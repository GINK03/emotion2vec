{"context": " More than 1 year has passed since last update.\u5c11\u3057\u524d\u306e\u8a71\u306b\u306a\u308a\u307e\u3059\u304c\u3001NetBSD-7.0\u306eLua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u6a5f\u80fd\u3067\u904a\u3076\u4f1a\u3068\u3044\u3046\u52c9\u5f37\u4f1a\u3092\u958b\u50ac\u3057\u3001NetBSD-7\u7cfb\u3067\u5229\u7528\u3067\u304d\u308bLua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u6a5f\u80fd\u3092\u8a66\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\u3053\u308c\u306b\u524d\u5f8c\u3059\u308b\u5f62\u3067NetBSD-7.0_RC3\u304c8/15\u306b\u30ea\u30ea\u30fc\u30b9\u3055\u308c\u3066\u3044\u307e\u3057\u305f\u3002\u624b\u5143\u306e\u74b0\u5883\u3067\u306fNetBSD-7.0_RC1\u3067\u306e\u624b\u9806\u3092\u8abf\u3079\u3066\u3044\u305f\u306e\u3067\u3001\u6539\u3081\u3066NetBSD-7.0_RC3\u306b\u304a\u3051\u308b\u3001Lua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u6a5f\u80fd\u306e\u5229\u7528\u624b\u9806\u3092\u307e\u3068\u3081\u3066\u307f\u307e\u3057\u305f\u3002\n\nNetBSD-7.0_RC3\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u307e\u305a\u306fNetBSD-7.0_RC3\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3067\u3059\u3002ISO\u30a4\u30e1\u30fc\u30b8\u306f\u4ee5\u4e0b\u306eURL\u304b\u3089\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3067\u304d\u307e\u3059\u3002\n\nhttp://ftp.jaist.ac.jp/pub/NetBSD/iso/7.0_RC3/NetBSD-7.0_RC3-amd64.iso\n\nNetBSD\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306f\u4ee5\u4e0b\u306e\u8a18\u4e8b\u3092\u53c2\u8003\u306b\u3057\u306a\u304c\u3089\u884c\u3048\u307e\u3059\u3002\u304c\u3001NetBSD-7\u7cfb\u3067\u306f\u4e00\u90e8\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u624b\u9806\u304c\u5909\u66f4\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u3067\u6ce8\u610f\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\nNetBSD\u3092VirtualBox\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u307f\u308b\n\n\nhttp://qiita.com/furandon_pig/items/5882ede06b5b5d3bf439\n\n\n\n\nLua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u8a66\u3059\n\n\u7528\u610f\u3055\u308c\u3066\u3044\u308bLua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305fNetBSD-7.0_RC3\u306b\u7528\u610f\u3055\u308c\u3066\u3044\u308bLua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3059\u3002Lua\u95a2\u9023\u306e\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u306f3\u3064\u3042\u308b\u3088\u3046\u3067\u3059\u3002\n# ls /stand/amd64/7.0/modules/lua*/*.kmod \n/stand/amd64/7.0/modules/lua/lua.kmod\n/stand/amd64/7.0/modules/luapmf/luapmf.kmod\n/stand/amd64/7.0/modules/luasystm/luasystm.kmod\n\n\nLua\u306b\u95a2\u3059\u308bman\u30da\u30fc\u30b8\n\u305d\u308c\u305e\u308c\u306e\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u304c\u3069\u3093\u306a\u6a5f\u80fd\u3092\u63d0\u4f9b\u3057\u3066\u3044\u308b\u306e\u304cman\u30da\u30fc\u30b8\u3067\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3059\u3002\n# find /usr/share/man/man* -type f | grep lua \n...\u4e2d\u7565...\n/usr/share/man/man8/luactl.8\n/usr/share/man/man9lua/intro.9lua\n/usr/share/man/man9lua/pmf.9lua\n/usr/share/man/man9lua/systm.9lua\n\n\u5404man\u30da\u30fc\u30b8\u3092\u3056\u3063\u3068\u898b\u3066\u884c\u304d\u307e\u3057\u3087\u3046\u3002\n\nintro.9lua\nintro.9lua\u306fLua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u6982\u8981\u3092\u8a18\u8f09\u3057\u305fman\u30da\u30fc\u30b8\u306e\u3088\u3046\u3067\u3059\u3002\u305f\u3060\u3001\u73fe\u72b6\u3067\u306f\u30db\u30f3\u30c8\u306b\u6982\u8981\u306e\u307f\u306e\u3088\u3046\u3067\u3059...\u3002\n# man 9lua intro \nman: Formatting manual page...\nINTRO(9lua)                          9lua                          INTRO(9lua)\n\nNAME\n     intro -- introduction to the Lua kernel bindings\n\nDESCRIPTION\n     This section provides an overview of the Lua kernel bindings, their\n     functions, error returns and other common definitions and concepts.\n\nSEE ALSO\n     lua(1), luac(1), intro(3lua), lua(4), pmf(9lua), systm(9lua)\n\nHISTORY\n     An intro manual for Lua kernel bindings appeared in NetBSD 7.0.\n\nNetBSD 7.0_RC3                 October 26, 2013                 NetBSD 7.0_RC3\n\n\npmf.9lua\npmf.9lua\u306f\u30d1\u30ef\u30fc\u30de\u30cd\u30b8\u30e1\u30f3\u30c8\u95a2\u9023\u306e\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u3088\u3046\u3067\u3059\u3002\n# man 9lua pmf\nman: Formatting manual page...\nPMF(9lua)                            9lua                            PMF(9lua)\n\nNAME\n     pmf -- Lua binding to the power management framework\n\nSYNOPSIS\n     local pmf = require 'pmf'\n\n     pmf.system_shutdown(howto)\n     pmf.set_platform(key, value)\n     value = pmf.get_platform(key)\n\nDESCRIPTION\n     The pmf Lua binding provides access to the power management framework.\n...\n\n\nsystm.9lua\nsystm.9lua\u306fLua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u57fa\u672c\u7684\u306a\u6a5f\u80fd\u306b\u3064\u3044\u3066\u8a18\u8ff0\u3057\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\n# man 9lua systm\nman: Formatting manual page...\nSYSTM(9lua)                          9lua                          SYSTM(9lua)\n\nNAME\n     systm -- access to general kernel functionality from Lua\n\nSYNOPSIS\n     local systm = require 'systm'\n\n     systm.print(msg)\n     systm.print_nolog(msg)\n     systm.uprint(msg)\n     systm.aprint_normal(msg)\n     systm.aprint_naive(msg)\n     systm.aprint_verbose(msg)\n     systm.aprint_debug(msg)\n     systm.aprint_error(msg)\n     count = systm.aprint_get_error_count()\n     systm.panic(msg)\n...\n\n\nHello,World.\nLua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u3067\u63d0\u4f9b\u3055\u308c\u3066\u3044\u308b\u6a5f\u80fd\u3092\u3056\u3063\u3068\u628a\u63e1\u3057\u305f\u3068\u3053\u308d\u3067\u3001\u3055\u3063\u305d\u304fLua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u6a5f\u80fd\u3092\u4f7f\u3063\u3066\u307f\u307e\u3057\u3087\u3046\u3002\u5148\u307b\u3069\u306esystm.9lua\u3067\u89e3\u8aac\u3055\u308c\u3066\u3044\u305fsystm.print()\u3092\u4f7f\u3046\u3068\"Hello,World.\"\u304c\u5b9f\u884c\u3067\u304d\u305d\u3046\u3067\u3059\u3002\n\u307e\u305a\u306fLua\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n-- hello.lua\nlocal systm = require 'systm' \nsystm.print('Hello,World.')\n\n\nLua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u4e0a\u3067Lua\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u52d5\u304b\u3059\n\u3053\u308c\u3092Lua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u304b\u3089\u5b9f\u884c\u3057\u3066\u307f\u307e\u3059\u3002\u4e00\u9023\u306e\u30b3\u30de\u30f3\u30c9\u306f\u4ee5\u4e0b\u306b\u306a\u308a\u307e\u3059\u3002\n# modload lua\n# luactl create hello\n# luactl load hello ./hello.lua\n# luactl destroy hello\n# modunload luasystem\n# modunload lua\n\n\u5b9f\u884c\u7d50\u679c\u306f\u4ee5\u4e0b\u3067\u3059\u3002\u7121\u4e8b\u306b\"Hello,World.\"\u3068\u3044\u3046\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u30ab\u30fc\u30cd\u30eb\u304b\u3089\u51fa\u529b\u3055\u308c\u3066\u3044\u3044\u307e\u3059(NetBSD\u3067\u306f\u30ab\u30fc\u30cd\u30eb\u5185\u3067printf()\u3057\u305f\u5185\u5bb9\u306f\u7dd1\u8272\u3067\u51fa\u529b\u3055\u308c\u307e\u3059)\u3002\n\n\nLua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u4e00\u9023\u306e\u6d41\u308c\nLua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u3068luactl\u30b3\u30de\u30f3\u30c9\u3092\u76f8\u4e92\u306b\u4f7f\u3046\u5f62\u3067Lua\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\u3002\u4e00\u9023\u306e\u624b\u9806\u304c\u3061\u3087\u3063\u3068\u3084\u3084\u3053\u3057\u3044\u306e\u3067\u3001\u7c21\u5358\u306a\u30b7\u30fc\u30b1\u30f3\u30b9\u56f3\u3092\u63cf\u3044\u3066\u307f\u307e\u3057\u305f\u3002\n\n\nLua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u3078\u306e\u6a5f\u80fd\u8ffd\u52a0\n\u6700\u521d\u304b\u3089\u7528\u610f\u3055\u308c\u3066\u3044\u308bsystm.print()\u3060\u3051\u3067\u306a\u304f\u3001\u72ec\u81ea\u306bLua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u306b\u95a2\u6570\u3092\u8ffd\u52a0\u3057\u3066\u307f\u305f\u3044\u3068\u601d\u3046\u306e\u304c\u4eba\u60c5(?)\u3067\u3059\u3002\u3068\u3044\u3046\u308f\u3051\u3067\u3001Lua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u306b\u72ec\u81ea\u306e\u95a2\u6570\u3092\u8ffd\u52a0\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u30ab\u30fc\u30cd\u30eb\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306e\u7528\u610f\n\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u3078\u306e\u6a5f\u80fd\u8ffd\u52a0\u306a\u306e\u3067\u3001\u4ee5\u4e0b\u306eURL\u304b\u3089NetBSD-7.0_RC3\u306e\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3092\u53d6\u5f97\u3057\u307e\u3059\u3002\n\nhttp://ftp.jaist.ac.jp/pub/NetBSD/NetBSD-7.0_RC3/source/sets/\n\n# curl -O http://ftp.jaist.ac.jp/pub/NetBSD/NetBSD-7.0_RC3/source/sets/gnusrc.tgz\n# curl -O http://ftp.jaist.ac.jp/pub/NetBSD/NetBSD-7.0_RC3/source/sets/sharesrc.tgz\n# curl -O http://ftp.jaist.ac.jp/pub/NetBSD/NetBSD-7.0_RC3/source/sets/src.tgz\n# curl -O http://ftp.jaist.ac.jp/pub/NetBSD/NetBSD-7.0_RC3/source/sets/syssrc.tgz\n\n\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u305f\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u3066\u5c55\u958b\u3057\u307e\u3059\u3002\u5c55\u958b\u5148\u306f/usr/src\u306b\u306a\u308a\u307e\u3059\u3002\n# for i in `echo *.tgz` ; do tar zxvf $i -C / ; done\n\n\nbuild.sh\u306b\u3088\u308b\u30c4\u30fc\u30eb\u30c1\u30a7\u30a4\u30f3\u69cb\u7bc9\n\u30ab\u30fc\u30cd\u30eb\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3092\u5c55\u958b\u3057\u305f\u5f8c\u3001build.sh\u3092\u4f7f\u7528\u3057\u3066\u30c4\u30fc\u30eb\u30c1\u30a7\u30a4\u30f3\u3092\u69cb\u7bc9\u3057\u307e\u3059\u3002\n# cd /usr/src\n# ./build.sh -m `uname -m` -a `uname -p` -T /usr/cross/NetBSD-`uname -r`/`uname -m` -r -o -U tools\n\n\u3053\u308c\u3067\u958b\u767a\u6e96\u5099\u304c\u6574\u3044\u307e\u3057\u305f\u3002\u4ee5\u4e0b\u306e\u624b\u9806\u3067Lua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u30d3\u30eb\u30c9\u3067\u304d\u307e\u3059(nbmake\u3067\u306f\u306a\u304fnbmake-amd64\u3092\u4f7f\u3046\u306e\u304c\u30dd\u30a4\u30f3\u30c8\u3067\u3059)\u3002\n# cd /usr/src/sys/modules/luasystm/\n# /usr/cross/NetBSD-7.0_RC3/amd64/bin/nbmake-amd64\n\n\u30d3\u30eb\u30c9\u3057\u305fLua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u306b\u5dee\u3057\u66ff\u3048\u307e\u3059\u3002\n# cp -p \\\n    /usr/src/sys/modules/luasystm/luasystm.kmod \\\n    /stand/amd64/7.0/modules/luasystm/luasystm.kmod\n\n\u4ee5\u964d\u306e\u4f8b\u3067\u306f\u3053\u306e\u624b\u9806\u3067luasystm.kmod\u3092\u30d3\u30eb\u30c9\u3057\u3066\u3044\u307e\u3059\u3002\n\nLua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u306b\u95a2\u6570\u3092\u8ffd\u52a0\u3059\u308b\n\n\u4e5d\u4e5d\u306e\u8868\u3092\u51fa\u529b\u3059\u308b\u95a2\u6570\u3092\u8ffd\u52a0\u3059\u308b\n\u307e\u305a\u306f\u7c21\u5358\u306b\u3001\u4e5d\u4e5d\u306e\u8868\u3092\u51fa\u529b\u3059\u308b\u95a2\u6570\u3092\u8ffd\u52a0\u3057\u3066\u307f\u307e\u3059\u3002luasystm.c\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u4fee\u6b63\u3057\u307e\u3059\u3002\n--- luasystm.c  2014-07-20 03:38:35.000000000 +0900\n+++ luasystm.c  2015-09-15 21:14:34.000000000 +0900\n@@ -141,6 +141,26 @@\n    return 1;\n }\n\n+static int\n+kuku(lua_State *L)\n+{\n+   int x, y, val;\n+\n+   for (x = 1; x <= 9; x++) {\n+       for (y = 1; y <=9; y++) {\n+           val = x * y;\n+           if (val < 10) {\n+               printf(\"  %d\", val);\n+           } else {\n+               printf(\" %d\", val);\n+           }\n+       }\n+       printf(\"\\n\");\n+   }\n+\n+   return 0;\n+}\n+\n /* panicing */\n\n static int\n@@ -171,6 +191,7 @@\n        { \"aprint_debug\",       systm_aprint_debug },\n        { \"aprint_error\",       systm_aprint_error },\n        { \"aprint_get_error_count\", systm_aprint_get_error_count },\n+       { \"kuku\",           kuku },\n\n        /* panicing */\n        { \"panic\",          systm_panic },\n\nLua\u30b9\u30af\u30ea\u30d7\u30c8\u304b\u3089\u306f\u5358\u306b\"systm.kuku()\"\u3092\u547c\u3073\u51fa\u3059\u3060\u3051\u3067\u3059\u3002\n-- kuku.lua\nlocal systm = require 'systm'\nsystm.kuku()\n\n\u5b9f\u884c\u7d50\u679c\u306f\u4ee5\u4e0b\u306b\u306a\u308a\u307e\u3059\u3002\n\n\n\u30d7\u30ed\u30bb\u30b9\u4e00\u89a7\u3092\u51fa\u529b\u3059\u308b\u95a2\u6570\u3092\u8ffd\u52a0\u3059\u308b\n\u6b21\u306b\u30ab\u30fc\u30cd\u30eb\u5185\u306e\u60c5\u5831\u3092\u53c2\u7167\u3059\u308b\u4f8b\u3068\u3057\u3066\u3001\u30d7\u30ed\u30bb\u30b9\u306e\u4e00\u89a7\u3092\u51fa\u529b\u3059\u308b\u95a2\u6570\u3092\u8ffd\u52a0\u3057\u3066\u307f\u307e\u3059\u3002luasystm.c\u306e\u4fee\u6b63\u5185\u5bb9\u306f\u4ee5\u4e0b\u306b\u306a\u308a\u307e\u3059\u3002\n--- luasystm.c  2014-07-20 03:38:35.000000000 +0900\n+++ luasystm.c  2015-09-15 21:45:46.000000000 +0900\n@@ -39,6 +39,11 @@\n #endif\n #include <sys/systm.h>\n\n+#include <sys/proc.h>\n+#include <sys/filedesc.h>\n+#include <sys/syscallargs.h>\n+#include <sys/file.h>\n+\n #include <lua.h>\n #include <lauxlib.h>\n\n@@ -141,6 +146,22 @@\n    return 1;\n }\n\n+static int\n+show_all_process(lua_State *L)\n+{\n+   struct proc *p;\n+\n+   LIST_FOREACH(p, &allproc, p_list) {\n+       if (curproc->p_pid == p->p_pid) {\n+           printf(\"* %5d %s\\n\", p->p_pid, p->p_comm);\n+       } else {\n+           printf(\"  %5d %s\\n\", p->p_pid, p->p_comm);\n+       }\n+   }\n+\n+   return 0;\n+}\n+\n /* panicing */\n\n static int\n@@ -171,6 +192,7 @@\n        { \"aprint_debug\",       systm_aprint_debug },\n        { \"aprint_error\",       systm_aprint_error },\n        { \"aprint_get_error_count\", systm_aprint_get_error_count },\n+       { \"show_all_process\",       show_all_process },\n\n        /* panicing */\n        { \"panic\",          systm_panic },\n\n\u5148\u307b\u3069\u306eLua\u30b9\u30af\u30ea\u30d7\u30c8\u3068\u540c\u3058\u304f\u3001\u3053\u3061\u3089\u3082\"systm.show_all_process()\"\u3092\u547c\u3073\u51fa\u3059\u3060\u3051\u3067\u3059\u3002\n-- show_all_process.lua\nlocal systm = require 'systm'\nsystm.show_all_process()\n\n\u5b9f\u884c\u7d50\u679c\u306f\u4ee5\u4e0b\u3067\u3059\u3002\u30d7\u30ed\u30bb\u30b9\u306e\u4e00\u89a7\u304c\u3060\u30fc\u3063\u3068\u51fa\u529b\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n\n\u30ab\u30fc\u30cd\u30eb\u30b9\u30ec\u30c3\u30c9\u306e\u4f5c\u6210\u30fb\u7834\u68c4\u3092\u884c\u3046\u95a2\u6570\u3092\u8ffd\u52a0\u3059\u308b\n\u5148\u306e\u4f8b\u3067\u306f\u5358\u306b\u4f55\u304b\u5b9f\u884c\u3057\u3066\u305d\u308c\u3067\u7d42\u308f\u308a\u3060\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u4eca\u5ea6\u306f\u30ab\u30fc\u30cd\u30eb\u30b9\u30ec\u30c3\u30c9\u3092\u7acb\u3061\u4e0a\u3052\u3066\u5b9a\u671f\u7684\u306b\u51e6\u7406\u304c\u8d70\u308b\u4f8b\u3092\u4f5c\u6210\u3057\u3066\u307f\u307e\u3059\u3002luasystm.c\u306e\u4fee\u6b63\u5185\u5bb9\u306f\u4ee5\u4e0b\u3067\u3059\u3002\n--- luasystm.c  2014-07-20 03:38:35.000000000 +0900\n+++ luasystm.c  2015-09-15 22:36:40.000000000 +0900\n@@ -39,12 +39,23 @@\n #endif\n #include <sys/systm.h>\n\n+#include <sys/types.h>\n+#include <sys/mutex.h>\n+#include <sys/kernel.h>\n+#include <sys/kthread.h>\n+\n #include <lua.h>\n #include <lauxlib.h>\n\n #ifdef _MODULE\n MODULE(MODULE_CLASS_MISC, luasystm, \"lua\");\n\n+static kcondvar_t  yry2_wait;\n+static kmutex_t        yry2_waitlock;\n+static lwp_t       *yry2_worker_lwp;\n+\n+static void yry2_thread(void *arg);\n+\n /* Various printing functions */\n static int\n print(lua_State *L)\n@@ -141,6 +152,70 @@\n    return 1;\n }\n\n+static int\n+yry2_kthread_create(lua_State *L)\n+{\n+   mutex_init(&yry2_waitlock, MUTEX_DEFAULT, IPL_NONE);\n+   cv_init(&yry2_wait, \"balloon\");\n+\n+   yry2_worker_lwp = (lwp_t *)0xdeadbabe;\n+\n+   if (kthread_create(PRI_NONE, KTHREAD_MPSAFE | KTHREAD_MUSTJOIN, NULL,\n+           yry2_thread, NULL, &yry2_worker_lwp, \"yry2_thread\")) {\n+       printf(\"cannot create kthread(luasystm).\\n\");\n+\n+       cv_destroy(&yry2_wait);\n+       mutex_destroy(&yry2_waitlock);\n+\n+       return 1;\n+   }\n+\n+   return 0;\n+}\n+\n+static int\n+yry2_kthread_destroy(lua_State *L)\n+{\n+   lwp_t *l = yry2_worker_lwp;\n+\n+   /* Notify the worker and wait for the exit. */\n+   mutex_enter(&yry2_waitlock);\n+   yry2_worker_lwp = NULL;\n+   cv_broadcast(&yry2_wait);\n+   mutex_exit(&yry2_waitlock);\n+   kthread_join(l);\n+\n+   cv_destroy(&yry2_wait);\n+   mutex_destroy(&yry2_waitlock);\n+\n+   printf(\"thread destroyed.\\n\");\n+\n+   return 0;\n+}\n+\n+\n+static void\n+yry2_thread(void *arg)\n+{\n+   int sleeptime = 10000;\n+   int count = 0;\n+\n+   for (;;) {\n+       const bool finish = (yry2_worker_lwp == NULL);\n+       mutex_enter(&yry2_waitlock);\n+       if (finish) {\n+           mutex_exit(&yry2_waitlock);\n+           break;\n+       }\n+       printf(\"hello,world. (%d)\\n\", count++);\n+       cv_timedwait(&yry2_wait, &yry2_waitlock,\n+           mstohz(sleeptime));\n+       mutex_exit(&yry2_waitlock);\n+   }\n+\n+   kthread_exit(0);\n+}\n+\n /* panicing */\n\n static int\n@@ -171,6 +246,8 @@\n        { \"aprint_debug\",       systm_aprint_debug },\n        { \"aprint_error\",       systm_aprint_error },\n        { \"aprint_get_error_count\", systm_aprint_get_error_count },\n+       { \"yry2_kthread_create\",    yry2_kthread_create },\n+       { \"yry2_kthread_destroy\",   yry2_kthread_destroy },\n\n        /* panicing */\n        { \"panic\",          systm_panic },\n\n\n\u30ab\u30fc\u30cd\u30eb\u30b9\u30ec\u30c3\u30c9\u3092\u751f\u6210\u30fb\u7834\u68c4\u3059\u308b\u305f\u3081\u3001Lua\u30b9\u30af\u30ea\u30d7\u30c8\u306f2\u3064\u4f5c\u6210\u3057\u307e\u3059\u3002\n-- kthread_create.lua\nlocal systm = require 'systm'\nsystm.yry2_kthread_create(\"\")\n\n-- kthread_destroy.lua\nlocal systm = require 'systm'\nsystm.yry2_kthread_destroy()\n\nLua\u30b9\u30af\u30ea\u30d7\u30c8\u304b\u3089\u30ab\u30fc\u30cd\u30eb\u30b9\u30ec\u30c3\u30c9\u3092\u8d77\u52d5\u3057\u3066\u307f\u307e\u3059\u3002\u4e00\u5b9a\u9593\u9694\u3067\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u8868\u793a\u3055\u308c\u307e\u3059\u3002\n\n\u30ab\u30fc\u30cd\u30eb\u30b9\u30ec\u30c3\u30c9\u3092\u505c\u6b62\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u3061\u306a\u307f\u306b\u3001\u30ab\u30fc\u30cd\u30eb\u30b9\u30ec\u30c3\u30c9\u306e\u5b9f\u884c\u4e2d\u306bluactl destroy\u3092\u5b9f\u884c\u3059\u308b\u3068\u30ab\u30fc\u30cd\u30eb\u30d1\u30cb\u30c3\u30af\u304c\u767a\u751f\u3057\u307e\u3059...\u3002\u5b9f\u884c\u4e2d\u306e\u72b6\u614b\u3092\u7834\u68c4\u3057\u305f\u3089\u305d\u308c\u306f\u30c0\u30e1\u3060\u3088\u306a\u3068\u601d\u3044\u3064\u3064\u3001\u30c1\u30a7\u30c3\u30af\u6a5f\u69cb\u3068\u304b\u306f\u7121\u3044\u306e\u304b\u3068\u3044\u3046\u6c17\u6301\u3061\u3082\u3002\n\u3068\u3082\u304b\u304f\u3001\u3053\u3093\u306a\u611f\u3058\u3067\u5f15\u6570\u3092\u4f34\u308f\u306a\u3044\u7c21\u5358\u306a\u95a2\u6570\u306b\u3064\u3044\u3066Lua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u306b\u8ffd\u52a0\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3057\u305f\u3002\n\n\u307e\u3068\u3081\nNetBSD-7.0_RC3\u3067Lua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u6a5f\u80fd\u3092\u8a66\u3057\u3066\u307f\u307e\u3057\u305f\u3002Lua\u30b9\u30af\u30ea\u30d7\u30c8\u304b\u3089\u547c\u3073\u51fa\u305b\u308b\u306e\u306fsystm.print()\u7684\u306a\u3082\u306e\u3084pmf\u95a2\u9023\u306e\u3082\u306e\u3067\u3001\u63d0\u4f9b\u3055\u308c\u3066\u3044\u308b\u6a5f\u80fd\u304c\u307e\u3060\u5c11\u306a\u3044\u611f\u3058\u3067\u3059\u3002\u5404\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u304cLua\u30b9\u30af\u30ea\u30d7\u30c8\u304b\u3089\u89e6\u308c\u3089\u308c\u308b\u3088\u3046\u306b\u306a\u308b\u3068\u3001\u5fdc\u7528\u7bc4\u56f2\u304c\u5e83\u304c\u308a\u305d\u3046\u3067\u306f\u3042\u308a\u307e\u3059\u304c\u3001\u4f55\u304b\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\u3092\u601d\u3044\u3064\u3044\u3066\u304a\u304b\u306a\u3044\u3068\u300cXX\u3068\u3044\u3046\u6a5f\u80fd\u304c\u6b32\u3057\u3044\u3093\u3060\u3051\u3069\u3001C\u8a00\u8a9e\u3067\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u3068\u3057\u3066\u5b9f\u88c5\u3059\u308c\u3070\u30a4\u30a4\u3058\u3083\u3093\u300d\u3068\u3044\u3046\u8a71\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u305d\u3046\u306a\u6c17\u3082\u3057\u307e\u3059\u3002\n\u3053\u306e\u5fdc\u7528\u4f8b\u304c\u601d\u3044\u3064\u304b\u306a\u3044\u611f\u3058\u3001\u3053\u308c\u306f\u65e2\u8996\u611f\u304c\u3042\u308b\u305e\u3068\u8a18\u61b6\u3092\u8fbf\u3063\u305f\u3089\u3001Linux\u306e\u30e9\u30a4\u30d6\u30d1\u30c3\u30c1\u3092\u8a66\u3057\u3066\u307f\u305f\u6642\u3068\u540c\u3058\u304f\u3001\u4fbf\u5229\u305d\u3046\u3067\u306f\u3042\u308b\u3051\u308c\u3069\u30a4\u30de\u30a4\u30c1\u5fdc\u7528\u4f8b\u304c\u601d\u3044\u3064\u304b\u306a\u3044\u3001\u3068\u3044\u3046\u306e\u3068\u540c\u3058\u611f\u899a\u306a\u306e\u3067\u3057\u305f\u3002\n\n\u53c2\u8003URL\n\nNetBSD 7.0_RC3\nLua\n\nModern net bsd kernel module\n\n\u6700\u8fd1\u306eNetBSD\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u89e3\u8aac\u3002\u3044\u3064\u306e\u9593\u306b\u3084\u3089LKM(Loadable Kernel Module)\u3067\u306f\u306a\u304f\u306a\u3063\u3066\u3044\u305f...\u3002\n\n\n\nNetBSD\u3092VirtualBox\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u307f\u308b\n\n\u624b\u524d\u5473\u564c\u306a\u304c\u3089\u81ea\u5206\u306e\u6295\u7a3f\u5185\u5bb9...\n\n\n\n\u5c11\u3057\u524d\u306e\u8a71\u306b\u306a\u308a\u307e\u3059\u304c\u3001[NetBSD-7.0\u306eLua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u6a5f\u80fd\u3067\u904a\u3076\u4f1a](https://yry2.doorkeeper.jp/events/29556)\u3068\u3044\u3046\u52c9\u5f37\u4f1a\u3092\u958b\u50ac\u3057\u3001NetBSD-7\u7cfb\u3067\u5229\u7528\u3067\u304d\u308bLua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u6a5f\u80fd\u3092\u8a66\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n\u3053\u308c\u306b\u524d\u5f8c\u3059\u308b\u5f62\u3067[NetBSD-7.0_RC3](http://blog.netbsd.org/tnf/entry/netbsd_7_0_rc3)\u304c8/15\u306b\u30ea\u30ea\u30fc\u30b9\u3055\u308c\u3066\u3044\u307e\u3057\u305f\u3002\u624b\u5143\u306e\u74b0\u5883\u3067\u306fNetBSD-7.0_RC1\u3067\u306e\u624b\u9806\u3092\u8abf\u3079\u3066\u3044\u305f\u306e\u3067\u3001\u6539\u3081\u3066NetBSD-7.0_RC3\u306b\u304a\u3051\u308b\u3001Lua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u6a5f\u80fd\u306e\u5229\u7528\u624b\u9806\u3092\u307e\u3068\u3081\u3066\u307f\u307e\u3057\u305f\u3002\n\n# NetBSD-7.0_RC3\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n\u307e\u305a\u306fNetBSD-7.0_RC3\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3067\u3059\u3002ISO\u30a4\u30e1\u30fc\u30b8\u306f\u4ee5\u4e0b\u306eURL\u304b\u3089\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3067\u304d\u307e\u3059\u3002\n\n * http://ftp.jaist.ac.jp/pub/NetBSD/iso/7.0_RC3/NetBSD-7.0_RC3-amd64.iso\n\nNetBSD\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306f\u4ee5\u4e0b\u306e\u8a18\u4e8b\u3092\u53c2\u8003\u306b\u3057\u306a\u304c\u3089\u884c\u3048\u307e\u3059\u3002\u304c\u3001NetBSD-7\u7cfb\u3067\u306f\u4e00\u90e8\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u624b\u9806\u304c\u5909\u66f4\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u3067\u6ce8\u610f\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n * NetBSD\u3092VirtualBox\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u307f\u308b\n   * http://qiita.com/furandon_pig/items/5882ede06b5b5d3bf439\n\n# Lua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u8a66\u3059\n\n## \u7528\u610f\u3055\u308c\u3066\u3044\u308bLua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305fNetBSD-7.0_RC3\u306b\u7528\u610f\u3055\u308c\u3066\u3044\u308bLua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3059\u3002Lua\u95a2\u9023\u306e\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u306f3\u3064\u3042\u308b\u3088\u3046\u3067\u3059\u3002\n\n```\n# ls /stand/amd64/7.0/modules/lua*/*.kmod \n/stand/amd64/7.0/modules/lua/lua.kmod\n/stand/amd64/7.0/modules/luapmf/luapmf.kmod\n/stand/amd64/7.0/modules/luasystm/luasystm.kmod\n```\n\n## Lua\u306b\u95a2\u3059\u308bman\u30da\u30fc\u30b8\n\n\u305d\u308c\u305e\u308c\u306e\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u304c\u3069\u3093\u306a\u6a5f\u80fd\u3092\u63d0\u4f9b\u3057\u3066\u3044\u308b\u306e\u304cman\u30da\u30fc\u30b8\u3067\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3059\u3002\n\n```\n# find /usr/share/man/man* -type f | grep lua \n...\u4e2d\u7565...\n/usr/share/man/man8/luactl.8\n/usr/share/man/man9lua/intro.9lua\n/usr/share/man/man9lua/pmf.9lua\n/usr/share/man/man9lua/systm.9lua\n```\n\n\u5404man\u30da\u30fc\u30b8\u3092\u3056\u3063\u3068\u898b\u3066\u884c\u304d\u307e\u3057\u3087\u3046\u3002\n\n### intro.9lua\n\nintro.9lua\u306fLua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u6982\u8981\u3092\u8a18\u8f09\u3057\u305fman\u30da\u30fc\u30b8\u306e\u3088\u3046\u3067\u3059\u3002\u305f\u3060\u3001\u73fe\u72b6\u3067\u306f\u30db\u30f3\u30c8\u306b\u6982\u8981\u306e\u307f\u306e\u3088\u3046\u3067\u3059...\u3002\n\n```\n# man 9lua intro \nman: Formatting manual page...\nINTRO(9lua)                          9lua                          INTRO(9lua)\n\nNAME\n     intro -- introduction to the Lua kernel bindings\n\nDESCRIPTION\n     This section provides an overview of the Lua kernel bindings, their\n     functions, error returns and other common definitions and concepts.\n\nSEE ALSO\n     lua(1), luac(1), intro(3lua), lua(4), pmf(9lua), systm(9lua)\n\nHISTORY\n     An intro manual for Lua kernel bindings appeared in NetBSD 7.0.\n\nNetBSD 7.0_RC3                 October 26, 2013                 NetBSD 7.0_RC3\n```\n\n### pmf.9lua\n\npmf.9lua\u306f\u30d1\u30ef\u30fc\u30de\u30cd\u30b8\u30e1\u30f3\u30c8\u95a2\u9023\u306e\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u3088\u3046\u3067\u3059\u3002\n\n```\n# man 9lua pmf\nman: Formatting manual page...\nPMF(9lua)                            9lua                            PMF(9lua)\n\nNAME\n     pmf -- Lua binding to the power management framework\n\nSYNOPSIS\n     local pmf = require 'pmf'\n\n     pmf.system_shutdown(howto)\n     pmf.set_platform(key, value)\n     value = pmf.get_platform(key)\n\nDESCRIPTION\n     The pmf Lua binding provides access to the power management framework.\n...\n```\n\n### systm.9lua\n\nsystm.9lua\u306fLua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u57fa\u672c\u7684\u306a\u6a5f\u80fd\u306b\u3064\u3044\u3066\u8a18\u8ff0\u3057\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\n\n```\n# man 9lua systm\nman: Formatting manual page...\nSYSTM(9lua)                          9lua                          SYSTM(9lua)\n\nNAME\n     systm -- access to general kernel functionality from Lua\n\nSYNOPSIS\n     local systm = require 'systm'\n\n     systm.print(msg)\n     systm.print_nolog(msg)\n     systm.uprint(msg)\n     systm.aprint_normal(msg)\n     systm.aprint_naive(msg)\n     systm.aprint_verbose(msg)\n     systm.aprint_debug(msg)\n     systm.aprint_error(msg)\n     count = systm.aprint_get_error_count()\n     systm.panic(msg)\n...\n```\n\n## Hello,World.\n\nLua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u3067\u63d0\u4f9b\u3055\u308c\u3066\u3044\u308b\u6a5f\u80fd\u3092\u3056\u3063\u3068\u628a\u63e1\u3057\u305f\u3068\u3053\u308d\u3067\u3001\u3055\u3063\u305d\u304fLua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u6a5f\u80fd\u3092\u4f7f\u3063\u3066\u307f\u307e\u3057\u3087\u3046\u3002\u5148\u307b\u3069\u306esystm.9lua\u3067\u89e3\u8aac\u3055\u308c\u3066\u3044\u305fsystm.print()\u3092\u4f7f\u3046\u3068\"Hello,World.\"\u304c\u5b9f\u884c\u3067\u304d\u305d\u3046\u3067\u3059\u3002\n\n\u307e\u305a\u306fLua\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```lua\n-- hello.lua\nlocal systm = require 'systm' \nsystm.print('Hello,World.')\n```\n\n## Lua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u4e0a\u3067Lua\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u52d5\u304b\u3059\n\n\u3053\u308c\u3092Lua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u304b\u3089\u5b9f\u884c\u3057\u3066\u307f\u307e\u3059\u3002\u4e00\u9023\u306e\u30b3\u30de\u30f3\u30c9\u306f\u4ee5\u4e0b\u306b\u306a\u308a\u307e\u3059\u3002\n\n```shell-session\n# modload lua\n# luactl create hello\n# luactl load hello ./hello.lua\n# luactl destroy hello\n# modunload luasystem\n# modunload lua\n```\n\n\u5b9f\u884c\u7d50\u679c\u306f\u4ee5\u4e0b\u3067\u3059\u3002\u7121\u4e8b\u306b\"Hello,World.\"\u3068\u3044\u3046\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u30ab\u30fc\u30cd\u30eb\u304b\u3089\u51fa\u529b\u3055\u308c\u3066\u3044\u3044\u307e\u3059(NetBSD\u3067\u306f\u30ab\u30fc\u30cd\u30eb\u5185\u3067printf()\u3057\u305f\u5185\u5bb9\u306f\u7dd1\u8272\u3067\u51fa\u529b\u3055\u308c\u307e\u3059)\u3002\n\n![img101.png](https://qiita-image-store.s3.amazonaws.com/0/61137/a6c09aa2-a8bb-68e7-5a1e-6f67e9f31878.png)\n\n## Lua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u4e00\u9023\u306e\u6d41\u308c\n\nLua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u3068luactl\u30b3\u30de\u30f3\u30c9\u3092\u76f8\u4e92\u306b\u4f7f\u3046\u5f62\u3067Lua\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\u3002\u4e00\u9023\u306e\u624b\u9806\u304c\u3061\u3087\u3063\u3068\u3084\u3084\u3053\u3057\u3044\u306e\u3067\u3001\u7c21\u5358\u306a\u30b7\u30fc\u30b1\u30f3\u30b9\u56f3\u3092\u63cf\u3044\u3066\u307f\u307e\u3057\u305f\u3002\n\n![img105.png](https://qiita-image-store.s3.amazonaws.com/0/61137/68c1156b-2744-44cf-9773-e18e3dbac303.png)\n\n# Lua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u3078\u306e\u6a5f\u80fd\u8ffd\u52a0\n\n\u6700\u521d\u304b\u3089\u7528\u610f\u3055\u308c\u3066\u3044\u308bsystm.print()\u3060\u3051\u3067\u306a\u304f\u3001\u72ec\u81ea\u306bLua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u306b\u95a2\u6570\u3092\u8ffd\u52a0\u3057\u3066\u307f\u305f\u3044\u3068\u601d\u3046\u306e\u304c\u4eba\u60c5(?)\u3067\u3059\u3002\u3068\u3044\u3046\u308f\u3051\u3067\u3001Lua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u306b\u72ec\u81ea\u306e\u95a2\u6570\u3092\u8ffd\u52a0\u3057\u3066\u307f\u307e\u3059\u3002\n\n## \u30ab\u30fc\u30cd\u30eb\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306e\u7528\u610f\n\n\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u3078\u306e\u6a5f\u80fd\u8ffd\u52a0\u306a\u306e\u3067\u3001\u4ee5\u4e0b\u306eURL\u304b\u3089NetBSD-7.0_RC3\u306e\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3092\u53d6\u5f97\u3057\u307e\u3059\u3002\n\n * http://ftp.jaist.ac.jp/pub/NetBSD/NetBSD-7.0_RC3/source/sets/\n\n```shell-session\n# curl -O http://ftp.jaist.ac.jp/pub/NetBSD/NetBSD-7.0_RC3/source/sets/gnusrc.tgz\n# curl -O http://ftp.jaist.ac.jp/pub/NetBSD/NetBSD-7.0_RC3/source/sets/sharesrc.tgz\n# curl -O http://ftp.jaist.ac.jp/pub/NetBSD/NetBSD-7.0_RC3/source/sets/src.tgz\n# curl -O http://ftp.jaist.ac.jp/pub/NetBSD/NetBSD-7.0_RC3/source/sets/syssrc.tgz\n```\n\n\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u305f\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u3066\u5c55\u958b\u3057\u307e\u3059\u3002\u5c55\u958b\u5148\u306f/usr/src\u306b\u306a\u308a\u307e\u3059\u3002\n\n```shell-session\n# for i in `echo *.tgz` ; do tar zxvf $i -C / ; done\n```\n\n### build.sh\u306b\u3088\u308b\u30c4\u30fc\u30eb\u30c1\u30a7\u30a4\u30f3\u69cb\u7bc9\n\n\u30ab\u30fc\u30cd\u30eb\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3092\u5c55\u958b\u3057\u305f\u5f8c\u3001build.sh\u3092\u4f7f\u7528\u3057\u3066\u30c4\u30fc\u30eb\u30c1\u30a7\u30a4\u30f3\u3092\u69cb\u7bc9\u3057\u307e\u3059\u3002\n\n```shell-session\n# cd /usr/src\n# ./build.sh -m `uname -m` -a `uname -p` -T /usr/cross/NetBSD-`uname -r`/`uname -m` -r -o -U tools\n```\n\n\u3053\u308c\u3067\u958b\u767a\u6e96\u5099\u304c\u6574\u3044\u307e\u3057\u305f\u3002\u4ee5\u4e0b\u306e\u624b\u9806\u3067Lua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u30d3\u30eb\u30c9\u3067\u304d\u307e\u3059(nbmake\u3067\u306f\u306a\u304fnbmake-amd64\u3092\u4f7f\u3046\u306e\u304c\u30dd\u30a4\u30f3\u30c8\u3067\u3059)\u3002\n\n```shell-session\n# cd /usr/src/sys/modules/luasystm/\n# /usr/cross/NetBSD-7.0_RC3/amd64/bin/nbmake-amd64\n```\n\n\u30d3\u30eb\u30c9\u3057\u305fLua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u306b\u5dee\u3057\u66ff\u3048\u307e\u3059\u3002\n\n```shell-session\n# cp -p \\\n    /usr/src/sys/modules/luasystm/luasystm.kmod \\\n    /stand/amd64/7.0/modules/luasystm/luasystm.kmod\n```\n\n\u4ee5\u964d\u306e\u4f8b\u3067\u306f\u3053\u306e\u624b\u9806\u3067luasystm.kmod\u3092\u30d3\u30eb\u30c9\u3057\u3066\u3044\u307e\u3059\u3002\n\n## Lua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u306b\u95a2\u6570\u3092\u8ffd\u52a0\u3059\u308b\n\n### \u4e5d\u4e5d\u306e\u8868\u3092\u51fa\u529b\u3059\u308b\u95a2\u6570\u3092\u8ffd\u52a0\u3059\u308b\n\n\u307e\u305a\u306f\u7c21\u5358\u306b\u3001\u4e5d\u4e5d\u306e\u8868\u3092\u51fa\u529b\u3059\u308b\u95a2\u6570\u3092\u8ffd\u52a0\u3057\u3066\u307f\u307e\u3059\u3002luasystm.c\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u4fee\u6b63\u3057\u307e\u3059\u3002\n\n```diff\n--- luasystm.c\t2014-07-20 03:38:35.000000000 +0900\n+++ luasystm.c\t2015-09-15 21:14:34.000000000 +0900\n@@ -141,6 +141,26 @@\n \treturn 1;\n }\n \n+static int\n+kuku(lua_State *L)\n+{\n+\tint x, y, val;\n+\n+\tfor (x = 1; x <= 9; x++) {\n+\t\tfor (y = 1; y <=9; y++) {\n+\t\t\tval = x * y;\n+\t\t\tif (val < 10) {\n+\t\t\t\tprintf(\"  %d\", val);\n+\t\t\t} else {\n+\t\t\t\tprintf(\" %d\", val);\n+\t\t\t}\n+\t\t}\n+\t\tprintf(\"\\n\");\n+\t}\n+\n+\treturn 0;\n+}\n+\n /* panicing */\n \n static int\n@@ -171,6 +191,7 @@\n \t\t{ \"aprint_debug\",\t\tsystm_aprint_debug },\n \t\t{ \"aprint_error\",\t\tsystm_aprint_error },\n \t\t{ \"aprint_get_error_count\",\tsystm_aprint_get_error_count },\n+\t\t{ \"kuku\",\t\t\tkuku },\n \n \t\t/* panicing */\n \t\t{ \"panic\",\t\t\tsystm_panic },\n```\n\nLua\u30b9\u30af\u30ea\u30d7\u30c8\u304b\u3089\u306f\u5358\u306b\"systm.kuku()\"\u3092\u547c\u3073\u51fa\u3059\u3060\u3051\u3067\u3059\u3002\n\n```lua\n-- kuku.lua\nlocal systm = require 'systm'\nsystm.kuku()\n```\n\n\u5b9f\u884c\u7d50\u679c\u306f\u4ee5\u4e0b\u306b\u306a\u308a\u307e\u3059\u3002\n\n![img106.png](https://qiita-image-store.s3.amazonaws.com/0/61137/d34a41b1-f346-6c82-e647-2bde2ae1875c.png)\n\n### \u30d7\u30ed\u30bb\u30b9\u4e00\u89a7\u3092\u51fa\u529b\u3059\u308b\u95a2\u6570\u3092\u8ffd\u52a0\u3059\u308b\n\n\u6b21\u306b\u30ab\u30fc\u30cd\u30eb\u5185\u306e\u60c5\u5831\u3092\u53c2\u7167\u3059\u308b\u4f8b\u3068\u3057\u3066\u3001\u30d7\u30ed\u30bb\u30b9\u306e\u4e00\u89a7\u3092\u51fa\u529b\u3059\u308b\u95a2\u6570\u3092\u8ffd\u52a0\u3057\u3066\u307f\u307e\u3059\u3002luasystm.c\u306e\u4fee\u6b63\u5185\u5bb9\u306f\u4ee5\u4e0b\u306b\u306a\u308a\u307e\u3059\u3002\n\n```diff\n--- luasystm.c\t2014-07-20 03:38:35.000000000 +0900\n+++ luasystm.c\t2015-09-15 21:45:46.000000000 +0900\n@@ -39,6 +39,11 @@\n #endif\n #include <sys/systm.h>\n \n+#include <sys/proc.h>\n+#include <sys/filedesc.h>\n+#include <sys/syscallargs.h>\n+#include <sys/file.h>\n+\n #include <lua.h>\n #include <lauxlib.h>\n \n@@ -141,6 +146,22 @@\n \treturn 1;\n }\n \n+static int\n+show_all_process(lua_State *L)\n+{\n+\tstruct proc *p;\n+\n+\tLIST_FOREACH(p, &allproc, p_list) {\n+\t\tif (curproc->p_pid == p->p_pid) {\n+\t\t\tprintf(\"* %5d %s\\n\", p->p_pid, p->p_comm);\n+\t\t} else {\n+\t\t\tprintf(\"  %5d %s\\n\", p->p_pid, p->p_comm);\n+\t\t}\n+\t}\n+\n+\treturn 0;\n+}\n+\n /* panicing */\n \n static int\n@@ -171,6 +192,7 @@\n \t\t{ \"aprint_debug\",\t\tsystm_aprint_debug },\n \t\t{ \"aprint_error\",\t\tsystm_aprint_error },\n \t\t{ \"aprint_get_error_count\",\tsystm_aprint_get_error_count },\n+\t\t{ \"show_all_process\",\t\tshow_all_process },\n \n \t\t/* panicing */\n \t\t{ \"panic\",\t\t\tsystm_panic },\n```\n\n\u5148\u307b\u3069\u306eLua\u30b9\u30af\u30ea\u30d7\u30c8\u3068\u540c\u3058\u304f\u3001\u3053\u3061\u3089\u3082\"systm.show_all_process()\"\u3092\u547c\u3073\u51fa\u3059\u3060\u3051\u3067\u3059\u3002\n\n```lua\n-- show_all_process.lua\nlocal systm = require 'systm'\nsystm.show_all_process()\n```\n\u5b9f\u884c\u7d50\u679c\u306f\u4ee5\u4e0b\u3067\u3059\u3002\u30d7\u30ed\u30bb\u30b9\u306e\u4e00\u89a7\u304c\u3060\u30fc\u3063\u3068\u51fa\u529b\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n![img102.png](https://qiita-image-store.s3.amazonaws.com/0/61137/6cf04e3b-d6bf-92e6-dc3a-4d13426968e6.png)\n\n### \u30ab\u30fc\u30cd\u30eb\u30b9\u30ec\u30c3\u30c9\u306e\u4f5c\u6210\u30fb\u7834\u68c4\u3092\u884c\u3046\u95a2\u6570\u3092\u8ffd\u52a0\u3059\u308b\n\n\u5148\u306e\u4f8b\u3067\u306f\u5358\u306b\u4f55\u304b\u5b9f\u884c\u3057\u3066\u305d\u308c\u3067\u7d42\u308f\u308a\u3060\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u4eca\u5ea6\u306f\u30ab\u30fc\u30cd\u30eb\u30b9\u30ec\u30c3\u30c9\u3092\u7acb\u3061\u4e0a\u3052\u3066\u5b9a\u671f\u7684\u306b\u51e6\u7406\u304c\u8d70\u308b\u4f8b\u3092\u4f5c\u6210\u3057\u3066\u307f\u307e\u3059\u3002luasystm.c\u306e\u4fee\u6b63\u5185\u5bb9\u306f\u4ee5\u4e0b\u3067\u3059\u3002\n\n```diff\n--- luasystm.c\t2014-07-20 03:38:35.000000000 +0900\n+++ luasystm.c\t2015-09-15 22:36:40.000000000 +0900\n@@ -39,12 +39,23 @@\n #endif\n #include <sys/systm.h>\n \n+#include <sys/types.h>\n+#include <sys/mutex.h>\n+#include <sys/kernel.h>\n+#include <sys/kthread.h>\n+\n #include <lua.h>\n #include <lauxlib.h>\n \n #ifdef _MODULE\n MODULE(MODULE_CLASS_MISC, luasystm, \"lua\");\n \n+static kcondvar_t\tyry2_wait;\n+static kmutex_t\t\tyry2_waitlock;\n+static lwp_t\t\t*yry2_worker_lwp;\n+\n+static void yry2_thread(void *arg);\n+\n /* Various printing functions */\n static int\n print(lua_State *L)\n@@ -141,6 +152,70 @@\n \treturn 1;\n }\n \n+static int\n+yry2_kthread_create(lua_State *L)\n+{\n+\tmutex_init(&yry2_waitlock, MUTEX_DEFAULT, IPL_NONE);\n+\tcv_init(&yry2_wait, \"balloon\");\n+\n+\tyry2_worker_lwp = (lwp_t *)0xdeadbabe;\n+\n+\tif (kthread_create(PRI_NONE, KTHREAD_MPSAFE | KTHREAD_MUSTJOIN, NULL,\n+   \t    yry2_thread, NULL, &yry2_worker_lwp, \"yry2_thread\")) {\n+\t\tprintf(\"cannot create kthread(luasystm).\\n\");\n+\n+\t\tcv_destroy(&yry2_wait);\n+\t\tmutex_destroy(&yry2_waitlock);\n+\n+\t\treturn 1;\n+\t}\n+\n+\treturn 0;\n+}\n+\n+static int\n+yry2_kthread_destroy(lua_State *L)\n+{\n+\tlwp_t *l = yry2_worker_lwp;\n+\n+\t/* Notify the worker and wait for the exit. */\n+\tmutex_enter(&yry2_waitlock);\n+\tyry2_worker_lwp = NULL;\n+\tcv_broadcast(&yry2_wait);\n+\tmutex_exit(&yry2_waitlock);\n+\tkthread_join(l);\n+\n+\tcv_destroy(&yry2_wait);\n+\tmutex_destroy(&yry2_waitlock);\n+\n+\tprintf(\"thread destroyed.\\n\");\n+\n+\treturn 0;\n+}\n+\n+\n+static void\n+yry2_thread(void *arg)\n+{\n+\tint sleeptime = 10000;\n+\tint count = 0;\n+\n+\tfor (;;) {\n+\t\tconst bool finish = (yry2_worker_lwp == NULL);\n+\t\tmutex_enter(&yry2_waitlock);\n+\t\tif (finish) {\n+\t\t\tmutex_exit(&yry2_waitlock);\n+\t\t\tbreak;\n+\t\t}\n+\t\tprintf(\"hello,world. (%d)\\n\", count++);\n+\t\tcv_timedwait(&yry2_wait, &yry2_waitlock,\n+\t\t\tmstohz(sleeptime));\n+\t\tmutex_exit(&yry2_waitlock);\n+\t}\n+\n+\tkthread_exit(0);\n+}\n+\n /* panicing */\n \n static int\n@@ -171,6 +246,8 @@\n \t\t{ \"aprint_debug\",\t\tsystm_aprint_debug },\n \t\t{ \"aprint_error\",\t\tsystm_aprint_error },\n \t\t{ \"aprint_get_error_count\",\tsystm_aprint_get_error_count },\n+\t\t{ \"yry2_kthread_create\",\tyry2_kthread_create },\n+\t\t{ \"yry2_kthread_destroy\",\tyry2_kthread_destroy },\n \n \t\t/* panicing */\n \t\t{ \"panic\",\t\t\tsystm_panic },\n\n```\n\n\u30ab\u30fc\u30cd\u30eb\u30b9\u30ec\u30c3\u30c9\u3092\u751f\u6210\u30fb\u7834\u68c4\u3059\u308b\u305f\u3081\u3001Lua\u30b9\u30af\u30ea\u30d7\u30c8\u306f2\u3064\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```lua\n-- kthread_create.lua\nlocal systm = require 'systm'\nsystm.yry2_kthread_create(\"\")\n```\n\n```lua\n-- kthread_destroy.lua\nlocal systm = require 'systm'\nsystm.yry2_kthread_destroy()\n```\n\nLua\u30b9\u30af\u30ea\u30d7\u30c8\u304b\u3089\u30ab\u30fc\u30cd\u30eb\u30b9\u30ec\u30c3\u30c9\u3092\u8d77\u52d5\u3057\u3066\u307f\u307e\u3059\u3002\u4e00\u5b9a\u9593\u9694\u3067\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u8868\u793a\u3055\u308c\u307e\u3059\u3002\n\n![img103.png](https://qiita-image-store.s3.amazonaws.com/0/61137/4e97beb7-e6c6-f01a-e718-2811540f3d54.png)\n\n\u30ab\u30fc\u30cd\u30eb\u30b9\u30ec\u30c3\u30c9\u3092\u505c\u6b62\u3057\u3066\u307f\u307e\u3059\u3002\n\n![img104.png](https://qiita-image-store.s3.amazonaws.com/0/61137/e3ac3aaa-acd9-2cd8-b2b1-53b6f94fa8d4.png)\n\n\u3061\u306a\u307f\u306b\u3001\u30ab\u30fc\u30cd\u30eb\u30b9\u30ec\u30c3\u30c9\u306e\u5b9f\u884c\u4e2d\u306bluactl destroy\u3092\u5b9f\u884c\u3059\u308b\u3068\u30ab\u30fc\u30cd\u30eb\u30d1\u30cb\u30c3\u30af\u304c\u767a\u751f\u3057\u307e\u3059...\u3002\u5b9f\u884c\u4e2d\u306e\u72b6\u614b\u3092\u7834\u68c4\u3057\u305f\u3089\u305d\u308c\u306f\u30c0\u30e1\u3060\u3088\u306a\u3068\u601d\u3044\u3064\u3064\u3001\u30c1\u30a7\u30c3\u30af\u6a5f\u69cb\u3068\u304b\u306f\u7121\u3044\u306e\u304b\u3068\u3044\u3046\u6c17\u6301\u3061\u3082\u3002\n\n\u3068\u3082\u304b\u304f\u3001\u3053\u3093\u306a\u611f\u3058\u3067\u5f15\u6570\u3092\u4f34\u308f\u306a\u3044\u7c21\u5358\u306a\u95a2\u6570\u306b\u3064\u3044\u3066Lua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u306b\u8ffd\u52a0\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3057\u305f\u3002\n\n# \u307e\u3068\u3081\n\nNetBSD-7.0_RC3\u3067Lua\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u6a5f\u80fd\u3092\u8a66\u3057\u3066\u307f\u307e\u3057\u305f\u3002Lua\u30b9\u30af\u30ea\u30d7\u30c8\u304b\u3089\u547c\u3073\u51fa\u305b\u308b\u306e\u306fsystm.print()\u7684\u306a\u3082\u306e\u3084pmf\u95a2\u9023\u306e\u3082\u306e\u3067\u3001\u63d0\u4f9b\u3055\u308c\u3066\u3044\u308b\u6a5f\u80fd\u304c\u307e\u3060\u5c11\u306a\u3044\u611f\u3058\u3067\u3059\u3002\u5404\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u304cLua\u30b9\u30af\u30ea\u30d7\u30c8\u304b\u3089\u89e6\u308c\u3089\u308c\u308b\u3088\u3046\u306b\u306a\u308b\u3068\u3001\u5fdc\u7528\u7bc4\u56f2\u304c\u5e83\u304c\u308a\u305d\u3046\u3067\u306f\u3042\u308a\u307e\u3059\u304c\u3001\u4f55\u304b\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\u3092\u601d\u3044\u3064\u3044\u3066\u304a\u304b\u306a\u3044\u3068\u300cXX\u3068\u3044\u3046\u6a5f\u80fd\u304c\u6b32\u3057\u3044\u3093\u3060\u3051\u3069\u3001C\u8a00\u8a9e\u3067\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u3068\u3057\u3066\u5b9f\u88c5\u3059\u308c\u3070\u30a4\u30a4\u3058\u3083\u3093\u300d\u3068\u3044\u3046\u8a71\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u305d\u3046\u306a\u6c17\u3082\u3057\u307e\u3059\u3002\n\n\u3053\u306e\u5fdc\u7528\u4f8b\u304c\u601d\u3044\u3064\u304b\u306a\u3044\u611f\u3058\u3001\u3053\u308c\u306f\u65e2\u8996\u611f\u304c\u3042\u308b\u305e\u3068\u8a18\u61b6\u3092\u8fbf\u3063\u305f\u3089\u3001[Linux\u306e\u30e9\u30a4\u30d6\u30d1\u30c3\u30c1\u3092\u8a66\u3057\u3066\u307f\u305f\u6642](http://qiita.com/furandon_pig/items/379ceacf234134798df2)\u3068\u540c\u3058\u304f\u3001\u4fbf\u5229\u305d\u3046\u3067\u306f\u3042\u308b\u3051\u308c\u3069\u30a4\u30de\u30a4\u30c1\u5fdc\u7528\u4f8b\u304c\u601d\u3044\u3064\u304b\u306a\u3044\u3001\u3068\u3044\u3046\u306e\u3068\u540c\u3058\u611f\u899a\u306a\u306e\u3067\u3057\u305f\u3002\n\n# \u53c2\u8003URL\n\n * [NetBSD 7.0_RC3](http://blog.netbsd.org/tnf/entry/netbsd_7_0_rc3)\n * [Lua](http://www.lua.org/)\n * [Modern net bsd kernel module](http://www.slideshare.net/masaruoki9/modern-net-bsd-kernel-module)\n   * \u6700\u8fd1\u306eNetBSD\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u89e3\u8aac\u3002\u3044\u3064\u306e\u9593\u306b\u3084\u3089LKM(Loadable Kernel Module)\u3067\u306f\u306a\u304f\u306a\u3063\u3066\u3044\u305f...\u3002\n * [NetBSD\u3092VirtualBox\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u307f\u308b](http://qiita.com/furandon_pig/items/5882ede06b5b5d3bf439)\n   * \u624b\u524d\u5473\u564c\u306a\u304c\u3089\u81ea\u5206\u306e\u6295\u7a3f\u5185\u5bb9...\n", "tags": ["NetBSD", "Lua"]}