{"context": "\n\n1. Prometheus\u3068\u306f?\n\u76e3\u8996\u30c4\u30fc\u30eb\u3067\u3059\u3002\n\n2. Prometheus\u306e\u69cb\u6210\nPrometheus\u306fprometheus\u30d7\u30ed\u30bb\u30b9\u3068Exporter\u3068\u547c\u3070\u308c\u308b\u30d7\u30ed\u30bb\u30b9\u304b\u3089\u69cb\u6210\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\u30fbprometheus\u306fExporter\u306b\u5bfe\u3057\u3066\u60c5\u5831\u3092\u8981\u6c42\u3059\u308b\u30d7\u30ed\u30bb\u30b9\u3067\u3059\u3002\n\u30fbExporter\u306f\u60c5\u5831\u3092\u53ce\u96c6\u3057\u3066\u3001\u53ce\u96c6\u3057\u305f\u60c5\u5831\u3092prometheus\u306b\u9001\u4fe1\u3059\u308b\u30d7\u30ed\u30bb\u30b9\u3067\u3059\u3002\nExporter\u306b\u306f\u3001\u30e1\u30e2\u30ea\u3001\u30c7\u30a3\u30b9\u30af\u30a2\u30af\u30bb\u30b9\u72b6\u6cc1\u306e\u53ce\u96c6\u3092\u76ee\u7684\u3057\u305fExporter(node_exporter)\u3084\u3001\nDatabases\u306b\u7279\u5316\u3057\u305fExporter(mysqld_exporter)\u7b49\u3001\u69d8\u3005\u306a\u7a2e\u985e\u304c\u3042\u308a\u307e\u3059\u3002\nExporter\u306e\u4e00\u89a7\u306f\u4ee5\u4e0b\u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\nhttps://prometheus.io/docs/instrumenting/exporters/\n  +--- Host ---+\n  |            |              +---------- Host -----------+\n  |            |<------------ | Exporter(node_exporter)   |\n  | prometheus |              +---------------------------+\n  |     A      |\n  |     |      |              +---------- Host -----------+\n  |     |      |<------------ | Exporter(mysqld_exporter) |\n  +-----|------+              +---------------------------+\n        |\n        |\n  +------------+\n  | web browser|\n  +------------+\n\n (*) Host :\u4eee\u60f3\u30de\u30b7\u30f3\u3084\u5b9f\u30de\u30b7\u30f3\u3092\u8868\u3057\u307e\u3059\u3002\u672c\u8a18\u4e8b\u3067\u306f\u3001\u4eee\u60f3\u30de\u30b7\u30f3(CentOS7.2)\u3092\u4f7f\u3063\u3066\u3044\u307e\u3059\u3002\n\n\n\n3. node_exporter\u3092\u4f7f\u3063\u305f\u30db\u30b9\u30c8\u306e\u76e3\u8996\n\u30db\u30b9\u30c8\u306e\u30e1\u30e2\u30ea,\u30c7\u30a3\u30b9\u30af\u306e\u30a2\u30af\u30bb\u30b9\u72b6\u6cc1\u3092\u76e3\u8996\u3059\u308b\u305f\u3081\u3001node_exporter\u3068\u3044\u3046Exporter\u3092\u4f7f\u3044\u307e\u3059\u3002\n\n3.1 \u69cb\u6210\nmaster1,master2\u306f\u4eee\u60f3\u30de\u30b7\u30f3\u3067\u3059\u3002OS\u306fCentOS7.2\u3067\u3059\u3002\n\u30dd\u30fc\u30c8\u756a\u53f7\u306f\u305d\u308c\u305e\u308c\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3067\u3059\u3002\n  - prometheus:9090\n  - node_exporter:9100\n\n\n\n                  +-------- master1 ---------+    +-------- master2 ---------+\n                  |                          |    |                          |\n +-------------+  | +----------+  +--------+ |    |  +--------+              |\n | web browser |  | |prometheus|  |  node  | |    |  |  node  |              |\n +-------------+  | |          |  |exporter| |    |  |exporter|              |\n        A         | +-- 9090 --+  +- 9100 -+ |    |  +- 9100 -+              |\n        |         |   A   A A         A      |    |      A                   |\n        |         |   |   | |         |      |    |      |                   |\n        |         |   |   | +---------+      |    |      |                   |\n        |         |   |   |                  |    |      |                   |\n        |         |   |   |                  |    |      |                   |\n        |         |   |   |                  |    |      |                   |\n        |         +---|---|-- eth0 ----------+    +------|--- eth0 ----------+\n        |             |   |    | .10                     |     | .20\n        |             |   |    |                         |     |\n        +-------------+   +------------------------------+     |\n                               |                               |\n    ---------------------------+-------------------------------+--------------\n                                       192.168.0.0/24\n\n\n3.2 \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u624b\u9806\n----------------------------------------------------------------------\n1. node_exporter\u306e\u8d77\u52d5(master1,master2\u3067\u5b9f\u65bd\u3059\u308b)\n----------------------------------------------------------------------\nmaster1\u3067\u30b3\u30f3\u30c6\u30ca(node_exporter)\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -d -p 9100:9100 --net=\"host\" prom/node-exporter\n310a1ef0c0e8ed17dbc6b0a843b9a97bd5a58d6fd0690c2f62bd196b3048fc1f\n[root@master1 ~]# docker ps\nCONTAINER ID        IMAGE                COMMAND                CREATED             STATUS              PORTS               NAMES\n310a1ef0c0e8        prom/node-exporter   \"/bin/node_exporter\"   26 seconds ago      Up 7 seconds                            ecstatic_lamarr\n\nmaster2\u3067\u30b3\u30f3\u30c6\u30ca(node_exporter)\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master2 ~]# docker run -d -p 9100:9100 --net=\"host\" prom/node-exporter\n65801b8c1c5eba173c9a21680eb9820ba54e59134f69283c7c2a9e85e83e6638\n[root@master2 ~]# docker ps\nCONTAINER ID        IMAGE                COMMAND                CREATED             STATUS              PORTS               NAMES\n65801b8c1c5e        prom/node-exporter   \"/bin/node_exporter\"   28 seconds ago      Up 22 seconds                           grave_ride\n\n\n----------------------------------------------------------------------\n2. prometheus\u306e\u8a2d\u5b9a&\u8d77\u52d5 (master1\u3067\u5b9f\u65bd\u3059\u308b)\n----------------------------------------------------------------------\n\u5b9a\u7fa9\u30d5\u30a1\u30a4\u30eb\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\n[root@master1 ~]# cd /tmp/\n[root@master1 tmp]# wget https://raw.githubusercontent.com/prometheus/prometheus/master/documentation/examples/prometheus.yml\n\n\u30d5\u30a1\u30a4\u30eb\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 tmp]# ls prometheus.yml\nprometheus.yml\n\n\u5b9a\u7fa9\u30d5\u30a1\u30a4\u30eb(prometheus.yml)\u3092\u7de8\u96c6\u3059\u308b\u3002\n\u7de8\u96c6\u7b87\u6240\u306ftargets\u306e2\u884c(\u4e0b\u8a18\u2605\u5370)\u306e\u307f\u3002node_exporter\u304c\u52d5\u4f5c\u3057\u3066\u3044\u308b\u30db\u30b9\u30c8\u306eIP\u30a2\u30c9\u30ec\u30b9\u3092\u6307\u5b9a\u3059\u308b\u3002\n[root@master1 tmp]# vi prometheus.yml\n[root@master1 tmp]# cat prometheus.yml\n# my global config\nglobal:\n  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.\n  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.\n  # scrape_timeout is set to the global default (10s).\n\n  # Attach these labels to any time series or alerts when communicating with\n  # external systems (federation, remote storage, Alertmanager).\n  external_labels:\n      monitor: 'codelab-monitor'\n\n# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.\nrule_files:\n  # - \"first.rules\"\n  # - \"second.rules\"\n\n# A scrape configuration containing exactly one endpoint to scrape:\n# Here it's Prometheus itself.\nscrape_configs:\n  # The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.\n  - job_name: 'prometheus'\n\n    # metrics_path defaults to '/metrics'\n    # scheme defaults to 'http'.\n\n    static_configs:\n      - targets: ['192.168.0.10:9100'] \u2605\n      - targets: ['192.168.0.20:9100'] \u2605\n\n[root@master1 tmp]# docker run -d -p 9090:9090 -v /tmp/prometheus.yml:/etc/prometheus/prometheus.yml prom/prometheus\n3190e11e8c7af01e8f8785fa1787ee38d5e2d04433a5bd5c5a160d17cab4a208\n\n\n\n3.3 prometheus\u306b\u30a2\u30af\u30bb\u30b9\n\u30d6\u30e9\u30a6\u30b6\u3067\u4e0b\u8a18URL\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3002\nhttp://192.168.0.10:9090\n\nmaster1,master2\u306e\u72b6\u614b\u3002master2\u306f\u30b7\u30e3\u30c3\u30c8\u30c0\u30a6\u30f3\u3057\u305f\u306e\u3067\u3001State\u304c\"DOWN\"\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\n\n4 Kubernetes,etcd\u306e\u76e3\u8996\n\u3053\u3053\u3067\u306f\u3001node-exporter\u306b\u52a0\u3048\u3001kubernetes,etcd\u306e\u76e3\u8996\u9805\u76ee\u306e\u8ffd\u52a0\u624b\u9806\u3092\u8aac\u660e\u3057\u307e\u3059\u3002\nkubernetes,etcd\u306fprometheus\u306b\u5bfe\u3059\u308b\u60c5\u5831\u53ce\u96c6\u306e\u30a4\u30f3\u30bf\u30d5\u30a7\u30fc\u30b9\u3092\u6301\u3063\u3066\u3044\u308b\u305f\u3081\u3001\nkubernetes,etcd\u306b\u5bfe\u3059\u308bExporter\u306f\u4e0d\u8981\u3067\u3059\u3002\n\n4.1 \u69cb\u6210\n\u30fbmaster1,master2\u306f\u4eee\u60f3\u30de\u30b7\u30f3\u3002OS\u306fCentOS7.2\u3067\u3059\u3002\n\u30fbmaster1\u304c\u30de\u30b9\u30bf\u3001master2\u304c\u30ce\u30fc\u30c9\u3068\u3057\u3066\u6a5f\u80fd\u3057\u307e\u3059\u3002\u3064\u307e\u308a\u3001master1\u3067kube-apiserver\u304c\u52d5\u4f5c\u3057\u3066\u3044\u307e\u3059\u3002\n\u30fb\u30dd\u30fc\u30c8\u756a\u53f7\u306f\u305d\u308c\u305e\u308c\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3067\u3059\u3002\n  - prometheus:9090\n  - node_exporter:9100\n  - kube-proxy:30900\n     => kube-proxy\u304c\u5b9b\u5148\u30dd\u30fc\u30c8\u756a\u53f7\u309230900\u304b\u30899090\u306b\u5909\u63db\u3059\u308b\u3002\n\n\n                  +-------- master1 ---------+    +-------- master2 ---------+\n                  |                          |    |                          |\n +-------------+  | +----------+  +--------+ |    |  +--------+              |\n | web browser |  | |prometheus|  |  node  | |    |  |  node  |              |\n +-------------+  | |          |  |exporter| |    |  |exporter|              |\n        A         | +-- 9090 --+  +- 9100 -+ |    |  +- 9100 -+              |\n        |         |   A   A A A       A      |    |      A                   |\n        |         |   |   | | |       |      |    |      |                   |\n        |         |   |   | | +-------+      |    |      |                   |\n        |         |   |   | |                |    |      |                   |\n        |         |   |   | |     +--------+ |    |      |                   |\n        |         |   |   | +---> |  etcd  | |    |      |                   |\n        |         |   |   |       +- 2379 -+ |    |      |                   |\n        |         |   |   |                  |    |      |                   |\n        |         | +----------+             |    |      |                   |\n        |         | |kube-proxy|             |    |      |                   |\n        |         | +-- 30900 -+             |    |      |                   |\n        |         |   |   |                  |    |      |                   |\n        |         +---|---|-- eth0 ----------+    +------|--- eth0 ----------+\n        |             |   |    | .10                     |     | .20\n        |             |   |    |                         |     |\n        +-------------+   +------------------------------+     |\n                               |                               |\n    ---------------------------+-------------------------------+--------------\n                                       192.168.0.0/24\n\n\n4.2 \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u624b\u9806(master1\u3067\u884c\u3046)\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u624b\u9806\u306f\u3001\u4e0b\u8a18\u8a18\u4e8b\u3092\u53c2\u8003\u306b\u3057\u307e\u3057\u305f\u3002\nhttps://coreos.com/blog/prometheus-and-kubernetes-up-and-running.html\n--------------------------------------\n1. \u30d5\u30a1\u30a4\u30eb\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b(\u5168\u90e8\u30673\u3064)\n--------------------------------------\nconfigmap\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\n[root@master1 prometheus]# wget https://coreos.com/assets/blog/promk8s/prometheus-configmap-1.yaml\n-\u4ee5\u4e0b\u3001\u7565-\n\ndeployment\u3068service\u3092\u5b9a\u7fa9\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\n[root@master1 prometheus]# wget https://coreos.com/assets/blog/promk8s/prometheus-deployment.yaml\n-\u4ee5\u4e0b\u3001\u7565-\n\nnode_exporter\u306e\u5b9a\u7fa9\u30d5\u30a1\u30a4\u30eb\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 prometheus]# wget https://coreos.com/assets/blog/promk8s/node-exporter.yaml\n-\u4ee5\u4e0b\u3001\u7565-\n\n\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 prometheus]# ls\nnode-exporter.yaml  prometheus-configmap-1.yaml  prometheus-deployment.yaml\n\n\n----------------------------------------\n2. prometheus-deployment.yaml\u3092\u7de8\u96c6\u3059\u308b\u3002\n----------------------------------------\nnodeSelector\u3092\u4f7f\u3063\u3066\u3001prometheus\u304cmaster1\u3067\u52d5\u304f\u3088\u3046\u306b\u3059\u308b\u3002\n\n\u5404\u30db\u30b9\u30c8\u306e\u30e9\u30d9\u30eb\u3092\u8868\u793a\u3059\u308b\u3002master1\u306f\"kubernetes.io/hostname=master1\"\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 prometheus]# kubectl get node --show-labels\nNAME      STATUS    AGE       LABELS\nmaster1   Ready     2h        kubernetes.io/hostname=master1\nmaster2   Ready     2h        kubernetes.io/hostname=master2\n\nnodeSelector\u3092\u8ffd\u52a0\u3059\u308b\uff08\u4e0b\u8a18\"\u65b0\u898f\u8ffd\u52a0\"\u306e\u90e8\u5206)\n[root@master1 prometheus]# vi prometheus-deployment.yaml\n-\u4e2d\u7565-\n    spec:\n      containers:\n      - name: prometheus\n        image: quay.io/coreos/prometheus:0.19.2\n        args:\n          - '-storage.local.retention=6h'\n          - '-storage.local.memory-chunks=500000'\n          - '-config.file=/etc/prometheus/prometheus.yml'\n        ports:\n        - name: web\n          containerPort: 9090\n        volumeMounts:\n        - name: config-volume\n          mountPath: /etc/prometheus\n      nodeSelector:                      #\u65b0\u898f\u8ffd\u52a0\n        kubernetes.io/hostname: master1  #\u65b0\u898f\u8ffd\u52a0\n      volumes:\n      - name: config-volume\n        configMap:\n          name: prometheus\n-\u4ee5\u4e0b\u3001\u7565-\n\n-----------------------------------------\n3. prometheus-configmap-1.yaml\u3092\u7de8\u96c6\u3059\u308b\u3002\n-----------------------------------------\nconfigmap\u30d5\u30a1\u30a4\u30eb\u3092\u7de8\u96c6\u3059\u308b\u3002\n[root@master1 prometheus]# vi prometheus-configmap-1.yaml\n\n    - job_name: 'etcd'\n      target_groups:\n      - targets:\n        - 192.168.0.10:2379      #\u5909\u66f4 (172.17.4.51:2379 => 192.168.0.10:2379)\n\n    - job_name: 'node_exporter'  #\u65b0\u898f\u8ffd\u52a0\n      target_groups:             #\u65b0\u898f\u8ffd\u52a0\n      - targets:                 #\u65b0\u898f\u8ffd\u52a0\n        - 192.168.0.10:9100      #\u65b0\u898f\u8ffd\u52a0\n        - 192.168.0.20:9100      #\u65b0\u898f\u8ffd\u52a0\n\n    - job_name: 'kubernetes_components'\n      kubernetes_sd_configs:\n\n----------------------------------\n4. configmap\u30ea\u30bd\u30fc\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3002\n----------------------------------\nconfigmap\u30ea\u30bd\u30fc\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 prometheus]# kubectl create -f prometheus-configmap-1.yaml\nconfigmap \"prometheus\" created\n\n\u4f5c\u6210\u3057\u305f\u30ea\u30bd\u30fc\u30b9\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 prometheus]# kubectl get configmap\nNAME         DATA      AGE\nprometheus   1         12s\n\n------------------------------------------\n5. deployment,service\u30ea\u30bd\u30fc\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3002\n------------------------------------------\ndeployment\u3068service\u30ea\u30bd\u30fc\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 prometheus]# kubectl create -f prometheus-deployment.yaml\nYou have exposed your service on an external port on all nodes in your\ncluster.  If you want to expose this service to the external internet, you may\nneed to set up firewall rules for the service port(s) (tcp:30900) to serve traffic.\n\nSee http://releases.k8s.io/release-1.2/docs/user-guide/services-firewalls.md for more details.\nservice \"prometheus\" created\ndeployment \"prometheus\" created\n\n\u4f5c\u6210\u3057\u305fdeployment\u3092\u78ba\u8a8d\u3059\u308b\u3002\"prometheus\"\u3068\u3044\u3046deployment\u304c\u4f5c\u6210\u3055\u308c\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 prometheus]# kubectl get deployment\nNAME         DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE\nprometheus   1         1         1            1           24s\n\n\u4f5c\u6210\u3057\u305fservice\u3092\u78ba\u8a8d\u3059\u308b\u3002\"prometheus\"\u3068\u3044\u3046service\u304c\u4f5c\u6210\u3055\u308c\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 prometheus]# kubectl get svc\nNAME         CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE\nkubernetes   10.254.0.1      <none>        443/TCP    1d\nprometheus   10.254.149.17   nodes         9090/TCP   32s\n\n-----------------------------------------------------------\n6. node-exporter\u7528\u306eservice,daemonset\u30ea\u30bd\u30fc\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3002\n-----------------------------------------------------------\nservice\u3068daemonset\u30ea\u30bd\u30fc\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 prometheus]# kubectl create -f node-exporter.yaml\nservice \"node-exporter\" created\ndaemonset \"node-exporter\" created\n\n\u4f5c\u6210\u3057\u305fservice\u3092\u78ba\u8a8d\u3059\u308b\u3002\"node-exporter\"\u3068\u3044\u3046service\u304c\u4f5c\u6210\u3055\u308c\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 prometheus]# kubectl get svc\nNAME            CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE\nkubernetes      10.254.0.1      <none>        443/TCP    1d\nnode-exporter   None            <none>        9100/TCP   1m\nprometheus      10.254.149.17   nodes         9090/TCP   3m\n\n\u4f5c\u6210\u3057\u305fdaemonset\u3092\u78ba\u8a8d\u3059\u308b\u3002\"node-exporter\"\u3068\u3044\u3046service\u304c\u4f5c\u6210\u3055\u308c\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 prometheus]# kubectl get daemonset\nNAME            DESIRED   CURRENT   NODE-SELECTOR   AGE\nnode-exporter   1         1         <none>          48s\n\n----------------------------------\n7. pod\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n----------------------------------\nmaster1\u3001master2\u3067node_exporter\u304c\u52d5\u4f5c\u3057\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 prometheus]# kubectl get pod -o wide\nNAME                          READY     STATUS    RESTARTS   AGE       NODE\nnode-exporter-6hh05           1/1       Running   0          47s       master2\nnode-exporter-w66rw           1/1       Running   0          1h        master1\nprometheus-1189099554-6xt11   1/1       Running   1          1h        master1\n\n----------------------------\n8. TCP\u30dd\u30fc\u30c8\u756a\u53f7\u3092\u78ba\u8a8d\u3059\u308b\u3002\n----------------------------\nkube-proxy\u306e\u30dd\u30fc\u30c8\u756a\u53f7\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 prometheus]# lsof -i:30900\nCOMMAND    PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME\nkube-prox 1024 root    7u  IPv6  26028      0t0  TCP *:30900 (LISTEN)\n\nnode_exporter\u306e\u30dd\u30fc\u30c8\u756a\u53f7\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 prometheus]# lsof -i:9100\nCOMMAND    PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME\nnode_expo 2444 root    3u  IPv6  32252      0t0  TCP *:jetdirect (LISTEN)\n\netcd\u306e\u30dd\u30fc\u30c8\u756a\u53f7\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 prometheus]# lsof -i:2379\nCOMMAND    PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME\netcd      1027 etcd    7u  IPv6  20991      0t0  TCP *:2379 (LISTEN)\n\n\n\n4.3 prometheus\u306b\u30a2\u30af\u30bb\u30b9\n\u30d6\u30e9\u30a6\u30b6\u3067\u4e0b\u8a18URL\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3002\nhttp://192.168.0.10:30900\n\n30900\u306fkube-proxy\u304cListen\u3057\u3066\u3044\u308bTCP\u30dd\u30fc\u30c8\u756a\u53f7\u3067\u3059\u3002\nkube-proxy\u306f30900\u756a\u30dd\u30fc\u30c8\u5b9b\u3066\u306e\u30d1\u30b1\u30c3\u30c8\u3092\u53d7\u4fe1\u3059\u308b\u3068\u3001\u5b9b\u5148\u30dd\u30fc\u30c8\u756a\u53f7\u30929090\u306b\u5909\u63db(DNAT)\u3057\u307e\u3059\u3002\n\u305d\u3057\u3066\u5b9b\u5148\u30dd\u30fc\u30c8\u756a\u53f79090\u306e\u30d1\u30b1\u30c3\u30c8\u3092prometheus\u30d7\u30ed\u30bb\u30b9\u306b\u8ee2\u9001\u3057\u307e\u3059\u3002\n\n4.4 \u8ab2\u984c\n(1) kube-apiserver\u306e\u60c5\u5831\u304c\u8868\u793a\u3067\u304d\u306a\u3044\u3002\netcd\u3068node_exporter\u306e\u60c5\u5831\u306f\u8868\u793a\u3067\u304d\u3066\u3044\u308b\u3002\n\u305f\u3076\u3093\u3001kube-apiserver\u306b\u5bfe\u3059\u308bhttps\u30a2\u30af\u30bb\u30b9\u304c\u6b63\u3057\u304f\u8a2d\u5b9a\u3067\u304d\u3066\u3044\u306a\u3044\u305f\u3081\u3060\u3068\u601d\u308f\u308c\u308b\uff08\u8abf\u67fb\u4e2d\uff09\u3002\n\n5.\u53c2\u8003\u60c5\u5831\n[Prometheus]https://github.com/prometheus/prometheus\n[node_exporter]https://github.com/prometheus/node_exporter\n[Prometheus and Kubernetes up and running]https://coreos.com/blog/prometheus-and-kubernetes-up-and-running.html\n#1. Prometheus\u3068\u306f?\n\u76e3\u8996\u30c4\u30fc\u30eb\u3067\u3059\u3002\n\n\n#2. Prometheus\u306e\u69cb\u6210\n\nPrometheus\u306fprometheus\u30d7\u30ed\u30bb\u30b9\u3068Exporter\u3068\u547c\u3070\u308c\u308b\u30d7\u30ed\u30bb\u30b9\u304b\u3089\u69cb\u6210\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n\u30fbprometheus\u306fExporter\u306b\u5bfe\u3057\u3066\u60c5\u5831\u3092\u8981\u6c42\u3059\u308b\u30d7\u30ed\u30bb\u30b9\u3067\u3059\u3002\n\u30fbExporter\u306f\u60c5\u5831\u3092\u53ce\u96c6\u3057\u3066\u3001\u53ce\u96c6\u3057\u305f\u60c5\u5831\u3092prometheus\u306b\u9001\u4fe1\u3059\u308b\u30d7\u30ed\u30bb\u30b9\u3067\u3059\u3002\nExporter\u306b\u306f\u3001\u30e1\u30e2\u30ea\u3001\u30c7\u30a3\u30b9\u30af\u30a2\u30af\u30bb\u30b9\u72b6\u6cc1\u306e\u53ce\u96c6\u3092\u76ee\u7684\u3057\u305fExporter(node_exporter)\u3084\u3001\nDatabases\u306b\u7279\u5316\u3057\u305fExporter(mysqld_exporter)\u7b49\u3001\u69d8\u3005\u306a\u7a2e\u985e\u304c\u3042\u308a\u307e\u3059\u3002\n\nExporter\u306e\u4e00\u89a7\u306f\u4ee5\u4e0b\u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\nhttps://prometheus.io/docs/instrumenting/exporters/\n\n\n```\n  +--- Host ---+\n  |            |              +---------- Host -----------+\n  |            |<------------ | Exporter(node_exporter)   |\n  | prometheus |              +---------------------------+\n  |     A      |\n  |     |      |              +---------- Host -----------+\n  |     |      |<------------ | Exporter(mysqld_exporter) |\n  +-----|------+              +---------------------------+\n        |\n        |\n  +------------+\n  | web browser|\n  +------------+\n\n (*) Host :\u4eee\u60f3\u30de\u30b7\u30f3\u3084\u5b9f\u30de\u30b7\u30f3\u3092\u8868\u3057\u307e\u3059\u3002\u672c\u8a18\u4e8b\u3067\u306f\u3001\u4eee\u60f3\u30de\u30b7\u30f3(CentOS7.2)\u3092\u4f7f\u3063\u3066\u3044\u307e\u3059\u3002\n\n```\n\n\n#3. node_exporter\u3092\u4f7f\u3063\u305f\u30db\u30b9\u30c8\u306e\u76e3\u8996\n\u30db\u30b9\u30c8\u306e\u30e1\u30e2\u30ea,\u30c7\u30a3\u30b9\u30af\u306e\u30a2\u30af\u30bb\u30b9\u72b6\u6cc1\u3092\u76e3\u8996\u3059\u308b\u305f\u3081\u3001node_exporter\u3068\u3044\u3046Exporter\u3092\u4f7f\u3044\u307e\u3059\u3002\n\n##3.1 \u69cb\u6210\n```\nmaster1,master2\u306f\u4eee\u60f3\u30de\u30b7\u30f3\u3067\u3059\u3002OS\u306fCentOS7.2\u3067\u3059\u3002\n\u30dd\u30fc\u30c8\u756a\u53f7\u306f\u305d\u308c\u305e\u308c\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3067\u3059\u3002\n  - prometheus:9090\n  - node_exporter:9100\n\n\n\n                  +-------- master1 ---------+    +-------- master2 ---------+\n                  |                          |    |                          |\n +-------------+  | +----------+  +--------+ |    |  +--------+              |\n | web browser |  | |prometheus|  |  node  | |    |  |  node  |              |\n +-------------+  | |          |  |exporter| |    |  |exporter|              |\n        A         | +-- 9090 --+  +- 9100 -+ |    |  +- 9100 -+              |\n        |         |   A   A A         A      |    |      A                   |\n        |         |   |   | |         |      |    |      |                   |\n        |         |   |   | +---------+      |    |      |                   |\n        |         |   |   |                  |    |      |                   |\n        |         |   |   |                  |    |      |                   |\n        |         |   |   |                  |    |      |                   |\n        |         +---|---|-- eth0 ----------+    +------|--- eth0 ----------+\n        |             |   |    | .10                     |     | .20\n        |             |   |    |                         |     |\n        +-------------+   +------------------------------+     |\n                               |                               |\n    ---------------------------+-------------------------------+--------------\n                                       192.168.0.0/24\n```\n\n\n##3.2 \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u624b\u9806\n\n```\n----------------------------------------------------------------------\n1. node_exporter\u306e\u8d77\u52d5(master1,master2\u3067\u5b9f\u65bd\u3059\u308b)\n----------------------------------------------------------------------\nmaster1\u3067\u30b3\u30f3\u30c6\u30ca(node_exporter)\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -d -p 9100:9100 --net=\"host\" prom/node-exporter\n310a1ef0c0e8ed17dbc6b0a843b9a97bd5a58d6fd0690c2f62bd196b3048fc1f\n[root@master1 ~]# docker ps\nCONTAINER ID        IMAGE                COMMAND                CREATED             STATUS              PORTS               NAMES\n310a1ef0c0e8        prom/node-exporter   \"/bin/node_exporter\"   26 seconds ago      Up 7 seconds                            ecstatic_lamarr\n\nmaster2\u3067\u30b3\u30f3\u30c6\u30ca(node_exporter)\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master2 ~]# docker run -d -p 9100:9100 --net=\"host\" prom/node-exporter\n65801b8c1c5eba173c9a21680eb9820ba54e59134f69283c7c2a9e85e83e6638\n[root@master2 ~]# docker ps\nCONTAINER ID        IMAGE                COMMAND                CREATED             STATUS              PORTS               NAMES\n65801b8c1c5e        prom/node-exporter   \"/bin/node_exporter\"   28 seconds ago      Up 22 seconds                           grave_ride\n\n\n----------------------------------------------------------------------\n2. prometheus\u306e\u8a2d\u5b9a&\u8d77\u52d5 (master1\u3067\u5b9f\u65bd\u3059\u308b)\n----------------------------------------------------------------------\n\u5b9a\u7fa9\u30d5\u30a1\u30a4\u30eb\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\n[root@master1 ~]# cd /tmp/\n[root@master1 tmp]# wget https://raw.githubusercontent.com/prometheus/prometheus/master/documentation/examples/prometheus.yml\n\n\u30d5\u30a1\u30a4\u30eb\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 tmp]# ls prometheus.yml\nprometheus.yml\n\n\u5b9a\u7fa9\u30d5\u30a1\u30a4\u30eb(prometheus.yml)\u3092\u7de8\u96c6\u3059\u308b\u3002\n\u7de8\u96c6\u7b87\u6240\u306ftargets\u306e2\u884c(\u4e0b\u8a18\u2605\u5370)\u306e\u307f\u3002node_exporter\u304c\u52d5\u4f5c\u3057\u3066\u3044\u308b\u30db\u30b9\u30c8\u306eIP\u30a2\u30c9\u30ec\u30b9\u3092\u6307\u5b9a\u3059\u308b\u3002\n[root@master1 tmp]# vi prometheus.yml\n[root@master1 tmp]# cat prometheus.yml\n# my global config\nglobal:\n  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.\n  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.\n  # scrape_timeout is set to the global default (10s).\n\n  # Attach these labels to any time series or alerts when communicating with\n  # external systems (federation, remote storage, Alertmanager).\n  external_labels:\n      monitor: 'codelab-monitor'\n\n# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.\nrule_files:\n  # - \"first.rules\"\n  # - \"second.rules\"\n\n# A scrape configuration containing exactly one endpoint to scrape:\n# Here it's Prometheus itself.\nscrape_configs:\n  # The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.\n  - job_name: 'prometheus'\n\n    # metrics_path defaults to '/metrics'\n    # scheme defaults to 'http'.\n\n    static_configs:\n      - targets: ['192.168.0.10:9100'] \u2605\n      - targets: ['192.168.0.20:9100'] \u2605\n\n[root@master1 tmp]# docker run -d -p 9090:9090 -v /tmp/prometheus.yml:/etc/prometheus/prometheus.yml prom/prometheus\n3190e11e8c7af01e8f8785fa1787ee38d5e2d04433a5bd5c5a160d17cab4a208\n\n```\n\n##3.3 prometheus\u306b\u30a2\u30af\u30bb\u30b9\n\n\u30d6\u30e9\u30a6\u30b6\u3067\u4e0b\u8a18URL\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3002\nhttp://192.168.0.10:9090\n![prometheus.png](https://qiita-image-store.s3.amazonaws.com/0/146813/a8e84c53-0e66-f323-2dcb-c4f10e653a50.png)\n\nmaster1,master2\u306e\u72b6\u614b\u3002master2\u306f\u30b7\u30e3\u30c3\u30c8\u30c0\u30a6\u30f3\u3057\u305f\u306e\u3067\u3001State\u304c\"DOWN\"\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n![prometheus-status.png](https://qiita-image-store.s3.amazonaws.com/0/146813/2130c4b1-ccf7-3aff-d4a5-c9d254184462.png)\n\n\n\n#4 Kubernetes,etcd\u306e\u76e3\u8996\n\u3053\u3053\u3067\u306f\u3001node-exporter\u306b\u52a0\u3048\u3001kubernetes,etcd\u306e\u76e3\u8996\u9805\u76ee\u306e\u8ffd\u52a0\u624b\u9806\u3092\u8aac\u660e\u3057\u307e\u3059\u3002\nkubernetes,etcd\u306fprometheus\u306b\u5bfe\u3059\u308b\u60c5\u5831\u53ce\u96c6\u306e\u30a4\u30f3\u30bf\u30d5\u30a7\u30fc\u30b9\u3092\u6301\u3063\u3066\u3044\u308b\u305f\u3081\u3001\nkubernetes,etcd\u306b\u5bfe\u3059\u308bExporter\u306f\u4e0d\u8981\u3067\u3059\u3002\n\n\n##4.1 \u69cb\u6210\n\n```\n\u30fbmaster1,master2\u306f\u4eee\u60f3\u30de\u30b7\u30f3\u3002OS\u306fCentOS7.2\u3067\u3059\u3002\n\u30fbmaster1\u304c\u30de\u30b9\u30bf\u3001master2\u304c\u30ce\u30fc\u30c9\u3068\u3057\u3066\u6a5f\u80fd\u3057\u307e\u3059\u3002\u3064\u307e\u308a\u3001master1\u3067kube-apiserver\u304c\u52d5\u4f5c\u3057\u3066\u3044\u307e\u3059\u3002\n\u30fb\u30dd\u30fc\u30c8\u756a\u53f7\u306f\u305d\u308c\u305e\u308c\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3067\u3059\u3002\n  - prometheus:9090\n  - node_exporter:9100\n  - kube-proxy:30900\n     => kube-proxy\u304c\u5b9b\u5148\u30dd\u30fc\u30c8\u756a\u53f7\u309230900\u304b\u30899090\u306b\u5909\u63db\u3059\u308b\u3002\n\n\n                  +-------- master1 ---------+    +-------- master2 ---------+\n                  |                          |    |                          |\n +-------------+  | +----------+  +--------+ |    |  +--------+              |\n | web browser |  | |prometheus|  |  node  | |    |  |  node  |              |\n +-------------+  | |          |  |exporter| |    |  |exporter|              |\n        A         | +-- 9090 --+  +- 9100 -+ |    |  +- 9100 -+              |\n        |         |   A   A A A       A      |    |      A                   |\n        |         |   |   | | |       |      |    |      |                   |\n        |         |   |   | | +-------+      |    |      |                   |\n        |         |   |   | |                |    |      |                   |\n        |         |   |   | |     +--------+ |    |      |                   |\n        |         |   |   | +---> |  etcd  | |    |      |                   |\n        |         |   |   |       +- 2379 -+ |    |      |                   |\n        |         |   |   |                  |    |      |                   |\n        |         | +----------+             |    |      |                   |\n        |         | |kube-proxy|             |    |      |                   |\n        |         | +-- 30900 -+             |    |      |                   |\n        |         |   |   |                  |    |      |                   |\n        |         +---|---|-- eth0 ----------+    +------|--- eth0 ----------+\n        |             |   |    | .10                     |     | .20\n        |             |   |    |                         |     |\n        +-------------+   +------------------------------+     |\n                               |                               |\n    ---------------------------+-------------------------------+--------------\n                                       192.168.0.0/24\n```\n\n\n\n##4.2 \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u624b\u9806(master1\u3067\u884c\u3046)\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u624b\u9806\u306f\u3001\u4e0b\u8a18\u8a18\u4e8b\u3092\u53c2\u8003\u306b\u3057\u307e\u3057\u305f\u3002\nhttps://coreos.com/blog/prometheus-and-kubernetes-up-and-running.html\n\n\n```\n--------------------------------------\n1. \u30d5\u30a1\u30a4\u30eb\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b(\u5168\u90e8\u30673\u3064)\n--------------------------------------\nconfigmap\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\n[root@master1 prometheus]# wget https://coreos.com/assets/blog/promk8s/prometheus-configmap-1.yaml\n-\u4ee5\u4e0b\u3001\u7565-\n\ndeployment\u3068service\u3092\u5b9a\u7fa9\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\n[root@master1 prometheus]# wget https://coreos.com/assets/blog/promk8s/prometheus-deployment.yaml\n-\u4ee5\u4e0b\u3001\u7565-\n\nnode_exporter\u306e\u5b9a\u7fa9\u30d5\u30a1\u30a4\u30eb\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 prometheus]# wget https://coreos.com/assets/blog/promk8s/node-exporter.yaml\n-\u4ee5\u4e0b\u3001\u7565-\n\n\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 prometheus]# ls\nnode-exporter.yaml  prometheus-configmap-1.yaml  prometheus-deployment.yaml\n\n\n----------------------------------------\n2. prometheus-deployment.yaml\u3092\u7de8\u96c6\u3059\u308b\u3002\n----------------------------------------\nnodeSelector\u3092\u4f7f\u3063\u3066\u3001prometheus\u304cmaster1\u3067\u52d5\u304f\u3088\u3046\u306b\u3059\u308b\u3002\n\n\u5404\u30db\u30b9\u30c8\u306e\u30e9\u30d9\u30eb\u3092\u8868\u793a\u3059\u308b\u3002master1\u306f\"kubernetes.io/hostname=master1\"\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 prometheus]# kubectl get node --show-labels\nNAME      STATUS    AGE       LABELS\nmaster1   Ready     2h        kubernetes.io/hostname=master1\nmaster2   Ready     2h        kubernetes.io/hostname=master2\n\nnodeSelector\u3092\u8ffd\u52a0\u3059\u308b\uff08\u4e0b\u8a18\"\u65b0\u898f\u8ffd\u52a0\"\u306e\u90e8\u5206)\n[root@master1 prometheus]# vi prometheus-deployment.yaml\n-\u4e2d\u7565-\n    spec:\n      containers:\n      - name: prometheus\n        image: quay.io/coreos/prometheus:0.19.2\n        args:\n          - '-storage.local.retention=6h'\n          - '-storage.local.memory-chunks=500000'\n          - '-config.file=/etc/prometheus/prometheus.yml'\n        ports:\n        - name: web\n          containerPort: 9090\n        volumeMounts:\n        - name: config-volume\n          mountPath: /etc/prometheus\n      nodeSelector:                      #\u65b0\u898f\u8ffd\u52a0\n        kubernetes.io/hostname: master1  #\u65b0\u898f\u8ffd\u52a0\n      volumes:\n      - name: config-volume\n        configMap:\n          name: prometheus\n-\u4ee5\u4e0b\u3001\u7565-\n\n-----------------------------------------\n3. prometheus-configmap-1.yaml\u3092\u7de8\u96c6\u3059\u308b\u3002\n-----------------------------------------\nconfigmap\u30d5\u30a1\u30a4\u30eb\u3092\u7de8\u96c6\u3059\u308b\u3002\n[root@master1 prometheus]# vi prometheus-configmap-1.yaml\n\n    - job_name: 'etcd'\n      target_groups:\n      - targets:\n        - 192.168.0.10:2379      #\u5909\u66f4 (172.17.4.51:2379 => 192.168.0.10:2379)\n\n    - job_name: 'node_exporter'  #\u65b0\u898f\u8ffd\u52a0\n      target_groups:             #\u65b0\u898f\u8ffd\u52a0\n      - targets:                 #\u65b0\u898f\u8ffd\u52a0\n        - 192.168.0.10:9100      #\u65b0\u898f\u8ffd\u52a0\n        - 192.168.0.20:9100      #\u65b0\u898f\u8ffd\u52a0\n\n    - job_name: 'kubernetes_components'\n      kubernetes_sd_configs:\n\n----------------------------------\n4. configmap\u30ea\u30bd\u30fc\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3002\n----------------------------------\nconfigmap\u30ea\u30bd\u30fc\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 prometheus]# kubectl create -f prometheus-configmap-1.yaml\nconfigmap \"prometheus\" created\n\n\u4f5c\u6210\u3057\u305f\u30ea\u30bd\u30fc\u30b9\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 prometheus]# kubectl get configmap\nNAME         DATA      AGE\nprometheus   1         12s\n\n------------------------------------------\n5. deployment,service\u30ea\u30bd\u30fc\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3002\n------------------------------------------\ndeployment\u3068service\u30ea\u30bd\u30fc\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 prometheus]# kubectl create -f prometheus-deployment.yaml\nYou have exposed your service on an external port on all nodes in your\ncluster.  If you want to expose this service to the external internet, you may\nneed to set up firewall rules for the service port(s) (tcp:30900) to serve traffic.\n\nSee http://releases.k8s.io/release-1.2/docs/user-guide/services-firewalls.md for more details.\nservice \"prometheus\" created\ndeployment \"prometheus\" created\n\n\u4f5c\u6210\u3057\u305fdeployment\u3092\u78ba\u8a8d\u3059\u308b\u3002\"prometheus\"\u3068\u3044\u3046deployment\u304c\u4f5c\u6210\u3055\u308c\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 prometheus]# kubectl get deployment\nNAME         DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE\nprometheus   1         1         1            1           24s\n\n\u4f5c\u6210\u3057\u305fservice\u3092\u78ba\u8a8d\u3059\u308b\u3002\"prometheus\"\u3068\u3044\u3046service\u304c\u4f5c\u6210\u3055\u308c\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 prometheus]# kubectl get svc\nNAME         CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE\nkubernetes   10.254.0.1      <none>        443/TCP    1d\nprometheus   10.254.149.17   nodes         9090/TCP   32s\n\n-----------------------------------------------------------\n6. node-exporter\u7528\u306eservice,daemonset\u30ea\u30bd\u30fc\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3002\n-----------------------------------------------------------\nservice\u3068daemonset\u30ea\u30bd\u30fc\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 prometheus]# kubectl create -f node-exporter.yaml\nservice \"node-exporter\" created\ndaemonset \"node-exporter\" created\n\n\u4f5c\u6210\u3057\u305fservice\u3092\u78ba\u8a8d\u3059\u308b\u3002\"node-exporter\"\u3068\u3044\u3046service\u304c\u4f5c\u6210\u3055\u308c\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 prometheus]# kubectl get svc\nNAME            CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE\nkubernetes      10.254.0.1      <none>        443/TCP    1d\nnode-exporter   None            <none>        9100/TCP   1m\nprometheus      10.254.149.17   nodes         9090/TCP   3m\n\n\u4f5c\u6210\u3057\u305fdaemonset\u3092\u78ba\u8a8d\u3059\u308b\u3002\"node-exporter\"\u3068\u3044\u3046service\u304c\u4f5c\u6210\u3055\u308c\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 prometheus]# kubectl get daemonset\nNAME            DESIRED   CURRENT   NODE-SELECTOR   AGE\nnode-exporter   1         1         <none>          48s\n\n----------------------------------\n7. pod\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n----------------------------------\nmaster1\u3001master2\u3067node_exporter\u304c\u52d5\u4f5c\u3057\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 prometheus]# kubectl get pod -o wide\nNAME                          READY     STATUS    RESTARTS   AGE       NODE\nnode-exporter-6hh05           1/1       Running   0          47s       master2\nnode-exporter-w66rw           1/1       Running   0          1h        master1\nprometheus-1189099554-6xt11   1/1       Running   1          1h        master1\n\n----------------------------\n8. TCP\u30dd\u30fc\u30c8\u756a\u53f7\u3092\u78ba\u8a8d\u3059\u308b\u3002\n----------------------------\nkube-proxy\u306e\u30dd\u30fc\u30c8\u756a\u53f7\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 prometheus]# lsof -i:30900\nCOMMAND    PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME\nkube-prox 1024 root    7u  IPv6  26028      0t0  TCP *:30900 (LISTEN)\n\nnode_exporter\u306e\u30dd\u30fc\u30c8\u756a\u53f7\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 prometheus]# lsof -i:9100\nCOMMAND    PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME\nnode_expo 2444 root    3u  IPv6  32252      0t0  TCP *:jetdirect (LISTEN)\n\netcd\u306e\u30dd\u30fc\u30c8\u756a\u53f7\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 prometheus]# lsof -i:2379\nCOMMAND    PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME\netcd      1027 etcd    7u  IPv6  20991      0t0  TCP *:2379 (LISTEN)\n\n```\n\n\n##4.3 prometheus\u306b\u30a2\u30af\u30bb\u30b9\n\n\u30d6\u30e9\u30a6\u30b6\u3067\u4e0b\u8a18URL\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3002\nhttp://192.168.0.10:30900\n![prometheus_kubernetes_etcd.png](https://qiita-image-store.s3.amazonaws.com/0/146813/ed022258-9b60-3c07-9b1c-20c8016d99ba.png)\n\n30900\u306fkube-proxy\u304cListen\u3057\u3066\u3044\u308bTCP\u30dd\u30fc\u30c8\u756a\u53f7\u3067\u3059\u3002\nkube-proxy\u306f30900\u756a\u30dd\u30fc\u30c8\u5b9b\u3066\u306e\u30d1\u30b1\u30c3\u30c8\u3092\u53d7\u4fe1\u3059\u308b\u3068\u3001\u5b9b\u5148\u30dd\u30fc\u30c8\u756a\u53f7\u30929090\u306b\u5909\u63db(DNAT)\u3057\u307e\u3059\u3002\n\u305d\u3057\u3066\u5b9b\u5148\u30dd\u30fc\u30c8\u756a\u53f79090\u306e\u30d1\u30b1\u30c3\u30c8\u3092prometheus\u30d7\u30ed\u30bb\u30b9\u306b\u8ee2\u9001\u3057\u307e\u3059\u3002\n\n\n##4.4 \u8ab2\u984c\n\n(1) kube-apiserver\u306e\u60c5\u5831\u304c\u8868\u793a\u3067\u304d\u306a\u3044\u3002\netcd\u3068node_exporter\u306e\u60c5\u5831\u306f\u8868\u793a\u3067\u304d\u3066\u3044\u308b\u3002\n\u305f\u3076\u3093\u3001kube-apiserver\u306b\u5bfe\u3059\u308bhttps\u30a2\u30af\u30bb\u30b9\u304c\u6b63\u3057\u304f\u8a2d\u5b9a\u3067\u304d\u3066\u3044\u306a\u3044\u305f\u3081\u3060\u3068\u601d\u308f\u308c\u308b\uff08\u8abf\u67fb\u4e2d\uff09\u3002\n\n\n\n#5.\u53c2\u8003\u60c5\u5831\n[Prometheus]https://github.com/prometheus/prometheus\n[node_exporter]https://github.com/prometheus/node_exporter\n[Prometheus and Kubernetes up and running]https://coreos.com/blog/prometheus-and-kubernetes-up-and-running.html\n", "tags": ["prometheus", "CentOS", "etcd", "kubernetes", "\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb"]}