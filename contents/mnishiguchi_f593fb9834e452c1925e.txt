{"tags": ["devise", "OmniAuth", "Rails", "Twitter"], "context": " More than 1 year has passed since last update.\nOmniAuth\u8a8d\u8a3c\u306b\u3064\u3044\u3066\u306e\u30e1\u30e2\u3002\n\n\u6982\u8981\n\nDevise\u3067\u8a8d\u8a3c\u3092\u884c\u3046Rails\u30a2\u30d7\u30ea\u306b\u5bfe\u3057\u3066\u3001OmniAuth\u3067\u306e\u8a8d\u8a3c\u6a5f\u80fd\u3092\u8ffd\u52a0\u3059\u308b\u3002\nTwitter\u3092\u30d7\u30ed\u30d0\u30a4\u30c0\u30fc\u3068\u3059\u308b\u3002\nOmniAuth\u3067\u8a8d\u8a3c\u3059\u308b\u5834\u5408\u306f\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u5165\u529b\u3092\u514d\u9664\u3059\u308b\u3002\n\u65b0\u898f\u767b\u9332\u6642\u3001email\u306f\u5fc5\u9808\u9805\u76ee\u3068\u3059\u308b\u3002\nDevise\u306econfirmable\u30e2\u30b8\u30e5\u30fc\u30eb\u3067email\u306e\u78ba\u8a8d\u3092\u3059\u308b\u3002\n\n\n\u624b\u9806\n\n\u8a8d\u8a3c\u3057\u3066\u3082\u3089\u3044\u305f\u3044\u30d7\u30ed\u30d0\u30a4\u30c0\u30fc\u306b\u30a2\u30d7\u30ea\u3092\u767b\u9332\u3057\u3001API\u30ad\u30fc\u7b49\u3092\u53d6\u5f97\nTwitter\u306eApplication Management\u30b5\u30a4\u30c8\u306b\u884c\u304d\u3001\u30d5\u30a9\u30fc\u30e0\u306b\u5fc5\u8981\u4e8b\u9805\u3092\u8a18\u5165\u3057\u3066\u63d0\u51fa\n\nhttps://apps.twitter.com/app/new\n\n\n\n\nName:        \u30a2\u30d7\u30ea\u540d\uff08\u30e6\u30fc\u30b6\u30fc\u304c\u8a8d\u8a3c\u624b\u7d9a\u304d\u3059\u308b\u3068\u304d\u306b\u8868\u793a\u3055\u308c\u308b\uff09\n\nDescription: \u30a2\u30d7\u30ea\u306b\u3064\u3044\u3066\u306e\u8aac\u660e \uff08\u30e6\u30fc\u30b6\u30fc\u304c\u8a8d\u8a3c\u624b\u7d9a\u304d\u3059\u308b\u3068\u304d\u306b\u8868\u793a\u3055\u308c\u308b\uff09\n\nWebsite:     \u4ecaWebsite\u304c\u306a\u3051\u308c\u3070\u3001\u4eee\u306eURL\u3092\u8a18\u5165\u3059\u308b\u3002\u5f8c\u306b\u5909\u66f4\u53ef\u80fd\u3002\n\nCallback URL:  omniauth-twitter\u306b\u3088\u308a\u8a8d\u8a3c\u5b8c\u4e86\u5f8c\u306b\u547c\u3070\u308c\u308bURL\u3092\u8a18\u5165\u3059\u308b\u3002Devise\u3092\u4f7f\u7528\u3057\u3066\u3044\u308b\u5834\u5408\u306fDevise\u304c\u9762\u5012\u3092\u898b\u3066\u304f\u308c\u308b\u306e\u3067\u3001\u6df1\u304f\u8003\u3048\u305ahttp://127.0.0.1:3000/auth/twitter/callback\u3092\u5165\u529b\u3059\u308b\u3002\n\n\u5de6\u304b\u3089\uff13\u756a\u76ee\u306e\u30bf\u30d6(Keys and Access Tokens)\u3092\u30af\u30ea\u30c3\u30af\u3057\u3001API Key\u3068API Secret\u3092\u78ba\u8a8d\u3002\n\n\nGemfile\u306bomniauth-twitter\u3092\u8ffd\u52a0\n\n/Gemfile\n#...\n\ngem 'omniauth-twitter'\n\n#...\n\n\n$ bin/bundle\n\n\nAPI Key\u3068API Secret\u3092/config/secrets.yml\u306b\u52a0\u3048\u308b\n\u76f4\u63a5\u30da\u30fc\u30b9\u30c8\u305b\u305a\u306b\u74b0\u5883\u5909\u6570\u7d4c\u7531\u3067\u6e21\u3059\u3088\u3046\u306b\u3059\u308b\u3068\u3088\u3044\u3002\n\u3053\u308c\u3067\u4ee5\u964d\u306f\u3001Development/Producton\u74b0\u5883\u3092\u554f\u308f\u305aRails.application.secrets.twitter_api_key\u3001Rails.application.secrets.twitter_api_secret\u3068\u3057\u3066API Key\u3068API Secret\u306b\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\u306b\u306a\u308b\u3002\n\n/config/secrets.yml\nproduction:\n  # ==> Rails\n  secret_key_base:     <%= ENV[\"SECRET_KEY_BASE\"] %>\n  # ==> OmniAuth\n  facebook_api_key:    <%= ENV[\"FACEBOOK_API_KEY\"] %>\n  facebook_api_secret: <%= ENV[\"FACEBOOK_API_SECRET\"] %>\n  twitter_api_key:     <%= ENV[\"TWITTER_API_KEY\"] %>\n  twitter_api_secret:  <%= ENV[\"TWITTER_API_SECRET\"] %>\n\ndevelopment:\n  # ==> Rails\n  secret_key_base:     <%= ENV[\"SECRET_KEY_BASE_DEV\"] %>\n  # ==> OmniAuth\n  facebook_api_key:    <%= ENV[\"FACEBOOK_API_KEY\"] %>\n  facebook_api_secret: <%= ENV[\"FACEBOOK_API_SECRET\"] %>\n  twitter_api_key:     <%= ENV[\"TWITTER_API_KEY\"] %>\n  twitter_api_secret:  <%= ENV[\"TWITTER_API_SECRET\"] %>\n\ntest:\n  # ==> Rails\n  secret_key_base:     <%= ENV[\"SECRET_KEY_BASE_TEST\"] %>\n\n\nDevelopment\u74b0\u5883\u306e\u5834\u5408\u3001dotenv\u3092\u5229\u7528\u3057\u3066\u3001API Key\u7b49\u3092/.env\u304b\u3089\u81ea\u52d5\u3067\u74b0\u5883\u5909\u6570\u306b\u5272\u308a\u5f53\u3066\u308b\u3053\u3068\u3082\u53ef\u80fd\u3002\n\n/.env\n#...\n\n# ==> OmniAuth\nTWITTER_API_KEY    = \"T0ONiGrNuMNsKb5AyNC05mOpe\"\nTWITTER_API_SECRET = \"FxrQ6ddvlVbIaUlvEm0xg4fgoK9ACmWWnkesdU60ck1vJFoBM8\"\n\n#...\n\n\n\u3053\u306e\u6642\u70b9\u3067git\u306b\u79d8\u5bc6\u306e\u30c7\u30fc\u30bf\u304cadd\u3055\u308c\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\u3057\u3066\u304a\u304f\u306e\u304c\u8ce2\u660e\u3002\n# Ignore secrets\n.env\n.secret\n\n\nDevise\u306b\u30d7\u30ed\u30d0\u30a4\u30c0\u30fc\u540d\u3001API Key\u3001API Secret\u3092\u6e21\u3059\n/config/initializers/devise.rb\u306e230\u884c\u76ee\u3042\u305f\u308a\u306b\u30d7\u30ec\u30fc\u30b9\u30db\u30eb\u30c0\u30fc\u304c\u3042\u308b\u3002\n\n/config/initializers/devise.rb\n#...\n\n  # ==> OmniAuth\n  config.omniauth :twitter, Rails.application.secrets.twitter_api_key,\n                            Rails.application.secrets.twitter_api_secret\n\n#...\n\n\n\u6ce8\u610f: \u8907\u6570\u306e\u53c2\u8003\u8cc7\u6599\u3092\u53c2\u7167\u3057\u3066\u3044\u308b\u3068\u6df7\u4e71\u3057\u3084\u3059\u3044\u304c\u3001Devise\u8a8d\u8a3c\u4ed8\u304d\u306e\u30a2\u30d7\u30ea\u3067OmniAuth\u3092\u5b9f\u88c5\u3059\u308b\u5834\u5408\u306f\u3001Devise\u304cmiddleware\u3092\u4f5c\u3063\u3066\u304f\u308c\u308b\u306e\u3067\u3001/config/initializers/omniauth.rb\u306f\u4e0d\u8981\u3002\u3053\u3053\u3067\u624b\u52d5\u3067middleware\u3092\u4f5c\u3063\u3066\u3057\u307e\u3046\u3068\u3001Devise\u306e\u3064\u304f\u3063\u305fmiddleware\u3068\u885d\u7a81\u3057\u3001\u8a8d\u8a3c\u304c\u5168\u3066\u5931\u6557\u3057\u3066\u3057\u307e\u3046\u3002\n\n/config/initializers/omniauth.rb\n# \u6ce8\u610f: Devise\u4ed8\u304d\u306e\u30a2\u30d7\u30ea\u3067OmniAuth\u3092\u5b9f\u88c5\u3059\u308b\u5834\u5408\u306f\u4e0d\u8981\n# Rails.application.config.middleware.use OmniAuth::Builder do\n#   provider :twitter, Rails.application.secrets.twitter_api_key,\n#                      Rails.application.secrets.twitter_api_secret\n# end\n\n\n\nomniauthable\u30e2\u30b8\u30e5\u30fc\u30eb\u3092User\u30e2\u30c7\u30eb\u306b\u8ffd\u52a0\n\n/app/models/user.rb\nclass User < ActiveRecord::Base\n  #...\n\n  devise :database_authenticatable, :registerable, :confirmable,\n         :recoverable, :rememberable, :trackable, :validatable,\n         :omniauthable, omniauth_providers: [:twitter]\n\n  #...\n\n\n\u3053\u308c\u3067Devise\u304c\u81ea\u52d5\u3067Sign in with Twitter\u30ea\u30f3\u30af\u3092\u751f\u6210\u3057\u3066\u304f\u308c\u308b\u3002\u8a66\u3057\u306b/users/sign_up\u306b\u884c\u3063\u3066\u30ea\u30f3\u30af\u304c\u3042\u308b\u304b\u3069\u3046\u304b\u78ba\u8a8d\u3059\u308b\u3002\n\n\nuser_omniauth_authorize_path(provider)\nDevise\u304c\u81ea\u52d5\u3067 \u751f\u6210\u3057\u305fuser_omniauth_authorize_path\u30e1\u30bd\u30c3\u30c9\u3092\u5229\u7528\u3057\u3066\u597d\u304d\u306a\u3068\u3053\u308d\u306bOmniAuth\u8a8d\u8a3c\u3078\u306e\u30ea\u30f3\u30af\u3092\u8cbc\u308b\u3002\n= link_to \"Log in with twitter\", user_omniauth_authorize_path(:twitter)\n\n\nOmniAuth\u8a8d\u8a3c\u30c7\u30fc\u30bf\u3092\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u4fdd\u5b58\u3059\u308b\u305f\u3081\u306e\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\n$ rails g migration add_omniauth_to_users provider uid\n\n\n\nprovider: \u8a8d\u8a3c\u3057\u305f\u30d7\u30ed\u30d0\u30a4\u30c0\u30fc\u540d\n\nuid: \u4e00\u610f\u7684ID\n\n$ rake db:migrate\n\n\nOmniAuth callback\u3092\u53d6\u308a\u6271\u3046\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u3092\u4f5c\u6210\n$ rails g controller omniauth_callbacks\n\n\u672c\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u3092devise_for\u306b\u767b\u9332\u3059\u308b\n\n/config/routes.rb\nRails.application.routes.draw do\n\n  #...\n\n  devise_for :users, controllers: { omniauth_callbacks: 'omniauth_callbacks' }\n\n  #...\n\nend\n\n\n\u8a8d\u8a3c\u5931\u6557\u6642\u306e\u53d6\u308a\u6271\u3044\u7b49\u306e\u6a5f\u80fd\u3092\u53d6\u308a\u8fbc\u3080\u305f\u3081\u3001super class\u306fDevise::OmniauthCallbacksController\u3068\u3059\u308b\u3002\n\u8907\u6570\u306e\u30d7\u30ed\u30d0\u30a4\u30c0\u30fc\u3092\u5229\u7528\u3059\u308b\u5834\u5408\u3082\u5185\u5bb9\u306f\u540c\u3058\u306a\u306e\u3067\u3001alias_method\u3092\u7528\u3044\u3001\u540c\u3058\u30b3\u30fc\u30c9\u3092\u8907\u6570\u306e\u30d7\u30ed\u30d0\u30a4\u30c0\u30fc\u306b\u5bfe\u3057\u3066\u4f7f\u7528\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u3002\n\n/app/controllers/omniauth_callbacks_controller.rb\nclass OmniauthCallbacksController < Devise::OmniauthCallbacksController\n\n  def all\n    # \u8a8d\u8a3c\u30c7\u30fc\u30bf\u3092\u5143\u306b\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3067\u30e6\u30fc\u30b6\u30fc\u3092\u63a2\u3057\u3001\u306a\u3051\u308c\u3070\u4f5c\u308b\u3002\n    user = User.from_omniauth(request.env[\"omniauth.auth\"])\n    if user.persisted?  # \u30e6\u30fc\u30b6\u30fc\u304c\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u4e0a\u306b\u5b58\u5728\u3057\u3066\u3044\u308b\u3002\n      sign_in_and_redirect user  # \u30e6\u30fc\u30b6\u30fc\u3092sign_in\u3059\u308b\n      set_flash_message(:notice, :success, kind: __callee__.to_s.capitalize) if is_navigational_format?\n    else  # \u4f55\u3089\u304b\u306e\u7406\u7531\u3067\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u4fdd\u5b58\u3055\u308c\u3066\u3044\u306a\u3044\u3002\n      session[\"devise.user_attributes\"] = user.attributes  # \u8a8d\u8a3c\u30c7\u30fc\u30bf\u3092\u899a\u3048\u3066\u304a\u304f\u3002\n      redirect_to new_user_registration_url(from_omniauth_callback: \"\uff11\")  # \u30e6\u30fc\u30b6\u30fc\u3092\u65b0\u898f\u767b\u9332\u30da\u30fc\u30b8\u306b\u8ee2\u9001\u3002\n    end\n  end\n\n  alias_method :twitter, :all\nend\n\n\n\nUser\u30e2\u30c7\u30eb\u306bOmniAuth\u8a8d\u8a3c\u51e6\u7406\u306b\u4f7f\u7528\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u3092\u8ffd\u52a0\n\n/app/models/user.rb\nclass User < ActiveRecord::Base\n\n  #...\n\n  devise :database_authenticatable, :registerable, :confirmable,\n         :recoverable, :rememberable, :trackable, :validatable, :omniauthable\n\n  # OmniAuth\u8a8d\u8a3c\u30c7\u30fc\u30bf\u3092\u5143\u306b\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3067\u30e6\u30fc\u30b6\u30fc\u3092\u63a2\u3059\u3002\u306a\u3051\u308c\u3070\u65b0\u3057\u304f\u4f5c\u308b\u3002\n  def self.from_omniauth(auth)\n    where(provider: auth.provider, uid: auth.uid).first_or_create do |user|\n      user.provider = auth.provider\n      user.uid      = auth.uid\n      user.username = auth.info.nickname\n      # \u30d1\u30b9\u30ef\u30fc\u30c9\u4e0d\u8981\u306a\u306e\u3067\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u306f\u89e6\u3089\u306a\u3044\u3002\n    end\n  end\n\n  # session[\"devise.user_attributes\"]\u304c\u5b58\u5728\u3059\u308b\u5834\u5408\u3001\u305d\u308c\u3068params\u3092\u7d44\u307f\u5408\u308f\u305b\u3066User.new\u3067\u304d\u308b\u3088\u3046\u3001Devise\u306e\u5b9f\u88c5\u3092Override\u3059\u308b\u3002\n  def self.new_with_session(params, session)\n    if session[\"devise.user_attributes\"]\n      new(session[\"devise.user_attributes\"]) do |user|\n        user.attributes = params\n        user.valid?\n      end\n    else\n      super\n    end\n  end\n\n  # \u30ed\u30b0\u30a4\u30f3\u6642\u3001OmniAuth\u3067\u8a8d\u8a3c\u3057\u305f\u30e6\u30fc\u30b6\u30fc\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u5165\u529b\u514d\u9664\u3059\u308b\u305f\u3081\u3001Devise\u306e\u5b9f\u88c5\u3092Override\u3059\u308b\u3002\n  def password_required?\n    super && provider.blank?  # provider\u5c5e\u6027\u306b\u5024\u304c\u3042\u308c\u3070\u30d1\u30b9\u30ef\u30fc\u30c9\u5165\u529b\u514d\u9664\n  end\n\n  # Edit\u6642\u3001OmniAuth\u3067\u8a8d\u8a3c\u3057\u305f\u30e6\u30fc\u30b6\u30fc\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u5165\u529b\u514d\u9664\u3059\u308b\u305f\u3081\u3001Devise\u306e\u5b9f\u88c5\u3092Override\u3059\u308b\u3002\n  def update_with_password(params, *options)\n    if encrypted_password.blank?            # encrypted_password\u5c5e\u6027\u304c\u7a7a\u306e\u5834\u5408\n      update_attributes(params, *options)   # \u30d1\u30b9\u30ef\u30fc\u30c9\u5165\u529b\u306a\u3057\u306b\u30c7\u30fc\u30bf\u66f4\u65b0\n    else\n      super\n    end\n  end\nend\n\n\n\n\u65b0\u898f\u767b\u9332\u30da\u30fc\u30b8\u3067\u30d1\u30b9\u30ef\u30fc\u30c9\u6b04\u304c\u4e0d\u8981\u306a\u5834\u5408\u306f\u96a0\u3059\n\u4f8b\u3001OmniAuth\u8a8d\u8a3c\u5f8c\u306bemail\u306e\u307f\u5165\u529b\u3092\u6c42\u3081\u308b\u5834\u5408\u3002\n\n/app/views/devise/registrations/new.html.haml\n= form_for(resource, as: resource_name, url: registration_path(resource_name)) do |f|\n\n  - if params[:from_omniauth_callback]\n    .alert.alert-danger Email address is required.\n  - else\n    = devise_error_messages!\n\n  .field.form-group\n    = f.text_field :username, autofocus: false, class: 'form-control', placeholder: \"Username\"\n\n  .field.form-group\n    = f.email_field :email, autofocus: false, class: 'form-control', placeholder: \"Email\"\n\n  - if f.object.password_required?\n\n    .field.form-group\n      = f.password_field :password, autocomplete: \"off\", class: 'form-control',\n        placeholder: \"Password (#{@minimum_password_length} characters min)\"\n\n    .field.form-group\n      = f.password_field :password_confirmation, autocomplete: \"off\", class: 'form-control',\n        placeholder: \"Password confirmation\"\n\n  .actions\n    = f.button \"Create my account\", class: \"submit btn btn-success btn-lg btn-block\",\n      data: { disable_with: \"<i class='fa fa-spinner fa-spin'></i> Processing...\" }\n\n\n\n\u53c2\u8003\u6587\u732e\n\nOmniAuth: Overview\nRuby on Rails - Railscasts PRO #235 Devise and OmniAuth (revised)\nhttps://github.com/railscasts/235-devise-and-omniauth-revised\nSign In With Twitter using Omniauth and the Twitter gem\nhttp://www.rubydoc.info/github/plataformatec/devise/\nhttps://github.com/arunagw/omniauth-twitter\n\n![Screenshot 2015-08-01 11.34.30.png](https://qiita-image-store.s3.amazonaws.com/0/82804/36ad86a0-2258-000e-c534-00cf2f617be1.png)\n\nOmniAuth\u8a8d\u8a3c\u306b\u3064\u3044\u3066\u306e\u30e1\u30e2\u3002\n\n# \u6982\u8981\n- Devise\u3067\u8a8d\u8a3c\u3092\u884c\u3046Rails\u30a2\u30d7\u30ea\u306b\u5bfe\u3057\u3066\u3001OmniAuth\u3067\u306e\u8a8d\u8a3c\u6a5f\u80fd\u3092\u8ffd\u52a0\u3059\u308b\u3002\n- Twitter\u3092\u30d7\u30ed\u30d0\u30a4\u30c0\u30fc\u3068\u3059\u308b\u3002\n- OmniAuth\u3067\u8a8d\u8a3c\u3059\u308b\u5834\u5408\u306f\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u5165\u529b\u3092\u514d\u9664\u3059\u308b\u3002\n- \u65b0\u898f\u767b\u9332\u6642\u3001email\u306f\u5fc5\u9808\u9805\u76ee\u3068\u3059\u308b\u3002\n- Devise\u306econfirmable\u30e2\u30b8\u30e5\u30fc\u30eb\u3067email\u306e\u78ba\u8a8d\u3092\u3059\u308b\u3002\n\n# \u624b\u9806\n\n##\u8a8d\u8a3c\u3057\u3066\u3082\u3089\u3044\u305f\u3044\u30d7\u30ed\u30d0\u30a4\u30c0\u30fc\u306b\u30a2\u30d7\u30ea\u3092\u767b\u9332\u3057\u3001API\u30ad\u30fc\u7b49\u3092\u53d6\u5f97\n\nTwitter\u306eApplication Management\u30b5\u30a4\u30c8\u306b\u884c\u304d\u3001\u30d5\u30a9\u30fc\u30e0\u306b\u5fc5\u8981\u4e8b\u9805\u3092\u8a18\u5165\u3057\u3066\u63d0\u51fa\n\n- https://apps.twitter.com/app/new\n\n![Screenshot 2015-07-31 10.42.18.png](https://qiita-image-store.s3.amazonaws.com/0/82804/61d701cf-7a84-8a69-dfa5-9cb6308e56b8.png)\n\n- **Name**:        \u30a2\u30d7\u30ea\u540d\uff08\u30e6\u30fc\u30b6\u30fc\u304c\u8a8d\u8a3c\u624b\u7d9a\u304d\u3059\u308b\u3068\u304d\u306b\u8868\u793a\u3055\u308c\u308b\uff09\n- **Description**: \u30a2\u30d7\u30ea\u306b\u3064\u3044\u3066\u306e\u8aac\u660e \uff08\u30e6\u30fc\u30b6\u30fc\u304c\u8a8d\u8a3c\u624b\u7d9a\u304d\u3059\u308b\u3068\u304d\u306b\u8868\u793a\u3055\u308c\u308b\uff09\n- **Website**:     \u4ecaWebsite\u304c\u306a\u3051\u308c\u3070\u3001\u4eee\u306eURL\u3092\u8a18\u5165\u3059\u308b\u3002\u5f8c\u306b\u5909\u66f4\u53ef\u80fd\u3002\n- **Callback URL**:  [omniauth-twitter](https://github.com/arunagw/omniauth-twitter)\u306b\u3088\u308a\u8a8d\u8a3c\u5b8c\u4e86\u5f8c\u306b\u547c\u3070\u308c\u308bURL\u3092\u8a18\u5165\u3059\u308b\u3002Devise\u3092\u4f7f\u7528\u3057\u3066\u3044\u308b\u5834\u5408\u306fDevise\u304c\u9762\u5012\u3092\u898b\u3066\u304f\u308c\u308b\u306e\u3067\u3001\u6df1\u304f\u8003\u3048\u305a`http://127.0.0.1:3000/auth/twitter/callback`\u3092\u5165\u529b\u3059\u308b\u3002\n\n\u5de6\u304b\u3089\uff13\u756a\u76ee\u306e\u30bf\u30d6(Keys and Access Tokens)\u3092\u30af\u30ea\u30c3\u30af\u3057\u3001API Key\u3068API Secret\u3092\u78ba\u8a8d\u3002\n\n![Screenshot 2015-07-31 13.33.45.png](https://qiita-image-store.s3.amazonaws.com/0/82804/6ff47e8e-849d-f93d-25cf-1a34b9eb1f06.png)\n\n\n## Gemfile\u306bomniauth-twitter\u3092\u8ffd\u52a0\n\n```rb:/Gemfile\n#...\n\ngem 'omniauth-twitter'\n\n#...\n```\n```\n$ bin/bundle\n```\n\n##API Key\u3068API Secret\u3092`/config/secrets.yml`\u306b\u52a0\u3048\u308b\n\n\u76f4\u63a5\u30da\u30fc\u30b9\u30c8\u305b\u305a\u306b\u74b0\u5883\u5909\u6570\u7d4c\u7531\u3067\u6e21\u3059\u3088\u3046\u306b\u3059\u308b\u3068\u3088\u3044\u3002\n\u3053\u308c\u3067\u4ee5\u964d\u306f\u3001Development/Producton\u74b0\u5883\u3092\u554f\u308f\u305a`Rails.application.secrets.twitter_api_key`\u3001`Rails.application.secrets.twitter_api_secret`\u3068\u3057\u3066`API Key`\u3068`API Secret`\u306b\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\u306b\u306a\u308b\u3002\n\n```yaml:/config/secrets.yml\nproduction:\n  # ==> Rails\n  secret_key_base:     <%= ENV[\"SECRET_KEY_BASE\"] %>\n  # ==> OmniAuth\n  facebook_api_key:    <%= ENV[\"FACEBOOK_API_KEY\"] %>\n  facebook_api_secret: <%= ENV[\"FACEBOOK_API_SECRET\"] %>\n  twitter_api_key:     <%= ENV[\"TWITTER_API_KEY\"] %>\n  twitter_api_secret:  <%= ENV[\"TWITTER_API_SECRET\"] %>\n\ndevelopment:\n  # ==> Rails\n  secret_key_base:     <%= ENV[\"SECRET_KEY_BASE_DEV\"] %>\n  # ==> OmniAuth\n  facebook_api_key:    <%= ENV[\"FACEBOOK_API_KEY\"] %>\n  facebook_api_secret: <%= ENV[\"FACEBOOK_API_SECRET\"] %>\n  twitter_api_key:     <%= ENV[\"TWITTER_API_KEY\"] %>\n  twitter_api_secret:  <%= ENV[\"TWITTER_API_SECRET\"] %>\n\ntest:\n  # ==> Rails\n  secret_key_base:     <%= ENV[\"SECRET_KEY_BASE_TEST\"] %>\n```\n\nDevelopment\u74b0\u5883\u306e\u5834\u5408\u3001[dotenv](https://github.com/bkeepers/dotenv)\u3092\u5229\u7528\u3057\u3066\u3001API Key\u7b49\u3092`/.env`\u304b\u3089\u81ea\u52d5\u3067\u74b0\u5883\u5909\u6570\u306b\u5272\u308a\u5f53\u3066\u308b\u3053\u3068\u3082\u53ef\u80fd\u3002\n\n```text:/.env\n#...\n\n# ==> OmniAuth\nTWITTER_API_KEY    = \"T0ONiGrNuMNsKb5AyNC05mOpe\"\nTWITTER_API_SECRET = \"FxrQ6ddvlVbIaUlvEm0xg4fgoK9ACmWWnkesdU60ck1vJFoBM8\"\n\n#...\n```\n\n\u3053\u306e\u6642\u70b9\u3067`git`\u306b\u79d8\u5bc6\u306e\u30c7\u30fc\u30bf\u304c`add`\u3055\u308c\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\u3057\u3066\u304a\u304f\u306e\u304c\u8ce2\u660e\u3002\n\n```.gitignore\n# Ignore secrets\n.env\n.secret\n```\n\n## Devise\u306b\u30d7\u30ed\u30d0\u30a4\u30c0\u30fc\u540d\u3001API Key\u3001API Secret\u3092\u6e21\u3059\n`/config/initializers/devise.rb`\u306e230\u884c\u76ee\u3042\u305f\u308a\u306b\u30d7\u30ec\u30fc\u30b9\u30db\u30eb\u30c0\u30fc\u304c\u3042\u308b\u3002\n\n```rb:/config/initializers/devise.rb\n#...\n\n  # ==> OmniAuth\n  config.omniauth :twitter, Rails.application.secrets.twitter_api_key,\n                            Rails.application.secrets.twitter_api_secret\n\n#...\n```\n\n\u6ce8\u610f: \u8907\u6570\u306e\u53c2\u8003\u8cc7\u6599\u3092\u53c2\u7167\u3057\u3066\u3044\u308b\u3068\u6df7\u4e71\u3057\u3084\u3059\u3044\u304c\u3001Devise\u8a8d\u8a3c\u4ed8\u304d\u306e\u30a2\u30d7\u30ea\u3067OmniAuth\u3092\u5b9f\u88c5\u3059\u308b\u5834\u5408\u306f\u3001Devise\u304cmiddleware\u3092\u4f5c\u3063\u3066\u304f\u308c\u308b\u306e\u3067\u3001`/config/initializers/omniauth.rb`\u306f\u4e0d\u8981\u3002\u3053\u3053\u3067\u624b\u52d5\u3067middleware\u3092\u4f5c\u3063\u3066\u3057\u307e\u3046\u3068\u3001Devise\u306e\u3064\u304f\u3063\u305fmiddleware\u3068\u885d\u7a81\u3057\u3001\u8a8d\u8a3c\u304c\u5168\u3066\u5931\u6557\u3057\u3066\u3057\u307e\u3046\u3002\n\n```rb:/config/initializers/omniauth.rb\n# \u6ce8\u610f: Devise\u4ed8\u304d\u306e\u30a2\u30d7\u30ea\u3067OmniAuth\u3092\u5b9f\u88c5\u3059\u308b\u5834\u5408\u306f\u4e0d\u8981\n# Rails.application.config.middleware.use OmniAuth::Builder do\n#   provider :twitter, Rails.application.secrets.twitter_api_key,\n#                      Rails.application.secrets.twitter_api_secret\n# end\n```\n\n##`omniauthable`\u30e2\u30b8\u30e5\u30fc\u30eb\u3092User\u30e2\u30c7\u30eb\u306b\u8ffd\u52a0\n\n```rb:/app/models/user.rb\nclass User < ActiveRecord::Base\n  #...\n\n  devise :database_authenticatable, :registerable, :confirmable,\n         :recoverable, :rememberable, :trackable, :validatable,\n         :omniauthable, omniauth_providers: [:twitter]\n\n  #...\n```\n\n\u3053\u308c\u3067Devise\u304c\u81ea\u52d5\u3067Sign in with Twitter\u30ea\u30f3\u30af\u3092\u751f\u6210\u3057\u3066\u304f\u308c\u308b\u3002\u8a66\u3057\u306b`/users/sign_up`\u306b\u884c\u3063\u3066\u30ea\u30f3\u30af\u304c\u3042\u308b\u304b\u3069\u3046\u304b\u78ba\u8a8d\u3059\u308b\u3002\n\n![Screenshot 2015-08-01 11.37.19.png](https://qiita-image-store.s3.amazonaws.com/0/82804/ac5a98be-7e40-cda8-f351-72eced79b2d6.png)\n\n## user_omniauth_authorize_path(provider)\n\nDevise\u304c\u81ea\u52d5\u3067 \u751f\u6210\u3057\u305f`user_omniauth_authorize_path`\u30e1\u30bd\u30c3\u30c9\u3092\u5229\u7528\u3057\u3066\u597d\u304d\u306a\u3068\u3053\u308d\u306bOmniAuth\u8a8d\u8a3c\u3078\u306e\u30ea\u30f3\u30af\u3092\u8cbc\u308b\u3002\n\n```rb\n= link_to \"Log in with twitter\", user_omniauth_authorize_path(:twitter)\n```\n\n## OmniAuth\u8a8d\u8a3c\u30c7\u30fc\u30bf\u3092\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u4fdd\u5b58\u3059\u308b\u305f\u3081\u306e\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\n\n```\n$ rails g migration add_omniauth_to_users provider uid\n```\n\n- **provider**: \u8a8d\u8a3c\u3057\u305f\u30d7\u30ed\u30d0\u30a4\u30c0\u30fc\u540d\n- **uid**: \u4e00\u610f\u7684ID\n\n```\n$ rake db:migrate\n```\n\n##OmniAuth callback\u3092\u53d6\u308a\u6271\u3046\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u3092\u4f5c\u6210\n\n```\n$ rails g controller omniauth_callbacks\n```\n\n\u672c\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u3092devise_for\u306b\u767b\u9332\u3059\u308b\n\n```rb:/config/routes.rb\nRails.application.routes.draw do\n\n  #...\n\n  devise_for :users, controllers: { omniauth_callbacks: 'omniauth_callbacks' }\n\n  #...\n\nend\n```\n\n\u8a8d\u8a3c\u5931\u6557\u6642\u306e\u53d6\u308a\u6271\u3044\u7b49\u306e\u6a5f\u80fd\u3092\u53d6\u308a\u8fbc\u3080\u305f\u3081\u3001super class\u306fDevise::OmniauthCallbacksController\u3068\u3059\u308b\u3002\n\u8907\u6570\u306e\u30d7\u30ed\u30d0\u30a4\u30c0\u30fc\u3092\u5229\u7528\u3059\u308b\u5834\u5408\u3082\u5185\u5bb9\u306f\u540c\u3058\u306a\u306e\u3067\u3001alias_method\u3092\u7528\u3044\u3001\u540c\u3058\u30b3\u30fc\u30c9\u3092\u8907\u6570\u306e\u30d7\u30ed\u30d0\u30a4\u30c0\u30fc\u306b\u5bfe\u3057\u3066\u4f7f\u7528\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u3002\n\n```rb:/app/controllers/omniauth_callbacks_controller.rb\nclass OmniauthCallbacksController < Devise::OmniauthCallbacksController\n\n  def all\n    # \u8a8d\u8a3c\u30c7\u30fc\u30bf\u3092\u5143\u306b\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3067\u30e6\u30fc\u30b6\u30fc\u3092\u63a2\u3057\u3001\u306a\u3051\u308c\u3070\u4f5c\u308b\u3002\n    user = User.from_omniauth(request.env[\"omniauth.auth\"])\n    if user.persisted?  # \u30e6\u30fc\u30b6\u30fc\u304c\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u4e0a\u306b\u5b58\u5728\u3057\u3066\u3044\u308b\u3002\n      sign_in_and_redirect user  # \u30e6\u30fc\u30b6\u30fc\u3092sign_in\u3059\u308b\n      set_flash_message(:notice, :success, kind: __callee__.to_s.capitalize) if is_navigational_format?\n    else  # \u4f55\u3089\u304b\u306e\u7406\u7531\u3067\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u4fdd\u5b58\u3055\u308c\u3066\u3044\u306a\u3044\u3002\n      session[\"devise.user_attributes\"] = user.attributes  # \u8a8d\u8a3c\u30c7\u30fc\u30bf\u3092\u899a\u3048\u3066\u304a\u304f\u3002\n      redirect_to new_user_registration_url(from_omniauth_callback: \"\uff11\")  # \u30e6\u30fc\u30b6\u30fc\u3092\u65b0\u898f\u767b\u9332\u30da\u30fc\u30b8\u306b\u8ee2\u9001\u3002\n    end\n  end\n\n  alias_method :twitter, :all\nend\n```\n\n## User\u30e2\u30c7\u30eb\u306bOmniAuth\u8a8d\u8a3c\u51e6\u7406\u306b\u4f7f\u7528\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u3092\u8ffd\u52a0\n\n```rb:/app/models/user.rb\nclass User < ActiveRecord::Base\n  \n  #...\n\n  devise :database_authenticatable, :registerable, :confirmable,\n         :recoverable, :rememberable, :trackable, :validatable, :omniauthable\n\n  # OmniAuth\u8a8d\u8a3c\u30c7\u30fc\u30bf\u3092\u5143\u306b\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3067\u30e6\u30fc\u30b6\u30fc\u3092\u63a2\u3059\u3002\u306a\u3051\u308c\u3070\u65b0\u3057\u304f\u4f5c\u308b\u3002\n  def self.from_omniauth(auth)\n    where(provider: auth.provider, uid: auth.uid).first_or_create do |user|\n      user.provider = auth.provider\n      user.uid      = auth.uid\n      user.username = auth.info.nickname\n      # \u30d1\u30b9\u30ef\u30fc\u30c9\u4e0d\u8981\u306a\u306e\u3067\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u306f\u89e6\u3089\u306a\u3044\u3002\n    end\n  end\n\n  # session[\"devise.user_attributes\"]\u304c\u5b58\u5728\u3059\u308b\u5834\u5408\u3001\u305d\u308c\u3068params\u3092\u7d44\u307f\u5408\u308f\u305b\u3066User.new\u3067\u304d\u308b\u3088\u3046\u3001Devise\u306e\u5b9f\u88c5\u3092Override\u3059\u308b\u3002\n  def self.new_with_session(params, session)\n    if session[\"devise.user_attributes\"]\n      new(session[\"devise.user_attributes\"]) do |user|\n        user.attributes = params\n        user.valid?\n      end\n    else\n      super\n    end\n  end\n\n  # \u30ed\u30b0\u30a4\u30f3\u6642\u3001OmniAuth\u3067\u8a8d\u8a3c\u3057\u305f\u30e6\u30fc\u30b6\u30fc\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u5165\u529b\u514d\u9664\u3059\u308b\u305f\u3081\u3001Devise\u306e\u5b9f\u88c5\u3092Override\u3059\u308b\u3002\n  def password_required?\n    super && provider.blank?  # provider\u5c5e\u6027\u306b\u5024\u304c\u3042\u308c\u3070\u30d1\u30b9\u30ef\u30fc\u30c9\u5165\u529b\u514d\u9664\n  end\n\n  # Edit\u6642\u3001OmniAuth\u3067\u8a8d\u8a3c\u3057\u305f\u30e6\u30fc\u30b6\u30fc\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u5165\u529b\u514d\u9664\u3059\u308b\u305f\u3081\u3001Devise\u306e\u5b9f\u88c5\u3092Override\u3059\u308b\u3002\n  def update_with_password(params, *options)\n    if encrypted_password.blank?            # encrypted_password\u5c5e\u6027\u304c\u7a7a\u306e\u5834\u5408\n      update_attributes(params, *options)   # \u30d1\u30b9\u30ef\u30fc\u30c9\u5165\u529b\u306a\u3057\u306b\u30c7\u30fc\u30bf\u66f4\u65b0\n    else\n      super\n    end\n  end\nend\n```\n\n## \u65b0\u898f\u767b\u9332\u30da\u30fc\u30b8\u3067\u30d1\u30b9\u30ef\u30fc\u30c9\u6b04\u304c\u4e0d\u8981\u306a\u5834\u5408\u306f\u96a0\u3059\n\u4f8b\u3001OmniAuth\u8a8d\u8a3c\u5f8c\u306bemail\u306e\u307f\u5165\u529b\b\u3092\u6c42\u3081\u308b\u5834\u5408\u3002\n\n```haml:/app/views/devise/registrations/new.html.haml\n= form_for(resource, as: resource_name, url: registration_path(resource_name)) do |f|\n\n  - if params[:from_omniauth_callback]\n    .alert.alert-danger Email address is required.\n  - else\n    = devise_error_messages!\n\n  .field.form-group\n    = f.text_field :username, autofocus: false, class: 'form-control', placeholder: \"Username\"\n\n  .field.form-group\n    = f.email_field :email, autofocus: false, class: 'form-control', placeholder: \"Email\"\n\n  - if f.object.password_required?\n\n    .field.form-group\n      = f.password_field :password, autocomplete: \"off\", class: 'form-control',\n        placeholder: \"Password (#{@minimum_password_length} characters min)\"\n\n    .field.form-group\n      = f.password_field :password_confirmation, autocomplete: \"off\", class: 'form-control',\n        placeholder: \"Password confirmation\"\n\n  .actions\n    = f.button \"Create my account\", class: \"submit btn btn-success btn-lg btn-block\",\n      data: { disable_with: \"<i class='fa fa-spinner fa-spin'></i> Processing...\" }\n```\n\n# \u53c2\u8003\u6587\u732e\n- [OmniAuth: Overview](https://github.com/plataformatec/devise/wiki/OmniAuth:-Overview)\n- [Ruby on Rails - Railscasts PRO #235 Devise and OmniAuth (revised)](https://www.youtube.com/watch?v=X6tKAUOMzCs)\n- https://github.com/railscasts/235-devise-and-omniauth-revised\n- [Sign In With Twitter using Omniauth and the Twitter gem](https://gorails.com/episodes/omniauth-twitter-sign-in?autoplay=1)\n- http://www.rubydoc.info/github/plataformatec/devise/\n- https://github.com/arunagw/omniauth-twitter\n"}