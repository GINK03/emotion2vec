{"tags": ["Linux", "dns", "unbound1.5.1"], "context": " More than 1 year has passed since last update.\n\n\u25a0\u306f\u3058\u3081\u306b\n\u5148\u65e5\u3001\u4ee5\u4e0b\u306e\u8a18\u4e8b\u3067\u3001AWS\u306eEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9(AmazonLinux)\u306b\u5bfe\u3057\u3066\u3001yum\u306b\u3088\u308aunbound\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3001DNS\u30ad\u30e3\u30c3\u30b7\u30e5\u30b5\u30fc\u30d0\u5316\u3057\u307e\u3057\u305f\u3002\nhttp://qiita.com/na0AaooQ/items/e165250c1ea5c19b648c\nyum\u306b\u3088\u308a\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305funbound\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u306f1.4\u7cfb\u3067\u3001\u4ee5\u4e0b\u3092\u62dd\u898b\u3057\u305f\u3068\u3053\u308d\u3001\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u306b\u8106\u5f31\u6027\u304c\u3042\u308b\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u3057\u305f\u3002\nhttp://jprs.jp/tech/security/2014-12-09-multiple-impl-vuln-delegation-limit.html\n\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\u3084unbound.conf\u3067\u3001\u7279\u5b9a\u306e\u30b5\u30fc\u30d0\u304b\u3089\u3057\u304bunbound\u30b5\u30fc\u30d0\u3092\u6307\u5b9a\u3057\u3066\u540d\u524d\u89e3\u6c7a\u51fa\u6765\u306a\u3044\u3088\u3046\u5236\u9650\u3057\u3066\u304a\u308a\u307e\u3057\u305f\u304c\u3001\u5ff5\u306e\u70ba\u3001\u8106\u5f31\u6027\u5bfe\u5fdc\u6e08\u307f\u306eunbound 1.5.1\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066unbound\u30b5\u30fc\u30d0\u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u306a\u304a\u3059\u4e8b\u306b\u3057\u307e\u3057\u305f\u3002\n\u4ee5\u4e0b\u306b\u30bd\u30fc\u30b9\u304b\u3089unbound 1.5.1\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3001Amazon VPC\u5916\u306e\u30b5\u30fc\u30d0\u304b\u3089unbound\u30b5\u30fc\u30d0\u3092\u6307\u5b9a\u3057\u3066\u540d\u524d\u89e3\u6c7a\u51fa\u6765\u308b\u3088\u3046\u306b\u3059\u308b\u3068\u3053\u308d\u307e\u3067\u306e\u624b\u9806\u3092\u307e\u3068\u3081\u307e\u3057\u305f\u3002\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305funbound\u306e\u7d30\u304b\u306a\u30d1\u30e9\u30e1\u30fc\u30bf\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\u306f\u3057\u3066\u3044\u306a\u3044\u306e\u3067\u3001\u5b9f\u904b\u7528\u306b\u3042\u305f\u3063\u3066\u306f\u3082\u3063\u3068\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\u304c\u5fc5\u8981\u3068\u601d\u3044\u307e\u3059\u304c\u3001\u307e\u305a\u306fAmazon VPC\u5916\u306e\u30b5\u30fc\u30d0\u304b\u3089unbound\u30b5\u30fc\u30d0\u7d4c\u7531\u3067Route53\u306e\u540d\u524d\u3092\u89e3\u6c7a\u51fa\u6765\u308b\u3068\u3053\u308d\u307e\u3067\u78ba\u8a8d\u3057\u307e\u3057\u305f\u3002\n\n\u25a0unbound\u30b5\u30fc\u30d0\u4f5c\u6210\u6642\u306b\u4f7f\u7528\u3057\u305fAMI\n\u30fbAmazon Linux AMI 2014.09.1 x86_64 HVM\n\n\u25a0\u53c2\u8003\u30b5\u30a4\u30c8\n\u4ee5\u4e0b\u306e\u30b5\u30a4\u30c8\u3092\u53c2\u8003\u306b\u3055\u305b\u3066\u9802\u304d\u307e\u3057\u305f\u3002\nhttp://unbound.jp/unbound/unbound-conf/\nhttp://unbound.jp/unbound/howto_optimise/\nhttps://genchan.net/server/3494\nhttp://www.nlnetlabs.nl/downloads/ldns/\n\n\u25a0unbound 1.5.1\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u624b\u9806\n\u30fbRoute53\u306b\u306froute53-test.example.org\u3068\u3044\u3046A\u30ec\u30b3\u30fc\u30c9\u300110.100.51.198.in-addr.arpa\u3068\u3044\u3046PTR\u30ec\u30b3\u30fc\u30c9\u3092\u767b\u9332\u3057\u3066\u3044\u308b\u3068\u3044\u3046\u524d\u63d0\u3067\u8a18\u8ff0\u3055\u305b\u3066\u9802\u304d\u307e\u3059\u3002\n\u30fbunbound\u30b5\u30fc\u30d0\u306e\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\u3067\u3001unbound\u30b5\u30fc\u30d0\u3092\u6307\u5b9a\u3057\u3066\u540d\u524d\u89e3\u6c7a\u3092\u884c\u3046VPC\u5916\u30b5\u30fc\u30d0\u304b\u3089\u306eUDP53\u756a\u30dd\u30fc\u30c8\u306e\u901a\u4fe1\u3092\u8a31\u53ef\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\u30fbAmazonLinux\u3067EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u65b0\u898f\u4f5c\u6210\u3057\u307e\u3059\u3002\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u51fa\u6765\u305f\u3089ec2-user\u3067\u30ed\u30b0\u30a4\u30f3\u3057\u307e\u3059\u3002\n\u30fbEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u521d\u671f\u8a2d\u5b9a\u3092\u884c\u3044\u307e\u3059\u3002\n$ sudo su -\n# vi /etc/sysconfig/network-scripts/ifcfg-eth0\nPEERDNS=yes\n\u3000\u2193\nPEERDNS=no\n\n# cp /usr/share/zoneinfo/Asia/Tokyo /etc/localtime\ncp: overwrite \u2018/etc/localtime\u2019? y\n# date\nFri Dec 12 14:27:01 JST 2014\n#\n\n# vi /etc/sysconfig/clock\nZONE=\"UTC\" \nUTC=true\n\u3000\u2193\nZONE=\"Asia/Tokyo\" \nUTC=false\nARC=false\n#\n\n\u30fbunbound\u30e6\u30fc\u30b6\u3068unbound\u30b0\u30eb\u30fc\u30d7\u3092\u4f5c\u6210\u3059\u308b\u3002\nunbound\u30e6\u30fc\u30b6\u3068unbound\u30b0\u30eb\u30fc\u30d7\u3092\u4f5c\u6210\u3059\u308b\u3002\nuid\u3084gid\u306f\u9069\u5b9c\u30b7\u30b9\u30c6\u30e0\u4e0a\u306b\u5b58\u5728\u3057\u306a\u3044\u756a\u53f7\u3092\u78ba\u8a8d\u306e\u4e0a\u3067\u6307\u5b9a\u3059\u308b\u4e8b\u3002\n# cp -p /etc/passwd /etc/passwd.ORG\n# cp -p /etc/shadow /etc/shadow.ORG\n# cp -p /etc/group /etc/group.ORG\n#\n\n# groupadd -g [unbound\u30b0\u30eb\u30fc\u30d7\u306b\u6307\u5b9a\u3059\u308bgid] unbound\n# useradd -u [unbound\u30e6\u30fc\u30b6\u306b\u6307\u5b9a\u3059\u308buid] -s /sbin/nologin -d /var/unbound -N -g unbound -c 'Unbound DNS Resolver User' unbound\n#\n\n# id unbound\nuid=XXXXX(unbound) gid=XXXXX(unbound) groups=XXXXX(unbound)\n#\n\n\n\u30fbunbound 1.5.1\u306e\u30bd\u30fc\u30b9\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306b\u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3002\nunbound\u30b5\u30fc\u30d0\u306b\u4ee5\u4e0b\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n# yum update\n# yum -y install openssl-devel\n# yum -y install flex\n# yum -y install libevent-devel\n# yum -y install gcc\n# yum -y install expat-devel\n\n\u4e00\u5ea6\u3001unbound\u30b5\u30fc\u30d0\u3092\u30ea\u30d6\u30fc\u30c8\u3057\u307e\u3059\u3002\n# reboot\n\n\u30fbldns\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\nunbound\u30b5\u30fc\u30d0\u304c\u8d77\u52d5\u3057\u3066\u304d\u305f\u3089\u4f5c\u696d\u3092\u518d\u958b\u3057\u307e\u3059\u3002\n$ sudo su -\n# cd /usr/local/src/\n# wget http://www.nlnetlabs.nl/downloads/ldns/ldns-1.6.17.tar.gz\n# tar zxvf /usr/local/src/ldns-1.6.17.tar.gz\n# cd /usr/local/src/ldns-1.6.17\n\n# pwd\n/usr/local/src/ldns-1.6.17\n# ./configure\n\n# make\n\n# make install\n\n\n\n\u30fbdrill\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n# cd /usr/local/src/ldns-1.6.17/drill/\n# pwd\n/usr/local/src/ldns-1.6.17/drill\n#\n\n# ./configure\n\n# make\n\n# make install\n\n\u30fbunbound 1.5.1\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\nhttp://jprs.jp/tech/security/2014-12-09-multiple-impl-vuln-delegation-limit.html\n# cd /usr/local/src\n# wget http://unbound.net/downloads/unbound-1.5.1.tar.gz\n\n# tar zxvf /usr/local/src/unbound-1.5.1.tar.gz\n\n# cd /usr/local/src/unbound-1.5.1\n# pwd\n/usr/local/src/unbound-1.5.1\n\n# ./configure --sysconfdir=/var --with-conf-file=/var/unbound/unbound.conf --with-libevent\n\n# make\n\n# make install\n\n\n\u30fbunbound 1.5.1\u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u305f\u4e8b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n# ls -lrta /var/unbound/unbound.conf\n-rw-r--r-- 1 root root 24367 Jan  8 14:06 /var/unbound/unbound.conf\n# ls -lrta /usr/local/sbin/unbound\n-rwxr-xr-x 1 root root 3880714 Jan  8 14:06 /usr/local/sbin/unbound\n#\n\n# ls -lrta /usr/local/lib/*unbound*\n-rwxr-xr-x 1 root root  652510 Jan  8 14:06 /usr/local/lib/libunbound.so.2.3.3\nlrwxrwxrwx 1 root root      19 Jan  8 14:06 /usr/local/lib/libunbound.so.2 -> libunbound.so.2.3.3\nlrwxrwxrwx 1 root root      19 Jan  8 14:06 /usr/local/lib/libunbound.so -> libunbound.so.2.3.3\n-rw-r--r-- 1 root root     975 Jan  8 14:06 /usr/local/lib/libunbound.la\n-rw-r--r-- 1 root root 9297828 Jan  8 14:06 /usr/local/lib/libunbound.a\n#\n\n\n\u30fbunbound\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u30d1\u30b9\u3092/etc/ld.so.cache\u3078\u8ffd\u52a0\u3059\u308b\u3002\n# ls -lrta /usr/local/lib/*unbound*\n-rwxr-xr-x 1 root root  652510 Jan  8 14:06 /usr/local/lib/libunbound.so.2.3.3\nlrwxrwxrwx 1 root root      19 Jan  8 14:06 /usr/local/lib/libunbound.so.2 -> libunbound.so.2.3.3\nlrwxrwxrwx 1 root root      19 Jan  8 14:06 /usr/local/lib/libunbound.so -> libunbound.so.2.3.3\n-rw-r--r-- 1 root root     975 Jan  8 14:06 /usr/local/lib/libunbound.la\n-rw-r--r-- 1 root root 9297828 Jan  8 14:06 /usr/local/lib/libunbound.a\n\n# cp -p /etc/ld.so.cache /etc/ld.so.cache.ORG\n# diff /etc/ld.so.cache /etc/ld.so.cache.ORG\n#\n\n# cp -p /etc/ld.so.conf /etc/ld.so.conf.ORG\n# diff /etc/ld.so.conf /etc/ld.so.conf.ORG\n#\n\n# echo \"/usr/local/lib\" >> /etc/ld.so.conf\n#\n\n# cat /etc/ld.so.conf\ninclude ld.so.conf.d/*.conf\n/usr/local/lib\n#\n\n# ls -lrta /etc/ld.so.cache\n-rw-r--r-- 1 root root 20832 Jan  8 13:39 /etc/ld.so.cache\n#\n\n# ldconfig\n#\n\n# ls -lrta /etc/ld.so.cache\n-rw-r--r-- 1 root root 21144 Jan  8 14:10 /etc/ld.so.cache\n#\n\n# ldconfig -p | grep unbound\n        libunbound.so.2 (libc6,x86-64) => /usr/local/lib/libunbound.so.2\n        libunbound.so (libc6,x86-64) => /usr/local/lib/libunbound.so\n#\n\n\u30fbunbound\u306e\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092/etc/init.d/unbound\u3068\u3057\u3066\u30b3\u30d4\u30fc\u3059\u308b\u3002\n# cp -p /usr/local/src/unbound-1.5.1/contrib/unbound.init /etc/init.d/unbound\n# diff /usr/local/src/unbound-1.5.1/contrib/unbound.init /etc/init.d/unbound\n# sed -i 's_/usr/sbin/unbound_/usr/local/sbin/unbound_' /etc/init.d/unbound\n\n# chown root:root /etc/init.d/unbound\n# chmod 755 /etc/init.d/unbound\n\n\u30fbunbound\u30d7\u30ed\u30bb\u30b9\u306e\u81ea\u52d5\u8d77\u52d5\u8a2d\u5b9a\u3002\n# chkconfig --list | grep unbound\n# chkconfig --add unbound\n# chkconfig unbound on\n# chkconfig --list | grep unbound\nunbound         0:off   1:off   2:on    3:on    4:on    5:on    6:off\n#\n\n\u30fbunbound.conf\u306e\u30ea\u30f3\u30af\u4f5c\u6210\u3002\n# ll /var/unbound/unbound.conf\n-rw-r--r-- 1 root root 24367 Jan  8 14:06 /var/unbound/unbound.conf\n#\n# ll /etc/unbound.conf\nls: cannot access /etc/unbound.conf: No such file or directory\n#\n# ln -s /var/unbound/unbound.conf /etc/unbound.conf\n# ll /etc/unbound.conf\nlrwxrwxrwx 1 root root 25 Jan  8 14:14 /etc/unbound.conf -> /var/unbound/unbound.conf\n#\n\n\u30fbunbound\u3092\u52d5\u304b\u3059\u70ba\u3001unbound.conf\u306b\u6700\u4f4e\u9650\u306e\u8a2d\u5b9a\u3092\u8ffd\u52a0\u30fb\u7de8\u96c6\u3059\u308b\u3002\n\u203bunbound\u30b5\u30fc\u30d0\u3092DNS\u30ad\u30e3\u30c3\u30b7\u30e5\u30b5\u30fc\u30d0\u3068\u3057\u3066\u5229\u7528\u3059\u308b\u30b5\u30fc\u30d0\u53f0\u6570\u304c\u591a\u3044\u5834\u5408\u3001\u4ee5\u4e0b\u3092\u53c2\u8003\u306b\u3057\u306a\u304c\u3089\u3001\u9069\u5b9c\u30d1\u30e9\u30e1\u30fc\u30bf\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\u3057\u305f\u65b9\u304c\u826f\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\nhttp://unbound.jp/unbound/howto_optimise/\n# cp -p /var/unbound/unbound.conf /var/unbound/unbound.conf.ORG\n# diff /var/unbound/unbound.conf /var/unbound/unbound.conf.ORG\n#\n\n# vi /var/unbound/unbound.conf\n\u3000(\u8a2d\u5b9a\u3092\u8ffd\u52a0\u30fb\u7de8\u96c6\u3059\u308b)\n\n\n\u30fbunbound.conf\u306e\u5909\u66f4\u5f8c\u306e\u5dee\u5206\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3002\n# diff /var/unbound/unbound.conf /var/unbound/unbound.conf.ORG\n31d30\n<       num-threads: 2\n42,43d40\n<       interface: 0.0.0.0@53\n<       interface: ::0@53\n51d47\n<       port: 53\n68d63\n<       outgoing-port-permit: 32768-65535\n107d101\n<       msg-buffer-size: 1311240\n112d105\n<       msg-cache-size: 50m\n131d123\n<       rrset-cache-size: 100m\n160d151\n<       do-ip4: yes\n164d154\n<       do-ip6: no\n168d157\n<       do-udp: yes\n172d160\n<       do-tcp: no\n193,198d180\n<       access-control: 198.51.100.0/24 allow\n<       access-control: 192.0.2.0/24 allow\n<       access-control: 127.0.0.1/32 allow\n<       access-control: 0.0.0.0/0 deny\n224d205\n<       chroot: \"\"\n230d210\n<       username: \"unbound\"\n236d215\n<       directory: \"/var/unbound\"\n241d219\n<       logfile: \"/var/log/unbound.log\"\n246d223\n<       use-syslog: no\n253d229\n<       log-queries: yes\n261d236\n<       root-hints: \"/var/unbound/named.cache\"\n265d239\n<       hide-identity: yes\n269d242\n<       hide-version: yes\n429d401\n<       val-permissive-mode: yes\n569,570d540\n<       include: /var/unbound/etc/local.d/*.conf\n<\n584d553\n<       control-enable: yes\n590d558\n<       control-interface: 127.0.0.1\n594d561\n<       control-port: 8953\n598d564\n<       server-key-file: \"/var/unbound/unbound_server.key\"\n602d567\n<       server-cert-file: \"/var/unbound/unbound_server.pem\"\n606d570\n<       control-key-file: \"/var/unbound/unbound_control.key\"\n610d573\n<       control-cert-file: \"/var/unbound/unbound_control.pem\"\n641,642d603\n<\n< include: /var/unbound/etc/conf.d/*.conf\n#\n\n\n\u30fbunbound-control\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u3002\nunbound-control-setup\u3067unbound-control\u30b3\u30de\u30f3\u30c9\u7528\u306e\u9375\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\u524d\u8ff0\u306eunbound.conf\u306e\u300ccontrol-interface: 127.0.0.1\u300d\u8a2d\u5b9a\u306b\u3088\u308a\u3001unbound\u30b5\u30fc\u30d0\u4ee5\u5916\u306e\u5916\u90e8\u30b5\u30fc\u30d0\u304b\u3089\u306eunbound-control\u30b3\u30de\u30f3\u30c9\u306f\u53d7\u3051\u4ed8\u3051\u306a\u3044\u3088\u3046\u306b\u5236\u9650\u3057\u3066\u304a\u308a\u307e\u3059\u3002\n# ls -lrta /var/unbound/\ntotal 60\ndrwxr-xr-x 19 root root  4096 Jan  8 14:06 ..\n-rw-r--r--  1 root root 24367 Jan  8 14:06 unbound.conf.ORG\n-rw-r--r--  1 root root 25411 Jan  8 14:25 unbound.conf\ndrwxr-xr-x  2 root root  4096 Jan  8 14:25 .\n#\n\n# cd /var/unbound/\n#\n\n# which unbound-control-setup\n/usr/local/sbin/unbound-control-setup\n#\n\n# unbound-control-setup\nsetup in directory /var/unbound\ngenerating unbound_server.key\nGenerating RSA private key, 1536 bit long modulus\n\u3000(\u4e2d\u7565)\n#\n\nunbound-control\u30b3\u30de\u30f3\u30c9\u7528\u306e\u9375\u30d5\u30a1\u30a4\u30eb\u304c\u4f5c\u6210\u3055\u308c\u305f\u4e8b\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n# ls -lrta /var/unbound/\ntotal 76\ndrwxr-xr-x 19 root root  4096 Jan  8 14:06 ..\n-rw-r--r--  1 root root 24367 Jan  8 14:06 unbound.conf.ORG\n-rw-r--r--  1 root root 25411 Jan  8 14:25 unbound.conf\n-rw-r-----  1 root root  1277 Jan  8 14:30 unbound_server.key\n-rw-r-----  1 root root  1277 Jan  8 14:30 unbound_control.key\n-rw-r-----  1 root root   790 Jan  8 14:30 unbound_server.pem\n-rw-r-----  1 root root   802 Jan  8 14:30 unbound_control.pem\ndrwxr-xr-x  2 root root  4096 Jan  8 14:30 .\n#\n\n\u30fbDNS\u30eb\u30fc\u30c8\u30b5\u30fc\u30d0\u304c\u8a18\u8f09\u3055\u308c\u305fhint\u30d5\u30a1\u30a4\u30eb\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\n# wget -O \"/var/unbound/named.cache\" ftp://FTP.INTERNIC.NET/domain/named.cache\n\n\u30fbunbound\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u683c\u7d0d\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4f5c\u6210\n# mkdir -p /var/unbound/etc/conf.d\n# mkdir -p /var/unbound/etc/local.d\n\n\u30fbunbound\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u4fee\u6b63\u3002\n/usr/local/src/unbound-1.5.1/contrib/unbound.init\u304b\u3089\u30b3\u30d4\u30fc\u3057\u3066/etc/init.d/unbound\u3092\u4f5c\u6210\u3057\u305f\u5834\u5408\u3001unbound\u30d7\u30ed\u30bb\u30b9\u505c\u6b62\u6642\u306b/var/unbound/dev/random\u3068/var/unbound/dev/log\u304c\u30de\u30a6\u30f3\u30c8\u3055\u308c\u305f\u307e\u307e\u6b8b\u3063\u3066\u3057\u307e\u3044\u3001\u518d\u5ea6unbound\u30d7\u30ed\u30bb\u30b9\u3092\u8d77\u52d5\u3059\u308b\u3068\u3001\u8907\u6570\u30de\u30a6\u30f3\u30c8\u3055\u308c\u3066\u3057\u307e\u3046\u73fe\u8c61\u304c\u8d77\u304d\u308b\u3002\nunbound\u30d7\u30ed\u30bb\u30b9\u505c\u6b62\u6642\u306b/var/unbound/dev/random\u3068/var/unbound/dev/log\u3092umount\u3055\u308c\u308b\u3088\u3046\u306b\u4fee\u6b63\u3059\u308b\u3002\n\u307e\u305f\u3001\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u306b/var/log/unbound.log\u304c\u5b58\u5728\u3057\u306a\u3044\u5834\u5408\u306b\u7a7a\u30d5\u30a1\u30a4\u30eb\u4f5c\u6210\u3059\u308b\u51e6\u7406\u3092\u8ffd\u52a0\u3059\u308b\u3002\n# vi /etc/init.d/unbound\n\u3000(\u4e2d\u7565)\nstop() {\n    echo -n $\"Stopping $prog: \"\n    # stop it here, often \"killproc $prog\"\n    killproc -p $pidfile $prog\n    retval=$?\n    echo\n    [ $retval -eq 0 ] && rm -f $lockfile\n##    if egrep -q '^/[^[:space:]]+[[:space:]]+'${rootdir}'/dev/log' /proc/mounts; then\n    MOUNT_CHK=`grep \"devtmpfs ${rootdir}/dev/log\" /proc/mounts | grep -v ^# | wc -l`\n    if [ ${MOUNT_CHK} -ge 1 ] ; then\n        umount ${rootdir}/dev/log >/dev/null 2>&1\n    fi;\n##    if egrep -q '^/[^[:space:]]+[[:space:]]+'${rootdir}'/dev/random' /proc/mounts; then\n    MOUNT_CHK=`grep \"devtmpfs ${rootdir}/dev/random\" /proc/mounts | grep -v ^# | wc -l`\n    if [ ${MOUNT_CHK} -ge 1 ] ; then\n        umount ${rootdir}/dev/random >/dev/null 2>&1\n    fi;\n    return $retval\n}\n\u3000(\u4e2d\u7565)\nmake_logfile() {\n    if [ ! -e \"/var/log/unbound.log\" ]\n    then\n         touch /var/log/unbound.log\n         chmod 644 /var/log/unbound.log\n         chown unbound:unbound /var/log/unbound.log\n    fi\n}\n\u3000(\u4e2d\u7565)\ncase \"$1\" in\n    start)\n        rh_status_q && exit 0\n        make_logfile\n        $1\n        ;;\n    stop)\n        rh_status_q || exit 0\n        $1\n        ;;\n    restart)\n        make_logfile\n        $1\n        ;;\n    reload)\n        rh_status_q || exit 7\n        make_logfile\n        $1\n        ;;\n    force-reload)\n        make_logfile\n        force_reload\n        ;;\n    status)\n        rh_status\n        ;;\n    condrestart|try-restart)\n        rh_status_q || exit 0\n        make_logfile\n        restart\n        ;;\n    *)\n        echo $\"Usage: $0 {start|stop|status|restart|condrestart|try-restart|reload|force-reload}\"\n        exit 2\nesac\nexit $?\n\n\u30fb\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u5909\u66f4\u5f8c\u306e\u5dee\u5206\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3002\n# diff /usr/local/src/unbound-1.5.1/contrib/unbound.init /etc/init.d/unbound\n24c24\n< exec=\"/usr/sbin/unbound\"\n---\n> exec=\"/usr/local/sbin/unbound\"\n78c78,80\n<     if egrep -q '^/[^[:space:]]+[[:space:]]+'${rootdir}'/dev/log' /proc/mounts; then\n---\n> ##    if egrep -q '^/[^[:space:]]+[[:space:]]+'${rootdir}'/dev/log' /proc/mounts; then\n>     MOUNT_CHK=`grep \"devtmpfs ${rootdir}/dev/log\" /proc/mounts | grep -v ^# | wc -l`\n>     if [ ${MOUNT_CHK} -ge 1 ] ; then\n81c83,85\n<     if egrep -q '^/[^[:space:]]+[[:space:]]+'${rootdir}'/dev/random' /proc/mounts; then\n---\n> ##    if egrep -q '^/[^[:space:]]+[[:space:]]+'${rootdir}'/dev/random' /proc/mounts; then\n>     MOUNT_CHK=`grep \"devtmpfs ${rootdir}/dev/random\" /proc/mounts | grep -v ^# | wc -l`\n>     if [ ${MOUNT_CHK} -ge 1 ] ; then\n108a113,121\n> make_logfile() {\n>     if [ ! -e \"/var/log/unbound.log\" ]\n>     then\n>          touch /var/log/unbound.log\n>          chmod 644 /var/log/unbound.log\n>          chown unbound:unbound /var/log/unbound.log\n>     fi\n> }\n>\n111a125\n>         make_logfile\n118a133\n>         make_logfile\n122a138\n>         make_logfile\n125a142\n>         make_logfile\n132a150\n>         make_logfile\n#\n\n\n\u30fbunbound\u30b5\u30fc\u30d0\u306bDNS\u30d5\u30a9\u30ef\u30fc\u30c9\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\nexample.org\u30c9\u30e1\u30a4\u30f3\u306e\u540d\u524d\u89e3\u6c7a\u3092Route53\u306b\u30d5\u30a9\u30ef\u30fc\u30c9\u3055\u305b\u305f\u3044\u5834\u5408\u3001forward-addr\u3067example.org\u30c9\u30e1\u30a4\u30f3\u3092\u7d10\u4ed8\u3051\u305fVPC\u306eAmazonProvidedDNS\u3092\u6307\u5b9a\u3059\u308b\u3002\n# vi /var/unbound/etc/conf.d/example.org.conf\nforward-zone:\n      name: \"example.org.\"\n      forward-addr: XX.XX.XX.2 (unbound\u30b5\u30fc\u30d0\u3092\u4f5c\u6210\u3057\u305fVPC\u306eAmazonProvidedDNS\u3092\u6307\u5b9a\u3059\u308b)\n#\n\n\u9006\u5f15\u304d\u30be\u30fc\u30f3\u306e\u540d\u524d\u89e3\u6c7a\u3092Route53\u3078\u30d5\u30a9\u30ef\u30fc\u30c9\u3055\u305b\u305f\u3044\u5834\u5408\u3001forward-addr\u3067\u9006\u5f15\u304d\u30be\u30fc\u30f3\u3092\u7d10\u4ed8\u3051\u305fVPC\u306eAmazonProvidedDNS\u3092\u6307\u5b9a\u3059\u308b\u3002\n# vi /var/unbound/etc/conf.d/100.51.198.in-addr.arpa.conf\nforward-zone:\n      name: \"100.51.198.in-addr.arpa.\"\n      forward-addr: XX.XX.XX.2 (unbound\u30b5\u30fc\u30d0\u3092\u4f5c\u6210\u3057\u305fVPC\u306eAmazonProvidedDNS\u3092\u6307\u5b9a\u3059\u308b)\n#\n\n# vi /var/unbound/etc/local.d/100.51.198.in-addr.arpa.conf\nlocal-zone: \"100.51.198.in-addr.arpa.\" transparent\n#\n\n# vi /var/unbound/etc/local.d/example.org.conf\nlocal-zone: \"example.org.\" transparent\n#\n\n\u30fbunbound\u30b5\u30fc\u30d0\u306e/etc/resolv.conf\u4fee\u6b63\nunbound\u30b5\u30fc\u30d0\u81ea\u8eab\u304c\u53c2\u7167\u3059\u308bDNS\u30b5\u30fc\u30d0\u3092\u81ea\u5206\u81ea\u8eab\u306b\u5909\u66f4\u3059\u308b\u3002\n# vi /etc/resolv.conf\n### unbound\u30b5\u30fc\u30d0\u81ea\u8eab\u306eIP\u30a2\u30c9\u30ec\u30b9\nnameserver 127.0.0.1\n#\n\n\u30fbunbound\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u30aa\u30fc\u30ca\u30fc\u8a2d\u5b9a\u3002\n# chown -R unbound:unbound /var/unbound\n\n\u30fbunbound\u8a2d\u5b9a\u30c1\u30a7\u30c3\u30af\u3002\n# unbound-checkconf\nunbound-checkconf: no errors in /var/unbound/unbound.conf\n#\n\n\n\u30fbunbound\u30d7\u30ed\u30bb\u30b9\u3092\u8d77\u52d5\u3059\u308b\u3002\n# ps awux | grep -v grep | grep unbound\n#\n\n# /etc/init.d/unbound start\nStarting unbound:                                          [  OK  ]\n#\n\n# ps awux | grep -v grep | grep unbound\nunbound   8421  0.0  0.8 136500  8352 ?        Ssl  17:00   0:00 /usr/local/sbin/unbound\n#\n\n# unbound-control status\nversion: 1.5.1\nverbosity: 1\nthreads: 2\nmodules: 2 [ validator iterator ]\nuptime: 13 seconds\noptions: control(ssl)\nunbound (pid 8421) is running...\n#\n\n\n\u25a0unbound\u30b5\u30fc\u30d0\u4e0a\u3067\u306e\u540d\u524d\u89e3\u6c7a\u30c6\u30b9\u30c8\nunbound\u30b5\u30fc\u30d0\u4e0a\u3067\u540d\u524d\u89e3\u6c7a\u3092\u884c\u3048\u308b\u304b\u30c6\u30b9\u30c8\u3057\u307e\u3059\u3002\nRoute53\u306b\u767b\u9332\u3057\u3066\u3044\u308bexample.org\u30c9\u30e1\u30a4\u30f3\u3084\u9006\u5f15\u304d\u30be\u30fc\u30f3\u3001\u305d\u3057\u3066Route53\u4ee5\u5916\u306egoogle.com\u7b49\u306e\u30c9\u30e1\u30a4\u30f3\u306e\u540d\u524d\u3092\u89e3\u6c7a\u51fa\u6765\u308b\u304b\u30c6\u30b9\u30c8\u3057\u307e\u3059\u3002\n\u30c6\u30b9\u30c8\u524d\u306bunbound\u30b5\u30fc\u30d0\u4e0a\u3067\u3001/etc/init.d/unbound reload\u3092\u5b9f\u884c\u3057\u3066\u3001unbound\u30b5\u30fc\u30d0\u4e0a\u306e\u540d\u524d\u89e3\u6c7a\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u6d88\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\u30fbunbound\u306e\u540d\u524d\u89e3\u6c7a\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u30af\u30ea\u30a2\u3059\u308b\u3002\n# /etc/init.d/unbound reload\n#\n\n# unbound-control dump_cache\nSTART_RRSET_CACHE\nEND_RRSET_CACHE\nSTART_MSG_CACHE\nEND_MSG_CACHE\nEOF\n#\n\n\u30fb\u540d\u524d\u89e3\u6c7a\u3057\u3066\u7d50\u679c\u304c\u8fd4\u3063\u3066\u304f\u308b\u304b\u78ba\u8a8d\u3057\u307e\u3059\u3002\n# dig +noall +ans route53-test.example.org @127.0.0.1\nroute53-test.example.org. 1     IN      A       198.51.100.10\n#\n\n# dig +noall +ans -x 198.51.100.10 @127.0.0.1\n10.100.51.198.in-addr.arpa. 1   IN      PTR     route53-test.example.org.\n#\n\n# dig +noall +ans www.google.co.jp @127.0.0.1\nwww.google.co.jp.       300     IN      A       173.194.38.87\nwww.google.co.jp.       300     IN      A       173.194.38.88\nwww.google.co.jp.       300     IN      A       173.194.38.95\nwww.google.co.jp.       300     IN      A       173.194.38.79\n#\n\n# dig +noall +ans www.google.com @127.0.0.1\nwww.google.com.         287     IN      A       74.125.235.176\nwww.google.com.         287     IN      A       74.125.235.180\nwww.google.com.         287     IN      A       74.125.235.177\nwww.google.com.         287     IN      A       74.125.235.179\nwww.google.com.         287     IN      A       74.125.235.178\n#\n\n# dig +noall +ans www.google.co.jp @127.0.0.1\nwww.google.co.jp.       192     IN      A       74.125.235.183\nwww.google.co.jp.       192     IN      A       74.125.235.191\nwww.google.co.jp.       192     IN      A       74.125.235.184\nwww.google.co.jp.       192     IN      A       74.125.235.175\n#\n\n\u30fbunbound\u30b5\u30fc\u30d0\u3067\u540d\u524d\u89e3\u6c7a\u306e\u30ed\u30b0\u3092\u78ba\u8a8d\u3059\u308b\u3002\n# tail -f /var/log/unbound.log\n\u3000(\u4e2d\u7565)\n[1420704380] unbound[8530:1] info: 127.0.0.1 route53-test.example.org. A IN\n[1420704380] unbound[8530:1] info: 127.0.0.1 10.100.51.198.in-addr.arpa. PTR IN\n[1420704380] unbound[8530:1] info: 127.0.0.1 www.google.co.jp. A IN\n[1420704380] unbound[8530:1] info: 127.0.0.1 www.google.com. A IN\n[1420704380] unbound[8530:1] info: 127.0.0.1 www.google.com. A IN\n[1420704380] unbound[8530:1] info: 127.0.0.1 www.google.co.jp. A IN\n\u3000(\u4e2d\u7565)\n\n\n\u25a0Amazon VPC\u5916\u306e\u30b5\u30fc\u30d0\u304b\u3089unbound\u30b5\u30fc\u30d0\u3092\u6307\u5b9a\u3057\u305f\u540d\u524d\u89e3\u6c7a\u30c6\u30b9\u30c8\nAmazon VPC\u5916\u306e\u30b5\u30fc\u30d0\u304b\u3089\u3001DNS\u30b5\u30fc\u30d0\u3068\u3057\u3066unbound\u30b5\u30fc\u30d0\u3092\u6307\u5b9a\u3057\u3066\u3001\u540d\u524d\u89e3\u6c7a\u3092\u884c\u3048\u308b\u304b\u30c6\u30b9\u30c8\u3057\u307e\u3059\u3002\nRoute53\u306b\u767b\u9332\u3057\u3066\u3044\u308bexample.org\u30c9\u30e1\u30a4\u30f3\u3084\u9006\u5f15\u304d\u30be\u30fc\u30f3\u3001\u305d\u3057\u3066Route53\u4ee5\u5916\u306egoogle.com\u7b49\u306e\u30c9\u30e1\u30a4\u30f3\u306e\u540d\u524d\u3092\u89e3\u6c7a\u51fa\u6765\u308b\u304b\u30c6\u30b9\u30c8\u3057\u307e\u3059\u3002\n\u30c6\u30b9\u30c8\u524d\u306bunbound\u30b5\u30fc\u30d0\u4e0a\u3067\u3001/etc/init.d/unbound reload\u3092\u5b9f\u884c\u3057\u3066\u3001unbound\u30b5\u30fc\u30d0\u4e0a\u306e\u540d\u524d\u89e3\u6c7a\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u6d88\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\u30fbunbound\u306e\u540d\u524d\u89e3\u6c7a\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u30af\u30ea\u30a2\u3059\u308b\u3002\n# /etc/init.d/unbound reload\n#\n\n# unbound-control dump_cache\nSTART_RRSET_CACHE\nEND_RRSET_CACHE\nSTART_MSG_CACHE\nEND_MSG_CACHE\nEOF\n#\n\n\u30fb\u540d\u524d\u89e3\u6c7a\u3057\u3066\u7d50\u679c\u304c\u8fd4\u3063\u3066\u304f\u308b\u304b\u78ba\u8a8d\u3057\u307e\u3059\u3002\n[exampleuser@notvpcserver ~]$ dig +noall +ans route53-test.example.org @unbound\u30b5\u30fc\u30d0\u306eIP\u30a2\u30c9\u30ec\u30b9\u3092\u6307\u5b9a\u3059\u308b\nroute53-test.example.org. 1     IN      A       198.51.100.10\n[exampleuser@notvpcserver ~]$\n\n[exampleuser@notvpcserver ~]$ dig +noall +ans -x 198.51.100.10 @unbound\u30b5\u30fc\u30d0\u306eIP\u30a2\u30c9\u30ec\u30b9\u3092\u6307\u5b9a\u3059\u308b\n10.100.51.198.in-addr.arpa. 1   IN      PTR     route53-test.example.org.\n[exampleuser@notvpcserver ~]$\n\n[exampleuser@notvpcserver ~]$ dig +noall +ans www.google.com @unbound\u30b5\u30fc\u30d0\u306eIP\u30a2\u30c9\u30ec\u30b9\u3092\u6307\u5b9a\u3059\u308b\nwww.google.com.         300     IN      A       74.125.235.179\nwww.google.com.         300     IN      A       74.125.235.178\nwww.google.com.         300     IN      A       74.125.235.180\nwww.google.com.         300     IN      A       74.125.235.177\nwww.google.com.         300     IN      A       74.125.235.176\n[exampleuser@notvpcserver ~]$\n\n[exampleuser@notvpcserver ~]$ dig +noall +ans www.google.co.jp @unbound\u30b5\u30fc\u30d0\u306eIP\u30a2\u30c9\u30ec\u30b9\u3092\u6307\u5b9a\u3059\u308b\nwww.google.co.jp.       300     IN      A       74.125.235.191\nwww.google.co.jp.       300     IN      A       74.125.235.184\nwww.google.co.jp.       300     IN      A       74.125.235.183\nwww.google.co.jp.       300     IN      A       74.125.235.175\n[exampleuser@notvpcserver ~]$\n\n\n\n\u25a0unbound\u30ed\u30b0\u30ed\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u8a2d\u5b9a\nunbound\u30b5\u30fc\u30d0\u306e/var/log/unbound.log\u3092\u30ed\u30b0\u30ed\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3055\u305b\u305f\u3044\u5834\u5408\u3001unbound\u30b5\u30fc\u30d0\u306b\u4ee5\u4e0b\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\u307e\u305aunbound-control\u30b3\u30de\u30f3\u30c9\u306e\u30d1\u30b9\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n# which unbound-control\n/usr/local/sbin/unbound-control\n#\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30ed\u30b0\u30ed\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n# vi /etc/logrotate.d/unbound\n/var/log/unbound.log\n{\n    daily\n    rotate 30\n    size 15M\n    missingok\n    compress\n    create 644 unbound unbound\n    sharedscripts\n    prerotate\n        touch /var/log/unbound.log\n        chown unbound:unbound /var/log/unbound.log\n        chmod 644 /var/log/unbound.log\n        /usr/local/sbin/unbound-control log_reopen\n    endscript\n    postrotate\n        /usr/local/sbin/unbound-control log_reopen\n    endscript\n}\n\n# chown root:root /etc/logrotate.d/unbound\n# chmod 644 /etc/logrotate.d/unbound\n#\n\n\u30ed\u30b0\u30ed\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306e\u30c6\u30b9\u30c8\u3092\u884c\u3044\u3001\u30a8\u30e9\u30fc\u304c\u51fa\u306a\u3044\u4e8b\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n# logrotate -dv /etc/logrotate.d/unbound\nreading config file /etc/logrotate.d/unbound\nreading config info for /var/log/unbound.log\n\n\nHandling 1 logs\n\nrotating pattern: /var/log/unbound.log\n 15728640 bytes (30 rotations)\nempty log files are rotated, old logs are removed\nconsidering log /var/log/unbound.log\n  log does not need rotating\nnot running prerotate script, since no logs will be rotated\nnot running postrotate script, since no logs were rotated\n#\n\n\u7fcc\u65e5\u4ee5\u964d\u306b/var/log/unbound.log\u304c\u30ed\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3055\u308c\u3066\u3044\u308c\u3070\u8a2d\u5b9a\u5b8c\u4e86\u3067\u3059\u3002\n# ll /var/log/unbound.log*\n-rw-r--r-- 1 unbound unbound   246825 *** **:** /var/log/unbound.log-YYYYMM01.gz\n-rw-r--r-- 1 unbound unbound   237778 *** **:** /var/log/unbound.log-YYYYMM02.gz\n#\n\n\u9577\u304f\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u304c\u3001\u4ee5\u4e0a\u306b\u306a\u308a\u307e\u3059\u3002\n\u25a0\u306f\u3058\u3081\u306b\n===\n\n\u5148\u65e5\u3001\u4ee5\u4e0b\u306e\u8a18\u4e8b\u3067\u3001AWS\u306eEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9(AmazonLinux)\u306b\u5bfe\u3057\u3066\u3001yum\u306b\u3088\u308aunbound\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3001DNS\u30ad\u30e3\u30c3\u30b7\u30e5\u30b5\u30fc\u30d0\u5316\u3057\u307e\u3057\u305f\u3002\nhttp://qiita.com/na0AaooQ/items/e165250c1ea5c19b648c\n\nyum\u306b\u3088\u308a\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305funbound\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u306f1.4\u7cfb\u3067\u3001\u4ee5\u4e0b\u3092\u62dd\u898b\u3057\u305f\u3068\u3053\u308d\u3001\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u306b\u8106\u5f31\u6027\u304c\u3042\u308b\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u3057\u305f\u3002\nhttp://jprs.jp/tech/security/2014-12-09-multiple-impl-vuln-delegation-limit.html\n\n\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\u3084unbound.conf\u3067\u3001\u7279\u5b9a\u306e\u30b5\u30fc\u30d0\u304b\u3089\u3057\u304bunbound\u30b5\u30fc\u30d0\u3092\u6307\u5b9a\u3057\u3066\u540d\u524d\u89e3\u6c7a\u51fa\u6765\u306a\u3044\u3088\u3046\u5236\u9650\u3057\u3066\u304a\u308a\u307e\u3057\u305f\u304c\u3001\u5ff5\u306e\u70ba\u3001\u8106\u5f31\u6027\u5bfe\u5fdc\u6e08\u307f\u306eunbound 1.5.1\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066unbound\u30b5\u30fc\u30d0\u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u306a\u304a\u3059\u4e8b\u306b\u3057\u307e\u3057\u305f\u3002\n\n\u4ee5\u4e0b\u306b\u30bd\u30fc\u30b9\u304b\u3089unbound 1.5.1\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3001Amazon VPC\u5916\u306e\u30b5\u30fc\u30d0\u304b\u3089unbound\u30b5\u30fc\u30d0\u3092\u6307\u5b9a\u3057\u3066\u540d\u524d\u89e3\u6c7a\u51fa\u6765\u308b\u3088\u3046\u306b\u3059\u308b\u3068\u3053\u308d\u307e\u3067\u306e\u624b\u9806\u3092\u307e\u3068\u3081\u307e\u3057\u305f\u3002\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305funbound\u306e\u7d30\u304b\u306a\u30d1\u30e9\u30e1\u30fc\u30bf\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\u306f\u3057\u3066\u3044\u306a\u3044\u306e\u3067\u3001\u5b9f\u904b\u7528\u306b\u3042\u305f\u3063\u3066\u306f\u3082\u3063\u3068\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\u304c\u5fc5\u8981\u3068\u601d\u3044\u307e\u3059\u304c\u3001\u307e\u305a\u306fAmazon VPC\u5916\u306e\u30b5\u30fc\u30d0\u304b\u3089unbound\u30b5\u30fc\u30d0\u7d4c\u7531\u3067Route53\u306e\u540d\u524d\u3092\u89e3\u6c7a\u51fa\u6765\u308b\u3068\u3053\u308d\u307e\u3067\u78ba\u8a8d\u3057\u307e\u3057\u305f\u3002\n\n\u25a0unbound\u30b5\u30fc\u30d0\u4f5c\u6210\u6642\u306b\u4f7f\u7528\u3057\u305fAMI\n===\n\n\u30fbAmazon Linux AMI 2014.09.1 x86_64 HVM\n\n\u25a0\u53c2\u8003\u30b5\u30a4\u30c8\n===\n\n\u4ee5\u4e0b\u306e\u30b5\u30a4\u30c8\u3092\u53c2\u8003\u306b\u3055\u305b\u3066\u9802\u304d\u307e\u3057\u305f\u3002\n\nhttp://unbound.jp/unbound/unbound-conf/\nhttp://unbound.jp/unbound/howto_optimise/\nhttps://genchan.net/server/3494\nhttp://www.nlnetlabs.nl/downloads/ldns/\n\n\u25a0unbound 1.5.1\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u624b\u9806\n===\n\n\u30fbRoute53\u306b\u306froute53-test.example.org\u3068\u3044\u3046A\u30ec\u30b3\u30fc\u30c9\u300110.100.51.198.in-addr.arpa\u3068\u3044\u3046PTR\u30ec\u30b3\u30fc\u30c9\u3092\u767b\u9332\u3057\u3066\u3044\u308b\u3068\u3044\u3046\u524d\u63d0\u3067\u8a18\u8ff0\u3055\u305b\u3066\u9802\u304d\u307e\u3059\u3002\n\n\u30fbunbound\u30b5\u30fc\u30d0\u306e\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\u3067\u3001unbound\u30b5\u30fc\u30d0\u3092\u6307\u5b9a\u3057\u3066\u540d\u524d\u89e3\u6c7a\u3092\u884c\u3046VPC\u5916\u30b5\u30fc\u30d0\u304b\u3089\u306eUDP53\u756a\u30dd\u30fc\u30c8\u306e\u901a\u4fe1\u3092\u8a31\u53ef\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n\u30fbAmazonLinux\u3067EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u65b0\u898f\u4f5c\u6210\u3057\u307e\u3059\u3002\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u51fa\u6765\u305f\u3089ec2-user\u3067\u30ed\u30b0\u30a4\u30f3\u3057\u307e\u3059\u3002\n\n\u30fbEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u521d\u671f\u8a2d\u5b9a\u3092\u884c\u3044\u307e\u3059\u3002\n\n```\n$ sudo su -\n# vi /etc/sysconfig/network-scripts/ifcfg-eth0\nPEERDNS=yes\n\u3000\u2193\nPEERDNS=no\n```\n\n```\n# cp /usr/share/zoneinfo/Asia/Tokyo /etc/localtime\ncp: overwrite \u2018/etc/localtime\u2019? y\n# date\nFri Dec 12 14:27:01 JST 2014\n#\n\n# vi /etc/sysconfig/clock\nZONE=\"UTC\" \nUTC=true\n\u3000\u2193\nZONE=\"Asia/Tokyo\" \nUTC=false\nARC=false\n#\n```\n\n\u30fbunbound\u30e6\u30fc\u30b6\u3068unbound\u30b0\u30eb\u30fc\u30d7\u3092\u4f5c\u6210\u3059\u308b\u3002\n\nunbound\u30e6\u30fc\u30b6\u3068unbound\u30b0\u30eb\u30fc\u30d7\u3092\u4f5c\u6210\u3059\u308b\u3002\nuid\u3084gid\u306f\u9069\u5b9c\u30b7\u30b9\u30c6\u30e0\u4e0a\u306b\u5b58\u5728\u3057\u306a\u3044\u756a\u53f7\u3092\u78ba\u8a8d\u306e\u4e0a\u3067\u6307\u5b9a\u3059\u308b\u4e8b\u3002\n\n\n```\n# cp -p /etc/passwd /etc/passwd.ORG\n# cp -p /etc/shadow /etc/shadow.ORG\n# cp -p /etc/group /etc/group.ORG\n#\n\n# groupadd -g [unbound\u30b0\u30eb\u30fc\u30d7\u306b\u6307\u5b9a\u3059\u308bgid] unbound\n# useradd -u [unbound\u30e6\u30fc\u30b6\u306b\u6307\u5b9a\u3059\u308buid] -s /sbin/nologin -d /var/unbound -N -g unbound -c 'Unbound DNS Resolver User' unbound\n#\n\n# id unbound\nuid=XXXXX(unbound) gid=XXXXX(unbound) groups=XXXXX(unbound)\n#\n\n```\n\n\n\u30fbunbound 1.5.1\u306e\u30bd\u30fc\u30b9\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306b\u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3002\n\nunbound\u30b5\u30fc\u30d0\u306b\u4ee5\u4e0b\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\n```\n# yum update\n# yum -y install openssl-devel\n# yum -y install flex\n# yum -y install libevent-devel\n# yum -y install gcc\n# yum -y install expat-devel\n```\n\n\u4e00\u5ea6\u3001unbound\u30b5\u30fc\u30d0\u3092\u30ea\u30d6\u30fc\u30c8\u3057\u307e\u3059\u3002\n\n```\n# reboot\n```\n\n\u30fbldns\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n\nunbound\u30b5\u30fc\u30d0\u304c\u8d77\u52d5\u3057\u3066\u304d\u305f\u3089\u4f5c\u696d\u3092\u518d\u958b\u3057\u307e\u3059\u3002\n\n```\n$ sudo su -\n# cd /usr/local/src/\n# wget http://www.nlnetlabs.nl/downloads/ldns/ldns-1.6.17.tar.gz\n# tar zxvf /usr/local/src/ldns-1.6.17.tar.gz\n# cd /usr/local/src/ldns-1.6.17\n\n# pwd\n/usr/local/src/ldns-1.6.17\n# ./configure\n\n# make\n\n# make install\n\n\n```\n\n\u30fbdrill\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n\n```\n# cd /usr/local/src/ldns-1.6.17/drill/\n# pwd\n/usr/local/src/ldns-1.6.17/drill\n#\n\n# ./configure\n\n# make\n\n# make install\n```\n\n\u30fbunbound 1.5.1\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\nhttp://jprs.jp/tech/security/2014-12-09-multiple-impl-vuln-delegation-limit.html\n\n```\n# cd /usr/local/src\n# wget http://unbound.net/downloads/unbound-1.5.1.tar.gz\n\n# tar zxvf /usr/local/src/unbound-1.5.1.tar.gz\n\n# cd /usr/local/src/unbound-1.5.1\n# pwd\n/usr/local/src/unbound-1.5.1\n\n# ./configure --sysconfdir=/var --with-conf-file=/var/unbound/unbound.conf --with-libevent\n\n# make\n\n# make install\n\n```\n\n\u30fbunbound 1.5.1\u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u305f\u4e8b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n\n```\n# ls -lrta /var/unbound/unbound.conf\n-rw-r--r-- 1 root root 24367 Jan  8 14:06 /var/unbound/unbound.conf\n# ls -lrta /usr/local/sbin/unbound\n-rwxr-xr-x 1 root root 3880714 Jan  8 14:06 /usr/local/sbin/unbound\n#\n\n# ls -lrta /usr/local/lib/*unbound*\n-rwxr-xr-x 1 root root  652510 Jan  8 14:06 /usr/local/lib/libunbound.so.2.3.3\nlrwxrwxrwx 1 root root      19 Jan  8 14:06 /usr/local/lib/libunbound.so.2 -> libunbound.so.2.3.3\nlrwxrwxrwx 1 root root      19 Jan  8 14:06 /usr/local/lib/libunbound.so -> libunbound.so.2.3.3\n-rw-r--r-- 1 root root     975 Jan  8 14:06 /usr/local/lib/libunbound.la\n-rw-r--r-- 1 root root 9297828 Jan  8 14:06 /usr/local/lib/libunbound.a\n#\n\n```\n\n\u30fbunbound\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u30d1\u30b9\u3092/etc/ld.so.cache\u3078\u8ffd\u52a0\u3059\u308b\u3002\n\n```\n# ls -lrta /usr/local/lib/*unbound*\n-rwxr-xr-x 1 root root  652510 Jan  8 14:06 /usr/local/lib/libunbound.so.2.3.3\nlrwxrwxrwx 1 root root      19 Jan  8 14:06 /usr/local/lib/libunbound.so.2 -> libunbound.so.2.3.3\nlrwxrwxrwx 1 root root      19 Jan  8 14:06 /usr/local/lib/libunbound.so -> libunbound.so.2.3.3\n-rw-r--r-- 1 root root     975 Jan  8 14:06 /usr/local/lib/libunbound.la\n-rw-r--r-- 1 root root 9297828 Jan  8 14:06 /usr/local/lib/libunbound.a\n\n# cp -p /etc/ld.so.cache /etc/ld.so.cache.ORG\n# diff /etc/ld.so.cache /etc/ld.so.cache.ORG\n#\n\n# cp -p /etc/ld.so.conf /etc/ld.so.conf.ORG\n# diff /etc/ld.so.conf /etc/ld.so.conf.ORG\n#\n\n# echo \"/usr/local/lib\" >> /etc/ld.so.conf\n#\n\n# cat /etc/ld.so.conf\ninclude ld.so.conf.d/*.conf\n/usr/local/lib\n#\n\n# ls -lrta /etc/ld.so.cache\n-rw-r--r-- 1 root root 20832 Jan  8 13:39 /etc/ld.so.cache\n#\n\n# ldconfig\n#\n\n# ls -lrta /etc/ld.so.cache\n-rw-r--r-- 1 root root 21144 Jan  8 14:10 /etc/ld.so.cache\n#\n\n# ldconfig -p | grep unbound\n        libunbound.so.2 (libc6,x86-64) => /usr/local/lib/libunbound.so.2\n        libunbound.so (libc6,x86-64) => /usr/local/lib/libunbound.so\n#\n```\n\n\u30fbunbound\u306e\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092/etc/init.d/unbound\u3068\u3057\u3066\u30b3\u30d4\u30fc\u3059\u308b\u3002\n\n\n```\n# cp -p /usr/local/src/unbound-1.5.1/contrib/unbound.init /etc/init.d/unbound\n# diff /usr/local/src/unbound-1.5.1/contrib/unbound.init /etc/init.d/unbound\n# sed -i 's_/usr/sbin/unbound_/usr/local/sbin/unbound_' /etc/init.d/unbound\n\n# chown root:root /etc/init.d/unbound\n# chmod 755 /etc/init.d/unbound\n```\n\n\u30fbunbound\u30d7\u30ed\u30bb\u30b9\u306e\u81ea\u52d5\u8d77\u52d5\u8a2d\u5b9a\u3002\n\n\n```\n# chkconfig --list | grep unbound\n# chkconfig --add unbound\n# chkconfig unbound on\n# chkconfig --list | grep unbound\nunbound         0:off   1:off   2:on    3:on    4:on    5:on    6:off\n#\n```\n\n\u30fbunbound.conf\u306e\u30ea\u30f3\u30af\u4f5c\u6210\u3002\n\n```\n# ll /var/unbound/unbound.conf\n-rw-r--r-- 1 root root 24367 Jan  8 14:06 /var/unbound/unbound.conf\n#\n# ll /etc/unbound.conf\nls: cannot access /etc/unbound.conf: No such file or directory\n#\n# ln -s /var/unbound/unbound.conf /etc/unbound.conf\n# ll /etc/unbound.conf\nlrwxrwxrwx 1 root root 25 Jan  8 14:14 /etc/unbound.conf -> /var/unbound/unbound.conf\n#\n```\n\n\u30fbunbound\u3092\u52d5\u304b\u3059\u70ba\u3001unbound.conf\u306b\u6700\u4f4e\u9650\u306e\u8a2d\u5b9a\u3092\u8ffd\u52a0\u30fb\u7de8\u96c6\u3059\u308b\u3002\n\n\u203bunbound\u30b5\u30fc\u30d0\u3092DNS\u30ad\u30e3\u30c3\u30b7\u30e5\u30b5\u30fc\u30d0\u3068\u3057\u3066\u5229\u7528\u3059\u308b\u30b5\u30fc\u30d0\u53f0\u6570\u304c\u591a\u3044\u5834\u5408\u3001\u4ee5\u4e0b\u3092\u53c2\u8003\u306b\u3057\u306a\u304c\u3089\u3001\u9069\u5b9c\u30d1\u30e9\u30e1\u30fc\u30bf\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\u3057\u305f\u65b9\u304c\u826f\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\nhttp://unbound.jp/unbound/howto_optimise/\n\n\n```\n# cp -p /var/unbound/unbound.conf /var/unbound/unbound.conf.ORG\n# diff /var/unbound/unbound.conf /var/unbound/unbound.conf.ORG\n#\n\n# vi /var/unbound/unbound.conf\n\u3000(\u8a2d\u5b9a\u3092\u8ffd\u52a0\u30fb\u7de8\u96c6\u3059\u308b)\n\n```\n\n\n\u30fbunbound.conf\u306e\u5909\u66f4\u5f8c\u306e\u5dee\u5206\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3002\n\n```\n# diff /var/unbound/unbound.conf /var/unbound/unbound.conf.ORG\n31d30\n<       num-threads: 2\n42,43d40\n<       interface: 0.0.0.0@53\n<       interface: ::0@53\n51d47\n<       port: 53\n68d63\n<       outgoing-port-permit: 32768-65535\n107d101\n<       msg-buffer-size: 1311240\n112d105\n<       msg-cache-size: 50m\n131d123\n<       rrset-cache-size: 100m\n160d151\n<       do-ip4: yes\n164d154\n<       do-ip6: no\n168d157\n<       do-udp: yes\n172d160\n<       do-tcp: no\n193,198d180\n<       access-control: 198.51.100.0/24 allow\n<       access-control: 192.0.2.0/24 allow\n<       access-control: 127.0.0.1/32 allow\n<       access-control: 0.0.0.0/0 deny\n224d205\n<       chroot: \"\"\n230d210\n<       username: \"unbound\"\n236d215\n<       directory: \"/var/unbound\"\n241d219\n<       logfile: \"/var/log/unbound.log\"\n246d223\n<       use-syslog: no\n253d229\n<       log-queries: yes\n261d236\n<       root-hints: \"/var/unbound/named.cache\"\n265d239\n<       hide-identity: yes\n269d242\n<       hide-version: yes\n429d401\n<       val-permissive-mode: yes\n569,570d540\n<       include: /var/unbound/etc/local.d/*.conf\n<\n584d553\n<       control-enable: yes\n590d558\n<       control-interface: 127.0.0.1\n594d561\n<       control-port: 8953\n598d564\n<       server-key-file: \"/var/unbound/unbound_server.key\"\n602d567\n<       server-cert-file: \"/var/unbound/unbound_server.pem\"\n606d570\n<       control-key-file: \"/var/unbound/unbound_control.key\"\n610d573\n<       control-cert-file: \"/var/unbound/unbound_control.pem\"\n641,642d603\n<\n< include: /var/unbound/etc/conf.d/*.conf\n#\n\n```\n\n\n\u30fbunbound-control\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u3002\n\nunbound-control-setup\u3067unbound-control\u30b3\u30de\u30f3\u30c9\u7528\u306e\u9375\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\u524d\u8ff0\u306eunbound.conf\u306e\u300ccontrol-interface: 127.0.0.1\u300d\u8a2d\u5b9a\u306b\u3088\u308a\u3001unbound\u30b5\u30fc\u30d0\u4ee5\u5916\u306e\u5916\u90e8\u30b5\u30fc\u30d0\u304b\u3089\u306eunbound-control\u30b3\u30de\u30f3\u30c9\u306f\u53d7\u3051\u4ed8\u3051\u306a\u3044\u3088\u3046\u306b\u5236\u9650\u3057\u3066\u304a\u308a\u307e\u3059\u3002\n\n```\n# ls -lrta /var/unbound/\ntotal 60\ndrwxr-xr-x 19 root root  4096 Jan  8 14:06 ..\n-rw-r--r--  1 root root 24367 Jan  8 14:06 unbound.conf.ORG\n-rw-r--r--  1 root root 25411 Jan  8 14:25 unbound.conf\ndrwxr-xr-x  2 root root  4096 Jan  8 14:25 .\n#\n\n# cd /var/unbound/\n#\n\n# which unbound-control-setup\n/usr/local/sbin/unbound-control-setup\n#\n\n# unbound-control-setup\nsetup in directory /var/unbound\ngenerating unbound_server.key\nGenerating RSA private key, 1536 bit long modulus\n\u3000(\u4e2d\u7565)\n#\n```\n\nunbound-control\u30b3\u30de\u30f3\u30c9\u7528\u306e\u9375\u30d5\u30a1\u30a4\u30eb\u304c\u4f5c\u6210\u3055\u308c\u305f\u4e8b\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```\n# ls -lrta /var/unbound/\ntotal 76\ndrwxr-xr-x 19 root root  4096 Jan  8 14:06 ..\n-rw-r--r--  1 root root 24367 Jan  8 14:06 unbound.conf.ORG\n-rw-r--r--  1 root root 25411 Jan  8 14:25 unbound.conf\n-rw-r-----  1 root root  1277 Jan  8 14:30 unbound_server.key\n-rw-r-----  1 root root  1277 Jan  8 14:30 unbound_control.key\n-rw-r-----  1 root root   790 Jan  8 14:30 unbound_server.pem\n-rw-r-----  1 root root   802 Jan  8 14:30 unbound_control.pem\ndrwxr-xr-x  2 root root  4096 Jan  8 14:30 .\n#\n```\n\n\u30fbDNS\u30eb\u30fc\u30c8\u30b5\u30fc\u30d0\u304c\u8a18\u8f09\u3055\u308c\u305fhint\u30d5\u30a1\u30a4\u30eb\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\n\n```\n# wget -O \"/var/unbound/named.cache\" ftp://FTP.INTERNIC.NET/domain/named.cache\n```\n\n\u30fbunbound\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u683c\u7d0d\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4f5c\u6210\n\n```\n# mkdir -p /var/unbound/etc/conf.d\n# mkdir -p /var/unbound/etc/local.d\n```\n\n\u30fbunbound\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u4fee\u6b63\u3002\n\n/usr/local/src/unbound-1.5.1/contrib/unbound.init\u304b\u3089\u30b3\u30d4\u30fc\u3057\u3066/etc/init.d/unbound\u3092\u4f5c\u6210\u3057\u305f\u5834\u5408\u3001unbound\u30d7\u30ed\u30bb\u30b9\u505c\u6b62\u6642\u306b/var/unbound/dev/random\u3068/var/unbound/dev/log\u304c\u30de\u30a6\u30f3\u30c8\u3055\u308c\u305f\u307e\u307e\u6b8b\u3063\u3066\u3057\u307e\u3044\u3001\u518d\u5ea6unbound\u30d7\u30ed\u30bb\u30b9\u3092\u8d77\u52d5\u3059\u308b\u3068\u3001\u8907\u6570\u30de\u30a6\u30f3\u30c8\u3055\u308c\u3066\u3057\u307e\u3046\u73fe\u8c61\u304c\u8d77\u304d\u308b\u3002\nunbound\u30d7\u30ed\u30bb\u30b9\u505c\u6b62\u6642\u306b/var/unbound/dev/random\u3068/var/unbound/dev/log\u3092umount\u3055\u308c\u308b\u3088\u3046\u306b\u4fee\u6b63\u3059\u308b\u3002\n\u307e\u305f\u3001\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u306b/var/log/unbound.log\u304c\u5b58\u5728\u3057\u306a\u3044\u5834\u5408\u306b\u7a7a\u30d5\u30a1\u30a4\u30eb\u4f5c\u6210\u3059\u308b\u51e6\u7406\u3092\u8ffd\u52a0\u3059\u308b\u3002\n\n\n```\n# vi /etc/init.d/unbound\n\u3000(\u4e2d\u7565)\nstop() {\n    echo -n $\"Stopping $prog: \"\n    # stop it here, often \"killproc $prog\"\n    killproc -p $pidfile $prog\n    retval=$?\n    echo\n    [ $retval -eq 0 ] && rm -f $lockfile\n##    if egrep -q '^/[^[:space:]]+[[:space:]]+'${rootdir}'/dev/log' /proc/mounts; then\n    MOUNT_CHK=`grep \"devtmpfs ${rootdir}/dev/log\" /proc/mounts | grep -v ^# | wc -l`\n    if [ ${MOUNT_CHK} -ge 1 ] ; then\n        umount ${rootdir}/dev/log >/dev/null 2>&1\n    fi;\n##    if egrep -q '^/[^[:space:]]+[[:space:]]+'${rootdir}'/dev/random' /proc/mounts; then\n    MOUNT_CHK=`grep \"devtmpfs ${rootdir}/dev/random\" /proc/mounts | grep -v ^# | wc -l`\n    if [ ${MOUNT_CHK} -ge 1 ] ; then\n        umount ${rootdir}/dev/random >/dev/null 2>&1\n    fi;\n    return $retval\n}\n\u3000(\u4e2d\u7565)\nmake_logfile() {\n    if [ ! -e \"/var/log/unbound.log\" ]\n    then\n         touch /var/log/unbound.log\n         chmod 644 /var/log/unbound.log\n         chown unbound:unbound /var/log/unbound.log\n    fi\n}\n\u3000(\u4e2d\u7565)\ncase \"$1\" in\n    start)\n        rh_status_q && exit 0\n        make_logfile\n        $1\n        ;;\n    stop)\n        rh_status_q || exit 0\n        $1\n        ;;\n    restart)\n        make_logfile\n        $1\n        ;;\n    reload)\n        rh_status_q || exit 7\n        make_logfile\n        $1\n        ;;\n    force-reload)\n        make_logfile\n        force_reload\n        ;;\n    status)\n        rh_status\n        ;;\n    condrestart|try-restart)\n        rh_status_q || exit 0\n        make_logfile\n        restart\n        ;;\n    *)\n        echo $\"Usage: $0 {start|stop|status|restart|condrestart|try-restart|reload|force-reload}\"\n        exit 2\nesac\nexit $?\n```\n\n\n\u30fb\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u5909\u66f4\u5f8c\u306e\u5dee\u5206\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3002\n\n\n```\n# diff /usr/local/src/unbound-1.5.1/contrib/unbound.init /etc/init.d/unbound\n24c24\n< exec=\"/usr/sbin/unbound\"\n---\n> exec=\"/usr/local/sbin/unbound\"\n78c78,80\n<     if egrep -q '^/[^[:space:]]+[[:space:]]+'${rootdir}'/dev/log' /proc/mounts; then\n---\n> ##    if egrep -q '^/[^[:space:]]+[[:space:]]+'${rootdir}'/dev/log' /proc/mounts; then\n>     MOUNT_CHK=`grep \"devtmpfs ${rootdir}/dev/log\" /proc/mounts | grep -v ^# | wc -l`\n>     if [ ${MOUNT_CHK} -ge 1 ] ; then\n81c83,85\n<     if egrep -q '^/[^[:space:]]+[[:space:]]+'${rootdir}'/dev/random' /proc/mounts; then\n---\n> ##    if egrep -q '^/[^[:space:]]+[[:space:]]+'${rootdir}'/dev/random' /proc/mounts; then\n>     MOUNT_CHK=`grep \"devtmpfs ${rootdir}/dev/random\" /proc/mounts | grep -v ^# | wc -l`\n>     if [ ${MOUNT_CHK} -ge 1 ] ; then\n108a113,121\n> make_logfile() {\n>     if [ ! -e \"/var/log/unbound.log\" ]\n>     then\n>          touch /var/log/unbound.log\n>          chmod 644 /var/log/unbound.log\n>          chown unbound:unbound /var/log/unbound.log\n>     fi\n> }\n>\n111a125\n>         make_logfile\n118a133\n>         make_logfile\n122a138\n>         make_logfile\n125a142\n>         make_logfile\n132a150\n>         make_logfile\n#\n\n```\n\n\u30fbunbound\u30b5\u30fc\u30d0\u306bDNS\u30d5\u30a9\u30ef\u30fc\u30c9\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\nexample.org\u30c9\u30e1\u30a4\u30f3\u306e\u540d\u524d\u89e3\u6c7a\u3092Route53\u306b\u30d5\u30a9\u30ef\u30fc\u30c9\u3055\u305b\u305f\u3044\u5834\u5408\u3001forward-addr\u3067example.org\u30c9\u30e1\u30a4\u30f3\u3092\u7d10\u4ed8\u3051\u305fVPC\u306eAmazonProvidedDNS\u3092\u6307\u5b9a\u3059\u308b\u3002\n\n```\n# vi /var/unbound/etc/conf.d/example.org.conf\nforward-zone:\n      name: \"example.org.\"\n      forward-addr: XX.XX.XX.2 (unbound\u30b5\u30fc\u30d0\u3092\u4f5c\u6210\u3057\u305fVPC\u306eAmazonProvidedDNS\u3092\u6307\u5b9a\u3059\u308b)\n#\n```\n\n\u9006\u5f15\u304d\u30be\u30fc\u30f3\u306e\u540d\u524d\u89e3\u6c7a\u3092Route53\u3078\u30d5\u30a9\u30ef\u30fc\u30c9\u3055\u305b\u305f\u3044\u5834\u5408\u3001forward-addr\u3067\u9006\u5f15\u304d\u30be\u30fc\u30f3\u3092\u7d10\u4ed8\u3051\u305fVPC\u306eAmazonProvidedDNS\u3092\u6307\u5b9a\u3059\u308b\u3002\n\n```\n# vi /var/unbound/etc/conf.d/100.51.198.in-addr.arpa.conf\nforward-zone:\n      name: \"100.51.198.in-addr.arpa.\"\n      forward-addr: XX.XX.XX.2 (unbound\u30b5\u30fc\u30d0\u3092\u4f5c\u6210\u3057\u305fVPC\u306eAmazonProvidedDNS\u3092\u6307\u5b9a\u3059\u308b)\n#\n```\n\n```\n# vi /var/unbound/etc/local.d/100.51.198.in-addr.arpa.conf\nlocal-zone: \"100.51.198.in-addr.arpa.\" transparent\n#\n\n# vi /var/unbound/etc/local.d/example.org.conf\nlocal-zone: \"example.org.\" transparent\n#\n```\n\n\u30fbunbound\u30b5\u30fc\u30d0\u306e/etc/resolv.conf\u4fee\u6b63\n\nunbound\u30b5\u30fc\u30d0\u81ea\u8eab\u304c\u53c2\u7167\u3059\u308bDNS\u30b5\u30fc\u30d0\u3092\u81ea\u5206\u81ea\u8eab\u306b\u5909\u66f4\u3059\u308b\u3002\n\n\n```\n# vi /etc/resolv.conf\n### unbound\u30b5\u30fc\u30d0\u81ea\u8eab\u306eIP\u30a2\u30c9\u30ec\u30b9\nnameserver 127.0.0.1\n#\n```\n\n\u30fbunbound\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u30aa\u30fc\u30ca\u30fc\u8a2d\u5b9a\u3002\n\n```\n# chown -R unbound:unbound /var/unbound\n```\n\n\n\u30fbunbound\u8a2d\u5b9a\u30c1\u30a7\u30c3\u30af\u3002\n\n```\n# unbound-checkconf\nunbound-checkconf: no errors in /var/unbound/unbound.conf\n#\n\n```\n\n\u30fbunbound\u30d7\u30ed\u30bb\u30b9\u3092\u8d77\u52d5\u3059\u308b\u3002\n\n```\n# ps awux | grep -v grep | grep unbound\n#\n\n# /etc/init.d/unbound start\nStarting unbound:                                          [  OK  ]\n#\n\n# ps awux | grep -v grep | grep unbound\nunbound   8421  0.0  0.8 136500  8352 ?        Ssl  17:00   0:00 /usr/local/sbin/unbound\n#\n\n# unbound-control status\nversion: 1.5.1\nverbosity: 1\nthreads: 2\nmodules: 2 [ validator iterator ]\nuptime: 13 seconds\noptions: control(ssl)\nunbound (pid 8421) is running...\n#\n```\n\n\n\u25a0unbound\u30b5\u30fc\u30d0\u4e0a\u3067\u306e\u540d\u524d\u89e3\u6c7a\u30c6\u30b9\u30c8\n===\n\nunbound\u30b5\u30fc\u30d0\u4e0a\u3067\u540d\u524d\u89e3\u6c7a\u3092\u884c\u3048\u308b\u304b\u30c6\u30b9\u30c8\u3057\u307e\u3059\u3002\nRoute53\u306b\u767b\u9332\u3057\u3066\u3044\u308bexample.org\u30c9\u30e1\u30a4\u30f3\u3084\u9006\u5f15\u304d\u30be\u30fc\u30f3\u3001\u305d\u3057\u3066Route53\u4ee5\u5916\u306egoogle.com\u7b49\u306e\u30c9\u30e1\u30a4\u30f3\u306e\u540d\u524d\u3092\u89e3\u6c7a\u51fa\u6765\u308b\u304b\u30c6\u30b9\u30c8\u3057\u307e\u3059\u3002\n\n\u30c6\u30b9\u30c8\u524d\u306bunbound\u30b5\u30fc\u30d0\u4e0a\u3067\u3001/etc/init.d/unbound reload\u3092\u5b9f\u884c\u3057\u3066\u3001unbound\u30b5\u30fc\u30d0\u4e0a\u306e\u540d\u524d\u89e3\u6c7a\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u6d88\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n\u30fbunbound\u306e\u540d\u524d\u89e3\u6c7a\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u30af\u30ea\u30a2\u3059\u308b\u3002\n\n```\n# /etc/init.d/unbound reload\n#\n\n# unbound-control dump_cache\nSTART_RRSET_CACHE\nEND_RRSET_CACHE\nSTART_MSG_CACHE\nEND_MSG_CACHE\nEOF\n#\n```\n\n\u30fb\u540d\u524d\u89e3\u6c7a\u3057\u3066\u7d50\u679c\u304c\u8fd4\u3063\u3066\u304f\u308b\u304b\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```\n# dig +noall +ans route53-test.example.org @127.0.0.1\nroute53-test.example.org. 1     IN      A       198.51.100.10\n#\n\n# dig +noall +ans -x 198.51.100.10 @127.0.0.1\n10.100.51.198.in-addr.arpa. 1   IN      PTR     route53-test.example.org.\n#\n\n# dig +noall +ans www.google.co.jp @127.0.0.1\nwww.google.co.jp.       300     IN      A       173.194.38.87\nwww.google.co.jp.       300     IN      A       173.194.38.88\nwww.google.co.jp.       300     IN      A       173.194.38.95\nwww.google.co.jp.       300     IN      A       173.194.38.79\n#\n\n# dig +noall +ans www.google.com @127.0.0.1\nwww.google.com.         287     IN      A       74.125.235.176\nwww.google.com.         287     IN      A       74.125.235.180\nwww.google.com.         287     IN      A       74.125.235.177\nwww.google.com.         287     IN      A       74.125.235.179\nwww.google.com.         287     IN      A       74.125.235.178\n#\n\n# dig +noall +ans www.google.co.jp @127.0.0.1\nwww.google.co.jp.       192     IN      A       74.125.235.183\nwww.google.co.jp.       192     IN      A       74.125.235.191\nwww.google.co.jp.       192     IN      A       74.125.235.184\nwww.google.co.jp.       192     IN      A       74.125.235.175\n#\n```\n\n\n\u30fbunbound\u30b5\u30fc\u30d0\u3067\u540d\u524d\u89e3\u6c7a\u306e\u30ed\u30b0\u3092\u78ba\u8a8d\u3059\u308b\u3002\n\n```\n# tail -f /var/log/unbound.log\n\u3000(\u4e2d\u7565)\n[1420704380] unbound[8530:1] info: 127.0.0.1 route53-test.example.org. A IN\n[1420704380] unbound[8530:1] info: 127.0.0.1 10.100.51.198.in-addr.arpa. PTR IN\n[1420704380] unbound[8530:1] info: 127.0.0.1 www.google.co.jp. A IN\n[1420704380] unbound[8530:1] info: 127.0.0.1 www.google.com. A IN\n[1420704380] unbound[8530:1] info: 127.0.0.1 www.google.com. A IN\n[1420704380] unbound[8530:1] info: 127.0.0.1 www.google.co.jp. A IN\n\u3000(\u4e2d\u7565)\n```\n\n\n\u25a0Amazon VPC\u5916\u306e\u30b5\u30fc\u30d0\u304b\u3089unbound\u30b5\u30fc\u30d0\u3092\u6307\u5b9a\u3057\u305f\u540d\u524d\u89e3\u6c7a\u30c6\u30b9\u30c8\n===\n\nAmazon VPC\u5916\u306e\u30b5\u30fc\u30d0\u304b\u3089\u3001DNS\u30b5\u30fc\u30d0\u3068\u3057\u3066unbound\u30b5\u30fc\u30d0\u3092\u6307\u5b9a\u3057\u3066\u3001\u540d\u524d\u89e3\u6c7a\u3092\u884c\u3048\u308b\u304b\u30c6\u30b9\u30c8\u3057\u307e\u3059\u3002\nRoute53\u306b\u767b\u9332\u3057\u3066\u3044\u308bexample.org\u30c9\u30e1\u30a4\u30f3\u3084\u9006\u5f15\u304d\u30be\u30fc\u30f3\u3001\u305d\u3057\u3066Route53\u4ee5\u5916\u306egoogle.com\u7b49\u306e\u30c9\u30e1\u30a4\u30f3\u306e\u540d\u524d\u3092\u89e3\u6c7a\u51fa\u6765\u308b\u304b\u30c6\u30b9\u30c8\u3057\u307e\u3059\u3002\n\n\u30c6\u30b9\u30c8\u524d\u306bunbound\u30b5\u30fc\u30d0\u4e0a\u3067\u3001/etc/init.d/unbound reload\u3092\u5b9f\u884c\u3057\u3066\u3001unbound\u30b5\u30fc\u30d0\u4e0a\u306e\u540d\u524d\u89e3\u6c7a\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u6d88\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n\u30fbunbound\u306e\u540d\u524d\u89e3\u6c7a\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u30af\u30ea\u30a2\u3059\u308b\u3002\n\n```\n# /etc/init.d/unbound reload\n#\n\n# unbound-control dump_cache\nSTART_RRSET_CACHE\nEND_RRSET_CACHE\nSTART_MSG_CACHE\nEND_MSG_CACHE\nEOF\n#\n```\n\n\u30fb\u540d\u524d\u89e3\u6c7a\u3057\u3066\u7d50\u679c\u304c\u8fd4\u3063\u3066\u304f\u308b\u304b\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```\n[exampleuser@notvpcserver ~]$ dig +noall +ans route53-test.example.org @unbound\u30b5\u30fc\u30d0\u306eIP\u30a2\u30c9\u30ec\u30b9\u3092\u6307\u5b9a\u3059\u308b\nroute53-test.example.org. 1     IN      A       198.51.100.10\n[exampleuser@notvpcserver ~]$\n\n[exampleuser@notvpcserver ~]$ dig +noall +ans -x 198.51.100.10 @unbound\u30b5\u30fc\u30d0\u306eIP\u30a2\u30c9\u30ec\u30b9\u3092\u6307\u5b9a\u3059\u308b\n10.100.51.198.in-addr.arpa. 1   IN      PTR     route53-test.example.org.\n[exampleuser@notvpcserver ~]$\n\n[exampleuser@notvpcserver ~]$ dig +noall +ans www.google.com @unbound\u30b5\u30fc\u30d0\u306eIP\u30a2\u30c9\u30ec\u30b9\u3092\u6307\u5b9a\u3059\u308b\nwww.google.com.         300     IN      A       74.125.235.179\nwww.google.com.         300     IN      A       74.125.235.178\nwww.google.com.         300     IN      A       74.125.235.180\nwww.google.com.         300     IN      A       74.125.235.177\nwww.google.com.         300     IN      A       74.125.235.176\n[exampleuser@notvpcserver ~]$\n\n[exampleuser@notvpcserver ~]$ dig +noall +ans www.google.co.jp @unbound\u30b5\u30fc\u30d0\u306eIP\u30a2\u30c9\u30ec\u30b9\u3092\u6307\u5b9a\u3059\u308b\nwww.google.co.jp.       300     IN      A       74.125.235.191\nwww.google.co.jp.       300     IN      A       74.125.235.184\nwww.google.co.jp.       300     IN      A       74.125.235.183\nwww.google.co.jp.       300     IN      A       74.125.235.175\n[exampleuser@notvpcserver ~]$\n\n```\n\n\n\u25a0unbound\u30ed\u30b0\u30ed\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u8a2d\u5b9a\n===\n\nunbound\u30b5\u30fc\u30d0\u306e/var/log/unbound.log\u3092\u30ed\u30b0\u30ed\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3055\u305b\u305f\u3044\u5834\u5408\u3001unbound\u30b5\u30fc\u30d0\u306b\u4ee5\u4e0b\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n\u307e\u305aunbound-control\u30b3\u30de\u30f3\u30c9\u306e\u30d1\u30b9\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```\n# which unbound-control\n/usr/local/sbin/unbound-control\n#\n```\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30ed\u30b0\u30ed\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```\n# vi /etc/logrotate.d/unbound\n/var/log/unbound.log\n{\n    daily\n    rotate 30\n    size 15M\n    missingok\n    compress\n    create 644 unbound unbound\n    sharedscripts\n    prerotate\n        touch /var/log/unbound.log\n        chown unbound:unbound /var/log/unbound.log\n        chmod 644 /var/log/unbound.log\n        /usr/local/sbin/unbound-control log_reopen\n    endscript\n    postrotate\n        /usr/local/sbin/unbound-control log_reopen\n    endscript\n}\n```\n\n```\n# chown root:root /etc/logrotate.d/unbound\n# chmod 644 /etc/logrotate.d/unbound\n#\n```\n\n\u30ed\u30b0\u30ed\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306e\u30c6\u30b9\u30c8\u3092\u884c\u3044\u3001\u30a8\u30e9\u30fc\u304c\u51fa\u306a\u3044\u4e8b\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```\n# logrotate -dv /etc/logrotate.d/unbound\nreading config file /etc/logrotate.d/unbound\nreading config info for /var/log/unbound.log\n\n\nHandling 1 logs\n\nrotating pattern: /var/log/unbound.log\n 15728640 bytes (30 rotations)\nempty log files are rotated, old logs are removed\nconsidering log /var/log/unbound.log\n  log does not need rotating\nnot running prerotate script, since no logs will be rotated\nnot running postrotate script, since no logs were rotated\n#\n```\n\n\u7fcc\u65e5\u4ee5\u964d\u306b/var/log/unbound.log\u304c\u30ed\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3055\u308c\u3066\u3044\u308c\u3070\u8a2d\u5b9a\u5b8c\u4e86\u3067\u3059\u3002\n\n```\n# ll /var/log/unbound.log*\n-rw-r--r-- 1 unbound unbound   246825 *** **:** /var/log/unbound.log-YYYYMM01.gz\n-rw-r--r-- 1 unbound unbound   237778 *** **:** /var/log/unbound.log-YYYYMM02.gz\n#\n```\n\n\u9577\u304f\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u304c\u3001\u4ee5\u4e0a\u306b\u306a\u308a\u307e\u3059\u3002\n"}