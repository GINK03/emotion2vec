{"context": " More than 1 year has passed since last update.IaaS \u3067\u3042\u308b Digital Ocean \u306b\u5bfe\u3057\u3066 Ansible \u3067 Droplet\uff08\u3044\u308f\u3086\u308b\u4eee\u60f3\u30de\u30b7\u30f3\uff09\u306e\u8d77\u52d5\u3092\u8a66\u307f\u305f\u6642\u306e\u30ed\u30b0\u3002\n\n\u6e96\u5099\u3068\u524d\u63d0\n\nAnsible \u30db\u30b9\u30c8\u5074\u306b\u306f dopy \u304c\u5fc5\u8981\uff08pip install dopy or python-pip install dopy\uff09\nDigital Ocean \u306e Personal Access Tokens \u3092\u53d6\u5f97\u3057\u3066\u304a\u304f\nDigital Ocean \u3068 SSH \u63a5\u7d9a\u3059\u308b\u305f\u3081\u306b ssh-key \u3092\u4f5c\u3063\u3066\u767b\u9332\u3057\u3068\u304f\uff08login -> Settings -> Security -> SSH Keys\uff09\nDigital Ocean API \u306f version 2 \u3092\u4f7f\u3046\n\n\n\u74b0\u5883\n\nAnsible Host : Vine Linux 6.3 \nAnsible version 2.0.0\n\n\nAnsible \u6e96\u5099\n\nInventory\n\nhosts\n127.0.0.1 ansible_connection=local\n\n\n\nrole\n\nrole/ocean/tasks/main.yml\n - name: Create droplet in DigitalOcean\n   digital_ocean:\n     state=present\n     command=droplet\n     name=mydroplet-test\n     ssh_key_ids=987654321\n     api_token=aaaaaaaaaaaaa\n     image_id=ubuntu-14-04-x64\n     size_id=1gb\n     region_id=sgp1\n     wait_timeout=500\n   register: my_droplet\n - debug: msg=\"ID is {{ my_droplet.droplet.id }}\"\n - debug: msg=\"IP is {{ my_droplet.droplet.ip_address }}\"\n\n\n\nimages_id\u3001region_id\u3001size_id \u3092\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3067\u78ba\u8a8d\u3057\u3068\u304f\n\n$ curl -X GET -H 'Content-Type: application/json' -H 'Authorization: Bearer <your token>' \"https://api.digitalocean.com/v2/images\" | jq '.regions[] | .slug,'\n\n$ curl -X GET -H 'Content-Type: application/json' -H 'Authorization: Bearer <your token>' \"https://api.digitalocean.com/v2/regions\" | jq '.regions[] | .name,.slug,.sizes'\n\n\n\u767b\u9332\u3057\u3066\u3042\u308b ssh_key_ids \u306f \u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u3066\u78ba\u8a8d\u3057\u3068\u304f\n\n$ curl -X GET -H 'Content-Type: application/json' -H 'Authorization: Bearer <your token>' \"https://api.digitalocean.com/v2/account/keys\" | jq '.ssh_keys[] | .id'\n\n\n\u6700\u5f8c\u306e3\u884c\u306e\u3088\u3046\u306b IP Address \u3068 Droplet ID \u3092\u8868\u793a\u3057\u3068\u304f\u3088\u3046\u306b\u3059\u308b\u3068\u5f8c\u3005\u4fbf\u5229\n\n\nPlaybook\n\nocean.yml\n- hosts: all\n\n  roles:\n    - ocean\n\n\n\nPlaybook \u5b9f\u884c\n[hoge@akira tmp]$ ansible-playbook -i local_hosts ocean.yml\n\nPLAY [all] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [127.0.0.1]\n\nTASK: [ocean | Create droplet in DigitalOcean] ********************************\nchanged: [127.0.0.1]\n\nTASK: [ocean | debug msg=\"ID is {{ my_droplet.droplet.id }}\"] *****************\nok: [127.0.0.1] => {\n    \"msg\": \"ID is 1234567\"\n}\n\nTASK: [ocean | debug msg=\"IP is {{ my_droplet.droplet.ip_address }}\"] *********\nok: [127.0.0.1] => {\n    \"msg\": \"IP is 111.222.333.444\"\n}\n\nPLAY RECAP ********************************************************************\n127.0.0.1                  : ok=4    changed=1    unreachable=0    failed=0\n\n\n\n\u30ea\u30e2\u30fc\u30c8\u30ed\u30b0\u30a4\u30f3\n[hoge@akira ~]$ ssh -i docean.key root@111.222.333.444\nThe authenticity of host '111.222.333.444 (111.222.333.444)' can't be established.\nECDSA key fingerprint is 80:93:98:ea:ca:f1:2a:ed:4a:77:55:7d:d4:f9:a4:71.\nAre you sure you want to continue connecting (yes/no)? yes\nWarning: Permanently added '111.222.333.444' (ECDSA) to the list of known hosts.\nEnter passphrase for key 'docean.key':\nWelcome to Ubuntu 14.04.2 LTS (GNU/Linux 3.13.0-52-generic x86_64)\n\n * Documentation:  https://help.ubuntu.com/\n\n  System information as of Fri May 22 20:08:46 EDT 2015\n\n  System load: 0.0               Memory usage: 5%   Processes:       51\n  Usage of /:  5.0% of 29.40GB   Swap usage:   0%   Users logged in: 0\n\n  Graph this data and manage this system at:\n    https://landscape.canonical.com/\n\nroot@mydroplet-test:~#\n\n\n\u51aa\u7b49\u6027\uff08Idempotence\uff09\n\u4e0a\u8a18\u3067\u4f5c\u3063\u305f\u3068\u304d\u306b Droplet \u306e ID \u304c\u308f\u304b\u3063\u3066\u308b\u306e\u3067\u305d\u308c\u3092\u9069\u7528\u3059\u308b\u3002\n\nroles/ocean/tasks/main.yml\n - name: Create droplet in DigitalOcean\n   digital_ocean:\n     state=present\n     command=droplet\n     id=1234567  \u2605 \u3053\u3053\n     name=mydroplet-test\n     ssh_key_ids=987654321\n     api_token=aaaaaaaaaaaaa\n     image_id=ubuntu-14-04-x64\n     size_id=1gb\n     region_id=sgp1\n     wait_timeout=500\n   register: my_droplet\n - debug: msg=\"ID is {{ my_droplet.droplet.id }}\"\n - debug: msg=\"IP is {{ my_droplet.droplet.ip_address }}\"\n\n\n\u5b9f\u884c\u3057\u3066\u307f\u308b\u3002\n[hoge@akira tmp]$ ansible-playbook -i local_hosts ocean.yml\n\nPLAY [all] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [127.0.0.1]\n\nTASK: [ocean | Create droplet in DigitalOcean] ********************************\nok: [127.0.0.1]\n\nTASK: [ocean | debug msg=\"ID is {{ my_droplet.droplet.id }}\"] *****************\nok: [127.0.0.1] => {\n    \"msg\": \"ID is 1234567\"\n}\n\nTASK: [ocean | debug msg=\"IP is {{ my_droplet.droplet.ip_address }}\"] *********\nok: [127.0.0.1] => {\n    \"msg\": \"IP is 111.222.333.444\"\n}\n\nPLAY RECAP ********************************************************************\n127.0.0.1                  : ok=4    changed=0    unreachable=0    failed=0\n\n\n\u65b0\u305f\u306b Droplet \u304c\u4f5c\u3089\u308c\u308b\u3053\u3068\u306f\u306a\u3044\u3002\u3082\u3057\u30de\u30c3\u30c1\u3057\u306a\u3044\u5834\u5408\u306f\u65b0\u898f\u306b\u4f5c\u3089\u308c\u308b\u3002\n\n\u53c2\u8003\n\nAnsible - DigitalOcean\nDigitalOcean API v2\nDigitalOcean dopy\n\nIaaS \u3067\u3042\u308b Digital Ocean \u306b\u5bfe\u3057\u3066 Ansible \u3067 Droplet\uff08\u3044\u308f\u3086\u308b\u4eee\u60f3\u30de\u30b7\u30f3\uff09\u306e\u8d77\u52d5\u3092\u8a66\u307f\u305f\u6642\u306e\u30ed\u30b0\u3002\n\n# \u6e96\u5099\u3068\u524d\u63d0\n\n* Ansible \u30db\u30b9\u30c8\u5074\u306b\u306f dopy \u304c\u5fc5\u8981\uff08pip install dopy or python-pip install dopy\uff09\n* Digital Ocean \u306e Personal Access Tokens \u3092\u53d6\u5f97\u3057\u3066\u304a\u304f\n* Digital Ocean \u3068 SSH \u63a5\u7d9a\u3059\u308b\u305f\u3081\u306b ssh-key \u3092\u4f5c\u3063\u3066\u767b\u9332\u3057\u3068\u304f\uff08login -> Settings -> Security -> SSH Keys\uff09\n* Digital Ocean API \u306f version 2 \u3092\u4f7f\u3046\n\n# \u74b0\u5883\n\n* Ansible Host : Vine Linux 6.3 \n* Ansible version 2.0.0\n\n# Ansible \u6e96\u5099\n## Inventory\n\n```shell-session:hosts\n127.0.0.1 ansible_connection=local\n```\n\n## role\n\n```shell-session:role/ocean/tasks/main.yml\n - name: Create droplet in DigitalOcean\n   digital_ocean:\n     state=present\n     command=droplet\n     name=mydroplet-test\n     ssh_key_ids=987654321\n     api_token=aaaaaaaaaaaaa\n     image_id=ubuntu-14-04-x64\n     size_id=1gb\n     region_id=sgp1\n     wait_timeout=500\n   register: my_droplet\n - debug: msg=\"ID is {{ my_droplet.droplet.id }}\"\n - debug: msg=\"IP is {{ my_droplet.droplet.ip_address }}\"\n```\n\n* images_id\u3001region_id\u3001size_id \u3092\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3067\u78ba\u8a8d\u3057\u3068\u304f\n\n```shell-session\n$ curl -X GET -H 'Content-Type: application/json' -H 'Authorization: Bearer <your token>' \"https://api.digitalocean.com/v2/images\" | jq '.regions[] | .slug,'\n```\n\n```shell-session\n$ curl -X GET -H 'Content-Type: application/json' -H 'Authorization: Bearer <your token>' \"https://api.digitalocean.com/v2/regions\" | jq '.regions[] | .name,.slug,.sizes'\n```\n\n* \u767b\u9332\u3057\u3066\u3042\u308b ssh_key_ids \u306f \u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u3066\u78ba\u8a8d\u3057\u3068\u304f\n\n```shell-session\n$ curl -X GET -H 'Content-Type: application/json' -H 'Authorization: Bearer <your token>' \"https://api.digitalocean.com/v2/account/keys\" | jq '.ssh_keys[] | .id'\n```\n* \u6700\u5f8c\u306e3\u884c\u306e\u3088\u3046\u306b IP Address \u3068 Droplet ID \u3092\u8868\u793a\u3057\u3068\u304f\u3088\u3046\u306b\u3059\u308b\u3068\u5f8c\u3005\u4fbf\u5229\n\n## Playbook\n\n```shell-session:ocean.yml\n- hosts: all\n\n  roles:\n    - ocean\n```\n\n# Playbook \u5b9f\u884c\n\n```shell-session\n[hoge@akira tmp]$ ansible-playbook -i local_hosts ocean.yml\n\nPLAY [all] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [127.0.0.1]\n\nTASK: [ocean | Create droplet in DigitalOcean] ********************************\nchanged: [127.0.0.1]\n\nTASK: [ocean | debug msg=\"ID is {{ my_droplet.droplet.id }}\"] *****************\nok: [127.0.0.1] => {\n    \"msg\": \"ID is 1234567\"\n}\n\nTASK: [ocean | debug msg=\"IP is {{ my_droplet.droplet.ip_address }}\"] *********\nok: [127.0.0.1] => {\n    \"msg\": \"IP is 111.222.333.444\"\n}\n\nPLAY RECAP ********************************************************************\n127.0.0.1                  : ok=4    changed=1    unreachable=0    failed=0\n```\n\n![2015-05-23 9-09-35.png](https://qiita-image-store.s3.amazonaws.com/0/75458/e6100181-104b-f26c-2c85-dba062cf59ac.png)\n\n# \u30ea\u30e2\u30fc\u30c8\u30ed\u30b0\u30a4\u30f3\n\n```shell-session\n[hoge@akira ~]$ ssh -i docean.key root@111.222.333.444\nThe authenticity of host '111.222.333.444 (111.222.333.444)' can't be established.\nECDSA key fingerprint is 80:93:98:ea:ca:f1:2a:ed:4a:77:55:7d:d4:f9:a4:71.\nAre you sure you want to continue connecting (yes/no)? yes\nWarning: Permanently added '111.222.333.444' (ECDSA) to the list of known hosts.\nEnter passphrase for key 'docean.key':\nWelcome to Ubuntu 14.04.2 LTS (GNU/Linux 3.13.0-52-generic x86_64)\n\n * Documentation:  https://help.ubuntu.com/\n\n  System information as of Fri May 22 20:08:46 EDT 2015\n\n  System load: 0.0               Memory usage: 5%   Processes:       51\n  Usage of /:  5.0% of 29.40GB   Swap usage:   0%   Users logged in: 0\n\n  Graph this data and manage this system at:\n    https://landscape.canonical.com/\n\nroot@mydroplet-test:~#\n```\n\n# \u51aa\u7b49\u6027\uff08Idempotence\uff09\n\n\u4e0a\u8a18\u3067\u4f5c\u3063\u305f\u3068\u304d\u306b Droplet \u306e ID \u304c\u308f\u304b\u3063\u3066\u308b\u306e\u3067\u305d\u308c\u3092\u9069\u7528\u3059\u308b\u3002\n\n```shell-session:roles/ocean/tasks/main.yml\n - name: Create droplet in DigitalOcean\n   digital_ocean:\n     state=present\n     command=droplet\n     id=1234567  \u2605 \u3053\u3053\n     name=mydroplet-test\n     ssh_key_ids=987654321\n     api_token=aaaaaaaaaaaaa\n     image_id=ubuntu-14-04-x64\n     size_id=1gb\n     region_id=sgp1\n     wait_timeout=500\n   register: my_droplet\n - debug: msg=\"ID is {{ my_droplet.droplet.id }}\"\n - debug: msg=\"IP is {{ my_droplet.droplet.ip_address }}\"\n```\n\n\u5b9f\u884c\u3057\u3066\u307f\u308b\u3002\n\n```shell-session\n[hoge@akira tmp]$ ansible-playbook -i local_hosts ocean.yml\n\nPLAY [all] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [127.0.0.1]\n\nTASK: [ocean | Create droplet in DigitalOcean] ********************************\nok: [127.0.0.1]\n\nTASK: [ocean | debug msg=\"ID is {{ my_droplet.droplet.id }}\"] *****************\nok: [127.0.0.1] => {\n    \"msg\": \"ID is 1234567\"\n}\n\nTASK: [ocean | debug msg=\"IP is {{ my_droplet.droplet.ip_address }}\"] *********\nok: [127.0.0.1] => {\n    \"msg\": \"IP is 111.222.333.444\"\n}\n\nPLAY RECAP ********************************************************************\n127.0.0.1                  : ok=4    changed=0    unreachable=0    failed=0\n\n```\n\n\u65b0\u305f\u306b Droplet \u304c\u4f5c\u3089\u308c\u308b\u3053\u3068\u306f\u306a\u3044\u3002\u3082\u3057\u30de\u30c3\u30c1\u3057\u306a\u3044\u5834\u5408\u306f\u65b0\u898f\u306b\u4f5c\u3089\u308c\u308b\u3002\n\n# \u53c2\u8003\n\n* [Ansible - DigitalOcean](http://docs.ansible.com/digital_ocean_module.html)\n* [DigitalOcean API v2] (https://developers.digitalocean.com/documentation/v2/)\n* [DigitalOcean dopy](http://devo.ps/blog/announcing-dopy-with-digitalocean-api-v2/)\n", "tags": ["Ansible", "DigitalOcean"]}