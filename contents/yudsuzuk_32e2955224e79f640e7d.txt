{"tags": ["Line", "linebot", "PHP", "docomoAPI", "Silex"], "context": "LINE\u306e\u300cBOT API Trial Account\u300d\u304c\u5148\u77401\u4e07\u540d\u9650\u5b9a\u3067\u81ea\u7531\u306b\u958b\u767a\u3067\u304d\u308b\u3068\u3044\u3046\u3053\u3068\u306a\u306e\u3067\u3001\u30c9\u30b3\u30e2\u306e\u96d1\u8ac7\u5bfe\u8a71API\u3068\u7d44\u307f\u5408\u308f\u305b\u3066\u3001\n\u5f0a\u793eSchool With\u306e\u30de\u30b9\u30b3\u30c3\u30c8\u30ad\u30e3\u30e9\u30af\u30bf\u30fc\u300c\u3046\u3043\u305a\u5409\u300d\u306b\u547d\u3092\u5439\u304d\u8fbc\u307f\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n\n\u7528\u610f\u3059\u308b\u3082\u306e\n\nLINE BOT API Trial Account\n\u30c9\u30b3\u30e2\u96d1\u8ac7\u5bfe\u8a71API\u7528\u30a2\u30af\u30bb\u30b9\u30ad\u30fc\nSSL\u8a3c\u660e\u66f8\u304c\u8a2d\u7f6e\u3055\u308c\u305fWeb\u30b5\u30fc\u30d0\n\n\nLINE BOT API\u30a2\u30ab\u30a6\u30f3\u30c8\u3092\u53d6\u5f97\n\u53d6\u5f97\u3057\u305f\u3089\u4e0b\u8a18\u3092\u30e1\u30e2\u3063\u3066\u304a\u304d\u307e\u3057\u3087\u3046\n\nCHANNEL ID\nCHANNEL SECRET\nMID\n\n\nCallBack URL\u306f\u3053\u3093\u306a\u611f\u3058\u3067\u30dd\u30fc\u30c8\u756a\u53f7\u307e\u3067\u6307\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\u3002\nhttps://example.com:443/callback\n\u307e\u305fServer IP Whitelist\u306b\u306f\u7528\u610f\u3057\u305fWeb\u30b5\u30fc\u30d0\u306eIP\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u30c9\u30b3\u30e2\u96d1\u8ac7\u5bfe\u8a71API\u7528\u30a2\u30ab\u30a6\u30f3\u30c8\u3092\u53d6\u5f97\n\u53d6\u5f97\u3057\u305f\u3089\u4e0b\u8a18\u3092\u30e1\u30e2\u3063\u3066\u304a\u304d\u307e\u3057\u3087\u3046\n\nAPI Key\n\n\n\nSSL\u8a3c\u660e\u66f8\u304c\u8a2d\u7f6e\u3055\u308c\u305f\u30b5\u30fc\u30d0\u3092\u7528\u610f\n\u7121\u6599\u306e\u8a3c\u660e\u66f8Let's Encrypt\u306f\u4f7f\u3048\u307e\u305b\u3093\u3067\u3057\u305f\u3002\nHeroku\u306bFixie\u3068\u3044\u3046\u30a2\u30c9\u30aa\u30f3\u3092\u5c0e\u5165\u3059\u308c\u3070\u7121\u6599\u3067\u4f7f\u3048\u308b\u3088\u3046\u3067\u3059\u3002\n\u2193\nhttp://qiita.com/yuya_takeyama/items/0660a59d13e2cd0b2516\n\n\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b3\u30fc\u30c9\n\nSilex(PHP)\nRedis\n\nRedis\u306b\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8ID\u3092\u4fdd\u5b58\u3059\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\u30c9\u30b3\u30e2\u96d1\u8ac7\u5bfe\u8a71API\u306b\u306fPHP\u7528\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u304c\u3042\u3063\u305f\u306e\u3067\u305d\u3061\u3089\u3092\u4f7f\u3044\u307e\u3059\u3002\n\nindex.php\n<?php\n// \u8a2d\u5b9a\ndefine('DOCOMO_API_KEY', '');\ndefine('DOCOMO_MODE', 'dialog');\ndefine('LINE_CHANNEL_ID', '');\ndefine('LINE_CHANNEL_SECRET', '');\ndefine('LINE_MID', '');\n\nrequire_once(__DIR__ . '/vendor/autoload.php');\nuse jp3cki\\docomoDialogue\\Dialogue;\n\n$app = new Silex\\Application();\n$app->post('/callback', function (Request $request) use ($app) {\n    // \u30ea\u30af\u30a8\u30b9\u30c8\u53d6\u5f97\n    $request = file_get_contents(\"php://input\");\n    $json = json_decode($request);\n    $content = $json->result[0]->content;\n    $message = $content->text;\n    // \u30b3\u30f3\u30c6\u30ad\u30b9\u30c8ID\u3092\u53d6\u5f97\n    $from = $content->from;\n    $redis = new Redis();\n    $redis->connect(\"127.0.0.1\",6379);\n    $context = $redis->get($from);\n    // \u9001\u4fe1\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u6e96\u5099\n    $dialog = new Dialogue(DOCOMO_API_KEY);\n    $dialog->parameter->reset();\n    $dialog->parameter->utt = $message;\n    $dialog->parameter->context = $context;\n    $dialog->parameter->mode = DOCOMO_MODE;\n    // \u5bfe\u8a71\n    $ret = $dialog->request();\n    // \u30b3\u30f3\u30c6\u30ad\u30b9\u30c8ID\u3092\u4fdd\u5b58\n    $redis->set($from, $ret->context);\n    $response_format_text = [\n        'contentType' => 1,\n        \"toType\" => 1,\n        \"text\" => \"$ret->utt\"\n    ];\n    $post_data = [\n        \"to\" => [\n            $from\n        ],\n        \"toChannel\" => \"1383378250\", // \u56fa\u5b9a\u5024\n        \"eventType\" => \"138311608800106203\", // \u56fa\u5b9a\u5024\n        \"content\" => $response_format_text\n    ];\n    // LINE\u306b\u9001\u4fe1\n    $ch = curl_init(\"https://trialbot-api.line.me/v1/events\");\n    curl_setopt($ch, CURLOPT_POST, true);\n    curl_setopt($ch, CURLOPT_CUSTOMREQUEST, 'POST');\n    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);\n    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($post_data));\n    curl_setopt($ch, CURLOPT_HTTPHEADER, [\n        'Content-Type: application/json; charser=UTF-8',\n        \"X-Line-ChannelID: \" . LINE_CHANNEL_ID,\n        \"X-Line-ChannelSecret: \" . LINE_CHANNEL_SECRET,\n        \"X-Line-Trusted-User-With-ACL: \" . LINE_MID,\n    ]);\n    curl_exec($ch);\n    curl_close($ch);\n\n    return 'OK';\n});\n$app->run();\n\n\n\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306f\u3053\u3061\u3089\nhttps://github.com/YuzuruS/line\n\n\u7d50\u679c\n\n\u306a\u3093\u3068\u304b\u4f1a\u8a71\u306b\u306a\u3063\u3066\u307e\u3059\u306d\uff57\n\nLINE\u306e\u300cBOT API Trial Account\u300d\u304c\u5148\u77401\u4e07\u540d\u9650\u5b9a\u3067\u81ea\u7531\u306b\u958b\u767a\u3067\u304d\u308b\u3068\u3044\u3046\u3053\u3068\u306a\u306e\u3067\u3001\u30c9\u30b3\u30e2\u306e\u96d1\u8ac7\u5bfe\u8a71API\u3068\u7d44\u307f\u5408\u308f\u305b\u3066\u3001\n\u5f0a\u793e[School With](https://schoolwith.me)\u306e\u30de\u30b9\u30b3\u30c3\u30c8\u30ad\u30e3\u30e9\u30af\u30bf\u30fc\u300c[\u3046\u3043\u305a\u5409](https://twitter.com/schoolwith)\u300d\u306b\u547d\u3092\u5439\u304d\u8fbc\u307f\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002  \n![\u3046\u3043\u305a\u5409](https://qiita-image-store.s3.amazonaws.com/0/3962/7055956b-9d71-b490-a792-1286595944a4.jpeg)\n\n\n## \u7528\u610f\u3059\u308b\u3082\u306e\n- [LINE BOT API Trial Account](https://business.line.me/services/products/4/introduction)\n- [\u30c9\u30b3\u30e2\u96d1\u8ac7\u5bfe\u8a71API\u7528\u30a2\u30af\u30bb\u30b9\u30ad\u30fc](https://dev.smt.docomo.ne.jp/)\n- SSL\u8a3c\u660e\u66f8\u304c\u8a2d\u7f6e\u3055\u308c\u305fWeb\u30b5\u30fc\u30d0\n\n#### LINE BOT API\u30a2\u30ab\u30a6\u30f3\u30c8\u3092\u53d6\u5f97\n\u53d6\u5f97\u3057\u305f\u3089\u4e0b\u8a18\u3092\u30e1\u30e2\u3063\u3066\u304a\u304d\u307e\u3057\u3087\u3046\n\n- CHANNEL ID\n- CHANNEL SECRET\n- MID\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8_2016-04-14_21_36_20.png](https://qiita-image-store.s3.amazonaws.com/0/3962/b66b4fbc-9aee-ca90-f0cd-20bd8e57775e.png)\n\nCallBack URL\u306f\u3053\u3093\u306a\u611f\u3058\u3067\u30dd\u30fc\u30c8\u756a\u53f7\u307e\u3067\u6307\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\u3002\nhttps://example.com:443/callback\n\n\u307e\u305fServer IP Whitelist\u306b\u306f\u7528\u610f\u3057\u305fWeb\u30b5\u30fc\u30d0\u306eIP\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n#### \u30c9\u30b3\u30e2\u96d1\u8ac7\u5bfe\u8a71API\u7528\u30a2\u30ab\u30a6\u30f3\u30c8\u3092\u53d6\u5f97\n\u53d6\u5f97\u3057\u305f\u3089\u4e0b\u8a18\u3092\u30e1\u30e2\u3063\u3066\u304a\u304d\u307e\u3057\u3087\u3046\n\n- API Key\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8_2016-04-14_21_43_49.png](https://qiita-image-store.s3.amazonaws.com/0/3962/514bd32d-6e3c-a82a-855a-b9d35b3c00fb.png)\n\n#### SSL\u8a3c\u660e\u66f8\u304c\u8a2d\u7f6e\u3055\u308c\u305f\u30b5\u30fc\u30d0\u3092\u7528\u610f\n\u7121\u6599\u306e\u8a3c\u660e\u66f8Let's Encrypt\u306f\u4f7f\u3048\u307e\u305b\u3093\u3067\u3057\u305f\u3002\nHeroku\u306bFixie\u3068\u3044\u3046\u30a2\u30c9\u30aa\u30f3\u3092\u5c0e\u5165\u3059\u308c\u3070\u7121\u6599\u3067\u4f7f\u3048\u308b\u3088\u3046\u3067\u3059\u3002\n\u2193\n\nhttp://qiita.com/yuya_takeyama/items/0660a59d13e2cd0b2516\n\n### \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b3\u30fc\u30c9\n\n- Silex(PHP)\n- Redis\n\nRedis\u306b\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8ID\u3092\u4fdd\u5b58\u3059\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\u30c9\u30b3\u30e2\u96d1\u8ac7\u5bfe\u8a71API\u306b\u306fPHP\u7528\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u304c\u3042\u3063\u305f\u306e\u3067\u305d\u3061\u3089\u3092\u4f7f\u3044\u307e\u3059\u3002\n\n```index.php\n<?php\n// \u8a2d\u5b9a\ndefine('DOCOMO_API_KEY', '');\ndefine('DOCOMO_MODE', 'dialog');\ndefine('LINE_CHANNEL_ID', '');\ndefine('LINE_CHANNEL_SECRET', '');\ndefine('LINE_MID', '');\n\nrequire_once(__DIR__ . '/vendor/autoload.php');\nuse jp3cki\\docomoDialogue\\Dialogue;\n\n$app = new Silex\\Application();\n$app->post('/callback', function (Request $request) use ($app) {\n    // \u30ea\u30af\u30a8\u30b9\u30c8\u53d6\u5f97\n    $request = file_get_contents(\"php://input\");\n    $json = json_decode($request);\n    $content = $json->result[0]->content;\n    $message = $content->text;\n    // \u30b3\u30f3\u30c6\u30ad\u30b9\u30c8ID\u3092\u53d6\u5f97\n    $from = $content->from;\n    $redis = new Redis();\n    $redis->connect(\"127.0.0.1\",6379);\n    $context = $redis->get($from);\n    // \u9001\u4fe1\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u6e96\u5099\n    $dialog = new Dialogue(DOCOMO_API_KEY);\n    $dialog->parameter->reset();\n    $dialog->parameter->utt = $message;\n    $dialog->parameter->context = $context;\n    $dialog->parameter->mode = DOCOMO_MODE;\n    // \u5bfe\u8a71\n    $ret = $dialog->request();\n    // \u30b3\u30f3\u30c6\u30ad\u30b9\u30c8ID\u3092\u4fdd\u5b58\n    $redis->set($from, $ret->context);\n    $response_format_text = [\n        'contentType' => 1,\n        \"toType\" => 1,\n        \"text\" => \"$ret->utt\"\n    ];\n    $post_data = [\n        \"to\" => [\n            $from\n        ],\n        \"toChannel\" => \"1383378250\", // \u56fa\u5b9a\u5024\n        \"eventType\" => \"138311608800106203\", // \u56fa\u5b9a\u5024\n        \"content\" => $response_format_text\n    ];\n    // LINE\u306b\u9001\u4fe1\n    $ch = curl_init(\"https://trialbot-api.line.me/v1/events\");\n    curl_setopt($ch, CURLOPT_POST, true);\n    curl_setopt($ch, CURLOPT_CUSTOMREQUEST, 'POST');\n    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);\n    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($post_data));\n    curl_setopt($ch, CURLOPT_HTTPHEADER, [\n        'Content-Type: application/json; charser=UTF-8',\n        \"X-Line-ChannelID: \" . LINE_CHANNEL_ID,\n        \"X-Line-ChannelSecret: \" . LINE_CHANNEL_SECRET,\n        \"X-Line-Trusted-User-With-ACL: \" . LINE_MID,\n    ]);\n    curl_exec($ch);\n    curl_close($ch);\n    \n    return 'OK';\n});\n$app->run();\n```\n\n\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306f\u3053\u3061\u3089\nhttps://github.com/YuzuruS/line\n\n### \u7d50\u679c\n\n![aIMG_3645.jpg](https://qiita-image-store.s3.amazonaws.com/0/3962/e97de315-4b12-8ec4-e8d0-38dbdc53bc7e.jpeg)\n\n\u306a\u3093\u3068\u304b\u4f1a\u8a71\u306b\u306a\u3063\u3066\u307e\u3059\u306d\uff57\n"}