{"tags": ["AWS", "aws-cli", "lambda"], "context": "\n\n\u524d\u63d0\u6761\u4ef6\n\nLambda\u3078\u306e\u6a29\u9650\nLambda\u306b\u5bfe\u3057\u3066\u30d5\u30eb\u6a29\u9650\u304c\u3042\u308b\u3053\u3068\u3002\n\nAWS CLI\n\u4ee5\u4e0b\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u52d5\u4f5c\u78ba\u8a8d\u6e08\n\nAWS CLI 1.10.38\n\n\n\u30b3\u30de\u30f3\u30c9\naws --version\n\n\n\n\u7d50\u679c(\u4f8b)\naws-cli/1.10.38 Python/2.7.11 Darwin/15.5.0 botocore/1.4.28\n\n\n\nIAM Role\n'lambdaBasicExecution'\u30ed\u30fc\u30eb\u304c\u5b58\u5728\u3059\u308b\u3053\u3068\u3002\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nIAM_ROLE_NAME='lambdaBasicExecution'\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws iam get-role \\\n   --role-name ${IAM_ROLE_NAME}\n\n\n\n\u7d50\u679c(\u4f8b)\n      {\n          \"Role\": {\n            \"AssumeRolePolicyDocument\": {\n                \"Version\": \"2012-10-17\",\n                \"Statement\": [\n                    {\n                        \"Action\": \"sts:AssumeRole\",\n                        \"Principal\": {\n                            \"Service\": \"lambda.amazonaws.com\"\n                        },\n                        \"Effect\": \"Allow\",\n                        \"Sid\": \"\"\n                    }\n                ]\n            },\n            \"RoleId\": \"AROAXXXXXXXXXXXXXXXXX\",\n            \"CreateDate\": \"2015-10-26T01:55:54Z\",\n            \"RoleName\": \"lambdaBasicExecution\",\n            \"Path\": \"/\",\n            \"Arn\": \"arn:aws:iam::XXXXXXXXXXXX:role/lambdaBasicExecution\"\n          }\n      }\n\n\n\u5b58\u5728\u3057\u306a\u3044\u5834\u5408\u306f\u3001\nhttp://qiita.com/tcsh/items/455fcea33fc1171a5502\n\u306e\u624b\u9806\u306b\u5f93\u3063\u3066\u4f5c\u6210\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n0. \u6e96\u5099\n\n0.1. \u5909\u6570\u306e\u78ba\u8a8d\n\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u304c\u60f3\u5b9a\u306e\u3082\u306e\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\u5909\u6570\u306e\u78ba\u8a8d\naws configure list\n\n\n\n\u7d50\u679c(\u4f8b)\n\n            Name                    Value             Type    Location\n            ----                    -----             ----    --------\n         profile       lambdaFull-prjz-mbp13        env    AWS_DEFAULT_PROFILE\n      access_key     ****************XXXX shared-credentials-file\n      secret_key     ****************XXXX shared-credentials-file\n          region        ap-northeast-1        env    AWS_DEFAULT_REGION\n\n\n\n0.2. IAM Role\u306eARN\u53d6\u5f97\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nIAM_ROLE_NAME='lambdaBasicExecution'\n\n\n\n\u30b3\u30de\u30f3\u30c9\nIAM_ROLE_ARN=$( \\\n  aws iam get-role \\\n    --role-name ${IAM_ROLE_NAME} \\\n    --query 'Role.Arn' \\\n    --output text \\\n) \\\n  && echo ${IAM_ROLE_ARN}\n\n\n\n\u7d50\u679c(\u4f8b)\n      arn:aws:iam::XXXXXXXXXXXX:role/lambdaBasicExecution\n\n\n\n0.3. \u30c8\u30d4\u30c3\u30af\u306e\u6307\u5b9a\n\u901a\u77e5\u5148\u3092\u767b\u9332\u3059\u308b\u30c8\u30d4\u30c3\u30af\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nSNS_TOPIC_NAME=\"$(date +%Y%m%d)-handson-topic\" \\\n  && echo ${SNS_TOPIC_NAME}\n\n\n\n0.4. \u30c8\u30d4\u30c3\u30afARN\u306e\u53d6\u5f97\n\n\u30b3\u30de\u30f3\u30c9\nSNS_TOPIC_ARN=$( \\\n        aws sns list-topics \\\n          --query \"Topics[?contains(TopicArn, \\`${SNS_TOPIC_NAME}\\`)].TopicArn\" \\\n          --output text \\\n) \\\n        && echo ${SNS_TOPIC_ARN}\n\n\n\n\u7d50\u679c(\u4f8b)\n      arn:aws:sns:ap-northeast-1:XXXXXXXXXXXX:20160620-handson-topic\n\n\n\n1. \u4e8b\u524d\u4f5c\u696d\n\n1.1. Lambda\u95a2\u6570\u540d\u306e\u6c7a\u5b9a\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nLAMBDA_FUNC_NAME=\"sns-message-$( date '+%Y%m%d' )\"\n\n\n\u540c\u540d\u306eLambda\u95a2\u6570\u306e\u4e0d\u5b58\u5728\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws lambda get-function \\\n  --function-name ${LAMBDA_FUNC_NAME}\n\n\n\n\u7d50\u679c(\u4f8b)\n      A client error (ResourceNotFoundException) occurred when calling the GetFunction operation: Function not found: arn:aws:lambda:ap-northeast-1:XXXXXXXXXXXX:function:sns-message-20160620\n\n\n\n1.2. Lambda\u95a2\u6570\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nFILE_LAMBDA_FUNC=\"${LAMBDA_FUNC_NAME}.py\"\n\n\n\n\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n    FILE_LAMBDA_FUNC: ${FILE_LAMBDA_FUNC}\n\nETX\n\n\n\n\u30b3\u30de\u30f3\u30c9\ncat << EOF > ${FILE_LAMBDA_FUNC}\nfrom __future__ import print_function\n\nimport json\n\nprint('Loading function')\n\n\ndef lambda_handler(event, context):\n    #print(\"Received event: \" + json.dumps(event, indent=2))\n    message = event['Records'][0]['Sns']['Message']\n    print(\"From SNS: \" + message)\n    return message\nEOF\n\ncat ${FILE_LAMBDA_FUNC}\n\n\n\n\u30b3\u30de\u30f3\u30c9\nzip ${LAMBDA_FUNC_NAME}.zip ${FILE_LAMBDA_FUNC}\n\n\n\n\u7d50\u679c(\u4f8b)\n\n      adding: sns-message-20160620.py (deflated 43%)\n\n\n\n2. Lambda\u95a2\u6570\u306e\u4f5c\u6210\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nLAMBDA_FUNC_DESC='An Amazon SNS trigger that logs the message pushed to the SNS topic.'\nLAMBDA_RUNTIME='python2.7'\nLAMBDA_HANDLER=\"${LAMBDA_FUNC_NAME}.lambda_handler\"\nFILE_LAMBDA_ZIP=\"${LAMBDA_FUNC_NAME}.zip\"\n\n\n\n\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n  LAMBDA_FUNC_NAME:  ${LAMBDA_FUNC_NAME}\n  LAMBDA_FUNC_DESC: \"${LAMBDA_FUNC_DESC}\"\n  LAMBDA_RUNTIME:    ${LAMBDA_RUNTIME}\n  FILE_LAMBDA_ZIP    ${FILE_LAMBDA_ZIP}\n  IAM_ROLE_ARN:      ${IAM_ROLE_ARN}\n  LAMBDA_HANDLER:    ${LAMBDA_HANDLER}\n\nETX\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws lambda create-function \\\n  --function-name ${LAMBDA_FUNC_NAME} \\\n  --description \"${LAMBDA_FUNC_DESC}\" \\\n  --zip-file fileb://${FILE_LAMBDA_ZIP} \\\n  --runtime ${LAMBDA_RUNTIME} \\\n  --role ${IAM_ROLE_ARN} \\\n  --handler ${LAMBDA_HANDLER}\n\n\n\n\u7d50\u679c(\u4f8b)\n{\n    \"CodeSha256\": \"y8yjqcUI8TGWAxqVt3x3BVzOv3Pb+rGr+0KPghz36i8=\", \n    \"FunctionName\": \"sns-message-20160620\", \n    \"CodeSize\": 380, \n    \"MemorySize\": 128, \n    \"FunctionArn\": \"arn:aws:lambda:us-west-2:xxxxxxxxxxxx:function:sns-message-20160620\", \n    \"Version\": \"$LATEST\", \n    \"Role\": \"arn:aws:iam::xxxxxxxxxxxx:role/lambdaBasicExecution\", \n    \"Timeout\": 3, \n    \"LastModified\": \"2016-06-19T15:10:47.747+0000\", \n    \"Handler\": \"sns-message-20160620.lambda_handler\", \n    \"Runtime\": \"python2.7\", \n    \"Description\": \"An Amazon SNS trigger that logs the message pushed to the SNS topic.\"\n}\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws lambda list-functions \n\n\n\n\u7d50\u679c(\u4f8b)\n{\n    \"Functions\": [\n        {\n            \"Version\": \"$LATEST\", \n            \"CodeSha256\": \"y8yjqcUI8TGWAxqVt3x3BVzOv3Pb+rGr+0KPghz36i8=\", \n            \"FunctionName\": \"sns-message-20160620\", \n            \"MemorySize\": 128, \n            \"CodeSize\": 380, \n            \"FunctionArn\": \"arn:aws:lambda:us-west-2:xxxxxxxxxxxx:function:sns-message-20160620\", \n            \"Handler\": \"sns-message-20160620.lambda_handler\", \n            \"Role\": \"arn:aws:iam::xxxxxxxxxxxx:role/lambdaBasicExecution\", \n            \"Timeout\": 3, \n            \"LastModified\": \"2016-06-19T15:10:47.747+0000\", \n            \"Runtime\": \"python2.7\", \n            \"Description\": \"An Amazon SNS trigger that logs the message pushed to the SNS topic.\"\n        }\n    ]\n}\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws lambda get-function \\\n  --function-name ${LAMBDA_FUNC_NAME}\n\n\n\n\u7d50\u679c(\u4f8b)\n{\n    \"Code\": {\n        \"RepositoryType\": \"S3\", \n        \"Location\": \"https://awslambda-us-west-2-tasks.s3-us-west-2.amazonaws.com/snapshots/xxxxxxxxxxxx/sns-message-20160620-94f6e8eb-ee3b-4c00-8c8a-954642396e71?x-amz-security-token=FQoDYXdzEO%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaDEruHidCLdnnzUDGQyK0A4dUQtu%2B4zoY%2FrVVjjQEHA3PZ4wZmeokZ4wNGVvL6Gl05QSctL4dRe79VgjBK%2BtYIUm1p6HgzxlWcrpV%2BhNgZsxsCqinRcBg79210XdopPa0wlPbswNIhqsHMyJS0Gs4x6eiKKJ9Gq2vMsiPoPKN8yKECvkDhCcSRs2wxCZrDybDutmqWKZowrNABgM4hzJGNz9xAh4dxN4Pr8fh%2F185glbq2iusjf3JP9gRIQKlT%2Bn9Xry1Jvj4qE0bl0iptY%2BRb%2FrzxTiz393p%2BYC0MJ63FR85T8GYtlhXzqAntufp4bxbkAKJFSsvEiO0LqssF%2Fse8aMTeIaPOfKOhOelT49HrbM0WLuRu7DBU416etC1AjkNCKMdPBPc9x%2FrCEcJKVfy5uENqrM8bKEFAdGMBMwFyUSHHnklsMTY8GSJtisBQIUVHNVTE5jbELx5kH9SaTolRfyTTVWLBn4Amlcobjhf1adlW58BmGa5Jge%2Bm1SzuvocaMRZQms%2BN6lNv9dLEgqT%2BlvVObkEqBk8m0O0ZLZat61SNoR81ymItLyuhmyg1QNbkOqpATQCg0wXg3WReKGqWUR1%2FckoucyauwU%3D&AWSAccessKeyId=ASIAJHC2NNIWC2M5YV3Q&Expires=1466349693&Signature=a%2FeD%2F%2FLuqd9HX23v4uDDAMMcuzQ%3D\"\n    }, \n    \"Configuration\": {\n        \"Version\": \"$LATEST\", \n        \"CodeSha256\": \"y8yjqcUI8TGWAxqVt3x3BVzOv3Pb+rGr+0KPghz36i8=\", \n        \"FunctionName\": \"sns-message-20160620\", \n        \"MemorySize\": 128, \n        \"CodeSize\": 380, \n        \"FunctionArn\": \"arn:aws:lambda:us-west-2:xxxxxxxxxxxx:function:sns-message-20160620\", \n        \"Handler\": \"sns-message-20160620.lambda_handler\", \n        \"Role\": \"arn:aws:iam::xxxxxxxxxxxx:role/lambdaBasicExecution\", \n        \"Timeout\": 3, \n        \"LastModified\": \"2016-06-19T15:10:47.747+0000\", \n        \"Runtime\": \"python2.7\", \n        \"Description\": \"An Amazon SNS trigger that logs the message pushed to the SNS topic.\"\n    }\n}\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws lambda get-function-configuration \\\n  --function-name ${LAMBDA_FUNC_NAME}\n\n\n\n\u7d50\u679c(\u4f8b)\n{\n    \"CodeSha256\": \"y8yjqcUI8TGWAxqVt3x3BVzOv3Pb+rGr+0KPghz36i8=\", \n    \"FunctionName\": \"sns-message-20160620\", \n    \"CodeSize\": 380, \n    \"MemorySize\": 128, \n    \"FunctionArn\": \"arn:aws:lambda:us-west-2:xxxxxxxxxxxx:function:sns-message-20160620\", \n    \"Version\": \"$LATEST\", \n    \"Role\": \"arn:aws:iam::xxxxxxxxxxxx:role/lambdaBasicExecution\", \n    \"Timeout\": 3, \n    \"LastModified\": \"2016-06-19T15:10:47.747+0000\", \n    \"Handler\": \"sns-message-20160620.lambda_handler\", \n    \"Runtime\": \"python2.7\", \n    \"Description\": \"An Amazon SNS trigger that logs the message pushed to the SNS topic.\"\n}\n\n\n\n3. Lambda\u95a2\u6570\u306e\u52d5\u4f5c\u78ba\u8a8d\n\n3.1. \u30b5\u30f3\u30d7\u30eb\u30c7\u30fc\u30bf\u306e\u4f5c\u6210\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nFILE_INPUT=\"${LAMBDA_FUNC_NAME}-data.json\" \\\n    && echo ${FILE_INPUT}\n\n\n\n\u30b3\u30de\u30f3\u30c9\ncat << EOF > ${FILE_INPUT}\n{\n  \"Records\": [\n    {\n      \"EventVersion\": \"1.0\",\n      \"EventSubscriptionArn\": \"arn:aws:sns:EXAMPLE\",\n      \"EventSource\": \"aws:sns\",\n      \"Sns\": {\n        \"SignatureVersion\": \"1\",\n        \"Timestamp\": \"1970-01-01T00:00:00.000Z\",\n        \"Signature\": \"EXAMPLE\",\n        \"SigningCertUrl\": \"EXAMPLE\",\n        \"MessageId\": \"95df01b4-ee98-5cb9-9903-4c221d41eb5e\",\n        \"Message\": \"Hello from SNS!\",\n        \"MessageAttributes\": {\n          \"Test\": {\n            \"Type\": \"String\",\n            \"Value\": \"TestString\"\n          },\n          \"TestBinary\": {\n            \"Type\": \"Binary\",\n            \"Value\": \"TestBinary\"\n          }\n        },\n        \"Type\": \"Notification\",\n        \"UnsubscribeUrl\": \"EXAMPLE\",\n        \"TopicArn\": \"${SNS_TOPIC_NAME}\",\n        \"Subject\": \"TestInvoke\"\n      }\n    }\n  ]\n}\nEOF\n\ncat ${FILE_INPUT}\n\n\nJSON\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u305f\u3089\u3001\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u304c\u58ca\u308c\u3066\u306a\u3044\u304b\u5fc5\u305a\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\njsonlint -q ${FILE_INPUT}\n\n\n\u30a8\u30e9\u30fc\u304c\u51fa\u529b\u3055\u308c\u306a\u3051\u308c\u3070OK\u3067\u3059\u3002\n\n3.2. lambda\u95a2\u6570\u306e\u624b\u52d5\u5b9f\u884c\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nFILE_OUTPUT_LAMBDA=\"${LAMBDA_FUNC_NAME}-out.txt\"\nFILE_LOG_LAMBDA=\"${LAMBDA_FUNC_NAME}-$(date +%Y%m%d%H%M%S).log\"\n\n\n\n\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n  LAMBDA_FUNC_NAME:   ${LAMBDA_FUNC_NAME}\n  FILE_INPUT:         ${FILE_INPUT}\n  FILE_OUTPUT_LAMBDA: ${FILE_OUTPUT_LAMBDA}\n  FILE_LOG_LAMBDA:    ${FILE_LOG_LAMBDA}\n\nETX\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws lambda invoke \\\n  --function-name ${LAMBDA_FUNC_NAME} \\\n  --log-type Tail \\\n  --payload file://${FILE_INPUT} \\\n  ${FILE_OUTPUT_LAMBDA} \\\n  > ${FILE_LOG_LAMBDA}\n\n\n\n\u30b3\u30de\u30f3\u30c9\ncat ${FILE_LOG_LAMBDA} \\\n  | jp.py 'StatusCode'\n\n\n\n\u7d50\u679c(\u4f8b)\n      200\n\n\n\n3.3. lambda\u95a2\u6570\u306e\u5b9f\u884c\u7d50\u679c\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\ncat ${FILE_OUTPUT_LAMBDA}\n\n\n\n\u7d50\u679c(\u4f8b)\n1970-01-01T00:00:00Z\n\n\n\n3.4. lambda\u95a2\u6570\u306e\u30ed\u30b0\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\ncat ${FILE_LOG_LAMBDA} \\\n  | jp.py 'LogResult' \\\n  | sed 's/\"//g' \\\n  | base64 --decode\n\n\n\n\u7d50\u679c(\u4f8b)\n\n\n\n\n4. permission\u306e\u8ffd\u52a0\n\n4.1. Lambda\u5b9f\u884c\u6a29\u9650\u306e\u4ed8\u4e0e\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nLAMBDA_STAT_ID='AllowSNS'\nLAMBDA_PERMIT_ACTION='lambda:InvokeFunction'\nLAMBDA_PERMIT_PRINCIPAL='sns.amazonaws.com'\n\n\n\n\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n  LAMBDA_FUNC_NAME:        ${LAMBDA_FUNC_NAME}\n  LAMBDA_STAT_ID:         \"${LAMBDA_STAT_ID}\"\n  LAMBDA_PERMIT_ACTION:    ${LAMBDA_PERMIT_ACTION}\n  LAMBDA_PERMIT_PRINCIPAL: ${LAMBDA_PERMIT_PRINCIPAL}\n\nETX\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws lambda add-permission \\\n  --function-name ${LAMBDA_FUNC_NAME} \\\n  --statement-id \"${LAMBDA_STAT_ID}\" \\\n  --action ${LAMBDA_PERMIT_ACTION} \\\n  --principal ${LAMBDA_PERMIT_PRINCIPAL}\n\n\n\n\u7d50\u679c(\u4f8b)\n{\n    \"Statement\": \"{\\\"Action\\\":[\\\"lambda:InvokeFunction\\\"],\\\"Resource\\\":\\\"arn:aws:lambda:us-west-2:xxxxxxxxxxxx:function:sns-message-20160620\\\",\\\"Effect\\\":\\\"Allow\\\",\\\"Principal\\\":{\\\"Service\\\":\\\"sns.amazonaws.com\\\"},\\\"Sid\\\":\\\"AllowSNS\\\"}\"\n}\n\n\n\n\u5b8c\u4e86\n\n\n\u524d\u63d0\u6761\u4ef6\n========\n\n\nLambda\u3078\u306e\u6a29\u9650\n--------------\n\nLambda\u306b\u5bfe\u3057\u3066\u30d5\u30eb\u6a29\u9650\u304c\u3042\u308b\u3053\u3068\u3002\n\n\nAWS CLI\n-------\n\n\u4ee5\u4e0b\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u52d5\u4f5c\u78ba\u8a8d\u6e08\n\n* AWS CLI 1.10.38\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws --version\n```\n\n```text:\u7d50\u679c(\u4f8b):\naws-cli/1.10.38 Python/2.7.11 Darwin/15.5.0 botocore/1.4.28\n```\n\n\nIAM Role\n--------\n\n'lambdaBasicExecution'\u30ed\u30fc\u30eb\u304c\u5b58\u5728\u3059\u308b\u3053\u3068\u3002\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nIAM_ROLE_NAME='lambdaBasicExecution'\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws iam get-role \\\n   --role-name ${IAM_ROLE_NAME}\n```\n\n```json:\u7d50\u679c(\u4f8b):\n      {\n          \"Role\": {\n            \"AssumeRolePolicyDocument\": {\n                \"Version\": \"2012-10-17\",\n                \"Statement\": [\n                    {\n                        \"Action\": \"sts:AssumeRole\",\n                        \"Principal\": {\n                            \"Service\": \"lambda.amazonaws.com\"\n                        },\n                        \"Effect\": \"Allow\",\n                        \"Sid\": \"\"\n                    }\n                ]\n            },\n            \"RoleId\": \"AROAXXXXXXXXXXXXXXXXX\",\n            \"CreateDate\": \"2015-10-26T01:55:54Z\",\n            \"RoleName\": \"lambdaBasicExecution\",\n            \"Path\": \"/\",\n            \"Arn\": \"arn:aws:iam::XXXXXXXXXXXX:role/lambdaBasicExecution\"\n          }\n      }\n```\n\n\u5b58\u5728\u3057\u306a\u3044\u5834\u5408\u306f\u3001\nhttp://qiita.com/tcsh/items/455fcea33fc1171a5502\n\u306e\u624b\u9806\u306b\u5f93\u3063\u3066\u4f5c\u6210\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\n0. \u6e96\u5099\n=======\n\n\n0.1. \u5909\u6570\u306e\u78ba\u8a8d\n---------------\n\n\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u304c\u60f3\u5b9a\u306e\u3082\u306e\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d:\naws configure list\n```\n\n```text:\u7d50\u679c(\u4f8b):\n\n            Name                    Value             Type    Location\n            ----                    -----             ----    --------\n         profile       lambdaFull-prjz-mbp13        env    AWS_DEFAULT_PROFILE\n      access_key     ****************XXXX shared-credentials-file\n      secret_key     ****************XXXX shared-credentials-file\n          region        ap-northeast-1        env    AWS_DEFAULT_REGION\n```\n\n\n0.2. IAM Role\u306eARN\u53d6\u5f97\n----------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nIAM_ROLE_NAME='lambdaBasicExecution'\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nIAM_ROLE_ARN=$( \\\n  aws iam get-role \\\n    --role-name ${IAM_ROLE_NAME} \\\n    --query 'Role.Arn' \\\n    --output text \\\n) \\\n  && echo ${IAM_ROLE_ARN}\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      arn:aws:iam::XXXXXXXXXXXX:role/lambdaBasicExecution\n```\n\n\n0.3. \u30c8\u30d4\u30c3\u30af\u306e\u6307\u5b9a\n-------------------\n\n\u901a\u77e5\u5148\u3092\u767b\u9332\u3059\u308b\u30c8\u30d4\u30c3\u30af\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nSNS_TOPIC_NAME=\"$(date +%Y%m%d)-handson-topic\" \\\n  && echo ${SNS_TOPIC_NAME}\n```\n\n\n\n\n0.4. \u30c8\u30d4\u30c3\u30afARN\u306e\u53d6\u5f97\n----------------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nSNS_TOPIC_ARN=$( \\\n        aws sns list-topics \\\n          --query \"Topics[?contains(TopicArn, \\`${SNS_TOPIC_NAME}\\`)].TopicArn\" \\\n          --output text \\\n) \\\n        && echo ${SNS_TOPIC_ARN}\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      arn:aws:sns:ap-northeast-1:XXXXXXXXXXXX:20160620-handson-topic\n```\n\n\n\n1. \u4e8b\u524d\u4f5c\u696d\n===========\n\n\n1.1. Lambda\u95a2\u6570\u540d\u306e\u6c7a\u5b9a\n-----------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nLAMBDA_FUNC_NAME=\"sns-message-$( date '+%Y%m%d' )\"\n```\n\n\u540c\u540d\u306eLambda\u95a2\u6570\u306e\u4e0d\u5b58\u5728\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws lambda get-function \\\n  --function-name ${LAMBDA_FUNC_NAME}\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      A client error (ResourceNotFoundException) occurred when calling the GetFunction operation: Function not found: arn:aws:lambda:ap-northeast-1:XXXXXXXXXXXX:function:sns-message-20160620\n```\n\n\n1.2. Lambda\u95a2\u6570\n---------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nFILE_LAMBDA_FUNC=\"${LAMBDA_FUNC_NAME}.py\"\n```\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d:\ncat << ETX\n\n    FILE_LAMBDA_FUNC: ${FILE_LAMBDA_FUNC}\n\nETX\n```\n\n\n```bash:\u30b3\u30de\u30f3\u30c9:\ncat << EOF > ${FILE_LAMBDA_FUNC}\nfrom __future__ import print_function\n\nimport json\n\nprint('Loading function')\n\n\ndef lambda_handler(event, context):\n    #print(\"Received event: \" + json.dumps(event, indent=2))\n    message = event['Records'][0]['Sns']['Message']\n    print(\"From SNS: \" + message)\n    return message\nEOF\n\ncat ${FILE_LAMBDA_FUNC}\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nzip ${LAMBDA_FUNC_NAME}.zip ${FILE_LAMBDA_FUNC}\n```\n\n```text:\u7d50\u679c(\u4f8b):\n\n      adding: sns-message-20160620.py (deflated 43%)\n```\n\n\n2. Lambda\u95a2\u6570\u306e\u4f5c\u6210\n===================\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nLAMBDA_FUNC_DESC='An Amazon SNS trigger that logs the message pushed to the SNS topic.'\nLAMBDA_RUNTIME='python2.7'\nLAMBDA_HANDLER=\"${LAMBDA_FUNC_NAME}.lambda_handler\"\nFILE_LAMBDA_ZIP=\"${LAMBDA_FUNC_NAME}.zip\"\n```\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d:\ncat << ETX\n\n  LAMBDA_FUNC_NAME:  ${LAMBDA_FUNC_NAME}\n  LAMBDA_FUNC_DESC: \"${LAMBDA_FUNC_DESC}\"\n  LAMBDA_RUNTIME:    ${LAMBDA_RUNTIME}\n  FILE_LAMBDA_ZIP    ${FILE_LAMBDA_ZIP}\n  IAM_ROLE_ARN:      ${IAM_ROLE_ARN}\n  LAMBDA_HANDLER:    ${LAMBDA_HANDLER}\n\nETX\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws lambda create-function \\\n  --function-name ${LAMBDA_FUNC_NAME} \\\n  --description \"${LAMBDA_FUNC_DESC}\" \\\n  --zip-file fileb://${FILE_LAMBDA_ZIP} \\\n  --runtime ${LAMBDA_RUNTIME} \\\n  --role ${IAM_ROLE_ARN} \\\n  --handler ${LAMBDA_HANDLER}\n```\n\n```json:\u7d50\u679c(\u4f8b):\n{\n    \"CodeSha256\": \"y8yjqcUI8TGWAxqVt3x3BVzOv3Pb+rGr+0KPghz36i8=\", \n    \"FunctionName\": \"sns-message-20160620\", \n    \"CodeSize\": 380, \n    \"MemorySize\": 128, \n    \"FunctionArn\": \"arn:aws:lambda:us-west-2:xxxxxxxxxxxx:function:sns-message-20160620\", \n    \"Version\": \"$LATEST\", \n    \"Role\": \"arn:aws:iam::xxxxxxxxxxxx:role/lambdaBasicExecution\", \n    \"Timeout\": 3, \n    \"LastModified\": \"2016-06-19T15:10:47.747+0000\", \n    \"Handler\": \"sns-message-20160620.lambda_handler\", \n    \"Runtime\": \"python2.7\", \n    \"Description\": \"An Amazon SNS trigger that logs the message pushed to the SNS topic.\"\n}\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws lambda list-functions \n```\n\n```json:\u7d50\u679c(\u4f8b):\n{\n    \"Functions\": [\n        {\n            \"Version\": \"$LATEST\", \n            \"CodeSha256\": \"y8yjqcUI8TGWAxqVt3x3BVzOv3Pb+rGr+0KPghz36i8=\", \n            \"FunctionName\": \"sns-message-20160620\", \n            \"MemorySize\": 128, \n            \"CodeSize\": 380, \n            \"FunctionArn\": \"arn:aws:lambda:us-west-2:xxxxxxxxxxxx:function:sns-message-20160620\", \n            \"Handler\": \"sns-message-20160620.lambda_handler\", \n            \"Role\": \"arn:aws:iam::xxxxxxxxxxxx:role/lambdaBasicExecution\", \n            \"Timeout\": 3, \n            \"LastModified\": \"2016-06-19T15:10:47.747+0000\", \n            \"Runtime\": \"python2.7\", \n            \"Description\": \"An Amazon SNS trigger that logs the message pushed to the SNS topic.\"\n        }\n    ]\n}\n```\n\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws lambda get-function \\\n  --function-name ${LAMBDA_FUNC_NAME}\n```\n\n```json:\u7d50\u679c(\u4f8b):\n{\n    \"Code\": {\n        \"RepositoryType\": \"S3\", \n        \"Location\": \"https://awslambda-us-west-2-tasks.s3-us-west-2.amazonaws.com/snapshots/xxxxxxxxxxxx/sns-message-20160620-94f6e8eb-ee3b-4c00-8c8a-954642396e71?x-amz-security-token=FQoDYXdzEO%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaDEruHidCLdnnzUDGQyK0A4dUQtu%2B4zoY%2FrVVjjQEHA3PZ4wZmeokZ4wNGVvL6Gl05QSctL4dRe79VgjBK%2BtYIUm1p6HgzxlWcrpV%2BhNgZsxsCqinRcBg79210XdopPa0wlPbswNIhqsHMyJS0Gs4x6eiKKJ9Gq2vMsiPoPKN8yKECvkDhCcSRs2wxCZrDybDutmqWKZowrNABgM4hzJGNz9xAh4dxN4Pr8fh%2F185glbq2iusjf3JP9gRIQKlT%2Bn9Xry1Jvj4qE0bl0iptY%2BRb%2FrzxTiz393p%2BYC0MJ63FR85T8GYtlhXzqAntufp4bxbkAKJFSsvEiO0LqssF%2Fse8aMTeIaPOfKOhOelT49HrbM0WLuRu7DBU416etC1AjkNCKMdPBPc9x%2FrCEcJKVfy5uENqrM8bKEFAdGMBMwFyUSHHnklsMTY8GSJtisBQIUVHNVTE5jbELx5kH9SaTolRfyTTVWLBn4Amlcobjhf1adlW58BmGa5Jge%2Bm1SzuvocaMRZQms%2BN6lNv9dLEgqT%2BlvVObkEqBk8m0O0ZLZat61SNoR81ymItLyuhmyg1QNbkOqpATQCg0wXg3WReKGqWUR1%2FckoucyauwU%3D&AWSAccessKeyId=ASIAJHC2NNIWC2M5YV3Q&Expires=1466349693&Signature=a%2FeD%2F%2FLuqd9HX23v4uDDAMMcuzQ%3D\"\n    }, \n    \"Configuration\": {\n        \"Version\": \"$LATEST\", \n        \"CodeSha256\": \"y8yjqcUI8TGWAxqVt3x3BVzOv3Pb+rGr+0KPghz36i8=\", \n        \"FunctionName\": \"sns-message-20160620\", \n        \"MemorySize\": 128, \n        \"CodeSize\": 380, \n        \"FunctionArn\": \"arn:aws:lambda:us-west-2:xxxxxxxxxxxx:function:sns-message-20160620\", \n        \"Handler\": \"sns-message-20160620.lambda_handler\", \n        \"Role\": \"arn:aws:iam::xxxxxxxxxxxx:role/lambdaBasicExecution\", \n        \"Timeout\": 3, \n        \"LastModified\": \"2016-06-19T15:10:47.747+0000\", \n        \"Runtime\": \"python2.7\", \n        \"Description\": \"An Amazon SNS trigger that logs the message pushed to the SNS topic.\"\n    }\n}\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws lambda get-function-configuration \\\n  --function-name ${LAMBDA_FUNC_NAME}\n```\n\n```json:\u7d50\u679c(\u4f8b):\n{\n    \"CodeSha256\": \"y8yjqcUI8TGWAxqVt3x3BVzOv3Pb+rGr+0KPghz36i8=\", \n    \"FunctionName\": \"sns-message-20160620\", \n    \"CodeSize\": 380, \n    \"MemorySize\": 128, \n    \"FunctionArn\": \"arn:aws:lambda:us-west-2:xxxxxxxxxxxx:function:sns-message-20160620\", \n    \"Version\": \"$LATEST\", \n    \"Role\": \"arn:aws:iam::xxxxxxxxxxxx:role/lambdaBasicExecution\", \n    \"Timeout\": 3, \n    \"LastModified\": \"2016-06-19T15:10:47.747+0000\", \n    \"Handler\": \"sns-message-20160620.lambda_handler\", \n    \"Runtime\": \"python2.7\", \n    \"Description\": \"An Amazon SNS trigger that logs the message pushed to the SNS topic.\"\n}\n```\n\n\n3. Lambda\u95a2\u6570\u306e\u52d5\u4f5c\u78ba\u8a8d\n=======================\n\n\n3.1. \u30b5\u30f3\u30d7\u30eb\u30c7\u30fc\u30bf\u306e\u4f5c\u6210\n-------------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nFILE_INPUT=\"${LAMBDA_FUNC_NAME}-data.json\" \\\n    && echo ${FILE_INPUT}\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\ncat << EOF > ${FILE_INPUT}\n{\n  \"Records\": [\n    {\n      \"EventVersion\": \"1.0\",\n      \"EventSubscriptionArn\": \"arn:aws:sns:EXAMPLE\",\n      \"EventSource\": \"aws:sns\",\n      \"Sns\": {\n        \"SignatureVersion\": \"1\",\n        \"Timestamp\": \"1970-01-01T00:00:00.000Z\",\n        \"Signature\": \"EXAMPLE\",\n        \"SigningCertUrl\": \"EXAMPLE\",\n        \"MessageId\": \"95df01b4-ee98-5cb9-9903-4c221d41eb5e\",\n        \"Message\": \"Hello from SNS!\",\n        \"MessageAttributes\": {\n          \"Test\": {\n            \"Type\": \"String\",\n            \"Value\": \"TestString\"\n          },\n          \"TestBinary\": {\n            \"Type\": \"Binary\",\n            \"Value\": \"TestBinary\"\n          }\n        },\n        \"Type\": \"Notification\",\n        \"UnsubscribeUrl\": \"EXAMPLE\",\n        \"TopicArn\": \"${SNS_TOPIC_NAME}\",\n        \"Subject\": \"TestInvoke\"\n      }\n    }\n  ]\n}\nEOF\n\ncat ${FILE_INPUT}\n```\n\nJSON\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u305f\u3089\u3001\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u304c\u58ca\u308c\u3066\u306a\u3044\u304b\u5fc5\u305a\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9:\njsonlint -q ${FILE_INPUT}\n```\n\n\u30a8\u30e9\u30fc\u304c\u51fa\u529b\u3055\u308c\u306a\u3051\u308c\u3070OK\u3067\u3059\u3002\n\n\n3.2. lambda\u95a2\u6570\u306e\u624b\u52d5\u5b9f\u884c\n-------------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nFILE_OUTPUT_LAMBDA=\"${LAMBDA_FUNC_NAME}-out.txt\"\nFILE_LOG_LAMBDA=\"${LAMBDA_FUNC_NAME}-$(date +%Y%m%d%H%M%S).log\"\n```\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d:\ncat << ETX\n\n  LAMBDA_FUNC_NAME:   ${LAMBDA_FUNC_NAME}\n  FILE_INPUT:         ${FILE_INPUT}\n  FILE_OUTPUT_LAMBDA: ${FILE_OUTPUT_LAMBDA}\n  FILE_LOG_LAMBDA:    ${FILE_LOG_LAMBDA}\n\nETX\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws lambda invoke \\\n  --function-name ${LAMBDA_FUNC_NAME} \\\n  --log-type Tail \\\n  --payload file://${FILE_INPUT} \\\n  ${FILE_OUTPUT_LAMBDA} \\\n  > ${FILE_LOG_LAMBDA}\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\ncat ${FILE_LOG_LAMBDA} \\\n  | jp.py 'StatusCode'\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      200\n```\n\n\n3.3. lambda\u95a2\u6570\u306e\u5b9f\u884c\u7d50\u679c\u306e\u78ba\u8a8d\n-------------------------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\ncat ${FILE_OUTPUT_LAMBDA}\n```\n\n```text:\u7d50\u679c(\u4f8b):\n1970-01-01T00:00:00Z\n```\n\n\n3.4. lambda\u95a2\u6570\u306e\u30ed\u30b0\u306e\u78ba\u8a8d\n---------------------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\ncat ${FILE_LOG_LAMBDA} \\\n  | jp.py 'LogResult' \\\n  | sed 's/\"//g' \\\n  | base64 --decode\n```\n\n```text:\u7d50\u679c(\u4f8b):\n\n```\n\n\n4. permission\u306e\u8ffd\u52a0\n======================\n\n\n4.1. Lambda\u5b9f\u884c\u6a29\u9650\u306e\u4ed8\u4e0e\n---------------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a\nLAMBDA_STAT_ID='AllowSNS'\nLAMBDA_PERMIT_ACTION='lambda:InvokeFunction'\nLAMBDA_PERMIT_PRINCIPAL='sns.amazonaws.com'\n```\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n  LAMBDA_FUNC_NAME:        ${LAMBDA_FUNC_NAME}\n  LAMBDA_STAT_ID:         \"${LAMBDA_STAT_ID}\"\n  LAMBDA_PERMIT_ACTION:    ${LAMBDA_PERMIT_ACTION}\n  LAMBDA_PERMIT_PRINCIPAL: ${LAMBDA_PERMIT_PRINCIPAL}\n\nETX\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws lambda add-permission \\\n  --function-name ${LAMBDA_FUNC_NAME} \\\n  --statement-id \"${LAMBDA_STAT_ID}\" \\\n  --action ${LAMBDA_PERMIT_ACTION} \\\n  --principal ${LAMBDA_PERMIT_PRINCIPAL}\n```\n\n```json:\u7d50\u679c(\u4f8b)\n{\n    \"Statement\": \"{\\\"Action\\\":[\\\"lambda:InvokeFunction\\\"],\\\"Resource\\\":\\\"arn:aws:lambda:us-west-2:xxxxxxxxxxxx:function:sns-message-20160620\\\",\\\"Effect\\\":\\\"Allow\\\",\\\"Principal\\\":{\\\"Service\\\":\\\"sns.amazonaws.com\\\"},\\\"Sid\\\":\\\"AllowSNS\\\"}\"\n}\n```\n\n\n\u5b8c\u4e86\n====\n"}