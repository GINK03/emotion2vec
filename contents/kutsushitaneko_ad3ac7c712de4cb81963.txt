{"context": " More than 1 year has passed since last update.\u73fe\u6642\u70b9\uff081.8.4\uff09\u3067\u306f\u3001Ansible\u306fControl Machine\u3068\u3057\u3066Windows\u3092\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u3044\u306a\u3044\u304c\u3001\u30d6\u30ed\u30b0Running Vagrant with Ansible Provisioning on Windows\u7b49\u3092\u53c2\u8003\u306b\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u3066\u307f\u305f\u306e\u3067\u624b\u9806\u3092\u307e\u3068\u3081\u3066\u304a\u304f\u3002\n\u524d\u534a\u306f\u7d14\u7c8b\u306bWindows(Cygwin)\u3067Ansible\u3092\u4f7f\u3046\u8a2d\u5b9a\u306b\u306a\u3063\u3066\u3044\u3066Vagrant\u3068\u306f\u7121\u95a2\u4fc2\u306b\u4f7f\u7528\u3067\u304d\u308b\u3002\n\u306a\u304a\u3001\u672b\u5c3e\u306e\u56de\u907f\u7b56\u306b\u8a18\u8f09\u3057\u3066\u3044\u308b\u304c\u672a\u89e3\u6c7a\u306e\u554f\u984c\uff08\u79d8\u5bc6\u9375\u306e\u30d1\u30fc\u30df\u30b7\u30e7\u30f3\u304c\u7de9\u904e\u304e\u308b\u3068\u8a00\u308f\u308c\u3066\u8e74\u3089\u308c\u3066\u3057\u307e\u3046\uff09\u304c\u3042\u308a\u3001\u4e00\u90e8\u5f37\u5f15\u306bAnsible\u306e\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3092\u66f8\u304d\u63db\u3048\u3066\u56de\u907f\u3057\u3066\u3044\u308b\u3002\n\n\u74b0\u5883\n\nWindows 8.1 Pro\nCygwin\nVagrant 1.7.2\nAnsible 1.8.4\n\n\nCygwin\u306e\u74b0\u5883\u3092\u6574\u3048\u308b\nCygwin\u306e\u4e0b\u8a18\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u8ffd\u52a0\u3059\u308b\uff08\u901a\u5e38\u306eCygwin Setup\u3092\u4f7f\u7528\uff09\u3002\n\npython\npython-paramiko\npython-crypto\npython-setuptools\ngcc-core\ngcc-g++\nmake\nwget\nopenssh\nlibyaml-devel\n\n\npip\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\nAnsible\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u305f\u3081\u306bpip\uff08Python\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u7ba1\u7406\u30b7\u30b9\u30c6\u30e0\uff09\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\uff08\u672c\u4f5c\u696d\u6642\u70b9\u3067\u306f\u3001Cygwin\u306ePython\u306f\u30012.7.8\u3067\u3042\u3063\u305f\u305f\u3081pip\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\u4ed8\u5c5e\u3057\u3066\u3044\u306a\u3044\u305f\u3081\uff09\u3002\n$ python /usr/lib/python2.7/site-packages/easy_install.py pip\n...\n...\nInstalled /usr/lib/python2.7/site-packages/pip-6.0.8-py2.7.egg\nProcessing dependencies for pip\nFinished processing dependencies for pip\n\n\nAnsible\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\n$ pip install ansible\nCollecting ansible\n  Downloading ansible-1.9.0.1.tar.gz (916kB)\n...\n...\nSuccessfully installed PyYAML-3.11 ansible-1.9.0.1 ecdsa-0.13 jinja2-2.7.3 markupsafe-0.23\n\n\u306a\u304a\u3001\nCommand \"python setup.py egg_info\" failed with error code 1\n\u304c\u51fa\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3067\u304d\u306a\u3044\u3068\u304d\u306fsetuptools\u3092upgrade\u3057\u307e\u3059\u3002\n$ pip install --upgrade setuptools\n\nAnsible\u5358\u4f53\u306e\u52d5\u4f5c\u78ba\u8a8d\u306e\u6e96\u5099\n\u3053\u3053\u3067\u3001Vagrant\u306eProvisioner\u3068\u3057\u3066\u306eAnsible\u3092\u52d5\u4f5c\u3055\u305b\u308b\u524d\u306bAnsible\u5358\u4f53\u306e\u52d5\u4f5c\u78ba\u8a8d\u3092\u3059\u308b\u3002\n\nManaged Node\u3092\u7528\u610f\u3059\u308b\nManaged Node\uff08Ansible\u3067\u64cd\u4f5c\u3055\u308c\u308b\u5074\u306e\u30b5\u30fc\u30d0\uff09\u3068\u3057\u3066\u3001\u9069\u5f53\u306a\u4eee\u60f3\u30de\u30b7\u30f3\u3092vagrant up\u3057\u3066\u304a\u304f\u7b49\u3057\u3066\u3001IP Address\u3092\u63a7\u3048\u3066\u304a\u304f\uff08\u4ee5\u4e0b\u3067\u306f\u4eee\u306b192.168.30.11\u3068192.168.30.12\u306e2\u30ce\u30fc\u30c9\u3068\u3059\u308b\uff09\u3002\n\ninventory\u30d5\u30a1\u30a4\u30eb\u3092\u7528\u610f\u3059\u308b\nmkdir /etc/ansible\nchmod 755 /etc/ansible\n\n\n/etc/ansible/hosts\n192.168.30.11\n192.168.30.12\n\n\n\nssh\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n\n\u9375\u30da\u30a2\u3092\u4f5c\u6210\u3059\u308b\u3002\n$ ssh-keygen\nGenerating public/private rsa key pair.\nEnter file in which to save the key (/home/XXXX/.ssh/id_rsa):\nEnter passphrase (empty for no passphrase):\nEnter same passphrase again:\nYour identification has been saved in /home/XXXX/.ssh/id_rsa.\nYour public key has been saved in /home/XXXX/.ssh/id_rsa.pub.\nThe key fingerprint is:\n\n\nManaged Node\u306bssh\u3067\u4f7f\u7528\u3059\u308b\u30db\u30b9\u30c8\u540d\u3092\u4ed8\u3051\u308b\uff08\u30aa\u30d7\u30b7\u30e7\u30f3\uff09\n\n~/.ssh/config\nHost node01\n  HostName 192.168.30.11\nHost node02\n  HostName 192.168.30.12\n\n\n\u3053\u306e\u8a2d\u5b9a\u3092\u3057\u305f\u5834\u5408\u306f inventory\u30d5\u30a1\u30a4\u30eb\u306f\u4e0b\u8a18\u3067\u3082\u826f\u3044\u3002\n\n/etc/ansible/hosts\nnode01\nnode02\n\n\n\n\u516c\u958b\u9375\u3092Managed Node\u306b\u914d\u5e03\u3059\u308b\n$ ssh-copy-id vagrant@node01`\n/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed\n/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys\nvagrant@192.168.30.11's password:\n\nNumber of key(s) added: 1\n\nNow try logging into the machine, with:   \"ssh 'vagrant@node01'\"\nand check to make sure that only the key(s) you wanted were added.\n\n$ ssh-copy-id vagrant@node02\n/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed\n/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys\nvagrant@192.168.30.11's password:\n\nNumber of key(s) added: 1\n\nNow try logging into the machine, with:   \"ssh 'vagrant@node02'\"\nand check to make sure that only the key(s) you wanted were added.\n\n\u3053\u3053\u3067\u3001@\u306e\u524d\u306e\"vagrant\"\u306f\u3001node01,node02\u3078\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u30e6\u30fc\u30b6\u30fc\u540d\u3002\n\nControlMaster\u306e\u8a2d\u5b9a\nansible\u3067\u306f\u3001ssh\u306econtrol master\u3068\u306e\u901a\u4fe1\u306b\u554f\u984c\u304c\u3042\u308b\u3089\u3057\u304f\u4e0b\u8a18\u306e\u4fee\u6b63\u304c\u5fc5\u8981\u3060\u3063\u305f\u3002\n\n/etc/ansible/ansible.cfg\n[ssh_connection]\nssh_args = -o ControlMaster=auto -o ControlPersist=60s\ncontrol_path = /tmp\n\n\n\u3061\u306a\u307f\u306b\u3001\u3053\u306e\u8a2d\u5b9a\u3092\u3057\u306a\u3044\u3068\nfatal: [node01] => SSH Error: Failed to connect to new control master\n    while connecting to 192.168.30.11:22\n\n\u3068\u306a\u308b\u3002\n\nssh\u306e\u8a8d\u8a3c\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u3092\u8d77\u52d5\u3059\u308b\n\u30d1\u30b9\u30d5\u30ec\u30fc\u30ba\u306e\u5165\u529b\u3092\u7701\u7565\u3059\u308b\u305f\u3081\u8a8d\u8a3c\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u3092\u4f7f\u3046\u3002\n$ eval `ssh-agent`\nAgent pid 9148\n\n\uff08ssh-agent\u306f\u3001\u30d0\u30c3\u30af\u30af\u30aa\u30fc\u30c8\u3067\u56f2\u3080\uff09\n\u3061\u306a\u307f\u306b\u3001\u8a8d\u8a3c\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u3092\u4f7f\u308f\u306a\u3044\u3068\u30d1\u30b9\u30d5\u30ec\u30fc\u30ba\u3092\u4f55\u5ea6\u3082\u5165\u529b\u3057\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u3060\u3051\u3067\u306a\u304f\u3001\u8907\u6570\u30ce\u30fc\u30c9\u3078\u306essh\u63a5\u7d9a\u8981\u6c42\u3092\u5e73\u884c\u3057\u3066\u51e6\u7406\u3059\u308b\u305f\u3081\u30d1\u30b9\u30d5\u30ec\u30fc\u30ba\u306e\u5165\u529b\u8981\u6c42\u304c\u5165\u308a\u4e71\u308c\u3046\u307e\u304f\u5165\u529b\u3067\u304d\u306a\u3044\u3002\u305d\u306e\u5834\u5408\u306f\u3001ansible-playbook\u8d77\u52d5\u6642\u306b -f 1 \u3092\u4ed8\u3051\u3066\u4e00\u5ea6\u306b1\u30ce\u30fc\u30c9\u3065\u3064\u51e6\u7406\u3059\u308b\u3088\u3046\u306b\u3059\u308c\u3070\u30d1\u30b9\u30d5\u30ec\u30fc\u30ba\u306e\u5165\u529b\u304c\u53ef\u80fd\u3068\u306a\u308b\u3002\n\n\u8a8d\u8a3c\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u306b\u79d8\u5bc6\u9375\u3092\u8a18\u61b6\u3055\u305b\u308b\n$ ssh-add .ssh/id_rsa\nEnter passphrase for .ssh/id_rsa:\nIdentity added: .ssh/id_rsa (.ssh/id_rsa)\n\n\nAnsible\u5358\u4f53\u306e\u52d5\u4f5c\u78ba\u8a8d\n\nAd-hoc\u30b3\u30de\u30f3\u30c9\nAd-hoc\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u3066Ansible\u304c\u5358\u4f53\u3067\u52d5\u4f5c\u3059\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u3002\n2\u3064\u306eManaged Node\u4e21\u65b9\u304b\u3089 /etc/redhat-release\u3092\u53d6\u3063\u3066\u304f\u308bAd-hoc\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u3066\u307f\u308b\u3002\n$ ansible all -a \"cat /etc/redhat-release\" -u vagrant\n192.168.30.12 | success | rc=0 >>\nCentOS Linux release 7.1.1503 (Core)\n\n192.168.30.11 | success | rc=0 >>\nCentOS Linux release 7.1.1503 (Core)\n\n\u7121\u4e8b\u6210\u529f\u3002\n\nPlaybook\n\u7c21\u5358\u306aPlaybook\u306e\u52d5\u4f5c\u3082\u78ba\u8a8d\u3057\u3066\u304a\u304f\u3002\n2\u3064\u306e\u30ce\u30fc\u30c9\u4e21\u65b9\u306b\"kuroneko\"\u3068\u3044\u3046\u30e6\u30fc\u30b6\u30fc\u3092\u767b\u9332\u3059\u308bPlaybook\u3092\u7528\u610f\u3059\u308b\u3002\n$ cat <<EOF > add_user.yml\n> - hosts: all\n>   sudo: yes\n>   remote_user: vagrant\n>   vars:\n>     username: kuroneko\n>   tasks:\n>     - name: add user\n>       user: name={{ username }} group=wheel shell=/usr/bin/bash\n> EOF\n\nansible-playbook\u3092\u5b9f\u884c\u3057\u3066\u307f\u308b\u3002\n$ ansible-playbook add_user.yml\n\nPLAY [all] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [192.168.30.11]\nok: [192.168.30.12]\n\nTASK: [add user] **************************************************************\nchanged: [192.168.30.11]\nchanged: [192.168.30.12]\n\nPLAY RECAP ********************************************************************\n192.168.30.11              : ok=2    changed=1    unreachable=0    failed=0\n192.168.30.12              : ok=2    changed=1    unreachable=0    failed=0\n\n\u7121\u4e8b\u6210\u529f\u3002\u5ff5\u306e\u305f\u3081\u3001kuroneko\u304c\u4f5c\u6210\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3002\n$ ansible all -a \"grep kuroneko /etc/passwd\" -u vagrant\n192.168.30.12 | success | rc=0 >>\nkuroneko:x:1002:10::/home/kuroneko:/usr/bin/bash\n\n192.168.30.11 | success | rc=0 >>\nkuroneko:x:1002:10::/home/kuroneko:/usr/bin/bash\n\n\u30e6\u30fc\u30b6\u30fc\"kuroneko\"\u304c\u78ba\u304b\u306b\u8ffd\u52a0\u3055\u308c\u3066\u3044\u3066\u3001playbook\u304c\u6b63\u5e38\u306b\u5b9f\u884c\u3055\u308c\u305f\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u305f\u3002\n\nansible-playbook\u3092vagrant\u304b\u3089\u547c\u3073\u51fa\u305b\u308b\u3088\u3046\u306b\u8a2d\u5b9a\n\nansible-playbook.bat\u30d5\u30a1\u30a4\u30eb\u3092\u7528\u610f\u3059\u308b\nVagrant\u304b\u3089ansible-playbook\u3092vagrant\u304b\u3089\u547c\u3073\u51fa\u3059\u305f\u3081\u306b\u306f\n\nWindows PATH\u306e\u4e2d\u306b ansible-player\u3092\u914d\u7f6e\u3059\u308b\nansible-player\u304cCygwin\u306ePaython\u3092\u4f7f\u7528\u3067\u304d\u308b\n\n\u3053\u3068\u304c\u5fc5\u8981\u3002\n\u305d\u3053\u3067\u3001\u4e0b\u8a18\u306ebat\u30d5\u30a1\u30a4\u30eb\u3092C:\\HashiCorp\\Vagrant\\bin\u306b\u914d\u7f6e\u3002\n\nansible-playbook.bat\n@echo off\n\nset CYGWIN=C:\\cygwin64\n\nset SH=%CYGWIN%\\bin\\bash.exe\n\n\"%SH%\" -c \"/bin/ansible-playbook %*\"\n\n\n\u3053\u3053\u3067\u3001CYGWIN=C:\\cygwin64\u306f\u3001Cygwin\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3067\u3059\u3002\u5b9f\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\u304f\u3060\u3055\u3044\u3002\u307e\u305f\u3001bat\u30d5\u30a1\u30a4\u30eb\u3092\u914d\u7f6e\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306f\u3001C:\\HashiCorp\\Vagrant\\bin\u3067\u3042\u308b\u5fc5\u8981\u306f\u3042\u308a\u307e\u305b\u3093\u3002Windows\u306ePATH\u304c\u901a\u3063\u3066\u3044\u308b\u5834\u6240\u306b\u914d\u7f6e\u3057\u307e\u3059\u3002\nansible-playbook.bat\u306e\u52d5\u4f5c\u78ba\u8a8d\u3092\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\nansible-playbook.bat\u52d5\u4f5c\u78ba\u8a8d\n$ ansible-playbook.bat add_user.yml\n\nPLAY [all] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [node01]\nok: [node02]\n\nTASK: [add user] **************************************************************\nok: [node01]\nok: [node02]\n\nPLAY RECAP ********************************************************************\nnode01                     : ok=2    changed=0    unreachable=0    failed=0\nnode02                     : ok=2    changed=0    unreachable=0    failed=0\n\n\nbat\u30d5\u30a1\u30a4\u30eb\u304b\u3089ansible-playbook\u304c\u547c\u3073\u51fa\u3055\u308c\u3066\u3001\u7121\u4e8badd_user.yml\u304c\u5b9f\u884c\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\nVagrant\u306eProvisioner\u3068\u3057\u3066\u306eAnsible\u306e\u52d5\u4f5c\u78ba\u8a8d\n\nVasgrantfile\u306e\u7528\u610f\n2\u3064\u306eCentOS 7 (1503)\u306e\u4eee\u60f3\u30b5\u30fc\u30d0\u3092\u4f5c\u6210\u3057\u3066\u3001Apache\u3092provisioning\u3059\u308bVagrantfile\u3092\u7528\u610f\u3002\n\nVagrantfile\nVagrant.configure(2) do |config|\n\n  if Vagrant.has_plugin?(\"vagrant-cachier\")\n    config.cache.scope = :box\n  end\n  if Vagrant.has_plugin?(\"vagrant-vbguest\")\n    config.vbguest.auto_update = false\n  end\n  config.vm.define \"web02\" do |web|\n    web.vm.box = \"centos7-1503-01-min\"\n    web.vm.hostname = \"web02\"\n    web.vm.network \"private_network\", ip: \"192.168.40.12\"\n    web.vm.provision \"shell\",\n      inline: \"nmcli connection reload;systemctl restart network.service\"\n    web.vm.provision \"ansible\" do |ansible|\n      ansible.playbook = \"ensure-apache-latest.yml\"\n    end\n  end\n  config.vm.define \"web01\" do |web|\n    web.vm.box = \"centos7-1503-01-min\"\n    web.vm.hostname = \"web01\"\n    web.vm.network \"private_network\", ip: \"192.168.40.11\"\n    web.vm.provision \"shell\",\n      inline: \"nmcli connection reload;systemctl restart network.service\"\n    web.vm.provision \"ansible\" do |ansible|\n      ansible.playbook = \"ensure-apache-latest.yml\"\n    end\n  end\n\nend\n\n\n\u547c\u3073\u51fa\u3055\u308c\u3066\u3044\u308bPlaybook\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3002\n\nensure-apache-latest.yml\n- hosts: all\n  sudo: yes\n  remote_user: vagrant\n  tasks:\n    - name: ensure apache is at the latest version\n      yum: pkg=httpd state=latest\n      notify:\n      - stop firewalld\n      - restart httpd\n  handlers:\n    - name: stop firewalld\n      service: name=firewalld state=stopped enabled=no\n    - name: restart httpd\n      service: name=httpd state=restarted enabled=yes\n\n\n\n\u52d5\u4f5c\u78ba\u8a8d\uff08\u5931\u6557\uff09\n\u4e0a\u8a18\u306eVagrantfile\u3067\u3001vagrant up\u3059\u308b\u3068\u4e0b\u8a18\u306e\u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u8868\u793a\u3055\u308c\u3001Playbook\u3092\u8d77\u52d5\u3067\u304d\u306a\u3044\u3002\n\nansible\u306e\u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\nfatal: [web01] => private_key_file (D:/Vagrant/projects/ansible-windows/.vagrant/machines/web01/virtualbox/private_key) is group-readable or world-readable and thus insecure - you will probably get an SSH failure\n\n\n\u79d8\u5bc6\u9375\u30d5\u30a1\u30a4\u30eb\u306e\u30d1\u30fc\u30df\u30b7\u30e7\u30f3\u304c\u5bdb\u5bb9\u904e\u304e\u308b\u3068\u3044\u3046\u3053\u3068\u306e\u3088\u3046\u3060\u304c\u3001chmod 600\u3057\u305f\u308a setfacl\u3067acl\u3092\u53b3\u3057\u304f\u3057\u3066\u3082\u89e3\u6c7a\u3067\u304d\u306a\u304b\u3063\u305f\u3002\n\u672c\u8a18\u4e8b\u306e\u4e0a\u306e\u65b9\u3067 ~/.ssh/id_rsa\u3092\u4f7f\u3063\u3066\u3001Playbook\u306e\u52d5\u4f5c\u78ba\u8a8d\u3092\u3057\u3066\u3044\u308b\u306e\u3067\u3001\u3053\u306e\u30d5\u30a1\u30a4\u30eb\u3068\u540c\u3058\u30d1\u30fc\u30df\u30b7\u30e7\u30f3\u3092\u8a2d\u5b9a\u3057\u305f\u308a getfacl ~/.ssh/id_rsa | setfacl -f - private_key \u7b49\u3092\u8a66\u3057\u3066\u307f\u305f\u304c\u306a\u305c\u304b\u89e3\u6c7a\u3067\u304d\u306a\u304b\u3063\u305f\u3002stat private_key\u7b49\u3057\u3066\u307f\u3066\u3082\u304a\u304b\u3057\u306a\u3068\u3053\u308d\u306f\u306a\u3044\u3088\u3046\u306b\u898b\u3048\u308b\u3002Cygwin\u3068Windows\u306e\u30d1\u30fc\u30df\u30b7\u30e7\u30f3\u95a2\u4fc2\u3067\u4f55\u304b\u898b\u9003\u3057\u3066\u3044\u305d\u3046\u3060\u304c\u308f\u304b\u3089\u306a\u3044\u3002\u305d\u3053\u3067\u3001\u6b21\u306e\u56de\u907f\u7b56\u3092\u5f37\u884c\u3057\u305f\u3002\n\n\u56de\u907f\u7b56\n\u4e0a\u306e\u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\u306f\u3001/usr/lib/python2.7/site-packages/ansible/runner/connection.py\u304b\u3089\u51fa\u529b\u3055\u308c\u3066\u3044\u308b\u3002\n\nconnection.py\u629c\u7c8b\nif st is not None and st.st_mode & (stat.S_IRGRP | stat.S_IROTH):\n  raise AnsibleError(\"private_key_file (%s) is group-readable or world-readable and thus insecure - \"\n    \"you will probably get an SSH failure\"\n    % (private_key_file,))\n\n\n\u8a66\u9a13\u7684\u306b\u3053\u306e\u90e8\u5206\u3092#\u3067\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3057\u3066\u3001vagrant destroy;vagrant up\u3057\u305f\u3068\u3053\u308d\u7121\u4e8b\u3001provisioning\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u305f\u3002\n\n\u5b9f\u884c\u30ed\u30b0\u306e\u629c\u7c8b\n$ vagrant up\nBringing machine 'web02' up with 'virtualbox' provider...\nBringing machine 'web01' up with 'virtualbox' provider...\n...\n...\n...\n==> web02: Running provisioner: ansible...\n...\n...\n...\nPLAY [all] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [web02]\n\nTASK: [ensure apache is at the latest version] ********************************\nchanged: [web02]\n\nNOTIFIED: [stop firewalld] ****************************************************\nchanged: [web02]\n\nNOTIFIED: [restart httpd] *****************************************************\nchanged: [web02]\n\nPLAY RECAP ********************************************************************\nweb02                      : ok=4    changed=3    unreachable=0    failed=0\n==> web02: Configuring cache buckets...\n==> web01: Importing base box 'centos7-1503-01-min'...\n...\n...\n...\n==> web01: Running provisioner: ansible...\n...\n...\n...\nPLAY [all] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [web01]\n\nTASK: [ensure apache is at the latest version] ********************************\nchanged: [web01]\n\nNOTIFIED: [stop firewalld] ****************************************************\nchanged: [web01]\n\nNOTIFIED: [restart httpd] *****************************************************\nchanged: [web01]\n\nPLAY RECAP ********************************************************************\nweb01                      : ok=4    changed=3    unreachable=0    failed=0\n==> web01: Configuring cache buckets...\n\n\n\n\u4f59\u8ac7\n\u4e0a\u306eVagrantfile\u306eansible playbook\u306e\u547c\u3073\u51fa\u3057\u65b9\u3060\u3068\u3001\u4eee\u60f3\u30b5\u30fc\u30d0\u4f5c\u3063\u3066\u3001\u30d7\u30ed\u30d3\u30b8\u30e7\u30f3\u3057\u3066\u3001\u4eee\u60f3\u30b5\u30fc\u30d0\u4f5c\u3063\u3066\u3001\u30d7\u30ed\u30d3\u30b8\u30e7\u30f3\u3057\u3066\u3092\u305f\u3060\u3072\u305f\u3059\u3089\u30b7\u30fc\u30b1\u30f3\u30b7\u30e3\u30eb\u306b\u5b9f\u884c\u3059\u308b\u3060\u3051\u3067\u3064\u307e\u3089\u306a\u3044\u3002Vagrant\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306eAnsible\u306eTIPS AND TRICS\u306b\"ANSIBLE PARALLEL EXECUTION\"\u3068\u3044\u3046\u8a18\u8f09\u304c\u3042\u308b\u3002\u3053\u308c\u3092\u307e\u306d\u3066\u4e0b\u8a18\u306eVagrantfile\u3067\u3001provisioning\u306e\u4e26\u5217\u5b9f\u884c\u3092\u3084\u3063\u3066\u307f\u305f\u3002\n\nVagrantfile\nVagrant.configure(2) do |config|\n\n  if Vagrant.has_plugin?(\"vagrant-cachier\")\n    config.cache.scope = :box\n  end\n  if Vagrant.has_plugin?(\"vagrant-vbguest\")\n    config.vbguest.auto_update = false\n  end\n  config.ssh.insert_key = false\n  config.vm.define \"web02\" do |web|\n    web.vm.box = \"centos7-1503-01-min\"\n    web.vm.hostname = \"web02\"\n    web.vm.network \"private_network\", ip: \"192.168.40.12\"\n    web.vm.provision \"shell\",\n      inline: \"nmcli connection reload;systemctl restart network.service\"\n  end\n  config.vm.define \"web01\" do |web|\n    web.vm.box = \"centos7-1503-01-min\"\n    web.vm.hostname = \"web01\"\n    web.vm.network \"private_network\", ip: \"192.168.40.11\"\n    web.vm.provision \"shell\",\n      inline: \"nmcli connection reload;systemctl restart network.service\"\n    web.vm.provision \"ansible\" do |ansible|\n      ansible.playbook = \"ensure-apache-latest.yml\"\n      ansible.limit = 'all'\n    end\n  end\n\nend\n\n\n\u3059\u3079\u3066\u306e\u4eee\u60f3\u30b5\u30fc\u30d0\u3078\u3072\u3068\u3064\u306e\u79d8\u5bc6\u9375\u3067ssh\u3059\u308b\u305f\u3081config.ssh.insert_key = false\u3092\u5fd8\u308c\u308b\u30681\u53f0\u3092\u9664\u3044\u3066provisioning\u306b\u5931\u6557\u3059\u308b\u306e\u3067\u6ce8\u610f\u3002\n\u5f8c\u3067legacy insecure key\u3092\u5165\u308c\u66ff\u3048\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u304c\u3001\u4f7f\u3048\u305d\u3046\u3060\u3002\n\u73fe\u6642\u70b9\uff081.8.4\uff09\u3067\u306f\u3001Ansible\u306fControl Machine\u3068\u3057\u3066Windows\u3092\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u3044\u306a\u3044\u304c\u3001\u30d6\u30ed\u30b0[Running Vagrant with Ansible Provisioning on Windows](http://www.azavea.com/blogs/labs/2014/10/running-vagrant-with-ansible-provisioning-on-windows/)\u7b49\u3092\u53c2\u8003\u306b\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u3066\u307f\u305f\u306e\u3067\u624b\u9806\u3092\u307e\u3068\u3081\u3066\u304a\u304f\u3002\n\n\u524d\u534a\u306f\u7d14\u7c8b\u306bWindows(Cygwin)\u3067Ansible\u3092\u4f7f\u3046\u8a2d\u5b9a\u306b\u306a\u3063\u3066\u3044\u3066Vagrant\u3068\u306f\u7121\u95a2\u4fc2\u306b\u4f7f\u7528\u3067\u304d\u308b\u3002\n\n\u306a\u304a\u3001\u672b\u5c3e\u306e\u56de\u907f\u7b56\u306b\u8a18\u8f09\u3057\u3066\u3044\u308b\u304c\u672a\u89e3\u6c7a\u306e\u554f\u984c\uff08\u79d8\u5bc6\u9375\u306e\u30d1\u30fc\u30df\u30b7\u30e7\u30f3\u304c\u7de9\u904e\u304e\u308b\u3068\u8a00\u308f\u308c\u3066\u8e74\u3089\u308c\u3066\u3057\u307e\u3046\uff09\u304c\u3042\u308a\u3001\u4e00\u90e8\u5f37\u5f15\u306bAnsible\u306e\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3092\u66f8\u304d\u63db\u3048\u3066\u56de\u907f\u3057\u3066\u3044\u308b\u3002\n\n#\u74b0\u5883\n* Windows 8.1 Pro\n* Cygwin\n* Vagrant 1.7.2\n* Ansible 1.8.4\n\n#Cygwin\u306e\u74b0\u5883\u3092\u6574\u3048\u308b\nCygwin\u306e\u4e0b\u8a18\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u8ffd\u52a0\u3059\u308b\uff08\u901a\u5e38\u306eCygwin Setup\u3092\u4f7f\u7528\uff09\u3002\n\n* python\n* python-paramiko\n* python-crypto\n* python-setuptools\n* gcc-core\n* gcc-g++\n* make\n* wget\n* openssh\n* libyaml-devel\n\n#pip\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\nAnsible\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u305f\u3081\u306bpip\uff08Python\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u7ba1\u7406\u30b7\u30b9\u30c6\u30e0\uff09\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\uff08\u672c\u4f5c\u696d\u6642\u70b9\u3067\u306f\u3001Cygwin\u306ePython\u306f\u30012.7.8\u3067\u3042\u3063\u305f\u305f\u3081pip\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\u4ed8\u5c5e\u3057\u3066\u3044\u306a\u3044\u305f\u3081\uff09\u3002\n\n```lang:\n$ python /usr/lib/python2.7/site-packages/easy_install.py pip\n...\n...\nInstalled /usr/lib/python2.7/site-packages/pip-6.0.8-py2.7.egg\nProcessing dependencies for pip\nFinished processing dependencies for pip\n```\n\n#Ansible\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\n```lang:\n$ pip install ansible\nCollecting ansible\n  Downloading ansible-1.9.0.1.tar.gz (916kB)\n...\n...\nSuccessfully installed PyYAML-3.11 ansible-1.9.0.1 ecdsa-0.13 jinja2-2.7.3 markupsafe-0.23\n```\n\n\u306a\u304a\u3001\n` Command \"python setup.py egg_info\" failed with error code 1`\n\u304c\u51fa\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3067\u304d\u306a\u3044\u3068\u304d\u306fsetuptools\u3092upgrade\u3057\u307e\u3059\u3002\n`$ pip install --upgrade setuptools`\n#Ansible\u5358\u4f53\u306e\u52d5\u4f5c\u78ba\u8a8d\u306e\u6e96\u5099\n\u3053\u3053\u3067\u3001Vagrant\u306eProvisioner\u3068\u3057\u3066\u306eAnsible\u3092\u52d5\u4f5c\u3055\u305b\u308b\u524d\u306bAnsible\u5358\u4f53\u306e\u52d5\u4f5c\u78ba\u8a8d\u3092\u3059\u308b\u3002\n##Managed Node\u3092\u7528\u610f\u3059\u308b\nManaged Node\uff08Ansible\u3067\u64cd\u4f5c\u3055\u308c\u308b\u5074\u306e\u30b5\u30fc\u30d0\uff09\u3068\u3057\u3066\u3001\u9069\u5f53\u306a\u4eee\u60f3\u30de\u30b7\u30f3\u3092vagrant up\u3057\u3066\u304a\u304f\u7b49\u3057\u3066\u3001IP Address\u3092\u63a7\u3048\u3066\u304a\u304f\uff08\u4ee5\u4e0b\u3067\u306f\u4eee\u306b192.168.30.11\u3068192.168.30.12\u306e2\u30ce\u30fc\u30c9\u3068\u3059\u308b\uff09\u3002\n\n##inventory\u30d5\u30a1\u30a4\u30eb\u3092\u7528\u610f\u3059\u308b\n```lang:\nmkdir /etc/ansible\nchmod 755 /etc/ansible\n```\n```lang:/etc/ansible/hosts\n192.168.30.11\n192.168.30.12\n```\n\n##ssh\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n###\u9375\u30da\u30a2\u3092\u4f5c\u6210\u3059\u308b\u3002\n```lang:\n$ ssh-keygen\nGenerating public/private rsa key pair.\nEnter file in which to save the key (/home/XXXX/.ssh/id_rsa):\nEnter passphrase (empty for no passphrase):\nEnter same passphrase again:\nYour identification has been saved in /home/XXXX/.ssh/id_rsa.\nYour public key has been saved in /home/XXXX/.ssh/id_rsa.pub.\nThe key fingerprint is:\n```\n\n###Managed Node\u306bssh\u3067\u4f7f\u7528\u3059\u308b\u30db\u30b9\u30c8\u540d\u3092\u4ed8\u3051\u308b\uff08\u30aa\u30d7\u30b7\u30e7\u30f3\uff09\n\n```lang:~/.ssh/config\nHost node01\n  HostName 192.168.30.11\nHost node02\n  HostName 192.168.30.12\n```\n\u3053\u306e\u8a2d\u5b9a\u3092\u3057\u305f\u5834\u5408\u306f inventory\u30d5\u30a1\u30a4\u30eb\u306f\u4e0b\u8a18\u3067\u3082\u826f\u3044\u3002\n\n```lang:/etc/ansible/hosts\nnode01\nnode02\n```\n\n\n###\u516c\u958b\u9375\u3092Managed Node\u306b\u914d\u5e03\u3059\u308b\n```lang:\n$ ssh-copy-id vagrant@node01`\n/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed\n/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys\nvagrant@192.168.30.11's password:\n\nNumber of key(s) added: 1\n\nNow try logging into the machine, with:   \"ssh 'vagrant@node01'\"\nand check to make sure that only the key(s) you wanted were added.\n\n$ ssh-copy-id vagrant@node02\n/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed\n/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys\nvagrant@192.168.30.11's password:\n\nNumber of key(s) added: 1\n\nNow try logging into the machine, with:   \"ssh 'vagrant@node02'\"\nand check to make sure that only the key(s) you wanted were added.\n```\n\n\u3053\u3053\u3067\u3001@\u306e\u524d\u306e\"vagrant\"\u306f\u3001node01,node02\u3078\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u30e6\u30fc\u30b6\u30fc\u540d\u3002\n\n###ControlMaster\u306e\u8a2d\u5b9a\nansible\u3067\u306f\u3001ssh\u306econtrol master\u3068\u306e\u901a\u4fe1\u306b\u554f\u984c\u304c\u3042\u308b\u3089\u3057\u304f\u4e0b\u8a18\u306e\u4fee\u6b63\u304c\u5fc5\u8981\u3060\u3063\u305f\u3002\n\n```lang:/etc/ansible/ansible.cfg\n[ssh_connection]\nssh_args = -o ControlMaster=auto -o ControlPersist=60s\ncontrol_path = /tmp\n```\n\n\u3061\u306a\u307f\u306b\u3001\u3053\u306e\u8a2d\u5b9a\u3092\u3057\u306a\u3044\u3068\n\n```lang:\nfatal: [node01] => SSH Error: Failed to connect to new control master\n    while connecting to 192.168.30.11:22\n```\n\u3068\u306a\u308b\u3002\n\n###ssh\u306e\u8a8d\u8a3c\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u3092\u8d77\u52d5\u3059\u308b\n\u30d1\u30b9\u30d5\u30ec\u30fc\u30ba\u306e\u5165\u529b\u3092\u7701\u7565\u3059\u308b\u305f\u3081\u8a8d\u8a3c\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u3092\u4f7f\u3046\u3002\n\n```lang:\n$ eval `ssh-agent`\nAgent pid 9148\n```\n\uff08ssh-agent\u306f\u3001\u30d0\u30c3\u30af\u30af\u30aa\u30fc\u30c8\u3067\u56f2\u3080\uff09\n\n\u3061\u306a\u307f\u306b\u3001\u8a8d\u8a3c\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u3092\u4f7f\u308f\u306a\u3044\u3068\u30d1\u30b9\u30d5\u30ec\u30fc\u30ba\u3092\u4f55\u5ea6\u3082\u5165\u529b\u3057\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u3060\u3051\u3067\u306a\u304f\u3001\u8907\u6570\u30ce\u30fc\u30c9\u3078\u306essh\u63a5\u7d9a\u8981\u6c42\u3092\u5e73\u884c\u3057\u3066\u51e6\u7406\u3059\u308b\u305f\u3081\u30d1\u30b9\u30d5\u30ec\u30fc\u30ba\u306e\u5165\u529b\u8981\u6c42\u304c\u5165\u308a\u4e71\u308c\u3046\u307e\u304f\u5165\u529b\u3067\u304d\u306a\u3044\u3002\u305d\u306e\u5834\u5408\u306f\u3001ansible-playbook\u8d77\u52d5\u6642\u306b `-f 1` \u3092\u4ed8\u3051\u3066\u4e00\u5ea6\u306b1\u30ce\u30fc\u30c9\u3065\u3064\u51e6\u7406\u3059\u308b\u3088\u3046\u306b\u3059\u308c\u3070\u30d1\u30b9\u30d5\u30ec\u30fc\u30ba\u306e\u5165\u529b\u304c\u53ef\u80fd\u3068\u306a\u308b\u3002\n\n###\u8a8d\u8a3c\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u306b\u79d8\u5bc6\u9375\u3092\u8a18\u61b6\u3055\u305b\u308b\n```lang:\n$ ssh-add .ssh/id_rsa\nEnter passphrase for .ssh/id_rsa:\nIdentity added: .ssh/id_rsa (.ssh/id_rsa)\n```\n\n#Ansible\u5358\u4f53\u306e\u52d5\u4f5c\u78ba\u8a8d\n##Ad-hoc\u30b3\u30de\u30f3\u30c9\nAd-hoc\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u3066Ansible\u304c\u5358\u4f53\u3067\u52d5\u4f5c\u3059\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u3002\n2\u3064\u306eManaged Node\u4e21\u65b9\u304b\u3089 /etc/redhat-release\u3092\u53d6\u3063\u3066\u304f\u308bAd-hoc\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u3066\u307f\u308b\u3002\n\n```lang:\n$ ansible all -a \"cat /etc/redhat-release\" -u vagrant\n192.168.30.12 | success | rc=0 >>\nCentOS Linux release 7.1.1503 (Core)\n\n192.168.30.11 | success | rc=0 >>\nCentOS Linux release 7.1.1503 (Core)\n```\n\n\u7121\u4e8b\u6210\u529f\u3002\n##Playbook\n\u7c21\u5358\u306aPlaybook\u306e\u52d5\u4f5c\u3082\u78ba\u8a8d\u3057\u3066\u304a\u304f\u3002\n2\u3064\u306e\u30ce\u30fc\u30c9\u4e21\u65b9\u306b\"kuroneko\"\u3068\u3044\u3046\u30e6\u30fc\u30b6\u30fc\u3092\u767b\u9332\u3059\u308bPlaybook\u3092\u7528\u610f\u3059\u308b\u3002\n\n```lang:\n$ cat <<EOF > add_user.yml\n> - hosts: all\n>   sudo: yes\n>   remote_user: vagrant\n>   vars:\n>     username: kuroneko\n>   tasks:\n>     - name: add user\n>       user: name={{ username }} group=wheel shell=/usr/bin/bash\n> EOF\n```\n\nansible-playbook\u3092\u5b9f\u884c\u3057\u3066\u307f\u308b\u3002\n\n```lang:\n$ ansible-playbook add_user.yml\n\nPLAY [all] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [192.168.30.11]\nok: [192.168.30.12]\n\nTASK: [add user] **************************************************************\nchanged: [192.168.30.11]\nchanged: [192.168.30.12]\n\nPLAY RECAP ********************************************************************\n192.168.30.11              : ok=2    changed=1    unreachable=0    failed=0\n192.168.30.12              : ok=2    changed=1    unreachable=0    failed=0\n```\n\n\u7121\u4e8b\u6210\u529f\u3002\u5ff5\u306e\u305f\u3081\u3001kuroneko\u304c\u4f5c\u6210\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3002\n\n```lang:\n$ ansible all -a \"grep kuroneko /etc/passwd\" -u vagrant\n192.168.30.12 | success | rc=0 >>\nkuroneko:x:1002:10::/home/kuroneko:/usr/bin/bash\n\n192.168.30.11 | success | rc=0 >>\nkuroneko:x:1002:10::/home/kuroneko:/usr/bin/bash\n```\n\n\u30e6\u30fc\u30b6\u30fc\"kuroneko\"\u304c\u78ba\u304b\u306b\u8ffd\u52a0\u3055\u308c\u3066\u3044\u3066\u3001playbook\u304c\u6b63\u5e38\u306b\u5b9f\u884c\u3055\u308c\u305f\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u305f\u3002\n\n#ansible-playbook\u3092vagrant\u304b\u3089\u547c\u3073\u51fa\u305b\u308b\u3088\u3046\u306b\u8a2d\u5b9a\n##ansible-playbook.bat\u30d5\u30a1\u30a4\u30eb\u3092\u7528\u610f\u3059\u308b\nVagrant\u304b\u3089ansible-playbook\u3092vagrant\u304b\u3089\u547c\u3073\u51fa\u3059\u305f\u3081\u306b\u306f\n\n* Windows PATH\u306e\u4e2d\u306b ansible-player\u3092\u914d\u7f6e\u3059\u308b\n* ansible-player\u304cCygwin\u306ePaython\u3092\u4f7f\u7528\u3067\u304d\u308b\n\n\n\u3053\u3068\u304c\u5fc5\u8981\u3002\n\u305d\u3053\u3067\u3001\u4e0b\u8a18\u306ebat\u30d5\u30a1\u30a4\u30eb\u3092C:\\HashiCorp\\Vagrant\\bin\u306b\u914d\u7f6e\u3002\n\n```lang:ansible-playbook.bat\n@echo off\n\nset CYGWIN=C:\\cygwin64\n\nset SH=%CYGWIN%\\bin\\bash.exe\n\n\"%SH%\" -c \"/bin/ansible-playbook %*\"\n```\n\n\u3053\u3053\u3067\u3001`CYGWIN=C:\\cygwin64`\u306f\u3001Cygwin\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3067\u3059\u3002\u5b9f\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\u304f\u3060\u3055\u3044\u3002\u307e\u305f\u3001bat\u30d5\u30a1\u30a4\u30eb\u3092\u914d\u7f6e\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306f\u3001`C:\\HashiCorp\\Vagrant\\bin`\u3067\u3042\u308b\u5fc5\u8981\u306f\u3042\u308a\u307e\u305b\u3093\u3002Windows\u306ePATH\u304c\u901a\u3063\u3066\u3044\u308b\u5834\u6240\u306b\u914d\u7f6e\u3057\u307e\u3059\u3002\n\nansible-playbook.bat\u306e\u52d5\u4f5c\u78ba\u8a8d\u3092\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n```lang:ansible-playbook.bat\u52d5\u4f5c\u78ba\u8a8d\n$ ansible-playbook.bat add_user.yml\n\nPLAY [all] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [node01]\nok: [node02]\n\nTASK: [add user] **************************************************************\nok: [node01]\nok: [node02]\n\nPLAY RECAP ********************************************************************\nnode01                     : ok=2    changed=0    unreachable=0    failed=0\nnode02                     : ok=2    changed=0    unreachable=0    failed=0\n```\n\nbat\u30d5\u30a1\u30a4\u30eb\u304b\u3089ansible-playbook\u304c\u547c\u3073\u51fa\u3055\u308c\u3066\u3001\u7121\u4e8badd_user.yml\u304c\u5b9f\u884c\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n#Vagrant\u306eProvisioner\u3068\u3057\u3066\u306eAnsible\u306e\u52d5\u4f5c\u78ba\u8a8d\n##Vasgrantfile\u306e\u7528\u610f\n2\u3064\u306eCentOS 7 (1503)\u306e\u4eee\u60f3\u30b5\u30fc\u30d0\u3092\u4f5c\u6210\u3057\u3066\u3001Apache\u3092provisioning\u3059\u308bVagrantfile\u3092\u7528\u610f\u3002\n\n```lang:Vagrantfile\nVagrant.configure(2) do |config|\n\n  if Vagrant.has_plugin?(\"vagrant-cachier\")\n    config.cache.scope = :box\n  end\n  if Vagrant.has_plugin?(\"vagrant-vbguest\")\n    config.vbguest.auto_update = false\n  end\n  config.vm.define \"web02\" do |web|\n    web.vm.box = \"centos7-1503-01-min\"\n    web.vm.hostname = \"web02\"\n    web.vm.network \"private_network\", ip: \"192.168.40.12\"\n    web.vm.provision \"shell\",\n      inline: \"nmcli connection reload;systemctl restart network.service\"\n    web.vm.provision \"ansible\" do |ansible|\n      ansible.playbook = \"ensure-apache-latest.yml\"\n    end\n  end\n  config.vm.define \"web01\" do |web|\n    web.vm.box = \"centos7-1503-01-min\"\n    web.vm.hostname = \"web01\"\n    web.vm.network \"private_network\", ip: \"192.168.40.11\"\n    web.vm.provision \"shell\",\n      inline: \"nmcli connection reload;systemctl restart network.service\"\n    web.vm.provision \"ansible\" do |ansible|\n      ansible.playbook = \"ensure-apache-latest.yml\"\n    end\n  end\n\nend\n```\n\n\u547c\u3073\u51fa\u3055\u308c\u3066\u3044\u308bPlaybook\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3002\n\n```lang:ensure-apache-latest.yml\n- hosts: all\n  sudo: yes\n  remote_user: vagrant\n  tasks:\n    - name: ensure apache is at the latest version\n      yum: pkg=httpd state=latest\n      notify:\n      - stop firewalld\n      - restart httpd\n  handlers:\n    - name: stop firewalld\n      service: name=firewalld state=stopped enabled=no\n    - name: restart httpd\n      service: name=httpd state=restarted enabled=yes\n```\n\n##\u52d5\u4f5c\u78ba\u8a8d\uff08\u5931\u6557\uff09\n\u4e0a\u8a18\u306eVagrantfile\u3067\u3001vagrant up\u3059\u308b\u3068\u4e0b\u8a18\u306e\u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u8868\u793a\u3055\u308c\u3001Playbook\u3092\u8d77\u52d5\u3067\u304d\u306a\u3044\u3002\n\n```lang:ansible\u306e\u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\nfatal: [web01] => private_key_file (D:/Vagrant/projects/ansible-windows/.vagrant/machines/web01/virtualbox/private_key) is group-readable or world-readable and thus insecure - you will probably get an SSH failure\n```\n\n\u79d8\u5bc6\u9375\u30d5\u30a1\u30a4\u30eb\u306e\u30d1\u30fc\u30df\u30b7\u30e7\u30f3\u304c\u5bdb\u5bb9\u904e\u304e\u308b\u3068\u3044\u3046\u3053\u3068\u306e\u3088\u3046\u3060\u304c\u3001chmod 600\u3057\u305f\u308a setfacl\u3067acl\u3092\u53b3\u3057\u304f\u3057\u3066\u3082\u89e3\u6c7a\u3067\u304d\u306a\u304b\u3063\u305f\u3002\n\u672c\u8a18\u4e8b\u306e\u4e0a\u306e\u65b9\u3067 ~/.ssh/id_rsa\u3092\u4f7f\u3063\u3066\u3001Playbook\u306e\u52d5\u4f5c\u78ba\u8a8d\u3092\u3057\u3066\u3044\u308b\u306e\u3067\u3001\u3053\u306e\u30d5\u30a1\u30a4\u30eb\u3068\u540c\u3058\u30d1\u30fc\u30df\u30b7\u30e7\u30f3\u3092\u8a2d\u5b9a\u3057\u305f\u308a getfacl ~/.ssh/id_rsa | setfacl -f - private_key \u7b49\u3092\u8a66\u3057\u3066\u307f\u305f\u304c\u306a\u305c\u304b\u89e3\u6c7a\u3067\u304d\u306a\u304b\u3063\u305f\u3002stat private_key\u7b49\u3057\u3066\u307f\u3066\u3082\u304a\u304b\u3057\u306a\u3068\u3053\u308d\u306f\u306a\u3044\u3088\u3046\u306b\u898b\u3048\u308b\u3002Cygwin\u3068Windows\u306e\u30d1\u30fc\u30df\u30b7\u30e7\u30f3\u95a2\u4fc2\u3067\u4f55\u304b\u898b\u9003\u3057\u3066\u3044\u305d\u3046\u3060\u304c\u308f\u304b\u3089\u306a\u3044\u3002\u305d\u3053\u3067\u3001\u6b21\u306e\u56de\u907f\u7b56\u3092\u5f37\u884c\u3057\u305f\u3002\n\n#\u56de\u907f\u7b56\n\n\u4e0a\u306e\u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\u306f\u3001`/usr/lib/python2.7/site-packages/ansible/runner/connection.py`\u304b\u3089\u51fa\u529b\u3055\u308c\u3066\u3044\u308b\u3002\n\n```lang:connection.py\u629c\u7c8b\nif st is not None and st.st_mode & (stat.S_IRGRP | stat.S_IROTH):\n  raise AnsibleError(\"private_key_file (%s) is group-readable or world-readable and thus insecure - \"\n    \"you will probably get an SSH failure\"\n    % (private_key_file,))\n```\n\n\u8a66\u9a13\u7684\u306b\u3053\u306e\u90e8\u5206\u3092#\u3067\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3057\u3066\u3001vagrant destroy;vagrant up\u3057\u305f\u3068\u3053\u308d\u7121\u4e8b\u3001provisioning\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u305f\u3002\n\n\n```lang:\u5b9f\u884c\u30ed\u30b0\u306e\u629c\u7c8b\n$ vagrant up\nBringing machine 'web02' up with 'virtualbox' provider...\nBringing machine 'web01' up with 'virtualbox' provider...\n...\n...\n...\n==> web02: Running provisioner: ansible...\n...\n...\n...\nPLAY [all] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [web02]\n\nTASK: [ensure apache is at the latest version] ********************************\nchanged: [web02]\n\nNOTIFIED: [stop firewalld] ****************************************************\nchanged: [web02]\n\nNOTIFIED: [restart httpd] *****************************************************\nchanged: [web02]\n\nPLAY RECAP ********************************************************************\nweb02                      : ok=4    changed=3    unreachable=0    failed=0\n==> web02: Configuring cache buckets...\n==> web01: Importing base box 'centos7-1503-01-min'...\n...\n...\n...\n==> web01: Running provisioner: ansible...\n...\n...\n...\nPLAY [all] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [web01]\n\nTASK: [ensure apache is at the latest version] ********************************\nchanged: [web01]\n\nNOTIFIED: [stop firewalld] ****************************************************\nchanged: [web01]\n\nNOTIFIED: [restart httpd] *****************************************************\nchanged: [web01]\n\nPLAY RECAP ********************************************************************\nweb01                      : ok=4    changed=3    unreachable=0    failed=0\n==> web01: Configuring cache buckets...\n```\n#\u4f59\u8ac7\n\u4e0a\u306eVagrantfile\u306eansible playbook\u306e\u547c\u3073\u51fa\u3057\u65b9\u3060\u3068\u3001\u4eee\u60f3\u30b5\u30fc\u30d0\u4f5c\u3063\u3066\u3001\u30d7\u30ed\u30d3\u30b8\u30e7\u30f3\u3057\u3066\u3001\u4eee\u60f3\u30b5\u30fc\u30d0\u4f5c\u3063\u3066\u3001\u30d7\u30ed\u30d3\u30b8\u30e7\u30f3\u3057\u3066\u3092\u305f\u3060\u3072\u305f\u3059\u3089\u30b7\u30fc\u30b1\u30f3\u30b7\u30e3\u30eb\u306b\u5b9f\u884c\u3059\u308b\u3060\u3051\u3067\u3064\u307e\u3089\u306a\u3044\u3002Vagrant\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306eAnsible\u306eTIPS AND TRICS\u306b\"ANSIBLE PARALLEL EXECUTION\"\u3068\u3044\u3046\u8a18\u8f09\u304c\u3042\u308b\u3002\u3053\u308c\u3092\u307e\u306d\u3066\u4e0b\u8a18\u306eVagrantfile\u3067\u3001provisioning\u306e\u4e26\u5217\u5b9f\u884c\u3092\u3084\u3063\u3066\u307f\u305f\u3002\n\n\n```lang:Vagrantfile\nVagrant.configure(2) do |config|\n\n  if Vagrant.has_plugin?(\"vagrant-cachier\")\n    config.cache.scope = :box\n  end\n  if Vagrant.has_plugin?(\"vagrant-vbguest\")\n    config.vbguest.auto_update = false\n  end\n  config.ssh.insert_key = false\n  config.vm.define \"web02\" do |web|\n    web.vm.box = \"centos7-1503-01-min\"\n    web.vm.hostname = \"web02\"\n    web.vm.network \"private_network\", ip: \"192.168.40.12\"\n    web.vm.provision \"shell\",\n      inline: \"nmcli connection reload;systemctl restart network.service\"\n  end\n  config.vm.define \"web01\" do |web|\n    web.vm.box = \"centos7-1503-01-min\"\n    web.vm.hostname = \"web01\"\n    web.vm.network \"private_network\", ip: \"192.168.40.11\"\n    web.vm.provision \"shell\",\n      inline: \"nmcli connection reload;systemctl restart network.service\"\n    web.vm.provision \"ansible\" do |ansible|\n      ansible.playbook = \"ensure-apache-latest.yml\"\n      ansible.limit = 'all'\n    end\n  end\n\nend\n```\n\n\u3059\u3079\u3066\u306e\u4eee\u60f3\u30b5\u30fc\u30d0\u3078\u3072\u3068\u3064\u306e\u79d8\u5bc6\u9375\u3067ssh\u3059\u308b\u305f\u3081`config.ssh.insert_key = false`\u3092\u5fd8\u308c\u308b\u30681\u53f0\u3092\u9664\u3044\u3066provisioning\u306b\u5931\u6557\u3059\u308b\u306e\u3067\u6ce8\u610f\u3002\n\n\u5f8c\u3067legacy insecure key\u3092\u5165\u308c\u66ff\u3048\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u304c\u3001\u4f7f\u3048\u305d\u3046\u3060\u3002\n", "tags": ["vagrant1.7.2", "Ansible1.8.4", "Cygwin", "Virtualization"]}