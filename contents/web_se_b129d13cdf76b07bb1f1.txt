{"context": "\u53d6\u5f97\u3067\u304d\u308bmetadata\u60c5\u5831\n$ curl -s http://metadata.google.internal/computeMetadata/v1/instance/ -H \"Metadata-Flavor: Google\"\nattributes/\ndescription\ndisks/\nhostname\nid\nimage\nmachine-type\nmaintenance-event\nnetwork-interfaces/\nscheduling/\nservice-accounts/\ntags\nvirtual-clock/\nzone\n\ntags\u3067\u3001Custom Metadata\u3092\u53d6\u5f97\n$ curl -s http://metadata.google.internal/computeMetadata/v1/instance/ tags/ -H \"Metadata-Flavor: Google\"\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u30a2\u30bf\u30c3\u30c1\u3055\u308c\u3066\u3044\u308b\u30c7\u30a3\u30b9\u30af\u60c5\u5831\u3092\u53d6\u5f97\u3002\n/disks/0/\u304c\u3001root volume\u3001/disks/1/\u306a\u3069\u306f\u3001\u8ffd\u52a0\u3055\u308c\u305f\u30c7\u30a3\u30b9\u30af\n$ curl -s http://metadata.google.internal/computeMetadata/v1/instance/disks/0/ -H \"Metadata-Flavor: Google\"\ndevice-name\nindex\nmode\ntype\n\n\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u306e\u60c5\u5831\u3002\n$ curl -s http://metadata.google.internal/computeMetadata/v1/instance/network-interfaces/0/ -H \"Metadata-Flavor: Google\"\n\naccess-configs/\nforwarded-ips/\nip\nnetwork\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\u30a4\u30d9\u30f3\u30c8\u306e\u60c5\u5831\n$ curl -s http://metadata.google.internal/computeMetadata/v1/instance/scheduling/ -H \"Metadata-Flavor: Google\"\nautomatic-restart\non-host-maintenance\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30be\u30fc\u30f3\u53d6\u5f97\nREGION=`curl -s http://metadata.google.internal/computeMetadata/v1/instance/zone  -H \"Metadata-Flavor: Google\" | cut -d \"/\" -f 4`\n\n\u51fa\u529b\nasia-east1-a\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306eExternal IP\u53d6\u5f97\ncurl \"http://metadata.google.internal/computeMetadata/v1/instance/network-interfaces/0/access-configs/0/external-ip\"  -H \"Metadata-Flavor: Google\"\n\n\u30ab\u30b9\u30bf\u30e0\u30a4\u30e1\u30fc\u30b8\u4f5c\u6210\u306e\u305f\u3081\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4f5c\u6210\n gcloud compute instances create instance-1 --machine-type n1-standard-1 --network prod\nuct-network --maintenance-policy MIGRATE --scopes \"https://www.googleapis.com/auth/compute\",\"https://www.goo\ngleapis.com/auth/devstorage.read_write\", \"https://www.googleapis.com/auth/bigquery\",\"https://www.googleapis.c\nom/auth/sqlservice.admin\",\"https://www.googleapis.com/auth/logging.write\" --image \"https://www.googleapis.co\nm/compute/v1/projects/centos-cloud/global/images/centos-7-v20150325\" --boot-disk-type pd-standard\n\n\u7a7a\u306e\u30c7\u30a3\u30b9\u30af\u4f5c\u6210\uff0850G\u3001SSD\uff09\ngcloud compute disks create disk-1 --size 50 --zone asia-east1-a --type pd-ssd\n\n\u4f5c\u696d\u7528\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u8d77\u52d5\nnginx\u3001Fluentd\u3001BQuery\u7b49\u5404\u7a2e\u8a2d\u5b9a\n[nginx]\nname=nginx repo\n#baseurl=http://nginx.org/packages/centos/$releasever/$basearch/\nbaseurl=http://nginx.org/packages/mainline/centos/$releasever/$basearch/\ngpgcheck=0\nenabled=0\n\nyum --enablerepo=nginx install nginx\nsystemctl enable nginx\n\ncurl -L http://toolbelt.treasuredata.com/sh/install-redhat-td-agent2.sh | sh\n/opt/td-agent/embedded/bin/fluent-gem install fluent-plugin-bigquery\n/opt/td-agent/embedded/bin/fluent-gem install fluent-plugin-forest\n\nSELinux\u7121\u52b9\ntimezone\u3092JST\u306b\u3059\u308b\ntimedatectl set-timezone Asia/Tokyo\n\nntp(\u6642\u523b\u540c\u671f\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u30aa\u30f3)\n$ ntpq -p\n     remote           refid      st t when poll reach   delay   offset  jitter\n==============================================================================\n*metadata.google 27.227.116.206   2 u    7   64    7    0.403  -31.466   5.497\n\n\u3059\u3067\u306b\u4f5c\u6210\u6e08\u306e\u30c7\u30a3\u30b9\u30af\u3092\u30a2\u30bf\u30c3\u30c1\u3059\u308b\ngcloud compute instances attach-disk instance-1 --disk disk-1 --zone asia-east1-a\n\n\u6307\u5b9a\u3057\u305fdevice\u540d\u306b\u306f\u3067\u304d\u306a\u305d\u3046\u3002(--device-name)\n\u5916\u90e8\u30c7\u30a3\u30b9\u30af\u306e\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\nmkfs.ext4 /dev/sdb \n\nVM\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u524a\u9664\uff08\u30c7\u30a3\u30b9\u30af\u306f\u524a\u9664\u3057\u306a\u3044\uff09\n\u4f5c\u696d\u7528\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30a4\u30e1\u30fc\u30b8\u53d6\u5f97\nVM\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u7d10\u4ed8\u3044\u305f\u30c7\u30a3\u30b9\u30af\u304b\u3089\u30a4\u30e1\u30fc\u30b8\u4f5c\u6210\u4e0d\u53ef\ngcloud compute images create cmsweb-20150405 --source-disk-zone asia-east1-a --source-disk disk-1\n\nstartup script\u3092\u914d\u7f6e\u3059\u308b\u30d0\u30b1\u30c3\u30c8\u3092\u4f5c\u6210\ngsutil mb -l ASIA h-XXXXXX-XXXX\n\nstartup.sh\n#! /bin/bash\ntimedatectl set-timezone Asia/Tokyo\n\nPRIVATE_IP=`curl \"http://metadata.google.internal/computeMetadata/v1/instance/network-interfaces/0/ip\" -H \"Metadata-Flavor: Google\"`\nINSTANCE_ID=`curl -s http://metadata.google.internal/computeMetadata/v1/instance/hostname -H \"Metadata-Flavor: Google\" | cut -d \".\" -f 1`\n\n\ngcloud compute instances attach-disk $INSTANCE_ID --disk disk-1 --zone asia-east1-a\n\nmount -o discard,defaults /dev/disk/by-id/google-persistent-disk-1 /mnt\n\n\nstartup-script\u3092Google Cloud Storage\u306e\u30d0\u30b1\u30c3\u30c8\u306b\u914d\u7f6e\u3057\u3066\u304a\u304f\u3053\u3068\u304c\u53ef\u80fd\u3002\npublic-read\u306eACL\u6a29\u9650\u304c\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\u3002\nstartup script\u3092\u30d0\u30b1\u30c3\u30c8\u306b\u3001\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3057\u307e\u3059\u3002\ngsutil cp startup.sh gs://h-XXXXXX-XXXX/\n\nstartup.sh\u306bpublic-read\u306e\u30a2\u30af\u30bb\u30b9\u6a29\u9650\u3092\u4ed8\u4e0e\u3057\u307e\u3059\u3002\ngsutil setacl public-read gs://h-XXXXXX-XXXX/startup.sh\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\ngcloud compute  instance-templates create instance-template-1 --machine-type n1-standard-1 --network product-network --maintenance-policy MIGRATE --scopes \"https://www.googleapis.com/auth/compute\" ,\"https://www.googleapis.com/auth/devstorage.read_write\" ,\"https://www.googleapis.com/auth/bigquery\" ,\"https://www.googleapis.com/auth/sqlservice.admin\" ,\"https://www.googleapis.com/auth/logging.write\" --image ,\"https://www.googleapis.com/compute/v1/projects/centos-cloud/global/images/centos-7-v20150325\" --boot-disk-type pd-standard  --metadata startup-script-url=gs://h-XXXXXX-XXXX/startup.sh --boot-disk-device-name instance-template-1 --boot-disk-size 30GB\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30b0\u30eb\u30fc\u30d7\ngcloud preview managed-instance-groups --zone asia-east1-a create instance-group-1 --base-instance-name instance-group-1 --template instance-template-1 --size 1\n\n\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\u60c5\u5831\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\ngcloud compute instances <instance id> get-serial-port-output instance-1\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3068zone\u304c\u9055\u3046\u3068\u30a8\u30e9\u30fc\u3068\u306a\u308a\u307e\u3059\u3002\n\uff08EBS\u304c\u914d\u7f6e\u3055\u308c\u3066\u3044\u308bAvailability Zone\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3057\u304b\u30a2\u30bf\u30c3\u30c1\u3067\u304d\u306a\u3044\u306e\u3068\u540c\u3058\u304b\u3002\uff09\ngcloud compute instances attach-disk instance-1 --disk disk-2 --zone asia-east1-c\nERROR: (gcloud.compute.instances.attach-disk) Some requests did not succeed:\n - The resource 'projects/skillful-fx-531/zones/asia-east1-c/instances/instance-1' was not found\n\n\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\ngcloud compute  alive-health-check create \"alive-health-check\" --port \"80\" --request-path \"/alive.php\" --check-interval \"5\" --timeout \"5\" --unhealthy-threshold \"2\" --healthy-threshold \"2\"\n\ngcloud preview instance-groups --zone asia-east1-a add-service instance-group-1 --port 80 --service http\n\ngcloud compute backend-services add-backend web-service --group instance-group-1 --zone asia-east1-a\n\ngcloud compute url-maps create web-map --default-service web-service\n\ngcloud compute target-http-proxies create web-proxy --url-map web-map\n\ngcloud compute forwarding-rules create http-rule --global \\\n    --target-http-proxy web-proxy --port-range 80\n\n\u53d6\u5f97\u3067\u304d\u308bmetadata\u60c5\u5831\n\n\n```\n$ curl -s http://metadata.google.internal/computeMetadata/v1/instance/ -H \"Metadata-Flavor: Google\"\nattributes/\ndescription\ndisks/\nhostname\nid\nimage\nmachine-type\nmaintenance-event\nnetwork-interfaces/\nscheduling/\nservice-accounts/\ntags\nvirtual-clock/\nzone\n```\n\ntags\u3067\u3001Custom Metadata\u3092\u53d6\u5f97\n\n```\n$ curl -s http://metadata.google.internal/computeMetadata/v1/instance/ tags/ -H \"Metadata-Flavor: Google\"\n```\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u30a2\u30bf\u30c3\u30c1\u3055\u308c\u3066\u3044\u308b\u30c7\u30a3\u30b9\u30af\u60c5\u5831\u3092\u53d6\u5f97\u3002\n/disks/0/\u304c\u3001root volume\u3001/disks/1/\u306a\u3069\u306f\u3001\u8ffd\u52a0\u3055\u308c\u305f\u30c7\u30a3\u30b9\u30af\n\n```\n$ curl -s http://metadata.google.internal/computeMetadata/v1/instance/disks/0/ -H \"Metadata-Flavor: Google\"\ndevice-name\nindex\nmode\ntype\n```\n\n\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u306e\u60c5\u5831\u3002\n\n\n```\n$ curl -s http://metadata.google.internal/computeMetadata/v1/instance/network-interfaces/0/ -H \"Metadata-Flavor: Google\"\n\naccess-configs/\nforwarded-ips/\nip\nnetwork\n```\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\u30a4\u30d9\u30f3\u30c8\u306e\u60c5\u5831\n\n```\n$ curl -s http://metadata.google.internal/computeMetadata/v1/instance/scheduling/ -H \"Metadata-Flavor: Google\"\nautomatic-restart\non-host-maintenance\n```\n\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30be\u30fc\u30f3\u53d6\u5f97\n\n```\nREGION=`curl -s http://metadata.google.internal/computeMetadata/v1/instance/zone  -H \"Metadata-Flavor: Google\" | cut -d \"/\" -f 4`\n```\n\n\u51fa\u529b\n\n```\nasia-east1-a\n```\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306eExternal IP\u53d6\u5f97\n\n```\ncurl \"http://metadata.google.internal/computeMetadata/v1/instance/network-interfaces/0/access-configs/0/external-ip\"  -H \"Metadata-Flavor: Google\"\n```\n\n\n\u30ab\u30b9\u30bf\u30e0\u30a4\u30e1\u30fc\u30b8\u4f5c\u6210\u306e\u305f\u3081\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4f5c\u6210\n\n```\n gcloud compute instances create instance-1 --machine-type n1-standard-1 --network prod\nuct-network --maintenance-policy MIGRATE --scopes \"https://www.googleapis.com/auth/compute\",\"https://www.goo\ngleapis.com/auth/devstorage.read_write\", \"https://www.googleapis.com/auth/bigquery\",\"https://www.googleapis.c\nom/auth/sqlservice.admin\",\"https://www.googleapis.com/auth/logging.write\" --image \"https://www.googleapis.co\nm/compute/v1/projects/centos-cloud/global/images/centos-7-v20150325\" --boot-disk-type pd-standard\n```\n\n\u7a7a\u306e\u30c7\u30a3\u30b9\u30af\u4f5c\u6210\uff0850G\u3001SSD\uff09\n\n```\ngcloud compute disks create disk-1 --size 50 --zone asia-east1-a --type pd-ssd\n```\n\n\u4f5c\u696d\u7528\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u8d77\u52d5\nnginx\u3001Fluentd\u3001BQuery\u7b49\u5404\u7a2e\u8a2d\u5b9a\n\n```\n[nginx]\nname=nginx repo\n#baseurl=http://nginx.org/packages/centos/$releasever/$basearch/\nbaseurl=http://nginx.org/packages/mainline/centos/$releasever/$basearch/\ngpgcheck=0\nenabled=0\n```\n\n```\nyum --enablerepo=nginx install nginx\nsystemctl enable nginx\n```\n\n\n```\ncurl -L http://toolbelt.treasuredata.com/sh/install-redhat-td-agent2.sh | sh\n/opt/td-agent/embedded/bin/fluent-gem install fluent-plugin-bigquery\n/opt/td-agent/embedded/bin/fluent-gem install fluent-plugin-forest\n```\n\nSELinux\u7121\u52b9\n\ntimezone\u3092JST\u306b\u3059\u308b\n\n```\ntimedatectl set-timezone Asia/Tokyo\n```\n\nntp(\u6642\u523b\u540c\u671f\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u30aa\u30f3)\n\n```\n$ ntpq -p\n     remote           refid      st t when poll reach   delay   offset  jitter\n==============================================================================\n*metadata.google 27.227.116.206   2 u    7   64    7    0.403  -31.466   5.497\n```\n\u3059\u3067\u306b\u4f5c\u6210\u6e08\u306e\u30c7\u30a3\u30b9\u30af\u3092\u30a2\u30bf\u30c3\u30c1\u3059\u308b\n\n```\ngcloud compute instances attach-disk instance-1 --disk disk-1 --zone asia-east1-a\n```\n\n\u6307\u5b9a\u3057\u305fdevice\u540d\u306b\u306f\u3067\u304d\u306a\u305d\u3046\u3002(--device-name)\n\n\u5916\u90e8\u30c7\u30a3\u30b9\u30af\u306e\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\n\n```\nmkfs.ext4 /dev/sdb \n```\n\nVM\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u524a\u9664\uff08\u30c7\u30a3\u30b9\u30af\u306f\u524a\u9664\u3057\u306a\u3044\uff09\n\n\u4f5c\u696d\u7528\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30a4\u30e1\u30fc\u30b8\u53d6\u5f97\nVM\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u7d10\u4ed8\u3044\u305f\u30c7\u30a3\u30b9\u30af\u304b\u3089\u30a4\u30e1\u30fc\u30b8\u4f5c\u6210\u4e0d\u53ef\n\n```\ngcloud compute images create cmsweb-20150405 --source-disk-zone asia-east1-a --source-disk disk-1\n```\n\n\n\n\nstartup script\u3092\u914d\u7f6e\u3059\u308b\u30d0\u30b1\u30c3\u30c8\u3092\u4f5c\u6210\n\n```\ngsutil mb -l ASIA h-XXXXXX-XXXX\n```\n\nstartup.sh\n\n```\n#! /bin/bash\ntimedatectl set-timezone Asia/Tokyo\n\nPRIVATE_IP=`curl \"http://metadata.google.internal/computeMetadata/v1/instance/network-interfaces/0/ip\" -H \"Metadata-Flavor: Google\"`\nINSTANCE_ID=`curl -s http://metadata.google.internal/computeMetadata/v1/instance/hostname -H \"Metadata-Flavor: Google\" | cut -d \".\" -f 1`\n\n\ngcloud compute instances attach-disk $INSTANCE_ID --disk disk-1 --zone asia-east1-a\n\nmount -o discard,defaults /dev/disk/by-id/google-persistent-disk-1 /mnt\n\n```\n\nstartup-script\u3092Google Cloud Storage\u306e\u30d0\u30b1\u30c3\u30c8\u306b\u914d\u7f6e\u3057\u3066\u304a\u304f\u3053\u3068\u304c\u53ef\u80fd\u3002\npublic-read\u306eACL\u6a29\u9650\u304c\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\u3002\n\nstartup script\u3092\u30d0\u30b1\u30c3\u30c8\u306b\u3001\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3057\u307e\u3059\u3002\n\n```\ngsutil cp startup.sh gs://h-XXXXXX-XXXX/\n```\n\nstartup.sh\u306bpublic-read\u306e\u30a2\u30af\u30bb\u30b9\u6a29\u9650\u3092\u4ed8\u4e0e\u3057\u307e\u3059\u3002\n\n```\ngsutil setacl public-read gs://h-XXXXXX-XXXX/startup.sh\n```\n\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\n\n```\ngcloud compute  instance-templates create instance-template-1 --machine-type n1-standard-1 --network product-network --maintenance-policy MIGRATE --scopes \"https://www.googleapis.com/auth/compute\" ,\"https://www.googleapis.com/auth/devstorage.read_write\" ,\"https://www.googleapis.com/auth/bigquery\" ,\"https://www.googleapis.com/auth/sqlservice.admin\" ,\"https://www.googleapis.com/auth/logging.write\" --image ,\"https://www.googleapis.com/compute/v1/projects/centos-cloud/global/images/centos-7-v20150325\" --boot-disk-type pd-standard  --metadata startup-script-url=gs://h-XXXXXX-XXXX/startup.sh --boot-disk-device-name instance-template-1 --boot-disk-size 30GB\n```\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30b0\u30eb\u30fc\u30d7\n\n```\ngcloud preview managed-instance-groups --zone asia-east1-a create instance-group-1 --base-instance-name instance-group-1 --template instance-template-1 --size 1\n```\n\n\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\u60c5\u5831\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```\ngcloud compute instances <instance id> get-serial-port-output instance-1\n```\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3068zone\u304c\u9055\u3046\u3068\u30a8\u30e9\u30fc\u3068\u306a\u308a\u307e\u3059\u3002\n\uff08EBS\u304c\u914d\u7f6e\u3055\u308c\u3066\u3044\u308bAvailability Zone\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3057\u304b\u30a2\u30bf\u30c3\u30c1\u3067\u304d\u306a\u3044\u306e\u3068\u540c\u3058\u304b\u3002\uff09\n\n```\ngcloud compute instances attach-disk instance-1 --disk disk-2 --zone asia-east1-c\nERROR: (gcloud.compute.instances.attach-disk) Some requests did not succeed:\n - The resource 'projects/skillful-fx-531/zones/asia-east1-c/instances/instance-1' was not found\n```\n\n\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\n\n```\ngcloud compute  alive-health-check create \"alive-health-check\" --port \"80\" --request-path \"/alive.php\" --check-interval \"5\" --timeout \"5\" --unhealthy-threshold \"2\" --healthy-threshold \"2\"\n```\n\n```\ngcloud preview instance-groups --zone asia-east1-a add-service instance-group-1 --port 80 --service http\n```\n\n```\ngcloud compute backend-services add-backend web-service --group instance-group-1 --zone asia-east1-a\n```\n\n```\ngcloud compute url-maps create web-map --default-service web-service\n```\n\n```\ngcloud compute target-http-proxies create web-proxy --url-map web-map\n```\n\n```\ngcloud compute forwarding-rules create http-rule --global \\\n    --target-http-proxy web-proxy --port-range 80\n```\n", "tags": ["googlecomputeengine", "GoogleCloudPlatform"]}