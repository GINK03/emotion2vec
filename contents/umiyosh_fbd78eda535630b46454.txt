{"context": " More than 1 year has passed since last update.\u3053\u306e\u8a18\u4e8b\u306f\u3002MongoDB Advent Calendar 2015 - Qiita\u306e\uff11\uff14\u65e5\u76ee\u306e\u8a18\u4e8b\u3067\u3059\u3002\n\u672c\u65e5\u500b\u4eba\u7684\u7406\u7531\u3067\u3078\u308d\u3078\u308d\u306a\u306e\u3067\u3059\u304c\u3001\u304c\u30fc\u3063\u3068\u66f8\u3044\u3066\u3044\u304d\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\u8077\u5834\u3067\u691c\u8a3c\u7528\u306eMongoDB\u74b0\u5883\u3092\u4f55\u5ea6\u304b\u4f5c\u3063\u3066\u3044\u305f\u306e\u3067\u3001\u305d\u308c\u3068\u4f3c\u305f\u624b\u9806\u3067MongoDB Cloud Manager\u3092\u4f7f\u3063\u3066AWS\u4e0a\u306b\u304a\u8a66\u3057MongoDB shard cluster\u3092\u4f5c\u308b\u624b\u9806\u3092\u66f8\u304d\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\nmms\u30a2\u30ab\u30a6\u30f3\u30c8\u4f5c\u6210\nMongoDB Cloud Manager - Management Made Easy | MongoDB\u304b\u3089\u7121\u6599\u30a2\u30ab\u30a6\u30f3\u30c8\u4f5c\u6210\u3057\u307e\u3059\u3002\uff13\uff10\u65e5\u9593\u306e\u30c8\u30e9\u30a4\u30a2\u30eb\u30a2\u30ab\u30a6\u30f3\u30c8\u304c\u53d6\u5f97\u3067\u304d\u307e\u3059\u3002\nSettings \u2192 Group Settings \u3088\u308aGROUP ID\u3068AGENT API KEY\u3092\u30e1\u30e2\u3063\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u30ad\u30fc\u30da\u30a2\u306e\u4f5c\u6210\nec2\u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9\u3088\u308a\u30ad\u30fc\u30da\u30a2\u3092\u4f5c\u6210\u3057\u3001\u624b\u5143\u306e\u30d1\u30bd\u30b3\u30f3\u306e~/.ssh/\u3068~/.ssh/config\u306b\u63a5\u7d9a\u60c5\u5831\u3092\u6574\u3048\u3066\u304a\u304d\u307e\u3059\u3002\n\nAMI\u3092\u4f5c\u308a\u306a\u304a\u3057\u3066ID\u57cb\u3081\u308b\nMMS\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6e08\u306eAMI \u203b\u304b\u3089EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u4f5c\u3063\u3066\u3001\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306bssh\u3057/etc/mongodb-mms/automation-agent.config \u306eREPLACE\u3068\u3057\u3066\u3044\u308b\u7b87\u6240\u306b\u5148\u307b\u3069\u306eGROUP ID\u3068AGENT API KEY\u3092\u5165\u308c\u3066AMI\u518d\u4f5c\u6210\u3057\u3066\u304f\u3060\u3055\u3044\u3002ami-id\u306f\u30e1\u30e2\u3063\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\n\u203b\u307e\u306b\u3042\u308f\u305a\u3002\u5f8c\u307b\u3069\u516c\u958b\u3059\u308b\u304b\u3082\u3002\u3068\u3044\u3063\u3066\u3082mms\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u304c\u5165\u3063\u3066\u3044\u308b\u3060\u3051\u3067\u3059\u3002\n\naccess_key, secret\u6574\u3048\n\u3053\u308c\u304b\u3089\u4f5c\u6210\u3059\u308bAWS\u30a2\u30ab\u30a6\u30f3\u30c8\u306b\u3066IAM\u3088\u308a\u74b0\u5883\u69cb\u7bc9\u7528\u306bAdministratorAccess\u30dd\u30ea\u30b7\u30fc\u306a\u3069\u3092\u4ed8\u4e0e\u3057\u305f\u30e6\u30fc\u30b6\u3092\u4f5c\u6210\u3057awscli\u3084terraform\u304c\u4f7f\u3048\u308b\u3088\u3046\u306baws configure\u3057\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u30c9\u30e1\u30a4\u30f3\u306e\u767b\u9332\nmms\u4e0a\u3067mongoc\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u969b\u3001CNAME\u304c\u5fc5\u9808\u306e\u305f\u3081\u3001\u3042\u3089\u304b\u3081\u30c9\u30e1\u30a4\u30f3\u767b\u9332\u304c\u3042\u308b\u3068\u826f\u3044\u3067\u3059\u3002\u4eca\u56de\u306fRoute53\u306e\u30ec\u30b8\u30b9\u30c8\u30e9\u3092\u4f7f\u3063\u3066umiyosh.com\u3068\u3044\u3046\u306e\u3092\u3067\u3063\u3061\u3042\u3052\u307e\u3057\u305f\u3002\u91d1\u304c\u3082\u3063\u305f\u3044\u306a\u3044\u306a\u3069\u306e\u5834\u5408\u306fGIP\u306a\u3069\u3067\u3082\u3060\u3044\u3058\u3087\u3076\u306a\u306f\u305a\u3067\u3059\uff08\u5f8c\u4ed8\u306e\u5909\u66f4\u304c\u3067\u304d\u306a\u3044\u306e\u3067\u69cb\u6210\u5909\u66f4\u306a\u3069\u3067\u304d\u306a\u3044\u306a\u3069\u306b\u306a\u3063\u305f\u308a\u3057\u307e\u3059\u306e\u3067\u307b\u3093\u3068\u304a\u8a66\u3057\u7248\u3068\u3044\u3046\u611f\u3058\u3067\u3059\uff09\u3002\n\nterraform clone\u3057\u3066\u5fc5\u8981\u306a\u3068\u3053\u308d\u3092\u8ffd\u8a18\u3059\u308b\n\u3059\u3050\u52d5\u304d\u305d\u3046\u306aterraform\u3092\u3046\uff50\u3057\u305f\u306e\u3067\u305d\u308c\u3092clone\u3057\u3066\u304d\u307e\u3059\u3002\n% git clone https://github.com/umiyosh/mmsInstall.git \n% cd mmsInstall\n% vi variable.tf\n\nvariable.tf\u3092\u66f8\u304d\u63db\u3048\u307e\u3059\u3002REPLACE\u3068\u3057\u3066\u3044\u308bVPC ID\u3084ZONE ID\u3084hosted_zone\u3084SUBNET ID\u3084AMI ID(\u5148\u307b\u3069\u81ea\u5206\u3067\u3055\u304f\u305b\u3044\u3057\u305f\u3084\u3064)\u306a\u3069\u3092\u66f8\u304d\u63db\u3048\u3066\u3044\u304d\u307e\u3059\u3002\n\nterraform plan\nterraform\u64cd\u4f5c\u3059\u308b\u30ed\u30fc\u30ab\u30ebcli\u3067\u4ee5\u4e0b\u306e\u74b0\u5883\u5909\u6570\u3092export\u3057\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\n% export AWS_DEFAULT_REGION=ap-northeast-1\n% export AWS_SECRET_ACCESS_KEY=\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u30a2\u30af\u30bb\u30b9\u30ad\u30fc\u306b\u7f6e\u304d\u63db\u3048\u3066\u304f\u3060\u3055\u3044\n% export AWS_ACCESS_KEY_ID=\u30a2\u30af\u30bb\u30b9\u30ad\u30fc\u306b\u7f6e\u304d\u63db\u3048\u3066\u304f\u3060\u3055\u3044\n\n\u4f5c\u6210\u3059\u308b\u307e\u3048\u306bplan\u3057AWS\u4e0a\u306b\u4f5c\u6210\u3055\u308c\u308b\u30ea\u30bd\u30fc\u30b9\u3092\u898b\u307e\u3057\u3087\u3046\u3002terraform\u306f\u521d\u671f\u69cb\u7bc9\u3059\u308b\u3060\u3051\u306a\u3089\u30e9\u30af\u3067\u3059\u304c\u64cd\u4f5c\u3092\u9593\u9055\u3046\u3068\u5927\u4e8b\u306a\u30ea\u30bd\u30fc\u30b9\u3092\u6d88\u3057\u305f\u308a\u306a\u3069\u3042\u308b\u306e\u3067\u306a\u306b\u3082\u306a\u3044AWS\u30a2\u30ab\u30a6\u30f3\u30c8\u3067\u3084\u308b\u306e\u304c\u826f\u3044\u3067\u3059\u3002\n% terraform plan --refresh=false\nThe Terraform execution plan has been generated and is shown below.\nResources are shown in alphabetical order for quick scanning. Green resources\nwill be created (or destroyed and then created if an existing resource\nexists), yellow resources are being changed in-place, and red resources\nwill be destroyed.\n\nNote: You didn't specify an \"-out\" parameter to save this plan, so when\n\"apply\" is called, Terraform can't guarantee this is what will execute.\n\n+ aws_iam_instance_profile.test_profile\n    arn:              \"\" => \"<computed>\"\n    create_date:      \"\" => \"<computed>\"\n<<\u7701\u7565>>\n\n\u3053\u3093\u306a\u611f\u3058\u306e\u304c\u51fa\u3066\u304f\u308c\u3070OK\u3067\u3059\u3002\n\nterraform apply\n\u5148\u306bIAM\u30ea\u30bd\u30fc\u30b9\u3092\u4f5c\u6210\u3057\u306a\u3044\u3068\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4f5c\u6210\u6642\u306bIAM profile\u304c\u5b58\u5728\u3057\u306a\u3044\u306e\u3067\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4f5c\u6210\u306b\u5931\u6557\u3059\u308b\u3068\u3044\u3046\u5fae\u5999\u554f\u984c\u304c\u3042\u308b\u307f\u305f\u3044\u306a\u306e\u3067-target\u3067IAM\u30ea\u30bd\u30fc\u30b9\u3092\u5148\u306b\u4f5c\u6210\u3057\u3066\u304a\u304d\u307e\u3059\u3002\u3042\u3068\u6709\u52b9\u306b\u306a\u308b\u306e\u306b\n\u3061\u3087\u3063\u3068\u6642\u9593\u3092\u7f6e\u304f\u5fc5\u8981\u304c\u3042\u308b\u306e\u3067\u6642\u9593\u3092\u304a\u304d\u307e\u3059\u3002\n% terraform plan -target=aws_iam_role.test_role -target=aws_iam_role_policy.test_policy -target=aws_iam_instance_profile.test_profile --refresh=false\n% terraform apply -target=aws_iam_role.test_role -target=aws_iam_role_policy.test_policy -target=aws_iam_instance_profile.test_profile\n\napply\u3057\u30ea\u30bd\u30fc\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\n% terraform apply\n\nMongoDB Cloud Manager\u306eDeployment \u2192 SERVERS \u2192 tile\u30dc\u30bf\u30f3\u306b\u4f5c\u6210\u3057\u305fMMS Agent\u304c\u767b\u9332\u3055\u308c\u3066\u3044\u308c\u3070OK\u3067\u3059\u3002\n\nMongoDB Cloud Manager API\u3067\u4f5c\u6210\nMongoDB Cloud Manager\u3067\u30dd\u30c1\u30dd\u30c1\u3084\u3063\u3066\u3082\u826f\u3044\u306e\u3067\u3059\u304c\u3001MMS API\u3067\u4eca\u56de\u306f\u3084\u3063\u3066\u307f\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\nMongoDB Cloud Manage Settings \u2192 Group Settings \u2192 Enable Public API \u3092YES\u306b\u3057\u307e\u3059\u3002\n\u304a\u306a\u3058\u304fMongoDB Cloud Manage Settings \u2192 Public API Access \u3088\u308aAPI Key\u3092Generate\u3057\u307e\u3059\u3002API Key\u306fPOST\u6642\u306b\u4f7f\u3046\u306e\u3067\u30e1\u30e2\u3063\u3066\u7f6e\u3044\u3066\u304f\u3060\u3055\u3044\u3002\u4ee5\u4e0b\u306e\u3088\u3046\u306bcurl\u30b3\u30de\u30f3\u30c9\u3067\u758e\u901a\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n% curl -u \"<user@example.net>:<api_key>\" --digest -i \"https://cloud.mongodb.com/api/public/v1.0?pretty=true\"\n\n\u3053\u306e\u74b0\u5883\u3060\u3068private_ip\u3092\u7d30\u304b\u304f\u5207\u3063\u3066\u306a\u3044\u306e\u3067MongoDB Cloud Manager\u5074\u3067\u3069\u308c\u304cmongod,mongoc,mongos\u306a\u306e\u304b\u5224\u5225\u3064\u304b\u306a\u3044\u3067\u3059\u306d\u3002\u3053\u3053\u3092\u81ea\u52d5\u3067\u3084\u308b\u826f\u3044\u65b9\u6cd5\u306a\u3044\u304b\u8003\u3048\u305f\u306e\u3067\u3059\u304c\u601d\u3044\u3064\u304b\u3093\u304b\u3063\u305f\u3067\u3059\u3002Tag Name\u306b\u306f\u7a2e\u5225\u304b\u3044\u3066\u3042\u308b\u306e\u3067awscli\u3067\u304c\u3070\u3063\u3068\u53d6\u3063\u3066\u304d\u3066\u3081\u3082\u3063\u3066shard.json\u306b\u53cd\u6620\u3057\u3066\u304f\u3060\u3055\u3044\u3002\u4f8b\u306b\u3088\u3063\u3066REPLACE\u3068\u66f8\u304b\u308c\u305f\u3068\u3053\u308d\u3068mongoc\u306ealias \u3092\u5909\u3048\u3066\u304f\u3060\u3055\u3044\u3002\n% aws ec2 describe-instances --profile umiyosh --filter \"Name=instance-state-name,Values=running\"| jq '.Reservations[].Instances[] | {PrivateDnsName,Tags }' -c\n\n% vi shard.json\n% curl -u \"<user@example.net>:<api_key>\" -H \"Content-Type: application/json\" \"https://cloud.mongodb.com/api/public/v1.0/groups/<group_id>/automationConfig\" --digest -i -X PUT --data @shard.json\n\nDeployment Pcocess\u3092\u898b\u308b\u3068\u30c7\u30d7\u30ed\u30a4\u3055\u308c\u3066\u3044\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\nshard\u78ba\u8a8d\n\uff12\u3064\u305f\u3066\u305fmongos\u306e\u3046\u3061\u3069\u3063\u3061\u304b\u306bssh\u3057\u3066DB\u3092\u4f5c\u3063\u3066 enablesharding\u3057\u305f\u308a\u3057\u3066\u5473\u898b\u3059\u308b\u3068\u826f\u3044\u3067\u3057\u3087\u3046\u3002\n% /var/lib/mongodb-mms-automation/mongodb-linux-x86_64-3.0.6/bin/mongo --host localhost --port 27000\n\n\n\u3053\u306e\u8a18\u4e8b\u306f\u3002[MongoDB Advent Calendar 2015 - Qiita](http://qiita.com/advent-calendar/2015/mongodb)\u306e\uff11\uff14\u65e5\u76ee\u306e\u8a18\u4e8b\u3067\u3059\u3002\n\u672c\u65e5\u500b\u4eba\u7684\u7406\u7531\u3067\u3078\u308d\u3078\u308d\u306a\u306e\u3067\u3059\u304c\u3001\u304c\u30fc\u3063\u3068\u66f8\u3044\u3066\u3044\u304d\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\u8077\u5834\u3067\u691c\u8a3c\u7528\u306eMongoDB\u74b0\u5883\u3092\u4f55\u5ea6\u304b\u4f5c\u3063\u3066\u3044\u305f\u306e\u3067\u3001\u305d\u308c\u3068\u4f3c\u305f\u624b\u9806\u3067MongoDB Cloud Manager\u3092\u4f7f\u3063\u3066AWS\u4e0a\u306b\u304a\u8a66\u3057MongoDB shard cluster\u3092\u4f5c\u308b\u624b\u9806\u3092\u66f8\u304d\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n## mms\u30a2\u30ab\u30a6\u30f3\u30c8\u4f5c\u6210\n\n[MongoDB Cloud Manager - Management Made Easy | MongoDB](https://www.mongodb.com/cloud)\u304b\u3089\u7121\u6599\u30a2\u30ab\u30a6\u30f3\u30c8\u4f5c\u6210\u3057\u307e\u3059\u3002\uff13\uff10\u65e5\u9593\u306e\u30c8\u30e9\u30a4\u30a2\u30eb\u30a2\u30ab\u30a6\u30f3\u30c8\u304c\u53d6\u5f97\u3067\u304d\u307e\u3059\u3002\n<code>Settings \u2192 Group Settings </code>\u3088\u308aGROUP ID\u3068AGENT API KEY\u3092\u30e1\u30e2\u3063\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\n\n## \u30ad\u30fc\u30da\u30a2\u306e\u4f5c\u6210\n\nec2\u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9\u3088\u308a\u30ad\u30fc\u30da\u30a2\u3092\u4f5c\u6210\u3057\u3001\u624b\u5143\u306e\u30d1\u30bd\u30b3\u30f3\u306e~/.ssh/\u3068~/.ssh/config\u306b\u63a5\u7d9a\u60c5\u5831\u3092\u6574\u3048\u3066\u304a\u304d\u307e\u3059\u3002\n\n## AMI\u3092\u4f5c\u308a\u306a\u304a\u3057\u3066ID\u57cb\u3081\u308b\n\n[MMS\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6e08\u306eAMI \u203b]()\u304b\u3089EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u4f5c\u3063\u3066\u3001\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306bssh\u3057<code>/etc/mongodb-mms/automation-agent.config</code> \u306eREPLACE\u3068\u3057\u3066\u3044\u308b\u7b87\u6240\u306b\u5148\u307b\u3069\u306eGROUP ID\u3068AGENT API KEY\u3092\u5165\u308c\u3066AMI\u518d\u4f5c\u6210\u3057\u3066\u304f\u3060\u3055\u3044\u3002ami-id\u306f\u30e1\u30e2\u3063\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\n\u203b\u307e\u306b\u3042\u308f\u305a\u3002\u5f8c\u307b\u3069\u516c\u958b\u3059\u308b\u304b\u3082\u3002\u3068\u3044\u3063\u3066\u3082mms\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u304c\u5165\u3063\u3066\u3044\u308b\u3060\u3051\u3067\u3059\u3002\n\n## access_key, secret\u6574\u3048\n\n\u3053\u308c\u304b\u3089\u4f5c\u6210\u3059\u308bAWS\u30a2\u30ab\u30a6\u30f3\u30c8\u306b\u3066IAM\u3088\u308a\u74b0\u5883\u69cb\u7bc9\u7528\u306bAdministratorAccess\u30dd\u30ea\u30b7\u30fc\u306a\u3069\u3092\u4ed8\u4e0e\u3057\u305f\u30e6\u30fc\u30b6\u3092\u4f5c\u6210\u3057awscli\u3084terraform\u304c\u4f7f\u3048\u308b\u3088\u3046\u306b<code>aws configure</code>\u3057\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\n\n## \u30c9\u30e1\u30a4\u30f3\u306e\u767b\u9332\n\nmms\u4e0a\u3067mongoc\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u969b\u3001CNAME\u304c\u5fc5\u9808\u306e\u305f\u3081\u3001\u3042\u3089\u304b\u3081\u30c9\u30e1\u30a4\u30f3\u767b\u9332\u304c\u3042\u308b\u3068\u826f\u3044\u3067\u3059\u3002\u4eca\u56de\u306fRoute53\u306e\u30ec\u30b8\u30b9\u30c8\u30e9\u3092\u4f7f\u3063\u3066umiyosh.com\u3068\u3044\u3046\u306e\u3092\u3067\u3063\u3061\u3042\u3052\u307e\u3057\u305f\u3002\u91d1\u304c\u3082\u3063\u305f\u3044\u306a\u3044\u306a\u3069\u306e\u5834\u5408\u306fGIP\u306a\u3069\u3067\u3082\u3060\u3044\u3058\u3087\u3076\u306a\u306f\u305a\u3067\u3059\uff08\u5f8c\u4ed8\u306e\u5909\u66f4\u304c\u3067\u304d\u306a\u3044\u306e\u3067\u69cb\u6210\u5909\u66f4\u306a\u3069\u3067\u304d\u306a\u3044\u306a\u3069\u306b\u306a\u3063\u305f\u308a\u3057\u307e\u3059\u306e\u3067\u307b\u3093\u3068\u304a\u8a66\u3057\u7248\u3068\u3044\u3046\u611f\u3058\u3067\u3059\uff09\u3002\n\n## terraform clone\u3057\u3066\u5fc5\u8981\u306a\u3068\u3053\u308d\u3092\u8ffd\u8a18\u3059\u308b\n\n\u3059\u3050\u52d5\u304d\u305d\u3046\u306aterraform\u3092\u3046\uff50\u3057\u305f\u306e\u3067\u305d\u308c\u3092clone\u3057\u3066\u304d\u307e\u3059\u3002\n\n``` bash\n% git clone https://github.com/umiyosh/mmsInstall.git \n% cd mmsInstall\n% vi variable.tf\n```\n\nvariable.tf\u3092\u66f8\u304d\u63db\u3048\u307e\u3059\u3002REPLACE\u3068\u3057\u3066\u3044\u308b<code>VPC ID</code>\u3084<code>ZONE ID</code>\u3084<code>hosted_zone</code>\u3084<code>SUBNET ID</code>\u3084<code>AMI ID(\u5148\u307b\u3069\u81ea\u5206\u3067\u3055\u304f\u305b\u3044\u3057\u305f\u3084\u3064)</code>\u306a\u3069\u3092\u66f8\u304d\u63db\u3048\u3066\u3044\u304d\u307e\u3059\u3002\n\n## terraform plan\n\nterraform\u64cd\u4f5c\u3059\u308b\u30ed\u30fc\u30ab\u30ebcli\u3067\u4ee5\u4e0b\u306e\u74b0\u5883\u5909\u6570\u3092export\u3057\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\n\n``` bash\n% export AWS_DEFAULT_REGION=ap-northeast-1\n% export AWS_SECRET_ACCESS_KEY=\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u30a2\u30af\u30bb\u30b9\u30ad\u30fc\u306b\u7f6e\u304d\u63db\u3048\u3066\u304f\u3060\u3055\u3044\n% export AWS_ACCESS_KEY_ID=\u30a2\u30af\u30bb\u30b9\u30ad\u30fc\u306b\u7f6e\u304d\u63db\u3048\u3066\u304f\u3060\u3055\u3044\n```\n\n\u4f5c\u6210\u3059\u308b\u307e\u3048\u306bplan\u3057AWS\u4e0a\u306b\u4f5c\u6210\u3055\u308c\u308b\u30ea\u30bd\u30fc\u30b9\u3092\u898b\u307e\u3057\u3087\u3046\u3002terraform\u306f\u521d\u671f\u69cb\u7bc9\u3059\u308b\u3060\u3051\u306a\u3089\u30e9\u30af\u3067\u3059\u304c\u64cd\u4f5c\u3092\u9593\u9055\u3046\u3068\u5927\u4e8b\u306a\u30ea\u30bd\u30fc\u30b9\u3092\u6d88\u3057\u305f\u308a\u306a\u3069\u3042\u308b\u306e\u3067\u306a\u306b\u3082\u306a\u3044AWS\u30a2\u30ab\u30a6\u30f3\u30c8\u3067\u3084\u308b\u306e\u304c\u826f\u3044\u3067\u3059\u3002\n\n``` bash\n% terraform plan --refresh=false\nThe Terraform execution plan has been generated and is shown below.\nResources are shown in alphabetical order for quick scanning. Green resources\nwill be created (or destroyed and then created if an existing resource\nexists), yellow resources are being changed in-place, and red resources\nwill be destroyed.\n\nNote: You didn't specify an \"-out\" parameter to save this plan, so when\n\"apply\" is called, Terraform can't guarantee this is what will execute.\n\n+ aws_iam_instance_profile.test_profile\n    arn:              \"\" => \"<computed>\"\n    create_date:      \"\" => \"<computed>\"\n<<\u7701\u7565>>\n```\n\n\u3053\u3093\u306a\u611f\u3058\u306e\u304c\u51fa\u3066\u304f\u308c\u3070OK\u3067\u3059\u3002\n\n## terraform apply\n\n\u5148\u306bIAM\u30ea\u30bd\u30fc\u30b9\u3092\u4f5c\u6210\u3057\u306a\u3044\u3068\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4f5c\u6210\u6642\u306bIAM profile\u304c\u5b58\u5728\u3057\u306a\u3044\u306e\u3067\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4f5c\u6210\u306b\u5931\u6557\u3059\u308b\u3068\u3044\u3046\u5fae\u5999\u554f\u984c\u304c\u3042\u308b\u307f\u305f\u3044\u306a\u306e\u3067<code>-target</code>\u3067IAM\u30ea\u30bd\u30fc\u30b9\u3092\u5148\u306b\u4f5c\u6210\u3057\u3066\u304a\u304d\u307e\u3059\u3002\u3042\u3068\u6709\u52b9\u306b\u306a\u308b\u306e\u306b\n\u3061\u3087\u3063\u3068\u6642\u9593\u3092\u7f6e\u304f\u5fc5\u8981\u304c\u3042\u308b\u306e\u3067\u6642\u9593\u3092\u304a\u304d\u307e\u3059\u3002\n\n``` bash\n% terraform plan -target=aws_iam_role.test_role -target=aws_iam_role_policy.test_policy -target=aws_iam_instance_profile.test_profile --refresh=false\n% terraform apply -target=aws_iam_role.test_role -target=aws_iam_role_policy.test_policy -target=aws_iam_instance_profile.test_profile\n```\n\napply\u3057\u30ea\u30bd\u30fc\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\n\n``` bash\n% terraform apply\n```\n\nMongoDB Cloud Manager\u306e<code>Deployment \u2192 SERVERS \u2192 tile\u30dc\u30bf\u30f3</code>\u306b\u4f5c\u6210\u3057\u305fMMS Agent\u304c\u767b\u9332\u3055\u308c\u3066\u3044\u308c\u3070OK\u3067\u3059\u3002\n\n## MongoDB Cloud Manager API\u3067\u4f5c\u6210\n\nMongoDB Cloud Manager\u3067\u30dd\u30c1\u30dd\u30c1\u3084\u3063\u3066\u3082\u826f\u3044\u306e\u3067\u3059\u304c\u3001MMS API\u3067\u4eca\u56de\u306f\u3084\u3063\u3066\u307f\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n<code>MongoDB Cloud Manage Settings \u2192 Group Settings \u2192 Enable Public API</code> \u3092<code>YES</code>\u306b\u3057\u307e\u3059\u3002\n\u304a\u306a\u3058\u304f<code>MongoDB Cloud Manage Settings \u2192 Public API Access</code> \u3088\u308aAPI Key\u3092Generate\u3057\u307e\u3059\u3002API Key\u306fPOST\u6642\u306b\u4f7f\u3046\u306e\u3067\u30e1\u30e2\u3063\u3066\u7f6e\u3044\u3066\u304f\u3060\u3055\u3044\u3002\u4ee5\u4e0b\u306e\u3088\u3046\u306bcurl\u30b3\u30de\u30f3\u30c9\u3067\u758e\u901a\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n``` bash\n% curl -u \"<user@example.net>:<api_key>\" --digest -i \"https://cloud.mongodb.com/api/public/v1.0?pretty=true\"\n```\n\n\u3053\u306e\u74b0\u5883\u3060\u3068private_ip\u3092\u7d30\u304b\u304f\u5207\u3063\u3066\u306a\u3044\u306e\u3067MongoDB Cloud Manager\u5074\u3067\u3069\u308c\u304cmongod,mongoc,mongos\u306a\u306e\u304b\u5224\u5225\u3064\u304b\u306a\u3044\u3067\u3059\u306d\u3002\u3053\u3053\u3092\u81ea\u52d5\u3067\u3084\u308b\u826f\u3044\u65b9\u6cd5\u306a\u3044\u304b\u8003\u3048\u305f\u306e\u3067\u3059\u304c\u601d\u3044\u3064\u304b\u3093\u304b\u3063\u305f\u3067\u3059\u3002Tag Name\u306b\u306f\u7a2e\u5225\u304b\u3044\u3066\u3042\u308b\u306e\u3067awscli\u3067\u304c\u3070\u3063\u3068\u53d6\u3063\u3066\u304d\u3066\u3081\u3082\u3063\u3066shard.json\u306b\u53cd\u6620\u3057\u3066\u304f\u3060\u3055\u3044\u3002\u4f8b\u306b\u3088\u3063\u3066REPLACE\u3068\u66f8\u304b\u308c\u305f\u3068\u3053\u308d\u3068mongoc\u306ealias \u3092\u5909\u3048\u3066\u304f\u3060\u3055\u3044\u3002\n\n``` bash\n% aws ec2 describe-instances --profile umiyosh --filter \"Name=instance-state-name,Values=running\"| jq '.Reservations[].Instances[] | {PrivateDnsName,Tags }' -c\n```\n\n``` bash\n% vi shard.json\n% curl -u \"<user@example.net>:<api_key>\" -H \"Content-Type: application/json\" \"https://cloud.mongodb.com/api/public/v1.0/groups/<group_id>/automationConfig\" --digest -i -X PUT --data @shard.json\n```\n\n<code>Deployment Pcocess</code>\u3092\u898b\u308b\u3068\u30c7\u30d7\u30ed\u30a4\u3055\u308c\u3066\u3044\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\n\n## shard\u78ba\u8a8d\n\n\uff12\u3064\u305f\u3066\u305fmongos\u306e\u3046\u3061\u3069\u3063\u3061\u304b\u306bssh\u3057\u3066DB\u3092\u4f5c\u3063\u3066 enablesharding\u3057\u305f\u308a\u3057\u3066\u5473\u898b\u3059\u308b\u3068\u826f\u3044\u3067\u3057\u3087\u3046\u3002\n\n``` bash\n% /var/lib/mongodb-mms-automation/mongodb-linux-x86_64-3.0.6/bin/mongo --host localhost --port 27000\n```\n", "tags": ["MMS", "Terraform", "MongoDB"]}