{"tags": ["MongoDB", "Go", "golang", "GIS", "OpenStreetMap"], "context": " More than 1 year has passed since last update.\u3053\u3093\u306b\u3061\u306f\u3002\nmongodb \u306b OpenStreetMap \u30c7\u30fc\u30bf\u3092\u53d6\u308a\u8fbc\u3093\u3067\u307f\u307e\u3057\u305f\u3002Go\u8a00\u8a9e\u306e goosm \uff08\u305d\u306e\u5185\u90e8\u3067\u306f mgo \u5229\u7528\uff09\u3092\u5229\u7528\u3057\u307e\u3057\u305f\u3002\u3061\u306a\u307f\u306bMacOSX\u3067homebrew\u5229\u7528\u3067\u3059\u3002\n\u30a4\u30f3\u30c7\u30c3\u30af\u30b9 {\"loc.coordinates\": \"2d\"} \u3092\u4ed8\u3051\u308b\u524d\u5f8c\u3067\u691c\u7d22\u901f\u5ea6\u306e\u5927\u5e45\u306a\u52b9\u679c\u3092\u4f53\u611f\u3057\u3066\u307f\u307e\u3057\u305f\u3002\u307e\u305f\u6307\u5b9a\u5186\u5185\u306e ways, nodes \u3092\u691c\u7d22\u3057\u5730\u56f3\u4e0a\u306b\u91cd\u306d\u3066\u307f\u307e\u3057\u305f\u3002\n\n\u306a\u304a OpenStreetMap \u30c7\u30fc\u30bf\u5185\u306e\u7570\u5e38(?)\u306b\u6c17\u304c\u3064\u3044\u305f\u306e\u3067\u3059\u304c\u3001\u7dda\u5206\u306e\u4e21\u7aef\u306e vertex \u304c\u540c\u4e00\u7d4c\u7def\u5ea6\u5024\u3092\u6301\u3063\u3066\u3044\u308b\u5834\u5408\uff08\u5f93\u3063\u3066\u70b9\u3078\u7e2e\u9000\uff09\u304c\u308f\u305a\u304b\u306b\u542b\u307e\u308c\u3066\u3044\u3066\u3001\u4f55\u304b\u5bfe\u7b56\u304c\u5fc5\u8981\u304b\u3068\u601d\u3044\u307e\u3059\u3002\n$ wget http://download.geofabrik.de/asia/japan-latest.osm.bz2\n$ go run goosm.go -f japan-latest.osm.bz2 -db osm\n   [6\u6642\u9593\u4ee5\u4e0a\u304b\u304b\u3063\u305f]\n\n$ mongo osm_ways\nMongoDB shell version: 3.0.1\nconnecting to: osm_ways\n> show dbs\nlocal        0.000GB\nosm_nodes    5.479GB\nosm_ways     1.816GB\n> show collections\ndata\n> db.data.ensureIndex({\"loc.coordinates\": \"2d\"})\n{\n    \"createdCollectionAutomatically\" : false,\n    \"numIndexesBefore\" : 2,\n    \"numIndexesAfter\" : 3,\n    \"ok\" : 1\n}\n> db.data.getIndexes()\n[\n    {\n        \"v\" : 1,\n        \"key\" : {\n            \"_id\" : 1\n        },\n        \"name\" : \"_id_\",\n        \"ns\" : \"osm_ways.data\"\n    },\n    {\n        \"v\" : 1,\n        \"key\" : {\n            \"loc\" : \"2dsphere\"\n        },\n        \"name\" : \"loc_2dsphere\",\n        \"ns\" : \"osm_ways.data\",\n        \"2dsphereIndexVersion\" : 2\n    },\n    {\n        \"v\" : 1,\n        \"key\" : {\n            \"loc.coordinates\" : \"2d\"\n        },\n        \"name\" : \"loc.coordinates_2d\",\n        \"ns\" : \"osm_ways.data\"\n    }\n]\n\n> db.data.find({\"loc\": { \"$near\": { \"$maxDistance\": 25.0, \"$geometry\": { \"type\": \"Point\", \"coordinates\": [139.710001, 35.690283] } } } , \"tags.name\": {\"$regex\": \"^\u82b1\"}}).count()\n2\n> db.data.find({\"loc.coordinates\" : { \"$geoWithin\" : { \"$centerSphere\" : [ [139.710001, 35.690283] , 0.00000392 ] } } , \"tags.name\": {\"$regex\": \"^\u82b1\"}}).count()\n2\n\n\u6ce8\uff1a0.00000392 radians = 25.0/6378137.0\n\u306a\u304a\u3001goosm.go \u306f *.osm.bz2 \u3092\u8aad\u307f\u8fbc\u3081\u308b\u3088\u3046\u306b\u5c11\u3057\u6539\u9020\u3002\nmongod \u306f\u524d\u3082\u3063\u3066\u624b\u52d5\u8d77\u52d5\u3057\u307e\u3057\u305f\u3002\n$ ulimit -n 2048 && mongod --config /usr/local/etc/mongod.conf &\n$ cat /usr/local/etc/mongod.conf\nsystemLog:\n  destination: file\n  path: /usr/local/var/log/mongodb/mongo.log\n  logAppend: true\nstorage:\n  dbPath: /usr/local/var/mongodb\n  engine: wiredTiger\nnet:\n  bindIp: 127.0.0.1\n  http:\n    enabled: true\n    RESTInterfaceEnabled: true\n\n\n\u306a\u304a\u3001mongodb \u3078\u306e\u53d6\u308a\u8fbc\u307f\u306b\u3064\u3044\u3066\u3001OSMImport (https://github.com/ederoyd46/OSMImport) \u3068\u3044\u3046\u3082\u306e\u3082\u3042\u308b\u3088\u3046\u3067\u3059\u306d\u3002\u307b\u304b\u306b\u3082\u60c5\u5831\u304c\u3042\u308b\u3088\u3046\u3067\u3059\uff08http://wiki.openstreetmap.org/wiki/Databases_and_data_access_APIs \uff09\u3002\n\u3053\u3093\u306b\u3061\u306f\u3002\nmongodb \u306b OpenStreetMap \u30c7\u30fc\u30bf\u3092\u53d6\u308a\u8fbc\u3093\u3067\u307f\u307e\u3057\u305f\u3002Go\u8a00\u8a9e\u306e [goosm] (https://github.com/bocajim/goosm) \uff08\u305d\u306e\u5185\u90e8\u3067\u306f [mgo](https://labix.org/mgo) \u5229\u7528\uff09\u3092\u5229\u7528\u3057\u307e\u3057\u305f\u3002\u3061\u306a\u307f\u306bMacOSX\u3067homebrew\u5229\u7528\u3067\u3059\u3002\n\u30a4\u30f3\u30c7\u30c3\u30af\u30b9 {\"loc.coordinates\": \"2d\"} \u3092\u4ed8\u3051\u308b\u524d\u5f8c\u3067\u691c\u7d22\u901f\u5ea6\u306e\u5927\u5e45\u306a\u52b9\u679c\u3092\u4f53\u611f\u3057\u3066\u307f\u307e\u3057\u305f\u3002\u307e\u305f\u6307\u5b9a\u5186\u5185\u306e ways, nodes \u3092\u691c\u7d22\u3057\u5730\u56f3\u4e0a\u306b\u91cd\u306d\u3066\u307f\u307e\u3057\u305f\u3002\n![test.jpg](https://qiita-image-store.s3.amazonaws.com/0/54617/6f8ce706-627f-e249-3c3f-bc2ee89772df.jpeg)\n\n\u306a\u304a OpenStreetMap \u30c7\u30fc\u30bf\u5185\u306e\u7570\u5e38(?)\u306b\u6c17\u304c\u3064\u3044\u305f\u306e\u3067\u3059\u304c\u3001\u7dda\u5206\u306e\u4e21\u7aef\u306e vertex \u304c\u540c\u4e00\u7d4c\u7def\u5ea6\u5024\u3092\u6301\u3063\u3066\u3044\u308b\u5834\u5408\uff08\u5f93\u3063\u3066\u70b9\u3078\u7e2e\u9000\uff09\u304c\u308f\u305a\u304b\u306b\u542b\u307e\u308c\u3066\u3044\u3066\u3001\u4f55\u304b\u5bfe\u7b56\u304c\u5fc5\u8981\u304b\u3068\u601d\u3044\u307e\u3059\u3002\n\n```\n$ wget http://download.geofabrik.de/asia/japan-latest.osm.bz2\n$ go run goosm.go -f japan-latest.osm.bz2 -db osm\n   [6\u6642\u9593\u4ee5\u4e0a\u304b\u304b\u3063\u305f]\n\n$ mongo osm_ways\nMongoDB shell version: 3.0.1\nconnecting to: osm_ways\n> show dbs\nlocal        0.000GB\nosm_nodes    5.479GB\nosm_ways     1.816GB\n> show collections\ndata\n> db.data.ensureIndex({\"loc.coordinates\": \"2d\"})\n{\n\t\"createdCollectionAutomatically\" : false,\n\t\"numIndexesBefore\" : 2,\n\t\"numIndexesAfter\" : 3,\n\t\"ok\" : 1\n}\n> db.data.getIndexes()\n[\n\t{\n\t\t\"v\" : 1,\n\t\t\"key\" : {\n\t\t\t\"_id\" : 1\n\t\t},\n\t\t\"name\" : \"_id_\",\n\t\t\"ns\" : \"osm_ways.data\"\n\t},\n\t{\n\t\t\"v\" : 1,\n\t\t\"key\" : {\n\t\t\t\"loc\" : \"2dsphere\"\n\t\t},\n\t\t\"name\" : \"loc_2dsphere\",\n\t\t\"ns\" : \"osm_ways.data\",\n\t\t\"2dsphereIndexVersion\" : 2\n\t},\n\t{\n\t\t\"v\" : 1,\n\t\t\"key\" : {\n\t\t\t\"loc.coordinates\" : \"2d\"\n\t\t},\n\t\t\"name\" : \"loc.coordinates_2d\",\n\t\t\"ns\" : \"osm_ways.data\"\n\t}\n]\n\n> db.data.find({\"loc\": { \"$near\": { \"$maxDistance\": 25.0, \"$geometry\": { \"type\": \"Point\", \"coordinates\": [139.710001, 35.690283] } } } , \"tags.name\": {\"$regex\": \"^\u82b1\"}}).count()\n2\n> db.data.find({\"loc.coordinates\" : { \"$geoWithin\" : { \"$centerSphere\" : [ [139.710001, 35.690283] , 0.00000392 ] } } , \"tags.name\": {\"$regex\": \"^\u82b1\"}}).count()\n2\n```\n\n\u6ce8\uff1a```0.00000392 radians = 25.0/6378137.0```\n\u306a\u304a\u3001goosm.go \u306f *.osm.bz2 \u3092\u8aad\u307f\u8fbc\u3081\u308b\u3088\u3046\u306b\u5c11\u3057\u6539\u9020\u3002\n\n\nmongod \u306f\u524d\u3082\u3063\u3066\u624b\u52d5\u8d77\u52d5\u3057\u307e\u3057\u305f\u3002\n\n```\n$ ulimit -n 2048 && mongod --config /usr/local/etc/mongod.conf &\n$ cat /usr/local/etc/mongod.conf\nsystemLog:\n  destination: file\n  path: /usr/local/var/log/mongodb/mongo.log\n  logAppend: true\nstorage:\n  dbPath: /usr/local/var/mongodb\n  engine: wiredTiger\nnet:\n  bindIp: 127.0.0.1\n  http:\n    enabled: true\n    RESTInterfaceEnabled: true\n\n```\n\n\u306a\u304a\u3001mongodb \u3078\u306e\u53d6\u308a\u8fbc\u307f\u306b\u3064\u3044\u3066\u3001OSMImport (https://github.com/ederoyd46/OSMImport) \u3068\u3044\u3046\u3082\u306e\u3082\u3042\u308b\u3088\u3046\u3067\u3059\u306d\u3002\u307b\u304b\u306b\u3082\u60c5\u5831\u304c\u3042\u308b\u3088\u3046\u3067\u3059\uff08http://wiki.openstreetmap.org/wiki/Databases_and_data_access_APIs \uff09\u3002\n"}