{"context": "\n\n0 \u306f\u3058\u3081\u306b\nNFSv4\u306b\u3064\u3044\u3066\u601d\u3044\u3064\u3044\u305f\u3053\u3068\u3092\u3001\u305d\u306e\u307e\u307e\u66f8\u304d\u7559\u3081\u3066\u3044\u307e\u3059\u3002\n\n1 \u74b0\u5883\n\n\u30b2\u30b9\u30c8\u30de\u30b7\u30f3\u306f2\u53f0\u3002OS\u306fCentOS7.3\u3002\u30db\u30b9\u30c8\u540d\u306fmaster,node1\u3002\n\u30db\u30b9\u30c8\u306fVMware Workstation\nNFSv4\u3092\u4f7f\u3046\nNFS\u30de\u30a6\u30f3\u30c8\u30dd\u30a4\u30f3\u30c8\u306f2\u3064(/mnt1,/boot/mnt2)\u3002\u305d\u308c\u305e\u308c\u3001NFS\u30b5\u30fc\u30d0\u306e\u5225\u30c7\u30d0\u30a4\u30b9\u3092\u30de\u30a6\u30f3\u30c8\u3059\u308b\u3002\n\n\n    +--------- node1 --------+                          +---------- master -------+\n    |                        |.20                    .10|                         |\n    |       NFS client     eth0 --- 192.168.0.0/24 --- eth0      NFS server       |\n    |      (CentOS7.3)       |                          |       (CentOS7.3)       |\n    |                        |                          |                         |\n    |         /mnt1        <--------- NFSv4 mount -------- /mnt1      (/dev/sda3) |\n    |         /boot/mnt2   <--------- NFSv4 mount -------- /boot/mnt2 (/dev/sda1) |\n    |                        |                          |                         |\n    +------------------------+                          +-------------------------+\n\n\n\n\n2 \u8a2d\u5b9a&\u8d77\u52d5\u65b9\u6cd5\n\n2.1 NFS\u30b5\u30fc\u30d0\nnfs-utils\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n[root@master ~]# yum -y install nfs-utils\n\nexports\u30d5\u30a1\u30a4\u30eb\u3092\u7de8\u96c6\u3059\u308b\u3002\n[root@master ~]# vi /etc/exports\n[root@master ~]# cat /etc/exports\n/mnt1 *(rw,no_root_squash)\n/boot/mnt2 *(rw,no_root_squash)\n\nNFS\u30b5\u30fc\u30d0\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u3059\u308b\u3002\n[root@master ~]# exportfs -a\n[root@master ~]# exportfs -s\n/mnt1  *(rw,wdelay,no_root_squash,no_subtree_check,sec=sys,rw,no_root_squash,no_all_squash)\n/boot/mnt2  *(rw,wdelay,no_root_squash,no_subtree_check,sec=sys,rw,no_root_squash,no_all_squash)\n[root@master ~]#\n\nNFS\u30b5\u30fc\u30d0\u3092\u6709\u52b9(OS\u8d77\u52d5\u6642\u306b\u81ea\u52d5\u7684\u306b\u8d77\u52d5)\u306b\u3059\u308b\u3002\n[root@master ~]# systemctl enable nfs-server\nCreated symlink from /etc/systemd/system/multi-user.target.wants/nfs-server.service to /usr/lib/systemd/system/nfs-server.service.\n\nNFS\u30b5\u30fc\u30d0\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master ~]# systemctl start nfs-server\n\n\nNFSv4\u304c\u4f7f\u3046\u30dd\u30fc\u30c8\u756a\u53f7\u306b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u3002\nroot@master ~]# firewall-cmd --add-port=2049/tcp\nsuccess\n[root@master ~]# firewall-cmd --runtime-to-permanent\nsuccess\n[root@master ~]# firewall-cmd --list-ports\n2049/tcp\n\n\n\n2.2 NFS\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\nnfs-utils\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n[root@node1 ~]# yum -y install nfs-utils\n\nfstab\u3092\u7de8\u96c6\u3059\u308b\u3002\n[root@node1 ~]# vi /etc/fstab\n[root@node1 ~]# cat /etc/fstab\n-\u4e2d\u7565-\nmaster:/mnt1       /mnt1       nfs  defaults  0 0\nmaster:/boot/mnt2  /boot/mnt2  nfs  defaults  0 0\n\nNFSv4\u304c\u4f7f\u3046\u30dd\u30fc\u30c8\u756a\u53f7\u306b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u3002\n[root@node1 ~]# firewall-cmd --add-port=2049/tcp\n[root@node1 ~]# firewall-cmd --runtime-to-permanent\n[root@node1 ~]# firewall-cmd --list-ports\n2049/tcp\n\nNFS\u30de\u30a6\u30f3\u30c8\u3092\u3059\u308b\u3002\n[root@node1 ~]# mount -a\n\n\u30de\u30a6\u30f3\u30c8\u3057\u305fNFS\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3092\u78ba\u8a8d\u3059\u308b(\u2605\u5370)\u3002\n[root@node1 ~]# df -h\n\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9      \u30b5\u30a4\u30ba  \u4f7f\u7528  \u6b8b\u308a \u4f7f\u7528% \u30de\u30a6\u30f3\u30c8\u4f4d\u7f6e\n/dev/sda3            40G  2.5G   37G    7% /\ndevtmpfs            227M     0  227M    0% /dev\ntmpfs               237M     0  237M    0% /dev/shm\ntmpfs               237M   13M  224M    6% /run\ntmpfs               237M     0  237M    0% /sys/fs/cgroup\n/dev/sda1           509M  109M  400M   22% /boot\ntmpfs                48M     0   48M    0% /run/user/0\nmaster:/mnt1         40G  2.6G   37G    7% /mnt1\u3000\u2605\nmaster:/boot/mnt2   509M   92M  418M   18% /boot/mnt2 \u2605\n\n\n\n3 \u30c7\u30d0\u30c3\u30b0\u60c5\u5831\u306e\u51fa\u529b\u65b9\u6cd5(rpcdebug)\nrpcdebug\u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u3046\u3068\u3001NFS\u3084RPC\u304c\u51fa\u529b\u3059\u308b\u30c7\u30d0\u30c3\u30b0\u7528\u30ab\u30fc\u30cd\u30eb\u30e1\u30c3\u30bb\u30fc\u30b8\u3092syslog\u306b\u51fa\u529b\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\n3.1 nfs\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u30c7\u30d0\u30c3\u30b0\u60c5\u5831\u51fa\u529b\nnfs\u306e\u30ab\u30fc\u30cd\u30eb\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u51fa\u529b\u3059\u308b\u3002(NFS\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u3067\u884c\u3046)\u3002\n\u30d5\u30e9\u30b0(-s)\u306f\u5168\u3066(all)\u3092\u9078\u629e\u3057\u305f\u3002\u30d5\u30e9\u30b0\u306f\u3088\u308a\u9650\u5b9a\u3057\u305f\u7bc4\u56f2\u3092\u6307\u5b9a\u3059\u308b\u3068\u304d\u306b\u4f7f\u3046\u3002\n[root@node1 tools]# rpcdebug -m nfs -s all\nnfs        vfs dircache lookupcache pagecache proc xdr file root callback client mount fscache pnfs pnfs_ld state\n[root@node1 tools]#\n\nNFS\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u4e0a\u306b\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@node1 mnt1]# touch bb\n\n\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3092\u3072\u3089\u3044\u3066\u30ed\u30b0\u3092\u78ba\u8a8d\u3059\u308b(NFS\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u3067\u884c\u3046)\n[root@node1 ~]# tail -f /var/log/messages\nMar  9 20:16:42 node1 kernel: NFS: permission(0:40/101162651), mask=0x81, res=0\nMar  9 20:16:42 node1 kernel: NFS: permission(0:40/101162651), mask=0x3, res=0\nMar  9 20:16:42 node1 kernel: NFS: atomic_open(0:40/101162651), bb\nMar  9 20:16:42 node1 kernel: --> nfs_put_client({3})\nMar  9 20:16:42 node1 kernel: --> nfs4_alloc_slot used_slots=0000 highest_used=4294967295 max_slots=1024\nMar  9 20:16:42 node1 kernel: <-- nfs4_alloc_slot used_slots=0001 highest_used=0 slotid=0\n-\u4ee5\u4e0b\u3001\u7565-\n\nnfs\u306e\u30c7\u30d0\u30c3\u30b0\u60c5\u5831\u51fa\u529b\u3092\u505c\u6b62\u3059\u308b\u3002\n[root@node1 ~]# rpcdebug -m nfs -c all\nnfs       <no flags set>\n\n\nnfs\u306e\u4e2d\u306evfs\u30d5\u30e9\u30b0\u3092\u3082\u3064\u3082\u306e\u3060\u3051\u3001\u30ab\u30fc\u30cd\u30eb\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u51fa\u529b\u3059\u308b\u3002\n[root@node1 ~]# rpcdebug -m nfs -s vfs\nnfs        vfs\n\n\u8a2d\u5b9a\u3092\u89e3\u9664\u3059\u308b\u3002\n[root@node1 ~]# rpcdebug -m nfs -c vfs\nnfs       <no flags set>\n\n\n\n3.2 RPC\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u30c7\u30d0\u30c3\u30b0\u60c5\u5831\u51fa\u529b\nRPC\u306e\u30ab\u30fc\u30cd\u30eb\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u51fa\u529b\u3059\u308b\u3002(NFS\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u3067\u884c\u3046)\n[root@node1 ~]# rpcdebug -m rpc -s all\nrpc        xprt call debug nfs auth bind sched trans svcsock svcdsp misc cache\n\nNFS\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u4e0a\u306b\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@node1 mnt1]# touch aa\n\n\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3092\u3072\u3089\u3044\u3066\u30ed\u30b0\u3092\u78ba\u8a8d\u3059\u308b\u3002(NFS\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u3067\u884c\u3046)\n[root@node1 ~]# tail -f /var/log/messages\nMar  9 20:27:15 node1 kernel: RPC:       looking up Generic cred\nMar  9 20:27:15 node1 kernel: RPC:       looking up Generic cred\nMar  9 20:27:15 node1 kernel: RPC:       new task initialized, procpid 2026\nMar  9 20:27:15 node1 kernel: RPC:       allocated task ffff88001059f900\nMar  9 20:27:15 node1 kernel: RPC:   465 __rpc_execute flags=0x4081\nMar  9 20:27:15 node1 kernel: RPC:   465 call_start nfs4 proc OPEN (async)\nMar  9 20:27:15 node1 kernel: RPC:   465 call_reserve (status 0)\nMar  9 20:27:15 node1 kernel: RPC:   465 reserved req ffff88000ea02a00 xid c33f8ead\nMar  9 20:27:15 node1 kernel: RPC:       wake_up_first(ffff88000c5e9190 \"xprt_sending\")\nMar  9 20:27:15 node1 kernel: RPC:   465 call_reserveresult (status 0)\nMar  9 20:27:15 node1 kernel: RPC:   465 call_refresh (status 0)\n-\u4ee5\u4e0b\u3001\u7565-\n\nRPC\u306e\u30c7\u30d0\u30c3\u30b0\u60c5\u5831\u51fa\u529b\u3092\u505c\u6b62\u3059\u308b\u3002\n[root@node1 ~]# rpcdebug -m rpc -c all\nrpc       <no flags set>\n\n\n\n3.2 \u305d\u306e\u4ed6\u30e2\u30b8\u30e5\u30fc\u30eb\u3068\u30d5\u30e9\u30b0\u4e00\u89a7\n\u4ed6\u306b\u4f7f\u3048\u308b\u30e2\u30b8\u30e5\u30fc\u30eb\u3068\u30d5\u30e9\u30b0\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3067\u3059\u3002\n[root@node1 ~]# rpcdebug -vh\nusage: rpcdebug [-v] [-h] [-m module] [-s flags...|-c flags...]\n       set or cancel debug flags.\n\nModule     Valid flags\nrpc        xprt call debug nfs auth bind sched trans svcsock svcdsp misc cache all\nnfs        vfs dircache lookupcache pagecache proc xdr file root callback client mount fscache pnfs pnfs_ld state all\nnfsd       sock fh export svc proc fileop auth repcache xdr lockd all\nnlm        svc client clntlock svclock monitor clntsubs svcsubs hostcache xdr all\n\n\n\n4 NFS\u304c\u51fa\u529b\u3059\u308b\u30c7\u30d0\u30c3\u30b0\u60c5\u5831\u306e\u610f\u5473\n\u4e0b\u8a182\u3064\u306b\u3064\u3044\u3066\u8abf\u3079\u305f\u3002xxxxxx\u306fi\u30ce\u30fc\u30c9\u756a\u53f7\u3002i\u30ce\u30fc\u30c9\u756a\u53f7\u306fNFS\u30b5\u30fc\u30d0\u4e0a\u306e\u30d5\u30a1\u30a4\u30eb\u306einode\u756a\u53f7\u3067\u3042\u308b\u3002Y:ZZ\u306f\u8abf\u67fb\u4e2d\u3002\n- decode_attr_fileid: fileid=xxxxxx\n- nfs_fhget(Y:ZZ/xxxxxx fh_crc=0xc3d25c2d ct=1)\n-----------------------------------\n1. /mnt1(/dev/sda3) \u3067\u306e\u5b9f\u9a13\n-----------------------------------\n\n\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u3057\u3066\u3044\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master mnt1]# exportfs\n/mnt1           <world>\n/boot/mnt2      <world>\n\n/mnt1\u914d\u4e0b\u306b\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master mnt1]# pwd\n/mnt1\n[root@master mnt1]# touch aa\n[root@master mnt1]# touch bb\n\ni\u30ce\u30fc\u30c9\u756a\u53f7\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master mnt1]# ls -li\n\u5408\u8a08 0\n101162652 -rw-r--r--. 1 root root 0  3\u6708  9 21:18 aa\n101162654 -rw-r--r--. 1 root root 0  3\u6708  9 21:18 bb\n\nNFS\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u30c7\u30d0\u30c3\u30b0\u60c5\u5831\u3092\u51fa\u529b\u3059\u308b\u3002\n[root@node1 ~]# rpcdebug -m nfs -s all\nnfs        vfs dircache lookupcache pagecache proc xdr file root callback client mount fscache pnfs pnfs_ld state\n\nNFS\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u4e0a\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u30ea\u30fc\u30c9\u3059\u308b\u3002\n[root@node1 mnt1]# pwd\n/mnt1\n\naa\u3092\u30ea\u30fc\u30c9\u3059\u308b\u3002\n[root@node1 mnt1]# cat aa\n\n\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3092\u958b\u3044\u3066\u3001\u51fa\u529b\u3055\u308c\u308b\u30ed\u30b0\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@node1 ~]# tail -f /var/log/messages |grep -e 101162652 -e 101162654\nMar  9 21:23:14 node1 kernel: decode_attr_fileid: fileid=101162652\nMar  9 21:23:14 node1 kernel: decode_attr_mounted_on_fileid: fileid=101162652\nMar  9 21:23:14 node1 kernel: NFS: nfs_update_inode(0:40/101162652 fh_crc=0x1b6e44e3 ct=3 info=0x427e7f)\nMar  9 21:23:14 node1 kernel: NFS: nfs_fhget(0:40/101162652 fh_crc=0x1b6e44e3 ct=3)\nMar  9 21:23:14 node1 kernel: NFS: nfs_update_inode(0:40/101162652 fh_crc=0x1b6e44e3 ct=2 info=0x26040)\n\n\u6b21\u306f\u3001bb\u3092\u30ea\u30fc\u30c9\u3059\u308b\u3002\n[root@node1 mnt1]# cat bb\n\n\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3092\u958b\u3044\u3066\u3001\u51fa\u529b\u3055\u308c\u308b\u30ed\u30b0\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@node1 ~]# tail -f /var/log/messages |grep -e 101162652 -e 101162654\nMar  9 21:24:47 node1 kernel: decode_attr_fileid: fileid=101162654\nMar  9 21:24:47 node1 kernel: decode_attr_mounted_on_fileid: fileid=101162654\nMar  9 21:24:47 node1 kernel: NFS: nfs_update_inode(0:40/101162654 fh_crc=0x37940a04 ct=3 info=0x427e7f)\nMar  9 21:24:47 node1 kernel: NFS: nfs_fhget(0:40/101162654 fh_crc=0x37940a04 ct=3)\nMar  9 21:24:47 node1 kernel: NFS: nfs_update_inode(0:40/101162654 fh_crc=0x37940a04 ct=2 info=0x26040)\n\n\n-----------------------------------\n2. /boot/mnt2 (/dev/sda1) \u3067\u306e\u5b9f\u9a13\n-----------------------------------\n[root@master mnt2]# pwd\n/boot/mnt2\n\n/boot/mnt2\u914d\u4e0b\u306b\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master mnt2]# touch cc\n[root@master mnt2]# touch dd\n\ni\u30ce\u30fc\u30c9\u756a\u53f7\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master mnt2]# ls -li\n\u5408\u8a08 0\n157630 -rw-r--r--. 1 root root 0  3\u6708  9 21:28 cc\n157631 -rw-r--r--. 1 root root 0  3\u6708  9 21:28 dd\n\n\n[root@node1 mnt2]# pwd\n/boot/mnt2\n\ncc\u3092\u30ea\u30fc\u30c9\u3059\u308b\u3002\n[root@node1 mnt2]# cat cc\n\n\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3092\u958b\u3044\u3066\u3001\u51fa\u529b\u3055\u308c\u308b\u30ed\u30b0\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@node1 ~]# tail -f /var/log/messages |grep -e 157630 -e 157631\nMar  9 21:30:49 node1 kernel: decode_attr_fileid: fileid=157630\nMar  9 21:30:49 node1 kernel: decode_attr_mounted_on_fileid: fileid=157630\nMar  9 21:30:49 node1 kernel: NFS: nfs_fhget(0:41/157630 fh_crc=0xfc7cedf4 ct=1)\nMar  9 21:30:49 node1 kernel: NFS: nfs_update_inode(0:41/157630 fh_crc=0xfc7cedf4 ct=2 info=0x26040)\n\n\u6b21\u306f\u3001dd\u3092\u30ea\u30fc\u30c9\u3059\u308b\u3002\n[root@node1 mnt2]# cat dd\n\n\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3092\u958b\u3044\u3066\u3001\u51fa\u529b\u3055\u308c\u308b\u30ed\u30b0\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@node1 ~]# tail -f /var/log/messages |grep -e 157630 -e 157631\nMar  9 21:31:57 node1 kernel: decode_attr_fileid: fileid=157631\nMar  9 21:31:57 node1 kernel: decode_attr_mounted_on_fileid: fileid=157631\nMar  9 21:31:57 node1 kernel: NFS: nfs_fhget(0:41/157631 fh_crc=0xc3d25c2d ct=1)\nMar  9 21:31:57 node1 kernel: NFS: nfs_update_inode(0:41/157631 fh_crc=0xc3d25c2d ct=2 info=0x26040)\n\n-----------------------------\n3. \u308f\u304b\u3063\u305f\u3053\u3068(\u30ed\u30b0\u306e\u610f\u5473)\n------------------------------\n(1) decode_attr_fileid: fileid=xxxxxx\n     xxxxx\u306fNFS\u30b5\u30fc\u30d0\u4e0a\u306e\u30d5\u30a1\u30a4\u30eb\u306ei\u30ce\u30fc\u30c9\u756a\u53f7\u3092\u3042\u3089\u308f\u3059\u3002\n\n(2) nfs_fhget(Y:ZZ/xxxxxx fh_crc=0xc3d25c2d ct=1)\n     xxxxx : NFS\u30b5\u30fc\u30d0\u4e0a\u306e\u30d5\u30a1\u30a4\u30eb\u306ei\u30ce\u30fc\u30c9\u756a\u53f7\u3092\u3042\u3089\u308f\u3059\u3002\n     Y     : \n     Z     : \n\n\n#0 \u306f\u3058\u3081\u306b\nNFSv4\u306b\u3064\u3044\u3066\u601d\u3044\u3064\u3044\u305f\u3053\u3068\u3092\u3001\u305d\u306e\u307e\u307e\u66f8\u304d\u7559\u3081\u3066\u3044\u307e\u3059\u3002\n\n\n#1 \u74b0\u5883\n\n- \u30b2\u30b9\u30c8\u30de\u30b7\u30f3\u306f2\u53f0\u3002OS\u306fCentOS7.3\u3002\u30db\u30b9\u30c8\u540d\u306fmaster,node1\u3002\n- \u30db\u30b9\u30c8\u306fVMware Workstation\n- NFSv4\u3092\u4f7f\u3046\n- NFS\u30de\u30a6\u30f3\u30c8\u30dd\u30a4\u30f3\u30c8\u306f2\u3064(/mnt1,/boot/mnt2)\u3002\u305d\u308c\u305e\u308c\u3001NFS\u30b5\u30fc\u30d0\u306e\u5225\u30c7\u30d0\u30a4\u30b9\u3092\u30de\u30a6\u30f3\u30c8\u3059\u308b\u3002\n\n\n```\n\n    +--------- node1 --------+                          +---------- master -------+\n    |                        |.20                    .10|                         |\n    |       NFS client     eth0 --- 192.168.0.0/24 --- eth0      NFS server       |\n    |      (CentOS7.3)       |                          |       (CentOS7.3)       |\n    |                        |                          |                         |\n    |         /mnt1        <--------- NFSv4 mount -------- /mnt1      (/dev/sda3) |\n    |         /boot/mnt2   <--------- NFSv4 mount -------- /boot/mnt2 (/dev/sda1) |\n    |                        |                          |                         |\n    +------------------------+                          +-------------------------+\n\n\n```\n\n\n#2 \u8a2d\u5b9a&\u8d77\u52d5\u65b9\u6cd5\n##2.1 NFS\u30b5\u30fc\u30d0\n\n```\nnfs-utils\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n[root@master ~]# yum -y install nfs-utils\n\nexports\u30d5\u30a1\u30a4\u30eb\u3092\u7de8\u96c6\u3059\u308b\u3002\n[root@master ~]# vi /etc/exports\n[root@master ~]# cat /etc/exports\n/mnt1 *(rw,no_root_squash)\n/boot/mnt2 *(rw,no_root_squash)\n\nNFS\u30b5\u30fc\u30d0\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u3059\u308b\u3002\n[root@master ~]# exportfs -a\n[root@master ~]# exportfs -s\n/mnt1  *(rw,wdelay,no_root_squash,no_subtree_check,sec=sys,rw,no_root_squash,no_all_squash)\n/boot/mnt2  *(rw,wdelay,no_root_squash,no_subtree_check,sec=sys,rw,no_root_squash,no_all_squash)\n[root@master ~]#\n\nNFS\u30b5\u30fc\u30d0\u3092\u6709\u52b9(OS\u8d77\u52d5\u6642\u306b\u81ea\u52d5\u7684\u306b\u8d77\u52d5)\u306b\u3059\u308b\u3002\n[root@master ~]# systemctl enable nfs-server\nCreated symlink from /etc/systemd/system/multi-user.target.wants/nfs-server.service to /usr/lib/systemd/system/nfs-server.service.\n\nNFS\u30b5\u30fc\u30d0\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master ~]# systemctl start nfs-server\n\n\nNFSv4\u304c\u4f7f\u3046\u30dd\u30fc\u30c8\u756a\u53f7\u306b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u3002\nroot@master ~]# firewall-cmd --add-port=2049/tcp\nsuccess\n[root@master ~]# firewall-cmd --runtime-to-permanent\nsuccess\n[root@master ~]# firewall-cmd --list-ports\n2049/tcp\n\n```\n\n\n##2.2 NFS\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\n\n```\nnfs-utils\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n[root@node1 ~]# yum -y install nfs-utils\n\nfstab\u3092\u7de8\u96c6\u3059\u308b\u3002\n[root@node1 ~]# vi /etc/fstab\n[root@node1 ~]# cat /etc/fstab\n-\u4e2d\u7565-\nmaster:/mnt1       /mnt1       nfs  defaults  0 0\nmaster:/boot/mnt2  /boot/mnt2  nfs  defaults  0 0\n\nNFSv4\u304c\u4f7f\u3046\u30dd\u30fc\u30c8\u756a\u53f7\u306b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u3002\n[root@node1 ~]# firewall-cmd --add-port=2049/tcp\n[root@node1 ~]# firewall-cmd --runtime-to-permanent\n[root@node1 ~]# firewall-cmd --list-ports\n2049/tcp\n\nNFS\u30de\u30a6\u30f3\u30c8\u3092\u3059\u308b\u3002\n[root@node1 ~]# mount -a\n\n\u30de\u30a6\u30f3\u30c8\u3057\u305fNFS\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3092\u78ba\u8a8d\u3059\u308b(\u2605\u5370)\u3002\n[root@node1 ~]# df -h\n\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9      \u30b5\u30a4\u30ba  \u4f7f\u7528  \u6b8b\u308a \u4f7f\u7528% \u30de\u30a6\u30f3\u30c8\u4f4d\u7f6e\n/dev/sda3            40G  2.5G   37G    7% /\ndevtmpfs            227M     0  227M    0% /dev\ntmpfs               237M     0  237M    0% /dev/shm\ntmpfs               237M   13M  224M    6% /run\ntmpfs               237M     0  237M    0% /sys/fs/cgroup\n/dev/sda1           509M  109M  400M   22% /boot\ntmpfs                48M     0   48M    0% /run/user/0\nmaster:/mnt1         40G  2.6G   37G    7% /mnt1\u3000\u2605\nmaster:/boot/mnt2   509M   92M  418M   18% /boot/mnt2 \u2605\n\n```\n\n\n\n#3 \u30c7\u30d0\u30c3\u30b0\u60c5\u5831\u306e\u51fa\u529b\u65b9\u6cd5(rpcdebug)\nrpcdebug\u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u3046\u3068\u3001NFS\u3084RPC\u304c\u51fa\u529b\u3059\u308b\u30c7\u30d0\u30c3\u30b0\u7528\u30ab\u30fc\u30cd\u30eb\u30e1\u30c3\u30bb\u30fc\u30b8\u3092syslog\u306b\u51fa\u529b\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\n##3.1 nfs\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u30c7\u30d0\u30c3\u30b0\u60c5\u5831\u51fa\u529b\n```\nnfs\u306e\u30ab\u30fc\u30cd\u30eb\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u51fa\u529b\u3059\u308b\u3002(NFS\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u3067\u884c\u3046)\u3002\n\u30d5\u30e9\u30b0(-s)\u306f\u5168\u3066(all)\u3092\u9078\u629e\u3057\u305f\u3002\u30d5\u30e9\u30b0\u306f\u3088\u308a\u9650\u5b9a\u3057\u305f\u7bc4\u56f2\u3092\u6307\u5b9a\u3059\u308b\u3068\u304d\u306b\u4f7f\u3046\u3002\n[root@node1 tools]# rpcdebug -m nfs -s all\nnfs        vfs dircache lookupcache pagecache proc xdr file root callback client mount fscache pnfs pnfs_ld state\n[root@node1 tools]#\n\nNFS\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u4e0a\u306b\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@node1 mnt1]# touch bb\n\n\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3092\u3072\u3089\u3044\u3066\u30ed\u30b0\u3092\u78ba\u8a8d\u3059\u308b(NFS\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u3067\u884c\u3046)\n[root@node1 ~]# tail -f /var/log/messages\nMar  9 20:16:42 node1 kernel: NFS: permission(0:40/101162651), mask=0x81, res=0\nMar  9 20:16:42 node1 kernel: NFS: permission(0:40/101162651), mask=0x3, res=0\nMar  9 20:16:42 node1 kernel: NFS: atomic_open(0:40/101162651), bb\nMar  9 20:16:42 node1 kernel: --> nfs_put_client({3})\nMar  9 20:16:42 node1 kernel: --> nfs4_alloc_slot used_slots=0000 highest_used=4294967295 max_slots=1024\nMar  9 20:16:42 node1 kernel: <-- nfs4_alloc_slot used_slots=0001 highest_used=0 slotid=0\n-\u4ee5\u4e0b\u3001\u7565-\n\nnfs\u306e\u30c7\u30d0\u30c3\u30b0\u60c5\u5831\u51fa\u529b\u3092\u505c\u6b62\u3059\u308b\u3002\n[root@node1 ~]# rpcdebug -m nfs -c all\nnfs       <no flags set>\n\n\nnfs\u306e\u4e2d\u306evfs\u30d5\u30e9\u30b0\u3092\u3082\u3064\u3082\u306e\u3060\u3051\u3001\u30ab\u30fc\u30cd\u30eb\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u51fa\u529b\u3059\u308b\u3002\n[root@node1 ~]# rpcdebug -m nfs -s vfs\nnfs        vfs\n\n\u8a2d\u5b9a\u3092\u89e3\u9664\u3059\u308b\u3002\n[root@node1 ~]# rpcdebug -m nfs -c vfs\nnfs       <no flags set>\n\n```\n\n\n##3.2 RPC\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u30c7\u30d0\u30c3\u30b0\u60c5\u5831\u51fa\u529b\n\n```\nRPC\u306e\u30ab\u30fc\u30cd\u30eb\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u51fa\u529b\u3059\u308b\u3002(NFS\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u3067\u884c\u3046)\n[root@node1 ~]# rpcdebug -m rpc -s all\nrpc        xprt call debug nfs auth bind sched trans svcsock svcdsp misc cache\n\nNFS\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u4e0a\u306b\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@node1 mnt1]# touch aa\n\n\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3092\u3072\u3089\u3044\u3066\u30ed\u30b0\u3092\u78ba\u8a8d\u3059\u308b\u3002(NFS\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u3067\u884c\u3046)\n[root@node1 ~]# tail -f /var/log/messages\nMar  9 20:27:15 node1 kernel: RPC:       looking up Generic cred\nMar  9 20:27:15 node1 kernel: RPC:       looking up Generic cred\nMar  9 20:27:15 node1 kernel: RPC:       new task initialized, procpid 2026\nMar  9 20:27:15 node1 kernel: RPC:       allocated task ffff88001059f900\nMar  9 20:27:15 node1 kernel: RPC:   465 __rpc_execute flags=0x4081\nMar  9 20:27:15 node1 kernel: RPC:   465 call_start nfs4 proc OPEN (async)\nMar  9 20:27:15 node1 kernel: RPC:   465 call_reserve (status 0)\nMar  9 20:27:15 node1 kernel: RPC:   465 reserved req ffff88000ea02a00 xid c33f8ead\nMar  9 20:27:15 node1 kernel: RPC:       wake_up_first(ffff88000c5e9190 \"xprt_sending\")\nMar  9 20:27:15 node1 kernel: RPC:   465 call_reserveresult (status 0)\nMar  9 20:27:15 node1 kernel: RPC:   465 call_refresh (status 0)\n-\u4ee5\u4e0b\u3001\u7565-\n\nRPC\u306e\u30c7\u30d0\u30c3\u30b0\u60c5\u5831\u51fa\u529b\u3092\u505c\u6b62\u3059\u308b\u3002\n[root@node1 ~]# rpcdebug -m rpc -c all\nrpc       <no flags set>\n\n```\n\n\n##3.2 \u305d\u306e\u4ed6\u30e2\u30b8\u30e5\u30fc\u30eb\u3068\u30d5\u30e9\u30b0\u4e00\u89a7\n\u4ed6\u306b\u4f7f\u3048\u308b\u30e2\u30b8\u30e5\u30fc\u30eb\u3068\u30d5\u30e9\u30b0\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3067\u3059\u3002\n\n```\n[root@node1 ~]# rpcdebug -vh\nusage: rpcdebug [-v] [-h] [-m module] [-s flags...|-c flags...]\n       set or cancel debug flags.\n\nModule     Valid flags\nrpc        xprt call debug nfs auth bind sched trans svcsock svcdsp misc cache all\nnfs        vfs dircache lookupcache pagecache proc xdr file root callback client mount fscache pnfs pnfs_ld state all\nnfsd       sock fh export svc proc fileop auth repcache xdr lockd all\nnlm        svc client clntlock svclock monitor clntsubs svcsubs hostcache xdr all\n\n```\n\n\n#4 NFS\u304c\u51fa\u529b\u3059\u308b\u30c7\u30d0\u30c3\u30b0\u60c5\u5831\u306e\u610f\u5473\n\u4e0b\u8a182\u3064\u306b\u3064\u3044\u3066\u8abf\u3079\u305f\u3002xxxxxx\u306fi\u30ce\u30fc\u30c9\u756a\u53f7\u3002i\u30ce\u30fc\u30c9\u756a\u53f7\u306fNFS\u30b5\u30fc\u30d0\u4e0a\u306e\u30d5\u30a1\u30a4\u30eb\u306einode\u756a\u53f7\u3067\u3042\u308b\u3002Y:ZZ\u306f\u8abf\u67fb\u4e2d\u3002\n- decode_attr_fileid: fileid=xxxxxx\n- nfs_fhget(Y:ZZ/xxxxxx fh_crc=0xc3d25c2d ct=1)\n\n```\n-----------------------------------\n1. /mnt1(/dev/sda3) \u3067\u306e\u5b9f\u9a13\n-----------------------------------\n\n\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u3057\u3066\u3044\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master mnt1]# exportfs\n/mnt1           <world>\n/boot/mnt2      <world>\n\n/mnt1\u914d\u4e0b\u306b\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master mnt1]# pwd\n/mnt1\n[root@master mnt1]# touch aa\n[root@master mnt1]# touch bb\n\ni\u30ce\u30fc\u30c9\u756a\u53f7\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master mnt1]# ls -li\n\u5408\u8a08 0\n101162652 -rw-r--r--. 1 root root 0  3\u6708  9 21:18 aa\n101162654 -rw-r--r--. 1 root root 0  3\u6708  9 21:18 bb\n\nNFS\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u30c7\u30d0\u30c3\u30b0\u60c5\u5831\u3092\u51fa\u529b\u3059\u308b\u3002\n[root@node1 ~]# rpcdebug -m nfs -s all\nnfs        vfs dircache lookupcache pagecache proc xdr file root callback client mount fscache pnfs pnfs_ld state\n\nNFS\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u4e0a\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u30ea\u30fc\u30c9\u3059\u308b\u3002\n[root@node1 mnt1]# pwd\n/mnt1\n\naa\u3092\u30ea\u30fc\u30c9\u3059\u308b\u3002\n[root@node1 mnt1]# cat aa\n\n\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3092\u958b\u3044\u3066\u3001\u51fa\u529b\u3055\u308c\u308b\u30ed\u30b0\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@node1 ~]# tail -f /var/log/messages |grep -e 101162652 -e 101162654\nMar  9 21:23:14 node1 kernel: decode_attr_fileid: fileid=101162652\nMar  9 21:23:14 node1 kernel: decode_attr_mounted_on_fileid: fileid=101162652\nMar  9 21:23:14 node1 kernel: NFS: nfs_update_inode(0:40/101162652 fh_crc=0x1b6e44e3 ct=3 info=0x427e7f)\nMar  9 21:23:14 node1 kernel: NFS: nfs_fhget(0:40/101162652 fh_crc=0x1b6e44e3 ct=3)\nMar  9 21:23:14 node1 kernel: NFS: nfs_update_inode(0:40/101162652 fh_crc=0x1b6e44e3 ct=2 info=0x26040)\n\n\u6b21\u306f\u3001bb\u3092\u30ea\u30fc\u30c9\u3059\u308b\u3002\n[root@node1 mnt1]# cat bb\n\n\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3092\u958b\u3044\u3066\u3001\u51fa\u529b\u3055\u308c\u308b\u30ed\u30b0\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@node1 ~]# tail -f /var/log/messages |grep -e 101162652 -e 101162654\nMar  9 21:24:47 node1 kernel: decode_attr_fileid: fileid=101162654\nMar  9 21:24:47 node1 kernel: decode_attr_mounted_on_fileid: fileid=101162654\nMar  9 21:24:47 node1 kernel: NFS: nfs_update_inode(0:40/101162654 fh_crc=0x37940a04 ct=3 info=0x427e7f)\nMar  9 21:24:47 node1 kernel: NFS: nfs_fhget(0:40/101162654 fh_crc=0x37940a04 ct=3)\nMar  9 21:24:47 node1 kernel: NFS: nfs_update_inode(0:40/101162654 fh_crc=0x37940a04 ct=2 info=0x26040)\n\n\n-----------------------------------\n2. /boot/mnt2 (/dev/sda1) \u3067\u306e\u5b9f\u9a13\n-----------------------------------\n[root@master mnt2]# pwd\n/boot/mnt2\n\n/boot/mnt2\u914d\u4e0b\u306b\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master mnt2]# touch cc\n[root@master mnt2]# touch dd\n\ni\u30ce\u30fc\u30c9\u756a\u53f7\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master mnt2]# ls -li\n\u5408\u8a08 0\n157630 -rw-r--r--. 1 root root 0  3\u6708  9 21:28 cc\n157631 -rw-r--r--. 1 root root 0  3\u6708  9 21:28 dd\n\n\n[root@node1 mnt2]# pwd\n/boot/mnt2\n\ncc\u3092\u30ea\u30fc\u30c9\u3059\u308b\u3002\n[root@node1 mnt2]# cat cc\n\n\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3092\u958b\u3044\u3066\u3001\u51fa\u529b\u3055\u308c\u308b\u30ed\u30b0\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@node1 ~]# tail -f /var/log/messages |grep -e 157630 -e 157631\nMar  9 21:30:49 node1 kernel: decode_attr_fileid: fileid=157630\nMar  9 21:30:49 node1 kernel: decode_attr_mounted_on_fileid: fileid=157630\nMar  9 21:30:49 node1 kernel: NFS: nfs_fhget(0:41/157630 fh_crc=0xfc7cedf4 ct=1)\nMar  9 21:30:49 node1 kernel: NFS: nfs_update_inode(0:41/157630 fh_crc=0xfc7cedf4 ct=2 info=0x26040)\n\n\u6b21\u306f\u3001dd\u3092\u30ea\u30fc\u30c9\u3059\u308b\u3002\n[root@node1 mnt2]# cat dd\n\n\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3092\u958b\u3044\u3066\u3001\u51fa\u529b\u3055\u308c\u308b\u30ed\u30b0\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@node1 ~]# tail -f /var/log/messages |grep -e 157630 -e 157631\nMar  9 21:31:57 node1 kernel: decode_attr_fileid: fileid=157631\nMar  9 21:31:57 node1 kernel: decode_attr_mounted_on_fileid: fileid=157631\nMar  9 21:31:57 node1 kernel: NFS: nfs_fhget(0:41/157631 fh_crc=0xc3d25c2d ct=1)\nMar  9 21:31:57 node1 kernel: NFS: nfs_update_inode(0:41/157631 fh_crc=0xc3d25c2d ct=2 info=0x26040)\n\n-----------------------------\n3. \u308f\u304b\u3063\u305f\u3053\u3068(\u30ed\u30b0\u306e\u610f\u5473)\n------------------------------\n(1) decode_attr_fileid: fileid=xxxxxx\n     xxxxx\u306fNFS\u30b5\u30fc\u30d0\u4e0a\u306e\u30d5\u30a1\u30a4\u30eb\u306ei\u30ce\u30fc\u30c9\u756a\u53f7\u3092\u3042\u3089\u308f\u3059\u3002\n\n(2) nfs_fhget(Y:ZZ/xxxxxx fh_crc=0xc3d25c2d ct=1)\n     xxxxx : NFS\u30b5\u30fc\u30d0\u4e0a\u306e\u30d5\u30a1\u30a4\u30eb\u306ei\u30ce\u30fc\u30c9\u756a\u53f7\u3092\u3042\u3089\u308f\u3059\u3002\n     Y     : \n     Z     : \n\n```\n\n\n\n\n\n\n", "tags": ["centos7", "nfsv4", "nfs"]}