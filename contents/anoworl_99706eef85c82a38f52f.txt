{"context": " More than 1 year has passed since last update.\n\n\u306f\u3058\u3081\u306b\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u63a5\u7d9a\u60c5\u5831\u306a\u3069\u306f\u3001\u30d9\u30bf\u66f8\u304d\u3067\u306f\u7121\u304f\u74b0\u5883\u5909\u6570\u3092\u901a\u3058\u3066\u53d6\u308a\u6271\u3063\u305f\u65b9\u304c\u53d6\u308a\u56de\u3057\u304c\u826f\u3044\u6c17\u304c\u3057\u307e\u3059\u3002\n\nconfig/database.yml\nproduction:\n  url: <%= ENV['DATABASE_URL'] %>\n\n\ndotenv\u3092\u4f7f\u3048\u3070Rails\u306eenvironment\u3054\u3068\u306b\u74b0\u5883\u5909\u6570\u3092\u5206\u3051\u308b\u3053\u3068\u304c\u51fa\u6765\u3001\u66f4\u306b\u4fbf\u5229\u611f\u3042\u308a\u307e\u3059\u3002\n\n.env.production\nDATABASE_URL=mysql2://user:password@db.example.com/database\n\n\n\u3058\u3083\u3042\u3001\u3053\u306e\u30d5\u30a1\u30a4\u30eb\u306e\u53d6\u308a\u6271\u3044\u306f\u3069\u3046\u3057\u307e\u3057\u3087\u3046\uff1f\u305d\u306e\u307e\u307e\u30ea\u30dd\u30b8\u30c8\u30ea\u306b\u30d7\u30c3\u30b7\u30e5\u3059\u308b\uff1f\n\u6700\u91cd\u8981\u6a5f\u5bc6\u306a\u306e\u3067\u30d7\u30c3\u30b7\u30e5\u3059\u308b\u306e\u306f\u6016\u3044\u3067\u3059\u3002\n\u3067\u306f\u30b5\u30fc\u30d0\u306b\u76f4\u63a5\u7f6e\u3044\u3068\u304f\uff1f\n\u3044\u3084\u3001\u74b0\u5883\u5909\u6570\u3060\u3063\u3066\u5909\u66f4\u3057\u305f\u3044\u6642\u304c\u3042\u308a\u307e\u3059\u3002\u305d\u306e\u6642\u306b\u30b5\u30fc\u30d0\u306b\u5165\u3063\u3066\u66f4\u65b0\u3059\u308b\u306e\u306f\u9762\u5012\u3067\u30591\u3002\n\u3068\u3044\u3046\u3053\u3068\u3067\u3001\u3053\u3053\u3067\u306fdotenv\u30d5\u30a1\u30a4\u30eb\u3092\u6697\u53f7\u5316\u3057\u305f\u3082\u306e\u3092\u30ea\u30dd\u30b8\u30c8\u30ea\u306b\u30d7\u30c3\u30b7\u30e5\u3059\u308b\u3068\u5171\u306b\u3001\u305d\u306e\u9375\u3092\u30b5\u30fc\u30d0\u306b\u7f6e\u3044\u3066\u304a\u304d\u3001\u30c7\u30d7\u30ed\u30a4\u6642\u306b\u30b5\u30fc\u30d0\u306e\u65b9\u3067\u5fa9\u53f7\u5316\u304a\u3088\u3073\u74b0\u5883\u5909\u6570\u306e\u53cd\u6620\u3092\u884c\u3046\u65b9\u6cd5\u3092\u793a\u3057\u307e\u3059\u3002\n\n\u7528\u610f\u3059\u308b\u3082\u306e\n\ndotenv gem (\u74b0\u5883\u5909\u6570\u53cd\u6620)\ngibberish gem (\u6697\u53f7\u5316, \u5fa9\u53f7\u5316)\ncapistrano gem (\u30c7\u30d7\u30ed\u30a4)\n\n\n\u624b\u9806\n\n1. \u9375\u3092\u7528\u610f\n\u6697\u53f7\u5316\u306b\u4f7f\u3046\u9375\u3092\u7528\u610f\u3057\u307e\u3059\u3002\u3053\u3053\u3067\u306f\u306a\u3093\u3068\u306a\u304fChef\u306e\u3084\u308a\u65b9\u306b\u5247\u3063\u3066\u7528\u610f\u3057\u307e\u3059\u3002\nopenssl rand -base64 512 | tr -d '\\r\\n' > config/encrypted_data_bag_secret\n\n\n2. \u74b0\u5883\u5909\u6570\u3092\u6697\u53f7\u5316\u3001\u5fa9\u53f7\u5316\u3059\u308bRake \u30bf\u30b9\u30af\u3092\u7528\u610f\n\nlib/tasks/env.rake\nnamespace :env do\n  key_path = Rails.root.join 'config', 'encrypted_data_bag_secret'\n\n  actual_path = Rails.root.join \".env.#{Rails.env}\"\n  decrypted_path = actual_path.to_s + '.decrypted'\n  encrypted_path = actual_path.to_s + '.encrypted'\n\n  task :encrypt do\n    cipher = Gibberish::AES.new File.read(key_path)\n\n    decrypted = File.read(decrypted_path)\n    encrypted = cipher.encrypt(decrypted)\n\n    File.write(encrypted_path, encrypted)\n  end\n\n  task :decrypt do\n    cipher = Gibberish::AES.new File.read(key_path)\n\n    encrypted = File.read(encrypted_path)\n    decrypted = cipher.decrypt(encrypted)\n\n    File.write(decrypted_path, decrypted)\n  end\n\n  task :deploy do\n    cp decrypted_path, actual_path\n  end\nend\n\n\n\n3. dotenv\u30d5\u30a1\u30a4\u30eb\u3092\u7528\u610f\n\u3053\u3053\u3067\u306fProduction\u74b0\u5883\u306edotenv\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n.env.production.decrypted\nDATABASE_URL=mysql2://user:password@db.example.com/database\n\n\n\n4. dotenv\u30d5\u30a1\u30a4\u30eb\u3092\u6697\u53f7\u5316\n\u3053\u308c\u3067.env.production.encrypted\u306b\u6697\u53f7\u5316\u3055\u308c\u305fdotenv\u30d5\u30a1\u30a4\u30eb\u304c\u4f5c\u6210\u3055\u308c\u307e\u3059\u3002\nRACK_ENV=production bundle exec rake env:encrypt\n\n\n5. cap deploy\u6642\u306bdotenv\u30d5\u30a1\u30a4\u30eb\u304c\u53cd\u6620\u3055\u308c\u308b\u3088\u3046\u306b\u8a2d\u5b9a\n\nconfig/deploy.rb\nnamespace :deploy do\n  task :env => [:set_rails_env] do\n    on roles(:app), in: :parallel do |host|\n      info '[deploy:env] Deploy Environment'\n      within release_path do\n        with rails_env: fetch(:rails_env) do\n          execute :rake, 'env:decrypt'\n          execute :rake, 'env:deploy'\n        end\n      end\n    end\n  end\nend\nbefore 'deploy:updated', 'deploy:env'\n\n\n\n6. \u6a5f\u5bc6\u60c5\u5831\u3092Push\u3057\u306a\u3044\u3088\u3046\u306b\u8a2d\u5b9a\n\n.gitignore\n/.env.*.decrypted\n/config/encrypted_data_bag_secret\n\n\n\n7. \u30b5\u30fc\u30d0\u306b\u9375\u3092\u7f6e\u304f\nscp config/encrypted_data_bag_secret app:/var/www/app/shared/config/encrypted_data_bag_secret\n\n\n8. \u30c7\u30d7\u30ed\u30a4\nbundle exec cap production deploy\n\n\n9. \u52d5\u4f5c\u78ba\u8a8d\n\u304a\u9858\u3044\u3057\u307e\u3059 ( _ _)\n\n\n\n\nChef\u3067\u74b0\u5883\u5909\u6570\u3092\u8a2d\u5b9a\u3059\u308b\u3088\u3046\u306b\u3057Encrypt a Data Bag Item\u3068\u304b\u3059\u308b\u65b9\u6cd5\u3082\u30a2\u30ea\u3060\u3068\u601d\u3044\u307e\u3059\u304c\u3001\u3053\u3053\u3067\u306f\u53d6\u308a\u6271\u3044\u307e\u305b\u3093\u00a0\u21a9\n\n\n\n## \u306f\u3058\u3081\u306b\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u63a5\u7d9a\u60c5\u5831\u306a\u3069\u306f\u3001\u30d9\u30bf\u66f8\u304d\u3067\u306f\u7121\u304f\u74b0\u5883\u5909\u6570\u3092\u901a\u3058\u3066\u53d6\u308a\u6271\u3063\u305f\u65b9\u304c\u53d6\u308a\u56de\u3057\u304c\u826f\u3044\u6c17\u304c\u3057\u307e\u3059\u3002\n\n```yaml:config/database.yml\nproduction:\n  url: <%= ENV['DATABASE_URL'] %>\n```\n\ndotenv\u3092\u4f7f\u3048\u3070Rails\u306eenvironment\u3054\u3068\u306b\u74b0\u5883\u5909\u6570\u3092\u5206\u3051\u308b\u3053\u3068\u304c\u51fa\u6765\u3001\u66f4\u306b\u4fbf\u5229\u611f\u3042\u308a\u307e\u3059\u3002\n\n```bash:.env.production\nDATABASE_URL=mysql2://user:password@db.example.com/database\n```\n\n\u3058\u3083\u3042\u3001\u3053\u306e\u30d5\u30a1\u30a4\u30eb\u306e\u53d6\u308a\u6271\u3044\u306f\u3069\u3046\u3057\u307e\u3057\u3087\u3046\uff1f\u305d\u306e\u307e\u307e\u30ea\u30dd\u30b8\u30c8\u30ea\u306b\u30d7\u30c3\u30b7\u30e5\u3059\u308b\uff1f\n\u6700\u91cd\u8981\u6a5f\u5bc6\u306a\u306e\u3067\u30d7\u30c3\u30b7\u30e5\u3059\u308b\u306e\u306f\u6016\u3044\u3067\u3059\u3002\n\n\u3067\u306f\u30b5\u30fc\u30d0\u306b\u76f4\u63a5\u7f6e\u3044\u3068\u304f\uff1f\n\u3044\u3084\u3001\u74b0\u5883\u5909\u6570\u3060\u3063\u3066\u5909\u66f4\u3057\u305f\u3044\u6642\u304c\u3042\u308a\u307e\u3059\u3002\u305d\u306e\u6642\u306b\u30b5\u30fc\u30d0\u306b\u5165\u3063\u3066\u66f4\u65b0\u3059\u308b\u306e\u306f\u9762\u5012\u3067\u3059[^1]\u3002\n\n[^1]: Chef\u3067\u74b0\u5883\u5909\u6570\u3092\u8a2d\u5b9a\u3059\u308b\u3088\u3046\u306b\u3057Encrypt a Data Bag Item\u3068\u304b\u3059\u308b\u65b9\u6cd5\u3082\u30a2\u30ea\u3060\u3068\u601d\u3044\u307e\u3059\u304c\u3001\u3053\u3053\u3067\u306f\u53d6\u308a\u6271\u3044\u307e\u305b\u3093\n\n\u3068\u3044\u3046\u3053\u3068\u3067\u3001\u3053\u3053\u3067\u306fdotenv\u30d5\u30a1\u30a4\u30eb\u3092\u6697\u53f7\u5316\u3057\u305f\u3082\u306e\u3092\u30ea\u30dd\u30b8\u30c8\u30ea\u306b\u30d7\u30c3\u30b7\u30e5\u3059\u308b\u3068\u5171\u306b\u3001\u305d\u306e\u9375\u3092\u30b5\u30fc\u30d0\u306b\u7f6e\u3044\u3066\u304a\u304d\u3001\u30c7\u30d7\u30ed\u30a4\u6642\u306b\u30b5\u30fc\u30d0\u306e\u65b9\u3067\u5fa9\u53f7\u5316\u304a\u3088\u3073\u74b0\u5883\u5909\u6570\u306e\u53cd\u6620\u3092\u884c\u3046\u65b9\u6cd5\u3092\u793a\u3057\u307e\u3059\u3002\n\n## \u7528\u610f\u3059\u308b\u3082\u306e\n- dotenv gem (\u74b0\u5883\u5909\u6570\u53cd\u6620)\n- gibberish gem (\u6697\u53f7\u5316, \u5fa9\u53f7\u5316)\n- capistrano gem (\u30c7\u30d7\u30ed\u30a4)\n\n## \u624b\u9806\n### 1. \u9375\u3092\u7528\u610f\n\u6697\u53f7\u5316\u306b\u4f7f\u3046\u9375\u3092\u7528\u610f\u3057\u307e\u3059\u3002\u3053\u3053\u3067\u306f\u306a\u3093\u3068\u306a\u304f[Chef\u306e\u3084\u308a\u65b9](https://docs.chef.io/data_bags.html#secret-keys)\u306b\u5247\u3063\u3066\u7528\u610f\u3057\u307e\u3059\u3002\n\n```bash\nopenssl rand -base64 512 | tr -d '\\r\\n' > config/encrypted_data_bag_secret\n```\n\n### 2. \u74b0\u5883\u5909\u6570\u3092\u6697\u53f7\u5316\u3001\u5fa9\u53f7\u5316\u3059\u308bRake \u30bf\u30b9\u30af\u3092\u7528\u610f\n```rb:lib/tasks/env.rake\nnamespace :env do\n  key_path = Rails.root.join 'config', 'encrypted_data_bag_secret'\n\n  actual_path = Rails.root.join \".env.#{Rails.env}\"\n  decrypted_path = actual_path.to_s + '.decrypted'\n  encrypted_path = actual_path.to_s + '.encrypted'\n\n  task :encrypt do\n    cipher = Gibberish::AES.new File.read(key_path)\n\n    decrypted = File.read(decrypted_path)\n    encrypted = cipher.encrypt(decrypted)\n\n    File.write(encrypted_path, encrypted)\n  end\n\n  task :decrypt do\n    cipher = Gibberish::AES.new File.read(key_path)\n\n    encrypted = File.read(encrypted_path)\n    decrypted = cipher.decrypt(encrypted)\n\n    File.write(decrypted_path, decrypted)\n  end\n\n  task :deploy do\n    cp decrypted_path, actual_path\n  end\nend\n```\n\n## 3. dotenv\u30d5\u30a1\u30a4\u30eb\u3092\u7528\u610f\n\u3053\u3053\u3067\u306fProduction\u74b0\u5883\u306edotenv\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```bash:.env.production.decrypted\nDATABASE_URL=mysql2://user:password@db.example.com/database\n```\n\n### 4. dotenv\u30d5\u30a1\u30a4\u30eb\u3092\u6697\u53f7\u5316\n\u3053\u308c\u3067.env.production.encrypted\u306b\u6697\u53f7\u5316\u3055\u308c\u305fdotenv\u30d5\u30a1\u30a4\u30eb\u304c\u4f5c\u6210\u3055\u308c\u307e\u3059\u3002\n\n```bash\nRACK_ENV=production bundle exec rake env:encrypt\n```\n\n### 5. cap deploy\u6642\u306bdotenv\u30d5\u30a1\u30a4\u30eb\u304c\u53cd\u6620\u3055\u308c\u308b\u3088\u3046\u306b\u8a2d\u5b9a\n```rb:config/deploy.rb\nnamespace :deploy do\n  task :env => [:set_rails_env] do\n    on roles(:app), in: :parallel do |host|\n      info '[deploy:env] Deploy Environment'\n      within release_path do\n        with rails_env: fetch(:rails_env) do\n          execute :rake, 'env:decrypt'\n          execute :rake, 'env:deploy'\n        end\n      end\n    end\n  end\nend\nbefore 'deploy:updated', 'deploy:env'\n```\n\n### 6. \u6a5f\u5bc6\u60c5\u5831\u3092Push\u3057\u306a\u3044\u3088\u3046\u306b\u8a2d\u5b9a\n```bash:.gitignore\n/.env.*.decrypted\n/config/encrypted_data_bag_secret\n```\n\n### 7. \u30b5\u30fc\u30d0\u306b\u9375\u3092\u7f6e\u304f\n```bash\nscp config/encrypted_data_bag_secret app:/var/www/app/shared/config/encrypted_data_bag_secret\n```\n\n### 8. \u30c7\u30d7\u30ed\u30a4\n```bash\nbundle exec cap production deploy\n```\n\n### 9. \u52d5\u4f5c\u78ba\u8a8d\n\u304a\u9858\u3044\u3057\u307e\u3059 ( _ _)\n", "tags": ["capistrano", "Rails", "dotenv", "rake", "GitHub"]}