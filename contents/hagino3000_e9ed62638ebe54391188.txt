{"context": "\n\n\u3053\u308c\u306f\u4f55\u304b\nwindow\u95a2\u6570\u3092\u99c6\u4f7f\u3059\u308b\u3068UDF\u3092\u4f7f\u308f\u306a\u304f\u3068\u3082\u7c21\u6f54\u306b\u7d71\u8a08\u91cf\u304c\u51fa\u305b\u308b\u3002\u304c\u3088\u304f\u66f8\u304d\u65b9\u3092\u5fd8\u308c\u308b\u306e\u3067\u30e1\u30e2\n\n\u57fa\u672c\n-- \u5e73\u5747\nAVG(expr)\n\n-- \u4e2d\u592e\u50240.1%\u8aa4\u5dee\nNTH(501, QUANTILES(expr, 1001))\n\n-- \u6700\u983b\u5024\nTOP(expr, 1), COUNT(*) as count\n\n-- \u5206\u6563\nVARIANCE(expr) \n-- \u6bcd\u96c6\u56e3\u306e\u5206\u6563 (\u5206\u6bcd\u304c n-1 \u306e\u65b9)\nVARIANCE_POP(expr)\n\n-- \u6a19\u6e96\u504f\u5dee\nSTDDEV(expr)\n-- \u6bcd\u96c6\u56e3\u306e\u6a19\u6e96\u504f\u5dee (\u5206\u6bcd\u304c n-1 \u306e\u65b9)\nSTDDEV_POP(expr)\n\n-- \u5909\u52d5\u4fc2\u6570\nSTDDEV(expr)/AVG(expr)\n\n-- \u30d4\u30a2\u30bd\u30f3\u76f8\u95a2\u4fc2\u6570\nCORR(expr1, expr2)\n\n\n\u60c5\u5831\u91cf\nPublic Datasets\u306eUSA Names\u304b\u3089\u3001\u30b8\u30a7\u30f3\u30c0\u30fc\u5225\u306b\u540d\u524d\u6bce\u306e\u60c5\u5831\u91cf\nselect\n    gender,\n    name,\n    number,\n    -log2(p_name) as bits\nfrom (\n    select\n        gender,\n        name,\n        number,\n        ratio_to_report(number) over (partition by gender) as p_name,\n    from [bigquery-public-data:usa_names.usa_1910_2013]\n    where state = 'CA' \n)\n\n\n\u30a8\u30f3\u30c8\u30ed\u30d4\u30fc\nPublic Datasets\u306eUSA Names\u304b\u3089\u3001\u30b8\u30a7\u30f3\u30c0\u30fc\u6bce\u306b\u540d\u524d\u306e\u30a8\u30f3\u30c8\u30ed\u30d4\u30fc\nselect\n    state,\n    gender,\n    sum(p_name * -log2(p_name)) as entropy\nfrom (\n    select\n        state,\n        gender,\n        name,\n        number,\n        ratio_to_report(number) over (partition by gender) as p_name,\n    from [bigquery-public-data:usa_names.usa_1910_2013]\n)\ngroup by state, gender\norder by entropy\n\n\nKL-Divergence\nKLDivergence = \\sum_iP(i)log_2\\frac{P(i)}{Q(i)}\n\nKaggle\u306eClick-Through Rate Prediction\u306e\u30c7\u30fc\u30bf\u3092\u4f8b\u306b\u3001\u5e83\u544a\u67a0\u6bce\u306bhourly\u306e\u30a4\u30f3\u30d7\u30ec\u30c3\u30b7\u30e7\u30f3\u6570\u3068\u30af\u30ea\u30c3\u30af\u6570\u306e\u78ba\u7387\u5206\u5e03\u306e\u8ddd\u96e2\u3092\u53d6\u308b\nselect\n    site_id,\n    sum(p_imp * log2(p_imp/(p_click + 0.0001))) as KLD_imp_and_click\nfrom (\n    select \n        site_id,\n        hour,\n        imp,\n        click,\n        ratio_to_report(imp) over (partition by site_id) as p_imp,\n        ratio_to_report(click) over (partition by site_id) as p_click\n    from (\n        select \n            site_id,\n            hour,\n            count(*) as imp,\n            sum(click) as click,\n        from [hagino3000-bq-sandbox:ctr_competition.train]\n        group by site_id, hour\n        order by site_id, hour\n    )\n)\ngroup by site_id\norder by KLD_imp_and_click\n\n\n\u6642\u7cfb\u5217\u30c7\u30fc\u30bf\u306e\u79fb\u52d5\u5e73\u5747\u3068\u5dee\u5206\u7cfb\u5217\n\u540c\u3058\u304fKaggle\u306eClick-Through Rate Prediction\u3067\u5e83\u544a\u67a0\u3054\u3068\u306e3\u6642\u9593\u79fb\u52d5\u5e73\u5747\u3002\u6b20\u640d\u5024\u3092\u88dc\u5b8c\u3057\u305f\u3044\u5834\u5408\u306f\u8ef8\u3092\u5225\u9014\u4f5c\u3063\u3066Join\u3059\u308b\u4e8b\u3002\nselect\n  site_id,\n  hour,\n  avg(imp) over (partition by site_id\n                 order by hour\n                 ROWS BETWEEN 3 preceding AND CURRENT ROW) as rolling_mean\nfrom (\n  select \n      site_id,\n      hour,\n      count(*) as imp\n  from [hagino3000-bq-sandbox:ctr_competition.train]\n      group by site_id, hour\n)\norder by site_id, hour\n\n\n\u5dee\u5206\u7cfb\u5217\nselect\n    site_id,\n    hour,\n    imp,\n    imp - ifnull(previous_imp, imp) as residual\nfrom (\n    select\n        site_id,\n        hour,\n        imp,\n        lag(imp, 1) over (partition by site_id order by hour) as previous_imp\n    from (\n        select \n            site_id,\n            hour,\n            count(*) as imp\n        from [hagino3000-bq-sandbox:ctr_competition.train]\n        group by site_id, hour\n    )\n)\norder by site_id, hour\n\n\n\u6b63\u898f\u5316\u3057\u305f\u4e2d\u592e\u7d76\u5bfe\u504f\u5dee\n\u30ed\u30d0\u30b9\u30c8\u306a\u6a19\u6e96\u504f\u5dee\u306e\u63a8\u5b9a\u5024\nMADN = \\frac{median(|x_i - mean(x)|)}{0.674}\n\nselect \n    a.stn as stn,\n    a.year as year,\n    a.mo as month,\n    a.da as day,\n    a.temp as temp, \n    avg(a.temp) over (partition by a.stn) as temp_mu,\n    stddev(a.temp) over (partition by a.stn) as temp_std,\n    b.median as temp_median,\n    b.madn as temp_madn\nfrom [bigquery-public-data:noaa_gsod.gsod1929] as a\ninner join \n(\n    select \n        org.stn as stn,\n        agg.median as median,\n        nth(501, quantiles(abs(org.temp - agg.median), 1001))/0.675 as madn,\n    from [bigquery-public-data:noaa_gsod.gsod1929] as org\n    inner join \n    (\n        select \n            stn,  nth(501, quantiles(temp, 1001)) as median\n        from [bigquery-public-data:noaa_gsod.gsod1929]\n        group by stn\n    ) as agg on org.stn = agg.stn\n    group by stn, median\n) as b on a.stn = b.stn\n\n\nZ\u5024\nBigQuery public dataset\u306eNOAA Weather Data\u304b\u3089\u3001\u30b9\u30c6\u30fc\u30b7\u30e7\u30f3\u6bce\u306b\u6c17\u6e29\u306eZ\u5024\nselect\n    stn,\n    year,\n    mo,\n    da,\n    temp,\n    (temp - mu)/std AS Z\nfrom (\n    select \n        stn,\n        year,\n        mo,\n        da,\n        temp, \n        avg(temp) over (partition by stn) as mu,\n        stddev(temp) over (partition by stn) as std\n    from [bigquery-public-data:noaa_gsod.gsod1929]\n)\norder by stn, year, mo, da\n\n### \u3053\u308c\u306f\u4f55\u304b\nwindow\u95a2\u6570\u3092\u99c6\u4f7f\u3059\u308b\u3068UDF\u3092\u4f7f\u308f\u306a\u304f\u3068\u3082\u7c21\u6f54\u306b\u7d71\u8a08\u91cf\u304c\u51fa\u305b\u308b\u3002\u304c\u3088\u304f\u66f8\u304d\u65b9\u3092\u5fd8\u308c\u308b\u306e\u3067\u30e1\u30e2\n\n### \u57fa\u672c\n\n```sql\n-- \u5e73\u5747\nAVG(expr)\n\n-- \u4e2d\u592e\u50240.1%\u8aa4\u5dee\nNTH(501, QUANTILES(expr, 1001))\n\n-- \u6700\u983b\u5024\nTOP(expr, 1), COUNT(*) as count\n\n-- \u5206\u6563\nVARIANCE(expr) \n-- \u6bcd\u96c6\u56e3\u306e\u5206\u6563 (\u5206\u6bcd\u304c n-1 \u306e\u65b9)\nVARIANCE_POP(expr)\n\n-- \u6a19\u6e96\u504f\u5dee\nSTDDEV(expr)\n-- \u6bcd\u96c6\u56e3\u306e\u6a19\u6e96\u504f\u5dee (\u5206\u6bcd\u304c n-1 \u306e\u65b9)\nSTDDEV_POP(expr)\n\n-- \u5909\u52d5\u4fc2\u6570\nSTDDEV(expr)/AVG(expr)\n\n-- \u30d4\u30a2\u30bd\u30f3\u76f8\u95a2\u4fc2\u6570\nCORR(expr1, expr2)\n```\n\n### \u60c5\u5831\u91cf\n\nPublic Datasets\u306eUSA Names\u304b\u3089\u3001\u30b8\u30a7\u30f3\u30c0\u30fc\u5225\u306b\u540d\u524d\u6bce\u306e\u60c5\u5831\u91cf\n\n```sql\nselect\n\tgender,\n\tname,\n\tnumber,\n\t-log2(p_name) as bits\nfrom (\n\tselect\n\t\tgender,\n\t\tname,\n\t\tnumber,\n\t\tratio_to_report(number) over (partition by gender) as p_name,\n\tfrom [bigquery-public-data:usa_names.usa_1910_2013]\n\twhere state = 'CA' \n)\n```\n\n### \u30a8\u30f3\u30c8\u30ed\u30d4\u30fc\n\nPublic Datasets\u306eUSA Names\u304b\u3089\u3001\u30b8\u30a7\u30f3\u30c0\u30fc\u6bce\u306b\u540d\u524d\u306e\u30a8\u30f3\u30c8\u30ed\u30d4\u30fc\n\n```sql\nselect\n\tstate,\n\tgender,\n\tsum(p_name * -log2(p_name)) as entropy\nfrom (\n\tselect\n\t\tstate,\n\t\tgender,\n\t\tname,\n\t\tnumber,\n\t\tratio_to_report(number) over (partition by gender) as p_name,\n\tfrom [bigquery-public-data:usa_names.usa_1910_2013]\n)\ngroup by state, gender\norder by entropy\n```\n\n### KL-Divergence\n\n```math\nKLDivergence = \\sum_iP(i)log_2\\frac{P(i)}{Q(i)}\n```\n\nKaggle\u306e[Click-Through Rate Prediction](https://www.kaggle.com/c/avazu-ctr-prediction)\u306e\u30c7\u30fc\u30bf\u3092\u4f8b\u306b\u3001\u5e83\u544a\u67a0\u6bce\u306bhourly\u306e\u30a4\u30f3\u30d7\u30ec\u30c3\u30b7\u30e7\u30f3\u6570\u3068\u30af\u30ea\u30c3\u30af\u6570\u306e\u78ba\u7387\u5206\u5e03\u306e\u8ddd\u96e2\u3092\u53d6\u308b\n\n```sql\nselect\n    site_id,\n    sum(p_imp * log2(p_imp/(p_click + 0.0001))) as KLD_imp_and_click\nfrom (\n    select \n        site_id,\n        hour,\n        imp,\n        click,\n        ratio_to_report(imp) over (partition by site_id) as p_imp,\n        ratio_to_report(click) over (partition by site_id) as p_click\n    from (\n        select \n            site_id,\n            hour,\n            count(*) as imp,\n            sum(click) as click,\n        from [hagino3000-bq-sandbox:ctr_competition.train]\n        group by site_id, hour\n        order by site_id, hour\n    )\n)\ngroup by site_id\norder by KLD_imp_and_click\n```\n\n### \u6642\u7cfb\u5217\u30c7\u30fc\u30bf\u306e\u79fb\u52d5\u5e73\u5747\u3068\u5dee\u5206\u7cfb\u5217\n\n\u540c\u3058\u304fKaggle\u306e[Click-Through Rate Prediction](https://www.kaggle.com/c/avazu-ctr-prediction)\u3067\u5e83\u544a\u67a0\u3054\u3068\u306e3\u6642\u9593\u79fb\u52d5\u5e73\u5747\u3002\u6b20\u640d\u5024\u3092\u88dc\u5b8c\u3057\u305f\u3044\u5834\u5408\u306f\u8ef8\u3092\u5225\u9014\u4f5c\u3063\u3066Join\u3059\u308b\u4e8b\u3002\n\n```sql\nselect\n  site_id,\n  hour,\n  avg(imp) over (partition by site_id\n                 order by hour\n                 ROWS BETWEEN 3 preceding AND CURRENT ROW) as rolling_mean\nfrom (\n  select \n      site_id,\n      hour,\n      count(*) as imp\n  from [hagino3000-bq-sandbox:ctr_competition.train]\n      group by site_id, hour\n)\norder by site_id, hour\n```\n\n#### \u5dee\u5206\u7cfb\u5217\n```sql\nselect\n    site_id,\n    hour,\n    imp,\n    imp - ifnull(previous_imp, imp) as residual\nfrom (\n    select\n        site_id,\n        hour,\n        imp,\n        lag(imp, 1) over (partition by site_id order by hour) as previous_imp\n    from (\n        select \n            site_id,\n            hour,\n            count(*) as imp\n        from [hagino3000-bq-sandbox:ctr_competition.train]\n        group by site_id, hour\n    )\n)\norder by site_id, hour\n```\n\n### \u6b63\u898f\u5316\u3057\u305f\u4e2d\u592e\u7d76\u5bfe\u504f\u5dee\n\n\u30ed\u30d0\u30b9\u30c8\u306a\u6a19\u6e96\u504f\u5dee\u306e\u63a8\u5b9a\u5024\n\n```math\nMADN = \\frac{median(|x_i - mean(x)|)}{0.674}\n```\n\n```sql\nselect \n    a.stn as stn,\n    a.year as year,\n    a.mo as month,\n    a.da as day,\n    a.temp as temp, \n    avg(a.temp) over (partition by a.stn) as temp_mu,\n    stddev(a.temp) over (partition by a.stn) as temp_std,\n    b.median as temp_median,\n    b.madn as temp_madn\nfrom [bigquery-public-data:noaa_gsod.gsod1929] as a\ninner join \n(\n    select \n        org.stn as stn,\n        agg.median as median,\n        nth(501, quantiles(abs(org.temp - agg.median), 1001))/0.675 as madn,\n    from [bigquery-public-data:noaa_gsod.gsod1929] as org\n    inner join \n    (\n        select \n            stn,  nth(501, quantiles(temp, 1001)) as median\n        from [bigquery-public-data:noaa_gsod.gsod1929]\n        group by stn\n    ) as agg on org.stn = agg.stn\n    group by stn, median\n) as b on a.stn = b.stn\n```\n\n### Z\u5024\n\nBigQuery public dataset\u306eNOAA Weather Data\u304b\u3089\u3001\u30b9\u30c6\u30fc\u30b7\u30e7\u30f3\u6bce\u306b\u6c17\u6e29\u306eZ\u5024\n\n```sql\nselect\n\tstn,\n\tyear,\n\tmo,\n\tda,\n\ttemp,\n\t(temp - mu)/std AS Z\nfrom (\n\tselect \n\t\tstn,\n\t\tyear,\n\t\tmo,\n\t\tda,\n\t\ttemp, \n\t\tavg(temp) over (partition by stn) as mu,\n\t\tstddev(temp) over (partition by stn) as std\n\tfrom [bigquery-public-data:noaa_gsod.gsod1929]\n)\norder by stn, year, mo, da\n```\n\n\n", "tags": ["bigquery", "SQL", "statistics"]}