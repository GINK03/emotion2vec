{"context": " More than 1 year has passed since last update.\u3053\u306e\u8a18\u4e8b\u306fTokyoDjangoMeetup #3\u53c2\u52a0\u4e2d\u306b\u66f8\u304d\u307e\u3057\u305f\u3002\n\n\u3069\u3093\u306a\u3053\u3068\u304c\u3067\u304d\u308b\u306e\u304b\uff1f\nDjango1.8\u3067\u8ffd\u52a0\u3055\u308c\u305f\u65b0\u6a5f\u80fdConditional Expressions\u3067\u3001\u30e2\u30c7\u30eb\u64cd\u4f5c\u6642\u306b\u4f7f\u3046annotation\u3001aggregation\u3001update\u30e1\u30bd\u30c3\u30c9\u306b\u6761\u4ef6\u5f0f\u3092\u6e21\u305b\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n\u30b5\u30f3\u30d7\u30eb\u306e\u30e2\u30c7\u30eb\n\u4ee5\u4e0b\u306e\u30e2\u30c7\u30eb\u3092\u7528\u610f\u3057\u307e\u3057\u305f\u30021\n\nmodels.py\n# -*- coding: utf-8 -*-\nfrom django.db import models\n\n\nclass Sponsor(models.Model):\n\n    u\"\"\"\n    PyCon JP 2015\u306e\u30b9\u30dd\u30f3\u30b5\u30fc\n    \"\"\"\n    DIAMOND = 'D'\n    PLATINUM = 'P'\n    GOLD = 'G'\n    SILVER = 'S'\n    PLAN_CHOICES = (\n        (DIAMOND, 'Diamond'),\n        (PLATINUM, 'Platinum'),\n        (GOLD, 'Gold'),\n        (SILVER, 'Silver'),\n    )\n    name = models.CharField(max_length=50)\n    registered_on = models.DateField()\n    plan = models.CharField(\n        max_length=1,\n        choices=PLAN_CHOICES,\n        default=SILVER,\n    )\n\n\n\u30c6\u30b9\u30c8\u30c7\u30fc\u30bf\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3067\u3059\u3002\n>>> from datetime import date, timedelta\n>>> Sponsor.objects.create(\n...     name='Crazy Inc.',\n...     plan=Sponsor.DIAMOND,\n...     registered_on=date.today() - timedelta(days=19))\n<Sponsor: Sponsor object>\n>>> Sponsor.objects.create(\n...     name='Star Inc.',\n...     plan=Sponsor.PLATINUM,\n...     registered_on=date.today() - timedelta(days=36))\n<Sponsor: Sponsor object>\n>>> Sponsor.objects.create(\n...     name='Experience Inc.',\n...     plan=Sponsor.GOLD,\n...     registered_on=date.today() - timedelta(days=11))\n<Sponsor: Sponsor object>\n>>> Sponsor.objects.create(\n...     name='Giorno co., ltd.',\n...     plan=Sponsor.GOLD,\n...     registered_on=date.today() - timedelta(days=6))\n<Sponsor: Sponsor object>\n>>> Sponsor.objects.create(\n...     name='Chariot Inc.',\n...     plan=Sponsor.SILVER,\n...     registered_on=date.today() - timedelta(days=1))\n<Sponsor: Sponsor object>\n>>> Sponsor.objects.create(\n...     name='Polnareff co., ltd.',\n...     plan=Sponsor.SILVER,\n...     registered_on=date.today() - timedelta(days=2))\n<Sponsor: Sponsor object>\n\n\n\u5b9f\u969b\u306b\u4f7f\u3063\u3066\u307f\u308b\nConditional Expressions\u306f\u3001\u4ee5\u4e0b\u306e2\u3064\u306e\u30af\u30e9\u30b9\u3092\u7d44\u307f\u5408\u308f\u305b\u3066\u66f8\u304d\u307e\u3059\u3002\n\n\nWhen\u30af\u30e9\u30b9\n\n\n\u300c\u6761\u4ef6\u300d\u3068\u300c\u7d50\u679c\u300d\u3092\u30ab\u30d7\u30bb\u30eb\u5316\u3057\u305f\u30af\u30e9\u30b9\n\n\n\nCase\u30af\u30e9\u30b9\n\n\nPython\u306eif ... elif ... else\u306e\u3088\u3046\u306a\u6761\u4ef6\u5f0f\u306b\u5f53\u305f\u308b\u5f79\u5272\u306e\u30af\u30e9\u30b9\u3002\u300c\u6761\u4ef6\u300d\u304c\u771f\u3068\u306a\u308bWhen\u306e\u300c\u7d50\u679c\u300d\u3092\u623b\u308a\u5024\u3068\u3059\u308b\u3002\n\n\n\nWhen\u30af\u30e9\u30b9\u306f\u3001\u6700\u521d\u306b\u300c\u6761\u4ef6\u300d\u3001\u6700\u5f8c\u306b\u300c\u7d50\u679c\u300d\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\u300c\u6761\u4ef6\u300d\u306e\u6307\u5b9a\u306e\u4ed5\u65b9\u306ffilter\u30e1\u30bd\u30c3\u30c9\u3068\u540c\u3058\u3067\u3059\u3002\n>>> from django.db.models import When, F, Q\n>>> # plan\u304cGold\u306e\u3068\u304d\u306bname\u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u53c2\u7167\u3059\u308b\n>>> When(plan=Sponsor.GOLD, then='name')\n>>> When(plan=Sponsor.GOLD, then=F('name'))\n>>> from datetime import date\n>>> # registered_on\u304c2015/2/1\u304b\u30892015/9/1\u306e\u9593\u306a\u3089plan\u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u53c2\u7167\u3059\u308b\n>>> When(registered_on__gt=date(2015, 2, 1),\n...      registered_on__lt=date(2015, 9, 1),\n...      then='plan')\n>>> # Q\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3067OR\u6761\u4ef6\u3092\u6307\u5b9a\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u308b\n>>> When(Q(name__startswith=\"Crazy\") | Q(name__startswith=\"Giorno\"),\n...      then='name')\n\n\u4e0a\u8a18\u306eWhen\u30af\u30e9\u30b9\u3092Case\u30af\u30e9\u30b9\u3068\u7d44\u307f\u5408\u308f\u305b\u3066\u3001\u5404\u30b9\u30dd\u30f3\u30b5\u30fc\u306e\u30b9\u30dd\u30f3\u30b5\u30fc\u6599\u3092\u6c42\u3081\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n>>> from django.db.models import Case, When, Value, CharField\n>>> Sponsor.objects.annotate(\n...     fee=Case(\n...         When(plan=Sponsor.DIAMOND, then=Value(u'1,000,000\u5186 (\u7a0e\u629c\u304d)')),\n...         When(plan=Sponsor.PLATINUM, then=Value(u'500,000\u5186 (\u7a0e\u629c\u304d)')),\n...         When(plan=Sponsor.GOLD, then=Value(u'300,000\u5186 (\u7a0e\u629c\u304d)')),\n...         When(plan=Sponsor.SILVER, then=Value(u'100,000\u5186 (\u7a0e\u629c\u304d)')),\n...         output_field=CharField(),\n...     ),\n... ).values_list('name', 'fee')\n[(u'Crazy Inc.', u'1,000,000\\u5186 (\\u7a0e\\u629c\\u304d)'), (u'Star Inc.', u'500,000\\u5186 (\\u7a0e\\u629c\\u304d)'), (u'Experience Inc.', u'300,000\\u5186 (\\u7a0e\\u629c\\u304d)'), (u'Giorno co., ltd.', u'300,000\\u5186 (\\u7a0e\\u629c\\u304d)'), (u'Chariot Inc.', u'100,000\\u5186 (\\u7a0e\\u629c\\u304d)'), (u'Polnareff co., ltd.', u'100,000\\u5186 (\\u7a0e\\u629c\\u304d)')]\n\n\nregistered_on\u306e\u5024\u306b\u5fdc\u3058\u3066plan\u3092\u66f4\u65b0\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n>>> from django.db.models import Case, When, Value\n>>> from datetime import date,timedelta\n>>> a_week_ago = date.today() - timedelta(weeks=1)\n>>> a_month_ago = date.today() - timedelta(days=30)\n>>> Sponsor.objects.update(\n...     plan=Case(\n...         When(registered_on__lte=a_week_ago ,\n...              then=Value(Sponsor.PLATINUM)),\n...         When(registered_on__lte=a_month_ago,\n...              then=Value(Sponsor.GOLD)),\n...         default=Value(Sponsor.SILVER)\n...     ),\n... )\n>>> Sponsor.objects.values_list('name', 'plan')\n[(u'Crazy Inc.', u'P'), (u'Star Inc.', u'P'), (u'Experience Inc.', u'P'), (u'Giorno co., ltd.', u'S'), (u'Chariot Inc.', u'S'), (u'Polnareff co., ltd.', u'S')]\n\n\n\u5404plan\u306b\u4f55\u793e\u5fdc\u52df\u3057\u305f\u306e\u304b\u8abf\u3079\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n>>> from django.db.models import Case, When, Value, IntegerField, Sum\n>>> Sponsor.objects.aggregate(\n...     silver=Sum(\n...         Case(When(plan=Sponsor.SILVER, then=1),\n...              output_field=IntegerField())\n...     ),\n...     gold=Sum(\n...         Case(When(plan=Sponsor.GOLD, then=1),\n...              output_field=IntegerField())\n...     ),\n...     platinum=Sum(\n...         Case(When(plan=Sponsor.PLATINUM, then=1),\n...              output_field=IntegerField())\n...     )\n... )\n{'platinum': 3, 'silver': 3, 'gold': None}\n\n\n\u3069\u3093\u306aSQL\u304c\u4f5c\u3089\u308c\u3066\u3044\u308b\u306e\u304b\uff1f\ndjnago-debug-toolbar\u306edebugsqlshell\u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u3063\u3066\u3001\u5b9f\u969b\u306b\u4f5c\u3089\u308c\u308bSQL\u3092\u898b\u3066\u307f\u307e\u3057\u3087\u3046\u30022\n>>> Sponsor.objects.annotate(\n...     fee=Case(\n...         When(plan=Sponsor.DIAMOND, then=Value(u'1,000,000\u5186 (\u7a0e\u629c\u304d)')),\n...         When(plan=Sponsor.PLATINUM, then=Value(u'500,000\u5186 (\u7a0e\u629c\u304d)')),\n...         When(plan=Sponsor.GOLD, then=Value(u'300,000\u5186 (\u7a0e\u629c\u304d)')),\n...         When(plan=Sponsor.SILVER, then=Value(u'100,000\u5186 (\u7a0e\u629c\u304d)')),\n...         output_field=CharField(),\n...     ),\n... ).values_list('name', 'fee')\nSELECT `sponsors_sponsor`.`name`,\n       CASE\n           WHEN `sponsors_sponsor`.`plan` = 'D' THEN '1,000,000\u5186 (\u7a0e\u629c\u304d)'\n           WHEN `sponsors_sponsor`.`plan` = 'P' THEN '500,000\u5186 (\u7a0e\u629c\u304d)'\n           WHEN `sponsors_sponsor`.`plan` = 'G' THEN '300,000\u5186 (\u7a0e\u629c\u304d)'\n           WHEN `sponsors_sponsor`.`plan` = 'S' THEN '100,000\u5186 (\u7a0e\u629c\u304d)'\n           ELSE NULL\n       END AS `fee`\nFROM `sponsors_sponsor` LIMIT 21 [0.23ms]\n\n>>> Sponsor.objects.update(\n...     plan=Case(\n...         When(registered_on__lte=a_week_ago ,\n...              then=Value(Sponsor.PLATINUM)),\n...         When(registered_on__lte=a_month_ago,\n...              then=Value(Sponsor.GOLD)),\n...         default=Value(Sponsor.SILVER)\n...     ),\n... )\nUPDATE `sponsors_sponsor`\nSET `plan` = CASE\n                 WHEN `sponsors_sponsor`.`registered_on` <= '2015-04-22' THEN 'P'\n                 WHEN `sponsors_sponsor`.`registered_on` <= '2015-03-30' THEN 'G'\n                 ELSE 'S'\n             END [0.62ms]\n\n>>> Sponsor.objects.aggregate(\n...     silver=Sum(\n...         Case(When(plan=Sponsor.SILVER, then=1),\n...              output_field=IntegerField())\n...     ),\n...     gold=Sum(\n...         Case(When(plan=Sponsor.GOLD, then=1),\n...              output_field=IntegerField())\n...     ),\n...     platinum=Sum(\n...         Case(When(plan=Sponsor.PLATINUM, then=1),\n...              output_field=IntegerField())\n...     )\n... )\nSELECT SUM(CASE WHEN `sponsors_sponsor`.`plan` = 'P' THEN 1 ELSE NULL END) AS `platinum`,\n       SUM(CASE WHEN `sponsors_sponsor`.`plan` = 'S' THEN 1 ELSE NULL END) AS `silver`,\n       SUM(CASE WHEN `sponsors_sponsor`.`plan` = 'G' THEN 1 ELSE NULL END) AS `gold`\nFROM `sponsors_sponsor` [0.32ms]\n\n\n\n\n\n\u672c\u5bb6\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u3092PyCon JP 2015\u30b9\u30dd\u30f3\u30b5\u30fc\u30b7\u30c3\u30d7\u306e\u3054\u6848\u5185\u3092\u53c2\u8003\u306b\u6539\u5909\u3002\u00a0\u21a9\n\n\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306fMySQL5.5.43\u3092\u4f7f\u3063\u3066\u3044\u307e\u3059\u3002\u00a0\u21a9\n\n\n\n\u3053\u306e\u8a18\u4e8b\u306f[TokyoDjangoMeetup #3](http://django.connpass.com/event/14219/)\u53c2\u52a0\u4e2d\u306b\u66f8\u304d\u307e\u3057\u305f\u3002\n\n## \u3069\u3093\u306a\u3053\u3068\u304c\u3067\u304d\u308b\u306e\u304b\uff1f\nDjango1.8\u3067\u8ffd\u52a0\u3055\u308c\u305f\u65b0\u6a5f\u80fd[Conditional Expressions](https://docs.djangoproject.com/en/1.8/ref/models/conditional-expressions/\n)\u3067\u3001\u30e2\u30c7\u30eb\u64cd\u4f5c\u6642\u306b\u4f7f\u3046`annotation`\u3001`aggregation`\u3001`update`\u30e1\u30bd\u30c3\u30c9\u306b\u6761\u4ef6\u5f0f\u3092\u6e21\u305b\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n## \u30b5\u30f3\u30d7\u30eb\u306e\u30e2\u30c7\u30eb\n\u4ee5\u4e0b\u306e\u30e2\u30c7\u30eb\u3092\u7528\u610f\u3057\u307e\u3057\u305f\u3002[^1]\n\n``` django:models.py\n# -*- coding: utf-8 -*-\nfrom django.db import models\n\n\nclass Sponsor(models.Model):\n\n    u\"\"\"\n    PyCon JP 2015\u306e\u30b9\u30dd\u30f3\u30b5\u30fc\n    \"\"\"\n    DIAMOND = 'D'\n    PLATINUM = 'P'\n    GOLD = 'G'\n    SILVER = 'S'\n    PLAN_CHOICES = (\n        (DIAMOND, 'Diamond'),\n        (PLATINUM, 'Platinum'),\n        (GOLD, 'Gold'),\n        (SILVER, 'Silver'),\n    )\n    name = models.CharField(max_length=50)\n    registered_on = models.DateField()\n    plan = models.CharField(\n        max_length=1,\n        choices=PLAN_CHOICES,\n        default=SILVER,\n    )\n```\n\n\u30c6\u30b9\u30c8\u30c7\u30fc\u30bf\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3067\u3059\u3002\n\n```pycon\n>>> from datetime import date, timedelta\n>>> Sponsor.objects.create(\n...     name='Crazy Inc.',\n...     plan=Sponsor.DIAMOND,\n...     registered_on=date.today() - timedelta(days=19))\n<Sponsor: Sponsor object>\n>>> Sponsor.objects.create(\n...     name='Star Inc.',\n...     plan=Sponsor.PLATINUM,\n...     registered_on=date.today() - timedelta(days=36))\n<Sponsor: Sponsor object>\n>>> Sponsor.objects.create(\n...     name='Experience Inc.',\n...     plan=Sponsor.GOLD,\n...     registered_on=date.today() - timedelta(days=11))\n<Sponsor: Sponsor object>\n>>> Sponsor.objects.create(\n...     name='Giorno co., ltd.',\n...     plan=Sponsor.GOLD,\n...     registered_on=date.today() - timedelta(days=6))\n<Sponsor: Sponsor object>\n>>> Sponsor.objects.create(\n...     name='Chariot Inc.',\n...     plan=Sponsor.SILVER,\n...     registered_on=date.today() - timedelta(days=1))\n<Sponsor: Sponsor object>\n>>> Sponsor.objects.create(\n...     name='Polnareff co., ltd.',\n...     plan=Sponsor.SILVER,\n...     registered_on=date.today() - timedelta(days=2))\n<Sponsor: Sponsor object>\n```\n\n## \u5b9f\u969b\u306b\u4f7f\u3063\u3066\u307f\u308b\nConditional Expressions\u306f\u3001\u4ee5\u4e0b\u306e2\u3064\u306e\u30af\u30e9\u30b9\u3092\u7d44\u307f\u5408\u308f\u305b\u3066\u66f8\u304d\u307e\u3059\u3002\n\n* [When](https://docs.djangoproject.com/en/1.8/ref/models/conditional-expressions/#when)\u30af\u30e9\u30b9\n    * \u300c\u6761\u4ef6\u300d\u3068\u300c\u7d50\u679c\u300d\u3092\u30ab\u30d7\u30bb\u30eb\u5316\u3057\u305f\u30af\u30e9\u30b9\n* [Case](https://docs.djangoproject.com/en/1.8/ref/models/conditional-expressions/#case)\u30af\u30e9\u30b9\n    * Python\u306e`if ... elif ... else`\u306e\u3088\u3046\u306a\u6761\u4ef6\u5f0f\u306b\u5f53\u305f\u308b\u5f79\u5272\u306e\u30af\u30e9\u30b9\u3002\u300c\u6761\u4ef6\u300d\u304c\u771f\u3068\u306a\u308b`When`\u306e\u300c\u7d50\u679c\u300d\u3092\u623b\u308a\u5024\u3068\u3059\u308b\u3002\n\n`When`\u30af\u30e9\u30b9\u306f\u3001\u6700\u521d\u306b\u300c\u6761\u4ef6\u300d\u3001\u6700\u5f8c\u306b\u300c\u7d50\u679c\u300d\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\u300c\u6761\u4ef6\u300d\u306e\u6307\u5b9a\u306e\u4ed5\u65b9\u306f[filter](https://docs.djangoproject.com/en/1.8/ref/models/querysets/#django.db.models.query.QuerySet.filter)\u30e1\u30bd\u30c3\u30c9\u3068\u540c\u3058\u3067\u3059\u3002\n\n```pycon\n>>> from django.db.models import When, F, Q\n>>> # plan\u304cGold\u306e\u3068\u304d\u306bname\u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u53c2\u7167\u3059\u308b\n>>> When(plan=Sponsor.GOLD, then='name')\n>>> When(plan=Sponsor.GOLD, then=F('name'))\n>>> from datetime import date\n>>> # registered_on\u304c2015/2/1\u304b\u30892015/9/1\u306e\u9593\u306a\u3089plan\u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u53c2\u7167\u3059\u308b\n>>> When(registered_on__gt=date(2015, 2, 1),\n...      registered_on__lt=date(2015, 9, 1),\n...      then='plan')\n>>> # Q\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3067OR\u6761\u4ef6\u3092\u6307\u5b9a\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u308b\n>>> When(Q(name__startswith=\"Crazy\") | Q(name__startswith=\"Giorno\"),\n...      then='name')\n```\n\n\u4e0a\u8a18\u306e`When`\u30af\u30e9\u30b9\u3092`Case`\u30af\u30e9\u30b9\u3068\u7d44\u307f\u5408\u308f\u305b\u3066\u3001\u5404\u30b9\u30dd\u30f3\u30b5\u30fc\u306e\u30b9\u30dd\u30f3\u30b5\u30fc\u6599\u3092\u6c42\u3081\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\n```pycon\n>>> from django.db.models import Case, When, Value, CharField\n>>> Sponsor.objects.annotate(\n...     fee=Case(\n...         When(plan=Sponsor.DIAMOND, then=Value(u'1,000,000\u5186 (\u7a0e\u629c\u304d)')),\n...         When(plan=Sponsor.PLATINUM, then=Value(u'500,000\u5186 (\u7a0e\u629c\u304d)')),\n...         When(plan=Sponsor.GOLD, then=Value(u'300,000\u5186 (\u7a0e\u629c\u304d)')),\n...         When(plan=Sponsor.SILVER, then=Value(u'100,000\u5186 (\u7a0e\u629c\u304d)')),\n...         output_field=CharField(),\n...     ),\n... ).values_list('name', 'fee')\n[(u'Crazy Inc.', u'1,000,000\\u5186 (\\u7a0e\\u629c\\u304d)'), (u'Star Inc.', u'500,000\\u5186 (\\u7a0e\\u629c\\u304d)'), (u'Experience Inc.', u'300,000\\u5186 (\\u7a0e\\u629c\\u304d)'), (u'Giorno co., ltd.', u'300,000\\u5186 (\\u7a0e\\u629c\\u304d)'), (u'Chariot Inc.', u'100,000\\u5186 (\\u7a0e\\u629c\\u304d)'), (u'Polnareff co., ltd.', u'100,000\\u5186 (\\u7a0e\\u629c\\u304d)')]\n\n```\n\n`registered_on`\u306e\u5024\u306b\u5fdc\u3058\u3066`plan`\u3092\u66f4\u65b0\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\n```pycon\n>>> from django.db.models import Case, When, Value\n>>> from datetime import date,timedelta\n>>> a_week_ago = date.today() - timedelta(weeks=1)\n>>> a_month_ago = date.today() - timedelta(days=30)\n>>> Sponsor.objects.update(\n...     plan=Case(\n...         When(registered_on__lte=a_week_ago ,\n...              then=Value(Sponsor.PLATINUM)),\n...         When(registered_on__lte=a_month_ago,\n...              then=Value(Sponsor.GOLD)),\n...         default=Value(Sponsor.SILVER)\n...     ),\n... )\n>>> Sponsor.objects.values_list('name', 'plan')\n[(u'Crazy Inc.', u'P'), (u'Star Inc.', u'P'), (u'Experience Inc.', u'P'), (u'Giorno co., ltd.', u'S'), (u'Chariot Inc.', u'S'), (u'Polnareff co., ltd.', u'S')]\n\n```\n\n\u5404`plan`\u306b\u4f55\u793e\u5fdc\u52df\u3057\u305f\u306e\u304b\u8abf\u3079\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\n```pycon\n>>> from django.db.models import Case, When, Value, IntegerField, Sum\n>>> Sponsor.objects.aggregate(\n...     silver=Sum(\n...         Case(When(plan=Sponsor.SILVER, then=1),\n...              output_field=IntegerField())\n...     ),\n...     gold=Sum(\n...         Case(When(plan=Sponsor.GOLD, then=1),\n...              output_field=IntegerField())\n...     ),\n...     platinum=Sum(\n...         Case(When(plan=Sponsor.PLATINUM, then=1),\n...              output_field=IntegerField())\n...     )\n... )\n{'platinum': 3, 'silver': 3, 'gold': None}\n```\n\n## \u3069\u3093\u306aSQL\u304c\u4f5c\u3089\u308c\u3066\u3044\u308b\u306e\u304b\uff1f\n\n[djnago-debug-toolbar](https://pypi.python.org/pypi/django-debug-toolbar)\u306e`debugsqlshell`\u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u3063\u3066\u3001\u5b9f\u969b\u306b\u4f5c\u3089\u308c\u308bSQL\u3092\u898b\u3066\u307f\u307e\u3057\u3087\u3046\u3002[^2]\n\n```pycon\n>>> Sponsor.objects.annotate(\n...     fee=Case(\n...         When(plan=Sponsor.DIAMOND, then=Value(u'1,000,000\u5186 (\u7a0e\u629c\u304d)')),\n...         When(plan=Sponsor.PLATINUM, then=Value(u'500,000\u5186 (\u7a0e\u629c\u304d)')),\n...         When(plan=Sponsor.GOLD, then=Value(u'300,000\u5186 (\u7a0e\u629c\u304d)')),\n...         When(plan=Sponsor.SILVER, then=Value(u'100,000\u5186 (\u7a0e\u629c\u304d)')),\n...         output_field=CharField(),\n...     ),\n... ).values_list('name', 'fee')\nSELECT `sponsors_sponsor`.`name`,\n       CASE\n           WHEN `sponsors_sponsor`.`plan` = 'D' THEN '1,000,000\u5186 (\u7a0e\u629c\u304d)'\n           WHEN `sponsors_sponsor`.`plan` = 'P' THEN '500,000\u5186 (\u7a0e\u629c\u304d)'\n           WHEN `sponsors_sponsor`.`plan` = 'G' THEN '300,000\u5186 (\u7a0e\u629c\u304d)'\n           WHEN `sponsors_sponsor`.`plan` = 'S' THEN '100,000\u5186 (\u7a0e\u629c\u304d)'\n           ELSE NULL\n       END AS `fee`\nFROM `sponsors_sponsor` LIMIT 21 [0.23ms]\n\n>>> Sponsor.objects.update(\n...     plan=Case(\n...         When(registered_on__lte=a_week_ago ,\n...              then=Value(Sponsor.PLATINUM)),\n...         When(registered_on__lte=a_month_ago,\n...              then=Value(Sponsor.GOLD)),\n...         default=Value(Sponsor.SILVER)\n...     ),\n... )\nUPDATE `sponsors_sponsor`\nSET `plan` = CASE\n                 WHEN `sponsors_sponsor`.`registered_on` <= '2015-04-22' THEN 'P'\n                 WHEN `sponsors_sponsor`.`registered_on` <= '2015-03-30' THEN 'G'\n                 ELSE 'S'\n             END [0.62ms]\n\n>>> Sponsor.objects.aggregate(\n...     silver=Sum(\n...         Case(When(plan=Sponsor.SILVER, then=1),\n...              output_field=IntegerField())\n...     ),\n...     gold=Sum(\n...         Case(When(plan=Sponsor.GOLD, then=1),\n...              output_field=IntegerField())\n...     ),\n...     platinum=Sum(\n...         Case(When(plan=Sponsor.PLATINUM, then=1),\n...              output_field=IntegerField())\n...     )\n... )\nSELECT SUM(CASE WHEN `sponsors_sponsor`.`plan` = 'P' THEN 1 ELSE NULL END) AS `platinum`,\n       SUM(CASE WHEN `sponsors_sponsor`.`plan` = 'S' THEN 1 ELSE NULL END) AS `silver`,\n       SUM(CASE WHEN `sponsors_sponsor`.`plan` = 'G' THEN 1 ELSE NULL END) AS `gold`\nFROM `sponsors_sponsor` [0.32ms]\n```\n\n[^1]: [\u672c\u5bb6\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9](https://docs.djangoproject.com/en/1.8/ref/models/conditional-expressions/)\u3092[PyCon JP 2015\u30b9\u30dd\u30f3\u30b5\u30fc\u30b7\u30c3\u30d7\u306e\u3054\u6848\u5185](https://pycon.jp/2015/sponsors/prospectus.html)\u3092\u53c2\u8003\u306b\u6539\u5909\u3002\n[^2]: \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306fMySQL5.5.43\u3092\u4f7f\u3063\u3066\u3044\u307e\u3059\u3002\n", "tags": ["Django1.8", "Python"]}