{"tags": ["SQL", "\u30de\u30fc\u30b1\u30c6\u30a3\u30f3\u30b0", "\u30c7\u30fc\u30bf\u5206\u6790", "\u30b9\u30de\u30db\u30b2\u30fc\u30e0", "\u30a2\u30af\u30bb\u30b9\u89e3\u6790"], "context": " \u3053\u306e\u8a18\u4e8b\u306f\u6700\u7d42\u66f4\u65b0\u65e5\u304b\u30891\u5e74\u4ee5\u4e0a\u304c\u7d4c\u904e\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u3010 \uff33\uff31\uff2c \u3011\n\n\n\u3010 \u60f3\u5b9a\u3059\u308b\u30b5\u30f3\u30d7\u30eb\u30fbDB\u30c6\u30fc\u30d6\u30eb \u3011\n\n\n\u30c6\u30fc\u30d6\u30eb\u7269\u7406\u540d\uff1agame_event_item_log\n\n\n\u30ab\u30e9\u30e0\u7269\u7406\u540d \u203b\u8ffd\u3063\u3066\u3059\u3050\u306b\u8ffd\u8a18\u3002\n\n\n\uff1c \u4e3b\u554f\u3044\u5408\u308f\u305b\u6587\u306e select \u53e5 \u3067 \u53c2\u7167\u3055\u308c\u3066\u5f97\u3089\u308c\u308b\u30ab\u30e9\u30e0 \uff1e\n\n\ngame_event : \u30b2\u30fc\u30e0\u30a4\u30d9\u30f3\u30c8\uff08\u540d or ID\uff09\nrank_time_interval_Z_in_game_event\uff1a \uff08\u76f4\u8fd1\u30a4\u30d9\u30f3\u30c8\u30ed\u30b0\u30a4\u30f3\u6642\u70b9\u304b\u3089\u306e\uff09\u7d4c\u904e\u6642\u9593\uff08\u5206\uff09\u306e\u30a4\u30d9\u30f3\u30c8\u5185 \u77ed\u3055\u9806\u4f4d\uff08\u6607\u9806\uff09\nrecord_num_of_this_rank\uff1a\u305d\u306e\u30b2\u30fc\u30e0\u30a4\u30d9\u30f3\u30c8\u306e\u5168\u30ec\u30b3\u30fc\u30c9\u6570\uff08\uff1d\u305d\u306e\u30a4\u30d9\u30f3\u30c8\u306e\u5168\u53c2\u52a0\uff35\uff35\u306e\u7d2f\u8a08\u30ed\u30b0\u30a4\u30f3\uff08\u30fb\u9000\u51fa\uff09\u56de\u6570\nmax_rank_in_game_event\uff1a\u305d\u306e\u30b2\u30fc\u30e0\u30a4\u30d9\u30f3\u30c8\u306e\u9806\u4f4d\u306e\u5168\u6570\uff08\uff11\u4f4d\uff5e\u4f55\u4f4d\u307e\u3067\u3001\u9806\u4f4d\u304c\u4ed8\u3051\u3089\u308c\u305f\u30a4\u30d9\u30f3\u30c8\u30b0\u30eb\u30fc\u30d7\u306a\u306e\u304b\uff09\ntime_interval\uff1a\u3042\u308b\u30e6\u30fc\u30b6\u306e\uff08\u76f4\u8fd1\u30a4\u30d9\u30f3\u30c8\u30ed\u30b0\u30a4\u30f3\u6642\u70b9\u304b\u3089\u3001\u4eca\u56de\u30a4\u30d9\u30f3\u30c8\u518d\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u307e\u3067\u306b\u304b\u304b\u3063\u305f\uff09\u9000\u51fa \u7d4c\u904e\u6642\u9593\uff08\u5206\uff09\ntime_interval_Z_score_by_game_event_level\uff1a\u4e0a\u8a18 \u9000\u51fa\u7d4c\u904e\u6642\u9593\u3092\u3001\u305d\u306e\u30b2\u30fc\u30e0\u30a4\u30d9\u30f3\u30c8\u5185\u306e\u5168 \u9000\u51fa\u7d4c\u904e\u6642\u9593\u30ec\u30b3\u30fc\u30c9\u306e\u5e73\u5747\u3068\u6a19\u6e96\u504f\u5dee\u3067\u6a19\u6e96\u5316\u3057\u305f\uff3a\u5024\u30b9\u30b3\u30a2\uff08\u203b Z\u5024\uff1a \u5e73\u5747\uff1d\u30bc\u30ed\u3001\u6a19\u6e96\u504f\u5dee\uff1d\uff11\u306e\u6570\u5b57\uff09\nmin_Z_score_in_game_event\uff1a\u305d\u306e\u30b2\u30fc\u30e0\u30a4\u30d9\u30f3\u30c8\u5185\u306e \u5168\u9000\u51fa\u7d4c\u904e\u6642\u9593\u30ec\u30b3\u30fc\u30c9\u306eZ\u5024\u30b9\u30b3\u30a2\u5024\u306e\u3046\u3061\u3001\u6700\u3082\u5c0f\u3055\u3044\u6570\u5024\nmax_Z_score_in_game_event\uff1a\u305d\u306e\u30b2\u30fc\u30e0\u30a4\u30d9\u30f3\u30c8\u5185\u306e \u5168\u9000\u51fa\u7d4c\u904e\u6642\u9593\u30ec\u30b3\u30fc\u30c9\u306eZ\u5024\u30b9\u30b3\u30a2\u5024\u306e\u3046\u3061\u3001\u6700\u3082\u5927\u304d\u3044\u6570\u5024\nuser_id\uff1a\u30b2\u30fc\u30e0\u30a4\u30d9\u30f3\u30c8\u53c2\u52a0\u30e6\u30fc\u30b6ID\ndatetime: \u30b2\u30fc\u30e0\u30a4\u30d9\u30f3\u30c8\u53c2\u52a0\uff08\u30ed\u30b0\u30a4\u30f3\uff09\u6642\u523b\uff08\u79d2\u523b\u307f YYYY-MM-DD HH24:MI:SS\uff09\nlatest\uff1a \u4e0a\u8a18\u30ed\u30b0\u30a4\u30f3\u6642\u523b\u306e\u76f4\u8fd1\uff08\uff11\u56de\u524d\u306b\u3001\u540c\u3058\u30e6\u30fc\u30b6\u304c\u540c\u3058\u30a4\u30d9\u30f3\u30c8\u306b\uff09\u30ed\u30b0\u30a4\u30f3\u3057\u305f\u904e\u53bb\u6642\u523b\uff08\u79d2\u523b\u307f YYYY-MM-DD HH24:MI:SS\uff09\n\n\n\n\uff1c \u30ec\u30b3\u30fc\u30c9\u8868\u793a\u9806 \uff1e\n\norder by game_event, rank_time_interval_Z_in_game_event, datetime desc, user_id\n\n\uff1c \uff33\uff31\uff2c \uff1e\n\n\nSQL\nWith temp AS (\nSELECT tbl_0.game_event,\n       tbl_0.user_id, \n       tbl_0.datetime,\n        (SELECT MAX(datetime)\n         FROM game_event_item_log tbl_1\n         where tbl_1.datetime < tbl_0.datetime) AS latest\nFROM game_event_item_log tbl_0\ngroup by tbl_0.game_event, tbl_0.user_id, tbl_0.datetime\norder by tbl_0.game_event, tbl_0.user_id, tbl_0.datetime desc\n), temp_2 AS (\nSELECT  game_event,\n        user_id,\n        datetime,\n        latest, \n        abs(datediff(minute,datetime, latest)) AS time_interval\nFROM temp\norder by game_event, user_id, datetime desc\n), temp_3 AS (\nSELECT *,\n       avg(time_interval) over(partition by game_event) AS AVG_event_interval_per_game_event,\n       round((stddev(time_interval) over(partition by game_event)), 1) AS SDTDEV_event_interval_per_game_event\nfrom temp_2\norder by game_event, user_id, datetime desc\n), temp_4 AS (\nselect game_event,\n       user_id,\n       datetime,\n       latest,\n       time_interval,\n       round((time_interval - AVG_event_interval_per_game_event) / SDTDEV_event_interval_per_game_event, 5) AS time_interval_Z_score_by_game_event_level\nfrom temp_3\norder by game_event, user_id, datetime desc  \n), temp_5 AS (\nselect *,\n       dense_rank() over(partition by game_event order by time_interval_Z_score_by_game_event_level) AS rank_time_interval_Z_in_game_event,\n       min(time_interval_Z_score_by_game_event_level) over(partition by game_event) AS min_Z_score_in_game_event,\n       max(time_interval_Z_score_by_game_event_level) over(partition by game_event) AS max_Z_score_in_game_event\nfrom temp_4\norder by game_event, rank_time_interval_Z_in_game_event, datetime desc, user_id\n)\nselect game_event,\n       rank_time_interval_Z_in_game_event,\n       count(*) over(partition by game_event, rank_time_interval_Z_in_game_event) AS record_num_of_this_rank,\n       max(rank_time_interval_Z_in_game_event) over(partition by game_event) AS max_rank_in_game_event,\n       time_interval,\n       time_interval_Z_score_by_game_event_level,\n       min_Z_score_in_game_event,\n       max_Z_score_in_game_event,\n       user_id,\n       datetime,\n       latest      \nfrom temp_5\norder by game_event, rank_time_interval_Z_in_game_event, datetime desc, user_id\n;      \n\n\n\n\n\u3010 \u6700\u7d42\u5f62\u306b\u3044\u304f\u3064\u304f\u307e\u3067\u306e\u30af\u30a8\u30ea\u4f5c\u6210\u904e\u7a0b \u3011\n\n\uff11\uff0e\n\u30a4\u30d9\u30f3\u30c8\u76ee\u7684\uff08game_event\u5217\uff09\u5225\u306b\u30c7\u30fc\u30bf\u3092\u30b0\u30eb\u30fc\u30d7\u5206\u3051\u3057\u305f\u4e0a\u3067\u3001\n\u5404\u30b0\u30eb\u30fc\u30d7\u5185\u306e\u500b\u3005\u306e\u30e6\u30fc\u30b6\u306b\u3064\u3044\u3066\u3001\n\u30a4\u30d9\u30f3\u30c8\u767a\u751f\u6642\u523b\u3068 \u305d\u306e\uff11\u56de\u524d\u306e\u30a4\u30d9\u30f3\u30c8\u767a\u751f\u6642\u523b\u306e\u30da\u30a2\uff082\u56de\u5206\u306e\u30a4\u30d9\u30f3\u30c8\u306e\u767a\u751f\u6642\u523b\uff09\u3092\u3001\n\u6642\u9593\u964d\u9806\uff08\u76f4\u8fd1\u306e\u3082\u306e\u304b\u3089\uff09\u8868\u793a\u3002\n\u30a4\u30d9\u30f3\u30c8\u767a\u751f\u9593\u9694\u3092\u3001\n\u300c\u30a4\u30d9\u30f3\u30c8\u767a\u751f\u6642\u523b\u300d\uff0d \u300c\u305d\u306e\uff11\u56de\u524d\u306e\u30a4\u30d9\u30f3\u30c8\u767a\u751f\u6642\u523b\u300d\n\u3067\u7b97\u51fa\u3057\u3066\u3001\u5404\u884c\u306e\u6700\u5f8c\u5217\u306b\u8ffd\u52a0\u3002\uff08time_interval \u5217\uff09\n\nSQL\nWith temp AS (\nSELECT tbl_0.game_event,\n       tbl_0.user_id, \n       tbl_0.datetime,\n        (SELECT MAX(datetime)\n         FROM game_event_item_log tbl_1\n         where tbl_1.datetime < tbl_0.datetime) AS latest\nFROM game_event_item_log tbl_0\ngroup by tbl_0.game_event, tbl_0.user_id, tbl_0.datetime\norder by tbl_0.game_event, tbl_0.user_id, tbl_0.datetime desc\n) \nSELECT  game_event,\n        user_id,\n        datetime,\n        latest, \n        abs(datediff(minute,datetime, latest)) AS time_interval\nFROM temp\norder by game_event, user_id, datetime desc\n;\n\n\n\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\n\uff12\uff0e\n\uff11\u306b\u4ee5\u4e0b\u306e\u5217\u3092\u8ffd\u52a0\u3002\n\u5404\u300cgame_event \u00d7 \u30e6\u30fc\u30b6\u300d\u5225\u306b\u30ec\u30b3\u30fc\u30c9\u3092\u30b0\u30eb\u30fc\u30d7\u5206\u3051\u3057\u305f\uff11\u306e\u96c6\u8a08\u306b\u3001\n\u30b0\u30eb\u30fc\u30d7\u5185\u3067\u306e time_interval \u5217 \u306e\u5e73\u5747\u5024\uff08\u6642\u9593\uff09\u5217 \u3068\u6a19\u6e96\u504f\u5dee\uff08\u6642\u9593\uff09\u5217 \u3092 \u8ffd\u52a0\u3002\n\nSQL\nWith temp AS (\nSELECT tbl_0.game_event,\n       tbl_0.user_id, \n       tbl_0.datetime,\n        (SELECT MAX(datetime)\n         FROM game_event_item_log tbl_1\n         where tbl_1.datetime < tbl_0.datetime) AS latest\nFROM game_event_item_log tbl_0\ngroup by tbl_0.game_event, tbl_0.user_id, tbl_0.datetime\norder by tbl_0.game_event, tbl_0.user_id, tbl_0.datetime desc\n), temp_2 AS (\nSELECT  game_event,\n        user_id,\n        datetime,\n        latest, \n        abs(datediff(minute,datetime, latest)) AS time_interval\nFROM temp\norder by game_event, user_id, datetime desc\n)\nSELECT *,\n       avg(time_interval) over(partition by game_event, user_id) AS AVG_event_interval_per_game_event_user,\n       round((stddev(time_interval) over(partition by game_event, user_id)), 1) AS SDTDEV_event_interval_per_game_event_user\nfrom temp_2\norder by game_event, user_id, datetime desc\n;      \n\n\n\n\uff0a game_event \u00d7 \u30e6\u30fc\u30b6 \u30b0\u30eb\u30fc\u30d7\u3054\u3068\u306e time_interval \u5e73\u5747\u5024\u3068\u6a19\u6e96\u504f\u5dee\u306f\u3001\u4ee5\u4e0b\u306egroup by\u3067\u3082\u96c6\u8a08\u3067\u304d\u308b\u3002\n\u3057\u304b\u3057\u3001group by \u3060\u3068\u3001\u4e3b\u554f\u3044\u5408\u308f\u305b\u6587\u3067 select \u3067\u304d\u308b\u30ab\u30e9\u30e0\u306f group by \u3067\u6307\u5b9a\u3057\u305f\u30ab\u30e9\u30e0\u306b\u9650\u3089\u308c\u308b\u3002\n\nlimited_sql\nWith temp AS (\nSELECT tbl_0.game_event,\n       tbl_0.user_id, \n       tbl_0.datetime,\n        (SELECT MAX(datetime)\n         FROM game_event_item_log tbl_1\n         where tbl_1.datetime < tbl_0.datetime) AS latest\nFROM game_event_item_log tbl_0\ngroup by tbl_0.game_event, tbl_0.user_id, tbl_0.datetime\norder by tbl_0.game_event, tbl_0.user_id, tbl_0.datetime desc\n), temp_2 AS (\nSELECT  game_event,\n        user_id,\n        datetime,\n        latest, \n        abs(datediff(minute,datetime, latest)) AS time_interval\nFROM temp\norder by game_event, user_id, datetime desc\n)\nSELECT game_event,\n       user_id,\n       avg(time_interval) AS AVG_event_interval_per_game_event_user,\n       round(stddev(time_interval), 1) AS SDTDEV_event_interval_per_game_event_user\nfrom temp_2\ngroup by game_event, user_id\norder by game_event, user_id\n;      \n\n\n\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\n\uff13\uff0e\n\uff12\u306b\u3001\u4ee5\u4e0b\u306e\u5217\u3092\u8ffd\u52a0\u3002\n\u3088\u308a\u96c6\u8a08\u7c92\u5ea6\u306e\u5927\u304d\u3044\u3001\u300cgame_event\u300d\u6b21\u5143\uff08\u6c34\u6e96\uff09\u30b0\u30eb\u30fc\u30d7\u5185\u3067\u306e time_interval \u5217 \u306e \u5e73\u5747\u5024 \u3068 \u6a19\u6e96\u504f\u5dee \u5217\u3002\n\nSQL\nWith temp AS (\nSELECT tbl_0.game_event,\n       tbl_0.user_id, \n       tbl_0.datetime,\n        (SELECT MAX(datetime)\n         FROM game_event_item_log tbl_1\n         where tbl_1.datetime < tbl_0.datetime) AS latest\nFROM game_event_item_log tbl_0\ngroup by tbl_0.game_event, tbl_0.user_id, tbl_0.datetime\norder by tbl_0.game_event, tbl_0.user_id, tbl_0.datetime desc\n), temp_2 AS (\nSELECT  game_event,\n        user_id,\n        datetime,\n        latest, \n        abs(datediff(minute,datetime, latest)) AS time_interval\nFROM temp\norder by game_event, user_id, datetime desc\n)\nSELECT *,\n       avg(time_interval) over(partition by game_event, user_id) AS AVG_event_interval_per_game_event_user,\n       round((stddev(time_interval) over(partition by game_event, user_id)), 1) AS SDTDEV_event_interval_per_game_event_user,\n       avg(time_interval) over(partition by game_event) AS AVG_event_interval_per_game_event,\n       round((stddev(time_interval) over(partition by game_event)), 1) AS SDTDEV_event_interval_per_game_event\nfrom temp_2\norder by game_event, user_id, datetime desc\n;      \n\n\n\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\n\uff14\uff0e\n3\u306b\u4ee5\u4e0b\u306e\u5217\u3092\u8ffd\u52a0\u3002\ngame_event \u00d7 \u30e6\u30fc\u30b6 \u30b0\u30eb\u30fc\u30d7\u3054\u3068\u306e time_interval\uff08\uff1d\u300c\u30a4\u30d9\u30f3\u30c8\u767a\u751f\u6642\u523b\u300d\uff0d \u300c\u305d\u306e\uff11\u56de\u524d\u306e\u30a4\u30d9\u30f3\u30c8\u767a\u751f\u6642\u523b\u300d\uff09\n\u3092\u3001\u300cgame_event\u300d\u6b21\u5143\uff08\u6c34\u6e96\uff09\u30b0\u30eb\u30fc\u30d7\u5185\u3067\u306e time_interval \u5217 \u306e \u5e73\u5747\u5024 \u3068 \u6a19\u6e96\u504f\u5dee \u5217 \u3067\u300c\u6a19\u6e96\u5316\uff08Z\u5024\uff09\u300d\n\u3057\u305f\u3001\ngame_event \u00d7 \u30e6\u30fc\u30b6 \u30b0\u30eb\u30fc\u30d7\u3054\u3068\u306e time_interval\uff08\uff1d\u300c\u30a4\u30d9\u30f3\u30c8\u767a\u751f\u6642\u523b\u300d\uff0d \u300c\u305d\u306e\uff11\u56de\u524d\u306e\u30a4\u30d9\u30f3\u30c8\u767a\u751f\u6642\u523b\u300d\u306eZ\u5024 \u5217\n\nSQL_Z_score\nWith temp AS (\nSELECT tbl_0.game_event,\n       tbl_0.user_id, \n       tbl_0.datetime,\n        (SELECT MAX(datetime)\n         FROM game_event_item_log tbl_1\n         where tbl_1.datetime < tbl_0.datetime) AS latest\nFROM game_event_item_log tbl_0\ngroup by tbl_0.game_event, tbl_0.user_id, tbl_0.datetime\norder by tbl_0.game_event, tbl_0.user_id, tbl_0.datetime desc\n), temp_2 AS (\nSELECT  game_event,\n        user_id,\n        datetime,\n        latest, \n        abs(datediff(minute,datetime, latest)) AS time_interval\nFROM temp\norder by game_event, user_id, datetime desc\n), temp_3 AS (\nSELECT *,\n       avg(time_interval) over(partition by game_event) AS AVG_event_interval_per_game_event,\n       round((stddev(time_interval) over(partition by game_event)), 1) AS SDTDEV_event_interval_per_game_event\nfrom temp_2\norder by game_event, user_id, datetime desc\n)\nselect game_event,\n       user_id,\n       datetime,\n       latest,\n       time_interval,\n       round((time_interval - AVG_event_interval_per_game_event) / SDTDEV_event_interval_per_game_event, 5) AS time_interval_Z_score_by_game_event_level\nfrom temp_3\norder by game_event, user_id, datetime desc    \n;      \n\n\n\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\n\u7d50\u679c\u30ec\u30b3\u30fc\u30c9\u306e\u4e26\u3073\u66ff\u3048\u9806\u5e8f\u3092\u4ee5\u4e0b\u306b\u5909\u66f4\u3002\norder by game_event, time_interval_Z_score_by_game_event_level, user_id, datetime desc\n\nSQL\nWith temp AS (\nSELECT tbl_0.game_event,\n       tbl_0.user_id, \n       tbl_0.datetime,\n        (SELECT MAX(datetime)\n         FROM game_event_item_log tbl_1\n         where tbl_1.datetime < tbl_0.datetime) AS latest\nFROM game_event_item_log tbl_0\ngroup by tbl_0.game_event, tbl_0.user_id, tbl_0.datetime\norder by tbl_0.game_event, tbl_0.user_id, tbl_0.datetime desc\n), temp_2 AS (\nSELECT  game_event,\n        user_id,\n        datetime,\n        latest, \n        abs(datediff(minute,datetime, latest)) AS time_interval\nFROM temp\norder by game_event, user_id, datetime desc\n), temp_3 AS (\nSELECT *,\n       avg(time_interval) over(partition by game_event) AS AVG_event_interval_per_game_event,\n       round((stddev(time_interval) over(partition by game_event)), 1) AS SDTDEV_event_interval_per_game_event\nfrom temp_2\norder by game_event, user_id, datetime desc\n)\nselect game_event,\n       user_id,\n       datetime,\n       latest,\n       time_interval,\n       round((time_interval - AVG_event_interval_per_game_event) / SDTDEV_event_interval_per_game_event, 5) AS time_interval_Z_score_by_game_event_level\nfrom temp_3\norder by game_event, time_interval_Z_score_by_game_event_level, user_id, datetime desc     \n;      \n\n\n\n\n#__\u3010 \uff33\uff31\uff2c \u3011__\n\n### __\u3010 \u60f3\u5b9a\u3059\u308b\u30b5\u30f3\u30d7\u30eb\u30fbDB\u30c6\u30fc\u30d6\u30eb \u3011__\n\n#### __\u30c6\u30fc\u30d6\u30eb\u7269\u7406\u540d\uff1agame_event_item_log__\n\n#### __\u30ab\u30e9\u30e0\u7269\u7406\u540d__ \u203b\u8ffd\u3063\u3066\u3059\u3050\u306b\u8ffd\u8a18\u3002\n\n\n___\n\n### __\uff1c \u4e3b\u554f\u3044\u5408\u308f\u305b\u6587\u306e select \u53e5 \u3067 \u53c2\u7167\u3055\u308c\u3066\u5f97\u3089\u308c\u308b\u30ab\u30e9\u30e0 \uff1e__\n\n- game_event : \u30b2\u30fc\u30e0\u30a4\u30d9\u30f3\u30c8\uff08\u540d or ID\uff09\n- rank_time_interval_Z_in_game_event\uff1a \uff08\u76f4\u8fd1\u30a4\u30d9\u30f3\u30c8\u30ed\u30b0\u30a4\u30f3\u6642\u70b9\u304b\u3089\u306e\uff09\u7d4c\u904e\u6642\u9593\uff08\u5206\uff09\u306e\u30a4\u30d9\u30f3\u30c8\u5185 \u77ed\u3055\u9806\u4f4d\uff08\u6607\u9806\uff09\n- record_num_of_this_rank\uff1a\u305d\u306e\u30b2\u30fc\u30e0\u30a4\u30d9\u30f3\u30c8\u306e\u5168\u30ec\u30b3\u30fc\u30c9\u6570\uff08\uff1d\u305d\u306e\u30a4\u30d9\u30f3\u30c8\u306e\u5168\u53c2\u52a0\uff35\uff35\u306e\u7d2f\u8a08\u30ed\u30b0\u30a4\u30f3\uff08\u30fb\u9000\u51fa\uff09\u56de\u6570\n- max_rank_in_game_event\uff1a\u305d\u306e\u30b2\u30fc\u30e0\u30a4\u30d9\u30f3\u30c8\u306e\u9806\u4f4d\u306e\u5168\u6570\uff08\uff11\u4f4d\uff5e\u4f55\u4f4d\u307e\u3067\u3001\u9806\u4f4d\u304c\u4ed8\u3051\u3089\u308c\u305f\u30a4\u30d9\u30f3\u30c8\u30b0\u30eb\u30fc\u30d7\u306a\u306e\u304b\uff09\n- time_interval\uff1a\u3042\u308b\u30e6\u30fc\u30b6\u306e\uff08\u76f4\u8fd1\u30a4\u30d9\u30f3\u30c8\u30ed\u30b0\u30a4\u30f3\u6642\u70b9\u304b\u3089\u3001\u4eca\u56de\u30a4\u30d9\u30f3\u30c8\u518d\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u307e\u3067\u306b\u304b\u304b\u3063\u305f\uff09\u9000\u51fa \u7d4c\u904e\u6642\u9593\uff08\u5206\uff09\n- time_interval_Z_score_by_game_event_level\uff1a\u4e0a\u8a18 \u9000\u51fa\u7d4c\u904e\u6642\u9593\u3092\u3001\u305d\u306e\u30b2\u30fc\u30e0\u30a4\u30d9\u30f3\u30c8\u5185\u306e\u5168 \u9000\u51fa\u7d4c\u904e\u6642\u9593\u30ec\u30b3\u30fc\u30c9\u306e\u5e73\u5747\u3068\u6a19\u6e96\u504f\u5dee\u3067\u6a19\u6e96\u5316\u3057\u305f\uff3a\u5024\u30b9\u30b3\u30a2\uff08\u203b Z\u5024\uff1a \u5e73\u5747\uff1d\u30bc\u30ed\u3001\u6a19\u6e96\u504f\u5dee\uff1d\uff11\u306e\u6570\u5b57\uff09\n- min_Z_score_in_game_event\uff1a\u305d\u306e\u30b2\u30fc\u30e0\u30a4\u30d9\u30f3\u30c8\u5185\u306e \u5168\u9000\u51fa\u7d4c\u904e\u6642\u9593\u30ec\u30b3\u30fc\u30c9\u306eZ\u5024\u30b9\u30b3\u30a2\u5024\u306e\u3046\u3061\u3001\u6700\u3082\u5c0f\u3055\u3044\u6570\u5024\n- max_Z_score_in_game_event\uff1a\u305d\u306e\u30b2\u30fc\u30e0\u30a4\u30d9\u30f3\u30c8\u5185\u306e \u5168\u9000\u51fa\u7d4c\u904e\u6642\u9593\u30ec\u30b3\u30fc\u30c9\u306eZ\u5024\u30b9\u30b3\u30a2\u5024\u306e\u3046\u3061\u3001\u6700\u3082\u5927\u304d\u3044\u6570\u5024\n- user_id\uff1a\u30b2\u30fc\u30e0\u30a4\u30d9\u30f3\u30c8\u53c2\u52a0\u30e6\u30fc\u30b6ID\n- datetime: \u30b2\u30fc\u30e0\u30a4\u30d9\u30f3\u30c8\u53c2\u52a0\uff08\u30ed\u30b0\u30a4\u30f3\uff09\u6642\u523b\uff08\u79d2\u523b\u307f YYYY-MM-DD HH24:MI:SS\uff09\n- latest\uff1a \u4e0a\u8a18\u30ed\u30b0\u30a4\u30f3\u6642\u523b\u306e\u76f4\u8fd1\uff08\uff11\u56de\u524d\u306b\u3001\u540c\u3058\u30e6\u30fc\u30b6\u304c\u540c\u3058\u30a4\u30d9\u30f3\u30c8\u306b\uff09\u30ed\u30b0\u30a4\u30f3\u3057\u305f\u904e\u53bb\u6642\u523b\uff08\u79d2\u523b\u307f YYYY-MM-DD HH24:MI:SS\uff09\t   \n\n\n### __\uff1c \u30ec\u30b3\u30fc\u30c9\u8868\u793a\u9806 \uff1e__\n\norder by game_event, rank_time_interval_Z_in_game_event, datetime desc, user_id\n\n\n### __\uff1c \uff33\uff31\uff2c \uff1e__\n\n```{SQL:SQL}\nWith temp AS (\nSELECT tbl_0.game_event,\n       tbl_0.user_id, \n       tbl_0.datetime,\n        (SELECT MAX(datetime)\n\t\t FROM game_event_item_log tbl_1\n\t\t where tbl_1.datetime < tbl_0.datetime) AS latest\nFROM game_event_item_log tbl_0\ngroup by tbl_0.game_event, tbl_0.user_id, tbl_0.datetime\norder by tbl_0.game_event, tbl_0.user_id, tbl_0.datetime desc\n), temp_2 AS (\nSELECT  game_event,\n        user_id,\n        datetime,\n\t\tlatest,\t\n\t\tabs(datediff(minute,datetime, latest)) AS time_interval\nFROM temp\norder by game_event, user_id, datetime desc\n), temp_3 AS (\nSELECT *,\n       avg(time_interval) over(partition by game_event) AS AVG_event_interval_per_game_event,\n\t   round((stddev(time_interval) over(partition by game_event)), 1) AS SDTDEV_event_interval_per_game_event\nfrom temp_2\norder by game_event, user_id, datetime desc\n), temp_4 AS (\nselect game_event,\n       user_id,\n\t   datetime,\n\t   latest,\n\t   time_interval,\n\t   round((time_interval - AVG_event_interval_per_game_event) / SDTDEV_event_interval_per_game_event, 5) AS time_interval_Z_score_by_game_event_level\nfrom temp_3\norder by game_event, user_id, datetime desc\t \n), temp_5 AS (\nselect *,\n       dense_rank() over(partition by game_event order by time_interval_Z_score_by_game_event_level) AS rank_time_interval_Z_in_game_event,\n\t   min(time_interval_Z_score_by_game_event_level) over(partition by game_event) AS min_Z_score_in_game_event,\n\t   max(time_interval_Z_score_by_game_event_level) over(partition by game_event) AS max_Z_score_in_game_event\nfrom temp_4\norder by game_event, rank_time_interval_Z_in_game_event, datetime desc, user_id\n)\nselect game_event,\n       rank_time_interval_Z_in_game_event,\n\t   count(*) over(partition by game_event, rank_time_interval_Z_in_game_event) AS record_num_of_this_rank,\n       max(rank_time_interval_Z_in_game_event) over(partition by game_event) AS max_rank_in_game_event,\n\t   time_interval,\n\t   time_interval_Z_score_by_game_event_level,\n\t   min_Z_score_in_game_event,\n\t   max_Z_score_in_game_event,\n\t   user_id,\n\t   datetime,\n\t   latest\t   \nfrom temp_5\norder by game_event, rank_time_interval_Z_in_game_event, datetime desc, user_id\n;\t   \n```\n\n___\n\n# **\u3010 \u6700\u7d42\u5f62\u306b\u3044\u304f\u3064\u304f\u307e\u3067\u306e\u30af\u30a8\u30ea\u4f5c\u6210\u904e\u7a0b \u3011**\n\n\uff11\uff0e\n\n\u30a4\u30d9\u30f3\u30c8\u76ee\u7684\uff08game_event\u5217\uff09\u5225\u306b\u30c7\u30fc\u30bf\u3092\u30b0\u30eb\u30fc\u30d7\u5206\u3051\u3057\u305f\u4e0a\u3067\u3001\n\u5404\u30b0\u30eb\u30fc\u30d7\u5185\u306e\u500b\u3005\u306e\u30e6\u30fc\u30b6\u306b\u3064\u3044\u3066\u3001\n\u30a4\u30d9\u30f3\u30c8\u767a\u751f\u6642\u523b\u3068 \u305d\u306e\uff11\u56de\u524d\u306e\u30a4\u30d9\u30f3\u30c8\u767a\u751f\u6642\u523b\u306e\u30da\u30a2\uff082\u56de\u5206\u306e\u30a4\u30d9\u30f3\u30c8\u306e\u767a\u751f\u6642\u523b\uff09\u3092\u3001\n\u6642\u9593\u964d\u9806\uff08\u76f4\u8fd1\u306e\u3082\u306e\u304b\u3089\uff09\u8868\u793a\u3002\n\n\u30a4\u30d9\u30f3\u30c8\u767a\u751f\u9593\u9694\u3092\u3001\n\u300c\u30a4\u30d9\u30f3\u30c8\u767a\u751f\u6642\u523b\u300d\uff0d \u300c\u305d\u306e\uff11\u56de\u524d\u306e\u30a4\u30d9\u30f3\u30c8\u767a\u751f\u6642\u523b\u300d\n\u3067\u7b97\u51fa\u3057\u3066\u3001\u5404\u884c\u306e\u6700\u5f8c\u5217\u306b\u8ffd\u52a0\u3002\uff08time_interval \u5217\uff09\n\n\n```{SQL:SQL}\nWith temp AS (\nSELECT tbl_0.game_event,\n       tbl_0.user_id, \n       tbl_0.datetime,\n        (SELECT MAX(datetime)\n\t\t FROM game_event_item_log tbl_1\n\t\t where tbl_1.datetime < tbl_0.datetime) AS latest\nFROM game_event_item_log tbl_0\ngroup by tbl_0.game_event, tbl_0.user_id, tbl_0.datetime\norder by tbl_0.game_event, tbl_0.user_id, tbl_0.datetime desc\n) \nSELECT  game_event,\n        user_id,\n        datetime,\n\t\tlatest,\t\n\t\tabs(datediff(minute,datetime, latest)) AS time_interval\nFROM temp\norder by game_event, user_id, datetime desc\n;\n```\n\n\n\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\n\n\uff12\uff0e\n\n\uff11\u306b\u4ee5\u4e0b\u306e\u5217\u3092\u8ffd\u52a0\u3002\n\n\u5404\u300cgame_event \u00d7 \u30e6\u30fc\u30b6\u300d\u5225\u306b\u30ec\u30b3\u30fc\u30c9\u3092\u30b0\u30eb\u30fc\u30d7\u5206\u3051\u3057\u305f\uff11\u306e\u96c6\u8a08\u306b\u3001\n\u30b0\u30eb\u30fc\u30d7\u5185\u3067\u306e time_interval \u5217 \u306e\u5e73\u5747\u5024\uff08\u6642\u9593\uff09\u5217 \u3068\u6a19\u6e96\u504f\u5dee\uff08\u6642\u9593\uff09\u5217 \u3092 \u8ffd\u52a0\u3002\n\n```{SQL:SQL}\nWith temp AS (\nSELECT tbl_0.game_event,\n       tbl_0.user_id, \n       tbl_0.datetime,\n        (SELECT MAX(datetime)\n\t\t FROM game_event_item_log tbl_1\n\t\t where tbl_1.datetime < tbl_0.datetime) AS latest\nFROM game_event_item_log tbl_0\ngroup by tbl_0.game_event, tbl_0.user_id, tbl_0.datetime\norder by tbl_0.game_event, tbl_0.user_id, tbl_0.datetime desc\n), temp_2 AS (\nSELECT  game_event,\n        user_id,\n        datetime,\n\t\tlatest,\t\n\t\tabs(datediff(minute,datetime, latest)) AS time_interval\nFROM temp\norder by game_event, user_id, datetime desc\n)\nSELECT *,\n       avg(time_interval) over(partition by game_event, user_id) AS AVG_event_interval_per_game_event_user,\n\t   round((stddev(time_interval) over(partition by game_event, user_id)), 1) AS SDTDEV_event_interval_per_game_event_user\nfrom temp_2\norder by game_event, user_id, datetime desc\n;\t   \n```\n\n\n___\n\n\n\uff0a game_event \u00d7 \u30e6\u30fc\u30b6 \u30b0\u30eb\u30fc\u30d7\u3054\u3068\u306e time_interval \u5e73\u5747\u5024\u3068\u6a19\u6e96\u504f\u5dee\u306f\u3001\u4ee5\u4e0b\u306egroup by\u3067\u3082\u96c6\u8a08\u3067\u304d\u308b\u3002\n\u3057\u304b\u3057\u3001group by \u3060\u3068\u3001\u4e3b\u554f\u3044\u5408\u308f\u305b\u6587\u3067 select \u3067\u304d\u308b\u30ab\u30e9\u30e0\u306f group by \u3067\u6307\u5b9a\u3057\u305f\u30ab\u30e9\u30e0\u306b\u9650\u3089\u308c\u308b\u3002\n\n```{SQL:limited_sql}\nWith temp AS (\nSELECT tbl_0.game_event,\n       tbl_0.user_id, \n       tbl_0.datetime,\n        (SELECT MAX(datetime)\n\t\t FROM game_event_item_log tbl_1\n\t\t where tbl_1.datetime < tbl_0.datetime) AS latest\nFROM game_event_item_log tbl_0\ngroup by tbl_0.game_event, tbl_0.user_id, tbl_0.datetime\norder by tbl_0.game_event, tbl_0.user_id, tbl_0.datetime desc\n), temp_2 AS (\nSELECT  game_event,\n        user_id,\n        datetime,\n\t\tlatest,\t\n\t\tabs(datediff(minute,datetime, latest)) AS time_interval\nFROM temp\norder by game_event, user_id, datetime desc\n)\nSELECT game_event,\n       user_id,\n       avg(time_interval) AS AVG_event_interval_per_game_event_user,\n\t   round(stddev(time_interval), 1) AS SDTDEV_event_interval_per_game_event_user\nfrom temp_2\ngroup by game_event, user_id\norder by game_event, user_id\n;\t   \n```\n\n\n\n\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\n\n\n\n\uff13\uff0e\n\n\uff12\u306b\u3001\u4ee5\u4e0b\u306e\u5217\u3092\u8ffd\u52a0\u3002\n\n\u3088\u308a\u96c6\u8a08\u7c92\u5ea6\u306e\u5927\u304d\u3044\u3001\u300cgame_event\u300d\u6b21\u5143\uff08\u6c34\u6e96\uff09\u30b0\u30eb\u30fc\u30d7\u5185\u3067\u306e time_interval \u5217 \u306e \u5e73\u5747\u5024 \u3068 \u6a19\u6e96\u504f\u5dee \u5217\u3002\n\n```{SQL:SQL}\nWith temp AS (\nSELECT tbl_0.game_event,\n       tbl_0.user_id, \n       tbl_0.datetime,\n        (SELECT MAX(datetime)\n\t\t FROM game_event_item_log tbl_1\n\t\t where tbl_1.datetime < tbl_0.datetime) AS latest\nFROM game_event_item_log tbl_0\ngroup by tbl_0.game_event, tbl_0.user_id, tbl_0.datetime\norder by tbl_0.game_event, tbl_0.user_id, tbl_0.datetime desc\n), temp_2 AS (\nSELECT  game_event,\n        user_id,\n        datetime,\n\t\tlatest,\t\n\t\tabs(datediff(minute,datetime, latest)) AS time_interval\nFROM temp\norder by game_event, user_id, datetime desc\n)\nSELECT *,\n       avg(time_interval) over(partition by game_event, user_id) AS AVG_event_interval_per_game_event_user,\n\t   round((stddev(time_interval) over(partition by game_event, user_id)), 1) AS SDTDEV_event_interval_per_game_event_user,\n\t   avg(time_interval) over(partition by game_event) AS AVG_event_interval_per_game_event,\n\t   round((stddev(time_interval) over(partition by game_event)), 1) AS SDTDEV_event_interval_per_game_event\nfrom temp_2\norder by game_event, user_id, datetime desc\n;\t   \n```\n\n\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\n\n\uff14\uff0e\n\n3\u306b\u4ee5\u4e0b\u306e\u5217\u3092\u8ffd\u52a0\u3002\n\ngame_event \u00d7 \u30e6\u30fc\u30b6 \u30b0\u30eb\u30fc\u30d7\u3054\u3068\u306e time_interval\uff08\uff1d\u300c\u30a4\u30d9\u30f3\u30c8\u767a\u751f\u6642\u523b\u300d\uff0d \u300c\u305d\u306e\uff11\u56de\u524d\u306e\u30a4\u30d9\u30f3\u30c8\u767a\u751f\u6642\u523b\u300d\uff09\n\u3092\u3001\u300cgame_event\u300d\u6b21\u5143\uff08\u6c34\u6e96\uff09\u30b0\u30eb\u30fc\u30d7\u5185\u3067\u306e time_interval \u5217 \u306e \u5e73\u5747\u5024 \u3068 \u6a19\u6e96\u504f\u5dee \u5217 \u3067\u300c\u6a19\u6e96\u5316\uff08Z\u5024\uff09\u300d\n\u3057\u305f\u3001\ngame_event \u00d7 \u30e6\u30fc\u30b6 \u30b0\u30eb\u30fc\u30d7\u3054\u3068\u306e time_interval\uff08\uff1d\u300c\u30a4\u30d9\u30f3\u30c8\u767a\u751f\u6642\u523b\u300d\uff0d \u300c\u305d\u306e\uff11\u56de\u524d\u306e\u30a4\u30d9\u30f3\u30c8\u767a\u751f\u6642\u523b\u300d\u306eZ\u5024 \u5217\n\n\n```{SQL:SQL_Z_score}\nWith temp AS (\nSELECT tbl_0.game_event,\n       tbl_0.user_id, \n       tbl_0.datetime,\n        (SELECT MAX(datetime)\n\t\t FROM game_event_item_log tbl_1\n\t\t where tbl_1.datetime < tbl_0.datetime) AS latest\nFROM game_event_item_log tbl_0\ngroup by tbl_0.game_event, tbl_0.user_id, tbl_0.datetime\norder by tbl_0.game_event, tbl_0.user_id, tbl_0.datetime desc\n), temp_2 AS (\nSELECT  game_event,\n        user_id,\n        datetime,\n\t\tlatest,\t\n\t\tabs(datediff(minute,datetime, latest)) AS time_interval\nFROM temp\norder by game_event, user_id, datetime desc\n), temp_3 AS (\nSELECT *,\n\t   avg(time_interval) over(partition by game_event) AS AVG_event_interval_per_game_event,\n\t   round((stddev(time_interval) over(partition by game_event)), 1) AS SDTDEV_event_interval_per_game_event\nfrom temp_2\norder by game_event, user_id, datetime desc\n)\nselect game_event,\n       user_id,\n\t   datetime,\n\t   latest,\n\t   time_interval,\n\t   round((time_interval - AVG_event_interval_per_game_event) / SDTDEV_event_interval_per_game_event, 5) AS time_interval_Z_score_by_game_event_level\nfrom temp_3\norder by game_event, user_id, datetime desc\t   \n;\t   \n```\n\n\n\n\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\uff1d\n\n\u7d50\u679c\u30ec\u30b3\u30fc\u30c9\u306e\u4e26\u3073\u66ff\u3048\u9806\u5e8f\u3092\u4ee5\u4e0b\u306b\u5909\u66f4\u3002\n\norder by game_event, time_interval_Z_score_by_game_event_level, user_id, datetime desc\n\n\n```{SQL:SQL}\nWith temp AS (\nSELECT tbl_0.game_event,\n       tbl_0.user_id, \n       tbl_0.datetime,\n        (SELECT MAX(datetime)\n\t\t FROM game_event_item_log tbl_1\n\t\t where tbl_1.datetime < tbl_0.datetime) AS latest\nFROM game_event_item_log tbl_0\ngroup by tbl_0.game_event, tbl_0.user_id, tbl_0.datetime\norder by tbl_0.game_event, tbl_0.user_id, tbl_0.datetime desc\n), temp_2 AS (\nSELECT  game_event,\n        user_id,\n        datetime,\n\t\tlatest,\t\n\t\tabs(datediff(minute,datetime, latest)) AS time_interval\nFROM temp\norder by game_event, user_id, datetime desc\n), temp_3 AS (\nSELECT *,\n\t   avg(time_interval) over(partition by game_event) AS AVG_event_interval_per_game_event,\n\t   round((stddev(time_interval) over(partition by game_event)), 1) AS SDTDEV_event_interval_per_game_event\nfrom temp_2\norder by game_event, user_id, datetime desc\n)\nselect game_event,\n       user_id,\n\t   datetime,\n\t   latest,\n\t   time_interval,\n\t   round((time_interval - AVG_event_interval_per_game_event) / SDTDEV_event_interval_per_game_event, 5) AS time_interval_Z_score_by_game_event_level\nfrom temp_3\norder by game_event, time_interval_Z_score_by_game_event_level, user_id, datetime desc\t   \n;\t   \n```\n"}