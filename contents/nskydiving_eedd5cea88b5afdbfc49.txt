{"context": "\u4eca\u56de\u306f SQLAlchemy \u3067 Delete \u306e\u3084\u308a\u65b9\u3092\u66f8\u304d\u307e\u3059\u3002\n\n\u52d5\u4f5c\u74b0\u5883\n\nMac OS X 10.11.5\nPython 3.5.1\nMySQL Ver 14.14 Distrib 5.7.11, for osx10.11 (x86_64) using  EditLine wrapper\nSQLAlchemy 1.1.0\nPyMySQL 0.7.4\n\n\n\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\n\u307e\u305a\u306f\u30b7\u30f3\u30d7\u30eb\u306b\u3001\u30c6\u30fc\u30d6\u30eb\u304b\u3089\u300cname\u300d\u30ab\u30e9\u30e0\u304c \"\u6851\u7530 \u7d50\u5b50\" \u3068\u306a\u3063\u3066\u3044\u308b\u30c7\u30fc\u30bf\u3092\u691c\u7d22\u3057\u3066\u3001\u524a\u9664\u3057\u307e\u3059\u3002\n\nsqlalchemy_delete.py\n# -*- coding:utf-8 -*-\nimport sqlalchemy\nimport sqlalchemy.orm\nimport sqlalchemy.ext.declarative\n\nBase = sqlalchemy.ext.declarative.declarative_base()\n\nclass Student(Base):\n    __tablename__ = 'students'\n    id = sqlalchemy.Column(sqlalchemy.Integer, primary_key=True)\n    name = sqlalchemy.Column(sqlalchemy.String(20))\n    kana = sqlalchemy.Column(sqlalchemy.String(40))\n\ndef main():\n    url = 'mysql+pymysql://root:@localhost/test_db?charset=utf8'\n\n    engine = sqlalchemy.create_engine(url, echo=False)\n\n    # \u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\n    Base.metadata.create_all(engine)\n\n    # \u30bb\u30c3\u30b7\u30e7\u30f3\u3092\u4f5c\u6210\n    Session = sqlalchemy.orm.sessionmaker(bind=engine)\n    session = Session()\n\n    # \u5168\u30c7\u30fc\u30bf\u524a\u9664\n    session.query(Student).delete()\n\n    # \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u8ffd\u52a0\u3059\u308b\u30c7\u30fc\u30bf\u30ea\u30b9\u30c8\n    student_list = [\n        Student(id=1, name='\u77f3\u5742 \u512a', kana='\u3044\u3057\u3056\u304b \u3086\u3046'),\n        Student(id=2, name='\u6749\u91ce \u8aa0\u4e00', kana='\u3059\u304e\u306e \u305b\u3044\u3044\u3061'),\n        Student(id=3, name='\u6851\u7530 \u7d50\u5b50', kana='\u304f\u308f\u305f \u3086\u3046\u3053'),\n        Student(id=4, name='\u6817\u539f \u611b', kana='\u304f\u308a\u306f\u3089 \u3042\u3044'),\n        Student(id=5, name='\u4f50\u4e45\u9593 \u4ec1', kana='\u3055\u304f\u307e \u3058\u3093'),\n    ]\n\n    # \u30c7\u30fc\u30bf\u30ea\u30b9\u30c8\u3092\u4e00\u62ec\u8ffd\u52a0\n    session.add_all(student_list)\n\n    # \u524a\u9664\u5bfe\u8c61\u306e\u30c7\u30fc\u30bf\u3092\u691c\u7d22\n    found_student = session.query(Student).filter_by(name='\u6851\u7530 \u7d50\u5b50').first()\n\n    # \u6307\u5b9a\u3057\u305f\u30c7\u30fc\u30bf\u3092\u524a\u9664\n    session.delete(found_student)\n\n    # \u30c6\u30fc\u30d6\u30eb\u306e\u5168\u30c7\u30fc\u30bf\u3092\u51fa\u529b\n    print_all_students(session)\n\n    # \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u53cd\u6620\n    session.commit()\n\n# \u30c6\u30fc\u30d6\u30eb\u306e\u5168\u30c7\u30fc\u30bf\u3092\u51fa\u529b\u3059\u308b\u95a2\u6570\ndef print_all_students(session):\n    students = session.query(Student).all()\n    for student in students:\n        print('%d, %s %s' % (student.id, student.name, student.kana))\n\nif __name__ == '__main__':\n    main()\n\n\n\u6b21\u306b\u5fdc\u7528\u3068\u3057\u3066\u3001\u30d5\u30a3\u30eb\u30bf\u6307\u5b9a\u3084 IN \u53e5\u6307\u5b9a\u3067\u30c7\u30fc\u30bf\u3092\u524a\u9664\u3057\u307e\u3059\u3002\n\nsqlalchemy_delete.py\n# -*- coding:utf-8 -*-\nimport sqlalchemy\nimport sqlalchemy.orm\nimport sqlalchemy.ext.declarative\n\nBase = sqlalchemy.ext.declarative.declarative_base()\n\nclass Student(Base):\n    __tablename__ = 'students'\n    id = sqlalchemy.Column(sqlalchemy.Integer, primary_key=True)\n    name = sqlalchemy.Column(sqlalchemy.String(20))\n    kana = sqlalchemy.Column(sqlalchemy.String(40))\n\ndef main():\n    url = 'mysql+pymysql://root:@localhost/test_db?charset=utf8'\n\n    engine = sqlalchemy.create_engine(url, echo=False)\n\n    # \u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\n    Base.metadata.create_all(engine)\n\n    # \u30bb\u30c3\u30b7\u30e7\u30f3\u3092\u4f5c\u6210\n    Session = sqlalchemy.orm.sessionmaker(bind=engine)\n    session = Session()\n\n    # \u5168\u30c7\u30fc\u30bf\u524a\u9664\n    print(\"====== session.query(Student).delete() =====\")\n    session.query(Student).delete()\n    print_all_students(session)\n\n    # \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u8ffd\u52a0\u3059\u308b\u30c7\u30fc\u30bf\u30ea\u30b9\u30c8\n    student_list = [\n        Student(id=1, name='\u77f3\u5742 \u512a', kana='\u3044\u3057\u3056\u304b \u3086\u3046'),\n        Student(id=2, name='\u6749\u91ce \u8aa0\u4e00', kana='\u3059\u304e\u306e \u305b\u3044\u3044\u3061'),\n        Student(id=3, name='\u6851\u7530 \u7d50\u5b50', kana='\u304f\u308f\u305f \u3086\u3046\u3053'),\n        Student(id=4, name='\u6817\u539f \u611b', kana='\u304f\u308a\u306f\u3089 \u3042\u3044'),\n        Student(id=5, name='\u4f50\u4e45\u9593 \u4ec1', kana='\u3055\u304f\u307e \u3058\u3093'),\n    ]\n\n    # \u30c7\u30fc\u30bf\u30ea\u30b9\u30c8\u3092\u4e00\u62ec\u8ffd\u52a0\n    print(\"====== session.add_all(student_list) ======\")\n    session.add_all(student_list)\n    print_all_students(session)\n\n    # \u30d5\u30a3\u30eb\u30bf\u3067\u6307\u5b9a\u3057\u3066\u524a\u9664\n    print(\"====== session.query(Student).filter(Student.id==2).delete() =====\")\n    session.query(Student).filter(Student.id==2).delete()\n    print_all_students(session)\n\n    # IN \u53e5\u3067\u6307\u5b9a\u3057\u3066\u524a\u9664\n    print(\"====== session.query(Student).filter(Student.id.in_([3, 4])).delete(synchronize_session='fetch') =====\")\n    session.query(Student).filter(Student.id.in_([3, 4])).delete(synchronize_session='fetch')\n    print_all_students(session)\n\n    # \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u53cd\u6620\n    session.commit()\n\n# \u30c6\u30fc\u30d6\u30eb\u306e\u5168\u30c7\u30fc\u30bf\u3092\u51fa\u529b\u3059\u308b\u95a2\u6570\ndef print_all_students(session):\n    students = session.query(Student).all()\n    for student in students:\n        print('%d, %s %s' % (student.id, student.name, student.kana))\n\nif __name__ == '__main__':\n    main()\n\n\n\n\u307e\u3068\u3081\nSession \u30af\u30e9\u30b9\u306b add_all \u3068\u3044\u3046\u30e1\u30bd\u30c3\u30c9\u304c\u3042\u308b\u306e\u3067\u3001\u5168\u30c7\u30fc\u30bf\u524a\u9664\u306f delete_all \u304b\u306a\uff1f\u3068\u601d\u308f\u308c\u308b\u65b9\u3082\u3044\u305d\u3046\u3067\u3059\u304c\u3001\u305d\u3046\u3067\u306f\u306a\u3044\u306e\u3067\u6ce8\u610f\u3067\u3059\u306d\u3002\n\u307e\u305f\u3001delete \u30e1\u30bd\u30c3\u30c9\u306e\u5f15\u6570 synchronize_session \u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u5f15\u6570\u306f 'evaluate' \u3068\u306a\u3063\u3066\u3044\u308b\u305f\u3081\u3001IN \u53e5\u3067\u6307\u5b9a\u3057\u3066\u524a\u9664\u3059\u308b\u5834\u5408\u306f 'fetch' \u3092\u6307\u5b9a\u3057\u306a\u3044\u3068\u4f8b\u5916\u304c\u767a\u751f\u3057\u307e\u3059\u3002\n\u8a73\u3057\u304f\u306f\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n[\u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8]\nsqlalchemy.exc.InvalidRequestError: Could not evaluate current criteria in Python. Specify 'fetch' or False for the synchronize_session parameter.\n\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\uff1eQuery API\uff1edelete(synchronize_session='evaluate')\nhttp://docs.sqlalchemy.org/en/rel_1_1/orm/query.html#sqlalchemy.orm.query.Query.delete\n\u4eca\u56de\u306f **SQLAlchemy** \u3067 **Delete** \u306e\u3084\u308a\u65b9\u3092\u66f8\u304d\u307e\u3059\u3002\n\n## \u52d5\u4f5c\u74b0\u5883\n- Mac OS X 10.11.5\n- Python 3.5.1\n- MySQL Ver 14.14 Distrib 5.7.11, for osx10.11 (x86_64) using  EditLine wrapper\n- SQLAlchemy 1.1.0\n- PyMySQL 0.7.4\n\n## \u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\n\u307e\u305a\u306f\u30b7\u30f3\u30d7\u30eb\u306b\u3001\u30c6\u30fc\u30d6\u30eb\u304b\u3089\u300cname\u300d\u30ab\u30e9\u30e0\u304c \"\u6851\u7530 \u7d50\u5b50\" \u3068\u306a\u3063\u3066\u3044\u308b\u30c7\u30fc\u30bf\u3092\u691c\u7d22\u3057\u3066\u3001\u524a\u9664\u3057\u307e\u3059\u3002\n\n```py3:sqlalchemy_delete.py\n# -*- coding:utf-8 -*-\nimport sqlalchemy\nimport sqlalchemy.orm\nimport sqlalchemy.ext.declarative\n\nBase = sqlalchemy.ext.declarative.declarative_base()\n\nclass Student(Base):\n    __tablename__ = 'students'\n    id = sqlalchemy.Column(sqlalchemy.Integer, primary_key=True)\n    name = sqlalchemy.Column(sqlalchemy.String(20))\n    kana = sqlalchemy.Column(sqlalchemy.String(40))\n\ndef main():\n    url = 'mysql+pymysql://root:@localhost/test_db?charset=utf8'\n\n    engine = sqlalchemy.create_engine(url, echo=False)\n\n    # \u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\n    Base.metadata.create_all(engine)\n\n    # \u30bb\u30c3\u30b7\u30e7\u30f3\u3092\u4f5c\u6210\n    Session = sqlalchemy.orm.sessionmaker(bind=engine)\n    session = Session()\n\n    # \u5168\u30c7\u30fc\u30bf\u524a\u9664\n    session.query(Student).delete()\n\n    # \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u8ffd\u52a0\u3059\u308b\u30c7\u30fc\u30bf\u30ea\u30b9\u30c8\n    student_list = [\n        Student(id=1, name='\u77f3\u5742 \u512a', kana='\u3044\u3057\u3056\u304b \u3086\u3046'),\n        Student(id=2, name='\u6749\u91ce \u8aa0\u4e00', kana='\u3059\u304e\u306e \u305b\u3044\u3044\u3061'),\n        Student(id=3, name='\u6851\u7530 \u7d50\u5b50', kana='\u304f\u308f\u305f \u3086\u3046\u3053'),\n        Student(id=4, name='\u6817\u539f \u611b', kana='\u304f\u308a\u306f\u3089 \u3042\u3044'),\n        Student(id=5, name='\u4f50\u4e45\u9593 \u4ec1', kana='\u3055\u304f\u307e \u3058\u3093'),\n    ]\n\n    # \u30c7\u30fc\u30bf\u30ea\u30b9\u30c8\u3092\u4e00\u62ec\u8ffd\u52a0\n    session.add_all(student_list)\n\n    # \u524a\u9664\u5bfe\u8c61\u306e\u30c7\u30fc\u30bf\u3092\u691c\u7d22\n    found_student = session.query(Student).filter_by(name='\u6851\u7530 \u7d50\u5b50').first()\n\n    # \u6307\u5b9a\u3057\u305f\u30c7\u30fc\u30bf\u3092\u524a\u9664\n    session.delete(found_student)\n\n    # \u30c6\u30fc\u30d6\u30eb\u306e\u5168\u30c7\u30fc\u30bf\u3092\u51fa\u529b\n    print_all_students(session)\n\n    # \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u53cd\u6620\n    session.commit()\n\n# \u30c6\u30fc\u30d6\u30eb\u306e\u5168\u30c7\u30fc\u30bf\u3092\u51fa\u529b\u3059\u308b\u95a2\u6570\ndef print_all_students(session):\n    students = session.query(Student).all()\n    for student in students:\n        print('%d, %s %s' % (student.id, student.name, student.kana))\n\nif __name__ == '__main__':\n    main()\n```\n\n\u6b21\u306b\u5fdc\u7528\u3068\u3057\u3066\u3001\u30d5\u30a3\u30eb\u30bf\u6307\u5b9a\u3084 IN \u53e5\u6307\u5b9a\u3067\u30c7\u30fc\u30bf\u3092\u524a\u9664\u3057\u307e\u3059\u3002\n\n```py3:sqlalchemy_delete.py\n# -*- coding:utf-8 -*-\nimport sqlalchemy\nimport sqlalchemy.orm\nimport sqlalchemy.ext.declarative\n\nBase = sqlalchemy.ext.declarative.declarative_base()\n\nclass Student(Base):\n    __tablename__ = 'students'\n    id = sqlalchemy.Column(sqlalchemy.Integer, primary_key=True)\n    name = sqlalchemy.Column(sqlalchemy.String(20))\n    kana = sqlalchemy.Column(sqlalchemy.String(40))\n\ndef main():\n    url = 'mysql+pymysql://root:@localhost/test_db?charset=utf8'\n\n    engine = sqlalchemy.create_engine(url, echo=False)\n\n    # \u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\n    Base.metadata.create_all(engine)\n\n    # \u30bb\u30c3\u30b7\u30e7\u30f3\u3092\u4f5c\u6210\n    Session = sqlalchemy.orm.sessionmaker(bind=engine)\n    session = Session()\n\n    # \u5168\u30c7\u30fc\u30bf\u524a\u9664\n    print(\"====== session.query(Student).delete() =====\")\n    session.query(Student).delete()\n    print_all_students(session)\n\n    # \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u8ffd\u52a0\u3059\u308b\u30c7\u30fc\u30bf\u30ea\u30b9\u30c8\n    student_list = [\n        Student(id=1, name='\u77f3\u5742 \u512a', kana='\u3044\u3057\u3056\u304b \u3086\u3046'),\n        Student(id=2, name='\u6749\u91ce \u8aa0\u4e00', kana='\u3059\u304e\u306e \u305b\u3044\u3044\u3061'),\n        Student(id=3, name='\u6851\u7530 \u7d50\u5b50', kana='\u304f\u308f\u305f \u3086\u3046\u3053'),\n        Student(id=4, name='\u6817\u539f \u611b', kana='\u304f\u308a\u306f\u3089 \u3042\u3044'),\n        Student(id=5, name='\u4f50\u4e45\u9593 \u4ec1', kana='\u3055\u304f\u307e \u3058\u3093'),\n    ]\n\n    # \u30c7\u30fc\u30bf\u30ea\u30b9\u30c8\u3092\u4e00\u62ec\u8ffd\u52a0\n    print(\"====== session.add_all(student_list) ======\")\n    session.add_all(student_list)\n    print_all_students(session)\n\n    # \u30d5\u30a3\u30eb\u30bf\u3067\u6307\u5b9a\u3057\u3066\u524a\u9664\n    print(\"====== session.query(Student).filter(Student.id==2).delete() =====\")\n    session.query(Student).filter(Student.id==2).delete()\n    print_all_students(session)\n\n    # IN \u53e5\u3067\u6307\u5b9a\u3057\u3066\u524a\u9664\n    print(\"====== session.query(Student).filter(Student.id.in_([3, 4])).delete(synchronize_session='fetch') =====\")\n    session.query(Student).filter(Student.id.in_([3, 4])).delete(synchronize_session='fetch')\n    print_all_students(session)\n\n    # \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u53cd\u6620\n    session.commit()\n\n# \u30c6\u30fc\u30d6\u30eb\u306e\u5168\u30c7\u30fc\u30bf\u3092\u51fa\u529b\u3059\u308b\u95a2\u6570\ndef print_all_students(session):\n    students = session.query(Student).all()\n    for student in students:\n        print('%d, %s %s' % (student.id, student.name, student.kana))\n\nif __name__ == '__main__':\n    main()\n```\n\n## \u307e\u3068\u3081\nSession \u30af\u30e9\u30b9\u306b add_all \u3068\u3044\u3046\u30e1\u30bd\u30c3\u30c9\u304c\u3042\u308b\u306e\u3067\u3001\u5168\u30c7\u30fc\u30bf\u524a\u9664\u306f delete_all \u304b\u306a\uff1f\u3068\u601d\u308f\u308c\u308b\u65b9\u3082\u3044\u305d\u3046\u3067\u3059\u304c\u3001\u305d\u3046\u3067\u306f\u306a\u3044\u306e\u3067\u6ce8\u610f\u3067\u3059\u306d\u3002\n\n\u307e\u305f\u3001delete \u30e1\u30bd\u30c3\u30c9\u306e\u5f15\u6570 synchronize_session \u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u5f15\u6570\u306f 'evaluate' \u3068\u306a\u3063\u3066\u3044\u308b\u305f\u3081\u3001IN \u53e5\u3067\u6307\u5b9a\u3057\u3066\u524a\u9664\u3059\u308b\u5834\u5408\u306f 'fetch' \u3092\u6307\u5b9a\u3057\u306a\u3044\u3068\u4f8b\u5916\u304c\u767a\u751f\u3057\u307e\u3059\u3002\n\u8a73\u3057\u304f\u306f[\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](http://docs.sqlalchemy.org/en/rel_1_1/orm/query.html#sqlalchemy.orm.query.Query.delete)\u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n[\u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8]\n`sqlalchemy.exc.InvalidRequestError: Could not evaluate current criteria in Python. Specify 'fetch' or False for the synchronize_session parameter.`\n\n\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\uff1eQuery API\uff1edelete(synchronize_session='evaluate')\nhttp://docs.sqlalchemy.org/en/rel_1_1/orm/query.html#sqlalchemy.orm.query.Query.delete\n\n\n", "tags": ["Python", "python3", "MySQL", "sqlalchemy"]}