{"context": "\n\n\u3053\u306e\u8a18\u4e8b\u306b\u3064\u3044\u3066\nJAWS-UG CLI\u5c02\u9580\u652f\u90e8 #73 Kinesis Firehose\u5165\u9580\u3067\u5b9f\u65bd\u3059\u308b\u30cf\u30f3\u30ba\u30aa\u30f3\u7528\u306e\u624b\u9806\u66f8\u3067\u3059\u3002\n\n\u524d\u63d0\u6761\u4ef6\n\n\u5fc5\u8981\u306a\u6a29\u9650\n\u4f5c\u696d\u306b\u3042\u305f\u3063\u3066\u306f\u3001\u4ee5\u4e0b\u306e\u6a29\u9650\u3092\u6709\u3057\u305fIAM\u30e6\u30fc\u30b6\u3082\u3057\u304f\u306fIAM\u30ed\u30fc\u30eb\u3092\u5229\u7528\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\nKinesis Firehose\u306e\u30d5\u30eb\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u6a29\u9650\nS3\u306e\u30d5\u30eb\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u6a29\u9650\nSTS\u306e\u95a2\u3059\u308b\u30d5\u30eb\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u6a29\u9650\nIAM\u306e\u95a2\u3059\u308b\u30d5\u30eb\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u6a29\u9650\nCloudWatch\u306e\u95a2\u3059\u308b\u30d5\u30eb\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u6a29\u9650\nCloudWatch Logs\u306e\u95a2\u3059\u308b\u30d5\u30eb\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u6a29\u9650\n\n\n0. \u6e96\u5099\n\n0.1. \u30ea\u30fc\u30b8\u30e7\u30f3\u3092\u6307\u5b9a\n\u30aa\u30ec\u30b4\u30f3\u30ea\u30fc\u30b8\u30e7\u30f3\u3067\u5b9f\u65bd\u3057\u307e\u3059\u3002\uff08\u6771\u4eac\u30de\u30c0\u30fc\uff1f\uff09\n\n\u30b3\u30de\u30f3\u30c9\nexport AWS_DEFAULT_REGION=\"us-west-2\"\n\n\n\n0.2. \u8cc7\u683c\u60c5\u5831\u3092\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws configure list\n\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u3092\u8a2d\u5b9a\u3057\u305fEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3067\u30a2\u30af\u30bb\u30b9\u30ad\u30fc\u3092\u8a2d\u5b9a\u305b\u305a\u306b\u5b9f\u884c\u3057\u305f\u5834\u5408\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u7d50\u679c\n      Name                    Value             Type    Location\n      ----                    -----             ----    --------\n   profile                <not set>             None    None\naccess_key     ****************QSAA         iam-role\nsecret_key     ****************c1xY         iam-role\n    region                us-west-2              env    AWS_DEFAULT_REGION\n\n\n\n0.3. \u30d0\u30fc\u30b8\u30e7\u30f3\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws --version\n\n\n\n\u7d50\u679c\naws-cli/1.11.28 Python/2.7.12 Linux/4.4.23-31.54.amzn1.x86_64 botocore/1.4.85\n\n\n\n0.4. \u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\uff08\u5fc5\u8981\u306b\u5fdc\u3058\u3066\uff09\n\n\u30b3\u30de\u30f3\u30c9\nsudo pip install -U awscli\n\n\n\n1. Destination\u306e\u6e96\u5099\nKinesis Firehose\u304b\u3089\u30c7\u30fc\u30bf\u3092\u914d\u4fe1\u3059\u308b\u5148\u3068\u306a\u308bS3\u30d0\u30b1\u30c3\u30c8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n1.1. S3\u30d0\u30b1\u30c3\u30c8\u306e\u4f5c\u6210\n\nAWS ID\u306e\u53d6\u5f97\n\n\u30b3\u30de\u30f3\u30c9\nAWS_ID=$(aws sts get-caller-identity \\\n    --query Account \\\n    --output text) \\\n    && echo ${AWS_ID}\n\n\n\n\u7d50\u679c\n************\n\n\n\n\u30d0\u30b1\u30c3\u30c8\u540d\u306e\u6307\u5b9a\n\n\u30b3\u30de\u30f3\u30c9\nBUCKET_NAME=\"jawsug-cli-firehose-${AWS_ID}\" \\\n    && echo ${BUCKET_NAME}\n\n\n\n\u7d50\u679c\njawsug-cli-firehose-************\n\n\n\n\u540c\u540d\u306e\u30d0\u30b1\u30c3\u30c8\u304c\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws s3 ls ${BUCKET_NAME}\n\n\n\n\u7d50\u679c\nAn error occurred (NoSuchBucket) when calling the ListObjects operation: The specified bucket does not exist\n\n\n\n\u5909\u6570\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n    BUCKET_NAME: ${BUCKET_NAME}\n\nETX\n\n\n\n\u7d50\u679c\n\n    BUCKET_NAME: jawsug-cli-firehose-************\n\n\n\n\n\u30d0\u30b1\u30c3\u30c8\u306e\u4f5c\u6210\n\n\u30b3\u30de\u30f3\u30c9\naws s3api create-bucket \\\n    --bucket ${BUCKET_NAME} \\\n    --create-bucket-configuration LocationConstraint=${AWS_DEFAULT_REGION}\n\n\n\n\u7d50\u679c\n{\n    \"Location\": \"http://jawsug-cli-firehose-************.s3.amazonaws.com/\"\n}\n\n\n\n\u4f5c\u6210\u3055\u308c\u305f\u30d0\u30b1\u30c3\u30c8\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws s3 ls | grep ${BUCKET_NAME}\n\n\n\n\u7d50\u679c\n2016-11-05 05:49:49 jawsug-cli-firehose-************\n\n\n\n2. \u30ed\u30b0\u306e\u51fa\u529b\u5148\u306e\u4f5c\u6210\n\u3053\u306e\u30ed\u30b0\u306f\u3001Kinesis Firehose\u306b\u95a2\u3059\u308b\u30a8\u30e9\u30fc\u30ed\u30b0\u306a\u3069\u3092\u6307\u3057\u307e\u3059\u3002\n\u3053\u306e\u30cf\u30f3\u30ba\u30aa\u30f3\u3067\u306f\uff08\u30a8\u30e9\u30fc\u304c\u8d77\u304d\u306a\u3051\u308c\u3070\u4f55\u3082\u51fa\u529b\u3055\u308c\u306a\u3044\u306e\u3067\uff09\u7279\u306b\u78ba\u8a8d\u306f\u3057\u307e\u305b\u3093\u304c\u3001\u904b\u7528\u74b0\u5883\u3067\u306f\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u306b\u306a\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u30ed\u30b0\u30b0\u30eb\u30fc\u30d7\u306e\u4f5c\u6210\n\n\u30ed\u30b0\u30b0\u30eb\u30fc\u30d7\u540d\u306e\u6307\u5b9a\n\n\u30b3\u30de\u30f3\u30c9\nLOG_GROUP_NAME=\"jawsug-cli-firehose\"\n\n\n\n\u30ed\u30b0\u30b0\u30eb\u30fc\u30d7\u540d\u306e\u91cd\u8907\u3092\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws logs describe-log-groups \\\n    --log-group-name-prefix ${LOG_GROUP_NAME}\n\n\n\n\u7d50\u679c\n{\n    \"logGroups\": []\n}\n\n\n\n\u5909\u6570\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n    LOG_GROUP_NAME: ${LOG_GROUP_NAME}\n\nETX\n\n\n\n\u7d50\u679c\n\n    LOG_GROUP_NAME: jawsug-cli-firehose\n\n\n\n\n\u30ed\u30b0\u30b0\u30eb\u30fc\u30d7\u306e\u4f5c\u6210\n\n\u30b3\u30de\u30f3\u30c9\naws logs create-log-group \\\n    --log-group-name ${LOG_GROUP_NAME}\n\n\n\n\u7d50\u679c\n\uff08\u8fd4\u5024\u7121\u3057\uff09\n\n\n\n\u30ed\u30b0\u30b0\u30eb\u30fc\u30d7\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws logs describe-log-groups \\\n    --log-group-name-prefix ${LOG_GROUP_NAME}\n\n\n\n\u7d50\u679c\n{\n    \"logGroups\": [\n        {\n            \"arn\": \"arn:aws:logs:us-west-2:************:log-group:jawsug-cli-firehose:*\",\n            \"creationTime\": 1478325129343,\n            \"metricFilterCount\": 0,\n            \"logGroupName\": \"jawsug-cli-firehose\",\n            \"storedBytes\": 0\n        }\n    ]\n}\n\n\n\n\u30ed\u30b0\u30b9\u30c8\u30ea\u30fc\u30e0\u306e\u4f5c\u6210\n\n\u30ed\u30b0\u30b9\u30c8\u30ea\u30fc\u30e0\u540d\u306e\u6307\u5b9a\n\n\u30b3\u30de\u30f3\u30c9\nLOG_STREAM_NAME=\"handson\"\n\n\n\n\u30ed\u30b0\u30b9\u30c8\u30ea\u30fc\u30e0\u540d\u306e\u91cd\u8907\u3092\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws logs describe-log-streams \\\n    --log-group-name ${LOG_GROUP_NAME}\\\n    --log-stream-name-prefix ${LOG_STREAM_NAME}\n\n\n\n\u7d50\u679c\n{\n    \"logStreams\": []\n}\n\n\n\n\u5909\u6570\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n    LOG_GROUP_NAME: ${LOG_GROUP_NAME}\n    LOG_STREAM_NAME: ${LOG_STREAM_NAME}\n\nETX\n\n\n\n\u7d50\u679c\n\n    LOG_GROUP_NAME: jawsug-cli-firehose\n    LOG_STREAM_NAME: handson\n\n\n\n\n\u30ed\u30b0\u30b9\u30c8\u30ea\u30fc\u30e0\u306e\u4f5c\u6210\n\n\u30b3\u30de\u30f3\u30c9\naws logs create-log-stream \\\n    --log-group-name ${LOG_GROUP_NAME} \\\n    --log-stream-name ${LOG_STREAM_NAME}\n\n\n\n\u7d50\u679c\n\uff08\u8fd4\u5024\u7121\u3057\uff09\n\n\n\n\u30ed\u30b0\u30b9\u30c8\u30ea\u30fc\u30e0\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws logs describe-log-streams \\\n    --log-group-name ${LOG_GROUP_NAME}\\\n    --log-stream-name-prefix ${LOG_STREAM_NAME}\n\n\n\n\u7d50\u679c\n{\n    \"logStreams\": [\n        {\n            \"creationTime\": 1478325265601,\n            \"arn\": \"arn:aws:logs:us-west-2:************:log-group:jawsug-cli-firehose:log-stream:handson\",\n            \"logStreamName\": \"handson\",\n            \"storedBytes\": 0\n        }\n    ]\n}\n\n\n\n3. IAM Role\u306e\u4f5c\u6210\nKinesis Firehose\u306b\u5bfe\u3057\u3001\u6a29\u9650\u3092\u59d4\u4efb\u3059\u308b\u305f\u3081\u306eIAM Role\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\uff08\u4ed8\u4e0e\u3059\u308b\u6a29\u9650\u306f\u5f8c\u8ff0\uff09\n\nIAM Role\u306e\u4f5c\u6210\n\nIAM Role\u540d\u3092\u6307\u5b9a\n\n\u30b3\u30de\u30f3\u30c9\nROLE_NAME='service-role-firehose'\n\n\n\n\u540c\u540d\u306e\u30ed\u30fc\u30eb\u304c\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws iam get-role \\\n    --role-name ${ROLE_NAME}\n\n\n\n\u7d50\u679c\nAn error occurred (NoSuchEntity) when calling the GetRole operation: Unknown\n\n\n\n\u4fe1\u983c\u95a2\u4fc2\u306e\u5b9a\u7fa9\n\n\u30b3\u30de\u30f3\u30c9\nTRUST_POLICY_FILE='Trust-Policy.json'\n\n\n\n\u30b3\u30de\u30f3\u30c9\ncat << EOF > ${TRUST_POLICY_FILE}\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": \"firehose.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRole\"\n    }\n  ]\n}\nEOF\n\ncat ${TRUST_POLICY_FILE}\n\n\n\n\u7d50\u679c\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": \"firehose.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRole\"\n    }\n  ]\n}\n\n\n\nJSON\u30d5\u30a1\u30a4\u30eb\u3092\u691c\u8a3c\n\n\u30b3\u30de\u30f3\u30c9\njsonlint -q ${TRUST_POLICY_FILE}\n\n\n\n\u7d50\u679c\n\uff08\u8fd4\u5024\u7121\u3057\uff09\n\n\n\n\u5909\u6570\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n    ROLE_NAME: ${ROLE_NAME}\n    TRUST_POLICY_FILE: ${TRUST_POLICY_FILE}\n\nETX\n\n\n\n\u7d50\u679c\n\n    ROLE_NAME: service-role-firehose\n    TRUST_POLICY_FILE: Trust-Policy.json\n\n\n\n\nIAM\u30ed\u30fc\u30eb\u306e\u4f5c\u6210\n\n\u30b3\u30de\u30f3\u30c9\naws iam create-role \\\n    --role-name ${ROLE_NAME} \\\n    --assume-role-policy-document file://${TRUST_POLICY_FILE}\n\n\n\n\u7d50\u679c\n{\n    \"Role\": {\n        \"AssumeRolePolicyDocument\": {\n            \"Version\": \"2012-10-17\",\n            \"Statement\": [\n                {\n                    \"Action\": \"sts:AssumeRole\",\n                    \"Principal\": {\n                        \"Service\": \"firehose.amazonaws.com\"\n                    },\n                    \"Effect\": \"Allow\",\n                    \"Sid\": \"\"\n                }\n            ]\n        },\n        \"RoleId\": \"A********************\",\n        \"CreateDate\": \"2016-11-05T05:58:53.873Z\",\n        \"RoleName\": \"service-role-firehose\",\n        \"Path\": \"/\",\n        \"Arn\": \"arn:aws:iam::************:role/service-role-firehose\"\n    }\n}\n\n\n\nIAM\u30ed\u30fc\u30eb\u306e\u78ba\u8a8d\u304a\u3088\u3073ARN\u306e\u53d6\u5f97\n\n\u30b3\u30de\u30f3\u30c9\nROLE_ARN=$(aws iam get-role \\\n    --role-name ${ROLE_NAME} \\\n    --query Role.Arn \\\n    --output text) \\\n    && echo ${ROLE_ARN}\n\n\n\n\u7d50\u679c\narn:aws:iam::************:role/service-role-firehose\n\n\n\n\u30dd\u30ea\u30b7\u30fc\u540d\u306e\u6307\u5b9a\n\u3053\u3053\u3067Kinesis Firehose\u306b\u5bfe\u3057\u3066\u59d4\u4efb\u3059\u308b\u6a29\u9650\u3092\u5b9a\u7fa9\u3057\u307e\u3059\u3002\n\u5177\u4f53\u7684\u306b\u306f\u3001\n\nS3\u3078\u306e\u30c7\u30fc\u30bf\u914d\u4fe1\nCloudWatch Logs\u3078\u306e\u30ed\u30b0\u306e\u51fa\u529b\n\n\u306e\u6a29\u9650\u3092\u4ed8\u4e0e\u3057\u307e\u3059\u3002\nControlling Access with Amazon Kinesis Firehose(Grant Firehose Access to an Amazon S3 Destination)\n\u203bKMS\u3092\u5229\u7528\u3059\u308b\u5834\u5408\u306b\u306f\u3001\u5fc5\u8981\u306a\u30dd\u30ea\u30b7\u30fc\u3092\u8ffd\u8a18\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\nGRANT_POLICY_FILE='Grant-Firehose-Access-to-S3-Policy.json'\n\n\n\n\u5909\u6570\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n    GRANT_POLICY_FILE: ${GRANT_POLICY_FILE}\n    BUCKET_NAME: ${BUCKET_NAME}\n    AWS_DEFAULT_REGION: ${AWS_DEFAULT_REGION}\n    AWS_ID: ${AWS_ID}\n    LOG_GROUP_NAME: ${LOG_GROUP_NAME}\n    LOG_STREAM_NAME: ${LOG_STREAM_NAME}\n\nETX\n\n\n\n\u7d50\u679c\n\n    GRANT_POLICY_FILE: Grant-Firehose-Access-to-S3-Policy.json\n    BUCKET_NAME: jawsug-cli-firehose-************\n    AWS_DEFAULT_REGION: us-west-2\n    AWS_ID: ************\n    LOG_GROUP_NAME: jawsug-cli-firehose\n    LOG_STREAM_NAME: handson\n\n\n\n\n\u30dd\u30ea\u30b7\u30fc\u306e\u751f\u6210\n\n\u30b3\u30de\u30f3\u30c9\ncat << EOF > ${GRANT_POLICY_FILE}\n{\n    \"Version\": \"2012-10-17\",  \n    \"Statement\":\n    [\n        {\n            \"Effect\": \"Allow\",      \n            \"Action\":\n            [        \n                \"s3:AbortMultipartUpload\",        \n                \"s3:GetBucketLocation\",        \n                \"s3:GetObject\",        \n                \"s3:ListBucket\",        \n                \"s3:ListBucketMultipartUploads\",        \n                \"s3:PutObject\"\n            ],      \n            \"Resource\":\n            [        \n                \"arn:aws:s3:::${BUCKET_NAME}\",\n                \"arn:aws:s3:::${BUCKET_NAME}/*\"         \n            ]    \n        },\n        {\n           \"Effect\": \"Allow\",\n           \"Action\": [\n               \"logs:PutLogEvents\"\n           ],\n           \"Resource\": [\n               \"arn:aws:logs:${AWS_DEFAULT_REGION}:${AWS_ID}:log-group:${LOG_GROUP_NAME}:log-stream:${LOG_STREAM_NAME}\"\n           ]\n        }\n    ]\n}\nEOF\n\ncat ${GRANT_POLICY_FILE}\n\n\n\n\u7d50\u679c\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\":\n    [\n        {\n            \"Effect\": \"Allow\",\n            \"Action\":\n            [\n                \"s3:AbortMultipartUpload\",\n                \"s3:GetBucketLocation\",\n                \"s3:GetObject\",\n                \"s3:ListBucket\",\n                \"s3:ListBucketMultipartUploads\",\n                \"s3:PutObject\"\n            ],\n            \"Resource\":\n            [\n                \"arn:aws:s3:::jawsug-cli-firehose-************\",\n                \"arn:aws:s3:::jawsug-cli-firehose-************/*\"\n            ]\n        },\n        {\n           \"Effect\": \"Allow\",\n           \"Action\": [\n               \"logs:PutLogEvents\"\n           ],\n           \"Resource\": [\n               \"arn:aws:logs:us-west-2:************:log-group:jawsug-cli-firehose:log-stream:handson\"\n           ]\n        }\n    ]\n}\n\n\n\nJSON\u30d5\u30a1\u30a4\u30eb\u3092\u691c\u8a3c\n\n\u30b3\u30de\u30f3\u30c9\njsonlint -q ${GRANT_POLICY_FILE}\n\n\n\n\u7d50\u679c\n\uff08\u8fd4\u5024\u7121\u3057\uff09\n\n\n\n\u30dd\u30ea\u30b7\u30fc\u540d\u3092\u6307\u5b9a\n\n\u30b3\u30de\u30f3\u30c9\nPOLICY_NAME=\"ServicePolicyFirehose\"\n\n\n\n\u540c\u540d\u306e\u30dd\u30ea\u30b7\u30fc\u304c\u7121\u3044\u3053\u3068\u3092\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws iam list-policies \\\n    --scope Local \\\n    --query Policies[?PolicyName==${POLICY_NAME}]\n\n\n\n\u7d50\u679c\n[]\n\n\n\n\u5909\u6570\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n    POLICY_NAME: ${POLICY_NAME}\n    GRANT_POLICY_FILE: ${GRANT_POLICY_FILE}\n\nETX\n\n\n\n\u7d50\u679c\n\n    POLICY_NAME: ServicePolicyFirehose\n    GRANT_POLICY_FILE: Grant-Firehose-Access-to-S3-Policy.json\n\n\n\n\n\u30dd\u30ea\u30b7\u30fc\u306e\u4f5c\u6210\u3001ARN\u306e\u53d6\u5f97\nIAM\u30dd\u30ea\u30b7\u30fc\u3092IAM Role\u306b\u30a2\u30bf\u30c3\u30c1\u3059\u308b\u969b\u306b\u30dd\u30ea\u30b7\u30fc\u3092ARN\u3067\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u305f\u3081\u3001\u3053\u3053\u3067ARN\u3092\u53d6\u5f97\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\naws iam create-policy \\\n    --policy-name ${POLICY_NAME} \\\n    --policy-document file://${GRANT_POLICY_FILE}\n\n\n\n\u7d50\u679c\n{\n    \"Policy\": {\n        \"PolicyName\": \"ServicePolicyFirehose\",\n        \"CreateDate\": \"2016-12-19T05:37:59.731Z\",\n        \"AttachmentCount\": 0,\n        \"IsAttachable\": true,\n        \"PolicyId\": \"A********************\",\n        \"DefaultVersionId\": \"v1\",\n        \"Path\": \"/\",\n        \"Arn\": \"arn:aws:iam::************:policy/ServicePolicyFirehose\",\n        \"UpdateDate\": \"2016-12-19T05:37:59.731Z\"\n    }\n}\n\n\n\n\u30b3\u30de\u30f3\u30c9\nPOLICY_ARN=$(aws iam list-policies \\\n    --max-items 1000 \\\n    --query \"Policies[?PolicyName==\\`${POLICY_NAME}\\`].Arn\" \\\n    --output text \\\n    ) && echo \"${POLICY_ARN}\"\n\n\n\n\u7d50\u679c\narn:aws:iam::************:policy/ServicePolicyFirehose\n\n\n\n\u4f5c\u6210\u3057\u305f\u30dd\u30ea\u30b7\u30fc\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws iam get-policy \\\n    --policy-arn ${POLICY_ARN}\n\n\n\n\u7d50\u679c\n{\n    \"Policy\": {\n        \"PolicyName\": \"ServicePolicyFirehose\",\n        \"CreateDate\": \"2016-12-03T05:35:18Z\",\n        \"AttachmentCount\": 0,\n        \"IsAttachable\": true,\n        \"PolicyId\": \"A********************\",\n        \"DefaultVersionId\": \"v1\",\n        \"Path\": \"/\",\n        \"Arn\": \"arn:aws:iam::************:policy/ServicePolicyFirehose\",\n        \"UpdateDate\": \"2016-12-03T05:35:18Z\"\n    }\n}\n\n\n\n\u5909\u6570\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n    ROLE_NAME: ${ROLE_NAME}\n    POLICY_ARN: ${POLICY_ARN}\n\nETX\n\n\n\n\u7d50\u679c\n\n    ROLE_NAME: service-role-firehose\n    POLICY_ARN: arn:aws:iam::************:policy/ServicePolicyFirehose\n\n\n\n\n\u30dd\u30ea\u30b7\u30fc\u3092\u30ed\u30fc\u30eb\u306b\u30a2\u30bf\u30c3\u30c1\n\n\u30b3\u30de\u30f3\u30c9\naws iam attach-role-policy \\\n    --role-name ${ROLE_NAME}\\\n    --policy-arn ${POLICY_ARN}\n\n\n\n\u7d50\u679c\n\uff08\u8fd4\u5024\u7121\u3057\uff09\n\n\n\nIAM Role\u306b\u30dd\u30ea\u30b7\u30fc\u304c\u30a2\u30bf\u30c3\u30c1\u3055\u308c\u305f\u3053\u3068\u3092\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws iam list-attached-role-policies --role-name ${ROLE_NAME}\n\n\n\n\u7d50\u679c\n{\n    \"AttachedPolicies\": [\n        {\n            \"PolicyName\": \"service-policy-firehose\",\n            \"PolicyArn\": \"arn:aws:iam::************:policy/service-policy-firehose\"\n        }\n    ]\n}\n\n\n\u4ee5\u4e0a\n# \u3053\u306e\u8a18\u4e8b\u306b\u3064\u3044\u3066\n\n[JAWS-UG CLI\u5c02\u9580\u652f\u90e8 #73 Kinesis Firehose\u5165\u9580](https://jawsug-cli.doorkeeper.jp/events/41915)\u3067\u5b9f\u65bd\u3059\u308b\u30cf\u30f3\u30ba\u30aa\u30f3\u7528\u306e\u624b\u9806\u66f8\u3067\u3059\u3002\n\n\n# \u524d\u63d0\u6761\u4ef6\n\n## \u5fc5\u8981\u306a\u6a29\u9650\n\n\u4f5c\u696d\u306b\u3042\u305f\u3063\u3066\u306f\u3001\u4ee5\u4e0b\u306e\u6a29\u9650\u3092\u6709\u3057\u305fIAM\u30e6\u30fc\u30b6\u3082\u3057\u304f\u306fIAM\u30ed\u30fc\u30eb\u3092\u5229\u7528\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n- Kinesis Firehose\u306e\u30d5\u30eb\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u6a29\u9650\n- S3\u306e\u30d5\u30eb\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u6a29\u9650\n- STS\u306e\u95a2\u3059\u308b\u30d5\u30eb\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u6a29\u9650\n- IAM\u306e\u95a2\u3059\u308b\u30d5\u30eb\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u6a29\u9650\n- CloudWatch\u306e\u95a2\u3059\u308b\u30d5\u30eb\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u6a29\u9650\n- CloudWatch Logs\u306e\u95a2\u3059\u308b\u30d5\u30eb\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u6a29\u9650\n\n# 0. \u6e96\u5099\n\n## 0.1. \u30ea\u30fc\u30b8\u30e7\u30f3\u3092\u6307\u5b9a\n\n\u30aa\u30ec\u30b4\u30f3\u30ea\u30fc\u30b8\u30e7\u30f3\u3067\u5b9f\u65bd\u3057\u307e\u3059\u3002\uff08\u6771\u4eac\u30de\u30c0\u30fc\uff1f\uff09\n\n```bash:\u30b3\u30de\u30f3\u30c9\nexport AWS_DEFAULT_REGION=\"us-west-2\"\n```\n\n## 0.2. \u8cc7\u683c\u60c5\u5831\u3092\u78ba\u8a8d\n\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws configure list\n```\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u3092\u8a2d\u5b9a\u3057\u305fEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3067\u30a2\u30af\u30bb\u30b9\u30ad\u30fc\u3092\u8a2d\u5b9a\u305b\u305a\u306b\u5b9f\u884c\u3057\u305f\u5834\u5408\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n```text:\u7d50\u679c\n      Name                    Value             Type    Location\n      ----                    -----             ----    --------\n   profile                <not set>             None    None\naccess_key     ****************QSAA         iam-role\nsecret_key     ****************c1xY         iam-role\n    region                us-west-2              env    AWS_DEFAULT_REGION\n```\n\n## 0.3. \u30d0\u30fc\u30b8\u30e7\u30f3\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws --version\n```\n\n```text:\u7d50\u679c\naws-cli/1.11.28 Python/2.7.12 Linux/4.4.23-31.54.amzn1.x86_64 botocore/1.4.85\n```\n\n## 0.4. \u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\uff08\u5fc5\u8981\u306b\u5fdc\u3058\u3066\uff09\n\n```bash:\u30b3\u30de\u30f3\u30c9\nsudo pip install -U awscli\n```\n\n\n# 1. Destination\u306e\u6e96\u5099\n\nKinesis Firehose\u304b\u3089\u30c7\u30fc\u30bf\u3092\u914d\u4fe1\u3059\u308b\u5148\u3068\u306a\u308bS3\u30d0\u30b1\u30c3\u30c8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n## 1.1. S3\u30d0\u30b1\u30c3\u30c8\u306e\u4f5c\u6210\n\n### AWS ID\u306e\u53d6\u5f97\n\n```bash:\u30b3\u30de\u30f3\u30c9\nAWS_ID=$(aws sts get-caller-identity \\\n    --query Account \\\n    --output text) \\\n    && echo ${AWS_ID}\n```\n\n```text:\u7d50\u679c\n************\n```\n\n### \u30d0\u30b1\u30c3\u30c8\u540d\u306e\u6307\u5b9a\n\n```bash:\u30b3\u30de\u30f3\u30c9\nBUCKET_NAME=\"jawsug-cli-firehose-${AWS_ID}\" \\\n    && echo ${BUCKET_NAME}\n```\n\n```text:\u7d50\u679c\njawsug-cli-firehose-************\n```\n\n#### \u540c\u540d\u306e\u30d0\u30b1\u30c3\u30c8\u304c\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws s3 ls ${BUCKET_NAME}\n```\n\n```text:\u7d50\u679c\nAn error occurred (NoSuchBucket) when calling the ListObjects operation: The specified bucket does not exist\n```\n\n### \u5909\u6570\u306e\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n    BUCKET_NAME: ${BUCKET_NAME}\n\nETX\n```\n\n```text:\u7d50\u679c\n\n    BUCKET_NAME: jawsug-cli-firehose-************\n\n```\n\n### \u30d0\u30b1\u30c3\u30c8\u306e\u4f5c\u6210\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws s3api create-bucket \\\n    --bucket ${BUCKET_NAME} \\\n    --create-bucket-configuration LocationConstraint=${AWS_DEFAULT_REGION}\n```\n\n```json:\u7d50\u679c\n{\n    \"Location\": \"http://jawsug-cli-firehose-************.s3.amazonaws.com/\"\n}\n```\n\n### \u4f5c\u6210\u3055\u308c\u305f\u30d0\u30b1\u30c3\u30c8\u306e\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws s3 ls | grep ${BUCKET_NAME}\n```\n\n```text:\u7d50\u679c\n2016-11-05 05:49:49 jawsug-cli-firehose-************\n```\n\n\n# 2. \u30ed\u30b0\u306e\u51fa\u529b\u5148\u306e\u4f5c\u6210\n\n\u3053\u306e\u30ed\u30b0\u306f\u3001Kinesis Firehose\u306b\u95a2\u3059\u308b\u30a8\u30e9\u30fc\u30ed\u30b0\u306a\u3069\u3092\u6307\u3057\u307e\u3059\u3002\n\u3053\u306e\u30cf\u30f3\u30ba\u30aa\u30f3\u3067\u306f\uff08\u30a8\u30e9\u30fc\u304c\u8d77\u304d\u306a\u3051\u308c\u3070\u4f55\u3082\u51fa\u529b\u3055\u308c\u306a\u3044\u306e\u3067\uff09\u7279\u306b\u78ba\u8a8d\u306f\u3057\u307e\u305b\u3093\u304c\u3001\u904b\u7528\u74b0\u5883\u3067\u306f\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u306b\u306a\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\n## \u30ed\u30b0\u30b0\u30eb\u30fc\u30d7\u306e\u4f5c\u6210\n\n### \u30ed\u30b0\u30b0\u30eb\u30fc\u30d7\u540d\u306e\u6307\u5b9a\n\n```bash:\u30b3\u30de\u30f3\u30c9\nLOG_GROUP_NAME=\"jawsug-cli-firehose\"\n```\n\n### \u30ed\u30b0\u30b0\u30eb\u30fc\u30d7\u540d\u306e\u91cd\u8907\u3092\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws logs describe-log-groups \\\n    --log-group-name-prefix ${LOG_GROUP_NAME}\n```\n\n```json:\u7d50\u679c\n{\n    \"logGroups\": []\n}\n```\n\n### \u5909\u6570\u306e\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n    LOG_GROUP_NAME: ${LOG_GROUP_NAME}\n\nETX\n```\n\n```text:\u7d50\u679c\n\n    LOG_GROUP_NAME: jawsug-cli-firehose\n\n```\n\n### \u30ed\u30b0\u30b0\u30eb\u30fc\u30d7\u306e\u4f5c\u6210\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws logs create-log-group \\\n    --log-group-name ${LOG_GROUP_NAME}\n```\n\n```text:\u7d50\u679c\n\uff08\u8fd4\u5024\u7121\u3057\uff09\n```\n\n### \u30ed\u30b0\u30b0\u30eb\u30fc\u30d7\u306e\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws logs describe-log-groups \\\n    --log-group-name-prefix ${LOG_GROUP_NAME}\n```\n\n```json:\u7d50\u679c\n{\n    \"logGroups\": [\n        {\n            \"arn\": \"arn:aws:logs:us-west-2:************:log-group:jawsug-cli-firehose:*\",\n            \"creationTime\": 1478325129343,\n            \"metricFilterCount\": 0,\n            \"logGroupName\": \"jawsug-cli-firehose\",\n            \"storedBytes\": 0\n        }\n    ]\n}\n```\n\n## \u30ed\u30b0\u30b9\u30c8\u30ea\u30fc\u30e0\u306e\u4f5c\u6210\n\n### \u30ed\u30b0\u30b9\u30c8\u30ea\u30fc\u30e0\u540d\u306e\u6307\u5b9a\n\n```bash:\u30b3\u30de\u30f3\u30c9\nLOG_STREAM_NAME=\"handson\"\n```\n\n\n### \u30ed\u30b0\u30b9\u30c8\u30ea\u30fc\u30e0\u540d\u306e\u91cd\u8907\u3092\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws logs describe-log-streams \\\n    --log-group-name ${LOG_GROUP_NAME}\\\n    --log-stream-name-prefix ${LOG_STREAM_NAME}\n```\n\n```json:\u7d50\u679c\n{\n    \"logStreams\": []\n}\n```\n\n### \u5909\u6570\u306e\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n    LOG_GROUP_NAME: ${LOG_GROUP_NAME}\n    LOG_STREAM_NAME: ${LOG_STREAM_NAME}\n\nETX\n```\n\n```text:\u7d50\u679c\n\n    LOG_GROUP_NAME: jawsug-cli-firehose\n    LOG_STREAM_NAME: handson\n\n```\n\n### \u30ed\u30b0\u30b9\u30c8\u30ea\u30fc\u30e0\u306e\u4f5c\u6210\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws logs create-log-stream \\\n    --log-group-name ${LOG_GROUP_NAME} \\\n    --log-stream-name ${LOG_STREAM_NAME}\n```\n\n```text:\u7d50\u679c\n\uff08\u8fd4\u5024\u7121\u3057\uff09\n```\n\n\n### \u30ed\u30b0\u30b9\u30c8\u30ea\u30fc\u30e0\u306e\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws logs describe-log-streams \\\n    --log-group-name ${LOG_GROUP_NAME}\\\n    --log-stream-name-prefix ${LOG_STREAM_NAME}\n```\n\n```json:\u7d50\u679c\n{\n    \"logStreams\": [\n        {\n            \"creationTime\": 1478325265601,\n            \"arn\": \"arn:aws:logs:us-west-2:************:log-group:jawsug-cli-firehose:log-stream:handson\",\n            \"logStreamName\": \"handson\",\n            \"storedBytes\": 0\n        }\n    ]\n}\n```\n\n# 3. IAM Role\u306e\u4f5c\u6210\n\nKinesis Firehose\u306b\u5bfe\u3057\u3001\u6a29\u9650\u3092\u59d4\u4efb\u3059\u308b\u305f\u3081\u306eIAM Role\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\uff08\u4ed8\u4e0e\u3059\u308b\u6a29\u9650\u306f\u5f8c\u8ff0\uff09\n\n## IAM Role\u306e\u4f5c\u6210\n\n### IAM Role\u540d\u3092\u6307\u5b9a\n\n```bash:\u30b3\u30de\u30f3\u30c9\nROLE_NAME='service-role-firehose'\n```\n\n### \u540c\u540d\u306e\u30ed\u30fc\u30eb\u304c\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws iam get-role \\\n    --role-name ${ROLE_NAME}\n```\n\n```text:\u7d50\u679c\nAn error occurred (NoSuchEntity) when calling the GetRole operation: Unknown\n```\n\n\n### \u4fe1\u983c\u95a2\u4fc2\u306e\u5b9a\u7fa9\n\n```bash:\u30b3\u30de\u30f3\u30c9\nTRUST_POLICY_FILE='Trust-Policy.json'\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9\ncat << EOF > ${TRUST_POLICY_FILE}\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": \"firehose.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRole\"\n    }\n  ]\n}\nEOF\n\ncat ${TRUST_POLICY_FILE}\n```\n\n```json:\u7d50\u679c\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": \"firehose.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRole\"\n    }\n  ]\n}\n```\n\n### JSON\u30d5\u30a1\u30a4\u30eb\u3092\u691c\u8a3c\n\n```bash:\u30b3\u30de\u30f3\u30c9\njsonlint -q ${TRUST_POLICY_FILE}\n```\n\n```text:\u7d50\u679c\n\uff08\u8fd4\u5024\u7121\u3057\uff09\n```\n\n### \u5909\u6570\u306e\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n    ROLE_NAME: ${ROLE_NAME}\n    TRUST_POLICY_FILE: ${TRUST_POLICY_FILE}\n\nETX\n```\n\n```text:\u7d50\u679c\n\n    ROLE_NAME: service-role-firehose\n    TRUST_POLICY_FILE: Trust-Policy.json\n\n```\n\n### IAM\u30ed\u30fc\u30eb\u306e\u4f5c\u6210\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws iam create-role \\\n    --role-name ${ROLE_NAME} \\\n    --assume-role-policy-document file://${TRUST_POLICY_FILE}\n```\n\n```json:\u7d50\u679c\n{\n    \"Role\": {\n        \"AssumeRolePolicyDocument\": {\n            \"Version\": \"2012-10-17\",\n            \"Statement\": [\n                {\n                    \"Action\": \"sts:AssumeRole\",\n                    \"Principal\": {\n                        \"Service\": \"firehose.amazonaws.com\"\n                    },\n                    \"Effect\": \"Allow\",\n                    \"Sid\": \"\"\n                }\n            ]\n        },\n        \"RoleId\": \"A********************\",\n        \"CreateDate\": \"2016-11-05T05:58:53.873Z\",\n        \"RoleName\": \"service-role-firehose\",\n        \"Path\": \"/\",\n        \"Arn\": \"arn:aws:iam::************:role/service-role-firehose\"\n    }\n}\n```\n\n\n### IAM\u30ed\u30fc\u30eb\u306e\u78ba\u8a8d\u304a\u3088\u3073ARN\u306e\u53d6\u5f97\n\n```bash:\u30b3\u30de\u30f3\u30c9\nROLE_ARN=$(aws iam get-role \\\n    --role-name ${ROLE_NAME} \\\n    --query Role.Arn \\\n    --output text) \\\n    && echo ${ROLE_ARN}\n```\n\n```text:\u7d50\u679c\narn:aws:iam::************:role/service-role-firehose\n```\n\n\n### \u30dd\u30ea\u30b7\u30fc\u540d\u306e\u6307\u5b9a\n\n\u3053\u3053\u3067Kinesis Firehose\u306b\u5bfe\u3057\u3066\u59d4\u4efb\u3059\u308b\u6a29\u9650\u3092\u5b9a\u7fa9\u3057\u307e\u3059\u3002\n\u5177\u4f53\u7684\u306b\u306f\u3001\n\n- S3\u3078\u306e\u30c7\u30fc\u30bf\u914d\u4fe1\n- CloudWatch Logs\u3078\u306e\u30ed\u30b0\u306e\u51fa\u529b\n\n\u306e\u6a29\u9650\u3092\u4ed8\u4e0e\u3057\u307e\u3059\u3002\n\n[Controlling Access with Amazon Kinesis Firehose(Grant Firehose Access to an Amazon S3 Destination)](http://docs.aws.amazon.com/firehose/latest/dev/controlling-access.html#using-iam-s3)\n\n\u203bKMS\u3092\u5229\u7528\u3059\u308b\u5834\u5408\u306b\u306f\u3001\u5fc5\u8981\u306a\u30dd\u30ea\u30b7\u30fc\u3092\u8ffd\u8a18\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9\nGRANT_POLICY_FILE='Grant-Firehose-Access-to-S3-Policy.json'\n```\n\n### \u5909\u6570\u306e\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n    GRANT_POLICY_FILE: ${GRANT_POLICY_FILE}\n    BUCKET_NAME: ${BUCKET_NAME}\n    AWS_DEFAULT_REGION: ${AWS_DEFAULT_REGION}\n    AWS_ID: ${AWS_ID}\n    LOG_GROUP_NAME: ${LOG_GROUP_NAME}\n    LOG_STREAM_NAME: ${LOG_STREAM_NAME}\n\nETX\n```\n\n```text:\u7d50\u679c\n\n    GRANT_POLICY_FILE: Grant-Firehose-Access-to-S3-Policy.json\n    BUCKET_NAME: jawsug-cli-firehose-************\n    AWS_DEFAULT_REGION: us-west-2\n    AWS_ID: ************\n    LOG_GROUP_NAME: jawsug-cli-firehose\n    LOG_STREAM_NAME: handson\n\n```\n\n### \u30dd\u30ea\u30b7\u30fc\u306e\u751f\u6210\n\n```bash:\u30b3\u30de\u30f3\u30c9\ncat << EOF > ${GRANT_POLICY_FILE}\n{\n    \"Version\": \"2012-10-17\",  \n    \"Statement\":\n    [\n        {\n            \"Effect\": \"Allow\",      \n            \"Action\":\n            [        \n                \"s3:AbortMultipartUpload\",        \n                \"s3:GetBucketLocation\",        \n                \"s3:GetObject\",        \n                \"s3:ListBucket\",        \n                \"s3:ListBucketMultipartUploads\",        \n                \"s3:PutObject\"\n            ],      \n            \"Resource\":\n            [        \n                \"arn:aws:s3:::${BUCKET_NAME}\",\n                \"arn:aws:s3:::${BUCKET_NAME}/*\"\t\t    \n            ]    \n        },\n        {\n           \"Effect\": \"Allow\",\n           \"Action\": [\n               \"logs:PutLogEvents\"\n           ],\n           \"Resource\": [\n               \"arn:aws:logs:${AWS_DEFAULT_REGION}:${AWS_ID}:log-group:${LOG_GROUP_NAME}:log-stream:${LOG_STREAM_NAME}\"\n           ]\n        }\n    ]\n}\nEOF\n\ncat ${GRANT_POLICY_FILE}\n```\n\n```json:\u7d50\u679c\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\":\n    [\n        {\n            \"Effect\": \"Allow\",\n            \"Action\":\n            [\n                \"s3:AbortMultipartUpload\",\n                \"s3:GetBucketLocation\",\n                \"s3:GetObject\",\n                \"s3:ListBucket\",\n                \"s3:ListBucketMultipartUploads\",\n                \"s3:PutObject\"\n            ],\n            \"Resource\":\n            [\n                \"arn:aws:s3:::jawsug-cli-firehose-************\",\n                \"arn:aws:s3:::jawsug-cli-firehose-************/*\"\n            ]\n        },\n        {\n           \"Effect\": \"Allow\",\n           \"Action\": [\n               \"logs:PutLogEvents\"\n           ],\n           \"Resource\": [\n               \"arn:aws:logs:us-west-2:************:log-group:jawsug-cli-firehose:log-stream:handson\"\n           ]\n        }\n    ]\n}\n```\n\n### JSON\u30d5\u30a1\u30a4\u30eb\u3092\u691c\u8a3c\n\n```bash:\u30b3\u30de\u30f3\u30c9\njsonlint -q ${GRANT_POLICY_FILE}\n```\n\n```text:\u7d50\u679c\n\uff08\u8fd4\u5024\u7121\u3057\uff09\n```\n\n\n### \u30dd\u30ea\u30b7\u30fc\u540d\u3092\u6307\u5b9a\n\n```bash:\u30b3\u30de\u30f3\u30c9\nPOLICY_NAME=\"ServicePolicyFirehose\"\n```\n\n### \u540c\u540d\u306e\u30dd\u30ea\u30b7\u30fc\u304c\u7121\u3044\u3053\u3068\u3092\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws iam list-policies \\\n    --scope Local \\\n    --query Policies[?PolicyName==${POLICY_NAME}]\n```\n\n```json:\u7d50\u679c\n[]\n```\n\n### \u5909\u6570\u306e\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n    POLICY_NAME: ${POLICY_NAME}\n    GRANT_POLICY_FILE: ${GRANT_POLICY_FILE}\n\nETX\n```\n\n```text:\u7d50\u679c\n\n    POLICY_NAME: ServicePolicyFirehose\n    GRANT_POLICY_FILE: Grant-Firehose-Access-to-S3-Policy.json\n\n```\n\n### \u30dd\u30ea\u30b7\u30fc\u306e\u4f5c\u6210\u3001ARN\u306e\u53d6\u5f97\n\nIAM\u30dd\u30ea\u30b7\u30fc\u3092IAM Role\u306b\u30a2\u30bf\u30c3\u30c1\u3059\u308b\u969b\u306b\u30dd\u30ea\u30b7\u30fc\u3092ARN\u3067\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u305f\u3081\u3001\u3053\u3053\u3067ARN\u3092\u53d6\u5f97\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws iam create-policy \\\n    --policy-name ${POLICY_NAME} \\\n    --policy-document file://${GRANT_POLICY_FILE}\n```\n\n```json:\u7d50\u679c\n{\n    \"Policy\": {\n        \"PolicyName\": \"ServicePolicyFirehose\",\n        \"CreateDate\": \"2016-12-19T05:37:59.731Z\",\n        \"AttachmentCount\": 0,\n        \"IsAttachable\": true,\n        \"PolicyId\": \"A********************\",\n        \"DefaultVersionId\": \"v1\",\n        \"Path\": \"/\",\n        \"Arn\": \"arn:aws:iam::************:policy/ServicePolicyFirehose\",\n        \"UpdateDate\": \"2016-12-19T05:37:59.731Z\"\n    }\n}\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9\nPOLICY_ARN=$(aws iam list-policies \\\n    --max-items 1000 \\\n    --query \"Policies[?PolicyName==\\`${POLICY_NAME}\\`].Arn\" \\\n    --output text \\\n    ) && echo \"${POLICY_ARN}\"\n```\n\n```text:\u7d50\u679c\narn:aws:iam::************:policy/ServicePolicyFirehose\n```\n\n### \u4f5c\u6210\u3057\u305f\u30dd\u30ea\u30b7\u30fc\u306e\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws iam get-policy \\\n    --policy-arn ${POLICY_ARN}\n```\n\n```json:\u7d50\u679c\n{\n    \"Policy\": {\n        \"PolicyName\": \"ServicePolicyFirehose\",\n        \"CreateDate\": \"2016-12-03T05:35:18Z\",\n        \"AttachmentCount\": 0,\n        \"IsAttachable\": true,\n        \"PolicyId\": \"A********************\",\n        \"DefaultVersionId\": \"v1\",\n        \"Path\": \"/\",\n        \"Arn\": \"arn:aws:iam::************:policy/ServicePolicyFirehose\",\n        \"UpdateDate\": \"2016-12-03T05:35:18Z\"\n    }\n}\n```\n\n### \u5909\u6570\u306e\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n    ROLE_NAME: ${ROLE_NAME}\n    POLICY_ARN: ${POLICY_ARN}\n\nETX\n```\n\n```text:\u7d50\u679c\n\n    ROLE_NAME: service-role-firehose\n    POLICY_ARN: arn:aws:iam::************:policy/ServicePolicyFirehose\n\n```\n\n### \u30dd\u30ea\u30b7\u30fc\u3092\u30ed\u30fc\u30eb\u306b\u30a2\u30bf\u30c3\u30c1\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws iam attach-role-policy \\\n    --role-name ${ROLE_NAME}\\\n    --policy-arn ${POLICY_ARN}\n```\n\n```text:\u7d50\u679c\n\uff08\u8fd4\u5024\u7121\u3057\uff09\n```\n\n### IAM Role\u306b\u30dd\u30ea\u30b7\u30fc\u304c\u30a2\u30bf\u30c3\u30c1\u3055\u308c\u305f\u3053\u3068\u3092\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws iam list-attached-role-policies --role-name ${ROLE_NAME}\n```\n\n```json:\u7d50\u679c\n{\n    \"AttachedPolicies\": [\n        {\n            \"PolicyName\": \"service-policy-firehose\",\n            \"PolicyArn\": \"arn:aws:iam::************:policy/service-policy-firehose\"\n        }\n    ]\n}\n```\n\n\u4ee5\u4e0a\n", "tags": ["AWS", "aws-cli", "Kinesis", "Firehose"]}