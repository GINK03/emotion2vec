{"tags": ["UE4", "NDK", "Android", "UnrealEngine"], "context": "\n\n\u306f\u3058\u3081\u306b\n\u4ee5\u524d\u3001UE4\u306eC++\u304b\u3089Android API\u3092\u547c\u3093\u3067\u307f\u305f\u3067Unreal C++\u304b\u3089Android API\u3092\u547c\u3093\u3067\u307f\u3066\u3001Android NDK\u304c\u3064\u3089\u3044\u611f\u3058\u3067\u3057\u305f\u3002\u3067\u3059\u304c\u3001UE4\u306fAndroid\u5074\u3092\u62e1\u5f35\u3059\u308b\u624b\u6bb5\u3092Unreal Plugin Language (\u4ee5\u4e0b\u3001UPL\u3068\u7701\u7565\u3059\u308b)\u3068\u3057\u3066\u7528\u610f\u3057\u3066\u3044\u307e\u3059\u3002\u4eca\u56de\u306f\u305d\u308c\u3092\u4f7f\u3063\u3066\u3001Unreal C++\u304b\u3089Android API\u547c\u3073\u51fa\u3057\u306e\u3064\u3089\u3055\u3092\u8efd\u6e1b\u3057\u307e\u3059\u3002\n\nJava\u306e\u30b3\u30fc\u30c9\u3092GameActivity.java\u306b\u8ffd\u3044\u51fa\u3059\nAndroid NDK\u3092\u4f7f\u3063\u305f\u3068\u304d\u306e\u3064\u3089\u3055\u306fFindClass()\u3084GetMethodID()\u3067\u5404ID\u3092\u53d6\u5f97\u3057\u305f\u308a\u3001\u30e1\u30bd\u30c3\u30c9\u547c\u3073\u51fa\u3057\u5f8c\u306bDeleteLocalRef()\u3067\u53c2\u7167\u3092\u524a\u9664\u3057\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u3053\u3068\u3067\u3059\u3002\u305d\u308c\u306a\u3089\u3070Java\u306e\u30b3\u30fc\u30c9\u306fJava\u5074\u306b\u8ffd\u3044\u51fa\u3057\u3066\u3057\u307e\u3046\u306e\u304c\u81ea\u7136\u3067\u3057\u3087\u3046\u3002\n\u4ee5\u4e0b\u3067\u306fUPL\u3067\u3001GameActivity.java\u306bPictures\u30d1\u30b9\u3092\u53d6\u5f97\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u3092\u8ffd\u52a0\u3057\u3066\u3001C++\u304b\u3089\u305d\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u547c\u3073\u51fa\u3059\u307e\u3067\u306e\u8a2d\u5b9a\u304a\u3088\u3073\u30b3\u30fc\u30c9\u3092\u89e3\u8aac\u3057\u307e\u3059\u3002\n\nCppTest.Build.cs\nUE4\u3067C++\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u4f5c\u6210\u3059\u308b\u3068\u5fc5\u305aBuild.cs\u304c\u4f5c\u6210\u3055\u308c\u307e\u3059\u3002\n\u3053\u306e\u4e2d\u3067UPL\u306eXML\u3092\u8aad\u307f\u8fbc\u307f\u307e\u3059\u3002\n\nSource/CppTest/CppTest.Build.cs\n// Fill out your copyright notice in the Description page of Project Settings.\n\nusing UnrealBuildTool;\n// \u3053\u3053\u304b\u3089\u8ffd\u52a0\nusing System.IO;\n// \u3053\u3053\u307e\u3067\u8ffd\u52a0\n\npublic class CppTest : ModuleRules\n{\n    public CppTest(TargetInfo Target)\n    {\n        PublicDependencyModuleNames.AddRange(new string[] { \"Core\", \"CoreUObject\", \"Engine\", \"InputCore\" });\n\n        PrivateDependencyModuleNames.AddRange(new string[] {  });\n\n        // \u3053\u3053\u304b\u3089\u8ffd\u52a0\n        if (Target.Platform == UnrealTargetPlatform.Android)\n        {\n            string ProjectPath = Utils.MakePathRelativeTo(ModuleDirectory, BuildConfiguration.RelativeEnginePath);\n            AdditionalPropertiesForReceipt.Add(new ReceiptProperty(\"AndroidPlugin\", Path.Combine(ProjectPath, \"CppTest_UPL.xml\")));\n        }\n        // \u3053\u3053\u307e\u3067\u8ffd\u52a0\n    }\n}\n\n\n\nCppTest_UPL.xml\n\u3053\u306e\u30d5\u30a1\u30a4\u30eb\u3067GameActivity.java\u306bPictures\u30d5\u30a9\u30eb\u30c0\u306e\u30d1\u30b9\u3092\u53d6\u5f97\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u3092\u8ffd\u52a0\u3057\u3066\u3044\u307e\u3059\u3002XML\u306e\u4e2d\u306eJava\u306e\u30b3\u30fc\u30c9\u306e\u65ad\u7247\u3092\u66f8\u304f\u306e\u304c\u6c17\u6301\u3061\u60aa\u3044\u3067\u3059\u304c\u6211\u6162\u3067\u3059\u3002\n\u8a73\u3057\u304f\u306fUnreal Plugin Language \u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\nSource/CppTest/CppTest_UPL.xml\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n\n<root xmlns:android=\"http://schemas.android.com/apk/res/android\">\n\n  <init>\n    <!-- APK\u4f5c\u6210\u6642\u306b\u30ed\u30b0\u3092\u51fa\u529b\u3059\u308b -->\n    <log text=\"CppTest init\"/>\n  </init>\n\n  <!-- APK\u4f5c\u6210\u6642\u306b\u30ed\u30b0\u51fa\u529b\u3092\u6709\u52b9\u306b\u3059\u308b -->\n  <trace enable=\"true\"/>\n\n  <gameActivityImportAdditions>\n    <insert>\n      import android.os.Environment;\n    </insert>\n  </gameActivityImportAdditions>\n\n  <gameActivityClassAdditions>\n    <insert>\n      public String AndroidThunkJava_GetPicturesPath() {\n          File f = Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_PICTURES);\n          return f.getPath();\n      }\n    </insert>\n  </gameActivityClassAdditions>\n\n</root>\n\n\n\nUMyBlueprintFunctionLibrary.h\n\u30d8\u30c3\u30c0\u30d5\u30a1\u30a4\u30eb\u306fUE4\u306eC++\u304b\u3089Android API\u3092\u547c\u3093\u3067\u307f\u305f\u3068\u540c\u3058\u3067\u3059\u3002\n\nSource/CppTest/UMyBlueprintFunctionLibrary.h\n// Fill out your copyright notice in the Description page of Project Settings.\n\n#pragma once\n\n#include \"Kismet/BlueprintFunctionLibrary.h\"\n#include \"MyBlueprintFunctionLibrary.generated.h\"\n\n/**\n * \n */\nUCLASS()\nclass CPPTEST_API UMyBlueprintFunctionLibrary : public UBlueprintFunctionLibrary\n{\n    GENERATED_BODY()\n\npublic:\n    UFUNCTION(BlueprintPure, Category = \"MyBPLibrary\")\n    static FString GetPicturesPath();\n\nprivate:\n    static FString GetPicturesPathJNI();\n};\n\n\n\nUMyBlueprintFunctionLibrary.cpp\n\u3084\u3063\u3068C++\u306e\u672c\u4f53\u3067\u3059\u3002\n\u4ee5\u524d\u306fJava\u5074\u306e\u8907\u6570\u306e\u30af\u30e9\u30b9\u3084\u30e1\u30f3\u30d0\u30fc\u5909\u6570\u3092\u53c2\u7167\u3057\u3066\u3044\u307e\u3057\u305f\u304c\u3001\u4eca\u56de\u306f\u8ffd\u52a0\u3057\u305f\u30e1\u30bd\u30c3\u30c91\u3064\u3060\u3051\u306b\u306a\u3063\u305f\u306e\u3067\u5e7e\u5206\u304b\u697d\u306b\u306a\u308a\u307e\u3057\u305f\u3002\nJava\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u5bfe\u3057\u3066\u30e1\u30bd\u30c3\u30c9\u3092\u547c\u3073\u305f\u3044\u5834\u5408\u306f\u3053\u308c\u304c\u9650\u754c\u3060\u3068\u601d\u3044\u307e\u3059\u3002\n\nSource/CppTest/UMyBlueprintFunctionLibrary.cpp\n// Fill out your copyright notice in the Description page of Project Settings.\n\n#include \"CppTest.h\"\n#include \"MyBlueprintFunctionLibrary.h\"\n\n#if PLATFORM_ANDROID\n#include \"Android/AndroidApplication.h\"\n#endif\n\nFString UMyBlueprintFunctionLibrary::GetPicturesPath()\n{\n    static FString PicturesPath = UMyBlueprintFunctionLibrary::GetPicturesPath();\n    return PicturesPath;\n}\n\nFString UMyBlueprintFunctionLibrary::GetPicturesPathJNI()\n{\n    FString result;\n#if PLATFORM_ANDROID\n    JNIEnv* Env = FAndroidApplication::GetJavaEnv();\n\n    if (nullptr != Env)\n    {\n        jclass GameActivity = FAndroidApplication::GetGameActivityThis();\n        jmethodID getPicturesPathMethod = Env->GetStaticMethodID(GameCls, \"AndroidThunkJava_GetPicturesPath\", \"()Ljava/lang/String;\");\n\n        jstring pathString = (jstring)Env->CallObjectMethod(GameActivity, getPicturesPathMethod, nullptr);\n        Env->DeleteLocalRef(getPicturesPathMethod);\n\n        const char *nativePathString = Env->GetStringUTFChars(pathString, 0);\n        result = FString(nativePathString);\n\n        Env->ReleaseStringUTFChars(pathString, nativePathString);\n        Env->DeleteLocalRef(pathString);\n    }\n    else\n    {\n#endif\n        result = FString(\"\");\n#if PLATFORM_ANDROID\n    }\n#endif\n\n    return result;\n}\n\n\n\nGameActivity.java\u304b\u3089\u30cd\u30a4\u30c6\u30a3\u30d6\u30e1\u30bd\u30c3\u30c9\u3092\u547c\u3073\u51fa\u3059\n\u4eca\u5ea6\u306f\u30b2\u30fc\u30e0\u8d77\u52d5\u5f8c\u3001\u5909\u66f4\u3055\u308c\u306a\u3044\u5024\u3092C++\u5074\u3067\u53d7\u3051\u53d6\u308b\u5834\u5408\u3092\u89e3\u8aac\u3057\u307e\u3059\u3002\n\nCppTest.Build.cs\nSource/CppTest/CppTest.Build.cs\u306f\u540c\u3058\u306a\u306e\u3067\u5272\u611b\u3057\u307e\u3059\u3002\n\nCppTest_UPL.xml\n\u4eca\u5ea6\u306f\u30cd\u30a4\u30c6\u30a3\u30d6\u30e1\u30bd\u30c3\u30c9nativeSetPicturesPath()\u3092\u5b9a\u7fa9\u3057\u3066\u3001Android\u306eonCreate()\u30e1\u30bd\u30c3\u30c9\u306e\u4e2d\u3067Pictures\u30d5\u30a9\u30eb\u30c0\u306e\u30d1\u30b9\u3092\u6e21\u3057\u307e\u3059\u3002\n\nSource/CppTest/CppTest_UPL.xml\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n\n<root xmlns:android=\"http://schemas.android.com/apk/res/android\">\n\n  <init>\n    <!-- APK\u4f5c\u6210\u6642\u306b\u30ed\u30b0\u3092\u51fa\u529b\u3059\u308b -->\n    <log text=\"CppTest init\"/>\n  </init>\n\n  <!-- APK\u4f5c\u6210\u6642\u306b\u30ed\u30b0\u51fa\u529b\u3092\u6709\u52b9\u306b\u3059\u308b -->\n  <trace enable=\"true\"/>\n\n  <gameActivityImportAdditions>\n    <insert>\n      import android.os.Environment;\n    </insert>\n  </gameActivityImportAdditions>\n\n  <gameActivityClassAdditions>\n    <insert>\n      public native void nativeSetPicturesPath(String PicturesPath);\n    </insert>\n  </gameActivityClassAdditions>\n\n  <gameActivityReadMetadataAdditions>\n    <insert>\n      File f = Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_PICTURES);\n      nativeSetPicturesPath(f.getPath());\n    </insert>\n  </gameActivityReadMetadataAdditions>\n\n</root>\n\n\n\nUMyBlueprintFunctionLibrary.h\nJava\u306e\u30cd\u30a4\u30c6\u30a3\u30d6\u30e1\u30bd\u30c3\u30c9\u306e\u5f15\u6570\u3067Pictures\u30d5\u30a9\u30eb\u30c0\u306e\u30d1\u30b9\u304c\u6e21\u3055\u308c\u308b\u306e\u3067\u305d\u308c\u3092\u4fdd\u5b58\u3059\u308b\u305f\u3081\u306e\u5909\u6570PicturesPath\u3092\u8ffd\u52a0\u3057\u3066\u3001JNI\u95a2\u6570\u3092\u4f7f\u308f\u306a\u304f\u306a\u3063\u305f\u306e\u3067GetPicturesPathJNI\u95a2\u6570\u3092\u524a\u9664\u3057\u3066\u3044\u307e\u3059\u3002\n\nSource/CppTest/UMyBlueprintFunctionLibrary.h\n// Fill out your copyright notice in the Description page of Project Settings.\n\n#pragma once\n\n#include \"Kismet/BlueprintFunctionLibrary.h\"\n#include \"MyBlueprintFunctionLibrary.generated.h\"\n\n/**\n * \n */\nUCLASS()\nclass CPPTEST_API UMyBlueprintFunctionLibrary : public UBlueprintFunctionLibrary\n{\n    GENERATED_BODY()\n\npublic:\n    static FString PicturesPath;\n\n    UFUNCTION(BlueprintPure, Category = \"MyBPLibrary\")\n    static FString GetPicturesPath();\n};\n\n\n\nUMyBlueprintFunctionLibrary.cpp\nC++\u306e\u672c\u4f53\u306fPicturesPath\u306egetter\u95a2\u6570\u3068Java\u3067\u5ba3\u8a00\u3057\u305f\u30cd\u30a4\u30c6\u30a3\u30d6\u30e1\u30bd\u30c3\u30c9\u306e\u5b9f\u88c5\u3060\u3051\u306b\u306a\u308a\u3001\u6700\u521d\u3068\u6bd4\u3079\u308b\u3068\u968f\u5206\u3068\u77ed\u304f\u306a\u308a\u307e\u3057\u305f\u3002\n\nSource/CppTest/UMyBlueprintFunctionLibrary.cpp\n// Fill out your copyright notice in the Description page of Project Settings.\n\n#include \"CppTest.h\"\n#include \"MyBlueprintFunctionLibrary.h\"\n\n#if PLATFORM_ANDROID\n#include \"Android/AndroidApplication.h\"\n#endif\n\nFString UMyBlueprintFunctionLibrary::PicturesPath;\n\nFString UMyBlueprintFunctionLibrary::GetPicturesPath()\n{\n    return UMyBlueprintFunctionLibrary::PicturesPath;\n}\n\n#if PLATFORM_ANDROID\nextern \"C\"\n{\n    JNIEXPORT void JNICALL Java_com_epicgames_ue4_GameActivity_nativeSetPicturesPath(JNIEnv* jenv, jobject thiz, jstring picturesPath)\n    {\n        const char* javaChars = jenv->GetStringUTFChars(picturesPath, 0);\n\n        UMyBlueprintFunctionLibrary::PicturesPath = FString(UTF8_TO_TCHAR(javaChars));\n\n        //Release the string\n        jenv->ReleaseStringUTFChars(picturesPath, javaChars);\n    }\n}\n#endif\n\n\n\n\u307e\u3068\u3081\nUPL\u3092\u4f7f\u3063\u3066\u3001Android API\u547c\u3073\u51fa\u3057\u306e\u3064\u3089\u3055\u3092\u8efd\u6e1b\u3067\u304d\u307e\u3057\u305f\uff01\nAndroid NDK\u306b\u3082\u8272\u3005\u3068\u95a2\u6570\u304c\u7528\u610f\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u308f\u3056\u308f\u3056Android API\u3092\u547c\u3076\u6a5f\u4f1a\u306f\u307b\u3068\u3093\u3069\u306a\u3044\u3068\u601d\u3044\u307e\u3059\u304c\u3001\u8ab0\u304b\u306e\u52a9\u3051\u306b\u306a\u308c\u3070\u3088\u3044\u304b\u3068\u601d\u3044\u307e\u3059\u3002\n# \u306f\u3058\u3081\u306b\n\n\u4ee5\u524d\u3001[UE4\u306eC++\u304b\u3089Android API\u3092\u547c\u3093\u3067\u307f\u305f](http://qiita.com/shiena/items/7b9d0de97a733b1a5101)\u3067Unreal C++\u304b\u3089Android API\u3092\u547c\u3093\u3067\u307f\u3066\u3001Android NDK\u304c\u3064\u3089\u3044\u611f\u3058\u3067\u3057\u305f\u3002\u3067\u3059\u304c\u3001UE4\u306fAndroid\u5074\u3092\u62e1\u5f35\u3059\u308b\u624b\u6bb5\u3092[Unreal Plugin Language](http://qiita.com/shiena/items/fe0e4cc1de4ddbaa60f0) (\u4ee5\u4e0b\u3001UPL\u3068\u7701\u7565\u3059\u308b)\u3068\u3057\u3066\u7528\u610f\u3057\u3066\u3044\u307e\u3059\u3002\u4eca\u56de\u306f\u305d\u308c\u3092\u4f7f\u3063\u3066\u3001Unreal C++\u304b\u3089Android API\u547c\u3073\u51fa\u3057\u306e\u3064\u3089\u3055\u3092\u8efd\u6e1b\u3057\u307e\u3059\u3002\n\n# Java\u306e\u30b3\u30fc\u30c9\u3092GameActivity.java\u306b\u8ffd\u3044\u51fa\u3059\n\nAndroid NDK\u3092\u4f7f\u3063\u305f\u3068\u304d\u306e\u3064\u3089\u3055\u306f`FindClass()`\u3084`GetMethodID()`\u3067\u5404ID\u3092\u53d6\u5f97\u3057\u305f\u308a\u3001\u30e1\u30bd\u30c3\u30c9\u547c\u3073\u51fa\u3057\u5f8c\u306b`DeleteLocalRef()`\u3067\u53c2\u7167\u3092\u524a\u9664\u3057\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u3053\u3068\u3067\u3059\u3002\u305d\u308c\u306a\u3089\u3070Java\u306e\u30b3\u30fc\u30c9\u306fJava\u5074\u306b\u8ffd\u3044\u51fa\u3057\u3066\u3057\u307e\u3046\u306e\u304c\u81ea\u7136\u3067\u3057\u3087\u3046\u3002\n\n\u4ee5\u4e0b\u3067\u306fUPL\u3067\u3001GameActivity.java\u306bPictures\u30d1\u30b9\u3092\u53d6\u5f97\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u3092\u8ffd\u52a0\u3057\u3066\u3001C++\u304b\u3089\u305d\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u547c\u3073\u51fa\u3059\u307e\u3067\u306e\u8a2d\u5b9a\u304a\u3088\u3073\u30b3\u30fc\u30c9\u3092\u89e3\u8aac\u3057\u307e\u3059\u3002\n\n## CppTest.Build.cs\n\nUE4\u3067C++\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u4f5c\u6210\u3059\u308b\u3068\u5fc5\u305a`Build.cs`\u304c\u4f5c\u6210\u3055\u308c\u307e\u3059\u3002\n\u3053\u306e\u4e2d\u3067UPL\u306eXML\u3092\u8aad\u307f\u8fbc\u307f\u307e\u3059\u3002\n\n```csharp:Source/CppTest/CppTest.Build.cs\n// Fill out your copyright notice in the Description page of Project Settings.\n\nusing UnrealBuildTool;\n// \u3053\u3053\u304b\u3089\u8ffd\u52a0\nusing System.IO;\n// \u3053\u3053\u307e\u3067\u8ffd\u52a0\n\npublic class CppTest : ModuleRules\n{\n    public CppTest(TargetInfo Target)\n    {\n        PublicDependencyModuleNames.AddRange(new string[] { \"Core\", \"CoreUObject\", \"Engine\", \"InputCore\" });\n\n        PrivateDependencyModuleNames.AddRange(new string[] {  });\n\n        // \u3053\u3053\u304b\u3089\u8ffd\u52a0\n        if (Target.Platform == UnrealTargetPlatform.Android)\n        {\n            string ProjectPath = Utils.MakePathRelativeTo(ModuleDirectory, BuildConfiguration.RelativeEnginePath);\n            AdditionalPropertiesForReceipt.Add(new ReceiptProperty(\"AndroidPlugin\", Path.Combine(ProjectPath, \"CppTest_UPL.xml\")));\n        }\n        // \u3053\u3053\u307e\u3067\u8ffd\u52a0\n    }\n}\n```\n\n## CppTest_UPL.xml\n\n\u3053\u306e\u30d5\u30a1\u30a4\u30eb\u3067GameActivity.java\u306bPictures\u30d5\u30a9\u30eb\u30c0\u306e\u30d1\u30b9\u3092\u53d6\u5f97\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u3092\u8ffd\u52a0\u3057\u3066\u3044\u307e\u3059\u3002XML\u306e\u4e2d\u306eJava\u306e\u30b3\u30fc\u30c9\u306e\u65ad\u7247\u3092\u66f8\u304f\u306e\u304c\u6c17\u6301\u3061\u60aa\u3044\u3067\u3059\u304c\u6211\u6162\u3067\u3059\u3002\n\u8a73\u3057\u304f\u306f[Unreal Plugin Language \u30ea\u30d5\u30a1\u30ec\u30f3\u30b9](http://qiita.com/shiena/items/fe0e4cc1de4ddbaa60f0)\u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n```xml:Source/CppTest/CppTest_UPL.xml\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n\n<root xmlns:android=\"http://schemas.android.com/apk/res/android\">\n\n  <init>\n    <!-- APK\u4f5c\u6210\u6642\u306b\u30ed\u30b0\u3092\u51fa\u529b\u3059\u308b -->\n    <log text=\"CppTest init\"/>\n  </init>\n\n  <!-- APK\u4f5c\u6210\u6642\u306b\u30ed\u30b0\u51fa\u529b\u3092\u6709\u52b9\u306b\u3059\u308b -->\n  <trace enable=\"true\"/>\n\n  <gameActivityImportAdditions>\n    <insert>\n      import android.os.Environment;\n    </insert>\n  </gameActivityImportAdditions>\n\n  <gameActivityClassAdditions>\n    <insert>\n      public String AndroidThunkJava_GetPicturesPath() {\n          File f = Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_PICTURES);\n          return f.getPath();\n      }\n    </insert>\n  </gameActivityClassAdditions>\n\n</root>\n```\n\n## UMyBlueprintFunctionLibrary.h\n\n\u30d8\u30c3\u30c0\u30d5\u30a1\u30a4\u30eb\u306f[UE4\u306eC++\u304b\u3089Android API\u3092\u547c\u3093\u3067\u307f\u305f](http://qiita.com/shiena/items/7b9d0de97a733b1a5101)\u3068\u540c\u3058\u3067\u3059\u3002\n\n```cpp:Source/CppTest/UMyBlueprintFunctionLibrary.h\n// Fill out your copyright notice in the Description page of Project Settings.\n\n#pragma once\n\n#include \"Kismet/BlueprintFunctionLibrary.h\"\n#include \"MyBlueprintFunctionLibrary.generated.h\"\n\n/**\n * \n */\nUCLASS()\nclass CPPTEST_API UMyBlueprintFunctionLibrary : public UBlueprintFunctionLibrary\n{\n    GENERATED_BODY()\n\npublic:\n    UFUNCTION(BlueprintPure, Category = \"MyBPLibrary\")\n    static FString GetPicturesPath();\n\nprivate:\n    static FString GetPicturesPathJNI();\n};\n```\n\n## UMyBlueprintFunctionLibrary.cpp\n\n\u3084\u3063\u3068C++\u306e\u672c\u4f53\u3067\u3059\u3002\n\u4ee5\u524d\u306fJava\u5074\u306e\u8907\u6570\u306e\u30af\u30e9\u30b9\u3084\u30e1\u30f3\u30d0\u30fc\u5909\u6570\u3092\u53c2\u7167\u3057\u3066\u3044\u307e\u3057\u305f\u304c\u3001\u4eca\u56de\u306f\u8ffd\u52a0\u3057\u305f\u30e1\u30bd\u30c3\u30c91\u3064\u3060\u3051\u306b\u306a\u3063\u305f\u306e\u3067\u5e7e\u5206\u304b\u697d\u306b\u306a\u308a\u307e\u3057\u305f\u3002\nJava\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u5bfe\u3057\u3066\u30e1\u30bd\u30c3\u30c9\u3092\u547c\u3073\u305f\u3044\u5834\u5408\u306f\u3053\u308c\u304c\u9650\u754c\u3060\u3068\u601d\u3044\u307e\u3059\u3002\n\n```cpp:Source/CppTest/UMyBlueprintFunctionLibrary.cpp\n// Fill out your copyright notice in the Description page of Project Settings.\n\n#include \"CppTest.h\"\n#include \"MyBlueprintFunctionLibrary.h\"\n\n#if PLATFORM_ANDROID\n#include \"Android/AndroidApplication.h\"\n#endif\n\nFString UMyBlueprintFunctionLibrary::GetPicturesPath()\n{\n    static FString PicturesPath = UMyBlueprintFunctionLibrary::GetPicturesPath();\n    return PicturesPath;\n}\n\nFString UMyBlueprintFunctionLibrary::GetPicturesPathJNI()\n{\n    FString result;\n#if PLATFORM_ANDROID\n    JNIEnv* Env = FAndroidApplication::GetJavaEnv();\n\n    if (nullptr != Env)\n    {\n\t\tjclass GameActivity = FAndroidApplication::GetGameActivityThis();\n        jmethodID getPicturesPathMethod = Env->GetStaticMethodID(GameCls, \"AndroidThunkJava_GetPicturesPath\", \"()Ljava/lang/String;\");\n\n        jstring pathString = (jstring)Env->CallObjectMethod(GameActivity, getPicturesPathMethod, nullptr);\n        Env->DeleteLocalRef(getPicturesPathMethod);\n\n        const char *nativePathString = Env->GetStringUTFChars(pathString, 0);\n        result = FString(nativePathString);\n\n        Env->ReleaseStringUTFChars(pathString, nativePathString);\n        Env->DeleteLocalRef(pathString);\n    }\n    else\n    {\n#endif\n        result = FString(\"\");\n#if PLATFORM_ANDROID\n    }\n#endif\n\n    return result;\n}\n```\n\n# GameActivity.java\u304b\u3089\u30cd\u30a4\u30c6\u30a3\u30d6\u30e1\u30bd\u30c3\u30c9\u3092\u547c\u3073\u51fa\u3059\n\n\u4eca\u5ea6\u306f\u30b2\u30fc\u30e0\u8d77\u52d5\u5f8c\u3001\u5909\u66f4\u3055\u308c\u306a\u3044\u5024\u3092C++\u5074\u3067\u53d7\u3051\u53d6\u308b\u5834\u5408\u3092\u89e3\u8aac\u3057\u307e\u3059\u3002\n\n## CppTest.Build.cs\n\n`Source/CppTest/CppTest.Build.cs`\u306f\u540c\u3058\u306a\u306e\u3067\u5272\u611b\u3057\u307e\u3059\u3002\n\n## CppTest_UPL.xml\n\n\u4eca\u5ea6\u306f\u30cd\u30a4\u30c6\u30a3\u30d6\u30e1\u30bd\u30c3\u30c9`nativeSetPicturesPath()`\u3092\u5b9a\u7fa9\u3057\u3066\u3001Android\u306e`onCreate()`\u30e1\u30bd\u30c3\u30c9\u306e\u4e2d\u3067Pictures\u30d5\u30a9\u30eb\u30c0\u306e\u30d1\u30b9\u3092\u6e21\u3057\u307e\u3059\u3002\n\n```xml:Source/CppTest/CppTest_UPL.xml\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n\n<root xmlns:android=\"http://schemas.android.com/apk/res/android\">\n\n  <init>\n    <!-- APK\u4f5c\u6210\u6642\u306b\u30ed\u30b0\u3092\u51fa\u529b\u3059\u308b -->\n    <log text=\"CppTest init\"/>\n  </init>\n\n  <!-- APK\u4f5c\u6210\u6642\u306b\u30ed\u30b0\u51fa\u529b\u3092\u6709\u52b9\u306b\u3059\u308b -->\n  <trace enable=\"true\"/>\n\n  <gameActivityImportAdditions>\n    <insert>\n      import android.os.Environment;\n    </insert>\n  </gameActivityImportAdditions>\n\n  <gameActivityClassAdditions>\n    <insert>\n      public native void nativeSetPicturesPath(String PicturesPath);\n    </insert>\n  </gameActivityClassAdditions>\n\n  <gameActivityReadMetadataAdditions>\n    <insert>\n      File f = Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_PICTURES);\n      nativeSetPicturesPath(f.getPath());\n    </insert>\n  </gameActivityReadMetadataAdditions>\n\n</root>\n```\n\n## UMyBlueprintFunctionLibrary.h\n\nJava\u306e\u30cd\u30a4\u30c6\u30a3\u30d6\u30e1\u30bd\u30c3\u30c9\u306e\u5f15\u6570\u3067Pictures\u30d5\u30a9\u30eb\u30c0\u306e\u30d1\u30b9\u304c\u6e21\u3055\u308c\u308b\u306e\u3067\u305d\u308c\u3092\u4fdd\u5b58\u3059\u308b\u305f\u3081\u306e\u5909\u6570`PicturesPath`\u3092\u8ffd\u52a0\u3057\u3066\u3001JNI\u95a2\u6570\u3092\u4f7f\u308f\u306a\u304f\u306a\u3063\u305f\u306e\u3067`GetPicturesPathJNI`\u95a2\u6570\u3092\u524a\u9664\u3057\u3066\u3044\u307e\u3059\u3002\n\n```cpp:Source/CppTest/UMyBlueprintFunctionLibrary.h\n// Fill out your copyright notice in the Description page of Project Settings.\n\n#pragma once\n\n#include \"Kismet/BlueprintFunctionLibrary.h\"\n#include \"MyBlueprintFunctionLibrary.generated.h\"\n\n/**\n * \n */\nUCLASS()\nclass CPPTEST_API UMyBlueprintFunctionLibrary : public UBlueprintFunctionLibrary\n{\n    GENERATED_BODY()\n\npublic:\n    static FString PicturesPath;\n\n    UFUNCTION(BlueprintPure, Category = \"MyBPLibrary\")\n    static FString GetPicturesPath();\n};\n```\n\n## UMyBlueprintFunctionLibrary.cpp\n\nC++\u306e\u672c\u4f53\u306f`PicturesPath`\u306egetter\u95a2\u6570\u3068Java\u3067\u5ba3\u8a00\u3057\u305f\u30cd\u30a4\u30c6\u30a3\u30d6\u30e1\u30bd\u30c3\u30c9\u306e\u5b9f\u88c5\u3060\u3051\u306b\u306a\u308a\u3001\u6700\u521d\u3068\u6bd4\u3079\u308b\u3068\u968f\u5206\u3068\u77ed\u304f\u306a\u308a\u307e\u3057\u305f\u3002\n\n```cpp:Source/CppTest/UMyBlueprintFunctionLibrary.cpp\n// Fill out your copyright notice in the Description page of Project Settings.\n\n#include \"CppTest.h\"\n#include \"MyBlueprintFunctionLibrary.h\"\n\n#if PLATFORM_ANDROID\n#include \"Android/AndroidApplication.h\"\n#endif\n\nFString UMyBlueprintFunctionLibrary::PicturesPath;\n\nFString UMyBlueprintFunctionLibrary::GetPicturesPath()\n{\n    return UMyBlueprintFunctionLibrary::PicturesPath;\n}\n\n#if PLATFORM_ANDROID\nextern \"C\"\n{\n    JNIEXPORT void JNICALL Java_com_epicgames_ue4_GameActivity_nativeSetPicturesPath(JNIEnv* jenv, jobject thiz, jstring picturesPath)\n    {\n        const char* javaChars = jenv->GetStringUTFChars(picturesPath, 0);\n\n        UMyBlueprintFunctionLibrary::PicturesPath = FString(UTF8_TO_TCHAR(javaChars));\n\n        //Release the string\n        jenv->ReleaseStringUTFChars(picturesPath, javaChars);\n    }\n}\n#endif\n```\n\n# \u307e\u3068\u3081\n\nUPL\u3092\u4f7f\u3063\u3066\u3001Android API\u547c\u3073\u51fa\u3057\u306e\u3064\u3089\u3055\u3092\u8efd\u6e1b\u3067\u304d\u307e\u3057\u305f\uff01\nAndroid NDK\u306b\u3082\u8272\u3005\u3068\u95a2\u6570\u304c\u7528\u610f\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u308f\u3056\u308f\u3056Android API\u3092\u547c\u3076\u6a5f\u4f1a\u306f\u307b\u3068\u3093\u3069\u306a\u3044\u3068\u601d\u3044\u307e\u3059\u304c\u3001\u8ab0\u304b\u306e\u52a9\u3051\u306b\u306a\u308c\u3070\u3088\u3044\u304b\u3068\u601d\u3044\u307e\u3059\u3002\n"}