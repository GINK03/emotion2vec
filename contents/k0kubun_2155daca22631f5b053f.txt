{"tags": ["Ruby", "itamae", "Conoha"], "context": " More than 1 year has passed since last update.\n\n\u76ee\u6a19\n\u4ee5\u4e0b\u306e\u4f5c\u696d\u3092itamae\u30ec\u30b7\u30d4\u306b\u3057\u3066\u81ea\u52d5\u5316\u3059\u308b\u3053\u3068\u3092\u76ee\u6a19\u3068\u3059\u308b\u3002\n\n\u4e00\u822c\u30e6\u30fc\u30b6\u30fc\u306e\u4f5c\u6210\n\u9375\u8a8d\u8a3c\u306e\u8a2d\u5b9a\nsudo\u6709\u52b9\u5316\nssh\u3068iptables\u306e\u8a2d\u5b9a\n\n\n\u4e0b\u6e96\u5099\n\n\u30d1\u30b9\u30ef\u30fc\u30c9\u6e96\u5099\n\u30ec\u30b7\u30d4\u306b\u306f\u30d1\u30b9\u30ef\u30fc\u30c9\u3092SHA512\u3067\u6697\u53f7\u5316\u3057\u305f\u3082\u306e\u3092\u3044\u308c\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u304c\u3001\u4f8b\u3048\u3070\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u751f\u6210\u3067\u304d\u308b\u3002\n$ gem install unix-crypt\n$ mkunixcrypt -s \"salt\"\nEnter password:\nVerify password:\n$6$salt$...\n\n\nroot\u3067ssh\u3067\u304d\u308b\u304b\u78ba\u8a8d\n\u300c\u30b5\u30fc\u30d0\u30fc\u30ea\u30b9\u30c8 > \u30b3\u30f3\u30bd\u30fc\u30eb\u300d\u304b\u3089\u79d8\u5bc6\u9375\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3001\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u3092600\u306b\u3057\u3066\u304a\u304f\u3002\nroot\u3067\u300c\u30b5\u30fc\u30d0\u30fc\u30ea\u30b9\u30c8 > DNS\u9006\u5f15\u304d\u8a2d\u5b9a\u300d\u306eIP\u30a2\u30c9\u30ec\u30b9\u306b\u305d\u306e\u9375\u3067ssh\u3067\u304d\u308b\u3053\u3068\u3092\u78ba\u304b\u3081\u3066\u304a\u304f\u3002\n\u79d8\u5bc6\u9375\u3092\u4eee\u306b~/.ssh/id_rsa.conoha\u306b\u304a\u3044\u305f\u3068\u3059\u308b\u3068\u3001\u4ee5\u964d\u3001\u4e00\u822c\u30e6\u30fc\u30b6\u30fc\u3067ssh\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u307e\u3067\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u30ec\u30b7\u30d4\u3092\u5b9f\u884c\u3059\u308b\u524d\u63d0\u3067\u66f8\u304f\u3002\n$ gem install itamae\n$ itamae ssh recipe.rb -h [IP\u30a2\u30c9\u30ec\u30b9] -u root -i ~/.ssh/id_rsa.conoha\n\n\u6700\u521d\u306f1\u3064\u306e\u30ec\u30b7\u30d4\u306b\u5168\u90e8\u66f8\u3044\u3066\u3001\u5f8c\u3067\u5206\u5272\u3059\u308c\u3070\u3044\u3044\u3068\u601d\u3046\u3002\n\n\u4e00\u822c\u30e6\u30fc\u30b6\u30fc\u306e\u4f5c\u6210\n\ntemplates/sudoers\n\u5143\u3005/etc/sudoers \u306b\u3042\u308b\u3084\u3064\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u66f4\u3057\u305f\u3082\u306e\u3092\u3001templates\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3068\u304b\u3092\u4f5c\u3063\u3066\u914d\u7f6e\u3057\u3066\u304a\u304f\n## Allows people in group wheel to run all commands\n-# %wheel   ALL=(ALL)   ALL\n+%wheel ALL=(ALL)   ALL\n\n\n\u30ec\u30b7\u30d4\nUSER_NAME = \"k0kubun\"     # \u5909\u66f4\u3059\u308b\nSSH_KEY   = \"ssh-rsa ...\" # \u5909\u66f4\u3059\u308b\nWHEEL_GID = \"10\"\n\nuser USER_NAME do\n  password \"$6$...$...\" # \u524d\u306e\u7bc0\u3067mkunixcrypt\u3067\u751f\u6210\u3057\u305f\u3084\u3064\nend\n\n# \u4e00\u65e6\u2191\u306e\u30d6\u30ed\u30c3\u30af\u3067\u4e00\u822c\u30e6\u30fc\u30b6\u30fc\u306egroup\u3092\u4f5c\u3063\u3066\u304b\u3089wheel\u306b\u5165\u308c\u308b\nuser USER_NAME do\n  gid WHEEL_GID\nend\n\ndirectory \"/home/#{USER_NAME}/.ssh\" do\n  owner USER_NAME\n  group USER_NAME\n  mode  \"700\"\nend\n\n# \u516c\u958b\u9375\u3067ssh\u53ef\u80fd\u306b\u3059\u308b\nfile \"/home/#{USER_NAME}/.ssh/authorized_keys\" do\n  content SSH_KEY\n  owner USER_NAME\n  group USER_NAME\n  mode  \"600\"\nend\n\n# sudo\u53ef\u80fd\u306b\u3059\u308b\ntemplate \"/etc/sudoers\" do\n  source \"templates/sudoers\"\n  mode   \"440\"\n  owner  \"root\"\n  group  \"root\"\nend\n\n\u3053\u308c\u3067\u4e00\u822c\u30e6\u30fc\u30b6\u30fc\u306b\u516c\u958b\u9375\u3067ssh\u53ef\u80fd\u304b\u3064sudo\u53ef\u80fd\u306b\u306a\u3063\u305f\u3002\n\nssh\u3068iptables\u306e\u8a2d\u5b9a\n\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u5909\u66f4\u3092\u52a0\u3048\u305fsshd_config\u3068iptables\u3092\u7528\u610f\u3057\u3066\u304a\u304f\u3002\n\ntemplates/sshd_config\n\nroot\u30ed\u30b0\u30a4\u30f3\u7121\u52b9\u5316\n\u30d1\u30b9\u30ef\u30fc\u30c9\u30ed\u30b0\u30a4\u30f3\u7121\u52b9\u5316\nssh\u7528\u30dd\u30fc\u30c8\u309222\u756a\u304b\u3089\u5909\u66f4\n\n\ntemplates/iplables\n\nssh\u7528\u306b\u958b\u3044\u3066\u3044\u308b22\u756a\u3092\u5225\u306e\u30dd\u30fc\u30c8\u306b\u5909\u66f4\nHTTP 80\u756a\u306e\u30dd\u30fc\u30c8\u3092\u958b\u3051\u308b\nHTTPS 443\u756a\u306e\u30dd\u30fc\u30c8\u3092\u958b\u3051\u308b\n\n\n\u30ec\u30b7\u30d4\ntemplate \"sshd_config\" do\n  path   \"/etc/ssh/sshd_config\"\n  source \"templates/sshd_config\"\n  mode   \"600\"\nend\n\n# sshd_config\u306b\u5909\u66f4\u304c\u3042\u3063\u305f\u3089\u518d\u8d77\u52d5\nservice \"sshd\" do\n  subscribes :restart, \"template[sshd_config]\"\nend\n\ntemplate \"iptables\" do\n  path   \"/etc/sysconfig/iptables\"\n  source \"templates/iptables\"\n  mode   \"600\"\nend\n\n# iptables\u306b\u5909\u66f4\u304c\u3042\u3063\u305f\u3089\u518d\u8d77\u52d5\nservice \"iptables\" do\n  subscribes :restart, \"template[iptables]\"\nend\n\n\u3053\u308c\u3067\u6700\u4f4e\u9650\u306e\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u5bfe\u7b56\u304c\u3067\u304d\u305f\u3002\n\n\u304a\u308f\u308a\n\u3053\u306e\u3088\u3046\u306bitamae\u3092\u4f7f\u3046\u3068\u7c21\u5358\u306bVPS\u306e\u521d\u671f\u8a2d\u5b9a\u3092\u81ea\u52d5\u5316\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n# \u76ee\u6a19\n\n\u4ee5\u4e0b\u306e\u4f5c\u696d\u3092itamae\u30ec\u30b7\u30d4\u306b\u3057\u3066\u81ea\u52d5\u5316\u3059\u308b\u3053\u3068\u3092\u76ee\u6a19\u3068\u3059\u308b\u3002\n\n- \u4e00\u822c\u30e6\u30fc\u30b6\u30fc\u306e\u4f5c\u6210\n- \u9375\u8a8d\u8a3c\u306e\u8a2d\u5b9a\n- sudo\u6709\u52b9\u5316\n- ssh\u3068iptables\u306e\u8a2d\u5b9a\n\n# \u4e0b\u6e96\u5099\n\n## \u30d1\u30b9\u30ef\u30fc\u30c9\u6e96\u5099\n\n\u30ec\u30b7\u30d4\u306b\u306f\u30d1\u30b9\u30ef\u30fc\u30c9\u3092SHA512\u3067\u6697\u53f7\u5316\u3057\u305f\u3082\u306e\u3092\u3044\u308c\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u304c\u3001\u4f8b\u3048\u3070\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u751f\u6210\u3067\u304d\u308b\u3002\n\n```bash\n$ gem install unix-crypt\n$ mkunixcrypt -s \"salt\"\nEnter password:\nVerify password:\n$6$salt$...\n```\n\n## root\u3067ssh\u3067\u304d\u308b\u304b\u78ba\u8a8d\n\u300c\u30b5\u30fc\u30d0\u30fc\u30ea\u30b9\u30c8 > \u30b3\u30f3\u30bd\u30fc\u30eb\u300d\u304b\u3089\u79d8\u5bc6\u9375\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3001\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u3092600\u306b\u3057\u3066\u304a\u304f\u3002\nroot\u3067\u300c\u30b5\u30fc\u30d0\u30fc\u30ea\u30b9\u30c8 > DNS\u9006\u5f15\u304d\u8a2d\u5b9a\u300d\u306eIP\u30a2\u30c9\u30ec\u30b9\u306b\u305d\u306e\u9375\u3067ssh\u3067\u304d\u308b\u3053\u3068\u3092\u78ba\u304b\u3081\u3066\u304a\u304f\u3002\n\n\u79d8\u5bc6\u9375\u3092\u4eee\u306b`~/.ssh/id_rsa.conoha`\u306b\u304a\u3044\u305f\u3068\u3059\u308b\u3068\u3001\u4ee5\u964d\u3001\u4e00\u822c\u30e6\u30fc\u30b6\u30fc\u3067ssh\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u307e\u3067\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u30ec\u30b7\u30d4\u3092\u5b9f\u884c\u3059\u308b\u524d\u63d0\u3067\u66f8\u304f\u3002\n\n```bash\n$ gem install itamae\n$ itamae ssh recipe.rb -h [IP\u30a2\u30c9\u30ec\u30b9] -u root -i ~/.ssh/id_rsa.conoha\n```\n\n\u6700\u521d\u306f1\u3064\u306e\u30ec\u30b7\u30d4\u306b\u5168\u90e8\u66f8\u3044\u3066\u3001\u5f8c\u3067\u5206\u5272\u3059\u308c\u3070\u3044\u3044\u3068\u601d\u3046\u3002\n\n# \u4e00\u822c\u30e6\u30fc\u30b6\u30fc\u306e\u4f5c\u6210\n\n## templates/sudoers\n\n\u5143\u3005/etc/sudoers \u306b\u3042\u308b\u3084\u3064\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u66f4\u3057\u305f\u3082\u306e\u3092\u3001templates\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3068\u304b\u3092\u4f5c\u3063\u3066\u914d\u7f6e\u3057\u3066\u304a\u304f\n\n```diff\n## Allows people in group wheel to run all commands\n-# %wheel\tALL=(ALL)\tALL\n+%wheel\tALL=(ALL)\tALL\n```\n\n## \u30ec\u30b7\u30d4\n\n```ruby\nUSER_NAME = \"k0kubun\"     # \u5909\u66f4\u3059\u308b\nSSH_KEY   = \"ssh-rsa ...\" # \u5909\u66f4\u3059\u308b\nWHEEL_GID = \"10\"\n\nuser USER_NAME do\n  password \"$6$...$...\" # \u524d\u306e\u7bc0\u3067mkunixcrypt\u3067\u751f\u6210\u3057\u305f\u3084\u3064\nend\n\n# \u4e00\u65e6\u2191\u306e\u30d6\u30ed\u30c3\u30af\u3067\u4e00\u822c\u30e6\u30fc\u30b6\u30fc\u306egroup\u3092\u4f5c\u3063\u3066\u304b\u3089wheel\u306b\u5165\u308c\u308b\nuser USER_NAME do\n  gid WHEEL_GID\nend\n\ndirectory \"/home/#{USER_NAME}/.ssh\" do\n  owner USER_NAME\n  group USER_NAME\n  mode  \"700\"\nend\n\n# \u516c\u958b\u9375\u3067ssh\u53ef\u80fd\u306b\u3059\u308b\nfile \"/home/#{USER_NAME}/.ssh/authorized_keys\" do\n  content SSH_KEY\n  owner USER_NAME\n  group USER_NAME\n  mode  \"600\"\nend\n\n# sudo\u53ef\u80fd\u306b\u3059\u308b\ntemplate \"/etc/sudoers\" do\n  source \"templates/sudoers\"\n  mode   \"440\"\n  owner  \"root\"\n  group  \"root\"\nend\n```\n\n\u3053\u308c\u3067\u4e00\u822c\u30e6\u30fc\u30b6\u30fc\u306b\u516c\u958b\u9375\u3067ssh\u53ef\u80fd\u304b\u3064sudo\u53ef\u80fd\u306b\u306a\u3063\u305f\u3002\n\n# ssh\u3068iptables\u306e\u8a2d\u5b9a\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u5909\u66f4\u3092\u52a0\u3048\u305fsshd\\_config\u3068iptables\u3092\u7528\u610f\u3057\u3066\u304a\u304f\u3002\n\n## templates/sshd\\_config\n\n- root\u30ed\u30b0\u30a4\u30f3\u7121\u52b9\u5316\n- \u30d1\u30b9\u30ef\u30fc\u30c9\u30ed\u30b0\u30a4\u30f3\u7121\u52b9\u5316\n- ssh\u7528\u30dd\u30fc\u30c8\u309222\u756a\u304b\u3089\u5909\u66f4\n\n## templates/iplables\n\n- ssh\u7528\u306b\u958b\u3044\u3066\u3044\u308b22\u756a\u3092\u5225\u306e\u30dd\u30fc\u30c8\u306b\u5909\u66f4\n- HTTP 80\u756a\u306e\u30dd\u30fc\u30c8\u3092\u958b\u3051\u308b\n- HTTPS 443\u756a\u306e\u30dd\u30fc\u30c8\u3092\u958b\u3051\u308b\n\n## \u30ec\u30b7\u30d4\n\n```ruby\ntemplate \"sshd_config\" do\n  path   \"/etc/ssh/sshd_config\"\n  source \"templates/sshd_config\"\n  mode   \"600\"\nend\n\n# sshd_config\u306b\u5909\u66f4\u304c\u3042\u3063\u305f\u3089\u518d\u8d77\u52d5\nservice \"sshd\" do\n  subscribes :restart, \"template[sshd_config]\"\nend\n\ntemplate \"iptables\" do\n  path   \"/etc/sysconfig/iptables\"\n  source \"templates/iptables\"\n  mode   \"600\"\nend\n\n# iptables\u306b\u5909\u66f4\u304c\u3042\u3063\u305f\u3089\u518d\u8d77\u52d5\nservice \"iptables\" do\n  subscribes :restart, \"template[iptables]\"\nend\n```\n\n\u3053\u308c\u3067\u6700\u4f4e\u9650\u306e\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u5bfe\u7b56\u304c\u3067\u304d\u305f\u3002\n\n# \u304a\u308f\u308a\n\n\u3053\u306e\u3088\u3046\u306bitamae\u3092\u4f7f\u3046\u3068\u7c21\u5358\u306bVPS\u306e\u521d\u671f\u8a2d\u5b9a\u3092\u81ea\u52d5\u5316\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n"}