{"tags": ["fluentd", "Elasticsearch", "Rails"], "context": " More than 1 year has passed since last update.\u30ed\u30b0\u306f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u958b\u767a\u4e2d\u306f\u3082\u3061\u308d\u3093\u3001\u904b\u7528\u3067\u3082\u3068\u3066\u3082\u5927\u5207\u306a\u60c5\u5831\u3067\u3059\u3002\nRails \u306e\u6a19\u6e96\u6a5f\u80fd\u306e\u30ed\u30ae\u30f3\u30b0\u3067\u306f\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u3084\u30a8\u30e9\u30fc\u30ed\u30b0\u306a\u3069\u69d8\u3005\u306a\u60c5\u5831\u304c\u6df7\u5728\u3057\u3066\u3044\u307e\u3059\u3002\n\u30ed\u30b0\u306f\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u30fb\u696d\u52d9\u30ed\u30b0\u3084\u6b63\u5e38\u7cfb\u30fb\u7570\u5e38\u7cfb\u306a\u3069\u95a2\u5fc3\u4e8b\u3092\u5206\u96e2\u3057\u3066\u8a2d\u8a08\u3059\u308b\u3053\u3068\u304c\u5927\u5207\u3067\u3059\u3002\n\u4eca\u56de\u306f\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u306b\u6ce8\u76ee\u3057\u305f\u30ed\u30b0\u306e\u5165\u9580\u7de8\u3068\u3057\u3066\u30b5\u30f3\u30d7\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3057\u305f\u3002\nRails \u306f\u30b9\u30b1\u30fc\u30eb\u30a2\u30a6\u30c8\u3092\u69cb\u6210\u3059\u308b\u3053\u3068\u304c\u3042\u308b\u306e\u3067\u30ed\u30b0\u306f Fluentd \u3067\u96c6\u3081\u3066\n\u5168\u6587\u691c\u7d22\u6a5f\u80fd\u304c\u3042\u308b Elasticsearch \u306a\u3069\u306b\u767b\u9332\u3059\u308b\u3068\u3088\u3044\u3067\u3059\u306d\u3002\n\nEnvironment\n\nRuby: v2.2.3\nRails: v4.2.5\nElasticsearch: v2.1.1\nFluentd: v0.12.16\n\n\nSimple Authentication\n\u307e\u305a\u3001\u30ed\u30b0\u306e\u30b5\u30f3\u30d7\u30eb\u306b\u5358\u7d14\u306a\u8a8d\u8a3c\u306eWab\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u4f5c\u308a\u307e\u3059\u3002\n\nSetup\n\n\nrails new \u306e\u30b3\u30de\u30f3\u30c9\u3067Wab\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u3092\u69cb\u7bc9\u3057\u307e\u3059\u3002\n\n$ rails new rails-lograge-example\n$ cd rails-lograge-example/\n\n\n\nseeds.rb \u306b\u30b5\u30f3\u30d7\u30eb\u30c7\u30fc\u30bf\u3092\u6e96\u5099\u3057\u307e\u3059\u3002\n\n\ndb/seeds.rb\nUser.create_with(username: :foo).find_or_create_by(username: :foo)\nUser.create_with(username: :bar).find_or_create_by(username: :bar)\n\n\n\n\nrails generate \u306e\u30b3\u30de\u30f3\u30c9\u3067\u30b5\u30a4\u30f3\u30a4\u30f3\u306e controller \u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n$ rails generate controller user/session show new\n$ rails generate model user username\n$ rake db:migrate\n$ rake db:seed\n\n\nMaking\n\n\nroutes.rb \u306b\u30b5\u30a4\u30f3\u30a4\u30f3\u306e\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n\nconfig/routes.rb\nRails.application.routes.draw do\n  namespace :user do\n    get    :sign_in,  to: 'session#new'\n    post   :sign_in,  to: 'session#create'\n    delete :sign_out, to: 'session#destroy'\n  end\n\n  root 'user/session#show'\nend\n\n\n\n\napplication_controller.rb \u306b\u8a8d\u8a3c\u306e\u51e6\u7406\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n\napp/controllers/application_controller.rb\nclass ApplicationController < ActionController::Base\n  protect_from_forgery with: :exception\n  helper_method :current_user\n  before_action :authenticate\n\n  def current_user\n    if session[:user_id].present?\n      @current_user ||= User.find(session[:user_id])\n    end\n  end\n\n  def append_info_to_payload(payload)\n    super\n    payload[:host] = request.host\n    payload[:username] = current_user.try(:username)\n  end\n\n  private\n    def authenticate\n      if current_user.blank?\n        session.delete :user_id\n        redirect_to user_sign_in_path\n      end\n    end\nend\n\n\n\n\nsession_controller.rb \u306b\u3082\u8a8d\u8a3c\u306e\u51e6\u7406\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n\napp/controllers/user/session_controller.rb\nclass User::SessionController < ApplicationController\n  skip_before_action :authenticate, except: :show\n\n  def show\n  end\n\n  def new\n  end\n\n  def create\n    user = User.find_by(user_params)\n    if user.present?\n      session[:user_id] = user.id\n      redirect_to root_path\n    else\n      render :new\n    end\n  end\n\n  def destroy\n    session.delete :user_id\n    redirect_to root_path\n  end\n\n  private\n    def user_params\n      params.permit(:username)\n    end\nend\n\n\n\n\nnew.html.erb \u306b\u8a8d\u8a3c\u306e\u30d5\u30a9\u30fc\u30e0\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n\napp/views/user/session/new.html.erb\n<h1>Please sign in</h1>\n<%= form_tag user_sign_in_path do %>\n<dl>\n  <dt><strong>Username:</strong></dt>\n  <dd><%= text_field_tag :username %></dd>\n</dl>\n<%= submit_tag 'Sign in' %>\n<% end %>\n\n\n\n\nshow.html.erb \u306b\u30d7\u30ed\u30d5\u30a3\u30fc\u30eb\u306e\u8868\u793a\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n\napp/views/user/session/show.html.erb\n<h1>Profile</h1>\n<dl>\n  <dt><strong>Username:</strong></dt>\n  <dd><%= current_user.username %></dd>\n</dl>\n<%= button_to 'Sign out', user_sign_out_path, method: :delete %>\n\n\n\nRun\n\n\nrails server \u306e\u30b3\u30de\u30f3\u30c9\u3067Wab\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u8d77\u52d5\u3057\u307e\u3059\u3002\n\nhttp://localhost:3000/ \u306b\u30a2\u30af\u30bb\u30b9\u3092\u3057\u3066\u3001foo \u3092\u5165\u529b\u3057\u3066\u30b5\u30a4\u30f3\u3057\u307e\u3059\u3002\n\n$ rails server\n\n\u30b5\u30a4\u30f3\u30a4\u30f3\u304c\u6210\u529f\u3059\u308b\u3068...\n\n\u30d7\u30ed\u30d5\u30a3\u30fc\u30eb\u304c\u8868\u793a\u3055\u308c\u307e\u3059\u3002\n\n\n\ndevelopment.log \u306b\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u304c\u51fa\u529b\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n\n\u76f4\u611f\u7684\u306b\u8aad\u307f\u53d6\u308c\u308b\u3088\u3046\u306b\u5de5\u592b\u3055\u308c\u3044\u307e\u3059\u304c...\n\n\n\n\nlog/development.log\nStarted GET \"/\" for ::1 at 2015-12-25 02:00:19 +0900\nProcessing by User::SessionController#show as HTML\n  Rendered user/session/show.html.erb within layouts/application (0.7ms)\nCompleted 200 OK in 63ms (Views: 50.7ms | ActiveRecord: 0.6ms)\n\n\n\nLogging by Lograge\n\u6b21\u306f\u3001\u6a19\u6e96\u306e\u30ed\u30b0\u306e\u51fa\u529b\u5185\u5bb9\u3067\u306f Elasticsearch \u306b\u767b\u9332\u3067\u304d\u306a\u3044\u306e\u3067\u8abf\u6574\u3057\u307e\u3059\u3002\n\nSetup\n\n\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u306e\u51fa\u529b\u306b\u306f Lograge \u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u5229\u7528\u3057\u307e\u3059\u3002\n\nElasticsearch \u306a\u306e\u3067 Logstash \u306e\u5f62\u5f0f\u306b\u3057\u307e\u3059\u3002\n\n$ echo \"gem 'lograge'\" >> Gemfile\n$ echo \"gem 'logstash-event'\" >> Gemfile\n$ bundle\n\n\nMaking\n\n\nlograge.rb \u306b Lograge \u306e\u30b3\u30f3\u30d5\u30a3\u30b0\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\u51fa\u529b\u5148\u3084\u66f8\u5f0f\u3092\u4efb\u610f\u306b\u5909\u66f4\u3067\u304d\u307e\u3059\u3002\u307e\u305f\u3001\u51fa\u529b\u9805\u76ee\u3092\u8ffd\u52a0\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n\nconfig/initializers/lograge.rb\nRails.application.configure do\n  path = \"#{Rails.root}/log/lograge_#{Rails.env}.log\"\n  config.lograge.logger = ActiveSupport::Logger.new path\n  config.lograge.enabled = true\n  config.lograge.keep_original_rails_log = true\n  config.lograge.formatter = Lograge::Formatters::Logstash.new\n\n  config.lograge.custom_options = lambda do |event|\n    {\n      host: event.payload[:host],\n      username: event.payload[:username],\n      time: event.time, timestamp: event.time\n    }\n  end\nend\n\n\n\nRun\n\n\nhttp://localhost:3000/ \u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068 Profile \u304c\u8868\u793a\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\nlograge_development.log \u306b\u305d\u306e\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u304c\u51fa\u529b\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n\nJSON \u306e\u5f62\u5f0f\u306b\u306a\u308a\u307e\u3057\u305f\u3002(JSON \u306f\u30c4\u30fc\u30eb\u3067\u6574\u5f62\u3057\u3066\u3044\u307e\u3059\u3002)\n\n\n\n\nlog/lograge_development.log\n{\n  \"method\":\"GET\",\n  \"path\":\"/\",\n  \"format\":\"html\",\n  \"controller\":\"user/session\",\n  \"action\":\"show\",\n  \"status\":200,\n  \"duration\":317.69,\n  \"view\":289.31,\n  \"db\":1.11,\n  \"host\":\"localhost\",\n  \"username\":\"foo\",\n  \"time\":\"2015-12-25T02:06:15.016+09:00\",\n  \"timestamp\":\"2015-12-25T02:06:15.016+09:00\",\n  \"@timestamp\":\"2015-12-24T17:06:15.334Z\",\n  \"@version\":\"1\",\n  \"message\":\"[200] GET / (user/session#show)\"\n}\n\n\n\nElasticsearch and Fluentd\n\u6700\u5f8c\u306f Fluentd \u3067 Lograge \u304c\u51fa\u529b\u3057\u305f\u30ed\u30b0\u3092 Elasticsearch \u306b\u767b\u9332\u3057\u307e\u3057\u3087\u3046\u3002\n\nSetup\n\n\nfluent.conf \u306e source \u306b Lograge \u306e\u8a2d\u5b9a\u3092 match \u306b Elasticsearch \u306e\u8a2d\u5b9a\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n\n\nElasticsearch \u306f \u30c7\u30d5\u30a9\u30eb\u30c8\u306e 127.0.0.1:9200 \u3067\u8d77\u52d5\u3057\u3066\u3044\u308b\u60f3\u5b9a\u3067\u3059\u3002\n\n\n\n\nconfig/fluent.conf\n<source>\n  type     tail\n  format   json\n  tag      lograge\n  path     ./log/lograge_development.log\n  pos_file ./log/lograge_development.log.pos\n  time_key time\n</source>\n\n<match lograge>\n  type elasticsearch\n  host 127.0.0.1\n  port 9200\n  logstash_format true\n  logstash_prefix lograge\n  flush_interval  1s\n</match>\n\n\n\n\nElasticsearch \u306f OS X \u3060\u3069 brew install \u30b3\u30de\u30f3\u30c9\u3067\u7c21\u5358\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3067\u304d\u307e\u3059\u3002\n\n$ brew install elasticsearch\n\n\n\nFluentd \u306f Gemfile \u306b\u8a18\u8ff0\u3059\u308b\u3068\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304c\u3067\u304d\u307e\u3059\u3002\n\n\n\nFluentd \u306f Ruby \u3067\u5b9f\u88c5\u3055\u308c\u3066\u3044\u307e\u3059\u3002(\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u5b8c\u5168\u89e3\u8aac)\n\n\n\n$ echo \"gem 'fluentd', require: false\" >> Gemfile\n$ echo \"gem 'fluent-plugin-elasticsearch', require: false\" >> Gemfile\n\n\n\nRails \u3068 Elasticsearch \u3068 Fluentd \u3092\u8d77\u52d5\u3059\u308b\u306e\u306b Foreman \u3092\u5229\u7528\u3057\u307e\u3059\u3002\n\n$ echo \"gem 'foreman', require: false\" >> Gemfile\n$ echo \"web: rails server\" >> Procfile\n$ echo \"es: elasticsearch\" >> Procfile\n$ echo \"td: bundle exec fluentd -c ./config/fluent.conf\" >> Procfile\n\n\nRun\n\n\nforeman start \u306e\u30b3\u30de\u30f3\u30c9\u3067\u5404\u7a2e\u3092\u8d77\u52d5\u3057\u307e\u3059\u3002\n\n$ bundle\n$ foreman start\n\n\nElasticsearch\nElasticsearch \u306b\u767b\u9332\u3055\u308c\u305f\u3089 API \u3067\u78ba\u8a8d\u3067\u304d\u308b\u306e\u3067\u3001\u3044\u304f\u3064\u304b\u7d39\u4ecb\u3057\u307e\u3059\u3002\n\nGET http://localhost:9200/_aliases?pretty \u306f\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u306e\u4e00\u89a7\u3092\u53c2\u7167\u3067\u304d\u307e\u3059\u3002\n\n{\n  \"lograge-2015.12.24\" : {\n    \"aliases\" : { }\n  }\n}\n\n\nGET http://localhost:9200/lograge*/_mapping?pretty \u306f\u9805\u76ee\u306e\u4e00\u89a7\u3092\u53c2\u7167\u3067\u304d\u307e\u3059\u3002\n\n{\n  \"lograge-2015.12.24\" : {\n    \"mappings\" : {\n      \"fluentd\" : {\n        \"properties\" : {\n          \"@timestamp\" : {\n            \"type\" : \"date\",\n            \"format\" : \"strict_date_optional_time||epoch_millis\"\n          },\n          \"@version\" : {\n            \"type\" : \"string\"\n          },\n          \"action\" : {\n            \"type\" : \"string\"\n          },\n          \"controller\" : {\n            \"type\" : \"string\"\n          },\n          \"db\" : {\n            \"type\" : \"double\"\n          },\n          \"duration\" : {\n            \"type\" : \"double\"\n          },\n          \"format\" : {\n            \"type\" : \"string\"\n          },\n          \"host\" : {\n            \"type\" : \"string\"\n          },\n          \"message\" : {\n            \"type\" : \"string\"\n          },\n          \"method\" : {\n            \"type\" : \"string\"\n          },\n          \"path\" : {\n            \"type\" : \"string\"\n          },\n          \"status\" : {\n            \"type\" : \"long\"\n          },\n          \"timestamp\" : {\n            \"type\" : \"date\",\n            \"format\" : \"strict_date_optional_time||epoch_millis\"\n          },\n          \"username\" : {\n            \"type\" : \"string\"\n          },\n          \"view\" : {\n            \"type\" : \"double\"\n          }\n        }\n      }\n    }\n  }\n}\n\n\nGET http://localhost:9200/lograge-*/_search?status=200&pretty \u306f\u691c\u7d22\u306e\u7d50\u679c\u3092\u53c2\u7167\u3067\u304d\u307e\u3059\u3002\n\n{\n  \"took\" : 10,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 5,\n    \"successful\" : 5,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : 1,\n    \"max_score\" : 1.0,\n    \"hits\" : [ {\n      \"_index\" : \"lograge-2015.12.24\",\n      \"_type\" : \"fluentd\",\n      \"_id\" : \"AVHU-kjPTuY2Nzr3aWVO\",\n      \"_score\" : 1.0,\n      \"_source\":{\"method\":\"GET\",\"path\":\"/\",\"format\":\"html\",\"controller\":\"user/session\",\"action\":\"show\",\"status\":200,\"duration\":316.39,\"view\":284.64,\"db\":1.12,\"host\":\"localhost\",\"username\":\"foo\",\"timestamp\":\"2015-12-25T02:12:30.224+09:00\",\"@timestamp\":\"2015-12-24T17:12:30.541Z\",\"@version\":\"1\",\"message\":\"[200] GET / (user/session#show)\"}\n    } ]\n  }\n}\n\n\nDELETE http://localhost:9200/lograge-* \u306f\u30c7\u30fc\u30bf\u3092\u524a\u9664\u3067\u304d\u307e\u3059\u3002\n\n\n\u5371\u967a\u306a API \u306e\u3067\u6271\u3044\u306b\u306f\u5341\u5206\u306b\u6ce8\u610f\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\n\n\nTips\n\nElasticsearch Client\nElasticsearch \u306e\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u306f Kibana \u304c\u3042\u308a\u307e\u3059\u304c Rails \u306b\u3082\u7c21\u5358\u306b\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3092\u5b9f\u88c5\u3067\u304d\u307e\u3059\u3002\n\nSetup\n\n\u4eca\u56de\u306f ActiveRecord \u306e\u30a4\u30f3\u30bf\u30d5\u30a7\u30fc\u30b9\u306b\u5408\u308f\u305b\u305f\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u5229\u7528\u3057\u307e\u3059\u3002\n\n$ echo \"gem 'elasticsearch-persistence'\" >> Gemfile\n$ bundle\n\n\n\nrails generate \u306e\u30b3\u30de\u30f3\u30c9\u3067 View \u3068 Controller \u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n$ rails generate controller logs index\n\n\nMaking\n\n\nroutes.rb \u306e logs \u306e\u30d1\u30b9\u3092\u7de8\u96c6\u3057\u307e\u3059\u3002\n\n\nconfig/routes.rb\nget :logs, to: 'logs#index'\n\n\n\n\nlogs_controller.rb \u306b message \u3067\u691c\u7d22\u3067\u304d\u308b\u3088\u3046\u306b\u51e6\u7406\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n\napp/controllers/logs_controller.rb\nclass LogsController < ApplicationController\n  def index\n    @message = params[:message] || \"\"\n    @logs = Elasticsearch::Lograge.search(query: {\n      match: {message: @message}\n    })\n  end\nend\n\n\n\n\nindex.html.erb \u306b\u691c\u7d22\u30d5\u30a9\u30fc\u30e0\u3068\u8868\u793a\u30a8\u30ea\u30a2\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n\napp/views/logs/index.html.erb\n<h1>Logs</h1>\n\n<%= form_tag logs_path, method: :get do %>\n<dl>\n  <dt><strong>message:</strong></dt>\n  <dd><%= text_field_tag :message, @message %></dd>\n</dl>\n<%= submit_tag 'Search' %>\n<% end %>\n\n<br/>\n\n<table border=\"1\">\n  <thead>\n    <tr>\n      <th>method</th>\n      <th>path</th>\n      <th>controller</th>\n      <th>action</th>\n      <th>status</th>\n      <th>username</th>\n      <th>message</th>\n      <th>timestamp</th>\n    </tr>\n  </thead>\n  <tbody>\n    <% @logs.each do |log| %>\n      <tr>\n        <td><%= log.method %></td>\n        <td><%= log.path %></td>\n        <td><%= log.controller %></td>\n        <td><%= log.action %></td>\n        <td><%= log.status %></td>\n        <td><%= log.username %></td>\n        <td><%= log.message %></td>\n        <td><%= log.timestamp %></td>\n      </tr>\n    <% end %>\n  </tbody>\n</table>\n\n\n\n\nlograge.rb \u306b\u53c2\u7167\u3059\u308b\u9805\u76ee\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n\n\nindex_name \u306b\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\ndocument_type \u306b\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\nattribute \u306b\u30de\u30c3\u30d4\u30f3\u30b0\u306e\u9805\u76ee\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n\n\n\napp/models/elasticsearch/lograge.rb\nrequire 'elasticsearch/persistence/model'\n\nmodule Elasticsearch\n  class Lograge\n    include Elasticsearch::Persistence::Model\n\n    index_name 'lograge*'\n    document_type 'fluentd'\n\n    attribute :method,      String\n    attribute :path,        String\n    attribute :format,      String\n    attribute :controller,  String\n    attribute :action,      String\n    attribute :status,      Integer\n    attribute :duration,    Float\n    attribute :view,        Float\n    attribute :db,          Float\n    attribute :username,    String\n    attribute :message,     String\n    attribute :timestamp,   Date\n  end\nend\n\n\n\n\nlograge.rb \u306b\u306f\u30ed\u30b0\u306b\u51fa\u529b\u3057\u306a\u3044\u30d1\u30b9\u3092\u8a18\u8ff0\u3067\u304d\u307e\u3059\u3002\n\n\nconfig/initializers/lograge.rb\nconfig.lograge.ignore_actions = %W(\n  user/session#new\n  logs#index\n)\n\n\n\nRun\n\u691c\u7d22\u306f\u5168\u6587\u691c\u7d22\u306a\u306e\u3067\u8abf\u67fb\u304c\u6357\u308a\u307e\u3059\u3002\n\n\u3044\u3064\uff08When\uff09\u3001\u3069\u3053\u3067\uff08Where\uff09\u3001\u3060\u308c\u304c\uff08Who\uff09\u3001\u306a\u306b\u3092\uff08What\uff09\u3092\u8ffd\u8de1\u3067\u304d\u308b\u6e96\u5099\u304c\u5b89\u5168\u306a\u958b\u767a\u3001\u5b89\u5fc3\u306a\u904b\u7528\u306b\u7e4b\u304c\u308a\u307e\u3059\u3002\nEnjoy Logging\n\n\u30ed\u30b0\u306f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u958b\u767a\u4e2d\u306f\u3082\u3061\u308d\u3093\u3001\u904b\u7528\u3067\u3082\u3068\u3066\u3082\u5927\u5207\u306a\u60c5\u5831\u3067\u3059\u3002\n[Rails](http://rubyonrails.org/) \u306e\u6a19\u6e96\u6a5f\u80fd\u306e\u30ed\u30ae\u30f3\u30b0\u3067\u306f\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u3084\u30a8\u30e9\u30fc\u30ed\u30b0\u306a\u3069\u69d8\u3005\u306a\u60c5\u5831\u304c\u6df7\u5728\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u30ed\u30b0\u306f\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u30fb\u696d\u52d9\u30ed\u30b0\u3084\u6b63\u5e38\u7cfb\u30fb\u7570\u5e38\u7cfb\u306a\u3069\u95a2\u5fc3\u4e8b\u3092\u5206\u96e2\u3057\u3066\u8a2d\u8a08\u3059\u308b\u3053\u3068\u304c\u5927\u5207\u3067\u3059\u3002\n\u4eca\u56de\u306f\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u306b\u6ce8\u76ee\u3057\u305f\u30ed\u30b0\u306e\u5165\u9580\u7de8\u3068\u3057\u3066[\u30b5\u30f3\u30d7\u30eb](https://github.com/dddrb/rails-lograge-example)\u3092\u4f5c\u6210\u3057\u307e\u3057\u305f\u3002\n\nRails \u306f\u30b9\u30b1\u30fc\u30eb\u30a2\u30a6\u30c8\u3092\u69cb\u6210\u3059\u308b\u3053\u3068\u304c\u3042\u308b\u306e\u3067\u30ed\u30b0\u306f [Fluentd](http://www.fluentd.org/) \u3067\u96c6\u3081\u3066\n\u5168\u6587\u691c\u7d22\u6a5f\u80fd\u304c\u3042\u308b [Elasticsearch](https://www.elastic.co/products/elasticsearch) \u306a\u3069\u306b\u767b\u9332\u3059\u308b\u3068\u3088\u3044\u3067\u3059\u306d\u3002\n\n## Environment\n\n* Ruby: v2.2.3\n* Rails: v4.2.5\n* Elasticsearch: v2.1.1\n* Fluentd: v0.12.16\n\n## Simple Authentication\n\n\u307e\u305a\u3001\u30ed\u30b0\u306e\u30b5\u30f3\u30d7\u30eb\u306b\u5358\u7d14\u306a\u8a8d\u8a3c\u306eWab\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u4f5c\u308a\u307e\u3059\u3002\n\n### Setup\n\n* `rails new` \u306e\u30b3\u30de\u30f3\u30c9\u3067Wab\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u3092\u69cb\u7bc9\u3057\u307e\u3059\u3002\n\n```bash\n$ rails new rails-lograge-example\n$ cd rails-lograge-example/\n```\n\n* `seeds.rb` \u306b\u30b5\u30f3\u30d7\u30eb\u30c7\u30fc\u30bf\u3092\u6e96\u5099\u3057\u307e\u3059\u3002\n\n```ruby:db/seeds.rb\nUser.create_with(username: :foo).find_or_create_by(username: :foo)\nUser.create_with(username: :bar).find_or_create_by(username: :bar)\n```\n\n* `rails generate` \u306e\u30b3\u30de\u30f3\u30c9\u3067\u30b5\u30a4\u30f3\u30a4\u30f3\u306e *controller* \u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```bash\n$ rails generate controller user/session show new\n$ rails generate model user username\n$ rake db:migrate\n$ rake db:seed\n```\n\n### Making\n\n* `routes.rb` \u306b\u30b5\u30a4\u30f3\u30a4\u30f3\u306e\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n```ruby:config/routes.rb\nRails.application.routes.draw do\n  namespace :user do\n    get    :sign_in,  to: 'session#new'\n    post   :sign_in,  to: 'session#create'\n    delete :sign_out, to: 'session#destroy'\n  end\n\n  root 'user/session#show'\nend\n```\n\n* `application_controller.rb` \u306b\u8a8d\u8a3c\u306e\u51e6\u7406\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n```ruby:app/controllers/application_controller.rb\nclass ApplicationController < ActionController::Base\n  protect_from_forgery with: :exception\n  helper_method :current_user\n  before_action :authenticate\n\n  def current_user\n    if session[:user_id].present?\n      @current_user ||= User.find(session[:user_id])\n    end\n  end\n\n  def append_info_to_payload(payload)\n    super\n    payload[:host] = request.host\n    payload[:username] = current_user.try(:username)\n  end\n\n  private\n    def authenticate\n      if current_user.blank?\n        session.delete :user_id\n        redirect_to user_sign_in_path\n      end\n    end\nend\n```\n\n* `session_controller.rb` \u306b\u3082\u8a8d\u8a3c\u306e\u51e6\u7406\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n```ruby:app/controllers/user/session_controller.rb\nclass User::SessionController < ApplicationController\n  skip_before_action :authenticate, except: :show\n\n  def show\n  end\n\n  def new\n  end\n\n  def create\n    user = User.find_by(user_params)\n    if user.present?\n      session[:user_id] = user.id\n      redirect_to root_path\n    else\n      render :new\n    end\n  end\n\n  def destroy\n    session.delete :user_id\n    redirect_to root_path\n  end\n\n  private\n    def user_params\n      params.permit(:username)\n    end\nend\n```\n\n* `new.html.erb` \u306b\u8a8d\u8a3c\u306e\u30d5\u30a9\u30fc\u30e0\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n```ruby:app/views/user/session/new.html.erb\n<h1>Please sign in</h1>\n<%= form_tag user_sign_in_path do %>\n<dl>\n  <dt><strong>Username:</strong></dt>\n  <dd><%= text_field_tag :username %></dd>\n</dl>\n<%= submit_tag 'Sign in' %>\n<% end %>\n```\n\n* `show.html.erb` \u306b\u30d7\u30ed\u30d5\u30a3\u30fc\u30eb\u306e\u8868\u793a\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n```ruby:app/views/user/session/show.html.erb\n<h1>Profile</h1>\n<dl>\n  <dt><strong>Username:</strong></dt>\n  <dd><%= current_user.username %></dd>\n</dl>\n<%= button_to 'Sign out', user_sign_out_path, method: :delete %>\n```\n\n### Run\n\n* `rails server` \u306e\u30b3\u30de\u30f3\u30c9\u3067Wab\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u8d77\u52d5\u3057\u307e\u3059\u3002\n* `http://localhost:3000/` \u306b\u30a2\u30af\u30bb\u30b9\u3092\u3057\u3066\u3001`foo` \u3092\u5165\u529b\u3057\u3066\u30b5\u30a4\u30f3\u3057\u307e\u3059\u3002\n\n```bash\n$ rails server\n```\n\n\u30b5\u30a4\u30f3\u30a4\u30f3\u304c\u6210\u529f\u3059\u308b\u3068...\n\n![sign_in](https://dl.dropboxusercontent.com/u/14690051/images/notes/lang/ruby/lograge/sign_in.png)\n\n\u30d7\u30ed\u30d5\u30a3\u30fc\u30eb\u304c\u8868\u793a\u3055\u308c\u307e\u3059\u3002\n\n![profile](https://dl.dropboxusercontent.com/u/14690051/images/notes/lang/ruby/lograge/profile.png)\n\n* `development.log` \u306b\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u304c\u51fa\u529b\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n    * \u76f4\u611f\u7684\u306b\u8aad\u307f\u53d6\u308c\u308b\u3088\u3046\u306b\u5de5\u592b\u3055\u308c\u3044\u307e\u3059\u304c...\n\n```text:log/development.log\nStarted GET \"/\" for ::1 at 2015-12-25 02:00:19 +0900\nProcessing by User::SessionController#show as HTML\n  Rendered user/session/show.html.erb within layouts/application (0.7ms)\nCompleted 200 OK in 63ms (Views: 50.7ms | ActiveRecord: 0.6ms)\n```\n\n\n## Logging by Lograge\n\n\u6b21\u306f\u3001\u6a19\u6e96\u306e\u30ed\u30b0\u306e\u51fa\u529b\u5185\u5bb9\u3067\u306f **Elasticsearch** \u306b\u767b\u9332\u3067\u304d\u306a\u3044\u306e\u3067\u8abf\u6574\u3057\u307e\u3059\u3002\n\n### Setup\n\n* \u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u306e\u51fa\u529b\u306b\u306f [Lograge](https://github.com/roidrage/lograge) \u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u5229\u7528\u3057\u307e\u3059\u3002\n* **Elasticsearch** \u306a\u306e\u3067 [Logstash](https://www.elastic.co/products/logstash) \u306e\u5f62\u5f0f\u306b\u3057\u307e\u3059\u3002\n\n```bash\n$ echo \"gem 'lograge'\" >> Gemfile\n$ echo \"gem 'logstash-event'\" >> Gemfile\n$ bundle\n```\n\n### Making\n\n* `lograge.rb` \u306b **Lograge** \u306e\u30b3\u30f3\u30d5\u30a3\u30b0\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n* \u51fa\u529b\u5148\u3084\u66f8\u5f0f\u3092\u4efb\u610f\u306b\u5909\u66f4\u3067\u304d\u307e\u3059\u3002\u307e\u305f\u3001\u51fa\u529b\u9805\u76ee\u3092\u8ffd\u52a0\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n```ruby:config/initializers/lograge.rb\nRails.application.configure do\n  path = \"#{Rails.root}/log/lograge_#{Rails.env}.log\"\n  config.lograge.logger = ActiveSupport::Logger.new path\n  config.lograge.enabled = true\n  config.lograge.keep_original_rails_log = true\n  config.lograge.formatter = Lograge::Formatters::Logstash.new\n\n  config.lograge.custom_options = lambda do |event|\n    {\n      host: event.payload[:host],\n      username: event.payload[:username],\n      time: event.time, timestamp: event.time\n    }\n  end\nend\n```\n\n### Run\n\n* `http://localhost:3000/` \u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068 *Profile* \u304c\u8868\u793a\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n* `lograge_development.log` \u306b\u305d\u306e\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u304c\u51fa\u529b\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n    * JSON \u306e\u5f62\u5f0f\u306b\u306a\u308a\u307e\u3057\u305f\u3002(JSON \u306f\u30c4\u30fc\u30eb\u3067\u6574\u5f62\u3057\u3066\u3044\u307e\u3059\u3002)\n\n```json:log/lograge_development.log\n{\n  \"method\":\"GET\",\n  \"path\":\"/\",\n  \"format\":\"html\",\n  \"controller\":\"user/session\",\n  \"action\":\"show\",\n  \"status\":200,\n  \"duration\":317.69,\n  \"view\":289.31,\n  \"db\":1.11,\n  \"host\":\"localhost\",\n  \"username\":\"foo\",\n  \"time\":\"2015-12-25T02:06:15.016+09:00\",\n  \"timestamp\":\"2015-12-25T02:06:15.016+09:00\",\n  \"@timestamp\":\"2015-12-24T17:06:15.334Z\",\n  \"@version\":\"1\",\n  \"message\":\"[200] GET / (user/session#show)\"\n}\n```\n\n\n## Elasticsearch and Fluentd\n\n\u6700\u5f8c\u306f **Fluentd** \u3067 **Lograge** \u304c\u51fa\u529b\u3057\u305f\u30ed\u30b0\u3092 **Elasticsearch** \u306b\u767b\u9332\u3057\u307e\u3057\u3087\u3046\u3002\n\n### Setup\n\n* `fluent.conf` \u306e `source` \u306b **Lograge** \u306e\u8a2d\u5b9a\u3092 `match` \u306b **Elasticsearch** \u306e\u8a2d\u5b9a\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n    * **Elasticsearch** \u306f \u30c7\u30d5\u30a9\u30eb\u30c8\u306e `127.0.0.1:9200` \u3067\u8d77\u52d5\u3057\u3066\u3044\u308b\u60f3\u5b9a\u3067\u3059\u3002\n\n```text:config/fluent.conf\n<source>\n  type     tail\n  format   json\n  tag      lograge\n  path     ./log/lograge_development.log\n  pos_file ./log/lograge_development.log.pos\n  time_key time\n</source>\n\n<match lograge>\n  type elasticsearch\n  host 127.0.0.1\n  port 9200\n  logstash_format true\n  logstash_prefix lograge\n  flush_interval  1s\n</match>\n```\n\n* **Elasticsearch** \u306f **OS X** \u3060\u3069 `brew install` \u30b3\u30de\u30f3\u30c9\u3067\u7c21\u5358\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3067\u304d\u307e\u3059\u3002\n\n```bash\n$ brew install elasticsearch\n```\n\n* **Fluentd** \u306f `Gemfile` \u306b\u8a18\u8ff0\u3059\u308b\u3068\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304c\u3067\u304d\u307e\u3059\u3002\n    * **Fluentd** \u306f Ruby \u3067\u5b9f\u88c5\u3055\u308c\u3066\u3044\u307e\u3059\u3002([\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u5b8c\u5168\u89e3\u8aac](https://gist.github.com/sonots/c54882f73e3e747f4b20))\n\n```bash\n$ echo \"gem 'fluentd', require: false\" >> Gemfile\n$ echo \"gem 'fluent-plugin-elasticsearch', require: false\" >> Gemfile\n```\n\n* **Rails** \u3068 **Elasticsearch** \u3068 **Fluentd** \u3092\u8d77\u52d5\u3059\u308b\u306e\u306b **Foreman** \u3092\u5229\u7528\u3057\u307e\u3059\u3002\n\n```bash\n$ echo \"gem 'foreman', require: false\" >> Gemfile\n$ echo \"web: rails server\" >> Procfile\n$ echo \"es: elasticsearch\" >> Procfile\n$ echo \"td: bundle exec fluentd -c ./config/fluent.conf\" >> Procfile\n```\n\n### Run\n\n* `foreman start` \u306e\u30b3\u30de\u30f3\u30c9\u3067\u5404\u7a2e\u3092\u8d77\u52d5\u3057\u307e\u3059\u3002\n\n```bash\n$ bundle\n$ foreman start\n```\n\n### Elasticsearch\n\n**Elasticsearch** \u306b\u767b\u9332\u3055\u308c\u305f\u3089 *API* \u3067\u78ba\u8a8d\u3067\u304d\u308b\u306e\u3067\u3001\u3044\u304f\u3064\u304b\u7d39\u4ecb\u3057\u307e\u3059\u3002\n\n\n* GET `http://localhost:9200/_aliases?pretty` \u306f\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u306e\u4e00\u89a7\u3092\u53c2\u7167\u3067\u304d\u307e\u3059\u3002\n\n```json\n{\n  \"lograge-2015.12.24\" : {\n    \"aliases\" : { }\n  }\n}\n```\n\n* GET `http://localhost:9200/lograge*/_mapping?pretty` \u306f\u9805\u76ee\u306e\u4e00\u89a7\u3092\u53c2\u7167\u3067\u304d\u307e\u3059\u3002\n\n```json\n{\n  \"lograge-2015.12.24\" : {\n    \"mappings\" : {\n      \"fluentd\" : {\n        \"properties\" : {\n          \"@timestamp\" : {\n            \"type\" : \"date\",\n            \"format\" : \"strict_date_optional_time||epoch_millis\"\n          },\n          \"@version\" : {\n            \"type\" : \"string\"\n          },\n          \"action\" : {\n            \"type\" : \"string\"\n          },\n          \"controller\" : {\n            \"type\" : \"string\"\n          },\n          \"db\" : {\n            \"type\" : \"double\"\n          },\n          \"duration\" : {\n            \"type\" : \"double\"\n          },\n          \"format\" : {\n            \"type\" : \"string\"\n          },\n          \"host\" : {\n            \"type\" : \"string\"\n          },\n          \"message\" : {\n            \"type\" : \"string\"\n          },\n          \"method\" : {\n            \"type\" : \"string\"\n          },\n          \"path\" : {\n            \"type\" : \"string\"\n          },\n          \"status\" : {\n            \"type\" : \"long\"\n          },\n          \"timestamp\" : {\n            \"type\" : \"date\",\n            \"format\" : \"strict_date_optional_time||epoch_millis\"\n          },\n          \"username\" : {\n            \"type\" : \"string\"\n          },\n          \"view\" : {\n            \"type\" : \"double\"\n          }\n        }\n      }\n    }\n  }\n}\n```\n\n* GET `http://localhost:9200/lograge-*/_search?status=200&pretty` \u306f\u691c\u7d22\u306e\u7d50\u679c\u3092\u53c2\u7167\u3067\u304d\u307e\u3059\u3002\n\n```json\n{\n  \"took\" : 10,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 5,\n    \"successful\" : 5,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : 1,\n    \"max_score\" : 1.0,\n    \"hits\" : [ {\n      \"_index\" : \"lograge-2015.12.24\",\n      \"_type\" : \"fluentd\",\n      \"_id\" : \"AVHU-kjPTuY2Nzr3aWVO\",\n      \"_score\" : 1.0,\n      \"_source\":{\"method\":\"GET\",\"path\":\"/\",\"format\":\"html\",\"controller\":\"user/session\",\"action\":\"show\",\"status\":200,\"duration\":316.39,\"view\":284.64,\"db\":1.12,\"host\":\"localhost\",\"username\":\"foo\",\"timestamp\":\"2015-12-25T02:12:30.224+09:00\",\"@timestamp\":\"2015-12-24T17:12:30.541Z\",\"@version\":\"1\",\"message\":\"[200] GET / (user/session#show)\"}\n    } ]\n  }\n}\n```\n\n* DELETE `http://localhost:9200/lograge-*` \u306f\u30c7\u30fc\u30bf\u3092\u524a\u9664\u3067\u304d\u307e\u3059\u3002\n    * \u5371\u967a\u306a *API* \u306e\u3067\u6271\u3044\u306b\u306f\u5341\u5206\u306b\u6ce8\u610f\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\n# Tips\n\n## Elasticsearch Client\n\n**Elasticsearch** \u306e\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u306f [Kibana](https://www.elastic.co/products/kibana) \u304c\u3042\u308a\u307e\u3059\u304c **Rails** \u306b\u3082\u7c21\u5358\u306b\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3092\u5b9f\u88c5\u3067\u304d\u307e\u3059\u3002\n\n### Setup\n\n* \u4eca\u56de\u306f *ActiveRecord* \u306e\u30a4\u30f3\u30bf\u30d5\u30a7\u30fc\u30b9\u306b\u5408\u308f\u305b\u305f\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u5229\u7528\u3057\u307e\u3059\u3002\n\n```bash\n$ echo \"gem 'elasticsearch-persistence'\" >> Gemfile\n$ bundle\n```\n\n* `rails generate` \u306e\u30b3\u30de\u30f3\u30c9\u3067 *View* \u3068 *Controller* \u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```bash\n$ rails generate controller logs index\n```\n\n### Making\n\n* `routes.rb` \u306e `logs` \u306e\u30d1\u30b9\u3092\u7de8\u96c6\u3057\u307e\u3059\u3002\n\n```ruby:config/routes.rb\nget :logs, to: 'logs#index'\n```\n\n* `logs_controller.rb` \u306b `message` \u3067\u691c\u7d22\u3067\u304d\u308b\u3088\u3046\u306b\u51e6\u7406\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n```ruby:app/controllers/logs_controller.rb\nclass LogsController < ApplicationController\n  def index\n    @message = params[:message] || \"\"\n    @logs = Elasticsearch::Lograge.search(query: {\n      match: {message: @message}\n    })\n  end\nend\n```\n\n* `index.html.erb` \u306b\u691c\u7d22\u30d5\u30a9\u30fc\u30e0\u3068\u8868\u793a\u30a8\u30ea\u30a2\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n```html:app/views/logs/index.html.erb\n<h1>Logs</h1>\n\n<%= form_tag logs_path, method: :get do %>\n<dl>\n  <dt><strong>message:</strong></dt>\n  <dd><%= text_field_tag :message, @message %></dd>\n</dl>\n<%= submit_tag 'Search' %>\n<% end %>\n\n<br/>\n\n<table border=\"1\">\n  <thead>\n    <tr>\n      <th>method</th>\n      <th>path</th>\n      <th>controller</th>\n      <th>action</th>\n      <th>status</th>\n      <th>username</th>\n      <th>message</th>\n      <th>timestamp</th>\n    </tr>\n  </thead>\n  <tbody>\n    <% @logs.each do |log| %>\n      <tr>\n        <td><%= log.method %></td>\n        <td><%= log.path %></td>\n        <td><%= log.controller %></td>\n        <td><%= log.action %></td>\n        <td><%= log.status %></td>\n        <td><%= log.username %></td>\n        <td><%= log.message %></td>\n        <td><%= log.timestamp %></td>\n      </tr>\n    <% end %>\n  </tbody>\n</table>\n```\n\n\n* `lograge.rb` \u306b\u53c2\u7167\u3059\u308b\u9805\u76ee\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n    * `index_name` \u306b\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n    * `document_type` \u306b\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n    * `attribute` \u306b\u30de\u30c3\u30d4\u30f3\u30b0\u306e\u9805\u76ee\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n```ruby:app/models/elasticsearch/lograge.rb\nrequire 'elasticsearch/persistence/model'\n\nmodule Elasticsearch\n  class Lograge\n    include Elasticsearch::Persistence::Model\n\n    index_name 'lograge*'\n    document_type 'fluentd'\n\n    attribute :method,      String\n    attribute :path,        String\n    attribute :format,      String\n    attribute :controller,  String\n    attribute :action,      String\n    attribute :status,      Integer\n    attribute :duration,    Float\n    attribute :view,        Float\n    attribute :db,          Float\n    attribute :username,    String\n    attribute :message,     String\n    attribute :timestamp,   Date\n  end\nend\n```\n\n* `lograge.rb` \u306b\u306f\u30ed\u30b0\u306b\u51fa\u529b\u3057\u306a\u3044\u30d1\u30b9\u3092\u8a18\u8ff0\u3067\u304d\u307e\u3059\u3002\n\n```ruby:config/initializers/lograge.rb\nconfig.lograge.ignore_actions = %W(\n  user/session#new\n  logs#index\n)\n```\n\n### Run\n\n\u691c\u7d22\u306f\u5168\u6587\u691c\u7d22\u306a\u306e\u3067\u8abf\u67fb\u304c\u6357\u308a\u307e\u3059\u3002\n\n![logs](https://dl.dropboxusercontent.com/u/14690051/images/notes/lang/ruby/lograge/logs.png)\n\n\u3044\u3064\uff08When\uff09\u3001\u3069\u3053\u3067\uff08Where\uff09\u3001\u3060\u308c\u304c\uff08Who\uff09\u3001\u306a\u306b\u3092\uff08What\uff09\u3092\u8ffd\u8de1\u3067\u304d\u308b\u6e96\u5099\u304c\u5b89\u5168\u306a\u958b\u767a\u3001\u5b89\u5fc3\u306a\u904b\u7528\u306b\u7e4b\u304c\u308a\u307e\u3059\u3002\n\n*Enjoy Logging*\n"}