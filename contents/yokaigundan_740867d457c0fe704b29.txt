{"context": " More than 1 year has passed since last update.\u8868\u984c\u306e\u4ef6\u3001\u4ee5\u4e0b\u306e\u30e2\u30c7\u30eb\u304c\u5b58\u5728\u3057\u3066\u3044\u308b\u3068\u304d\u3001\nclass Group < ActiveRecord::Base\n\n  has_many :children, class: Group, :foreign_key => :parent_id\n  belongs_to :parent, class: Group, :foreign_key => :parent_id\n\n  def self.generations(num = 3)\n    num.times.inject({}) { |gen| gen = { children: gen } }\n  end\n\n  scope :family, -> { includes(generations) }\n\nend\n\n\u4ee5\u4e0b\u306edb/seed.rb\u3092\u524d\u63d0\u3068\u3057\u3066\u3001\nroot = Group.create(name: 'root')\ngroup_a = Group.create(name: 'group_a', parent_id: root.id)\ngroup_b = Group.create(name: 'group_b', parent_id: root.id)\ngroup_a_a = Group.create(name: 'group_a_a', parent_id: group_a.id)\ngroup_a_b = Group.create(name: 'group_a_b', parent_id: group_a.id)\ngroup_b_a = Group.create(name: 'group_b_a', parent_id: group_b.id)\ngroup_b_b = Group.create(name: 'group_b_b', parent_id: group_b.id)\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30b3\u30fc\u30c9\u3092rails console\u304b\u3089\u5b9f\u884c\u3057\u305f\u5834\u5408\u3001\nLoading development environment (Rails 4.1.8)\n2.0.0 :001 > root = Group.first\n  Group Load (0.3ms)  SELECT  `groups`.* FROM `groups`   ORDER BY `groups`.`id` ASC LIMIT 1\n => #<Group id: 1, parent_id: nil, name: \"root\", created_at: \"2014-12-02 11:43:16\", updated_at: \"2014-12-02 11:43:16\">\n2.0.0 :002 > root.children.family\n  Group Load (0.4ms)  SELECT `groups`.* FROM `groups`  WHERE `groups`.`parent_id` = 1\n  Group Load (0.3ms)  SELECT `groups`.* FROM `groups`  WHERE `groups`.`parent_id` IN (2, 3)\n  Group Load (0.2ms)  SELECT `groups`.* FROM `groups`  WHERE `groups`.`parent_id` IN (4, 5, 6, 7)\n => #<ActiveRecord::AssociationRelation [#<Group id: 2, parent_id: 1, name: \"group_a\", created_at: \"2014-12-02 11:43:16\", updated_at: \"2014-12-02 11:43:16\">, #<Group id: 3, parent_id: 1, name: \"group_b\", created_at: \"2014-12-02 11:43:16\", updated_at: \"2014-12-02 11:43:16\">]>\n\npreload\u304c\u8d70\u3063\u3066SELECT\u306b\u3088\u308b\u30ad\u30e3\u30c3\u30b7\u30f3\u30b0\u304c\u89aa\u3001\u5b50\u3001\u5b6b\u3068\u884c\u308f\u308c\u307e\u3059\u3002\n\u5bfe\u3057\u3066\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306breferences\u3092\u6307\u5b9a\u3057\u305f\u5834\u5408\u3001\n2.0.0 :018 > root.children.family.references(:children)\n  SQL (1.1ms)  SELECT `groups`.`id` AS t0_r0, `groups`.`parent_id` AS t0_r1, `groups`.`name` AS t0_r2, `groups`.`created_at` AS t0_r3, `groups`.`updated_at` AS t0_r4, `children_groups`.`id` AS t1_r0, `children_groups`.`parent_id` AS t1_r1, `children_groups`.`name` AS t1_r2, `children_groups`.`created_at` AS t1_r3, `children_groups`.`updated_at` AS t1_r4, `children_groups_2`.`id` AS t2_r0, `children_groups_2`.`parent_id` AS t2_r1, `children_groups_2`.`name` AS t2_r2, `children_groups_2`.`created_at` AS t2_r3, `children_groups_2`.`updated_at` AS t2_r4, `children_groups_3`.`id` AS t3_r0, `children_groups_3`.`parent_id` AS t3_r1, `children_groups_3`.`name` AS t3_r2, `children_groups_3`.`created_at` AS t3_r3, `children_groups_3`.`updated_at` AS t3_r4 FROM `groups` LEFT OUTER JOIN `groups` `children_groups` ON `children_groups`.`parent_id` = `groups`.`id` LEFT OUTER JOIN `groups` `children_groups_2` ON `children_groups_2`.`parent_id` = `children_groups`.`id` LEFT OUTER JOIN `groups` `children_groups_3` ON `children_groups_3`.`parent_id` = `children_groups_2`.`id` WHERE `groups`.`parent_id` = 1\n => #<ActiveRecord::AssociationRelation [#<Group id: 2, parent_id: 1, name: \"group_a\", created_at: \"2014-12-02 11:43:16\", updated_at: \"2014-12-02 11:43:16\">, #<Group id: 3, parent_id: 1, name: \"group_b\", created_at: \"2014-12-02 11:43:16\", updated_at: \"2014-12-02 11:43:16\">]>\n\n\n\u30b7\u30e3\u30a4\u30cb\u30f3\u30b0\u30ed\u30ea\u30d0\u30d0\u30a1\uff01\n\u8868\u984c\u306e\u4ef6\u3001\u4ee5\u4e0b\u306e\u30e2\u30c7\u30eb\u304c\u5b58\u5728\u3057\u3066\u3044\u308b\u3068\u304d\u3001\n\n```ruby\nclass Group < ActiveRecord::Base\n\n  has_many :children, class: Group, :foreign_key => :parent_id\n  belongs_to :parent, class: Group, :foreign_key => :parent_id\n\n  def self.generations(num = 3)\n    num.times.inject({}) { |gen| gen = { children: gen } }\n  end\n\n  scope :family, -> { includes(generations) }\n\nend\n```\n\n\u4ee5\u4e0b\u306edb/seed.rb\u3092\u524d\u63d0\u3068\u3057\u3066\u3001\n\n```ruby\nroot = Group.create(name: 'root')\ngroup_a = Group.create(name: 'group_a', parent_id: root.id)\ngroup_b = Group.create(name: 'group_b', parent_id: root.id)\ngroup_a_a = Group.create(name: 'group_a_a', parent_id: group_a.id)\ngroup_a_b = Group.create(name: 'group_a_b', parent_id: group_a.id)\ngroup_b_a = Group.create(name: 'group_b_a', parent_id: group_b.id)\ngroup_b_b = Group.create(name: 'group_b_b', parent_id: group_b.id)\n```\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30b3\u30fc\u30c9\u3092rails console\u304b\u3089\u5b9f\u884c\u3057\u305f\u5834\u5408\u3001\n\n```ruby\nLoading development environment (Rails 4.1.8)\n2.0.0 :001 > root = Group.first\n  Group Load (0.3ms)  SELECT  `groups`.* FROM `groups`   ORDER BY `groups`.`id` ASC LIMIT 1\n => #<Group id: 1, parent_id: nil, name: \"root\", created_at: \"2014-12-02 11:43:16\", updated_at: \"2014-12-02 11:43:16\">\n2.0.0 :002 > root.children.family\n  Group Load (0.4ms)  SELECT `groups`.* FROM `groups`  WHERE `groups`.`parent_id` = 1\n  Group Load (0.3ms)  SELECT `groups`.* FROM `groups`  WHERE `groups`.`parent_id` IN (2, 3)\n  Group Load (0.2ms)  SELECT `groups`.* FROM `groups`  WHERE `groups`.`parent_id` IN (4, 5, 6, 7)\n => #<ActiveRecord::AssociationRelation [#<Group id: 2, parent_id: 1, name: \"group_a\", created_at: \"2014-12-02 11:43:16\", updated_at: \"2014-12-02 11:43:16\">, #<Group id: 3, parent_id: 1, name: \"group_b\", created_at: \"2014-12-02 11:43:16\", updated_at: \"2014-12-02 11:43:16\">]>\n```\n\npreload\u304c\u8d70\u3063\u3066SELECT\u306b\u3088\u308b\u30ad\u30e3\u30c3\u30b7\u30f3\u30b0\u304c\u89aa\u3001\u5b50\u3001\u5b6b\u3068\u884c\u308f\u308c\u307e\u3059\u3002\n\n\u5bfe\u3057\u3066\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306breferences\u3092\u6307\u5b9a\u3057\u305f\u5834\u5408\u3001\n\n```ruby\n2.0.0 :018 > root.children.family.references(:children)\n  SQL (1.1ms)  SELECT `groups`.`id` AS t0_r0, `groups`.`parent_id` AS t0_r1, `groups`.`name` AS t0_r2, `groups`.`created_at` AS t0_r3, `groups`.`updated_at` AS t0_r4, `children_groups`.`id` AS t1_r0, `children_groups`.`parent_id` AS t1_r1, `children_groups`.`name` AS t1_r2, `children_groups`.`created_at` AS t1_r3, `children_groups`.`updated_at` AS t1_r4, `children_groups_2`.`id` AS t2_r0, `children_groups_2`.`parent_id` AS t2_r1, `children_groups_2`.`name` AS t2_r2, `children_groups_2`.`created_at` AS t2_r3, `children_groups_2`.`updated_at` AS t2_r4, `children_groups_3`.`id` AS t3_r0, `children_groups_3`.`parent_id` AS t3_r1, `children_groups_3`.`name` AS t3_r2, `children_groups_3`.`created_at` AS t3_r3, `children_groups_3`.`updated_at` AS t3_r4 FROM `groups` LEFT OUTER JOIN `groups` `children_groups` ON `children_groups`.`parent_id` = `groups`.`id` LEFT OUTER JOIN `groups` `children_groups_2` ON `children_groups_2`.`parent_id` = `children_groups`.`id` LEFT OUTER JOIN `groups` `children_groups_3` ON `children_groups_3`.`parent_id` = `children_groups_2`.`id` WHERE `groups`.`parent_id` = 1\n => #<ActiveRecord::AssociationRelation [#<Group id: 2, parent_id: 1, name: \"group_a\", created_at: \"2014-12-02 11:43:16\", updated_at: \"2014-12-02 11:43:16\">, #<Group id: 3, parent_id: 1, name: \"group_b\", created_at: \"2014-12-02 11:43:16\", updated_at: \"2014-12-02 11:43:16\">]>\n```\n\n# \u30b7\u30e3\u30a4\u30cb\u30f3\u30b0\u30ed\u30ea\u30d0\u30d0\u30a1\uff01\n", "tags": ["Rails", "ActiveRecord"]}