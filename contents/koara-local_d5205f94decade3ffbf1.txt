{"context": "\n\nTL;DR\n\u30d3\u30eb\u30c9\u6e08\u307f\u306e\u30d0\u30a4\u30ca\u30ea\u306e\u95a2\u6570\u3092\u5f8c\u304b\u3089\u5dee\u3057\u66ff\u3048\u308b\u65b9\u6cd5\u306e\u307e\u3068\u3081\n\u203b\u672c\u8a18\u4e8b\u306e\u65b9\u6cd5\u306f\u5171\u6709\u30e9\u30a4\u30d6\u30e9\u30ea\u306e\u95a2\u6570\u306e\u307f\u6709\u52b9\n\n\u5dee\u3057\u66ff\u3048\u5bfe\u8c61\u30b3\u30fc\u30c9\n\u5dee\u3057\u66ff\u3048\u5bfe\u8c61\u306e\u30b5\u30f3\u30d7\u30eb\u3068\u3057\u3066ptintf\u3068fprintf\u306e\u305d\u308c\u305e\u308c\u53ef\u5909\u9577\u5f15\u6570\u3042\u308a\u3068\u306a\u3057\u3092\u7528\u610f\u3059\u308b\u3002\n\nprint.c\n#include <stdio.h>\n\nint main(int argc, char const* argv[])\n{\n    printf(\"printf no args\\n\");\n    printf(\"printf %d\\n\", 1);\n\n    fprintf(stdout, \"fprintf no args\\n\");\n    fprintf(stdout, \"fprintf %d\\n\", 1);\n\n    return 0;\n}\n\n\n\u30d3\u30eb\u30c9\u3068\u5b9f\u884c\u7d50\u679c\u306f\u4ee5\u4e0b\u306b\u306a\u308b\u3002\n\n\u30d3\u30eb\u30c9\u3068\u5b9f\u884c\u7d50\u679c\n$ gcc print.c \n$ ./a.out \nprintf no args\nprintf 1\nfprintf no args\nfprintf 1\n\n\n\n\u5dee\u3057\u66ff\u3048\u30b3\u30fc\u30c9\n\u6b21\u306bLD_PRELOAD\u306b\u3066\u5dee\u3057\u66ff\u3048\u3092\u884c\u3046\u7528\u306e\u30b3\u30fc\u30c9\u3092\u7528\u610f\u3059\u308b\u3002\n\u53ef\u5909\u9577\u5f15\u6570\u306e\u6709\u7121\u306b\u304b\u304b\u308f\u3089\u305a\u57fa\u672c\u7684\u306b\u306f\u5dee\u3057\u66ff\u3048\u305f\u3044\u95a2\u6570\u306e\u5b9a\u7fa9\u3092\u6301\u3063\u3066\u304d\u3066\u518d\u5b9a\u7fa9\u3059\u308c\u3070\u826f\u3044\u3002\n\noverride.c\n#include <stdio.h>\n#include <stdarg.h>\n#include <string.h>\n\nsize_t fwrite(const void *ptr, size_t size, size_t nmemb, FILE *stream) {\n    const char *c = \"override fwrite\\n\";\n    write(1, c, strlen(c)); // stdout\n    return 0;\n}\n\nint fprintf (FILE *__restrict __stream, const char *__restrict __format, ...) {\n    const char *c = \"override fprintf\\n\";\n    write(1, c, strlen(c)); // stdout\n    return 0;\n}\n\nint puts(const char *s) {\n    const char *c = \"override puts\\n\";\n    write(1, c, strlen(c)); // stdout\n    return 0;\n}\n\nint printf (const char *__restrict __format, ...) {\n    const char *c = \"override printf\\n\";\n    write(1, c, strlen(c)); // stdout\n    return 0;\n}\n\n\n\u3053\u308c\u3092LD_PRELOAD\u3067\u6307\u5b9a\u3057\u3066\u5b9f\u884c\u3059\u308c\u3070\u3001\u5b9a\u7fa9\u3092\u5f8c\u304b\u3089\u5dee\u3057\u66ff\u3048\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\n\u30d3\u30eb\u30c9\u3068\u5b9f\u884c\u7d50\u679c\n$ gcc -shared -fPIC override.c -o liboverride.so\n$ LD_PRELOAD=./liboverride.so ./a.out\noverride puts\noverride printf\noverride fwrite\noverride fprintf\n\n\n\u305f\u3060\u3057\u3001GCC\u3067\u306f printf \u3068 fprintf \u3067\u53ef\u5909\u9577\u5f15\u6570\u306e\u8981\u7d20\u304c0\u306e\u5834\u5408\u3001\u30b3\u30f3\u30d1\u30a4\u30eb\u6642\u306b\u305d\u308c\u305e\u308c puts \u3068 fwrite \u306b\u7f6e\u304d\u66ff\u3048\u3089\u308c\u3066\u3057\u307e\u3046\u3002(GCC\u306f-O0\u3067\u3082\u7f6e\u304d\u66ff\u3048\u306f\u6709\u52b9\u3001clang 3.6\u3067\u306f-O0\u3067\u306fprintf\u306e\u307e\u307e\u7f6e\u304d\u63db\u3048\u306a\u3057\u3001-O1\u4ee5\u4e0a\u3067\u7f6e\u304d\u63db\u3048)\n$ gcc -S print.c\n$ cat print.s\n        .file   \"print.c\"\n        .section        .rodata\n.LC0:\n        .string \"printf no args\"\n.LC1:\n        .string \"printf %d\\n\"\n.LC2:\n        .string \"fprintf no args\\n\"\n.LC3:\n        .string \"fprintf %d\\n\"\n        .text\n        .globl  main\n        .type   main, @function\nmain:\n.LFB0:\n        .cfi_startproc\n        pushq   %rbp\n        .cfi_def_cfa_offset 16\n        .cfi_offset 6, -16\n        movq    %rsp, %rbp\n        .cfi_def_cfa_register 6\n        subq    $16, %rsp\n        movl    %edi, -4(%rbp)\n        movq    %rsi, -16(%rbp)\n        movl    $.LC0, %edi\n        call    puts             <- printf \u304c puts \u306b\u306a\u3063\u3066\u3044\u308b\n        movl    $1, %esi\n        movl    $.LC1, %edi\n        movl    $0, %eax\n        call    printf\n        movq    stdout(%rip), %rax\n        movq    %rax, %rcx\n        movl    $16, %edx\n        movl    $1, %esi\n        movl    $.LC2, %edi\n        call    fwrite             <- fprintf \u304c fwrite \u306b\u306a\u3063\u3066\u3044\u308b\n        movq    stdout(%rip), %rax\n        movl    $1, %edx\n        movl    $.LC3, %esi\n        movq    %rax, %rdi\n        movl    $0, %eax\n        call    fprintf\n        movl    $0, %eax\n        leave\n        .cfi_def_cfa 7, 8\n        ret\n        .cfi_endproc\n.LFE0:\n        .size   main, .-main\n        .ident  \"GCC: (Ubuntu 4.8.2-19ubuntu1) 4.8.2\"\n        .section        .note.GNU-stack,\"\",@progbits\n\nGCC\u3067\u3053\u306e\u7f6e\u304d\u66ff\u3048\u3092\u3082\u3057\u7121\u52b9\u5316\u3057\u305f\u3044\u5834\u5408\u306f -fno-builtin-printf -fno-builtin-fprintf \u3092\u3064\u3051\u3066\u30d3\u30eb\u30c9\u3059\u308c\u3070\u826f\u3044\n\n\u5dee\u3057\u66ff\u3048\u3092\u7121\u52b9\u5316\u3057\u305f\u30d3\u30eb\u30c9\u3068\u5b9f\u884c\u7d50\u679c\n$ gcc -fno-builtin-printf -fno-builtin-fprintf print.c                                                                                                                \n$ LD_PRELOAD=./liboverride.so ./a.out                                                                                                                                 \noverride printf\noverride printf\noverride fprintf\noverride fprintf\n\n\n\n\u6ce8\u610f\u70b9\n\u5f53\u7136\u3068\u3044\u3048\u3070\u5f53\u7136\u3060\u3051\u308c\u3069\u3082\u3001\u5dee\u3057\u66ff\u3048\u305f\u95a2\u6570\u5185\u3067\u518d\u5ea6\u540c\u3058\u95a2\u6570\u3092\u547c\u3076\u3068\u518d\u5e30\u547c\u3073\u51fa\u3057\u306b\u306a\u308a\u629c\u3051\u3089\u308c\u306a\u304f\u306a\u308b\u3002\n\u4f8b\u3048\u3070printf\u3092\u5dee\u3057\u66ff\u3048\u308b\u5834\u5408\u306f\u5dee\u3057\u66ff\u3048\u51e6\u7406\u3067\u4f7f\u7528\u3057\u305f\u30e9\u30a4\u30d6\u30e9\u30ea\u5185\u3067\u4f7f\u308f\u308c\u3066\u3044\u305f\u308a\u3082\u3059\u308b\u305f\u3081\u3001\u5225\u9014\u6c17\u3092\u3064\u3051\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\n\u518d\u5e30\u547c\u3073\u51fa\u3057\nint puts(const char *s) {\n        const char *c = \"override puts\\n\";\n        write(1, c, strlen(c)); // stdout\n\n        puts(\"recursive call?\"); // \u203bputs\u304b\u3089\u629c\u3051\u3089\u308c\u306a\u304f\u306a\u308b\n\n        return 0;\n}\n\n\n\n\u53c2\u8003\u66f8\u7c4d\n\u300eBINARY HACKS\u300f #HACK 60 : LD_PRELOAD\u3067\u5171\u6709\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u5dee\u3057\u66ff\u3048\u308b\n\n\u95a2\u9023\n\u5b9f\u884c\u6642\u306e\u95a2\u6570\u5168\u3066\u306e in/out \u3092\u30c8\u30ec\u30fc\u30b9\u3059\u308b - Qiita\n\n\u53c2\u8003\nLinux \u5171\u6709\u30e9\u30a4\u30d6\u30e9\u30ea(.so)\u306e\u52d5\u4f5c\u3092\u5909\u3048\u308b\u3002LD_PRELOAD\u3067\u697d\u3057\u304f\u904a\u3076\uff1aGarbage In Garbage Out\nLD_PRELOAD\u3067\u95a2\u6570\u30d5\u30c3\u30af\u3057\u3066\u307f\u3088\u3046\uff01 - \u30d0\u30a4\u30ca\u30ea\u306e\u6b69\u304d\u65b9\nLD_PRELOAD\u3067\u52d5\u7684\u30e9\u30a4\u30d6\u30e9\u30ea\u95a2\u6570\u3092\u4e0a\u66f8\u304d\u3059\u308b | Siguniang's Blog\n# TL;DR\n\u30d3\u30eb\u30c9\u6e08\u307f\u306e\u30d0\u30a4\u30ca\u30ea\u306e\u95a2\u6570\u3092\u5f8c\u304b\u3089\u5dee\u3057\u66ff\u3048\u308b\u65b9\u6cd5\u306e\u307e\u3068\u3081\n\n\u203b\u672c\u8a18\u4e8b\u306e\u65b9\u6cd5\u306f\u5171\u6709\u30e9\u30a4\u30d6\u30e9\u30ea\u306e\u95a2\u6570\u306e\u307f\u6709\u52b9\n\n# \u5dee\u3057\u66ff\u3048\u5bfe\u8c61\u30b3\u30fc\u30c9\n\u5dee\u3057\u66ff\u3048\u5bfe\u8c61\u306e\u30b5\u30f3\u30d7\u30eb\u3068\u3057\u3066ptintf\u3068fprintf\u306e\u305d\u308c\u305e\u308c\u53ef\u5909\u9577\u5f15\u6570\u3042\u308a\u3068\u306a\u3057\u3092\u7528\u610f\u3059\u308b\u3002\n\n```c:print.c\n#include <stdio.h>\n\nint main(int argc, char const* argv[])\n{\n    printf(\"printf no args\\n\");\n    printf(\"printf %d\\n\", 1);\n\n    fprintf(stdout, \"fprintf no args\\n\");\n    fprintf(stdout, \"fprintf %d\\n\", 1);\n\n    return 0;\n}\n```\n\n\u30d3\u30eb\u30c9\u3068\u5b9f\u884c\u7d50\u679c\u306f\u4ee5\u4e0b\u306b\u306a\u308b\u3002\n\n```shell-session:\u30d3\u30eb\u30c9\u3068\u5b9f\u884c\u7d50\u679c\n$ gcc print.c \n$ ./a.out \nprintf no args\nprintf 1\nfprintf no args\nfprintf 1\n```\n\n# \u5dee\u3057\u66ff\u3048\u30b3\u30fc\u30c9\n\u6b21\u306bLD_PRELOAD\u306b\u3066\u5dee\u3057\u66ff\u3048\u3092\u884c\u3046\u7528\u306e\u30b3\u30fc\u30c9\u3092\u7528\u610f\u3059\u308b\u3002\n\u53ef\u5909\u9577\u5f15\u6570\u306e\u6709\u7121\u306b\u304b\u304b\u308f\u3089\u305a\u57fa\u672c\u7684\u306b\u306f\u5dee\u3057\u66ff\u3048\u305f\u3044\u95a2\u6570\u306e\u5b9a\u7fa9\u3092\u6301\u3063\u3066\u304d\u3066\u518d\u5b9a\u7fa9\u3059\u308c\u3070\u826f\u3044\u3002\n\n```c:override.c\n#include <stdio.h>\n#include <stdarg.h>\n#include <string.h>\n\nsize_t fwrite(const void *ptr, size_t size, size_t nmemb, FILE *stream) {\n\tconst char *c = \"override fwrite\\n\";\n\twrite(1, c, strlen(c)); // stdout\n\treturn 0;\n}\n\nint fprintf (FILE *__restrict __stream, const char *__restrict __format, ...) {\n\tconst char *c = \"override fprintf\\n\";\n\twrite(1, c, strlen(c)); // stdout\n\treturn 0;\n}\n\nint puts(const char *s) {\n\tconst char *c = \"override puts\\n\";\n\twrite(1, c, strlen(c)); // stdout\n\treturn 0;\n}\n\nint printf (const char *__restrict __format, ...) {\n\tconst char *c = \"override printf\\n\";\n\twrite(1, c, strlen(c)); // stdout\n\treturn 0;\n}\n```\n\n\u3053\u308c\u3092LD_PRELOAD\u3067\u6307\u5b9a\u3057\u3066\u5b9f\u884c\u3059\u308c\u3070\u3001\u5b9a\u7fa9\u3092\u5f8c\u304b\u3089\u5dee\u3057\u66ff\u3048\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\n```shell-session:\u30d3\u30eb\u30c9\u3068\u5b9f\u884c\u7d50\u679c\n$ gcc -shared -fPIC override.c -o liboverride.so\n$ LD_PRELOAD=./liboverride.so ./a.out\noverride puts\noverride printf\noverride fwrite\noverride fprintf\n```\n\n\u305f\u3060\u3057\u3001GCC\u3067\u306f `printf` \u3068 `fprintf` \u3067\u53ef\u5909\u9577\u5f15\u6570\u306e\u8981\u7d20\u304c0\u306e\u5834\u5408\u3001\u30b3\u30f3\u30d1\u30a4\u30eb\u6642\u306b\u305d\u308c\u305e\u308c `puts` \u3068 `fwrite` \u306b\u7f6e\u304d\u66ff\u3048\u3089\u308c\u3066\u3057\u307e\u3046\u3002(GCC\u306f-O0\u3067\u3082\u7f6e\u304d\u66ff\u3048\u306f\u6709\u52b9\u3001clang 3.6\u3067\u306f-O0\u3067\u306fprintf\u306e\u307e\u307e\u7f6e\u304d\u63db\u3048\u306a\u3057\u3001-O1\u4ee5\u4e0a\u3067\u7f6e\u304d\u63db\u3048)\n\n```\n$ gcc -S print.c\n$ cat print.s\n        .file   \"print.c\"\n        .section        .rodata\n.LC0:\n        .string \"printf no args\"\n.LC1:\n        .string \"printf %d\\n\"\n.LC2:\n        .string \"fprintf no args\\n\"\n.LC3:\n        .string \"fprintf %d\\n\"\n        .text\n        .globl  main\n        .type   main, @function\nmain:\n.LFB0:\n        .cfi_startproc\n        pushq   %rbp\n        .cfi_def_cfa_offset 16\n        .cfi_offset 6, -16\n        movq    %rsp, %rbp\n        .cfi_def_cfa_register 6\n        subq    $16, %rsp\n        movl    %edi, -4(%rbp)\n        movq    %rsi, -16(%rbp)\n        movl    $.LC0, %edi\n        call    puts             <- printf \u304c puts \u306b\u306a\u3063\u3066\u3044\u308b\n        movl    $1, %esi\n        movl    $.LC1, %edi\n        movl    $0, %eax\n        call    printf\n        movq    stdout(%rip), %rax\n        movq    %rax, %rcx\n        movl    $16, %edx\n        movl    $1, %esi\n        movl    $.LC2, %edi\n        call    fwrite             <- fprintf \u304c fwrite \u306b\u306a\u3063\u3066\u3044\u308b\n        movq    stdout(%rip), %rax\n        movl    $1, %edx\n        movl    $.LC3, %esi\n        movq    %rax, %rdi\n        movl    $0, %eax\n        call    fprintf\n        movl    $0, %eax\n        leave\n        .cfi_def_cfa 7, 8\n        ret\n        .cfi_endproc\n.LFE0:\n        .size   main, .-main\n        .ident  \"GCC: (Ubuntu 4.8.2-19ubuntu1) 4.8.2\"\n        .section        .note.GNU-stack,\"\",@progbits\n```\n\nGCC\u3067\u3053\u306e\u7f6e\u304d\u66ff\u3048\u3092\u3082\u3057\u7121\u52b9\u5316\u3057\u305f\u3044\u5834\u5408\u306f `-fno-builtin-printf` `-fno-builtin-fprintf` \u3092\u3064\u3051\u3066\u30d3\u30eb\u30c9\u3059\u308c\u3070\u826f\u3044\n\n```shell-session:\u5dee\u3057\u66ff\u3048\u3092\u7121\u52b9\u5316\u3057\u305f\u30d3\u30eb\u30c9\u3068\u5b9f\u884c\u7d50\u679c\n$ gcc -fno-builtin-printf -fno-builtin-fprintf print.c                                                                                                                \n$ LD_PRELOAD=./liboverride.so ./a.out                                                                                                                                 \noverride printf\noverride printf\noverride fprintf\noverride fprintf\n```\n\n# \u6ce8\u610f\u70b9\n\u5f53\u7136\u3068\u3044\u3048\u3070\u5f53\u7136\u3060\u3051\u308c\u3069\u3082\u3001\u5dee\u3057\u66ff\u3048\u305f\u95a2\u6570\u5185\u3067\u518d\u5ea6\u540c\u3058\u95a2\u6570\u3092\u547c\u3076\u3068\u518d\u5e30\u547c\u3073\u51fa\u3057\u306b\u306a\u308a\u629c\u3051\u3089\u308c\u306a\u304f\u306a\u308b\u3002\n\u4f8b\u3048\u3070printf\u3092\u5dee\u3057\u66ff\u3048\u308b\u5834\u5408\u306f\u5dee\u3057\u66ff\u3048\u51e6\u7406\u3067\u4f7f\u7528\u3057\u305f\u30e9\u30a4\u30d6\u30e9\u30ea\u5185\u3067\u4f7f\u308f\u308c\u3066\u3044\u305f\u308a\u3082\u3059\u308b\u305f\u3081\u3001\u5225\u9014\u6c17\u3092\u3064\u3051\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\n```c:\u518d\u5e30\u547c\u3073\u51fa\u3057\nint puts(const char *s) {\n        const char *c = \"override puts\\n\";\n        write(1, c, strlen(c)); // stdout\n\n        puts(\"recursive call?\"); // \u203bputs\u304b\u3089\u629c\u3051\u3089\u308c\u306a\u304f\u306a\u308b\n\n        return 0;\n}\n```\n\n# \u53c2\u8003\u66f8\u7c4d\n\u300eBINARY HACKS\u300f #HACK 60 : LD_PRELOAD\u3067\u5171\u6709\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u5dee\u3057\u66ff\u3048\u308b\n\n# \u95a2\u9023\n\n[\u5b9f\u884c\u6642\u306e\u95a2\u6570\u5168\u3066\u306e in/out \u3092\u30c8\u30ec\u30fc\u30b9\u3059\u308b - Qiita](http://qiita.com/naohikowatanabe/items/d559858734d8a02f0d8a)\n\n# \u53c2\u8003\n[Linux \u5171\u6709\u30e9\u30a4\u30d6\u30e9\u30ea(.so)\u306e\u52d5\u4f5c\u3092\u5909\u3048\u308b\u3002LD_PRELOAD\u3067\u697d\u3057\u304f\u904a\u3076\uff1aGarbage In Garbage Out](http://g1g0.com/2012/04/1790/)\n[LD_PRELOAD\u3067\u95a2\u6570\u30d5\u30c3\u30af\u3057\u3066\u307f\u3088\u3046\uff01 - \u30d0\u30a4\u30ca\u30ea\u306e\u6b69\u304d\u65b9](http://07c00.hatenablog.com/entry/2013/09/02/003629)\n[LD_PRELOAD\u3067\u52d5\u7684\u30e9\u30a4\u30d6\u30e9\u30ea\u95a2\u6570\u3092\u4e0a\u66f8\u304d\u3059\u308b | Siguniang's Blog](https://siguniang.wordpress.com/2015/05/15/override-functions-with-ld_preload/)\n", "tags": ["Linux", "C", "GCC", "LD_PRELOAD"]}