{"context": " More than 1 year has passed since last update.\n\n\u6982\u8981\n\n\u65e5\u672c\u8a9e\u3067\u691c\u7d22\nGET\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u30ad\u30fc\u30ef\u30fc\u30c9\u3068\u3057\u3066\u691c\u7d22\nPDO\u4f7f\u3063\u3066MySQL\u306b\u63a5\u7d9a\u3057\u3001\u30d7\u30ec\u30fc\u30b9\u30db\u30eb\u30c0\u3092\u4f7f\u3063\u3066SQL\u3092\u69cb\u7bc9\u3059\u308b\n\u53ef\u5909\u9577\u306aAND(OR)\u691c\u7d22\n\n\n\u30dd\u30a4\u30f3\u30c8\n\n\u65e5\u672c\u8a9e\u5bfe\u7b56\n\n\nmb_internal_encoding('UTF-8');\u3092\u30d5\u30a1\u30a4\u30eb\u306e\u5148\u982d\u306b\u66f8\u304f\n\n\n\u4eca\u56de\u306f\u7279\u306b\u95a2\u4fc2\u306a\u3044\u3063\u307d\u3044\u3067\u3059\u304c\u3001\u3068\u308a\u3042\u3048\u305a\u66f8\u3044\u3066\u307e\u3059\n\n\n\nPDO\u4f5c\u6210\u306e\u969b\u306butf8\u3092\u6307\u5b9a\u3059\u308b\n\nMySQL\u306e\u8a2d\u5b9a\u3092\u5909\u66f4\u3059\u308b\n\n\u3053\u3046\u306a\u3063\u3066\u305f\u3089\u52d5\u3044\u305f\n\n\nmysql> show variables like 'character_set_%';\n\n\n\nVariable_name\nValue\n\n\n\n\ncharacter_set_client\nutf8\n\n\ncharacter_set_connection\nutf8\n\n\ncharacter_set_database\nlatin1\n\n\ncharacter_set_filesystem\nutf8\n\n\ncharacter_set_results\nutf8\n\n\ncharacter_set_server\nutf8\n\n\ncharacter_set_system\nutf8\n\n\n\n\n\n\n\ntips\n\n\nSQL\u306e\u7d44\u307f\u7acb\u3066\u304b\u3089\u5b9f\u884c\u307e\u3067\n\nSQL\u6587\u3092prepare\u3059\u308b\n\u30d7\u30ec\u30fc\u30b9\u30db\u30eb\u30c0\u306b\u5909\u6570\u3092bindParam\u3059\u308b\n\nexecute\u3059\u308b\n\nwhile\u6587\u306e\u4e2d\u3067fetch\u3057\u3066\u4e00\u884c\u305a\u3064\u53d6\u308a\u51fa\u3059\n\n\n\n\n\u30d7\u30ec\u30fc\u30b9\u30db\u30eb\u30c0\u306bbindParam\u3092\u3059\u308b\u969b\u306b\u578b\u3092\u6307\u5b9a\u3067\u304d\u308b\n\n\u30c7\u30d5\u30a9\u30eb\u30c8\u3060\u3068\u6570\u5024\u3092\u5165\u308c\u305f\u3089\u6587\u5b57\u5217\u306b\u3055\u308c\u3066\u3057\u307e\u3046\n\u7b2c3\u5f15\u6570\u306bPDO::PARAM_INT\u3084PDO::PARAM_STR\u3092\u6307\u5b9a\u3059\u308c\u3070\u826f\u3044\n\n\n\nSQL\u3067\u30ab\u30e9\u30e0\u540d\u3092\u6307\u5b9a\u3059\u308b\u5834\u5408(FROM\u53e5\u3084ORDER BY\u53e5)\n\nsprintf\u3068\u304b\u3067\u6587\u5b57\u5217\u3068\u3057\u3066\u57cb\u3081\u8fbc\u3080\u5fc5\u8981\u304c\u3042\u308b\n\u30db\u30ef\u30a4\u30c8\u30ea\u30b9\u30c8\u3092\u4f5c\u3063\u3066\u5bfe\u51e6\u3059\u308b\n\n\n\u53c2\u8003\uff1ahttp://blog.a-way-out.net/blog/2013/12/19/sql-injection-prevention/\n\n\n\n\n\n\n$_GET\u306e\u30a8\u30b9\u30b1\u30fc\u30d7\n\n\nhtmlspecialchars()\u306fDB\u304b\u3089\u5f97\u305f\u7d50\u679c\u3092html\u3068\u3057\u3066\u51fa\u529b\u3059\u308b\u969b\u306b\u547c\u3076\u3068\u3044\u3044\u3089\u3057\u3044\n\u30d7\u30ec\u30fc\u30b9\u30db\u30eb\u30c0\u3092\u4f7f\u3063\u3066SQL\u3092\u7d44\u307f\u7acb\u3066\u308b\u5834\u5408\u306f\u5fc5\u8981\u306a\u3044\n\n\n\u81ea\u5206\u3067\u3084\u308b\u5834\u5408\u306fPDO::quote\u304c\u4f7f\u3048\u308b\u3063\u307d\u3044\u304c\u3001prepare\u3057\u307e\u3057\u3087\u3046\n\n\n\n\n\nbindParam\u3059\u308b\u5909\u6570\u306b\u6ce8\u610f\u3059\u308b\n\n\u540c\u3058\u5909\u6570\u3092\u66f8\u304d\u63db\u3048\u306a\u304c\u3089\u8907\u6570\u306e\u30d7\u30ec\u30fc\u30b9\u30db\u30eb\u30c0\u306bbindParam\u3059\u308b\u3068\u3001\u305d\u306e\u5909\u6570\u306e\u6700\u5f8c\u306e\u5024\u304c\u5168\u3066\u306e\u30d7\u30ec\u30fc\u30b9\u30db\u30eb\u30c0\u306b\u5165\u3063\u3066\u3057\u307e\u3046\n\n\n\u5b9f\u884c\u6642\u306b\u30d0\u30a4\u30f3\u30c9\u3055\u308c\u308b\u3063\u307d\u3044\n\n\n\nbindValue\u3092\u4f7f\u3048\u3070\u305d\u306e\u5834\u3067\u30d0\u30a4\u30f3\u30c9\u3055\u308c\u308b\n\n\n\nSELECT\u6587\u3092\u5b9f\u884c\u3057\u305f\u969b\u306e\u7d50\u679c\u6570\u3092\u53d6\u5f97\u3057\u305f\u3044\n\n\u5225\u3067SELECT COUNT(*)\u3092\u5b9f\u884c\u3057\u306a\u3044\u3068\u3060\u3081\u3063\u307d\u3044...\u306a\u3093\u3067\u3060\u3088...\n\n\n\n\nAND\u691c\u7d22\u3001OR\u691c\u7d22\n\n\nSQL\u3067\u306eAND\u691c\u7d22\u3068OR\u691c\u7d22\nselect * from product where name like \"hoge\" and (name like \"foo\" or name like \"bar\") limit 100 order by id;\n\n\n\u666e\u901a\u306band\u3068or\u3067like\u53e5\u3092\u7e4b\u3052\u305f\u3089\u51fa\u6765\u308b\n\n\n\n\n\u95a2\u6570\u304b\u3089\u8907\u6570\u306e\u8fd4\u308a\u5024\u3092\u8fd4\u3057\u3001\u53d7\u3051\u53d6\u308b\n\n\u8fd4\u308a\u5024\n\n\nreturn array($foo, $bar);\n\n\n\u53d7\u3051\u53d6\u308b\n\n\nlist($foo, $bar) = ...;\n\n\n\n\n\u30b3\u30fc\u30c9\n\n\nproduct\u30c6\u30fc\u30d6\u30eb\u304b\u3089where\u53e5\u3067name\u3067AND\u691c\u7d22\u3092\u3057\u3066\u3001limit\u3068order by\u3092\u6307\u5b9a\u3059\u308b\n\n\n\u6d41\u308c\n\n\n$_GET\u304b\u3089\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u53d6\u308a\u51fa\u3059\n\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\nAND\u691c\u7d22\u3092\u3059\u308b\u305f\u3081\u306b\u524d\u51e6\u7406\n\n\n\u3082\u3061\u308d\u3093\u30011\u5358\u8a9e\u306a\u3089AND\u691c\u7d22\u306b\u306f\u306a\u3089\u306a\u3044\n\n\n\nPDO\u306bSQL\u3092prepare\u3057\u3066\u30d7\u30ec\u30fc\u30b9\u30db\u30eb\u30c0\u306bbindParam\u3057\u3066execute\n\n\u7d50\u679c\u306e\u53d6\u5f97\n\n\nfunction.php\n\nfunctions.php\n<?php\nmb_internal_encoding('UTF-8');\nrequire('./_config.php');  // MySQL\u63a5\u7d9a\u7528\u306e\u5b9a\u6570\u3092\u5b9a\u7fa9\u3057\u3066\u3042\u308b\n\nfunction connectDB() {\n  // DB\u63a5\u7d9a\u7528\n  try {\n    // utf8\u3067\u63a5\u7d9a\u3059\u308b\n    $data_source =\n      sprintf(\"mysql:dbname=%s;host=%s;charset=%s\", DB_NAME, DB_HOST, \"utf8\");\n    $pdo = new PDO($data_source , DB_USERNAME, DB_PASSWD);\n    return $pdo;\n  } catch (PDOException $e) {\n    var_dump($e->getMessage());\n    exit('cannot connect to database');\n  }\n}\n\n\n\n\n\nsearch.php\n\nsearch.php\n<?php\nmb_internal_encoding('UTF-8');\nrequire_once('./functions.php');\n\nfunction productSearchAPI() {\n  // $_GET\u304b\u3089\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u53d6\u308a\u51fa\u3057\u3066\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\n  list($params, $paramsType) = getValidParamater($_GET);\n  if ($params[\":query\"] === \"\") {\n    exit(\"invalid query...\");\n  }\n  // SQL\u3092\u7d44\u307f\u7acb\u3066\u3066\u5b9f\u884c\n  $results = doSearch($params, $paramsType);  \n}\n\nfunction getValidParamater($params){\n  // GET\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u30c1\u30a7\u30c3\u30af\u3059\u308b\n  if(isset($params['query']) && is_string($params['query'])) {\n    // \u5168\u89d2\u30b9\u30da\u30fc\u30b9 => \u534a\u89d2\n    $query = $params['query'];\n    $query = str_replace(\"\u3000\", \" \", $query);\n  } else {\n    $query = \"\";\n  }\n\n  if(isset($params['limit']) && is_int($params['limit'])) {\n    $limit = $params['limit'];\n  } else {\n    $limit = 100;\n  }\n  if(isset($params['orderBy']) && is_string($params['orderBy'])) {\n    $orderBy = $params['orderBy'];\n  } else {\n    $orderBy = \"id\";\n  }\n\n  $valid_params = array(\n    \":query\" => $query,\n    \":orderBy\" => $orderBy,\n    \":limit\" => $limit\n  );\n  $paramsType = array(\n    \":query\" => PDO::PARAM_STR,\n    \":limit\" => PDO::PARAM_INT\n  );\n  // \u8907\u6570\u306e\u5024\u3092\u8fd4\u3059\n  return array($valid_params, $paramsType);\n}\n\nfunction whiteOrder($order) {\n    // ORDER BY\u53e5\u306b\u5165\u308c\u308b\u305f\u3081\u306e\u30db\u30ef\u30a4\u30c8\u30ea\u30b9\u30c8\n   if (in_array($order, array(\"id\", \"name\", \"detail\"))) {\n        return $order;\n    } else {\n        return \"id\";\n    }\n}\n\nfunction makeQuery($dbh, $params, $paramsType) {\n  // SQL\u3092\u7d44\u307f\u7acb\u3066\u308b\n  // \u3082\u3068\u3068\u306a\u308bSQL\n  $sql = \"SELECT name, detail FROM product WHERE\";\n  // \u3042\u3068\u3067\u4ed8\u3051\u8db3\u3059SQL\n  // \u30ab\u30e9\u30e0\u540d\u3092\u6307\u5b9a\u3059\u308b\u306b\u306f\u6587\u5b57\u5217\u3068\u3057\u3066\u57cb\u3081\u8fbc\u3080\u5fc5\u8981\u304c\u3042\u308b\n  $orderSql = \" ORDER BY \".whiteOrder($params[\":orderBy\"]).\" LIMIT :limit\";\n\n  $query = $params[\":query\"];\n  if(stristr($query, \" \")){\n    // \u30af\u30a8\u30ea\u306b\u30b9\u30da\u30fc\u30b9\u3092\u542b\u3080\u6642\n    $queries = explode(\" \", $query);\n    $queryCount = count($queries);\n\n    for ($i = 0; $i < $queryCount; $i++) {\n      // \u6700\u521d\u306fAND\u3092\u4ed8\u3051\u306a\u3044\n      if($i != 0){\n        $sql .= \" AND\";\n      }\n      // placeholder\u306b\u756a\u53f7\u3092\u4ed8\u3051\u308b\n      $sql .= \" name LIKE :query\".$i;\n    }\n  } else {\n    // \u30b9\u30da\u30fc\u30b9\u304c\u7121\u3044\u6642\n    $queryCount = 1;\n  }\n\n  // sql\u306e:query\u306b\u5358\u8a9e\u3092bind\u3059\u308b\n  if ($queryCount == 1) {\n    // \u5358\u5358\u8a9e\u30af\u30a8\u30ea\n    $sql = $sql.\" name LIKE :query\".$orderSql;\n    $query = '%'.$query.'%';\n    $stmt = $dbh->prepare($sql);\n    $stmt->bindParam(':query', $query, $paramsType[\":query\"]);\n  } else {\n    // \u8907\u5358\u8a9e\u30af\u30a8\u30ea\n    $sql .= $orderSql;\n    $stmt = $dbh->prepare($sql);\n    for($i = 0; $i < $queryCount; $i++) {\n      // placeholder\u306f:query0, :query1\u3068\u306a\u3063\u3066\u3044\u308b\n      $placeholder = ':query'.$i;\n      $queries[$i] = '%'.$queries[$i].'%';\n      $stmt->bindParam($placeholder, $queries[$i], $paramsType[\":query\"]);\n      /*\n      $_query = '%'.$queries[$i].'%';\n      $stmt->bindParam($placeholder, $_query, $paramsType[\":query\"]);\n      \u3068\u3059\u308b\u3068\u3001\u5b9f\u884c\u6642\u306e$_query\u306e\u53c2\u7167\u5148\u304c\u5168\u3066$queries[$queryCount-1]\u306b\u306a\u3063\u3066\u3057\u307e\u3046\n      bindValue\u306b\u3059\u308c\u3070\u4e0a\u306e$_query\u3092\u4f7f\u3063\u3066\u554f\u984c\u306a\u3044\n      */\n    }\n  }\n\n  // \u5f8c\u308d\u306elimit\u53e5\u306b\u30d0\u30a4\u30f3\u30c9\n  $stmt->bindParam(':limit', $params[\":limit\"], $paramsType[\":limit\"]);\n  return $stmt;\n}\n\nfunction doSearch($params, $paramsType) {\n  // SQL\u3092\u7d44\u307f\u7acb\u3066\u3066\u5b9f\u884c\n  $dbh = connectDB();\n  $stmt = makeQuery($dbh, $params, $paramsType);\n  $ret = $stmt->execute();\n\n  // sql\u3092\u78ba\u8a8d\u3067\u304d\u308b\n  // $stmt->debugDumpParams();\n\n  if (!$ret) {\n    $err = $dbh->errorInfo();\n    exit('SELECT \u5931\u6557\uff1a' . $err[2] . var_dump($params));\n  }\n\n  $results = makeResult($stmt);\n  // \u63a5\u7d9a\u3092\u9589\u3058\u308b\n  $dbh = null;\n  return $results;\n}\n\nfunction makeResult($stmt) {\n  // MySQL\u304b\u3089\u8fd4\u3063\u3066\u304d\u305f\u5024\u3092\u8f9e\u66f8\u306b\u683c\u7d0d\u3059\u308b\n  // \u53d6\u5f97\u7d50\u679c\u306f\u30ab\u30e9\u30e0\u540d\u3092\u30ad\u30fc\u3068\u3059\u308b\u8f9e\u66f8\u306b\u306a\u3063\u3066\u3044\u308b\n  $names = [];\n  while($row = $stmt->fetch()) {\n    $names[] = trim($row[\"name\"]);\n    $details[] = trim($row[\"detail\"]);\n  }\n  // \u7d50\u679c\u304c\u7121\u3044\u5834\u5408\n  // select count(*)\u3059\u308b\u306e\u304c\u5acc\u3060\u3063\u305f\n  if ($names === []) {\n    return [];\n  }\n  $results = array(\n    'names' => $names,\n    'details' => $details\n  );\n  return $results;\n}\n?>\n\n\n\n\n\u611f\u60f3\nPHP\u3042\u3093\u307e\u308a\u6163\u308c\u3066\u306a\u3044\u3057\u9593\u9055\u3063\u3066\u308b\u304b\u3082\u77e5\u308c\u306a\u3044\n\u30b3\u30fc\u30c9\u304c\u3042\u3093\u307e\u308a\u7dba\u9e97\u306a\u5206\u5272\u3058\u3083\u306a\u304f\u3066\u6c17\u6301\u3061\u60aa\u3044\u3051\u3069\u3001\u3068\u308a\u3042\u3048\u305a\u8981\u4ef6\u306f\u6e80\u305f\u305b\u308b\u306f\u305a\n\u578b\u3092\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u306a\u3051\u308c\u3070\n$stmt->execute($params)\n\n\u3068\u51fa\u6765\u308b\u304c\u3001\u578b\u3092\u6307\u5b9a\u3059\u308b\u306b\u306f\u3044\u3061\u3044\u3061bindParam\u3057\u306a\u3044\u3068\u3060\u3081\u3067\u3081\u3093\u3069\u304f\u3055\u3044\n\n# \u6982\u8981\n\n- \u65e5\u672c\u8a9e\u3067\u691c\u7d22\n- GET\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u30ad\u30fc\u30ef\u30fc\u30c9\u3068\u3057\u3066\u691c\u7d22\n- PDO\u4f7f\u3063\u3066MySQL\u306b\u63a5\u7d9a\u3057\u3001\u30d7\u30ec\u30fc\u30b9\u30db\u30eb\u30c0\u3092\u4f7f\u3063\u3066SQL\u3092\u69cb\u7bc9\u3059\u308b\n- \u53ef\u5909\u9577\u306aAND(OR)\u691c\u7d22\n\n# \u30dd\u30a4\u30f3\u30c8\n\n## \u65e5\u672c\u8a9e\u5bfe\u7b56\n\n- `mb_internal_encoding('UTF-8');`\u3092\u30d5\u30a1\u30a4\u30eb\u306e\u5148\u982d\u306b\u66f8\u304f\n  - \u4eca\u56de\u306f\u7279\u306b\u95a2\u4fc2\u306a\u3044\u3063\u307d\u3044\u3067\u3059\u304c\u3001\u3068\u308a\u3042\u3048\u305a\u66f8\u3044\u3066\u307e\u3059\n- `PDO`\u4f5c\u6210\u306e\u969b\u306b`utf8`\u3092\u6307\u5b9a\u3059\u308b\n- MySQL\u306e\u8a2d\u5b9a\u3092\u5909\u66f4\u3059\u308b\n  - \u3053\u3046\u306a\u3063\u3066\u305f\u3089\u52d5\u3044\u305f\n\n\t>mysql> show variables like 'character_set_%';\n\n\t>| Variable_name            | Value                                     |\n|:-------------------------|:------------------------------------------|\n| character_set_client     | utf8                                      |\n| character_set_connection | utf8                                      |\n| character_set_database   | latin1                                    |\n| character_set_filesystem | utf8                                      |\n| character_set_results    | utf8                                      |\n| character_set_server     | utf8                                      |\n| character_set_system     | utf8                                      |\n\n\n## tips\n\n- SQL\u306e\u7d44\u307f\u7acb\u3066\u304b\u3089\u5b9f\u884c\u307e\u3067\n\t1. SQL\u6587\u3092`prepare`\u3059\u308b\n\t1. \u30d7\u30ec\u30fc\u30b9\u30db\u30eb\u30c0\u306b\u5909\u6570\u3092`bindParam`\u3059\u308b\n\t1. `execute`\u3059\u308b\n\t1. `while`\u6587\u306e\u4e2d\u3067`fetch`\u3057\u3066\u4e00\u884c\u305a\u3064\u53d6\u308a\u51fa\u3059  \n\n- \u30d7\u30ec\u30fc\u30b9\u30db\u30eb\u30c0\u306b`bindParam`\u3092\u3059\u308b\u969b\u306b\u578b\u3092\u6307\u5b9a\u3067\u304d\u308b\n\t- \u30c7\u30d5\u30a9\u30eb\u30c8\u3060\u3068\u6570\u5024\u3092\u5165\u308c\u305f\u3089\u6587\u5b57\u5217\u306b\u3055\u308c\u3066\u3057\u307e\u3046\n\t- \u7b2c3\u5f15\u6570\u306b`PDO::PARAM_INT`\u3084`PDO::PARAM_STR`\u3092\u6307\u5b9a\u3059\u308c\u3070\u826f\u3044\n\n- SQL\u3067\u30ab\u30e9\u30e0\u540d\u3092\u6307\u5b9a\u3059\u308b\u5834\u5408(FROM\u53e5\u3084ORDER BY\u53e5)\n\t- sprintf\u3068\u304b\u3067\u6587\u5b57\u5217\u3068\u3057\u3066\u57cb\u3081\u8fbc\u3080\u5fc5\u8981\u304c\u3042\u308b\n\t- \u30db\u30ef\u30a4\u30c8\u30ea\u30b9\u30c8\u3092\u4f5c\u3063\u3066\u5bfe\u51e6\u3059\u308b\n\t\t- \u53c2\u8003\uff1ahttp://blog.a-way-out.net/blog/2013/12/19/sql-injection-prevention/\n\n- $_GET\u306e\u30a8\u30b9\u30b1\u30fc\u30d7\n\t- `htmlspecialchars()`\u306fDB\u304b\u3089\u5f97\u305f\u7d50\u679c\u3092html\u3068\u3057\u3066\u51fa\u529b\u3059\u308b\u969b\u306b\u547c\u3076\u3068\u3044\u3044\u3089\u3057\u3044\n\t- \u30d7\u30ec\u30fc\u30b9\u30db\u30eb\u30c0\u3092\u4f7f\u3063\u3066SQL\u3092\u7d44\u307f\u7acb\u3066\u308b\u5834\u5408\u306f\u5fc5\u8981\u306a\u3044\n\t\t- \u81ea\u5206\u3067\u3084\u308b\u5834\u5408\u306f`PDO::quote`\u304c\u4f7f\u3048\u308b\u3063\u307d\u3044\u304c\u3001`prepare`\u3057\u307e\u3057\u3087\u3046\n\n- `bindParam`\u3059\u308b\u5909\u6570\u306b\u6ce8\u610f\u3059\u308b\n\t- \u540c\u3058\u5909\u6570\u3092\u66f8\u304d\u63db\u3048\u306a\u304c\u3089\u8907\u6570\u306e\u30d7\u30ec\u30fc\u30b9\u30db\u30eb\u30c0\u306b`bindParam`\u3059\u308b\u3068\u3001\u305d\u306e\u5909\u6570\u306e\u6700\u5f8c\u306e\u5024\u304c\u5168\u3066\u306e\u30d7\u30ec\u30fc\u30b9\u30db\u30eb\u30c0\u306b\u5165\u3063\u3066\u3057\u307e\u3046\n\t\t- \u5b9f\u884c\u6642\u306b\u30d0\u30a4\u30f3\u30c9\u3055\u308c\u308b\u3063\u307d\u3044\n\t- `bindValue`\u3092\u4f7f\u3048\u3070\u305d\u306e\u5834\u3067\u30d0\u30a4\u30f3\u30c9\u3055\u308c\u308b\n\n- `SELECT`\u6587\u3092\u5b9f\u884c\u3057\u305f\u969b\u306e\u7d50\u679c\u6570\u3092\u53d6\u5f97\u3057\u305f\u3044\n\t- \u5225\u3067`SELECT COUNT(*)`\u3092\u5b9f\u884c\u3057\u306a\u3044\u3068\u3060\u3081\u3063\u307d\u3044...\u306a\u3093\u3067\u3060\u3088...\n\n### AND\u691c\u7d22\u3001OR\u691c\u7d22\n\n- SQL\u3067\u306eAND\u691c\u7d22\u3068OR\u691c\u7d22\n\n    ```sql\n    select * from product where name like \"hoge\" and (name like \"foo\" or name like \"bar\") limit 100 order by id;\n\t```\n\n\t- \u666e\u901a\u306b`and`\u3068`or`\u3067`like`\u53e5\u3092\u7e4b\u3052\u305f\u3089\u51fa\u6765\u308b\n\n### \u95a2\u6570\u304b\u3089\u8907\u6570\u306e\u8fd4\u308a\u5024\u3092\u8fd4\u3057\u3001\u53d7\u3051\u53d6\u308b\n\n- \u8fd4\u308a\u5024\n\t- `return array($foo, $bar);`\n- \u53d7\u3051\u53d6\u308b\n\t- `list($foo, $bar) = ...;`\n\n# \u30b3\u30fc\u30c9\n\n1. `product`\u30c6\u30fc\u30d6\u30eb\u304b\u3089`where`\u53e5\u3067`name`\u3067AND\u691c\u7d22\u3092\u3057\u3066\u3001`limit`\u3068`order by`\u3092\u6307\u5b9a\u3059\u308b\n\n### \u6d41\u308c\n1. `$_GET`\u304b\u3089\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u53d6\u308a\u51fa\u3059\n1. \u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\n1. AND\u691c\u7d22\u3092\u3059\u308b\u305f\u3081\u306b\u524d\u51e6\u7406\n\t- \u3082\u3061\u308d\u3093\u30011\u5358\u8a9e\u306a\u3089AND\u691c\u7d22\u306b\u306f\u306a\u3089\u306a\u3044\n1. `PDO`\u306bSQL\u3092`prepare`\u3057\u3066\u30d7\u30ec\u30fc\u30b9\u30db\u30eb\u30c0\u306b`bindParam`\u3057\u3066`execute`\n1. \u7d50\u679c\u306e\u53d6\u5f97\n\n\n### function.php\n\n```php:functions.php\n<?php\nmb_internal_encoding('UTF-8');\nrequire('./_config.php');  // MySQL\u63a5\u7d9a\u7528\u306e\u5b9a\u6570\u3092\u5b9a\u7fa9\u3057\u3066\u3042\u308b\n\nfunction connectDB() {\n  // DB\u63a5\u7d9a\u7528\n  try {\n    // utf8\u3067\u63a5\u7d9a\u3059\u308b\n    $data_source =\n      sprintf(\"mysql:dbname=%s;host=%s;charset=%s\", DB_NAME, DB_HOST, \"utf8\");\n    $pdo = new PDO($data_source , DB_USERNAME, DB_PASSWD);\n    return $pdo;\n  } catch (PDOException $e) {\n    var_dump($e->getMessage());\n    exit('cannot connect to database');\n  }\n}\n\n\n```\n\n### search.php\n\n```php:search.php\n<?php\nmb_internal_encoding('UTF-8');\nrequire_once('./functions.php');\n\nfunction productSearchAPI() {\n  // $_GET\u304b\u3089\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u53d6\u308a\u51fa\u3057\u3066\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\n  list($params, $paramsType) = getValidParamater($_GET);\n  if ($params[\":query\"] === \"\") {\n    exit(\"invalid query...\");\n  }\n  // SQL\u3092\u7d44\u307f\u7acb\u3066\u3066\u5b9f\u884c\n  $results = doSearch($params, $paramsType);  \n}\n\nfunction getValidParamater($params){\n  // GET\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u30c1\u30a7\u30c3\u30af\u3059\u308b\n  if(isset($params['query']) && is_string($params['query'])) {\n    // \u5168\u89d2\u30b9\u30da\u30fc\u30b9 => \u534a\u89d2\n    $query = $params['query'];\n    $query = str_replace(\"\u3000\", \" \", $query);\n  } else {\n    $query = \"\";\n  }\n\n  if(isset($params['limit']) && is_int($params['limit'])) {\n    $limit = $params['limit'];\n  } else {\n    $limit = 100;\n  }\n  if(isset($params['orderBy']) && is_string($params['orderBy'])) {\n    $orderBy = $params['orderBy'];\n  } else {\n    $orderBy = \"id\";\n  }\n\n  $valid_params = array(\n    \":query\" => $query,\n    \":orderBy\" => $orderBy,\n    \":limit\" => $limit\n  );\n  $paramsType = array(\n    \":query\" => PDO::PARAM_STR,\n    \":limit\" => PDO::PARAM_INT\n  );\n  // \u8907\u6570\u306e\u5024\u3092\u8fd4\u3059\n  return array($valid_params, $paramsType);\n}\n\nfunction whiteOrder($order) {\n\t// ORDER BY\u53e5\u306b\u5165\u308c\u308b\u305f\u3081\u306e\u30db\u30ef\u30a4\u30c8\u30ea\u30b9\u30c8\n   if (in_array($order, array(\"id\", \"name\", \"detail\"))) {\n\t\treturn $order;\n\t} else {\n\t\treturn \"id\";\n\t}\n}\n\nfunction makeQuery($dbh, $params, $paramsType) {\n  // SQL\u3092\u7d44\u307f\u7acb\u3066\u308b\n  // \u3082\u3068\u3068\u306a\u308bSQL\n  $sql = \"SELECT name, detail FROM product WHERE\";\n  // \u3042\u3068\u3067\u4ed8\u3051\u8db3\u3059SQL\n  // \u30ab\u30e9\u30e0\u540d\u3092\u6307\u5b9a\u3059\u308b\u306b\u306f\u6587\u5b57\u5217\u3068\u3057\u3066\u57cb\u3081\u8fbc\u3080\u5fc5\u8981\u304c\u3042\u308b\n  $orderSql = \" ORDER BY \".whiteOrder($params[\":orderBy\"]).\" LIMIT :limit\";\n\n  $query = $params[\":query\"];\n  if(stristr($query, \" \")){\n    // \u30af\u30a8\u30ea\u306b\u30b9\u30da\u30fc\u30b9\u3092\u542b\u3080\u6642\n    $queries = explode(\" \", $query);\n    $queryCount = count($queries);\n\n    for ($i = 0; $i < $queryCount; $i++) {\n      // \u6700\u521d\u306fAND\u3092\u4ed8\u3051\u306a\u3044\n      if($i != 0){\n        $sql .= \" AND\";\n      }\n      // placeholder\u306b\u756a\u53f7\u3092\u4ed8\u3051\u308b\n      $sql .= \" name LIKE :query\".$i;\n    }\n  } else {\n    // \u30b9\u30da\u30fc\u30b9\u304c\u7121\u3044\u6642\n    $queryCount = 1;\n  }\n\n  // sql\u306e:query\u306b\u5358\u8a9e\u3092bind\u3059\u308b\n  if ($queryCount == 1) {\n    // \u5358\u5358\u8a9e\u30af\u30a8\u30ea\n    $sql = $sql.\" name LIKE :query\".$orderSql;\n    $query = '%'.$query.'%';\n    $stmt = $dbh->prepare($sql);\n    $stmt->bindParam(':query', $query, $paramsType[\":query\"]);\n  } else {\n    // \u8907\u5358\u8a9e\u30af\u30a8\u30ea\n    $sql .= $orderSql;\n    $stmt = $dbh->prepare($sql);\n    for($i = 0; $i < $queryCount; $i++) {\n      // placeholder\u306f:query0, :query1\u3068\u306a\u3063\u3066\u3044\u308b\n      $placeholder = ':query'.$i;\n      $queries[$i] = '%'.$queries[$i].'%';\n      $stmt->bindParam($placeholder, $queries[$i], $paramsType[\":query\"]);\n      /*\n      $_query = '%'.$queries[$i].'%';\n      $stmt->bindParam($placeholder, $_query, $paramsType[\":query\"]);\n      \u3068\u3059\u308b\u3068\u3001\u5b9f\u884c\u6642\u306e$_query\u306e\u53c2\u7167\u5148\u304c\u5168\u3066$queries[$queryCount-1]\u306b\u306a\u3063\u3066\u3057\u307e\u3046\n      bindValue\u306b\u3059\u308c\u3070\u4e0a\u306e$_query\u3092\u4f7f\u3063\u3066\u554f\u984c\u306a\u3044\n      */\n    }\n  }\n\n  // \u5f8c\u308d\u306elimit\u53e5\u306b\u30d0\u30a4\u30f3\u30c9\n  $stmt->bindParam(':limit', $params[\":limit\"], $paramsType[\":limit\"]);\n  return $stmt;\n}\n\nfunction doSearch($params, $paramsType) {\n  // SQL\u3092\u7d44\u307f\u7acb\u3066\u3066\u5b9f\u884c\n  $dbh = connectDB();\n  $stmt = makeQuery($dbh, $params, $paramsType);\n  $ret = $stmt->execute();\n\n  // sql\u3092\u78ba\u8a8d\u3067\u304d\u308b\n  // $stmt->debugDumpParams();\n\n  if (!$ret) {\n    $err = $dbh->errorInfo();\n    exit('SELECT \u5931\u6557\uff1a' . $err[2] . var_dump($params));\n  }\n\n  $results = makeResult($stmt);\n  // \u63a5\u7d9a\u3092\u9589\u3058\u308b\n  $dbh = null;\n  return $results;\n}\n\nfunction makeResult($stmt) {\n  // MySQL\u304b\u3089\u8fd4\u3063\u3066\u304d\u305f\u5024\u3092\u8f9e\u66f8\u306b\u683c\u7d0d\u3059\u308b\n  // \u53d6\u5f97\u7d50\u679c\u306f\u30ab\u30e9\u30e0\u540d\u3092\u30ad\u30fc\u3068\u3059\u308b\u8f9e\u66f8\u306b\u306a\u3063\u3066\u3044\u308b\n  $names = [];\n  while($row = $stmt->fetch()) {\n    $names[] = trim($row[\"name\"]);\n    $details[] = trim($row[\"detail\"]);\n  }\n  // \u7d50\u679c\u304c\u7121\u3044\u5834\u5408\n  // select count(*)\u3059\u308b\u306e\u304c\u5acc\u3060\u3063\u305f\n  if ($names === []) {\n    return [];\n  }\n  $results = array(\n    'names' => $names,\n    'details' => $details\n  );\n  return $results;\n}\n?>\n\n```\n\n\n### \u611f\u60f3\nPHP\u3042\u3093\u307e\u308a\u6163\u308c\u3066\u306a\u3044\u3057\u9593\u9055\u3063\u3066\u308b\u304b\u3082\u77e5\u308c\u306a\u3044\n\u30b3\u30fc\u30c9\u304c\u3042\u3093\u307e\u308a\u7dba\u9e97\u306a\u5206\u5272\u3058\u3083\u306a\u304f\u3066\u6c17\u6301\u3061\u60aa\u3044\u3051\u3069\u3001\u3068\u308a\u3042\u3048\u305a\u8981\u4ef6\u306f\u6e80\u305f\u305b\u308b\u306f\u305a\n\n\u578b\u3092\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u306a\u3051\u308c\u3070\n\n```php\n$stmt->execute($params)\n```\n\u3068\u51fa\u6765\u308b\u304c\u3001\u578b\u3092\u6307\u5b9a\u3059\u308b\u306b\u306f\u3044\u3061\u3044\u3061`bindParam`\u3057\u306a\u3044\u3068\u3060\u3081\u3067\u3081\u3093\u3069\u304f\u3055\u3044\n", "tags": ["PHP", "PDO"]}