{"context": "\n\n\u3084\u308a\u305f\u3044\u3053\u3068\n\nnginx\u306eaccesslog\u3092S3\u306b\u8caf\u3081\u305f\u3044\n\n\ntd-agent install\n$ curl -L https://toolbelt.treasuredata.com/sh/install-redhat-td-agent2.sh | sh\n\n\nS3 output\u30d7\u30e9\u30b0\u30a4\u30f3\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ sudo /opt/td-agent/embedded/bin/fluent-gem update\n$ sudo /opt/td-agent/embedded/bin/fluent-gem install fluent-plugin-s3\n$ sudo /usr/lib64/fluent/ruby/bin/fluent-gem install fluent-plugin-forest\n\n\ntd-agent.conf\u306e\u7de8\u96c6 /etc/td-agent/td-agent.conf\n<source>\n  type config_expander\n  <config>\n    type tail\n    # format nginx\n    format /^(?<remote>[^ ]*) (?<host>[^ ]*) (?<user>[^ ]*) \\[(?<time>[^\\]]*)\\] \"(?<method>\\S+)(?: +(?<path>[^ ]*) +\\S*)?\" (?<code>[^ ]*) (?<size>[^ ]*)(?: \"(?<referer>[^\\\"]*)\" \"(?<agent>[^\\\"]*)\" \"(?<forwarder>[^\\\"]*)\")?/\n    time_format %d/%b/%Y:%H:%M:%S %z\n    pos_file /var/log/td-agent/access.log.pos\n    path /var/log/nginx/access.log\n    tag ${hostname}/nginx.access\n  </config>\n</source>\n<source>\n  type config_expander\n  <config>\n    type tail\n    format /^[[^ ]* (?<time>[^]]*)] [(?<level>[^]]*)] (?<message>.*)$/\n    time_format %b %d %H:%M:%S\n    pos_file /var/log/td-agent/error.log.pos\n    path /var/log/nginx/error.log\n    tag ${hostname}/nginx.error\n  </config>\n</source>\n\n<source>\n  type config_expander\n  <config>\n    type tail\n    format syslog\n    pos_file /var/log/td-agent/syslog.pos\n    path /var/log/messages\n    tag ${hostname}/syslog.messages\n  </config>\n</source>\n\n<match *.**>\n  type forest\n  subtype s3\n   <template>\n     # /etc/sysconfig/td-agent\n     aws_key_id \"#{ENV['AWS_KEY_ID']}\" \n     aws_sec_key \"#{ENV['AWS_SECRET_KEY']}\"\n     s3_bucket fluent-log-test\n\n     path\n     buffer_path /var/log/td-agent/buffer/${tag}\n     time_slice_format %Y/%m/%d/${tag}/ec2-%Y-%m-%d-%H\n     retry_wait 30s\n     retry_limit 5\n     flush_interval 1s\n     flush_at_shutdown true\n   </template>\n</match>\n\n\nAWS\u8a2d\u5b9a /etc/sysconfig/td-agent\nexport AWS_KEY_ID=\"xxxxxxxxx\"\nexport AWS_SECRET_KEY=\"xxxxxxxxxxxx\"\n\n\ntd-agent \u8d77\u52d5\nservice td-agent start\n\n\n# \u3084\u308a\u305f\u3044\u3053\u3068\n* nginx\u306eaccesslog\u3092S3\u306b\u8caf\u3081\u305f\u3044\n\n\n#### td-agent install \n\n```\n$ curl -L https://toolbelt.treasuredata.com/sh/install-redhat-td-agent2.sh | sh\n```\n#### S3 output\u30d7\u30e9\u30b0\u30a4\u30f3\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n```\n$ sudo /opt/td-agent/embedded/bin/fluent-gem update\n$ sudo /opt/td-agent/embedded/bin/fluent-gem install fluent-plugin-s3\n$ sudo /usr/lib64/fluent/ruby/bin/fluent-gem install fluent-plugin-forest\n```\n\n#### td-agent.conf\u306e\u7de8\u96c6 /etc/td-agent/td-agent.conf\n\n```\n<source>\n  type config_expander\n  <config>\n    type tail\n    # format nginx\n    format /^(?<remote>[^ ]*) (?<host>[^ ]*) (?<user>[^ ]*) \\[(?<time>[^\\]]*)\\] \"(?<method>\\S+)(?: +(?<path>[^ ]*) +\\S*)?\" (?<code>[^ ]*) (?<size>[^ ]*)(?: \"(?<referer>[^\\\"]*)\" \"(?<agent>[^\\\"]*)\" \"(?<forwarder>[^\\\"]*)\")?/\n    time_format %d/%b/%Y:%H:%M:%S %z\n    pos_file /var/log/td-agent/access.log.pos\n    path /var/log/nginx/access.log\n    tag ${hostname}/nginx.access\n  </config>\n</source>\n<source>\n  type config_expander\n  <config>\n    type tail\n    format /^[[^ ]* (?<time>[^]]*)] [(?<level>[^]]*)] (?<message>.*)$/\n    time_format %b %d %H:%M:%S\n    pos_file /var/log/td-agent/error.log.pos\n    path /var/log/nginx/error.log\n    tag ${hostname}/nginx.error\n  </config>\n</source>\n\n<source>\n  type config_expander\n  <config>\n    type tail\n    format syslog\n    pos_file /var/log/td-agent/syslog.pos\n    path /var/log/messages\n    tag ${hostname}/syslog.messages\n  </config>\n</source>\n\n<match *.**>\n  type forest\n  subtype s3\n   <template>\n     # /etc/sysconfig/td-agent\n     aws_key_id \"#{ENV['AWS_KEY_ID']}\" \n     aws_sec_key \"#{ENV['AWS_SECRET_KEY']}\"\n     s3_bucket fluent-log-test\n\n     path\n     buffer_path /var/log/td-agent/buffer/${tag}\n     time_slice_format %Y/%m/%d/${tag}/ec2-%Y-%m-%d-%H\n     retry_wait 30s\n     retry_limit 5\n     flush_interval 1s\n     flush_at_shutdown true\n   </template>\n</match>\n```\n\n#### AWS\u8a2d\u5b9a /etc/sysconfig/td-agent\n```\nexport AWS_KEY_ID=\"xxxxxxxxx\"\nexport AWS_SECRET_KEY=\"xxxxxxxxxxxx\"\n```\n\n\n#### td-agent \u8d77\u52d5\n\n```\nservice td-agent start\n```\n\n\n\n\n", "tags": ["td-agent", "fluentd", "S3", "nginx"]}