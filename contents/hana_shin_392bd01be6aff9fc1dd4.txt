{"context": "\n\n1. \u30db\u30b9\u30c8\u7248\u6570\u3001Docker\u7248\u6570\n[root@master1 ~]# cat /etc/redhat-release\nCentOS Linux release 7.2.1511 (Core)\n\n[root@master1 ~]# docker -v\nDocker version 1.10.3, build cb079f6-unsupported\n\n\n\n2. \u57fa\u672c\u7de8\n\n2.1 Docker\u30b3\u30de\u30f3\u30c9\u306e\u30d8\u30eb\u30d7\u306e\u4f7f\u3044\u65b9\ndocker\u30b3\u30de\u30f3\u30c9\u306b--help\u3092\u6307\u5b9a\u3059\u308b\u3002attach\u7b49\u306e\u30b5\u30d6\u30b3\u30de\u30f3\u30c9\u4e00\u89a7\u304c\u8868\u793a\u3055\u308c\u308b\u3002\n[root@master1 ~]# docker --help\n-\u4e2d\u7565-\nCommands:\n    attach    Attach to a running container\n    build     Build an image from a Dockerfile\n\u4ee5\u4e0b\u3001\u7565\n\n\n\u30b5\u30d6\u30b3\u30de\u30f3\u30c9\u306b--help\u3092\u6307\u5b9a\u3059\u308b\u3002\n[root@master1 ~]# docker attach --help\n\nUsage:  docker attach [OPTIONS] CONTAINER\n\nAttach to a running container\n\n  --detach-keys       Override the key sequence for detaching a container\n  --help              Print usage\n  --no-stdin          Do not attach STDIN\n  --sig-proxy=true    Proxy all received signals to the process\n[root@master1 ~]#\n\nnetwork\u30b5\u30d6\u30b3\u30de\u30f3\u30c9\u306f\u3001network\u30b5\u30d6\u30b3\u30de\u30f3\u30c9\u306e\u4e0b\u306b\u3001\u3055\u3089\u306b\u30b5\u30d6\u30b3\u30de\u30f3\u30c9\u304c\u3042\u308b\u3002\n[root@master1 ~]# docker network ls --help\n\nUsage:  docker network ls [OPTIONS]\n\nLists networks\n\n  -f, --filter=[]    Filter output based on conditions provided\n  --help             Print usage\n  --no-trunc         Do not truncate the output\n  -q, --quiet        Only display numeric IDs\n[root@master1 ~]#\n\n\n\n3. \u5fdc\u7528\u7de8\n\n3.1 Docker\u30ec\u30b8\u30b9\u30c8\u30ea\u3092\u4f7f\u3046(\u30a4\u30e1\u30fc\u30b8\u306e\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\uff0f\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9)\n\n------------------------------------------------------\n1. \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u7de8\u96c6(/etc/sysconfig/docker)\n------------------------------------------------------\n\u5b9a\u7fa9\u30d5\u30a1\u30a4\u30eb\u3092\u7de8\u96c6\u3059\u308b\u3002\n[root@master1 ~]# vi /etc/sysconfig/docker\n\n\u3010\u5909\u66f4\u524d\u3011\nINSECURE_REGISTRY='--insecure-registry'\n\n\u3010\u5909\u66f4\u5f8c\u3011\nINSECURE_REGISTRY='--insecure-registry master1:12345'\n\n  --insecure-registry <\u30db\u30b9\u30c8\u540d>:<TCP\u30dd\u30fc\u30c8\u756a\u53f7>\n\n   \u30db\u30b9\u30c8\u540d:docker\u30c7\u30fc\u30e2\u30f3\u304c\u52d5\u4f5c\u3057\u3066\u3044\u308b\u30db\u30b9\u30c8\u540d\u3092\u6307\u5b9a\u3059\u308b\u3002\n             /etc/hosts\u306b\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u308b\u540d\u524d\u3092\u6307\u5b9a\u3059\u308b\u3002\n   \u30dd\u30fc\u30c8\u756a\u53f7:\u30db\u30b9\u30c8\u306eTCP\u30dd\u30fc\u30c8\u756a\u53f7\u3092\u6307\u5b9a\u3059\u308b\u3002\n              \u65e2\u5b58\u30dd\u30fc\u30c8\u756a\u53f7\u3068\u91cd\u8907\u3057\u306a\u3044\u3088\u3046\u306b\u9078\u629e\u3059\u308b\u3002\n\n\n\u8a2d\u5b9a\u5909\u66f4\u3057\u305f\u3089docker\u3092\u518d\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# systemctl restart docker\n\n\n------------------------------------------------------\n2. Docker\u30ec\u30b8\u30b9\u30c8\u30ea\u3092\u6e96\u5099\u3059\u308b\n------------------------------------------------------\nDocker\u30ec\u30b8\u30b9\u30c8\u30ea\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\n[root@master1 ~]# docker pull registry:2.4.1\nTrying to pull repository docker.io/library/registry ...\n2.4.1: Pulling from docker.io/library/registry\n-\u4ee5\u4e0b\u3001\u7565-\n\nDocker\u30ec\u30b8\u30b9\u30c8\u30ea\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -d -p 12345:5000 --name test-registry registry:2.4.1\n894bcb0a2a4830013991ac827315ff7287d623d1031dc32e1d4848ccf93f013f\n\nDocker\u30ec\u30b8\u30b9\u30c8\u30ea\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                     NAMES\n894bcb0a2a48        registry:2.4.1      \"/bin/registry serve \"   7 seconds ago       Up 4 seconds        0.0.0.0:12345->5000/tcp   test-registry\n\n\n------------------------------------------------------\n3. Docker\u30ec\u30b8\u30b9\u30c8\u306b\u30a4\u30e1\u30fc\u30b8\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\n------------------------------------------------------\n\u30c6\u30b9\u30c8\u7528\u30a4\u30e1\u30fc\u30b8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\u30a4\u30e1\u30fc\u30b8\u30b5\u30a4\u30ba\u304c\u5c0f\u3055\u3044busybox\u3092\u4f7f\u3046\u3002\n[root@master1 ~]# docker pull busybox\nUsing default tag: latest\nTrying to pull repository docker.io/library/busybox ...\n-\u4ee5\u4e0b\u3001\u7565-\n\n\u30a4\u30e1\u30fc\u30b8\u306btag\u4ed8\u3051\u3092\u3059\u308b\n[root@master1 ~]# docker tag busybox master1:12345/hana_shin/busybox:ver1\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# docker images |grep busybox\ndocker.io/busybox                            latest            e02e811dd08f        8 weeks ago         1.093 MB\nmaster1:12345/hana_shin/busybox              ver1              e02e811dd08f        8 weeks ago         1.093 MB\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\u3002\n[root@master1 ~]# docker push master1:12345/hana_shin/busybox:ver1\nThe push refers to a repository [master1:12345/hana_shin/busybox]\ne88b3f82283b: Pushed\nver1: digest: sha256:9393222c6789842b16bcf7306b6eb4b486d81a48d3b8b8f206589b5d1d5a6101 size: 505\n\n\n-------------------------------------------------------------\n4. \u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3057\u305f\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002\n-------------------------------------------------------------\nDocker\u30ec\u30b8\u30b9\u30c8\u30ea\u306b\u767b\u9332\u3057\u305f\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# curl http://localhost:12345/v2/_catalog\n{\"repositories\":[\"hana_shin/busybox\"]}\n\ntag\u3092\u53d6\u5f97\u3059\u308b\u3002\n[root@master1 ~]# curl http://localhost:12345/v2/hana_shin/busybox/tags/list\n{\"name\":\"hana_shin/busybox\",\"tags\":[\"ver1\"]}\n\n\n-------------------------------------------------------------\n5. Docker\u30ec\u30b8\u30b9\u30c8\u30ea\u304b\u3089\u30a4\u30e1\u30fc\u30b8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\n-------------------------------------------------------------\n\u30db\u30b9\u30c8\u5074\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u524a\u9664\u3059\u308b\u3002\n[root@master1 ~]# docker images |grep busybox\ndocker.io/busybox                                     latest                             e02e811dd08f        8 weeks ago         1.093 MB\nmaster1:12345/hana_shin/busybox                       ver1                               e02e811dd08f        8 weeks ago         1.093 MB\n[root@master1 ~]# docker rmi -f e02e811dd08f\nUntagged: docker.io/busybox:latest\nUntagged: master1:12345/hana_shin/busybox:ver1\nDeleted: sha256:e02e811dd08fd49e7f6032625495118e63f597eb150403d02e3238af1df240ba\nDeleted: sha256:e88b3f82283bc59d5e0df427c824e9f95557e661fcb0ea15fb0fb6f97760f9d9\n\nbusybox\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002\u524a\u9664\u3067\u304d\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# docker images |grep busybox\n[root@master1 ~]#\n\nDocker\u30ec\u30b8\u30b9\u30c8\u30ea\u304b\u3089\u30a4\u30e1\u30fc\u30b8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\n[root@master1 ~]# docker pull master1:12345/hana_shin/busybox:ver1\nTrying to pull repository master1:12345/hana_shin/busybox ...\nver1: Pulling from master1:12345/hana_shin/busybox\n56bec22e3559: Pull complete\nDigest: sha256:9393222c6789842b16bcf7306b6eb4b486d81a48d3b8b8f206589b5d1d5a6101\nStatus: Downloaded newer image for master1:12345/hana_shin/busybox:ver1\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002Docker\u30ec\u30b8\u30b9\u30c8\u30ea\u304b\u3089\u30a4\u30e1\u30fc\u30b8\u3092pull\u3067\u304d\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# docker images |grep busybox\nmaster1:12345/hana_shin/busybox                       ver1                               e02e811dd08f        8 weeks ago         1.093 MB\n\n\n-------------------------------------------------------------\n6. docker\u30b3\u30de\u30f3\u30c9\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u8aac\u660e\n-------------------------------------------------------------\ndocker run -d -p 12345:5000 --name test-registry registry\n            A      A            A                  A\n            |      |            |                  +--- \u30a4\u30e1\u30fc\u30b8\u306e\u540d\u524d\u3092\u6307\u5b9a\u3059\u308b\u3002\n            |      |            +---------------------- \u30b3\u30f3\u30c6\u30ca\u306e\u540d\u524d\u3092\u6307\u5b9a\u3059\u308b\u3002\u4efb\u610f\u306e\u540d\u524d\u3067OK\n            |      +----------------------------------- \u30db\u30b9\u30c8\u5074TCP\u30dd\u30fc\u30c8\u756a\u53f7(12345)\u3092\u30b3\u30f3\u30c6\u30ca\u306e\u30dd\u30fc\u30c8\u756a\u53f7(5000)\u306b\u5bfe\u5fdc\u4ed8\u3051\u3059\u308b\u3002\n            +------------------------------------------ \u30b3\u30f3\u30c6\u30ca\u3092\u30d0\u30c3\u30af\u30b0\u30e9\u30a6\u30f3\u30c9\u3067\u52d5\u304b\u3059\u305f\u3081\u306e\u6307\u5b9a\n\n\ndocker tag busybox localhost:12345/test/busybox:ver1\n             A       A         A     A    A      A\n             |       |         |     |    |      +------ tag\u540d\n             |       |         |     |    +------------- \u30a4\u30e1\u30fc\u30b8\u540d\n             |       |         |     +------------------ \u30ea\u30dd\u30b8\u30c8\u30ea\u540d\n             |       |         +------------------------ \u30db\u30b9\u30c8\u306eTCP\u30dd\u30fc\u30c8\u756a\u53f7(\u30db\u30b9\u30c8\u3068\u306fDocker\u30b5\u30fc\u30d0\u304c\u52d5\u4f5c\u3057\u3066\u3044\u308b\u30b5\u30fc\u30d0\u306eIP\u30a2\u30c9\u30ec\u30b9\u3067\u3059)\n             |       +---------------------------------- \u30db\u30b9\u30c8\u306eIP\u30a2\u30c9\u30ec\u30b9\n             +------------------------------------------ \u5143\u306e\u30a4\u30e1\u30fc\u30b8\u306e\u540d\u524d\n\n\n\n3.2 \u30db\u30b9\u30c8\u304b\u3089\u30b3\u30f3\u30c6\u30ca\u3078\u306e\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0(2\u306e\u7d9a\u304d)\nregistry\u30b5\u30fc\u30d0\u3092\u8d77\u52d5\u3059\u308b\u3068\u3001DNAT\u30c6\u30fc\u30d6\u30eb\u304c\u4f5c\u3089\u308c\u307e\u3059\u3002DNAT\u306e\u5909\u63db\u30eb\u30fc\u30eb\u306e\u610f\u5473\u306f\u6b21\u306e\u3068\u304a\u308a\u3002\n\u30db\u30b9\u30c8\u306e\u4efb\u610f(0.0.0.0)\u306e\u30a4\u30f3\u30bf\u30d5\u30a7\u30fc\u30b9\u306b\u5230\u7740\u3057\u305fIP\u30d1\u30b1\u30c3\u30c8\u3067\u5b9b\u5148TCP\u30dd\u30fc\u30c8\u756a\u53f7\u304c12345\u306e\u30d1\u30b1\u30c3\u30c8\u306f\u3001\n\u5b9b\u5148IP\u30a2\u30c9\u30ec\u30b9\u3092172.17.0.2,\u5b9b\u5148\u30dd\u30fc\u30c8\u756a\u53f7\u30925000\u306b\u5909\u63db\u3059\u308b\u3002\n[root@master1 ~]# iptables -L -t nat -n |grep -B3 12345\nChain DOCKER (2 references)\ntarget     prot opt source               destination\nRETURN     all  --  0.0.0.0/0            0.0.0.0/0\nDNAT       tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:12345 to:172.17.0.2:5000\n\n\n\u30b3\u30f3\u30c6\u30ca\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u3066IP\u30a2\u30c9\u30ec\u30b9\u3092\u8abf\u3079\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u306eIP\u30a2\u30c9\u30ec\u30b9\u306f\"172.17.0.2\"\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# docker exec -it test-registry sh\n/ # ip a\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n    inet6 ::1/128 scope host\n       valid_lft forever preferred_lft forever\n20: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP\n    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff\n    inet 172.17.0.2/16 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::42:acff:fe11:2/64 scope link\n       valid_lft forever preferred_lft forever\n/ #\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u30d7\u30ed\u30bb\u30b9\u304c\u4f7f\u7528\u3057\u3066\u3044\u308b\u30dd\u30fc\u30c8\u756a\u53f7\u3092\u8abf\u3079\u308b\u3002\n/ # netstat -antp\nActive Internet connections (servers and established)\nProto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name\ntcp        0      0 :::5000                 :::*                    LISTEN      1/registry\n/ #\n\n\u3055\u3089\u306b\u3082\u30461\u3064registry\u30b5\u30fc\u30d0\u3092\u8d77\u52d5\u3057\u305f\u3068\u304d\u306e\u30db\u30b9\u30c8\u306e\u69d8\u5b50\u3092\u4ee5\u4e0b\u306b\u793a\u3057\u307e\u3059\u3002\n[root@master1 ~]# docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                     NAMES\n467b1628f13b        registry            \"/entrypoint.sh /etc/\"   30 minutes ago      Up 30 minutes       0.0.0.0:22222->5000/tcp   test2-registry\nb00c90063f16        registry            \"/entrypoint.sh /etc/\"   3 hours ago         Up 33 minutes       0.0.0.0:12345->5000/tcp   test-registry\n\n[root@master1 ~]# iptables -L -t nat -n |grep -e 12345 -e 22222\nDNAT       tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:12345 to:172.17.0.2:5000\nDNAT       tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:22222 to:172.17.0.3:5000\n\n\ndocker0\u306f\u30d6\u30ea\u30c3\u30b8\u3067\u3059\u3002container\u306f\u8d77\u52d5\u3059\u308b\u3068\u3001\u3053\u306e\u30d6\u30ea\u30c3\u30b8\u306b\u63a5\u7d9a\u3055\u308c\u307e\u3059\u3002\n\u30d6\u30ea\u30c3\u30b8\u306b\u306f\u30dd\u30fc\u30c8\u304c\u5272\u308a\u5f53\u3066\u3089\u308c\u307e\u3059\u3002container1\u3068vethXXX,container2\u3068vethYYY\u304c\u305d\u308c\u305e\u308c\u3064\u306a\u304c\u3063\u3066\u3044\u307e\u3059\u3002\n\n +---------- Host(CentOS7.2)-------------+\n |                                       |\n |  +- container1 -+   +- container2 -+  |\n |  |              |   |              |  |\n |  |   port=5000  |   |   port=5000  |  |\n |  |              |   |              |  |\n |  +---- eth0 ----+   +---- eth0 - --+  |   -*-\n |    A    | .2               | .3  A    |    |\n |    |    |                  |     |    | 172.16.0.0/16\u306e\u30b5\u30d6\u30cd\u30c3\u30c8\n |  +-|- vethXXX --------- vethYYY -|-+  |    |\n |  | |    docker0(172.17.0.1/16)   | |  |    |\n |  +-|-----------------------------|-+  |   -*-\n |    |              |              |    |\n |    +----+         |          +---+    |\n |         |         |          |        |\n |  +------|--------------------|-----+  |\n |  |      |       Routing      |     | ========> +----------------------------------------------------------------------------------------+\n |  +------|--------------------|-----+  |        |\u3010\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u30c6\u30fc\u30d6\u30eb\u3011\u5b9b\u5148IP\u30a2\u30c9\u30ec\u30b9\u3088\u308a\u3001\u51fa\u529b\u3059\u308b\u30c7\u30d0\u30a4\u30b9(eth0,dcoker0)\u3092\u6c7a\u3081\u308b            |\n |         |         |          |        |        | [root@master1 ~]# route -n                                                             |\n |  port=12345       |      port=22222   |        | Kernel IP routing table                                                                |\n |         |         |          |        |        | Destination     Gateway         Genmask         Flags Metric Ref    Use Iface          |\n +----- eth0 (192.168.0.10/24) -|--------+        | 0.0.0.0         192.168.0.1     0.0.0.0         UG    100    0        0 eth0           |\n           |         |          |                 | 172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0        |\n                     |                            | 192.168.0.0     0.0.0.0         255.255.255.0   U     100    0        0 eth0           |\n                     |                            +----------------------------------------------------------------------------------------+\n\n\n\n\n\n3.3 \u30b3\u30f3\u30c6\u30caID\u304b\u3089\u30d7\u30ed\u30bb\u30b9ID\u3092\u6c42\u3081\u308b\u65b9\u6cd5\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -it --name test-con centos:centos7 bash\n[root@22914bed7a73 /]# ps\n   PID TTY          TIME CMD\n     1 ?        00:00:00 bash\n    16 ?        00:00:00 ps\n\n\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3092\u8d77\u52d5\u3057\u3066\u3001\u30b3\u30f3\u30c6\u30caID\u3092\u6c42\u3081\u308b\n[root@master1 ~]# CID=$(docker ps --no-trunc=true|grep \"test-con\"|awk '{print $1}')\n\n\u30b3\u30f3\u30c6\u30caID\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# echo $CID\n22914bed7a73ee10382d23a1066dfb3ec94e44de0390af087ccfb4b2b751384b\n\nPID\u3092\u6c42\u3081\u308b\u3002\n[root@master1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\nPID\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# echo $PID\n2857\n\n\u30d7\u30ed\u30bb\u30b9\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# ps -lp 2857\nF S   UID    PID   PPID  C PRI  NI ADDR SZ WCHAN  TTY          TIME CMD\n4 S     0   2857   1053  0  80   0 -  2944 n_tty_ pts/2    00:00:00 bash\n\n\n\n3.4 \u30b3\u30f3\u30c6\u30ca\u304c\u30db\u30b9\u30c8\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u30de\u30a6\u30f3\u30c8\u3059\u308b\u65b9\u6cd5\n-------------------------------------------------------------\n1. \u30de\u30a6\u30f3\u30c8\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u660e\u793a\u7684\u306b\u6307\u5b9a\u3059\u308b\u65b9\u6cd5(-v\u30aa\u30d7\u30b7\u30e7\u30f3)\n-------------------------------------------------------------\n\n\u30de\u30a6\u30f3\u30c8\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\"svirt_sandbox_file_t\"\u3068\u3044\u3046SElinux\u306e\u30bf\u30a4\u30d7\u3092\u8a2d\u5b9a\u3059\u308b\u3002\n[root@master1 ~]# ls -ldZ registry/\ndrwxr-xr-x. root root unconfined_u:object_r:admin_home_t:s0 registry/\n[root@master1 ~]# chcon -Rt svirt_sandbox_file_t registry\n[root@master1 ~]# ls -ldZ registry/\ndrwxr-xr-x. root root unconfined_u:object_r:svirt_sandbox_file_t:s0 registry/\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -it -v $HOME/registry:/var/lib/registry --name test centos:centos7 bash\n\n\n\u30de\u30a6\u30f3\u30c8\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@08497e222b5e /]# touch /var/lib/registry/test.txt\n[root@08497e222b5e /]# echo \"This is container\" > /var/lib/registry/test.txt\n[root@08497e222b5e /]# cat /var/lib/registry/test.txt\nThis is container\n\n\n\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3067\u4f5c\u6210\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u306e\u4e2d\u8eab\u3092\u78ba\u8a8d\u3059\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u3067\u4f5c\u6210\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u306e\u4e2d\u8eab\u304c\u78ba\u8a8d\u3067\u304d\u305f\u3002\n[root@master1 ~]# pwd\n/root\n[root@master1 ~]# cat registry/test.txt\nThis is container\n\n\n-------------------------------------------------------------\n2. \u30de\u30a6\u30f3\u30c8\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u3092\u660e\u793a\u7684\u306b\u6307\u5b9a\u3057\u306a\u3044\u65b9\u6cd5\u3002\n-------------------------------------------------------------\n\n\u3053\u306e\u5834\u5408\u3001\u30b3\u30f3\u30c6\u30ca\u306f\u30db\u30b9\u30c8\u306e/var/lib/docker/volumes\u914d\u4e0b\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u30de\u30a6\u30f3\u30c8\u3057\u307e\u3059\u3002\n\n\n--------------------------------------------------------------------------------------\n2.1 Dockerfile\u3067VOLUME\u3092\u6307\u5b9a\u3059\u308b\u65b9\u6cd5\n--------------------------------------------------------------------------------------\nDockerfile\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 ~]# vi Dockerfile\n[root@master1 ~]# cat Dockerfile\nFROM centos:centos7\nVOLUME /root/dir01\nVOLUME /root/dir02\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 ~]# docker build -t test-image:v1 .\nSending build context to Docker daemon  84.3 MB\nStep 1 : FROM centos:centos7\n ---> 0584b3d2cf6d\nStep 2 : VOLUME /root/dir01\n ---> Using cache\n ---> 226d9d64338d\nStep 3 : VOLUME /root/dir02\n ---> Using cache\n ---> 6584f874444e\nSuccessfully built 6584f874444e\n[root@master1 ~]#\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -itd --name test-con test-image:v1\n45f6382fd50f21361a911080bf1a3e5d8b91781df0677f6d63ebca5fb334cb64\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# docker ps\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\n45f6382fd50f        test-image:v1       \"/bin/bash\"         26 seconds ago      Up 24 seconds                           test-con\n\njq\u30b3\u30de\u30f3\u30c9\u304c\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n[root@master1 ~]# yum -y install jq\n\n\u30db\u30b9\u30c8\u5074\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u78ba\u8a8d\u3059\u308b\u3002/var/lib/docker/volumes\u914d\u4e0b(\u2605\u5370)\u306b\u30de\u30c3\u30d4\u30f3\u30b0\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# docker inspect test-con | jq .|less\n\n-\u4e2d\u7565-\n    \"Mounts\": [\n      {\n        \"Name\": \"d7b8625f00b37f7648fbb5b7d92e1204c7d5b4b2c314051208929080e2d3d82d\",\n      \u2605\"Source\": \"/var/lib/docker/volumes/d7b8625f00b37f7648fbb5b7d92e1204c7d5b4b2c314051208929080e2d3d82d/_data\",\n        \"Destination\": \"/root/dir01\",\n        \"Driver\": \"local\",\n        \"Mode\": \"\",\n        \"RW\": true,\n        \"Propagation\": \"\"\n      },\n      {\n        \"Name\": \"761db694fb793079933981ce9094920c1814f964eba4635bf292e1a038a8f428\",\n      \u2605\"Source\": \"/var/lib/docker/volumes/761db694fb793079933981ce9094920c1814f964eba4635bf292e1a038a8f428/_data\",\n        \"Destination\": \"/root/dir02\",\n        \"Driver\": \"local\",\n        \"Mode\": \"\",\n        \"RW\": true,\n        \"Propagation\": \"\"\n      }\n    ],\n\u4ee5\u4e0b\u3001\u7565\n\n\n\u30b3\u30f3\u30c6\u30ca\u306ebash\u306b\u63a5\u7d9a\u3059\u308b\u3002\n[root@master1 ~]# docker exec -it test-con bash\n\nVOLUME\u3067\u6307\u5b9a\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u304c\u4f5c\u6210\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@45f6382fd50f /]# cd /root/\n[root@45f6382fd50f ~]# ls\nanaconda-ks.cfg  dir01  dir02\n\n\ndir01\u914d\u4e0b\u306b\u30d5\u30a1\u30a4\u30eb(file01)\u3092\u4f5c\u6210\u3059\u308b\n[root@45f6382fd50f ~]# cd dir01/\n[root@45f6382fd50f dir01]# touch file01\n[root@45f6382fd50f dir01]# echo \"This is file01\" > file01\n[root@45f6382fd50f dir01]# cat file01\nThis is file01\n\n\n\u4f5c\u6210\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u306e\u4e2d\u8eab\u3092\u30db\u30b9\u30c8\u5074\u3067\u78ba\u8a8d\u3059\u308b\u3002\u3082\u30461\u3064\u30bf\u30fc\u30df\u30ca\u30eb\u3092\u8d77\u52d5\u3059\u308b\u3002\n\u30b3\u30f3\u30c6\u30ca\u3067\u66f8\u3044\u305f\u30d5\u30a1\u30a4\u30eb\u306e\u5185\u5bb9\u304c\u30db\u30b9\u30c8\u3067\u8aad\u3081\u305f\u3002\n[root@master1 ~]# cat /var/lib/docker/volumes/d7b8625f00b37f7648fbb5b7d92e1204c7d5b4b2c314051208929080e2d3d82d/_data/file01\nThis is file01\n\n\n--------------------------------------------------------------------------------------\n2.2. docker run\u5b9f\u884c\u6642\u306b\u6307\u5b9a\u3059\u308b\u65b9\u6cd5.  \u78ba\u8a8d\u65b9\u6cd5\u306f2.1\u3092\u53c2\u8003\u306b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n--------------------------------------------------------------------------------------\n[root@master1 ~]# docker run -it --rm -v /root/dir01 -v /root/dir02 centos:centos7 bash\n[root@0e646e283a53 /]# cd root/\n[root@0e646e283a53 ~]# ls\nanaconda-ks.cfg  dir01  dir02\n[root@0e646e283a53 ~]#\n\n\n\n\n3.5 \u30db\u30b9\u30c8\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u30ea\u30fc\u30c9\u30aa\u30f3\u30ea\u30fc(ro\u30aa\u30d7\u30b7\u30e7\u30f3)\u3067\u30de\u30a6\u30f3\u30c8\u3059\u308b\u3002\n\u30b3\u30f3\u30c6\u30ca\u3067\u30de\u30a6\u30f3\u30c8\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 ~]# mkdir /hostdir\n[root@master1 ~]# chcon -Rt svirt_sandbox_file_t /hostdir\n[root@master1 ~]# ls -ldZ /hostdir\ndrwxr-xr-x. root root unconfined_u:object_r:svirt_sandbox_file_t:s0 /hostdir\n\n\u30db\u30b9\u30c8\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u30ea\u30fc\u30c9\u30aa\u30f3\u30ea\u30fc(ro\u30aa\u30d7\u30b7\u30e7\u30f3)\u3067\u30de\u30a6\u30f3\u30c8\u3059\u308b\u3002\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u3066\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\u304c\u3067\u304d\u306a\u3044\u3002\n[root@master1 ~]# docker run -it -v /hostdir:/tmp:ro busybox sh\n/ # echo \"This is container\" > /tmp/test.txt\nsh: can't create /tmp/test.txt: Read-only file system\n/ # exit\n\n\u4eca\u5ea6\u306f\u3001\u66f8\u304d\u8fbc\u307f\u53ef\u3067\u30de\u30a6\u30f3\u30c8\u3059\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u3067\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u305f\u3002\n[root@master1 ~]# docker run -it -v /hostdir:/tmp busybox sh\n/ # echo \"This is container\" > /tmp/test.txt\n/ # exit\n[root@master1 ~]# cat /hostdir/test.txt\nThis is container\n[root@master1 ~]#\n\n\n\n3.6 \u30c7\u30fc\u30bf\u4fdd\u5b58\u5c02\u7528\u30b3\u30f3\u30c6\u30ca\u306e\u4f5c\u6210\u65b9\u6cd5\ndata_con\u30b3\u30f3\u30c6\u30ca\u306e/data_dir\u306b\u5bfe\u3057\u3066\u3001con\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u30d5\u30a1\u30a4\u30eb\u306e\u8aad\u307f\u66f8\u304d\u3092\u3059\u308b\u3002\n\n    con\u30b3\u30f3\u30c6\u30ca                data_con\u30b3\u30f3\u30c6\u30ca(\u30c7\u30fc\u30bf\u4fdd\u5b58\u5c02\u7528)\n                 -------->     /data_dir\n                read/write\n\n\n\u30c7\u30fc\u30bf\u4fdd\u5b58\u5c02\u7528\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002-v\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u4f7f\u3063\u3066\u3001/data_dir\u3092\u4ed6\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u53c2\u7167\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u3002\n[root@master1 ~]# docker run -it -v /data_dir --name data_con busybox sh\n/ # ls /data_dir/\n/ # echo \"This is data-container\" > /data_dir/data.txt\n/ # exit\n\n\u3082\u30461\u3064\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u30c7\u30fc\u30bf\u4fdd\u5b58\u5c02\u7528\u30b3\u30f3\u30c6\u30ca\u306b\u4fdd\u5b58\u3057\u305f\n[root@master1 ~]# docker run -it --volumes-from data_con --name con busybox sh\n/ # cat /data_dir/data.txt\nThis is data-container\n/ # exit\n\n\n\n\n3.7 \u540c\u4e00\u30db\u30b9\u30c8\u3067nginx\u30b3\u30f3\u30c6\u30ca\u3092\u8907\u6570\u8d77\u52d5\u3059\u308b\u3002\n\u30db\u30b9\u30c8\u306eTCP\u30dd\u30fc\u30c8\u756a\u53f711111\u3092\u30b3\u30f3\u30c6\u30ca\u306e\u30dd\u30fc\u30c8\u756a\u53f780\u306b\u30de\u30c3\u30d7\u3059\u308b\u3002\n[root@master1 ~]# docker run -d -p 11111:80 --name web1 nginx\n498c3d59429b7756d63a83cbd8285f68a0a6a4470227fa58cc62c3f1cf682164\n\n\u30db\u30b9\u30c8\u306eTCP\u30dd\u30fc\u30c8\u756a\u53f722222\u3092\u30b3\u30f3\u30c6\u30ca\u306e\u30dd\u30fc\u30c8\u756a\u53f780\u306b\u30de\u30c3\u30d7\u3059\u308b\u3002\n[root@master1 ~]# docker run -d -p 22222:80 --name web2 nginx\ncc5d925c88ca18542931dba346f0ae011cd414f7aad3d00fc95172e4d7fc6d69\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u78ba\u8a8d\u3059\u308b\u3002\u305d\u308c\u305e\u308c\u300111111->80,22222->80\u3000\u306b\u30de\u30c3\u30d7\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# docker ps |grep -e web1 -e web2\ncc5d925c88ca        nginx               \"nginx -g 'daemon off\"   15 seconds ago      Up 13 seconds       443/tcp, 0.0.0.0:22222->80/tcp   web2\n498c3d59429b        nginx               \"nginx -g 'daemon off\"   26 seconds ago      Up 23 seconds       443/tcp, 0.0.0.0:11111->80/tcp   web1\n\n[root@master1 ~]# curl http://localhost:11111\n<!DOCTYPE html>\n<html>\n<head>\n<title>Welcome to nginx!</title>\n\u4ee5\u4e0b\u3001\u7565\n\n[root@master1 ~]# curl http://localhost:22222\n<!DOCTYPE html>\n<html>\n<head>\n<title>Welcome to nginx!</title>\n\u4ee5\u4e0b\u3001\u7565\n\n[root@master1 ~]# docker rm -f web1 web2\nweb1\nweb2\n[root@master1 ~]#\n\n\n\n\n3.8 \u30b3\u30f3\u30c6\u30ca\u304c\u52d5\u4f5c\u3059\u308bCPU\u3092\u6307\u5b9a\u3059\u308b\u65b9\u6cd5(--cpuset-cpus\u30aa\u30d7\u30b7\u30e7\u30f3)\n\n----------------------------------------------------\n1. dd\u30b3\u30de\u30f3\u30c9\u3067CPU\u8ca0\u8377\u3092\u304b\u3051\u308b\n----------------------------------------------------\n\u30b3\u30f3\u30c6\u30ca\u304c\u3069\u306eCPU\u3067\u52d5\u3044\u3066\u3044\u308b\u304b\u3092\u78ba\u8a8d\u3059\u308b\u305f\u3081\u3001htop\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n[root@master1 ~]# yum -y install epel-release\n[root@master1 ~]# yum -y install htop\n\n\u30db\u30b9\u30c8\u306eCPU\u3092\u78ba\u8a8d\u3059\u308b\u3002CPU\u304c4\u500b\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# cat /proc/cpuinfo |grep processor\nprocessor       : 0\nprocessor       : 1\nprocessor       : 2\nprocessor       : 3\n[root@master1 ~]#\n\n\nCPU=0\u3067\u30b3\u30f3\u30c6\u30ca\u3092\u52d5\u304b\u3059\u3002--cpuset-cpus\u306b0\u3092\u6307\u5b9a\u3059\u308b\u3002\n[root@master1 ~]# docker run -it -d --name con0 --cpuset-cpus=0 busybox dd if=/dev/zero of=/dev/null\n06ef3f9b7cd70b3b2e0df2917aaef8702491e34f9019ee0361266e86081d0a42\n\n\u30b3\u30f3\u30c6\u30ca\u304c\u3069\u306eCPU\u3067\u52d5\u3044\u3066\u3044\u308b\u304b\u306e\u78ba\u8a8d\u65b9\u6cd5\u306e\u8aac\u660e\u3002\nhtop\u306e\u753b\u50cf\u3092\u5f35\u308a\u4ed8\u3051\u3066\u8aac\u660e\u3057\u305f\u3044\u3051\u3069\u3001\u8cbc\u308a\u4ed8\u3051\u3064\u3051\u65b9\u304c\u308f\u304b\u3089\u306a\u3044\u306e\u3067\u3001\u8a00\u8449\u3067\u8aac\u660e\u3059\u308b\u3002\n\n1. htop\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# htop\n\n2. F2\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b\u3002\u753b\u9762\u304c\u5207\u308a\u66ff\u308f\u308b\u3002\n3. \u2191\u2193\u30ad\u30fc\u3092\u64cd\u4f5c\u3057\u3066\u3001\"Setup\"\u5217\u306e\"Columns\"\u306b\u30ab\u30fc\u30bd\u30eb\u3092\u5408\u308f\u305b\u3001Enter\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b\u3002\n4. <-->\u30ad\u30fc\u3092\u9078\u629e\u3057\u3066\u3001\u53f3\u7aef\u306e\"Available Columens\"\u5217\u306b\u30ab\u30fc\u30bd\u30eb\u3092\u79fb\u52d5\u3059\u308b\u3002\n5. \"Available Columens\"\u5217\u306e\"PROCESSOR\"\u3068\u3044\u3046\u9805\u76ee\u306b\u30ab\u30fc\u30bd\u30eb\u3092\u79fb\u52d5\u3057\u3066Enter\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b\u3002\n6. F5\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b\u3002\"PROCESSOR\"\u9805\u76ee\u3092\u8868\u793a\u9805\u76ee\u306b\u8ffd\u52a0\u3059\u308b\u3002\n7. F10\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u3066\u3001\u8a2d\u5b9a\u3092\u4fdd\u5b58\u3059\u308b\u3002\n8. \u753b\u9762\u304c\u5207\u308a\u66ff\u308f\u308b\u3002\u30d7\u30ed\u30bb\u30b9\u4e00\u89a7\u304c\u8868\u793a\u3055\u308c\u308b\u3002\"CPU\"\u5217\u304c\u8ffd\u52a0\u3055\u308c\u3066\u3044\u308b\u3002\n9. dd\u30d7\u30ed\u30bb\u30b9\u3092\u691c\u7d22\u3059\u308b\u305f\u3081F3\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b\u3002\u7d9a\u3051\u3066\u3001\"dd\"\u3068\u5165\u529b\u3059\u308b\u3002\n10. dd\u30d7\u30ed\u30bb\u30b9\u304c\u753b\u9762\u306e\u4e00\u756a\u4e0a\u306b\u8868\u793a\u3055\u308c\u308b\u3002\n11. dd\u30b3\u30de\u30f3\u30c9\u304c\u52d5\u4f5c\u3057\u3066\u3044\u308bCPU\u756a\u53f7\u3092\u78ba\u8a8d\u3059\u308b\u3002CPU=0\u3067\u52d5\u3044\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n\nCPU\u756a\u53f7\u306e\u6570\u3048\u65b9\u304c\u3001\u30db\u30b9\u30c8\u3068htop\u3067\u306f\u7570\u306a\u308b\u306e\u3067(\u30db\u30b9\u30c8\u306f0,1,..htop\u306f1,2..)\u3001\n\u30db\u30b9\u30c8\u306b\u5408\u308f\u305b\u308b\u5834\u5408\u306f\"Display options\" -> \"Count CPUs from 0 instead of 1\"\u3092\u9078\u629e\u3059\u308b\u3002\nhtop\u3067\u3082CPU\u756a\u53f7\u304c0,1,2...\u3068\u8868\u793a\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u308b\u3002\n\n\n\u4ed6\u306b\u3082\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306bCPU\u756a\u53f7\u3092\u5909\u5316\u3055\u305b\u3066\u3001htop\u3067\u78ba\u8a8d\u3059\u308b\u3002\u6307\u5b9a\u3057\u305fCPU\u3067\u30b3\u30f3\u30c6\u30ca\u304c\u52d5\u3044\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n[root@master1 ~]# docker run -it -d --name con1 --cpuset-cpus=1 busybox dd if=/dev/zero of=/dev/null\n[root@master1 ~]# docker run -it -d --name con2 --cpuset-cpus=2 busybox dd if=/dev/zero of=/dev/null\n[root@master1 ~]# docker run -it -d --name con3 --cpuset-cpus=3 busybox dd if=/dev/zero of=/dev/null\n\n\n----------------------------------------------------\n2. openssl\u30b3\u30de\u30f3\u30c9\u3067CPU\u8ca0\u8377\u3092\u304b\u3051\u308b\n----------------------------------------------------\n[root@master1 ~]# vi Dockerfile\n[root@master1 ~]# cat Dockerfile\nFROM centos:centos7\nENV container docker\nRUN yum -y install openssl && yum clean all\n[root@master1 ~]#\n\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 ~]# docker build -t test --no-cache=true .\nSending build context to Docker daemon 84.29 MB\nStep 1 : FROM centos:centos7\n ---> 0584b3d2cf6d\nStep 2 : ENV container docker\n ---> Running in f75f52ceffb5\n ---> 49803a7122bf\nRemoving intermediate container f75f52ceffb5\nStep 3 : RUN yum -y install openssl && yum clean all\n ---> Running in 3cae1e4c3680\n\u4ee5\u4e0b\u3001\u7565\n\n\n[root@master1 ~]# docker run -it -d --name cpuload --cpuset-cpus=0-1 test /usr/bin/openssl speed -multi 2\n7cc24954486249466f4c8f31586ae73a34be7eb0eee5c9155d88df0f4aa61115\n[root@master1 ~]# docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES\n7cc249544862        test                \"/usr/bin/openssl spe\"   4 seconds ago       Up 2 seconds                            cpuload\n[root@master1 ~]#\n\n\nhtop\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# htop\n\nCPU=0,1\u3067openssl\u30b3\u30de\u30f3\u30c9\u306e\u4f7f\u7528\u7387\u304c100%\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n\n\n\u4eca\u5ea6\u306f\u3001CPU0\u3068CPU3\u3067openssl\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3002\n[root@master1 ~]# docker run -it -d --name cpuload --cpuset-cpus=0,3 test /usr/bin/openssl speed -multi 2\n041d17acb164c629ac9d1d8052439961c8881b7d124e57268214abeffb3e066c\n[root@master1 ~]# docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES\n041d17acb164        test                \"/usr/bin/openssl spe\"   6 seconds ago       Up 3 seconds                            cpuload\n[root@master1 ~]#\n\nhtop\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# htop\n\nCPU0\u3068CPU3\u3067openssl\u30b3\u30de\u30f3\u30c9\u306e\u4f7f\u7528\u7387\u304c100%\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n\n\n\n3.9 \u30b3\u30f3\u30c6\u30ca\u304c\u52d5\u4f5c\u3059\u308bCPU\u306e\u78ba\u8a8d\u65b9\u6cd5\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -it --rm --name test-con1 centos:centos7 bash\n[root@0b9b40152ac4 /]#\n\n\u30b3\u30f3\u30c6\u30caID\u3092\u53d6\u5f97\u3059\u308b\u3002\n[root@master1 ~]# CID=$(docker ps -a --no-trunc=true |grep test-con1 | awk '{print $1}')\n\n\u30b3\u30f3\u30c6\u30caID\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# echo $CID\n0b9b40152ac4377080bb77ba8fca267d1c4cf11cb2d6314f3ad8ac064efe5b35\n\n\u30b3\u30f3\u30c6\u30ca\u304c\u52d5\u4f5c\u3059\u308bCPU\u3092\u78ba\u8a8d\u3059\u308b\u3002CPU=0,1,2,3\u3067\u52d5\u304f\u8a2d\u5b9a\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# cat /sys/fs/cgroup/cpuset/system.slice/docker-${CID}.scope/cpuset.cpus\n0-3\n\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u306fCPU=0\u3067\u52d5\u304f\u8a2d\u5b9a\u3002\n[root@master1 ~]# docker run -it --rm --cpuset-cpus=0 --name test-con1 centos:centos7 bash\n[root@923a81f60736 /]#\n\n\u30b3\u30f3\u30c6\u30caID\u3092\u53d6\u5f97\u3059\u308b\u3002\n[root@master1 ~]# CID=$(docker ps -a --no-trunc=true |grep \"test-con1\" | awk '{print $1}')\n\n\u30b3\u30f3\u30c6\u30caID\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# echo $CID\n923a81f60736846eaf10627fe8408173180e08163f285252f1cb5b6a52730608\n\n\u30b3\u30f3\u30c6\u30ca\u304c\u52d5\u4f5c\u3059\u308bCPU\u3092\u78ba\u8a8d\u3059\u308b\u3002CPU=0\u3067\u52d5\u304f\u8a2d\u5b9a\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# cat /sys/fs/cgroup/cpuset/system.slice/docker-${CID}.scope/cpuset.cpus\n0\n\n\n\n3.10 \u30b3\u30f3\u30c6\u30ca\u304c\u4f7f\u3046CPU\u5272\u308a\u5f53\u3066\u6642\u9593\u6307\u5b9a\u3059\u308b(--cpu--shares\u30aa\u30d7\u30b7\u30e7\u30f3)\n\u30b3\u30f3\u30c6\u30ca\u30923\u3064\u8d77\u52d5\u3059\u308b\u3002CPU\u5272\u308a\u5f53\u3066\u6642\u9593\u30921024:1024:1024\u306e\u5272\u5408\u3067\u5272\u308a\u5f53\u3066\u308b\u3002\n[root@master1 ~]# docker run -it -d --name con0 --cpuset-cpus=0 --cpu-shares=1024  busybox dd if=/dev/zero of=/dev/null\nb0d0b5c19b2504066b5b78c908fc5e7bb2cba44efacb3c334dd093986f354956\n[root@master1 ~]# docker run -it -d --name con1 --cpuset-cpus=0 --cpu-shares=1024  busybox dd if=/dev/zero of=/dev/null\nd61db7e92a491934a80168580b2a6f3fa2941ce3984b822e8b65916a1e7f602a\n[root@master1 ~]# docker run -it -d --name con3 --cpuset-cpus=0 --cpu-shares=1024  busybox dd if=/dev/zero of=/dev/null\n64d2d6c2dde6bd2ea4b3b1e98fa4a205290d3fcb024f4d0254b85a5f343c7c3b\n[root@master1 ~]#\n\nhtop\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# htop\n\n\nCPU=0\u3067dd\u30d7\u30ed\u30bb\u30b9\u304c3\u3064\u52d5\u3044\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n\u305d\u306e\u6642\u306e\u5404\u30d7\u30ed\u30bb\u30b9\u306eCPU\u4f7f\u7528\u7387\u304c33%\u524d\u5f8c\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\n-------------------------------------------------------------------------\n\u4eca\u5ea6\u306f--cpu-shares=128\u3092\u6307\u5b9a\u3059\u308b\u3002\n[root@master1 ~]# docker run -it -d --name con0 --cpuset-cpus=0 --cpu-shares=128  busybox dd if=/dev/zero of=/dev/null\n96e2a54cdd306b39e04cdbd16e5b9a013e8109197c6f9966aedba6dd6620286f\n[root@master1 ~]# docker run -it -d --name con1 --cpuset-cpus=0 --cpu-shares=128  busybox dd if=/dev/zero of=/dev/null\ned1fbce1deb59563ca327a740bb7ef02bb665d6dc7c432539bdfc2c2feef8c48\n[root@master1 ~]# docker run -it -d --name con2 --cpuset-cpus=0 --cpu-shares=128  busybox dd if=/dev/zero of=/dev/null\n591136e723f0ff2371ae127721924423fc2337b7d856240d1578ab715d7b5752\n[root@master1 ~]#\n\nhtop\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# htop\n\nCPU=0\u3067dd\u30d7\u30ed\u30bb\u30b9\u304c3\u3064\u52d5\u3044\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n--cpu-shares=128\u3068\u6307\u5b9a\u3057\u305f\u5834\u5408\u3067\u3082\u3001\u5404\u30d7\u30ed\u30bb\u30b9\u306eCPU\u4f7f\u7528\u7387\u304c33%\u524d\u5f8c\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\n\n\n-------------------------------------------------------------------------\n\u4eca\u5ea6\u306f\u3001--cpu-shares\u3092128:128:256\u306b\u6307\u5b9a\u3059\u308b\u3002\n[root@master1 ~]# docker run -it -d --name con1 --cpuset-cpus=0 --cpu-shares=128  busybox dd if=/dev/zero of=/dev/null\nf1e0c7a0ebfb51502eab81f9d4138f290d8edfffce466c15dc02395e935a5a61\n[root@master1 ~]# docker run -it -d --name con2 --cpuset-cpus=0 --cpu-shares=128  busybox dd if=/dev/zero of=/dev/null\nf0515a66cb18af7f88affa944567b557fc5ebaf5b8a23e7909de1b44e485f33d\n[root@master1 ~]# docker run -it -d --name con3 --cpuset-cpus=0 --cpu-shares=256  busybox dd if=/dev/zero of=/dev/null\nbf35847b04244840d2fdc69107bc37366b612269a6cb090a481dc12c1662aa19\n\nhtop\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# htop\n\nCPU=0\u3067dd\u30d7\u30ed\u30bb\u30b9\u304c3\u3064\u52d5\u3044\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\nCPU\u4f7f\u7528\u7387\u3092\u78ba\u8a8d\u3059\u308b\u3068\u3001con1:con2:con3\u304c1:1:2\u306e\u5272\u5408\u306b\u306a\u3063\u305f\u3002\n\n\n\n3.11 \u30b3\u30f3\u30c6\u30ca\u304c\u51fa\u529b\u3059\u308b\u30ed\u30b0\u3092syslog\u3084journald\u306b\u51fa\u529b\u3059\u308b(--log-driver\u30aa\u30d7\u30b7\u30e7\u30f3)\n\n-----------------------------------------------------------\n1. \u30b3\u30f3\u30c6\u30ca\u5358\u4f4d\u3067\u6709\u52b9\u306b\u3059\u308b\u65b9\u6cd5\n-----------------------------------------------------------\n[root@master1 ~]# docker pull centos:centos7\n[root@master1 ~]# docker run --log-driver=syslog centos:centos7 echo 'bbbbbbbbbb'\n\n[root@master1 ~]# grep bbbbbbbbbb /var/log/messages\n-\u4e2d\u7565-\nNov 20 22:23:47 master1 docker-current/978df20ce856[1037]: bbbbbbbbbb\n\n\n\u6bce\u56de\u8d77\u52d5\u6642\u306b\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u6307\u5b9a\u3059\u308b\u306e\u306f\u9762\u5012\u306a\u306e\u3067\u3001\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306bsyslog\u3078\u306e\u30ed\u30b0\u51fa\u529b\u3092\u6307\u5b9a\u3059\u308b\u3002\n[root@master1 ~]# vi /etc/sysconfig/docker\n-\u4e2d\u7565-\nDOCKER_OPTS=\"--log-driver syslog\"\n\n[root@master1 ~]# systemctl restart docker\n[root@master1 ~]# docker run centos:centos7 echo 'cccccccccc'\ncccccccccc\n\n[root@master1 ~]# grep cccccccccc /var/log/messages\nNov 20 22:27:47 master1 journal: cccccccccc\n\n\n-----------------------------------------------------------\n2. \u5168\u3066\u306e\u30b3\u30f3\u30c6\u30ca\u3067\u6709\u52b9\u306b\u3059\u308b\n-----------------------------------------------------------\n[root@master1 ~]# vi /etc/sysconfig/docker\nDOCKER_OPTS=\"--log driver syslog\"\n\n[root@master1 ~]# systemctl restart docker\n\n\n\n3.12 \u30b3\u30f3\u30c6\u30ca\u304c\u4f7f\u3046\u30e1\u30e2\u30ea\u91cf\u306b\u5236\u9650\u3092\u304b\u3051\u308b(-m\u30aa\u30d7\u30b7\u30e7\u30f3)\n\u30b3\u30f3\u30c6\u30ca\u304c\u4f7f\u3046\u30e1\u30e2\u30ea\u91cf\u3092256M\u306b\u5236\u9650\u3059\u308b\u3002\n[root@master1 ~]# docker run -it -m 256m --name memload centos:centos7 bash\n[root@f020e33fb040 /]#\n\n\u4e0b\u8a18\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3002\n[root@af2e80e36842 /]# /dev/null < $(yes)\n\nhtop\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# htop\n\n\u30e1\u30e2\u30ea\u304c256M\u8fd1\u304f\u307e\u3067\u6d88\u8cbb\u3059\u308b\u306e\u3092\u7e70\u308a\u8fd4\u3057\u305f\u3042\u3068\u3001bash\u304ckill\u3055\u308c\u308b\u3002\n[root@f020e33fb040 /]# /dev/null < $(yes)\nKilled\n\n\n\n3.13 \u30b3\u30f3\u30c6\u30ca\u304c\u4f7f\u3046fd(\u30d5\u30a1\u30a4\u30eb\u30c7\u30a3\u30b9\u30af\u30ea\u30d7\u30bf)\u6570\u306b\u5236\u9650\u3092\u304b\u3051\u308b(--ulimit\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u4f7f\u3046)\n\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u6307\u5b9a\u305b\u305a\u3001\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 test2]# docker run -it --rm centos:centos7 bash\n\n\u30c7\u30d5\u30a9\u30eb\u30c8\u306efd\u6570\u306f1048576\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@290563aa925e /]# ulimit -n\n1048576\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002fd\u6570\u304c512\u306b\u5236\u9650\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 test2]# docker run -it --rm --ulimit=\"nofile=512\" centos:centos7 bash\n[root@master1 test2]# docker run -it --rm --ulimit=\"nofile=512\" centos:centos7 bash\n[root@2621ef057b15 /]# ulimit -n\n512\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002fd\u6570\u304c1024\u306b\u5236\u9650\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 test2]# docker run -it --rm --ulimit=\"nofile=1024\" centos:centos7 bash\n[root@38c6f57b1af8 /]# ulimit -n\n1024\n\n\n\n3.14 \u30b3\u30f3\u30c6\u30ca\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u524a\u9664\u3059\u308b\u30b9\u30af\u30ea\u30d7\u30c8\n\u3053\u308c\u304b\u3089\u4f5c\u6210\u3059\u308brmcon\u304c\u5b58\u5728\u3057\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# which rmcon\n/usr/bin/which: no rmcon in (/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin)\n\n[root@master1 ~]# touch /usr/local/bin/rmcon\n[root@master1 ~]# chmod 744 /usr/local/bin/rmcon\n[root@master1 ~]# vi /usr/local/bin/rmcon\n[root@master1 ~]# cat /usr/local/bin/rmcon\n#!/usr/bin/bash\ndocker rm $(docker ps -qa)\n\n\n[root@master1 ~]# docker ps -a\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                      PORTS               NAMES\n54851f2549eb        nginx               \"nginx -g 'daemon off\"   14 seconds ago      Exited (0) 10 seconds ago                       test\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u524a\u9664\u3059\u308b\u3002\n[root@master1 ~]# rmcon\n54851f2549eb\n[root@master1 ~]#\n\n\n\n3.15 docker\u30d6\u30ea\u30c3\u30b8\u3092\u6d41\u308c\u308b\u30d1\u30b1\u30c3\u30c8\u3092\u898b\u308b\u3002\n\u30b3\u30f3\u30c6\u30ca\u8d77\u52d5\u524d\u306eDNAT\u5b9a\u7fa9\u3092\u78ba\u8a8d\u3059\u308b\u3002\u30dd\u30fc\u30c8\u756a\u53f711111,22222\u5b9b\u306f\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u306a\u3044\u3002\n[root@master1 ~]# iptables -L -t nat -n |grep -e 11111 -e 22222\n[root@master1 ~]#\n\n\n80\u756a\u30dd\u30fc\u30c8\u3067\u5f85\u3064\u30b3\u30f3\u30c6\u30ca\u30922\u3064\u8d77\u52d5\u3059\u308b\u3002\u305d\u308c\u305e\u308c\u306e\u30db\u30b9\u30c8\u5074\u30dd\u30fc\u30c8\u756a\u53f7\u306f11111,22222\n[root@master1 ~]# docker run -d --name nginx1 -p 11111:80 nginx\n[root@master1 ~]# docker run -d --name nginx2 -p 22222:80 nginx\n\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3068\u3001DNAT\u306e\u5b9a\u7fa9\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308b\u3002\n[root@master1 ~]# iptables -L -t nat -n |grep -e 11111 -e 22222\nDNAT       tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:11111 to:172.17.0.2:80\nDNAT       tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:22222 to:172.17.0.3:80\n\n\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3057\u305f\u3068\u304d\u306e\u30db\u30b9\u30c8\u5185\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308b\u3002\n\n  +--- nginx1 ---+   +--- nginx2 ---+\n  |    port=80   |   |    port=80   |\n  |              |   |              |\n  +---- eth0 ----+   +---- eth0 ----+\n      172.17.0.2        172.17.0.3\n          |  A               |   A\n          |  |               |   |\n  +-------+--|---------------+---|--+\n  |          |  docker0(Bridge)  |  | <=== tcpdump -i docker0 tcp port 80 -nn\n  +----------|-------+-----------|--+\n             |       |           |\n             |       |           |\n [after]     |       |           | [after]\n   DstIP=172.17.0.2  |           |   DstIP=172.17.0.3\n   DstPort=80        |           |   DstPort=80\n             |       |           |\n +-------------------------- DNAT -----------------------------------------------+\n |  [root@master1 ~]# iptables -L -t nat -n |grep -e 11111 -e 22222              |\n |  DNAT   tcp  --  0.0.0.0/0      0.0.0.0/0     tcp dpt:11111 to:172.17.0.2:80  |\n |  DNAT   tcp  --  0.0.0.0/0      0.0.0.0/0     tcp dpt:22222 to:172.17.0.3:80  |\n +-------------------------------------------------------------------------------+\n                     |\n            eth0(192.168.0.10/24)\n              A                A\n              |                |\n              |                |\n  [before]    |                | [before]\n     DstIP=192.168.0.10        |   DstIP=192.168.0.10\n     DstPort=11111             |   DstPort=22222\n\n\ntcpdump\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# tcpdump -i docker0 tcp port 80 -nn\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on docker0, link-type EN10MB (Ethernet), capture size 65535 bytes\n\n\n\u5225\u306e\u30bf\u30fc\u30df\u30ca\u30eb\u3067Nginx\u306bcurl\u30b3\u30de\u30f3\u30c9\u3067\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3002\n[root@master1 ~]# curl http://192.168.0.10:11111\n<!DOCTYPE html>\n<html>\n<head>\n<title>Welcome to nginx!</title>\n\n\u3053\u306e\u6642\u3001tcpdump\u3067\u63a1\u53d6\u3057\u305f\u30d1\u30b1\u30c3\u30c8\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3002TCP\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u78ba\u7acb\u6642\u306e\u307f\u629c\u7c8b\n21:12:08.660096 IP 192.168.0.10.57391 > 172.17.0.2.80: Flags [S], seq 1382156843, win 43690, options [mss 65495,sackOK,TS val 5452241 ecr 0,nop,wscale 7], length 0\n21:12:08.660252 IP 172.17.0.2.80 > 192.168.0.10.57391: Flags [S.], seq 3030911224, ack 1382156844, win 14480, options [mss 1460,sackOK,TS val 5452241 ecr 5452241,nop,wscale 7], length 0\n21:12:08.660301 IP 192.168.0.10.57391 > 172.17.0.2.80: Flags [.], ack 1, win 342, options [nop,nop,TS val 5452241 ecr 5452241], length 0\n\n\n\u6b21\u306b\u5b9b\u5148\u30dd\u30fc\u30c8\u756a\u53f7\u309222222\u306b\u5909\u66f4\u3057\u3066\u30b3\u30f3\u30c6\u30ca\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3002\n[root@master1 ~]# curl http://192.168.0.10:22222\n<!DOCTYPE html>\n<html>\n<head>\n<title>Welcome to nginx!</title>\n\n\u5b9b\u5148TCP\u30dd\u30fc\u30c8\u756a\u53f7\u304c22222\u306e\u3068\u304d\u306etcpdump\u3067\u63a1\u53d6\u3057\u305f\u30d1\u30b1\u30c3\u30c8\n21:14:13.673223 IP 192.168.0.10.42175 > 172.17.0.3.80: Flags [S], seq 2685052290, win 43690, options [mss 65495,sackOK,TS val 5577254 ecr 0,nop,wscale 7], length 0\n21:14:13.673333 IP 172.17.0.3.80 > 192.168.0.10.42175: Flags [S.], seq 1261474781, ack 2685052291, win 14480, options [mss 1460,sackOK,TS val 5577254 ecr 5577254,nop,wscale 7], length 0\n21:14:13.673375 IP 192.168.0.10.42175 > 172.17.0.3.80: Flags [.], ack 1, win 342, options [nop,nop,TS val 5577255 ecr 5577254], length 0\n\n\n\n\n3.16 Docker\u30af\u30e9\u30a4\u30a2\u30f3\u30c8 <=> Docker\u30b5\u30fc\u30d0\u9593\u306eUNIX domain\u30bd\u30b1\u30c3\u30c8\u3092\u6d41\u308c\u308b\u30d1\u30b1\u30c3\u30c8\u3092\u898b\u308b\u3002\nDocker\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3068\u30b5\u30fc\u30d0\u306e\u9593\u306bproxy\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 ~]# socat -v UNIX-LISTEN:/tmp/dockerapi.sock UNIX-CONNECT:/var/run/docker.sock&\n[1] 9449\n\n\nDocker\u30b5\u30fc\u30d0\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b.HTTP\u30ea\u30af\u30a8\u30b9\u30c8\u3068\u30ec\u30b9\u30dd\u30f3\u30b9\u304c\u89b3\u6e2c\u3067\u304d\u308b\u3002\n[root@master1 ~]# docker -H unix:///tmp/dockerapi.sock ps -a\n> 2016/11/21 21:37:09.017349  length=95 from=0 to=94           ======> HTTP\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u958b\u59cb\nGET /v1.22/containers/json?all=1 HTTP/1.1\\r\nHost: \\r\nUser-Agent: Docker-Client/1.10.3 (linux)\\r\n\\r\n< 2016/11/21 21:37:09.019849  length=141 from=0 to=140          ========> HTTP\u30ec\u30b9\u30dd\u30f3\u30b9\u306e\u958b\u59cb\nHTTP/1.1 200 OK\\r\nContent-Type: application/json\\r\nServer: Docker/1.10.3 (linux)\\r\nDate: Mon, 21 Nov 2016 12:37:09 GMT\\r\nContent-Length: 3\\r\n\\r\n[]\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\n[root@master1 ~]#\n\n\n\n\nsocat\u306e\u4f7f\u3044\u65b9\n[root@master1 ~]# socat tcp-listen:11111 stdout\n\n\u5225\u306e\u30bf\u30fc\u30df\u30ca\u30eb\u3067\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5b9f\u884c\u3059\u308b\u3002\n[root@master1 ~]# socat tcp-connect:localhost:11111 stdin\ntest\n\n\u3082\u3046\u4e00\u65b9\u306e\u30bf\u30fc\u30df\u30ca\u30eb\n[root@master1 ~]# socat tcp-listen:11111 stdout\ntest\n\n\n\n3.17 \u30b3\u30f3\u30c6\u30ca\u306eMAC\u30a2\u30c9\u30ec\u30b9\u3068IP\u30a2\u30c9\u30ec\u30b9\u3092\u78ba\u8a8d\u3059\u308b\u65b9\u6cd5(docker network inspect bridge)\n\u30b3\u30f3\u30c6\u30ca\u30923\u3064\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -d --name nginx1 nginx\n4b93774b8e7ac70ba0f70f5ead741e3a82a10a19cf4a940ca9cb6c4ca16b6329\n[root@master1 ~]# docker run -d --name nginx2 nginx\n2f12861523f1f019d89a4dec32233c09eccad44e0a792b12a9a5e19eb857014d\n[root@master1 ~]# docker run -d --name nginx3 nginx\nf8d753a23cbcd71810d8c04d411b3a71d9908211bbeb3244cc510e21e2170e2e\n[root@master1 ~]#\n\n\ndocker network inspect bridge\u3092\u5b9f\u884c\u3059\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u304c\u3069\u3093\u306aIP/MAC\u30a2\u30c9\u30ec\u30b9\u3092\u3082\u3063\u3066\u3044\u308b\u306e\u304b\u308f\u304b\u308b\u3002\n[root@master1 ~]# docker network inspect bridge\n[\n-\u4e2d\u7565-\n        \"Containers\": {\n            \"2f12861523f1f019d89a4dec32233c09eccad44e0a792b12a9a5e19eb857014d\": {\n                \"Name\": \"nginx2\",\n                \"EndpointID\": \"53001e97e15fd900134f01884b208277796ead9795ab78c6d03631829429b6ed\",\n                \"MacAddress\": \"02:42:ac:11:00:03\",\n                \"IPv4Address\": \"172.17.0.3/16\",\n                \"IPv6Address\": \"\"\n            },\n            \"4b93774b8e7ac70ba0f70f5ead741e3a82a10a19cf4a940ca9cb6c4ca16b6329\": {\n                \"Name\": \"nginx1\",\n                \"EndpointID\": \"4f3b361b89607f78f15f3cacbbcc76e261bc75c7093ad32f32bc2e6c15135ea9\",\n                \"MacAddress\": \"02:42:ac:11:00:02\",\n                \"IPv4Address\": \"172.17.0.2/16\",\n                \"IPv6Address\": \"\"\n            },\n            \"f8d753a23cbcd71810d8c04d411b3a71d9908211bbeb3244cc510e21e2170e2e\": {\n                \"Name\": \"nginx3\",\n                \"EndpointID\": \"bd49d3847cf5372376bcf12a93414dc7eb432ad23352639c5515ea25acbc33b9\",\n                \"MacAddress\": \"02:42:ac:11:00:04\",\n                \"IPv4Address\": \"172.17.0.4/16\",\n                \"IPv6Address\": \"\"\n            }\n\u4ee5\u4e0b\u3001\u7565\n\n\n\n3.18 \u30b3\u30f3\u30c6\u30ca\u304c\u4f7f\u7528\u3059\u308b\u30c7\u30a3\u30b9\u30af\u30b5\u30a4\u30ba(dm.basesize)\u3092\u5909\u66f4\u3059\u308b\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master3 ~]# docker run -it --name centos centos:centos7 bash\n\n\u30eb\u30fc\u30c8\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306e\u30b5\u30a4\u30ba\u3092\u78ba\u8a8d\u3059\u308b\u300210G(\u2605\u5370)\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@144e5f96041b /]# df -h\nFilesystem                                                                                         Size  Used Avail Use% Mounted on\n/dev/mapper/docker-8:3-202336481-871f24af84360d9307d0015d201d28088fdbe73c6684110afb2c4fdffa13d81a \u260510G  240M  9.8G   3% /\ntmpfs                                                                                              490M     0  490M   0% /dev\ntmpfs                                                                                              490M     0  490M   0% /sys/fs/cgroup\n/dev/sda3                                                                                           40G  1.7G   38G   5% /etc/hosts\nshm                                                                                                 64M     0   64M   0% /dev/shm\n[root@144e5f96041b /]# exit\nexit\n\ndocker info\u30b3\u30de\u30f3\u30c9\u3067\u3082\u78ba\u8a8d\u3057\u3066\u307f\u308b\u300210.74 GB\u3067\u3042\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n[root@master3 ~]# docker info |grep \"Base Device Size:\"\n Base Device Size: 10.74 GB\n\n\n\u30c7\u30a3\u30b9\u30af\u30b5\u30a4\u30ba\u309210G->20G\u306b\u5909\u66f4\u3059\u308b\u3002\n[root@master3 ~]# vi /etc/sysconfig/docker-storage\nDOCKER_STORAGE_OPTIONS=--storage-opt dm.basesize=20G\n\nDocker\u3092\u505c\u6b62\u3059\u308b\u3002\u505c\u6b62\u3057\u306a\u3044\u3068\u3001/var/lib/docker\u914d\u4e0b\u304c\u524a\u9664\u3067\u304d\u306a\u3044\u3002\n[root@master3 ~]# systemctl stop docker\n\n/var/lib/docker\u914d\u4e0b\u3092\u524a\u9664\u3059\u308b\u3002\u4eca\u307e\u3067\u4f5c\u6210\u3057\u305f\u30a4\u30e1\u30fc\u30b8\u304c\u5168\u3066\u6d88\u53bb\u3055\u308c\u308b\u306e\u3067\u6ce8\u610f!!!\n[root@master3 ~]# rm -f -r /var/lib/docker/\n\nDocker\u3092\u518d\u8d77\u52d5\u3059\u308b\u3002\n[root@master3 ~]# systemctl start docker\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002/var/lib/docker\u914d\u4e0b\u3092\u524a\u9664\u3057\u305f\u306e\u3067\u3001\u518d\u5ea6\u3001\u30a4\u30e1\u30fc\u30b8\u306e\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u304c\u59cb\u307e\u308b\u3002\n[root@master3 ~]# docker run -it --name centos centos:centos7 bash\nUnable to find image 'centos:centos7' locally\nTrying to pull repository docker.io/library/centos ...\ncentos7: Pulling from docker.io/library/centos\n08d48e6f1cff: Pull complete\nDigest: sha256:b2f9d1c0ff5f87a4743104d099a3d561002ac500db1b9bfa02a783a46e0d366c\nStatus: Downloaded newer image for docker.io/centos:centos7\n\n\n\u30c7\u30a3\u30b9\u30af\u30b5\u30a4\u30ba\u3092\u78ba\u8a8d\u3059\u308b\u300220G(\u2605\u5370)\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n[root@13f57f8cd4fb /]# df -h\nFilesystem                                                                                         Size  Used Avail Use% Mounted on\n/dev/mapper/docker-8:3-135722635-214924edf11302e77f89a1d577930cd48168d4d4987cd175cb67f6d937d21aa9 \u260520G  240M   20G   2% /\ntmpfs                                                                                              490M     0  490M   0% /dev\ntmpfs                                                                                              490M     0  490M   0% /sys/fs/cgroup\n/dev/sda3                                                                                           40G  1.7G   38G   5% /etc/hosts\nshm                                                                                                 64M     0   64M   0% /dev/shm\n[root@13f57f8cd4fb /]# exit\nexit\n\ndocker info\u30b3\u30de\u30f3\u30c9\u3067\u3082\u78ba\u8a8d\u3057\u3066\u307f\u308b\u300221.47 GB\u3067\u3042\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n[root@master3 ~]# docker info |grep \"Base Device Size:\"\n Base Device Size: 21.47 GB\n\n-------------------------------------------------------------------------------------------\n0.  truncate\u30b3\u30de\u30f3\u30c9\u306e\u4f7f\u3044\u65b9\u3002\u77e5\u3089\u306a\u304b\u3063\u305f\u306e\u3067\u30e1\u30e2\n-------------------------------------------------------------------------------------------\n1K\u30b5\u30a4\u30ba\u306e\u30d5\u30a1\u30a4\u30eb\u4f5c\u6210\n[root@master1 ~]# truncate --size 1K /root/file_1K\n[root@master1 ~]# ls -la file_1K\n-rw-r--r--. 1 root root 1024 11\u6708 23 09:02 file_1K\n\n1M\u30b5\u30a4\u30ba\u306e\u30d5\u30a1\u30a4\u30eb\u4f5c\u6210\n[root@master1 ~]# truncate --size 1M /root/file_1M\n[root@master1 ~]# ls -la file_1M\n-rw-r--r--. 1 root root 1048576 11\u6708 23 09:02 file_1M\n\n1G\u30b5\u30a4\u30ba\u306e\u30d5\u30a1\u30a4\u30eb\u4f5c\u6210\n[root@master1 ~]# truncate --size 1G /root/file_1G\n[root@master1 ~]# ls -la file_1G\n-rw-r--r--. 1 root root 1073741824 11\u6708 23 09:02 file_1G\n\n\n\u3061\u306a\u307f\u306b\u3001\u3069\u306e\u30d5\u30a1\u30a4\u30eb\u3082\u5b9f\u969b\u306b\u30c7\u30a3\u30b9\u30af\u9818\u57df\u306f\u6d88\u8cbb\u3057\u3066\u3044\u306a\u3044\u3002\n[root@master1 ~]# du file_1K\n0       file_1K\n[root@master1 ~]# du file_1M\n0       file_1M\n[root@master1 ~]# du file_1G\n0       file_1G\n\n\n\n-------------------------------------------------------------------------------------------\n1. \u30eb\u30fc\u30c8\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306e\u30b5\u30a4\u30ba(10G)\u3088\u308a\u5c0f\u3055\u306a\u30b5\u30a4\u30ba(500M)\u306e\u30d5\u30a1\u30a4\u30eb\u306f\u4f5c\u6210\u3067\u304d\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u3002\n-------------------------------------------------------------------------------------------\n[root@master3 ~]# vi Dockerfile\n[root@master3 ~]# docker build -t small .\nSending build context to Docker daemon 24.06 kB\nStep 1 : FROM centos:centos7\n ---> 0584b3d2cf6d\nStep 2 : RUN truncate --size 500M /root/file\n ---> Running in 72309990b267\n ---> d9e74f07cb1a\nRemoving intermediate container 72309990b267\nSuccessfully built d9e74f07cb1a\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master3 ~]# docker run -it --rm samll bash\n\n\u30eb\u30fc\u30c8\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306e\u30b5\u30a4\u30ba\u3092\u78ba\u8a8d\u3059\u308b\u3002\u30b5\u30a4\u30ba\u306f10G(\u2605\u5370)\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@4a6240b311cb /]# df -h\nFilesystem                                                                                         Size  Used Avail Use% Mounted on\n/dev/mapper/docker-8:3-135722635-c8ee47480aa38ff8849f715f2d93d4ece493b25a3adde1bb72b783841bfae129 \u260510G  740M  9.3G   8% /\ntmpfs                                                                                              490M     0  490M   0% /dev\ntmpfs                                                                                              490M     0  490M   0% /sys/fs/cgroup\n/dev/sda3                                                                                           40G  3.2G   37G   9% /etc/hosts\nshm                                                                                                 64M     0   64M   0% /dev/shm\n[root@4a6240b311cb /]# exit\nexit\n\n\u30d5\u30a1\u30a4\u30eb\u30b5\u30a4\u30ba\u3092\u78ba\u8a8d\u3059\u308b\u3002500M\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u305f\u3002\n[root@2d0e98bd08bd /]# ls -la /root/file\n-rw-r--r--. 1 root root 524288000 Nov 22 13:14 /root/file\n\n\n\n-------------------------------------------------------------------------------------------\n2. \u30eb\u30fc\u30c8\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306e\u30b5\u30a4\u30ba(10G)\u3088\u308a\u5927\u304d\u306a\u30d5\u30a1\u30a4\u30eb(11G)\u3092\u4f5c\u6210\u3057\u3066\u3001\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3059\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u3002\n-------------------------------------------------------------------------------------------\n\u4eca\u5ea6\u306f11G\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308bDockerfile\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master3 ~]# vi Dockerfile\n[root@master3 ~]# cat Dockerfile\nFROM centos:centos7\nRUN truncate --size 11G /root/file\n\n\u30eb\u30fc\u30c8\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306e\u30b5\u30a4\u30ba(10G)\u3088\u308a\u5927\u304d\u306a\u30d5\u30a1\u30a4\u30eb(11G)\u3092\u4f5c\u6210\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u306a\u3044\u3002\n[root@master3 ~]# docker build --no-cache -t big .\nSending build context to Docker daemon 24.06 kB\nStep 1 : FROM centos:centos7\n ---> 0584b3d2cf6d\nStep 2 : RUN truncate --size 11G /root/file\n ---> Running in 40ebcbd0670c\nApplyLayer exit status 1 stdout:  stderr: write /root/file: no space left on device\n[root@master3 ~]#\n\n\n-------------------------------------------------------------------------------------------\n3. \u5b9f\u969b\u306b\u3069\u3053\u304c\u6d88\u8cbb\u3055\u308c\u308b\u304b\u78ba\u8a8d\u3057\u3066\u307f\u308b\u3002\n-------------------------------------------------------------------------------------------\n[root@e2f80a45bad0 /]# df -h\nFilesystem                                                                                      Size  Used Avail Use% Mounted on\n/dev/mapper/docker-8:3-713942-3c889cab414769b972f8b76f02a67365ffbbf868f10737e29bd959ff761ac7bc   10G  240M\u26059.8G   3% /\ntmpfs                                                                                           490M     0  490M   0% /dev\ntmpfs                                                                                           490M     0  490M   0% /sys/fs/cgroup\n/dev/sda3                                                                                        40G  5.0G   35G  13% /etc/hosts\nshm                                                                                              64M     0   64M   0% /dev/shm\n\n1G\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@e2f80a45bad0 /]# dd if=/dev/zero of=test.txt bs=1024k count=1024\n1024+0 records in\n1024+0 records out\n1073741824 bytes (1.1 GB) copied, 90.7417 s, 11.8 MB/s\n\n/dev/mapper\u914d\u4e0b\u304c\u4f7f\u308f\u308c\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@e2f80a45bad0 /]# df -h\nFilesystem                                                                                      Size  Used Avail Use% Mounted on\n/dev/mapper/docker-8:3-713942-3c889cab414769b972f8b76f02a67365ffbbf868f10737e29bd959ff761ac7bc   10G  1.3G\u26058.8G  13% /\ntmpfs                                                                                           490M     0  490M   0% /dev\ntmpfs                                                                                           490M     0  490M   0% /sys/fs/cgroup\n/dev/sda3                                                                                        40G  6.0G   34G  16% /etc/hosts\nshm                                                                                              64M     0   64M   0% /dev/shm\n\n\n\n\n\n3.19 \u30b3\u30f3\u30c6\u30ca\u306e\u30d7\u30ed\u30bb\u30b9\u3092strace\u3067\u30c7\u30d0\u30c3\u30b0\u3059\u308b\u65b9\u6cd5(nsenter)\nnginx\u306e\u30b3\u30f3\u30c6\u30ca\u306b\u306f\u3001strace\u30b3\u30de\u30f3\u30c9\u304c\u5165\u3063\u3066\u3044\u306a\u3044\u3002\nyum\u30b3\u30de\u30f3\u30c9\u3082\u5165\u3063\u3066\u3044\u306a\u3044\u306e\u3067\u3001\u305d\u3082\u305d\u3082\u3001strace\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u306a\u3044\u3002\n\u305f\u3068\u3048\u3070\u3001\u30b3\u30f3\u30c6\u30ca\u306eNginx\u3092\u30c7\u30d0\u30c3\u30b0\u3059\u308b\u3068\u304d\u3001\u3069\u306e\u3088\u3046\u306b\u3057\u305f\u3089\u826f\u3044\u304b\uff1f\n\u305d\u306e\u3088\u3046\u306a\u5834\u5408\u3001nsenter\u3092\u4f7f\u3046\u3053\u3068\u3067\u89e3\u6c7a\u3067\u304d\u308b\u3002\nNginx\u30b3\u30f3\u30c6\u30ca\u3067strace,yum\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u306bstrace\u306f\u5165\u3063\u3066\u3044\u306a\u3044\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# docker run -it --rm nginx bash\nroot@a42cfaf8c6f8:/# strace\nbash: strace: command not found\nroot@a42cfaf8c6f8:/# yum\nbash: yum: command not found\nroot@a42cfaf8c6f8:/#\n\n\n\u30db\u30b9\u30c8\u306bnsenter\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n[root@master1 ~]# docker run -v /usr/local/bin:/target --privileged jpetazzo/nsenter\nUnable to find image 'jpetazzo/nsenter:latest' locally\nTrying to pull repository docker.io/jpetazzo/nsenter ...\nlatest: Pulling from docker.io/jpetazzo/nsenter\n5c90d4a2d1a8: Downloading [===============>                                   ] 15.73 MB/51.35 MB\n-\u4e2d\u7565-\n\nDigest: sha256:a30e7da907a9abb715027677c21468005beee06251b7737c86f84fa148d572b0\nStatus: Downloaded newer image for docker.io/jpetazzo/nsenter:latest\nInstalling nsenter to /target\nInstalling docker-enter to /target\nInstalling importenv to /target\n\n\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u305fnsenter\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# docker images |grep nsenter\ndocker.io/jpetazzo/nsenter                            latest                             c16fe938c1a5        4 months ago        370.8 MB\n\nnsenter\u30b3\u30de\u30f3\u30c9\u306f\u3001\u4ee5\u4e0b\u306e\u30d1\u30b9\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u308b\u3002\n[root@master1 ~]# ls /usr/local/bin/nsenter\n/usr/local/bin/nsenter\n\n\nNginx\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u30db\u30b9\u30c8\u5074\u30dd\u30fc\u30c8\u756a\u53f711111,\u30b3\u30f3\u30c6\u30ca\u5074\u30dd\u30fc\u30c8\u756a\u53f780\u3067\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# CID=$(docker run -d --name test -p 11111:80 nginx)\n[root@master1 ~]# docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                            NAMES\n900ae34b590a        nginx               \"nginx -g 'daemon off\"   13 seconds ago      Up 11 seconds       443/tcp, 0.0.0.0:11111->80/tcp   test\n[root@master1 ~]# echo $CID\n900ae34b590a567ad396f6a02015d545b82a75608f660d5275f9a96914acc667\n\n[root@master1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n[root@master1 ~]# echo $PID\n15780\n\nnsenter\u3092\u8d77\u52d5\u3057\u3066\u3001Nginx\u30b3\u30f3\u30c6\u30ca\u306b\u63a5\u7d9a\u3059\u308b\u3002\n[root@master1 ~]# nsenter --target $PID --uts --ipc --net /bin/bash\n\nstrace\u3092\u5b9f\u884c\u3059\u308b\u305f\u3081\u3001Nginx\u306ePID\u3092\u8abf\u3079\u308b\u3002\n[root@900ae34b590a ~]# ps aux|grep nginx\nroot      15780  0.4  0.2  31752  2868 ?        Ss   11:17   0:00 nginx: master process nginx -g daemon off;\n104       15796  0.0  0.1  32144  1664 ?        S    11:17   0:00 nginx: worker process\nroot      15875  0.0  0.0 112656   972 pts/0    S+   11:18   0:00 grep --color=auto nginx\n\nNginx\u306e\u30d7\u30ed\u30bb\u30b9\u306b\u5bfe\u3057\u3066\u3001strace\u3092\u5b9f\u884c\u3059\u308b\u3002epoll\u3067\u30a4\u30d9\u30f3\u30c8\u5f85\u3061\u3002\n[root@900ae34b590a ~]# strace -ttT -f -p 15796\nProcess 15796 attached\n11:18:48.761204 epoll_wait(8, {{EPOLLIN, {u32=1517506576, u64=140502782660624}}}, 512, -1) = 1 <4.638268>\n\n\n\u3053\u306e\u3068\u304d\u3001\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3088\u308acurl\u30b3\u30de\u30f3\u30c9\u3067Nginx\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3002\n[root@master1 ~]#\n[root@master1 ~]# curl http://localhost:11111\n<!DOCTYPE html>\n<html>\n<head>\n<title>Welcome to nginx!</title>\n<style>\n\nNginx\u306e\u30a4\u30d9\u30f3\u30c8\u5f85\u3061\u304c\u89e3\u9664\u3055\u308c\u308b\u3002\n[root@900ae34b590a ~]# strace -ttT -f -p 15796\n11:18:48.761204 epoll_wait(8, {{EPOLLIN, {u32=1517506576, u64=140502782660624}}}, 512, -1) = 1 <4.638268>\u3000\u2605\u30a4\u30d9\u30f3\u30c8\u5f85\u3061\u3067\u30d6\u30ed\u30c3\u30af\n\ncurl\u30b3\u30de\u30f3\u30c9\u306780\u756a\u30dd\u30fc\u30c8\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001Nginx\u306e\u30d6\u30ed\u30c3\u30af\u304c\u89e3\u9664\u3055\u308c\u3001\u4ee5\u4e0b\u306e\u30c8\u30ec\u30fc\u30b9\u304c\u8868\u793a\u3055\u308c\u305f\u3002\n11:18:53.399994 accept4(6, {sa_family=AF_INET, sin_port=htons(44234), sin_addr=inet_addr(\"172.17.0.1\")}, [16], SOCK_NONBLOCK) = 3 <0.000048>\n11:18:53.400279 epoll_ctl(8, EPOLL_CTL_ADD, 3, {EPOLLIN|EPOLLRDHUP|EPOLLET, {u32=1517507056, u64=140502782661104}}) = 0 <0.000033>\n11:18:53.400514 epoll_wait(8, {{EPOLLIN, {u32=1517507056, u64=140502782661104}}}, 512, 60000) = 1 <0.000033>\n11:18:53.400742 recvfrom(3, \"GET / HTTP/1.1\\r\\nUser-Agent: curl\"..., 1024, 0, NULL, NULL) = 79 <0.000039>\n11:18:53.401093 stat(\"/usr/share/nginx/html/index.html\", {st_mode=S_IFREG|0644, st_size=612, ...}) = 0 <0.013186>\n11:18:53.414573 open(\"/usr/share/nginx/html/index.html\", O_RDONLY|O_NONBLOCK) = 11 <0.000241>\n11:18:53.419455 fstat(11, {st_mode=S_IFREG|0644, st_size=612, ...}) = 0 <0.000029>\n11:18:53.419783 writev(3, [{\"HTTP/1.1 200 OK\\r\\nServer: nginx/1\"..., 238}], 1) = 238 <0.000212>\n11:18:53.420595 sendfile(3, 11, [0], 612) = 612 <0.000958>\n11:18:53.421907 write(5, \"172.17.0.1 - - [23/Nov/2016:02:1\"..., 91) = 91 <0.002888>\n11:18:53.424934 close(11)               = 0 <0.000082>\n11:18:53.425137 setsockopt(3, SOL_TCP, TCP_NODELAY, [1], 4) = 0 <0.000038>\n11:18:53.425293 epoll_wait(8, {{EPOLLIN|EPOLLRDHUP, {u32=1517507056, u64=140502782661104}}}, 512, 65000) = 1 <0.009390>\n11:18:53.434845 recvfrom(3, \"\", 1024, 0, NULL, NULL) = 0 <0.000039>\n11:18:53.434999 close(3)                = 0 <0.000194>\n11:18:53.435281 epoll_wait(8,   \u2605\u3053\u3053\u3067\u3001\u307e\u305f\u30a4\u30d9\u30f3\u30c8\u5f85\u3061\u3067\u30d6\u30ed\u30c3\u30af\u3059\u308b\u3002\n\n\n\n3.20 \u30b3\u30f3\u30c6\u30ca\u304c\u51fa\u529b\u3059\u308b\u30ed\u30b0\u3092\u78ba\u8a8d\u3059\u308b\u3002(docker logs)\n-------------------------------------------------------------\n1. \u30ed\u30b0\u672b\u5c3e(-f\u30aa\u30d7\u30b7\u30e7\u30f3)\u3084\u6642\u523b\u8868\u793a(-t\u30aa\u30d7\u30b7\u30e7\u30f3)\u306e\u30ed\u30b0\u3092\u51fa\u529b\u3059\u308b.\n-------------------------------------------------------------\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -itd -p 11111:80 --name test-con nginx\nc21e8fd203992631946deb0e9eb91c6cc34eceb5cb57b56e9071a5e74867fe18\n[root@master1 ~]# docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                            NAMES\nc21e8fd20399        nginx               \"nginx -g 'daemon off\"   4 seconds ago       Up 1 seconds        443/tcp, 0.0.0.0:11111->80/tcp   test-con\n\n\n\u5225\u306e\u30bf\u30fc\u30df\u30ca\u30eb\u304b\u3089\u3001Nginx\u30b3\u30f3\u30c6\u30ca\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3002\n[root@master1 ~]# curl http://localhost:11111\n\nNginx\u304c\u51fa\u529b\u3059\u308b\u30ed\u30b0\u3092\u78ba\u8a8d\u3059\u308b\u3002-f\u306f\u30ed\u30b0\u306e\u672b\u5c3e\u3092\u8868\u793a\u3059\u308b\u3002-t\u306f\u6642\u523b\u3092\u8868\u793a\u3059\u308b\u30aa\u30d7\u30b7\u30e7\u30f3\n[root@master1 ~]# docker logs -ft test-con\n2016-11-23T07:43:51.860181000Z 172.17.0.1 - - [23/Nov/2016:07:43:51 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n2016-11-23T07:44:12.619368000Z 172.17.0.1 - - [23/Nov/2016:07:44:12 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n2016-11-23T07:44:14.394863000Z 172.17.0.1 - - [23/Nov/2016:07:44:14 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n\n-------------------------------------------------------------\n2. \u3042\u308b\u6642\u523b\u4ee5\u964d\u306e\u30ed\u30b0\u3060\u3051\u3092\u51fa\u529b\u3059\u308b\u3002(--since\u30aa\u30d7\u30b7\u30e7\u30f3)\n-------------------------------------------------------------\n\u5168\u3066\u306e\u30ed\u30b0\u3092\u8868\u793a\u3059\u308b\u3002\n[root@master1 ~]# docker logs -t test-con\n2016-11-23T07:43:51.860181000Z 172.17.0.1 - - [23/Nov/2016:07:43:51 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n2016-11-23T07:44:12.619368000Z 172.17.0.1 - - [23/Nov/2016:07:44:12 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n2016-11-23T07:44:14.394863000Z 172.17.0.1 - - [23/Nov/2016:07:44:14 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n2016-11-23T07:44:23.147067000Z 172.17.0.1 - - [23/Nov/2016:07:44:23 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n2016-11-23T07:44:29.820801000Z 172.17.0.1 - - [23/Nov/2016:07:44:29 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n2016-11-23T07:54:26.968246000Z 172.17.0.1 - - [23/Nov/2016:07:54:26 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n\u2605\n2016-11-23T07:54:28.472748000Z 172.17.0.1 - - [23/Nov/2016:07:54:28 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n2016-11-23T07:54:29.249195000Z 172.17.0.1 - - [23/Nov/2016:07:54:29 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n2016-11-23T07:57:23.897494000Z 172.17.0.1 - - [23/Nov/2016:07:57:23 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n\n\u305f\u3068\u3048\u3070\u3001\u2605\u4ee5\u964d\u306e\u30ed\u30b0\u3060\u3051\u3092\u8868\u793a\u3059\u308b\u306b\u306f\u3001--since\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u4f7f\u3046\u3002\n[root@master1 ~]# docker logs --since 2016-11-23T07:54:28.472748000Z test-con\n172.17.0.1 - - [23/Nov/2016:07:54:28 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n172.17.0.1 - - [23/Nov/2016:07:54:29 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n172.17.0.1 - - [23/Nov/2016:07:57:23 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n\n\u6b63\u78ba\u306a\u6642\u523b\u3092\u6307\u5b9a\u3057\u306a\u304f\u3066\u3082\u300107:54:28.000000000Z \u306e\u3088\u3046\u306b\u6307\u5b9a\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u308b\u3002\n[root@master1 ~]# docker logs --since 2016-11-23T07:54:28.000000000Z test-con\n172.17.0.1 - - [23/Nov/2016:07:54:28 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n172.17.0.1 - - [23/Nov/2016:07:54:29 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n172.17.0.1 - - [23/Nov/2016:07:57:23 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n[root@master1 ~]#\n\n\u4ed6\u306b\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u7701\u7565\u3057\u305f\u5834\u5408\u3067\u3082\u3001\u671f\u5f85\u901a\u308a\u306e\u30ed\u30b0\u3092\u8868\u793a\u3067\u304d\u305f\u3002\".0Z\"\n[root@master1 ~]# docker logs --since 2016-11-23T07:54:28.0Z test-con\n172.17.0.1 - - [23/Nov/2016:07:54:28 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n172.17.0.1 - - [23/Nov/2016:07:54:29 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n172.17.0.1 - - [23/Nov/2016:07:57:23 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n\n\".00Z\"\n[root@master1 ~]# docker logs --since 2016-11-23T07:54:28.00Z test-con\n172.17.0.1 - - [23/Nov/2016:07:54:28 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n172.17.0.1 - - [23/Nov/2016:07:54:29 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n172.17.0.1 - - [23/Nov/2016:07:57:23 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n\n\n\n3.21 \u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092tar\u30d5\u30a1\u30a4\u30eb\u306b\u4fdd\u5b58\u3057\u305f\u308a\u3001tar\u30d5\u30a1\u30a4\u30eb\u304b\u3089\u30a4\u30e1\u30fc\u30b8\u3092\u53d6\u308a\u51fa\u3059(export/import)\n---------------------------------------------------------------------\n1. \u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\u3092\u30d5\u30a1\u30a4\u30eb\u306b\u66f8\u304d\u51fa\u3059(export)\n---------------------------------------------------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 test]# docker run -it --name test-con centos:centos7 bash\n\n\u30b3\u30f3\u30c6\u30ca\u5185\u3067\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@7066811e42e1 /]# touch test.txt\n[root@7066811e42e1 /]# echo \"This is container\" > test.txt\n[root@7066811e42e1 /]# cat test.txt\nThis is container\n\nCtrl\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u306a\u304c\u3089\u3001P\u30ad\u30fc\u3068Q\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u3066\u3001\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u629c\u3051\u308b\u3002\n[root@7066811e42e1 /]# \n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 test]# docker ps\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\n7066811e42e1        centos:centos7      \"bash\"              28 seconds ago      Up 25 seconds                           test-con\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u505c\u6b62\u3059\u308b\u3002\u505c\u6b62\u3057\u3066\u304b\u3089\u3001\u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\u3092\u30d5\u30a1\u30a4\u30eb\u306b\u66f8\u304d\u51fa\u3059\u3002\n[root@master1 test]# docker stop test-con\ntest-con\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3092\u30d5\u30a1\u30a4\u30eb\u306b\u66f8\u304d\u51fa\u3059\u3002\n[root@master1 test]# docker export test-con > test-img.tar\n\n\u30d5\u30a1\u30a4\u30eb\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 test]# file test-img.tar\ntest-img.tar: POSIX tar archive\n\n\u30b3\u30f3\u30c6\u30ca\u3067\u4f5c\u6210\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u3092\u53d6\u308a\u51fa\u3059\u3002\n[root@master1 test]# tar xvf test-img.tar test.txt\ntest.txt\n\n\u30d5\u30a1\u30a4\u30eb\u306e\u4e2d\u8eab\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 test]# cat test.txt\nThis is container\n\n\n---------------------------------------------------------------------\n2. \u30d5\u30a1\u30a4\u30eb\u304b\u3089\u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\u3092\u53d6\u308a\u3060\u3059(import)\n---------------------------------------------------------------------\n[root@master1 test]# ls\ntest-img.tar\n\n\u30d5\u30a1\u30a4\u30eb\u304b\u3089\u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\u3092\u53d6\u308a\u51fa\u3059\u3002\n[root@master1 test]# cat test-img.tar | docker import - test-img:ver2\nsha256:37a6835802e35b05a3e095705774f4002a0e5a1799cb569d30e57dc310174ac8\n\n\u53d6\u308a\u51fa\u3057\u305f\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 test]# docker images\nREPOSITORY                                            TAG                                IMAGE ID            CREATED             SIZE\ntest-img                                              ver2                               37a6835802e3        28 seconds ago      196.5 MB\n\u4ee5\u4e0b\u3001\u7565\n\n\u767b\u9332\u3057\u305f\u30a4\u30e1\u30fc\u30b8\u304b\u3089\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 test]# docker run -it --rm test-img:ver2 bash\n\n[root@5e12df260b97 /]# ls\nanaconda-post.log  bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  test.txt  tmp  usr  var\n\n\u4f5c\u6210\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u306e\u4e2d\u8eab\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@5e12df260b97 /]# cat test.txt\nThis is container\n\n\n\n3.22 \u30a4\u30e1\u30fc\u30b8\u3092tar\u30d5\u30a1\u30a4\u30eb\u306b\u4fdd\u5b58\u3057\u305f\u308a\u3001tar\u30d5\u30a1\u30a4\u30eb\u304b\u3089\u30a4\u30e1\u30fc\u30b8\u3092\u53d6\u308a\u51fa\u3059(save/load)\n\n3.22.1 \u57fa\u672c\u7684\u306a\u4f7f\u3044\u65b9\n------------------------------------------------------\n0. \u5168\u4f53\u50cf\n------------------------------------------------------\nmaster1,master2\u306f\u4eee\u60f3\u30de\u30b7\u30f3(CentOS7.2)\u3067\u3059\u3002\n (1) \u30a4\u30e1\u30fc\u30b8\u3092tar\u306b\u4fdd\u5b58(save)\n (2) tar\u3092scp\u3067\u8ee2\u9001(master1->master2)\n (3) tar\u304b\u3089\u30a4\u30e1\u30fc\u30b8\u3092\u53d6\u308a\u51fa\u3059(load)\n\n    master1   ----------------------- master2\n\n     <save>   ------- (scp) -------->  <load>\n\n------------------------------------------------------\n1. master1\u306e\u64cd\u4f5c\n------------------------------------------------------\ntar\u30d5\u30a1\u30a4\u30eb\u306b\u4fdd\u5b58\u3059\u308b\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\n[root@master1 test2]# docker images |grep busybox\ndocker.io/busybox                                     latest                             e02e811dd08f        7 weeks ago         1.093 MB\n\n\u30a4\u30e1\u30fc\u30b8\u3092tar\u306b\u4fdd\u5b58\u3059\u308b\u3002\n[root@master1 test2]# docker save busybox > busybox_ver1.tar\n[root@master1 test2]# ls\nbusybox_ver1.tar\n\ntar\u30d5\u30a1\u30a4\u30eb\u3092\u5225\u30db\u30b9\u30c8(master2)\u306b\u8ee2\u9001\u3059\u308b\u3002\n[root@master1 test2]# scp busybox_ver1.tar root@master2:/root/test\n\n------------------------------------------------------\n2. master2\u306e\u64cd\u4f5c\n------------------------------------------------------\nmaster1\u304b\u3089\u8ee2\u9001\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master2 test]# ls\nbusybox_ver1.tar\n\ntar\u30d5\u30a1\u30a4\u30eb\u304b\u3089\u30a4\u30e1\u30fc\u30b8\u3092\u5fa9\u5143\u3059\u308b\u3002\n[root@master2 test]# docker load -i busybox_ver1.tar\n[root@master2 test]# docker images |grep busybox\ndocker.io/busybox                                     latest                             e02e811dd08f        7 weeks ago         1.093 MB\n\n\u30b3\u30f3\u30c6\u30ca\u306b\u30ed\u30b0\u30a4\u30f3\u3059\u308b\n[root@master2 test]# docker run -it busybox sh\n/ # exit\n\n\n\n3.22.2 \u767b\u9332\u6e08\u30a4\u30e1\u30fc\u30b8\u3092tar\u30d5\u30a1\u30a4\u30eb\u306b\u5909\u63db\n\u767b\u9332\u6e08\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# docker images |grep skydns\ngcr.io/google_containers/skydns                       2015-03-11-001      d808d12f05f0        22 months ago       8.811 MB\n\n\u30a4\u30e1\u30fc\u30b8\u3092tar\u30d5\u30a1\u30a4\u30eb\u306b\u4fdd\u5b58\u3059\u308b\u3002\n[root@master1 ~]# docker save gcr.io/google_containers/skydns:2015-03-11-001 > skydns.tar\n[root@master1 ~]# ls skydns.tar\nskydns.tar\n\n\u767b\u9332\u6e08\u307f\u30a4\u30e1\u30fc\u30b8\u3092\u524a\u9664\u3059\u308b\u3002\n[root@master1 ~]# docker rmi d808d12f05f0\nUntagged: gcr.io/google_containers/skydns:2015-03-11-001\nDeleted: sha256:d808d12f05f04a0f99443d803c49ac557540f0453de1599d07c0b761ddf89625\nDeleted: sha256:81a0d366188e44745f6c5ef56f7509002b96886c662697c9dbb8faf0878e8ffa\nDeleted: sha256:327cc3abb2d292aca8af2e4342914d4239e22c45d49b4b2eea53435d471c47a7\n\n\u30a4\u30e1\u30fc\u30b8\u304c\u524a\u9664\u3067\u304d\u305f\u304b\u3069\u3046\u304b\u3092\u78ba\u8a8d\u3059\u308b\u3002\u524a\u9664\u3067\u304d\u305f\u3002\n[root@master1 ~]# docker images |grep skydns\n[root@master1 ~]#\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30ed\u30fc\u30c9\u3059\u308b\u3002\n[root@master1 ~]# docker load -i skydns.tar\n\n\u30a4\u30e1\u30fc\u30b8\u304c\u767b\u9332\u3067\u304d\u305f\u304b\u3069\u3046\u304b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# docker images |grep skydns\ngcr.io/google_containers/skydns                       2015-03-11-001      d808d12f05f0        22 months ago       8.811 MB\n[root@master1 ~]#\n\n\n\u3061\u306a\u307f\u306b\u3001tar\u30d5\u30a1\u30a4\u30eb\u306e\u4e2d\u8eab\u3092\u898b\u3066\u307f\u308b\u3002\n[root@master1 ~]# tar tvf skydns.tar\ndrwxr-xr-x 0/0               0 2015-03-11 14:51 0db03cc7860ce2e801eb4f0ce4b84943cec176fcdf6db56fc37b7cf9490b7354/\n-rw-r--r-- 0/0               3 2015-03-11 14:51 0db03cc7860ce2e801eb4f0ce4b84943cec176fcdf6db56fc37b7cf9490b7354/VERSION\n-rw-r--r-- 0/0            1220 2015-03-11 14:51 0db03cc7860ce2e801eb4f0ce4b84943cec176fcdf6db56fc37b7cf9490b7354/json\n-rw-r--r-- 0/0            1024 2015-03-11 14:51 0db03cc7860ce2e801eb4f0ce4b84943cec176fcdf6db56fc37b7cf9490b7354/layer.tar\ndrwxr-xr-x 0/0               0 2015-03-11 14:51 768d4f50f65f00831244703e57f64134771289e3de919a576441c9140e037ea2/\n-rw-r--r-- 0/0               3 2015-03-11 14:51 768d4f50f65f00831244703e57f64134771289e3de919a576441c9140e037ea2/VERSION\n-rw-r--r-- 0/0             388 2015-03-11 14:51 768d4f50f65f00831244703e57f64134771289e3de919a576441c9140e037ea2/json\n-rw-r--r-- 0/0            1024 2015-03-11 14:51 768d4f50f65f00831244703e57f64134771289e3de919a576441c9140e037ea2/layer.tar\ndrwxr-xr-x 0/0               0 2015-03-11 14:51 8189e88be4567d5094319a378e339a729c56a4cfb1e4514ff1dfdb5338a9ba20/\n-rw-r--r-- 0/0               3 2015-03-11 14:51 8189e88be4567d5094319a378e339a729c56a4cfb1e4514ff1dfdb5338a9ba20/VERSION\n-rw-r--r-- 0/0             464 2015-03-11 14:51 8189e88be4567d5094319a378e339a729c56a4cfb1e4514ff1dfdb5338a9ba20/json\n-rw-r--r-- 0/0         6382592 2015-03-11 14:51 8189e88be4567d5094319a378e339a729c56a4cfb1e4514ff1dfdb5338a9ba20/layer.tar\ndrwxr-xr-x 0/0               0 2015-03-11 14:51 96c5134b442cd6446dfae4b1ae1de0aad4b0f408ccd0cf6126566a096da7a209/\n-rw-r--r-- 0/0               3 2015-03-11 14:51 96c5134b442cd6446dfae4b1ae1de0aad4b0f408ccd0cf6126566a096da7a209/VERSION\n-rw-r--r-- 0/0             464 2015-03-11 14:51 96c5134b442cd6446dfae4b1ae1de0aad4b0f408ccd0cf6126566a096da7a209/json\n-rw-r--r-- 0/0         2643968 2015-03-11 14:51 96c5134b442cd6446dfae4b1ae1de0aad4b0f408ccd0cf6126566a096da7a209/layer.tar\ndrwxr-xr-x 0/0               0 2015-03-11 14:51 b3bbc4636fc59ec067f4a877899f2e008bf3e2fe55451ef78c090dd9709b3818/\n-rw-r--r-- 0/0               3 2015-03-11 14:51 b3bbc4636fc59ec067f4a877899f2e008bf3e2fe55451ef78c090dd9709b3818/VERSION\n-rw-r--r-- 0/0             464 2015-03-11 14:51 b3bbc4636fc59ec067f4a877899f2e008bf3e2fe55451ef78c090dd9709b3818/json\n-rw-r--r-- 0/0            1024 2015-03-11 14:51 b3bbc4636fc59ec067f4a877899f2e008bf3e2fe55451ef78c090dd9709b3818/layer.tar\ndrwxr-xr-x 0/0               0 2015-03-11 14:51 b888703acbfd97fc1bce3fb2badfcf7f98da8cb6529af2be1a56ab82422a1504/\n-rw-r--r-- 0/0               3 2015-03-11 14:51 b888703acbfd97fc1bce3fb2badfcf7f98da8cb6529af2be1a56ab82422a1504/VERSION\n-rw-r--r-- 0/0             464 2015-03-11 14:51 b888703acbfd97fc1bce3fb2badfcf7f98da8cb6529af2be1a56ab82422a1504/json\n-rw-r--r-- 0/0            1024 2015-03-11 14:51 b888703acbfd97fc1bce3fb2badfcf7f98da8cb6529af2be1a56ab82422a1504/layer.tar\n-rw-r--r-- 0/0            2473 2015-03-11 14:51 d808d12f05f04a0f99443d803c49ac557540f0453de1599d07c0b761ddf89625.json\ndrwxr-xr-x 0/0               0 2015-03-11 14:51 f65db1fc72e498be5329bab6c2f9f5aa6bb4d4747644a984e53fd9dbb17db8bc/\n-rw-r--r-- 0/0               3 2015-03-11 14:51 f65db1fc72e498be5329bab6c2f9f5aa6bb4d4747644a984e53fd9dbb17db8bc/VERSION\n-rw-r--r-- 0/0             464 2015-03-11 14:51 f65db1fc72e498be5329bab6c2f9f5aa6bb4d4747644a984e53fd9dbb17db8bc/json\n-rw-r--r-- 0/0            1024 2015-03-11 14:51 f65db1fc72e498be5329bab6c2f9f5aa6bb4d4747644a984e53fd9dbb17db8bc/layer.tar\n-rw-r--r-- 0/0             697 1970-01-01 09:00 manifest.json\n-rw-r--r-- 0/0             122 1970-01-01 09:00 repositories\n[root@master1 ~]#\n\n\n\n3.23 Nginx\u30a4\u30e1\u30fc\u30b8\u306e\u3064\u304f\u308a\u65b9\n[root@master1 ~]# mkdir nginx\n[root@master1 ~]# cd nginx/\n\nDockerfile\u3092\u7de8\u96c6\u3059\u308b\u3002\n[root@master1 nginx]# vi Dockerfile\n[root@master1 nginx]# cat Dockerfile\nFROM centos:centos7\nRUN yum -y install epel-release\nRUN yum -y install nginx\nADD index.html /usr/share/nginx/html/\nCMD /usr/sbin/nginx -g 'daemon off;' -c /etc/nginx/nginx.conf\n[root@master1 nginx]#\n\nindex.html\u30d5\u30a1\u30a4\u30eb\u3092\u7de8\u96c6\u3059\u308b\u3002\n[root@master1 nginx]# vi index.html\n[root@master1 nginx]# cat index.html\nHello hana_shin\n\n[root@master1 nginx]# ls\nDockerfile  index.html\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 nginx]# docker build -t nginx-img:v1 --no-cache=true .\nSending build context to Docker daemon 3.072 kB\nStep 1 : FROM centos:centos7\n ---> 0584b3d2cf6d\nStep 2 : RUN yum -y install epel-release\n ---> Running in e48a494481c1\nLoaded plugins: fastestmirror, ovl\n-\u4ee5\u4e0b\u3001\u7565\n\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 nginx]# docker images\nREPOSITORY                                            TAG                                IMAGE ID            CREATED             SIZE\nnginx-img                                             v1                                 3df7144df03d        18 seconds ago      400.8 MB\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 nginx]# docker run -d -p 11111:80 nginx-img:v1\na6f13663ca199463519f08ca81f33f1fa5133440ed1ddf58f1d6f1d7a064d760\n\n\u30b3\u30f3\u30c6\u30ca\u306bHTTP\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3002\n[root@master1 nginx]# curl http://localhost:11111\nHello hana_shin\n\n\n\n3.24 \u30d3\u30eb\u30c9\u306b\u4e0d\u8981\u306a\u30d5\u30a1\u30a4\u30eb\u306e\u9664\u5916\u65b9\u6cd5(.dockerignore\u30d5\u30a1\u30a4\u30eb\u3092\u4f7f\u3046)\n\u30d3\u30eb\u30c9\u3059\u308b\u6642\u9593\u306f4\u79d2\n[root@master1 ~]# time docker build -t test-img --no-cache=true .\nSending build context to Docker daemon 83.64 MB\nStep 1 : FROM busybox\n ---> e02e811dd08f\nSuccessfully built e02e811dd08f\n\nreal    0m4.368s\nuser    0m0.363s\nsys     0m0.882s\n\n\n\u30d3\u30eb\u30c9\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b1G\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 ~]# dd if=/dev/zero of=./file_1G bs=1024k count=1024\n1024+0 \u30ec\u30b3\u30fc\u30c9\u5165\u529b\n1024+0 \u30ec\u30b3\u30fc\u30c9\u51fa\u529b\n1073741824 \u30d0\u30a4\u30c8 (1.1 GB) \u30b3\u30d4\u30fc\u3055\u308c\u307e\u3057\u305f\u3001 3.67382 \u79d2\u3001 292 MB/\u79d2\n\n\u30d5\u30a1\u30a4\u30eb\u30b5\u30a4\u30ba\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# ls -la file_1G\n-rw-r--r--. 1 root root 1073741824 11\u6708 23 20:33 file_1G\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\u30d3\u30eb\u30c9\u306b47\u79d2\u304b\u304b\u308b\u3002\n[root@master1 ~]# time docker build -t test-img --no-cache=true .\nSending build context to Docker daemon 1.157 GB\nStep 1 : FROM busybox\n ---> e02e811dd08f\nSuccessfully built e02e811dd08f\n\nreal    0m47.847s\nuser    0m2.671s\nsys     0m8.364s\n[root@master1 ~]#\n\n\n\u30d3\u30eb\u30c9\u5bfe\u8c61\u5916\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 ~]# vi .dockerignore\n[root@master1 ~]# cat .dockerignore\nfile_1G\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\u4eca\u5ea6\u306f3.7\u79d2\u3057\u304b\u304b\u304b\u3089\u306a\u3044\u3002\n[root@master1 ~]# time docker build -t test-img --no-cache=true .\nSending build context to Docker daemon 83.64 MB\nStep 1 : FROM busybox\n ---> e02e811dd08f\nSuccessfully built e02e811dd08f\n\nreal    0m3.764s\nuser    0m0.209s\nsys     0m1.398s\n\n\n\n3.25 systemd\u304b\u3089\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n\u30b5\u30fc\u30d3\u30b9\u5b9a\u7fa9\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 system]# pwd\n/etc/systemd/system\n[root@master1 system]# touch test.service\n[root@master1 system]# vi test.service\n[root@master1 system]# cat test.service\n[Unit]\nDescription=Simple Nginx Test\nAfter=docker.service\nRequires=docker.service\n\n[Service]\nRestart=always\nExecStart=/usr/bin/docker run --name nginx-con -p 11111:80 nginx\nExecStop=/usr/bin/docker rm -f nginx-con\n\n[Install]\nWantedBy=multi-user.target\n\n\n[root@master1 system]# systemctl enable /etc/systemd/system/test.service\nCreated symlink from /etc/systemd/system/multi-user.target.wants/test.service to /etc/systemd/system/test.service.\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 system]# systemctl start test.service\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 system]# systemctl status test.service\n\u25cf test.service - Simple Nginx Test\n   Loaded: loaded (/etc/systemd/system/test.service; enabled; vendor preset: disabled)\n   Active: active (running) since \u91d1 2016-11-25 22:47:25 JST; 7s ago\n Main PID: 20391 (docker-current)\n   Memory: 9.8M\n   CGroup: /system.slice/test.service\n           mq20391 /usr/bin/docker-current run --name nginx-con -p 11111:80 nginx\n\n11\u6708 25 22:47:25 master1 systemd[1]: Started Simple Nginx Test.\n11\u6708 25 22:47:25 master1 systemd[1]: Starting Simple Nginx Test...\n\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002Nginx\u306e\u30b3\u30f3\u30c6\u30ca\u304c\u8d77\u52d5\u3057\u3066\u3044\u308b\u3002\n[root@master1 system]# docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                            NAMES\nddd3608f807d        nginx               \"nginx -g 'daemon off\"   48 seconds ago      Up 44 seconds       443/tcp, 0.0.0.0:11111->80/tcp   nginx-con\n\n\u30b3\u30f3\u30c6\u30ca\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3002\n[root@master1 ~]# curl http://localhost:11111\n<!DOCTYPE html>\n<html>\n<head>\n<title>Welcome to nginx!</title>\n<style>\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u505c\u6b62\u3059\u308b\u3002\n[root@master1 system]# systemctl stop test.service\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 system]# docker ps\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\n\n\n\n3.26 \u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\u304b\u3089\u5c65\u6b74\u3092\u524a\u9664\u3059\u308b\u65b9\u6cd5\uff08\u79d8\u5bc6\u60c5\u5831\u3092\u524a\u9664\u3057\u305f\u3044\u5834\u5408\u306b\u4f7f\u3046\uff09\n\n--------------------------------------------------\n1. \u30c6\u30b9\u30c8\u7528\u30a4\u30e1\u30fc\u30b8\u3092\u4f5c\u6210\u3059\u308b\u3002\n--------------------------------------------------\nDockerfile\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 test2]# vi Dockerfile\n[root@master1 test2]# cat Dockerfile\nFROM centos:centos7\nRUN echo \"This is secret information\" >> /tmp/secret_key\nRUN cat /tmp/secret_key\nRUN rm /tmp/secret_key\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 test2]# docker build -t test-img:ver1 .\nSending build context to Docker daemon 2.048 kB\nStep 1 : FROM centos:centos7\n ---> 0584b3d2cf6d\nStep 2 : RUN echo \"This is secret information\" >> /tmp/secret_key\n ---> Running in ed00cad28d24\n ---> 9c6db5e3cad3\nRemoving intermediate container ed00cad28d24\nStep 3 : RUN cat /tmp/secret_key\n ---> Running in 7641391a877c\nThis is secret information\n ---> 99b9ea91137e\nRemoving intermediate container 7641391a877c\nStep 4 : RUN rm /tmp/secret_key\n ---> Running in 041fc96f4ce2\n ---> 06d81d6769f1\nRemoving intermediate container 041fc96f4ce2\nSuccessfully built 06d81d6769f1\n\n\u30a4\u30e1\u30fc\u30b8\u306b\u5bfe\u3059\u308b\u64cd\u4f5c\u5c65\u6b74\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 test2]# docker history test-img:ver1\nIMAGE               CREATED              CREATED BY                                      SIZE                COMMENT\n06d81d6769f1        About a minute ago   /bin/sh -c rm /tmp/secret_key                   0 B\n99b9ea91137e        About a minute ago   /bin/sh -c cat /tmp/secret_key                  0 B\n9c6db5e3cad3        About a minute ago   /bin/sh -c echo \"This is secret information\"    27 B\n0584b3d2cf6d        3 weeks ago          /bin/sh -c #(nop)  CMD [\"/bin/bash\"]            0 B\n<missing>           3 weeks ago          /bin/sh -c #(nop)  LABEL name=CentOS Base Ima   0 B\n<missing>           3 weeks ago          /bin/sh -c #(nop) ADD file:54df3580ac9fb66389   196.5 MB\n<missing>           12 weeks ago         /bin/sh -c #(nop)  MAINTAINER https://github.   0 B\n\n\u5c65\u6b74\u306e\u4e0a\u304b\u30892\u756a\u76ee\u306e\u64cd\u4f5c\u3092\u5b9f\u884c\u3059\u308b\u3002\u60c5\u5831\u304c\u8aad\u3081\u3066\u3057\u307e\u3046!!!\n[root@master1 test2]# docker run 99b9ea91137e cat /tmp/secret_key\nThis is secret information\n\n\n--------------------------------------------------\n2. \u30a4\u30e1\u30fc\u30b8\u304b\u3089\u5c65\u6b74\u3092\u524a\u9664\u3059\u308b\u3002\n--------------------------------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 test2]# docker run -d test-img:ver1 /bin/true\n8cb069ea1ef9bf058b7515fb6061a33a9512df956fef7b13413c926cd7403805\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 test2]# docker ps -a\nCONTAINER ID        IMAGE               COMMAND                 CREATED             STATUS                     PORTS               NAMES\n8cb069ea1ef9        test-img:ver1       \"/bin/true\"             10 seconds ago      Exited (0) 7 seconds ago                       focused_chandrasekhar\n\n\u30a4\u30e1\u30fc\u30b8\u304b\u3089\u5c65\u6b74\u3092\u524a\u9664\u3059\u308b\u3002\n[root@master1 test2]# docker export 8cb069ea1ef9 | docker import - test-img:ver1\nsha256:a1691c449d092903e16522566a747a85dbbf69486a7b1122984cf147a33594fe\n[root@master1 test2]#\n\n\u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\u306e\u5c65\u6b74\u3092\u78ba\u8a8d\u3059\u308b\u3002\u5c65\u6b74\u304c\u524a\u9664\u3055\u308c\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 test2]# docker history test-img:ver1\nIMAGE               CREATED             CREATED BY          SIZE                COMMENT\na1691c449d09        38 seconds ago                          196.5 MB            Imported from -\n\n\n\n3.27 \u30a4\u30e1\u30fc\u30b8\u4e00\u89a7\u306b\"none:none\"\u3068\u3044\u3046\u30a8\u30f3\u30c8\u30ea\u304c\u4f5c\u6210\u3055\u308c\u308b\u7406\u7531\n\u540c\u3058\u540d\u524d\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3068\u3001\u30a4\u30e1\u30fc\u30b8\u4e00\u89a7\u306e\u4e2d\u306b\"none:none\"\u3068\u3044\u3046\u30a8\u30f3\u30c8\u30ea\u304c\u4f5c\u6210\u3055\u308c\u308b\u3002\n----------------------------------------------\n1. 1\u56de\u76ee\u306e\u30d3\u30eb\u30c9\u5b9f\u884c\n----------------------------------------------\n[root@master1 test2]# less Dockerfile\n[root@master1 test2]# cat Dockerfile\nFROM centos:centos7\nRUN echo \"This is V1\" >> /tmp/version\nRUN cat /tmp/version\nRUN rm /tmp/version\n\n[root@master1 test2]# docker build -t test-img:ver1 .\n\u4ee5\u4e0b\u3001\u7565\n\n[root@master1 test2]# docker images\nREPOSITORY                                            TAG                                IMAGE ID            CREATED             SIZE\ntest-img                                              ver1                               ada297f58022        9 seconds ago       196.5 MB\n\n\n------------------------------------------------\n2. Dockerfile\u306e\u4e2d\u8eab\u3092\u66f8\u304d\u63db\u3048\u3066\u30012\u56de\u76ee\u306e\u30d3\u30eb\u30c9\u5b9f\u884c\n------------------------------------------------\n[root@master1 test2]# vi Dockerfile\n[root@master1 test2]# cat Dockerfile\nFROM centos:centos7\nRUN echo \"This is V2\" >> /tmp/version\nRUN cat /tmp/version\nRUN rm /tmp/version\n\n[root@master1 test2]# docker build -t test-img:ver1 .\n\u4ee5\u4e0b\u3001\u7565\n\n1\u56de\u76ee\u306b\u4f5c\u6210\u3057\u305f\u30a4\u30e1\u30fc\u30b8\u306e\"\u30ea\u30dd\u30b8\u30c8\u30ea\u540d:TAG\"\u304c\"none:none\"\u306b\u304b\u308f\u3063\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 test2]# docker images\nREPOSITORY                                            TAG                                IMAGE ID            CREATED              SIZE\ntest-img                                              ver1                               7a09677e71ac        8 seconds ago        196.5 MB\n<none>                                                <none>                             ada297f58022        About a minute ago   196.5 MB\n\u4ee5\u4e0b\u3001\u7565\n\n\n------------------------------------------------\n3. Dockerfile\u306e\u4e2d\u8eab\u3092\u66f8\u304d\u63db\u3048\u3066\u30013\u56de\u76ee\u306e\u30d3\u30eb\u30c9\u5b9f\u884c\n------------------------------------------------\n[root@master1 test2]# vi Dockerfile\n[root@master1 test2]# cat Dockerfile\nFROM centos:centos7\nRUN echo \"This is V3\" >> /tmp/version\nRUN cat /tmp/version\nRUN rm /tmp/version\n\n[root@master1 test2]# docker build -t test-img:ver1 .\n\u4ee5\u4e0b\u3001\u7565\n\n1\u56de\u76ee,2\u56de\u76ee\u306b\u4f5c\u6210\u3057\u305f\u30a4\u30e1\u30fc\u30b8\u306e\"\u30ea\u30dd\u30b8\u30c8\u30ea\u540d:TAG\"\u304c\"none:none\"\u306b\u304b\u308f\u3063\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 test2]# docker images\nREPOSITORY                                            TAG                                IMAGE ID            CREATED              SIZE\ntest-img                                              ver1                               77f33e665cac        7 seconds ago        196.5 MB\n<none>                                                <none>                             7a09677e71ac        About a minute ago   196.5 MB\n<none>                                                <none>                             ada297f58022        About a minute ago   196.5 MB\n\u4ee5\u4e0b\u3001\u7565\n\n\n\n\n3.28 \u30b3\u30f3\u30c6\u30ca\u306e\u30e6\u30fc\u30b6ID\u3092\u8abf\u3079\u308b\u65b9\u6cd5\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master ~]# docker run -d --name test-con nginx\ne509a143aec99f60494ffb7ece7ad4798ba7a251a84dda3b12682448fcfd940b\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master ~]# docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES\ne509a143aec9        nginx               \"nginx -g 'daemon off\"   5 seconds ago       Up 2 seconds        80/tcp, 443/tcp     test-con\n\n\u30b3\u30f3\u30c6\u30caID\u3092\u6c42\u3081\u308b\u3002\n[root@master ~]# CID=$(docker ps --no-trunc=true|grep \"test-con\"|awk '{print $1}')\n\n\u30b3\u30f3\u30c6\u30caID\u3092\u8868\u793a\u3059\u308b\u3002\n[root@master ~]# echo $CID\ne509a143aec99f60494ffb7ece7ad4798ba7a251a84dda3b12682448fcfd940b\n\n\u30d7\u30ed\u30bb\u30b9ID\u3092\u6c42\u3081\u308b\u3002\n[root@master ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u30d7\u30ed\u30bb\u30b9ID\u3092\u8868\u793a\u3059\u308b\u3002\n[root@master ~]# echo $PID\n20648\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u30e6\u30fc\u30b6ID(UID)\u3092\u8abf\u3079\u308b\u3002\u30e6\u30fc\u30b6ID(UID)\u306f0\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\u3064\u307e\u308aroot\u30e6\u30fc\u30b6\u3068\u540c\u3058\n[root@master ~]# ps -p $PID -o cmd,pid,ppid,uid,euid\nCMD                            PID   PPID   UID  EUID\nnginx: master process nginx  20648  20632     0     0\n\n\n\n3.29 \u30b3\u30f3\u30c6\u30ca\u306eIP\u30a2\u30c9\u30ec\u30b9\u3092\u8abf\u3079\u308b\u65b9\u6cd5\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -it --rm --name test-con centos:centos7 bash\n\n[root@bf30021d03ac /]# yum -y install iproute\n[root@bf30021d03ac /]# ip a\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n    inet6 ::1/128 scope host\n       valid_lft forever preferred_lft forever\n40: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP\n    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff\n  \u2605inet 172.17.0.2/16 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::42:acff:fe11:2/64 scope link\n       valid_lft forever preferred_lft forever\n[root@bf30021d03ac /]#\n\n\n\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3067\u30b3\u30f3\u30c6\u30ca\u306eIP\u30a2\u30c9\u30ec\u30b9\u3092\u78ba\u8a8d\u3059\u308b\u3002IP\u30a2\u30c9\u30ec\u30b9\u304c172.17.0.2\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# docker ps\nCONTAINER ID      IMAGE              COMMAND        CREATED             STATUS          PORTS     NAMES\nbf30021d03ac      centos:centos7     \"bash\"         9 seconds ago       Up 6 seconds              test-con\n\n[root@master1 ~]# IP=$(docker inspect -f {{.NetworkSettings.IPAddress}} test-con)\n[root@master1 ~]# echo $IP\n172.17.0.2 \u2605\n\n\n\n3.30 \u30b3\u30f3\u30c6\u30ca\u306e\u30ea\u30bd\u30fc\u30b9\u6d88\u8cbb\u3092\u8abf\u3079\u308b\u65b9\u6cd5(htop\u3092\u4f7f\u3046\u3088\u308a\u3001\u3053\u3063\u3061\u306e\u307b\u3046\u304c\u7c21\u5358\u304b\u3082\uff09\n\u30b3\u30f3\u30c6\u30ca(con0)\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -it -d --name con0 --cpu-shares=1024  busybox dd if=/dev/zero of=/dev/null\nb67ad54132fc2d05797f32830d15306484e17678af75b6505559ef8f80216f1c\n\n\u30b3\u30f3\u30c6\u30ca(con1)\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -it -d --name con1 --cpu-shares=1024  busybox dd if=/dev/zero of=/dev/null\nf3b736c38bee1b713d9da908f14bc846ad6c3522ccbe9b41410e0b6967145d20\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# docker ps\nCONTAINER ID     IMAGE         COMMAND                  CREATED             STATUS           PORTS           NAMES\nf3b736c38bee     busybox       \"dd if=/dev/zero of=/\"   5 seconds ago       Up 2 seconds                     con1\nb67ad54132fc     busybox       \"dd if=/dev/zero of=/\"   12 seconds ago      Up 10 seconds                    con0\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u7d71\u8a08\u60c5\u5831\u3092\u78ba\u8a8d\u3059\u308b\u3002CPU\u4f7f\u7528\u7387\u3001\u30e1\u30e2\u30ea\u4f7f\u7528\u91cf\u7b49\u3068\u3044\u3063\u305f\u60c5\u5831\u304c\u53d6\u5f97\u3067\u304d\u308b\u3002\n[root@master1 ~]# docker stats $(docker inspect -f {{.Name}} $(docker ps -q))\nCONTAINER           CPU %               MEM USAGE / LIMIT     MEM %               NET I/O             BLOCK I/O\n/con0               51.97%              1.057 MB / 1.027 GB   0.10%               1.296 kB / 648 B    1.108 MB / 0 B\n/con1               48.78%              1.118 MB / 1.027 GB   0.11%               718 B / 648 B       1.108 MB / 0 B\n\n\n\n3.31 \u30bf\u30b0\u306a\u3057\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u3059\u3079\u3066\u524a\u9664\u3059\u308b\n\u30bf\u30b0\u306a\u3057\u30a4\u30e1\u30fc\u30b8\u4e00\u89a7\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 test2]# docker images |grep none\n<none>                                                <none>                             987633f4efac        About a minute ago   196.5 MB\n<none>                                                <none>                             817a3d2131b4        2 minutes ago        196.5 MB\n<none>                                                <none>                             98a0ac2e3be6        7 minutes ago        196.5 MB\n\n\u30bf\u30b0\u306a\u3057\u30a4\u30e1\u30fc\u30b8\u3092\u5168\u3066\u524a\u9664\u3059\u308b\n[root@master1 test2]# docker rmi $(docker images | grep '<none>' | awk '{print$3}')\nDeleted: sha256:987633f4eface07f7d53b84cc7464182ccbcd8c2c63ae319ad324f255fce815b\n-\u4ee5\u4e0b\u3001\u7565-\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002\u30bf\u30b0\u306a\u3057\u306e\u30a4\u30e1\u30fc\u30b8\u304c\u5168\u3066\u524a\u9664\u3067\u304d\u305f\u3002\n[root@master1 test2]# docker images |grep none\n[root@master1 test2]#\n\n\n\n3.32 \u30b3\u30f3\u30c6\u30ca\u304c\u7d42\u4e86\u3059\u308b\u3068\u304d\u306e\u7d42\u4e86\u30b3\u30fc\u30c9\u306b\u3064\u3044\u3066\nExit Codes With Special Meanings\n----------------------------------------------------------------\n1. \u30b3\u30f3\u30c6\u30ca\u3092\u6b63\u5e38\u7d42\u4e86\u3059\u308b\n----------------------------------------------------------------\n[root@master1 ~]# docker run --rm busybox /bin/sh -c 'uname -r'\n3.10.0-229.el7.x86_64\n\n\u7d42\u4e86\u30b3\u30fc\u30c9\u3092\u78ba\u8a8d\u3059\u308b\u3002\u6b63\u5e38\u7d42\u4e86\u3057\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# echo $?\n0\n\n----------------------------------------------------------------\n2. \u30b3\u30f3\u30c6\u30ca\u3092\u7570\u5e38\u7d42\u4e86(\u7d42\u4e86\u30b3\u30fc\u30c9=1)\u3059\u308b\n----------------------------------------------------------------\n\u610f\u56f3\u7684\u306b\u30b3\u30f3\u30c6\u30ca\u3092\u7570\u5e38\u7d42\u4e86(\u7d42\u4e86\u30b3\u30fc\u30c9=1)\u3059\u308b\u3002\n[root@master1 ~]# docker run busybox /bin/sh -c 'exit 1'\n\n\u7d42\u4e86\u30b3\u30fc\u30c9\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# echo $?\n1\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002STATUS\u304c\"Exited (1)\"\u3068\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# docker ps -a\nCONTAINER ID      IMAGE        COMMAND                 CREATED           STATUS                     PORTS         NAMES\n1528b8e7a77f      busybox      \"/bin/sh -c 'exit 1'\"   10 seconds ago  \u2605Exited (1) 8 seconds ago                 stupefied_visvesvaraya\n\n\u5f8c\u59cb\u672b\u3002\u30b3\u30f3\u30c6\u30ca\u3092\u524a\u9664\u3059\u308b\u3002\n[root@master1 ~]# docker rm 1528b8e7a77f\n1528b8e7a77f\n\n----------------------------------------------------------------\n3. \u30b3\u30f3\u30c6\u30ca\u3092\u7570\u5e38\u7d42\u4e86(\u7d42\u4e86\u30b3\u30fc\u30c9=5)\u3059\u308b\n----------------------------------------------------------------\n\u610f\u56f3\u7684\u306b\u30b3\u30f3\u30c6\u30ca\u3092\u7570\u5e38\u7d42\u4e86(\u7d42\u4e86\u30b3\u30fc\u30c9=5)\u3059\u308b\u3002\n[root@master1 ~]# docker run busybox /bin/sh -c 'exit 5'\n\n\u7d42\u4e86\u30b3\u30fc\u30c9\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# echo $?\n5\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002STATUS\u304c\"Exited (5)\"\u3068\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# docker ps -a\nCONTAINER ID      IMAGE        COMMAND                 CREATED           STATUS                     PORTS         NAMES\n720f0ea21f28      busybox      \"/bin/sh -c 'exit 5'\"   9 seconds ago   \u2605Exited (5) 7 seconds ago                 fervent_engelbart\n\n\u5f8c\u59cb\u672b\u3002\u30b3\u30f3\u30c6\u30ca\u3092\u524a\u9664\u3059\u308b\u3002\n[root@master1 ~]# docker rm 720f0ea21f28\n720f0ea21f28\n\n----------------------------------------------------------------------------\n4. \u30b3\u30f3\u30c6\u30ca\u5185\u3067\u30b3\u30de\u30f3\u30c9\u304c\u898b\u3064\u304b\u3089\u306a\u3044\u5834\u5408\u3067\u7d42\u4e86\u3059\u308b\u5834\u5408  (\u7d42\u4e86\u30b3\u30fc\u30c9=127)\n----------------------------------------------------------------------------\n\u5b9f\u5728\u3057\u306a\u3044\u30b3\u30de\u30f3\u30c9lll\u3092\u5b9f\u884c\u3059\u308b\u3002\n[root@master1 ~]# docker run busybox /bin/sh -c 'lll'\n/bin/sh: lll: not found\n\n\u7d42\u4e86\u30b3\u30fc\u30c9\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# echo $?\n127\n\n[root@master1 ~]# docker ps -a\nCONTAINER ID      IMAGE       COMMAND             CREATED            STATUS                       PORTS        NAMES\nbb22f6b73563      busybox     \"/bin/sh -c lll\"    12 seconds ago   \u2605Exited (127) 9 seconds ago                jovial_thompson\n\n----------------------------------------------------------------\n5. Docker\u81ea\u8eab\u306e\u30a8\u30e9\u30fc\u306e\u5834\u5408(\u7d42\u4e86\u30b3\u30fc\u30c9=125)\n----------------------------------------------------------------\n[root@master1 ~]# docker run --rm --foo busybox\nflag provided but not defined: --foo\nSee '/usr/bin/docker-current run --help'.\n\n\u7d42\u4e86\u30b3\u30fc\u30c9\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# echo $?\n125\n\n\n\n3.33 \u30b3\u30f3\u30c6\u30ca\u7d42\u4e86\u6642\u306e\u6319\u52d5\u306b\u3064\u3044\u3066(--restart=on-failure,no)\n--restart=on-failure:X (X\u306f\u518d\u8d77\u52d5\u306e\u56de\u6570\u3092\u8868\u3059) \u30b3\u30f3\u30c6\u30ca\u304c\u7570\u5e38\u7d42\u4e86\uff08\u7d42\u4e86\u30b3\u30fc\u30c9\u304c0\u4ee5\u5916\uff09\u3057\u305f\u5834\u5408\u306e\u518d\u8d77\u52d5\u306e\u56de\u6570\u3092\u6307\u5b9a\u3059\u308b\u30aa\u30d7\u30b7\u30e7\u30f3\u3002\n--restart=no\u306f\u3001\u30b3\u30f3\u30c6\u30ca\u304c\u7570\u5e38\u7d42\u4e86\u3057\u3066\u3082\u518d\u8d77\u52d5\u3057\u306a\u3044\u3088\u3046\u306b\u3059\u308b\u30aa\u30d7\u30b7\u30e7\u30f3\u3002\n\n\n---------------------------------------------------------\n1. \u7570\u5e38\u7d42\u4e86\u6642\u306e --restart=on-failure \u306e\u52d5\u4f5c\u3092\u78ba\u8a8d\u3059\u308b\u3002\n---------------------------------------------------------\ndocker events\u3092\u5b9f\u884c\u3059\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u306e\u958b\u59cb\u3001\u7d42\u4e86\u306e\u30a4\u30d9\u30f3\u30c8\u3092\u5f97\u308b\u305f\u3081\u3001grep\u3067\u7d5e\u308a\u8fbc\u3080\u3002\n[root@master1 ~]# docker events |grep -e start -e die\n\n\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3092\u958b\u304f\u3002on-failure:3\u3092\u4ed8\u3051\u3066\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run --restart=on-failure:3 busybox /bin/sh -c 'exit 1'\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# docker ps -a\nCONTAINER ID     IMAGE       COMMAND                 CREATED           STATUS                              PORTS      NAMES\n2e8167f2125b     busybox     \"/bin/sh -c 'exit 1'\"   6 seconds ago   \u2605Exited (1) Less than a second ago              thirsty_ardinghelli\n\ndocker events\u3092\u78ba\u8a8d\u3059\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u304c3\u56de\u518d\u8d77\u52d5\u3092\u3057\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\u518d\u8d77\u52d5\u306f\u25cf\u5370\u306e\u90e8\u5206\n[root@master1 ~]# docker events |grep -e start -e die\n2016-12-06T22:11:09.171061352+09:00 container  start 2e8167f2125bf21f05193ca43e63a665685e05a94f356b48623cde97b1539615 (image=busybox, name=thirsty_ardinghelli)\n2016-12-06T22:11:09.991771696+09:00 container  die 2e8167f2125bf21f05193ca43e63a665685e05a94f356b48623cde97b1539615 (image=busybox, name=thirsty_ardinghelli)\n2016-12-06T22:11:10.193297589+09:00 container\u25cfstart 2e8167f2125bf21f05193ca43e63a665685e05a94f356b48623cde97b1539615 (image=busybox, name=thirsty_ardinghelli)\n2016-12-06T22:11:10.738386606+09:00 container  die 2e8167f2125bf21f05193ca43e63a665685e05a94f356b48623cde97b1539615 (image=busybox, name=thirsty_ardinghelli)\n2016-12-06T22:11:11.139880436+09:00 container\u25cfstart 2e8167f2125bf21f05193ca43e63a665685e05a94f356b48623cde97b1539615 (image=busybox, name=thirsty_ardinghelli)\n2016-12-06T22:11:11.788550292+09:00 container  die 2e8167f2125bf21f05193ca43e63a665685e05a94f356b48623cde97b1539615 (image=busybox, name=thirsty_ardinghelli)\n2016-12-06T22:11:12.848497457+09:00 container\u25cfstart 2e8167f2125bf21f05193ca43e63a665685e05a94f356b48623cde97b1539615 (image=busybox, name=thirsty_ardinghelli)\n2016-12-06T22:11:13.528665703+09:00 container  die 2e8167f2125bf21f05193ca43e63a665685e05a94f356b48623cde97b1539615 (image=busybox, name=thirsty_ardinghelli)\n\u4ee5\u4e0b\u3001\u4f55\u3082\u51fa\u529b\u3055\u308c\u306a\u3044\u3002\n\n\n---------------------------------------------------------\n2. \u6b63\u5e38\u7d42\u4e86\u6642\u306e --restart=on-failure \u306e\u52d5\u4f5c\u3092\u78ba\u8a8d\u3059\u308b\u3002\n---------------------------------------------------------\ndocker events\u3092\u5b9f\u884c\u3059\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u306e\u958b\u59cb\u3001\u7d42\u4e86\u306e\u30a4\u30d9\u30f3\u30c8\u3092\u5f97\u308b\u305f\u3081\u3001grep\u3067\u7d5e\u308a\u8fbc\u3080\u3002\n[root@master1 ~]# docker events |grep -e start -e die\n\n\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3092\u958b\u304f\u3002on-failure:3\u3092\u4ed8\u3051\u3066\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run --restart=on-failure:3 busybox /bin/sh -c 'exit 0'\n[root@master1 ~]# echo $?\n0\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# docker ps -a\nCONTAINER ID      IMAGE        COMMAND                 CREATED           STATUS                     PORTS       NAMES\ne9bef69f4b79      busybox      \"/bin/sh -c 'exit 0'\"   9 seconds ago   \u2605Exited (0) 7 seconds ago               sick_davinci\n\ndocker events\u3092\u78ba\u8a8d\u3059\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u304c\u518d\u8d77\u52d5\u3057\u3066\u3044\u306a\u3044\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# docker events |grep -e start -e die\n2016-12-06T22:23:51.403847392+09:00 container start e9bef69f4b79595cfac312c39550e567229c44f5569de009f565b8b6dea38967 (image=busybox, name=sick_davinci)\n2016-12-06T22:23:52.449435115+09:00 container die e9bef69f4b79595cfac312c39550e567229c44f5569de009f565b8b6dea38967 (image=busybox, name=sick_davinci)\n\u4ee5\u4e0b\u3001\u4f55\u3082\u51fa\u529b\u3055\u308c\u306a\u3044\u3002\n\n\n------------------------------------------------------\n3. --restart=no(\u30c7\u30d5\u30a9\u30eb\u30c8\uff09\u306e\u52d5\u4f5c\u3092\u78ba\u8a8d\u3059\u308b\u3002\n------------------------------------------------------\ndocker events\u3092\u5b9f\u884c\u3059\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u306e\u958b\u59cb\u3001\u7d42\u4e86\u306e\u30a4\u30d9\u30f3\u30c8\u3092\u5f97\u308b\u305f\u3081\u3001grep\u3067\u7d5e\u308a\u8fbc\u3080\u3002\n[root@master1 ~]# docker events |grep -e start -e die\n\n\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3092\u958b\u304f\u3002\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run busybox /bin/sh -c 'exit 1'\n[root@master1 ~]# echo $?\n1\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# docker ps -a\nCONTAINER ID       IMAGE       COMMAND                 CREATED            STATUS                      PORTS         NAMES\naf4d7b72ebf7       busybox     \"/bin/sh -c 'exit 1'\"   16 seconds ago   \u2605Exited (1) 14 seconds ago                 big_mirzakhani\n\ndocker events\u3092\u78ba\u8a8d\u3059\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u304c\u518d\u8d77\u52d5\u3057\u3066\u3044\u306a\u3044\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# docker events |grep -e start -e die\n2016-12-06T22:17:32.421207276+09:00 container start af4d7b72ebf78122596b9c90370f1511bf9e454a272e2940f80fed0cc5af9243 (image=busybox, name=big_mirzakhani)\n2016-12-06T22:17:33.363000228+09:00 container die af4d7b72ebf78122596b9c90370f1511bf9e454a272e2940f80fed0cc5af9243 (image=busybox, name=big_mirzakhani)\n\u4ee5\u4e0b\u3001\u4f55\u3082\u51fa\u529b\u3055\u308c\u306a\u3044\u3002\n\n\n\n3.34 \u4e00\u822c\u30e6\u30fc\u30b6\u6a29\u9650\u3067\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\uff08\u305f\u3060\u3057\u8d77\u52d5\u3057\u305f\u30b3\u30f3\u30c6\u30ca\u306f\u7279\u6a29\u30e6\u30fc\u30b6\u6a29\u9650\u3067\u52d5\u4f5c\uff09\nDocker-docs-ja\u53c2\u7167\n-----------------------------------------------------\n1. \u6e96\u5099(\u7279\u6a29\u30e6\u30fc\u30b6(root)\u3067\u884c\u3046)\n-----------------------------------------------------\ngroup\u3092\u78ba\u8a8d\u3059\u308b\u3002docker\u30b0\u30eb\u30fc\u30d7\u306f\u5b58\u5728\u3057\u306a\u3044\u3002\n[root@master1 ~]# cat /etc/group|grep docker\ndockerroot:x:993:\n\ndocker\u30b0\u30eb\u30fc\u30d7\u3092\u8ffd\u52a0\u3059\u308b\u3002\n[root@master1 ~]# groupadd docker\n\ngroup\u3092\u78ba\u8a8d\u3059\u308b\u3002docker\u30b0\u30eb\u30fc\u30d7\u304c\u8ffd\u52a0\u3055\u308c\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# cat /etc/group|grep docker\ndockerroot:x:993:\ndocker:x:1002:\n\n\u30e6\u30fc\u30b6\u3092\u8ffd\u52a0\u3059\u308b\u3002\n[root@master1 ~]# adduser hana_shin\n[root@master1 ~]# passwd hana_shin\n\ndocker\u30b0\u30eb\u30fc\u30d7\u306b\u30e6\u30fc\u30b6(hana_shin)\u3092\u8ffd\u52a0\u3059\u308b\u3002\n[root@master1 ~]# usermod -aG docker hana_shin\n[root@master1 ~]# cat /etc/group|grep docker\ndockerroot:x:993:\ndocker:x:1002:hana_shin\n\nDocker\u3092\u518d\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# systemctl restart docker\n[root@master1 ~]#\n\n-----------------------------------------------------\n2. \u4e00\u822c\u30e6\u30fc\u30b6\u6a29\u9650\u3067Docker\u3092\u8d77\u52d5\u3059\u308b\u3002\n-----------------------------------------------------\n\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3088\u308a\u3001\u4e00\u822c\u30e6\u30fc\u30b6\u3067\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u3002\n[hana_shin@master1 ~]$\n[hana_shin@master1 ~]$ id\nuid=1001(hana_shin) gid=1001(hana_shin) groups=1001(hana_shin),1002(docker) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[hana_shin@master1 ~]$ docker run -it --name test-con centos:centos7 bash\n\nCtrl\u3092\u62bc\u4e0b\u3057\u306a\u304c\u3089\u3001P\u30ad\u30fc\u3068Q\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u3066\u3001\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u629c\u3051\u308b\u3002\n[root@f1e13169655f /]# [hana_shin@master1 ~]$\n\n\u30db\u30b9\u30c8\u3067\u3001\u30b3\u30f3\u30c6\u30ca\u306e\u30e6\u30fc\u30b6ID\u7b49\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[hana_shin@master1 ~]$ CID=$(docker ps --no-trunc=true|grep \"test-con\"|awk '{print $1}')\n[hana_shin@master1 ~]$ PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u4e00\u822c\u30e6\u30fc\u30b6(hana_shin)\u6a29\u9650\u3067\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3067\u304d\u305f\u3002\n[hana_shin@master1 ~]$ ps -p $PID -o comm,pid,ppid,uid,euid\nCOMMAND            PID   PPID   UID  EUID\nbash              2079   1655     0     0\n\n\u89aa\u30d7\u30ed\u30bb\u30b9\u3092\u78ba\u8a8d\u3059\u308b\u3002\u89aa\u30d7\u30ed\u30bb\u30b9\u306fdocker-current\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[hana_shin@master1 ~]$ ps -p 1655 -o comm,pid,ppid,uid,euid\nCOMMAND            PID   PPID   UID  EUID\ndocker-current    1655      1     0     0\n\n\u5f8c\u59cb\u672b\u3002\u30b3\u30f3\u30c6\u30ca\u3092\u7d42\u4e86\u3059\u308b\u3002\n[hana_shin@master1 ~]$ docker stop f1e13169655f\nf1e13169655f\n[hana_shin@master1 ~]$ docker ps -a\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                       PORTS               NAMES\nf1e13169655f        centos:centos7      \"bash\"              16 minutes ago      Exited (137) 3 seconds ago                       test-con\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u524a\u9664\u3059\u308b\u3002\n[hana_shin@master1 ~]$ docker rm f1e13169655f\nf1e13169655f\n[hana_shin@master1 ~]$\n\n-----------------------------------------------------\n3. \u5f8c\u59cb\u672b\uff08\u30b0\u30eb\u30fc\u30d7\u304b\u3089\u30e6\u30fc\u30b6\u3092\u524a\u9664\u3059\u308b\uff09\n-----------------------------------------------------\n[root@master1 ~]# gpasswd -d hana_shin docker\n\u30e6\u30fc\u30b6 hana_shin \u3092\u30b0\u30eb\u30fc\u30d7 docker \u304b\u3089\u524a\u9664\n[root@master1 ~]# cat /etc/group|grep docker\ndockerroot:x:993:\ndocker:x:1002:\n\n\n\n3.35 userns-remap\uff08\u4f7f\u3044\u65b9\u304c\u3044\u307e\u3044\u3061\u308f\u304b\u3089\u306a\u3044\u3002\u3002\uff09\n--userns-remap \u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u6307\u5b9a\u3059\u308b\u3053\u3068\u3067\u3001 /etc/subuid \u3068 /etc/subguid \u30d5\u30a1\u30a4\u30eb\u304c\u30e6\u30fc\u30b6\u3068\u30aa\u30d7\u30b7\u30e7\u30f3\u306e\u30b0\u30eb\u30fc\u30d7\u7528\u306b\u4f7f\u308f\u308c\u307e\u3059\u3002\nDocker for your users - Introducing user namespace/a>\nOracle\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\n\n------------------------------------------------------------------------\n1. \u6e96\u5099(CentOS7.2\u4ee5\u4e0a\u304c\u5fc5\u8981)\n------------------------------------------------------------------------\n[root@master1 ~]# uname -r\n3.10.0-327.36.3.el7.x86_64\n\ndocker\u5b9a\u7fa9\u30d5\u30a1\u30a4\u30eb\u3092\u7de8\u96c6\u3059\u308b\u3002\"--userns-remap=default\"\u3092\u8ffd\u52a0\u3059\u308b\u3002\n[root@master1 ~]# vi /etc/sysconfig/docker\nOPTIONS='--userns-remap=default'\n\n--userns-remap=default\u3092\u6307\u5b9a\u3059\u308b\u3068\u3001dockremap\u3068\u3044\u3046\u30e6\u30fc\u30b6\u3068\u30b0\u30eb\u30fc\u30d7\u304c\u3064\u304f\u308c\u308b\u306e\u3067\n\u305d\u308c\u305e\u308c\u306eID\u3092\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306b\u5b9a\u7fa9\u3057\u3066\u304a\u304f\u3002\n[root@master1 ~]# echo dockremap:500000:65536 > /etc/subuid\n[root@master1 ~]# echo dockremap:500000:65536 > /etc/subgid\n\n\u30ab\u30fc\u30cd\u30eb\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u30d1\u30e9\u30e1\u30fc\u30bf(user_namespace.enable=1)\u3092\u8ffd\u52a0\u3059\u308b\u3002\n[root@master1 ~]# vi /etc/sysconfig/grub\nGRUB_CMDLINE_LINUX=\"rhgb quiet biosdevname=0 net.ifnames=0 user_namespace.enable=1\"\n\n\u8a2d\u5b9a\u3092\u6709\u52b9\u306b\u3059\u308b\u3002\n[root@master1 ~]# grub2-mkconfig -o /boot/grub2/grub.cfg\nGenerating grub configuration file ...\nFound linux image: /boot/vmlinuz-3.10.0-229.el7.x86_64\nFound initrd image: /boot/initramfs-3.10.0-229.el7.x86_64.img\nFound linux image: /boot/vmlinuz-0-rescue-f9ce816285894f709c0fd8ecf27b8212\nFound initrd image: /boot/initramfs-0-rescue-f9ce816285894f709c0fd8ecf27b8212.img\ndone\n\n\u30ab\u30fc\u30cd\u30eb\u3092\u518d\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# shutdown -r now\n\n------------------------------------------------------------------------\n2. \u30ab\u30fc\u30cd\u30eb\u518d\u8d77\u52d5\u5f8c\n------------------------------------------------------------------------\n\u30ab\u30fc\u30cd\u30eb\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u78ba\u8a8d\u3059\u308b\u3002\u898b\u3084\u3059\u304f\u3059\u308b\u305f\u3081\u9014\u4e2d\u3067\u6298\u308a\u8fd4\u3057\u3066\u3044\u307e\u3059\u3002\n[root@master1 ~]# cat /proc/cmdline\nBOOT_IMAGE=/vmlinuz-3.10.0-327.36.3.el7.x86_64 root=UUID=c2cb61fd-0e07-4e92-bd38-f76181d9be81 \n    ro rhgb quiet biosdevname=0 net.ifnames=0 user_namespace.enable=1 systemd.debug LANG=ja_JP.UTF-8\n\nDocker\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\u898b\u3084\u3059\u304f\u3059\u308b\u305f\u3081\u9014\u4e2d\u3067\u6298\u308a\u8fd4\u3057\u3066\u3044\u307e\u3059\u3002\n[root@master1 ~]# ps aux|grep docker\nroot       1066  2.9  3.2 586576 32460 ?        Ssl  18:26   0:09 /usr/bin/docker-current daemon \n  --exec-opt native.cgroupdriver=systemd \n  --userns-remap=default \n  --storage-opt dm.basesize=50G \n  --insecure-registry master1:12345\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -it --name test-con busybox sh\n/ # id\nuid=0(root) gid=0(root) groups=10(wheel)\n\n\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3092\u8d77\u52d5\u3059\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u306eUID\u3092\u78ba\u8a8d\u3059\u308b\u3002UID=500000\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# CID=$(docker ps --no-trunc=true|grep \"test-con\"|awk '{print $1}')\n[root@master1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n[root@master1 ~]# ps -p $PID -o comm,pid,ppid,uid,euid\nCOMMAND            PID   PPID   UID  EUID\nsh                1489   1067 500000 500000\n\n\u3042\u3068\u59cb\u672b\u3002\u30b3\u30f3\u30c6\u30ca\u3092\u524a\u9664\u3059\u308b\u3002\n[root@master1 ~]# docker rm -f test-con\ntest-con\n\n-----------------------------------------------------\n3. UID,GID\u3092\u5909\u66f4\u3059\u308b\u3002\n-----------------------------------------------------\nUID\u3092\u5909\u66f4\u3059\u308b\u3002\n[root@master1 ~]# vi /etc/subuid\n[root@master1 ~]# cat /etc/subuid\ndockremap:510000:65536\n\nGID\u3092\u5909\u66f4\u3059\u308b\u3002\n[root@master1 ~]# vi /etc/subgid\n[root@master1 ~]# cat /etc/subgid\ndockremap:510000:65536\n\nDocker\u3092\u518d\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# systemctl restart docker\n[root@master1 ~]#\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\n[root@master1 ~]# docker run -it --name test-con busybox sh\n/ # id\nuid=0(root) gid=0(root) groups=10(wheel)\n\nCtrl\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u306a\u304c\u3089\u3001P\u30ad\u30fc\u3068Q\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b\u3002\n/ # [root@master1 ~]#\n\n\u30b3\u30f3\u30c6\u30ca\u306eUID\u3092\u78ba\u8a8d\u3059\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u304cUID=510000\u3067\u52d5\u4f5c\u3057\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# CID=$(docker ps --no-trunc=true|grep \"test-con\"|awk '{print $1}')\n[root@master1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n[root@master1 ~]# ps -p $PID -o comm,pid,ppid,uid,euid\nCOMMAND            PID   PPID   UID  EUID\nsh                4707   4540 510000 510000\n\n\n\n3.36 --user\u30aa\u30d7\u30b7\u30e7\u30f3\u306e\u4f7f\u3044\u65b9\n--user\u306b\u6307\u5b9a\u3059\u308b\u30e6\u30fc\u30b6(\u307e\u305f\u306fUID)\u306f\u3001\u30b3\u30f3\u30c6\u30ca\u5185\u306e\u30e6\u30fc\u30b6\uff08\u307e\u305f\u306fUID)\u3092\u6307\u5b9a\u3059\u308b\u3002\n\u4ee5\u4e0b\u306e\u4f8b\u3067\u306f\u3001centos7\u3068nginx\u306e\u30b3\u30f3\u30c6\u30ca\u3067\u306f\u3001daemon\u30e6\u30fc\u30b6\u306eUID\u304c\u9055\u3046\u3053\u3068\u3092\u793a\u3057\u3066\u3044\u308b\u3002\n----------------------------------------------------\n1. centos7\u30b3\u30f3\u30c6\u30ca\u3067\u306f\u3001daemon\u30e6\u30fc\u30b6\u306eUID\u306f2\u3002\n----------------------------------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -it --user=daemon:daemon --name test-con centos:centos7 bash\n\nUID\u3092\u78ba\u8a8d\u3059\u308b\u3002UID=2\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\nbash-4.2$ id\nuid=2(daemon) gid=2(daemon) groups=2(daemon)\n\npasswd\u30d5\u30a1\u30a4\u30eb\u3067UID\u3092\u78ba\u8a8d\u3059\u308b\u3002UID=2\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\nbash-4.2$ grep daemon /etc/passwd\ndaemon:x:2:2:daemon:/sbin:/sbin/nologin\n\nCtrl\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u306a\u304c\u3089P\u30ad\u30fc\u3068Q\u30ad\u30fc\u3092\u62bc\u3057\u3066\u3001\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u629c\u3051\u308b\u3002\nbash-4.2$ [root@master1 ~]#\n\n\u30b3\u30f3\u30c6\u30caID\u3092\u6c42\u3081\u308b\u3002\n[root@master1 ~]# CID=$(docker ps --no-trunc=true|grep -w \"test-con\"|awk '{print $1}')\n[root@master1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u30b3\u30f3\u30c6\u30ca\u306eUID\u3092\u6c42\u3081\u308b\u3002UID=2\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# ps -p $PID -o comm,pid,ppid,uid,euid\nCOMMAND            PID   PPID   UID  EUID\nbash              6396   1028   \u26052     2\n\n----------------------------------------------------\n2. nginx\u30b3\u30f3\u30c6\u30ca\u3067\u306f\u3001daemon\u30e6\u30fc\u30b6\u306eUID\u306f1\u3002\n----------------------------------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -it --user=daemon:daemon --name test-con nginx bash\n\nUID\u3092\u78ba\u8a8d\u3059\u308b\u3002UID=1\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\ndaemon@6acee3f32043:/$ id\nuid=1(daemon) gid=1(daemon) groups=1(daemon)\n\npasswd\u30d5\u30a1\u30a4\u30eb\u3067UID\u3092\u78ba\u8a8d\u3059\u308b\u3002UID=1\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\ndaemon@929d7b11ba72:/$ grep daemon /etc/passwd\ndaemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin\n\nCtrl\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u306a\u304c\u3089P\u30ad\u30fc\u3068Q\u30ad\u30fc\u3092\u62bc\u3057\u3066\u3001\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u629c\u3051\u308b\u3002\n/ $ [root@master1 ~]#\n\n\u30b3\u30f3\u30c6\u30caID\u3092\u6c42\u3081\u308b\u3002\n[root@master1 ~]# CID=$(docker ps --no-trunc=true|grep -w \"test-con\"|awk '{print $1}')\n[root@master1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u30b3\u30f3\u30c6\u30ca\u306eUID\u3092\u6c42\u3081\u308b\u3002UID=1\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# ps -p $PID -o comm,pid,ppid,uid,euid\nCOMMAND            PID   PPID   UID  EUID\nsh                6957   1028   \u26051     1\n\n\n\n3.37 \u30b3\u30f3\u30c6\u30ca\u306e\u60c5\u5831\u3092\u6574\u5f62\u3057\u3066\u51fa\u529b\u3059\u308b\u65b9\u6cd5(--format)\nhttp://docs.docker.jp/engine/reference/commandline/ps.html\n[root@master1 ~]# docker ps --format \"table {{.ID}}\\t{{.Status}}\\t{{.Image}}\"\nCONTAINER ID        STATUS              IMAGE\n847c578f3c8f        Up About a minute   gcr.io/google_containers/skydns:2015-03-11-001\n517e07f64736        Up 4 minutes        gcr.io/google_containers/kube2sky:1.11\ncca839d03bac        Up 28 minutes       nginx\n27727fcf9348        Up 28 minutes       registry.access.redhat.com/rhel7/pod-infrastructure:latest\nbdefbe6a6e33        Up 28 minutes       nginx\n4bbd8a95cc0f        Up 28 minutes       registry.access.redhat.com/rhel7/pod-infrastructure:latest\n\n\n\n3.38 dokcer\u30a4\u30e1\u30fc\u30b8\u304b\u3089Pod\u3092\u8d77\u52d5\u3059\u308b\nDockerfile\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 dockerfile]# vi Dockerfile\n[root@master1 dockerfile]# cat Dockerfile\nFROM centos:centos7\nRUN useradd user1\nUSER user1\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 dockerfile]# docker build -t hana/test-img:v1 --no-cache=true .\nSending build context to Docker daemon 3.072 kB\n-\u4ee5\u4e0b\u3001\u7565-\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 dockerfile]# docker images hana/test-img:v1\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nhana/test-img       v1                  d8de1bc46638        43 seconds ago      196.5 MB\n\nPod\u5b9a\u7fa9\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 dockerfile]# vi test.yaml\n[root@master1 dockerfile]# cat test.yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  name: test\nspec:\n  restartPolicy: Never\n  containers:\n  - name: test\n    image: hana/test-img:v1\n    command: [\"sleep\", \"3600\"]\n\nPod\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 dockerfile]# kubectl create -f test.yaml\npod \"test\" created\n\nPod\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 dockerfile]# kubectl get pod\nNAME      READY     STATUS    RESTARTS   AGE\ntest      1/1       Running   0          7s\n\nPod\u3067bash\u3092\u5b9f\u884c\u3059\u308b\u3002\n[root@master1 dockerfile]# kubectl exec -it test bash\n[user1@test /]$ id\nuid=1000(user1) gid=1000(user1) groups=1000(user1)\n[user1@test /]$ cat /etc/redhat-release\nCentOS Linux release 7.2.1511 (Core)\n[user1@test /]$\n\n\n\n3.39 \u30b3\u30f3\u30c6\u30ca\u306eGUI\u3092\u5229\u7528\u3059\u308b\u3002\n\u4e0a\u624b\u304f\u3044\u304b\u306a\u3044\u3002\u3002\u3002\n\nDockerfile\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 dockergui]# vi Dockerfile\n[root@master1 dockergui]# cat Dockerfile\nFROM centos:centos7.2.1511\nRUN yum -y install firefox\nRUN groupadd -g 2002 guiuser\nRUN useradd -d /home/guiuser -s /bin/bash -m guiuser -u 2002 -g 2002\nUSER guiuser\nENV HOME /home/guiuser\nCMD /usr/bin/firefox\n\n\u30e6\u30fc\u30b6\u3092\u8ffd\u52a0\u3059\u308b\u3002\n[root@master1 dockergui]# adduser guiuser\n[root@master1 dockergui]# cat /etc/passwd|grep guiuser\nguiuser:x:2002:2002::/home/guiuser:/bin/bash\n[root@master1 dockergui]# cat /etc/group|grep guiuser\nguiuser:x:2002:\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 dockergui]# docker build -t gui .\nSending build context to Docker daemon 2.048 kB\nStep 1 : FROM centos:centos7.2.1511\n ---> feac5e0dfdb2\nStep 2 : RUN yum -y install firefox\n ---> Running in 5e3c45a8b3e8\nLoaded plugins: fastestmirror\n\n-\u4e2d\u7565-\n\nComplete!\n ---> 5edd4cd2c3c9\nRemoving intermediate container 5e3c45a8b3e8\nStep 3 : RUN groupadd -g 2002 guiuser\n ---> Running in 27c81dd37230\n ---> 93a3a4a1b09d\nRemoving intermediate container 27c81dd37230\nStep 4 : RUN useradd -d /home/guiuser -s /bin/bash -m guiuser -u 2002 -g 2002\n ---> Running in 127631b45428\n ---> afa1633e5c1c\nRemoving intermediate container 127631b45428\nStep 5 : USER guiuser\n ---> Running in f6be57dabc5b\n ---> 3110bf85d8fb\nRemoving intermediate container f6be57dabc5b\nStep 6 : ENV HOME /home/guiuser\n ---> Running in 27a5cdd1c695\n ---> d5700b8b5316\nRemoving intermediate container 27a5cdd1c695\nStep 7 : CMD /usr/bin/firefox\n ---> Running in 0df2f2d03910\n ---> fcf6a8321176\nRemoving intermediate container 0df2f2d03910\nSuccessfully built fcf6a8321176\n\n[root@master1 dockergui]# docker images gui\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\ngui                 latest              fcf6a8321176        58 seconds ago      421.9 MB\n\n[root@master1 dockergui]# docker run -v /tmp/.X11-unix:/tmp/.X11-unix -e DISPLAY=$DISPLAY -h $HOSTNAME -v $HOME/.Xauthority:/home/$USER/.Xauthority gui\nError: cannot open display:\n\n\n\n3.xx \u4eee\u60f3\u5316\u74b0\u5883\u3067\u5229\u7528\u3057\u3066\u3044\u308b\u30b2\u30b9\u30c8OS\u306e\u30a4\u30e1\u30fc\u30b8\u3092Docker\u74b0\u5883\u3078\u306e\u79fb\u690d\n1.virt-tar-out\u3092\u4f7f\u3063\u3066\u3001qcow2\u3092\u5727\u7e2e\u30d5\u30a1\u30a4\u30eb(tgz)\u306b\u5909\u63db\n2.docker import\u3092\u4f7f\u3063\u3066\u3001\u5727\u7e2e\u30d5\u30a1\u30a4\u30eb(tgz)\u3092\u30a4\u30e1\u30fc\u30b8\u306b\u5909\u63db\n\n\n\n4 Dockerfile\n\n4.1 CMD (\u30b3\u30f3\u30c6\u30ca\u8d77\u52d5\u6642\u306b\u81ea\u52d5\u7684\u306b\u5b9f\u884c\u3059\u308b\u30b3\u30de\u30f3\u30c9\u3092\u6307\u5b9a\u3059\u308b)\nDockerfile \u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u3088\u308a\u629c\u7c8b\n\nDockerfile \u3067 CMD \u547d\u4ee4\u3092\u4e00\u5ea6\u3060\u3051\u6307\u5b9a\u3067\u304d\u307e\u3059\u3002\u8907\u6570\u306e CMD \u304c\u3042\u308b\u5834\u5408\u3001\u6700\u3082\u5f8c\u308d\u306e CMD \u306e\u307f\u6709\u52b9\u3067\u3059\u3002\n\n---------------------------------------------------\n1. CMD [\"-a\"] -> CMD [\"-r\"]\u306e\u9806\u756a\n---------------------------------------------------\n[root@master1 test2]# vi Dockerfile\n[root@master1 test2]# cat Dockerfile\nFROM centos:centos7\nENTRYPOINT [\"/usr/bin/uname\"]\nCMD [\"-a\"]\nCMD [\"-r\"]\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 test2]# docker build -t test-img:ver1 --no-cache=true .\n-\u4e2d\u7565 -\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002uname -r\u304c\u5b9f\u884c\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 test2]# docker run --rm test-img:ver1\n3.10.0-229.el7.x86_64\n\n\n---------------------------------------------------\n2. \u9806\u756a\u3092\u5165\u308c\u66ff\u3048\u308b( CMD [\"-r\"] -> CMD [\"-a\"])\n---------------------------------------------------\nDockerfile\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 test2]# vi Dockerfile\n[root@master1 test2]# cat Dockerfile\nFROM centos:centos7\nENTRYPOINT [\"/usr/bin/uname\"]\nCMD [\"-r\"]\nCMD [\"-a\"]\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 test2]# docker build -t test-img:ver1 --no-cache=true .\n-\u4e2d\u7565 -\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002uname -a\u304c\u5b9f\u884c\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 test2]# docker run --rm test-img:ver1\nLinux bafbe7f69bb2 3.10.0-229.el7.x86_64 #1 SMP Fri Mar 6 11:36:42 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux\n\n\n\n4.2 CMD\u3068ENTRYPOINT\u306e\u4f7f\u3044\u65b9\nCMD\u3082ENTRYPOINT\u3082\u30b3\u30f3\u30c6\u30ca\u8d77\u52d5\u6642\u306b\u81ea\u52d5\u7684\u306b\u5b9f\u884c\u3059\u308b\u30b3\u30de\u30f3\u30c9\u3092\u6307\u5b9a\u3059\u308b\u3002\n\u30b3\u30f3\u30c6\u30ca\u8d77\u52d5\u6642\u306b\u5b9f\u884c\u3059\u308b\u30b3\u30de\u30f3\u30c9\u3092ENTRYPOINT\u306b\u6307\u5b9a\u3057\u3066\u3001\n\u3042\u3068\u304b\u3089\u5909\u66f4\u53ef\u80fd\u306a\u30b3\u30de\u30f3\u30c9\u306e\u5f15\u6570\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u5024\u3092CMD\u306b\u6307\u5b9a\u3059\u308b\u3001\u3068\u3044\u3046\u3088\u3046\u306b\u4f7f\u3046\u3002\n--------------------------------------------------------------\n1. CMD\u3067\u6307\u5b9a\u3057\u305f\u30b3\u30de\u30f3\u30c9\u5f15\u6570\u306f\u5909\u66f4\u53ef\u80fd\u3067\u3042\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u3002\n--------------------------------------------------------------\nDockerfile\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 test2]# vi Dockerfile\n[root@master1 test2]# cat Dockerfile\nFROM centos:centos7\nENTRYPOINT [\"/usr/bin/uname\"]\nCMD [\"-a\"]\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 test2]# docker build -t test-img:ver1 .\n-\u4e2d\u7565-\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u306e\u8d77\u52d5\u30d1\u30e9\u30e1\u30fc\u30bf\u306b\u4f55\u3082\u6307\u5b9a\u3057\u306a\u304b\u308c\u3070\u3001uname -a\u304c\u5b9f\u884c\u3055\u308c\u308b\u3002\n[root@master1 test2]# docker run --rm test-img:ver1\nLinux 9496baeb4980 3.10.0-229.el7.x86_64 #1 SMP Fri Mar 6 11:36:42 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux\n\n\u8d77\u52d5\u30d1\u30e9\u30e1\u30fc\u30bf(uname -r\u306e\"-r\")\u3092\u6307\u5b9a\u3057\u3066\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002uname -r\u304c\u5b9f\u884c\u3055\u308c\u308b\u3002\n\u3064\u307e\u308a\u3001CMD [\"-a\"]\u304c\u4e0a\u66f8\u304d\u3055\u308c\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 test2]# docker run --rm test-img:ver1 -r\n3.10.0-229.el7.x86_64\n\n\n--------------------------------------------------------------\n2. ENTRYPOINT\u3067\u6307\u5b9a\u3057\u305f\u30b3\u30de\u30f3\u30c9\u5f15\u6570\u306f\u5909\u66f4\u4e0d\u53ef\u3067\u3042\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u3002\n--------------------------------------------------------------\nDockerfile\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 test2]# vi Dockerfile\n[root@master1 test2]# cat Dockerfile\nFROM centos:centos7\nENTRYPOINT [\"/usr/bin/uname\",\"-a\"]\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 test2]# docker build -t test-img:ver1 --no-cache=true .\n-\u4e2d\u7565-\n\n\u5f15\u6570\u306a\u3057\u3067\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 test2]# docker run --rm test-img:ver1\nLinux 4a7180accb88 3.10.0-229.el7.x86_64 #1 SMP Fri Mar 6 11:36:42 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux\n\n\u5f15\u6570\u3042\u308a\u3067\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u3057\u304b\u3057\u3001\u5f15\u6570(-r)\u304c\u7121\u8996\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\nENTRYPOINT\u3067\u6307\u5b9a\u3057\u305f\u30b3\u30de\u30f3\u30c9\u5f15\u6570\u306f\u5909\u66f4\u3067\u304d\u306a\u3044\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 test2]# docker run --rm test-img:ver1 -r\nLinux 4b71de2fda69 3.10.0-229.el7.x86_64 #1 SMP Fri Mar 6 11:36:42 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux\n\n\n\n4.3 ADD\u3068COPY\u306e\u9055\u3044\nADD\u306f\u30a2\u30fc\u30ab\u30a4\u30d6\u30d5\u30a1\u30a4\u30eb\u3092\u5c55\u958b\u3057\u3066\u3057\u307e\u3046\u304c\u3001COPY\u306f\u5c55\u958b\u305b\u305a\u3001\u305d\u306e\u307e\u307e\u3092\u30a4\u30e1\u30fc\u30b8\u306b\u30b3\u30d4\u30fc\u3059\u308b\u3002\n---------------------------------------------------------\n1. \u30a2\u30fc\u30ab\u30a4\u30d6\u30d5\u30a1\u30a4\u30eb\u306e\u6e96\u5099\n---------------------------------------------------------\n\u30d5\u30a1\u30a4\u30eb\u30922\u3064\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 test2]#  head -c 1000 /dev/urandom > a.txt\n[root@master1 test2]#  head -c 1000 /dev/urandom > b.txt\n\n\u30a2\u30fc\u30ab\u30a4\u30d6\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 test2]# tar cvfz test.tar.gz a.txt b.txt\na.txt\nb.txt\n\n\u4f5c\u6210\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 test2]# ls -lt\n\u5408\u8a08 12\n-rw-r--r--. 1 root root 2207 11\u6708 26 16:47 test.tar.gz\n-rw-r--r--. 1 root root 1000 11\u6708 26 16:47 b.txt\n-rw-r--r--. 1 root root 1000 11\u6708 26 16:47 a.txt\n\n---------------------------------------------------------\n2. ADD\u3092\u4f7f\u3063\u305f\u5834\u5408 (\u30a2\u30fc\u30ab\u30a4\u30d6\u304c\u5c55\u958b\u3055\u308c\u3066\u3057\u307e\u3046\uff09\n---------------------------------------------------------\nDockerfile\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 test2]# vi Dockerfile\n[root@master1 test2]# cat Dockerfile\nFROM centos:centos7\nRUN mkdir /opt/test\nADD test.tar.gz /opt/test/\nRUN ls -lRt /opt/test\n\n\u30ab\u30ec\u30f3\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u78ba\u8a8d\u3059\u308b\n[root@master1 test2]# ls\nDockerfile  a.txt  b.txt  test.tar.gz\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\u5727\u7e2e\u30d5\u30a1\u30a4\u30eb\u304c\u5c55\u958b\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 test2]# docker build -t test-img:ver1 .\nSending build context to Docker daemon 8.192 kB\nStep 1 : FROM centos:centos7\n ---> 0584b3d2cf6d\nStep 2 : RUN mkdir /opt/test\n ---> Running in f6129d2aa4c3\n ---> af19cbd77e74\nRemoving intermediate container f6129d2aa4c3\nStep 3 : ADD test.tar.gz /opt/test/\n ---> c21b8d439958\nRemoving intermediate container e6810a0aabec\nStep 4 : RUN ls -lRt /opt/test\n ---> Running in 9b751e97e690\n/opt/test:\ntotal 8\n-rw-r--r--. 1 root root 1000 Nov 26 07:47 b.txt  <=== \u30a2\u30fc\u30ab\u30a4\u30d6\u304c\u5c55\u958b\u3055\u308c\u305f\u3002\n-rw-r--r--. 1 root root 1000 Nov 26 07:47 a.txt  <=== \u30a2\u30fc\u30ab\u30a4\u30d6\u304c\u5c55\u958b\u3055\u308c\u305f\u3002\n ---> 995292e70c54\nRemoving intermediate container 9b751e97e690\nSuccessfully built 995292e70c54\n\n\u30b3\u30f3\u30c6\u30ca\u306b\u5165\u3063\u3066\u78ba\u8a8d\u3059\u308b\u3002\u5727\u7e2e\u30d5\u30a1\u30a4\u30eb\u304c\u5c55\u958b\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 test2]# docker run -it --rm test-img:ver1 bash\n[root@16fc609ba268 /]# cd /opt/test/\n[root@16fc609ba268 test]# ls -lt\ntotal 8\n-rw-r--r--. 1 root root 1000 Nov 26 07:47 b.txt   <=== \u30a2\u30fc\u30ab\u30a4\u30d6\u304c\u5c55\u958b\u3055\u308c\u305f\u3002\n-rw-r--r--. 1 root root 1000 Nov 26 07:47 a.txt   <=== \u30a2\u30fc\u30ab\u30a4\u30d6\u304c\u5c55\u958b\u3055\u308c\u305f\u3002\n\n\n---------------------------------------------------------\n3. COPY\u3092\u4f7f\u3063\u305f\u5834\u5408 (\u30a2\u30fc\u30ab\u30a4\u306f\u5c55\u958b\u3055\u308c\u306a\u3044\uff09\n---------------------------------------------------------\n[root@master1 test2]# vi Dockerfile\n[root@master1 test2]# cat Dockerfile\nFROM centos:centos7\nRUN mkdir /opt/test\nCOPY test.tar.gz /opt/test/\nRUN ls -lRt /opt/test\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\u30a2\u30fc\u30ab\u30a4\u30d6\u306f\u5c55\u958b\u3055\u308c\u306a\u3044\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 test2]# docker build -t test-img:ver1 .\nSending build context to Docker daemon 8.192 kB\nStep 1 : FROM centos:centos7\n ---> 0584b3d2cf6d\nStep 2 : RUN mkdir /opt/test\n ---> Running in 9acb716ae732\n ---> a9f38033cf21\nRemoving intermediate container 9acb716ae732\nStep 3 : COPY test.tar.gz /opt/test/\n ---> 47f2b98dee82\nRemoving intermediate container b7129e471f34\nStep 4 : RUN ls -lRt /opt/test\n ---> Running in 175575dda529\n/opt/test:\ntotal 4\n-rw-r--r--. 1 root root 2207 Nov 26 07:47 test.tar.gz  <=== \u30a2\u30fc\u30ab\u30a4\u30d6\u306f\u5c55\u958b\u3055\u308c\u306a\u3044\u3002\n ---> 2b55986f826b\nRemoving intermediate container 175575dda529\nSuccessfully built 2b55986f826b\n\n\u30b3\u30f3\u30c6\u30ca\u306b\u5165\u3063\u3066\u78ba\u8a8d\u3059\u308b\u3002\u30a2\u30fc\u30ab\u30a4\u30d6\u30d5\u30a1\u30a4\u30eb\u304c\u5c55\u958b\u3055\u308c\u306a\u3044\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 test2]# docker run -it --rm test-img:ver1 bash\n[root@1dc516c1a917 /]# cd /opt/test/\n[root@1dc516c1a917 test]# ls -lt\ntotal 4\n-rw-r--r--. 1 root root 2207 Nov 26 07:47 test.tar.gz  <=== \u30a2\u30fc\u30ab\u30a4\u30d6\u306f\u5c55\u958b\u3055\u308c\u306a\u3044\n\n\n---------------------------------------------------------------------------------\n4. ADD\u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u3063\u3066\u3001\u30a4\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8\u4e0a\u306e\u30a2\u30fc\u30ab\u30a4\u30d6\u30d5\u30a1\u30a4\u30eb\u3092\u30a4\u30e1\u30fc\u30b8\u306b\u8ffd\u52a0\u3059\u308b\n   COPY\u30b3\u30de\u30f3\u30c9\u3067\u306f\u3067\u304d\u306a\u3044\u3002\n---------------------------------------------------------------------------------\nDockerfile\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 test2]# vi Dockerfile\n[root@master1 test2]# cat Dockerfile\nFROM centos:centos7\nRUN mkdir /opt/test\nADD http://tamacom.com/global/global-6.5.5.tar.gz /opt/test/\nRUN ls -lRt /opt/test\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 test2]# docker build -t test-img:ver1 .\nSending build context to Docker daemon 2.048 kB\nStep 1 : FROM centos:centos7\n ---> 0584b3d2cf6d\nStep 2 : RUN mkdir /opt/test\n ---> Using cache\n ---> a9f38033cf21\nStep 3 : ADD http://tamacom.com/global/global-6.5.5.tar.gz /opt/test/\nDownloading [==================================================>] 2.935 MB/2.935 MB\n ---> 74f57a040737\nRemoving intermediate container ffba4d6a3c60\nStep 4 : RUN ls -lRt /opt/test\n ---> Running in db028ae06a11\n/opt/test:\ntotal 2868\n-rw-------. 1 root root 2934542 Sep 21 04:57 global-6.5.5.tar.gz  <===\u30a2\u30fc\u30ab\u30a4\u30d6\u304c\u8ffd\u52a0\u3055\u308c\u305f\u3002\n ---> d4c6f9b643ea\nRemoving intermediate container db028ae06a11\nSuccessfully built d4c6f9b643ea\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 test2]# docker run -it --rm test-img:ver1 bash\n\n\u30a4\u30e1\u30fc\u30b8\u306b\u8ffd\u52a0\u3057\u305f\u30a2\u30fc\u30ab\u30a4\u30d6\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@d05a61cfe82f /]# cd /opt/test/\n[root@d05a61cfe82f test]# ls -lt\ntotal 2868\n-rw-------. 1 root root 2934542 Sep 21 04:57 global-6.5.5.tar.gz\n\n\n\n4.4 LABEL(\u30a4\u30e1\u30fc\u30b8\u306b\u30b3\u30e1\u30f3\u30c8\u3084\u30d0\u30fc\u30b8\u30e7\u30f3\u60c5\u5831\u3092\u3064\u3051\u308b\uff09\nDockerfile\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 test2]# cat Dockerfile\nFROM centos:centos7\nLABEL title=\"Test image\"\nLABEL version=\"1.0\"\nLABEL descriptuon=\"This is test\"\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 test2]# docker build -t test-img:ver1 --no-cache=true .\n-\u4e2d\u7565-\n\n\u30a4\u30e1\u30fc\u30b8\u306e\u4e2d\u8eab\u3092\u8abf\u3079\u308b\u3002\u30b3\u30e1\u30f3\u30c8\u7b49\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n[root@master1 test2]# docker inspect --format=\"{{ .Config.Labels }}\" test-img:ver1\nmap[build-date:20161102 descriptuon:This is test license:GPLv2 name:CentOS Base Image title:Test image vendor:CentOS version:1.0]\n\n\n\n4.5 WORKDIR(\u4f5c\u696d\u7528\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u6307\u5b9a\u3059\u308b\u3002\uff09\n-----------------------------------------------\n1. \u7d76\u5bfe\u30d1\u30b9\u306e\u3042\u3068\u306b\u76f8\u5bfe\u30d1\u30b9\u3092\u4f7f\u3063\u305f\u5834\u5408\n-----------------------------------------------\n[root@master1 test2]# vi Dockerfile\n[root@master1 test2]# cat Dockerfile\nFROM centos:centos7\nWORKDIR /first\nWORKDIR second\nWORKDIR third\nCMD [\"pwd\"]\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 test2]# docker build -t test-img:ver1 --no-cache=true .\n-\u4ee5\u4e0b\u3001\u7565-\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 test2]# docker run --rm test-img:ver1\n/first/second/third\n\n-----------------------------------------------\n2. \u7d76\u5bfe\u30d1\u30b9\u3092\u7d9a\u3051\u3066\u4f7f\u3063\u305f\u5834\u5408\n-----------------------------------------------\n[root@master1 test2]# vi Dockerfile\n[root@master1 test2]# cat Dockerfile\nFROM centos:centos7\nWORKDIR /first\nWORKDIR /second\nWORKDIR /third\nCMD [\"pwd\"]\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 test2]# docker build -t test-img:ver1 --no-cache=true .\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 test2]# docker run --rm test-img:ver1\n/third\n\n\n\n4.6 USER(USER\u4ee5\u964d\u306e\u30b3\u30de\u30f3\u30c9\u3092USER\u6a29\u9650\u3067\u5b9f\u884c\u3059\u308b\uff09\n----------------------------------------------------\n1. \u30db\u30b9\u30c8\u3067\u30e6\u30fc\u30b6(hana_shin)\u3092\u4f5c\u6210\u3059\u308b\u3002\n----------------------------------------------------\n[root@master1 test]# useradd -u 2000 hana_shin\n[root@master1 test]# grep hana_shin /etc/passwd\nhana_shin:x:2000:2000::/home/hana_shin:/bin/bash\n[root@master1 test]# grep hana_shin /etc/group\nhana_shin:x:2000:\n\n----------------------------------------------------\n2. \u30b3\u30f3\u30c6\u30ca\u3067\u30db\u30b9\u30c8\u3068\u540c\u3058\u30e6\u30fc\u30b6(hana_shin)\u3092\u4f5c\u6210\u3059\u308b\u3002\n----------------------------------------------------\n[root@master1 test]# vi Dockerfile\n[root@master1 test]# cat Dockerfile\nFROM centos:centos7\nRUN useradd -u 2000 hana_shin\nUSER hana_shin\nCMD tail -f /dev/null\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 test]# docker build -t test-img:ver1 --no-cache=true .\n-\u4ee5\u4e0b\u3001\u7565-\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 test]# docker run -it --rm --name test-con test-img:ver1 bash\n\nUID\u3092\u78ba\u8a8d\u3059\u308b\u3002UID=2000\u306e\u30e6\u30fc\u30b6\u304c\u4f5c\u6210\u3067\u304d\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[hana_shin@4fbb369c1d2d /]$ id\nuid=2000(hana_shin) gid=2000(hana_shin) groups=2000(hana_shin)\n\n[hana_shin@4fbb369c1d2d /]$ grep hana_shin /etc/passwd\nhana_shin:x:2000:2000::/home/hana_shin:/bin/bash\n\n----------------------------------------------------\n3. \u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3067\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n----------------------------------------------------\n\u30b3\u30f3\u30c6\u30ca\u306e\u540d\u524d(test-con)\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# docker ps\nCONTAINER ID      IMAGE            COMMAND      CREATED           STATUS              PORTS         NAMES\n4fbb369c1d2d      test-img:ver1    \"bash\"       4 minutes ago     Up 4 minutes                      test-con\n\n\u30b3\u30f3\u30c6\u30caID\u3092\u6c42\u3081\u308b\u3002\n[root@master1 ~]# CID=$(docker ps --no-trunc=true|grep \"test-con\"|awk '{print $1}')\n\n\u30b3\u30f3\u30c6\u30ca\u306ePID\u3092\u6c42\u3081\u308b\u3002\n[root@master1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u30b3\u30f3\u30c6\u30ca\u306epid,uid\u7b49\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# ps -p $PID -o pid,ppid,uid,euid\n   PID   PPID   UID  EUID\n  3191   1028  2000  2000\n\n\u89aa\u30d7\u30ed\u30bb\u30b9\u3092\u78ba\u8a8d\u3059\u308b\u3002\u89aa\u30d7\u30ed\u30bb\u30b9\u306fdocker-current \u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# ps -p 1028 -o comm,pid,ppid,uid,euid\nCOMMAND            PID   PPID   UID  EUID\ndocker-current    1028      1     0     0\n\n\u30d7\u30ed\u30bb\u30b9\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# ps aux|grep hana\nhana_sh+   1480  0.0  0.0   4328   648 ?        Ss   19:35   0:00 /bin/sh -c tail -f /dev/null\nhana_sh+   1488  0.0  0.0   4260   352 ?        S    19:35   0:00 tail -f /dev/null\nhana_sh+   3191  0.0  0.1  11776  1904 pts/1    Ss+  19:59   0:00 bash\nroot       3916  0.0  0.0 112664   960 pts/2    S+   20:11   0:00 grep --color=auto hana\n\n\n\n4.7 ARG(\u30d3\u30eb\u30c9\u6642\u306e\u5f15\u6570\u3092\u6307\u5b9a\u3059\u308b)\n\u30d3\u30eb\u30c9\u6642\u306b\u5f15\u6570x\u3092\u6307\u5b9a\u3057\u305f\u3089\u30a4\u30e1\u30fc\u30b8X\u3001\u5f15\u6570y\u3092\u6307\u5b9a\u3057\u305f\u3089\u30a4\u30e1\u30fc\u30b8Y\u3001\u3068\u3044\u3046\u3088\u3046\u306b\u3001\n\u30d3\u30eb\u30c9\u6642\u306e\u5f15\u6570\u306b\u3057\u305f\u304c\u3063\u3066\u7570\u306a\u308b\u30a4\u30e1\u30fc\u30b8\u3092\u4f5c\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n4.7.1 \u305d\u306e1 (ARG xxx=yyy \u3068\u5b9a\u7fa9\u3057\u305f\u5834\u5408)\n--------------------------------------------------\n1. ARG\u3092\u4f7f\u3063\u305fDockerfile (\u4e0b\u8a182,3\u3067\u540c\u3058\u3082\u306e\u3092\u4f7f\u3046)\n--------------------------------------------------\n[root@node1 test]# vi Dockerfile\n[root@node1 test]# cat Dockerfile\nFROM centos:centos7\nARG user=nginx\nRUN useradd $user\nUSER $user\n\n----------------------------------------------------\n2. \u30d3\u30eb\u30c9\u6642\u306b\u5f15\u6570\u3092\u6307\u5b9a\u3057\u306a\u3044(--build-arg\u3092\u4f7f\u308f\u306a\u3044)\n----------------------------------------------------\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\u30a4\u30e1\u30fc\u30b8\u5185\u306b\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u306enginx\u30e6\u30fc\u30b6\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@node1 test]# docker build -t test-img:ver1 --no-cache=true .\nSending build context to Docker daemon 2.048 kB\n-\u4ee5\u4e0b\u3001\u7565-\n\n\u30e6\u30fc\u30b6\u3092\u78ba\u8a8d\u3059\u308b\u3002\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30e6\u30fc\u30b6\u540d(nginx)\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n[root@node1 test]# docker run -it --rm test-img:ver1 bash\n[nginx@a1a98aa3000d /]$ id\nuid=1000(nginx) gid=1000(nginx) groups=1000(nginx)\n\n----------------------------------------------------\n3. \u30d3\u30eb\u30c9\u6642\u306b\u5f15\u6570\u3092\u6307\u5b9a\u3059\u308b\u3002(--build-arg user=httpd)\n----------------------------------------------------\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\u30a4\u30e1\u30fc\u30b8\u5185\u306b\u3001\u5f15\u6570\u3067\u6307\u5b9a\u3057\u305fhttpd\u30e6\u30fc\u30b6\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@node1 test]# docker build -t test-img:ver1 --no-cache=true --build-arg user=httpd .\nSending build context to Docker daemon 2.048 kB\n-\u4ee5\u4e0b\u3001\u7565-\n\n\u30e6\u30fc\u30b6\u3092\u78ba\u8a8d\u3059\u308b\u3002\u30d3\u30eb\u30c9\u6642\u306b\u6307\u5b9a\u3057\u305f\u30e6\u30fc\u30b6\u540d(httpd)\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n[root@node1 test]# docker run -it --rm test-img:ver1 bash\n[httpd@fb7fdb408f5b /]$ id\nuid=1000(httpd) gid=1000(httpd) groups=1000(httpd)\n\n\n\n4.7.1 \u305d\u306e2 (ARG xxx \u3068\u5b9a\u7fa9\u3057\u305f\u5834\u5408)\n----------------------------------------------------\n1. \u30c6\u30b9\u30c8\u7528\u30d5\u30a1\u30a4\u30eb\u306e\u6e96\u5099 (\u4e0b\u8a182,3,4\u3067\u540c\u3058\u3082\u306e\u3092\u4f7f\u3046)\n----------------------------------------------------\n[root@node1 test]# vi Dockerfile\n[root@node1 test]# cat Dockerfile\nFROM centos:centos7\nARG arg\nCOPY test_$arg /tmp\n\n[root@node1 test]# touch test_10\n[root@node1 test]# touch test_20\n[root@node1 test]# echo 10 > test_10\n[root@node1 test]# echo 20 > test_20\n[root@node1 test]# ls\nDockerfile  test_10  test_20\n\n------------------------------------------------------\n2. \u5f15\u6570\u306b10\u3092\u6307\u5b9a(--build-arg arg=10)\u3057\u3066\u30d3\u30eb\u30c9\u3059\u308b\n------------------------------------------------------\n\u30d3\u30eb\u30c9\u3059\u308b\u3002\u30a4\u30e1\u30fc\u30b8\u5185\u306b\u3001/tmp/test_10\u3068\u3044\u3046\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@node1 test]# docker build -t test-img:ver1 --no-cache=true --build-arg arg=10 .\nSending build context to Docker daemon 4.096 kB\n-\u4ee5\u4e0b\u3001\u7565-\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@node1 test]# docker run -it --rm test-img:ver1 bash\n\n\u30c6\u30b9\u30c8\u30d5\u30a1\u30a4\u30eb\u3092\u8aad\u307f\u51fa\u3059\u3002\u30d3\u30eb\u30c9\u6642\u306b\u6307\u5b9a\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u306e\u4e2d\u8eab\u304c\u3088\u3081\u305f\u3002\n[root@74312d24207d /]# cat /tmp/test_10\n10\n[root@74312d24207d /]# exit\nexit\n\n------------------------------------------------------\n3. \u5f15\u6570\u306b20\u3092\u6307\u5b9a(--build-arg arg=20)\u3057\u3066\u30d3\u30eb\u30c9\u3059\u308b\n------------------------------------------------------\n\u30d3\u30eb\u30c9\u3059\u308b\u3002\u30a4\u30e1\u30fc\u30b8\u5185\u306b\u3001/tmp/test_20\u3068\u3044\u3046\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@node1 test]# docker build -t test-img:ver1 --no-cache=true --build-arg arg=20 .\nSending build context to Docker daemon 4.096 kB\n-\u4ee5\u4e0b\u3001\u7565-\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@node1 test]# docker run -it --rm test-img:ver1 bash\n\n\u30c6\u30b9\u30c8\u30d5\u30a1\u30a4\u30eb\u3092\u8aad\u307f\u51fa\u3059\u3002\u30d3\u30eb\u30c9\u6642\u306b\u6307\u5b9a\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u306e\u4e2d\u8eab\u304c\u3088\u3081\u305f\u3002\n[root@636350430fc3 /]# cat /tmp/test_20\n20\n[root@636350430fc3 /]# exit\nexit\n\n-----------------------------------------------------^\n4. \u5f15\u6570\u306b\u4f55\u3082\u6307\u5b9a\u3057\u306a\u3044\u3067\u30d3\u30eb\u30c9\u3059\u308b\n------------------------------------------------------\n\u30d3\u30eb\u30c9\u3059\u308b\u3002\u5f15\u6570\u3092\u6307\u5b9a\u3057\u306a\u3044\u3068\u30a8\u30e9\u30fc\u767a\u751f\u3059\u308b\u3002\n[root@node1 test]# docker build -t test-img:ver1 --no-cache=true .\nSending build context to Docker daemon 4.096 kB\n-\u4e2d\u7565-\nStep 3 : COPY test_$arg /tmp\nlstat test_: no such file or directory \u2605\n\n\n\n4.8 ONBUILD\nDockerfile\u306eONBUILD\n\n4.20 Dockerfile\u306e\u4e2d\u304b\u3089\u30b7\u30a7\u30eb\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u5b9f\u884c\u3059\u308b\u3002\nDockerfile\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 test2]# vi Dockerfile\n[root@master1 test2]# cat Dockerfile\nFROM centos:centos7\nADD test.sh /usr/local/bin/\nRUN chmod +x /usr/local/bin/test.sh\nENTRYPOINT [\"/usr/local/bin/test.sh\"]\n\n\u30b7\u30a7\u30eb\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 test2]# vi test.sh\n[root@master1 test2]# cat test.sh\n#!/usr/bin/bash\ndate\ndf -HT\n\n\u30d5\u30a1\u30a4\u30eb\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 test2]# ls\nDockerfile  test.sh\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 test2]# docker build -t test-img:ver1 --no-cache=true .\nSending build context to Docker daemon 3.072 kB\nStep 1 : FROM centos:centos7\n ---> 0584b3d2cf6d\nStep 2 : ADD test.sh /usr/local/bin/\n ---> 47e0b863dc89\nRemoving intermediate container cb92e3c9f034\nStep 3 : RUN chmod +x /usr/local/bin/test.sh\n ---> Running in 9bf731f15e9c\n ---> 7c9d1c388c8a\nRemoving intermediate container 9bf731f15e9c\nStep 4 : ENTRYPOINT /usr/local/bin/test.sh\n ---> Running in b70e9cf496aa\n ---> 9d8185069d7f\nRemoving intermediate container b70e9cf496aa\nSuccessfully built 9d8185069d7f\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 test2]# docker run --rm test-img:ver1\nSat Nov 26 12:06:16 UTC 2016\nFilesystem                                                                                     Type   Size  Used Avail Use% Mounted on\n/dev/mapper/docker-8:3-713942-b4002d9923c4ebdf11156b914942131e8f9b34ffe43b646f4ebe55914855d553 xfs     11G  252M   11G   3% /\ntmpfs                                                                                          tmpfs  514M     0  514M   0% /dev\ntmpfs                                                                                          tmpfs  514M     0  514M   0% /sys/fs/cgroup\n/dev/sda3                                                                                      xfs     43G  5.4G   37G  13% /etc/hosts\nshm                                                                                            tmpfs   68M     0   68M   0% /dev/shm\n[root@master1 test2]#\n\n\n\n\n4.22 shell\n<A Href=\"https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/\">xxx</A>\n\n\n\n\n4.22 \u30b3\u30f3\u30c6\u30ca\u3092\u52d5\u4f5c\u3055\u305b\u7d9a\u3051\u308b(tail -f /dev/null)\nDockerfile\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 test2]# vi Dockerfile\n[root@master1 test2]# cat Dockerfile\nFROM centos:centos7\nCMD tail -f /dev/null\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 test2]# docker build -t test-img:ver1 --no-cache=true .\nSending build context to Docker daemon 3.072 kB\nStep 1 : FROM centos:centos7\n ---> 0584b3d2cf6d\nStep 2 : CMD tail -f /dev/null\n ---> Running in 51c3bd766516\n ---> 9ddc19b87832\nRemoving intermediate container 51c3bd766516\nSuccessfully built 9ddc19b87832\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 test2]# docker run -d --name test-con test-img:ver1\nab0b4bd16be96e4df1fa01bd47df5e663c67a9a56d97f72d9038280d4d7d9e5b\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\u52d5\u4f5c\u3057\u3066\u7d9a\u3051\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 test2]# docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES\nab0b4bd16be9        test-img:ver1       \"/bin/sh -c 'tail -f \"   2 minutes ago       Up 2 minutes                            test-con\n\n\n\n\n5 \u5b9f\u7528\u7de8\n\n5.1 WordPress(\u30d6\u30ed\u30b0\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2)\u3068MySQL(\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9)\u306e\u9023\u643a\n-------------------------------------------------------------\n1. \u69cb\u6210\n-------------------------------------------------------------\nWordPress\u3068MySQL\u306f\u3001\u4ee5\u4e0b\u306e\u69cb\u6210\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n\n                +--------------- Host(CentOS7.2) ------------------+\n                |                                                  |\n              TCP port            container             container  |\n   web  <---> 10003 <----------> 80(wordpress) <------> (wp-mysql) |\n browser        |                                                  |\n                |                                                  |\n                +--------------------------------------------------+\n\n\n-------------------------------------------------------------\n2. \u8a2d\u5b9a\n-------------------------------------------------------------\n\u30b3\u30f3\u30c6\u30ca(MySQL)\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -d --name wp-mysql -e MYSQL_ROOT_PASSWORD=hana_shin mysql\nac631804cc003747cfb16549b8738e5ea0d89d9c4ccc747f277397e36258ae33\n\n\u30b3\u30f3\u30c6\u30ca(wordpress)\u3092\u8d77\u52d5\u3059\u308b\u3002link\u30aa\u30d7\u30b7\u30e7\u30f3\u306f\u3001<\u9023\u643a\u3057\u305f\u3044\u30b3\u30f3\u30c6\u30ca\u540d:\u30a8\u30a4\u30ea\u30a2\u30b9\u540d>\u306e\u3088\u3046\u306b\u3064\u3051\u308b\u3002\n[root@master1 ~]# docker run -d --name wordpress --link wp-mysql:mysql -p 10003:80 wordpress\n6c02355bd6b3d357a1d6627ebae4bd353598f096be529406ef5e161aa63e2b3f\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                   NAMES\n6c02355bd6b3        wordpress           \"docker-entrypoint.sh\"   6 seconds ago       Up 2 seconds        0.0.0.0:10003->80/tcp   wordpress\nac631804cc00        mysql               \"docker-entrypoint.sh\"   11 seconds ago      Up 9 seconds        3306/tcp                wp-mysql\n\nwordpress\u304c\u53d6\u5f97\u3057\u305f\u74b0\u5883\u5909\u6570\u3092\u8868\u793a\u3059\u308b\u3002\n[root@master1 ~]# docker exec -it wordpress env\nPATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\nHOSTNAME=6c02355bd6b3\nMYSQL_PORT=tcp://172.17.0.2:3306\nMYSQL_PORT_3306_TCP=tcp://172.17.0.2:3306\nMYSQL_PORT_3306_TCP_ADDR=172.17.0.2\nMYSQL_PORT_3306_TCP_PORT=3306\nMYSQL_PORT_3306_TCP_PROTO=tcp\n-\u4ee5\u4e0b\u3001\u7565-\n\n\u30d6\u30e9\u30a6\u30b6\u3067\u4e0b\u8a18\u30a2\u30c9\u30ec\u30b9\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3002\nhttp://192.168.0.10:10003/\n\n\n\n5.2 CentOS\u3068MySQL\u306e\u9023\u643a(\u7528\u9014\u3042\u308b\u306e\u304b???)\n\u30b3\u30f3\u30c6\u30ca(MySQL)\u8d77\u52d5\n[root@master1 test2]# docker run -d --name mysql -e MYSQL_ROOT_PASSWORD=hana_shin mysql\n7ddd8884ada441341361d45a74bdb252c1082e1cf3226141a26e6c1b992fe17c\n\n\u30b3\u30f3\u30c6\u30ca(CentOS)\u8d77\u52d5\n[root@master1 test2]# docker run -it --name test-con --link mysql:db centos:centos7 bash\n\nCentOS\u306bmysql\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n[root@8b616eca9919 /]# yum -y install mysql\nLoaded plugins: fastestmirror, ovl\n-\u4ee5\u4e0b\u3001\u7565-\n\n\u63a5\u7d9a\u3059\u308bDB\u306eIP\u30a2\u30c9\u30ec\u30b9\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@8b616eca9919 /]# env|grep DB_PORT_3306_TCP_ADDR\nDB_PORT_3306_TCP_ADDR=172.17.0.2\n\nCentOS\u304b\u3089MySQL\u306b\u63a5\u7d9a\u3059\u308b\u3002\n[root@8b616eca9919 /]# mysql -u root -p -h 172.17.0.2\nEnter password:\nWelcome to the MariaDB monitor.  Commands end with ; or \\g.\nYour MySQL connection id is 2\nServer version: 5.7.16 MySQL Community Server (GPL)\n\nCopyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others.\n\nType 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.\n\nMySQL [(none)]>\n\n\n\n5.3 Jenkins\uff08\u958b\u767a\u652f\u63f4\u30c4\u30fc\u30eb\uff09\u3092\u8d77\u52d5\u3059\u308b\u3002\n\n(1) Jenkins\u3092\u8d77\u52d5\u3059\u308b\u3002\nDockerfile\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 test2]# vi Dockerfile\n[root@master1 test2]# cat Dockerfile\nFROM jenkins\nCOPY jenkins_plugins.txt /tmp/jenkins_plugins.txt\nRUN /usr/local/bin/plugins.sh /tmp/jenkins_plugins.txt\nUSER root\nRUN rm /tmp/jenkins_plugins.txt\nRUN groupadd -g 142 docker\nRUN addgroup -a jenkins docker\nUSER jenkins\n\n\u30d7\u30e9\u30b0\u30a4\u30f3\u7528\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 test2]# vi jenkins_plugins.txt\n[root@master1 test2]# cat jenkins_plugins.txt\nswarm:1.22\n\n\u4f5c\u6210\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 test2]# ls\nDockerfile  jenkins_plugins.txt\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 test2]# docker build -t jenkins_server .\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 test2]# docker run --name jenkins_server -p 11111:8080 -p 50000:50000 -v /var/run/docker.sock:/var/run/docker.sock -v /tmp:/var/jenkins_home -d jenkins_server\n64e6856dbe6ed15f575b0b916eae82c116c1bfa6300876a2ce607993120327d6\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 test2]# docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                                               NAMES\n64e6856dbe6e        jenkins_server      \"/bin/tini -- /usr/lo\"   5 seconds ago       Up 3 seconds        0.0.0.0:50000->50000/tcp, 0.0.0.0:11111->8080/tcp   jenkins_server\n\n\u30d6\u30e9\u30a6\u30b6\u3067\u4e0b\u8a18URL\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3002\nhttp://192.168.0.10:11111/\n\n\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3059\u308b\u305f\u3081\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u5165\u529b\u3092\u6c42\u3081\u3089\u308c\u308b\u306e\u3067\u3001jenkins\u306b\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u3002\n[root@master1 var]# docker exec -it jenkins_server bash\n\njenkins\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u7528\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u8aad\u307f\u3060\u3059\u3002\njenkins@64e6856dbe6e:~$ cat /var/jenkins_home/secrets/initialAdminPassword\nxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n\n\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u5165\u529b\u3059\u308b\u3068\u3001jenkins\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u304c\u958b\u59cb\u3055\u308c\u308b\u3002\n\n\n(2) jenkins\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u5b8c\u4e86\u5f8c\u306e\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u4fdd\u5b58(commit)\u3059\u308b\u3002\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 test2]# docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                                               NAMES\n64e6856dbe6e        jenkins_server      \"/bin/tini -- /usr/lo\"   16 minutes ago      Up 16 minutes       0.0.0.0:50000->50000/tcp, 0.0.0.0:11111->8080/tcp   jenkins_server\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u505c\u6b62\u3059\u308b\u3002\n[root@master1 test2]# docker stop jenkins_server\njenkins_server\n\n\u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\u3092\u4fdd\u5b58(commit)\u3059\u308b\u3002\u4fdd\u5b58\u3059\u308b\u306e\u306f\u3001\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u5b8c\u4e86\u6e08\u30a4\u30e1\u30fc\u30b8\u3002\n[root@master1 test2]# docker commit jenkins_server jenkins_server:ver1\nsha256:6d5dbe73cf0422e9ba14e2577454386b3ab0600f5b379c9ced52905144522de8\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u5b8c\u4e86\u5f8c\u306e\u30a4\u30e1\u30fc\u30b8\u306f jenkins_server:ver1\n[root@master1 test2]# docker images |grep jenkins_server\njenkins_server                                        ver1                               6d5dbe73cf04        55 seconds ago      714.1 MB\njenkins_server                                        latest                             b8081e64f449        21 minutes ago      714.1 MB\n\njenkins\u3092\u8d77\u52d5\u3059\u308b\u3002\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u5b8c\u4e86\u5f8c\u306e\u30a4\u30e1\u30fc\u30b8\u304b\u3089\u518d\u8d77\u52d5\u3067\u304d\u305f\u3002\n[root@master1 test2]# docker run --name jenkins_server -p 11111:8080 -p 50000:50000 -v /var/run/docker.sock:/var/run/docker.sock -v /tmp:/var/jenkins_home -d jenkins_server:ver1\n\n\n\n6 \u30b3\u30f3\u30c6\u30ca\u306e\u6a29\u9650(Capabilities)\nSecure Your Containers with this One Weird Trick\nHardening Docker Containers: Disable SUID Programs\nCIS Docker 1.11.0 Benchmark\n\u30b3\u30f3\u30c6\u30ca\u3067cron\u3092\u52d5\u304b\u3057\u305f\u6642\u306b\u51fa\u308bPAM\u30a8\u30e9\u30fc\u306e\u5bfe\u51e6\u6cd5\nDocker networking considered harmful\n\n6.1 \u30b3\u30f3\u30c6\u30ca\u306e\u6a29\u9650\u3092\u78ba\u8a8d\u3059\u308b\u65b9\u6cd5\npscap\u30b3\u30de\u30f3\u30c9\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002pscap\u3067\u30d7\u30ed\u30bb\u30b9\u306e\u6a29\u9650\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n[root@master1 ~]# yum -y install libcap-ng-utils\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -it --name test-con centos:centos7 bash\n\n\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u306c\u3051\u308b(Ctrl\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u306a\u304c\u3089\u3001P\u30ad\u30fc\u3068Q\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b)\n[root@14cbbaf4c108 /]# [root@master1 ~]#\n\n\u30b3\u30f3\u30c6\u30caID\u3092\u6c42\u3081\u308b\u3002\n[root@master1 ~]# CID=$(docker ps --no-trunc=true|grep -w \"test-con\"|awk '{print $1}')\n[root@master1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u6a29\u9650(capabilities)\u3092\u78ba\u8a8d\u3059\u308b\u30021\u884c\u304c\u9577\u3044\u306e\u3067\u6298\u308a\u8fd4\u3057\u3066\u3044\u307e\u3059\u3002\n[root@master1 ~]# pscap |grep $PID\nppid  pid   name   command   capabilities\n1028  13295 root   bash      chown, dac_override, fowner, fsetid, kill, \n                             setgid, setuid, setpcap, net_bind_service, \n                             net_raw, sys_chroot, mknod, audit_write, setfcap\n\n\n\n6.2 \u5168\u3066\u306e\u6a29\u9650\u3092\u4e0e\u3048\u308b\u3002\u5168\u3066\u306e\u6a29\u9650\u3092\u843d\u3068\u3059\n------------------------------------------\n1. \u5168\u3066\u306e\u6a29\u9650\u3092\u4e0e\u3048\u308b(--cap-add=all)\n------------------------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u5168\u3066\u306e\u6a29\u9650\u3092\u4e0e\u3048\u308b\u3002\n[root@node1 ~]# docker run -it --cap-add=all --name test-con centos:centos7 bash\n\n\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u306c\u3051\u308b(Ctrl\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u306a\u304c\u3089\u3001P\u30ad\u30fc\u3068Q\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b)\n[root@0f1503dc4f09 /]# [root@node1 ~]#\n\n\u30b3\u30f3\u30c6\u30caID\u304b\u3089\u30b3\u30f3\u30c6\u30ca\u306ePID\u3092\u6c42\u3081\u308b\u3002\n[root@node1 ~]# CID=$(docker ps --no-trunc=true|grep -w \"test-con\"|awk '{print $1}')\n[root@node1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u6a29\u9650\u3092\u78ba\u8a8d\u3059\u308b\u3002\u5168\u3066\u306e\u6a29\u9650\u304c\u4e0e\u3048\u3089\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@node1 ~]# pscap |grep $PID\nppid  pid   name        command           capabilities\n1009  1367  root        bash            \u2605full\n\n\n------------------------------------------\n2. \u5168\u3066\u306e\u6a29\u9650\u3092\u843d\u3068\u3059(--cap-drop=all)\n------------------------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u5168\u3066\u306e\u6a29\u9650\u3092\u843d\u3068\u3059\u3002\n[root@node1 ~]# docker run -it --cap-drop=all --name test-con centos:centos7 bash\n\n\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u306c\u3051\u308b(Ctrl\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u306a\u304c\u3089\u3001P\u30ad\u30fc\u3068Q\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b)\n[root@536f79628b07 /]# [root@node1 ~]#\n\n\u30b3\u30f3\u30c6\u30caID\u304b\u3089\u30b3\u30f3\u30c6\u30ca\u306ePID\u3092\u6c42\u3081\u308b\u3002\n[root@node1 ~]# CID=$(docker ps --no-trunc=true|grep -w \"test-con\"|awk '{print $1}')\n[root@node1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u6a29\u9650\u3092\u78ba\u8a8d\u3059\u308b\u3002\u6a29\u9650\u304c\u4f55\u3082\u4e0e\u3048\u3089\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\n[root@node1 ~]# pscap |grep $PID\n[root@node1 ~]#\n\n------------------------------------------\n3. \u7279\u5b9a\u306e\u6a29\u9650\u3060\u3051\u4e0e\u3048\u308b\n------------------------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u5168\u3066\u306e\u6a29\u9650\u3092\u843d\u3068\u3057\u3066\u304b\u3089\u3001\u5fc5\u8981\u306a\u6a29\u9650\u3060\u3051\u3092\u4e0e\u3048\u308b\u3002\n[root@node1 ~]# docker run -it --cap-drop=all --cap-add=NET_ADMIN --name test-con centos:centos7 bash\n\n\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u306c\u3051\u308b(Ctrl\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u306a\u304c\u3089\u3001P\u30ad\u30fc\u3068Q\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b)\n[root@2768d178ef7d /]# [root@node1 ~]#\n[root@node1 ~]#\n\n\u30b3\u30f3\u30c6\u30caID\u304b\u3089\u30b3\u30f3\u30c6\u30ca\u306ePID\u3092\u6c42\u3081\u308b\u3002\n[root@node1 ~]# CID=$(docker ps --no-trunc=true|grep -w \"test-con\"|awk '{print $1}')\n[root@node1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u6a29\u9650\u3092\u78ba\u8a8d\u3059\u308b\u3002NET_ADMIN\u3060\u3051\u4e0e\u3048\u3089\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@node1 ~]# pscap |grep $PID\nppid  pid   name        command           capabilities\n1009  1739  root        bash              net_admin\n\n\n\n6.3 NET_ADMIN\u306e\u4f7f\u3044\u65b9\uff08\u305d\u306e\uff11\uff1a\u7d4c\u8def\u60c5\u5831\u306e\u8ffd\u52a0\uff0f\u524a\u9664\u3092\u5236\u5fa1\u3059\u308b\uff09\n-----------------------------\n1. NET_ADMIN\u304c\u6709\u52b9\u306e\u5834\u5408\n-----------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002NET_ADMIN\u3060\u3051\u6709\u52b9\u306b\u3059\u308b\u3002\n[root@node1 ~]# docker run -it --cap-drop=all --cap-add=NET_ADMIN  --name test-con busybox sh\n\n\u7d4c\u8def\u60c5\u5831\u3092\u78ba\u8a8d\u3059\u308b\u3002\n/ # ip route show\ndefault via 172.17.0.1 dev eth0\n172.17.0.0/16 dev eth0  src 172.17.0.2\n\n\u7d4c\u8def\u60c5\u5831\u3092\u8ffd\u52a0\u3059\u308b\u3002\n/ # ip route add 8.8.8.8 via 172.17.0.1 dev eth0\n\n\u7d4c\u8def\u60c5\u5831\u3092\u78ba\u8a8d\u3059\u308b\u3002\u7d4c\u8def\u60c5\u5831\u304c\u8ffd\u52a0\u3055\u308c\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n/ # ip route show\ndefault via 172.17.0.1 dev eth0\n8.8.8.8 via 172.17.0.1 dev eth0 \u2605\n172.17.0.0/16 dev eth0  src 172.17.0.2\n\n\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u306c\u3051\u308b(Ctrl\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u306a\u304c\u3089\u3001P\u30ad\u30fc\u3068Q\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b)\n/ # [root@node1 ~]#\n\n\u30b3\u30f3\u30c6\u30caID\u304b\u3089\u30b3\u30f3\u30c6\u30ca\u306ePID\u3092\u6c42\u3081\u308b\u3002\n[root@node1 ~]# CID=$(docker ps --no-trunc=true|grep -w \"test-con\"|awk '{print $1}')\n[root@node1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u6a29\u9650\u3092\u78ba\u8a8d\u3059\u308b\u3002NET_ADMIN\u304c\u6709\u52b9\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@node1 ~]# pscap |grep $PID\nppid  pid   name        command           capabilities\n1009  2062  root        sh              \u2605net_admin\n\n-----------------------------\n2. NET_ADMIN\u304c\u7121\u52b9\u306e\u5834\u5408\n-----------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u5168\u3066\u306e\u6a29\u9650\u3092\u843d\u3068\u3059\u3002\n[root@node1 ~]# docker run -it --cap-drop=all --name test-con busybox sh\n\n\u7d4c\u8def\u60c5\u5831\u3092\u78ba\u8a8d\u3059\u308b\u3002\n/ # ip route show\ndefault via 172.17.0.1 dev eth0\n172.17.0.0/16 dev eth0  src 172.17.0.2\n\n\u7d4c\u8def\u60c5\u5831\u3092\u8ffd\u52a0\u3059\u308b\u3002\u8ffd\u52a0\u3067\u304d\u306a\u3044\u3002\n/ # ip route add 8.8.8.8 via 172.17.0.1 dev eth0\nip: RTNETLINK answers: Operation not permitted\n\n\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u306c\u3051\u308b(Ctrl\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u306a\u304c\u3089\u3001P\u30ad\u30fc\u3068Q\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b)\n/ # [root@node1 ~]#\n\n\u30b3\u30f3\u30c6\u30caID\u304b\u3089\u30b3\u30f3\u30c6\u30ca\u306ePID\u3092\u6c42\u3081\u308b\u3002\n[root@node1 ~]# CID=$(docker ps --no-trunc=true|grep -w \"test-con\"|awk '{print $1}')\n[root@node1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u6a29\u9650\u3092\u78ba\u8a8d\u3059\u308b\u3002\u6a29\u9650\u304c\u4f55\u3082\u4e0e\u3048\u3089\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\n[root@node1 ~]# pscap |grep $PID\n[root@node1 ~]#\n\n\n\n6.4 NET_ADMIN\u306e\u4f7f\u3044\u65b9\uff08\u305d\u306e\uff12\uff1a\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30c7\u30d0\u30a4\u30b9\u306e\u4f5c\u6210\u53ef\u5426\u3092\u5236\u5fa1\u3059\u308b\uff09\n-----------------------------\n1. NET_ADMIN\u304c\u6709\u52b9\u306e\u5834\u5408\n-----------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002NET_ADMIN\u3060\u3051\u6709\u52b9\u306b\u3059\u308b\u3002\n[root@node1 ~]# docker run -it --cap-drop=all --cap-add=NET_ADMIN --name test-con busybox sh\n\ndummy\u30bf\u30a4\u30d7\u306e\u30c7\u30d0\u30a4\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3002\n/ # ip link add foo type dummy\n\n\u30c7\u30d0\u30a4\u30b9(foo)\u304c\u4f5c\u6210\u3067\u304d\u305f\u3002\n/ # ip link show foo\n2: foo: <BROADCAST,NOARP> mtu 1500 qdisc noop\n    link/ether 1a:f8:ed:6b:f0:91 brd ff:ff:ff:ff:ff:ff\n\n\u30c7\u30d0\u30a4\u30b9\u3092\u524a\u9664\u3059\u308b\u3002\n/ # ip link del foo\n\n\u30c7\u30d0\u30a4\u30b9\u304c\u524a\u9664\u3067\u304d\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n/ # ip link show foo\nip: can't find device 'foo'\n\n\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u306c\u3051\u308b(Ctrl\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u306a\u304c\u3089\u3001P\u30ad\u30fc\u3068Q\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b)\n/ # [root@node1 ~]#\n\n\u30b3\u30f3\u30c6\u30caID\u304b\u3089\u30b3\u30f3\u30c6\u30ca\u306ePID\u3092\u6c42\u3081\u308b\u3002\n[root@node1 ~]# CID=$(docker ps --no-trunc=true|grep -w \"test-con\"|awk '{print $1}')\n[root@node1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u6a29\u9650\u3092\u78ba\u8a8d\u3059\u308b\u3002NET_ADMIN\u304c\u6709\u52b9\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@node1 ~]# pscap |grep $PID\nppid  pid   name        command           capabilities\n1009  3378  root        sh              \u2605net_admin\n\n-----------------------------\n2. NET_ADMIN\u304c\u7121\u52b9\u306e\u5834\u5408\n-----------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u5168\u3066\u306e\u6a29\u9650\u3092\u7121\u52b9\u306b\u3059\u308b\u3002\n[root@node1 ~]# docker run -it --cap-drop=all --name test-con busybox sh\n\n\u30c7\u30d0\u30a4\u30b9(foo)\u3092\u4f5c\u6210\u3059\u308b\u3002\u3057\u304b\u3057\u6a29\u9650\u304c\u306a\u3044\u305f\u3081\u4f5c\u6210\u3067\u304d\u306a\u3044\u3002\n/ # ip link add foo type dummy\nip: RTNETLINK answers: Operation not permitted\n\n\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u306c\u3051\u308b(Ctrl\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u306a\u304c\u3089\u3001P\u30ad\u30fc\u3068Q\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b)\n/ # [root@node1 ~]#\n\n\u30b3\u30f3\u30c6\u30caID\u304b\u3089\u30b3\u30f3\u30c6\u30ca\u306ePID\u3092\u6c42\u3081\u308b\u3002\n[root@node1 ~]# CID=$(docker ps --no-trunc=true|grep -w \"test-con\"|awk '{print $1}')\n[root@node1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u6a29\u9650\u3092\u78ba\u8a8d\u3059\u308b\u3002\u6a29\u9650\u304c\u4f55\u3082\u4e0e\u3048\u3089\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\n[root@node1 ~]# pscap |grep $PID\n[root@node1 ~]#\n\n\n\n6.5 NET_BIND_SERVICE\u306e\u4f7f\u3044\u65b9(\u7279\u6a29\u30dd\u30fc\u30c8\u3067\u306e\u30ea\u30c3\u30b9\u30f3\u3092\u5236\u5fa1\u3059\u308b\uff09\n----------------------------------\n1. NET_BIND_SERVICE\u304c\u6709\u52b9\u306e\u5834\u5408\n----------------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002NET_BIND_SERVICE\u3060\u3051\u6709\u52b9\u306b\u3059\u308b\u3002\n[root@node1 ~]# docker run -it --cap-drop=all --cap-add=NET_BIND_SERVICE  --name test-con busybox sh\n\nroto\u30e6\u30fc\u30b6\u3067\u5b9f\u884c\u3059\u308b\u3002\n/ # id\nuid=0(root) gid=0(root) groups=10(wheel)\n\n\u4e00\u822c\u30dd\u30fc\u30c8(80)\u3067\u30ea\u30c3\u30b9\u30f3\u3059\u308b\u3002\u30ea\u30c3\u30b9\u30f3\u3067\u304d\u305f\u3002Ctrl+C\u3067\u7d42\u4e86\u3002\n/ # nc -l -p 80\n^C\n\u4e00\u822c\u30dd\u30fc\u30c8(1023)\u3067\u30ea\u30c3\u30b9\u30f3\u3059\u308b\u3002\u30ea\u30c3\u30b9\u30f3\u3067\u304d\u305f\u3002Ctrl+C\u3067\u7d42\u4e86\u3002\n/ # nc -l -p 1023\n^C\n\u7279\u6a29\u30dd\u30fc\u30c8(1024\u4ee5\u4e0a)\u3067\u30ea\u30c3\u30b9\u30f3\u3059\u308b\u3002\u30ea\u30c3\u30b9\u30f3\u3067\u304d\u305f\u3002Ctrl+C\u3067\u7d42\u4e86\u3002\n/ # nc -l -p 1024\n^C\n/ #\n\n\n\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3092\u958b\u304f\u3002\u30ea\u30c3\u30b9\u30f3\u3057\u3066\u3044\u308b\u30dd\u30fc\u30c8\u756a\u53f7\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n[root@node1 ~]# docker exec -it test-con sh\n/ # netstat -antp\nActive Internet connections (servers and established)\nProto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name\ntcp        0      0 :::80\u2605                 :::*                    LISTEN      20/nc\n\n/ # netstat -antp\nActive Internet connections (servers and established)\nProto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name\ntcp        0      0 :::1023\u2605               :::*                    LISTEN      22/nc\n\n/ # netstat -antp\nActive Internet connections (servers and established)\nProto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name\ntcp        0      0 :::1024\u2605\n\n\u30b3\u30f3\u30c6\u30caID\u304b\u3089\u30b3\u30f3\u30c6\u30ca\u306ePID\u3092\u6c42\u3081\u308b\u3002\n[root@node1 ~]# CID=$(docker ps --no-trunc=true|grep -w \"test-con\"|awk '{print $1}')\n[root@node1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u6a29\u9650\u3092\u78ba\u8a8d\u3059\u308b\u3002NET_BIND_SERVICE\u304c\u6709\u52b9\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@node1 ~]# pscap |grep $PID\nppid  pid   name        command           capabilities\n2308  2357  root        nc              \u2605net_bind_service\n\n----------------------------------\n2. NET_BIND_SERVICE\u304c\u7121\u52b9\u306e\u5834\u5408\n----------------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u5168\u3066\u306e\u6a29\u9650\u3092\u7121\u52b9\u306b\u3059\u308b\u3002\n[root@node1 ~]# docker run -it --cap-drop=all --name test-con busybox sh\n\nroto\u30e6\u30fc\u30b6\u3067\u5b9f\u884c\u3059\u308b\u3002\n/ # id\nuid=0(root) gid=0(root) groups=10(wheel)\n\n\u7279\u6a29\u30dd\u30fc\u30c8(1-1023)\u3067\u306f\u30ea\u30c3\u30b9\u30f3\u3067\u304d\u306a\u3044\u3002\n/ # nc -l -p 80\nnc: bind: Permission denied\n\n\u4e00\u822c\u30dd\u30fc\u30c8\u3067\u306f\u30ea\u30c3\u30b9\u30f3\u3067\u304d\u308b\u3002\n[root@node1 ~]# docker exec -it test-con sh\n/ # nc -l -p 1024\n^C\n\n\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u306c\u3051\u308b(Ctrl\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u306a\u304c\u3089\u3001P\u30ad\u30fc\u3068Q\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b)\n/ # [root@node1 ~]#\n[root@node1 ~]#\n\n\u30b3\u30f3\u30c6\u30caID\u304b\u3089\u30b3\u30f3\u30c6\u30ca\u306ePID\u3092\u6c42\u3081\u308b\u3002\n[root@node1 ~]# CID=$(docker ps --no-trunc=true|grep -w \"test-con\"|awk '{print $1}')\n[root@node1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u6a29\u9650\u3092\u78ba\u8a8d\u3059\u308b\u3002\u6a29\u9650\u304c\u4f55\u3082\u4e0e\u3048\u3089\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\n[root@node1 ~]# pscap |grep $PID\n[root@node1 ~]#\n\n\n\n6.6 NET_RAW\u306e\u4f7f\u3044\u65b9\nping,traceroute,arping,tcpdump\u3068\u3044\u3063\u305f\u30d7\u30ed\u30b0\u30e9\u30e0\u304c\u4f7f\u3048\u306a\u304f\u306a\u308b\u3002\n-----------------------------\n1. NET_RAW\u304c\u6709\u52b9\u306e\u5834\u5408\n-----------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002NET_RAW\u3060\u3051\u6709\u52b9\u306b\u3059\u308b\u3002\n[root@node1 ~]# docker run -it --cap-drop=all --cap-add=NET_RAW busybox sh\n\n\u7d4c\u8def\u60c5\u5831\u3092\u691c\u7d22\u3059\u308b\u3002(ping,traceroute\u306e\u5b9b\u5148\u3092\u78ba\u8a8d\u3059\u308b\u305f\u3081\uff09\n/ # ip route show\ndefault via 172.17.0.1 dev eth0\n172.17.0.0/16 dev eth0  src 172.17.0.2\n\nping\u3092\u5b9f\u884c\u3059\u308b\u3002\u5fdc\u7b54\u304c\u3042\u308b\u3002\n/ # ping 172.17.0.1\nPING 172.17.0.1 (172.17.0.1): 56 data bytes\n64 bytes from 172.17.0.1: seq=0 ttl=64 time=0.194 ms\n-\u4ee5\u4e0b\u3001\u7565-\n\ntraceroute\u3092\u5b9f\u884c\u3059\u308b\u3002\u5fdc\u7b54\u304c\u3042\u308b\u3002\n/ # traceroute 172.17.0.1\ntraceroute to 172.17.0.1 (172.17.0.1), 30 hops max, 46 byte packets\n 1  172.17.0.1 (172.17.0.1)  0.016 ms  0.070 ms  0.016 ms\n\narping\u3092\u5b9f\u884c\u3059\u308b\u3002\u30eb\u30fc\u30bf\u306eMAC\u30a2\u30c9\u30ec\u30b9\u3092\u5f97\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n/ # arping -I eth0 172.17.0.1\nARPING to 172.17.0.1 from 172.17.0.2 via eth0\nUnicast reply from 172.17.0.1 [02:42:4c:40:95:b7] 0.031ms\n-\u4ee5\u4e0b\u3001\u7565-\n\n\n-----------------------------\n2. NET_RAW\u304c\u7121\u52b9\u306e\u5834\u5408\n-----------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u5168\u3066\u306e\u6a29\u9650\u3092\u7121\u52b9\u306b\u3059\u308b\u3002\n[root@node1 ~]# docker run -it --cap-drop=all busybox sh\n\n\u7d4c\u8def\u60c5\u5831\u3092\u691c\u7d22\u3059\u308b\u3002(ping,traceroute\u306e\u5b9b\u5148\u3092\u78ba\u8a8d\u3059\u308b\u305f\u3081\uff09\n/ # ip route show\ndefault via 172.17.0.1 dev eth0\n172.17.0.0/16 dev eth0  src 172.17.0.2\n\nping\u3092\u5b9f\u884c\u3059\u308b\u3002\u5fdc\u7b54\u304c\u306a\u3044\u3002\n/ # ping 172.17.0.1\nPING 172.17.0.1 (172.17.0.1): 56 data bytes\nping: permission denied (are you root?)\n\ntraceroute\u3092\u5b9f\u884c\u3059\u308b\u3002\u5fdc\u7b54\u304c\u306a\u3044\u3002\n/ # traceroute 172.17.0.1\ntraceroute: socket: Operation not permitted\n\narping\u3092\u5b9f\u884c\u3059\u308b\u3002\u5fdc\u7b54\u304c\u306a\u3044\u3002\n/ # arping -I eth0 172.17.0.1\narping: socket: Operation not permitted\n\n\nbusybox\u306b\u306fyum,tcpdump\u304c\u5165\u3063\u3066\u3044\u306a\u3044\u306e\u3067\u3001centos7\u3067\u78ba\u8a8d\u3002\n[root@node1 ~]# docker run -it --rm --cap-drop=NET_RAW centos:centos7 bash\n[root@f54069514adf /]# yum -y install tcpdump\n[root@f54069514adf /]# tcpdump -i eth0 port 80\ntcpdump: eth0: You don't have permission to capture on that device\n(socket: Operation not permitted)\n\n\n\n6.7 MKNOD\u306e\u4f7f\u3044\u65b9\n-----------------------------\n1. MKNOD\u304c\u6709\u52b9\u306a\u5834\u5408\n-----------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002MKNOD\u3060\u3051\u6709\u52b9\u306b\u3059\u308b\u3002\n[root@node1 ~]# docker run -it --cap-drop=all --cap-add=MKNOD --name test-con busybox sh\n\n\u30c7\u30d0\u30a4\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3002\n/ # mknod -m 660 /dev/hda b 56 0\n\n\u30c7\u30d0\u30a4\u30b9\u3092\u78ba\u8a8d\u3059\u308b\u3002\u4f5c\u6210\u3067\u304d\u305f\u3002\n/ # ls -la /dev/hda\nbrw-rw----    1 root     root       56,   0 Dec 16 12:07 /dev/hda\n\n\n\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u306c\u3051\u308b(Ctrl\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u306a\u304c\u3089\u3001P\u30ad\u30fc\u3068Q\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b)\n/ # [root@node1 ~]#\n\n\u30b3\u30f3\u30c6\u30caID\u304b\u3089\u30b3\u30f3\u30c6\u30ca\u306ePID\u3092\u6c42\u3081\u308b\u3002\n[root@node1 ~]# CID=$(docker ps --no-trunc=true|grep -w \"test-con\"|awk '{print $1}')\n[root@node1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u6a29\u9650\u3092\u78ba\u8a8d\u3059\u308b\u3002MKNOD\u304c\u6709\u52b9\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@node1 ~]# pscap |grep $PID\nppid  pid   name        command           capabilities\n1009  3118  root        sh              \u2605mknod\n\n-----------------------------\n2. MKNOD\u304c\u7121\u52b9\u306a\u5834\u5408\n-----------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u5168\u3066\u306e\u6a29\u9650\u3092\u7121\u52b9\u306b\u3059\u308b\u3002\n[root@node1 ~]# docker run -it --cap-drop=all --name test-con busybox sh\n\n\u30c7\u30d0\u30a4\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3002\u3057\u304b\u3057\u3001\u4f5c\u6210\u3067\u304d\u306a\u3044\u3002\n/ # mknod -m 660 /dev/hda b 56 0\nmknod: /dev/hda: Operation not permitted\n\n\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u306c\u3051\u308b(Ctrl\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u306a\u304c\u3089\u3001P\u30ad\u30fc\u3068Q\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b)\n/ # [root@node1 ~]#\n[root@node1 ~]#\n\n\u30b3\u30f3\u30c6\u30caID\u304b\u3089\u30b3\u30f3\u30c6\u30ca\u306ePID\u3092\u6c42\u3081\u308b\u3002\n[root@node1 ~]# CID=$(docker ps --no-trunc=true|grep -w \"test-con\"|awk '{print $1}')\n[root@node1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u6a29\u9650\u3092\u78ba\u8a8d\u3059\u308b\u3002MKNOD\u304c\u7121\u52b9\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@node1 ~]# pscap |grep $PID\n[root@node1 ~]#\n\n\n\n6.8 CHOWN\u306e\u4f7f\u3044\u65b9\n-----------------------------\n1. CHOWN\u304c\u6709\u52b9\u306e\u5834\u5408\n-----------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002CHOWN\u3060\u3051\u6709\u52b9\u306b\u3059\u308b\u3002\n[root@node1 ~]# docker run -it --cap-drop=all --cap-add=CHOWN busybox sh\n\n\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\u6240\u6709\u8005\u3001\u30b0\u30eb\u30fc\u30d7\u3092\u78ba\u8a8d\u3059\u308b\u3002\n/ # touch /tmp/aa.txt\n/ # ls -la /tmp/aa.txt\n-rw-r--r--    1 root     root             0 Dec 18 12:01 /tmp/aa.txt\n\n\u6240\u6709\u8005\u3001\u30b0\u30eb\u30fc\u30d7\u3092\u5909\u66f4\u3059\u308b\u3002\n/ # id daemon\nuid=1(daemon) gid=1(daemon) groups=1(daemon)\n/ # chown daemon:daemon /tmp/aa.txt\n\n\u6240\u6709\u8005\u3001\u30b0\u30eb\u30fc\u30d7\u3092\u78ba\u8a8d\u3059\u308b\u3002\u5909\u66f4\u3067\u304d\u305f\u3002\n/ # ls -la /tmp/aa.txt\n-rw-r--r--    1 daemon   daemon           0 Dec 18 12:01 /tmp/aa.txt\n\n\n-----------------------------\n2. CHOWN\u304c\u7121\u52b9\u306e\u5834\u5408\n-----------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u5168\u3066\u306e\u6a29\u9650\u3092\u7121\u52b9\u306b\u3059\u308b\u3002\n[root@node1 ~]# docker run -it --cap-drop=all busybox sh\n\n\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\u6240\u6709\u8005\u3001\u30b0\u30eb\u30fc\u30d7\u3092\u78ba\u8a8d\u3059\u308b\u3002\n/ # touch /tmp/aa.txt\n/ # ls -la /tmp/aa.txt\n-rw-r--r--    1 root     root             0 Dec 18 12:03 /tmp/aa.txt\n\n\u6240\u6709\u8005\u3001\u30b0\u30eb\u30fc\u30d7\u3092\u78ba\u8a8d\u3059\u308b\u3002\u5909\u66f4\u3067\u304d\u306a\u3044\u3002\n/ # chown daemon:daemon /tmp/aa.txt\nchown: /tmp/aa.txt: Operation not permitted\n\n\n\n6.9 SETUID\u306e\u4f7f\u3044\u65b9\nAdded no-new-privileges Security Flag to Docker\n\u4f7f\u3044\u65b9\u304c\u3088\u304f\u308f\u304b\u3089\u306a\u3044\u3002\u60f3\u5b9a\u901a\u308a\u306b\u52d5\u4f5c\u3057\u306a\u3044\uff01\uff01\uff01\n\u30c6\u30b9\u30c8\u7528\u30d7\u30ed\u30b0\u30e9\u30e0(\u5b9f\u884c\u30e6\u30fc\u30b6ID\u3092\u78ba\u8a8d\u3059\u308b)\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@node1 test]# vi uid_test.c\n[root@node1 test]# cat uid_test.c\n#include <stdio.h>\n#include <unistd.h>\n#include <sys/types.h>\n\nint main(int argc, char *argv[])\n{\n        printf(\"Effective uid: %d\\n\", geteuid());\n        return 0;\n}\n\nDockerfile\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@node1 test]# vi Dockerfile\n[root@node1 test]# cat Dockerfile\nFROM centos:centos7\nADD uid_test /tmp/uid_test\nRUN chmod u+s /tmp/uid_test\nRUN useradd -u 2000 hana_shin\nUSER hana_shin\nENTRYPOINT /tmp/uid_test\n\n[root@node1 test]# ls\nDockerfile  uid_test  uid_test.c\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@node1 test]# docker build -t test-img:ver1 .\nSending build context to Docker daemon 12.29 kB\n-\u4ee5\u4e0b\u3001\u7565-\n\n\n\n7. \u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\n\n7.1 \u30a4\u30e1\u30fc\u30b8\u306e\u7f72\u540d\u30c1\u30a7\u30c3\u30af\u6a5f\u80fd(DOCKER_CONTENT_TRUST)\u3092\u6709\u52b9\u306b\u3059\u308b\n\u30a4\u30e1\u30fc\u30b8\u306e\u7f72\u540d\u30c1\u30a7\u30c3\u30af\u6a5f\u80fd\u3092\u6709\u52b9\u306b\u3059\u308b\u3068\u3001\u30a4\u30e1\u30fc\u30b8\u304c\u6539\u3056\u3093\u3055\u308c\u3066\u3044\u308b\u304b\u3069\u3046\u304b\u78ba\u8a8d\u3067\u304d\u308b\u3002\n\u672c\u6a5f\u80fd\u306fDocker1.8\u3067\u5b9f\u88c5\u3055\u308c\u305f\u3002\n--------------------------------------------------------\n1. \u7f72\u540d\u30c1\u30a7\u30c3\u30af\u6a5f\u80fd(DOCKER_CONTENT_TRUST)\u306b\u3064\u3044\u3066\u78ba\u8a8d\u3059\u308b\u3002\n--------------------------------------------------------\n\u30a4\u30e1\u30fc\u30b8\u306e\u7f72\u540d\u30c1\u30a7\u30c3\u30af\u6a5f\u80fd\u3092\u6709\u52b9\u306b\u3059\u308b\u3002\n[root@master1 ~]# export DOCKER_CONTENT_TRUST=1\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\n[root@master1 ~]# docker pull busybox\nUsing default tag: latest\nPull (1 of 1): docker.io/busybox:latest@sha256:29f5d56d12684887bdfa50dcd29fc31eea4aaf4ad3bec43daf19026a7ce69912\nTrying to pull repository docker.io/library/busybox ...\nsha256:29f5d56d12684887bdfa50dcd29fc31eea4aaf4ad3bec43daf19026a7ce69912: Pulling from docker.io/library/busybox\n56bec22e3559: Pull complete\nDigest: sha256:29f5d56d12684887bdfa50dcd29fc31eea4aaf4ad3bec43daf19026a7ce69912\nStatus: Downloaded newer image for docker.io/busybox@sha256:29f5d56d12684887bdfa50dcd29fc31eea4aaf4ad3bec43daf19026a7ce69912\nTagging docker.io/busybox@sha256:29f5d56d12684887bdfa50dcd29fc31eea4aaf4ad3bec43daf19026a7ce69912 as docker.io/busybox:latest\n\n\u30a4\u30e1\u30fc\u30b8\u304c\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3067\u304d\u305f\u3002\n[root@master1 ~]# docker images |grep busybox\ndocker.io/busybox                                     latest                             e02e811dd08f        7 weeks ago         1.093 MB\ndocker.io/busybox                                     <none>                             e02e811dd08f        7 weeks ago         1.093 MB\n\n\n\u5225\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\u30a4\u30e1\u30fc\u30b8\u306b\u7f72\u540d\u304c\u306a\u3044\u305f\u3081\u3001\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u304c\u5931\u6557\u3059\u308b\u3002\n[root@master1 ~]# docker pull sdurrheimer/prom-busybox\nUsing default tag: latest\nError: remote trust data does not exist for docker.io/sdurrheimer/prom-busybox: notary.docker.io does not have trust data for docker.io/sdurrheimer/prom-busybox\n\n                                  <none>                             e02e811dd08f        7 weeks ago         1.093 MB\n\n\u7f72\u540d\u30c1\u30a7\u30c3\u30af\u6a5f\u80fd\u3092\u7121\u52b9\u306b\u3059\u308b\u3002\n[root@master1 ~]# export DOCKER_CONTENT_TRUST=0\n\n\u3082\u3046\u4e00\u5ea6\u3001\u30a4\u30e1\u30fc\u30b8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\u7f72\u540d\u30c1\u30a7\u30c3\u30af\u6a5f\u80fd\u304c\u7121\u52b9\u306a\u306e\u3067\u3001\u30a4\u30e1\u30fc\u30b8\u306b\u7f72\u540d\u304c\u306a\u304f\u3066\u3082\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3067\u304d\u305f\u3002\n[root@master1 ~]# docker pull sdurrheimer/prom-busybox\nUsing default tag: latest\nTrying to pull repository docker.io/sdurrheimer/prom-busybox ...\nlatest: Pulling from docker.io/sdurrheimer/prom-busybox\n56bec22e3559: Already exists\n2e3e1c51b98e: Pull complete\nDigest: sha256:d2db77d1721fc54fab36939e94a329572c274ec4870d846771264991a0cd94d1\nStatus: Downloaded newer image for docker.io/sdurrheimer/prom-busybox:latest\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002\u516c\u5f0f\u306eBusybox\u306b\u52a0\u3048\u3001prom-busybox\u3068\u3044\u3046\u30a4\u30e1\u30fc\u30b8\u3082\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3067\u304d\u305f\u3002\n[root@master1 ~]# docker images |grep busybox\ndocker.io/sdurrheimer/prom-busybox                    latest                             172d95747d74        7 weeks ago         2.492 MB\ndocker.io/busybox                                     latest                             e02e811dd08f        7 weeks ago         1.093 MB\ndocker.io/busybox                                     <none>                             e02e811dd08f        7 weeks ago         1.093 MB\n[root@master1 ~]#\n\n\n--------------------------------------------------------------------------\n2. \u7279\u5b9a\u306e\u30a4\u30e1\u30fc\u30b8\u3060\u3051\u30c1\u30a7\u30c3\u30af\u6a5f\u80fd\u3092\u7121\u52b9\u306b\u3057\u305f\u3044\u5834\u5408(--disable-content-trust)\n--------------------------------------------------------------------------\n\u30a4\u30e1\u30fc\u30b8\u306e\u7f72\u540d\u30c1\u30a7\u30c3\u30af\u6a5f\u80fd\u3092\u6709\u52b9\u306b\u3059\u308b\u3002\n[root@master1 ~]# export DOCKER_CONTENT_TRUST=1\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\u7f72\u540d\u304c\u306a\u3044\u306e\u3067\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3067\u304d\u306a\u3044\u3002\n[root@master1 ~]# docker pull sdurrheimer/prom-busybox\nUsing default tag: latest\nError: remote trust data does not exist for docker.io/sdurrheimer/prom-busybox: notary.docker.io does not have trust data for docker.io/sdurrheimer/prom-busybox\n\n\u7f72\u540d\u304c\u306a\u304f\u3066\u3082\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3067\u304d\u308b\u30aa\u30d7\u30b7\u30e7\u30f3(--disable-content-trust)\u3092\u3064\u3051\u3066\u3001\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\n[root@master1 ~]# docker pull --disable-content-trust sdurrheimer/prom-busybox\nUsing default tag: latest\nTrying to pull repository docker.io/sdurrheimer/prom-busybox ...\nlatest: Pulling from docker.io/sdurrheimer/prom-busybox\n56bec22e3559: Pull complete\n2e3e1c51b98e: Pull complete\nDigest: sha256:d2db77d1721fc54fab36939e94a329572c274ec4870d846771264991a0cd94d1\nStatus: Downloaded newer image for docker.io/sdurrheimer/prom-busybox:latest\n\n\n\n7.2 \u30b3\u30f3\u30c6\u30ca\u9593\u901a\u4fe1\u3092\u7981\u6b62(--icc=false)\u306b\u3059\u308b\u65b9\u6cd5\n-------------------------------------------------\n1. \u30c7\u30d5\u30a9\u30eb\u30c8(--icc=true)\u306e\u3068\u304d\u306e\u6319\u52d5\u3092\u8abf\u3079\u308b\n-------------------------------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u306f5001\u756a\u30dd\u30fc\u30c8\u3067\u63a5\u7d9a\u5f85\u3061\u72b6\u614b\u306b\u3057\u3066\u304a\u304f\u3002\n[root@master1 ~]# docker run -d --name nc-test amouat/network-utils nc -l 5001\nb8f13cffe0748431b05ed08491c3fa36b3173ba9b4e5a93abdcf35ae89e4cb7e\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# docker ps\nCONTAINER ID        IMAGE                  COMMAND             CREATED             STATUS              PORTS               NAMES\nb8f13cffe074        amouat/network-utils   \"nc -l 5001\"        8 seconds ago       Up 4 seconds                            nc-test\n\n\u63a5\u7d9a\u5f85\u3061\u30b3\u30f3\u30c6\u30ca\u306b\u30e1\u30c3\u30bb\u30fc\u30b8(hello)\u3092\u9001\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n[root@master1 ~]# docker run -e IP=$(docker inspect -f {{.NetworkSettings.IPAddress}} nc-test) amouat/network-utils sh -c 'echo -n \"hello\" | nc -w 2 -v $IP 5001'\nConnection to 172.17.0.2 5001 port [tcp/*] succeeded!\n\n\n-------------------------------------------------\n2. \u30b3\u30f3\u30c6\u30ca\u9593\u901a\u4fe1\u3092\u7121\u52b9(--icc=false)\u306b\u3059\u308b\n-------------------------------------------------\n[root@master1 ~]# vi /etc/sysconfig/docker\n[root@master1 ~]# cat /etc/sysconfig/docker|grep OPTIONS\nOPTIONS='--iptables=true --icc=false'\n\n\u8a2d\u5b9a\u3092\u53cd\u6620\u3059\u308b\u3002\n[root@master1 ~]# systemctl restart docker\n\n\u8a2d\u5b9a\u3092\u78ba\u8a8d\u3059\u308b\u3002--icc=false\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# ps -C docker-current -o cmd\nCMD\n/usr/bin/docker-current daemon --exec-opt native.cgroupdriver=systemd --iptables=true \u2605--icc=false --storage-opt dm.basesize=50G --insecure-registry 192.\n[root@master1 ~]#\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u306f5001\u756a\u30dd\u30fc\u30c8\u3067\u63a5\u7d9a\u5f85\u3061\u72b6\u614b\u306b\u3057\u3066\u304a\u304f\u3002\n[root@master1 ~]# docker run -d --name nc-test amouat/network-utils nc -l 5001\n11d2572c0efa9b43c8818fa01922035965653ffcc669de4df2fed1dcea186a07\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# docker ps\nCONTAINER ID        IMAGE                  COMMAND             CREATED             STATUS              PORTS               NAMES\n11d2572c0efa        amouat/network-utils   \"nc -l 5001\"        14 seconds ago      Up 11 seconds                           nc-test\n\n\u63a5\u7d9a\u5f85\u3061\u30b3\u30f3\u30c6\u30ca\u306b\u30e1\u30c3\u30bb\u30fc\u30b8(hello)\u3092\u9001\u308b\u3002\u3057\u304b\u3057\u3001\u4eca\u5ea6\u306f\u9001\u4fe1\u3067\u304d\u306a\u3044\u3002\n[root@master1 ~]# docker run -e IP=$(docker inspect -f {{.NetworkSettings.IPAddress}} nc-test) amouat/network-utils sh -c 'echo -n \"hello\" | nc -w 2 -v $IP 5001'\nnc: connect to 172.17.0.2 port 5001 (tcp) timed out: Operation now in progress\n\n\n\n7.3 Docker Bench for Security\u3092\u4f7f\u3046\nDocker Bench for Security\u3092\u3064\u304b\u3063\u3066\u3001\n\u30b3\u30f3\u30c6\u30ca\u306e\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30c1\u30a7\u30c3\u30af\u3092\u884c\u3046\u3002\u73fe\u6642\u70b9\u3067\u306f\u4f7f\u3044\u65b9\u3060\u3051\u3002\n-------------------------------------------------------------\n1. Docker Bench for Security\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n-------------------------------------------------------------\nDocker Bench for Security\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\n[root@master1 ~]# git clone https://github.com/docker/docker-bench-security.git\nCloning into 'docker-bench-security'...\nremote: Counting objects: 810, done.\nremote: Total 810 (delta 0), reused 0 (delta 0), pack-reused 810\nReceiving objects: 100% (810/810), 395.98 KiB | 153.00 KiB/s, done.\nResolving deltas: 100% (546/546), done.\n\n\u30d3\u30eb\u30c9\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u79fb\u52d5\u3059\u308b\u3002\n[root@master1 ~]# cd docker-bench-security/\n[root@master1 docker-bench-security]# ls\nCONTRIBUTING.md  LICENSE.md   README.md          distros                   docker-compose.yml  output_lib.sh\nDockerfile       MAINTAINERS  benchmark_log.png  docker-bench-security.sh  helper_lib.sh       tests\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 docker-bench-security]# docker build -t docker-bench-security .\nSending build context to Docker daemon 154.1 kB\nStep 1 : FROM alpine:3.2\n ---> 7bed0150ea37\n-\u4ee5\u4e0b\u3001\u7565-\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 docker-bench-security]# docker images docker-bench-security\nREPOSITORY              TAG            IMAGE ID           CREATED             SIZE\ndocker-bench-security   latest         d59bf3a4d941       24 seconds ago      41.21 MB\n\n\n-------------------------------------------------------------\n2. \u8a66\u9a13\u5bfe\u8c61\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n-------------------------------------------------------------\n\u8a66\u9a13\u5bfe\u8c61(Nginx)\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 docker-bench-security]# docker run -d --name nginx nginx\n5ffaf5d636bf575b066b1e9995157c0600e5b8b645dc8b023c1239d564e5840e\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 docker-bench-security]# docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES\n5ffaf5d636bf        nginx               \"nginx -g 'daemon off\"   6 seconds ago       Up 4 seconds        80/tcp, 443/tcp     nginx\n[root@master1 docker-bench-security]#\n\n\n-------------------------------------------------------------\n3. \u30b3\u30f3\u30c6\u30ca\u306e\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30c1\u30a7\u30c3\u30af\u3092\u884c\u3046\u3002\n-------------------------------------------------------------\nDocker Bench for Security\u3092\u5b9f\u884c\u3059\u308b\u3002\u7d9a\u3051\u3066\u3001\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30c1\u30a7\u30c3\u30af\u306e\u5b9f\u884c\u7d50\u679c\u304c\u8868\u793a\u3055\u308c\u308b\u3002\nNginx\u306e\u30c1\u30a7\u30c3\u30af\u7d50\u679c\u306b\u306f\u2605\u5370\u3092\u3064\u3051\u3066\u3044\u307e\u3059\u3002\n[root@master1 docker-bench-security]# docker run -it --net host --pid host --cap-add audit_control \\\n      -v /var/lib:/var/lib \\\n      -v /var/run/docker.sock:/var/run/docker.sock \\\n      -v /usr/lib/systemd:/usr/lib/systemd \\\n      -v /etc:/etc --label docker_bench_security \\\n      docker-bench-security\n# ------------------------------------------------------------------------------\n# Docker Bench for Security v1.1.0\n#\n# Docker, Inc. (c) 2015-\n#\n# Checks for dozens of common best-practices around deploying Docker containers in production.\n# Inspired by the CIS Docker 1.11 Benchmark:\n# https://benchmarks.cisecurity.org/downloads/show-single/index.cfm?file=docker16.110\n# ------------------------------------------------------------------------------\n\nInitializing Sun Dec  4 09:09:01 GMT 2016\n\n\n[INFO] 1 - Host Configuration\n[WARN] 1.1  - Create a separate partition for containers\n[PASS] 1.2  - Use an updated Linux Kernel\n[WARN] 1.4  - Remove all non-essential services from the host - Network\n[WARN]      * Host listening on: 13 ports\n[WARN] 1.5  - Keep Docker up to date\n[WARN]       * Using 1.10.3, when 1.12.3 is current as of 2016-10-26\n[INFO]       * Your operating system vendor may provide support and security maintenance for docker\n[INFO] 1.6  - Only allow trusted users to control Docker daemon\n[WARN] 1.7  - Failed to inspect: auditctl command not found.\n[WARN] 1.8  - Failed to inspect: auditctl command not found.\n[WARN] 1.9  - Failed to inspect: auditctl command not found.\n[WARN] 1.10 - Failed to inspect: auditctl command not found.\n[INFO] 1.11 - Audit Docker files and directories - docker.socket\n[INFO]      * File not found\n[INFO] 1.12 - Audit Docker files and directories - /etc/default/docker\n[INFO]      * File not found\n[INFO] 1.13 - Audit Docker files and directories - /etc/docker/daemon.json\n[INFO]      * File not found\n[INFO] 1.14 - Audit Docker files and directories - /usr/bin/docker-containerd\n[INFO]      * File not found\n[INFO] 1.15 - Audit Docker files and directories - /usr/bin/docker-runc\n[INFO]      * File not found\n\n\n[INFO] 2 - Docker Daemon Configuration\n[WARN] 2.1  - Restrict network traffic between containers\n[WARN] 2.2  - Set the logging level\n[PASS] 2.3  - Allow Docker to make changes to iptables\n[PASS] 2.4  - Do not use insecure registries\n[PASS] 2.5  - Do not use the aufs storage driver\n[INFO] 2.6  - Configure TLS authentication for Docker daemon\n[INFO]      * Docker daemon not listening on TCP\n[INFO] 2.7 - Set default ulimit as appropriate\n[INFO]      * Default ulimit doesn't appear to be set\n[WARN] 2.8  - Enable user namespace support\n[PASS] 2.9  - Confirm default cgroup usage\n[PASS] 2.10 - Do not change base device size until needed\n[WARN] 2.11 - Use authorization plugin\n[WARN] 2.12 - Configure centralized and remote logging\n[WARN] 2.13 - Disable operations on legacy registry (v1)\n\n\n[INFO] 3 - Docker Daemon Configuration Files\n[PASS] 3.1  - Verify that docker.service file ownership is set to root:root\n[PASS] 3.2  - Verify that docker.service file permissions are set to 644\n[INFO] 3.3  - Verify that docker.socket file ownership is set to root:root\n[INFO]      * File not found\n[INFO] 3.4  - Verify that docker.socket file permissions are set to 644\n[INFO]      * File not found\n[PASS] 3.5  - Verify that /etc/docker directory ownership is set to root:root\n[PASS] 3.6  - Verify that /etc/docker directory permissions are set to 755\n[PASS] 3.7  - Verify that registry certificate file ownership is set to root:root\n[PASS] 3.8  - Verify that registry certificate file permissions are set to 444\n[INFO] 3.9  - Verify that TLS CA certificate file ownership is set to root:root\n[INFO]      * No TLS CA certificate found\n[INFO] 3.10 - Verify that TLS CA certificate file permissions are set to 444\n[INFO]      * No TLS CA certificate found\n[INFO] 3.11 - Verify that Docker server certificate file ownership is set to root:root\n[INFO]      * No TLS Server certificate found\n[INFO] 3.12 - Verify that Docker server certificate file permissions are set to 444\n[INFO]      * No TLS Server certificate found\n[INFO] 3.13 - Verify that Docker server key file ownership is set to root:root\n[INFO]      * No TLS Key found\n[INFO] 3.14 - Verify that Docker server key file permissions are set to 400\n[INFO]      * No TLS Key found\n[WARN] 3.15 - Verify that Docker socket file ownership is set to root:docker\n[WARN]      * Wrong ownership for /var/run/docker.sock\n[PASS] 3.16 - Verify that Docker socket file permissions are set to 660\n[INFO] 3.17 - Verify that daemon.json file ownership is set to root:root\n[INFO]      * File not found\n[INFO] 3.18 - Verify that daemon.json file permissions are set to 644\n[INFO]      * File not found\n[INFO] 3.19 - Verify that /etc/default/docker file ownership is set to root:root\n[INFO]      * File not found\n[INFO] 3.20 - Verify that /etc/default/docker file permissions are set to 644\n[INFO]      * File not found\n\n\n[INFO] 4 - Container Images and Build Files\n[WARN] 4.1  - Create a user for the container\n[WARN]      * Running as root: nginx  \u2605\n[WARN] 4.5  - Enable Content trust for Docker\n\n\n[INFO] 5  - Container Runtime\n[WARN] 5.1  - Verify AppArmor Profile, if applicable\n[WARN]      * No AppArmorProfile Found: nginx  \u2605\n[WARN] 5.2  - Verify SELinux security options, if applicable\n[WARN]      * No SecurityOptions Found: nginx  \u2605\n[PASS] 5.3  - Restrict Linux Kernel Capabilities within containers\n[PASS] 5.4  - Do not use privileged containers\n[PASS] 5.5  - Do not mount sensitive host system directories on containers\n[PASS] 5.6  - Do not run ssh within containers\n[PASS] 5.7  - Do not map privileged ports within containers\n[PASS] 5.9 - Do not share the host's network namespace\n[WARN] 5.10 - Limit memory usage for container\n[WARN]      * Container running without memory restrictions: nginx \u2605\n[WARN] 5.11 - Set container CPU priority appropriately\n[WARN]      * Container running without CPU restrictions: nginx \u2605\n[WARN] 5.12 - Mount container's root filesystem as read only\n[WARN]      * Container running with root FS mounted R/W: nginx  \u2605\n[PASS] 5.13 - Bind incoming container traffic to a specific host interface\n[WARN] 5.14 - Set the 'on-failure' container restart policy to 5\n[WARN]      * MaximumRetryCount is not set to 5: nginx     \u2605\n[PASS] 5.15 - Do not share the host's process namespace\n[PASS] 5.16 - Do not share the host's IPC namespace\n[PASS] 5.17 - Do not directly expose host devices to containers\n[INFO] 5.18 - Override default ulimit at runtime only if needed\n[INFO]      * Container no default ulimit override: nginx   \u2605\n[PASS] 5.19 - Do not set mount propagation mode to shared\n[PASS] 5.20 - Do not share the host's UTS namespace\n[PASS] 5.21 - Do not disable default seccomp profile\n[PASS] 5.24 - Confirm cgroup usage\n[WARN] 5.25 - Restrict container from acquiring additional privileges\n[WARN]      * Privileges not restricted: nginx   \u2605\n\n\n[INFO] 6  - Docker Security Operations\n[INFO] 6.4 - Avoid image sprawl\n[INFO]      * There are currently: 22 images\n[WARN]      * Only 2 out of 22 are in use\n[INFO] 6.5 - Avoid container sprawl\n[INFO]      * There are currently a total of 2 containers, with 2 of them currently running\n[root@master1 docker-bench-security]#\n\n\n\n7.3.1 \"[WARN]      * Running as root: <\u30b3\u30f3\u30c6\u30ca\u306e\u540d\u524d>\"\u306b\u5bfe\u51e6\u3059\u308b\n\u30b3\u30f3\u30c6\u30ca\u304croot\u30e6\u30fc\u30b6\u3067\u52d5\u4f5c\u3057\u3066\u3044\u308b\u305f\u3081\u306b\u51fa\u529b\u3055\u308c\u308b\u8b66\u544a\u3067\u3059\u3002\n\u30b3\u30f3\u30c6\u30ca\u3092\u4e00\u822c\u30e6\u30fc\u30b6\u3067\u52d5\u304b\u3059\u3053\u3068\u3067\u8b66\u544a\u306f\u89e3\u6d88\u3055\u308c\u307e\u3059\u3002\n[root@node1 test]# vi Dockerfile\n[root@node1 test]# cat Dockerfile\nFROM centos:centos7\nRUN useradd -u 2000 hana_shin\nUSER hana_shin\n[root@node1 test]# docker build -t test-img:ver1 --no-cache=true .\nSending build context to Docker daemon  5.12 kB\n-\u4ee5\u4e0b\u3001\u7565-\n\n[root@node1 test]# docker run -it --name test-con test-img:ver1 bash\n[hana_shin@54ba61db5ac7 /]$ id\nuid=2000(hana_shin) gid=2000(hana_shin) groups=2000(hana_shin)\n\n\n\n8 docker\u306e\u30c7\u30d0\u30c3\u30b0\u30aa\u30d7\u30b7\u30e7\u30f3\n\n8.1 \u30c7\u30d0\u30c3\u30b0\u30aa\u30d7\u30b7\u30e7\u30f3\u306e\u6307\u5b9a\u65b9\u6cd5\n\u5b9a\u7fa9\u30d5\u30a1\u30a4\u30eb(/etc/sysconfig/docker)\u306e--log-level\u306b\u30c7\u30d0\u30c3\u30b0\u30ec\u30d9\u30eb\u3092\u6307\u5b9a\u3059\u308b\u3002\n\u30c7\u30d0\u30c3\u30b0\u30ec\u30d9\u30eb\u3068\u3057\u3066\u306f\u4ee5\u4e0b\u306e\u3082\u306e\u304c\u3042\u308b\u3002fatal\u304c\u6700\u3082\u91cd\u8981\u5ea6\u304c\u9ad8\u304f\u3001debug\u304c\u6700\u3082\u91cd\u8981\u5ea6\u304c\u4f4e\u3044\u3002\n\u30001. fatal(\u512a\u5148\u5ea6\u9ad8)\n\u30002. error\n\u30003. warning\n\u30004. info(\u30c7\u30d5\u30a9\u30eb\u30c8)\n\u30005. debug(\u512a\u5148\u5ea6\u4f4e)\n\u30c7\u30d5\u30a9\u30eb\u30c8\u306finfo\u30ec\u30d9\u30eb\u306b\u306a\u3063\u3066\u3044\u308b\u3002info\u4ee5\u4e0a\u306e\u30ed\u30b0\u3092\u51fa\u529b\u3059\u308b\u3002\ndebug\u3092\u6307\u5b9a\u3059\u308b\u3068\u3001\u5168\u3066\u306e\u30ec\u30d9\u30eb\u306e\u30ed\u30b0\u3092\u51fa\u529b\u3059\u308b\u3053\u3068\u306b\u306a\u308b\u3002\n\u30c7\u30d0\u30c3\u30b0\u30ec\u30d9\u30eb\u306bdebug\u3092\u6307\u5b9a\u3057\u305f\u5834\u5408\u3092\u4ee5\u4e0b\u306b\u793a\u3059\u3002\n[root@master ~]# vi /etc/sysconfig/docker\nOPTIONS='--log-level=debug'\n\n8.2 info\u3092\u6307\u5b9a\u3057\u305f\u5834\u5408(\u5f97\u306b\u6307\u5b9a\u3057\u306a\u304f\u3066\u3082\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30ec\u30d9\u30eb)\ndocker\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master ~]# systemctl start docker\n\n\u5225\u306e\u30bf\u30fc\u30df\u30ca\u30eb\u3092\u3072\u3089\u3044\u3066\u3001syslog\u3092\u78ba\u8a8d\u3059\u308b\u3002warning\u3068info\u30ec\u30d9\u30eb\u306e\u30ed\u30b0\u304c\u51fa\u529b\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master ~]# tail -f /var/log/messages|grep -E '(fatal|error|warning|info|debug)'\nMar 12 10:02:46 master dockerd-current: time=\"2017-03-12T10:02:46.494348443+09:00\" level=info msg=\"libcontainerd: new containerd process, pid: 12877\"\nMar 12 10:02:47 master dockerd-current: time=\"2017-03-12T10:02:47.734320975+09:00\" level=warning msg=\"devmapper: Usage of loopback devices is strongly discouraged for production use. Please use `--storage-opt dm.thinpooldev` or use `man docker` to refer to dm.thinpooldev section.\"\nMar 12 10:02:47 master dockerd-current: time=\"2017-03-12T10:02:47.937309476+09:00\" level=warning msg=\"devmapper: Base device already exists and has filesystem xfs on it. User specified filesystem  will be ignored.\"\nMar 12 10:02:48 master dockerd-current: time=\"2017-03-12T10:02:48.031061132+09:00\" level=info msg=\"[graphdriver] using prior storage driver \\\"devicemapper\\\"\"\nMar 12 10:02:48 master dockerd-current: time=\"2017-03-12T10:02:48.054100692+09:00\" level=info msg=\"Graph migration to content-addressability took 0.00 seconds\"\nMar 12 10:02:48 master dockerd-current: time=\"2017-03-12T10:02:48.058632306+09:00\" level=info msg=\"Loading containers: start.\"\nMar 12 10:02:49 master dockerd-current: time=\"2017-03-12T10:02:49.018324023+09:00\" level=info msg=\"Loading containers: done.\"\nMar 12 10:02:49 master dockerd-current: time=\"2017-03-12T10:02:49.021027153+09:00\" level=info msg=\"Daemon has completed initialization\"\nMar 12 10:02:49 master dockerd-current: time=\"2017-03-12T10:02:49.021911520+09:00\" level=info msg=\"Docker daemon\" commit=\"047e51b/1.12.5\" graphdriver=devicemapper version=1.12.5\nMar 12 10:02:49 master dockerd-current: time=\"2017-03-12T10:02:49.106995415+09:00\" level=info msg=\"API listen on /var/run/docker.sock\"\n\n\n\n8.3 warning\u3092\u6307\u5b9a\u3057\u305f\u5834\u5408\n[root@master ~]# vi /etc/sysconfig/docker\nOPTIONS='--log-level=warning'\n\ndocker\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master ~]# systemctl start docker\n\n\u5225\u306e\u30bf\u30fc\u30df\u30ca\u30eb\u3092\u3072\u3089\u3044\u3066\u3001syslog\u3092\u78ba\u8a8d\u3059\u308b\u3002warning\u30ec\u30d9\u30eb\u306e\u30ed\u30b0\u3060\u3051\u304c\u51fa\u529b\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\ninfo\u30ec\u30d9\u30eb\u306e\u30ed\u30b0\u306f\u51fa\u529b\u3055\u308c\u306a\u304f\u306a\u3063\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\nMar 12 10:15:09 master dockerd-current: time=\"2017-03-12T10:15:09.791169342+09:00\" level=warning msg=\"devmapper: Usage of loopback devices is strongly discouraged for production use. Please use `--storage-opt dm.thinpooldev` or use `man docker` to refer to dm.thinpooldev section.\"\nMar 12 10:15:09 master dockerd-current: time=\"2017-03-12T10:15:09.962940297+09:00\" level=warning msg=\"devmapper: Base device already exists and has filesystem xfs on it. User specified filesystem  will be ignored.\"\n\n\n\n9.\u5404\u7a2e\u30a4\u30e1\u30fc\u30b8\u306e\u8d77\u52d5\n----------------\n1. CentOS5.11\n----------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -it --rm centos:centos5.11 bash\nUnable to find image 'centos:centos5.11' locally\nTrying to pull repository docker.io/library/centos ...\ncentos5.11: Pulling from docker.io/library/centos\n2068b24f564b: Pull complete\nDigest: sha256:c40041f5894293d0df8f5c6c2049b92a82c53f1718ecdd73cbf3c1826a08ba4a\nStatus: Downloaded newer image for docker.io/centos:centos5.11\n\n\u7248\u6570\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@4d4c5a456ff3 /]# cat /etc/redhat-release\nCentOS release 5.11 (Final)\n\n[root@master1 ~]# docker images centos:centos5.11\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\ndocker.io/centos    centos5.11          b424fba01172        4 months ago        284.1 MB\n\n----------------\n2. CentOS6.8\n----------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -it --rm centos:centos6.8 bash\nUnable to find image 'centos:centos6.8' locally\nTrying to pull repository docker.io/library/centos ...\ncentos6.8: Pulling from docker.io/library/centos\n67f15db7c18f: Pull complete\nDigest: sha256:37ee2dcd9a3a430136b566efb4aa1111ed332bfdef8b0de51a25d26891689fd7\nStatus: Downloaded newer image for docker.io/centos:centos6.8\n\n\u7248\u6570\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@805bd6c7ec2f /]# cat /etc/redhat-release\nCentOS release 6.8 (Final)\n[root@805bd6c7ec2f /]#\n\n[root@master1 ~]# docker images centos:centos6.8\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\ndocker.io/centos    centos6.8           0cd976dc0a98        4 months ago        194.5 MB\n\n----------------\n3. CentOS7.2\n----------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -it centos:centos7.2.1511 bash\n\n\u7248\u6570\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@7726e3a77531 /]# cat /etc/redhat-release\nCentOS Linux release 7.2.1511 (Core)\n[root@7726e3a77531 /]#\n[root@7726e3a77531 /]# exit\nexit\n[root@master1 ~]# docker images centos:centos7.2.1511\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\ndocker.io/centos    centos7.2.1511      feac5e0dfdb2        4 months ago        194.6 MB\n[root@master1 ~]#\n\n----------------\n4. CentOS7.3\n----------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -it centos:centos7.3.1611 bash\nUnable to find image 'centos:centos7.3.1611' locally\nTrying to pull repository docker.io/library/centos ...\ncentos7.3.1611: Pulling from docker.io/library/centos\nDigest: sha256:c577af3197aacedf79c5a204cd7f493c8e07ffbce7f88f7600bf19c688c38799\nStatus: Downloaded newer image for docker.io/centos:centos7.3.1611\n\n\u7248\u6570\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@b66640a84593 /]# cat /etc/redhat-release\nCentOS Linux release 7.3.1611 (Core)\n[root@b66640a84593 /]# exit\nexit\n[root@master1 ~]# docker images centos:centos7.3.1611\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\ndocker.io/centos    centos7.3.1611      67591570dd29        5 weeks ago         191.8 MB\n[root@master1 ~]#\n\n\n\n10. \u53c2\u8003\u8cc7\u6599\nDocker\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30ea\u30dd\u30b8\u30c8\u30ea(Docker Registry)\u69cb\u7bc9\u30ec\u30b7\u30d4\nDocker \u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u65e5\u672c\u8a9e\u5316\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\n\u3055\u304f\u3089\u306e\u30ca\u30ec\u30c3\u30b8\nDocker Content Trust \u5165\u9580\nDocker Content Trust Gets Hardware Signing\nAlien (\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2)\nDockerfile \u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9 \nDocker\u5b9f\u8df5\u5165\u9580\nDocker\u5b9f\u8df5\u30ac\u30a4\u30c9\n\u30d7\u30ed\u30b0\u30e9\u30de\u306e\u305f\u3081\u306eDocker\u6559\u79d1\u66f8 \u30a4\u30f3\u30d5\u30e9\u306e\u57fa\u790e\u77e5\u8b58\uff06\u30b3\u30fc\u30c9\u306b\u3088\u308b\u74b0\u5883\u69cb\u7bc9\u306e\u81ea\u52d5\u5316\nCreate the smallest possible Docker container\n[\u521d\u5fc3\u8005\u5411\u3051] Docker\u30b3\u30f3\u30c6\u30ca\u306e\u5185\u5074\nDocker/Aarukas\u5165\u9580\u30cf\u30f3\u30ba\u30aa\u30f3\u8cc7\u6599\uff5e\u7b2c1\u56de\u3055\u304f\u3089\u3068\u30b3\u30f3\u30c6\u30ca\u306e\u5915\u3079 #\u3055\u304f\u3089\u306e\u5915\u3079 \u756a\u5916\u7de8\n#1. \u30db\u30b9\u30c8\u7248\u6570\u3001Docker\u7248\u6570\n\n```\n[root@master1 ~]# cat /etc/redhat-release\nCentOS Linux release 7.2.1511 (Core)\n\n[root@master1 ~]# docker -v\nDocker version 1.10.3, build cb079f6-unsupported\n\n```\n\n\n#2. \u57fa\u672c\u7de8\n##2.1 Docker\u30b3\u30de\u30f3\u30c9\u306e\u30d8\u30eb\u30d7\u306e\u4f7f\u3044\u65b9\n\n```\ndocker\u30b3\u30de\u30f3\u30c9\u306b--help\u3092\u6307\u5b9a\u3059\u308b\u3002attach\u7b49\u306e\u30b5\u30d6\u30b3\u30de\u30f3\u30c9\u4e00\u89a7\u304c\u8868\u793a\u3055\u308c\u308b\u3002\n[root@master1 ~]# docker --help\n-\u4e2d\u7565-\nCommands:\n    attach    Attach to a running container\n    build     Build an image from a Dockerfile\n\u4ee5\u4e0b\u3001\u7565\n\n\n\u30b5\u30d6\u30b3\u30de\u30f3\u30c9\u306b--help\u3092\u6307\u5b9a\u3059\u308b\u3002\n[root@master1 ~]# docker attach --help\n\nUsage:  docker attach [OPTIONS] CONTAINER\n\nAttach to a running container\n\n  --detach-keys       Override the key sequence for detaching a container\n  --help              Print usage\n  --no-stdin          Do not attach STDIN\n  --sig-proxy=true    Proxy all received signals to the process\n[root@master1 ~]#\n\nnetwork\u30b5\u30d6\u30b3\u30de\u30f3\u30c9\u306f\u3001network\u30b5\u30d6\u30b3\u30de\u30f3\u30c9\u306e\u4e0b\u306b\u3001\u3055\u3089\u306b\u30b5\u30d6\u30b3\u30de\u30f3\u30c9\u304c\u3042\u308b\u3002\n[root@master1 ~]# docker network ls --help\n\nUsage:  docker network ls [OPTIONS]\n\nLists networks\n\n  -f, --filter=[]    Filter output based on conditions provided\n  --help             Print usage\n  --no-trunc         Do not truncate the output\n  -q, --quiet        Only display numeric IDs\n[root@master1 ~]#\n\n```\n\n\n\n\n#3. \u5fdc\u7528\u7de8\n##3.1 Docker\u30ec\u30b8\u30b9\u30c8\u30ea\u3092\u4f7f\u3046(\u30a4\u30e1\u30fc\u30b8\u306e\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\uff0f\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9)\n\n```\n\n------------------------------------------------------\n1. \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u7de8\u96c6(/etc/sysconfig/docker)\n------------------------------------------------------\n\u5b9a\u7fa9\u30d5\u30a1\u30a4\u30eb\u3092\u7de8\u96c6\u3059\u308b\u3002\n[root@master1 ~]# vi /etc/sysconfig/docker\n\n\u3010\u5909\u66f4\u524d\u3011\nINSECURE_REGISTRY='--insecure-registry'\n\n\u3010\u5909\u66f4\u5f8c\u3011\nINSECURE_REGISTRY='--insecure-registry master1:12345'\n\n  --insecure-registry <\u30db\u30b9\u30c8\u540d>:<TCP\u30dd\u30fc\u30c8\u756a\u53f7>\n\n   \u30db\u30b9\u30c8\u540d:docker\u30c7\u30fc\u30e2\u30f3\u304c\u52d5\u4f5c\u3057\u3066\u3044\u308b\u30db\u30b9\u30c8\u540d\u3092\u6307\u5b9a\u3059\u308b\u3002\n             /etc/hosts\u306b\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u308b\u540d\u524d\u3092\u6307\u5b9a\u3059\u308b\u3002\n   \u30dd\u30fc\u30c8\u756a\u53f7:\u30db\u30b9\u30c8\u306eTCP\u30dd\u30fc\u30c8\u756a\u53f7\u3092\u6307\u5b9a\u3059\u308b\u3002\n              \u65e2\u5b58\u30dd\u30fc\u30c8\u756a\u53f7\u3068\u91cd\u8907\u3057\u306a\u3044\u3088\u3046\u306b\u9078\u629e\u3059\u308b\u3002\n\n\n\u8a2d\u5b9a\u5909\u66f4\u3057\u305f\u3089docker\u3092\u518d\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# systemctl restart docker\n\n\n------------------------------------------------------\n2. Docker\u30ec\u30b8\u30b9\u30c8\u30ea\u3092\u6e96\u5099\u3059\u308b\n------------------------------------------------------\nDocker\u30ec\u30b8\u30b9\u30c8\u30ea\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\n[root@master1 ~]# docker pull registry:2.4.1\nTrying to pull repository docker.io/library/registry ...\n2.4.1: Pulling from docker.io/library/registry\n-\u4ee5\u4e0b\u3001\u7565-\n\nDocker\u30ec\u30b8\u30b9\u30c8\u30ea\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -d -p 12345:5000 --name test-registry registry:2.4.1\n894bcb0a2a4830013991ac827315ff7287d623d1031dc32e1d4848ccf93f013f\n\nDocker\u30ec\u30b8\u30b9\u30c8\u30ea\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                     NAMES\n894bcb0a2a48        registry:2.4.1      \"/bin/registry serve \"   7 seconds ago       Up 4 seconds        0.0.0.0:12345->5000/tcp   test-registry\n\n\n------------------------------------------------------\n3. Docker\u30ec\u30b8\u30b9\u30c8\u306b\u30a4\u30e1\u30fc\u30b8\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\n------------------------------------------------------\n\u30c6\u30b9\u30c8\u7528\u30a4\u30e1\u30fc\u30b8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\u30a4\u30e1\u30fc\u30b8\u30b5\u30a4\u30ba\u304c\u5c0f\u3055\u3044busybox\u3092\u4f7f\u3046\u3002\n[root@master1 ~]# docker pull busybox\nUsing default tag: latest\nTrying to pull repository docker.io/library/busybox ...\n-\u4ee5\u4e0b\u3001\u7565-\n\n\u30a4\u30e1\u30fc\u30b8\u306btag\u4ed8\u3051\u3092\u3059\u308b\n[root@master1 ~]# docker tag busybox master1:12345/hana_shin/busybox:ver1\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# docker images |grep busybox\ndocker.io/busybox                            latest            e02e811dd08f        8 weeks ago         1.093 MB\nmaster1:12345/hana_shin/busybox              ver1              e02e811dd08f        8 weeks ago         1.093 MB\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\u3002\n[root@master1 ~]# docker push master1:12345/hana_shin/busybox:ver1\nThe push refers to a repository [master1:12345/hana_shin/busybox]\ne88b3f82283b: Pushed\nver1: digest: sha256:9393222c6789842b16bcf7306b6eb4b486d81a48d3b8b8f206589b5d1d5a6101 size: 505\n\n\n-------------------------------------------------------------\n4. \u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3057\u305f\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002\n-------------------------------------------------------------\nDocker\u30ec\u30b8\u30b9\u30c8\u30ea\u306b\u767b\u9332\u3057\u305f\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# curl http://localhost:12345/v2/_catalog\n{\"repositories\":[\"hana_shin/busybox\"]}\n\ntag\u3092\u53d6\u5f97\u3059\u308b\u3002\n[root@master1 ~]# curl http://localhost:12345/v2/hana_shin/busybox/tags/list\n{\"name\":\"hana_shin/busybox\",\"tags\":[\"ver1\"]}\n\n\n-------------------------------------------------------------\n5. Docker\u30ec\u30b8\u30b9\u30c8\u30ea\u304b\u3089\u30a4\u30e1\u30fc\u30b8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\n-------------------------------------------------------------\n\u30db\u30b9\u30c8\u5074\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u524a\u9664\u3059\u308b\u3002\n[root@master1 ~]# docker images |grep busybox\ndocker.io/busybox                                     latest                             e02e811dd08f        8 weeks ago         1.093 MB\nmaster1:12345/hana_shin/busybox                       ver1                               e02e811dd08f        8 weeks ago         1.093 MB\n[root@master1 ~]# docker rmi -f e02e811dd08f\nUntagged: docker.io/busybox:latest\nUntagged: master1:12345/hana_shin/busybox:ver1\nDeleted: sha256:e02e811dd08fd49e7f6032625495118e63f597eb150403d02e3238af1df240ba\nDeleted: sha256:e88b3f82283bc59d5e0df427c824e9f95557e661fcb0ea15fb0fb6f97760f9d9\n\nbusybox\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002\u524a\u9664\u3067\u304d\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# docker images |grep busybox\n[root@master1 ~]#\n\nDocker\u30ec\u30b8\u30b9\u30c8\u30ea\u304b\u3089\u30a4\u30e1\u30fc\u30b8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\n[root@master1 ~]# docker pull master1:12345/hana_shin/busybox:ver1\nTrying to pull repository master1:12345/hana_shin/busybox ...\nver1: Pulling from master1:12345/hana_shin/busybox\n56bec22e3559: Pull complete\nDigest: sha256:9393222c6789842b16bcf7306b6eb4b486d81a48d3b8b8f206589b5d1d5a6101\nStatus: Downloaded newer image for master1:12345/hana_shin/busybox:ver1\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002Docker\u30ec\u30b8\u30b9\u30c8\u30ea\u304b\u3089\u30a4\u30e1\u30fc\u30b8\u3092pull\u3067\u304d\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# docker images |grep busybox\nmaster1:12345/hana_shin/busybox                       ver1                               e02e811dd08f        8 weeks ago         1.093 MB\n\n\n-------------------------------------------------------------\n6. docker\u30b3\u30de\u30f3\u30c9\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u8aac\u660e\n-------------------------------------------------------------\ndocker run -d -p 12345:5000 --name test-registry registry\n            A      A            A                  A\n            |      |            |                  +--- \u30a4\u30e1\u30fc\u30b8\u306e\u540d\u524d\u3092\u6307\u5b9a\u3059\u308b\u3002\n            |      |            +---------------------- \u30b3\u30f3\u30c6\u30ca\u306e\u540d\u524d\u3092\u6307\u5b9a\u3059\u308b\u3002\u4efb\u610f\u306e\u540d\u524d\u3067OK\n            |      +----------------------------------- \u30db\u30b9\u30c8\u5074TCP\u30dd\u30fc\u30c8\u756a\u53f7(12345)\u3092\u30b3\u30f3\u30c6\u30ca\u306e\u30dd\u30fc\u30c8\u756a\u53f7(5000)\u306b\u5bfe\u5fdc\u4ed8\u3051\u3059\u308b\u3002\n            +------------------------------------------ \u30b3\u30f3\u30c6\u30ca\u3092\u30d0\u30c3\u30af\u30b0\u30e9\u30a6\u30f3\u30c9\u3067\u52d5\u304b\u3059\u305f\u3081\u306e\u6307\u5b9a\n\n\ndocker tag busybox localhost:12345/test/busybox:ver1\n             A       A         A     A    A      A\n             |       |         |     |    |      +------ tag\u540d\n             |       |         |     |    +------------- \u30a4\u30e1\u30fc\u30b8\u540d\n             |       |         |     +------------------ \u30ea\u30dd\u30b8\u30c8\u30ea\u540d\n             |       |         +------------------------ \u30db\u30b9\u30c8\u306eTCP\u30dd\u30fc\u30c8\u756a\u53f7(\u30db\u30b9\u30c8\u3068\u306fDocker\u30b5\u30fc\u30d0\u304c\u52d5\u4f5c\u3057\u3066\u3044\u308b\u30b5\u30fc\u30d0\u306eIP\u30a2\u30c9\u30ec\u30b9\u3067\u3059)\n             |       +---------------------------------- \u30db\u30b9\u30c8\u306eIP\u30a2\u30c9\u30ec\u30b9\n             +------------------------------------------ \u5143\u306e\u30a4\u30e1\u30fc\u30b8\u306e\u540d\u524d\n\n```\n\n\n\n\n##3.2 \u30db\u30b9\u30c8\u304b\u3089\u30b3\u30f3\u30c6\u30ca\u3078\u306e\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0(2\u306e\u7d9a\u304d)\n\n```\nregistry\u30b5\u30fc\u30d0\u3092\u8d77\u52d5\u3059\u308b\u3068\u3001DNAT\u30c6\u30fc\u30d6\u30eb\u304c\u4f5c\u3089\u308c\u307e\u3059\u3002DNAT\u306e\u5909\u63db\u30eb\u30fc\u30eb\u306e\u610f\u5473\u306f\u6b21\u306e\u3068\u304a\u308a\u3002\n\u30db\u30b9\u30c8\u306e\u4efb\u610f(0.0.0.0)\u306e\u30a4\u30f3\u30bf\u30d5\u30a7\u30fc\u30b9\u306b\u5230\u7740\u3057\u305fIP\u30d1\u30b1\u30c3\u30c8\u3067\u5b9b\u5148TCP\u30dd\u30fc\u30c8\u756a\u53f7\u304c12345\u306e\u30d1\u30b1\u30c3\u30c8\u306f\u3001\n\u5b9b\u5148IP\u30a2\u30c9\u30ec\u30b9\u3092172.17.0.2,\u5b9b\u5148\u30dd\u30fc\u30c8\u756a\u53f7\u30925000\u306b\u5909\u63db\u3059\u308b\u3002\n[root@master1 ~]# iptables -L -t nat -n |grep -B3 12345\nChain DOCKER (2 references)\ntarget     prot opt source               destination\nRETURN     all  --  0.0.0.0/0            0.0.0.0/0\nDNAT       tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:12345 to:172.17.0.2:5000\n\n\n\u30b3\u30f3\u30c6\u30ca\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u3066IP\u30a2\u30c9\u30ec\u30b9\u3092\u8abf\u3079\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u306eIP\u30a2\u30c9\u30ec\u30b9\u306f\"172.17.0.2\"\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# docker exec -it test-registry sh\n/ # ip a\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n    inet6 ::1/128 scope host\n       valid_lft forever preferred_lft forever\n20: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP\n    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff\n    inet 172.17.0.2/16 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::42:acff:fe11:2/64 scope link\n       valid_lft forever preferred_lft forever\n/ #\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u30d7\u30ed\u30bb\u30b9\u304c\u4f7f\u7528\u3057\u3066\u3044\u308b\u30dd\u30fc\u30c8\u756a\u53f7\u3092\u8abf\u3079\u308b\u3002\n/ # netstat -antp\nActive Internet connections (servers and established)\nProto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name\ntcp        0      0 :::5000                 :::*                    LISTEN      1/registry\n/ #\n```\n\n\n\u3055\u3089\u306b\u3082\u30461\u3064registry\u30b5\u30fc\u30d0\u3092\u8d77\u52d5\u3057\u305f\u3068\u304d\u306e\u30db\u30b9\u30c8\u306e\u69d8\u5b50\u3092\u4ee5\u4e0b\u306b\u793a\u3057\u307e\u3059\u3002\n\n```\n[root@master1 ~]# docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                     NAMES\n467b1628f13b        registry            \"/entrypoint.sh /etc/\"   30 minutes ago      Up 30 minutes       0.0.0.0:22222->5000/tcp   test2-registry\nb00c90063f16        registry            \"/entrypoint.sh /etc/\"   3 hours ago         Up 33 minutes       0.0.0.0:12345->5000/tcp   test-registry\n\n[root@master1 ~]# iptables -L -t nat -n |grep -e 12345 -e 22222\nDNAT       tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:12345 to:172.17.0.2:5000\nDNAT       tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:22222 to:172.17.0.3:5000\n\n```\n\n\ndocker0\u306f\u30d6\u30ea\u30c3\u30b8\u3067\u3059\u3002container\u306f\u8d77\u52d5\u3059\u308b\u3068\u3001\u3053\u306e\u30d6\u30ea\u30c3\u30b8\u306b\u63a5\u7d9a\u3055\u308c\u307e\u3059\u3002\n\u30d6\u30ea\u30c3\u30b8\u306b\u306f\u30dd\u30fc\u30c8\u304c\u5272\u308a\u5f53\u3066\u3089\u308c\u307e\u3059\u3002container1\u3068vethXXX,container2\u3068vethYYY\u304c\u305d\u308c\u305e\u308c\u3064\u306a\u304c\u3063\u3066\u3044\u307e\u3059\u3002\n\n\n\n```\n\n +---------- Host(CentOS7.2)-------------+\n |                                       |\n |  +- container1 -+   +- container2 -+  |\n |  |              |   |              |  |\n |  |   port=5000  |   |   port=5000  |  |\n |  |              |   |              |  |\n |  +---- eth0 ----+   +---- eth0 - --+  |   -*-\n |    A    | .2               | .3  A    |    |\n |    |    |                  |     |    | 172.16.0.0/16\u306e\u30b5\u30d6\u30cd\u30c3\u30c8\n |  +-|- vethXXX --------- vethYYY -|-+  |    |\n |  | |    docker0(172.17.0.1/16)   | |  |    |\n |  +-|-----------------------------|-+  |   -*-\n |    |              |              |    |\n |    +----+         |          +---+    |\n |         |         |          |        |\n |  +------|--------------------|-----+  |\n |  |      |       Routing      |     | ========> +----------------------------------------------------------------------------------------+\n |  +------|--------------------|-----+  |        |\u3010\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u30c6\u30fc\u30d6\u30eb\u3011\u5b9b\u5148IP\u30a2\u30c9\u30ec\u30b9\u3088\u308a\u3001\u51fa\u529b\u3059\u308b\u30c7\u30d0\u30a4\u30b9(eth0,dcoker0)\u3092\u6c7a\u3081\u308b            |\n |         |         |          |        |        | [root@master1 ~]# route -n                                                             |\n |  port=12345       |      port=22222   |        | Kernel IP routing table                                                                |\n |         |         |          |        |        | Destination     Gateway         Genmask         Flags Metric Ref    Use Iface          |\n +----- eth0 (192.168.0.10/24) -|--------+        | 0.0.0.0         192.168.0.1     0.0.0.0         UG    100    0        0 eth0           |\n           |         |          |                 | 172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0        |\n                     |                            | 192.168.0.0     0.0.0.0         255.255.255.0   U     100    0        0 eth0           |\n                     |                            +----------------------------------------------------------------------------------------+\n\n\n\n```\n\n\n##3.3 \u30b3\u30f3\u30c6\u30caID\u304b\u3089\u30d7\u30ed\u30bb\u30b9ID\u3092\u6c42\u3081\u308b\u65b9\u6cd5\n\n```\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -it --name test-con centos:centos7 bash\n[root@22914bed7a73 /]# ps\n   PID TTY          TIME CMD\n     1 ?        00:00:00 bash\n    16 ?        00:00:00 ps\n\n\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3092\u8d77\u52d5\u3057\u3066\u3001\u30b3\u30f3\u30c6\u30caID\u3092\u6c42\u3081\u308b\n[root@master1 ~]# CID=$(docker ps --no-trunc=true|grep \"test-con\"|awk '{print $1}')\n\n\u30b3\u30f3\u30c6\u30caID\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# echo $CID\n22914bed7a73ee10382d23a1066dfb3ec94e44de0390af087ccfb4b2b751384b\n\nPID\u3092\u6c42\u3081\u308b\u3002\n[root@master1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\nPID\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# echo $PID\n2857\n\n\u30d7\u30ed\u30bb\u30b9\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# ps -lp 2857\nF S   UID    PID   PPID  C PRI  NI ADDR SZ WCHAN  TTY          TIME CMD\n4 S     0   2857   1053  0  80   0 -  2944 n_tty_ pts/2    00:00:00 bash\n\n```\n\n\n##3.4 \u30b3\u30f3\u30c6\u30ca\u304c\u30db\u30b9\u30c8\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u30de\u30a6\u30f3\u30c8\u3059\u308b\u65b9\u6cd5\n\n```\n-------------------------------------------------------------\n1. \u30de\u30a6\u30f3\u30c8\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u660e\u793a\u7684\u306b\u6307\u5b9a\u3059\u308b\u65b9\u6cd5(-v\u30aa\u30d7\u30b7\u30e7\u30f3)\n-------------------------------------------------------------\n\n\u30de\u30a6\u30f3\u30c8\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\"svirt_sandbox_file_t\"\u3068\u3044\u3046SElinux\u306e\u30bf\u30a4\u30d7\u3092\u8a2d\u5b9a\u3059\u308b\u3002\n[root@master1 ~]# ls -ldZ registry/\ndrwxr-xr-x. root root unconfined_u:object_r:admin_home_t:s0 registry/\n[root@master1 ~]# chcon -Rt svirt_sandbox_file_t registry\n[root@master1 ~]# ls -ldZ registry/\ndrwxr-xr-x. root root unconfined_u:object_r:svirt_sandbox_file_t:s0 registry/\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -it -v $HOME/registry:/var/lib/registry --name test centos:centos7 bash\n\n\n\u30de\u30a6\u30f3\u30c8\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@08497e222b5e /]# touch /var/lib/registry/test.txt\n[root@08497e222b5e /]# echo \"This is container\" > /var/lib/registry/test.txt\n[root@08497e222b5e /]# cat /var/lib/registry/test.txt\nThis is container\n\n\n\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3067\u4f5c\u6210\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u306e\u4e2d\u8eab\u3092\u78ba\u8a8d\u3059\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u3067\u4f5c\u6210\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u306e\u4e2d\u8eab\u304c\u78ba\u8a8d\u3067\u304d\u305f\u3002\n[root@master1 ~]# pwd\n/root\n[root@master1 ~]# cat registry/test.txt\nThis is container\n\n\n-------------------------------------------------------------\n2. \u30de\u30a6\u30f3\u30c8\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u3092\u660e\u793a\u7684\u306b\u6307\u5b9a\u3057\u306a\u3044\u65b9\u6cd5\u3002\n-------------------------------------------------------------\n\n\u3053\u306e\u5834\u5408\u3001\u30b3\u30f3\u30c6\u30ca\u306f\u30db\u30b9\u30c8\u306e/var/lib/docker/volumes\u914d\u4e0b\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u30de\u30a6\u30f3\u30c8\u3057\u307e\u3059\u3002\n\n\n--------------------------------------------------------------------------------------\n2.1 Dockerfile\u3067VOLUME\u3092\u6307\u5b9a\u3059\u308b\u65b9\u6cd5\n--------------------------------------------------------------------------------------\nDockerfile\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 ~]# vi Dockerfile\n[root@master1 ~]# cat Dockerfile\nFROM centos:centos7\nVOLUME /root/dir01\nVOLUME /root/dir02\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 ~]# docker build -t test-image:v1 .\nSending build context to Docker daemon  84.3 MB\nStep 1 : FROM centos:centos7\n ---> 0584b3d2cf6d\nStep 2 : VOLUME /root/dir01\n ---> Using cache\n ---> 226d9d64338d\nStep 3 : VOLUME /root/dir02\n ---> Using cache\n ---> 6584f874444e\nSuccessfully built 6584f874444e\n[root@master1 ~]#\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -itd --name test-con test-image:v1\n45f6382fd50f21361a911080bf1a3e5d8b91781df0677f6d63ebca5fb334cb64\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# docker ps\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\n45f6382fd50f        test-image:v1       \"/bin/bash\"         26 seconds ago      Up 24 seconds                           test-con\n\njq\u30b3\u30de\u30f3\u30c9\u304c\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n[root@master1 ~]# yum -y install jq\n\n\u30db\u30b9\u30c8\u5074\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u78ba\u8a8d\u3059\u308b\u3002/var/lib/docker/volumes\u914d\u4e0b(\u2605\u5370)\u306b\u30de\u30c3\u30d4\u30f3\u30b0\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# docker inspect test-con | jq .|less\n\n-\u4e2d\u7565-\n    \"Mounts\": [\n      {\n        \"Name\": \"d7b8625f00b37f7648fbb5b7d92e1204c7d5b4b2c314051208929080e2d3d82d\",\n      \u2605\"Source\": \"/var/lib/docker/volumes/d7b8625f00b37f7648fbb5b7d92e1204c7d5b4b2c314051208929080e2d3d82d/_data\",\n        \"Destination\": \"/root/dir01\",\n        \"Driver\": \"local\",\n        \"Mode\": \"\",\n        \"RW\": true,\n        \"Propagation\": \"\"\n      },\n      {\n        \"Name\": \"761db694fb793079933981ce9094920c1814f964eba4635bf292e1a038a8f428\",\n      \u2605\"Source\": \"/var/lib/docker/volumes/761db694fb793079933981ce9094920c1814f964eba4635bf292e1a038a8f428/_data\",\n        \"Destination\": \"/root/dir02\",\n        \"Driver\": \"local\",\n        \"Mode\": \"\",\n        \"RW\": true,\n        \"Propagation\": \"\"\n      }\n    ],\n\u4ee5\u4e0b\u3001\u7565\n\n\n\u30b3\u30f3\u30c6\u30ca\u306ebash\u306b\u63a5\u7d9a\u3059\u308b\u3002\n[root@master1 ~]# docker exec -it test-con bash\n\nVOLUME\u3067\u6307\u5b9a\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u304c\u4f5c\u6210\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@45f6382fd50f /]# cd /root/\n[root@45f6382fd50f ~]# ls\nanaconda-ks.cfg  dir01  dir02\n\n\ndir01\u914d\u4e0b\u306b\u30d5\u30a1\u30a4\u30eb(file01)\u3092\u4f5c\u6210\u3059\u308b\n[root@45f6382fd50f ~]# cd dir01/\n[root@45f6382fd50f dir01]# touch file01\n[root@45f6382fd50f dir01]# echo \"This is file01\" > file01\n[root@45f6382fd50f dir01]# cat file01\nThis is file01\n\n\n\u4f5c\u6210\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u306e\u4e2d\u8eab\u3092\u30db\u30b9\u30c8\u5074\u3067\u78ba\u8a8d\u3059\u308b\u3002\u3082\u30461\u3064\u30bf\u30fc\u30df\u30ca\u30eb\u3092\u8d77\u52d5\u3059\u308b\u3002\n\u30b3\u30f3\u30c6\u30ca\u3067\u66f8\u3044\u305f\u30d5\u30a1\u30a4\u30eb\u306e\u5185\u5bb9\u304c\u30db\u30b9\u30c8\u3067\u8aad\u3081\u305f\u3002\n[root@master1 ~]# cat /var/lib/docker/volumes/d7b8625f00b37f7648fbb5b7d92e1204c7d5b4b2c314051208929080e2d3d82d/_data/file01\nThis is file01\n\n\n--------------------------------------------------------------------------------------\n2.2. docker run\u5b9f\u884c\u6642\u306b\u6307\u5b9a\u3059\u308b\u65b9\u6cd5.  \u78ba\u8a8d\u65b9\u6cd5\u306f2.1\u3092\u53c2\u8003\u306b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n--------------------------------------------------------------------------------------\n[root@master1 ~]# docker run -it --rm -v /root/dir01 -v /root/dir02 centos:centos7 bash\n[root@0e646e283a53 /]# cd root/\n[root@0e646e283a53 ~]# ls\nanaconda-ks.cfg  dir01  dir02\n[root@0e646e283a53 ~]#\n\n\n```\n\n\n\n##3.5 \u30db\u30b9\u30c8\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u30ea\u30fc\u30c9\u30aa\u30f3\u30ea\u30fc(ro\u30aa\u30d7\u30b7\u30e7\u30f3)\u3067\u30de\u30a6\u30f3\u30c8\u3059\u308b\u3002\n\n```\n\u30b3\u30f3\u30c6\u30ca\u3067\u30de\u30a6\u30f3\u30c8\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 ~]# mkdir /hostdir\n[root@master1 ~]# chcon -Rt svirt_sandbox_file_t /hostdir\n[root@master1 ~]# ls -ldZ /hostdir\ndrwxr-xr-x. root root unconfined_u:object_r:svirt_sandbox_file_t:s0 /hostdir\n\n\u30db\u30b9\u30c8\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u30ea\u30fc\u30c9\u30aa\u30f3\u30ea\u30fc(ro\u30aa\u30d7\u30b7\u30e7\u30f3)\u3067\u30de\u30a6\u30f3\u30c8\u3059\u308b\u3002\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u3066\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\u304c\u3067\u304d\u306a\u3044\u3002\n[root@master1 ~]# docker run -it -v /hostdir:/tmp:ro busybox sh\n/ # echo \"This is container\" > /tmp/test.txt\nsh: can't create /tmp/test.txt: Read-only file system\n/ # exit\n\n\u4eca\u5ea6\u306f\u3001\u66f8\u304d\u8fbc\u307f\u53ef\u3067\u30de\u30a6\u30f3\u30c8\u3059\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u3067\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u305f\u3002\n[root@master1 ~]# docker run -it -v /hostdir:/tmp busybox sh\n/ # echo \"This is container\" > /tmp/test.txt\n/ # exit\n[root@master1 ~]# cat /hostdir/test.txt\nThis is container\n[root@master1 ~]#\n\n```\n\n\n\n##3.6 \u30c7\u30fc\u30bf\u4fdd\u5b58\u5c02\u7528\u30b3\u30f3\u30c6\u30ca\u306e\u4f5c\u6210\u65b9\u6cd5\n\n\n```\ndata_con\u30b3\u30f3\u30c6\u30ca\u306e/data_dir\u306b\u5bfe\u3057\u3066\u3001con\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u30d5\u30a1\u30a4\u30eb\u306e\u8aad\u307f\u66f8\u304d\u3092\u3059\u308b\u3002\n\n    con\u30b3\u30f3\u30c6\u30ca                data_con\u30b3\u30f3\u30c6\u30ca(\u30c7\u30fc\u30bf\u4fdd\u5b58\u5c02\u7528)\n                 -------->     /data_dir\n                read/write\n\n\n\u30c7\u30fc\u30bf\u4fdd\u5b58\u5c02\u7528\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002-v\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u4f7f\u3063\u3066\u3001/data_dir\u3092\u4ed6\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u53c2\u7167\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u3002\n[root@master1 ~]# docker run -it -v /data_dir --name data_con busybox sh\n/ # ls /data_dir/\n/ # echo \"This is data-container\" > /data_dir/data.txt\n/ # exit\n\n\u3082\u30461\u3064\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u30c7\u30fc\u30bf\u4fdd\u5b58\u5c02\u7528\u30b3\u30f3\u30c6\u30ca\u306b\u4fdd\u5b58\u3057\u305f\n[root@master1 ~]# docker run -it --volumes-from data_con --name con busybox sh\n/ # cat /data_dir/data.txt\nThis is data-container\n/ # exit\n\n\n```\n\n\n##3.7 \u540c\u4e00\u30db\u30b9\u30c8\u3067nginx\u30b3\u30f3\u30c6\u30ca\u3092\u8907\u6570\u8d77\u52d5\u3059\u308b\u3002\n\n```\n\u30db\u30b9\u30c8\u306eTCP\u30dd\u30fc\u30c8\u756a\u53f711111\u3092\u30b3\u30f3\u30c6\u30ca\u306e\u30dd\u30fc\u30c8\u756a\u53f780\u306b\u30de\u30c3\u30d7\u3059\u308b\u3002\n[root@master1 ~]# docker run -d -p 11111:80 --name web1 nginx\n498c3d59429b7756d63a83cbd8285f68a0a6a4470227fa58cc62c3f1cf682164\n\n\u30db\u30b9\u30c8\u306eTCP\u30dd\u30fc\u30c8\u756a\u53f722222\u3092\u30b3\u30f3\u30c6\u30ca\u306e\u30dd\u30fc\u30c8\u756a\u53f780\u306b\u30de\u30c3\u30d7\u3059\u308b\u3002\n[root@master1 ~]# docker run -d -p 22222:80 --name web2 nginx\ncc5d925c88ca18542931dba346f0ae011cd414f7aad3d00fc95172e4d7fc6d69\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u78ba\u8a8d\u3059\u308b\u3002\u305d\u308c\u305e\u308c\u300111111->80,22222->80\u3000\u306b\u30de\u30c3\u30d7\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# docker ps |grep -e web1 -e web2\ncc5d925c88ca        nginx               \"nginx -g 'daemon off\"   15 seconds ago      Up 13 seconds       443/tcp, 0.0.0.0:22222->80/tcp   web2\n498c3d59429b        nginx               \"nginx -g 'daemon off\"   26 seconds ago      Up 23 seconds       443/tcp, 0.0.0.0:11111->80/tcp   web1\n\n[root@master1 ~]# curl http://localhost:11111\n<!DOCTYPE html>\n<html>\n<head>\n<title>Welcome to nginx!</title>\n\u4ee5\u4e0b\u3001\u7565\n\n[root@master1 ~]# curl http://localhost:22222\n<!DOCTYPE html>\n<html>\n<head>\n<title>Welcome to nginx!</title>\n\u4ee5\u4e0b\u3001\u7565\n\n[root@master1 ~]# docker rm -f web1 web2\nweb1\nweb2\n[root@master1 ~]#\n\n\n```\n\n##3.8 \u30b3\u30f3\u30c6\u30ca\u304c\u52d5\u4f5c\u3059\u308bCPU\u3092\u6307\u5b9a\u3059\u308b\u65b9\u6cd5(--cpuset-cpus\u30aa\u30d7\u30b7\u30e7\u30f3)\n\n```\n\n----------------------------------------------------\n1. dd\u30b3\u30de\u30f3\u30c9\u3067CPU\u8ca0\u8377\u3092\u304b\u3051\u308b\n----------------------------------------------------\n\u30b3\u30f3\u30c6\u30ca\u304c\u3069\u306eCPU\u3067\u52d5\u3044\u3066\u3044\u308b\u304b\u3092\u78ba\u8a8d\u3059\u308b\u305f\u3081\u3001htop\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n[root@master1 ~]# yum -y install epel-release\n[root@master1 ~]# yum -y install htop\n\n\u30db\u30b9\u30c8\u306eCPU\u3092\u78ba\u8a8d\u3059\u308b\u3002CPU\u304c4\u500b\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# cat /proc/cpuinfo |grep processor\nprocessor       : 0\nprocessor       : 1\nprocessor       : 2\nprocessor       : 3\n[root@master1 ~]#\n\n\nCPU=0\u3067\u30b3\u30f3\u30c6\u30ca\u3092\u52d5\u304b\u3059\u3002--cpuset-cpus\u306b0\u3092\u6307\u5b9a\u3059\u308b\u3002\n[root@master1 ~]# docker run -it -d --name con0 --cpuset-cpus=0 busybox dd if=/dev/zero of=/dev/null\n06ef3f9b7cd70b3b2e0df2917aaef8702491e34f9019ee0361266e86081d0a42\n\n\u30b3\u30f3\u30c6\u30ca\u304c\u3069\u306eCPU\u3067\u52d5\u3044\u3066\u3044\u308b\u304b\u306e\u78ba\u8a8d\u65b9\u6cd5\u306e\u8aac\u660e\u3002\nhtop\u306e\u753b\u50cf\u3092\u5f35\u308a\u4ed8\u3051\u3066\u8aac\u660e\u3057\u305f\u3044\u3051\u3069\u3001\u8cbc\u308a\u4ed8\u3051\u3064\u3051\u65b9\u304c\u308f\u304b\u3089\u306a\u3044\u306e\u3067\u3001\u8a00\u8449\u3067\u8aac\u660e\u3059\u308b\u3002\n\n1. htop\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# htop\n\n2. F2\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b\u3002\u753b\u9762\u304c\u5207\u308a\u66ff\u308f\u308b\u3002\n3. \u2191\u2193\u30ad\u30fc\u3092\u64cd\u4f5c\u3057\u3066\u3001\"Setup\"\u5217\u306e\"Columns\"\u306b\u30ab\u30fc\u30bd\u30eb\u3092\u5408\u308f\u305b\u3001Enter\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b\u3002\n4. <-->\u30ad\u30fc\u3092\u9078\u629e\u3057\u3066\u3001\u53f3\u7aef\u306e\"Available Columens\"\u5217\u306b\u30ab\u30fc\u30bd\u30eb\u3092\u79fb\u52d5\u3059\u308b\u3002\n5. \"Available Columens\"\u5217\u306e\"PROCESSOR\"\u3068\u3044\u3046\u9805\u76ee\u306b\u30ab\u30fc\u30bd\u30eb\u3092\u79fb\u52d5\u3057\u3066Enter\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b\u3002\n6. F5\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b\u3002\"PROCESSOR\"\u9805\u76ee\u3092\u8868\u793a\u9805\u76ee\u306b\u8ffd\u52a0\u3059\u308b\u3002\n7. F10\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u3066\u3001\u8a2d\u5b9a\u3092\u4fdd\u5b58\u3059\u308b\u3002\n8. \u753b\u9762\u304c\u5207\u308a\u66ff\u308f\u308b\u3002\u30d7\u30ed\u30bb\u30b9\u4e00\u89a7\u304c\u8868\u793a\u3055\u308c\u308b\u3002\"CPU\"\u5217\u304c\u8ffd\u52a0\u3055\u308c\u3066\u3044\u308b\u3002\n9. dd\u30d7\u30ed\u30bb\u30b9\u3092\u691c\u7d22\u3059\u308b\u305f\u3081F3\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b\u3002\u7d9a\u3051\u3066\u3001\"dd\"\u3068\u5165\u529b\u3059\u308b\u3002\n10. dd\u30d7\u30ed\u30bb\u30b9\u304c\u753b\u9762\u306e\u4e00\u756a\u4e0a\u306b\u8868\u793a\u3055\u308c\u308b\u3002\n11. dd\u30b3\u30de\u30f3\u30c9\u304c\u52d5\u4f5c\u3057\u3066\u3044\u308bCPU\u756a\u53f7\u3092\u78ba\u8a8d\u3059\u308b\u3002CPU=0\u3067\u52d5\u3044\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n\nCPU\u756a\u53f7\u306e\u6570\u3048\u65b9\u304c\u3001\u30db\u30b9\u30c8\u3068htop\u3067\u306f\u7570\u306a\u308b\u306e\u3067(\u30db\u30b9\u30c8\u306f0,1,..htop\u306f1,2..)\u3001\n\u30db\u30b9\u30c8\u306b\u5408\u308f\u305b\u308b\u5834\u5408\u306f\"Display options\" -> \"Count CPUs from 0 instead of 1\"\u3092\u9078\u629e\u3059\u308b\u3002\nhtop\u3067\u3082CPU\u756a\u53f7\u304c0,1,2...\u3068\u8868\u793a\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u308b\u3002\n\n\n\u4ed6\u306b\u3082\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306bCPU\u756a\u53f7\u3092\u5909\u5316\u3055\u305b\u3066\u3001htop\u3067\u78ba\u8a8d\u3059\u308b\u3002\u6307\u5b9a\u3057\u305fCPU\u3067\u30b3\u30f3\u30c6\u30ca\u304c\u52d5\u3044\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n[root@master1 ~]# docker run -it -d --name con1 --cpuset-cpus=1 busybox dd if=/dev/zero of=/dev/null\n[root@master1 ~]# docker run -it -d --name con2 --cpuset-cpus=2 busybox dd if=/dev/zero of=/dev/null\n[root@master1 ~]# docker run -it -d --name con3 --cpuset-cpus=3 busybox dd if=/dev/zero of=/dev/null\n\n\n----------------------------------------------------\n2. openssl\u30b3\u30de\u30f3\u30c9\u3067CPU\u8ca0\u8377\u3092\u304b\u3051\u308b\n----------------------------------------------------\n[root@master1 ~]# vi Dockerfile\n[root@master1 ~]# cat Dockerfile\nFROM centos:centos7\nENV container docker\nRUN yum -y install openssl && yum clean all\n[root@master1 ~]#\n\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 ~]# docker build -t test --no-cache=true .\nSending build context to Docker daemon 84.29 MB\nStep 1 : FROM centos:centos7\n ---> 0584b3d2cf6d\nStep 2 : ENV container docker\n ---> Running in f75f52ceffb5\n ---> 49803a7122bf\nRemoving intermediate container f75f52ceffb5\nStep 3 : RUN yum -y install openssl && yum clean all\n ---> Running in 3cae1e4c3680\n\u4ee5\u4e0b\u3001\u7565\n\n\n[root@master1 ~]# docker run -it -d --name cpuload --cpuset-cpus=0-1 test /usr/bin/openssl speed -multi 2\n7cc24954486249466f4c8f31586ae73a34be7eb0eee5c9155d88df0f4aa61115\n[root@master1 ~]# docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES\n7cc249544862        test                \"/usr/bin/openssl spe\"   4 seconds ago       Up 2 seconds                            cpuload\n[root@master1 ~]#\n\n\nhtop\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# htop\n\nCPU=0,1\u3067openssl\u30b3\u30de\u30f3\u30c9\u306e\u4f7f\u7528\u7387\u304c100%\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n\n\n\u4eca\u5ea6\u306f\u3001CPU0\u3068CPU3\u3067openssl\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3002\n[root@master1 ~]# docker run -it -d --name cpuload --cpuset-cpus=0,3 test /usr/bin/openssl speed -multi 2\n041d17acb164c629ac9d1d8052439961c8881b7d124e57268214abeffb3e066c\n[root@master1 ~]# docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES\n041d17acb164        test                \"/usr/bin/openssl spe\"   6 seconds ago       Up 3 seconds                            cpuload\n[root@master1 ~]#\n\nhtop\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# htop\n\nCPU0\u3068CPU3\u3067openssl\u30b3\u30de\u30f3\u30c9\u306e\u4f7f\u7528\u7387\u304c100%\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n\n```\n\n\n##3.9 \u30b3\u30f3\u30c6\u30ca\u304c\u52d5\u4f5c\u3059\u308bCPU\u306e\u78ba\u8a8d\u65b9\u6cd5\n\n```\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -it --rm --name test-con1 centos:centos7 bash\n[root@0b9b40152ac4 /]#\n\n\u30b3\u30f3\u30c6\u30caID\u3092\u53d6\u5f97\u3059\u308b\u3002\n[root@master1 ~]# CID=$(docker ps -a --no-trunc=true |grep test-con1 | awk '{print $1}')\n\n\u30b3\u30f3\u30c6\u30caID\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# echo $CID\n0b9b40152ac4377080bb77ba8fca267d1c4cf11cb2d6314f3ad8ac064efe5b35\n\n\u30b3\u30f3\u30c6\u30ca\u304c\u52d5\u4f5c\u3059\u308bCPU\u3092\u78ba\u8a8d\u3059\u308b\u3002CPU=0,1,2,3\u3067\u52d5\u304f\u8a2d\u5b9a\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# cat /sys/fs/cgroup/cpuset/system.slice/docker-${CID}.scope/cpuset.cpus\n0-3\n\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u306fCPU=0\u3067\u52d5\u304f\u8a2d\u5b9a\u3002\n[root@master1 ~]# docker run -it --rm --cpuset-cpus=0 --name test-con1 centos:centos7 bash\n[root@923a81f60736 /]#\n\n\u30b3\u30f3\u30c6\u30caID\u3092\u53d6\u5f97\u3059\u308b\u3002\n[root@master1 ~]# CID=$(docker ps -a --no-trunc=true |grep \"test-con1\" | awk '{print $1}')\n\n\u30b3\u30f3\u30c6\u30caID\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# echo $CID\n923a81f60736846eaf10627fe8408173180e08163f285252f1cb5b6a52730608\n\n\u30b3\u30f3\u30c6\u30ca\u304c\u52d5\u4f5c\u3059\u308bCPU\u3092\u78ba\u8a8d\u3059\u308b\u3002CPU=0\u3067\u52d5\u304f\u8a2d\u5b9a\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# cat /sys/fs/cgroup/cpuset/system.slice/docker-${CID}.scope/cpuset.cpus\n0\n\n```\n\n\n\n##3.10 \u30b3\u30f3\u30c6\u30ca\u304c\u4f7f\u3046CPU\u5272\u308a\u5f53\u3066\u6642\u9593\u6307\u5b9a\u3059\u308b(--cpu--shares\u30aa\u30d7\u30b7\u30e7\u30f3)\n\n```\n\u30b3\u30f3\u30c6\u30ca\u30923\u3064\u8d77\u52d5\u3059\u308b\u3002CPU\u5272\u308a\u5f53\u3066\u6642\u9593\u30921024:1024:1024\u306e\u5272\u5408\u3067\u5272\u308a\u5f53\u3066\u308b\u3002\n[root@master1 ~]# docker run -it -d --name con0 --cpuset-cpus=0 --cpu-shares=1024  busybox dd if=/dev/zero of=/dev/null\nb0d0b5c19b2504066b5b78c908fc5e7bb2cba44efacb3c334dd093986f354956\n[root@master1 ~]# docker run -it -d --name con1 --cpuset-cpus=0 --cpu-shares=1024  busybox dd if=/dev/zero of=/dev/null\nd61db7e92a491934a80168580b2a6f3fa2941ce3984b822e8b65916a1e7f602a\n[root@master1 ~]# docker run -it -d --name con3 --cpuset-cpus=0 --cpu-shares=1024  busybox dd if=/dev/zero of=/dev/null\n64d2d6c2dde6bd2ea4b3b1e98fa4a205290d3fcb024f4d0254b85a5f343c7c3b\n[root@master1 ~]#\n\nhtop\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# htop\n\n\nCPU=0\u3067dd\u30d7\u30ed\u30bb\u30b9\u304c3\u3064\u52d5\u3044\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n\u305d\u306e\u6642\u306e\u5404\u30d7\u30ed\u30bb\u30b9\u306eCPU\u4f7f\u7528\u7387\u304c33%\u524d\u5f8c\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\n-------------------------------------------------------------------------\n\u4eca\u5ea6\u306f--cpu-shares=128\u3092\u6307\u5b9a\u3059\u308b\u3002\n[root@master1 ~]# docker run -it -d --name con0 --cpuset-cpus=0 --cpu-shares=128  busybox dd if=/dev/zero of=/dev/null\n96e2a54cdd306b39e04cdbd16e5b9a013e8109197c6f9966aedba6dd6620286f\n[root@master1 ~]# docker run -it -d --name con1 --cpuset-cpus=0 --cpu-shares=128  busybox dd if=/dev/zero of=/dev/null\ned1fbce1deb59563ca327a740bb7ef02bb665d6dc7c432539bdfc2c2feef8c48\n[root@master1 ~]# docker run -it -d --name con2 --cpuset-cpus=0 --cpu-shares=128  busybox dd if=/dev/zero of=/dev/null\n591136e723f0ff2371ae127721924423fc2337b7d856240d1578ab715d7b5752\n[root@master1 ~]#\n\nhtop\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# htop\n\nCPU=0\u3067dd\u30d7\u30ed\u30bb\u30b9\u304c3\u3064\u52d5\u3044\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n--cpu-shares=128\u3068\u6307\u5b9a\u3057\u305f\u5834\u5408\u3067\u3082\u3001\u5404\u30d7\u30ed\u30bb\u30b9\u306eCPU\u4f7f\u7528\u7387\u304c33%\u524d\u5f8c\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\n\n\n-------------------------------------------------------------------------\n\u4eca\u5ea6\u306f\u3001--cpu-shares\u3092128:128:256\u306b\u6307\u5b9a\u3059\u308b\u3002\n[root@master1 ~]# docker run -it -d --name con1 --cpuset-cpus=0 --cpu-shares=128  busybox dd if=/dev/zero of=/dev/null\nf1e0c7a0ebfb51502eab81f9d4138f290d8edfffce466c15dc02395e935a5a61\n[root@master1 ~]# docker run -it -d --name con2 --cpuset-cpus=0 --cpu-shares=128  busybox dd if=/dev/zero of=/dev/null\nf0515a66cb18af7f88affa944567b557fc5ebaf5b8a23e7909de1b44e485f33d\n[root@master1 ~]# docker run -it -d --name con3 --cpuset-cpus=0 --cpu-shares=256  busybox dd if=/dev/zero of=/dev/null\nbf35847b04244840d2fdc69107bc37366b612269a6cb090a481dc12c1662aa19\n\nhtop\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# htop\n\nCPU=0\u3067dd\u30d7\u30ed\u30bb\u30b9\u304c3\u3064\u52d5\u3044\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\nCPU\u4f7f\u7528\u7387\u3092\u78ba\u8a8d\u3059\u308b\u3068\u3001con1:con2:con3\u304c1:1:2\u306e\u5272\u5408\u306b\u306a\u3063\u305f\u3002\n\n```\n\n\n##3.11 \u30b3\u30f3\u30c6\u30ca\u304c\u51fa\u529b\u3059\u308b\u30ed\u30b0\u3092syslog\u3084journald\u306b\u51fa\u529b\u3059\u308b(--log-driver\u30aa\u30d7\u30b7\u30e7\u30f3)\n\n```\n\n-----------------------------------------------------------\n1. \u30b3\u30f3\u30c6\u30ca\u5358\u4f4d\u3067\u6709\u52b9\u306b\u3059\u308b\u65b9\u6cd5\n-----------------------------------------------------------\n[root@master1 ~]# docker pull centos:centos7\n[root@master1 ~]# docker run --log-driver=syslog centos:centos7 echo 'bbbbbbbbbb'\n\n[root@master1 ~]# grep bbbbbbbbbb /var/log/messages\n-\u4e2d\u7565-\nNov 20 22:23:47 master1 docker-current/978df20ce856[1037]: bbbbbbbbbb\n\n\n\u6bce\u56de\u8d77\u52d5\u6642\u306b\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u6307\u5b9a\u3059\u308b\u306e\u306f\u9762\u5012\u306a\u306e\u3067\u3001\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306bsyslog\u3078\u306e\u30ed\u30b0\u51fa\u529b\u3092\u6307\u5b9a\u3059\u308b\u3002\n[root@master1 ~]# vi /etc/sysconfig/docker\n-\u4e2d\u7565-\nDOCKER_OPTS=\"--log-driver syslog\"\n\n[root@master1 ~]# systemctl restart docker\n[root@master1 ~]# docker run centos:centos7 echo 'cccccccccc'\ncccccccccc\n\n[root@master1 ~]# grep cccccccccc /var/log/messages\nNov 20 22:27:47 master1 journal: cccccccccc\n\n\n-----------------------------------------------------------\n2. \u5168\u3066\u306e\u30b3\u30f3\u30c6\u30ca\u3067\u6709\u52b9\u306b\u3059\u308b\n-----------------------------------------------------------\n[root@master1 ~]# vi /etc/sysconfig/docker\nDOCKER_OPTS=\"--log driver syslog\"\n\n[root@master1 ~]# systemctl restart docker\n\n```\n\n##3.12 \u30b3\u30f3\u30c6\u30ca\u304c\u4f7f\u3046\u30e1\u30e2\u30ea\u91cf\u306b\u5236\u9650\u3092\u304b\u3051\u308b(-m\u30aa\u30d7\u30b7\u30e7\u30f3)\n\n```\n\u30b3\u30f3\u30c6\u30ca\u304c\u4f7f\u3046\u30e1\u30e2\u30ea\u91cf\u3092256M\u306b\u5236\u9650\u3059\u308b\u3002\n[root@master1 ~]# docker run -it -m 256m --name memload centos:centos7 bash\n[root@f020e33fb040 /]#\n\n\u4e0b\u8a18\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3002\n[root@af2e80e36842 /]# /dev/null < $(yes)\n\nhtop\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# htop\n\n\u30e1\u30e2\u30ea\u304c256M\u8fd1\u304f\u307e\u3067\u6d88\u8cbb\u3059\u308b\u306e\u3092\u7e70\u308a\u8fd4\u3057\u305f\u3042\u3068\u3001bash\u304ckill\u3055\u308c\u308b\u3002\n[root@f020e33fb040 /]# /dev/null < $(yes)\nKilled\n\n```\n\n\n##3.13 \u30b3\u30f3\u30c6\u30ca\u304c\u4f7f\u3046fd(\u30d5\u30a1\u30a4\u30eb\u30c7\u30a3\u30b9\u30af\u30ea\u30d7\u30bf)\u6570\u306b\u5236\u9650\u3092\u304b\u3051\u308b(--ulimit\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u4f7f\u3046)\n\n\n```\n\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u6307\u5b9a\u305b\u305a\u3001\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 test2]# docker run -it --rm centos:centos7 bash\n\n\u30c7\u30d5\u30a9\u30eb\u30c8\u306efd\u6570\u306f1048576\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@290563aa925e /]# ulimit -n\n1048576\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002fd\u6570\u304c512\u306b\u5236\u9650\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 test2]# docker run -it --rm --ulimit=\"nofile=512\" centos:centos7 bash\n[root@master1 test2]# docker run -it --rm --ulimit=\"nofile=512\" centos:centos7 bash\n[root@2621ef057b15 /]# ulimit -n\n512\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002fd\u6570\u304c1024\u306b\u5236\u9650\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 test2]# docker run -it --rm --ulimit=\"nofile=1024\" centos:centos7 bash\n[root@38c6f57b1af8 /]# ulimit -n\n1024\n\n```\n\n\n\n##3.14 \u30b3\u30f3\u30c6\u30ca\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u524a\u9664\u3059\u308b\u30b9\u30af\u30ea\u30d7\u30c8\n\n```\n\u3053\u308c\u304b\u3089\u4f5c\u6210\u3059\u308brmcon\u304c\u5b58\u5728\u3057\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# which rmcon\n/usr/bin/which: no rmcon in (/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin)\n\n[root@master1 ~]# touch /usr/local/bin/rmcon\n[root@master1 ~]# chmod 744 /usr/local/bin/rmcon\n[root@master1 ~]# vi /usr/local/bin/rmcon\n[root@master1 ~]# cat /usr/local/bin/rmcon\n#!/usr/bin/bash\ndocker rm $(docker ps -qa)\n\n\n[root@master1 ~]# docker ps -a\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                      PORTS               NAMES\n54851f2549eb        nginx               \"nginx -g 'daemon off\"   14 seconds ago      Exited (0) 10 seconds ago                       test\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u524a\u9664\u3059\u308b\u3002\n[root@master1 ~]# rmcon\n54851f2549eb\n[root@master1 ~]#\n\n```\n\n\n##3.15 docker\u30d6\u30ea\u30c3\u30b8\u3092\u6d41\u308c\u308b\u30d1\u30b1\u30c3\u30c8\u3092\u898b\u308b\u3002\n\n\n```\n\u30b3\u30f3\u30c6\u30ca\u8d77\u52d5\u524d\u306eDNAT\u5b9a\u7fa9\u3092\u78ba\u8a8d\u3059\u308b\u3002\u30dd\u30fc\u30c8\u756a\u53f711111,22222\u5b9b\u306f\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u306a\u3044\u3002\n[root@master1 ~]# iptables -L -t nat -n |grep -e 11111 -e 22222\n[root@master1 ~]#\n\n\n80\u756a\u30dd\u30fc\u30c8\u3067\u5f85\u3064\u30b3\u30f3\u30c6\u30ca\u30922\u3064\u8d77\u52d5\u3059\u308b\u3002\u305d\u308c\u305e\u308c\u306e\u30db\u30b9\u30c8\u5074\u30dd\u30fc\u30c8\u756a\u53f7\u306f11111,22222\n[root@master1 ~]# docker run -d --name nginx1 -p 11111:80 nginx\n[root@master1 ~]# docker run -d --name nginx2 -p 22222:80 nginx\n\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3068\u3001DNAT\u306e\u5b9a\u7fa9\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308b\u3002\n[root@master1 ~]# iptables -L -t nat -n |grep -e 11111 -e 22222\nDNAT       tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:11111 to:172.17.0.2:80\nDNAT       tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:22222 to:172.17.0.3:80\n\n\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3057\u305f\u3068\u304d\u306e\u30db\u30b9\u30c8\u5185\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308b\u3002\n\n  +--- nginx1 ---+   +--- nginx2 ---+\n  |    port=80   |   |    port=80   |\n  |              |   |              |\n  +---- eth0 ----+   +---- eth0 ----+\n      172.17.0.2        172.17.0.3\n          |  A               |   A\n          |  |               |   |\n  +-------+--|---------------+---|--+\n  |          |  docker0(Bridge)  |  | <=== tcpdump -i docker0 tcp port 80 -nn\n  +----------|-------+-----------|--+\n             |       |           |\n             |       |           |\n [after]     |       |           | [after]\n   DstIP=172.17.0.2  |           |   DstIP=172.17.0.3\n   DstPort=80        |           |   DstPort=80\n             |       |           |\n +-------------------------- DNAT -----------------------------------------------+\n |  [root@master1 ~]# iptables -L -t nat -n |grep -e 11111 -e 22222              |\n |  DNAT   tcp  --  0.0.0.0/0      0.0.0.0/0     tcp dpt:11111 to:172.17.0.2:80  |\n |  DNAT   tcp  --  0.0.0.0/0      0.0.0.0/0     tcp dpt:22222 to:172.17.0.3:80  |\n +-------------------------------------------------------------------------------+\n                     |\n            eth0(192.168.0.10/24)\n              A                A\n              |                |\n              |                |\n  [before]    |                | [before]\n     DstIP=192.168.0.10        |   DstIP=192.168.0.10\n     DstPort=11111             |   DstPort=22222\n\n\ntcpdump\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# tcpdump -i docker0 tcp port 80 -nn\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on docker0, link-type EN10MB (Ethernet), capture size 65535 bytes\n\n\n\u5225\u306e\u30bf\u30fc\u30df\u30ca\u30eb\u3067Nginx\u306bcurl\u30b3\u30de\u30f3\u30c9\u3067\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3002\n[root@master1 ~]# curl http://192.168.0.10:11111\n<!DOCTYPE html>\n<html>\n<head>\n<title>Welcome to nginx!</title>\n\n\u3053\u306e\u6642\u3001tcpdump\u3067\u63a1\u53d6\u3057\u305f\u30d1\u30b1\u30c3\u30c8\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3002TCP\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u78ba\u7acb\u6642\u306e\u307f\u629c\u7c8b\n21:12:08.660096 IP 192.168.0.10.57391 > 172.17.0.2.80: Flags [S], seq 1382156843, win 43690, options [mss 65495,sackOK,TS val 5452241 ecr 0,nop,wscale 7], length 0\n21:12:08.660252 IP 172.17.0.2.80 > 192.168.0.10.57391: Flags [S.], seq 3030911224, ack 1382156844, win 14480, options [mss 1460,sackOK,TS val 5452241 ecr 5452241,nop,wscale 7], length 0\n21:12:08.660301 IP 192.168.0.10.57391 > 172.17.0.2.80: Flags [.], ack 1, win 342, options [nop,nop,TS val 5452241 ecr 5452241], length 0\n\n\n\u6b21\u306b\u5b9b\u5148\u30dd\u30fc\u30c8\u756a\u53f7\u309222222\u306b\u5909\u66f4\u3057\u3066\u30b3\u30f3\u30c6\u30ca\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3002\n[root@master1 ~]# curl http://192.168.0.10:22222\n<!DOCTYPE html>\n<html>\n<head>\n<title>Welcome to nginx!</title>\n\n\u5b9b\u5148TCP\u30dd\u30fc\u30c8\u756a\u53f7\u304c22222\u306e\u3068\u304d\u306etcpdump\u3067\u63a1\u53d6\u3057\u305f\u30d1\u30b1\u30c3\u30c8\n21:14:13.673223 IP 192.168.0.10.42175 > 172.17.0.3.80: Flags [S], seq 2685052290, win 43690, options [mss 65495,sackOK,TS val 5577254 ecr 0,nop,wscale 7], length 0\n21:14:13.673333 IP 172.17.0.3.80 > 192.168.0.10.42175: Flags [S.], seq 1261474781, ack 2685052291, win 14480, options [mss 1460,sackOK,TS val 5577254 ecr 5577254,nop,wscale 7], length 0\n21:14:13.673375 IP 192.168.0.10.42175 > 172.17.0.3.80: Flags [.], ack 1, win 342, options [nop,nop,TS val 5577255 ecr 5577254], length 0\n\n\n```\n\n\n##3.16 Docker\u30af\u30e9\u30a4\u30a2\u30f3\u30c8 <=> Docker\u30b5\u30fc\u30d0\u9593\u306eUNIX domain\u30bd\u30b1\u30c3\u30c8\u3092\u6d41\u308c\u308b\u30d1\u30b1\u30c3\u30c8\u3092\u898b\u308b\u3002\n\n\n```\nDocker\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3068\u30b5\u30fc\u30d0\u306e\u9593\u306bproxy\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 ~]# socat -v UNIX-LISTEN:/tmp/dockerapi.sock UNIX-CONNECT:/var/run/docker.sock&\n[1] 9449\n\n\nDocker\u30b5\u30fc\u30d0\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b.HTTP\u30ea\u30af\u30a8\u30b9\u30c8\u3068\u30ec\u30b9\u30dd\u30f3\u30b9\u304c\u89b3\u6e2c\u3067\u304d\u308b\u3002\n[root@master1 ~]# docker -H unix:///tmp/dockerapi.sock ps -a\n> 2016/11/21 21:37:09.017349  length=95 from=0 to=94           ======> HTTP\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u958b\u59cb\nGET /v1.22/containers/json?all=1 HTTP/1.1\\r\nHost: \\r\nUser-Agent: Docker-Client/1.10.3 (linux)\\r\n\\r\n< 2016/11/21 21:37:09.019849  length=141 from=0 to=140          ========> HTTP\u30ec\u30b9\u30dd\u30f3\u30b9\u306e\u958b\u59cb\nHTTP/1.1 200 OK\\r\nContent-Type: application/json\\r\nServer: Docker/1.10.3 (linux)\\r\nDate: Mon, 21 Nov 2016 12:37:09 GMT\\r\nContent-Length: 3\\r\n\\r\n[]\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\n[root@master1 ~]#\n\n\n\n\nsocat\u306e\u4f7f\u3044\u65b9\n[root@master1 ~]# socat tcp-listen:11111 stdout\n\n\u5225\u306e\u30bf\u30fc\u30df\u30ca\u30eb\u3067\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5b9f\u884c\u3059\u308b\u3002\n[root@master1 ~]# socat tcp-connect:localhost:11111 stdin\ntest\n\n\u3082\u3046\u4e00\u65b9\u306e\u30bf\u30fc\u30df\u30ca\u30eb\n[root@master1 ~]# socat tcp-listen:11111 stdout\ntest\n\n```\n\n\n##3.17 \u30b3\u30f3\u30c6\u30ca\u306eMAC\u30a2\u30c9\u30ec\u30b9\u3068IP\u30a2\u30c9\u30ec\u30b9\u3092\u78ba\u8a8d\u3059\u308b\u65b9\u6cd5(docker network inspect bridge)\n\n\n```\n\u30b3\u30f3\u30c6\u30ca\u30923\u3064\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -d --name nginx1 nginx\n4b93774b8e7ac70ba0f70f5ead741e3a82a10a19cf4a940ca9cb6c4ca16b6329\n[root@master1 ~]# docker run -d --name nginx2 nginx\n2f12861523f1f019d89a4dec32233c09eccad44e0a792b12a9a5e19eb857014d\n[root@master1 ~]# docker run -d --name nginx3 nginx\nf8d753a23cbcd71810d8c04d411b3a71d9908211bbeb3244cc510e21e2170e2e\n[root@master1 ~]#\n\n\ndocker network inspect bridge\u3092\u5b9f\u884c\u3059\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u304c\u3069\u3093\u306aIP/MAC\u30a2\u30c9\u30ec\u30b9\u3092\u3082\u3063\u3066\u3044\u308b\u306e\u304b\u308f\u304b\u308b\u3002\n[root@master1 ~]# docker network inspect bridge\n[\n-\u4e2d\u7565-\n        \"Containers\": {\n            \"2f12861523f1f019d89a4dec32233c09eccad44e0a792b12a9a5e19eb857014d\": {\n                \"Name\": \"nginx2\",\n                \"EndpointID\": \"53001e97e15fd900134f01884b208277796ead9795ab78c6d03631829429b6ed\",\n                \"MacAddress\": \"02:42:ac:11:00:03\",\n                \"IPv4Address\": \"172.17.0.3/16\",\n                \"IPv6Address\": \"\"\n            },\n            \"4b93774b8e7ac70ba0f70f5ead741e3a82a10a19cf4a940ca9cb6c4ca16b6329\": {\n                \"Name\": \"nginx1\",\n                \"EndpointID\": \"4f3b361b89607f78f15f3cacbbcc76e261bc75c7093ad32f32bc2e6c15135ea9\",\n                \"MacAddress\": \"02:42:ac:11:00:02\",\n                \"IPv4Address\": \"172.17.0.2/16\",\n                \"IPv6Address\": \"\"\n            },\n            \"f8d753a23cbcd71810d8c04d411b3a71d9908211bbeb3244cc510e21e2170e2e\": {\n                \"Name\": \"nginx3\",\n                \"EndpointID\": \"bd49d3847cf5372376bcf12a93414dc7eb432ad23352639c5515ea25acbc33b9\",\n                \"MacAddress\": \"02:42:ac:11:00:04\",\n                \"IPv4Address\": \"172.17.0.4/16\",\n                \"IPv6Address\": \"\"\n            }\n\u4ee5\u4e0b\u3001\u7565\n\n```\n\n\n##3.18 \u30b3\u30f3\u30c6\u30ca\u304c\u4f7f\u7528\u3059\u308b\u30c7\u30a3\u30b9\u30af\u30b5\u30a4\u30ba(dm.basesize)\u3092\u5909\u66f4\u3059\u308b\n\n\n```\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master3 ~]# docker run -it --name centos centos:centos7 bash\n\n\u30eb\u30fc\u30c8\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306e\u30b5\u30a4\u30ba\u3092\u78ba\u8a8d\u3059\u308b\u300210G(\u2605\u5370)\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@144e5f96041b /]# df -h\nFilesystem                                                                                         Size  Used Avail Use% Mounted on\n/dev/mapper/docker-8:3-202336481-871f24af84360d9307d0015d201d28088fdbe73c6684110afb2c4fdffa13d81a \u260510G  240M  9.8G   3% /\ntmpfs                                                                                              490M     0  490M   0% /dev\ntmpfs                                                                                              490M     0  490M   0% /sys/fs/cgroup\n/dev/sda3                                                                                           40G  1.7G   38G   5% /etc/hosts\nshm                                                                                                 64M     0   64M   0% /dev/shm\n[root@144e5f96041b /]# exit\nexit\n\ndocker info\u30b3\u30de\u30f3\u30c9\u3067\u3082\u78ba\u8a8d\u3057\u3066\u307f\u308b\u300210.74 GB\u3067\u3042\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n[root@master3 ~]# docker info |grep \"Base Device Size:\"\n Base Device Size: 10.74 GB\n\n\n\u30c7\u30a3\u30b9\u30af\u30b5\u30a4\u30ba\u309210G->20G\u306b\u5909\u66f4\u3059\u308b\u3002\n[root@master3 ~]# vi /etc/sysconfig/docker-storage\nDOCKER_STORAGE_OPTIONS=--storage-opt dm.basesize=20G\n\nDocker\u3092\u505c\u6b62\u3059\u308b\u3002\u505c\u6b62\u3057\u306a\u3044\u3068\u3001/var/lib/docker\u914d\u4e0b\u304c\u524a\u9664\u3067\u304d\u306a\u3044\u3002\n[root@master3 ~]# systemctl stop docker\n\n/var/lib/docker\u914d\u4e0b\u3092\u524a\u9664\u3059\u308b\u3002\u4eca\u307e\u3067\u4f5c\u6210\u3057\u305f\u30a4\u30e1\u30fc\u30b8\u304c\u5168\u3066\u6d88\u53bb\u3055\u308c\u308b\u306e\u3067\u6ce8\u610f!!!\n[root@master3 ~]# rm -f -r /var/lib/docker/\n\nDocker\u3092\u518d\u8d77\u52d5\u3059\u308b\u3002\n[root@master3 ~]# systemctl start docker\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002/var/lib/docker\u914d\u4e0b\u3092\u524a\u9664\u3057\u305f\u306e\u3067\u3001\u518d\u5ea6\u3001\u30a4\u30e1\u30fc\u30b8\u306e\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u304c\u59cb\u307e\u308b\u3002\n[root@master3 ~]# docker run -it --name centos centos:centos7 bash\nUnable to find image 'centos:centos7' locally\nTrying to pull repository docker.io/library/centos ...\ncentos7: Pulling from docker.io/library/centos\n08d48e6f1cff: Pull complete\nDigest: sha256:b2f9d1c0ff5f87a4743104d099a3d561002ac500db1b9bfa02a783a46e0d366c\nStatus: Downloaded newer image for docker.io/centos:centos7\n\n\n\u30c7\u30a3\u30b9\u30af\u30b5\u30a4\u30ba\u3092\u78ba\u8a8d\u3059\u308b\u300220G(\u2605\u5370)\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n[root@13f57f8cd4fb /]# df -h\nFilesystem                                                                                         Size  Used Avail Use% Mounted on\n/dev/mapper/docker-8:3-135722635-214924edf11302e77f89a1d577930cd48168d4d4987cd175cb67f6d937d21aa9 \u260520G  240M   20G   2% /\ntmpfs                                                                                              490M     0  490M   0% /dev\ntmpfs                                                                                              490M     0  490M   0% /sys/fs/cgroup\n/dev/sda3                                                                                           40G  1.7G   38G   5% /etc/hosts\nshm                                                                                                 64M     0   64M   0% /dev/shm\n[root@13f57f8cd4fb /]# exit\nexit\n\ndocker info\u30b3\u30de\u30f3\u30c9\u3067\u3082\u78ba\u8a8d\u3057\u3066\u307f\u308b\u300221.47 GB\u3067\u3042\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n[root@master3 ~]# docker info |grep \"Base Device Size:\"\n Base Device Size: 21.47 GB\n\n-------------------------------------------------------------------------------------------\n0.  truncate\u30b3\u30de\u30f3\u30c9\u306e\u4f7f\u3044\u65b9\u3002\u77e5\u3089\u306a\u304b\u3063\u305f\u306e\u3067\u30e1\u30e2\n-------------------------------------------------------------------------------------------\n1K\u30b5\u30a4\u30ba\u306e\u30d5\u30a1\u30a4\u30eb\u4f5c\u6210\n[root@master1 ~]# truncate --size 1K /root/file_1K\n[root@master1 ~]# ls -la file_1K\n-rw-r--r--. 1 root root 1024 11\u6708 23 09:02 file_1K\n\n1M\u30b5\u30a4\u30ba\u306e\u30d5\u30a1\u30a4\u30eb\u4f5c\u6210\n[root@master1 ~]# truncate --size 1M /root/file_1M\n[root@master1 ~]# ls -la file_1M\n-rw-r--r--. 1 root root 1048576 11\u6708 23 09:02 file_1M\n\n1G\u30b5\u30a4\u30ba\u306e\u30d5\u30a1\u30a4\u30eb\u4f5c\u6210\n[root@master1 ~]# truncate --size 1G /root/file_1G\n[root@master1 ~]# ls -la file_1G\n-rw-r--r--. 1 root root 1073741824 11\u6708 23 09:02 file_1G\n\n\n\u3061\u306a\u307f\u306b\u3001\u3069\u306e\u30d5\u30a1\u30a4\u30eb\u3082\u5b9f\u969b\u306b\u30c7\u30a3\u30b9\u30af\u9818\u57df\u306f\u6d88\u8cbb\u3057\u3066\u3044\u306a\u3044\u3002\n[root@master1 ~]# du file_1K\n0       file_1K\n[root@master1 ~]# du file_1M\n0       file_1M\n[root@master1 ~]# du file_1G\n0       file_1G\n\n\n\n-------------------------------------------------------------------------------------------\n1. \u30eb\u30fc\u30c8\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306e\u30b5\u30a4\u30ba(10G)\u3088\u308a\u5c0f\u3055\u306a\u30b5\u30a4\u30ba(500M)\u306e\u30d5\u30a1\u30a4\u30eb\u306f\u4f5c\u6210\u3067\u304d\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u3002\n-------------------------------------------------------------------------------------------\n[root@master3 ~]# vi Dockerfile\n[root@master3 ~]# docker build -t small .\nSending build context to Docker daemon 24.06 kB\nStep 1 : FROM centos:centos7\n ---> 0584b3d2cf6d\nStep 2 : RUN truncate --size 500M /root/file\n ---> Running in 72309990b267\n ---> d9e74f07cb1a\nRemoving intermediate container 72309990b267\nSuccessfully built d9e74f07cb1a\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master3 ~]# docker run -it --rm samll bash\n\n\u30eb\u30fc\u30c8\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306e\u30b5\u30a4\u30ba\u3092\u78ba\u8a8d\u3059\u308b\u3002\u30b5\u30a4\u30ba\u306f10G(\u2605\u5370)\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@4a6240b311cb /]# df -h\nFilesystem                                                                                         Size  Used Avail Use% Mounted on\n/dev/mapper/docker-8:3-135722635-c8ee47480aa38ff8849f715f2d93d4ece493b25a3adde1bb72b783841bfae129 \u260510G  740M  9.3G   8% /\ntmpfs                                                                                              490M     0  490M   0% /dev\ntmpfs                                                                                              490M     0  490M   0% /sys/fs/cgroup\n/dev/sda3                                                                                           40G  3.2G   37G   9% /etc/hosts\nshm                                                                                                 64M     0   64M   0% /dev/shm\n[root@4a6240b311cb /]# exit\nexit\n\n\u30d5\u30a1\u30a4\u30eb\u30b5\u30a4\u30ba\u3092\u78ba\u8a8d\u3059\u308b\u3002500M\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u305f\u3002\n[root@2d0e98bd08bd /]# ls -la /root/file\n-rw-r--r--. 1 root root 524288000 Nov 22 13:14 /root/file\n\n\n\n-------------------------------------------------------------------------------------------\n2. \u30eb\u30fc\u30c8\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306e\u30b5\u30a4\u30ba(10G)\u3088\u308a\u5927\u304d\u306a\u30d5\u30a1\u30a4\u30eb(11G)\u3092\u4f5c\u6210\u3057\u3066\u3001\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3059\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u3002\n-------------------------------------------------------------------------------------------\n\u4eca\u5ea6\u306f11G\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308bDockerfile\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master3 ~]# vi Dockerfile\n[root@master3 ~]# cat Dockerfile\nFROM centos:centos7\nRUN truncate --size 11G /root/file\n\n\u30eb\u30fc\u30c8\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306e\u30b5\u30a4\u30ba(10G)\u3088\u308a\u5927\u304d\u306a\u30d5\u30a1\u30a4\u30eb(11G)\u3092\u4f5c\u6210\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u306a\u3044\u3002\n[root@master3 ~]# docker build --no-cache -t big .\nSending build context to Docker daemon 24.06 kB\nStep 1 : FROM centos:centos7\n ---> 0584b3d2cf6d\nStep 2 : RUN truncate --size 11G /root/file\n ---> Running in 40ebcbd0670c\nApplyLayer exit status 1 stdout:  stderr: write /root/file: no space left on device\n[root@master3 ~]#\n\n\n-------------------------------------------------------------------------------------------\n3. \u5b9f\u969b\u306b\u3069\u3053\u304c\u6d88\u8cbb\u3055\u308c\u308b\u304b\u78ba\u8a8d\u3057\u3066\u307f\u308b\u3002\n-------------------------------------------------------------------------------------------\n[root@e2f80a45bad0 /]# df -h\nFilesystem                                                                                      Size  Used Avail Use% Mounted on\n/dev/mapper/docker-8:3-713942-3c889cab414769b972f8b76f02a67365ffbbf868f10737e29bd959ff761ac7bc   10G  240M\u26059.8G   3% /\ntmpfs                                                                                           490M     0  490M   0% /dev\ntmpfs                                                                                           490M     0  490M   0% /sys/fs/cgroup\n/dev/sda3                                                                                        40G  5.0G   35G  13% /etc/hosts\nshm                                                                                              64M     0   64M   0% /dev/shm\n\n1G\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@e2f80a45bad0 /]# dd if=/dev/zero of=test.txt bs=1024k count=1024\n1024+0 records in\n1024+0 records out\n1073741824 bytes (1.1 GB) copied, 90.7417 s, 11.8 MB/s\n\n/dev/mapper\u914d\u4e0b\u304c\u4f7f\u308f\u308c\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@e2f80a45bad0 /]# df -h\nFilesystem                                                                                      Size  Used Avail Use% Mounted on\n/dev/mapper/docker-8:3-713942-3c889cab414769b972f8b76f02a67365ffbbf868f10737e29bd959ff761ac7bc   10G  1.3G\u26058.8G  13% /\ntmpfs                                                                                           490M     0  490M   0% /dev\ntmpfs                                                                                           490M     0  490M   0% /sys/fs/cgroup\n/dev/sda3                                                                                        40G  6.0G   34G  16% /etc/hosts\nshm                                                                                              64M     0   64M   0% /dev/shm\n\n\n\n```\n\n\n##3.19 \u30b3\u30f3\u30c6\u30ca\u306e\u30d7\u30ed\u30bb\u30b9\u3092strace\u3067\u30c7\u30d0\u30c3\u30b0\u3059\u308b\u65b9\u6cd5(nsenter)\nnginx\u306e\u30b3\u30f3\u30c6\u30ca\u306b\u306f\u3001strace\u30b3\u30de\u30f3\u30c9\u304c\u5165\u3063\u3066\u3044\u306a\u3044\u3002\nyum\u30b3\u30de\u30f3\u30c9\u3082\u5165\u3063\u3066\u3044\u306a\u3044\u306e\u3067\u3001\u305d\u3082\u305d\u3082\u3001strace\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u306a\u3044\u3002\n\u305f\u3068\u3048\u3070\u3001\u30b3\u30f3\u30c6\u30ca\u306eNginx\u3092\u30c7\u30d0\u30c3\u30b0\u3059\u308b\u3068\u304d\u3001\u3069\u306e\u3088\u3046\u306b\u3057\u305f\u3089\u826f\u3044\u304b\uff1f\n\u305d\u306e\u3088\u3046\u306a\u5834\u5408\u3001nsenter\u3092\u4f7f\u3046\u3053\u3068\u3067\u89e3\u6c7a\u3067\u304d\u308b\u3002\n\n```\nNginx\u30b3\u30f3\u30c6\u30ca\u3067strace,yum\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u306bstrace\u306f\u5165\u3063\u3066\u3044\u306a\u3044\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# docker run -it --rm nginx bash\nroot@a42cfaf8c6f8:/# strace\nbash: strace: command not found\nroot@a42cfaf8c6f8:/# yum\nbash: yum: command not found\nroot@a42cfaf8c6f8:/#\n\n\n\u30db\u30b9\u30c8\u306bnsenter\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n[root@master1 ~]# docker run -v /usr/local/bin:/target --privileged jpetazzo/nsenter\nUnable to find image 'jpetazzo/nsenter:latest' locally\nTrying to pull repository docker.io/jpetazzo/nsenter ...\nlatest: Pulling from docker.io/jpetazzo/nsenter\n5c90d4a2d1a8: Downloading [===============>                                   ] 15.73 MB/51.35 MB\n-\u4e2d\u7565-\n\nDigest: sha256:a30e7da907a9abb715027677c21468005beee06251b7737c86f84fa148d572b0\nStatus: Downloaded newer image for docker.io/jpetazzo/nsenter:latest\nInstalling nsenter to /target\nInstalling docker-enter to /target\nInstalling importenv to /target\n\n\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u305fnsenter\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# docker images |grep nsenter\ndocker.io/jpetazzo/nsenter                            latest                             c16fe938c1a5        4 months ago        370.8 MB\n\nnsenter\u30b3\u30de\u30f3\u30c9\u306f\u3001\u4ee5\u4e0b\u306e\u30d1\u30b9\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u308b\u3002\n[root@master1 ~]# ls /usr/local/bin/nsenter\n/usr/local/bin/nsenter\n\n\nNginx\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u30db\u30b9\u30c8\u5074\u30dd\u30fc\u30c8\u756a\u53f711111,\u30b3\u30f3\u30c6\u30ca\u5074\u30dd\u30fc\u30c8\u756a\u53f780\u3067\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# CID=$(docker run -d --name test -p 11111:80 nginx)\n[root@master1 ~]# docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                            NAMES\n900ae34b590a        nginx               \"nginx -g 'daemon off\"   13 seconds ago      Up 11 seconds       443/tcp, 0.0.0.0:11111->80/tcp   test\n[root@master1 ~]# echo $CID\n900ae34b590a567ad396f6a02015d545b82a75608f660d5275f9a96914acc667\n\n[root@master1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n[root@master1 ~]# echo $PID\n15780\n\nnsenter\u3092\u8d77\u52d5\u3057\u3066\u3001Nginx\u30b3\u30f3\u30c6\u30ca\u306b\u63a5\u7d9a\u3059\u308b\u3002\n[root@master1 ~]# nsenter --target $PID --uts --ipc --net /bin/bash\n\nstrace\u3092\u5b9f\u884c\u3059\u308b\u305f\u3081\u3001Nginx\u306ePID\u3092\u8abf\u3079\u308b\u3002\n[root@900ae34b590a ~]# ps aux|grep nginx\nroot      15780  0.4  0.2  31752  2868 ?        Ss   11:17   0:00 nginx: master process nginx -g daemon off;\n104       15796  0.0  0.1  32144  1664 ?        S    11:17   0:00 nginx: worker process\nroot      15875  0.0  0.0 112656   972 pts/0    S+   11:18   0:00 grep --color=auto nginx\n\nNginx\u306e\u30d7\u30ed\u30bb\u30b9\u306b\u5bfe\u3057\u3066\u3001strace\u3092\u5b9f\u884c\u3059\u308b\u3002epoll\u3067\u30a4\u30d9\u30f3\u30c8\u5f85\u3061\u3002\n[root@900ae34b590a ~]# strace -ttT -f -p 15796\nProcess 15796 attached\n11:18:48.761204 epoll_wait(8, {{EPOLLIN, {u32=1517506576, u64=140502782660624}}}, 512, -1) = 1 <4.638268>\n\n\n\u3053\u306e\u3068\u304d\u3001\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3088\u308acurl\u30b3\u30de\u30f3\u30c9\u3067Nginx\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3002\n[root@master1 ~]#\n[root@master1 ~]# curl http://localhost:11111\n<!DOCTYPE html>\n<html>\n<head>\n<title>Welcome to nginx!</title>\n<style>\n\nNginx\u306e\u30a4\u30d9\u30f3\u30c8\u5f85\u3061\u304c\u89e3\u9664\u3055\u308c\u308b\u3002\n[root@900ae34b590a ~]# strace -ttT -f -p 15796\n11:18:48.761204 epoll_wait(8, {{EPOLLIN, {u32=1517506576, u64=140502782660624}}}, 512, -1) = 1 <4.638268>\u3000\u2605\u30a4\u30d9\u30f3\u30c8\u5f85\u3061\u3067\u30d6\u30ed\u30c3\u30af\n\ncurl\u30b3\u30de\u30f3\u30c9\u306780\u756a\u30dd\u30fc\u30c8\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001Nginx\u306e\u30d6\u30ed\u30c3\u30af\u304c\u89e3\u9664\u3055\u308c\u3001\u4ee5\u4e0b\u306e\u30c8\u30ec\u30fc\u30b9\u304c\u8868\u793a\u3055\u308c\u305f\u3002\n11:18:53.399994 accept4(6, {sa_family=AF_INET, sin_port=htons(44234), sin_addr=inet_addr(\"172.17.0.1\")}, [16], SOCK_NONBLOCK) = 3 <0.000048>\n11:18:53.400279 epoll_ctl(8, EPOLL_CTL_ADD, 3, {EPOLLIN|EPOLLRDHUP|EPOLLET, {u32=1517507056, u64=140502782661104}}) = 0 <0.000033>\n11:18:53.400514 epoll_wait(8, {{EPOLLIN, {u32=1517507056, u64=140502782661104}}}, 512, 60000) = 1 <0.000033>\n11:18:53.400742 recvfrom(3, \"GET / HTTP/1.1\\r\\nUser-Agent: curl\"..., 1024, 0, NULL, NULL) = 79 <0.000039>\n11:18:53.401093 stat(\"/usr/share/nginx/html/index.html\", {st_mode=S_IFREG|0644, st_size=612, ...}) = 0 <0.013186>\n11:18:53.414573 open(\"/usr/share/nginx/html/index.html\", O_RDONLY|O_NONBLOCK) = 11 <0.000241>\n11:18:53.419455 fstat(11, {st_mode=S_IFREG|0644, st_size=612, ...}) = 0 <0.000029>\n11:18:53.419783 writev(3, [{\"HTTP/1.1 200 OK\\r\\nServer: nginx/1\"..., 238}], 1) = 238 <0.000212>\n11:18:53.420595 sendfile(3, 11, [0], 612) = 612 <0.000958>\n11:18:53.421907 write(5, \"172.17.0.1 - - [23/Nov/2016:02:1\"..., 91) = 91 <0.002888>\n11:18:53.424934 close(11)               = 0 <0.000082>\n11:18:53.425137 setsockopt(3, SOL_TCP, TCP_NODELAY, [1], 4) = 0 <0.000038>\n11:18:53.425293 epoll_wait(8, {{EPOLLIN|EPOLLRDHUP, {u32=1517507056, u64=140502782661104}}}, 512, 65000) = 1 <0.009390>\n11:18:53.434845 recvfrom(3, \"\", 1024, 0, NULL, NULL) = 0 <0.000039>\n11:18:53.434999 close(3)                = 0 <0.000194>\n11:18:53.435281 epoll_wait(8,   \u2605\u3053\u3053\u3067\u3001\u307e\u305f\u30a4\u30d9\u30f3\u30c8\u5f85\u3061\u3067\u30d6\u30ed\u30c3\u30af\u3059\u308b\u3002\n\n```\n\n\n##3.20 \u30b3\u30f3\u30c6\u30ca\u304c\u51fa\u529b\u3059\u308b\u30ed\u30b0\u3092\u78ba\u8a8d\u3059\u308b\u3002(docker logs)\n\n```\n-------------------------------------------------------------\n1. \u30ed\u30b0\u672b\u5c3e(-f\u30aa\u30d7\u30b7\u30e7\u30f3)\u3084\u6642\u523b\u8868\u793a(-t\u30aa\u30d7\u30b7\u30e7\u30f3)\u306e\u30ed\u30b0\u3092\u51fa\u529b\u3059\u308b.\n-------------------------------------------------------------\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -itd -p 11111:80 --name test-con nginx\nc21e8fd203992631946deb0e9eb91c6cc34eceb5cb57b56e9071a5e74867fe18\n[root@master1 ~]# docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                            NAMES\nc21e8fd20399        nginx               \"nginx -g 'daemon off\"   4 seconds ago       Up 1 seconds        443/tcp, 0.0.0.0:11111->80/tcp   test-con\n\n\n\u5225\u306e\u30bf\u30fc\u30df\u30ca\u30eb\u304b\u3089\u3001Nginx\u30b3\u30f3\u30c6\u30ca\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3002\n[root@master1 ~]# curl http://localhost:11111\n\nNginx\u304c\u51fa\u529b\u3059\u308b\u30ed\u30b0\u3092\u78ba\u8a8d\u3059\u308b\u3002-f\u306f\u30ed\u30b0\u306e\u672b\u5c3e\u3092\u8868\u793a\u3059\u308b\u3002-t\u306f\u6642\u523b\u3092\u8868\u793a\u3059\u308b\u30aa\u30d7\u30b7\u30e7\u30f3\n[root@master1 ~]# docker logs -ft test-con\n2016-11-23T07:43:51.860181000Z 172.17.0.1 - - [23/Nov/2016:07:43:51 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n2016-11-23T07:44:12.619368000Z 172.17.0.1 - - [23/Nov/2016:07:44:12 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n2016-11-23T07:44:14.394863000Z 172.17.0.1 - - [23/Nov/2016:07:44:14 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n\n-------------------------------------------------------------\n2. \u3042\u308b\u6642\u523b\u4ee5\u964d\u306e\u30ed\u30b0\u3060\u3051\u3092\u51fa\u529b\u3059\u308b\u3002(--since\u30aa\u30d7\u30b7\u30e7\u30f3)\n-------------------------------------------------------------\n\u5168\u3066\u306e\u30ed\u30b0\u3092\u8868\u793a\u3059\u308b\u3002\n[root@master1 ~]# docker logs -t test-con\n2016-11-23T07:43:51.860181000Z 172.17.0.1 - - [23/Nov/2016:07:43:51 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n2016-11-23T07:44:12.619368000Z 172.17.0.1 - - [23/Nov/2016:07:44:12 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n2016-11-23T07:44:14.394863000Z 172.17.0.1 - - [23/Nov/2016:07:44:14 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n2016-11-23T07:44:23.147067000Z 172.17.0.1 - - [23/Nov/2016:07:44:23 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n2016-11-23T07:44:29.820801000Z 172.17.0.1 - - [23/Nov/2016:07:44:29 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n2016-11-23T07:54:26.968246000Z 172.17.0.1 - - [23/Nov/2016:07:54:26 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n\u2605\n2016-11-23T07:54:28.472748000Z 172.17.0.1 - - [23/Nov/2016:07:54:28 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n2016-11-23T07:54:29.249195000Z 172.17.0.1 - - [23/Nov/2016:07:54:29 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n2016-11-23T07:57:23.897494000Z 172.17.0.1 - - [23/Nov/2016:07:57:23 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n\n\u305f\u3068\u3048\u3070\u3001\u2605\u4ee5\u964d\u306e\u30ed\u30b0\u3060\u3051\u3092\u8868\u793a\u3059\u308b\u306b\u306f\u3001--since\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u4f7f\u3046\u3002\n[root@master1 ~]# docker logs --since 2016-11-23T07:54:28.472748000Z test-con\n172.17.0.1 - - [23/Nov/2016:07:54:28 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n172.17.0.1 - - [23/Nov/2016:07:54:29 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n172.17.0.1 - - [23/Nov/2016:07:57:23 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n\n\u6b63\u78ba\u306a\u6642\u523b\u3092\u6307\u5b9a\u3057\u306a\u304f\u3066\u3082\u300107:54:28.000000000Z \u306e\u3088\u3046\u306b\u6307\u5b9a\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u308b\u3002\n[root@master1 ~]# docker logs --since 2016-11-23T07:54:28.000000000Z test-con\n172.17.0.1 - - [23/Nov/2016:07:54:28 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n172.17.0.1 - - [23/Nov/2016:07:54:29 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n172.17.0.1 - - [23/Nov/2016:07:57:23 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n[root@master1 ~]#\n\n\u4ed6\u306b\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u7701\u7565\u3057\u305f\u5834\u5408\u3067\u3082\u3001\u671f\u5f85\u901a\u308a\u306e\u30ed\u30b0\u3092\u8868\u793a\u3067\u304d\u305f\u3002\".0Z\"\n[root@master1 ~]# docker logs --since 2016-11-23T07:54:28.0Z test-con\n172.17.0.1 - - [23/Nov/2016:07:54:28 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n172.17.0.1 - - [23/Nov/2016:07:54:29 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n172.17.0.1 - - [23/Nov/2016:07:57:23 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n\n\".00Z\"\n[root@master1 ~]# docker logs --since 2016-11-23T07:54:28.00Z test-con\n172.17.0.1 - - [23/Nov/2016:07:54:28 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n172.17.0.1 - - [23/Nov/2016:07:54:29 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n172.17.0.1 - - [23/Nov/2016:07:57:23 +0000] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.29.0\" \"-\"\n\n```\n\n\n##3.21 \u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092tar\u30d5\u30a1\u30a4\u30eb\u306b\u4fdd\u5b58\u3057\u305f\u308a\u3001tar\u30d5\u30a1\u30a4\u30eb\u304b\u3089\u30a4\u30e1\u30fc\u30b8\u3092\u53d6\u308a\u51fa\u3059(export/import)\n\n```\n---------------------------------------------------------------------\n1. \u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\u3092\u30d5\u30a1\u30a4\u30eb\u306b\u66f8\u304d\u51fa\u3059(export)\n---------------------------------------------------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 test]# docker run -it --name test-con centos:centos7 bash\n\n\u30b3\u30f3\u30c6\u30ca\u5185\u3067\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@7066811e42e1 /]# touch test.txt\n[root@7066811e42e1 /]# echo \"This is container\" > test.txt\n[root@7066811e42e1 /]# cat test.txt\nThis is container\n\nCtrl\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u306a\u304c\u3089\u3001P\u30ad\u30fc\u3068Q\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u3066\u3001\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u629c\u3051\u308b\u3002\n[root@7066811e42e1 /]# \n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 test]# docker ps\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\n7066811e42e1        centos:centos7      \"bash\"              28 seconds ago      Up 25 seconds                           test-con\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u505c\u6b62\u3059\u308b\u3002\u505c\u6b62\u3057\u3066\u304b\u3089\u3001\u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\u3092\u30d5\u30a1\u30a4\u30eb\u306b\u66f8\u304d\u51fa\u3059\u3002\n[root@master1 test]# docker stop test-con\ntest-con\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3092\u30d5\u30a1\u30a4\u30eb\u306b\u66f8\u304d\u51fa\u3059\u3002\n[root@master1 test]# docker export test-con > test-img.tar\n\n\u30d5\u30a1\u30a4\u30eb\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 test]# file test-img.tar\ntest-img.tar: POSIX tar archive\n\n\u30b3\u30f3\u30c6\u30ca\u3067\u4f5c\u6210\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u3092\u53d6\u308a\u51fa\u3059\u3002\n[root@master1 test]# tar xvf test-img.tar test.txt\ntest.txt\n\n\u30d5\u30a1\u30a4\u30eb\u306e\u4e2d\u8eab\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 test]# cat test.txt\nThis is container\n\n\n---------------------------------------------------------------------\n2. \u30d5\u30a1\u30a4\u30eb\u304b\u3089\u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\u3092\u53d6\u308a\u3060\u3059(import)\n---------------------------------------------------------------------\n[root@master1 test]# ls\ntest-img.tar\n\n\u30d5\u30a1\u30a4\u30eb\u304b\u3089\u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\u3092\u53d6\u308a\u51fa\u3059\u3002\n[root@master1 test]# cat test-img.tar | docker import - test-img:ver2\nsha256:37a6835802e35b05a3e095705774f4002a0e5a1799cb569d30e57dc310174ac8\n\n\u53d6\u308a\u51fa\u3057\u305f\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 test]# docker images\nREPOSITORY                                            TAG                                IMAGE ID            CREATED             SIZE\ntest-img                                              ver2                               37a6835802e3        28 seconds ago      196.5 MB\n\u4ee5\u4e0b\u3001\u7565\n\n\u767b\u9332\u3057\u305f\u30a4\u30e1\u30fc\u30b8\u304b\u3089\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 test]# docker run -it --rm test-img:ver2 bash\n\n[root@5e12df260b97 /]# ls\nanaconda-post.log  bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  test.txt  tmp  usr  var\n\n\u4f5c\u6210\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u306e\u4e2d\u8eab\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@5e12df260b97 /]# cat test.txt\nThis is container\n\n```\n\n\n##3.22 \u30a4\u30e1\u30fc\u30b8\u3092tar\u30d5\u30a1\u30a4\u30eb\u306b\u4fdd\u5b58\u3057\u305f\u308a\u3001tar\u30d5\u30a1\u30a4\u30eb\u304b\u3089\u30a4\u30e1\u30fc\u30b8\u3092\u53d6\u308a\u51fa\u3059(save/load)\n###3.22.1 \u57fa\u672c\u7684\u306a\u4f7f\u3044\u65b9\n\n```\n------------------------------------------------------\n0. \u5168\u4f53\u50cf\n------------------------------------------------------\nmaster1,master2\u306f\u4eee\u60f3\u30de\u30b7\u30f3(CentOS7.2)\u3067\u3059\u3002\n (1) \u30a4\u30e1\u30fc\u30b8\u3092tar\u306b\u4fdd\u5b58(save)\n (2) tar\u3092scp\u3067\u8ee2\u9001(master1->master2)\n (3) tar\u304b\u3089\u30a4\u30e1\u30fc\u30b8\u3092\u53d6\u308a\u51fa\u3059(load)\n\n    master1   ----------------------- master2\n\n     <save>   ------- (scp) -------->  <load>\n\n------------------------------------------------------\n1. master1\u306e\u64cd\u4f5c\n------------------------------------------------------\ntar\u30d5\u30a1\u30a4\u30eb\u306b\u4fdd\u5b58\u3059\u308b\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\n[root@master1 test2]# docker images |grep busybox\ndocker.io/busybox                                     latest                             e02e811dd08f        7 weeks ago         1.093 MB\n\n\u30a4\u30e1\u30fc\u30b8\u3092tar\u306b\u4fdd\u5b58\u3059\u308b\u3002\n[root@master1 test2]# docker save busybox > busybox_ver1.tar\n[root@master1 test2]# ls\nbusybox_ver1.tar\n\ntar\u30d5\u30a1\u30a4\u30eb\u3092\u5225\u30db\u30b9\u30c8(master2)\u306b\u8ee2\u9001\u3059\u308b\u3002\n[root@master1 test2]# scp busybox_ver1.tar root@master2:/root/test\n\n------------------------------------------------------\n2. master2\u306e\u64cd\u4f5c\n------------------------------------------------------\nmaster1\u304b\u3089\u8ee2\u9001\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master2 test]# ls\nbusybox_ver1.tar\n\ntar\u30d5\u30a1\u30a4\u30eb\u304b\u3089\u30a4\u30e1\u30fc\u30b8\u3092\u5fa9\u5143\u3059\u308b\u3002\n[root@master2 test]# docker load -i busybox_ver1.tar\n[root@master2 test]# docker images |grep busybox\ndocker.io/busybox                                     latest                             e02e811dd08f        7 weeks ago         1.093 MB\n\n\u30b3\u30f3\u30c6\u30ca\u306b\u30ed\u30b0\u30a4\u30f3\u3059\u308b\n[root@master2 test]# docker run -it busybox sh\n/ # exit\n\n```\n\n\n\n\n###3.22.2 \u767b\u9332\u6e08\u30a4\u30e1\u30fc\u30b8\u3092tar\u30d5\u30a1\u30a4\u30eb\u306b\u5909\u63db\n\n\n```\n\u767b\u9332\u6e08\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# docker images |grep skydns\ngcr.io/google_containers/skydns                       2015-03-11-001      d808d12f05f0        22 months ago       8.811 MB\n\n\u30a4\u30e1\u30fc\u30b8\u3092tar\u30d5\u30a1\u30a4\u30eb\u306b\u4fdd\u5b58\u3059\u308b\u3002\n[root@master1 ~]# docker save gcr.io/google_containers/skydns:2015-03-11-001 > skydns.tar\n[root@master1 ~]# ls skydns.tar\nskydns.tar\n\n\u767b\u9332\u6e08\u307f\u30a4\u30e1\u30fc\u30b8\u3092\u524a\u9664\u3059\u308b\u3002\n[root@master1 ~]# docker rmi d808d12f05f0\nUntagged: gcr.io/google_containers/skydns:2015-03-11-001\nDeleted: sha256:d808d12f05f04a0f99443d803c49ac557540f0453de1599d07c0b761ddf89625\nDeleted: sha256:81a0d366188e44745f6c5ef56f7509002b96886c662697c9dbb8faf0878e8ffa\nDeleted: sha256:327cc3abb2d292aca8af2e4342914d4239e22c45d49b4b2eea53435d471c47a7\n\n\u30a4\u30e1\u30fc\u30b8\u304c\u524a\u9664\u3067\u304d\u305f\u304b\u3069\u3046\u304b\u3092\u78ba\u8a8d\u3059\u308b\u3002\u524a\u9664\u3067\u304d\u305f\u3002\n[root@master1 ~]# docker images |grep skydns\n[root@master1 ~]#\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30ed\u30fc\u30c9\u3059\u308b\u3002\n[root@master1 ~]# docker load -i skydns.tar\n\n\u30a4\u30e1\u30fc\u30b8\u304c\u767b\u9332\u3067\u304d\u305f\u304b\u3069\u3046\u304b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# docker images |grep skydns\ngcr.io/google_containers/skydns                       2015-03-11-001      d808d12f05f0        22 months ago       8.811 MB\n[root@master1 ~]#\n\n\n\u3061\u306a\u307f\u306b\u3001tar\u30d5\u30a1\u30a4\u30eb\u306e\u4e2d\u8eab\u3092\u898b\u3066\u307f\u308b\u3002\n[root@master1 ~]# tar tvf skydns.tar\ndrwxr-xr-x 0/0               0 2015-03-11 14:51 0db03cc7860ce2e801eb4f0ce4b84943cec176fcdf6db56fc37b7cf9490b7354/\n-rw-r--r-- 0/0               3 2015-03-11 14:51 0db03cc7860ce2e801eb4f0ce4b84943cec176fcdf6db56fc37b7cf9490b7354/VERSION\n-rw-r--r-- 0/0            1220 2015-03-11 14:51 0db03cc7860ce2e801eb4f0ce4b84943cec176fcdf6db56fc37b7cf9490b7354/json\n-rw-r--r-- 0/0            1024 2015-03-11 14:51 0db03cc7860ce2e801eb4f0ce4b84943cec176fcdf6db56fc37b7cf9490b7354/layer.tar\ndrwxr-xr-x 0/0               0 2015-03-11 14:51 768d4f50f65f00831244703e57f64134771289e3de919a576441c9140e037ea2/\n-rw-r--r-- 0/0               3 2015-03-11 14:51 768d4f50f65f00831244703e57f64134771289e3de919a576441c9140e037ea2/VERSION\n-rw-r--r-- 0/0             388 2015-03-11 14:51 768d4f50f65f00831244703e57f64134771289e3de919a576441c9140e037ea2/json\n-rw-r--r-- 0/0            1024 2015-03-11 14:51 768d4f50f65f00831244703e57f64134771289e3de919a576441c9140e037ea2/layer.tar\ndrwxr-xr-x 0/0               0 2015-03-11 14:51 8189e88be4567d5094319a378e339a729c56a4cfb1e4514ff1dfdb5338a9ba20/\n-rw-r--r-- 0/0               3 2015-03-11 14:51 8189e88be4567d5094319a378e339a729c56a4cfb1e4514ff1dfdb5338a9ba20/VERSION\n-rw-r--r-- 0/0             464 2015-03-11 14:51 8189e88be4567d5094319a378e339a729c56a4cfb1e4514ff1dfdb5338a9ba20/json\n-rw-r--r-- 0/0         6382592 2015-03-11 14:51 8189e88be4567d5094319a378e339a729c56a4cfb1e4514ff1dfdb5338a9ba20/layer.tar\ndrwxr-xr-x 0/0               0 2015-03-11 14:51 96c5134b442cd6446dfae4b1ae1de0aad4b0f408ccd0cf6126566a096da7a209/\n-rw-r--r-- 0/0               3 2015-03-11 14:51 96c5134b442cd6446dfae4b1ae1de0aad4b0f408ccd0cf6126566a096da7a209/VERSION\n-rw-r--r-- 0/0             464 2015-03-11 14:51 96c5134b442cd6446dfae4b1ae1de0aad4b0f408ccd0cf6126566a096da7a209/json\n-rw-r--r-- 0/0         2643968 2015-03-11 14:51 96c5134b442cd6446dfae4b1ae1de0aad4b0f408ccd0cf6126566a096da7a209/layer.tar\ndrwxr-xr-x 0/0               0 2015-03-11 14:51 b3bbc4636fc59ec067f4a877899f2e008bf3e2fe55451ef78c090dd9709b3818/\n-rw-r--r-- 0/0               3 2015-03-11 14:51 b3bbc4636fc59ec067f4a877899f2e008bf3e2fe55451ef78c090dd9709b3818/VERSION\n-rw-r--r-- 0/0             464 2015-03-11 14:51 b3bbc4636fc59ec067f4a877899f2e008bf3e2fe55451ef78c090dd9709b3818/json\n-rw-r--r-- 0/0            1024 2015-03-11 14:51 b3bbc4636fc59ec067f4a877899f2e008bf3e2fe55451ef78c090dd9709b3818/layer.tar\ndrwxr-xr-x 0/0               0 2015-03-11 14:51 b888703acbfd97fc1bce3fb2badfcf7f98da8cb6529af2be1a56ab82422a1504/\n-rw-r--r-- 0/0               3 2015-03-11 14:51 b888703acbfd97fc1bce3fb2badfcf7f98da8cb6529af2be1a56ab82422a1504/VERSION\n-rw-r--r-- 0/0             464 2015-03-11 14:51 b888703acbfd97fc1bce3fb2badfcf7f98da8cb6529af2be1a56ab82422a1504/json\n-rw-r--r-- 0/0            1024 2015-03-11 14:51 b888703acbfd97fc1bce3fb2badfcf7f98da8cb6529af2be1a56ab82422a1504/layer.tar\n-rw-r--r-- 0/0            2473 2015-03-11 14:51 d808d12f05f04a0f99443d803c49ac557540f0453de1599d07c0b761ddf89625.json\ndrwxr-xr-x 0/0               0 2015-03-11 14:51 f65db1fc72e498be5329bab6c2f9f5aa6bb4d4747644a984e53fd9dbb17db8bc/\n-rw-r--r-- 0/0               3 2015-03-11 14:51 f65db1fc72e498be5329bab6c2f9f5aa6bb4d4747644a984e53fd9dbb17db8bc/VERSION\n-rw-r--r-- 0/0             464 2015-03-11 14:51 f65db1fc72e498be5329bab6c2f9f5aa6bb4d4747644a984e53fd9dbb17db8bc/json\n-rw-r--r-- 0/0            1024 2015-03-11 14:51 f65db1fc72e498be5329bab6c2f9f5aa6bb4d4747644a984e53fd9dbb17db8bc/layer.tar\n-rw-r--r-- 0/0             697 1970-01-01 09:00 manifest.json\n-rw-r--r-- 0/0             122 1970-01-01 09:00 repositories\n[root@master1 ~]#\n\n```\n\n\n\n##3.23 Nginx\u30a4\u30e1\u30fc\u30b8\u306e\u3064\u304f\u308a\u65b9\n\n```\n[root@master1 ~]# mkdir nginx\n[root@master1 ~]# cd nginx/\n\nDockerfile\u3092\u7de8\u96c6\u3059\u308b\u3002\n[root@master1 nginx]# vi Dockerfile\n[root@master1 nginx]# cat Dockerfile\nFROM centos:centos7\nRUN yum -y install epel-release\nRUN yum -y install nginx\nADD index.html /usr/share/nginx/html/\nCMD /usr/sbin/nginx -g 'daemon off;' -c /etc/nginx/nginx.conf\n[root@master1 nginx]#\n\nindex.html\u30d5\u30a1\u30a4\u30eb\u3092\u7de8\u96c6\u3059\u308b\u3002\n[root@master1 nginx]# vi index.html\n[root@master1 nginx]# cat index.html\nHello hana_shin\n\n[root@master1 nginx]# ls\nDockerfile  index.html\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 nginx]# docker build -t nginx-img:v1 --no-cache=true .\nSending build context to Docker daemon 3.072 kB\nStep 1 : FROM centos:centos7\n ---> 0584b3d2cf6d\nStep 2 : RUN yum -y install epel-release\n ---> Running in e48a494481c1\nLoaded plugins: fastestmirror, ovl\n-\u4ee5\u4e0b\u3001\u7565\n\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 nginx]# docker images\nREPOSITORY                                            TAG                                IMAGE ID            CREATED             SIZE\nnginx-img                                             v1                                 3df7144df03d        18 seconds ago      400.8 MB\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 nginx]# docker run -d -p 11111:80 nginx-img:v1\na6f13663ca199463519f08ca81f33f1fa5133440ed1ddf58f1d6f1d7a064d760\n\n\u30b3\u30f3\u30c6\u30ca\u306bHTTP\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3002\n[root@master1 nginx]# curl http://localhost:11111\nHello hana_shin\n\n```\n\n\n\n##3.24 \u30d3\u30eb\u30c9\u306b\u4e0d\u8981\u306a\u30d5\u30a1\u30a4\u30eb\u306e\u9664\u5916\u65b9\u6cd5(.dockerignore\u30d5\u30a1\u30a4\u30eb\u3092\u4f7f\u3046)\n\n```\n\u30d3\u30eb\u30c9\u3059\u308b\u6642\u9593\u306f4\u79d2\n[root@master1 ~]# time docker build -t test-img --no-cache=true .\nSending build context to Docker daemon 83.64 MB\nStep 1 : FROM busybox\n ---> e02e811dd08f\nSuccessfully built e02e811dd08f\n\nreal    0m4.368s\nuser    0m0.363s\nsys     0m0.882s\n\n\n\u30d3\u30eb\u30c9\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b1G\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 ~]# dd if=/dev/zero of=./file_1G bs=1024k count=1024\n1024+0 \u30ec\u30b3\u30fc\u30c9\u5165\u529b\n1024+0 \u30ec\u30b3\u30fc\u30c9\u51fa\u529b\n1073741824 \u30d0\u30a4\u30c8 (1.1 GB) \u30b3\u30d4\u30fc\u3055\u308c\u307e\u3057\u305f\u3001 3.67382 \u79d2\u3001 292 MB/\u79d2\n\n\u30d5\u30a1\u30a4\u30eb\u30b5\u30a4\u30ba\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# ls -la file_1G\n-rw-r--r--. 1 root root 1073741824 11\u6708 23 20:33 file_1G\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\u30d3\u30eb\u30c9\u306b47\u79d2\u304b\u304b\u308b\u3002\n[root@master1 ~]# time docker build -t test-img --no-cache=true .\nSending build context to Docker daemon 1.157 GB\nStep 1 : FROM busybox\n ---> e02e811dd08f\nSuccessfully built e02e811dd08f\n\nreal    0m47.847s\nuser    0m2.671s\nsys     0m8.364s\n[root@master1 ~]#\n\n\n\u30d3\u30eb\u30c9\u5bfe\u8c61\u5916\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 ~]# vi .dockerignore\n[root@master1 ~]# cat .dockerignore\nfile_1G\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\u4eca\u5ea6\u306f3.7\u79d2\u3057\u304b\u304b\u304b\u3089\u306a\u3044\u3002\n[root@master1 ~]# time docker build -t test-img --no-cache=true .\nSending build context to Docker daemon 83.64 MB\nStep 1 : FROM busybox\n ---> e02e811dd08f\nSuccessfully built e02e811dd08f\n\nreal    0m3.764s\nuser    0m0.209s\nsys     0m1.398s\n\n```\n\n##3.25 systemd\u304b\u3089\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n\n```\n\u30b5\u30fc\u30d3\u30b9\u5b9a\u7fa9\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 system]# pwd\n/etc/systemd/system\n[root@master1 system]# touch test.service\n[root@master1 system]# vi test.service\n[root@master1 system]# cat test.service\n[Unit]\nDescription=Simple Nginx Test\nAfter=docker.service\nRequires=docker.service\n\n[Service]\nRestart=always\nExecStart=/usr/bin/docker run --name nginx-con -p 11111:80 nginx\nExecStop=/usr/bin/docker rm -f nginx-con\n\n[Install]\nWantedBy=multi-user.target\n\n\n[root@master1 system]# systemctl enable /etc/systemd/system/test.service\nCreated symlink from /etc/systemd/system/multi-user.target.wants/test.service to /etc/systemd/system/test.service.\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 system]# systemctl start test.service\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 system]# systemctl status test.service\n\u25cf test.service - Simple Nginx Test\n   Loaded: loaded (/etc/systemd/system/test.service; enabled; vendor preset: disabled)\n   Active: active (running) since \u91d1 2016-11-25 22:47:25 JST; 7s ago\n Main PID: 20391 (docker-current)\n   Memory: 9.8M\n   CGroup: /system.slice/test.service\n           mq20391 /usr/bin/docker-current run --name nginx-con -p 11111:80 nginx\n\n11\u6708 25 22:47:25 master1 systemd[1]: Started Simple Nginx Test.\n11\u6708 25 22:47:25 master1 systemd[1]: Starting Simple Nginx Test...\n\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002Nginx\u306e\u30b3\u30f3\u30c6\u30ca\u304c\u8d77\u52d5\u3057\u3066\u3044\u308b\u3002\n[root@master1 system]# docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                            NAMES\nddd3608f807d        nginx               \"nginx -g 'daemon off\"   48 seconds ago      Up 44 seconds       443/tcp, 0.0.0.0:11111->80/tcp   nginx-con\n\n\u30b3\u30f3\u30c6\u30ca\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3002\n[root@master1 ~]# curl http://localhost:11111\n<!DOCTYPE html>\n<html>\n<head>\n<title>Welcome to nginx!</title>\n<style>\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u505c\u6b62\u3059\u308b\u3002\n[root@master1 system]# systemctl stop test.service\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 system]# docker ps\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\n\n```\n\n\n##3.26 \u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\u304b\u3089\u5c65\u6b74\u3092\u524a\u9664\u3059\u308b\u65b9\u6cd5\uff08\u79d8\u5bc6\u60c5\u5831\u3092\u524a\u9664\u3057\u305f\u3044\u5834\u5408\u306b\u4f7f\u3046\uff09\n\n```\n\n--------------------------------------------------\n1. \u30c6\u30b9\u30c8\u7528\u30a4\u30e1\u30fc\u30b8\u3092\u4f5c\u6210\u3059\u308b\u3002\n--------------------------------------------------\nDockerfile\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 test2]# vi Dockerfile\n[root@master1 test2]# cat Dockerfile\nFROM centos:centos7\nRUN echo \"This is secret information\" >> /tmp/secret_key\nRUN cat /tmp/secret_key\nRUN rm /tmp/secret_key\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 test2]# docker build -t test-img:ver1 .\nSending build context to Docker daemon 2.048 kB\nStep 1 : FROM centos:centos7\n ---> 0584b3d2cf6d\nStep 2 : RUN echo \"This is secret information\" >> /tmp/secret_key\n ---> Running in ed00cad28d24\n ---> 9c6db5e3cad3\nRemoving intermediate container ed00cad28d24\nStep 3 : RUN cat /tmp/secret_key\n ---> Running in 7641391a877c\nThis is secret information\n ---> 99b9ea91137e\nRemoving intermediate container 7641391a877c\nStep 4 : RUN rm /tmp/secret_key\n ---> Running in 041fc96f4ce2\n ---> 06d81d6769f1\nRemoving intermediate container 041fc96f4ce2\nSuccessfully built 06d81d6769f1\n\n\u30a4\u30e1\u30fc\u30b8\u306b\u5bfe\u3059\u308b\u64cd\u4f5c\u5c65\u6b74\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 test2]# docker history test-img:ver1\nIMAGE               CREATED              CREATED BY                                      SIZE                COMMENT\n06d81d6769f1        About a minute ago   /bin/sh -c rm /tmp/secret_key                   0 B\n99b9ea91137e        About a minute ago   /bin/sh -c cat /tmp/secret_key                  0 B\n9c6db5e3cad3        About a minute ago   /bin/sh -c echo \"This is secret information\"    27 B\n0584b3d2cf6d        3 weeks ago          /bin/sh -c #(nop)  CMD [\"/bin/bash\"]            0 B\n<missing>           3 weeks ago          /bin/sh -c #(nop)  LABEL name=CentOS Base Ima   0 B\n<missing>           3 weeks ago          /bin/sh -c #(nop) ADD file:54df3580ac9fb66389   196.5 MB\n<missing>           12 weeks ago         /bin/sh -c #(nop)  MAINTAINER https://github.   0 B\n\n\u5c65\u6b74\u306e\u4e0a\u304b\u30892\u756a\u76ee\u306e\u64cd\u4f5c\u3092\u5b9f\u884c\u3059\u308b\u3002\u60c5\u5831\u304c\u8aad\u3081\u3066\u3057\u307e\u3046!!!\n[root@master1 test2]# docker run 99b9ea91137e cat /tmp/secret_key\nThis is secret information\n\n\n--------------------------------------------------\n2. \u30a4\u30e1\u30fc\u30b8\u304b\u3089\u5c65\u6b74\u3092\u524a\u9664\u3059\u308b\u3002\n--------------------------------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 test2]# docker run -d test-img:ver1 /bin/true\n8cb069ea1ef9bf058b7515fb6061a33a9512df956fef7b13413c926cd7403805\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 test2]# docker ps -a\nCONTAINER ID        IMAGE               COMMAND                 CREATED             STATUS                     PORTS               NAMES\n8cb069ea1ef9        test-img:ver1       \"/bin/true\"             10 seconds ago      Exited (0) 7 seconds ago                       focused_chandrasekhar\n\n\u30a4\u30e1\u30fc\u30b8\u304b\u3089\u5c65\u6b74\u3092\u524a\u9664\u3059\u308b\u3002\n[root@master1 test2]# docker export 8cb069ea1ef9 | docker import - test-img:ver1\nsha256:a1691c449d092903e16522566a747a85dbbf69486a7b1122984cf147a33594fe\n[root@master1 test2]#\n\n\u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\u306e\u5c65\u6b74\u3092\u78ba\u8a8d\u3059\u308b\u3002\u5c65\u6b74\u304c\u524a\u9664\u3055\u308c\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 test2]# docker history test-img:ver1\nIMAGE               CREATED             CREATED BY          SIZE                COMMENT\na1691c449d09        38 seconds ago                          196.5 MB            Imported from -\n\n```\n\n\n##3.27 \u30a4\u30e1\u30fc\u30b8\u4e00\u89a7\u306b\"none:none\"\u3068\u3044\u3046\u30a8\u30f3\u30c8\u30ea\u304c\u4f5c\u6210\u3055\u308c\u308b\u7406\u7531\n\u540c\u3058\u540d\u524d\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3068\u3001\u30a4\u30e1\u30fc\u30b8\u4e00\u89a7\u306e\u4e2d\u306b\"none:none\"\u3068\u3044\u3046\u30a8\u30f3\u30c8\u30ea\u304c\u4f5c\u6210\u3055\u308c\u308b\u3002\n\n```\n----------------------------------------------\n1. 1\u56de\u76ee\u306e\u30d3\u30eb\u30c9\u5b9f\u884c\n----------------------------------------------\n[root@master1 test2]# less Dockerfile\n[root@master1 test2]# cat Dockerfile\nFROM centos:centos7\nRUN echo \"This is V1\" >> /tmp/version\nRUN cat /tmp/version\nRUN rm /tmp/version\n\n[root@master1 test2]# docker build -t test-img:ver1 .\n\u4ee5\u4e0b\u3001\u7565\n\n[root@master1 test2]# docker images\nREPOSITORY                                            TAG                                IMAGE ID            CREATED             SIZE\ntest-img                                              ver1                               ada297f58022        9 seconds ago       196.5 MB\n\n\n------------------------------------------------\n2. Dockerfile\u306e\u4e2d\u8eab\u3092\u66f8\u304d\u63db\u3048\u3066\u30012\u56de\u76ee\u306e\u30d3\u30eb\u30c9\u5b9f\u884c\n------------------------------------------------\n[root@master1 test2]# vi Dockerfile\n[root@master1 test2]# cat Dockerfile\nFROM centos:centos7\nRUN echo \"This is V2\" >> /tmp/version\nRUN cat /tmp/version\nRUN rm /tmp/version\n\n[root@master1 test2]# docker build -t test-img:ver1 .\n\u4ee5\u4e0b\u3001\u7565\n\n1\u56de\u76ee\u306b\u4f5c\u6210\u3057\u305f\u30a4\u30e1\u30fc\u30b8\u306e\"\u30ea\u30dd\u30b8\u30c8\u30ea\u540d:TAG\"\u304c\"none:none\"\u306b\u304b\u308f\u3063\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 test2]# docker images\nREPOSITORY                                            TAG                                IMAGE ID            CREATED              SIZE\ntest-img                                              ver1                               7a09677e71ac        8 seconds ago        196.5 MB\n<none>                                                <none>                             ada297f58022        About a minute ago   196.5 MB\n\u4ee5\u4e0b\u3001\u7565\n\n\n------------------------------------------------\n3. Dockerfile\u306e\u4e2d\u8eab\u3092\u66f8\u304d\u63db\u3048\u3066\u30013\u56de\u76ee\u306e\u30d3\u30eb\u30c9\u5b9f\u884c\n------------------------------------------------\n[root@master1 test2]# vi Dockerfile\n[root@master1 test2]# cat Dockerfile\nFROM centos:centos7\nRUN echo \"This is V3\" >> /tmp/version\nRUN cat /tmp/version\nRUN rm /tmp/version\n\n[root@master1 test2]# docker build -t test-img:ver1 .\n\u4ee5\u4e0b\u3001\u7565\n\n1\u56de\u76ee,2\u56de\u76ee\u306b\u4f5c\u6210\u3057\u305f\u30a4\u30e1\u30fc\u30b8\u306e\"\u30ea\u30dd\u30b8\u30c8\u30ea\u540d:TAG\"\u304c\"none:none\"\u306b\u304b\u308f\u3063\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 test2]# docker images\nREPOSITORY                                            TAG                                IMAGE ID            CREATED              SIZE\ntest-img                                              ver1                               77f33e665cac        7 seconds ago        196.5 MB\n<none>                                                <none>                             7a09677e71ac        About a minute ago   196.5 MB\n<none>                                                <none>                             ada297f58022        About a minute ago   196.5 MB\n\u4ee5\u4e0b\u3001\u7565\n\n\n```\n\n\n##3.28 \u30b3\u30f3\u30c6\u30ca\u306e\u30e6\u30fc\u30b6ID\u3092\u8abf\u3079\u308b\u65b9\u6cd5\n\n```\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master ~]# docker run -d --name test-con nginx\ne509a143aec99f60494ffb7ece7ad4798ba7a251a84dda3b12682448fcfd940b\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master ~]# docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES\ne509a143aec9        nginx               \"nginx -g 'daemon off\"   5 seconds ago       Up 2 seconds        80/tcp, 443/tcp     test-con\n\n\u30b3\u30f3\u30c6\u30caID\u3092\u6c42\u3081\u308b\u3002\n[root@master ~]# CID=$(docker ps --no-trunc=true|grep \"test-con\"|awk '{print $1}')\n\n\u30b3\u30f3\u30c6\u30caID\u3092\u8868\u793a\u3059\u308b\u3002\n[root@master ~]# echo $CID\ne509a143aec99f60494ffb7ece7ad4798ba7a251a84dda3b12682448fcfd940b\n\n\u30d7\u30ed\u30bb\u30b9ID\u3092\u6c42\u3081\u308b\u3002\n[root@master ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u30d7\u30ed\u30bb\u30b9ID\u3092\u8868\u793a\u3059\u308b\u3002\n[root@master ~]# echo $PID\n20648\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u30e6\u30fc\u30b6ID(UID)\u3092\u8abf\u3079\u308b\u3002\u30e6\u30fc\u30b6ID(UID)\u306f0\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\u3064\u307e\u308aroot\u30e6\u30fc\u30b6\u3068\u540c\u3058\n[root@master ~]# ps -p $PID -o cmd,pid,ppid,uid,euid\nCMD                            PID   PPID   UID  EUID\nnginx: master process nginx  20648  20632     0     0\n\n```\n\n##3.29 \u30b3\u30f3\u30c6\u30ca\u306eIP\u30a2\u30c9\u30ec\u30b9\u3092\u8abf\u3079\u308b\u65b9\u6cd5\n\n```\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -it --rm --name test-con centos:centos7 bash\n\n[root@bf30021d03ac /]# yum -y install iproute\n[root@bf30021d03ac /]# ip a\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n    inet6 ::1/128 scope host\n       valid_lft forever preferred_lft forever\n40: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP\n    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff\n  \u2605inet 172.17.0.2/16 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::42:acff:fe11:2/64 scope link\n       valid_lft forever preferred_lft forever\n[root@bf30021d03ac /]#\n\n\n\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3067\u30b3\u30f3\u30c6\u30ca\u306eIP\u30a2\u30c9\u30ec\u30b9\u3092\u78ba\u8a8d\u3059\u308b\u3002IP\u30a2\u30c9\u30ec\u30b9\u304c172.17.0.2\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# docker ps\nCONTAINER ID      IMAGE              COMMAND        CREATED             STATUS          PORTS     NAMES\nbf30021d03ac      centos:centos7     \"bash\"         9 seconds ago       Up 6 seconds              test-con\n\n[root@master1 ~]# IP=$(docker inspect -f {{.NetworkSettings.IPAddress}} test-con)\n[root@master1 ~]# echo $IP\n172.17.0.2 \u2605\n\n```\n\n\n\n##3.30 \u30b3\u30f3\u30c6\u30ca\u306e\u30ea\u30bd\u30fc\u30b9\u6d88\u8cbb\u3092\u8abf\u3079\u308b\u65b9\u6cd5(htop\u3092\u4f7f\u3046\u3088\u308a\u3001\u3053\u3063\u3061\u306e\u307b\u3046\u304c\u7c21\u5358\u304b\u3082\uff09\n\n```\n\u30b3\u30f3\u30c6\u30ca(con0)\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -it -d --name con0 --cpu-shares=1024  busybox dd if=/dev/zero of=/dev/null\nb67ad54132fc2d05797f32830d15306484e17678af75b6505559ef8f80216f1c\n\n\u30b3\u30f3\u30c6\u30ca(con1)\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -it -d --name con1 --cpu-shares=1024  busybox dd if=/dev/zero of=/dev/null\nf3b736c38bee1b713d9da908f14bc846ad6c3522ccbe9b41410e0b6967145d20\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# docker ps\nCONTAINER ID     IMAGE         COMMAND                  CREATED             STATUS           PORTS           NAMES\nf3b736c38bee     busybox       \"dd if=/dev/zero of=/\"   5 seconds ago       Up 2 seconds                     con1\nb67ad54132fc     busybox       \"dd if=/dev/zero of=/\"   12 seconds ago      Up 10 seconds                    con0\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u7d71\u8a08\u60c5\u5831\u3092\u78ba\u8a8d\u3059\u308b\u3002CPU\u4f7f\u7528\u7387\u3001\u30e1\u30e2\u30ea\u4f7f\u7528\u91cf\u7b49\u3068\u3044\u3063\u305f\u60c5\u5831\u304c\u53d6\u5f97\u3067\u304d\u308b\u3002\n[root@master1 ~]# docker stats $(docker inspect -f {{.Name}} $(docker ps -q))\nCONTAINER           CPU %               MEM USAGE / LIMIT     MEM %               NET I/O             BLOCK I/O\n/con0               51.97%              1.057 MB / 1.027 GB   0.10%               1.296 kB / 648 B    1.108 MB / 0 B\n/con1               48.78%              1.118 MB / 1.027 GB   0.11%               718 B / 648 B       1.108 MB / 0 B\n\n```\n\n\n##3.31 \u30bf\u30b0\u306a\u3057\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u3059\u3079\u3066\u524a\u9664\u3059\u308b\n\n```\n\u30bf\u30b0\u306a\u3057\u30a4\u30e1\u30fc\u30b8\u4e00\u89a7\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 test2]# docker images |grep none\n<none>                                                <none>                             987633f4efac        About a minute ago   196.5 MB\n<none>                                                <none>                             817a3d2131b4        2 minutes ago        196.5 MB\n<none>                                                <none>                             98a0ac2e3be6        7 minutes ago        196.5 MB\n\n\u30bf\u30b0\u306a\u3057\u30a4\u30e1\u30fc\u30b8\u3092\u5168\u3066\u524a\u9664\u3059\u308b\n[root@master1 test2]# docker rmi $(docker images | grep '<none>' | awk '{print$3}')\nDeleted: sha256:987633f4eface07f7d53b84cc7464182ccbcd8c2c63ae319ad324f255fce815b\n-\u4ee5\u4e0b\u3001\u7565-\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002\u30bf\u30b0\u306a\u3057\u306e\u30a4\u30e1\u30fc\u30b8\u304c\u5168\u3066\u524a\u9664\u3067\u304d\u305f\u3002\n[root@master1 test2]# docker images |grep none\n[root@master1 test2]#\n\n```\n\n\n##3.32 \u30b3\u30f3\u30c6\u30ca\u304c\u7d42\u4e86\u3059\u308b\u3068\u304d\u306e\u7d42\u4e86\u30b3\u30fc\u30c9\u306b\u3064\u3044\u3066\n\n[Exit Codes With Special Meanings](http://tldp.org/LDP/abs/html/exitcodes.html)\n\n```\n----------------------------------------------------------------\n1. \u30b3\u30f3\u30c6\u30ca\u3092\u6b63\u5e38\u7d42\u4e86\u3059\u308b\n----------------------------------------------------------------\n[root@master1 ~]# docker run --rm busybox /bin/sh -c 'uname -r'\n3.10.0-229.el7.x86_64\n\n\u7d42\u4e86\u30b3\u30fc\u30c9\u3092\u78ba\u8a8d\u3059\u308b\u3002\u6b63\u5e38\u7d42\u4e86\u3057\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# echo $?\n0\n\n----------------------------------------------------------------\n2. \u30b3\u30f3\u30c6\u30ca\u3092\u7570\u5e38\u7d42\u4e86(\u7d42\u4e86\u30b3\u30fc\u30c9=1)\u3059\u308b\n----------------------------------------------------------------\n\u610f\u56f3\u7684\u306b\u30b3\u30f3\u30c6\u30ca\u3092\u7570\u5e38\u7d42\u4e86(\u7d42\u4e86\u30b3\u30fc\u30c9=1)\u3059\u308b\u3002\n[root@master1 ~]# docker run busybox /bin/sh -c 'exit 1'\n\n\u7d42\u4e86\u30b3\u30fc\u30c9\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# echo $?\n1\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002STATUS\u304c\"Exited (1)\"\u3068\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# docker ps -a\nCONTAINER ID      IMAGE        COMMAND                 CREATED           STATUS                     PORTS         NAMES\n1528b8e7a77f      busybox      \"/bin/sh -c 'exit 1'\"   10 seconds ago  \u2605Exited (1) 8 seconds ago                 stupefied_visvesvaraya\n\n\u5f8c\u59cb\u672b\u3002\u30b3\u30f3\u30c6\u30ca\u3092\u524a\u9664\u3059\u308b\u3002\n[root@master1 ~]# docker rm 1528b8e7a77f\n1528b8e7a77f\n\n----------------------------------------------------------------\n3. \u30b3\u30f3\u30c6\u30ca\u3092\u7570\u5e38\u7d42\u4e86(\u7d42\u4e86\u30b3\u30fc\u30c9=5)\u3059\u308b\n----------------------------------------------------------------\n\u610f\u56f3\u7684\u306b\u30b3\u30f3\u30c6\u30ca\u3092\u7570\u5e38\u7d42\u4e86(\u7d42\u4e86\u30b3\u30fc\u30c9=5)\u3059\u308b\u3002\n[root@master1 ~]# docker run busybox /bin/sh -c 'exit 5'\n\n\u7d42\u4e86\u30b3\u30fc\u30c9\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# echo $?\n5\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002STATUS\u304c\"Exited (5)\"\u3068\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# docker ps -a\nCONTAINER ID      IMAGE        COMMAND                 CREATED           STATUS                     PORTS         NAMES\n720f0ea21f28      busybox      \"/bin/sh -c 'exit 5'\"   9 seconds ago   \u2605Exited (5) 7 seconds ago                 fervent_engelbart\n\n\u5f8c\u59cb\u672b\u3002\u30b3\u30f3\u30c6\u30ca\u3092\u524a\u9664\u3059\u308b\u3002\n[root@master1 ~]# docker rm 720f0ea21f28\n720f0ea21f28\n\n----------------------------------------------------------------------------\n4. \u30b3\u30f3\u30c6\u30ca\u5185\u3067\u30b3\u30de\u30f3\u30c9\u304c\u898b\u3064\u304b\u3089\u306a\u3044\u5834\u5408\u3067\u7d42\u4e86\u3059\u308b\u5834\u5408  (\u7d42\u4e86\u30b3\u30fc\u30c9=127)\n----------------------------------------------------------------------------\n\u5b9f\u5728\u3057\u306a\u3044\u30b3\u30de\u30f3\u30c9lll\u3092\u5b9f\u884c\u3059\u308b\u3002\n[root@master1 ~]# docker run busybox /bin/sh -c 'lll'\n/bin/sh: lll: not found\n\n\u7d42\u4e86\u30b3\u30fc\u30c9\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# echo $?\n127\n\n[root@master1 ~]# docker ps -a\nCONTAINER ID      IMAGE       COMMAND             CREATED            STATUS                       PORTS        NAMES\nbb22f6b73563      busybox     \"/bin/sh -c lll\"    12 seconds ago   \u2605Exited (127) 9 seconds ago                jovial_thompson\n\n----------------------------------------------------------------\n5. Docker\u81ea\u8eab\u306e\u30a8\u30e9\u30fc\u306e\u5834\u5408(\u7d42\u4e86\u30b3\u30fc\u30c9=125)\n----------------------------------------------------------------\n[root@master1 ~]# docker run --rm --foo busybox\nflag provided but not defined: --foo\nSee '/usr/bin/docker-current run --help'.\n\n\u7d42\u4e86\u30b3\u30fc\u30c9\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# echo $?\n125\n\n```\n\n##3.33 \u30b3\u30f3\u30c6\u30ca\u7d42\u4e86\u6642\u306e\u6319\u52d5\u306b\u3064\u3044\u3066(--restart=on-failure,no)\n\n\n```\n--restart=on-failure:X (X\u306f\u518d\u8d77\u52d5\u306e\u56de\u6570\u3092\u8868\u3059) \u30b3\u30f3\u30c6\u30ca\u304c\u7570\u5e38\u7d42\u4e86\uff08\u7d42\u4e86\u30b3\u30fc\u30c9\u304c0\u4ee5\u5916\uff09\u3057\u305f\u5834\u5408\u306e\u518d\u8d77\u52d5\u306e\u56de\u6570\u3092\u6307\u5b9a\u3059\u308b\u30aa\u30d7\u30b7\u30e7\u30f3\u3002\n--restart=no\u306f\u3001\u30b3\u30f3\u30c6\u30ca\u304c\u7570\u5e38\u7d42\u4e86\u3057\u3066\u3082\u518d\u8d77\u52d5\u3057\u306a\u3044\u3088\u3046\u306b\u3059\u308b\u30aa\u30d7\u30b7\u30e7\u30f3\u3002\n\n```\n\n\n```\n---------------------------------------------------------\n1. \u7570\u5e38\u7d42\u4e86\u6642\u306e --restart=on-failure \u306e\u52d5\u4f5c\u3092\u78ba\u8a8d\u3059\u308b\u3002\n---------------------------------------------------------\ndocker events\u3092\u5b9f\u884c\u3059\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u306e\u958b\u59cb\u3001\u7d42\u4e86\u306e\u30a4\u30d9\u30f3\u30c8\u3092\u5f97\u308b\u305f\u3081\u3001grep\u3067\u7d5e\u308a\u8fbc\u3080\u3002\n[root@master1 ~]# docker events |grep -e start -e die\n\n\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3092\u958b\u304f\u3002on-failure:3\u3092\u4ed8\u3051\u3066\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run --restart=on-failure:3 busybox /bin/sh -c 'exit 1'\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# docker ps -a\nCONTAINER ID     IMAGE       COMMAND                 CREATED           STATUS                              PORTS      NAMES\n2e8167f2125b     busybox     \"/bin/sh -c 'exit 1'\"   6 seconds ago   \u2605Exited (1) Less than a second ago              thirsty_ardinghelli\n\ndocker events\u3092\u78ba\u8a8d\u3059\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u304c3\u56de\u518d\u8d77\u52d5\u3092\u3057\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\u518d\u8d77\u52d5\u306f\u25cf\u5370\u306e\u90e8\u5206\n[root@master1 ~]# docker events |grep -e start -e die\n2016-12-06T22:11:09.171061352+09:00 container  start 2e8167f2125bf21f05193ca43e63a665685e05a94f356b48623cde97b1539615 (image=busybox, name=thirsty_ardinghelli)\n2016-12-06T22:11:09.991771696+09:00 container  die 2e8167f2125bf21f05193ca43e63a665685e05a94f356b48623cde97b1539615 (image=busybox, name=thirsty_ardinghelli)\n2016-12-06T22:11:10.193297589+09:00 container\u25cfstart 2e8167f2125bf21f05193ca43e63a665685e05a94f356b48623cde97b1539615 (image=busybox, name=thirsty_ardinghelli)\n2016-12-06T22:11:10.738386606+09:00 container  die 2e8167f2125bf21f05193ca43e63a665685e05a94f356b48623cde97b1539615 (image=busybox, name=thirsty_ardinghelli)\n2016-12-06T22:11:11.139880436+09:00 container\u25cfstart 2e8167f2125bf21f05193ca43e63a665685e05a94f356b48623cde97b1539615 (image=busybox, name=thirsty_ardinghelli)\n2016-12-06T22:11:11.788550292+09:00 container  die 2e8167f2125bf21f05193ca43e63a665685e05a94f356b48623cde97b1539615 (image=busybox, name=thirsty_ardinghelli)\n2016-12-06T22:11:12.848497457+09:00 container\u25cfstart 2e8167f2125bf21f05193ca43e63a665685e05a94f356b48623cde97b1539615 (image=busybox, name=thirsty_ardinghelli)\n2016-12-06T22:11:13.528665703+09:00 container  die 2e8167f2125bf21f05193ca43e63a665685e05a94f356b48623cde97b1539615 (image=busybox, name=thirsty_ardinghelli)\n\u4ee5\u4e0b\u3001\u4f55\u3082\u51fa\u529b\u3055\u308c\u306a\u3044\u3002\n\n\n---------------------------------------------------------\n2. \u6b63\u5e38\u7d42\u4e86\u6642\u306e --restart=on-failure \u306e\u52d5\u4f5c\u3092\u78ba\u8a8d\u3059\u308b\u3002\n---------------------------------------------------------\ndocker events\u3092\u5b9f\u884c\u3059\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u306e\u958b\u59cb\u3001\u7d42\u4e86\u306e\u30a4\u30d9\u30f3\u30c8\u3092\u5f97\u308b\u305f\u3081\u3001grep\u3067\u7d5e\u308a\u8fbc\u3080\u3002\n[root@master1 ~]# docker events |grep -e start -e die\n\n\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3092\u958b\u304f\u3002on-failure:3\u3092\u4ed8\u3051\u3066\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run --restart=on-failure:3 busybox /bin/sh -c 'exit 0'\n[root@master1 ~]# echo $?\n0\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# docker ps -a\nCONTAINER ID      IMAGE        COMMAND                 CREATED           STATUS                     PORTS       NAMES\ne9bef69f4b79      busybox      \"/bin/sh -c 'exit 0'\"   9 seconds ago   \u2605Exited (0) 7 seconds ago               sick_davinci\n\ndocker events\u3092\u78ba\u8a8d\u3059\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u304c\u518d\u8d77\u52d5\u3057\u3066\u3044\u306a\u3044\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# docker events |grep -e start -e die\n2016-12-06T22:23:51.403847392+09:00 container start e9bef69f4b79595cfac312c39550e567229c44f5569de009f565b8b6dea38967 (image=busybox, name=sick_davinci)\n2016-12-06T22:23:52.449435115+09:00 container die e9bef69f4b79595cfac312c39550e567229c44f5569de009f565b8b6dea38967 (image=busybox, name=sick_davinci)\n\u4ee5\u4e0b\u3001\u4f55\u3082\u51fa\u529b\u3055\u308c\u306a\u3044\u3002\n\n\n------------------------------------------------------\n3. --restart=no(\u30c7\u30d5\u30a9\u30eb\u30c8\uff09\u306e\u52d5\u4f5c\u3092\u78ba\u8a8d\u3059\u308b\u3002\n------------------------------------------------------\ndocker events\u3092\u5b9f\u884c\u3059\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u306e\u958b\u59cb\u3001\u7d42\u4e86\u306e\u30a4\u30d9\u30f3\u30c8\u3092\u5f97\u308b\u305f\u3081\u3001grep\u3067\u7d5e\u308a\u8fbc\u3080\u3002\n[root@master1 ~]# docker events |grep -e start -e die\n\n\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3092\u958b\u304f\u3002\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run busybox /bin/sh -c 'exit 1'\n[root@master1 ~]# echo $?\n1\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# docker ps -a\nCONTAINER ID       IMAGE       COMMAND                 CREATED            STATUS                      PORTS         NAMES\naf4d7b72ebf7       busybox     \"/bin/sh -c 'exit 1'\"   16 seconds ago   \u2605Exited (1) 14 seconds ago                 big_mirzakhani\n\ndocker events\u3092\u78ba\u8a8d\u3059\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u304c\u518d\u8d77\u52d5\u3057\u3066\u3044\u306a\u3044\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# docker events |grep -e start -e die\n2016-12-06T22:17:32.421207276+09:00 container start af4d7b72ebf78122596b9c90370f1511bf9e454a272e2940f80fed0cc5af9243 (image=busybox, name=big_mirzakhani)\n2016-12-06T22:17:33.363000228+09:00 container die af4d7b72ebf78122596b9c90370f1511bf9e454a272e2940f80fed0cc5af9243 (image=busybox, name=big_mirzakhani)\n\u4ee5\u4e0b\u3001\u4f55\u3082\u51fa\u529b\u3055\u308c\u306a\u3044\u3002\n\n```\n\n\n##3.34 \u4e00\u822c\u30e6\u30fc\u30b6\u6a29\u9650\u3067\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\uff08\u305f\u3060\u3057\u8d77\u52d5\u3057\u305f\u30b3\u30f3\u30c6\u30ca\u306f\u7279\u6a29\u30e6\u30fc\u30b6\u6a29\u9650\u3067\u52d5\u4f5c\uff09\n<a href=\"https://docs.docker.com/engine/installation/linux/ubuntulinux/\">Docker-docs-ja\u53c2\u7167</a>\n\n```\n-----------------------------------------------------\n1. \u6e96\u5099(\u7279\u6a29\u30e6\u30fc\u30b6(root)\u3067\u884c\u3046)\n-----------------------------------------------------\ngroup\u3092\u78ba\u8a8d\u3059\u308b\u3002docker\u30b0\u30eb\u30fc\u30d7\u306f\u5b58\u5728\u3057\u306a\u3044\u3002\n[root@master1 ~]# cat /etc/group|grep docker\ndockerroot:x:993:\n\ndocker\u30b0\u30eb\u30fc\u30d7\u3092\u8ffd\u52a0\u3059\u308b\u3002\n[root@master1 ~]# groupadd docker\n\ngroup\u3092\u78ba\u8a8d\u3059\u308b\u3002docker\u30b0\u30eb\u30fc\u30d7\u304c\u8ffd\u52a0\u3055\u308c\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# cat /etc/group|grep docker\ndockerroot:x:993:\ndocker:x:1002:\n\n\u30e6\u30fc\u30b6\u3092\u8ffd\u52a0\u3059\u308b\u3002\n[root@master1 ~]# adduser hana_shin\n[root@master1 ~]# passwd hana_shin\n\ndocker\u30b0\u30eb\u30fc\u30d7\u306b\u30e6\u30fc\u30b6(hana_shin)\u3092\u8ffd\u52a0\u3059\u308b\u3002\n[root@master1 ~]# usermod -aG docker hana_shin\n[root@master1 ~]# cat /etc/group|grep docker\ndockerroot:x:993:\ndocker:x:1002:hana_shin\n\nDocker\u3092\u518d\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# systemctl restart docker\n[root@master1 ~]#\n\n-----------------------------------------------------\n2. \u4e00\u822c\u30e6\u30fc\u30b6\u6a29\u9650\u3067Docker\u3092\u8d77\u52d5\u3059\u308b\u3002\n-----------------------------------------------------\n\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3088\u308a\u3001\u4e00\u822c\u30e6\u30fc\u30b6\u3067\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u3002\n[hana_shin@master1 ~]$\n[hana_shin@master1 ~]$ id\nuid=1001(hana_shin) gid=1001(hana_shin) groups=1001(hana_shin),1002(docker) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[hana_shin@master1 ~]$ docker run -it --name test-con centos:centos7 bash\n\nCtrl\u3092\u62bc\u4e0b\u3057\u306a\u304c\u3089\u3001P\u30ad\u30fc\u3068Q\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u3066\u3001\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u629c\u3051\u308b\u3002\n[root@f1e13169655f /]# [hana_shin@master1 ~]$\n\n\u30db\u30b9\u30c8\u3067\u3001\u30b3\u30f3\u30c6\u30ca\u306e\u30e6\u30fc\u30b6ID\u7b49\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[hana_shin@master1 ~]$ CID=$(docker ps --no-trunc=true|grep \"test-con\"|awk '{print $1}')\n[hana_shin@master1 ~]$ PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u4e00\u822c\u30e6\u30fc\u30b6(hana_shin)\u6a29\u9650\u3067\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3067\u304d\u305f\u3002\n[hana_shin@master1 ~]$ ps -p $PID -o comm,pid,ppid,uid,euid\nCOMMAND            PID   PPID   UID  EUID\nbash              2079   1655     0     0\n\n\u89aa\u30d7\u30ed\u30bb\u30b9\u3092\u78ba\u8a8d\u3059\u308b\u3002\u89aa\u30d7\u30ed\u30bb\u30b9\u306fdocker-current\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[hana_shin@master1 ~]$ ps -p 1655 -o comm,pid,ppid,uid,euid\nCOMMAND            PID   PPID   UID  EUID\ndocker-current    1655      1     0     0\n\n\u5f8c\u59cb\u672b\u3002\u30b3\u30f3\u30c6\u30ca\u3092\u7d42\u4e86\u3059\u308b\u3002\n[hana_shin@master1 ~]$ docker stop f1e13169655f\nf1e13169655f\n[hana_shin@master1 ~]$ docker ps -a\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                       PORTS               NAMES\nf1e13169655f        centos:centos7      \"bash\"              16 minutes ago      Exited (137) 3 seconds ago                       test-con\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u524a\u9664\u3059\u308b\u3002\n[hana_shin@master1 ~]$ docker rm f1e13169655f\nf1e13169655f\n[hana_shin@master1 ~]$\n\n-----------------------------------------------------\n3. \u5f8c\u59cb\u672b\uff08\u30b0\u30eb\u30fc\u30d7\u304b\u3089\u30e6\u30fc\u30b6\u3092\u524a\u9664\u3059\u308b\uff09\n-----------------------------------------------------\n[root@master1 ~]# gpasswd -d hana_shin docker\n\u30e6\u30fc\u30b6 hana_shin \u3092\u30b0\u30eb\u30fc\u30d7 docker \u304b\u3089\u524a\u9664\n[root@master1 ~]# cat /etc/group|grep docker\ndockerroot:x:993:\ndocker:x:1002:\n\n```\n\n\n\n##3.35 userns-remap\uff08\u4f7f\u3044\u65b9\u304c\u3044\u307e\u3044\u3061\u308f\u304b\u3089\u306a\u3044\u3002\u3002\uff09\n--userns-remap \u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u6307\u5b9a\u3059\u308b\u3053\u3068\u3067\u3001 /etc/subuid \u3068 /etc/subguid \u30d5\u30a1\u30a4\u30eb\u304c\u30e6\u30fc\u30b6\u3068\u30aa\u30d7\u30b7\u30e7\u30f3\u306e\u30b0\u30eb\u30fc\u30d7\u7528\u306b\u4f7f\u308f\u308c\u307e\u3059\u3002\n\n<a href=\"https://blog.yadutaf.fr/2016/04/14/docker-for-your-users-introducing-user-namespace/\">Docker for your users - Introducing user namespace/a>\n<a href=\"https://docs.oracle.com/cd/E37670_01/E75728/html/ol-docker-userns-remap.html\">Oracle\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8</a>\n\n\n```\n\n------------------------------------------------------------------------\n1. \u6e96\u5099(CentOS7.2\u4ee5\u4e0a\u304c\u5fc5\u8981)\n------------------------------------------------------------------------\n[root@master1 ~]# uname -r\n3.10.0-327.36.3.el7.x86_64\n\ndocker\u5b9a\u7fa9\u30d5\u30a1\u30a4\u30eb\u3092\u7de8\u96c6\u3059\u308b\u3002\"--userns-remap=default\"\u3092\u8ffd\u52a0\u3059\u308b\u3002\n[root@master1 ~]# vi /etc/sysconfig/docker\nOPTIONS='--userns-remap=default'\n\n--userns-remap=default\u3092\u6307\u5b9a\u3059\u308b\u3068\u3001dockremap\u3068\u3044\u3046\u30e6\u30fc\u30b6\u3068\u30b0\u30eb\u30fc\u30d7\u304c\u3064\u304f\u308c\u308b\u306e\u3067\n\u305d\u308c\u305e\u308c\u306eID\u3092\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306b\u5b9a\u7fa9\u3057\u3066\u304a\u304f\u3002\n[root@master1 ~]# echo dockremap:500000:65536 > /etc/subuid\n[root@master1 ~]# echo dockremap:500000:65536 > /etc/subgid\n\n\u30ab\u30fc\u30cd\u30eb\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u30d1\u30e9\u30e1\u30fc\u30bf(user_namespace.enable=1)\u3092\u8ffd\u52a0\u3059\u308b\u3002\n[root@master1 ~]# vi /etc/sysconfig/grub\nGRUB_CMDLINE_LINUX=\"rhgb quiet biosdevname=0 net.ifnames=0 user_namespace.enable=1\"\n\n\u8a2d\u5b9a\u3092\u6709\u52b9\u306b\u3059\u308b\u3002\n[root@master1 ~]# grub2-mkconfig -o /boot/grub2/grub.cfg\nGenerating grub configuration file ...\nFound linux image: /boot/vmlinuz-3.10.0-229.el7.x86_64\nFound initrd image: /boot/initramfs-3.10.0-229.el7.x86_64.img\nFound linux image: /boot/vmlinuz-0-rescue-f9ce816285894f709c0fd8ecf27b8212\nFound initrd image: /boot/initramfs-0-rescue-f9ce816285894f709c0fd8ecf27b8212.img\ndone\n\n\u30ab\u30fc\u30cd\u30eb\u3092\u518d\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# shutdown -r now\n\n------------------------------------------------------------------------\n2. \u30ab\u30fc\u30cd\u30eb\u518d\u8d77\u52d5\u5f8c\n------------------------------------------------------------------------\n\u30ab\u30fc\u30cd\u30eb\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u78ba\u8a8d\u3059\u308b\u3002\u898b\u3084\u3059\u304f\u3059\u308b\u305f\u3081\u9014\u4e2d\u3067\u6298\u308a\u8fd4\u3057\u3066\u3044\u307e\u3059\u3002\n[root@master1 ~]# cat /proc/cmdline\nBOOT_IMAGE=/vmlinuz-3.10.0-327.36.3.el7.x86_64 root=UUID=c2cb61fd-0e07-4e92-bd38-f76181d9be81 \n    ro rhgb quiet biosdevname=0 net.ifnames=0 user_namespace.enable=1 systemd.debug LANG=ja_JP.UTF-8\n\nDocker\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\u898b\u3084\u3059\u304f\u3059\u308b\u305f\u3081\u9014\u4e2d\u3067\u6298\u308a\u8fd4\u3057\u3066\u3044\u307e\u3059\u3002\n[root@master1 ~]# ps aux|grep docker\nroot       1066  2.9  3.2 586576 32460 ?        Ssl  18:26   0:09 /usr/bin/docker-current daemon \n  --exec-opt native.cgroupdriver=systemd \n  --userns-remap=default \n  --storage-opt dm.basesize=50G \n  --insecure-registry master1:12345\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -it --name test-con busybox sh\n/ # id\nuid=0(root) gid=0(root) groups=10(wheel)\n\n\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3092\u8d77\u52d5\u3059\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u306eUID\u3092\u78ba\u8a8d\u3059\u308b\u3002UID=500000\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# CID=$(docker ps --no-trunc=true|grep \"test-con\"|awk '{print $1}')\n[root@master1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n[root@master1 ~]# ps -p $PID -o comm,pid,ppid,uid,euid\nCOMMAND            PID   PPID   UID  EUID\nsh                1489   1067 500000 500000\n\n\u3042\u3068\u59cb\u672b\u3002\u30b3\u30f3\u30c6\u30ca\u3092\u524a\u9664\u3059\u308b\u3002\n[root@master1 ~]# docker rm -f test-con\ntest-con\n\n-----------------------------------------------------\n3. UID,GID\u3092\u5909\u66f4\u3059\u308b\u3002\n-----------------------------------------------------\nUID\u3092\u5909\u66f4\u3059\u308b\u3002\n[root@master1 ~]# vi /etc/subuid\n[root@master1 ~]# cat /etc/subuid\ndockremap:510000:65536\n\nGID\u3092\u5909\u66f4\u3059\u308b\u3002\n[root@master1 ~]# vi /etc/subgid\n[root@master1 ~]# cat /etc/subgid\ndockremap:510000:65536\n\nDocker\u3092\u518d\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# systemctl restart docker\n[root@master1 ~]#\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\n[root@master1 ~]# docker run -it --name test-con busybox sh\n/ # id\nuid=0(root) gid=0(root) groups=10(wheel)\n\nCtrl\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u306a\u304c\u3089\u3001P\u30ad\u30fc\u3068Q\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b\u3002\n/ # [root@master1 ~]#\n\n\u30b3\u30f3\u30c6\u30ca\u306eUID\u3092\u78ba\u8a8d\u3059\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u304cUID=510000\u3067\u52d5\u4f5c\u3057\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# CID=$(docker ps --no-trunc=true|grep \"test-con\"|awk '{print $1}')\n[root@master1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n[root@master1 ~]# ps -p $PID -o comm,pid,ppid,uid,euid\nCOMMAND            PID   PPID   UID  EUID\nsh                4707   4540 510000 510000\n\n```\n\n\n\n##3.36 --user\u30aa\u30d7\u30b7\u30e7\u30f3\u306e\u4f7f\u3044\u65b9\n--user\u306b\u6307\u5b9a\u3059\u308b\u30e6\u30fc\u30b6(\u307e\u305f\u306fUID)\u306f\u3001\u30b3\u30f3\u30c6\u30ca\u5185\u306e\u30e6\u30fc\u30b6\uff08\u307e\u305f\u306fUID)\u3092\u6307\u5b9a\u3059\u308b\u3002\n\u4ee5\u4e0b\u306e\u4f8b\u3067\u306f\u3001centos7\u3068nginx\u306e\u30b3\u30f3\u30c6\u30ca\u3067\u306f\u3001daemon\u30e6\u30fc\u30b6\u306eUID\u304c\u9055\u3046\u3053\u3068\u3092\u793a\u3057\u3066\u3044\u308b\u3002\n\n```\n----------------------------------------------------\n1. centos7\u30b3\u30f3\u30c6\u30ca\u3067\u306f\u3001daemon\u30e6\u30fc\u30b6\u306eUID\u306f2\u3002\n----------------------------------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -it --user=daemon:daemon --name test-con centos:centos7 bash\n\nUID\u3092\u78ba\u8a8d\u3059\u308b\u3002UID=2\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\nbash-4.2$ id\nuid=2(daemon) gid=2(daemon) groups=2(daemon)\n\npasswd\u30d5\u30a1\u30a4\u30eb\u3067UID\u3092\u78ba\u8a8d\u3059\u308b\u3002UID=2\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\nbash-4.2$ grep daemon /etc/passwd\ndaemon:x:2:2:daemon:/sbin:/sbin/nologin\n\nCtrl\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u306a\u304c\u3089P\u30ad\u30fc\u3068Q\u30ad\u30fc\u3092\u62bc\u3057\u3066\u3001\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u629c\u3051\u308b\u3002\nbash-4.2$ [root@master1 ~]#\n\n\u30b3\u30f3\u30c6\u30caID\u3092\u6c42\u3081\u308b\u3002\n[root@master1 ~]# CID=$(docker ps --no-trunc=true|grep -w \"test-con\"|awk '{print $1}')\n[root@master1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u30b3\u30f3\u30c6\u30ca\u306eUID\u3092\u6c42\u3081\u308b\u3002UID=2\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# ps -p $PID -o comm,pid,ppid,uid,euid\nCOMMAND            PID   PPID   UID  EUID\nbash              6396   1028   \u26052     2\n\n----------------------------------------------------\n2. nginx\u30b3\u30f3\u30c6\u30ca\u3067\u306f\u3001daemon\u30e6\u30fc\u30b6\u306eUID\u306f1\u3002\n----------------------------------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -it --user=daemon:daemon --name test-con nginx bash\n\nUID\u3092\u78ba\u8a8d\u3059\u308b\u3002UID=1\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\ndaemon@6acee3f32043:/$ id\nuid=1(daemon) gid=1(daemon) groups=1(daemon)\n\npasswd\u30d5\u30a1\u30a4\u30eb\u3067UID\u3092\u78ba\u8a8d\u3059\u308b\u3002UID=1\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\ndaemon@929d7b11ba72:/$ grep daemon /etc/passwd\ndaemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin\n\nCtrl\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u306a\u304c\u3089P\u30ad\u30fc\u3068Q\u30ad\u30fc\u3092\u62bc\u3057\u3066\u3001\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u629c\u3051\u308b\u3002\n/ $ [root@master1 ~]#\n\n\u30b3\u30f3\u30c6\u30caID\u3092\u6c42\u3081\u308b\u3002\n[root@master1 ~]# CID=$(docker ps --no-trunc=true|grep -w \"test-con\"|awk '{print $1}')\n[root@master1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u30b3\u30f3\u30c6\u30ca\u306eUID\u3092\u6c42\u3081\u308b\u3002UID=1\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# ps -p $PID -o comm,pid,ppid,uid,euid\nCOMMAND            PID   PPID   UID  EUID\nsh                6957   1028   \u26051     1\n\n```\n\n\n##3.37 \u30b3\u30f3\u30c6\u30ca\u306e\u60c5\u5831\u3092\u6574\u5f62\u3057\u3066\u51fa\u529b\u3059\u308b\u65b9\u6cd5(--format)\n\nhttp://docs.docker.jp/engine/reference/commandline/ps.html\n\n```\n[root@master1 ~]# docker ps --format \"table {{.ID}}\\t{{.Status}}\\t{{.Image}}\"\nCONTAINER ID        STATUS              IMAGE\n847c578f3c8f        Up About a minute   gcr.io/google_containers/skydns:2015-03-11-001\n517e07f64736        Up 4 minutes        gcr.io/google_containers/kube2sky:1.11\ncca839d03bac        Up 28 minutes       nginx\n27727fcf9348        Up 28 minutes       registry.access.redhat.com/rhel7/pod-infrastructure:latest\nbdefbe6a6e33        Up 28 minutes       nginx\n4bbd8a95cc0f        Up 28 minutes       registry.access.redhat.com/rhel7/pod-infrastructure:latest\n\n```\n\n\n\n##3.38 dokcer\u30a4\u30e1\u30fc\u30b8\u304b\u3089Pod\u3092\u8d77\u52d5\u3059\u308b\n\n\n```\nDockerfile\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 dockerfile]# vi Dockerfile\n[root@master1 dockerfile]# cat Dockerfile\nFROM centos:centos7\nRUN useradd user1\nUSER user1\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 dockerfile]# docker build -t hana/test-img:v1 --no-cache=true .\nSending build context to Docker daemon 3.072 kB\n-\u4ee5\u4e0b\u3001\u7565-\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 dockerfile]# docker images hana/test-img:v1\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nhana/test-img       v1                  d8de1bc46638        43 seconds ago      196.5 MB\n\nPod\u5b9a\u7fa9\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 dockerfile]# vi test.yaml\n[root@master1 dockerfile]# cat test.yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  name: test\nspec:\n  restartPolicy: Never\n  containers:\n  - name: test\n    image: hana/test-img:v1\n    command: [\"sleep\", \"3600\"]\n\nPod\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 dockerfile]# kubectl create -f test.yaml\npod \"test\" created\n\nPod\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 dockerfile]# kubectl get pod\nNAME      READY     STATUS    RESTARTS   AGE\ntest      1/1       Running   0          7s\n\nPod\u3067bash\u3092\u5b9f\u884c\u3059\u308b\u3002\n[root@master1 dockerfile]# kubectl exec -it test bash\n[user1@test /]$ id\nuid=1000(user1) gid=1000(user1) groups=1000(user1)\n[user1@test /]$ cat /etc/redhat-release\nCentOS Linux release 7.2.1511 (Core)\n[user1@test /]$\n\n```\n\n\n##3.39 \u30b3\u30f3\u30c6\u30ca\u306eGUI\u3092\u5229\u7528\u3059\u308b\u3002\n\u4e0a\u624b\u304f\u3044\u304b\u306a\u3044\u3002\u3002\u3002\n\n```\n\nDockerfile\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 dockergui]# vi Dockerfile\n[root@master1 dockergui]# cat Dockerfile\nFROM centos:centos7.2.1511\nRUN yum -y install firefox\nRUN groupadd -g 2002 guiuser\nRUN useradd -d /home/guiuser -s /bin/bash -m guiuser -u 2002 -g 2002\nUSER guiuser\nENV HOME /home/guiuser\nCMD /usr/bin/firefox\n\n\u30e6\u30fc\u30b6\u3092\u8ffd\u52a0\u3059\u308b\u3002\n[root@master1 dockergui]# adduser guiuser\n[root@master1 dockergui]# cat /etc/passwd|grep guiuser\nguiuser:x:2002:2002::/home/guiuser:/bin/bash\n[root@master1 dockergui]# cat /etc/group|grep guiuser\nguiuser:x:2002:\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 dockergui]# docker build -t gui .\nSending build context to Docker daemon 2.048 kB\nStep 1 : FROM centos:centos7.2.1511\n ---> feac5e0dfdb2\nStep 2 : RUN yum -y install firefox\n ---> Running in 5e3c45a8b3e8\nLoaded plugins: fastestmirror\n\n-\u4e2d\u7565-\n\nComplete!\n ---> 5edd4cd2c3c9\nRemoving intermediate container 5e3c45a8b3e8\nStep 3 : RUN groupadd -g 2002 guiuser\n ---> Running in 27c81dd37230\n ---> 93a3a4a1b09d\nRemoving intermediate container 27c81dd37230\nStep 4 : RUN useradd -d /home/guiuser -s /bin/bash -m guiuser -u 2002 -g 2002\n ---> Running in 127631b45428\n ---> afa1633e5c1c\nRemoving intermediate container 127631b45428\nStep 5 : USER guiuser\n ---> Running in f6be57dabc5b\n ---> 3110bf85d8fb\nRemoving intermediate container f6be57dabc5b\nStep 6 : ENV HOME /home/guiuser\n ---> Running in 27a5cdd1c695\n ---> d5700b8b5316\nRemoving intermediate container 27a5cdd1c695\nStep 7 : CMD /usr/bin/firefox\n ---> Running in 0df2f2d03910\n ---> fcf6a8321176\nRemoving intermediate container 0df2f2d03910\nSuccessfully built fcf6a8321176\n\n[root@master1 dockergui]# docker images gui\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\ngui                 latest              fcf6a8321176        58 seconds ago      421.9 MB\n\n[root@master1 dockergui]# docker run -v /tmp/.X11-unix:/tmp/.X11-unix -e DISPLAY=$DISPLAY -h $HOSTNAME -v $HOME/.Xauthority:/home/$USER/.Xauthority gui\nError: cannot open display:\n\n```\n\n\n\n##3.xx \u4eee\u60f3\u5316\u74b0\u5883\u3067\u5229\u7528\u3057\u3066\u3044\u308b\u30b2\u30b9\u30c8OS\u306e\u30a4\u30e1\u30fc\u30b8\u3092Docker\u74b0\u5883\u3078\u306e\u79fb\u690d\n\n```\n1.virt-tar-out\u3092\u4f7f\u3063\u3066\u3001qcow2\u3092\u5727\u7e2e\u30d5\u30a1\u30a4\u30eb(tgz)\u306b\u5909\u63db\n2.docker import\u3092\u4f7f\u3063\u3066\u3001\u5727\u7e2e\u30d5\u30a1\u30a4\u30eb(tgz)\u3092\u30a4\u30e1\u30fc\u30b8\u306b\u5909\u63db\n\n```\n\n\n\n\n#4 Dockerfile\n##4.1 CMD (\u30b3\u30f3\u30c6\u30ca\u8d77\u52d5\u6642\u306b\u81ea\u52d5\u7684\u306b\u5b9f\u884c\u3059\u308b\u30b3\u30de\u30f3\u30c9\u3092\u6307\u5b9a\u3059\u308b)\n\n<A Href=\"http://docs.docker.jp/engine/reference/builder.html#cmd\">Dockerfile \u30ea\u30d5\u30a1\u30ec\u30f3\u30b9</A>\u3088\u308a\u629c\u7c8b\n> Dockerfile \u3067 CMD \u547d\u4ee4\u3092\u4e00\u5ea6\u3060\u3051\u6307\u5b9a\u3067\u304d\u307e\u3059\u3002\u8907\u6570\u306e CMD \u304c\u3042\u308b\u5834\u5408\u3001\u6700\u3082\u5f8c\u308d\u306e CMD \u306e\u307f\u6709\u52b9\u3067\u3059\u3002\n\n\n```\n---------------------------------------------------\n1. CMD [\"-a\"] -> CMD [\"-r\"]\u306e\u9806\u756a\n---------------------------------------------------\n[root@master1 test2]# vi Dockerfile\n[root@master1 test2]# cat Dockerfile\nFROM centos:centos7\nENTRYPOINT [\"/usr/bin/uname\"]\nCMD [\"-a\"]\nCMD [\"-r\"]\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 test2]# docker build -t test-img:ver1 --no-cache=true .\n-\u4e2d\u7565 -\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002uname -r\u304c\u5b9f\u884c\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 test2]# docker run --rm test-img:ver1\n3.10.0-229.el7.x86_64\n\n\n---------------------------------------------------\n2. \u9806\u756a\u3092\u5165\u308c\u66ff\u3048\u308b( CMD [\"-r\"] -> CMD [\"-a\"])\n---------------------------------------------------\nDockerfile\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 test2]# vi Dockerfile\n[root@master1 test2]# cat Dockerfile\nFROM centos:centos7\nENTRYPOINT [\"/usr/bin/uname\"]\nCMD [\"-r\"]\nCMD [\"-a\"]\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 test2]# docker build -t test-img:ver1 --no-cache=true .\n-\u4e2d\u7565 -\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002uname -a\u304c\u5b9f\u884c\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 test2]# docker run --rm test-img:ver1\nLinux bafbe7f69bb2 3.10.0-229.el7.x86_64 #1 SMP Fri Mar 6 11:36:42 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux\n\n```\n\n\n\n##4.2 CMD\u3068ENTRYPOINT\u306e\u4f7f\u3044\u65b9\n\nCMD\u3082ENTRYPOINT\u3082\u30b3\u30f3\u30c6\u30ca\u8d77\u52d5\u6642\u306b\u81ea\u52d5\u7684\u306b\u5b9f\u884c\u3059\u308b\u30b3\u30de\u30f3\u30c9\u3092\u6307\u5b9a\u3059\u308b\u3002\n\u30b3\u30f3\u30c6\u30ca\u8d77\u52d5\u6642\u306b\u5b9f\u884c\u3059\u308b\u30b3\u30de\u30f3\u30c9\u3092ENTRYPOINT\u306b\u6307\u5b9a\u3057\u3066\u3001\n\u3042\u3068\u304b\u3089\u5909\u66f4\u53ef\u80fd\u306a\u30b3\u30de\u30f3\u30c9\u306e\u5f15\u6570\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u5024\u3092CMD\u306b\u6307\u5b9a\u3059\u308b\u3001\u3068\u3044\u3046\u3088\u3046\u306b\u4f7f\u3046\u3002\n\n```\n--------------------------------------------------------------\n1. CMD\u3067\u6307\u5b9a\u3057\u305f\u30b3\u30de\u30f3\u30c9\u5f15\u6570\u306f\u5909\u66f4\u53ef\u80fd\u3067\u3042\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u3002\n--------------------------------------------------------------\nDockerfile\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 test2]# vi Dockerfile\n[root@master1 test2]# cat Dockerfile\nFROM centos:centos7\nENTRYPOINT [\"/usr/bin/uname\"]\nCMD [\"-a\"]\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 test2]# docker build -t test-img:ver1 .\n-\u4e2d\u7565-\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u306e\u8d77\u52d5\u30d1\u30e9\u30e1\u30fc\u30bf\u306b\u4f55\u3082\u6307\u5b9a\u3057\u306a\u304b\u308c\u3070\u3001uname -a\u304c\u5b9f\u884c\u3055\u308c\u308b\u3002\n[root@master1 test2]# docker run --rm test-img:ver1\nLinux 9496baeb4980 3.10.0-229.el7.x86_64 #1 SMP Fri Mar 6 11:36:42 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux\n\n\u8d77\u52d5\u30d1\u30e9\u30e1\u30fc\u30bf(uname -r\u306e\"-r\")\u3092\u6307\u5b9a\u3057\u3066\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002uname -r\u304c\u5b9f\u884c\u3055\u308c\u308b\u3002\n\u3064\u307e\u308a\u3001CMD [\"-a\"]\u304c\u4e0a\u66f8\u304d\u3055\u308c\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 test2]# docker run --rm test-img:ver1 -r\n3.10.0-229.el7.x86_64\n\n\n--------------------------------------------------------------\n2. ENTRYPOINT\u3067\u6307\u5b9a\u3057\u305f\u30b3\u30de\u30f3\u30c9\u5f15\u6570\u306f\u5909\u66f4\u4e0d\u53ef\u3067\u3042\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u3002\n--------------------------------------------------------------\nDockerfile\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 test2]# vi Dockerfile\n[root@master1 test2]# cat Dockerfile\nFROM centos:centos7\nENTRYPOINT [\"/usr/bin/uname\",\"-a\"]\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 test2]# docker build -t test-img:ver1 --no-cache=true .\n-\u4e2d\u7565-\n\n\u5f15\u6570\u306a\u3057\u3067\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 test2]# docker run --rm test-img:ver1\nLinux 4a7180accb88 3.10.0-229.el7.x86_64 #1 SMP Fri Mar 6 11:36:42 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux\n\n\u5f15\u6570\u3042\u308a\u3067\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u3057\u304b\u3057\u3001\u5f15\u6570(-r)\u304c\u7121\u8996\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\nENTRYPOINT\u3067\u6307\u5b9a\u3057\u305f\u30b3\u30de\u30f3\u30c9\u5f15\u6570\u306f\u5909\u66f4\u3067\u304d\u306a\u3044\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 test2]# docker run --rm test-img:ver1 -r\nLinux 4b71de2fda69 3.10.0-229.el7.x86_64 #1 SMP Fri Mar 6 11:36:42 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux\n\n```\n\n\n##4.3 ADD\u3068COPY\u306e\u9055\u3044\nADD\u306f\u30a2\u30fc\u30ab\u30a4\u30d6\u30d5\u30a1\u30a4\u30eb\u3092\u5c55\u958b\u3057\u3066\u3057\u307e\u3046\u304c\u3001COPY\u306f\u5c55\u958b\u305b\u305a\u3001\u305d\u306e\u307e\u307e\u3092\u30a4\u30e1\u30fc\u30b8\u306b\u30b3\u30d4\u30fc\u3059\u308b\u3002\n\n```\n---------------------------------------------------------\n1. \u30a2\u30fc\u30ab\u30a4\u30d6\u30d5\u30a1\u30a4\u30eb\u306e\u6e96\u5099\n---------------------------------------------------------\n\u30d5\u30a1\u30a4\u30eb\u30922\u3064\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 test2]#  head -c 1000 /dev/urandom > a.txt\n[root@master1 test2]#  head -c 1000 /dev/urandom > b.txt\n\n\u30a2\u30fc\u30ab\u30a4\u30d6\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 test2]# tar cvfz test.tar.gz a.txt b.txt\na.txt\nb.txt\n\n\u4f5c\u6210\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 test2]# ls -lt\n\u5408\u8a08 12\n-rw-r--r--. 1 root root 2207 11\u6708 26 16:47 test.tar.gz\n-rw-r--r--. 1 root root 1000 11\u6708 26 16:47 b.txt\n-rw-r--r--. 1 root root 1000 11\u6708 26 16:47 a.txt\n\n---------------------------------------------------------\n2. ADD\u3092\u4f7f\u3063\u305f\u5834\u5408 (\u30a2\u30fc\u30ab\u30a4\u30d6\u304c\u5c55\u958b\u3055\u308c\u3066\u3057\u307e\u3046\uff09\n---------------------------------------------------------\nDockerfile\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 test2]# vi Dockerfile\n[root@master1 test2]# cat Dockerfile\nFROM centos:centos7\nRUN mkdir /opt/test\nADD test.tar.gz /opt/test/\nRUN ls -lRt /opt/test\n\n\u30ab\u30ec\u30f3\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u78ba\u8a8d\u3059\u308b\n[root@master1 test2]# ls\nDockerfile  a.txt  b.txt  test.tar.gz\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\u5727\u7e2e\u30d5\u30a1\u30a4\u30eb\u304c\u5c55\u958b\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 test2]# docker build -t test-img:ver1 .\nSending build context to Docker daemon 8.192 kB\nStep 1 : FROM centos:centos7\n ---> 0584b3d2cf6d\nStep 2 : RUN mkdir /opt/test\n ---> Running in f6129d2aa4c3\n ---> af19cbd77e74\nRemoving intermediate container f6129d2aa4c3\nStep 3 : ADD test.tar.gz /opt/test/\n ---> c21b8d439958\nRemoving intermediate container e6810a0aabec\nStep 4 : RUN ls -lRt /opt/test\n ---> Running in 9b751e97e690\n/opt/test:\ntotal 8\n-rw-r--r--. 1 root root 1000 Nov 26 07:47 b.txt  <=== \u30a2\u30fc\u30ab\u30a4\u30d6\u304c\u5c55\u958b\u3055\u308c\u305f\u3002\n-rw-r--r--. 1 root root 1000 Nov 26 07:47 a.txt  <=== \u30a2\u30fc\u30ab\u30a4\u30d6\u304c\u5c55\u958b\u3055\u308c\u305f\u3002\n ---> 995292e70c54\nRemoving intermediate container 9b751e97e690\nSuccessfully built 995292e70c54\n\n\u30b3\u30f3\u30c6\u30ca\u306b\u5165\u3063\u3066\u78ba\u8a8d\u3059\u308b\u3002\u5727\u7e2e\u30d5\u30a1\u30a4\u30eb\u304c\u5c55\u958b\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 test2]# docker run -it --rm test-img:ver1 bash\n[root@16fc609ba268 /]# cd /opt/test/\n[root@16fc609ba268 test]# ls -lt\ntotal 8\n-rw-r--r--. 1 root root 1000 Nov 26 07:47 b.txt   <=== \u30a2\u30fc\u30ab\u30a4\u30d6\u304c\u5c55\u958b\u3055\u308c\u305f\u3002\n-rw-r--r--. 1 root root 1000 Nov 26 07:47 a.txt   <=== \u30a2\u30fc\u30ab\u30a4\u30d6\u304c\u5c55\u958b\u3055\u308c\u305f\u3002\n\n\n---------------------------------------------------------\n3. COPY\u3092\u4f7f\u3063\u305f\u5834\u5408 (\u30a2\u30fc\u30ab\u30a4\u306f\u5c55\u958b\u3055\u308c\u306a\u3044\uff09\n---------------------------------------------------------\n[root@master1 test2]# vi Dockerfile\n[root@master1 test2]# cat Dockerfile\nFROM centos:centos7\nRUN mkdir /opt/test\nCOPY test.tar.gz /opt/test/\nRUN ls -lRt /opt/test\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\u30a2\u30fc\u30ab\u30a4\u30d6\u306f\u5c55\u958b\u3055\u308c\u306a\u3044\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 test2]# docker build -t test-img:ver1 .\nSending build context to Docker daemon 8.192 kB\nStep 1 : FROM centos:centos7\n ---> 0584b3d2cf6d\nStep 2 : RUN mkdir /opt/test\n ---> Running in 9acb716ae732\n ---> a9f38033cf21\nRemoving intermediate container 9acb716ae732\nStep 3 : COPY test.tar.gz /opt/test/\n ---> 47f2b98dee82\nRemoving intermediate container b7129e471f34\nStep 4 : RUN ls -lRt /opt/test\n ---> Running in 175575dda529\n/opt/test:\ntotal 4\n-rw-r--r--. 1 root root 2207 Nov 26 07:47 test.tar.gz  <=== \u30a2\u30fc\u30ab\u30a4\u30d6\u306f\u5c55\u958b\u3055\u308c\u306a\u3044\u3002\n ---> 2b55986f826b\nRemoving intermediate container 175575dda529\nSuccessfully built 2b55986f826b\n\n\u30b3\u30f3\u30c6\u30ca\u306b\u5165\u3063\u3066\u78ba\u8a8d\u3059\u308b\u3002\u30a2\u30fc\u30ab\u30a4\u30d6\u30d5\u30a1\u30a4\u30eb\u304c\u5c55\u958b\u3055\u308c\u306a\u3044\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 test2]# docker run -it --rm test-img:ver1 bash\n[root@1dc516c1a917 /]# cd /opt/test/\n[root@1dc516c1a917 test]# ls -lt\ntotal 4\n-rw-r--r--. 1 root root 2207 Nov 26 07:47 test.tar.gz  <=== \u30a2\u30fc\u30ab\u30a4\u30d6\u306f\u5c55\u958b\u3055\u308c\u306a\u3044\n\n\n---------------------------------------------------------------------------------\n4. ADD\u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u3063\u3066\u3001\u30a4\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8\u4e0a\u306e\u30a2\u30fc\u30ab\u30a4\u30d6\u30d5\u30a1\u30a4\u30eb\u3092\u30a4\u30e1\u30fc\u30b8\u306b\u8ffd\u52a0\u3059\u308b\n   COPY\u30b3\u30de\u30f3\u30c9\u3067\u306f\u3067\u304d\u306a\u3044\u3002\n---------------------------------------------------------------------------------\nDockerfile\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 test2]# vi Dockerfile\n[root@master1 test2]# cat Dockerfile\nFROM centos:centos7\nRUN mkdir /opt/test\nADD http://tamacom.com/global/global-6.5.5.tar.gz /opt/test/\nRUN ls -lRt /opt/test\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 test2]# docker build -t test-img:ver1 .\nSending build context to Docker daemon 2.048 kB\nStep 1 : FROM centos:centos7\n ---> 0584b3d2cf6d\nStep 2 : RUN mkdir /opt/test\n ---> Using cache\n ---> a9f38033cf21\nStep 3 : ADD http://tamacom.com/global/global-6.5.5.tar.gz /opt/test/\nDownloading [==================================================>] 2.935 MB/2.935 MB\n ---> 74f57a040737\nRemoving intermediate container ffba4d6a3c60\nStep 4 : RUN ls -lRt /opt/test\n ---> Running in db028ae06a11\n/opt/test:\ntotal 2868\n-rw-------. 1 root root 2934542 Sep 21 04:57 global-6.5.5.tar.gz  <===\u30a2\u30fc\u30ab\u30a4\u30d6\u304c\u8ffd\u52a0\u3055\u308c\u305f\u3002\n ---> d4c6f9b643ea\nRemoving intermediate container db028ae06a11\nSuccessfully built d4c6f9b643ea\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 test2]# docker run -it --rm test-img:ver1 bash\n\n\u30a4\u30e1\u30fc\u30b8\u306b\u8ffd\u52a0\u3057\u305f\u30a2\u30fc\u30ab\u30a4\u30d6\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@d05a61cfe82f /]# cd /opt/test/\n[root@d05a61cfe82f test]# ls -lt\ntotal 2868\n-rw-------. 1 root root 2934542 Sep 21 04:57 global-6.5.5.tar.gz\n\n```\n\n\n##4.4 LABEL(\u30a4\u30e1\u30fc\u30b8\u306b\u30b3\u30e1\u30f3\u30c8\u3084\u30d0\u30fc\u30b8\u30e7\u30f3\u60c5\u5831\u3092\u3064\u3051\u308b\uff09\n\n```\nDockerfile\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 test2]# cat Dockerfile\nFROM centos:centos7\nLABEL title=\"Test image\"\nLABEL version=\"1.0\"\nLABEL descriptuon=\"This is test\"\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 test2]# docker build -t test-img:ver1 --no-cache=true .\n-\u4e2d\u7565-\n\n\u30a4\u30e1\u30fc\u30b8\u306e\u4e2d\u8eab\u3092\u8abf\u3079\u308b\u3002\u30b3\u30e1\u30f3\u30c8\u7b49\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n[root@master1 test2]# docker inspect --format=\"{{ .Config.Labels }}\" test-img:ver1\nmap[build-date:20161102 descriptuon:This is test license:GPLv2 name:CentOS Base Image title:Test image vendor:CentOS version:1.0]\n\n```\n\n\n##4.5 WORKDIR(\u4f5c\u696d\u7528\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u6307\u5b9a\u3059\u308b\u3002\uff09\n\n```\n-----------------------------------------------\n1. \u7d76\u5bfe\u30d1\u30b9\u306e\u3042\u3068\u306b\u76f8\u5bfe\u30d1\u30b9\u3092\u4f7f\u3063\u305f\u5834\u5408\n-----------------------------------------------\n[root@master1 test2]# vi Dockerfile\n[root@master1 test2]# cat Dockerfile\nFROM centos:centos7\nWORKDIR /first\nWORKDIR second\nWORKDIR third\nCMD [\"pwd\"]\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 test2]# docker build -t test-img:ver1 --no-cache=true .\n-\u4ee5\u4e0b\u3001\u7565-\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 test2]# docker run --rm test-img:ver1\n/first/second/third\n\n-----------------------------------------------\n2. \u7d76\u5bfe\u30d1\u30b9\u3092\u7d9a\u3051\u3066\u4f7f\u3063\u305f\u5834\u5408\n-----------------------------------------------\n[root@master1 test2]# vi Dockerfile\n[root@master1 test2]# cat Dockerfile\nFROM centos:centos7\nWORKDIR /first\nWORKDIR /second\nWORKDIR /third\nCMD [\"pwd\"]\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 test2]# docker build -t test-img:ver1 --no-cache=true .\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 test2]# docker run --rm test-img:ver1\n/third\n\n```\n\n\n##4.6 USER(USER\u4ee5\u964d\u306e\u30b3\u30de\u30f3\u30c9\u3092USER\u6a29\u9650\u3067\u5b9f\u884c\u3059\u308b\uff09\n\n\n```\n----------------------------------------------------\n1. \u30db\u30b9\u30c8\u3067\u30e6\u30fc\u30b6(hana_shin)\u3092\u4f5c\u6210\u3059\u308b\u3002\n----------------------------------------------------\n[root@master1 test]# useradd -u 2000 hana_shin\n[root@master1 test]# grep hana_shin /etc/passwd\nhana_shin:x:2000:2000::/home/hana_shin:/bin/bash\n[root@master1 test]# grep hana_shin /etc/group\nhana_shin:x:2000:\n\n----------------------------------------------------\n2. \u30b3\u30f3\u30c6\u30ca\u3067\u30db\u30b9\u30c8\u3068\u540c\u3058\u30e6\u30fc\u30b6(hana_shin)\u3092\u4f5c\u6210\u3059\u308b\u3002\n----------------------------------------------------\n[root@master1 test]# vi Dockerfile\n[root@master1 test]# cat Dockerfile\nFROM centos:centos7\nRUN useradd -u 2000 hana_shin\nUSER hana_shin\nCMD tail -f /dev/null\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 test]# docker build -t test-img:ver1 --no-cache=true .\n-\u4ee5\u4e0b\u3001\u7565-\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 test]# docker run -it --rm --name test-con test-img:ver1 bash\n\nUID\u3092\u78ba\u8a8d\u3059\u308b\u3002UID=2000\u306e\u30e6\u30fc\u30b6\u304c\u4f5c\u6210\u3067\u304d\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[hana_shin@4fbb369c1d2d /]$ id\nuid=2000(hana_shin) gid=2000(hana_shin) groups=2000(hana_shin)\n\n[hana_shin@4fbb369c1d2d /]$ grep hana_shin /etc/passwd\nhana_shin:x:2000:2000::/home/hana_shin:/bin/bash\n\n----------------------------------------------------\n3. \u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3067\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n----------------------------------------------------\n\u30b3\u30f3\u30c6\u30ca\u306e\u540d\u524d(test-con)\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# docker ps\nCONTAINER ID      IMAGE            COMMAND      CREATED           STATUS              PORTS         NAMES\n4fbb369c1d2d      test-img:ver1    \"bash\"       4 minutes ago     Up 4 minutes                      test-con\n\n\u30b3\u30f3\u30c6\u30caID\u3092\u6c42\u3081\u308b\u3002\n[root@master1 ~]# CID=$(docker ps --no-trunc=true|grep \"test-con\"|awk '{print $1}')\n\n\u30b3\u30f3\u30c6\u30ca\u306ePID\u3092\u6c42\u3081\u308b\u3002\n[root@master1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u30b3\u30f3\u30c6\u30ca\u306epid,uid\u7b49\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# ps -p $PID -o pid,ppid,uid,euid\n   PID   PPID   UID  EUID\n  3191   1028  2000  2000\n\n\u89aa\u30d7\u30ed\u30bb\u30b9\u3092\u78ba\u8a8d\u3059\u308b\u3002\u89aa\u30d7\u30ed\u30bb\u30b9\u306fdocker-current \u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# ps -p 1028 -o comm,pid,ppid,uid,euid\nCOMMAND            PID   PPID   UID  EUID\ndocker-current    1028      1     0     0\n\n\u30d7\u30ed\u30bb\u30b9\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# ps aux|grep hana\nhana_sh+   1480  0.0  0.0   4328   648 ?        Ss   19:35   0:00 /bin/sh -c tail -f /dev/null\nhana_sh+   1488  0.0  0.0   4260   352 ?        S    19:35   0:00 tail -f /dev/null\nhana_sh+   3191  0.0  0.1  11776  1904 pts/1    Ss+  19:59   0:00 bash\nroot       3916  0.0  0.0 112664   960 pts/2    S+   20:11   0:00 grep --color=auto hana\n\n```\n\n\n\n##4.7 ARG(\u30d3\u30eb\u30c9\u6642\u306e\u5f15\u6570\u3092\u6307\u5b9a\u3059\u308b)\n\u30d3\u30eb\u30c9\u6642\u306b\u5f15\u6570x\u3092\u6307\u5b9a\u3057\u305f\u3089\u30a4\u30e1\u30fc\u30b8X\u3001\u5f15\u6570y\u3092\u6307\u5b9a\u3057\u305f\u3089\u30a4\u30e1\u30fc\u30b8Y\u3001\u3068\u3044\u3046\u3088\u3046\u306b\u3001\n\u30d3\u30eb\u30c9\u6642\u306e\u5f15\u6570\u306b\u3057\u305f\u304c\u3063\u3066\u7570\u306a\u308b\u30a4\u30e1\u30fc\u30b8\u3092\u4f5c\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n###4.7.1 \u305d\u306e1 (ARG xxx=yyy \u3068\u5b9a\u7fa9\u3057\u305f\u5834\u5408)\n```\n--------------------------------------------------\n1. ARG\u3092\u4f7f\u3063\u305fDockerfile (\u4e0b\u8a182,3\u3067\u540c\u3058\u3082\u306e\u3092\u4f7f\u3046)\n--------------------------------------------------\n[root@node1 test]# vi Dockerfile\n[root@node1 test]# cat Dockerfile\nFROM centos:centos7\nARG user=nginx\nRUN useradd $user\nUSER $user\n\n----------------------------------------------------\n2. \u30d3\u30eb\u30c9\u6642\u306b\u5f15\u6570\u3092\u6307\u5b9a\u3057\u306a\u3044(--build-arg\u3092\u4f7f\u308f\u306a\u3044)\n----------------------------------------------------\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\u30a4\u30e1\u30fc\u30b8\u5185\u306b\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u306enginx\u30e6\u30fc\u30b6\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@node1 test]# docker build -t test-img:ver1 --no-cache=true .\nSending build context to Docker daemon 2.048 kB\n-\u4ee5\u4e0b\u3001\u7565-\n\n\u30e6\u30fc\u30b6\u3092\u78ba\u8a8d\u3059\u308b\u3002\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30e6\u30fc\u30b6\u540d(nginx)\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n[root@node1 test]# docker run -it --rm test-img:ver1 bash\n[nginx@a1a98aa3000d /]$ id\nuid=1000(nginx) gid=1000(nginx) groups=1000(nginx)\n\n----------------------------------------------------\n3. \u30d3\u30eb\u30c9\u6642\u306b\u5f15\u6570\u3092\u6307\u5b9a\u3059\u308b\u3002(--build-arg user=httpd)\n----------------------------------------------------\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\u30a4\u30e1\u30fc\u30b8\u5185\u306b\u3001\u5f15\u6570\u3067\u6307\u5b9a\u3057\u305fhttpd\u30e6\u30fc\u30b6\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@node1 test]# docker build -t test-img:ver1 --no-cache=true --build-arg user=httpd .\nSending build context to Docker daemon 2.048 kB\n-\u4ee5\u4e0b\u3001\u7565-\n\n\u30e6\u30fc\u30b6\u3092\u78ba\u8a8d\u3059\u308b\u3002\u30d3\u30eb\u30c9\u6642\u306b\u6307\u5b9a\u3057\u305f\u30e6\u30fc\u30b6\u540d(httpd)\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n[root@node1 test]# docker run -it --rm test-img:ver1 bash\n[httpd@fb7fdb408f5b /]$ id\nuid=1000(httpd) gid=1000(httpd) groups=1000(httpd)\n\n```\n\n###4.7.1 \u305d\u306e2 (ARG xxx \u3068\u5b9a\u7fa9\u3057\u305f\u5834\u5408)\n\n```\n----------------------------------------------------\n1. \u30c6\u30b9\u30c8\u7528\u30d5\u30a1\u30a4\u30eb\u306e\u6e96\u5099 (\u4e0b\u8a182,3,4\u3067\u540c\u3058\u3082\u306e\u3092\u4f7f\u3046)\n----------------------------------------------------\n[root@node1 test]# vi Dockerfile\n[root@node1 test]# cat Dockerfile\nFROM centos:centos7\nARG arg\nCOPY test_$arg /tmp\n\n[root@node1 test]# touch test_10\n[root@node1 test]# touch test_20\n[root@node1 test]# echo 10 > test_10\n[root@node1 test]# echo 20 > test_20\n[root@node1 test]# ls\nDockerfile  test_10  test_20\n\n------------------------------------------------------\n2. \u5f15\u6570\u306b10\u3092\u6307\u5b9a(--build-arg arg=10)\u3057\u3066\u30d3\u30eb\u30c9\u3059\u308b\n------------------------------------------------------\n\u30d3\u30eb\u30c9\u3059\u308b\u3002\u30a4\u30e1\u30fc\u30b8\u5185\u306b\u3001/tmp/test_10\u3068\u3044\u3046\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@node1 test]# docker build -t test-img:ver1 --no-cache=true --build-arg arg=10 .\nSending build context to Docker daemon 4.096 kB\n-\u4ee5\u4e0b\u3001\u7565-\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@node1 test]# docker run -it --rm test-img:ver1 bash\n\n\u30c6\u30b9\u30c8\u30d5\u30a1\u30a4\u30eb\u3092\u8aad\u307f\u51fa\u3059\u3002\u30d3\u30eb\u30c9\u6642\u306b\u6307\u5b9a\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u306e\u4e2d\u8eab\u304c\u3088\u3081\u305f\u3002\n[root@74312d24207d /]# cat /tmp/test_10\n10\n[root@74312d24207d /]# exit\nexit\n\n------------------------------------------------------\n3. \u5f15\u6570\u306b20\u3092\u6307\u5b9a(--build-arg arg=20)\u3057\u3066\u30d3\u30eb\u30c9\u3059\u308b\n------------------------------------------------------\n\u30d3\u30eb\u30c9\u3059\u308b\u3002\u30a4\u30e1\u30fc\u30b8\u5185\u306b\u3001/tmp/test_20\u3068\u3044\u3046\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@node1 test]# docker build -t test-img:ver1 --no-cache=true --build-arg arg=20 .\nSending build context to Docker daemon 4.096 kB\n-\u4ee5\u4e0b\u3001\u7565-\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@node1 test]# docker run -it --rm test-img:ver1 bash\n\n\u30c6\u30b9\u30c8\u30d5\u30a1\u30a4\u30eb\u3092\u8aad\u307f\u51fa\u3059\u3002\u30d3\u30eb\u30c9\u6642\u306b\u6307\u5b9a\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u306e\u4e2d\u8eab\u304c\u3088\u3081\u305f\u3002\n[root@636350430fc3 /]# cat /tmp/test_20\n20\n[root@636350430fc3 /]# exit\nexit\n\n-----------------------------------------------------^\n4. \u5f15\u6570\u306b\u4f55\u3082\u6307\u5b9a\u3057\u306a\u3044\u3067\u30d3\u30eb\u30c9\u3059\u308b\n------------------------------------------------------\n\u30d3\u30eb\u30c9\u3059\u308b\u3002\u5f15\u6570\u3092\u6307\u5b9a\u3057\u306a\u3044\u3068\u30a8\u30e9\u30fc\u767a\u751f\u3059\u308b\u3002\n[root@node1 test]# docker build -t test-img:ver1 --no-cache=true .\nSending build context to Docker daemon 4.096 kB\n-\u4e2d\u7565-\nStep 3 : COPY test_$arg /tmp\nlstat test_: no such file or directory \u2605\n\n```\n\n##4.8 ONBUILD\n<A Href=\"http://deeeet.com/writing/2014/03/21/docker-onbuild/\">Dockerfile\u306eONBUILD</A>\n\n\n\n##4.20 Dockerfile\u306e\u4e2d\u304b\u3089\u30b7\u30a7\u30eb\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u5b9f\u884c\u3059\u308b\u3002\n\n```\nDockerfile\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 test2]# vi Dockerfile\n[root@master1 test2]# cat Dockerfile\nFROM centos:centos7\nADD test.sh /usr/local/bin/\nRUN chmod +x /usr/local/bin/test.sh\nENTRYPOINT [\"/usr/local/bin/test.sh\"]\n\n\u30b7\u30a7\u30eb\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 test2]# vi test.sh\n[root@master1 test2]# cat test.sh\n#!/usr/bin/bash\ndate\ndf -HT\n\n\u30d5\u30a1\u30a4\u30eb\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 test2]# ls\nDockerfile  test.sh\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 test2]# docker build -t test-img:ver1 --no-cache=true .\nSending build context to Docker daemon 3.072 kB\nStep 1 : FROM centos:centos7\n ---> 0584b3d2cf6d\nStep 2 : ADD test.sh /usr/local/bin/\n ---> 47e0b863dc89\nRemoving intermediate container cb92e3c9f034\nStep 3 : RUN chmod +x /usr/local/bin/test.sh\n ---> Running in 9bf731f15e9c\n ---> 7c9d1c388c8a\nRemoving intermediate container 9bf731f15e9c\nStep 4 : ENTRYPOINT /usr/local/bin/test.sh\n ---> Running in b70e9cf496aa\n ---> 9d8185069d7f\nRemoving intermediate container b70e9cf496aa\nSuccessfully built 9d8185069d7f\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 test2]# docker run --rm test-img:ver1\nSat Nov 26 12:06:16 UTC 2016\nFilesystem                                                                                     Type   Size  Used Avail Use% Mounted on\n/dev/mapper/docker-8:3-713942-b4002d9923c4ebdf11156b914942131e8f9b34ffe43b646f4ebe55914855d553 xfs     11G  252M   11G   3% /\ntmpfs                                                                                          tmpfs  514M     0  514M   0% /dev\ntmpfs                                                                                          tmpfs  514M     0  514M   0% /sys/fs/cgroup\n/dev/sda3                                                                                      xfs     43G  5.4G   37G  13% /etc/hosts\nshm                                                                                            tmpfs   68M     0   68M   0% /dev/shm\n[root@master1 test2]#\n\n\n```\n\n##4.22 shell\n\n```\n<A Href=\"https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/\">xxx</A>\n\n\n```\n\n##4.22 \u30b3\u30f3\u30c6\u30ca\u3092\u52d5\u4f5c\u3055\u305b\u7d9a\u3051\u308b(tail -f /dev/null)\n\n```\nDockerfile\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 test2]# vi Dockerfile\n[root@master1 test2]# cat Dockerfile\nFROM centos:centos7\nCMD tail -f /dev/null\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 test2]# docker build -t test-img:ver1 --no-cache=true .\nSending build context to Docker daemon 3.072 kB\nStep 1 : FROM centos:centos7\n ---> 0584b3d2cf6d\nStep 2 : CMD tail -f /dev/null\n ---> Running in 51c3bd766516\n ---> 9ddc19b87832\nRemoving intermediate container 51c3bd766516\nSuccessfully built 9ddc19b87832\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 test2]# docker run -d --name test-con test-img:ver1\nab0b4bd16be96e4df1fa01bd47df5e663c67a9a56d97f72d9038280d4d7d9e5b\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\u52d5\u4f5c\u3057\u3066\u7d9a\u3051\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 test2]# docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES\nab0b4bd16be9        test-img:ver1       \"/bin/sh -c 'tail -f \"   2 minutes ago       Up 2 minutes                            test-con\n\n\n```\n\n#5 \u5b9f\u7528\u7de8\n##5.1 WordPress(\u30d6\u30ed\u30b0\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2)\u3068MySQL(\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9)\u306e\u9023\u643a\n\n```\n-------------------------------------------------------------\n1. \u69cb\u6210\n-------------------------------------------------------------\nWordPress\u3068MySQL\u306f\u3001\u4ee5\u4e0b\u306e\u69cb\u6210\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n\n                +--------------- Host(CentOS7.2) ------------------+\n                |                                                  |\n              TCP port            container             container  |\n   web  <---> 10003 <----------> 80(wordpress) <------> (wp-mysql) |\n browser        |                                                  |\n                |                                                  |\n                +--------------------------------------------------+\n\n\n-------------------------------------------------------------\n2. \u8a2d\u5b9a\n-------------------------------------------------------------\n\u30b3\u30f3\u30c6\u30ca(MySQL)\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -d --name wp-mysql -e MYSQL_ROOT_PASSWORD=hana_shin mysql\nac631804cc003747cfb16549b8738e5ea0d89d9c4ccc747f277397e36258ae33\n\n\u30b3\u30f3\u30c6\u30ca(wordpress)\u3092\u8d77\u52d5\u3059\u308b\u3002link\u30aa\u30d7\u30b7\u30e7\u30f3\u306f\u3001<\u9023\u643a\u3057\u305f\u3044\u30b3\u30f3\u30c6\u30ca\u540d:\u30a8\u30a4\u30ea\u30a2\u30b9\u540d>\u306e\u3088\u3046\u306b\u3064\u3051\u308b\u3002\n[root@master1 ~]# docker run -d --name wordpress --link wp-mysql:mysql -p 10003:80 wordpress\n6c02355bd6b3d357a1d6627ebae4bd353598f096be529406ef5e161aa63e2b3f\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                   NAMES\n6c02355bd6b3        wordpress           \"docker-entrypoint.sh\"   6 seconds ago       Up 2 seconds        0.0.0.0:10003->80/tcp   wordpress\nac631804cc00        mysql               \"docker-entrypoint.sh\"   11 seconds ago      Up 9 seconds        3306/tcp                wp-mysql\n\nwordpress\u304c\u53d6\u5f97\u3057\u305f\u74b0\u5883\u5909\u6570\u3092\u8868\u793a\u3059\u308b\u3002\n[root@master1 ~]# docker exec -it wordpress env\nPATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\nHOSTNAME=6c02355bd6b3\nMYSQL_PORT=tcp://172.17.0.2:3306\nMYSQL_PORT_3306_TCP=tcp://172.17.0.2:3306\nMYSQL_PORT_3306_TCP_ADDR=172.17.0.2\nMYSQL_PORT_3306_TCP_PORT=3306\nMYSQL_PORT_3306_TCP_PROTO=tcp\n-\u4ee5\u4e0b\u3001\u7565-\n\n\u30d6\u30e9\u30a6\u30b6\u3067\u4e0b\u8a18\u30a2\u30c9\u30ec\u30b9\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3002\nhttp://192.168.0.10:10003/\n\n```\n\n##5.2 CentOS\u3068MySQL\u306e\u9023\u643a(\u7528\u9014\u3042\u308b\u306e\u304b???)\n\n```\n\u30b3\u30f3\u30c6\u30ca(MySQL)\u8d77\u52d5\n[root@master1 test2]# docker run -d --name mysql -e MYSQL_ROOT_PASSWORD=hana_shin mysql\n7ddd8884ada441341361d45a74bdb252c1082e1cf3226141a26e6c1b992fe17c\n\n\u30b3\u30f3\u30c6\u30ca(CentOS)\u8d77\u52d5\n[root@master1 test2]# docker run -it --name test-con --link mysql:db centos:centos7 bash\n\nCentOS\u306bmysql\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n[root@8b616eca9919 /]# yum -y install mysql\nLoaded plugins: fastestmirror, ovl\n-\u4ee5\u4e0b\u3001\u7565-\n\n\u63a5\u7d9a\u3059\u308bDB\u306eIP\u30a2\u30c9\u30ec\u30b9\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@8b616eca9919 /]# env|grep DB_PORT_3306_TCP_ADDR\nDB_PORT_3306_TCP_ADDR=172.17.0.2\n\nCentOS\u304b\u3089MySQL\u306b\u63a5\u7d9a\u3059\u308b\u3002\n[root@8b616eca9919 /]# mysql -u root -p -h 172.17.0.2\nEnter password:\nWelcome to the MariaDB monitor.  Commands end with ; or \\g.\nYour MySQL connection id is 2\nServer version: 5.7.16 MySQL Community Server (GPL)\n\nCopyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others.\n\nType 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.\n\nMySQL [(none)]>\n\n```\n\n\n##5.3 Jenkins\uff08\u958b\u767a\u652f\u63f4\u30c4\u30fc\u30eb\uff09\u3092\u8d77\u52d5\u3059\u308b\u3002\n\n###(1) Jenkins\u3092\u8d77\u52d5\u3059\u308b\u3002\n```\nDockerfile\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 test2]# vi Dockerfile\n[root@master1 test2]# cat Dockerfile\nFROM jenkins\nCOPY jenkins_plugins.txt /tmp/jenkins_plugins.txt\nRUN /usr/local/bin/plugins.sh /tmp/jenkins_plugins.txt\nUSER root\nRUN rm /tmp/jenkins_plugins.txt\nRUN groupadd -g 142 docker\nRUN addgroup -a jenkins docker\nUSER jenkins\n\n\u30d7\u30e9\u30b0\u30a4\u30f3\u7528\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 test2]# vi jenkins_plugins.txt\n[root@master1 test2]# cat jenkins_plugins.txt\nswarm:1.22\n\n\u4f5c\u6210\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 test2]# ls\nDockerfile  jenkins_plugins.txt\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 test2]# docker build -t jenkins_server .\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 test2]# docker run --name jenkins_server -p 11111:8080 -p 50000:50000 -v /var/run/docker.sock:/var/run/docker.sock -v /tmp:/var/jenkins_home -d jenkins_server\n64e6856dbe6ed15f575b0b916eae82c116c1bfa6300876a2ce607993120327d6\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 test2]# docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                                               NAMES\n64e6856dbe6e        jenkins_server      \"/bin/tini -- /usr/lo\"   5 seconds ago       Up 3 seconds        0.0.0.0:50000->50000/tcp, 0.0.0.0:11111->8080/tcp   jenkins_server\n\n\u30d6\u30e9\u30a6\u30b6\u3067\u4e0b\u8a18URL\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3002\nhttp://192.168.0.10:11111/\n\n\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3059\u308b\u305f\u3081\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u5165\u529b\u3092\u6c42\u3081\u3089\u308c\u308b\u306e\u3067\u3001jenkins\u306b\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u3002\n[root@master1 var]# docker exec -it jenkins_server bash\n\njenkins\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u7528\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u8aad\u307f\u3060\u3059\u3002\njenkins@64e6856dbe6e:~$ cat /var/jenkins_home/secrets/initialAdminPassword\nxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n\n\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u5165\u529b\u3059\u308b\u3068\u3001jenkins\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u304c\u958b\u59cb\u3055\u308c\u308b\u3002\n```\n\n\n###(2) jenkins\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u5b8c\u4e86\u5f8c\u306e\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u4fdd\u5b58(commit)\u3059\u308b\u3002\n\n```\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 test2]# docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                                               NAMES\n64e6856dbe6e        jenkins_server      \"/bin/tini -- /usr/lo\"   16 minutes ago      Up 16 minutes       0.0.0.0:50000->50000/tcp, 0.0.0.0:11111->8080/tcp   jenkins_server\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u505c\u6b62\u3059\u308b\u3002\n[root@master1 test2]# docker stop jenkins_server\njenkins_server\n\n\u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\u3092\u4fdd\u5b58(commit)\u3059\u308b\u3002\u4fdd\u5b58\u3059\u308b\u306e\u306f\u3001\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u5b8c\u4e86\u6e08\u30a4\u30e1\u30fc\u30b8\u3002\n[root@master1 test2]# docker commit jenkins_server jenkins_server:ver1\nsha256:6d5dbe73cf0422e9ba14e2577454386b3ab0600f5b379c9ced52905144522de8\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u5b8c\u4e86\u5f8c\u306e\u30a4\u30e1\u30fc\u30b8\u306f jenkins_server:ver1\n[root@master1 test2]# docker images |grep jenkins_server\njenkins_server                                        ver1                               6d5dbe73cf04        55 seconds ago      714.1 MB\njenkins_server                                        latest                             b8081e64f449        21 minutes ago      714.1 MB\n\njenkins\u3092\u8d77\u52d5\u3059\u308b\u3002\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u5b8c\u4e86\u5f8c\u306e\u30a4\u30e1\u30fc\u30b8\u304b\u3089\u518d\u8d77\u52d5\u3067\u304d\u305f\u3002\n[root@master1 test2]# docker run --name jenkins_server -p 11111:8080 -p 50000:50000 -v /var/run/docker.sock:/var/run/docker.sock -v /tmp:/var/jenkins_home -d jenkins_server:ver1\n\n```\n\n\n#6 \u30b3\u30f3\u30c6\u30ca\u306e\u6a29\u9650(Capabilities)\n\n<a href=\"http://rhelblog.redhat.com/2016/10/17/secure-your-containers-with-this-one-weird-trick/\">Secure Your Containers with this One Weird Trick</a>\n<a href=\"https://blog.tutum.co/2015/02/03/hardening-containers-disable-suid-programs/\">Hardening Docker Containers: Disable SUID Programs</a>\n<a href=\"https://benchmarks.cisecurity.org/tools2/docker/CIS_Docker_1.11.0_Benchmark_v1.0.0.pdf\">CIS Docker 1.11.0 Benchmark</a>\n<a href=\"http://tanksuzuki.com/post/docker-pam-error/\">\u30b3\u30f3\u30c6\u30ca\u3067cron\u3092\u52d5\u304b\u3057\u305f\u6642\u306b\u51fa\u308bPAM\u30a8\u30e9\u30fc\u306e\u5bfe\u51e6\u6cd5</a>\n[Docker networking considered harmful](https://nyantec.com/en/2015/03/20/docker-networking-considered-harmful/)\n\n\n##6.1 \u30b3\u30f3\u30c6\u30ca\u306e\u6a29\u9650\u3092\u78ba\u8a8d\u3059\u308b\u65b9\u6cd5\n\n```\npscap\u30b3\u30de\u30f3\u30c9\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002pscap\u3067\u30d7\u30ed\u30bb\u30b9\u306e\u6a29\u9650\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n[root@master1 ~]# yum -y install libcap-ng-utils\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -it --name test-con centos:centos7 bash\n\n\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u306c\u3051\u308b(Ctrl\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u306a\u304c\u3089\u3001P\u30ad\u30fc\u3068Q\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b)\n[root@14cbbaf4c108 /]# [root@master1 ~]#\n\n\u30b3\u30f3\u30c6\u30caID\u3092\u6c42\u3081\u308b\u3002\n[root@master1 ~]# CID=$(docker ps --no-trunc=true|grep -w \"test-con\"|awk '{print $1}')\n[root@master1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u6a29\u9650(capabilities)\u3092\u78ba\u8a8d\u3059\u308b\u30021\u884c\u304c\u9577\u3044\u306e\u3067\u6298\u308a\u8fd4\u3057\u3066\u3044\u307e\u3059\u3002\n[root@master1 ~]# pscap |grep $PID\nppid  pid   name   command   capabilities\n1028  13295 root   bash      chown, dac_override, fowner, fsetid, kill, \n                             setgid, setuid, setpcap, net_bind_service, \n                             net_raw, sys_chroot, mknod, audit_write, setfcap\n\n```\n\n\n##6.2 \u5168\u3066\u306e\u6a29\u9650\u3092\u4e0e\u3048\u308b\u3002\u5168\u3066\u306e\u6a29\u9650\u3092\u843d\u3068\u3059\n\n```\n------------------------------------------\n1. \u5168\u3066\u306e\u6a29\u9650\u3092\u4e0e\u3048\u308b(--cap-add=all)\n------------------------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u5168\u3066\u306e\u6a29\u9650\u3092\u4e0e\u3048\u308b\u3002\n[root@node1 ~]# docker run -it --cap-add=all --name test-con centos:centos7 bash\n\n\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u306c\u3051\u308b(Ctrl\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u306a\u304c\u3089\u3001P\u30ad\u30fc\u3068Q\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b)\n[root@0f1503dc4f09 /]# [root@node1 ~]#\n\n\u30b3\u30f3\u30c6\u30caID\u304b\u3089\u30b3\u30f3\u30c6\u30ca\u306ePID\u3092\u6c42\u3081\u308b\u3002\n[root@node1 ~]# CID=$(docker ps --no-trunc=true|grep -w \"test-con\"|awk '{print $1}')\n[root@node1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u6a29\u9650\u3092\u78ba\u8a8d\u3059\u308b\u3002\u5168\u3066\u306e\u6a29\u9650\u304c\u4e0e\u3048\u3089\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@node1 ~]# pscap |grep $PID\nppid  pid   name        command           capabilities\n1009  1367  root        bash            \u2605full\n\n\n------------------------------------------\n2. \u5168\u3066\u306e\u6a29\u9650\u3092\u843d\u3068\u3059(--cap-drop=all)\n------------------------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u5168\u3066\u306e\u6a29\u9650\u3092\u843d\u3068\u3059\u3002\n[root@node1 ~]# docker run -it --cap-drop=all --name test-con centos:centos7 bash\n\n\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u306c\u3051\u308b(Ctrl\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u306a\u304c\u3089\u3001P\u30ad\u30fc\u3068Q\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b)\n[root@536f79628b07 /]# [root@node1 ~]#\n\n\u30b3\u30f3\u30c6\u30caID\u304b\u3089\u30b3\u30f3\u30c6\u30ca\u306ePID\u3092\u6c42\u3081\u308b\u3002\n[root@node1 ~]# CID=$(docker ps --no-trunc=true|grep -w \"test-con\"|awk '{print $1}')\n[root@node1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u6a29\u9650\u3092\u78ba\u8a8d\u3059\u308b\u3002\u6a29\u9650\u304c\u4f55\u3082\u4e0e\u3048\u3089\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\n[root@node1 ~]# pscap |grep $PID\n[root@node1 ~]#\n\n------------------------------------------\n3. \u7279\u5b9a\u306e\u6a29\u9650\u3060\u3051\u4e0e\u3048\u308b\n------------------------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u5168\u3066\u306e\u6a29\u9650\u3092\u843d\u3068\u3057\u3066\u304b\u3089\u3001\u5fc5\u8981\u306a\u6a29\u9650\u3060\u3051\u3092\u4e0e\u3048\u308b\u3002\n[root@node1 ~]# docker run -it --cap-drop=all --cap-add=NET_ADMIN --name test-con centos:centos7 bash\n\n\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u306c\u3051\u308b(Ctrl\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u306a\u304c\u3089\u3001P\u30ad\u30fc\u3068Q\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b)\n[root@2768d178ef7d /]# [root@node1 ~]#\n[root@node1 ~]#\n\n\u30b3\u30f3\u30c6\u30caID\u304b\u3089\u30b3\u30f3\u30c6\u30ca\u306ePID\u3092\u6c42\u3081\u308b\u3002\n[root@node1 ~]# CID=$(docker ps --no-trunc=true|grep -w \"test-con\"|awk '{print $1}')\n[root@node1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u6a29\u9650\u3092\u78ba\u8a8d\u3059\u308b\u3002NET_ADMIN\u3060\u3051\u4e0e\u3048\u3089\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@node1 ~]# pscap |grep $PID\nppid  pid   name        command           capabilities\n1009  1739  root        bash              net_admin\n\n```\n\n\n##6.3 NET_ADMIN\u306e\u4f7f\u3044\u65b9\uff08\u305d\u306e\uff11\uff1a\u7d4c\u8def\u60c5\u5831\u306e\u8ffd\u52a0\uff0f\u524a\u9664\u3092\u5236\u5fa1\u3059\u308b\uff09\n\n```\n-----------------------------\n1. NET_ADMIN\u304c\u6709\u52b9\u306e\u5834\u5408\n-----------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002NET_ADMIN\u3060\u3051\u6709\u52b9\u306b\u3059\u308b\u3002\n[root@node1 ~]# docker run -it --cap-drop=all --cap-add=NET_ADMIN  --name test-con busybox sh\n\n\u7d4c\u8def\u60c5\u5831\u3092\u78ba\u8a8d\u3059\u308b\u3002\n/ # ip route show\ndefault via 172.17.0.1 dev eth0\n172.17.0.0/16 dev eth0  src 172.17.0.2\n\n\u7d4c\u8def\u60c5\u5831\u3092\u8ffd\u52a0\u3059\u308b\u3002\n/ # ip route add 8.8.8.8 via 172.17.0.1 dev eth0\n\n\u7d4c\u8def\u60c5\u5831\u3092\u78ba\u8a8d\u3059\u308b\u3002\u7d4c\u8def\u60c5\u5831\u304c\u8ffd\u52a0\u3055\u308c\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n/ # ip route show\ndefault via 172.17.0.1 dev eth0\n8.8.8.8 via 172.17.0.1 dev eth0 \u2605\n172.17.0.0/16 dev eth0  src 172.17.0.2\n\n\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u306c\u3051\u308b(Ctrl\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u306a\u304c\u3089\u3001P\u30ad\u30fc\u3068Q\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b)\n/ # [root@node1 ~]#\n\n\u30b3\u30f3\u30c6\u30caID\u304b\u3089\u30b3\u30f3\u30c6\u30ca\u306ePID\u3092\u6c42\u3081\u308b\u3002\n[root@node1 ~]# CID=$(docker ps --no-trunc=true|grep -w \"test-con\"|awk '{print $1}')\n[root@node1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u6a29\u9650\u3092\u78ba\u8a8d\u3059\u308b\u3002NET_ADMIN\u304c\u6709\u52b9\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@node1 ~]# pscap |grep $PID\nppid  pid   name        command           capabilities\n1009  2062  root        sh              \u2605net_admin\n\n-----------------------------\n2. NET_ADMIN\u304c\u7121\u52b9\u306e\u5834\u5408\n-----------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u5168\u3066\u306e\u6a29\u9650\u3092\u843d\u3068\u3059\u3002\n[root@node1 ~]# docker run -it --cap-drop=all --name test-con busybox sh\n\n\u7d4c\u8def\u60c5\u5831\u3092\u78ba\u8a8d\u3059\u308b\u3002\n/ # ip route show\ndefault via 172.17.0.1 dev eth0\n172.17.0.0/16 dev eth0  src 172.17.0.2\n\n\u7d4c\u8def\u60c5\u5831\u3092\u8ffd\u52a0\u3059\u308b\u3002\u8ffd\u52a0\u3067\u304d\u306a\u3044\u3002\n/ # ip route add 8.8.8.8 via 172.17.0.1 dev eth0\nip: RTNETLINK answers: Operation not permitted\n\n\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u306c\u3051\u308b(Ctrl\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u306a\u304c\u3089\u3001P\u30ad\u30fc\u3068Q\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b)\n/ # [root@node1 ~]#\n\n\u30b3\u30f3\u30c6\u30caID\u304b\u3089\u30b3\u30f3\u30c6\u30ca\u306ePID\u3092\u6c42\u3081\u308b\u3002\n[root@node1 ~]# CID=$(docker ps --no-trunc=true|grep -w \"test-con\"|awk '{print $1}')\n[root@node1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u6a29\u9650\u3092\u78ba\u8a8d\u3059\u308b\u3002\u6a29\u9650\u304c\u4f55\u3082\u4e0e\u3048\u3089\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\n[root@node1 ~]# pscap |grep $PID\n[root@node1 ~]#\n\n```\n\n\n\n##6.4 NET_ADMIN\u306e\u4f7f\u3044\u65b9\uff08\u305d\u306e\uff12\uff1a\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30c7\u30d0\u30a4\u30b9\u306e\u4f5c\u6210\u53ef\u5426\u3092\u5236\u5fa1\u3059\u308b\uff09\n\n\n```\n-----------------------------\n1. NET_ADMIN\u304c\u6709\u52b9\u306e\u5834\u5408\n-----------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002NET_ADMIN\u3060\u3051\u6709\u52b9\u306b\u3059\u308b\u3002\n[root@node1 ~]# docker run -it --cap-drop=all --cap-add=NET_ADMIN --name test-con busybox sh\n\ndummy\u30bf\u30a4\u30d7\u306e\u30c7\u30d0\u30a4\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3002\n/ # ip link add foo type dummy\n\n\u30c7\u30d0\u30a4\u30b9(foo)\u304c\u4f5c\u6210\u3067\u304d\u305f\u3002\n/ # ip link show foo\n2: foo: <BROADCAST,NOARP> mtu 1500 qdisc noop\n    link/ether 1a:f8:ed:6b:f0:91 brd ff:ff:ff:ff:ff:ff\n\n\u30c7\u30d0\u30a4\u30b9\u3092\u524a\u9664\u3059\u308b\u3002\n/ # ip link del foo\n\n\u30c7\u30d0\u30a4\u30b9\u304c\u524a\u9664\u3067\u304d\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n/ # ip link show foo\nip: can't find device 'foo'\n\n\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u306c\u3051\u308b(Ctrl\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u306a\u304c\u3089\u3001P\u30ad\u30fc\u3068Q\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b)\n/ # [root@node1 ~]#\n\n\u30b3\u30f3\u30c6\u30caID\u304b\u3089\u30b3\u30f3\u30c6\u30ca\u306ePID\u3092\u6c42\u3081\u308b\u3002\n[root@node1 ~]# CID=$(docker ps --no-trunc=true|grep -w \"test-con\"|awk '{print $1}')\n[root@node1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u6a29\u9650\u3092\u78ba\u8a8d\u3059\u308b\u3002NET_ADMIN\u304c\u6709\u52b9\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@node1 ~]# pscap |grep $PID\nppid  pid   name        command           capabilities\n1009  3378  root        sh              \u2605net_admin\n\n-----------------------------\n2. NET_ADMIN\u304c\u7121\u52b9\u306e\u5834\u5408\n-----------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u5168\u3066\u306e\u6a29\u9650\u3092\u7121\u52b9\u306b\u3059\u308b\u3002\n[root@node1 ~]# docker run -it --cap-drop=all --name test-con busybox sh\n\n\u30c7\u30d0\u30a4\u30b9(foo)\u3092\u4f5c\u6210\u3059\u308b\u3002\u3057\u304b\u3057\u6a29\u9650\u304c\u306a\u3044\u305f\u3081\u4f5c\u6210\u3067\u304d\u306a\u3044\u3002\n/ # ip link add foo type dummy\nip: RTNETLINK answers: Operation not permitted\n\n\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u306c\u3051\u308b(Ctrl\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u306a\u304c\u3089\u3001P\u30ad\u30fc\u3068Q\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b)\n/ # [root@node1 ~]#\n\n\u30b3\u30f3\u30c6\u30caID\u304b\u3089\u30b3\u30f3\u30c6\u30ca\u306ePID\u3092\u6c42\u3081\u308b\u3002\n[root@node1 ~]# CID=$(docker ps --no-trunc=true|grep -w \"test-con\"|awk '{print $1}')\n[root@node1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u6a29\u9650\u3092\u78ba\u8a8d\u3059\u308b\u3002\u6a29\u9650\u304c\u4f55\u3082\u4e0e\u3048\u3089\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\n[root@node1 ~]# pscap |grep $PID\n[root@node1 ~]#\n\n```\n\n\n\n##6.5 NET_BIND_SERVICE\u306e\u4f7f\u3044\u65b9(\u7279\u6a29\u30dd\u30fc\u30c8\u3067\u306e\u30ea\u30c3\u30b9\u30f3\u3092\u5236\u5fa1\u3059\u308b\uff09\n\n```\n----------------------------------\n1. NET_BIND_SERVICE\u304c\u6709\u52b9\u306e\u5834\u5408\n----------------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002NET_BIND_SERVICE\u3060\u3051\u6709\u52b9\u306b\u3059\u308b\u3002\n[root@node1 ~]# docker run -it --cap-drop=all --cap-add=NET_BIND_SERVICE  --name test-con busybox sh\n\nroto\u30e6\u30fc\u30b6\u3067\u5b9f\u884c\u3059\u308b\u3002\n/ # id\nuid=0(root) gid=0(root) groups=10(wheel)\n\n\u4e00\u822c\u30dd\u30fc\u30c8(80)\u3067\u30ea\u30c3\u30b9\u30f3\u3059\u308b\u3002\u30ea\u30c3\u30b9\u30f3\u3067\u304d\u305f\u3002Ctrl+C\u3067\u7d42\u4e86\u3002\n/ # nc -l -p 80\n^C\n\u4e00\u822c\u30dd\u30fc\u30c8(1023)\u3067\u30ea\u30c3\u30b9\u30f3\u3059\u308b\u3002\u30ea\u30c3\u30b9\u30f3\u3067\u304d\u305f\u3002Ctrl+C\u3067\u7d42\u4e86\u3002\n/ # nc -l -p 1023\n^C\n\u7279\u6a29\u30dd\u30fc\u30c8(1024\u4ee5\u4e0a)\u3067\u30ea\u30c3\u30b9\u30f3\u3059\u308b\u3002\u30ea\u30c3\u30b9\u30f3\u3067\u304d\u305f\u3002Ctrl+C\u3067\u7d42\u4e86\u3002\n/ # nc -l -p 1024\n^C\n/ #\n\n\n\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3092\u958b\u304f\u3002\u30ea\u30c3\u30b9\u30f3\u3057\u3066\u3044\u308b\u30dd\u30fc\u30c8\u756a\u53f7\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n[root@node1 ~]# docker exec -it test-con sh\n/ # netstat -antp\nActive Internet connections (servers and established)\nProto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name\ntcp        0      0 :::80\u2605                 :::*                    LISTEN      20/nc\n\n/ # netstat -antp\nActive Internet connections (servers and established)\nProto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name\ntcp        0      0 :::1023\u2605               :::*                    LISTEN      22/nc\n\n/ # netstat -antp\nActive Internet connections (servers and established)\nProto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name\ntcp        0      0 :::1024\u2605\n\n\u30b3\u30f3\u30c6\u30caID\u304b\u3089\u30b3\u30f3\u30c6\u30ca\u306ePID\u3092\u6c42\u3081\u308b\u3002\n[root@node1 ~]# CID=$(docker ps --no-trunc=true|grep -w \"test-con\"|awk '{print $1}')\n[root@node1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u6a29\u9650\u3092\u78ba\u8a8d\u3059\u308b\u3002NET_BIND_SERVICE\u304c\u6709\u52b9\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@node1 ~]# pscap |grep $PID\nppid  pid   name        command           capabilities\n2308  2357  root        nc              \u2605net_bind_service\n\n----------------------------------\n2. NET_BIND_SERVICE\u304c\u7121\u52b9\u306e\u5834\u5408\n----------------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u5168\u3066\u306e\u6a29\u9650\u3092\u7121\u52b9\u306b\u3059\u308b\u3002\n[root@node1 ~]# docker run -it --cap-drop=all --name test-con busybox sh\n\nroto\u30e6\u30fc\u30b6\u3067\u5b9f\u884c\u3059\u308b\u3002\n/ # id\nuid=0(root) gid=0(root) groups=10(wheel)\n\n\u7279\u6a29\u30dd\u30fc\u30c8(1-1023)\u3067\u306f\u30ea\u30c3\u30b9\u30f3\u3067\u304d\u306a\u3044\u3002\n/ # nc -l -p 80\nnc: bind: Permission denied\n\n\u4e00\u822c\u30dd\u30fc\u30c8\u3067\u306f\u30ea\u30c3\u30b9\u30f3\u3067\u304d\u308b\u3002\n[root@node1 ~]# docker exec -it test-con sh\n/ # nc -l -p 1024\n^C\n\n\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u306c\u3051\u308b(Ctrl\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u306a\u304c\u3089\u3001P\u30ad\u30fc\u3068Q\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b)\n/ # [root@node1 ~]#\n[root@node1 ~]#\n\n\u30b3\u30f3\u30c6\u30caID\u304b\u3089\u30b3\u30f3\u30c6\u30ca\u306ePID\u3092\u6c42\u3081\u308b\u3002\n[root@node1 ~]# CID=$(docker ps --no-trunc=true|grep -w \"test-con\"|awk '{print $1}')\n[root@node1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u6a29\u9650\u3092\u78ba\u8a8d\u3059\u308b\u3002\u6a29\u9650\u304c\u4f55\u3082\u4e0e\u3048\u3089\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\n[root@node1 ~]# pscap |grep $PID\n[root@node1 ~]#\n\n```\n\n\n\n##6.6 NET_RAW\u306e\u4f7f\u3044\u65b9\nping,traceroute,arping,tcpdump\u3068\u3044\u3063\u305f\u30d7\u30ed\u30b0\u30e9\u30e0\u304c\u4f7f\u3048\u306a\u304f\u306a\u308b\u3002\n\n\n```\n-----------------------------\n1. NET_RAW\u304c\u6709\u52b9\u306e\u5834\u5408\n-----------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002NET_RAW\u3060\u3051\u6709\u52b9\u306b\u3059\u308b\u3002\n[root@node1 ~]# docker run -it --cap-drop=all --cap-add=NET_RAW busybox sh\n\n\u7d4c\u8def\u60c5\u5831\u3092\u691c\u7d22\u3059\u308b\u3002(ping,traceroute\u306e\u5b9b\u5148\u3092\u78ba\u8a8d\u3059\u308b\u305f\u3081\uff09\n/ # ip route show\ndefault via 172.17.0.1 dev eth0\n172.17.0.0/16 dev eth0  src 172.17.0.2\n\nping\u3092\u5b9f\u884c\u3059\u308b\u3002\u5fdc\u7b54\u304c\u3042\u308b\u3002\n/ # ping 172.17.0.1\nPING 172.17.0.1 (172.17.0.1): 56 data bytes\n64 bytes from 172.17.0.1: seq=0 ttl=64 time=0.194 ms\n-\u4ee5\u4e0b\u3001\u7565-\n\ntraceroute\u3092\u5b9f\u884c\u3059\u308b\u3002\u5fdc\u7b54\u304c\u3042\u308b\u3002\n/ # traceroute 172.17.0.1\ntraceroute to 172.17.0.1 (172.17.0.1), 30 hops max, 46 byte packets\n 1  172.17.0.1 (172.17.0.1)  0.016 ms  0.070 ms  0.016 ms\n\narping\u3092\u5b9f\u884c\u3059\u308b\u3002\u30eb\u30fc\u30bf\u306eMAC\u30a2\u30c9\u30ec\u30b9\u3092\u5f97\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n/ # arping -I eth0 172.17.0.1\nARPING to 172.17.0.1 from 172.17.0.2 via eth0\nUnicast reply from 172.17.0.1 [02:42:4c:40:95:b7] 0.031ms\n-\u4ee5\u4e0b\u3001\u7565-\n\n\n-----------------------------\n2. NET_RAW\u304c\u7121\u52b9\u306e\u5834\u5408\n-----------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u5168\u3066\u306e\u6a29\u9650\u3092\u7121\u52b9\u306b\u3059\u308b\u3002\n[root@node1 ~]# docker run -it --cap-drop=all busybox sh\n\n\u7d4c\u8def\u60c5\u5831\u3092\u691c\u7d22\u3059\u308b\u3002(ping,traceroute\u306e\u5b9b\u5148\u3092\u78ba\u8a8d\u3059\u308b\u305f\u3081\uff09\n/ # ip route show\ndefault via 172.17.0.1 dev eth0\n172.17.0.0/16 dev eth0  src 172.17.0.2\n\nping\u3092\u5b9f\u884c\u3059\u308b\u3002\u5fdc\u7b54\u304c\u306a\u3044\u3002\n/ # ping 172.17.0.1\nPING 172.17.0.1 (172.17.0.1): 56 data bytes\nping: permission denied (are you root?)\n\ntraceroute\u3092\u5b9f\u884c\u3059\u308b\u3002\u5fdc\u7b54\u304c\u306a\u3044\u3002\n/ # traceroute 172.17.0.1\ntraceroute: socket: Operation not permitted\n\narping\u3092\u5b9f\u884c\u3059\u308b\u3002\u5fdc\u7b54\u304c\u306a\u3044\u3002\n/ # arping -I eth0 172.17.0.1\narping: socket: Operation not permitted\n\n\nbusybox\u306b\u306fyum,tcpdump\u304c\u5165\u3063\u3066\u3044\u306a\u3044\u306e\u3067\u3001centos7\u3067\u78ba\u8a8d\u3002\n[root@node1 ~]# docker run -it --rm --cap-drop=NET_RAW centos:centos7 bash\n[root@f54069514adf /]# yum -y install tcpdump\n[root@f54069514adf /]# tcpdump -i eth0 port 80\ntcpdump: eth0: You don't have permission to capture on that device\n(socket: Operation not permitted)\n\n```\n\n\n\n##6.7 MKNOD\u306e\u4f7f\u3044\u65b9\n\n```\n-----------------------------\n1. MKNOD\u304c\u6709\u52b9\u306a\u5834\u5408\n-----------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002MKNOD\u3060\u3051\u6709\u52b9\u306b\u3059\u308b\u3002\n[root@node1 ~]# docker run -it --cap-drop=all --cap-add=MKNOD --name test-con busybox sh\n\n\u30c7\u30d0\u30a4\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3002\n/ # mknod -m 660 /dev/hda b 56 0\n\n\u30c7\u30d0\u30a4\u30b9\u3092\u78ba\u8a8d\u3059\u308b\u3002\u4f5c\u6210\u3067\u304d\u305f\u3002\n/ # ls -la /dev/hda\nbrw-rw----    1 root     root       56,   0 Dec 16 12:07 /dev/hda\n\n\n\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u306c\u3051\u308b(Ctrl\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u306a\u304c\u3089\u3001P\u30ad\u30fc\u3068Q\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b)\n/ # [root@node1 ~]#\n\n\u30b3\u30f3\u30c6\u30caID\u304b\u3089\u30b3\u30f3\u30c6\u30ca\u306ePID\u3092\u6c42\u3081\u308b\u3002\n[root@node1 ~]# CID=$(docker ps --no-trunc=true|grep -w \"test-con\"|awk '{print $1}')\n[root@node1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u6a29\u9650\u3092\u78ba\u8a8d\u3059\u308b\u3002MKNOD\u304c\u6709\u52b9\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@node1 ~]# pscap |grep $PID\nppid  pid   name        command           capabilities\n1009  3118  root        sh              \u2605mknod\n\n-----------------------------\n2. MKNOD\u304c\u7121\u52b9\u306a\u5834\u5408\n-----------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u5168\u3066\u306e\u6a29\u9650\u3092\u7121\u52b9\u306b\u3059\u308b\u3002\n[root@node1 ~]# docker run -it --cap-drop=all --name test-con busybox sh\n\n\u30c7\u30d0\u30a4\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3002\u3057\u304b\u3057\u3001\u4f5c\u6210\u3067\u304d\u306a\u3044\u3002\n/ # mknod -m 660 /dev/hda b 56 0\nmknod: /dev/hda: Operation not permitted\n\n\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u306c\u3051\u308b(Ctrl\u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u306a\u304c\u3089\u3001P\u30ad\u30fc\u3068Q\u30ad\u30fc\u3092\u62bc\u4e0b\u3059\u308b)\n/ # [root@node1 ~]#\n[root@node1 ~]#\n\n\u30b3\u30f3\u30c6\u30caID\u304b\u3089\u30b3\u30f3\u30c6\u30ca\u306ePID\u3092\u6c42\u3081\u308b\u3002\n[root@node1 ~]# CID=$(docker ps --no-trunc=true|grep -w \"test-con\"|awk '{print $1}')\n[root@node1 ~]# PID=$(docker inspect --format {{.State.Pid}} $CID)\n\n\u6a29\u9650\u3092\u78ba\u8a8d\u3059\u308b\u3002MKNOD\u304c\u7121\u52b9\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@node1 ~]# pscap |grep $PID\n[root@node1 ~]#\n\n```\n\n##6.8 CHOWN\u306e\u4f7f\u3044\u65b9\n\n```\n-----------------------------\n1. CHOWN\u304c\u6709\u52b9\u306e\u5834\u5408\n-----------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002CHOWN\u3060\u3051\u6709\u52b9\u306b\u3059\u308b\u3002\n[root@node1 ~]# docker run -it --cap-drop=all --cap-add=CHOWN busybox sh\n\n\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\u6240\u6709\u8005\u3001\u30b0\u30eb\u30fc\u30d7\u3092\u78ba\u8a8d\u3059\u308b\u3002\n/ # touch /tmp/aa.txt\n/ # ls -la /tmp/aa.txt\n-rw-r--r--    1 root     root             0 Dec 18 12:01 /tmp/aa.txt\n\n\u6240\u6709\u8005\u3001\u30b0\u30eb\u30fc\u30d7\u3092\u5909\u66f4\u3059\u308b\u3002\n/ # id daemon\nuid=1(daemon) gid=1(daemon) groups=1(daemon)\n/ # chown daemon:daemon /tmp/aa.txt\n\n\u6240\u6709\u8005\u3001\u30b0\u30eb\u30fc\u30d7\u3092\u78ba\u8a8d\u3059\u308b\u3002\u5909\u66f4\u3067\u304d\u305f\u3002\n/ # ls -la /tmp/aa.txt\n-rw-r--r--    1 daemon   daemon           0 Dec 18 12:01 /tmp/aa.txt\n\n\n-----------------------------\n2. CHOWN\u304c\u7121\u52b9\u306e\u5834\u5408\n-----------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u5168\u3066\u306e\u6a29\u9650\u3092\u7121\u52b9\u306b\u3059\u308b\u3002\n[root@node1 ~]# docker run -it --cap-drop=all busybox sh\n\n\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\u6240\u6709\u8005\u3001\u30b0\u30eb\u30fc\u30d7\u3092\u78ba\u8a8d\u3059\u308b\u3002\n/ # touch /tmp/aa.txt\n/ # ls -la /tmp/aa.txt\n-rw-r--r--    1 root     root             0 Dec 18 12:03 /tmp/aa.txt\n\n\u6240\u6709\u8005\u3001\u30b0\u30eb\u30fc\u30d7\u3092\u78ba\u8a8d\u3059\u308b\u3002\u5909\u66f4\u3067\u304d\u306a\u3044\u3002\n/ # chown daemon:daemon /tmp/aa.txt\nchown: /tmp/aa.txt: Operation not permitted\n\n```\n\n\n##6.9 SETUID\u306e\u4f7f\u3044\u65b9\n<A Href=\"http://www.projectatomic.io/blog/2016/03/no-new-privs-docker/\">Added no-new-privileges Security Flag to Docker</A>\n\n\u4f7f\u3044\u65b9\u304c\u3088\u304f\u308f\u304b\u3089\u306a\u3044\u3002\u60f3\u5b9a\u901a\u308a\u306b\u52d5\u4f5c\u3057\u306a\u3044\uff01\uff01\uff01\n\n```\n\u30c6\u30b9\u30c8\u7528\u30d7\u30ed\u30b0\u30e9\u30e0(\u5b9f\u884c\u30e6\u30fc\u30b6ID\u3092\u78ba\u8a8d\u3059\u308b)\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@node1 test]# vi uid_test.c\n[root@node1 test]# cat uid_test.c\n#include <stdio.h>\n#include <unistd.h>\n#include <sys/types.h>\n\nint main(int argc, char *argv[])\n{\n        printf(\"Effective uid: %d\\n\", geteuid());\n        return 0;\n}\n\nDockerfile\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@node1 test]# vi Dockerfile\n[root@node1 test]# cat Dockerfile\nFROM centos:centos7\nADD uid_test /tmp/uid_test\nRUN chmod u+s /tmp/uid_test\nRUN useradd -u 2000 hana_shin\nUSER hana_shin\nENTRYPOINT /tmp/uid_test\n\n[root@node1 test]# ls\nDockerfile  uid_test  uid_test.c\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@node1 test]# docker build -t test-img:ver1 .\nSending build context to Docker daemon 12.29 kB\n-\u4ee5\u4e0b\u3001\u7565-\n\n```\n\n\n#7. \u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\n\n##7.1 \u30a4\u30e1\u30fc\u30b8\u306e\u7f72\u540d\u30c1\u30a7\u30c3\u30af\u6a5f\u80fd(DOCKER_CONTENT_TRUST)\u3092\u6709\u52b9\u306b\u3059\u308b\n\u30a4\u30e1\u30fc\u30b8\u306e\u7f72\u540d\u30c1\u30a7\u30c3\u30af\u6a5f\u80fd\u3092\u6709\u52b9\u306b\u3059\u308b\u3068\u3001\u30a4\u30e1\u30fc\u30b8\u304c\u6539\u3056\u3093\u3055\u308c\u3066\u3044\u308b\u304b\u3069\u3046\u304b\u78ba\u8a8d\u3067\u304d\u308b\u3002\n\u672c\u6a5f\u80fd\u306fDocker1.8\u3067\u5b9f\u88c5\u3055\u308c\u305f\u3002\n\n```\n--------------------------------------------------------\n1. \u7f72\u540d\u30c1\u30a7\u30c3\u30af\u6a5f\u80fd(DOCKER_CONTENT_TRUST)\u306b\u3064\u3044\u3066\u78ba\u8a8d\u3059\u308b\u3002\n--------------------------------------------------------\n\u30a4\u30e1\u30fc\u30b8\u306e\u7f72\u540d\u30c1\u30a7\u30c3\u30af\u6a5f\u80fd\u3092\u6709\u52b9\u306b\u3059\u308b\u3002\n[root@master1 ~]# export DOCKER_CONTENT_TRUST=1\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\n[root@master1 ~]# docker pull busybox\nUsing default tag: latest\nPull (1 of 1): docker.io/busybox:latest@sha256:29f5d56d12684887bdfa50dcd29fc31eea4aaf4ad3bec43daf19026a7ce69912\nTrying to pull repository docker.io/library/busybox ...\nsha256:29f5d56d12684887bdfa50dcd29fc31eea4aaf4ad3bec43daf19026a7ce69912: Pulling from docker.io/library/busybox\n56bec22e3559: Pull complete\nDigest: sha256:29f5d56d12684887bdfa50dcd29fc31eea4aaf4ad3bec43daf19026a7ce69912\nStatus: Downloaded newer image for docker.io/busybox@sha256:29f5d56d12684887bdfa50dcd29fc31eea4aaf4ad3bec43daf19026a7ce69912\nTagging docker.io/busybox@sha256:29f5d56d12684887bdfa50dcd29fc31eea4aaf4ad3bec43daf19026a7ce69912 as docker.io/busybox:latest\n\n\u30a4\u30e1\u30fc\u30b8\u304c\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3067\u304d\u305f\u3002\n[root@master1 ~]# docker images |grep busybox\ndocker.io/busybox                                     latest                             e02e811dd08f        7 weeks ago         1.093 MB\ndocker.io/busybox                                     <none>                             e02e811dd08f        7 weeks ago         1.093 MB\n\n\n\u5225\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\u30a4\u30e1\u30fc\u30b8\u306b\u7f72\u540d\u304c\u306a\u3044\u305f\u3081\u3001\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u304c\u5931\u6557\u3059\u308b\u3002\n[root@master1 ~]# docker pull sdurrheimer/prom-busybox\nUsing default tag: latest\nError: remote trust data does not exist for docker.io/sdurrheimer/prom-busybox: notary.docker.io does not have trust data for docker.io/sdurrheimer/prom-busybox\n\n                                  <none>                             e02e811dd08f        7 weeks ago         1.093 MB\n\n\u7f72\u540d\u30c1\u30a7\u30c3\u30af\u6a5f\u80fd\u3092\u7121\u52b9\u306b\u3059\u308b\u3002\n[root@master1 ~]# export DOCKER_CONTENT_TRUST=0\n\n\u3082\u3046\u4e00\u5ea6\u3001\u30a4\u30e1\u30fc\u30b8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\u7f72\u540d\u30c1\u30a7\u30c3\u30af\u6a5f\u80fd\u304c\u7121\u52b9\u306a\u306e\u3067\u3001\u30a4\u30e1\u30fc\u30b8\u306b\u7f72\u540d\u304c\u306a\u304f\u3066\u3082\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3067\u304d\u305f\u3002\n[root@master1 ~]# docker pull sdurrheimer/prom-busybox\nUsing default tag: latest\nTrying to pull repository docker.io/sdurrheimer/prom-busybox ...\nlatest: Pulling from docker.io/sdurrheimer/prom-busybox\n56bec22e3559: Already exists\n2e3e1c51b98e: Pull complete\nDigest: sha256:d2db77d1721fc54fab36939e94a329572c274ec4870d846771264991a0cd94d1\nStatus: Downloaded newer image for docker.io/sdurrheimer/prom-busybox:latest\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002\u516c\u5f0f\u306eBusybox\u306b\u52a0\u3048\u3001prom-busybox\u3068\u3044\u3046\u30a4\u30e1\u30fc\u30b8\u3082\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3067\u304d\u305f\u3002\n[root@master1 ~]# docker images |grep busybox\ndocker.io/sdurrheimer/prom-busybox                    latest                             172d95747d74        7 weeks ago         2.492 MB\ndocker.io/busybox                                     latest                             e02e811dd08f        7 weeks ago         1.093 MB\ndocker.io/busybox                                     <none>                             e02e811dd08f        7 weeks ago         1.093 MB\n[root@master1 ~]#\n\n\n--------------------------------------------------------------------------\n2. \u7279\u5b9a\u306e\u30a4\u30e1\u30fc\u30b8\u3060\u3051\u30c1\u30a7\u30c3\u30af\u6a5f\u80fd\u3092\u7121\u52b9\u306b\u3057\u305f\u3044\u5834\u5408(--disable-content-trust)\n--------------------------------------------------------------------------\n\u30a4\u30e1\u30fc\u30b8\u306e\u7f72\u540d\u30c1\u30a7\u30c3\u30af\u6a5f\u80fd\u3092\u6709\u52b9\u306b\u3059\u308b\u3002\n[root@master1 ~]# export DOCKER_CONTENT_TRUST=1\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\u7f72\u540d\u304c\u306a\u3044\u306e\u3067\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3067\u304d\u306a\u3044\u3002\n[root@master1 ~]# docker pull sdurrheimer/prom-busybox\nUsing default tag: latest\nError: remote trust data does not exist for docker.io/sdurrheimer/prom-busybox: notary.docker.io does not have trust data for docker.io/sdurrheimer/prom-busybox\n\n\u7f72\u540d\u304c\u306a\u304f\u3066\u3082\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3067\u304d\u308b\u30aa\u30d7\u30b7\u30e7\u30f3(--disable-content-trust)\u3092\u3064\u3051\u3066\u3001\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\n[root@master1 ~]# docker pull --disable-content-trust sdurrheimer/prom-busybox\nUsing default tag: latest\nTrying to pull repository docker.io/sdurrheimer/prom-busybox ...\nlatest: Pulling from docker.io/sdurrheimer/prom-busybox\n56bec22e3559: Pull complete\n2e3e1c51b98e: Pull complete\nDigest: sha256:d2db77d1721fc54fab36939e94a329572c274ec4870d846771264991a0cd94d1\nStatus: Downloaded newer image for docker.io/sdurrheimer/prom-busybox:latest\n\n```\n\n\n##7.2 \u30b3\u30f3\u30c6\u30ca\u9593\u901a\u4fe1\u3092\u7981\u6b62(--icc=false)\u306b\u3059\u308b\u65b9\u6cd5\n\n```\n-------------------------------------------------\n1. \u30c7\u30d5\u30a9\u30eb\u30c8(--icc=true)\u306e\u3068\u304d\u306e\u6319\u52d5\u3092\u8abf\u3079\u308b\n-------------------------------------------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u306f5001\u756a\u30dd\u30fc\u30c8\u3067\u63a5\u7d9a\u5f85\u3061\u72b6\u614b\u306b\u3057\u3066\u304a\u304f\u3002\n[root@master1 ~]# docker run -d --name nc-test amouat/network-utils nc -l 5001\nb8f13cffe0748431b05ed08491c3fa36b3173ba9b4e5a93abdcf35ae89e4cb7e\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# docker ps\nCONTAINER ID        IMAGE                  COMMAND             CREATED             STATUS              PORTS               NAMES\nb8f13cffe074        amouat/network-utils   \"nc -l 5001\"        8 seconds ago       Up 4 seconds                            nc-test\n\n\u63a5\u7d9a\u5f85\u3061\u30b3\u30f3\u30c6\u30ca\u306b\u30e1\u30c3\u30bb\u30fc\u30b8(hello)\u3092\u9001\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n[root@master1 ~]# docker run -e IP=$(docker inspect -f {{.NetworkSettings.IPAddress}} nc-test) amouat/network-utils sh -c 'echo -n \"hello\" | nc -w 2 -v $IP 5001'\nConnection to 172.17.0.2 5001 port [tcp/*] succeeded!\n\n\n-------------------------------------------------\n2. \u30b3\u30f3\u30c6\u30ca\u9593\u901a\u4fe1\u3092\u7121\u52b9(--icc=false)\u306b\u3059\u308b\n-------------------------------------------------\n[root@master1 ~]# vi /etc/sysconfig/docker\n[root@master1 ~]# cat /etc/sysconfig/docker|grep OPTIONS\nOPTIONS='--iptables=true --icc=false'\n\n\u8a2d\u5b9a\u3092\u53cd\u6620\u3059\u308b\u3002\n[root@master1 ~]# systemctl restart docker\n\n\u8a2d\u5b9a\u3092\u78ba\u8a8d\u3059\u308b\u3002--icc=false\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# ps -C docker-current -o cmd\nCMD\n/usr/bin/docker-current daemon --exec-opt native.cgroupdriver=systemd --iptables=true \u2605--icc=false --storage-opt dm.basesize=50G --insecure-registry 192.\n[root@master1 ~]#\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u306f5001\u756a\u30dd\u30fc\u30c8\u3067\u63a5\u7d9a\u5f85\u3061\u72b6\u614b\u306b\u3057\u3066\u304a\u304f\u3002\n[root@master1 ~]# docker run -d --name nc-test amouat/network-utils nc -l 5001\n11d2572c0efa9b43c8818fa01922035965653ffcc669de4df2fed1dcea186a07\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# docker ps\nCONTAINER ID        IMAGE                  COMMAND             CREATED             STATUS              PORTS               NAMES\n11d2572c0efa        amouat/network-utils   \"nc -l 5001\"        14 seconds ago      Up 11 seconds                           nc-test\n\n\u63a5\u7d9a\u5f85\u3061\u30b3\u30f3\u30c6\u30ca\u306b\u30e1\u30c3\u30bb\u30fc\u30b8(hello)\u3092\u9001\u308b\u3002\u3057\u304b\u3057\u3001\u4eca\u5ea6\u306f\u9001\u4fe1\u3067\u304d\u306a\u3044\u3002\n[root@master1 ~]# docker run -e IP=$(docker inspect -f {{.NetworkSettings.IPAddress}} nc-test) amouat/network-utils sh -c 'echo -n \"hello\" | nc -w 2 -v $IP 5001'\nnc: connect to 172.17.0.2 port 5001 (tcp) timed out: Operation now in progress\n\n```\n\n\n\n##7.3 Docker Bench for Security\u3092\u4f7f\u3046\n<A Href=\"https://github.com/docker/docker-bench-security\">Docker Bench for Security</A>\u3092\u3064\u304b\u3063\u3066\u3001\n\u30b3\u30f3\u30c6\u30ca\u306e\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30c1\u30a7\u30c3\u30af\u3092\u884c\u3046\u3002\u73fe\u6642\u70b9\u3067\u306f\u4f7f\u3044\u65b9\u3060\u3051\u3002\n\n```\n-------------------------------------------------------------\n1. Docker Bench for Security\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n-------------------------------------------------------------\nDocker Bench for Security\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\n[root@master1 ~]# git clone https://github.com/docker/docker-bench-security.git\nCloning into 'docker-bench-security'...\nremote: Counting objects: 810, done.\nremote: Total 810 (delta 0), reused 0 (delta 0), pack-reused 810\nReceiving objects: 100% (810/810), 395.98 KiB | 153.00 KiB/s, done.\nResolving deltas: 100% (546/546), done.\n\n\u30d3\u30eb\u30c9\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u79fb\u52d5\u3059\u308b\u3002\n[root@master1 ~]# cd docker-bench-security/\n[root@master1 docker-bench-security]# ls\nCONTRIBUTING.md  LICENSE.md   README.md          distros                   docker-compose.yml  output_lib.sh\nDockerfile       MAINTAINERS  benchmark_log.png  docker-bench-security.sh  helper_lib.sh       tests\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n[root@master1 docker-bench-security]# docker build -t docker-bench-security .\nSending build context to Docker daemon 154.1 kB\nStep 1 : FROM alpine:3.2\n ---> 7bed0150ea37\n-\u4ee5\u4e0b\u3001\u7565-\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 docker-bench-security]# docker images docker-bench-security\nREPOSITORY              TAG            IMAGE ID           CREATED             SIZE\ndocker-bench-security   latest         d59bf3a4d941       24 seconds ago      41.21 MB\n\n\n-------------------------------------------------------------\n2. \u8a66\u9a13\u5bfe\u8c61\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n-------------------------------------------------------------\n\u8a66\u9a13\u5bfe\u8c61(Nginx)\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 docker-bench-security]# docker run -d --name nginx nginx\n5ffaf5d636bf575b066b1e9995157c0600e5b8b645dc8b023c1239d564e5840e\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 docker-bench-security]# docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES\n5ffaf5d636bf        nginx               \"nginx -g 'daemon off\"   6 seconds ago       Up 4 seconds        80/tcp, 443/tcp     nginx\n[root@master1 docker-bench-security]#\n\n\n-------------------------------------------------------------\n3. \u30b3\u30f3\u30c6\u30ca\u306e\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30c1\u30a7\u30c3\u30af\u3092\u884c\u3046\u3002\n-------------------------------------------------------------\nDocker Bench for Security\u3092\u5b9f\u884c\u3059\u308b\u3002\u7d9a\u3051\u3066\u3001\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30c1\u30a7\u30c3\u30af\u306e\u5b9f\u884c\u7d50\u679c\u304c\u8868\u793a\u3055\u308c\u308b\u3002\nNginx\u306e\u30c1\u30a7\u30c3\u30af\u7d50\u679c\u306b\u306f\u2605\u5370\u3092\u3064\u3051\u3066\u3044\u307e\u3059\u3002\n[root@master1 docker-bench-security]# docker run -it --net host --pid host --cap-add audit_control \\\n      -v /var/lib:/var/lib \\\n      -v /var/run/docker.sock:/var/run/docker.sock \\\n      -v /usr/lib/systemd:/usr/lib/systemd \\\n      -v /etc:/etc --label docker_bench_security \\\n      docker-bench-security\n# ------------------------------------------------------------------------------\n# Docker Bench for Security v1.1.0\n#\n# Docker, Inc. (c) 2015-\n#\n# Checks for dozens of common best-practices around deploying Docker containers in production.\n# Inspired by the CIS Docker 1.11 Benchmark:\n# https://benchmarks.cisecurity.org/downloads/show-single/index.cfm?file=docker16.110\n# ------------------------------------------------------------------------------\n\nInitializing Sun Dec  4 09:09:01 GMT 2016\n\n\n[INFO] 1 - Host Configuration\n[WARN] 1.1  - Create a separate partition for containers\n[PASS] 1.2  - Use an updated Linux Kernel\n[WARN] 1.4  - Remove all non-essential services from the host - Network\n[WARN]      * Host listening on: 13 ports\n[WARN] 1.5  - Keep Docker up to date\n[WARN]       * Using 1.10.3, when 1.12.3 is current as of 2016-10-26\n[INFO]       * Your operating system vendor may provide support and security maintenance for docker\n[INFO] 1.6  - Only allow trusted users to control Docker daemon\n[WARN] 1.7  - Failed to inspect: auditctl command not found.\n[WARN] 1.8  - Failed to inspect: auditctl command not found.\n[WARN] 1.9  - Failed to inspect: auditctl command not found.\n[WARN] 1.10 - Failed to inspect: auditctl command not found.\n[INFO] 1.11 - Audit Docker files and directories - docker.socket\n[INFO]      * File not found\n[INFO] 1.12 - Audit Docker files and directories - /etc/default/docker\n[INFO]      * File not found\n[INFO] 1.13 - Audit Docker files and directories - /etc/docker/daemon.json\n[INFO]      * File not found\n[INFO] 1.14 - Audit Docker files and directories - /usr/bin/docker-containerd\n[INFO]      * File not found\n[INFO] 1.15 - Audit Docker files and directories - /usr/bin/docker-runc\n[INFO]      * File not found\n\n\n[INFO] 2 - Docker Daemon Configuration\n[WARN] 2.1  - Restrict network traffic between containers\n[WARN] 2.2  - Set the logging level\n[PASS] 2.3  - Allow Docker to make changes to iptables\n[PASS] 2.4  - Do not use insecure registries\n[PASS] 2.5  - Do not use the aufs storage driver\n[INFO] 2.6  - Configure TLS authentication for Docker daemon\n[INFO]      * Docker daemon not listening on TCP\n[INFO] 2.7 - Set default ulimit as appropriate\n[INFO]      * Default ulimit doesn't appear to be set\n[WARN] 2.8  - Enable user namespace support\n[PASS] 2.9  - Confirm default cgroup usage\n[PASS] 2.10 - Do not change base device size until needed\n[WARN] 2.11 - Use authorization plugin\n[WARN] 2.12 - Configure centralized and remote logging\n[WARN] 2.13 - Disable operations on legacy registry (v1)\n\n\n[INFO] 3 - Docker Daemon Configuration Files\n[PASS] 3.1  - Verify that docker.service file ownership is set to root:root\n[PASS] 3.2  - Verify that docker.service file permissions are set to 644\n[INFO] 3.3  - Verify that docker.socket file ownership is set to root:root\n[INFO]      * File not found\n[INFO] 3.4  - Verify that docker.socket file permissions are set to 644\n[INFO]      * File not found\n[PASS] 3.5  - Verify that /etc/docker directory ownership is set to root:root\n[PASS] 3.6  - Verify that /etc/docker directory permissions are set to 755\n[PASS] 3.7  - Verify that registry certificate file ownership is set to root:root\n[PASS] 3.8  - Verify that registry certificate file permissions are set to 444\n[INFO] 3.9  - Verify that TLS CA certificate file ownership is set to root:root\n[INFO]      * No TLS CA certificate found\n[INFO] 3.10 - Verify that TLS CA certificate file permissions are set to 444\n[INFO]      * No TLS CA certificate found\n[INFO] 3.11 - Verify that Docker server certificate file ownership is set to root:root\n[INFO]      * No TLS Server certificate found\n[INFO] 3.12 - Verify that Docker server certificate file permissions are set to 444\n[INFO]      * No TLS Server certificate found\n[INFO] 3.13 - Verify that Docker server key file ownership is set to root:root\n[INFO]      * No TLS Key found\n[INFO] 3.14 - Verify that Docker server key file permissions are set to 400\n[INFO]      * No TLS Key found\n[WARN] 3.15 - Verify that Docker socket file ownership is set to root:docker\n[WARN]      * Wrong ownership for /var/run/docker.sock\n[PASS] 3.16 - Verify that Docker socket file permissions are set to 660\n[INFO] 3.17 - Verify that daemon.json file ownership is set to root:root\n[INFO]      * File not found\n[INFO] 3.18 - Verify that daemon.json file permissions are set to 644\n[INFO]      * File not found\n[INFO] 3.19 - Verify that /etc/default/docker file ownership is set to root:root\n[INFO]      * File not found\n[INFO] 3.20 - Verify that /etc/default/docker file permissions are set to 644\n[INFO]      * File not found\n\n\n[INFO] 4 - Container Images and Build Files\n[WARN] 4.1  - Create a user for the container\n[WARN]      * Running as root: nginx  \u2605\n[WARN] 4.5  - Enable Content trust for Docker\n\n\n[INFO] 5  - Container Runtime\n[WARN] 5.1  - Verify AppArmor Profile, if applicable\n[WARN]      * No AppArmorProfile Found: nginx  \u2605\n[WARN] 5.2  - Verify SELinux security options, if applicable\n[WARN]      * No SecurityOptions Found: nginx  \u2605\n[PASS] 5.3  - Restrict Linux Kernel Capabilities within containers\n[PASS] 5.4  - Do not use privileged containers\n[PASS] 5.5  - Do not mount sensitive host system directories on containers\n[PASS] 5.6  - Do not run ssh within containers\n[PASS] 5.7  - Do not map privileged ports within containers\n[PASS] 5.9 - Do not share the host's network namespace\n[WARN] 5.10 - Limit memory usage for container\n[WARN]      * Container running without memory restrictions: nginx \u2605\n[WARN] 5.11 - Set container CPU priority appropriately\n[WARN]      * Container running without CPU restrictions: nginx \u2605\n[WARN] 5.12 - Mount container's root filesystem as read only\n[WARN]      * Container running with root FS mounted R/W: nginx  \u2605\n[PASS] 5.13 - Bind incoming container traffic to a specific host interface\n[WARN] 5.14 - Set the 'on-failure' container restart policy to 5\n[WARN]      * MaximumRetryCount is not set to 5: nginx     \u2605\n[PASS] 5.15 - Do not share the host's process namespace\n[PASS] 5.16 - Do not share the host's IPC namespace\n[PASS] 5.17 - Do not directly expose host devices to containers\n[INFO] 5.18 - Override default ulimit at runtime only if needed\n[INFO]      * Container no default ulimit override: nginx   \u2605\n[PASS] 5.19 - Do not set mount propagation mode to shared\n[PASS] 5.20 - Do not share the host's UTS namespace\n[PASS] 5.21 - Do not disable default seccomp profile\n[PASS] 5.24 - Confirm cgroup usage\n[WARN] 5.25 - Restrict container from acquiring additional privileges\n[WARN]      * Privileges not restricted: nginx   \u2605\n\n\n[INFO] 6  - Docker Security Operations\n[INFO] 6.4 - Avoid image sprawl\n[INFO]      * There are currently: 22 images\n[WARN]      * Only 2 out of 22 are in use\n[INFO] 6.5 - Avoid container sprawl\n[INFO]      * There are currently a total of 2 containers, with 2 of them currently running\n[root@master1 docker-bench-security]#\n\n```\n\n###7.3.1 \"[WARN]      * Running as root: `<\u30b3\u30f3\u30c6\u30ca\u306e\u540d\u524d`>\"\u306b\u5bfe\u51e6\u3059\u308b\n\u30b3\u30f3\u30c6\u30ca\u304croot\u30e6\u30fc\u30b6\u3067\u52d5\u4f5c\u3057\u3066\u3044\u308b\u305f\u3081\u306b\u51fa\u529b\u3055\u308c\u308b\u8b66\u544a\u3067\u3059\u3002\n\u30b3\u30f3\u30c6\u30ca\u3092\u4e00\u822c\u30e6\u30fc\u30b6\u3067\u52d5\u304b\u3059\u3053\u3068\u3067\u8b66\u544a\u306f\u89e3\u6d88\u3055\u308c\u307e\u3059\u3002\n\n```\n[root@node1 test]# vi Dockerfile\n[root@node1 test]# cat Dockerfile\nFROM centos:centos7\nRUN useradd -u 2000 hana_shin\nUSER hana_shin\n[root@node1 test]# docker build -t test-img:ver1 --no-cache=true .\nSending build context to Docker daemon  5.12 kB\n-\u4ee5\u4e0b\u3001\u7565-\n\n[root@node1 test]# docker run -it --name test-con test-img:ver1 bash\n[hana_shin@54ba61db5ac7 /]$ id\nuid=2000(hana_shin) gid=2000(hana_shin) groups=2000(hana_shin)\n\n```\n\n\n\n#8 docker\u306e\u30c7\u30d0\u30c3\u30b0\u30aa\u30d7\u30b7\u30e7\u30f3\n##8.1 \u30c7\u30d0\u30c3\u30b0\u30aa\u30d7\u30b7\u30e7\u30f3\u306e\u6307\u5b9a\u65b9\u6cd5\n\u5b9a\u7fa9\u30d5\u30a1\u30a4\u30eb(/etc/sysconfig/docker)\u306e--log-level\u306b\u30c7\u30d0\u30c3\u30b0\u30ec\u30d9\u30eb\u3092\u6307\u5b9a\u3059\u308b\u3002\n\u30c7\u30d0\u30c3\u30b0\u30ec\u30d9\u30eb\u3068\u3057\u3066\u306f\u4ee5\u4e0b\u306e\u3082\u306e\u304c\u3042\u308b\u3002fatal\u304c\u6700\u3082\u91cd\u8981\u5ea6\u304c\u9ad8\u304f\u3001debug\u304c\u6700\u3082\u91cd\u8981\u5ea6\u304c\u4f4e\u3044\u3002\n\n\u30001. fatal(\u512a\u5148\u5ea6\u9ad8)\n\u30002. error\n\u30003. warning\n\u30004. info(\u30c7\u30d5\u30a9\u30eb\u30c8)\n\u30005. debug(\u512a\u5148\u5ea6\u4f4e)\n\n\u30c7\u30d5\u30a9\u30eb\u30c8\u306finfo\u30ec\u30d9\u30eb\u306b\u306a\u3063\u3066\u3044\u308b\u3002info\u4ee5\u4e0a\u306e\u30ed\u30b0\u3092\u51fa\u529b\u3059\u308b\u3002\ndebug\u3092\u6307\u5b9a\u3059\u308b\u3068\u3001\u5168\u3066\u306e\u30ec\u30d9\u30eb\u306e\u30ed\u30b0\u3092\u51fa\u529b\u3059\u308b\u3053\u3068\u306b\u306a\u308b\u3002\n\n\u30c7\u30d0\u30c3\u30b0\u30ec\u30d9\u30eb\u306bdebug\u3092\u6307\u5b9a\u3057\u305f\u5834\u5408\u3092\u4ee5\u4e0b\u306b\u793a\u3059\u3002\n[root@master ~]# vi /etc/sysconfig/docker\nOPTIONS='--log-level=debug'\n\n\n##8.2 info\u3092\u6307\u5b9a\u3057\u305f\u5834\u5408(\u5f97\u306b\u6307\u5b9a\u3057\u306a\u304f\u3066\u3082\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30ec\u30d9\u30eb)\n\n```\ndocker\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master ~]# systemctl start docker\n\n\u5225\u306e\u30bf\u30fc\u30df\u30ca\u30eb\u3092\u3072\u3089\u3044\u3066\u3001syslog\u3092\u78ba\u8a8d\u3059\u308b\u3002warning\u3068info\u30ec\u30d9\u30eb\u306e\u30ed\u30b0\u304c\u51fa\u529b\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master ~]# tail -f /var/log/messages|grep -E '(fatal|error|warning|info|debug)'\nMar 12 10:02:46 master dockerd-current: time=\"2017-03-12T10:02:46.494348443+09:00\" level=info msg=\"libcontainerd: new containerd process, pid: 12877\"\nMar 12 10:02:47 master dockerd-current: time=\"2017-03-12T10:02:47.734320975+09:00\" level=warning msg=\"devmapper: Usage of loopback devices is strongly discouraged for production use. Please use `--storage-opt dm.thinpooldev` or use `man docker` to refer to dm.thinpooldev section.\"\nMar 12 10:02:47 master dockerd-current: time=\"2017-03-12T10:02:47.937309476+09:00\" level=warning msg=\"devmapper: Base device already exists and has filesystem xfs on it. User specified filesystem  will be ignored.\"\nMar 12 10:02:48 master dockerd-current: time=\"2017-03-12T10:02:48.031061132+09:00\" level=info msg=\"[graphdriver] using prior storage driver \\\"devicemapper\\\"\"\nMar 12 10:02:48 master dockerd-current: time=\"2017-03-12T10:02:48.054100692+09:00\" level=info msg=\"Graph migration to content-addressability took 0.00 seconds\"\nMar 12 10:02:48 master dockerd-current: time=\"2017-03-12T10:02:48.058632306+09:00\" level=info msg=\"Loading containers: start.\"\nMar 12 10:02:49 master dockerd-current: time=\"2017-03-12T10:02:49.018324023+09:00\" level=info msg=\"Loading containers: done.\"\nMar 12 10:02:49 master dockerd-current: time=\"2017-03-12T10:02:49.021027153+09:00\" level=info msg=\"Daemon has completed initialization\"\nMar 12 10:02:49 master dockerd-current: time=\"2017-03-12T10:02:49.021911520+09:00\" level=info msg=\"Docker daemon\" commit=\"047e51b/1.12.5\" graphdriver=devicemapper version=1.12.5\nMar 12 10:02:49 master dockerd-current: time=\"2017-03-12T10:02:49.106995415+09:00\" level=info msg=\"API listen on /var/run/docker.sock\"\n\n```\n\n\n##8.3 warning\u3092\u6307\u5b9a\u3057\u305f\u5834\u5408\n\n```\n[root@master ~]# vi /etc/sysconfig/docker\nOPTIONS='--log-level=warning'\n\ndocker\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master ~]# systemctl start docker\n\n\u5225\u306e\u30bf\u30fc\u30df\u30ca\u30eb\u3092\u3072\u3089\u3044\u3066\u3001syslog\u3092\u78ba\u8a8d\u3059\u308b\u3002warning\u30ec\u30d9\u30eb\u306e\u30ed\u30b0\u3060\u3051\u304c\u51fa\u529b\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\ninfo\u30ec\u30d9\u30eb\u306e\u30ed\u30b0\u306f\u51fa\u529b\u3055\u308c\u306a\u304f\u306a\u3063\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\nMar 12 10:15:09 master dockerd-current: time=\"2017-03-12T10:15:09.791169342+09:00\" level=warning msg=\"devmapper: Usage of loopback devices is strongly discouraged for production use. Please use `--storage-opt dm.thinpooldev` or use `man docker` to refer to dm.thinpooldev section.\"\nMar 12 10:15:09 master dockerd-current: time=\"2017-03-12T10:15:09.962940297+09:00\" level=warning msg=\"devmapper: Base device already exists and has filesystem xfs on it. User specified filesystem  will be ignored.\"\n\n```\n\n\n#9.\u5404\u7a2e\u30a4\u30e1\u30fc\u30b8\u306e\u8d77\u52d5\n\n```\n----------------\n1. CentOS5.11\n----------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -it --rm centos:centos5.11 bash\nUnable to find image 'centos:centos5.11' locally\nTrying to pull repository docker.io/library/centos ...\ncentos5.11: Pulling from docker.io/library/centos\n2068b24f564b: Pull complete\nDigest: sha256:c40041f5894293d0df8f5c6c2049b92a82c53f1718ecdd73cbf3c1826a08ba4a\nStatus: Downloaded newer image for docker.io/centos:centos5.11\n\n\u7248\u6570\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@4d4c5a456ff3 /]# cat /etc/redhat-release\nCentOS release 5.11 (Final)\n\n[root@master1 ~]# docker images centos:centos5.11\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\ndocker.io/centos    centos5.11          b424fba01172        4 months ago        284.1 MB\n\n----------------\n2. CentOS6.8\n----------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -it --rm centos:centos6.8 bash\nUnable to find image 'centos:centos6.8' locally\nTrying to pull repository docker.io/library/centos ...\ncentos6.8: Pulling from docker.io/library/centos\n67f15db7c18f: Pull complete\nDigest: sha256:37ee2dcd9a3a430136b566efb4aa1111ed332bfdef8b0de51a25d26891689fd7\nStatus: Downloaded newer image for docker.io/centos:centos6.8\n\n\u7248\u6570\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@805bd6c7ec2f /]# cat /etc/redhat-release\nCentOS release 6.8 (Final)\n[root@805bd6c7ec2f /]#\n\n[root@master1 ~]# docker images centos:centos6.8\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\ndocker.io/centos    centos6.8           0cd976dc0a98        4 months ago        194.5 MB\n\n----------------\n3. CentOS7.2\n----------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -it centos:centos7.2.1511 bash\n\n\u7248\u6570\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@7726e3a77531 /]# cat /etc/redhat-release\nCentOS Linux release 7.2.1511 (Core)\n[root@7726e3a77531 /]#\n[root@7726e3a77531 /]# exit\nexit\n[root@master1 ~]# docker images centos:centos7.2.1511\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\ndocker.io/centos    centos7.2.1511      feac5e0dfdb2        4 months ago        194.6 MB\n[root@master1 ~]#\n\n----------------\n4. CentOS7.3\n----------------\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# docker run -it centos:centos7.3.1611 bash\nUnable to find image 'centos:centos7.3.1611' locally\nTrying to pull repository docker.io/library/centos ...\ncentos7.3.1611: Pulling from docker.io/library/centos\nDigest: sha256:c577af3197aacedf79c5a204cd7f493c8e07ffbce7f88f7600bf19c688c38799\nStatus: Downloaded newer image for docker.io/centos:centos7.3.1611\n\n\u7248\u6570\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@b66640a84593 /]# cat /etc/redhat-release\nCentOS Linux release 7.3.1611 (Core)\n[root@b66640a84593 /]# exit\nexit\n[root@master1 ~]# docker images centos:centos7.3.1611\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\ndocker.io/centos    centos7.3.1611      67591570dd29        5 weeks ago         191.8 MB\n[root@master1 ~]#\n\n```\n\n\n\n#10. \u53c2\u8003\u8cc7\u6599\n[Docker\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30ea\u30dd\u30b8\u30c8\u30ea(Docker Registry)\u69cb\u7bc9\u30ec\u30b7\u30d4](http://dev.classmethod.jp/cloud/docker-registry-recipes/)\n[Docker \u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u65e5\u672c\u8a9e\u5316\u30d7\u30ed\u30b8\u30a7\u30af\u30c8](http://docs.docker.jp/index.html)\n[\u3055\u304f\u3089\u306e\u30ca\u30ec\u30c3\u30b8](http://knowledge.sakura.ad.jp/knowledge/5118/)\n[Docker Content Trust \u5165\u9580](http://pocketstudio.jp/log3/2015/08/14/content-trust-docker-1-8-ja/)\n[Docker Content Trust Gets Hardware Signing](https://blog.docker.com/2015/11/docker-content-trust-yubikey/)\n[Alien (\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2)](https://ja.wikipedia.org/wiki/Alien_(%E3%82%BD%E3%83%95%E3%83%88%E3%82%A6%E3%82%A7%E3%82%A2))\n[Dockerfile \u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9 ](https://www.qoosky.io/techs/f38c112ca9)\n\n[Docker\u5b9f\u8df5\u5165\u9580](http://gihyo.jp/book/2015/978-4-7741-7654-3)\n[Docker\u5b9f\u8df5\u30ac\u30a4\u30c9](http://book.impress.co.jp/books/1115101002)\n[\u30d7\u30ed\u30b0\u30e9\u30de\u306e\u305f\u3081\u306eDocker\u6559\u79d1\u66f8 \u30a4\u30f3\u30d5\u30e9\u306e\u57fa\u790e\u77e5\u8b58\uff06\u30b3\u30fc\u30c9\u306b\u3088\u308b\u74b0\u5883\u69cb\u7bc9\u306e\u81ea\u52d5\u5316](http://www.shoeisha.co.jp/book/detail/9784798141022)\n\n[Create the smallest possible Docker container](http://blog.xebia.com/create-the-smallest-possible-docker-container/)\n[[\u521d\u5fc3\u8005\u5411\u3051] Docker\u30b3\u30f3\u30c6\u30ca\u306e\u5185\u5074](http://www.cloudninja.asia/insideofcontainer/)\n[Docker/Aarukas\u5165\u9580\u30cf\u30f3\u30ba\u30aa\u30f3\u8cc7\u6599\uff5e\u7b2c1\u56de\u3055\u304f\u3089\u3068\u30b3\u30f3\u30c6\u30ca\u306e\u5915\u3079 #\u3055\u304f\u3089\u306e\u5915\u3079 \u756a\u5916\u7de8](https://www.slideshare.net/zembutsu/docker-hands-on-training-sakura-container-evening)\n\n\n", "tags": ["docker", "dockerfile", "centos7", "kubernetes"]}