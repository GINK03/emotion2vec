{"context": "\u7b2c\u4e00\u56de\u3067\u306f\u3001DVR\u306e\u7c21\u5358\u306a\u8aac\u660e\u3068\u74b0\u5883\u306e\u8aac\u660e\u3092\u3057\u307e\u3057\u305f\u3002\n\u7b2c\u4e8c\u56de\u3067\u306f\u3001North-South \u901a\u4fe1\u306b\u3064\u3044\u3066\u898b\u3066\u3044\u304d\u307e\u3059\u3002\n\nNorth-South \u901a\u4fe1\n\nFloating IP \u3092\u4f7f\u7528\u3057\u306a\u3044\u5834\u5408\nFloating IP \u3092\u4f7f\u7528\u3057\u306a\u3044\u5834\u5408\u3001\u5916\u90e8\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3078\u306e\u30a2\u30af\u30bb\u30b9\u3059\u308b\u969b\u306f\u3001\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b Controller Node \u3092\u7d4c\u7531\u3057\u3066\u5916\u90e8\u3068\u306e\u901a\u4fe1\u3092\u884c\u3044\u307e\u3059\u3002\n\n\u305d\u308c\u3067\u306f\u3001\u9806\u3092\u8ffd\u3063\u3066\u898b\u3066\u3044\u304d\u307e\u3057\u3087\u3046\u3002\n\nVM#1 \u306f\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u306e\u8a2d\u5b9a\u306b\u5f93\u3044\u3001qbr*** \u304a\u3088\u3073 br-int \u30b9\u30a4\u30c3\u30c1\u3092\u7d4c\u7531\u3057\u3066\u3001\n\u81ea\u30db\u30b9\u30c8\u306e\u4eee\u60f3\u30eb\u30fc\u30bf\uff08qrouter-***\uff09\u3078\u5230\u9054\u3057\u307e\u3059\u3002\n\u3053\u306e\u3068\u304d\u3001Src IP \u304a\u3088\u3073 Src MAC \u306f VM#1 \u306e\u60c5\u5831\u3068\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n\nqrouter \u306b\u5230\u9054\u3057\u305f\u5f8c\u3001Dst MAC \u304c Controller Node \u306e sg-*** \u306e MAC \u3078\u3068\u66f8\u304d\u63db\u3048\u3089\u308c\u307e\u3059\u3002\n\n\n\u305d\u306e\u5f8c\u3001br-tun \u306b\u3066\u3001Src MAC \u304c DVR\u3092\u4f7f\u7528\u3059\u308b\u969b\u306b\u4f7f\u7528\u3059\u308b\u81ea\u30db\u30b9\u30c8\u306eMAC(\u203b1)\u3078\u3068\u66f8\u304d\u63db\u3048\u3089\u308c(\u203b2)\u3001\nDst MAC \u3068\u3057\u3066 sg-*** \u304c\u6307\u5b9a\u3055\u308c\u3066\u3044\u308b\u305f\u3081\u3001Private \u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3092\u4f7f\u7528\u3057\u305f\u30c8\u30f3\u30cd\u30eb\u901a\u4fe1\uff08\u4eca\u56de\u306e\u5834\u5408 vxlan\uff09\u3067\nController Node \u3078\u3068\u5411\u304b\u3044\u307e\u3059\u3002\n\n\nController Node \u306b\u5230\u9054\u3057\u305f\u5f8c\u3001Controller Node \u4e0a\u306e sg-*** \u3078\u3068\u5230\u9054\u3057\u307e\u3059\u3002\n\u3053\u306e\u3068\u304d\u306e Src MAC \u306f\u3001Controller Node \u306e MAC\u30a2\u30c9\u30ec\u30b9\u3068\u306a\u308a\u307e\u3059\u3002\n\n\nNamespace snat-*** \u3067\u306f\u3001\u5916\u90e8\u901a\u4fe1\u306e\u305f\u3081\u3001Src MAC/IP \u304c\u3000qg-*** \u306e\u60c5\u5831\u306b\u3001\nDst MAC \u304c Controller Node \u306e Default\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u306e\u3082\u306e\u3078\u3068\u66f8\u304d\u63db\u3048\u3089\u308c\u307e\u3059\u3002\n\n\n\u305d\u306e\u5f8c\u3001Namespace snat-*** \u306e qg-***\u3001br-int\u3001br-floating\u3001br-ex \u3092\u7d4c\u7531\u3057\u3066\u3001 \nDst MAC \u3067\u6307\u5b9a\u3055\u308c\u3066\u3044\u308b\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u3078\u5230\u9054\u3057\u3001\u30a4\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8\u3078\u30a2\u30af\u30bb\u30b9\u3057\u307e\u3059\u3002\n\nFloating IP \u3092\u4f7f\u7528\u3057\u306a\u3044 North-South \u901a\u4fe1\u3067\u306f\u3001\n\u5916\u90e8\u3078\u306e\u30a2\u30af\u30bb\u30b9\u304c Controller Node \u306b\u4e00\u6975\u96c6\u4e2d\u3057\u3066\u304a\u308a\u3001DVR \u306e\u30e1\u30ea\u30c3\u30c8\u304c\u3046\u307e\u304f\u6d3b\u304d\u3066\u3044\u307e\u305b\u3093\u3002\n\nFloating IP \u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\nFloating IP \u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\u306f\u3069\u3046\u3067\u3057\u3087\u3046\u304b\u3002\n\n\u3053\u3061\u3089\u306f\u3001Compute Node \u306e br-ex \u304b\u3089\u5916\u90e8\u3078\u30a2\u30af\u30bb\u30b9\u3057\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\n\nFloating IP \u3068\u540c\u69d8\u3001VM#1 \u306f\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u306e\u8a2d\u5b9a\u306b\u5f93\u3044\u3001qbr*** \u304a\u3088\u3073 br-int \u30b9\u30a4\u30c3\u30c1\u3092\u7d4c\u7531\u3057\u3066\u3001\n\u81ea\u30db\u30b9\u30c8\u306e\u4eee\u60f3\u30eb\u30fc\u30bf\uff08qrouter-***\uff09\u3078\u5230\u9054\u3057\u307e\u3059\u3002\nSrc IP \u304a\u3088\u3073 Src MAC \u306f VM#1 \u306e\u60c5\u5831\u3068\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n\nqrouter \u306b\u5230\u9054\u3057\u305f\u5f8c\u3001Dst MAC \u304c fpr-*** \u306e MAC \u3078\u3068\u66f8\u304d\u63db\u3048\u3089\u308c\u3001\nSrc IP/MAC \u304c\u3001frp-*** \u306e\u3082\u306e\uff08Floating IP \u3068\u540c\u4e00\uff09\u3068\u306a\u308a\u307e\u3059\u3002\n\n\n\u305d\u3057\u3066\u3001Namespace fip-*** \u3078\u5230\u9054\u3057\u305f\u5f8c\u3001Src MAC \u304c fg-*** \u306e MAC \u306b\u3001\nDst MAC \u304c Compute Node \u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u306eMAC\u3078\u3068\u66f8\u304d\u63db\u308f\u308a\u307e\u3059\u3002\n\n\n\u305d\u306e\u5f8c\u3001Namespace fip-*** \u306e fg-***\u3001br-int\u3001ber-floating\u3001br-ex \u3092\u7d4c\u7531\u3057\u3066\u3001 \nDst MAC \u3067\u6307\u5b9a\u3055\u308c\u3066\u3044\u308b\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u3078\u5230\u9054\u3057\u3001\u30a4\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8\u3078\u30a2\u30af\u30bb\u30b9\u3057\u307e\u3059\u3002\n\n\n\u88dc\u8db3\nNamespace \u3092\u4e2d\u5fc3\u306b\u8abf\u3079\u305f\u7d50\u679c\u3092\u3044\u304f\u3064\u304b\u4ee5\u4e0b\u306b\u8a18\u8f09\u3057\u307e\u3059\u3002\n\nNamespace\n\u30b5\u30d6\u30cd\u30c3\u30c8\u3054\u3068\u306b\u4eee\u60f3\u30eb\u30fc\u30bf\uff08qrouter-***\uff09\u304c\u751f\u6210\u3055\u308c\u3066\u3044\u304d\u307e\u3059\u3002\nfip-*** \u306f\u5404 Compute Node \u6bce\u306b\uff11\u3064\u3068\u306a\u308a\u307e\u3059\u3002\nroot@compute01:~# ip netns\nqrouter-703db450-5cd2-4f8c-a525-a0cd9f90cb3f\nqrouter-13fe8525-da22-42de-aeb6-84f41a3b607d\nfip-02e2d514-529e-4067-bbf4-807943ea6472\nqrouter-242fcb80-e9e1-410b-ba4e-7617d1c384ad\n\n\nNamespace fip-*** \u306e NIC\n\u4ee5\u4e0b\u306e\u901a\u308a\u3001\u4eee\u60f3\u30de\u30b7\u30f3\u3078 Floating IP \u3092\u5272\u308a\u5f53\u3066\u305f\u969b\u306b\u5bfe\u5fdc\u3059\u308b\u4eee\u60f3\u30eb\u30fc\u30bf\u3068\u63a5\u7d9a\u3059\u308b\u305f\u3081\u306e NIC\uff08fpr-***\uff09\u304c\u751f\u6210\u3055\u308c\u307e\u3059\u3002\n\n\u4eee\u60f3\u30de\u30b7\u30f3\uff08VM#1\uff09\u3078\u306e Floating IP \u5272\u308a\u5f53\u3066\u524d\n\nroot@compute01:~# ip netns exec fip-02e2d514-529e-4067-bbf4-807943ea6472 ip addr\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n    inet6 ::1/128 scope host\n       valid_lft forever preferred_lft forever\n21: fpr-703db450-5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 3a:0b:24:74:57:0d brd ff:ff:ff:ff:ff:ff\n    inet 169.254.30.51/31 scope global fpr-703db450-5\n       valid_lft forever preferred_lft forever\n    inet6 fe80::380b:24ff:fe74:570d/64 scope link\n       valid_lft forever preferred_lft forever\n26: fg-6e12764c-ba: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UNKNOWN group default\n    link/ether fa:16:3e:d2:85:89 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.74.103/24 brd 192.168.74.255 scope global fg-6e12764c-ba\n       valid_lft forever preferred_lft forever\n    inet6 fe80::f816:3eff:fed2:8589/64 scope link\n       valid_lft forever preferred_lft forever\n\n\n\u4eee\u60f3\u30de\u30b7\u30f3\uff08VM#1\uff09\u3078\u306e Floating IP \u5272\u308a\u5f53\u3066\u5f8c\n\nroot@compute01:~# ip netns exec fip-02e2d514-529e-4067-bbf4-807943ea6472 ip addr\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n    inet6 ::1/128 scope host\n       valid_lft forever preferred_lft forever\n19: fpr-13fe8525-d: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 2e:8b:6f:f5:ee:8d brd ff:ff:ff:ff:ff:ff\n    inet 169.254.31.105/31 scope global fpr-13fe8525-d\n       valid_lft forever preferred_lft forever\n    inet6 fe80::2c8b:6fff:fef5:ee8d/64 scope link\n       valid_lft forever preferred_lft forever\n21: fpr-703db450-5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 3a:0b:24:74:57:0d brd ff:ff:ff:ff:ff:ff\n    inet 169.254.30.51/31 scope global fpr-703db450-5\n       valid_lft forever preferred_lft forever\n    inet6 fe80::380b:24ff:fe74:570d/64 scope link\n       valid_lft forever preferred_lft forever\n26: fg-6e12764c-ba: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UNKNOWN group default\n    link/ether fa:16:3e:d2:85:89 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.74.103/24 brd 192.168.74.255 scope global fg-6e12764c-ba\n       valid_lft forever preferred_lft forever\n    inet6 fe80::f816:3eff:fed2:8589/64 scope link\n       valid_lft forever preferred_lft forever\n\n\nNamespace qrouter-*** \u306e NIC\nqrouter-*** \u3082 fip-*** \u3068\u540c\u69d8\u3001\u4eee\u60f3\u30de\u30b7\u30f3\u3078 Floating IP \u3092\u5272\u308a\u5f53\u3066\u305f\u969b\u306b\n\u5bfe\u5fdc\u3059\u308b\u4eee\u60f3\u30eb\u30fc\u30bf\u3068\u63a5\u7d9a\u3059\u308b\u305f\u3081\u306e NIC\uff08frp-***\uff09\u304c\u751f\u6210\u3055\u308c\u307e\u3059\u3002\n\n\u4eee\u60f3\u30de\u30b7\u30f3\uff08VM#1\uff09\u3078\u306e Floating IP \u5272\u308a\u5f53\u3066\u524d\n\nroot@compute01:~# ip netns exec qrouter-242fcb80-e9e1-410b-ba4e-7617d1c384ad ip addr\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n    inet6 ::1/128 scope host\n       valid_lft forever preferred_lft forever\n24: qr-b4b97d8a-7c: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 65000 qdisc noqueue state UNKNOWN group default\n    link/ether fa:16:3e:ac:30:ff brd ff:ff:ff:ff:ff:ff\n    inet 192.168.111.1/24 brd 192.168.111.255 scope global qr-b4b97d8a-7c\n       valid_lft forever preferred_lft forever\n    inet6 fe80::f816:3eff:feac:30ff/64 scope link\n       valid_lft forever preferred_lft forever\n\n\n\u4eee\u60f3\u30de\u30b7\u30f3\uff08VM#1\uff09\u3078\u306e Floating IP \u5272\u308a\u5f53\u3066\u5f8c\n\nroot@compute01:~# ip netns exec qrouter-242fcb80-e9e1-410b-ba4e-7617d1c384ad ip addr\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n    inet6 ::1/128 scope host\n       valid_lft forever preferred_lft forever\n3: rfp-242fcb80-e: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 02:9f:83:86:46:4c brd ff:ff:ff:ff:ff:ff\n    inet 169.254.31.74/31 scope global rfp-242fcb80-e\n       valid_lft forever preferred_lft forever\n    inet 192.168.74.104/32 brd 192.168.74.104 scope global rfp-242fcb80-e\n       valid_lft forever preferred_lft forever\n    inet6 fe80::9f:83ff:fe86:464c/64 scope link\n       valid_lft forever preferred_lft forever\n24: qr-b4b97d8a-7c: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 65000 qdisc noqueue state UNKNOWN group default\n    link/ether fa:16:3e:ac:30:ff brd ff:ff:ff:ff:ff:ff\n    inet 192.168.111.1/24 brd 192.168.111.255 scope global qr-b4b97d8a-7c\n       valid_lft forever preferred_lft forever\n    inet6 fe80::f816:3eff:feac:30ff/64 scope link\n       valid_lft forever preferred_lft forever\n\n\nNamespace \u5185\u306e NIC \u3067\u306e tcpdump\nNamespace \u5185\u306e NIC \u306b\u5bfe\u3057\u3066\u3082 tcpdump\u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u7528\u3057\u305f\u30d1\u30b1\u30c3\u30c8\u30ad\u30e3\u30d7\u30c1\u30e3\u3092\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\nroot@compute01:~# ip netns exec qrouter-13fe8525-da22-42de-aeb6-84f41a3b607d tcpdump -n -i qr-85285e17-5d\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on qr-85285e17-5d, link-type EN10MB (Ethernet), capture size 65535 bytes\n^C02:54:00.544983 IP 10.16.0.3 > 8.8.8.8: ICMP echo request, id 42550, seq 5, length 64\n02:54:00.545021 IP 10.16.0.3 > 8.8.8.8: ICMP echo request, id 42550, seq 5, length 64\n02:54:00.548426 ARP, Request who-has 10.16.0.1 tell 10.16.0.3, length 28\n02:54:00.548440 ARP, Reply 10.16.0.1 is-at fa:16:3e:84:64:cc, length 28\n02:54:01.545141 IP 10.16.0.3 > 8.8.8.8: ICMP echo request, id 42550, seq 6, length 64\n02:54:01.545172 IP 10.16.0.3 > 8.8.8.8: ICMP echo request, id 42550, seq 6, length 64\n02:54:02.545399 IP 10.16.0.3 > 8.8.8.8: ICMP echo request, id 42550, seq 7, length 64\n\n\n\u6ce8\u91c8\n\u203b1\u00a0\u00a0\u00a0DVR\u3092\u4f7f\u7528\u3059\u308b\u969b\u306b\u4f7f\u7528\u3059\u308b\u81ea\u30db\u30b9\u30c8\u306eMAC\nDVR\u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\u3001\u5185\u90e8\u901a\u4fe1\u3067\u4f7f\u7528\u3055\u308c\u308b MAC \u30a2\u30c9\u30ec\u30b9\u3067\u3059\u3002\n\u5404\u30db\u30b9\u30c8\u3054\u3068\u306b\u30e6\u30cb\u30fc\u30af\u306a\u5024\u3068\u306a\u3063\u3066\u304a\u308a\u3001dvr_host_macs \u30c6\u30fc\u30d6\u30eb\u3067\u7ba1\u7406\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\uff08neutron.conf \u306e dvr_base_mac \u3067MAC\u30a2\u30c9\u30ec\u30b9\u3092\u5909\u66f4\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u308b\u3088\u3046\u3067\u3059\u3002\uff09\nmysql> select * from neutron.dvr_host_macs;\n+-------------------------+-------------------+\n| host                    | mac_address       |\n+-------------------------+-------------------+\n| compute02.domain.tld    | fa:16:3f:6d:9f:cd |\n| compute01.domain.tld    | fa:16:3f:86:5c:5c |\n| controller01.domain.tld | fa:16:3f:e7:70:87 |\n+-------------------------+-------------------+\n3 rows in set (0.00 sec)\n\n\u203b2\u00a0\u00a0\u00a0br-tun \u306b\u304a\u3051\u308b Src MAC \u306e DVR\u3092\u4f7f\u7528\u3059\u308b\u969b\u306b\u4f7f\u7528\u3059\u308b\u81ea\u30db\u30b9\u30c8\u306eMAC \u3078\u306e\u66f8\u304d\u63db\u3048\n\u4ee5\u4e0b\u306e\u30b1\u30fc\u30b9\u3067\u306f\u3001\n\nSrc MAC \u304c\u3001compute01 \u306e\u4eee\u60f3\u30eb\u30fc\u30bf(qrouter-***) \u306e qr-*** \u306e MAC \u3068\u306a\u3063\u3066\u3044\u308b\u5834\u5408\u3001\nDVR\u3092\u4f7f\u7528\u3059\u308b\u969b\u306b\u4f7f\u7528\u3059\u308b\u81ea\u30db\u30b9\u30c8(compute01)\u306eMAC \u3078\u3068\u66f8\u304d\u63db\u3048\u3089\u308c\u308b\n\nroot@compute01:~# ovs-ofctl dump-flows br-tun\n cookie=0x9993ab7371e38af2, duration=8878.130s, table=1, n_packets=1838, n_bytes=179875, idle_age=0, priority=1,dl_vlan=1,dl_src=fa:16:3e:bc:4c:74 actions=mod_dl_src:fa:16:3f:86:5c:5c,resubmit(,2)\n\n[\u7b2c\u4e00\u56de](http://qiita.com/h-otsuka/items/d6ebbca982897a47ed6a)\u3067\u306f\u3001DVR\u306e\u7c21\u5358\u306a\u8aac\u660e\u3068\u74b0\u5883\u306e\u8aac\u660e\u3092\u3057\u307e\u3057\u305f\u3002\n\u7b2c\u4e8c\u56de\u3067\u306f\u3001North-South \u901a\u4fe1\u306b\u3064\u3044\u3066\u898b\u3066\u3044\u304d\u307e\u3059\u3002\n\n# North-South \u901a\u4fe1\n## Floating IP \u3092\u4f7f\u7528\u3057\u306a\u3044\u5834\u5408\nFloating IP \u3092\u4f7f\u7528\u3057\u306a\u3044\u5834\u5408\u3001\u5916\u90e8\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3078\u306e\u30a2\u30af\u30bb\u30b9\u3059\u308b\u969b\u306f\u3001\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b Controller Node \u3092\u7d4c\u7531\u3057\u3066\u5916\u90e8\u3068\u306e\u901a\u4fe1\u3092\u884c\u3044\u307e\u3059\u3002\n![simple_ns1 (3).png](https://qiita-image-store.s3.amazonaws.com/0/121387/203752f5-149a-85ee-a972-a4ec613665cd.png)\n\n\n\n\u305d\u308c\u3067\u306f\u3001\u9806\u3092\u8ffd\u3063\u3066\u898b\u3066\u3044\u304d\u307e\u3057\u3087\u3046\u3002\n\n1. VM#1 \u306f\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u306e\u8a2d\u5b9a\u306b\u5f93\u3044\u3001qbr\\*\\*\\* \u304a\u3088\u3073 br-int \u30b9\u30a4\u30c3\u30c1\u3092\u7d4c\u7531\u3057\u3066\u3001\n\u81ea\u30db\u30b9\u30c8\u306e\u4eee\u60f3\u30eb\u30fc\u30bf\uff08qrouter-\\*\\*\\*\uff09\u3078\u5230\u9054\u3057\u307e\u3059\u3002\n\u3053\u306e\u3068\u304d\u3001Src IP \u304a\u3088\u3073 Src MAC \u306f VM#1 \u306e\u60c5\u5831\u3068\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n<br><br>\n2. qrouter \u306b\u5230\u9054\u3057\u305f\u5f8c\u3001Dst MAC \u304c Controller Node \u306e sg-\\*\\*\\* \u306e MAC \u3078\u3068\u66f8\u304d\u63db\u3048\u3089\u308c\u307e\u3059\u3002\n<br><br>\n3. \u305d\u306e\u5f8c\u3001br-tun \u306b\u3066\u3001Src MAC \u304c DVR\u3092\u4f7f\u7528\u3059\u308b\u969b\u306b\u4f7f\u7528\u3059\u308b\u81ea\u30db\u30b9\u30c8\u306eMAC(\u203b1)\u3078\u3068\u66f8\u304d\u63db\u3048\u3089\u308c(\u203b2)\u3001\nDst MAC \u3068\u3057\u3066 sg-\\*\\*\\* \u304c\u6307\u5b9a\u3055\u308c\u3066\u3044\u308b\u305f\u3081\u3001Private \u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3092\u4f7f\u7528\u3057\u305f\u30c8\u30f3\u30cd\u30eb\u901a\u4fe1\uff08\u4eca\u56de\u306e\u5834\u5408 vxlan\uff09\u3067\nController Node \u3078\u3068\u5411\u304b\u3044\u307e\u3059\u3002\n<br><br>\n4. Controller Node \u306b\u5230\u9054\u3057\u305f\u5f8c\u3001Controller Node \u4e0a\u306e sg-\\*\\*\\* \u3078\u3068\u5230\u9054\u3057\u307e\u3059\u3002\n\u3053\u306e\u3068\u304d\u306e Src MAC \u306f\u3001Controller Node \u306e MAC\u30a2\u30c9\u30ec\u30b9\u3068\u306a\u308a\u307e\u3059\u3002\n<br><br>\n5. Namespace snat-\\*\\*\\* \u3067\u306f\u3001\u5916\u90e8\u901a\u4fe1\u306e\u305f\u3081\u3001Src MAC/IP \u304c\u3000qg-\\*\\*\\* \u306e\u60c5\u5831\u306b\u3001\nDst MAC \u304c Controller Node \u306e Default\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u306e\u3082\u306e\u3078\u3068\u66f8\u304d\u63db\u3048\u3089\u308c\u307e\u3059\u3002\n<br><br>\n6. \u305d\u306e\u5f8c\u3001Namespace snat-\\*\\*\\* \u306e qg-\\*\\*\\*\u3001br-int\u3001br-floating\u3001br-ex \u3092\u7d4c\u7531\u3057\u3066\u3001 \nDst MAC \u3067\u6307\u5b9a\u3055\u308c\u3066\u3044\u308b\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u3078\u5230\u9054\u3057\u3001\u30a4\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8\u3078\u30a2\u30af\u30bb\u30b9\u3057\u307e\u3059\u3002\n\n\nFloating IP \u3092\u4f7f\u7528\u3057\u306a\u3044 North-South \u901a\u4fe1\u3067\u306f\u3001\n\u5916\u90e8\u3078\u306e\u30a2\u30af\u30bb\u30b9\u304c Controller Node \u306b\u4e00\u6975\u96c6\u4e2d\u3057\u3066\u304a\u308a\u3001DVR \u306e\u30e1\u30ea\u30c3\u30c8\u304c\u3046\u307e\u304f\u6d3b\u304d\u3066\u3044\u307e\u305b\u3093\u3002\n\n## Floating IP \u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\nFloating IP \u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\u306f\u3069\u3046\u3067\u3057\u3087\u3046\u304b\u3002\n![simple_ns2 (1).png](https://qiita-image-store.s3.amazonaws.com/0/121387/a17e6346-0d86-368b-4cd9-03b54a453705.png)\n\n\u3053\u3061\u3089\u306f\u3001Compute Node \u306e br-ex \u304b\u3089\u5916\u90e8\u3078\u30a2\u30af\u30bb\u30b9\u3057\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\n\n1. Floating IP \u3068\u540c\u69d8\u3001VM#1 \u306f\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u306e\u8a2d\u5b9a\u306b\u5f93\u3044\u3001qbr\\*\\*\\* \u304a\u3088\u3073 br-int \u30b9\u30a4\u30c3\u30c1\u3092\u7d4c\u7531\u3057\u3066\u3001\n\u81ea\u30db\u30b9\u30c8\u306e\u4eee\u60f3\u30eb\u30fc\u30bf\uff08qrouter-\\*\\*\\*\uff09\u3078\u5230\u9054\u3057\u307e\u3059\u3002\nSrc IP \u304a\u3088\u3073 Src MAC \u306f VM#1 \u306e\u60c5\u5831\u3068\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n<br><br>\n2. qrouter \u306b\u5230\u9054\u3057\u305f\u5f8c\u3001Dst MAC \u304c fpr-\\*\\*\\* \u306e MAC \u3078\u3068\u66f8\u304d\u63db\u3048\u3089\u308c\u3001\nSrc IP/MAC \u304c\u3001frp-*** \u306e\u3082\u306e\uff08Floating IP \u3068\u540c\u4e00\uff09\u3068\u306a\u308a\u307e\u3059\u3002\n<br><br>\n3. \u305d\u3057\u3066\u3001Namespace fip-*** \u3078\u5230\u9054\u3057\u305f\u5f8c\u3001Src MAC \u304c fg-*** \u306e MAC \u306b\u3001\nDst MAC \u304c Compute Node \u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u306eMAC\u3078\u3068\u66f8\u304d\u63db\u308f\u308a\u307e\u3059\u3002\n<br><br>\n4. \u305d\u306e\u5f8c\u3001Namespace fip-\\*\\*\\* \u306e fg-\\*\\*\\*\u3001br-int\u3001ber-floating\u3001br-ex \u3092\u7d4c\u7531\u3057\u3066\u3001 \nDst MAC \u3067\u6307\u5b9a\u3055\u308c\u3066\u3044\u308b\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u3078\u5230\u9054\u3057\u3001\u30a4\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8\u3078\u30a2\u30af\u30bb\u30b9\u3057\u307e\u3059\u3002\n\n# \u88dc\u8db3\nNamespace \u3092\u4e2d\u5fc3\u306b\u8abf\u3079\u305f\u7d50\u679c\u3092\u3044\u304f\u3064\u304b\u4ee5\u4e0b\u306b\u8a18\u8f09\u3057\u307e\u3059\u3002\n\n## Namespace\n\u30b5\u30d6\u30cd\u30c3\u30c8\u3054\u3068\u306b\u4eee\u60f3\u30eb\u30fc\u30bf\uff08qrouter-\\*\\*\\*\uff09\u304c\u751f\u6210\u3055\u308c\u3066\u3044\u304d\u307e\u3059\u3002\nfip-\\*\\*\\* \u306f\u5404 Compute Node \u6bce\u306b\uff11\u3064\u3068\u306a\u308a\u307e\u3059\u3002\n\n```bash\nroot@compute01:~# ip netns\nqrouter-703db450-5cd2-4f8c-a525-a0cd9f90cb3f\nqrouter-13fe8525-da22-42de-aeb6-84f41a3b607d\nfip-02e2d514-529e-4067-bbf4-807943ea6472\nqrouter-242fcb80-e9e1-410b-ba4e-7617d1c384ad\n```\n### Namespace fip-\\*\\*\\* \u306e NIC\n\u4ee5\u4e0b\u306e\u901a\u308a\u3001\u4eee\u60f3\u30de\u30b7\u30f3\u3078 Floating IP \u3092\u5272\u308a\u5f53\u3066\u305f\u969b\u306b\u5bfe\u5fdc\u3059\u308b\u4eee\u60f3\u30eb\u30fc\u30bf\u3068\u63a5\u7d9a\u3059\u308b\u305f\u3081\u306e NIC\uff08fpr-***\uff09\u304c\u751f\u6210\u3055\u308c\u307e\u3059\u3002\n\n- \u4eee\u60f3\u30de\u30b7\u30f3\uff08VM#1\uff09\u3078\u306e Floating IP \u5272\u308a\u5f53\u3066\u524d\n\n```bash\nroot@compute01:~# ip netns exec fip-02e2d514-529e-4067-bbf4-807943ea6472 ip addr\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n    inet6 ::1/128 scope host\n       valid_lft forever preferred_lft forever\n21: fpr-703db450-5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 3a:0b:24:74:57:0d brd ff:ff:ff:ff:ff:ff\n    inet 169.254.30.51/31 scope global fpr-703db450-5\n       valid_lft forever preferred_lft forever\n    inet6 fe80::380b:24ff:fe74:570d/64 scope link\n       valid_lft forever preferred_lft forever\n26: fg-6e12764c-ba: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UNKNOWN group default\n    link/ether fa:16:3e:d2:85:89 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.74.103/24 brd 192.168.74.255 scope global fg-6e12764c-ba\n       valid_lft forever preferred_lft forever\n    inet6 fe80::f816:3eff:fed2:8589/64 scope link\n       valid_lft forever preferred_lft forever\n```\n\n- \u4eee\u60f3\u30de\u30b7\u30f3\uff08VM#1\uff09\u3078\u306e Floating IP \u5272\u308a\u5f53\u3066\u5f8c\n\n```bash\nroot@compute01:~# ip netns exec fip-02e2d514-529e-4067-bbf4-807943ea6472 ip addr\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n    inet6 ::1/128 scope host\n       valid_lft forever preferred_lft forever\n19: fpr-13fe8525-d: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 2e:8b:6f:f5:ee:8d brd ff:ff:ff:ff:ff:ff\n    inet 169.254.31.105/31 scope global fpr-13fe8525-d\n       valid_lft forever preferred_lft forever\n    inet6 fe80::2c8b:6fff:fef5:ee8d/64 scope link\n       valid_lft forever preferred_lft forever\n21: fpr-703db450-5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 3a:0b:24:74:57:0d brd ff:ff:ff:ff:ff:ff\n    inet 169.254.30.51/31 scope global fpr-703db450-5\n       valid_lft forever preferred_lft forever\n    inet6 fe80::380b:24ff:fe74:570d/64 scope link\n       valid_lft forever preferred_lft forever\n26: fg-6e12764c-ba: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UNKNOWN group default\n    link/ether fa:16:3e:d2:85:89 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.74.103/24 brd 192.168.74.255 scope global fg-6e12764c-ba\n       valid_lft forever preferred_lft forever\n    inet6 fe80::f816:3eff:fed2:8589/64 scope link\n       valid_lft forever preferred_lft forever\n```\n\n### Namespace qrouter-\\*\\*\\* \u306e NIC\nqrouter-\\*\\*\\* \u3082 fip-\\*\\*\\* \u3068\u540c\u69d8\u3001\u4eee\u60f3\u30de\u30b7\u30f3\u3078 Floating IP \u3092\u5272\u308a\u5f53\u3066\u305f\u969b\u306b\n\u5bfe\u5fdc\u3059\u308b\u4eee\u60f3\u30eb\u30fc\u30bf\u3068\u63a5\u7d9a\u3059\u308b\u305f\u3081\u306e NIC\uff08frp-\\*\\*\\*\uff09\u304c\u751f\u6210\u3055\u308c\u307e\u3059\u3002\n\n- \u4eee\u60f3\u30de\u30b7\u30f3\uff08VM#1\uff09\u3078\u306e Floating IP \u5272\u308a\u5f53\u3066\u524d\n\n```bash\nroot@compute01:~# ip netns exec qrouter-242fcb80-e9e1-410b-ba4e-7617d1c384ad ip addr\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n    inet6 ::1/128 scope host\n       valid_lft forever preferred_lft forever\n24: qr-b4b97d8a-7c: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 65000 qdisc noqueue state UNKNOWN group default\n    link/ether fa:16:3e:ac:30:ff brd ff:ff:ff:ff:ff:ff\n    inet 192.168.111.1/24 brd 192.168.111.255 scope global qr-b4b97d8a-7c\n       valid_lft forever preferred_lft forever\n    inet6 fe80::f816:3eff:feac:30ff/64 scope link\n       valid_lft forever preferred_lft forever\n```\n\n- \u4eee\u60f3\u30de\u30b7\u30f3\uff08VM#1\uff09\u3078\u306e Floating IP \u5272\u308a\u5f53\u3066\u5f8c\n\n```bash\nroot@compute01:~# ip netns exec qrouter-242fcb80-e9e1-410b-ba4e-7617d1c384ad ip addr\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n    inet6 ::1/128 scope host\n       valid_lft forever preferred_lft forever\n3: rfp-242fcb80-e: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 02:9f:83:86:46:4c brd ff:ff:ff:ff:ff:ff\n    inet 169.254.31.74/31 scope global rfp-242fcb80-e\n       valid_lft forever preferred_lft forever\n    inet 192.168.74.104/32 brd 192.168.74.104 scope global rfp-242fcb80-e\n       valid_lft forever preferred_lft forever\n    inet6 fe80::9f:83ff:fe86:464c/64 scope link\n       valid_lft forever preferred_lft forever\n24: qr-b4b97d8a-7c: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 65000 qdisc noqueue state UNKNOWN group default\n    link/ether fa:16:3e:ac:30:ff brd ff:ff:ff:ff:ff:ff\n    inet 192.168.111.1/24 brd 192.168.111.255 scope global qr-b4b97d8a-7c\n       valid_lft forever preferred_lft forever\n    inet6 fe80::f816:3eff:feac:30ff/64 scope link\n       valid_lft forever preferred_lft forever\n```\n\n### Namespace \u5185\u306e NIC \u3067\u306e tcpdump\nNamespace \u5185\u306e NIC \u306b\u5bfe\u3057\u3066\u3082 `tcpdump`\u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u7528\u3057\u305f\u30d1\u30b1\u30c3\u30c8\u30ad\u30e3\u30d7\u30c1\u30e3\u3092\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n```bash\nroot@compute01:~# ip netns exec qrouter-13fe8525-da22-42de-aeb6-84f41a3b607d tcpdump -n -i qr-85285e17-5d\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on qr-85285e17-5d, link-type EN10MB (Ethernet), capture size 65535 bytes\n^C02:54:00.544983 IP 10.16.0.3 > 8.8.8.8: ICMP echo request, id 42550, seq 5, length 64\n02:54:00.545021 IP 10.16.0.3 > 8.8.8.8: ICMP echo request, id 42550, seq 5, length 64\n02:54:00.548426 ARP, Request who-has 10.16.0.1 tell 10.16.0.3, length 28\n02:54:00.548440 ARP, Reply 10.16.0.1 is-at fa:16:3e:84:64:cc, length 28\n02:54:01.545141 IP 10.16.0.3 > 8.8.8.8: ICMP echo request, id 42550, seq 6, length 64\n02:54:01.545172 IP 10.16.0.3 > 8.8.8.8: ICMP echo request, id 42550, seq 6, length 64\n02:54:02.545399 IP 10.16.0.3 > 8.8.8.8: ICMP echo request, id 42550, seq 7, length 64\n```\n\n# \u6ce8\u91c8\n\u203b1&nbsp;&nbsp;&nbsp;DVR\u3092\u4f7f\u7528\u3059\u308b\u969b\u306b\u4f7f\u7528\u3059\u308b\u81ea\u30db\u30b9\u30c8\u306eMAC\n\nDVR\u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\u3001\u5185\u90e8\u901a\u4fe1\u3067\u4f7f\u7528\u3055\u308c\u308b MAC \u30a2\u30c9\u30ec\u30b9\u3067\u3059\u3002\n\u5404\u30db\u30b9\u30c8\u3054\u3068\u306b\u30e6\u30cb\u30fc\u30af\u306a\u5024\u3068\u306a\u3063\u3066\u304a\u308a\u3001dvr_host_macs \u30c6\u30fc\u30d6\u30eb\u3067\u7ba1\u7406\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\uff08neutron.conf \u306e dvr_base_mac \u3067MAC\u30a2\u30c9\u30ec\u30b9\u3092\u5909\u66f4\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u308b\u3088\u3046\u3067\u3059\u3002\uff09\n\n```bash\nmysql> select * from neutron.dvr_host_macs;\n+-------------------------+-------------------+\n| host                    | mac_address       |\n+-------------------------+-------------------+\n| compute02.domain.tld    | fa:16:3f:6d:9f:cd |\n| compute01.domain.tld    | fa:16:3f:86:5c:5c |\n| controller01.domain.tld | fa:16:3f:e7:70:87 |\n+-------------------------+-------------------+\n3 rows in set (0.00 sec)\n```\n\n\u203b2&nbsp;&nbsp;&nbsp;br-tun \u306b\u304a\u3051\u308b Src MAC \u306e DVR\u3092\u4f7f\u7528\u3059\u308b\u969b\u306b\u4f7f\u7528\u3059\u308b\u81ea\u30db\u30b9\u30c8\u306eMAC \u3078\u306e\u66f8\u304d\u63db\u3048\n\n\u4ee5\u4e0b\u306e\u30b1\u30fc\u30b9\u3067\u306f\u3001\n> Src MAC \u304c\u3001compute01 \u306e\u4eee\u60f3\u30eb\u30fc\u30bf(qrouter-\\*\\*\\*) \u306e qr-\\*\\*\\* \u306e MAC \u3068\u306a\u3063\u3066\u3044\u308b\u5834\u5408\u3001\nDVR\u3092\u4f7f\u7528\u3059\u308b\u969b\u306b\u4f7f\u7528\u3059\u308b\u81ea\u30db\u30b9\u30c8(compute01)\u306eMAC \u3078\u3068\u66f8\u304d\u63db\u3048\u3089\u308c\u308b\n\n```\nroot@compute01:~# ovs-ofctl dump-flows br-tun\n cookie=0x9993ab7371e38af2, duration=8878.130s, table=1, n_packets=1838, n_bytes=179875, idle_age=0, priority=1,dl_vlan=1,dl_src=fa:16:3e:bc:4c:74 actions=mod_dl_src:fa:16:3f:86:5c:5c,resubmit(,2)\n```\n", "tags": ["openstack", "mirantis", "DVR"]}