{"context": "\u30a4\u30f3\u30d5\u30e9\u52c9\u5f37\u4e2d\u306e\u8005\u304cAWS\u306b\u4ee5\u4e0b\u306e\u74b0\u5883\u3092\u69cb\u7bc9\u3059\u308b\u307e\u3067\u306e\u6d41\u308c\u3092\u5b9f\u65bd\u3057\u305f\u306e\u3067\u3001\u5099\u5fd8\u9332\u3068\u3057\u3066\u6b8b\u3057\u3066\u304a\u3053\u3046\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u524d\u63d0\u30fb\u958b\u767a\u74b0\u5883\n\u30fbAmazonLinux\n\u30fbApache2.2\n\u30fbPHP\uff17\nEC2\u306e\u8a2d\u5b9a\u306f\u4e0b\u8a18\u3067\u3059\u3002\n[AWS] EC2+RDS\u958b\u767a\u74b0\u5883\u8a2d\u5b9a\u3000Apache2.2+PHP7+MySQL+WordPress+phpMyAdmin\n\n\u5b9f\u65bd\u4e8b\u9805\nlsyncd+rsync\u3067\u306e\u8907\u6570\u30b5\u30fc\u30d0\u540c\u671f\u306e\u8a2d\u5b9a\n\u30df\u30e9\u30fc\u30ea\u30f3\u30b0\u5bfe\u8c61\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306f\u3001/var/www/html\u4ee5\u4e0b\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u30fb\u30d5\u30a1\u30a4\u30eb\n\u30a4\u30e1\u30fc\u30b8\nmaster(\u30df\u30e9\u30fc\u5143) EC2\u306eIP\u30a2\u30c9\u30ec\u30b9\u3000\u2192 XXX:XXX:XXX:XXX\nslave\uff08\u30df\u30e9\u30fc\u5148\uff09EC2\u306eIP\u30a2\u30c9\u30ec\u30b9\u3000\u2192 YYY:YYY:YYY:YYY\n\n\n\u8a2d\u5b9a\n\u6700\u521d\u306bmaster\u5074\u306e\u8a2d\u5b9a\n\nmaster\n[ec2-user@ip-10-0-1-187 ~]$ sudo yum -y install lsyncd\n[ec2-user@ip-10-0-1-187 ~]$ cd /etc\n[ec2-user@ip-10-0-1-187 etc]$ sudo vi lsyncd.conf\n\nlsyncd.conf\u306e\u7de8\u96c6/\u8ffd\u52a0\n=========================\nsettings{\n    logfile = \"/var/log/lsyncd.log\",\n    statusFile = \"/tmp/lsyncd.stat\",\n    statusInterval = 1,\n}\nsync{\n    default.rsync,\n    source=\"/var/www/html/\",\n    target=\"YYY.YYY.YYY.YYY::qiita\",\n    rsync = {\n        archive = true,\n        links = true,\n        update = true,\n        verbose = false\n    }\n}\n=========================\n[ec2-user@ip-10-0-1-187 etc]$ sudo chkconfig lsyncd on\n[ec2-user@ip-10-0-1-187 etc]$ sudo /etc/rc.d/init.d/lsyncd start\nStarting lsyncd:                                           [  OK  ]\n\n\n\u5225\u30b7\u30a7\u30eb\u3092\u7acb\u3061\u4e0a\u3052\u3066\u4e0b\u8a18\u306etail\u30b3\u30de\u30f3\u30c9\u3067\u30ed\u30b0\u3092\u62fe\u3063\u3066\u304a\u304f\u3068\u30a8\u30e9\u30fc\u306e\u72b6\u6cc1\u304c\u628a\u63e1\u3057\u3084\u3059\u3044\u3067\u3059\u3002\n\nmaster_log\n[ec2-user@ip-10-0-1-187 ~]$ tail -f /var/log/lsyncd.log\nWed Mar  1 07:27:58 2017 Error: Temporary or permanent failure on startup of \"/var/www/html/\". Terminating since \"insist\" is not set.\n\u30fb\u30fb\u30fb\u30fb\u30fb\n\n\n\u6b21\u306bslave\u5074\u306e\u8a2d\u5b9a\n\nslave\n[ec2-user@ip-10-0-2-165 ~]$ sudo yum -y install xinetd\n[ec2-user@ip-10-0-2-165 ~]$ cd /etc/xinetd.d\n[ec2-user@ip-10-0-2-165 xinetd.d]$ sudo vi rsync\n\nrsync\u306e\u7de8\u96c6\n=========================\n# default: off\n# description: The rsync server is a good addition to an ftp server, as it \\\n#       allows crc checksumming etc.\nservice rsync\n{\n        disable = no \u2190yes\u3092no\u306b\u4fee\u6b63\n        flags           = IPv6\n        socket_type     = stream\n        wait            = no\n        user            = root\n        server          = /usr/bin/rsync\n        server_args     = --daemon\n        log_on_failure  += USERID\n}\n=========================\n\n[ec2-user@ip-10-0-2-165 xinetd.d]$ cd ..\n[ec2-user@ip-10-0-2-165 etc]$ sudo touch rsyncd.conf\n[ec2-user@ip-10-0-2-165 etc]$ sudo vi rsyncd.conf\n\nrsyncd.conf\u306e\u7de8\u96c6\u30fb\u8ffd\u52a0\n=========================\nuid = root\ngid = root\nread only = no\nlog file = /home/slave/logs/rsyncd.log\npid file = /home/slave/logs/rsyncd.pid\nport = 873\n\n[qiita]\npath = /var/www/html/\nhosts allow = XXX.XXX.XXX.XXX\nread only = false\n=========================\n[ec2-user@ip-10-0-2-165 etc]sudo chkconfig xinetd on\n[ec2-user@ip-10-0-2-165 etc]$ cd\n[ec2-user@ip-10-0-2-165 ~]$ sudo  service xinetd start\nStarting xinetd:                                           [  OK  ]\n\n\nlsyncd(master\u5074)\u3068rsync(slave\u5074)\u306e\u8a2d\u5b9a\u306f\u4ee5\u4e0a\u3067\u3059\u3002\n\u3057\u304b\u3057\u3001\u3053\u308c\u3060\u3051\u3067\u306f\u30df\u30e9\u30fc\u30ea\u30f3\u30b0\u51fa\u6765\u306a\u3044\u306e\u3067\u4e0b\u8a18\u306e2\u3064\u306e\u8a2d\u5b9a\u3092\u5b9f\u65bd\u3057\u307e\u3059\u3002\n1. EC2(slave\u5074)\u306b\u304a\u3044\u3066\u3001TCP\u306e\u30dd\u30fc\u30c8(873)\u306e\u89e3\u653e\n2. \u30b5\u30fc\u30d0\u9593\u306eSSH\u63a5\u7d9a\u3092\u3059\u308b\u305f\u3081\u306eRSA\u8a8d\u8a3c\n\n1.EC2(slave\u5074)\u306b\u304a\u3044\u3066\u3001TCP\u306e\u30dd\u30fc\u30c8(873)\u306e\u89e3\u653e\nEC2(slave\u5074)\u306e\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\u306e\u30a4\u30f3\u30d0\u30a6\u30f3\u30c9\u30eb\u30fc\u30eb\u3092\u8ffd\u52a0\u3059\u308b\u3002\n\n\n2.master\u3068slave\u306e\u30b5\u30fc\u30d0\u9593\u3067RSA\u516c\u958b\u9375\u8a8d\u8a3c\n2-1 RSA\u9375\u306e\u751f\u6210\n2-2 EC2(master)\u304b\u3089EC2(slave)\u306b\u751f\u6210\u3055\u308c\u305f\u516c\u958b\u9375\u3092\u6e21\u3059\u305f\u3081\u306e\u6e96\u5099\n\u3000\u3000\u3000\uff11) EC2(slave)\u306eSSH\u30dd\u30fc\u30c8\u3092\u4e00\u65e6\u5168\u3066\u89e3\u653e (\u4e0a\u8a181\u306eTCP\u3068\u540c\u69d8\u306e\u624b\u9806)\u203b\u5f8c\u307b\u3069\u8981\u9589\u9396\n\u3000\u3000\u3000\uff12) EC2(slave)\u306e\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u30ad\u30fc\u3092EC2(master)\u306e/.ssh\u306b\u4e00\u6642\u4fdd\u5b58\u203b\u5f8c\u307b\u3069\u8981\u524a\u9664\n2-3 EC2(master)\u304b\u3089EC2(slave)\u3078\u306e\u516c\u958b\u9375\u306e\u9001\u4fe1\n2-4 EC2(slave)\u306e/.ssh\u306b\u516c\u958b\u9375\u304c\u6e21\u3055\u308c\u305f\u304b\u78ba\u8a8d\u3068EC2(slave)\u306exinetd\u3092\u518d\u8d77\u52d5\n2-5 EC2(master)\u306elsyncd\u306e\u518d\u8d77\u52d5\n2-6 EC2(master_log)\u306e\u78ba\u8a8d\n2-1 RSA\u9375\u306e\u751f\u6210\n\nmaster\n[ec2-user@ip-10-0-1-187 etc]$ cd \n[ec2-user@ip-10-0-1-187 ~]$ ssh-keygen -t rsa -N \"\"\nGenerating public/private rsa key pair.\nEnter file in which to save the key (/root/.ssh/id_rsa): (\u2190\u305d\u306e\u307e\u307eEnter)\nYour identification has been saved in /root/.ssh/id_rsa.\nYour public key has been saved in /root/.ssh/id_rsa.pub.\nThe key fingerprint is:\n12:34:56:78:90:ab:cd:ef:gh:ij:kl:mn:op:qr:st:uv root@ip-10-0-1-187\nThe keys randomart image is:\n+--[ RSA 2048]----+\n|          ... oo |\n|          +. oo .|\n|         . +E+.. |\n|         \uff08\u30a4\u30e1\u30fc\u30b8\uff09|\n+-----------------+\n[ec2-user@ip-10-0-1-187 ~]$ cd .ssh\n[ec2-user@ip-10-0-1-187 .ssh]$ ls -la\n\u5408\u8a08 24\ndrwx------ 2 ec2-user ec2-user 4096  3\u6708  1 08:21 .\ndrwx------ 3 ec2-user ec2-user 4096  2\u6708 27 08:21 ..\n-rw------- 1 ec2-user ec2-user  774  3\u6708  1 01:59 authorized_keys\n-rw------- 1 ec2-user ec2-user 1675  3\u6708  1 08:21 id_rsa #\u79d8\u5bc6\u9375\n-rw-r--r-- 1 ec2-user ec2-user  404  3\u6708  1 08:21 id_rsa.pub #\u516c\u958b\u9375\n[ec2-user@ip-10-0-1-187 .ssh]$ exit\n\u30ed\u30b0\u30a2\u30a6\u30c8\nConnection to XXX.XXX.XXX.XXX closed.\n\n\n2-2 EC2(master)\u304b\u3089EC2(slave)\u306b\u751f\u6210\u3055\u308c\u305f\u516c\u958b\u9375\u3092\u6e21\u3059\u305f\u3081\u306e\u6e96\u5099\n\nmaster\nMyname-no-MacBook-Pro:~myname$ scp -i .ssh/key_of_XXX.pem .ssh/key_of_YYY.pem ec2-user@XXX.XXX.XXX.XXX:~/.ssh \nkey_of_YYY.pem                                                                                                                                                                        100% 1696     1.7KB/s   00:00    \nMyname-no-MacBook-Pro:~ myname$ ssh -i ~/.ssh/key_of_XXX.pem ec2-user@XXX.XXX.XXX.XXX\nLast login: Wed Mar  1 07:55:18 2017 from k99999.ppp.hogehoge-net.or.jp\n\n       __|  __|_  )\n       _|  (     /   Amazon Linux AMI\n      ___|\\___|___|\n\nhttps://aws.amazon.com/amazon-linux-ami/2016.09-release-notes/\n[ec2-user@ip-10-0-1-187 ~]$ cd .ssh\n[ec2-user@ip-10-0-1-187 .ssh]$ ls -la\n\u5408\u8a08 24\ndrwx------ 2 ec2-user ec2-user 4096  3\u6708  1 08:21 .\ndrwx------ 3 ec2-user ec2-user 4096  2\u6708 27 08:21 ..\n-rw------- 1 ec2-user ec2-user  774  3\u6708  1 01:59 authorized_keys\n-rw------- 1 ec2-user ec2-user 1675  3\u6708  1 08:21 id_rsa\n-rw-r--r-- 1 ec2-user ec2-user  404  3\u6708  1 08:21 id_rsa.pub\n-r-------- 1 ec2-user ec2-user 1696  3\u6708  1 08:19 key_of_YYY.pem\n\n\n2-3 EC2(master)\u304b\u3089EC2(slave)\u3078\u306e\u516c\u958b\u9375\u306e\u9001\u4fe1\n[ec2-user@ip-10-0-1-187 ~]$ scp -i .ssh/key_of_YYY.pem .ssh/id_rsa.pub ec2-user@YYY.YYY.YYY.YYY:~/.ssh\nThe authenticity of host YYY.YYY.YYY.YYY(YYY.YYY.YYY.YYY) cant be established.\nECDSA key fingerprint is 12:34:56:78:90:ab:cd:ef:gh:ij:kl:mn:op:qr:st:uv.\nAre you sure you want to continue connecting (yes/no)? yes\nWarning: Permanently added 'YYY.YYY.YYY.YYY' (ECDSA) to the list of known hosts.\nid_rsa.pub                                                                                                                                                                       100%  404     0.4KB/s   00:00 \n[ec2-user@ip-10-0-1-187 .ssh]$ sudo rm -r key_of_YYY.pem\n\n\n2-4 EC2(slave)\u306e/.ssh\u306b\u516c\u958b\u9375\u304c\u6e21\u3055\u308c\u305f\u304b\u78ba\u8a8d\u3068EC2(slave)\u306exinetd\u3092\u518d\u8d77\u52d5\n\nslave\n[ec2-user@ip-10-0-2-165 ~]$ cd .ssh\n[ec2-user@ip-10-0-2-165 .ssh]$ ls -la\n\u5408\u8a08 16\ndrwx------ 2 ec2-user ec2-user 4096  3\u6708  1 08:28 .\ndrwx------ 3 ec2-user ec2-user 4096  2\u6708 27 08:21 ..\n-rw------- 1 ec2-user ec2-user  774  3\u6708  1 02:04 authorized_keys\n-rw-r--r-- 1 ec2-user ec2-user  404  3\u6708  1 08:28 id_rsa.pub #\u516c\u958b\u9375\n[ec2-user@ip-10-0-2-165 ~]$ sudo service xinetd restart\nStopping xinetd:                                           [  OK  ]\nStarting xinetd:                                           [  OK  ]\n\n\n2-5 EC2(master)\u306elsyncd\u306e\u518d\u8d77\u52d5\n\nmaster\n[ec2-user@ip-10-0-1-187 ~]$ sudo /etc/rc.d/init.d/lsyncd restart\nlsyncd \u3092\u505c\u6b62\u4e2d:                                           [  OK  ]\nlsyncd \u3092\u8d77\u52d5\u4e2d:                                           [  OK  ]\n\n\n2-6 EC2(master_log)\u306e\u78ba\u8a8d\n\nmaster_log\nWed Mar  1 09:13:16 2017 Normal: --- TERM signal, fading ---\nWed Mar  1 09:13:16 2017 Normal: recursive startup rsync: /var/www/html/ -> YYY.YYY.YYY.YYY::qiita/\nWed Mar  1 09:13:17 2017 Normal: Startup of \"/var/www/html/\" finished.\n\n\nStartup of \"/var/www/html/\" finished\u3068\u306a\u308c\u3070\u6210\u529f\nhtml\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u5185\u306b\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210/\u30d5\u30a1\u30a4\u30eb\u306e\u5909\u66f4\u3067\u78ba\u8a8d\nlog\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u63a8\u79fb(html\u5185\u306ehoge\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u5909\u66f4)\n\nmaster_log\nWed Mar  1 09:04:37 2017 Normal: --- TERM signal, fading ---\nWed Mar  1 09:04:37 2017 Normal: recursive startup rsync: /var/www/html/ -> YYY.YYY.YYY.YYY::qiita/\nWed Mar  1 09:04:38 2017 Normal: Startup of \"/var/www/html/\" finished.\nWed Mar  1 09:05:07 2017 Normal: Calling rsync with filter-list of new/modified files/dirs\n/hoge/assets/cache/pages/hoge/docid_1.pageCache.php\n/hoge/assets/cache/pages/hoge/\n/hoge/assets/cache/pages/\n/hoge/assets/cache/\n/hoge/assets/\n/hoge/\n/\n/hoge/assets/cache/pages/hoge/***\n/hoge/assets/cache/pages/***\n/hoge/assets/cache/.tmp_2624_58b68eb4bacf0\n/hoge/assets/cache/basicConfig.php\n/hoge/assets/cache/.tmp_23766_58b68eb7697b0\nWed Mar  1 09:05:08 2017 Normal: Finished a list after exitcode: 0\n\n\n\u4ee5\u4e0a\u3067\u3059\u3002\n\u307e\u3060\u307e\u3060\u3001\u52c9\u5f37\u4e0d\u8db3\u3067\u3059\u3002\n\u3054\u6307\u6458\u304c\u3042\u308c\u3070\u30b3\u30e1\u30f3\u30c8\u3044\u305f\u3060\u3051\u307e\u3059\u3068\u5e78\u3044\u3067\u3059\u3002\n\u307e\u305f\u3001\u4eca\u56de\u306fslave\u30b5\u30fc\u30d0\u306f\uff11\u53f0\u3067\u3057\u305f\u304c\u3001\u8907\u6570\u53f0\u540c\u6642\u306b\u540c\u671f\u3059\u308b\u5834\u5408\u306f\u3001master\u306elsyncd.conf\u3092\u4e0b\u8a18\u306e\u3088\u3046\u306b\u8ffd\u52a0\u4fee\u6b63\u3059\u308b\u3053\u3068\u3067\u5bfe\u5fdc\u3067\u304d\u308b\u3088\u3046\u3067\u3059\u3002\n\nlsyncd.conf\n\nsettings{\n    logfile = \"/var/log/lsyncd.log\",\n    statusFile = \"/tmp/lsyncd.stat\",\n    statusInterval = 1,\n}\nsync_base = {\n    default.rsync,\n    source=\"/var/www/html/\",\n    rsync = {\n        archive = true,\n        links = true,\n        update = true,\n        verbose = false\n    }\n}\n\nsync {sync_base, target='target=YYY.YYY.YYY.YYY::qiita'}\nsync {sync_base, target='target=ZZZ.ZZZ.ZZZ.ZZZ::qiita'}\n\n\n\n\u5927\u5909\u53c2\u8003\u306b\u3055\u305b\u3066\u3044\u305f\u3060\u304d\u307e\u3057\u305f\u3002\nxinetd\u3068\u306f\nlsyncd + rsyncd\u3067\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u540c\u671f\u3059\u308b CentOS6\n\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u30df\u30e9\u30fc\u30ea\u30f3\u30b0\u30c4\u30fc\u30eb\u5c0e\u5165(lsyncd+rsyncd)\nCentOS rsync+lsync\nssh\u516c\u958b\u9375\u8a8d\u8a3c\u3092\u5b9f\u88c5\u3059\u308b\nlsyncd\u3067\u8907\u6570\u30b5\u30fc\u30d0\u30fc\u3092\u30bf\u30fc\u30b2\u30c3\u30c8\u306b\u540c\u671f\u3059\u308b\u969b\u306etips\n\u30a4\u30f3\u30d5\u30e9\u52c9\u5f37\u4e2d\u306e\u8005\u304cAWS\u306b\u4ee5\u4e0b\u306e\u74b0\u5883\u3092\u69cb\u7bc9\u3059\u308b\u307e\u3067\u306e\u6d41\u308c\u3092\u5b9f\u65bd\u3057\u305f\u306e\u3067\u3001\u5099\u5fd8\u9332\u3068\u3057\u3066\u6b8b\u3057\u3066\u304a\u3053\u3046\u3068\u601d\u3044\u307e\u3059\u3002\n\n##\u524d\u63d0\u30fb\u958b\u767a\u74b0\u5883\n\u30fbAmazonLinux\n\u30fbApache2.2\n\u30fbPHP\uff17\nEC2\u306e\u8a2d\u5b9a\u306f\u4e0b\u8a18\u3067\u3059\u3002\n[[AWS] EC2+RDS\u958b\u767a\u74b0\u5883\u8a2d\u5b9a\u3000Apache2.2+PHP7+MySQL+WordPress+phpMyAdmin](http://qiita.com/hibriiiiidge/items/7483335bb3d2fef40214)\n\n##\u5b9f\u65bd\u4e8b\u9805\nlsyncd+rsync\u3067\u306e\u8907\u6570\u30b5\u30fc\u30d0\u540c\u671f\u306e\u8a2d\u5b9a\n\u30df\u30e9\u30fc\u30ea\u30f3\u30b0\u5bfe\u8c61\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306f\u3001`/var/www/html`\u4ee5\u4e0b\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u30fb\u30d5\u30a1\u30a4\u30eb\n\u30a4\u30e1\u30fc\u30b8\n\nmaster(\u30df\u30e9\u30fc\u5143) EC2\u306eIP\u30a2\u30c9\u30ec\u30b9\u3000\u2192 XXX:XXX:XXX:XXX\nslave\uff08\u30df\u30e9\u30fc\u5148\uff09EC2\u306eIP\u30a2\u30c9\u30ec\u30b9\u3000\u2192 YYY:YYY:YYY:YYY\n\n<img width=\"669\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2017-03-01 16.05.57.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/114886/27265bfe-2c1d-cdb4-49c1-5ae52dff5d20.png\">\n\n##\u8a2d\u5b9a\n\n\u6700\u521d\u306bmaster\u5074\u306e\u8a2d\u5b9a\n\n```PHP:master\n[ec2-user@ip-10-0-1-187 ~]$ sudo yum -y install lsyncd\n[ec2-user@ip-10-0-1-187 ~]$ cd /etc\n[ec2-user@ip-10-0-1-187 etc]$ sudo vi lsyncd.conf\n\nlsyncd.conf\u306e\u7de8\u96c6/\u8ffd\u52a0\n=========================\nsettings{\n    logfile = \"/var/log/lsyncd.log\",\n    statusFile = \"/tmp/lsyncd.stat\",\n    statusInterval = 1,\n}\nsync{\n    default.rsync,\n    source=\"/var/www/html/\",\n    target=\"YYY.YYY.YYY.YYY::qiita\",\n    rsync = {\n        archive = true,\n        links = true,\n        update = true,\n        verbose = false\n    }\n}\n=========================\n[ec2-user@ip-10-0-1-187 etc]$ sudo chkconfig lsyncd on\n[ec2-user@ip-10-0-1-187 etc]$ sudo /etc/rc.d/init.d/lsyncd start\nStarting lsyncd:                                           [  OK  ]\n```\n\n\u5225\u30b7\u30a7\u30eb\u3092\u7acb\u3061\u4e0a\u3052\u3066\u4e0b\u8a18\u306e`tail`\u30b3\u30de\u30f3\u30c9\u3067\u30ed\u30b0\u3092\u62fe\u3063\u3066\u304a\u304f\u3068\u30a8\u30e9\u30fc\u306e\u72b6\u6cc1\u304c\u628a\u63e1\u3057\u3084\u3059\u3044\u3067\u3059\u3002\n\n```php:master_log\n[ec2-user@ip-10-0-1-187 ~]$ tail -f /var/log/lsyncd.log\nWed Mar  1 07:27:58 2017 Error: Temporary or permanent failure on startup of \"/var/www/html/\". Terminating since \"insist\" is not set.\n\u30fb\u30fb\u30fb\u30fb\u30fb\n```\n\n\u6b21\u306bslave\u5074\u306e\u8a2d\u5b9a\n\n```PHP:slave\n[ec2-user@ip-10-0-2-165 ~]$ sudo yum -y install xinetd\n[ec2-user@ip-10-0-2-165 ~]$ cd /etc/xinetd.d\n[ec2-user@ip-10-0-2-165 xinetd.d]$ sudo vi rsync\n\nrsync\u306e\u7de8\u96c6\n=========================\n# default: off\n# description: The rsync server is a good addition to an ftp server, as it \\\n#       allows crc checksumming etc.\nservice rsync\n{\n        disable = no \u2190yes\u3092no\u306b\u4fee\u6b63\n        flags           = IPv6\n        socket_type     = stream\n        wait            = no\n        user            = root\n        server          = /usr/bin/rsync\n        server_args     = --daemon\n        log_on_failure  += USERID\n}\n=========================\n\n[ec2-user@ip-10-0-2-165 xinetd.d]$ cd ..\n[ec2-user@ip-10-0-2-165 etc]$ sudo touch rsyncd.conf\n[ec2-user@ip-10-0-2-165 etc]$ sudo vi rsyncd.conf\n\nrsyncd.conf\u306e\u7de8\u96c6\u30fb\u8ffd\u52a0\n=========================\nuid = root\ngid = root\nread only = no\nlog file = /home/slave/logs/rsyncd.log\npid file = /home/slave/logs/rsyncd.pid\nport = 873\n\n[qiita]\npath = /var/www/html/\nhosts allow = XXX.XXX.XXX.XXX\nread only = false\n=========================\n[ec2-user@ip-10-0-2-165 etc]sudo chkconfig xinetd on\n[ec2-user@ip-10-0-2-165 etc]$ cd\n[ec2-user@ip-10-0-2-165 ~]$ sudo  service xinetd start\nStarting xinetd:                                           [  OK  ]\n```\n\nlsyncd(master\u5074)\u3068rsync(slave\u5074)\u306e\u8a2d\u5b9a\u306f\u4ee5\u4e0a\u3067\u3059\u3002\n\n\u3057\u304b\u3057\u3001\u3053\u308c\u3060\u3051\u3067\u306f\u30df\u30e9\u30fc\u30ea\u30f3\u30b0\u51fa\u6765\u306a\u3044\u306e\u3067\u4e0b\u8a18\u306e2\u3064\u306e\u8a2d\u5b9a\u3092\u5b9f\u65bd\u3057\u307e\u3059\u3002\n1. EC2(slave\u5074)\u306b\u304a\u3044\u3066\u3001TCP\u306e\u30dd\u30fc\u30c8(873)\u306e\u89e3\u653e\n2. \u30b5\u30fc\u30d0\u9593\u306eSSH\u63a5\u7d9a\u3092\u3059\u308b\u305f\u3081\u306eRSA\u8a8d\u8a3c\n###1.EC2(slave\u5074)\u306b\u304a\u3044\u3066\u3001TCP\u306e\u30dd\u30fc\u30c8(873)\u306e\u89e3\u653e\nEC2(slave\u5074)\u306e\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\u306e\u30a4\u30f3\u30d0\u30a6\u30f3\u30c9\u30eb\u30fc\u30eb\u3092\u8ffd\u52a0\u3059\u308b\u3002\n<img width=\"651\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2017-03-01 18.18.21.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/114886/5067ab0e-6826-ee16-e442-0f668146f42d.png\">\n\n###2.master\u3068slave\u306e\u30b5\u30fc\u30d0\u9593\u3067RSA\u516c\u958b\u9375\u8a8d\u8a3c\n2-1 RSA\u9375\u306e\u751f\u6210\n2-2 EC2(master)\u304b\u3089EC2(slave)\u306b\u751f\u6210\u3055\u308c\u305f\u516c\u958b\u9375\u3092\u6e21\u3059\u305f\u3081\u306e\u6e96\u5099\n\u3000\u3000\u3000\uff11) EC2(slave)\u306eSSH\u30dd\u30fc\u30c8\u3092\u4e00\u65e6\u5168\u3066\u89e3\u653e (\u4e0a\u8a181\u306eTCP\u3068\u540c\u69d8\u306e\u624b\u9806)\u203b\u5f8c\u307b\u3069\u8981\u9589\u9396\n\u3000\u3000\u3000\uff12) EC2(slave)\u306e\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u30ad\u30fc\u3092EC2(master)\u306e`/.ssh`\u306b\u4e00\u6642\u4fdd\u5b58\u203b\u5f8c\u307b\u3069\u8981\u524a\u9664\n2-3 EC2(master)\u304b\u3089EC2(slave)\u3078\u306e\u516c\u958b\u9375\u306e\u9001\u4fe1\n2-4 EC2(slave)\u306e`/.ssh`\u306b\u516c\u958b\u9375\u304c\u6e21\u3055\u308c\u305f\u304b\u78ba\u8a8d\u3068EC2(slave)\u306e`xinetd`\u3092\u518d\u8d77\u52d5\n2-5 EC2(master)\u306e`lsyncd`\u306e\u518d\u8d77\u52d5\n2-6 EC2(master_log)\u306e\u78ba\u8a8d\n\n2-1 RSA\u9375\u306e\u751f\u6210\n\n```php:master\n[ec2-user@ip-10-0-1-187 etc]$ cd \n[ec2-user@ip-10-0-1-187 ~]$ ssh-keygen -t rsa -N \"\"\nGenerating public/private rsa key pair.\nEnter file in which to save the key (/root/.ssh/id_rsa): (\u2190\u305d\u306e\u307e\u307eEnter)\nYour identification has been saved in /root/.ssh/id_rsa.\nYour public key has been saved in /root/.ssh/id_rsa.pub.\nThe key fingerprint is:\n12:34:56:78:90:ab:cd:ef:gh:ij:kl:mn:op:qr:st:uv root@ip-10-0-1-187\nThe keys randomart image is:\n+--[ RSA 2048]----+\n|          ... oo |\n|          +. oo .|\n|         . +E+.. |\n|         \uff08\u30a4\u30e1\u30fc\u30b8\uff09|\n+-----------------+\n[ec2-user@ip-10-0-1-187 ~]$ cd .ssh\n[ec2-user@ip-10-0-1-187 .ssh]$ ls -la\n\u5408\u8a08 24\ndrwx------ 2 ec2-user ec2-user 4096  3\u6708  1 08:21 .\ndrwx------ 3 ec2-user ec2-user 4096  2\u6708 27 08:21 ..\n-rw------- 1 ec2-user ec2-user  774  3\u6708  1 01:59 authorized_keys\n-rw------- 1 ec2-user ec2-user 1675  3\u6708  1 08:21 id_rsa #\u79d8\u5bc6\u9375\n-rw-r--r-- 1 ec2-user ec2-user  404  3\u6708  1 08:21 id_rsa.pub #\u516c\u958b\u9375\n[ec2-user@ip-10-0-1-187 .ssh]$ exit\n\u30ed\u30b0\u30a2\u30a6\u30c8\nConnection to XXX.XXX.XXX.XXX closed.\n```\n\n2-2 EC2(master)\u304b\u3089EC2(slave)\u306b\u751f\u6210\u3055\u308c\u305f\u516c\u958b\u9375\u3092\u6e21\u3059\u305f\u3081\u306e\u6e96\u5099\n\n```php:master\nMyname-no-MacBook-Pro:~myname$ scp -i .ssh/key_of_XXX.pem .ssh/key_of_YYY.pem ec2-user@XXX.XXX.XXX.XXX:~/.ssh \nkey_of_YYY.pem                                                                                                                                                                        100% 1696     1.7KB/s   00:00    \nMyname-no-MacBook-Pro:~ myname$ ssh -i ~/.ssh/key_of_XXX.pem ec2-user@XXX.XXX.XXX.XXX\nLast login: Wed Mar  1 07:55:18 2017 from k99999.ppp.hogehoge-net.or.jp\n\n       __|  __|_  )\n       _|  (     /   Amazon Linux AMI\n      ___|\\___|___|\n\nhttps://aws.amazon.com/amazon-linux-ami/2016.09-release-notes/\n[ec2-user@ip-10-0-1-187 ~]$ cd .ssh\n[ec2-user@ip-10-0-1-187 .ssh]$ ls -la\n\u5408\u8a08 24\ndrwx------ 2 ec2-user ec2-user 4096  3\u6708  1 08:21 .\ndrwx------ 3 ec2-user ec2-user 4096  2\u6708 27 08:21 ..\n-rw------- 1 ec2-user ec2-user  774  3\u6708  1 01:59 authorized_keys\n-rw------- 1 ec2-user ec2-user 1675  3\u6708  1 08:21 id_rsa\n-rw-r--r-- 1 ec2-user ec2-user  404  3\u6708  1 08:21 id_rsa.pub\n-r-------- 1 ec2-user ec2-user 1696  3\u6708  1 08:19 key_of_YYY.pem\n```\n\n2-3 EC2(master)\u304b\u3089EC2(slave)\u3078\u306e\u516c\u958b\u9375\u306e\u9001\u4fe1\n\n```\n[ec2-user@ip-10-0-1-187 ~]$ scp -i .ssh/key_of_YYY.pem .ssh/id_rsa.pub ec2-user@YYY.YYY.YYY.YYY:~/.ssh\nThe authenticity of host YYY.YYY.YYY.YYY(YYY.YYY.YYY.YYY) cant be established.\nECDSA key fingerprint is 12:34:56:78:90:ab:cd:ef:gh:ij:kl:mn:op:qr:st:uv.\nAre you sure you want to continue connecting (yes/no)? yes\nWarning: Permanently added 'YYY.YYY.YYY.YYY' (ECDSA) to the list of known hosts.\nid_rsa.pub                                                                                                                                                                       100%  404     0.4KB/s   00:00 \n[ec2-user@ip-10-0-1-187 .ssh]$ sudo rm -r key_of_YYY.pem\n\n```\n\n2-4 EC2(slave)\u306e`/.ssh`\u306b\u516c\u958b\u9375\u304c\u6e21\u3055\u308c\u305f\u304b\u78ba\u8a8d\u3068EC2(slave)\u306e`xinetd`\u3092\u518d\u8d77\u52d5\n\n```php:slave\n[ec2-user@ip-10-0-2-165 ~]$ cd .ssh\n[ec2-user@ip-10-0-2-165 .ssh]$ ls -la\n\u5408\u8a08 16\ndrwx------ 2 ec2-user ec2-user 4096  3\u6708  1 08:28 .\ndrwx------ 3 ec2-user ec2-user 4096  2\u6708 27 08:21 ..\n-rw------- 1 ec2-user ec2-user  774  3\u6708  1 02:04 authorized_keys\n-rw-r--r-- 1 ec2-user ec2-user  404  3\u6708  1 08:28 id_rsa.pub #\u516c\u958b\u9375\n[ec2-user@ip-10-0-2-165 ~]$ sudo service xinetd restart\nStopping xinetd:                                           [  OK  ]\nStarting xinetd:                                           [  OK  ]\n```\n\n2-5 EC2(master)\u306e`lsyncd`\u306e\u518d\u8d77\u52d5\n\n```php:master\n[ec2-user@ip-10-0-1-187 ~]$ sudo /etc/rc.d/init.d/lsyncd restart\nlsyncd \u3092\u505c\u6b62\u4e2d:                                           [  OK  ]\nlsyncd \u3092\u8d77\u52d5\u4e2d:                                           [  OK  ]\n```\n\n2-6 EC2(master_log)\u306e\u78ba\u8a8d\n\n```php:master_log\nWed Mar  1 09:13:16 2017 Normal: --- TERM signal, fading ---\nWed Mar  1 09:13:16 2017 Normal: recursive startup rsync: /var/www/html/ -> YYY.YYY.YYY.YYY::qiita/\nWed Mar  1 09:13:17 2017 Normal: Startup of \"/var/www/html/\" finished.\n```\n\n`Startup of \"/var/www/html/\" finished`\u3068\u306a\u308c\u3070\u6210\u529f\n`html`\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u5185\u306b\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210/\u30d5\u30a1\u30a4\u30eb\u306e\u5909\u66f4\u3067\u78ba\u8a8d\n\n`log`\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u63a8\u79fb(html\u5185\u306ehoge\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u5909\u66f4)\n\n```php:master_log\nWed Mar  1 09:04:37 2017 Normal: --- TERM signal, fading ---\nWed Mar  1 09:04:37 2017 Normal: recursive startup rsync: /var/www/html/ -> YYY.YYY.YYY.YYY::qiita/\nWed Mar  1 09:04:38 2017 Normal: Startup of \"/var/www/html/\" finished.\nWed Mar  1 09:05:07 2017 Normal: Calling rsync with filter-list of new/modified files/dirs\n/hoge/assets/cache/pages/hoge/docid_1.pageCache.php\n/hoge/assets/cache/pages/hoge/\n/hoge/assets/cache/pages/\n/hoge/assets/cache/\n/hoge/assets/\n/hoge/\n/\n/hoge/assets/cache/pages/hoge/***\n/hoge/assets/cache/pages/***\n/hoge/assets/cache/.tmp_2624_58b68eb4bacf0\n/hoge/assets/cache/basicConfig.php\n/hoge/assets/cache/.tmp_23766_58b68eb7697b0\nWed Mar  1 09:05:08 2017 Normal: Finished a list after exitcode: 0\n```\n\n\u4ee5\u4e0a\u3067\u3059\u3002\n\n\u307e\u3060\u307e\u3060\u3001\u52c9\u5f37\u4e0d\u8db3\u3067\u3059\u3002\n\u3054\u6307\u6458\u304c\u3042\u308c\u3070\u30b3\u30e1\u30f3\u30c8\u3044\u305f\u3060\u3051\u307e\u3059\u3068\u5e78\u3044\u3067\u3059\u3002\n\n\u307e\u305f\u3001\u4eca\u56de\u306fslave\u30b5\u30fc\u30d0\u306f\uff11\u53f0\u3067\u3057\u305f\u304c\u3001\u8907\u6570\u53f0\u540c\u6642\u306b\u540c\u671f\u3059\u308b\u5834\u5408\u306f\u3001master\u306e`lsyncd.conf`\u3092\u4e0b\u8a18\u306e\u3088\u3046\u306b\u8ffd\u52a0\u4fee\u6b63\u3059\u308b\u3053\u3068\u3067\u5bfe\u5fdc\u3067\u304d\u308b\u3088\u3046\u3067\u3059\u3002\n\n```php:lsyncd.conf\n\nsettings{\n    logfile = \"/var/log/lsyncd.log\",\n    statusFile = \"/tmp/lsyncd.stat\",\n    statusInterval = 1,\n}\nsync_base = {\n    default.rsync,\n    source=\"/var/www/html/\",\n    rsync = {\n        archive = true,\n        links = true,\n        update = true,\n        verbose = false\n    }\n}\n\nsync {sync_base, target='target=YYY.YYY.YYY.YYY::qiita'}\nsync {sync_base, target='target=ZZZ.ZZZ.ZZZ.ZZZ::qiita'}\n\n```\n\n\n\u5927\u5909\u53c2\u8003\u306b\u3055\u305b\u3066\u3044\u305f\u3060\u304d\u307e\u3057\u305f\u3002\n[xinetd\u3068\u306f](http://wa3.i-3-i.info/word13585.html)\n[lsyncd + rsyncd\u3067\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u540c\u671f\u3059\u308b CentOS6](http://saba.omnioo.com/note/1258/lsyncd-rsyncd%E3%81%A7%E3%83%AA%E3%82%A2%E3%83%AB%E3%82%BF%E3%82%A4%E3%83%A0%E5%90%8C%E6%9C%9F%E3%81%99%E3%82%8B-centos6/)\n[\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u30df\u30e9\u30fc\u30ea\u30f3\u30b0\u30c4\u30fc\u30eb\u5c0e\u5165(lsyncd+rsyncd)](https://centossrv.com/lsyncd.shtml)\n[CentOS rsync+lsync](http://www.unix-power.net/linux/lsyncd.html)\n[ssh\u516c\u958b\u9375\u8a8d\u8a3c\u3092\u5b9f\u88c5\u3059\u308b](http://qiita.com/HamaTech/items/21bb9761f326c4d4aa65)\n[lsyncd\u3067\u8907\u6570\u30b5\u30fc\u30d0\u30fc\u3092\u30bf\u30fc\u30b2\u30c3\u30c8\u306b\u540c\u671f\u3059\u308b\u969b\u306etips](https://labs.precs.co.jp/2015/01/27/140/)\n\n\n", "tags": ["AWS", "lsyncd", "rsync"]}