{"context": "Redshift\u306fPython\u3067UDF\u3092\u5b9a\u7fa9\u3067\u304d\u308b\u304c\u3001\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u767b\u9332\u3057\u3066UDF\u304b\u3089\u547c\u3079\u305f\u308a\u3082\u3059\u308b\u3002\u8a66\u3057\u306bwoothee\u3067UA\u6587\u5b57\u5217\u3092\u30d1\u30fc\u30b9\u3059\u308b\u95a2\u6570\u3092\u4f5c\u3063\u3066\u307f\u305f\u3002\n\u307e\u305apip wheel\u3067woothee\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u624b\u5143\u306b\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\n$ pip wheel --no-deps --wheel-dir . woothee\nCollecting woothee\n  Downloading woothee-1.5.0-py2.py3-none-any.whl\n  Saved ./woothee-1.5.0-py2.py3-none-any.whl\nSkipping woothee, due to already being wheel.\n\n\u3053\u308c\u3092\u305d\u306e\u307e\u307eS3\u306e\u9069\u5f53\u306a\u30d0\u30b2\u30c3\u30c8\u306b\u4e0a\u3052\u308b\u3002\n$ aws s3 cp woothee-1.5.0-py2.py3-none-any.whl s3://bucketname/redshift/library/woothee-1.5.0-py2.py3-none-any.whl\n\nRedshift\u306ecreate library\u6587\u3067UDF\u304b\u3089\u547c\u3079\u308b\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u767b\u9332\u3067\u304d\u308b\u306e\u3067\u3053\u308c\u306b\u3055\u3063\u304d\u3042\u3052\u305fS3\u306e\u30d1\u30b9\u3092\u6307\u5b9a\u3059\u308b\u3002\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u306fzip\u3092\u6307\u5b9a\u3059\u308b\u3063\u3066\u3042\u308b\u3051\u3069.whl\u306f\u4e2d\u8eab\u306fzip\u306a\u306e\u3067\u554f\u984c\u306a\u3044\u3063\u307d\u3044\u3002\ncreate library woothee\nlanguage plpythonu\nfrom 's3://bucketname/redshift/library/woothee-1.5.0-py2.py3-none-any.whl'\ncredentials 'aws_access_key_id=***;aws_secret_access_key=***'\n\n\u3053\u308c\u3067woothee\u304cimport\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308b\u306e\u3067UA\u3092\u30d1\u30fc\u30b9\u3059\u308bUDF\u3092\u4f5c\u308b\u3002\u3068\u308a\u3042\u3048\u305a\u6587\u5b57\u5217\u3067JSON\u3092\u8fd4\u3057\u3068\u304f\u3002\ncreate function f_ua_parse (ua varchar(max))\n  returns varchar(max)\nstable\nas $$\n  import woothee\n  import json\n\n  return json.dumps(woothee.parse(ua))\n$$ language plpythonu\n\n\u3053\u308c\u3067f_ua_parse\u95a2\u6570\u304cRedshift\u304b\u3089\u547c\u3079\u308b\u3088\u3046\u306b\u306a\u308b\u3002\u7c21\u5358\u3060\u3002\n> select f_ua_parse('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2486.0 Safari/537.36 Edge/13.10586');\n                                                          f_ua_parse\n-------------------------------------------------------------------------------------------------------------------------------\n {\"category\": \"pc\", \"vendor\": \"Microsoft\", \"name\": \"Edge\", \"os_version\": \"NT 10.0\", \"version\": \"13.10586\", \"os\": \"Windows 10\"}\n(1 row)\n\nTime: 143.379 ms\n\nRedshift\u306fJSON\u578b\u306b\u306f\u5bfe\u5fdc\u3057\u3066\u306a\u3044\u3051\u3069JSON\u3092\u30d1\u30fc\u30b9\u3059\u308b\u3067\u304d\u308b\u95a2\u6570\u304c\u3042\u308b\u306e\u3067\u305d\u308c\u3092\u4f7f\u3048\u3070\u3088\u3044\u3002\u5b9f\u969b\u306b\u4f7f\u3046\u3068\u304d\u306f\u3053\u3093\u306a\u611f\u3058\u3067\u4f7f\u3048\u308b\u3002\nselect\n    *\nfrom (\n    select\n        distinct\n        json_extract_path_text(ua, 'category') as category\n        , json_extract_path_text(ua, 'vendor') as vendor\n        , json_extract_path_text(ua, 'os') as os\n        , json_extract_path_text(ua, 'name') as name\n        , json_extract_path_text(ua, 'version') as version\n        , json_extract_path_text(ua, 'os_version') as os_version\n    from (select f_ua_parse(ua) as ua from access_logs)\n)\nwhere os != 'UNKNOWN'\nlimit 20\n;\n\n  category  |  vendor   |         os          |       name        |    version    |         os_version\n------------+-----------+---------------------+-------------------+---------------+----------------------------\n pc         | Mozilla   | Mac OSX             | Firefox           | 26.0          | 10.9\n pc         | Google    | Linux               | Chrome            | 52.0.2743.116 | UNKNOWN\n pc         | Microsoft | Windows 7           | Internet Explorer | 9.0           | NT 6.1\n pc         | Mozilla   | Mac OSX             | Firefox           | 24.0          | 10.8\n pc         | Mozilla   | Windows 10          | Firefox           | 47.0          | NT 10.0\n smartphone | Microsoft | Windows Phone OS    | Edge              | 14.14393      | 10.0\n smartphone | Apple     | iPhone              | Safari            | 9.0           | 9.3\n pc         | Mozilla   | Mac OSX             | Firefox           | 48.0          | 10.11\n pc         | Google    | Windows 7           | Chrome            | 52.0.2743.116 | NT 6.1\n pc         | Mozilla   | Windows UNKNOWN Ver | Firefox           | 9.0.1         | UNKNOWN\n pc         | Google    | Linux               | Chrome            | 47.0.2526.106 | UNKNOWN\n pc         | Google    | Mac OSX             | Chrome            | 51.0.2704.103 | 10.11.6\n smartphone | Apple     | iPad                | Safari            | 9.0           | 9.3.2\n pc         | Mozilla   | Mac OSX             | Firefox           | 47.0          | 10.9\n pc         | Apple     | Mac OSX             | Safari            | 5.1           | 10.7.1\n pc         | Google    | Linux               | Chrome            | 49.0.2623.75  | UNKNOWN\n pc         | UNKNOWN   | Windows UNKNOWN Ver | UNKNOWN           | UNKNOWN       | NT 6.1.7601 Service Pack 1\n pc         | Apple     | Mac OSX             | Safari            | 8.0           | 10.10\n pc         | Google    | Windows 10          | Chrome            | 51.0.2704.84  | NT 10.0\n pc         | Google    | Windows 7           | Chrome            | 41.0.2228.0   | NT 6.1\n(20 rows)\n\n\u6700\u9ad8\u306b\u4fbf\u5229\u3060\u3002\n\nRedshift\u306fPython\u3067UDF\u3092\u5b9a\u7fa9\u3067\u304d\u308b\u304c\u3001\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u767b\u9332\u3057\u3066UDF\u304b\u3089\u547c\u3079\u305f\u308a\u3082\u3059\u308b\u3002\u8a66\u3057\u306bwoothee\u3067UA\u6587\u5b57\u5217\u3092\u30d1\u30fc\u30b9\u3059\u308b\u95a2\u6570\u3092\u4f5c\u3063\u3066\u307f\u305f\u3002\n\n\u307e\u305a`pip wheel`\u3067`woothee`\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u624b\u5143\u306b\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\n\n```\n$ pip wheel --no-deps --wheel-dir . woothee\nCollecting woothee\n  Downloading woothee-1.5.0-py2.py3-none-any.whl\n  Saved ./woothee-1.5.0-py2.py3-none-any.whl\nSkipping woothee, due to already being wheel.\n```\n\n\u3053\u308c\u3092\u305d\u306e\u307e\u307eS3\u306e\u9069\u5f53\u306a\u30d0\u30b2\u30c3\u30c8\u306b\u4e0a\u3052\u308b\u3002\n\n```\n$ aws s3 cp woothee-1.5.0-py2.py3-none-any.whl s3://bucketname/redshift/library/woothee-1.5.0-py2.py3-none-any.whl\n```\n\nRedshift\u306e`create library`\u6587\u3067UDF\u304b\u3089\u547c\u3079\u308b\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u767b\u9332\u3067\u304d\u308b\u306e\u3067\u3053\u308c\u306b\u3055\u3063\u304d\u3042\u3052\u305fS3\u306e\u30d1\u30b9\u3092\u6307\u5b9a\u3059\u308b\u3002[\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](http://docs.aws.amazon.com/redshift/latest/dg/r_CREATE_LIBRARY.html)\u306b\u306fzip\u3092\u6307\u5b9a\u3059\u308b\u3063\u3066\u3042\u308b\u3051\u3069`.whl`\u306f\u4e2d\u8eab\u306fzip\u306a\u306e\u3067\u554f\u984c\u306a\u3044\u3063\u307d\u3044\u3002\n\n```sql\ncreate library woothee\nlanguage plpythonu\nfrom 's3://bucketname/redshift/library/woothee-1.5.0-py2.py3-none-any.whl'\ncredentials 'aws_access_key_id=***;aws_secret_access_key=***'\n```\n\n\u3053\u308c\u3067woothee\u304cimport\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308b\u306e\u3067UA\u3092\u30d1\u30fc\u30b9\u3059\u308bUDF\u3092\u4f5c\u308b\u3002\u3068\u308a\u3042\u3048\u305a\u6587\u5b57\u5217\u3067JSON\u3092\u8fd4\u3057\u3068\u304f\u3002\n\n```sql\ncreate function f_ua_parse (ua varchar(max))\n  returns varchar(max)\nstable\nas $$\n  import woothee\n  import json\n\n  return json.dumps(woothee.parse(ua))\n$$ language plpythonu\n```\n\n\u3053\u308c\u3067`f_ua_parse`\u95a2\u6570\u304cRedshift\u304b\u3089\u547c\u3079\u308b\u3088\u3046\u306b\u306a\u308b\u3002\u7c21\u5358\u3060\u3002\n\n```\n> select f_ua_parse('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2486.0 Safari/537.36 Edge/13.10586');\n                                                          f_ua_parse\n-------------------------------------------------------------------------------------------------------------------------------\n {\"category\": \"pc\", \"vendor\": \"Microsoft\", \"name\": \"Edge\", \"os_version\": \"NT 10.0\", \"version\": \"13.10586\", \"os\": \"Windows 10\"}\n(1 row)\n\nTime: 143.379 ms\n```\n\nRedshift\u306fJSON\u578b\u306b\u306f\u5bfe\u5fdc\u3057\u3066\u306a\u3044\u3051\u3069JSON\u3092\u30d1\u30fc\u30b9\u3059\u308b\u3067\u304d\u308b\u95a2\u6570\u304c\u3042\u308b\u306e\u3067\u305d\u308c\u3092\u4f7f\u3048\u3070\u3088\u3044\u3002\u5b9f\u969b\u306b\u4f7f\u3046\u3068\u304d\u306f\u3053\u3093\u306a\u611f\u3058\u3067\u4f7f\u3048\u308b\u3002\n\n```sql\nselect\n    *\nfrom (\n    select\n        distinct\n        json_extract_path_text(ua, 'category') as category\n        , json_extract_path_text(ua, 'vendor') as vendor\n        , json_extract_path_text(ua, 'os') as os\n        , json_extract_path_text(ua, 'name') as name\n        , json_extract_path_text(ua, 'version') as version\n        , json_extract_path_text(ua, 'os_version') as os_version\n    from (select f_ua_parse(ua) as ua from access_logs)\n)\nwhere os != 'UNKNOWN'\nlimit 20\n;\n```\n\n```\n  category  |  vendor   |         os          |       name        |    version    |         os_version\n------------+-----------+---------------------+-------------------+---------------+----------------------------\n pc         | Mozilla   | Mac OSX             | Firefox           | 26.0          | 10.9\n pc         | Google    | Linux               | Chrome            | 52.0.2743.116 | UNKNOWN\n pc         | Microsoft | Windows 7           | Internet Explorer | 9.0           | NT 6.1\n pc         | Mozilla   | Mac OSX             | Firefox           | 24.0          | 10.8\n pc         | Mozilla   | Windows 10          | Firefox           | 47.0          | NT 10.0\n smartphone | Microsoft | Windows Phone OS    | Edge              | 14.14393      | 10.0\n smartphone | Apple     | iPhone              | Safari            | 9.0           | 9.3\n pc         | Mozilla   | Mac OSX             | Firefox           | 48.0          | 10.11\n pc         | Google    | Windows 7           | Chrome            | 52.0.2743.116 | NT 6.1\n pc         | Mozilla   | Windows UNKNOWN Ver | Firefox           | 9.0.1         | UNKNOWN\n pc         | Google    | Linux               | Chrome            | 47.0.2526.106 | UNKNOWN\n pc         | Google    | Mac OSX             | Chrome            | 51.0.2704.103 | 10.11.6\n smartphone | Apple     | iPad                | Safari            | 9.0           | 9.3.2\n pc         | Mozilla   | Mac OSX             | Firefox           | 47.0          | 10.9\n pc         | Apple     | Mac OSX             | Safari            | 5.1           | 10.7.1\n pc         | Google    | Linux               | Chrome            | 49.0.2623.75  | UNKNOWN\n pc         | UNKNOWN   | Windows UNKNOWN Ver | UNKNOWN           | UNKNOWN       | NT 6.1.7601 Service Pack 1\n pc         | Apple     | Mac OSX             | Safari            | 8.0           | 10.10\n pc         | Google    | Windows 10          | Chrome            | 51.0.2704.84  | NT 10.0\n pc         | Google    | Windows 7           | Chrome            | 41.0.2228.0   | NT 6.1\n(20 rows)\n```\n\n\u6700\u9ad8\u306b\u4fbf\u5229\u3060\u3002\n", "tags": ["redshift"]}