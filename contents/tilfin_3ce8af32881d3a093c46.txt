{"context": "EC2 \u306b SSH \u3059\u308b\u5ea6\u306b AWS \u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u8a73\u7d30\u9078\u3093\u3067 Elastic IP \u3092\u30b3\u30d4\u30da\u3057\u3066\u30ad\u30fc\u30d5\u30a1\u30a4\u30eb\u3092\u6307\u5b9a\u3057\u3066\u5b9f\u884c\u3068\u3044\u3046\u306e\u304c\u6020\u3044\u306e\u3067\u4fbf\u5229\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u4f5c\u3063\u3066\u307f\u305f\u3002\n\n\u5358\u306b SSH\n\u7b2c1\u5f15\u6570\u306b\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u540d\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002 ~/.aws/credentials \u306b\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u308b\u4e2d\u304b\u3089\u9078\u629e\u3057\u307e\u3059\uff08\u5f15\u6570\u306a\u3057\u3067\u5b9f\u884c\u3059\u308b\u3068\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u304c\u308f\u304b\u308a\u307e\u3059\uff09\u3002\n$ ec2ssh profile1\n0) server-dev   60.100.45.XXX  i-abcdefgx  keypair-dev\n1) server-stg   60.100.45.YYY  i-abcdefgy  keypair-stg\n2) server-prod  60.100.45.ZZZ  i-abcdefgz  keypair-prod\nInput target EC2 number> 2\nLast login: Wed Jan 20 15:19:00 2016 from xxxx.xxxx.xxx.xxx\n\n       __|  __|_  )\n       _|  (     /   Amazon Linux AMI\n      ___|\\___|___|\n\nhttps://aws.amazon.com/amazon-linux-ami/2015.09-release-notes/\n[ec2-user@ip-10-0-0-1 ~]$\n\n\n\u30d5\u30a1\u30a4\u30eb\u3092EC2\u304b\u3089\u30ed\u30fc\u30ab\u30eb\u306b\u30b3\u30d4\u30fc\nEC2 \u306e /tmp/log.tgz \u3092\u30ed\u30fc\u30ab\u30eb\u306e ~/work/ \u306b\u30b3\u30d4\u30fc\u3059\u308b\u3002\n\u5f15\u6570\u306b get, EC2\u5185\u30d5\u30a1\u30a4\u30eb\u30d1\u30b9, \u30ed\u30fc\u30ab\u30eb\u30b3\u30d4\u30fc\u5148\u30d1\u30b9 \u306e\u9806\u306b\u6307\u5b9a\u3059\u308b\u3002\n\u30b3\u30d4\u30fc\u5148\u304c\u672a\u6307\u5b9a\u306a\u3089\u30ab\u30ec\u30f3\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u306a\u308b\u3002\n$ ec2ssh profile1 get /tmp/log.tgz ~/work/\n\n\n\u30d5\u30a1\u30a4\u30eb\u3092\u30ed\u30fc\u30ab\u30eb\u304b\u3089EC2\u306b\u30b3\u30d4\u30fc\n\u30ab\u30ec\u30f3\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e batch.sh \u3092 EC2 \u306e /tmp \u306b\u30b3\u30d4\u30fc\u3059\u308b\n\u5f15\u6570\u306b put, \u30ed\u30fc\u30ab\u30eb\u30d5\u30a1\u30a4\u30eb\u30d1\u30b9, EC2\u5185\u30b3\u30d4\u30fc\u5148\u30d1\u30b9 \u306e\u9806\u306b\u6307\u5b9a\u3059\u308b\u3002\n\u30b3\u30d4\u30fc\u5148\u304c\u672a\u6307\u5b9a\u306a\u3089 ec2-user \u306e\u30db\u30fc\u30e0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u306a\u308b\u3002\n$ ec2ssh profile1 put batch.sh /tmp\n\n\n\u30b9\u30af\u30ea\u30d7\u30c8\nhttps://gist.github.com/tilfin/4cdca4311b2585ed91e8\n\n\nAWS CLI \u3068 jq \u306b\u4f9d\u5b58\u3057\u3066\u3044\u307e\u3059\u3002\n\u5404\u30ad\u30fc\u30da\u30a2pem\u30d5\u30a1\u30a4\u30eb\u306f\u3001AWS\u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089\u53d6\u5f97\u3057\u305f\u3068\u304d\u306e\u30d5\u30a1\u30a4\u30eb\u540d\u306e\u307e\u307e ~/.ssh/ \u306b\u7f6e\u304f\u3002\n\n~/.ec2ssh-pre \u3092\u7f6e\u304f\u3068 ssh, scp \u524d\u306b\u4efb\u610f\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3067\u304d\u307e\u3059\u3002\n\n~/.ec2ssh-post \u3092\u7f6e\u304f\u3068 ssh, scp \u5f8c\u306b\u4efb\u610f\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3067\u304d\u307e\u3059\u3002\n\n#!/bin/bash\n#---------------------------------------------\n# EC2 SSH\n#\n# select target from instace list\n#---------------------------------------------\n#\n#  ssh example) $ ec2ssh profile1\n#\n#  download file example)\n#  $ ec2ssh profile1 get /tmp/log.tgz ~/work/\n#\n#  upload file example)\n#  $ ec2ssh profile1 put batch.sh /tmp\n#\n#\n#  If you want to hook pre and post command,\n#  put ~/.ec2ssh-pre or ~/.ec2ssh-post\n#  pre|post script is called with arguments:\n#     $1 = EC2 IP Address\n#     $2 = profile\n#     $3 = action\n#     $4 = source path\n#     $5 = destination path\n#\n#---------------------------------------------\n\nEC2USER=ec2-user\nALIVEINTERVAL=30\n\n\nprofile=$1\naction=$2\nsrc=$3\ndest=$4\nif [ \"$profile\" == \"\" ]; then\n  name=`basename $0`\n  echo \"Usage: $name <aws profile> [action] [src] [dest]\"\n  echo -n \"  aws profiles)\"\n  for pf in `grep -e \"\\[[a-z\\-]*\\]\" ~/.aws/credentials | sed 's/\\[//;s/\\]//'`\n  do\n    echo -n \" $pf\"\n  done\n  echo -e \"\\n  action) get put\"\n  exit 1\nfi\n\n\niplist=()\nkeylist=()\nindex=0\n\nIFS=$'\\n'\nfor line in `aws ec2 describe-instances --profile $profile \\\n  | jq '.Reservations[].Instances[] | {InstanceId, PublicIpAddress, PrivateIpAddress, KeyName, InstanceName: (.Tags[] | select(.Key==\"Name\").Value)}' 2> /dev/null \\\n  | jq 'sort_by(.InstanceName) | .[]' --slurp \\\n  | jq -r '[.PublicIpAddress, .InstanceId, .InstanceName, .KeyName] | @tsv'`\ndo\n  IFS=$'\\t'\n  item=( $line )\n  IFS=$'\\n'\n\n  iplist+=( ${item[0]:-dummy} )\n  keylist+=( ${item[3]:-dummy} )\n  echo -e \"$index) ${item[2]}\\t${item[0]}\\t${item[1]}\\t${item[3]}\"\n\n  index=$((index + 1))\n  count=$index\ndone\n\nif [ $count -eq 0 ]; then\n  echo \"Not found EC2 instances\"\n  exit 1\nfi\n\necho -n \"Input target EC2 number> \"\nread INPUT\nindex=$INPUT\n\nif [ \"$index\" != \"\" ] && [ $index -lt $count ]; then\n  hostip=${iplist[$index]}\n  pemfile=${keylist[${index}]}\n\n  if [ -f ~/.ec2ssh-pre ]; then\n    . ~/.ec2ssh-pre $hostip $profile $action $src $dest\n  fi\n\n  if [ \"$action\" == \"get\" ]; then\n    if [ \"$dest\" == \"\" ]; then\n      dest=\".\"\n    fi\n\n    scp -o StrictHostKeyChecking=no -i ~/.ssh/${pemfile}.pem $EC2USER@$hostip:$src $dest\n  elif [ \"$action\" == \"put\" ]; then\n    if [ \"$dest\" == \"\" ]; then\n      dest=\"~\"\n    fi\n\n    scp -o StrictHostKeyChecking=no -i ~/.ssh/${pemfile}.pem $src $EC2USER@$hostip:$dest\n  else\n    ssh -o ServerAliveInterval=$ALIVEINTERVAL \\\n        -o StrictHostKeyChecking=no \\\n        -l $EC2USER -i ~/.ssh/${pemfile}.pem $hostip\n  fi\n\n  if [ -f ~/.ec2ssh-post ]; then\n    . ~/.ec2ssh-post $hostip $profile $action $src $dest\n  fi\nfi\n\ntilfin's note \u3088\u308a\u30af\u30ed\u30b9\u30dd\u30b9\u30c8\nEC2 \u306b SSH \u3059\u308b\u5ea6\u306b AWS \u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u8a73\u7d30\u9078\u3093\u3067 Elastic IP \u3092\u30b3\u30d4\u30da\u3057\u3066\u30ad\u30fc\u30d5\u30a1\u30a4\u30eb\u3092\u6307\u5b9a\u3057\u3066\u5b9f\u884c\u3068\u3044\u3046\u306e\u304c\u6020\u3044\u306e\u3067\u4fbf\u5229\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u4f5c\u3063\u3066\u307f\u305f\u3002\n\n### \u5358\u306b SSH\n\u7b2c1\u5f15\u6570\u306b\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u540d\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002 `~/.aws/credentials` \u306b\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u308b\u4e2d\u304b\u3089\u9078\u629e\u3057\u307e\u3059\uff08\u5f15\u6570\u306a\u3057\u3067\u5b9f\u884c\u3059\u308b\u3068\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u304c\u308f\u304b\u308a\u307e\u3059\uff09\u3002\n\n```\n$ ec2ssh profile1\n0) server-dev   60.100.45.XXX  i-abcdefgx  keypair-dev\n1) server-stg   60.100.45.YYY  i-abcdefgy  keypair-stg\n2) server-prod  60.100.45.ZZZ  i-abcdefgz  keypair-prod\nInput target EC2 number> 2\nLast login: Wed Jan 20 15:19:00 2016 from xxxx.xxxx.xxx.xxx\n\n       __|  __|_  )\n       _|  (     /   Amazon Linux AMI\n      ___|\\___|___|\n\nhttps://aws.amazon.com/amazon-linux-ami/2015.09-release-notes/\n[ec2-user@ip-10-0-0-1 ~]$\n```\n\n### \u30d5\u30a1\u30a4\u30eb\u3092EC2\u304b\u3089\u30ed\u30fc\u30ab\u30eb\u306b\u30b3\u30d4\u30fc\nEC2 \u306e /tmp/log.tgz \u3092\u30ed\u30fc\u30ab\u30eb\u306e ~/work/ \u306b\u30b3\u30d4\u30fc\u3059\u308b\u3002\n\u5f15\u6570\u306b `get`, `EC2\u5185\u30d5\u30a1\u30a4\u30eb\u30d1\u30b9`, `\u30ed\u30fc\u30ab\u30eb\u30b3\u30d4\u30fc\u5148\u30d1\u30b9` \u306e\u9806\u306b\u6307\u5b9a\u3059\u308b\u3002\n\u30b3\u30d4\u30fc\u5148\u304c\u672a\u6307\u5b9a\u306a\u3089\u30ab\u30ec\u30f3\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u306a\u308b\u3002\n\n```\n$ ec2ssh profile1 get /tmp/log.tgz ~/work/\n```\n\n### \u30d5\u30a1\u30a4\u30eb\u3092\u30ed\u30fc\u30ab\u30eb\u304b\u3089EC2\u306b\u30b3\u30d4\u30fc\n\u30ab\u30ec\u30f3\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e batch.sh \u3092 EC2 \u306e /tmp \u306b\u30b3\u30d4\u30fc\u3059\u308b\n\u5f15\u6570\u306b `put`, `\u30ed\u30fc\u30ab\u30eb\u30d5\u30a1\u30a4\u30eb\u30d1\u30b9`, `EC2\u5185\u30b3\u30d4\u30fc\u5148\u30d1\u30b9` \u306e\u9806\u306b\u6307\u5b9a\u3059\u308b\u3002\n\u30b3\u30d4\u30fc\u5148\u304c\u672a\u6307\u5b9a\u306a\u3089 ec2-user \u306e\u30db\u30fc\u30e0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u306a\u308b\u3002\n\n```\n$ ec2ssh profile1 put batch.sh /tmp\n```\n\n### \u30b9\u30af\u30ea\u30d7\u30c8\nhttps://gist.github.com/tilfin/4cdca4311b2585ed91e8\n\n- [AWS CLI](https://aws.amazon.com/jp/cli/) \u3068 [jq](https://stedolan.github.io/jq/) \u306b\u4f9d\u5b58\u3057\u3066\u3044\u307e\u3059\u3002\n- \u5404\u30ad\u30fc\u30da\u30a2pem\u30d5\u30a1\u30a4\u30eb\u306f\u3001AWS\u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089\u53d6\u5f97\u3057\u305f\u3068\u304d\u306e\u30d5\u30a1\u30a4\u30eb\u540d\u306e\u307e\u307e `~/.ssh/` \u306b\u7f6e\u304f\u3002\n- `~/.ec2ssh-pre` \u3092\u7f6e\u304f\u3068 ssh, scp \u524d\u306b\u4efb\u610f\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3067\u304d\u307e\u3059\u3002\n- `~/.ec2ssh-post` \u3092\u7f6e\u304f\u3068 ssh, scp \u5f8c\u306b\u4efb\u610f\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3067\u304d\u307e\u3059\u3002\n\n```bash\n#!/bin/bash\n#---------------------------------------------\n# EC2 SSH\n#\n# select target from instace list\n#---------------------------------------------\n#\n#  ssh example) $ ec2ssh profile1\n#\n#  download file example)\n#  $ ec2ssh profile1 get /tmp/log.tgz ~/work/\n#\n#  upload file example)\n#  $ ec2ssh profile1 put batch.sh /tmp\n#\n#\n#  If you want to hook pre and post command,\n#  put ~/.ec2ssh-pre or ~/.ec2ssh-post\n#  pre|post script is called with arguments:\n#     $1 = EC2 IP Address\n#     $2 = profile\n#     $3 = action\n#     $4 = source path\n#     $5 = destination path\n#\n#---------------------------------------------\n\nEC2USER=ec2-user\nALIVEINTERVAL=30\n\n\nprofile=$1\naction=$2\nsrc=$3\ndest=$4\nif [ \"$profile\" == \"\" ]; then\n  name=`basename $0`\n  echo \"Usage: $name <aws profile> [action] [src] [dest]\"\n  echo -n \"  aws profiles)\"\n  for pf in `grep -e \"\\[[a-z\\-]*\\]\" ~/.aws/credentials | sed 's/\\[//;s/\\]//'`\n  do\n    echo -n \" $pf\"\n  done\n  echo -e \"\\n  action) get put\"\n  exit 1\nfi\n\n\niplist=()\nkeylist=()\nindex=0\n\nIFS=$'\\n'\nfor line in `aws ec2 describe-instances --profile $profile \\\n  | jq '.Reservations[].Instances[] | {InstanceId, PublicIpAddress, PrivateIpAddress, KeyName, InstanceName: (.Tags[] | select(.Key==\"Name\").Value)}' 2> /dev/null \\\n  | jq 'sort_by(.InstanceName) | .[]' --slurp \\\n  | jq -r '[.PublicIpAddress, .InstanceId, .InstanceName, .KeyName] | @tsv'`\ndo\n  IFS=$'\\t'\n  item=( $line )\n  IFS=$'\\n'\n\n  iplist+=( ${item[0]:-dummy} )\n  keylist+=( ${item[3]:-dummy} )\n  echo -e \"$index) ${item[2]}\\t${item[0]}\\t${item[1]}\\t${item[3]}\"\n\n  index=$((index + 1))\n  count=$index\ndone\n\nif [ $count -eq 0 ]; then\n  echo \"Not found EC2 instances\"\n  exit 1\nfi\n\necho -n \"Input target EC2 number> \"\nread INPUT\nindex=$INPUT\n\nif [ \"$index\" != \"\" ] && [ $index -lt $count ]; then\n  hostip=${iplist[$index]}\n  pemfile=${keylist[${index}]}\n\n  if [ -f ~/.ec2ssh-pre ]; then\n    . ~/.ec2ssh-pre $hostip $profile $action $src $dest\n  fi\n\n  if [ \"$action\" == \"get\" ]; then\n    if [ \"$dest\" == \"\" ]; then\n      dest=\".\"\n    fi\n\n    scp -o StrictHostKeyChecking=no -i ~/.ssh/${pemfile}.pem $EC2USER@$hostip:$src $dest\n  elif [ \"$action\" == \"put\" ]; then\n    if [ \"$dest\" == \"\" ]; then\n      dest=\"~\"\n    fi\n\n    scp -o StrictHostKeyChecking=no -i ~/.ssh/${pemfile}.pem $src $EC2USER@$hostip:$dest\n  else\n    ssh -o ServerAliveInterval=$ALIVEINTERVAL \\\n        -o StrictHostKeyChecking=no \\\n        -l $EC2USER -i ~/.ssh/${pemfile}.pem $hostip\n  fi\n\n  if [ -f ~/.ec2ssh-post ]; then\n    . ~/.ec2ssh-post $hostip $profile $action $src $dest\n  fi\nfi\n```\n\n[tilfin's note](http://tilfin.hatenablog.com/entry/2016/02/25/012841) \u3088\u308a\u30af\u30ed\u30b9\u30dd\u30b9\u30c8\n", "tags": ["AWS", "EC2", "script"]}