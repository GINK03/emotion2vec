{"tags": ["awsIoT", "Fuji", "mqtt"], "context": " More than 1 year has passed since last update.MQTT\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4 Fuji\u3067\u8a3c\u660e\u66f8\u306b\u3088\u308b\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u8a8d\u8a3c\u306b\u5bfe\u5fdc\u3057\u305f\u306e\u3067\u3001AWS IoT\u306b\u7e4b\u3044\u3067\u307f\u307e\u3057\u305f\u3002\n\uff1c2016/2/16:\u8ffd\u8a18\uff1aFuji\u304c1.0.0\u30d0\u30fc\u30b8\u30e7\u30f3\u30ea\u30ea\u30fc\u30b9\u3068\u306a\u308a\u3001\u3053\u306e\u6a5f\u80fd\u304c\u6b63\u5f0f\u306b\u53d6\u308a\u8fbc\u307e\u308c\u3066\u3044\u307e\u3057\u305f\uff1e\n\u4ee5\u4e0b\u306e\u8a18\u4e8b\u3092\u5927\u5909\u53c2\u8003\u306b\u3055\u305b\u3066\u3044\u305f\u3060\u304d\u307e\u3057\u305f\u3002\u3042\u308a\u304c\u3068\u3046\u3054\u3056\u3044\u307e\u3059\u3002\nhttp://dev.classmethod.jp/cloud/aws/pub-sub-with-aws-iot-over-mqtt/\n\n\u307e\u305aAWS IoT\u5074\u3067Thing\u3092\u4f5c\u308b\n\u4ee5\u4e0b\u306e\u60c5\u5831\u304c\u5f97\u3089\u308c\u307e\u3059\n\nThing\u306ecertificate\n\u8a3c\u660e\u66f8\u306eprivate_key\n\u8a3c\u660e\u66f8\u306eprivate_key\u306b\u5bfe\u5fdc\u3059\u308bpublick_key\nMQTT topic\n\n\u8a3c\u660e\u66f8\u306e\u8a8d\u8a3c\u306e\u30eb\u30fc\u30c8CA\u306f\u30b7\u30de\u30f3\u30c6\u30c3\u30af\u30b5\u30a4\u30c8\u304b\u3089\u53d6\u5f97\u3057\u307e\u3059\u3002\ncurl -o rootCA.pem  https://www.symantec.com/content/en/us/enterprise/verisign/roots/VeriSign-Class%203-Public-Primary-Certification-Authority-G5.pem\n\n\n\u3068\u3053\u308d\u3067\u3001Things\u306eshadow\u3092update\u3059\u308b\u306b\u306f\u3069\u3093\u306aJSON\u3092\u6295\u3052\u308b\u306e\u304b\uff1f\nAPI\uff1ahttp://docs.aws.amazon.com/iot/latest/developerguide//thing-shadow-mqtt.html\nMQTT\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306emosquitto_sub, mosquitto_pub\u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u3063\u3066\u52d5\u4f5c\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u307e\u305a\u3001\u7d50\u679c\u3092\u30e2\u30cb\u30bf\u3059\u308b\u305f\u3081\u306esubscribe\u3092\u3057\u3066\u304a\u304d\u307e\u3059\n mosquitto_sub -t \"\\$aws/things/RoomTemp/#\" -h XXX.amazonaws.com -p 8883 --cafile rootCA.pem --cert UNIQUEID-certificate.pem.crt --key UNIQUEID-private.pem.key -d\n\n\nClient mosqsub/hostname. sending SUBSCRIBE (Mid: 1, Topic: $aws/things/RoomTemp/#, QoS: 0)\n\n\n\u3067\u306fJSON\u30c7\u30fc\u30bf\u3092publish\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\u5024\u3060\u3051\u306eJSON\u3092publish\u3057\u3066\u307f\u305f\nClient mosqsub/hostname. received PUBLISH (d0, q0, r0, m0, '$aws/things/RoomTemp/shadow/update', ... (13 bytes))\n{\"value\": 31}\n\n\u3059\u308b\u3068\u3001reject\u3092\u98df\u3089\u3063\u3066\u3044\u305f\nClient mosqsub/hostname. received PUBLISH (d0, q0, r0, m0, '$aws/things/RoomTemp/shadow/update/rejected', ... (53 bytes))\n{\"code\":400,\"message\":\"Missing required node: state\"}\n\ndesired\u3068reported\u3060\u3051\u3067\u3082\u30c0\u30e1\u3002\nClient mosqsub/hostname. received PUBLISH (d0, q0, r0, m0, '$aws/things/RoomTemp/shadow/update', ... (59 bytes))\n{ \"desired\": { \"value\": 30 }, \"reported\": { \"value\": 30 } }\nClient mosqsub/hostname. received PUBLISH (d0, q0, r0, m0, '$aws/things/RoomTemp/shadow/update/rejected', ... (53 bytes))\n{\"code\":400,\"message\":\"Missing required node: state\"}\n\npublish\u3059\u308bJSON\u306f\u4ee5\u4e0b\u306e\u5f62\u5f0f\u306b\u5f93\u3046\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u826f\u3044\u5b50\u306f\u3061\u3083\u3093\u3068\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092\u8aad\u307f\u307e\u3057\u3087\u3046\u3002\nhttp://docs.aws.amazon.com/iot/latest/developerguide//thing-shadow-document-syntax.html#thing-shadow-example-request-json\n\u8a3b\uff1aclientToke\u3068version\u306f\u30aa\u30d7\u30b7\u30e7\u30f3\n{\n    \"state\": {\n        \"desired\": {\n            \"attribute1\": integer2,\n            \"attribute2\": \"string2\",\n            ...\n            \"attributeN\": boolean2\n        },\n        \"reported\": {\n            \"attribute1\": integer1,\n            \"attribute2\": \"string1\",\n            ...\n            \"attributeN\": boolean1\n        }\n    }\n    \"clientToken\": \"token\",\n    \"version\": version\n}\n\n\u6210\u529f\u4f8b\ndesired\u3068reported\u304c\u7570\u306a\u308b\u5024\u306b\u3057\u3066\u307f\u307e\u3057\u305f\u3002\nClient mosqsub/hostname. received PUBLISH (d0, q0, r0, m0, '$aws/things/RoomTemp/shadow/update', ... (69 bytes))\n{\"state\":{ \"desired\": { \"value\": 30 }, \"reported\": { \"value\": 31 } }}\n\nClient mosqsub/hostname. received PUBLISH (d0, q0, r0, m0, '$aws/things/RoomTemp/shadow/update/delta', ... (103 bytes))\n{\"version\":4,\"timestamp\":1447815699,\"state\":{\"value\":30},\"metadata\":{\"value\":{\"timestamp\":1447815699}}}\n\nClient mosqsub/hostname. received PUBLISH (d0, q0, r0, m0, '$aws/things/RoomTemp/shadow/update/accepted', ... (197 bytes))\n{\"state\":{\"desired\":{\"value\":30},\"reported\":{\"value\":31}},\"metadata\":{\"desired\":{\"value\":{\"timestamp\":1447815699}},\"reported\":{\"value\":{\"timestamp\":1447815699}}},\"version\":4,\"timestamp\":1447815699}\n\n\u3053\u306e\u7d50\u679c\u3001out of sync\u306e\u72b6\u614b\u306b\u306a\u308a\u307e\u3059\u3002\n\u4ee5\u4e0b\u306e\u3088\u3046\u306bdesired\u3068reported\u304c\u4e00\u81f4\u3059\u308b\u3068AWS\u306e\u30b3\u30f3\u30bd\u30fc\u30eb\u306bShadow Status In sync\u3068\u8868\u793a\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\nClient mosqsub/hostname. received PUBLISH (d0, q0, r0, m0, '$aws/things/RoomTemp/shadow/update', ... (69 bytes))\n{\"state\":{ \"desired\": { \"value\": 30 }, \"reported\": { \"value\": 30 } }}\n\nClient mosqsub/hostname. received PUBLISH (d0, q0, r0, m0, '$aws/things/RoomTemp/shadow/update/accepted', ... (197 bytes))\n{\"state\":{\"desired\":{\"value\":30},\"reported\":{\"value\":30}},\"metadata\":{\"desired\":{\"value\":{\"timestamp\":1447815776}},\"reported\":{\"value\":{\"timestamp\":1447815776}}},\"version\":5,\"timestamp\":1447815776}\n\n\nfuji\u3067\u7e4b\u3052\u3066\u307f\u307e\u3059\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\n\nawsthing.toml\n[gateway]\nname = \"RoomTemp\"\n\n[[broker.\"aws/1\"]]\n\nhost = \"ABCDEFG.iot.ap-northeast-1.amazonaws.com\"\nport = 8883\ntopic_prefix = \"aws\"\n\ntls = true\n\ncacert = \"/AWSThing/rootCA.pem\"\nclient_cert = \"/AWSThing/XXXXX-certificate.pem.crt\"\nclient_key = \"AWSThing/XXXXX-private.pem.key\"\n\n[device.\"RoomTemp\"]\ntype = \"dummy\"\nbroker = \"aws\"\ninterval = 30\nqos = 0\npayload = \"30\"\n\n\n\n\u5b9f\u884c\u7d50\u679c\n$ ./fuji -c awsthing.toml -d\n\nINFO[0000] start fuji gateway\nWARN[0000] status create error, no status found\nINFO[0000] broker connecting to: tcp://ABCDEF.iot.ap-northeast-1.amazonaws.com:8883\nINFO[0000] start dummy device\nINFO[0000] client connected\nDEBU[0030] message got: {aws/RoomTemp/RoomTemp/dummy/publish}\nDEBU[0030] message published: {aws/RoomTemp/RoomTemp/dummy/publish}\n\n\n\u77e5\u898b\u3001\u306e\u3088\u3046\u306a\u7269\n\n\u8a3c\u660e\u66f8\u304c\u7121\u52b9\u306a\u5834\u5408\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30a8\u30e9\u30fc\u304c\u51fa\u308b\u3089\u3057\u3044\nERRO[0000] Failed to start MQTT client: Network Error : remote error: unknown certificate \n\nERRO[0000] Failed to start MQTT client: Network Error : remote error: unknown certificate authority \n\n\n\u3069\u3046\u3084\u3089will\u306e\u8a2d\u5b9a\u304c\u3042\u308b\u3068\u3046\u307e\u304f\u7e4b\u304c\u3089\u306a\u3044\u3089\u3057\u3044\n\u3082\u3068\u3082\u3068AWS IoT\u306e\u30b7\u30b9\u30c6\u30e0\u306fWill\u3092\u30b5\u30dd\u30fc\u30c8\u305b\u305a\u3001Shadow\u306e\u72b6\u614b\u3068\u3057\u3066\u8868\u73fe\u3067\u304d\u308b\u3088\u3046\u306a\u306e\u3067\u7279\u306b\u554f\u984c\u3067\u306f\u7121\u3044\u3068\u601d\u3044\u307e\u3059\u304c\u3001\u8a2d\u5b9a\u3067will_message\u3092\u6307\u5b9a\u3057\u305f\u3089\u3064\u306a\u304c\u3089\u305a\u3001\u3061\u3087\u3063\u3068\u60a9\u307f\u307e\u3057\u305f\uff082015\u5e7412\u6708\u4e0b\u65ec\u6642\u70b9\uff09\n\n<a href=\"https://github.com/shiguredo/fuji\">MQTT\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4 Fuji</a>\u3067\u8a3c\u660e\u66f8\u306b\u3088\u308b\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u8a8d\u8a3c\u306b\u5bfe\u5fdc\u3057\u305f\u306e\u3067\u3001AWS IoT\u306b\u7e4b\u3044\u3067\u307f\u307e\u3057\u305f\u3002\n\uff1c2016/2/16:\u8ffd\u8a18\uff1aFuji\u304c1.0.0\u30d0\u30fc\u30b8\u30e7\u30f3\u30ea\u30ea\u30fc\u30b9\u3068\u306a\u308a\u3001\u3053\u306e\u6a5f\u80fd\u304c\u6b63\u5f0f\u306b\u53d6\u308a\u8fbc\u307e\u308c\u3066\u3044\u307e\u3057\u305f\uff1e\n\n\u4ee5\u4e0b\u306e\u8a18\u4e8b\u3092\u5927\u5909\u53c2\u8003\u306b\u3055\u305b\u3066\u3044\u305f\u3060\u304d\u307e\u3057\u305f\u3002\u3042\u308a\u304c\u3068\u3046\u3054\u3056\u3044\u307e\u3059\u3002\n\nhttp://dev.classmethod.jp/cloud/aws/pub-sub-with-aws-iot-over-mqtt/\n\n\n## \u307e\u305aAWS IoT\u5074\u3067Thing\u3092\u4f5c\u308b\n\n\u4ee5\u4e0b\u306e\u60c5\u5831\u304c\u5f97\u3089\u308c\u307e\u3059\n\n- Thing\u306ecertificate\n- \u8a3c\u660e\u66f8\u306eprivate_key\n- \u8a3c\u660e\u66f8\u306eprivate_key\u306b\u5bfe\u5fdc\u3059\u308bpublick_key\n- MQTT topic\n\n\u8a3c\u660e\u66f8\u306e\u8a8d\u8a3c\u306e\u30eb\u30fc\u30c8CA\u306f\u30b7\u30de\u30f3\u30c6\u30c3\u30af\u30b5\u30a4\u30c8\u304b\u3089\u53d6\u5f97\u3057\u307e\u3059\u3002\n\n```\ncurl -o rootCA.pem  https://www.symantec.com/content/en/us/enterprise/verisign/roots/VeriSign-Class%203-Public-Primary-Certification-Authority-G5.pem\n```\n\n\n## \u3068\u3053\u308d\u3067\u3001Things\u306eshadow\u3092update\u3059\u308b\u306b\u306f\u3069\u3093\u306aJSON\u3092\u6295\u3052\u308b\u306e\u304b\uff1f\n\nAPI\uff1ahttp://docs.aws.amazon.com/iot/latest/developerguide//thing-shadow-mqtt.html\n\nMQTT\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306emosquitto_sub, mosquitto_pub\u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u3063\u3066\u52d5\u4f5c\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3059\u3002\n\n### \u307e\u305a\u3001\u7d50\u679c\u3092\u30e2\u30cb\u30bf\u3059\u308b\u305f\u3081\u306esubscribe\u3092\u3057\u3066\u304a\u304d\u307e\u3059\n\n```\n mosquitto_sub -t \"\\$aws/things/RoomTemp/#\" -h XXX.amazonaws.com -p 8883 --cafile rootCA.pem --cert UNIQUEID-certificate.pem.crt --key UNIQUEID-private.pem.key -d\n \n\nClient mosqsub/hostname. sending SUBSCRIBE (Mid: 1, Topic: $aws/things/RoomTemp/#, QoS: 0)\n```\n\n### \u3067\u306fJSON\u30c7\u30fc\u30bf\u3092publish\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\n\u5024\u3060\u3051\u306eJSON\u3092publish\u3057\u3066\u307f\u305f\n\n```\nClient mosqsub/hostname. received PUBLISH (d0, q0, r0, m0, '$aws/things/RoomTemp/shadow/update', ... (13 bytes))\n{\"value\": 31}\n```\n\n\u3059\u308b\u3068\u3001reject\u3092\u98df\u3089\u3063\u3066\u3044\u305f\n\n```\nClient mosqsub/hostname. received PUBLISH (d0, q0, r0, m0, '$aws/things/RoomTemp/shadow/update/rejected', ... (53 bytes))\n{\"code\":400,\"message\":\"Missing required node: state\"}\n```\n\n`desired`\u3068`reported`\u3060\u3051\u3067\u3082\u30c0\u30e1\u3002\n\n```\nClient mosqsub/hostname. received PUBLISH (d0, q0, r0, m0, '$aws/things/RoomTemp/shadow/update', ... (59 bytes))\n{ \"desired\": { \"value\": 30 }, \"reported\": { \"value\": 30 } }\nClient mosqsub/hostname. received PUBLISH (d0, q0, r0, m0, '$aws/things/RoomTemp/shadow/update/rejected', ... (53 bytes))\n{\"code\":400,\"message\":\"Missing required node: state\"}\n```\n\npublish\u3059\u308bJSON\u306f\u4ee5\u4e0b\u306e\u5f62\u5f0f\u306b\u5f93\u3046\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u826f\u3044\u5b50\u306f\u3061\u3083\u3093\u3068\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092\u8aad\u307f\u307e\u3057\u3087\u3046\u3002\n\nhttp://docs.aws.amazon.com/iot/latest/developerguide//thing-shadow-document-syntax.html#thing-shadow-example-request-json\n\n\u8a3b\uff1aclientToke\u3068version\u306f\u30aa\u30d7\u30b7\u30e7\u30f3\n\n```\n{\n    \"state\": {\n        \"desired\": {\n            \"attribute1\": integer2,\n            \"attribute2\": \"string2\",\n            ...\n            \"attributeN\": boolean2\n        },\n        \"reported\": {\n            \"attribute1\": integer1,\n            \"attribute2\": \"string1\",\n            ...\n            \"attributeN\": boolean1\n        }\n    }\n    \"clientToken\": \"token\",\n    \"version\": version\n}\n```\n\n\n\u6210\u529f\u4f8b\ndesired\u3068reported\u304c\u7570\u306a\u308b\u5024\u306b\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n```\nClient mosqsub/hostname. received PUBLISH (d0, q0, r0, m0, '$aws/things/RoomTemp/shadow/update', ... (69 bytes))\n{\"state\":{ \"desired\": { \"value\": 30 }, \"reported\": { \"value\": 31 } }}\n\nClient mosqsub/hostname. received PUBLISH (d0, q0, r0, m0, '$aws/things/RoomTemp/shadow/update/delta', ... (103 bytes))\n{\"version\":4,\"timestamp\":1447815699,\"state\":{\"value\":30},\"metadata\":{\"value\":{\"timestamp\":1447815699}}}\n\nClient mosqsub/hostname. received PUBLISH (d0, q0, r0, m0, '$aws/things/RoomTemp/shadow/update/accepted', ... (197 bytes))\n{\"state\":{\"desired\":{\"value\":30},\"reported\":{\"value\":31}},\"metadata\":{\"desired\":{\"value\":{\"timestamp\":1447815699}},\"reported\":{\"value\":{\"timestamp\":1447815699}}},\"version\":4,\"timestamp\":1447815699}\n```\n\n\u3053\u306e\u7d50\u679c\u3001`out of sync`\u306e\u72b6\u614b\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b`desired`\u3068`reported`\u304c\u4e00\u81f4\u3059\u308b\u3068AWS\u306e\u30b3\u30f3\u30bd\u30fc\u30eb\u306b`Shadow Status In sync`\u3068\u8868\u793a\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n```\nClient mosqsub/hostname. received PUBLISH (d0, q0, r0, m0, '$aws/things/RoomTemp/shadow/update', ... (69 bytes))\n{\"state\":{ \"desired\": { \"value\": 30 }, \"reported\": { \"value\": 30 } }}\n\nClient mosqsub/hostname. received PUBLISH (d0, q0, r0, m0, '$aws/things/RoomTemp/shadow/update/accepted', ... (197 bytes))\n{\"state\":{\"desired\":{\"value\":30},\"reported\":{\"value\":30}},\"metadata\":{\"desired\":{\"value\":{\"timestamp\":1447815776}},\"reported\":{\"value\":{\"timestamp\":1447815776}}},\"version\":5,\"timestamp\":1447815776}\n```\n\n# fuji\u3067\u7e4b\u3052\u3066\u307f\u307e\u3059\n\n## \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\n\n```{awsthing.toml}\n[gateway]\nname = \"RoomTemp\"\n\n[[broker.\"aws/1\"]]\n\nhost = \"ABCDEFG.iot.ap-northeast-1.amazonaws.com\"\nport = 8883\ntopic_prefix = \"aws\"\n\ntls = true\n\ncacert = \"/AWSThing/rootCA.pem\"\nclient_cert = \"/AWSThing/XXXXX-certificate.pem.crt\"\nclient_key = \"AWSThing/XXXXX-private.pem.key\"\n\n[device.\"RoomTemp\"]\ntype = \"dummy\"\nbroker = \"aws\"\ninterval = 30\nqos = 0\npayload = \"30\"\n```\n\n## \u5b9f\u884c\u7d50\u679c\n\n```\n$ ./fuji -c awsthing.toml -d\n\nINFO[0000] start fuji gateway\nWARN[0000] status create error, no status found\nINFO[0000] broker connecting to: tcp://ABCDEF.iot.ap-northeast-1.amazonaws.com:8883\nINFO[0000] start dummy device\nINFO[0000] client connected\nDEBU[0030] message got: {aws/RoomTemp/RoomTemp/dummy/publish}\nDEBU[0030] message published: {aws/RoomTemp/RoomTemp/dummy/publish}\n```\n\n\n# \u77e5\u898b\u3001\u306e\u3088\u3046\u306a\u7269\n\n\n## \u8a3c\u660e\u66f8\u304c\u7121\u52b9\u306a\u5834\u5408\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30a8\u30e9\u30fc\u304c\u51fa\u308b\u3089\u3057\u3044\n\n```\nERRO[0000] Failed to start MQTT client: Network Error : remote error: unknown certificate \n\nERRO[0000] Failed to start MQTT client: Network Error : remote error: unknown certificate authority \n```\n\n## \u3069\u3046\u3084\u3089will\u306e\u8a2d\u5b9a\u304c\u3042\u308b\u3068\u3046\u307e\u304f\u7e4b\u304c\u3089\u306a\u3044\u3089\u3057\u3044\n\n\u3082\u3068\u3082\u3068AWS IoT\u306e\u30b7\u30b9\u30c6\u30e0\u306fWill\u3092\u30b5\u30dd\u30fc\u30c8\u305b\u305a\u3001Shadow\u306e\u72b6\u614b\u3068\u3057\u3066\u8868\u73fe\u3067\u304d\u308b\u3088\u3046\u306a\u306e\u3067\u7279\u306b\u554f\u984c\u3067\u306f\u7121\u3044\u3068\u601d\u3044\u307e\u3059\u304c\u3001\u8a2d\u5b9a\u3067will_message\u3092\u6307\u5b9a\u3057\u305f\u3089\u3064\u306a\u304c\u3089\u305a\u3001\u3061\u3087\u3063\u3068\u60a9\u307f\u307e\u3057\u305f\uff082015\u5e7412\u6708\u4e0b\u65ec\u6642\u70b9\uff09\n"}