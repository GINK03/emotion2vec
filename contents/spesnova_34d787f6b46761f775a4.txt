{"tags": ["etcd", "docker", "CoreOS"], "context": " More than 1 year has passed since last update.\n\n\u6982\u8981\nvulcand \u3068\u3044\u3046 HTTP \u30d7\u30ed\u30ad\u30b7\u3092\u4f7f\u3063\u3066 Docker \u30b3\u30f3\u30c6\u30ca\u3092\u30d6\u30eb\u30fc\u30b0\u30ea\u30fc\u30f3\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u3068\u3044\u3046\u8a71\u3002\nConsul \u3068 Nginx \u3092\u7d44\u307f\u5408\u308f\u305b\u3066\u52d5\u7684\u306b\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b9\u3059\u308b\u3068\u3044\u3046\u8a71\u3068\u3084\u308a\u305f\u3044\u3053\u3068\u306f\u540c\u3058\u3060\u3068\u601d\u3046\u3002\n\nvulcand \u3068\u306f\nvulcand \u306f\u3001Mailgun \u3068\u3044\u3046\u30e1\u30fc\u30eb\u7cfb SaaS \u306e\u958b\u767a\u30c1\u30fc\u30e0\u304c\u4f5c\u3063\u305f HTTP \u30d7\u30ed\u30ad\u30b7\u3002\n\netcd \u3092\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306b\u5229\u7528\u3057\u305f HTTP \u30d7\u30ed\u30ad\u30b7\n\u518d\u8d77\u52d5\u306a\u3057\u3067\u8a2d\u5b9a\u3092\u53cd\u6620\u3067\u304d\u308b\nHTTP API \u3068 CLI\n\u30d7\u30e9\u30ac\u30d6\u30eb\u306a\u30df\u30c9\u30eb\u30a6\u30a7\u30a2\n\u30bc\u30ed\u30c0\u30a6\u30f3\u30bf\u30a4\u30e0\u30c7\u30d7\u30ed\u30a4\u306e\u30b5\u30dd\u30fc\u30c8\n\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u30e1\u30c8\u30ea\u30af\u30b9\u30ec\u30dd\u30fc\u30c8\nTLS \u3068 certificate \u306e\u7ba1\u7406\n\n\u3068\u3044\u3063\u305f\u7279\u5fb4\u3092\u6301\u3064\u3002\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092 etcd \u306b\u4fdd\u5b58\u3057\u3066\u518d\u8d77\u52d5\u306a\u3057\u3067\u8a2d\u5b9a\u53cd\u6620\u3067\u304d\u308b\u3068\u3044\u3046\u306e\u304c\u975e\u5e38\u306b\u4fbf\u5229\u306a\u30dd\u30a4\u30f3\u30c8\u3060\u3068\u601d\u3046\u3002 \n\nvulcand \u306e\u4ed5\u7d44\u307f\n\nvulcand \u306b \u4ee5\u4e0b\u306e 2 \u3064\u306e\u4e3b\u8981\u306a\u6982\u5ff5\u304c\u3042\u308b\u3002\n\nlocations\nupstreams\n\n\nLocation\nLocation \u306f\u30db\u30b9\u30c8\u540d\u3068\u30ea\u30af\u30a8\u30b9\u30c8\u30d1\u30b9\u306e\u7d44\u307f\u5408\u308f\u305b\u304b\u3089\u306a\u308a\u3001\u540d\u524d\u3092\u6301\u3064\u3002\u30ea\u30af\u30a8\u30b9\u30c8\u3055\u308c\u305f URL \u306b\u5bfe\u3057\u3066\u6b63\u898f\u8868\u73fe\u30de\u30c3\u30c1\u304c\u884c\u308f\u308c\u308b\u3002\n\u4f8b\n\n\nsearch \u3068\u3044\u3046\u540d\u524d\u306e location \u3067 example.com \u3092 host \u3068\u3057\u3066 /search \u3092\u6b63\u898f\u8868\u73fe\u30de\u30c3\u30c1\u30e3\u3068\u3057\u3066\u4f7f\u3046 \n\nuser \u3068\u3044\u3046\u540d\u524d\u306e location \u3067 example.com \u3092 host \u3068\u3057\u3066 /^users.*$/ \u3092\u6b63\u898f\u8868\u73fe\u30de\u30c3\u30c1\u30e3\u3068\u3057\u3066\u4f7f\u3046\n\n\u305d\u3057\u3066 Location \u306f\u5f8c\u8ff0\u3059\u308b upstream \u3092\u6301\u3061\u3001\u6b63\u898f\u8868\u73fe\u30de\u30c3\u30c1\u3057\u305f\u30ea\u30af\u30a8\u30b9\u30c8\u3092upstreams \u3078\u30d7\u30ed\u30ad\u30b7\u3059\u308b\u3002\n\nUpstream\nUpstream \u306f\u5f8c\u8ff0\u3059\u308b endpoint \u306e\u96c6\u5408\u3067\u3042\u308a\u3001\u540d\u524d\u3092\u6301\u3064\u3002\n\u4f8b\n\n\nsearch-backend \u3068\u3044\u3046\u540d\u524d\u306e upstream \u3067 endpoint \u306f http://10.10.1.2:8080 \u3068 http://10.10.1.3:8080 \n\n\nEndpoint\nEndpoint \u306f\u6700\u7d42\u7684\u306b\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u51e6\u7406\u3059\u308b\u3068\u3053\u308d\u3002 <schema>://<host>:<port> \u5f62\u5f0f\u3067\u5b9a\u7fa9\u3059\u308b\n\u4f8b\n\nhttp://localhost:5000\n\n\nVulcand \u3092\u4f7f\u3063\u3066 Docker \u30b3\u30f3\u30c6\u30ca\u306e\u30d6\u30eb\u30fc\u30b0\u30ea\u30fc\u30f3\u30c7\u30d7\u30ed\u30a4\nVagrant \u3067\u8d77\u52d5\u3057\u305f CoreOS \u30de\u30b7\u30f3\u4e0a\u306e vulcand \u306b OS X \u304b\u3089\u63a5\u7d9a\u3057\u3066\u30d6\u30eb\u30fc\u30b0\u30ea\u30fc\u30f3\u30c7\u30d7\u30ed\u30a4\u3092\u8a66\u3059\u3002\n\u30a4\u30e1\u30fc\u30b8\u56f3:\n\n\u4f8b\u3068\u3057\u3066\u3001example \u3068\u3044\u3046\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u304c\u3042\u308b\u3068\u3057\u3066\u3001v1 \u304b\u3089 v2 \u3078\u306e\u5207\u308a\u66ff\u3048\u3092\u3059\u308b\u30c7\u30d7\u30ed\u30a4\u3092\u3059\u308b\u3002\n\nOS X \u5074\u306e hosts \u3092\u8a2d\u5b9a\u3057\u3066\u304a\u304f\n# on CoreOS\ncore@core-01 ~ $ cat /etc/environment\nCOREOS_PUBLIC_IPV4=172.17.8.101\nCOREOS_PRIVATE_IPV4=172.17.8.101\n\n# on OS X\n$ sudo vi /etc/hosts\n\n##\n# Host Database\n#\n# localhost is used to configure the loopback interface\n# when the system is booting.  Do not change this entry.\n##\n127.0.0.1       localhost\n255.255.255.255 broadcasthost\n::1             localhost\n\n172.17.8.101    example.com # \u8ffd\u52a0\n\n\n\u30b5\u30fc\u30d3\u30b9\u30b3\u30f3\u30c6\u30ca v1 \u306e\u8d77\u52d5\nexample \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b3\u30f3\u30c6\u30ca\u306e v1 \u30922 \u53f0\u8d77\u52d5\u3059\u308b\n# on CoreOS\ncore@core-01 ~ $ docker run -d --name example-v1.1 -p 8086:80 coreos/example:1.0.0\n0940df1b68a823e68d165196a7fde12922b6c57ff6b4ad95441a2fa9fd64a95b\n\ncore@core-01 ~ $ docker run -d --name example-v1.2 -p 8087:80 coreos/example:1.0.0\ne35ed7de9766ae67e14bc05f95e5c1a207d74b03e3dd4f350b99192c4ff51845\n\n\nUpstream example-v1 \u306e\u8a2d\u5b9a\n\u7d9a\u3044\u3066\u3001example-v1.1, exaple-v1.2 \u3092 endpoint \u3068\u3059\u308b example \u3068\u3044\u3046 upstream \u3092\u30bb\u30c3\u30c8\u3059\u308b\u3002\n# on CoreOS\ncore@core-01 ~ $ etcdctl set /vulcand/upstreams/example-v1/endpoints/1 http://172.17.8.101:8086\nhttp://172.17.8.101:8086\n\ncore@core-01 ~ $ etcdctl set /vulcand/upstreams/example-v1/endpoints/2 http://172.17.8.101:8087\nhttp://172.17.8.101:8087\n\n\nLocation \u306e\u8a2d\u5b9a\nhome \u3068\u3044\u3046\u540d\u524d\u306e location \u3092\u4f5c\u6210\u3059\u308b\u3002\u6b63\u898f\u8868\u73fe\u30de\u30c3\u30c1\u30e3\u306f /.* \u3064\u307e\u308a\u5168\u3066\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u30de\u30c3\u30c1\u3055\u305b\u308b\u3002\n# on CoreoS\ncore@core-01 ~ $ etcdctl set \"/vulcand/hosts/example.com/locations/home/path\" '/.*'\n/.*\n\n\u305d\u3057\u3066 home location \u3092 example-v1 upstream \u306b\u30d7\u30ed\u30ad\u30b7\u3055\u305b\u308b\u3088\u3046\u30bb\u30c3\u30c8\u3059\u308b\n# on CoreOS\ncore@core-01 ~ $ etcdctl set /vulcand/hosts/example.com/locations/home/upstream example-v1\nexample-v1\n\n\nvulcand \u30b3\u30f3\u30c6\u30ca\u306e\u8d77\u52d5\n# on CoreOS\ncore@core-01 ~ $ docker run \\\n  --rm \\\n  --name vulcan \\\n  -p 80:80 \\\n  -p 8182:8182 \\\n  mailgun/vulcand \\\n  /opt/vulcan/vulcand \\\n  -apiInterface=\"0.0.0.0\" \\\n  -interface=\"0.0.0.0\" \\\n  -etcd=\"http://172.17.8.101:4001\" \\\n  -port=80 \\\n  -apiPort=8182\n\n\n\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u308b\nhttp://example.com \u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u308b\u3002example \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e v1 \u304c\u898b\u308c\u305f :)\n\n\n\u30b5\u30fc\u30d3\u30b9\u30b3\u30f3\u30c6\u30ca v2 \u306e\u8d77\u52d5\n# on CoreOS\ncore@core-01 ~ $ docker run -d --name example-v2.1 -p 8088:80 coreos/example:2.0.0\n8aa0f8cd402fa8be29b96f37bc97a2899bb32510cc3a8899d1338d0f8c8e1040\n\ncore@core-01 ~ $ docker run -d --name example-v2.2 -p 8089:80 coreos/example:2.0.0\n8db14040b1207ec42a5c08236bd4c7214323db36058d47e77606256231b6f5e8\n\n\nupstream example-v2 \u306e\u8a2d\u5b9a\n# on CoreOS\ncore@core-01 ~ $ etcdctl set /vulcand/upstreams/example-v2/endpoints/1 http://172.17.8.101:8088\nhttp://172.17.8.101:8088\n\ncore@core-01 ~ $ etcdctl set /vulcand/upstreams/example-v2/endpoints/2 http://172.17.8.101:8089\nhttp://172.17.8.101:8089\n\n\nv1 \u304b\u3089 v2 \u306b\u5207\u308a\u66ff\u3048\n# on CoreOS\ncore@core-01 ~ $ etcdctl set /vulcand/hosts/example.com/locations/home/upstream example-v2\n\n\n\u518d\u5ea6\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u308b\nexample \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e v2 \u306b\u306a\u3063\u3066\u308b :)\n\u30bc\u30ed\u30c0\u30a6\u30f3\u30bf\u30a4\u30e0\u30d6\u30eb\u30fc\u30b0\u30ea\u30fc\u30f3\u30c7\u30d7\u30ed\u30a4\u3002\n\n\u3053\u3053\u3067\u307e\u305f\n# on CoreOS\ncore@core-01 ~ $ etcdctl set /vulcand/hosts/example.com/locations/home/upstream example-v1\n\n\u3068\u3059\u308c\u3070 v1 \u306e\u30b3\u30f3\u30c6\u30ca\u306b\u30d7\u30ed\u30ad\u30b7\u3055\u308c\u3066\u30ed\u30fc\u30eb\u30d0\u30c3\u30af\u304c\u3067\u304d\u308b\u3002\n\n\u30ed\u30fc\u30ea\u30f3\u30b0\u30c7\u30d7\u30ed\u30a4\n\n\u4e0a\u8a18\u306e\u4f8b\u3060\u3068\u3001home location \u3078\u7d10\u3065\u3051\u308b upstream \u3092 example-v1 \u304b\u3089 example-v2 \u306b\u5207\u308a\u66ff\u3048\u3066\u30c7\u30d7\u30ed\u30a4\u3092\u884c\u3063\u305f\u304c\u3001upstream \u3092\u56fa\u5b9a\u3057\u3066\u3001endpoint \u3092\u8ffd\u52a0\u30fb\u524a\u9664\u3059\u308b\u3053\u3068\u3067\u30ed\u30fc\u30ea\u30f3\u30b0\u30c7\u30d7\u30ed\u30a4\u3082\u53ef\u80fd\u3002\n\nTODO: registrator \u3092\u4f7f\u3063\u3066 upstream \u306e\u81ea\u52d5\u767b\u9332\u3092\u3059\u308b\nregistrator \u307e\u305f\u306f docker-plugin \u3092\u4f7f\u3063\u3066\u3001\u30b3\u30f3\u30c6\u30ca\u306e start hook \u6642\u306b etcd \u306b\u8d77\u52d5 IP \u3068 Port \u3092\u767b\u9332\u3059\u308b\n\n\u30e1\u30e2\u3068\u611f\u60f3\n\nHA \u69cb\u6210\u3067\u304d\u308b\netcd \u304b\u3089\u8a2d\u5b9a\u3092\u8aad\u3080\u306e\u3067\u3001HA \u69cb\u6210\u304c\u5b9f\u73fe\u3067\u304d\u305d\u3046\u3002\u4f8b\u3048\u3070 AWS \u3067 3 \u53f0\u304b\u3089\u306a\u308b CoreOS \u30af\u30e9\u30b9\u30bf\u304c\u3042\u308b\u3068\u304d\u3001\u5168\u53f0\u3067 vulcand \u3092\u8d77\u52d5\u3057\u3066\u304a\u304d\u3001vulcand \u306e\u524d\u6bb5\u306b ELB \u3092\u7f6e\u304f\u4e8b\u3067\u3001\n\nDocker \u30db\u30b9\u30c8\u30ec\u30d9\u30eb\uff08\uff1dEC2 \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\uff09\u306e\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b9\u3092 ELB \u306b\nDocker \u30b3\u30f3\u30c6\u30ca\u30ec\u30d9\u30eb\u306e\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b9\u3092 vulcan \u306b\n\n\u3084\u3089\u305b\u308b\u3053\u3068\u3067\u5272\u3068\u30b7\u30f3\u30d7\u30eb\u306a\u69cb\u6210\u306b\u3067\u304d\u305d\u3046\u3002\n# requests:\n#  - www.example.com\n#  - admin.example.com\n#  - search.example.com\n\n\n                     vulcan.1 on coreos.1 \n                   /                        --> upstream `search`\n                  /                       /\nrequest --> ELB ---  vulcan.2 on coreos.2  ---> upstream `admin`\n                 \\                        \\ \n                   \\                        --> upstream `www`\n                     vulcan.3 on coreos.3\n\n\n\nNginx \u3068\u6bd4\u3079\u3066\n\n\u30b3\u30f3\u30c6\u30ca\u3068\u3057\u3066\u52d5\u304b\u3059\u306e\u306b\u5411\u3044\u3066\u3044\u308b\n\u30d7\u30ed\u30ad\u30b7\u3068\u3057\u3066\u306e\u6a5f\u80fd\u306f nginx \u3068\u6bd4\u3079\u308b\u3068\u4e4f\u3057\u3044\uff1f\n\n\n\u30b3\u30f3\u30c6\u30ca\u3068\u3057\u3066\u52d5\u304b\u3059\u3053\u3068\u306b\u3064\u3044\u3066\nnginx \u304c\u30b3\u30f3\u30c6\u30ca\u3068\u3057\u3066\u52d5\u304b\u305d\u3046\u3068\u601d\u3046\u3068\u5f8c\u304b\u3089\u8a2d\u5b9a\u3092\u30c0\u30a4\u30ca\u30df\u30c3\u30af\u306b\u306f\u5909\u66f4\u3057\u3065\u3089\u3044\u3002\u306a\u306e\u3067\u3001Docker \u30db\u30b9\u30c8\u5074\u306b Nginx \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3053\u3068\u306b\u306a\u308b\u3002\u306a\u308b\u3060\u3051\u5168\u3066\u3092\u30b3\u30f3\u30c6\u30ca\u3067\u3084\u308a\u305f\u3044\u3068\u601d\u3046\u3068\u3053\u308c\u306f\u5fae\u5999\u3002\n\u9811\u5f35\u3063\u3066\u30b3\u30f3\u30c6\u30ca\u3067\u3084\u308d\u3046\u3068\u3059\u308b\u306a\u3089\n\n\u30b3\u30f3\u30c6\u30ca\u3092 Nginx \u3068\u3057\u3066\u52d5\u304b\u3059\u304c\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092 -v \u3067\u30db\u30b9\u30c8\u3068\u5171\u6709\u3057\u3066 docker exec \u3067 nginx \u3092 reload \n\u30b3\u30f3\u30c6\u30ca\u3092 Nginx \u3068\u3057\u3066\u52d5\u304b\u3059\u304c\u3001\u8a2d\u5b9a\u5909\u66f4\u6642\u306f\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u306b\u74b0\u5883\u5909\u6570\u3084\u5f15\u6570\u3092\u6e21\u3057\u3066\u52d5\u7684\u306b\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u4f5c\u3063\u3066\u30b3\u30f3\u30c6\u30ca\u518d\u8d77\u52d5\n\n\u3068\u3044\u3063\u305f\u611f\u3058\u3067\u3067\u304d\u306a\u304f\u3082\u306a\u3044\u3068\u601d\u3046\u304c\u3001\u3068\u3066\u3082\u8907\u96d1\uff08\u4ed6\u306b\u3082\u3084\u308a\u65b9\u306f\u3042\u308b\u3068\u601d\u3046\uff09\n\nTODO: \u30d7\u30ed\u30ad\u30b7\u3068\u3057\u3066\u306e\u6a5f\u80fd\u306b\u3064\u3044\u3066\n\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u307e\u3060\u5168\u90e8\u8aad\u3081\u3066\u306a\u3044\u3002deis \u306f\u300c\u8272\u3005\u8db3\u308a\u3066\u306a\u3044\u304b\u3089\u307e\u3060 Nginx \u4f7f\u3046\u3088\u300d \u3063\u3066\u8a00\u3063\u3066\u308b\u3002\n\nREF\n\nmailgun/vulcand - GitHub\nmailgun/vulcand - DockerHub\nvulcan Documentation\nZero Downtime Frontend Deploys with Vulcand on CoreOS\nGolang Reverse Proxy - r7km/s\n\n\n## \u6982\u8981\nvulcand \u3068\u3044\u3046 HTTP \u30d7\u30ed\u30ad\u30b7\u3092\u4f7f\u3063\u3066 Docker \u30b3\u30f3\u30c6\u30ca\u3092\u30d6\u30eb\u30fc\u30b0\u30ea\u30fc\u30f3\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u3068\u3044\u3046\u8a71\u3002\nConsul \u3068 Nginx \u3092\u7d44\u307f\u5408\u308f\u305b\u3066\u52d5\u7684\u306b\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b9\u3059\u308b\u3068\u3044\u3046\u8a71\u3068\u3084\u308a\u305f\u3044\u3053\u3068\u306f\u540c\u3058\u3060\u3068\u601d\u3046\u3002\n\n## vulcand \u3068\u306f\n[vulcand](https://github.com/mailgun/vulcand) \u306f\u3001[Mailgun](http://www.mailgun.com/) \u3068\u3044\u3046\u30e1\u30fc\u30eb\u7cfb SaaS \u306e\u958b\u767a\u30c1\u30fc\u30e0\u304c\u4f5c\u3063\u305f HTTP \u30d7\u30ed\u30ad\u30b7\u3002\n\n* etcd \u3092\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306b\u5229\u7528\u3057\u305f HTTP \u30d7\u30ed\u30ad\u30b7\n* \u518d\u8d77\u52d5\u306a\u3057\u3067\u8a2d\u5b9a\u3092\u53cd\u6620\u3067\u304d\u308b\n* HTTP API \u3068 CLI\n* \u30d7\u30e9\u30ac\u30d6\u30eb\u306a\u30df\u30c9\u30eb\u30a6\u30a7\u30a2\n* \u30bc\u30ed\u30c0\u30a6\u30f3\u30bf\u30a4\u30e0\u30c7\u30d7\u30ed\u30a4\u306e\u30b5\u30dd\u30fc\u30c8\n* \u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u30e1\u30c8\u30ea\u30af\u30b9\u30ec\u30dd\u30fc\u30c8\n* TLS \u3068 certificate \u306e\u7ba1\u7406\n\n\u3068\u3044\u3063\u305f\u7279\u5fb4\u3092\u6301\u3064\u3002\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092 etcd \u306b\u4fdd\u5b58\u3057\u3066\u518d\u8d77\u52d5\u306a\u3057\u3067\u8a2d\u5b9a\u53cd\u6620\u3067\u304d\u308b\u3068\u3044\u3046\u306e\u304c\u975e\u5e38\u306b\u4fbf\u5229\u306a\u30dd\u30a4\u30f3\u30c8\u3060\u3068\u601d\u3046\u3002 \n\n### vulcand \u306e\u4ed5\u7d44\u307f\n\n![](https://coreos.com/assets/images/media/vulcan-diagram.png)\n\nvulcand \u306b \u4ee5\u4e0b\u306e 2 \u3064\u306e\u4e3b\u8981\u306a\u6982\u5ff5\u304c\u3042\u308b\u3002\n\n* locations\n* upstreams\n\n#### Location \nLocation \u306f\u30db\u30b9\u30c8\u540d\u3068\u30ea\u30af\u30a8\u30b9\u30c8\u30d1\u30b9\u306e\u7d44\u307f\u5408\u308f\u305b\u304b\u3089\u306a\u308a\u3001\u540d\u524d\u3092\u6301\u3064\u3002\u30ea\u30af\u30a8\u30b9\u30c8\u3055\u308c\u305f URL \u306b\u5bfe\u3057\u3066\u6b63\u898f\u8868\u73fe\u30de\u30c3\u30c1\u304c\u884c\u308f\u308c\u308b\u3002\n\n\u4f8b\n\n* `search` \u3068\u3044\u3046\u540d\u524d\u306e location \u3067 `example.com` \u3092 host \u3068\u3057\u3066 `/search` \u3092\u6b63\u898f\u8868\u73fe\u30de\u30c3\u30c1\u30e3\u3068\u3057\u3066\u4f7f\u3046 \n* `user` \u3068\u3044\u3046\u540d\u524d\u306e location \u3067 `example.com` \u3092 host \u3068\u3057\u3066 `/^users.*$/` \u3092\u6b63\u898f\u8868\u73fe\u30de\u30c3\u30c1\u30e3\u3068\u3057\u3066\u4f7f\u3046\n\n\n\u305d\u3057\u3066 Location \u306f\u5f8c\u8ff0\u3059\u308b upstream \u3092\u6301\u3061\u3001\u6b63\u898f\u8868\u73fe\u30de\u30c3\u30c1\u3057\u305f\u30ea\u30af\u30a8\u30b9\u30c8\u3092upstreams \u3078\u30d7\u30ed\u30ad\u30b7\u3059\u308b\u3002\n\n#### Upstream\nUpstream \u306f\u5f8c\u8ff0\u3059\u308b endpoint \u306e\u96c6\u5408\u3067\u3042\u308a\u3001\u540d\u524d\u3092\u6301\u3064\u3002\n\n\u4f8b\n\n* `search-backend` \u3068\u3044\u3046\u540d\u524d\u306e upstream \u3067 endpoint \u306f `http://10.10.1.2:8080` \u3068 `http://10.10.1.3:8080` \n\n#### Endpoint\nEndpoint \u306f\u6700\u7d42\u7684\u306b\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u51e6\u7406\u3059\u308b\u3068\u3053\u308d\u3002 `<schema>://<host>:<port>` \u5f62\u5f0f\u3067\u5b9a\u7fa9\u3059\u308b\n\n\u4f8b\n\n* `http://localhost:5000`\n\n## Vulcand \u3092\u4f7f\u3063\u3066 Docker \u30b3\u30f3\u30c6\u30ca\u306e\u30d6\u30eb\u30fc\u30b0\u30ea\u30fc\u30f3\u30c7\u30d7\u30ed\u30a4\nVagrant \u3067\u8d77\u52d5\u3057\u305f CoreOS \u30de\u30b7\u30f3\u4e0a\u306e vulcand \u306b OS X \u304b\u3089\u63a5\u7d9a\u3057\u3066\u30d6\u30eb\u30fc\u30b0\u30ea\u30fc\u30f3\u30c7\u30d7\u30ed\u30a4\u3092\u8a66\u3059\u3002\n\n\u30a4\u30e1\u30fc\u30b8\u56f3:\n\n![](https://coreos.com/assets/images/media/vulcan-2-upstreams.png)\n\n\u4f8b\u3068\u3057\u3066\u3001`example` \u3068\u3044\u3046\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u304c\u3042\u308b\u3068\u3057\u3066\u3001v1 \u304b\u3089 v2 \u3078\u306e\u5207\u308a\u66ff\u3048\u3092\u3059\u308b\u30c7\u30d7\u30ed\u30a4\u3092\u3059\u308b\u3002\n\n### OS X \u5074\u306e hosts \u3092\u8a2d\u5b9a\u3057\u3066\u304a\u304f\n\n```bash\n# on CoreOS\ncore@core-01 ~ $ cat /etc/environment\nCOREOS_PUBLIC_IPV4=172.17.8.101\nCOREOS_PRIVATE_IPV4=172.17.8.101\n```\n\n```\n# on OS X\n$ sudo vi /etc/hosts\n```\n\n```\n##\n# Host Database\n#\n# localhost is used to configure the loopback interface\n# when the system is booting.  Do not change this entry.\n##\n127.0.0.1       localhost\n255.255.255.255 broadcasthost\n::1             localhost\n\n172.17.8.101    example.com # \u8ffd\u52a0\n```\n\n### \u30b5\u30fc\u30d3\u30b9\u30b3\u30f3\u30c6\u30ca v1 \u306e\u8d77\u52d5\nexample \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b3\u30f3\u30c6\u30ca\u306e v1 \u30922 \u53f0\u8d77\u52d5\u3059\u308b\n\n```bash\n# on CoreOS\ncore@core-01 ~ $ docker run -d --name example-v1.1 -p 8086:80 coreos/example:1.0.0\n0940df1b68a823e68d165196a7fde12922b6c57ff6b4ad95441a2fa9fd64a95b\n\ncore@core-01 ~ $ docker run -d --name example-v1.2 -p 8087:80 coreos/example:1.0.0\ne35ed7de9766ae67e14bc05f95e5c1a207d74b03e3dd4f350b99192c4ff51845\n```\n\n### Upstream `example-v1` \u306e\u8a2d\u5b9a\n\u7d9a\u3044\u3066\u3001`example-v1.1`, `exaple-v1.2` \u3092 endpoint \u3068\u3059\u308b `example` \u3068\u3044\u3046 upstream \u3092\u30bb\u30c3\u30c8\u3059\u308b\u3002\n\n```bash\n# on CoreOS\ncore@core-01 ~ $ etcdctl set /vulcand/upstreams/example-v1/endpoints/1 http://172.17.8.101:8086\nhttp://172.17.8.101:8086\n\ncore@core-01 ~ $ etcdctl set /vulcand/upstreams/example-v1/endpoints/2 http://172.17.8.101:8087\nhttp://172.17.8.101:8087\n```\n\n### Location \u306e\u8a2d\u5b9a\n`home` \u3068\u3044\u3046\u540d\u524d\u306e location \u3092\u4f5c\u6210\u3059\u308b\u3002\u6b63\u898f\u8868\u73fe\u30de\u30c3\u30c1\u30e3\u306f `/.*` \u3064\u307e\u308a\u5168\u3066\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u30de\u30c3\u30c1\u3055\u305b\u308b\u3002\n\n```bash\n# on CoreoS\ncore@core-01 ~ $ etcdctl set \"/vulcand/hosts/example.com/locations/home/path\" '/.*'\n/.*\n```\n\n\u305d\u3057\u3066 `home` location \u3092 `example-v1` upstream \u306b\u30d7\u30ed\u30ad\u30b7\u3055\u305b\u308b\u3088\u3046\u30bb\u30c3\u30c8\u3059\u308b\n\n```bash\n# on CoreOS\ncore@core-01 ~ $ etcdctl set /vulcand/hosts/example.com/locations/home/upstream example-v1\nexample-v1\n```\n\n### vulcand \u30b3\u30f3\u30c6\u30ca\u306e\u8d77\u52d5\n\n```bash\n# on CoreOS\ncore@core-01 ~ $ docker run \\\n  --rm \\\n  --name vulcan \\\n  -p 80:80 \\\n  -p 8182:8182 \\\n  mailgun/vulcand \\\n  /opt/vulcan/vulcand \\\n  -apiInterface=\"0.0.0.0\" \\\n  -interface=\"0.0.0.0\" \\\n  -etcd=\"http://172.17.8.101:4001\" \\\n  -port=80 \\\n  -apiPort=8182\n```\n\n### \u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u308b\n`http://example.com` \u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u308b\u3002example \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e v1 \u304c\u898b\u308c\u305f :)\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2014-11-05 16.32.09.png](https://qiita-image-store.s3.amazonaws.com/0/20833/748442aa-bdcc-7475-3f14-e0d4dd603416.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2014-11-05 16.32.09.png\")\n\n### \u30b5\u30fc\u30d3\u30b9\u30b3\u30f3\u30c6\u30ca v2 \u306e\u8d77\u52d5\n\n```bash\n# on CoreOS\ncore@core-01 ~ $ docker run -d --name example-v2.1 -p 8088:80 coreos/example:2.0.0\n8aa0f8cd402fa8be29b96f37bc97a2899bb32510cc3a8899d1338d0f8c8e1040\n\ncore@core-01 ~ $ docker run -d --name example-v2.2 -p 8089:80 coreos/example:2.0.0\n8db14040b1207ec42a5c08236bd4c7214323db36058d47e77606256231b6f5e8\n```\n\n### upstream `example-v2` \u306e\u8a2d\u5b9a\n\n```bash\n# on CoreOS\ncore@core-01 ~ $ etcdctl set /vulcand/upstreams/example-v2/endpoints/1 http://172.17.8.101:8088\nhttp://172.17.8.101:8088\n\ncore@core-01 ~ $ etcdctl set /vulcand/upstreams/example-v2/endpoints/2 http://172.17.8.101:8089\nhttp://172.17.8.101:8089\n```\n\n### v1 \u304b\u3089 v2 \u306b\u5207\u308a\u66ff\u3048\n\n```bash\n# on CoreOS\ncore@core-01 ~ $ etcdctl set /vulcand/hosts/example.com/locations/home/upstream example-v2\n```\n\n### \u518d\u5ea6\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u308b\nexample \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e v2 \u306b\u306a\u3063\u3066\u308b :)\n\u30bc\u30ed\u30c0\u30a6\u30f3\u30bf\u30a4\u30e0\u30d6\u30eb\u30fc\u30b0\u30ea\u30fc\u30f3\u30c7\u30d7\u30ed\u30a4\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2014-11-05 16.48.26.png](https://qiita-image-store.s3.amazonaws.com/0/20833/32a7a52a-a197-1a4b-9e25-f5834a930674.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2014-11-05 16.48.26.png\")\n\n\u3053\u3053\u3067\u307e\u305f\n\n```\n# on CoreOS\ncore@core-01 ~ $ etcdctl set /vulcand/hosts/example.com/locations/home/upstream example-v1\n```\n\n\u3068\u3059\u308c\u3070 v1 \u306e\u30b3\u30f3\u30c6\u30ca\u306b\u30d7\u30ed\u30ad\u30b7\u3055\u308c\u3066\u30ed\u30fc\u30eb\u30d0\u30c3\u30af\u304c\u3067\u304d\u308b\u3002\n\n### \u30ed\u30fc\u30ea\u30f3\u30b0\u30c7\u30d7\u30ed\u30a4\n![](https://coreos.com/assets/images/media/vulcan-1-upstream.png)\n\n\u4e0a\u8a18\u306e\u4f8b\u3060\u3068\u3001`home` location \u3078\u7d10\u3065\u3051\u308b `upstream` \u3092 `example-v1` \u304b\u3089 `example-v2` \u306b\u5207\u308a\u66ff\u3048\u3066\u30c7\u30d7\u30ed\u30a4\u3092\u884c\u3063\u305f\u304c\u3001`upstream` \u3092\u56fa\u5b9a\u3057\u3066\u3001endpoint \u3092\u8ffd\u52a0\u30fb\u524a\u9664\u3059\u308b\u3053\u3068\u3067\u30ed\u30fc\u30ea\u30f3\u30b0\u30c7\u30d7\u30ed\u30a4\u3082\u53ef\u80fd\u3002\n\n## TODO: registrator \u3092\u4f7f\u3063\u3066 upstream \u306e\u81ea\u52d5\u767b\u9332\u3092\u3059\u308b\nregistrator \u307e\u305f\u306f docker-plugin \u3092\u4f7f\u3063\u3066\u3001\u30b3\u30f3\u30c6\u30ca\u306e `start` hook \u6642\u306b etcd \u306b\u8d77\u52d5 IP \u3068 Port \u3092\u767b\u9332\u3059\u308b\n\n## \u30e1\u30e2\u3068\u611f\u60f3\n### HA \u69cb\u6210\u3067\u304d\u308b\netcd \u304b\u3089\u8a2d\u5b9a\u3092\u8aad\u3080\u306e\u3067\u3001HA \u69cb\u6210\u304c\u5b9f\u73fe\u3067\u304d\u305d\u3046\u3002\u4f8b\u3048\u3070 AWS \u3067 3 \u53f0\u304b\u3089\u306a\u308b CoreOS \u30af\u30e9\u30b9\u30bf\u304c\u3042\u308b\u3068\u304d\u3001\u5168\u53f0\u3067 vulcand \u3092\u8d77\u52d5\u3057\u3066\u304a\u304d\u3001vulcand \u306e\u524d\u6bb5\u306b ELB \u3092\u7f6e\u304f\u4e8b\u3067\u3001\n\n* Docker \u30db\u30b9\u30c8\u30ec\u30d9\u30eb\uff08\uff1dEC2 \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\uff09\u306e\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b9\u3092 ELB \u306b\n* Docker \u30b3\u30f3\u30c6\u30ca\u30ec\u30d9\u30eb\u306e\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b9\u3092 vulcan \u306b\n\n\u3084\u3089\u305b\u308b\u3053\u3068\u3067\u5272\u3068\u30b7\u30f3\u30d7\u30eb\u306a\u69cb\u6210\u306b\u3067\u304d\u305d\u3046\u3002\n\n```bash\n# requests:\n#  - www.example.com\n#  - admin.example.com\n#  - search.example.com\n\n\n                     vulcan.1 on coreos.1 \n                   /                        --> upstream `search`\n                  /                       /\nrequest --> ELB ---  vulcan.2 on coreos.2  ---> upstream `admin`\n                 \\                        \\ \n                   \\                        --> upstream `www`\n                     vulcan.3 on coreos.3\n\n```\n\n### Nginx \u3068\u6bd4\u3079\u3066\n\n* \u30b3\u30f3\u30c6\u30ca\u3068\u3057\u3066\u52d5\u304b\u3059\u306e\u306b\u5411\u3044\u3066\u3044\u308b\n* \u30d7\u30ed\u30ad\u30b7\u3068\u3057\u3066\u306e\u6a5f\u80fd\u306f nginx \u3068\u6bd4\u3079\u308b\u3068\u4e4f\u3057\u3044\uff1f\n\n#### \u30b3\u30f3\u30c6\u30ca\u3068\u3057\u3066\u52d5\u304b\u3059\u3053\u3068\u306b\u3064\u3044\u3066\nnginx \u304c\u30b3\u30f3\u30c6\u30ca\u3068\u3057\u3066\u52d5\u304b\u305d\u3046\u3068\u601d\u3046\u3068\u5f8c\u304b\u3089\u8a2d\u5b9a\u3092\u30c0\u30a4\u30ca\u30df\u30c3\u30af\u306b\u306f\u5909\u66f4\u3057\u3065\u3089\u3044\u3002\u306a\u306e\u3067\u3001Docker \u30db\u30b9\u30c8\u5074\u306b Nginx \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3053\u3068\u306b\u306a\u308b\u3002\u306a\u308b\u3060\u3051\u5168\u3066\u3092\u30b3\u30f3\u30c6\u30ca\u3067\u3084\u308a\u305f\u3044\u3068\u601d\u3046\u3068\u3053\u308c\u306f\u5fae\u5999\u3002\n\n\u9811\u5f35\u3063\u3066\u30b3\u30f3\u30c6\u30ca\u3067\u3084\u308d\u3046\u3068\u3059\u308b\u306a\u3089\n\n* \u30b3\u30f3\u30c6\u30ca\u3092 Nginx \u3068\u3057\u3066\u52d5\u304b\u3059\u304c\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092 -v \u3067\u30db\u30b9\u30c8\u3068\u5171\u6709\u3057\u3066 docker exec \u3067 nginx \u3092 reload \n* \u30b3\u30f3\u30c6\u30ca\u3092 Nginx \u3068\u3057\u3066\u52d5\u304b\u3059\u304c\u3001\u8a2d\u5b9a\u5909\u66f4\u6642\u306f\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u306b\u74b0\u5883\u5909\u6570\u3084\u5f15\u6570\u3092\u6e21\u3057\u3066\u52d5\u7684\u306b\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u4f5c\u3063\u3066\u30b3\u30f3\u30c6\u30ca\u518d\u8d77\u52d5\n\n\u3068\u3044\u3063\u305f\u611f\u3058\u3067\u3067\u304d\u306a\u304f\u3082\u306a\u3044\u3068\u601d\u3046\u304c\u3001\u3068\u3066\u3082\u8907\u96d1\uff08\u4ed6\u306b\u3082\u3084\u308a\u65b9\u306f\u3042\u308b\u3068\u601d\u3046\uff09\n\n#### TODO: \u30d7\u30ed\u30ad\u30b7\u3068\u3057\u3066\u306e\u6a5f\u80fd\u306b\u3064\u3044\u3066\n\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u307e\u3060\u5168\u90e8\u8aad\u3081\u3066\u306a\u3044\u3002[deis \u306f\u300c\u8272\u3005\u8db3\u308a\u3066\u306a\u3044\u304b\u3089\u307e\u3060 Nginx \u4f7f\u3046\u3088\u300d](https://github.com/deis/deis/issues/1829#issuecomment-55607828) \u3063\u3066\u8a00\u3063\u3066\u308b\u3002\n\n## REF\n\n* [mailgun/vulcand - GitHub](https://github.com/mailgun/vulcand)\n* [mailgun/vulcand - DockerHub](https://registry.hub.docker.com/u/mailgun/vulcand/)\n* [vulcan Documentation](https://www.vulcanproxy.com/)\n* [Zero Downtime Frontend Deploys with Vulcand on CoreOS](https://coreos.com/blog/zero-downtime-frontend-deploys-vulcand/)\n* [Golang Reverse Proxy - r7km/s](http://r7kamura.github.io/2014/07/20/golang-reverse-proxy.html)\n"}