{"tags": ["PHP", "MySQL", "RSS"], "context": " More than 1 year has passed since last update.\u6614\uff08\u591a\u5206\u4eca\u3082\u3042\u308b\u3051\u3069\uff09mixi\u306b\u300cmixi\u30cb\u30e5\u30fc\u30b9\u300d\u3068\u3044\u3046\u30b3\u30f3\u30c6\u30f3\u30c4\u3042\u308a\u307e\u3057\u305f\u3002\u3053\u308c\u306f\u5358\u306b\u30cb\u30e5\u30fc\u30b9\u3092\u898b\u308c\u308b\u3060\u3051\u3067\u306f\u306a\u304f\u3001\u305d\u306e\u30cb\u30e5\u30fc\u30b9\u306b\u3064\u3044\u3066\u30b3\u30e1\u30f3\u30c8\u7684\u306b\u65e5\u8a18\u3092\u66f8\u304f\u3053\u3068\u304c\u3067\u304d\u308b\u30b3\u30f3\u30c6\u30f3\u30c4\u3067\u3001\u81ea\u5206\u306f\u4e00\u6642\u671f\u3053\u308c\u306b\u3081\u3063\u3061\u3083\u30cf\u30de\u3063\u3066\u307e\u3057\u305f\u3002\n\u3067\u3059\u304c\u3054\u5b58\u77e5\u306e\u901a\u308a\u3001\u8db3\u3042\u3068\u6a5f\u80fd\u306e\u5ec3\u6b62\u306b\u3088\u308a\u300c\u8db3\u3042\u3068\u300d\u3068\u8a00\u3046\u540d\u306e\u30a2\u30af\u30bb\u30b9\u30ab\u30a6\u30f3\u30bf\u6a5f\u80fd\u304c\u6d88\u3048\u5931\u305b\u3001\u7d50\u679c\u5927\u5e45\u306b\u30e2\u30c1\u30d9\u30fc\u30b7\u30e7\u30f3\u304c\u4f4e\u4e0b\u3057\u3066\u3064\u3044\u306b\u66f8\u304b\u306a\u304f\u306a\u308a\u307e\u3057\u305f\u3002\n\u3068\u306f\u3044\u3048\u4eba\u9593\u4e00\u5ea6\u5473\u3092\u3057\u3081\u308b\u3068\u306a\u304b\u306a\u304b\u8131\u5374\u3067\u304d\u306a\u3044\u3082\u306e\u3067\u3001\u4f55\u304b\u3069\u3046\u306b\u304b\u3057\u3066\u3084\u308c\u306a\u3044\u304b\u306a\u3042\u3068\u8003\u3048\u305f\u3068\u3053\u308d\n\u300c\u305d\u3046\u3060\u30cb\u30e5\u30fc\u30b9\u306eRSS\u3092\u89e3\u6790\u3057\u3066\u81ea\u524d\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u84c4\u7a4d\u3057\u3068\u3051\u3070\u3044\u3044\u3093\u3060\u300d\n\u300c\u78ba\u304b\u30a2\u30ec\u3063\u3066\u5143\u8a18\u4e8b\u306eURL\u3082\u3042\u308b\u3057\u898b\u51fa\u3057\u898b\u3066\u6c17\u306b\u5165\u3063\u305f\u30cb\u30e5\u30fc\u30b9\u3092\u898b\u3066\u66f8\u3051\u3070\u3044\u3044\u3093\u3060\u300d\n\u300c\u3064\u3044\u3067\u306bmixi\u307f\u305f\u304f\u898b\u51fa\u3057\u3084URL\u3092\u300e\u5f15\u7528\u300f\uff08\u3053\u308c\u5927\u4e8b\uff09\u3068\u304b\u306b\u3057\u3068\u3051\u3070\u4f3c\u305f\u611f\u3058\u306b\u306a\u308b\u305e\u300d\n\u3068\u3044\u3046\u7d50\u8ad6\u306b\u81f3\u308a\u3053\u308c\u3092\u5b9f\u88c5\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n\u5b9f\u88c5\u306b\u5fc5\u8981\u306a\u3082\u306e\n\u30fb\u30ec\u30f3\u30bf\u30eb\u30b5\u30fc\u30d0\u30fc\n\u30fbphp\n\u30fbmysql\n\n\u30c6\u30fc\u30d6\u30eb\u5b9a\u7fa9\n\u30c6\u30fc\u30d6\u30eb\u305d\u306e\uff11\u3001rss\u30c7\u30fc\u30bf\u3092\u3092\u914d\u4fe1\u3057\u3066\u308b\u30b5\u30a4\u30c8\u3092\u7ba1\u7406\u3059\u308b\u30c6\u30fc\u30d6\u30ebCREATE TABLE rssmaster (\n  id int(10) NOT NULL AUTO_INCREMENT ,\n  name varchar(255) DEFAULT NULL,\n  url varchar(255) DEFAULT NULL,\n  dispname varchar(255) DEFAULT NULL,\n  rdf varchar(255) DEFAULT NULL,\n  status int(1) DEFAULT 1,\n  version varchar(10) DEFAULT NULL,\n  created timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n  updated timestamp NOT NULL DEFAULT '0000-00-00 00:00:00',\n  PRIMARY KEY (id)\n) ENGINE=MyISAM AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;\n\n\u30b5\u30f3\u30d7\u30eb\u30c7\u30fc\u30bf\u3002INSERT INTO rssmaster (id, name, url, dispname, rdf, status, version, itemlimit, created, modified) VALUES (1,'\u30de\u30a4\u30ca\u30d3\u30cb\u30e5\u30fc\u30b9 - \u305d\u306e\u5148\u3092\u4f1d\u3048\u308b\u7dcf\u5408\u60c5\u5831\u30b5\u30a4\u30c8','http://news.mynavi.jp/','MYCOM\u30b8\u30e3\u30fc\u30ca\u30eb','http://rss.rssad.jp/rss/mycom/index',1,'1.0',0,'2013-09-04 12:20:17','2013-09-04 12:20:17');\nINSERT INTO rssmaster (id, name, url, dispname, rdf, status, version, itemlimit, created, modified) VALUES (2,'\u30de\u30a4\u30ca\u30d3\u30a6\u30fc\u30de\u30f3 | \u30a8\u30ad\u30b5\u30a4\u30c8\u30cb\u30e5\u30fc\u30b9','http://www.excite.co.jp/News/source/Escala/','\u30de\u30a4\u30ca\u30d3\u30a6\u30fc\u30de\u30f3\u6700\u65b0\u914d\u4fe1\u8a18\u4e8b | \u30a8\u30ad\u30b5\u30a4\u30c8\u30cb\u30e5\u30fc\u30b9','http://www.excite.co.jp/News/rss/source/?source=Escala',1,'1.0',0,'0000-00-00 00:00:00','0000-00-00 00:00:00');\nINSERT INTO rssmaster (id, name, url, dispname, rdf, status, version, itemlimit, created, modified) VALUES (3,'\u30e1\u30f3\u30ba\u30b5\u30a4\u30be\u30fc | \u30a8\u30ad\u30b5\u30a4\u30c8\u30cb\u30e5\u30fc\u30b9','http://www.excite.co.jp/News/source/Menscyzo/','\u30e1\u30f3\u30ba\u30b5\u30a4\u30be\u30fc\u6700\u65b0\u914d\u4fe1\u8a18\u4e8b | \u30a8\u30ad\u30b5\u30a4\u30c8\u30cb\u30e5\u30fc\u30b9','http://www.excite.co.jp/News/rss/source/?source=Menscyzo',1,'1.0',0,'0000-00-00 00:00:00','0000-00-00 00:00:00');\nINSERT INTO rssmaster (id, name, url, dispname, rdf, status, version, itemlimit, created, modified) VALUES (4,'\u30b5\u30a4\u30be\u30fc\u30a6\u30fc\u30de\u30f3 | \u30a8\u30ad\u30b5\u30a4\u30c8\u30cb\u30e5\u30fc\u30b9','http://www.excite.co.jp/News/source/Cyzowoman/','\u30b5\u30a4\u30be\u30fc\u30a6\u30fc\u30de\u30f3\u6700\u65b0\u914d\u4fe1\u8a18\u4e8b | \u30a8\u30ad\u30b5\u30a4\u30c8\u30cb\u30e5\u30fc\u30b9','http://www.excite.co.jp/News/rss/source/?source=Cyzowoman',1,'1.0',0,'0000-00-00 00:00:00','0000-00-00 00:00:00');\nINSERT INTO rssmaster (id, name, url, dispname, rdf, status, version, itemlimit, created, modified) VALUES (5,'\u671d\u65e5\u65b0\u805e\u30c7\u30b8\u30bf\u30eb\uff1a\u671d\u65e5\u65b0\u805e\u793e\u306e\u30cb\u30e5\u30fc\u30b9\u30b5\u30a4\u30c8','http://www.asahi.com/','\u671d\u65e5\u65b0\u805e\u30c7\u30b8\u30bf\u30eb\u901f\u5831\u30cb\u30e5\u30fc\u30b9','http://rss.asahi.com/rss/asahi/newsheadlines.rdf',0,'1.0',0,'2013-09-14 22:07:09','2013-09-14 22:07:09');\nINSERT INTO rssmaster (id, name, url, dispname, rdf, status, version, itemlimit, created, modified) VALUES (6,'\u65b0\u7740\u30cb\u30e5\u30fc\u30b9 : YOMIURI ONLINE\uff08\u8aad\u58f2\u65b0\u805e\uff09','http://www.yomiuri.co.jp/latestnews/','YOMIURI ONLINE \u65b0\u7740\u30cb\u30e5\u30fc\u30b9','http://rss.yomiuri.co.jp/rss/yol/latestnews30',1,'2.0',0,'2013-09-14 22:09:01','2013-09-14 22:09:01');\n\u5b9f\u969b\u306b\u306f\u3053\u3053\u307f\u3066\u624b\u52d5\u3067\u53d6\u308a\u8fbc\u3093\u3067\u305f\u3002\n\n\u30c6\u30fc\u30d6\u30eb\u305d\u306e\uff12\u3001\u8a18\u4e8b\u30c7\u30fc\u30bf\u3092\u7ba1\u7406\u3059\u308b\u30c6\u30fc\u30d6\u30ebCREATE TABLE rssdata (\n  itemkey varchar(32) NOT NULL,\n  id int(10) NOT NULL,\n  sitetitle text,\n  sitedescription text,\n  sitelink text,\n  itemtitle text,\n  itemdescription_body text,\n  itemdescription_plane text,\n  itemdescription_image text,\n  itemdescription_title text,\n  itemdescription_comment text,\n  to varchar(255) DEFAULT NULL,\n  itemlink text,\n  status int(1) DEFAULT '1',\n  version varchar(10) DEFAULT NULL,\n  created timestamp NOT NULL DEFAULT '0000-00-00 00:00:00' ,\n  modified timestamp NOT NULL DEFAULT '0000-00-00 00:00:00',\n  PRIMARY KEY (itemkey),\n  KEY id (id)\n) ENGINE=MyISAM DEFAULT CHARSET=utf8;\n\n\nRSS\u30c7\u30fc\u30bf\u3092\u3068\u3063\u3066\u304f\u308b\u30d7\u30ed\u30b0\u30e9\u30e0(parserdf.php)\n<?php\n//include(\"feedcreator.class.php\");\nmb_internal_encoding(\"utf-8\");  // \u5185\u90e8\u30a8\u30f3\u30b3\u30fc\u30c9\u6307\u5b9a@\u6587\u5b57\u5316\u3051\u5bfe\u7b56\n$newslimit = 1; // \u30b5\u30a4\u30c8\u3054\u3068\u306e\u4ef6\u6570\u306frssmaster\u306b\u3082\u305f\u305b\u305f\n$newscount = 0; \n$dbHost=\"127.0.0.1\";\n$dbUser=\"mysql\";\n$dbPass=\"password\";\n$db_select = mysql_connect($dbHost, $dbUser, $dbPass);\nmysql_set_charset(\"utf8\",$db_select);   // DB\u30a8\u30f3\u30b3\u30fc\u30c9\u6307\u5b9a@\u6587\u5b57\u5316\u3051\u5bfe\u7b56\n$db_selected = mysql_select_db('rssbbs', $db_select);\n\n$timestamp = date(\"YmdHis\");\nSystem(\"mysqldump -u root rssbbs rssdata --password=password  > rssdata.$timestamp.txt\");\nmysql_query(\"DELETE FROM rssdata WHERE ( status = 0 AND ( itemdescription_comment IS NULL OR itemdescription_comment = '' ))\nOR modified < date_add(current_timestamp, interval -7 day) \");\n\n$ret = mysql_query(\"SELECT * FROM rssmaster WHERE status = 1 ORDER BY id\");\nwhile ($array = mysql_fetch_array($ret)) \n{\n    $id = $array['id'];\n    $newslimit = $array['itemlimit'];\n    $version = $array['version'];\n    //$result = simplexml_load_file($array['rdf']);\n    // 2013.06.29 description\u4e2d\u306eCDATA\u3092\u30c6\u30ad\u30b9\u30c8\u3068\u3057\u3066\u53d6\u5f97\n    $result = simplexml_load_file($array['rdf'], 'SimpleXMLElement', LIBXML_NOCDATA);\n    // 2013.08.27 \u914d\u5217\u578b\u306b\u5909\u63db\n    $result = json_decode(json_encode($result), true);\n\n    $sitetitle = NULL;\n    $sitedescription = NULL;\n    $sitelink = NULL;\n\n    // sitetitle\n    if (array_key_exists('title', $result['channel']))\n    {\n        $sitetitle = $result['channel']['title'];\n    }\n    else\n    {\n        $sitetitle = $array['dispname'];\n    }\n\n    // sitedescription\n    if (array_key_exists('description', $result['channel']) && is_string($result['channel']['description']))\n    {\n        $sitedescription = $result['channel']['description'];\n    }\n    else\n    {\n        $sitedescription = $array['name'];\n    }\n\n    // sitelink\n    if (array_key_exists('link', $result['channel'])) \n    {\n        $sitelink = urlcheck((string)$result['channel']['link'], $array['url']);\n    }\n    else\n    {\n        $sitelink = $array['url'];\n    }\n\n    $isitems=false;\n    $items=array();\n\n    // RSS Version1.0\n    if ($version === '1.0')\n    {\n        if (array_key_exists('item', $result))\n        {\n            $isitems=true;\n            $items=$result['item'];\n        }\n    }\n    // RSS Version2.0\n    elseif($version === '2.0')\n    {\n        if (array_key_exists('item', $result['channel']))\n        {\n            $isitems=true;\n            $items=$result['channel']['item'];\n        }\n    }\n    if ($isitems){\n        $newscount = 0;\n        foreach($items as $item)\n        {\n\n            // newslimit=0\u306f\u5168\u4ef6\n            if ($newslimit != 0){\n                if ($newscount >= $newslimit) break;\n                $newscount++;\n            }\n\n            $itemtitle = NULL;\n            $itemlink = NULL;\n            $itemkey = NULL;\n            $itemdescription_source = NULL;\n            $itemdescription_image = NULL;\n            $itemdescription_plane = NULL;\n            $itemdescription_body = NULL;\n\n            $itemtitle = (array_key_exists('title', $item)) ? $item['title'] : \"\";\n            if (! is_string($itemtitle))\n            {\n                continue;\n            }\n            if (substr($itemtitle,0,2) === 'PR' || substr($itemtitle,0,2) == 'AD' || substr($itemtitle,1,2) == 'PR') \n            {\n                continue;\n            }\n\n            $itemlink = (array_key_exists('link', $item)) ? $item['link'] : \"\";\n            $itemkey = md5($itemlink);  // \u8a18\u4e8b\u5358\u4f4d\u306ekey\u751f\u6210\n            $itemdescription_source = (array_key_exists('description', $item)) ? $item['description'] : \"\";\n            if (is_string($itemdescription_source)){\n                $itemdescription_image = getimage($itemdescription_source);\n                $itemdescription_plane = strip_tags($itemdescription_source);\n                $itemdescription_plane = str_replace(array(\"\\r\\n\",\"\\r\",\"\\n\"), '', $itemdescription_plane);\n\n                $itemdescription_body = str_replace(\"'\",\"\\\"\",$itemdescription_source);\n                $itemdescription_body = str_replace(\"<p>\", \"\", $itemdescription_body);\n                $itemdescription_body = str_replace(\"</p>\", \"\", $itemdescription_body);\n                $itemdescription_body = str_replace(array(\"\\r\\n\",\"\\r\",\"\\n\"), '', $itemdescription_body);\n            }\n\n            $check_sql = \"SELECT itemkey FROM rssdata WHERE itemkey = '$itemkey'\";\n            $check_ret = mysql_query($check_sql);\n            $check_array = mysql_fetch_array($check_ret);\n            if(empty($check_array) || $check_array[0]['itemkey'] === '')\n            {\n\n                $replace_sql = \"INSERT INTO rssdata \n                    (\n                        id,\n                        sitetitle,\n                        sitedescription,\n                        sitelink,\n                        itemkey,\n                        itemtitle,\n                        itemdescription_body,\n                        itemdescription_plane,\n                        itemdescription_image,\n                        itemlink,\n                        status,\n                        version\n                    )\n                    VALUES \n                    (\n                        $id,\n                        '$sitetitle',\n                        '$sitedescription',\n                        '$sitelink',\n                        '$itemkey',\n                        '$itemtitle',\n                        '$itemdescription_body',\n                        '$itemdescription_plane',\n                        '$itemdescription_image',\n                        '$itemlink',\n                        0,\n                        '$version'\n                    )\";\n                $replace_sql = str_replace(array(\"\\r\\n\",\"\\r\",\"\\n\", \"\\t\" ), '', $replace_sql);\n\n                mysql_query($replace_sql);\n\n                logging(array(\n                    'id' => $id,\n                    'sitetitle' => $sitetitle,\n                    'sitedescription' => $sitedescription,\n                    'sitelink' => $sitelink,\n                    'itemkey' => $itemkey,\n                    'itemtitle' => $itemtitle,\n                    'itemdescription_body' => $itemdescription_body,\n                    'itemdescription_plane' => $itemdescription_plane,\n                    'itemdescription_image' => $itemdescription_image,\n                    'itemlink' => $itemlink,\n                    'version' => $version));\n            }   \n        }\n    }\n}\nmysql_close($db_select);\n\n\n// ---------------------------------------------------------------\n//  functions\n// ---------------------------------------------------------------\n\n// url1\u306e\u5f62\u5f0f\u30c1\u30a7\u30c3\u30af\u30fb\u5b58\u5728\u30c1\u30a7\u30c3\u30af\u3092\u3059\u308b\u3002\u4e21\u65b9true\u306a\u3089url1\u3092\u3001false\u304c\u3042\u308c\u3070url2\u3092\u8fd4\u3059\nfunction urlcheck($url1,$url2)\n{\n    $returl = $url1;\n\n    // url\u5f62\u5f0f\u30c1\u30a7\u30c3\u30af\n    if (preg_match('/^(https?|ftp)(:\\/\\/[-_.!~*\\'()a-zA-Z0-9;\\/?:\\@&=+\\$,%#]+)$/', $url1))\n    {\n        // URL\u5b58\u5728\u30c1\u30a7\u30c3\u30af\n        if($fp = @fopen($url1, 'r'))\n        {\n            fclose($fp);\n        }\n        else\n        {\n            $returl = $url2;\n        }\n    }\n    else\n    {\n        $returl = $url2;\n    }\n    return $returl;\n}\n\n// img\u30bf\u30b0\u629c\u304d\u51fa\u3057\nfunction getimage($str)\n{\n    if (!is_string($str)) return;\n    if (preg_match('/(\\<img).*(gif|jpg|jpeg|png)(.*?>)/', $str, $match))\n    {\n        return str_replace(\"'\",\"\\\"\",$match[0]);\n    }\n    else\n    {\n        return \"\";\n    }\n}\n\nfunction logging($array)\n{\n    $log = NULL;\n    $log.= date(\"Y/m/d H:i:s\").\" : \";\n    $Ymd = date(\"Ymd\");\n    foreach($array as $key => $value)\n    {\n        if (is_numeric($key))\n        {\n            continue;\n        }\n        $log.= \"$key=$value,\";\n    }\n    $log = substr($log,0,-1);\n    $log.= \"\\n\";\n    $logfile = str_replace(\"php\",\"log\",$_SERVER['PHP_SELF']) ;\n    error_log($log,3,'/var/log/'.$logfile);\n}\n?>\n\n\n\u4f7f\u3044\u65b9\nmysql\u306b\u30c6\u30fc\u30d6\u30eb\u4f5c\u3063\u3066php\u306e\u30bd\u30fc\u30b9\u306bmysql\u306e\u30a2\u30af\u30bb\u30b9\u8a2d\u5b9a\u3057\u3066parserdf.php\u3092cli\u8d77\u52d5\u3059\u308c\u3070\u52d5\u304f\u306f\u305a\u3067\u3059\u3002\n\u3053\u308c\u3060\u3051\u3060\u3068\u898b\u308b\u65b9\u6cd5\u304c\u306a\u3044\u306e\u3067\u5b9f\u904b\u7528\u306b\u306fcakePHP\u306b\u3066WebUI\u3092\u5b9f\u88c5\u3057\u3066\u3044\u307e\u3059\u3002\n\u305d\u308c\u306f\u307e\u305f\u6b21\u56de\u306b\u3002\n\u6614\uff08\u591a\u5206\u4eca\u3082\u3042\u308b\u3051\u3069\uff09mixi\u306b\u300cmixi\u30cb\u30e5\u30fc\u30b9\u300d\u3068\u3044\u3046\u30b3\u30f3\u30c6\u30f3\u30c4\u3042\u308a\u307e\u3057\u305f\u3002\u3053\u308c\u306f\u5358\u306b\u30cb\u30e5\u30fc\u30b9\u3092\u898b\u308c\u308b\u3060\u3051\u3067\u306f\u306a\u304f\u3001\u305d\u306e\u30cb\u30e5\u30fc\u30b9\u306b\u3064\u3044\u3066\u30b3\u30e1\u30f3\u30c8\u7684\u306b\u65e5\u8a18\u3092\u66f8\u304f\u3053\u3068\u304c\u3067\u304d\u308b\u30b3\u30f3\u30c6\u30f3\u30c4\u3067\u3001\u81ea\u5206\u306f\u4e00\u6642\u671f\u3053\u308c\u306b\u3081\u3063\u3061\u3083\u30cf\u30de\u3063\u3066\u307e\u3057\u305f\u3002\n\n\u3067\u3059\u304c\u3054\u5b58\u77e5\u306e\u901a\u308a\u3001\u8db3\u3042\u3068\u6a5f\u80fd\u306e\u5ec3\u6b62\u306b\u3088\u308a\u300c\u8db3\u3042\u3068\u300d\u3068\u8a00\u3046\u540d\u306e\u30a2\u30af\u30bb\u30b9\u30ab\u30a6\u30f3\u30bf\u6a5f\u80fd\u304c\u6d88\u3048\u5931\u305b\u3001\u7d50\u679c\u5927\u5e45\u306b\u30e2\u30c1\u30d9\u30fc\u30b7\u30e7\u30f3\u304c\u4f4e\u4e0b\u3057\u3066\u3064\u3044\u306b\u66f8\u304b\u306a\u304f\u306a\u308a\u307e\u3057\u305f\u3002\n\n\u3068\u306f\u3044\u3048\u4eba\u9593\u4e00\u5ea6\u5473\u3092\u3057\u3081\u308b\u3068\u306a\u304b\u306a\u304b\u8131\u5374\u3067\u304d\u306a\u3044\u3082\u306e\u3067\u3001\u4f55\u304b\u3069\u3046\u306b\u304b\u3057\u3066\u3084\u308c\u306a\u3044\u304b\u306a\u3042\u3068\u8003\u3048\u305f\u3068\u3053\u308d\n\n\u300c\u305d\u3046\u3060\u30cb\u30e5\u30fc\u30b9\u306eRSS\u3092\u89e3\u6790\u3057\u3066\u81ea\u524d\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u84c4\u7a4d\u3057\u3068\u3051\u3070\u3044\u3044\u3093\u3060\u300d\n\u300c\u78ba\u304b\u30a2\u30ec\u3063\u3066\u5143\u8a18\u4e8b\u306eURL\u3082\u3042\u308b\u3057\u898b\u51fa\u3057\u898b\u3066\u6c17\u306b\u5165\u3063\u305f\u30cb\u30e5\u30fc\u30b9\u3092\u898b\u3066\u66f8\u3051\u3070\u3044\u3044\u3093\u3060\u300d\n\u300c\u3064\u3044\u3067\u306bmixi\u307f\u305f\u304f\u898b\u51fa\u3057\u3084URL\u3092\u300e\u5f15\u7528\u300f\uff08\u3053\u308c\u5927\u4e8b\uff09\u3068\u304b\u306b\u3057\u3068\u3051\u3070\u4f3c\u305f\u611f\u3058\u306b\u306a\u308b\u305e\u300d\n\n\u3068\u3044\u3046\u7d50\u8ad6\u306b\u81f3\u308a\u3053\u308c\u3092\u5b9f\u88c5\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n\n#\u5b9f\u88c5\u306b\u5fc5\u8981\u306a\u3082\u306e\n\u30fb\u30ec\u30f3\u30bf\u30eb\u30b5\u30fc\u30d0\u30fc\n\u30fbphp\n\u30fbmysql\n\n#\u30c6\u30fc\u30d6\u30eb\u5b9a\u7fa9\n\n\u30c6\u30fc\u30d6\u30eb\u305d\u306e\uff11\u3001rss\u30c7\u30fc\u30bf\u3092\u3092\u914d\u4fe1\u3057\u3066\u308b\u30b5\u30a4\u30c8\u3092\u7ba1\u7406\u3059\u308b\u30c6\u30fc\u30d6\u30eb<pre>\nCREATE TABLE rssmaster (\n  id int(10) NOT NULL AUTO_INCREMENT ,\n  name varchar(255) DEFAULT NULL,\n  url varchar(255) DEFAULT NULL,\n  dispname varchar(255) DEFAULT NULL,\n  rdf varchar(255) DEFAULT NULL,\n  status int(1) DEFAULT 1,\n  version varchar(10) DEFAULT NULL,\n  created timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n  updated timestamp NOT NULL DEFAULT '0000-00-00 00:00:00',\n  PRIMARY KEY (id)\n) ENGINE=MyISAM AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;\n</pre>\n\n\u30b5\u30f3\u30d7\u30eb\u30c7\u30fc\u30bf\u3002<pre>INSERT INTO `rssmaster` (`id`, `name`, `url`, `dispname`, `rdf`, `status`, `version`, `itemlimit`, `created`, `modified`) VALUES (1,'\u30de\u30a4\u30ca\u30d3\u30cb\u30e5\u30fc\u30b9 - \u305d\u306e\u5148\u3092\u4f1d\u3048\u308b\u7dcf\u5408\u60c5\u5831\u30b5\u30a4\u30c8','http://news.mynavi.jp/','MYCOM\u30b8\u30e3\u30fc\u30ca\u30eb','http://rss.rssad.jp/rss/mycom/index',1,'1.0',0,'2013-09-04 12:20:17','2013-09-04 12:20:17');\nINSERT INTO `rssmaster` (`id`, `name`, `url`, `dispname`, `rdf`, `status`, `version`, `itemlimit`, `created`, `modified`) VALUES (2,'\u30de\u30a4\u30ca\u30d3\u30a6\u30fc\u30de\u30f3 | \u30a8\u30ad\u30b5\u30a4\u30c8\u30cb\u30e5\u30fc\u30b9','http://www.excite.co.jp/News/source/Escala/','\u30de\u30a4\u30ca\u30d3\u30a6\u30fc\u30de\u30f3\u6700\u65b0\u914d\u4fe1\u8a18\u4e8b | \u30a8\u30ad\u30b5\u30a4\u30c8\u30cb\u30e5\u30fc\u30b9','http://www.excite.co.jp/News/rss/source/?source=Escala',1,'1.0',0,'0000-00-00 00:00:00','0000-00-00 00:00:00');\nINSERT INTO `rssmaster` (`id`, `name`, `url`, `dispname`, `rdf`, `status`, `version`, `itemlimit`, `created`, `modified`) VALUES (3,'\u30e1\u30f3\u30ba\u30b5\u30a4\u30be\u30fc | \u30a8\u30ad\u30b5\u30a4\u30c8\u30cb\u30e5\u30fc\u30b9','http://www.excite.co.jp/News/source/Menscyzo/','\u30e1\u30f3\u30ba\u30b5\u30a4\u30be\u30fc\u6700\u65b0\u914d\u4fe1\u8a18\u4e8b | \u30a8\u30ad\u30b5\u30a4\u30c8\u30cb\u30e5\u30fc\u30b9','http://www.excite.co.jp/News/rss/source/?source=Menscyzo',1,'1.0',0,'0000-00-00 00:00:00','0000-00-00 00:00:00');\nINSERT INTO `rssmaster` (`id`, `name`, `url`, `dispname`, `rdf`, `status`, `version`, `itemlimit`, `created`, `modified`) VALUES (4,'\u30b5\u30a4\u30be\u30fc\u30a6\u30fc\u30de\u30f3 | \u30a8\u30ad\u30b5\u30a4\u30c8\u30cb\u30e5\u30fc\u30b9','http://www.excite.co.jp/News/source/Cyzowoman/','\u30b5\u30a4\u30be\u30fc\u30a6\u30fc\u30de\u30f3\u6700\u65b0\u914d\u4fe1\u8a18\u4e8b | \u30a8\u30ad\u30b5\u30a4\u30c8\u30cb\u30e5\u30fc\u30b9','http://www.excite.co.jp/News/rss/source/?source=Cyzowoman',1,'1.0',0,'0000-00-00 00:00:00','0000-00-00 00:00:00');\nINSERT INTO `rssmaster` (`id`, `name`, `url`, `dispname`, `rdf`, `status`, `version`, `itemlimit`, `created`, `modified`) VALUES (5,'\u671d\u65e5\u65b0\u805e\u30c7\u30b8\u30bf\u30eb\uff1a\u671d\u65e5\u65b0\u805e\u793e\u306e\u30cb\u30e5\u30fc\u30b9\u30b5\u30a4\u30c8','http://www.asahi.com/','\u671d\u65e5\u65b0\u805e\u30c7\u30b8\u30bf\u30eb\u901f\u5831\u30cb\u30e5\u30fc\u30b9','http://rss.asahi.com/rss/asahi/newsheadlines.rdf',0,'1.0',0,'2013-09-14 22:07:09','2013-09-14 22:07:09');\nINSERT INTO `rssmaster` (`id`, `name`, `url`, `dispname`, `rdf`, `status`, `version`, `itemlimit`, `created`, `modified`) VALUES (6,'\u65b0\u7740\u30cb\u30e5\u30fc\u30b9 : YOMIURI ONLINE\uff08\u8aad\u58f2\u65b0\u805e\uff09','http://www.yomiuri.co.jp/latestnews/','YOMIURI ONLINE \u65b0\u7740\u30cb\u30e5\u30fc\u30b9','http://rss.yomiuri.co.jp/rss/yol/latestnews30',1,'2.0',0,'2013-09-14 22:09:01','2013-09-14 22:09:01');\n</pre>\u5b9f\u969b\u306b\u306f[\u3053\u3053](http://feeds.japan.cnet.com/rss/cnet/all.rdf)\u307f\u3066\u624b\u52d5\u3067\u53d6\u308a\u8fbc\u3093\u3067\u305f\u3002\n\n\u30c6\u30fc\u30d6\u30eb\u305d\u306e\uff12\u3001\u8a18\u4e8b\u30c7\u30fc\u30bf\u3092\u7ba1\u7406\u3059\u308b\u30c6\u30fc\u30d6\u30eb<pre>\nCREATE TABLE rssdata (\n  itemkey varchar(32) NOT NULL,\n  id int(10) NOT NULL,\n  sitetitle text,\n  sitedescription text,\n  sitelink text,\n  itemtitle text,\n  itemdescription_body text,\n  itemdescription_plane text,\n  itemdescription_image text,\n  itemdescription_title text,\n  itemdescription_comment text,\n  to varchar(255) DEFAULT NULL,\n  itemlink text,\n  status int(1) DEFAULT '1',\n  version varchar(10) DEFAULT NULL,\n  created timestamp NOT NULL DEFAULT '0000-00-00 00:00:00' ,\n  modified timestamp NOT NULL DEFAULT '0000-00-00 00:00:00',\n  PRIMARY KEY (itemkey),\n  KEY id (id)\n) ENGINE=MyISAM DEFAULT CHARSET=utf8;\n</pre>\n\n#RSS\u30c7\u30fc\u30bf\u3092\u3068\u3063\u3066\u304f\u308b\u30d7\u30ed\u30b0\u30e9\u30e0(parserdf.php)\n<pre>\n&lt;?php\n//include(\"feedcreator.class.php\");\nmb_internal_encoding(\"utf-8\");\t// \u5185\u90e8\u30a8\u30f3\u30b3\u30fc\u30c9\u6307\u5b9a@\u6587\u5b57\u5316\u3051\u5bfe\u7b56\n$newslimit = 1; // \u30b5\u30a4\u30c8\u3054\u3068\u306e\u4ef6\u6570\u306frssmaster\u306b\u3082\u305f\u305b\u305f\n$newscount = 0; \n$dbHost=\"127.0.0.1\";\n$dbUser=\"mysql\";\n$dbPass=\"password\";\n$db_select = mysql_connect($dbHost, $dbUser, $dbPass);\nmysql_set_charset(\"utf8\",$db_select);\t// DB\u30a8\u30f3\u30b3\u30fc\u30c9\u6307\u5b9a@\u6587\u5b57\u5316\u3051\u5bfe\u7b56\n$db_selected = mysql_select_db('rssbbs', $db_select);\n\n$timestamp = date(\"YmdHis\");\nSystem(\"mysqldump -u root rssbbs rssdata --password=password  &gt; rssdata.$timestamp.txt\");\nmysql_query(\"DELETE FROM rssdata WHERE ( status = 0 AND ( itemdescription_comment IS NULL OR itemdescription_comment = '' ))\nOR modified &lt; date_add(current_timestamp, interval -7 day) \");\n\n$ret = mysql_query(\"SELECT * FROM rssmaster WHERE status = 1 ORDER BY id\");\nwhile ($array = mysql_fetch_array($ret)) \n{\n\t$id = $array['id'];\n\t$newslimit = $array['itemlimit'];\n\t$version = $array['version'];\n\t//$result = simplexml_load_file($array['rdf']);\n\t// 2013.06.29 description\u4e2d\u306eCDATA\u3092\u30c6\u30ad\u30b9\u30c8\u3068\u3057\u3066\u53d6\u5f97\n\t$result = simplexml_load_file($array['rdf'], 'SimpleXMLElement', LIBXML_NOCDATA);\n\t// 2013.08.27 \u914d\u5217\u578b\u306b\u5909\u63db\n\t$result = json_decode(json_encode($result), true);\n\n\t$sitetitle = NULL;\n\t$sitedescription = NULL;\n\t$sitelink = NULL;\n\n\t// sitetitle\n\tif (array_key_exists('title', $result['channel']))\n\t{\n\t\t$sitetitle = $result['channel']['title'];\n\t}\n\telse\n\t{\n\t\t$sitetitle = $array['dispname'];\n\t}\n\n\t// sitedescription\n\tif (array_key_exists('description', $result['channel']) && is_string($result['channel']['description']))\n\t{\n\t\t$sitedescription = $result['channel']['description'];\n\t}\n\telse\n\t{\n\t\t$sitedescription = $array['name'];\n\t}\n\n\t// sitelink\n\tif (array_key_exists('link', $result['channel'])) \n\t{\n\t\t$sitelink = urlcheck((string)$result['channel']['link'], $array['url']);\n\t}\n\telse\n\t{\n\t\t$sitelink = $array['url'];\n\t}\n\n\t$isitems=false;\n\t$items=array();\n\n\t// RSS Version1.0\n\tif ($version === '1.0')\n\t{\n\t\tif (array_key_exists('item', $result))\n\t\t{\n\t\t\t$isitems=true;\n\t\t\t$items=$result['item'];\n\t\t}\n\t}\n\t// RSS Version2.0\n\telseif($version === '2.0')\n\t{\n\t\tif (array_key_exists('item', $result['channel']))\n\t\t{\n\t\t\t$isitems=true;\n\t\t\t$items=$result['channel']['item'];\n\t\t}\n\t}\n\tif ($isitems){\n\t\t$newscount = 0;\n\t\tforeach($items as $item)\n\t\t{\n\n\t\t\t// newslimit=0\u306f\u5168\u4ef6\n\t\t\tif ($newslimit != 0){\n\t\t\t\tif ($newscount &gt;= $newslimit) break;\n\t\t\t\t$newscount++;\n\t\t\t}\n\n\t\t\t$itemtitle = NULL;\n\t\t\t$itemlink = NULL;\n\t\t\t$itemkey = NULL;\n\t\t\t$itemdescription_source = NULL;\n\t\t\t$itemdescription_image = NULL;\n\t\t\t$itemdescription_plane = NULL;\n\t\t\t$itemdescription_body = NULL;\n\n\t\t\t$itemtitle = (array_key_exists('title', $item)) ? $item['title'] : \"\";\n\t\t\tif (! is_string($itemtitle))\n\t\t\t{\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (substr($itemtitle,0,2) === 'PR' || substr($itemtitle,0,2) == 'AD' || substr($itemtitle,1,2) == 'PR') \n\t\t\t{\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t$itemlink = (array_key_exists('link', $item)) ? $item['link'] : \"\";\n\t\t\t$itemkey = md5($itemlink);\t// \u8a18\u4e8b\u5358\u4f4d\u306ekey\u751f\u6210\n\t\t\t$itemdescription_source = (array_key_exists('description', $item)) ? $item['description'] : \"\";\n\t\t\tif (is_string($itemdescription_source)){\n\t\t\t\t$itemdescription_image = getimage($itemdescription_source);\n\t\t\t\t$itemdescription_plane = strip_tags($itemdescription_source);\n\t\t\t\t$itemdescription_plane = str_replace(array(\"\\r\\n\",\"\\r\",\"\\n\"), '', $itemdescription_plane);\n\n\t\t\t\t$itemdescription_body = str_replace(\"'\",\"\\\"\",$itemdescription_source);\n\t\t\t\t$itemdescription_body = str_replace(\"&lt;p&gt;\", \"\", $itemdescription_body);\n\t\t\t\t$itemdescription_body = str_replace(\"&lt;/p&gt;\", \"\", $itemdescription_body);\n\t\t\t\t$itemdescription_body = str_replace(array(\"\\r\\n\",\"\\r\",\"\\n\"), '', $itemdescription_body);\n\t\t\t}\n\n\t\t\t$check_sql = \"SELECT itemkey FROM rssdata WHERE itemkey = '$itemkey'\";\n\t\t\t$check_ret = mysql_query($check_sql);\n\t\t\t$check_array = mysql_fetch_array($check_ret);\n\t\t\tif(empty($check_array) || $check_array[0]['itemkey'] === '')\n\t\t\t{\n\n\t\t\t\t$replace_sql = \"INSERT INTO rssdata \n\t\t\t\t\t(\n\t\t\t\t\t\tid,\n\t\t\t\t\t\tsitetitle,\n\t\t\t\t\t\tsitedescription,\n\t\t\t\t\t\tsitelink,\n\t\t\t\t\t\titemkey,\n\t\t\t\t\t\titemtitle,\n\t\t\t\t\t\titemdescription_body,\n\t\t\t\t\t\titemdescription_plane,\n\t\t\t\t\t\titemdescription_image,\n\t\t\t\t\t\titemlink,\n\t\t\t\t\t\tstatus,\n\t\t\t\t\t\tversion\n\t\t\t\t\t)\n\t\t\t\t\tVALUES \n\t\t\t\t\t(\n\t\t\t\t\t\t$id,\n\t\t\t\t\t\t'$sitetitle',\n\t\t\t\t\t\t'$sitedescription',\n\t\t\t\t\t\t'$sitelink',\n\t\t\t\t\t\t'$itemkey',\n\t\t\t\t\t\t'$itemtitle',\n\t\t\t\t\t\t'$itemdescription_body',\n\t\t\t\t\t\t'$itemdescription_plane',\n\t\t\t\t\t\t'$itemdescription_image',\n\t\t\t\t\t\t'$itemlink',\n\t\t\t\t\t\t0,\n\t\t\t\t\t\t'$version'\n\t\t\t\t\t)\";\n\t\t\t\t$replace_sql = str_replace(array(\"\\r\\n\",\"\\r\",\"\\n\", \"\\t\" ), '', $replace_sql);\n\n\t\t\t\tmysql_query($replace_sql);\n\n\t\t\t\tlogging(array(\n\t\t\t\t\t'id' =&gt; $id,\n\t\t\t\t\t'sitetitle' =&gt; $sitetitle,\n\t\t\t\t\t'sitedescription' =&gt; $sitedescription,\n\t\t\t\t\t'sitelink' =&gt; $sitelink,\n\t\t\t\t\t'itemkey' =&gt; $itemkey,\n\t\t\t\t\t'itemtitle' =&gt; $itemtitle,\n\t\t\t\t\t'itemdescription_body' =&gt; $itemdescription_body,\n\t\t\t\t\t'itemdescription_plane' =&gt; $itemdescription_plane,\n\t\t\t\t\t'itemdescription_image' =&gt; $itemdescription_image,\n\t\t\t\t\t'itemlink' =&gt; $itemlink,\n\t\t\t\t\t'version' =&gt; $version));\n\t\t\t}\t\n\t\t}\n\t}\n}\nmysql_close($db_select);\n\n\n// ---------------------------------------------------------------\n//\tfunctions\n// ---------------------------------------------------------------\n\n// url1\u306e\u5f62\u5f0f\u30c1\u30a7\u30c3\u30af\u30fb\u5b58\u5728\u30c1\u30a7\u30c3\u30af\u3092\u3059\u308b\u3002\u4e21\u65b9true\u306a\u3089url1\u3092\u3001false\u304c\u3042\u308c\u3070url2\u3092\u8fd4\u3059\nfunction urlcheck($url1,$url2)\n{\n\t$returl = $url1;\n\n\t// url\u5f62\u5f0f\u30c1\u30a7\u30c3\u30af\n\tif (preg_match('/^(https?|ftp)(:\\/\\/[-_.!~*\\'()a-zA-Z0-9;\\/?:\\@&=+\\$,%#]+)$/', $url1))\n\t{\n\t\t// URL\u5b58\u5728\u30c1\u30a7\u30c3\u30af\n\t\tif($fp = @fopen($url1, 'r'))\n\t\t{\n\t\t\tfclose($fp);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$returl = $url2;\n\t\t}\n\t}\n\telse\n\t{\n\t\t$returl = $url2;\n\t}\n\treturn $returl;\n}\n\n// img\u30bf\u30b0\u629c\u304d\u51fa\u3057\nfunction getimage($str)\n{\n\tif (!is_string($str)) return;\n\tif (preg_match('/(\\&lt;img).*(gif|jpg|jpeg|png)(.*?&gt;)/', $str, $match))\n\t{\n\t\treturn str_replace(\"'\",\"\\\"\",$match[0]);\n\t}\n\telse\n\t{\n\t\treturn \"\";\n\t}\n}\n\nfunction logging($array)\n{\n    $log = NULL;\n    $log.= date(\"Y/m/d H:i:s\").\" : \";\n\t$Ymd = date(\"Ymd\");\n    foreach($array as $key =&gt; $value)\n    {\n        if (is_numeric($key))\n        {\n            continue;\n        }\n        $log.= \"$key=$value,\";\n    }\n    $log = substr($log,0,-1);\n\t$log.= \"\\n\";\n    $logfile = str_replace(\"php\",\"log\",$_SERVER['PHP_SELF']) ;\n    error_log($log,3,'/var/log/'.$logfile);\n}\n?&gt;\n</pre>\n\n#\u4f7f\u3044\u65b9\nmysql\u306b\u30c6\u30fc\u30d6\u30eb\u4f5c\u3063\u3066php\u306e\u30bd\u30fc\u30b9\u306bmysql\u306e\u30a2\u30af\u30bb\u30b9\u8a2d\u5b9a\u3057\u3066parserdf.php\u3092cli\u8d77\u52d5\u3059\u308c\u3070\u52d5\u304f\u306f\u305a\u3067\u3059\u3002\n\n\u3053\u308c\u3060\u3051\u3060\u3068\u898b\u308b\u65b9\u6cd5\u304c\u306a\u3044\u306e\u3067\u5b9f\u904b\u7528\u306b\u306fcakePHP\u306b\u3066WebUI\u3092\u5b9f\u88c5\u3057\u3066\u3044\u307e\u3059\u3002\n\u305d\u308c\u306f\u307e\u305f\u6b21\u56de\u306b\u3002\n"}