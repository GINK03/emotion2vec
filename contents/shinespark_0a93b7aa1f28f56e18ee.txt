{"context": "\u3053\u306e\u8a18\u4e8b\u306f Docker2 Advent Calendar 2016 \u306e7\u65e5\u76ee\u3067\u3059\u3002(\u7a7a\u3044\u3066\u3044\u305f\u306e\u3067\u6ed1\u308a\u8fbc\u307f\u307e\u3057\u305f\u3002)\n\u5168\u56fd\u306eConfluence\u597d\u304d\u306e\u7686\u3055\u3093\u3053\u3093\u306b\u3061\u306f\u3002\n\u8ee2\u8077\u5148\u306e\u4f1a\u793e\u306bConfluence\u304c\u306a\u304b\u3063\u305f...\u305d\u3093\u306a\u3053\u3068\u3042\u308a\u307e\u305b\u3093\u304b\uff1f\n\u79c1\u3082\u8ee2\u8077\u5148\u306bConfluence\u304c\u306a\u304b\u3063\u305f\u306e\u3067\u3001\u65e9\u901f\u7a1f\u8b70\u3092\u51fa\u3057\u3064\u3064\u6298\u89d2\u306a\u306e\u3067Docker\u74b0\u5883\u3067Confluence\u3092\u69cb\u7bc9\u3057\u307e\u3057\u305f\u3002\n\n\u8981\u4ef6\n\u4ee5\u4e0b\u306e\u74b0\u5883\u3092\u60f3\u5b9a\u3002\n\nDocker Compose\nConfluence 5.10.8 (6\u7cfb\u306f\u307e\u30606.0.1\u306a\u306e\u3067\u898b\u9001\u308a)\nnginx\nPostgreSQL (RDS\u5229\u7528\u4e88\u5b9a\u306a\u306e\u3067\u3001docker-compose.yml\u306b\u306f\u542b\u3081\u306a\u3044)\n\n\n\u5168\u4f53\u306e\u69cb\u6210\n\u3053\u308c\u304b\u3089\u69cb\u7bc9\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u69cb\u6210\u3002\n.\n\u251c\u2500\u2500 docker-compose.yml\n\u251c\u2500\u2500 data\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 confluence-home\n\u251c\u2500\u2500 confluence\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 Dockerfile\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 server.xml\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 setenv.sh\n\u251c\u2500\u2500 nginx\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 Dockerfile\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 conf.d\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 default.conf\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 nginx.conf\n\u2514\u2500\u2500 postgres\n    \u2514\u2500\u2500 Dockerfile\n\n\nConfluence\u306eDockerfile\u3092\u4f5c\u6210\u3059\u308b\n\u307e\u305aConfluence\u306eDockerfile\u3092\u4f5c\u6210\u3059\u308b\u3002\n\u4eca\u56de\u306f5.10\u7cfb\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u306e\u3067\u516c\u5f0f\u306e Dockerfile \u2014 Bitbucket \u306e5.10\u30d6\u30e9\u30f3\u30c1\u306eDockerfile\u3092\u30d9\u30fc\u30b9\u306b\u3059\u308b\u3002\n\u3057\u304b\u3057\u3001\u3053\u306e\u307e\u307eConfluence\u306e\u30b3\u30f3\u30c6\u30ca\u5185\u306bMySQL\u30c9\u30e9\u30a4\u30d0\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u3057\u307e\u3046\u306e\u3067\u66f8\u304d\u63db\u3048\u308b\u3002\n\nMySQL\u30c9\u30e9\u30a4\u30d0\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u7b87\u6240\u3092\u53d6\u308a\u9664\u304f\nMySQL\u30c9\u30e9\u30a4\u30d0\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u3044\u308b\u7b87\u6240\u3092\u53d6\u308a\u9664\u304f\u3002\nPostgreSQL\u3092\u5229\u7528\u3059\u308b\u5834\u5408\u306b\u306f\u3001\u7279\u306b\u8ffd\u52a0\u3067\u4f55\u3082\u3059\u308b\u5fc5\u8981\u306f\u306a\u3044\u306e\u3067\u524a\u9664\u306e\u307f\u3002\n\nconfluence/Dockerfile\n@@ -10,9 +10,6 @@ LABEL Description=\"This image is used to start Atlassian Confluence\" Vendor=\"Atl\n\n ENV CONFLUENCE_DOWNLOAD_URL http://www.atlassian.com/software/confluence/downloads/binary/atlassian-confluence-${CONF_VERSION}.tar.gz\n\n-ENV MYSQL_VERSION 5.1.38\n-ENV MYSQL_DRIVER_DOWNLOAD_URL http://dev.mysql.com/get/Downloads/Connector-J/mysql-connector-java-${MYSQL_VERSION}.tar.gz\n-\n # Use the default unprivileged account. This could be considered bad practice\n # on systems where multiple processes end up being executed by 'daemon' but\n # here we only ever run one process anyway.\n@@ -31,7 +28,6 @@ RUN set -x \\\n     && chown ${RUN_USER}:${RUN_GROUP}     \"${CONFLUENCE_HOME}\" \\\n     && mkdir -p                           \"${CONFLUENCE_INSTALL}/conf\" \\\n     && curl -Ls                           \"${CONFLUENCE_DOWNLOAD_URL}\" | tar -xz --directory \"${CONFLUENCE_INSTALL}\" --strip-components=1 --no-same-owner \\\n-    && curl -Ls                           \"${MYSQL_DRIVER_DOWNLOAD_URL}\" | tar -xz --directory \"${CONFLUENCE_INSTALL}/confluence/WEB-INF/lib\" --strip-components=1 --no-same-own\n     && chmod -R 700                       \"${CONFLUENCE_INSTALL}/conf\" \\\n     && chmod -R 700                       \"${CONFLUENCE_INSTALL}/temp\" \\\n     && chmod -R 700                       \"${CONFLUENCE_INSTALL}/logs\" \\\n\n\n\n\u30e1\u30e2\u30ea\u3092\u53ef\u5909\u306b\u3059\u308b\n\u3055\u3066\u3001Confluence\u3092\u74b0\u5883\u69cb\u7bc9\u3057\u3066\u6539\u3081\u3066\u5b9f\u611f\u3057\u305f\u304c\u3001\u30e1\u30e2\u30ea\u304c\u5927\u91cf\u306b\u5fc5\u8981\u3068\u306a\u308b\u30022GB\u3067\u306f\u5168\u7136\u8db3\u308a\u306a\u3044\u3002\nHow to fix out of memory errors by increasing available memory - Atlassian Documentation \u3092\u53c2\u8003\u306b\u3001setenv.sh\u3092\u66f8\u304d\u63db\u3048\u3066Tomcat\u306e\u30e1\u30e2\u30ea\u4f7f\u7528\u91cf\u3092\u5897\u3084\u3059\u5fc5\u8981\u304c\u3042\u308b\u304c\u3001\u4eca\u5f8c\u306e\u3053\u3068\u3092\u8003\u3048\u3066\u74b0\u5883\u5909\u6570\u306b\u3059\u308b\u3002\nsetenv.sh\u3092\u4e0b\u8a18\u306e\u3088\u3046\u306b\u66f8\u304d\u63db\u3048\u3001\n\nconfluence/setenv.sh\nCATALINA_OPTS=\"-XX:-PrintGCDetails -XX:+PrintGCDateStamps -XX:-PrintTenuringDistribution ${CATALINA_OPTS}\"\nCATALINA_OPTS=\"-Xloggc:$LOGBASEABS/logs/gc-`date +%F_%H-%M-%S`.log -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=2M ${CATALINA_OPTS}\"\nCATALINA_OPTS=\"-XX:G1ReservePercent=20 ${CATALINA_OPTS}\"\nCATALINA_OPTS=\"-Djava.awt.headless=true ${CATALINA_OPTS}\"\nCATALINA_OPTS=\"-Datlassian.plugins.enable.wait=300 ${CATALINA_OPTS}\"\n+CATALINA_OPTS=\"-Xms${CONFLUENCE_CATALINA_MEM}m -Xmx${CONFLUENCE_CATALINA_MEM}m -XX:+UseG1GC ${CATALINA_OPTS}\"\n\n\nexport CATALINA_OPTS\n\n\nENV\u306b \u74b0\u5883\u5909\u6570\u3068\u3057\u3066\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30e1\u30e2\u30ea\u4f7f\u7528\u91cf\u3092\u8a18\u8ff0\u3059\u308b\u3002\n\nconfluence/Dockerfile\n@@ -4,6 +4,7 @@ MAINTAINER Atlassian Confluence\n # Setup useful environment variables\n ENV CONFLUENCE_HOME     /var/atlassian/application-data/confluence\n ENV CONFLUENCE_INSTALL  /opt/atlassian/confluence\n+ENV CONFLUENCE_CATALINA_MEM  2048\n ENV CONF_VERSION  5.10.8\n\n LABEL Description=\"This image is used to start Atlassian Confluence\" Vendor=\"Atlassian\" Version=\"${CONF_VERSION}\"\n@@ -54,6 +55,7 @@ RUN set -x \\\n # here we only ever run one process anyway.\n USER ${RUN_USER}:${RUN_GROUP}\n\n+COPY ./setenv.sh  ${CONFLUENCE_INSTALL}/bin/\n COPY ./server.xml ${CONFLUENCE_INSTALL}/conf/\n\n\n\n\u30d7\u30ed\u30ad\u30b7\u5b9f\u884c\u7528\u306bserver.xml\u3092\u66f8\u304d\u63db\u3048\u308b\n\u6b21\u306b\u30d7\u30ed\u30ad\u30b7\u5b9f\u884c\u7528\u306e\u8a2d\u5b9a\u3092\u884c\u3046\u3002\nHow to use NGINX to proxy requests for Confluence - Atlassian Documentation \u306b\u5f93\u3044\u3001\u30d7\u30ed\u30ad\u30b7\u5b9f\u884c\u7528\u306b\u66f8\u304d\u63db\u3048\u305fserver.xml\u3092\u7528\u610f\u3059\u308b\u3002\n\nconfluence/server.xml\n- <Connector port=\"8090\" connectionTimeout=\"20000\" redirectPort=\"8443\" maxThreads=\"48\" minSpareThreads=\"10\" enableLookups=\"false\" acceptCount=\"10\" debug=\"0\" URIEncoding=\"UTF-8\" protocol=\"org.apache.coyote.http11.Http11NioProtocol\"/>\n+ <Connector port=\"8090\" connectionTimeout=\"20000\" redirectPort=\"8443\" maxThreads=\"48\" minSpareThreads=\"10\" enableLookups=\"false\" acceptCount=\"10\" debug=\"0\" URIEncoding=\"UTF-8\" protocol=\"org.apache.coyote.http11.Http11NioProtocol\" proxyName=\"localhost\" proxyPort=\"80\"/>\n     <Engine name=\"Standalone\" defaultHost=\"localhost\">\n       <Host name=\"localhost\" appBase=\"webapps\" unpackWARs=\"true\" autoDeploy=\"false\">\n-        <Context path=\"\" docBase=\"../confluence\" reloadable=\"false\" useHttpOnly=\"true\">\n+        <Context path=\"/confluence\" docBase=\"../confluence\" reloadable=\"false\" useHttpOnly=\"true\">\n\n\n\u4f75\u305b\u3066\u3001Dockerfile\u5074\u306b\u3082COPY\u3092\u8ffd\u8a18\u3059\u308b\u3002\n\nconfluence/Dockerfile\n--- a/confluence/Dockerfile\n+++ b/confluence/Dockerfile\n@@ -54,6 +54,8 @@ RUN set -x \\\n # here we only ever run one process anyway.\n USER ${RUN_USER}:${RUN_GROUP}\n\n+COPY ./server.xml ${CONFLUENCE_INSTALL}/conf/\n+\n # Expose default HTTP connector port.\n EXPOSE 8090\n\n\n\u305f\u3060\u3057\u3001\u3053\u306e\u307e\u307e\u3067\u306fproxyName\u306flocalhost\u56fa\u5b9a\u3068\u306a\u3063\u3066\u3057\u307e\u3046\u3002\u3053\u3053\u306f\u74b0\u5883\u5909\u6570\u3067\u306f\u3069\u3046\u3057\u3088\u3046\u3082\u306a\u3044\u306e\u3067\u3001Dockerfile\u5074\u3067ARG\u3068sed\u3092\u4f7f\u3044build\u6642\u306b\u7f6e\u63db\u3092\u884c\u3046\u3002\n\nconfluence/Dockerfile\n@@ -8,7 +8,7 @@\n ENV CONF_VERSION  5.10.8\n ENV JAVA_HOME           /usr/lib/jvm/java-8-openjdk-amd64/jre\n\n+ARG CONFLUENCE_HOSTNAME=\"localhost\"\n\n\n LABEL Description=\"This image is used to start Atlassian Confluence\" Vendor=\"Atlassian\" Version=\"${CONF_VERSION}\"\n@@ -64,7 +64,7 @@\n\n COPY ./server.xml ${CONFLUENCE_INSTALL}/conf/\n+RUN sed -i -e \"4s/localhost/${CONFLUENCE_HOSTNAME}/\" ${CONFLUENCE_INSTALL}/conf/server.xml\n\n\n\n\u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\u3068\u3057\u3066nginx\u3092\u5229\u7528\u3059\u308b\n\u524d\u8077\u306eConfluence\u7ba1\u7406\u8005\u304b\u3089\u3001nginx\u3092\u901a\u3057\u3066\u30ad\u30e3\u30c3\u30b7\u30e5\u3057\u306a\u3044\u3068Confluence\u306f\u91cd\u904e\u304e\u308b\u3068\u306e\u8a71\u3092\u3082\u3089\u3063\u3066\u3044\u305f\u306e\u3067nginx\u3068\u4f75\u7528\u3059\u308b\u3002\u5b9f\u969b\u304b\u306a\u308a\u91cd\u3044\u3002\n\nnginx/Dockerfile\nFROM nginx:1.11.5-alpine\n\nCOPY ./nginx.conf /etc/nginx/\n\n\nnginx.conf\u306f docker\u7248nginx\u306enginx.conf \u3092\u53c2\u8003\u306b\u66f8\u304d\u63db\u3048\u308b\u3002\n\nnginx/nginx.conf\nuser  nginx;\nworker_processes  1;\n\nerror_log  /var/log/nginx/error.log warn;\npid        /var/run/nginx.pid;\n\n\nevents {\n    worker_connections  1024;\n}\n\n\nhttp {\n    include       /etc/nginx/mime.types;\n    default_type  application/octet-stream;\n\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log  /var/log/nginx/access.log  main;\n    sendfile        on;\n    keepalive_timeout  65;\n    client_max_body_size 30m;\n\n    gzip  on;\n    gzip_types text/css text/javascript\n               application/x-javascript application/javascript\n               application/json;\n    gzip_min_length 1k;\n    gzip_disable \"msie6\";\n\n    server {\n      listen       80;\n\n      location = / {\n        return 302 /confluence;\n      }\n\n      location / {\n        proxy_set_header X-Forwarded-Host   $host;\n        proxy_set_header X-Forwarded-Server $host;\n        proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;\n        proxy_pass       http://confluence:8090;\n      }\n    }\n}\n\n\ngzip\u5468\u308a\u306fnginx\u5b9f\u8df5\u5165\u9580\u3092\u53c2\u8003\u306b\u3057\u305f\u3002\n\ndocker-compose.yml \u3092\u4f5c\u6210\u3059\u308b\nnginx\u30a4\u30e1\u30fc\u30b8\u3092\u4f5c\u308a\u306f\u3058\u3081\u305f\u306e\u3067docker-compose.yml\u3082\u4f5c\u308a\u59cb\u3081\u308b\u3002\n\ndocker-compose.yml\nversion: '2'\nservices:\n  nginx:\n    build: ./nginx\n    links:\n      - confluence\n    ports:\n      - '80:80'\n  confluence:\n    build:\n      context: ./confluence\n      args:\n        CONFLUENCE_HOSTNAME: 'localhost'\n    environment:\n      CONFLUENCE_CATALINA_MEM: 2048\n    ports:\n      - '8090:8090'\n    volumes:\n      - ./data/confluence-home:/var/atlassian/application-data/confluence\n\n\n$ docker-compose \u5229\u7528\u6642\u306b\u306f\u3001Dockerfile\u306b\u66f8\u3044\u305fARG\u3084ENV\u306f\u3001docker-compose.yml \u306b\u66f8\u3044\u305fargs\u3084environment\u3067\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3055\u308c\u308b\u3002\n\u3064\u307e\u308a\u53ef\u5909\u90e8\u5206\u306f docker-compose.yml \u3060\u3051\u66f8\u304d\u63db\u308c\u3070OK\u3002\u4fbf\u5229\u3002\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u30db\u30b9\u30c8OS\u306b\u30de\u30a6\u30f3\u30c8\u3059\u308b\nConfluence\u306f\u521d\u56de\u30d6\u30e9\u30a6\u30b6\u30a2\u30af\u30bb\u30b9\u6642\u306b\u884c\u3046\u8a2d\u5b9a\u306e\u969b\u306b /var/atlassian/application-data/confluence \u4ee5\u4e0b\u306b\u30d5\u30a1\u30a4\u30eb\u7fa4\u304c\u751f\u6210\u3055\u308c\u308b\u3002\n\u3053\u306e\u30d5\u30a1\u30a4\u30eb\u7fa4\u3092\u524a\u9664\u3057\u305f\u72b6\u614b\u3067Confluence\u3092\u518d\u8d77\u52d5\u3057\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001\u307e\u305f\u521d\u671f\u8a2d\u5b9a\u753b\u9762\u306b\u306a\u308b\u3002\n\u305d\u306e\u70ba\u3001Docker\u30b3\u30f3\u30c6\u30ca\u3092\u7834\u68c4\u3057\u3066\u3082\u60c5\u5831\u304c\u5f15\u304d\u7d99\u304c\u308c\u308b\u3088\u3046\u306b\u3001\u3053\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u30db\u30b9\u30c8OS\u306b\u30de\u30a6\u30f3\u30c8\u3059\u308b\u3002\u5148\u7a0b\u306edocker-compose.yml\u306e\u672b\u5c3e\u304c\u305d\u306e\u8a2d\u5b9a\u306b\u8a72\u5f53\u3059\u308b\u3002\n\ndocker-compose.yml\n    volumes:\n      - ./data/confluence-home:/var/atlassian/application-data/confluence\n\n\n\n\u8d77\u52d5\u3057\u3066\u307f\u308b\n$ docker-compose build && docker-compose up \u3057\u3066 localhost\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u308b\u3002\n\n\u5f8c\u306f\u30e9\u30a4\u30bb\u30f3\u30b9\u30ad\u30fc\u3092\u5165\u308c\u305f\u308aDB\u8a2d\u5b9a\u3092\u3057\u305f\u308a\u3059\u308c\u3070Confluence\u304c\u4f7f\u3048\u308b\u3088\u3046\u306b\u306a\u308b\uff01\u3084\u3063\u305f\u306d\uff01\uff01\n\n\u30aa\u30de\u30b1\n\nPostgreSQL \u3082 Docker \u3067\u52d5\u304b\u3059\nConfluence\u3068PostgreSQL\u3092\u30ea\u30f3\u30af\u3055\u305b\u3064\u3064\u3001\u74b0\u5883\u5909\u6570\u3092\u6e21\u3059\u3060\u3051\u3067\u7c21\u5358\u306bDocker\u3067\u52d5\u304b\u3059\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\ndocker-compose.yml\n19a20,21\n+     links:\n+       - postgres\n23a26,34\n+   postgres:\n+     build: ./postgres\n+     environment:\n+       POSTGRES_USER: postgres\n+       POSTGRES_PASSWORD: postgres\n+     ports:\n+       - '5432:5432'\n+     volumes:\n+       - ./data/postgres:/var/lib/postgresql/data\n\n\n\nTimezone\u3082\u53ef\u5909\u306b\u3059\u308b\nConfluence\u306e\u7de8\u96c6\u5c65\u6b74\u306e\u76f8\u5bfe\u6642\u523b\u8868\u793a\u306fOS\u306e\u30bf\u30a4\u30e0\u30be\u30fc\u30f3\u306b\u4f9d\u5b58\u3059\u308b\u306e\u3067Timezone\u3092Asia/Tokyo\u306b\u5909\u66f4\u3059\u308b\u3002\n\nconfluence/Dockerfile\n@@ -8,6 +8,9 @@ ENV CONFLUENCE_CATALINA_MEM  1024\n ENV CONF_VERSION  5.10.8\n ENV JAVA_HOME           /usr/lib/jvm/java-8-openjdk-amd64/jre\n\n ARG CONFLUENCE_HOSTNAME=\"localhost\"\n+ARG TIMEZONE=\"Asia/Tokyo\"\n\n LABEL Description=\"This image is used to start Atlassian Confluence\" Vendor=\"Atlassian\" Version=\"${CONF_VERSION}\"\n\n ENV CONFLUENCE_DOWNLOAD_URL http://www.atlassian.com/software/confluence/downloads/binary/atlassian-confluence-${CONF_VERSION}.tar.gz\n@@ -51,6 +54,9 @@ RUN set -x \\\n                                           \"${CONFLUENCE_INSTALL}/conf/server.xml\" \\\n     && touch -d \"@0\"                      \"${CONFLUENCE_INSTALL}/conf/server.xml\"\n\n+# set timezone\n+RUN sed -i -e \"s|Etc/UTC|${TIMEZONE}|\" /etc/timezone\n\n\n\nIPA\u30b4\u30b7\u30c3\u30af\u3092\u30de\u30af\u30ed\u30bf\u30a4\u30c8\u30eb\u306b\u9069\u7528\u3059\u308b\n\u9806\u8abf\u306b\u52d5\u4f5c\u3057\u3066\u3044\u305f\u304b\u306b\u601d\u308f\u308c\u305fConfluence\u3060\u304c\u3001\u7de8\u96c6\u753b\u9762\u306e\u30de\u30af\u30ed\u306e\u30bf\u30a4\u30c8\u30eb\u90e8\u5206\u304c\u6587\u5b57\u5316\u3051\u3057\u3066\u3044\u305f\u3002\n\n\u3053\u3053\u306fIPA\u30b4\u30b7\u30c3\u30af\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066jre\u304b\u3089\u3082\u53c2\u7167\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u3002\n\nconfluence/Dockerfile\n@@ -22,7 +23,7 @@ ENV RUN_GROUP           daemon\n # directory structure.\n RUN set -x \\\n     && apt-get update --quiet \\\n-    && apt-get install --quiet --yes --no-install-recommends libtcnative-1 xmlstarlet \\\n+    && apt-get install --quiet --yes --no-install-recommends libtcnative-1 xmlstarlet fonts-ipafont-gothic\\\n     && apt-get clean \\\n     && mkdir -p                           \"${CONFLUENCE_HOME}\" \\\n     && chmod -R 700                       \"${CONFLUENCE_HOME}\" \\\n\n\n+# add font for macro title\n+RUN mkdir -p \"${JAVA_HOME}/lib/fonts/fallback\"\n+RUN ln -s /usr/share/fonts/opentype/ipafont-gothic/ipag.ttf \"${JAVA_HOME}/lib/fonts/fallback/ipag.ttf\"\n\n\n\nconfluence/setenv.sh\n@@ -44,6 +44,9 @@ CATALINA_OPTS=\"-Djava.awt.headless=true ${CATALINA_OPTS}\"\n CATALINA_OPTS=\"-Datlassian.plugins.enable.wait=300 ${CATALINA_OPTS}\"\n CATALINA_OPTS=\"-Xms${CONFLUENCE_CATALINA_MEM}m -Xmx${CONFLUENCE_CATALINA_MEM}m -XX:+UseG1GC ${CATALINA_OPTS}\"\n\n+# For macro titles\n+CATALINA_OPTS=\"-Dconfluence.document.conversion.fontpath=${JAVA_HOME}/lib/fonts/fallback ${CATALINA_OPTS}\"\n+CATALINA_OPTS=\"-Dconfluence.document.conversion.slides.defaultfontname.regular=IPAGothic -Dconfluence.document.conversion.slides.defaultfontname.asian=IPAGothic -Dconfluence.do\n\n export CATALINA_OPTS\n\n\n\nPDF\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u304c\u9045\u3044\u554f\u984c\u3092\u89e3\u6c7a\u3059\u308b\nConfluence 5.10.8\u3067\u306fPDF\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u304c\u9045\u304f\u306a\u308b\u73fe\u8c61\u304c\u3042\u308b\u304c\u3001\u6050\u3089\u304f\u30ed\u30fc\u30ab\u30eb\u306e\u4e00\u6642\u30d5\u30a1\u30a4\u30eb\u3068\u3057\u3066\u51fa\u529b\u3057\u305fPDF\u30d5\u30a1\u30a4\u30eb\u3092\u30ea\u30af\u30a8\u30b9\u30c8\u5143\u306b\u8fd4\u3059\u969b\u306b\u4e0a\u624b\u304f\u3044\u3063\u3066\u306a\u3044\u3002 /etc/hosts \u306b\u81ea\u8eab\u306e\u30db\u30b9\u30c8\u540d\u3092\u66f8\u304f\u3068\u89e3\u6d88\u3059\u308b\u306e\u3067\u3053\u3061\u3089\u3082docker-compose.yml\u304b\u3089\u5bfe\u5fdc\u3059\u308b\u3002\n\ndocker-compose.yml\n@@ -12,7 +12,10 @@ services:\n   confluence:\n     build: ./confluence\n     environment:\n       CONFLUENCE_HOSTNAME: \"www.example.com\"\n       CONFLUENCE_CATALINA_MEM: 2048\n+    extra_hosts:\n+      - \"www.example.com:127.0.0.1\"\n     ports:\n       - '8090:8090'\n     volumes:\n\n\n\u3053\u306e\u3088\u3046\u306b\u3057\u3066\u304a\u3044\u3066\u3001\u5404\u81ea\u306e\u74b0\u5883\u3067 :%s/www\\.example\\.com/<\u4efb\u610f\u306e\u30c9\u30e1\u30a4\u30f3>/\u306b\u7f6e\u63db\u3059\u308c\u3070confluence\u30b3\u30f3\u30c6\u30ca\u306e /etc/hosts/ \u306bextra_hosts\u306b\u66f8\u3044\u305f\u5185\u5bb9\u304c\u8ffd\u8a18\u3055\u308c\u308b\u3002\nCompose file reference - Docker\n\n\u6ce8\u610f\u4e8b\u9805\natlassian/confluence-server - Docker Hub\n\u306b\u3082\u8a18\u8f09\u3055\u308c\u3066\u3044\u308b\u304c\u3001OpenJDK\u306fConfluence\u306e\u30b5\u30dd\u30fc\u30c8\u5bfe\u8c61\u5916\u3068\u306a\u3063\u3066\u3044\u308b\u3002\n\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u308bJava\u74b0\u5883\u306fOracle JDK\u3060\u304c\u3001\u30e9\u30a4\u30bb\u30f3\u30b9\u4e0a\u518d\u914d\u5e03\u4e0d\u53ef\u3068\u306a\u3063\u3066\u3044\u308b\u306e\u3067\u3001Oracle JDK\u74b0\u5883\u3067\u52d5\u4f5c\u3055\u305b\u308b\u306b\u306f\u3001\u5404\u81ea\u3067Oracle JDK\u306eDocker\u30a4\u30e1\u30fc\u30b8\u3092\u69cb\u7bc9\u3057\u3001\u305d\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u53c2\u7167\u3057\u3066Confluence\u30a4\u30e1\u30fc\u30b8\u3092\u69cb\u7bc9\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\nUpdate the Confluence Docker image to use Oracle JDK - Atlassian Documentation \n\n\u3006\n\u8af8\u3005\u8e93\u304f\u6240\u304c\u3042\u3063\u305f\u304c\u3001\u7121\u4e8b\u306bDocker Compose\u3067Confluence\u3092\u69cb\u7bc9\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3057\u305f\u3002\n\u4e0a\u8a18\u306eDocker\u74b0\u5883\u306fGitHub\u306b\u3082\u516c\u958b\u3057\u3066\u304a\u308a\u307e\u3059(OpenJDK\u3067\u3059)\u3002\nshinespark/docker-confluence: GitHub\n\u597d\u307f\u306e\u74b0\u5883\u306b\u3042\u308f\u305b\u3066docker-compose.yml\u306e\u30db\u30b9\u30c8\u540d\u3060\u3051\u66f8\u304d\u63db\u3048\u3066 $ docker-compose up \u3059\u308c\u3070\u307b\u307c\u554f\u984c\u306a\u304f\u5229\u7528\u53ef\u80fd\u3067\u3059\u3002PR\u6b53\u8fce\u3057\u3066\u3044\u307e\u3059\u3002\n\u3053\u306e\u8a18\u4e8b\u306f [Docker2 Advent Calendar 2016](http://qiita.com/advent-calendar/2016/docker2) \u306e7\u65e5\u76ee\u3067\u3059\u3002(\u7a7a\u3044\u3066\u3044\u305f\u306e\u3067\u6ed1\u308a\u8fbc\u307f\u307e\u3057\u305f\u3002)\n\n\u5168\u56fd\u306eConfluence\u597d\u304d\u306e\u7686\u3055\u3093\u3053\u3093\u306b\u3061\u306f\u3002\n\u8ee2\u8077\u5148\u306e\u4f1a\u793e\u306bConfluence\u304c\u306a\u304b\u3063\u305f...\u305d\u3093\u306a\u3053\u3068\u3042\u308a\u307e\u305b\u3093\u304b\uff1f\n\n\u79c1\u3082\u8ee2\u8077\u5148\u306bConfluence\u304c\u306a\u304b\u3063\u305f\u306e\u3067\u3001\u65e9\u901f\u7a1f\u8b70\u3092\u51fa\u3057\u3064\u3064\u6298\u89d2\u306a\u306e\u3067Docker\u74b0\u5883\u3067Confluence\u3092\u69cb\u7bc9\u3057\u307e\u3057\u305f\u3002\n\n## \u8981\u4ef6\n\n\u4ee5\u4e0b\u306e\u74b0\u5883\u3092\u60f3\u5b9a\u3002\n\n* Docker Compose\n* Confluence 5.10.8 (6\u7cfb\u306f\u307e\u30606.0.1\u306a\u306e\u3067\u898b\u9001\u308a)\n* nginx\n* PostgreSQL (RDS\u5229\u7528\u4e88\u5b9a\u306a\u306e\u3067\u3001docker-compose.yml\u306b\u306f\u542b\u3081\u306a\u3044)\n\n## \u5168\u4f53\u306e\u69cb\u6210\n\n\u3053\u308c\u304b\u3089\u69cb\u7bc9\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u69cb\u6210\u3002\n\n```\n.\n\u251c\u2500\u2500 docker-compose.yml\n\u251c\u2500\u2500 data\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 confluence-home\n\u251c\u2500\u2500 confluence\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 Dockerfile\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 server.xml\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 setenv.sh\n\u251c\u2500\u2500 nginx\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 Dockerfile\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 conf.d\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 default.conf\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 nginx.conf\n\u2514\u2500\u2500 postgres\n    \u2514\u2500\u2500 Dockerfile\n```\n\n\n# Confluence\u306eDockerfile\u3092\u4f5c\u6210\u3059\u308b\n\n\u307e\u305aConfluence\u306eDockerfile\u3092\u4f5c\u6210\u3059\u308b\u3002\n\u4eca\u56de\u306f5.10\u7cfb\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u306e\u3067\u516c\u5f0f\u306e [Dockerfile \u2014 Bitbucket](https://bitbucket.org/atlassian/docker-atlassian-confluence-server/src/ba62d39c9559f3f0dbc21dc0fdeda0fcefba8da4/Dockerfile?at=5.10&fileviewer=file-view-default) \u306e5.10\u30d6\u30e9\u30f3\u30c1\u306eDockerfile\u3092\u30d9\u30fc\u30b9\u306b\u3059\u308b\u3002\n\n\u3057\u304b\u3057\u3001\u3053\u306e\u307e\u307eConfluence\u306e\u30b3\u30f3\u30c6\u30ca\u5185\u306bMySQL\u30c9\u30e9\u30a4\u30d0\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u3057\u307e\u3046\u306e\u3067\u66f8\u304d\u63db\u3048\u308b\u3002\n\n## MySQL\u30c9\u30e9\u30a4\u30d0\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u7b87\u6240\u3092\u53d6\u308a\u9664\u304f\n\nMySQL\u30c9\u30e9\u30a4\u30d0\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u3044\u308b\u7b87\u6240\u3092\u53d6\u308a\u9664\u304f\u3002\nPostgreSQL\u3092\u5229\u7528\u3059\u308b\u5834\u5408\u306b\u306f\u3001\u7279\u306b\u8ffd\u52a0\u3067\u4f55\u3082\u3059\u308b\u5fc5\u8981\u306f\u306a\u3044\u306e\u3067\u524a\u9664\u306e\u307f\u3002\n\n```diff:confluence/Dockerfile\n@@ -10,9 +10,6 @@ LABEL Description=\"This image is used to start Atlassian Confluence\" Vendor=\"Atl\n\n ENV CONFLUENCE_DOWNLOAD_URL http://www.atlassian.com/software/confluence/downloads/binary/atlassian-confluence-${CONF_VERSION}.tar.gz\n\n-ENV MYSQL_VERSION 5.1.38\n-ENV MYSQL_DRIVER_DOWNLOAD_URL http://dev.mysql.com/get/Downloads/Connector-J/mysql-connector-java-${MYSQL_VERSION}.tar.gz\n-\n # Use the default unprivileged account. This could be considered bad practice\n # on systems where multiple processes end up being executed by 'daemon' but\n # here we only ever run one process anyway.\n@@ -31,7 +28,6 @@ RUN set -x \\\n     && chown ${RUN_USER}:${RUN_GROUP}     \"${CONFLUENCE_HOME}\" \\\n     && mkdir -p                           \"${CONFLUENCE_INSTALL}/conf\" \\\n     && curl -Ls                           \"${CONFLUENCE_DOWNLOAD_URL}\" | tar -xz --directory \"${CONFLUENCE_INSTALL}\" --strip-components=1 --no-same-owner \\\n-    && curl -Ls                           \"${MYSQL_DRIVER_DOWNLOAD_URL}\" | tar -xz --directory \"${CONFLUENCE_INSTALL}/confluence/WEB-INF/lib\" --strip-components=1 --no-same-own\n     && chmod -R 700                       \"${CONFLUENCE_INSTALL}/conf\" \\\n     && chmod -R 700                       \"${CONFLUENCE_INSTALL}/temp\" \\\n     && chmod -R 700                       \"${CONFLUENCE_INSTALL}/logs\" \\\n```\n\n# \u30e1\u30e2\u30ea\u3092\u53ef\u5909\u306b\u3059\u308b\n\n\u3055\u3066\u3001Confluence\u3092\u74b0\u5883\u69cb\u7bc9\u3057\u3066\u6539\u3081\u3066\u5b9f\u611f\u3057\u305f\u304c\u3001\u30e1\u30e2\u30ea\u304c\u5927\u91cf\u306b\u5fc5\u8981\u3068\u306a\u308b\u30022GB\u3067\u306f\u5168\u7136\u8db3\u308a\u306a\u3044\u3002\n\n[How to fix out of memory errors by increasing available memory - Atlassian Documentation](https://confluence.atlassian.com/confkb/how-to-fix-out-of-memory-errors-by-increasing-available-memory-154071.html) \u3092\u53c2\u8003\u306b\u3001setenv.sh\u3092\u66f8\u304d\u63db\u3048\u3066Tomcat\u306e\u30e1\u30e2\u30ea\u4f7f\u7528\u91cf\u3092\u5897\u3084\u3059\u5fc5\u8981\u304c\u3042\u308b\u304c\u3001\u4eca\u5f8c\u306e\u3053\u3068\u3092\u8003\u3048\u3066\u74b0\u5883\u5909\u6570\u306b\u3059\u308b\u3002\n\nsetenv.sh\u3092\u4e0b\u8a18\u306e\u3088\u3046\u306b\u66f8\u304d\u63db\u3048\u3001\n\n```diff:confluence/setenv.sh\nCATALINA_OPTS=\"-XX:-PrintGCDetails -XX:+PrintGCDateStamps -XX:-PrintTenuringDistribution ${CATALINA_OPTS}\"\nCATALINA_OPTS=\"-Xloggc:$LOGBASEABS/logs/gc-`date +%F_%H-%M-%S`.log -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=2M ${CATALINA_OPTS}\"\nCATALINA_OPTS=\"-XX:G1ReservePercent=20 ${CATALINA_OPTS}\"\nCATALINA_OPTS=\"-Djava.awt.headless=true ${CATALINA_OPTS}\"\nCATALINA_OPTS=\"-Datlassian.plugins.enable.wait=300 ${CATALINA_OPTS}\"\n+CATALINA_OPTS=\"-Xms${CONFLUENCE_CATALINA_MEM}m -Xmx${CONFLUENCE_CATALINA_MEM}m -XX:+UseG1GC ${CATALINA_OPTS}\"\n\n\nexport CATALINA_OPTS\n```\n\n`ENV`\u306b \u74b0\u5883\u5909\u6570\u3068\u3057\u3066\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30e1\u30e2\u30ea\u4f7f\u7528\u91cf\u3092\u8a18\u8ff0\u3059\u308b\u3002\n\n```diff:confluence/Dockerfile\n@@ -4,6 +4,7 @@ MAINTAINER Atlassian Confluence\n # Setup useful environment variables\n ENV CONFLUENCE_HOME     /var/atlassian/application-data/confluence\n ENV CONFLUENCE_INSTALL  /opt/atlassian/confluence\n+ENV CONFLUENCE_CATALINA_MEM  2048\n ENV CONF_VERSION  5.10.8\n\n LABEL Description=\"This image is used to start Atlassian Confluence\" Vendor=\"Atlassian\" Version=\"${CONF_VERSION}\"\n@@ -54,6 +55,7 @@ RUN set -x \\\n # here we only ever run one process anyway.\n USER ${RUN_USER}:${RUN_GROUP}\n\n+COPY ./setenv.sh  ${CONFLUENCE_INSTALL}/bin/\n COPY ./server.xml ${CONFLUENCE_INSTALL}/conf/\n```\n\n\n## \u30d7\u30ed\u30ad\u30b7\u5b9f\u884c\u7528\u306bserver.xml\u3092\u66f8\u304d\u63db\u3048\u308b\n\n\u6b21\u306b\u30d7\u30ed\u30ad\u30b7\u5b9f\u884c\u7528\u306e\u8a2d\u5b9a\u3092\u884c\u3046\u3002\n[How to use NGINX to proxy requests for Confluence - Atlassian Documentation](https://confluence.atlassian.com/confkb/how-to-use-nginx-to-proxy-requests-for-confluence-313459790.html) \u306b\u5f93\u3044\u3001\u30d7\u30ed\u30ad\u30b7\u5b9f\u884c\u7528\u306b\u66f8\u304d\u63db\u3048\u305fserver.xml\u3092\u7528\u610f\u3059\u308b\u3002\n\n```diff:confluence/server.xml\n- <Connector port=\"8090\" connectionTimeout=\"20000\" redirectPort=\"8443\" maxThreads=\"48\" minSpareThreads=\"10\" enableLookups=\"false\" acceptCount=\"10\" debug=\"0\" URIEncoding=\"UTF-8\" protocol=\"org.apache.coyote.http11.Http11NioProtocol\"/>\n+ <Connector port=\"8090\" connectionTimeout=\"20000\" redirectPort=\"8443\" maxThreads=\"48\" minSpareThreads=\"10\" enableLookups=\"false\" acceptCount=\"10\" debug=\"0\" URIEncoding=\"UTF-8\" protocol=\"org.apache.coyote.http11.Http11NioProtocol\" proxyName=\"localhost\" proxyPort=\"80\"/>\n     <Engine name=\"Standalone\" defaultHost=\"localhost\">\n       <Host name=\"localhost\" appBase=\"webapps\" unpackWARs=\"true\" autoDeploy=\"false\">\n-        <Context path=\"\" docBase=\"../confluence\" reloadable=\"false\" useHttpOnly=\"true\">\n+        <Context path=\"/confluence\" docBase=\"../confluence\" reloadable=\"false\" useHttpOnly=\"true\">\n```\n\n\u4f75\u305b\u3066\u3001Dockerfile\u5074\u306b\u3082COPY\u3092\u8ffd\u8a18\u3059\u308b\u3002\n\n```diff:confluence/Dockerfile\n--- a/confluence/Dockerfile\n+++ b/confluence/Dockerfile\n@@ -54,6 +54,8 @@ RUN set -x \\\n # here we only ever run one process anyway.\n USER ${RUN_USER}:${RUN_GROUP}\n\n+COPY ./server.xml ${CONFLUENCE_INSTALL}/conf/\n+\n # Expose default HTTP connector port.\n EXPOSE 8090\n```\n\n\u305f\u3060\u3057\u3001\u3053\u306e\u307e\u307e\u3067\u306fproxyName\u306flocalhost\u56fa\u5b9a\u3068\u306a\u3063\u3066\u3057\u307e\u3046\u3002\u3053\u3053\u306f\u74b0\u5883\u5909\u6570\u3067\u306f\u3069\u3046\u3057\u3088\u3046\u3082\u306a\u3044\u306e\u3067\u3001Dockerfile\u5074\u3067`ARG`\u3068`sed`\u3092\u4f7f\u3044build\u6642\u306b\u7f6e\u63db\u3092\u884c\u3046\u3002\n\n```diff:confluence/Dockerfile\n@@ -8,7 +8,7 @@\n ENV CONF_VERSION  5.10.8\n ENV JAVA_HOME           /usr/lib/jvm/java-8-openjdk-amd64/jre\n\n+ARG CONFLUENCE_HOSTNAME=\"localhost\"\n\n\n LABEL Description=\"This image is used to start Atlassian Confluence\" Vendor=\"Atlassian\" Version=\"${CONF_VERSION}\"\n@@ -64,7 +64,7 @@\n \n COPY ./server.xml ${CONFLUENCE_INSTALL}/conf/\n+RUN sed -i -e \"4s/localhost/${CONFLUENCE_HOSTNAME}/\" ${CONFLUENCE_INSTALL}/conf/server.xml\n```\n\n# \u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\u3068\u3057\u3066nginx\u3092\u5229\u7528\u3059\u308b\n\n\u524d\u8077\u306eConfluence\u7ba1\u7406\u8005\u304b\u3089\u3001nginx\u3092\u901a\u3057\u3066\u30ad\u30e3\u30c3\u30b7\u30e5\u3057\u306a\u3044\u3068Confluence\u306f\u91cd\u904e\u304e\u308b\u3068\u306e\u8a71\u3092\u3082\u3089\u3063\u3066\u3044\u305f\u306e\u3067nginx\u3068\u4f75\u7528\u3059\u308b\u3002\u5b9f\u969b\u304b\u306a\u308a\u91cd\u3044\u3002\n\n```:nginx/Dockerfile\nFROM nginx:1.11.5-alpine\n\nCOPY ./nginx.conf /etc/nginx/\n```\n\nnginx.conf\u306f [docker\u7248nginx\u306enginx.conf](https://github.com/nginxinc/docker-nginx/blob/master/mainline/alpine/nginx.conf) \u3092\u53c2\u8003\u306b\u66f8\u304d\u63db\u3048\u308b\u3002\n\n```nginx:nginx/nginx.conf\nuser  nginx;\nworker_processes  1;\n\nerror_log  /var/log/nginx/error.log warn;\npid        /var/run/nginx.pid;\n\n\nevents {\n    worker_connections  1024;\n}\n\n\nhttp {\n    include       /etc/nginx/mime.types;\n    default_type  application/octet-stream;\n\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log  /var/log/nginx/access.log  main;\n    sendfile        on;\n    keepalive_timeout  65;\n    client_max_body_size 30m;\n\n    gzip  on;\n    gzip_types text/css text/javascript\n               application/x-javascript application/javascript\n               application/json;\n    gzip_min_length 1k;\n    gzip_disable \"msie6\";\n\n    server {\n      listen       80;\n\n      location = / {\n        return 302 /confluence;\n      }\n\n      location / {\n        proxy_set_header X-Forwarded-Host   $host;\n        proxy_set_header X-Forwarded-Server $host;\n        proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;\n        proxy_pass       http://confluence:8090;\n      }\n    }\n}\n```\n\ngzip\u5468\u308a\u306fnginx\u5b9f\u8df5\u5165\u9580\u3092\u53c2\u8003\u306b\u3057\u305f\u3002\n\n# docker-compose.yml \u3092\u4f5c\u6210\u3059\u308b\n\nnginx\u30a4\u30e1\u30fc\u30b8\u3092\u4f5c\u308a\u306f\u3058\u3081\u305f\u306e\u3067docker-compose.yml\u3082\u4f5c\u308a\u59cb\u3081\u308b\u3002\n\n```yaml:docker-compose.yml\nversion: '2'\nservices:\n  nginx:\n    build: ./nginx\n    links:\n      - confluence\n    ports:\n      - '80:80'\n  confluence:\n    build:\n      context: ./confluence\n      args:\n        CONFLUENCE_HOSTNAME: 'localhost'\n    environment:\n      CONFLUENCE_CATALINA_MEM: 2048\n    ports:\n      - '8090:8090'\n    volumes:\n      - ./data/confluence-home:/var/atlassian/application-data/confluence\n```\n\n`$ docker-compose` \u5229\u7528\u6642\u306b\u306f\u3001Dockerfile\u306b\u66f8\u3044\u305f`ARG`\u3084`ENV`\u306f\u3001docker-compose.yml \u306b\u66f8\u3044\u305f`args`\u3084`environment`\u3067\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3055\u308c\u308b\u3002\n\u3064\u307e\u308a\u53ef\u5909\u90e8\u5206\u306f docker-compose.yml \u3060\u3051\u66f8\u304d\u63db\u308c\u3070OK\u3002\u4fbf\u5229\u3002\n\n# \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u30db\u30b9\u30c8OS\u306b\u30de\u30a6\u30f3\u30c8\u3059\u308b\n\nConfluence\u306f\u521d\u56de\u30d6\u30e9\u30a6\u30b6\u30a2\u30af\u30bb\u30b9\u6642\u306b\u884c\u3046\u8a2d\u5b9a\u306e\u969b\u306b `/var/atlassian/application-data/confluence` \u4ee5\u4e0b\u306b\u30d5\u30a1\u30a4\u30eb\u7fa4\u304c\u751f\u6210\u3055\u308c\u308b\u3002\n\n\u3053\u306e\u30d5\u30a1\u30a4\u30eb\u7fa4\u3092\u524a\u9664\u3057\u305f\u72b6\u614b\u3067Confluence\u3092\u518d\u8d77\u52d5\u3057\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001\u307e\u305f\u521d\u671f\u8a2d\u5b9a\u753b\u9762\u306b\u306a\u308b\u3002\n\n\u305d\u306e\u70ba\u3001Docker\u30b3\u30f3\u30c6\u30ca\u3092\u7834\u68c4\u3057\u3066\u3082\u60c5\u5831\u304c\u5f15\u304d\u7d99\u304c\u308c\u308b\u3088\u3046\u306b\u3001\u3053\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u30db\u30b9\u30c8OS\u306b\u30de\u30a6\u30f3\u30c8\u3059\u308b\u3002\u5148\u7a0b\u306edocker-compose.yml\u306e\u672b\u5c3e\u304c\u305d\u306e\u8a2d\u5b9a\u306b\u8a72\u5f53\u3059\u308b\u3002\n\n```docker-compose.yml\n    volumes:\n      - ./data/confluence-home:/var/atlassian/application-data/confluence\n```\n\n\n# \u8d77\u52d5\u3057\u3066\u307f\u308b\n\n`$ docker-compose build && docker-compose up` \u3057\u3066 localhost\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u308b\u3002\n\n<img width=\"500\" alt=\"Screen Shot 2016-12-06 at 00.26.20.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/94332/752751f6-4ce9-e222-892c-79d0e66b6efa.png\">\n\n\u5f8c\u306f\u30e9\u30a4\u30bb\u30f3\u30b9\u30ad\u30fc\u3092\u5165\u308c\u305f\u308aDB\u8a2d\u5b9a\u3092\u3057\u305f\u308a\u3059\u308c\u3070Confluence\u304c\u4f7f\u3048\u308b\u3088\u3046\u306b\u306a\u308b\uff01\u3084\u3063\u305f\u306d\uff01\uff01\n\n# \u30aa\u30de\u30b1\n\n## PostgreSQL \u3082 Docker \u3067\u52d5\u304b\u3059\n\nConfluence\u3068PostgreSQL\u3092\u30ea\u30f3\u30af\u3055\u305b\u3064\u3064\u3001\u74b0\u5883\u5909\u6570\u3092\u6e21\u3059\u3060\u3051\u3067\u7c21\u5358\u306bDocker\u3067\u52d5\u304b\u3059\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\n```diff:docker-compose.yml\n19a20,21\n+     links:\n+       - postgres\n23a26,34\n+   postgres:\n+     build: ./postgres\n+     environment:\n+       POSTGRES_USER: postgres\n+       POSTGRES_PASSWORD: postgres\n+     ports:\n+       - '5432:5432'\n+     volumes:\n+       - ./data/postgres:/var/lib/postgresql/data\n```\n\n## Timezone\u3082\u53ef\u5909\u306b\u3059\u308b\n\nConfluence\u306e\u7de8\u96c6\u5c65\u6b74\u306e\u76f8\u5bfe\u6642\u523b\u8868\u793a\u306fOS\u306e\u30bf\u30a4\u30e0\u30be\u30fc\u30f3\u306b\u4f9d\u5b58\u3059\u308b\u306e\u3067Timezone\u3092Asia/Tokyo\u306b\u5909\u66f4\u3059\u308b\u3002\n\n```diff:confluence/Dockerfile\n@@ -8,6 +8,9 @@ ENV CONFLUENCE_CATALINA_MEM  1024\n ENV CONF_VERSION  5.10.8\n ENV JAVA_HOME           /usr/lib/jvm/java-8-openjdk-amd64/jre\n\n ARG CONFLUENCE_HOSTNAME=\"localhost\"\n+ARG TIMEZONE=\"Asia/Tokyo\"\n \n LABEL Description=\"This image is used to start Atlassian Confluence\" Vendor=\"Atlassian\" Version=\"${CONF_VERSION}\"\n\n ENV CONFLUENCE_DOWNLOAD_URL http://www.atlassian.com/software/confluence/downloads/binary/atlassian-confluence-${CONF_VERSION}.tar.gz\n@@ -51,6 +54,9 @@ RUN set -x \\\n                                           \"${CONFLUENCE_INSTALL}/conf/server.xml\" \\\n     && touch -d \"@0\"                      \"${CONFLUENCE_INSTALL}/conf/server.xml\"\n\n+# set timezone\n+RUN sed -i -e \"s|Etc/UTC|${TIMEZONE}|\" /etc/timezone\n```\n\n## IPA\u30b4\u30b7\u30c3\u30af\u3092\u30de\u30af\u30ed\u30bf\u30a4\u30c8\u30eb\u306b\u9069\u7528\u3059\u308b\n\n\u9806\u8abf\u306b\u52d5\u4f5c\u3057\u3066\u3044\u305f\u304b\u306b\u601d\u308f\u308c\u305fConfluence\u3060\u304c\u3001\u7de8\u96c6\u753b\u9762\u306e\u30de\u30af\u30ed\u306e\u30bf\u30a4\u30c8\u30eb\u90e8\u5206\u304c\u6587\u5b57\u5316\u3051\u3057\u3066\u3044\u305f\u3002\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/94332/938c509a-a32e-b383-29b8-23c0fd67db7a.png)\n\n\u3053\u3053\u306fIPA\u30b4\u30b7\u30c3\u30af\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066jre\u304b\u3089\u3082\u53c2\u7167\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u3002\n\n```diff:confluence/Dockerfile\n@@ -22,7 +23,7 @@ ENV RUN_GROUP           daemon\n # directory structure.\n RUN set -x \\\n     && apt-get update --quiet \\\n-    && apt-get install --quiet --yes --no-install-recommends libtcnative-1 xmlstarlet \\\n+    && apt-get install --quiet --yes --no-install-recommends libtcnative-1 xmlstarlet fonts-ipafont-gothic\\\n     && apt-get clean \\\n     && mkdir -p                           \"${CONFLUENCE_HOME}\" \\\n     && chmod -R 700                       \"${CONFLUENCE_HOME}\" \\\n\n\n+# add font for macro title\n+RUN mkdir -p \"${JAVA_HOME}/lib/fonts/fallback\"\n+RUN ln -s /usr/share/fonts/opentype/ipafont-gothic/ipag.ttf \"${JAVA_HOME}/lib/fonts/fallback/ipag.ttf\"\n```\n\n```diff:confluence/setenv.sh\n@@ -44,6 +44,9 @@ CATALINA_OPTS=\"-Djava.awt.headless=true ${CATALINA_OPTS}\"\n CATALINA_OPTS=\"-Datlassian.plugins.enable.wait=300 ${CATALINA_OPTS}\"\n CATALINA_OPTS=\"-Xms${CONFLUENCE_CATALINA_MEM}m -Xmx${CONFLUENCE_CATALINA_MEM}m -XX:+UseG1GC ${CATALINA_OPTS}\"\n\n+# For macro titles\n+CATALINA_OPTS=\"-Dconfluence.document.conversion.fontpath=${JAVA_HOME}/lib/fonts/fallback ${CATALINA_OPTS}\"\n+CATALINA_OPTS=\"-Dconfluence.document.conversion.slides.defaultfontname.regular=IPAGothic -Dconfluence.document.conversion.slides.defaultfontname.asian=IPAGothic -Dconfluence.do\n\n export CATALINA_OPTS\n```\n\n## PDF\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u304c\u9045\u3044\u554f\u984c\u3092\u89e3\u6c7a\u3059\u308b\n\nConfluence 5.10.8\u3067\u306fPDF\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u304c\u9045\u304f\u306a\u308b\u73fe\u8c61\u304c\u3042\u308b\u304c\u3001\u6050\u3089\u304f\u30ed\u30fc\u30ab\u30eb\u306e\u4e00\u6642\u30d5\u30a1\u30a4\u30eb\u3068\u3057\u3066\u51fa\u529b\u3057\u305fPDF\u30d5\u30a1\u30a4\u30eb\u3092\u30ea\u30af\u30a8\u30b9\u30c8\u5143\u306b\u8fd4\u3059\u969b\u306b\u4e0a\u624b\u304f\u3044\u3063\u3066\u306a\u3044\u3002 /etc/hosts \u306b\u81ea\u8eab\u306e\u30db\u30b9\u30c8\u540d\u3092\u66f8\u304f\u3068\u89e3\u6d88\u3059\u308b\u306e\u3067\u3053\u3061\u3089\u3082docker-compose.yml\u304b\u3089\u5bfe\u5fdc\u3059\u308b\u3002\n\n```diff:docker-compose.yml\n@@ -12,7 +12,10 @@ services:\n   confluence:\n     build: ./confluence\n     environment:\n       CONFLUENCE_HOSTNAME: \"www.example.com\"\n       CONFLUENCE_CATALINA_MEM: 2048\n+    extra_hosts:\n+      - \"www.example.com:127.0.0.1\"\n     ports:\n       - '8090:8090'\n     volumes:\n```\n\n\u3053\u306e\u3088\u3046\u306b\u3057\u3066\u304a\u3044\u3066\u3001\u5404\u81ea\u306e\u74b0\u5883\u3067 `:%s/www\\.example\\.com/<\u4efb\u610f\u306e\u30c9\u30e1\u30a4\u30f3>/`\u306b\u7f6e\u63db\u3059\u308c\u3070confluence\u30b3\u30f3\u30c6\u30ca\u306e /etc/hosts/ \u306bextra_hosts\u306b\u66f8\u3044\u305f\u5185\u5bb9\u304c\u8ffd\u8a18\u3055\u308c\u308b\u3002\n\n[Compose file reference - Docker](https://docs.docker.com/compose/compose-file/#/extrahosts)\n\n# \u6ce8\u610f\u4e8b\u9805\n\n[atlassian/confluence-server - Docker Hub](https://hub.docker.com/r/atlassian/confluence-server/)\n\n\u306b\u3082\u8a18\u8f09\u3055\u308c\u3066\u3044\u308b\u304c\u3001OpenJDK\u306fConfluence\u306e\u30b5\u30dd\u30fc\u30c8\u5bfe\u8c61\u5916\u3068\u306a\u3063\u3066\u3044\u308b\u3002\n\n\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u308bJava\u74b0\u5883\u306fOracle JDK\u3060\u304c\u3001\u30e9\u30a4\u30bb\u30f3\u30b9\u4e0a\u518d\u914d\u5e03\u4e0d\u53ef\u3068\u306a\u3063\u3066\u3044\u308b\u306e\u3067\u3001Oracle JDK\u74b0\u5883\u3067\u52d5\u4f5c\u3055\u305b\u308b\u306b\u306f\u3001\u5404\u81ea\u3067Oracle JDK\u306eDocker\u30a4\u30e1\u30fc\u30b8\u3092\u69cb\u7bc9\u3057\u3001\u305d\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u53c2\u7167\u3057\u3066Confluence\u30a4\u30e1\u30fc\u30b8\u3092\u69cb\u7bc9\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n[Update the Confluence Docker image to use Oracle JDK - Atlassian Documentation](https://confluence.atlassian.com/confkb/update-the-confluence-docker-image-to-use-oracle-jdk-829062521.html) \n\n# \u3006\n\n\u8af8\u3005\u8e93\u304f\u6240\u304c\u3042\u3063\u305f\u304c\u3001\u7121\u4e8b\u306bDocker Compose\u3067Confluence\u3092\u69cb\u7bc9\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3057\u305f\u3002\n\n\u4e0a\u8a18\u306eDocker\u74b0\u5883\u306fGitHub\u306b\u3082\u516c\u958b\u3057\u3066\u304a\u308a\u307e\u3059(OpenJDK\u3067\u3059)\u3002\n[shinespark/docker-confluence: GitHub](https://github.com/shinespark/docker-confluence)\n\n\u597d\u307f\u306e\u74b0\u5883\u306b\u3042\u308f\u305b\u3066docker-compose.yml\u306e\u30db\u30b9\u30c8\u540d\u3060\u3051\u66f8\u304d\u63db\u3048\u3066 `$ docker-compose up` \u3059\u308c\u3070\u307b\u307c\u554f\u984c\u306a\u304f\u5229\u7528\u53ef\u80fd\u3067\u3059\u3002PR\u6b53\u8fce\u3057\u3066\u3044\u307e\u3059\u3002\n", "tags": ["docker", "docker-compose", "confluence", "Atlassian"]}