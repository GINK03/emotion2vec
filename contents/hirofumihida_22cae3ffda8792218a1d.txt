{"context": "\n\nmd raid \u306e\u30e1\u30f3\u30c6\u30e1\u30e2\n\n\u76ee\u7684:\n\n\u500b\u4eba\u7528\u306e\u5099\u5fd8\u9332\n\u500b\u4eba\u7528\u306e\u4f5c\u696d\u624b\u9806\n\n\n\u5bfe\u8c61:\n\n\u81ea\u5206\nmd raid \u5229\u7528\u8005\n\u53e4\u3044 Disk \u304c\u983b\u7e41\u306b Fail \u3059\u308b\u3088\u3046\u306a\u74b0\u5883\n\n\n\u74b0\u5883:\n\nOS: Ubuntu14.04 Server\nDisk: SATA HDDs\n\n# mdadm --version\nmdadm - v3.2.5 - 18th May 2012\n\nsmartctl 6.2 2013-07-26 r3841 [x86_64-linux-3.13.0-29-generic] (local build)\n\n\n\u624b\u9806:\n\n1. Fail \u3057\u305f Disk \u306e\u78ba\u8a8d\u65b9\u6cd5\n\n1-1. syslog \u304b\u3089\n# grep -P 'md\\d*:.*disabling' /var/log/syslog*\n/var/log/syslog.1:Sep 25 16:15:24 fs2 kernel: [25914184.413892] md/raid1:md1: Disk failure on sda3, disabling device.\n/var/log/syslog.1:Sep 25 19:00:10 fs2 kernel: [25924078.611045] md/raid1:md2: Disk failure on sda5, disabling device.\n\n\n1-2. proc \u304b\u3089\n# cat /proc/mdstat | grep '(F)'\nmd2 : active raid1 sda5[0](F) sdc5[2]\nmd1 : active raid1 sda3[3](F) sdc3[2]\n\n\nmd1 \u306e sda3 \u3068\nmd2 \u306e sda5 \u304c raid \u304b\u3089\u5207\u308a\u96e2\u3055\u308c\u305f\u3053\u3068\u304c\u5206\u304b\u308b\n\n\n2. Disk \u306e\u72b6\u614b\u78ba\u8a8d\n\n2-1. fdisk \u3067\u898b\u3048\u308b\u304b?\n# fdisk -l /dev/sda\n\nDisk /dev/sda: 2000.4 GB, 2000398934016 bytes\n255 heads, 63 sectors/track, 243201 cylinders, total 3907029168 sectors\nUnits = sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\nDisk identifier: 0x00070f5f\n(snip)\n/dev/sda3        16209920    35741695     9765888   fd  Linux raid autodetect\n/dev/sda5        35743744    74803199    19529728   fd  Linux raid autodetect\n(snip)\n\n\n2-2. S.M.A.R.T \u60c5\u5831\n# smartctl --all /dev/sda\n\n# smartctl --attributes /dev/sda\n\n# smartctl --attributes /dev/sda | grep -E \"_Err|Unco|Power_On_Hours|Temperature_Celsius\"\n  1 Raw_Read_Error_Rate     0x002f   154   154   051    Pre-fail  Always       -       79071\n  7 Seek_Error_Rate         0x002e   200   200   000    Old_age   Always       -       0\n  9 Power_On_Hours          0x0032   063   063   000    Old_age   Always       -       27525\n194 Temperature_Celsius     0x0022   110   090   000    Old_age   Always       -       40\n198 Offline_Uncorrectable   0x0030   200   196   000    Old_age   Offline      -       100\n199 UDMA_CRC_Error_Count    0x0032   200   200   000    Old_age   Always       -       0\n200 Multi_Zone_Error_Rate   0x0008   001   001   000    Old_age   Offline      -       125766\n\n\n3. RAID \u304b\u3089\u306e\u5207\u308a\u96e2\u3057\n\n3-1. \u5207\u308a\u96e2\u3057\n# mdadm /dev/md1 --remove /dev/sda3\nmdadm: hot removed /dev/sda3 from /dev/md1\n\n# mdadm /dev/md2 --remove /dev/sda5\nmdadm: hot removed /dev/sda5 from /dev/md2\n\n\n3-2. \u5207\u308a\u96e2\u3057\u78ba\u8a8d\n# mdadm --detail /dev/md1\n(snip)\n    Number   Major   Minor   RaidDevice State\n       0       0        0        0      removed\n       2       8       35        1      active sync   /dev/sdc3\n\n# mdadm --detail /dev/md2\n(snip)\n    Number   Major   Minor   RaidDevice State\n       0       0        0        0      removed\n       2       8       37        1      active sync   /dev/sdc5\n\n\nsyslog\nSep 27 00:57:44 fs2 kernel: [26032025.115138] md: unbind<sda3>\nSep 27 00:57:44 fs2 kernel: [26032025.133178] md: export_rdev(sda3)\nSep 27 00:58:08 fs2 kernel: [26032048.442038] md: unbind<sda5>\nSep 27 00:58:08 fs2 kernel: [26032048.460046] md: export_rdev(sda5)\n\n\n\n4. fdisk (if needed)\n\n5. RAID \u306b\u3082\u3069\u3059\n\n5-1. \u3082\u3069\u3057\n# mdadm --manage  /dev/md1 --add /dev/sda3\nmdadm: added /dev/sda3\n\n# mdadm --manage  /dev/md2 --add /dev/sda5\nmdadm: added /dev/sda5\n\n\n5-2. \u3082\u3069\u3057\u78ba\u8a8d\n\nrebuilded\n# mdadm --detail /dev/md1\n(snip)\n    Number   Major   Minor   RaidDevice State\n       3       8        3        0      active sync   /dev/sda3\n       2       8       35        1      active sync   /dev/sdc3\n\n\n\nrebuilding\n# mdadm --detail /dev/md2\n(snip)\n    Number   Major   Minor   RaidDevice State\n       3       8        5        0      spare rebuilding   /dev/sda5\n       2       8       37        1      active sync   /dev/sdc5\n\n\n\nsyslog\nSep 27 01:16:27 fs2 kernel: [26033148.773364] md: recovery of RAID array md1\nSep 27 01:16:27 fs2 kernel: [26033148.773374] md: using maximum available idle IO bandwidth (but not more than 200000 KB/sec) for recovery.\nSep 27 01:16:33 fs2 kernel: [26033154.668741] md: delaying recovery of md2 until md1 has finished (they share one or more physical units)\nSep 27 01:17:49 fs2 kernel: [26033230.326188] md: md1: recovery done.\nSep 27 01:17:49 fs2 kernel: [26033230.339303] md: recovery of RAID array md2\nSep 27 01:17:49 fs2 kernel: [26033230.339311] md: using maximum available idle IO bandwidth (but not more than 200000 KB/sec) for recovery.\nSep 27 01:20:29 fs2 kernel: [26033390.864021] md: md2: recovery done.\n\n\n\nproc\n# cat /proc/mdstat\nmd1 : active raid1 sda3[3] sdc3[2]\n      9757568 blocks super 1.2 [2/2] [UU]\n(snip)\nmd2 : active raid1 sda5[3] sdc5[2]\n      19513216 blocks super 1.2 [2/2] [UU]\n\n\n\n6. \u624b\u52d5\u3067 Fail \u306b\u3057\u3066 Remove \u3059\u308b\u5834\u5408\nroot@fs2:~# mdadm --detail /dev/md2\n(snip)\n    Number   Major   Minor   RaidDevice State\n       3       8        5        0      active sync   /dev/sda5\n       2       8       37        1      active sync   /dev/sdc5\n\nroot@fs2:~# mdadm /dev/md2 --fail /dev/sda5\nmdadm: set /dev/sda5 faulty in /dev/md2\n\nroot@fs2:~# mdadm /dev/md2 --remove /dev/sda5\nmdadm: hot removed /dev/sda5 from /dev/md2\n\nroot@fs2:~# mdadm --detail /dev/md2\n(snip)\n    Number   Major   Minor   RaidDevice State\n       0       0        0        0      removed\n       2       8       37        1      active sync   /dev/sdc5\n\n\n7. \u304a\u308f\u308a\n# md raid \u306e\u30e1\u30f3\u30c6\u30e1\u30e2\n\n## \u76ee\u7684:\n\n* \u500b\u4eba\u7528\u306e\u5099\u5fd8\u9332\n* \u500b\u4eba\u7528\u306e\u4f5c\u696d\u624b\u9806\n\n## \u5bfe\u8c61:\n\n* \u81ea\u5206\n* md raid \u5229\u7528\u8005\n* \u53e4\u3044 Disk \u304c\u983b\u7e41\u306b Fail \u3059\u308b\u3088\u3046\u306a\u74b0\u5883\n\n## \u74b0\u5883:\n\n* OS: Ubuntu14.04 Server\n* Disk: SATA HDDs\n\n```shell-session\n# mdadm --version\nmdadm - v3.2.5 - 18th May 2012\n```\n```shell-session\nsmartctl 6.2 2013-07-26 r3841 [x86_64-linux-3.13.0-29-generic] (local build)\n```\n\n## \u624b\u9806:\n\n### 1. Fail \u3057\u305f Disk \u306e\u78ba\u8a8d\u65b9\u6cd5\n\n#### 1-1. syslog \u304b\u3089\n\n```shell-session\n# grep -P 'md\\d*:.*disabling' /var/log/syslog*\n/var/log/syslog.1:Sep 25 16:15:24 fs2 kernel: [25914184.413892] md/raid1:md1: Disk failure on sda3, disabling device.\n/var/log/syslog.1:Sep 25 19:00:10 fs2 kernel: [25924078.611045] md/raid1:md2: Disk failure on sda5, disabling device.\n```\n\n#### 1-2. proc \u304b\u3089\n\n```shell-session\n# cat /proc/mdstat | grep '(F)'\nmd2 : active raid1 sda5[0](F) sdc5[2]\nmd1 : active raid1 sda3[3](F) sdc3[2]\n```\n\n> md1 \u306e sda3 \u3068\n> md2 \u306e sda5 \u304c raid \u304b\u3089\u5207\u308a\u96e2\u3055\u308c\u305f\u3053\u3068\u304c\u5206\u304b\u308b\n\n### 2. Disk \u306e\u72b6\u614b\u78ba\u8a8d\n\n#### 2-1. fdisk \u3067\u898b\u3048\u308b\u304b?\n\n```shell-session\n# fdisk -l /dev/sda\n\nDisk /dev/sda: 2000.4 GB, 2000398934016 bytes\n255 heads, 63 sectors/track, 243201 cylinders, total 3907029168 sectors\nUnits = sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\nDisk identifier: 0x00070f5f\n(snip)\n/dev/sda3        16209920    35741695     9765888   fd  Linux raid autodetect\n/dev/sda5        35743744    74803199    19529728   fd  Linux raid autodetect\n(snip)\n```\n\n#### 2-2. S.M.A.R.T \u60c5\u5831\n\n```shell-session\n# smartctl --all /dev/sda\n```\n```shell-session\n# smartctl --attributes /dev/sda\n```\n```shell-session\n# smartctl --attributes /dev/sda | grep -E \"_Err|Unco|Power_On_Hours|Temperature_Celsius\"\n  1 Raw_Read_Error_Rate     0x002f   154   154   051    Pre-fail  Always       -       79071\n  7 Seek_Error_Rate         0x002e   200   200   000    Old_age   Always       -       0\n  9 Power_On_Hours          0x0032   063   063   000    Old_age   Always       -       27525\n194 Temperature_Celsius     0x0022   110   090   000    Old_age   Always       -       40\n198 Offline_Uncorrectable   0x0030   200   196   000    Old_age   Offline      -       100\n199 UDMA_CRC_Error_Count    0x0032   200   200   000    Old_age   Always       -       0\n200 Multi_Zone_Error_Rate   0x0008   001   001   000    Old_age   Offline      -       125766\n```\n\n### 3. RAID \u304b\u3089\u306e\u5207\u308a\u96e2\u3057\n\n#### 3-1. \u5207\u308a\u96e2\u3057\n\n```shell-session\n# mdadm /dev/md1 --remove /dev/sda3\nmdadm: hot removed /dev/sda3 from /dev/md1\n\n# mdadm /dev/md2 --remove /dev/sda5\nmdadm: hot removed /dev/sda5 from /dev/md2\n```\n\n#### 3-2. \u5207\u308a\u96e2\u3057\u78ba\u8a8d\n\n```shell-session\n# mdadm --detail /dev/md1\n(snip)\n    Number   Major   Minor   RaidDevice State\n       0       0        0        0      removed\n       2       8       35        1      active sync   /dev/sdc3\n```\n```shell-session\n# mdadm --detail /dev/md2\n(snip)\n    Number   Major   Minor   RaidDevice State\n       0       0        0        0      removed\n       2       8       37        1      active sync   /dev/sdc5\n```\n```shell-session:syslog\nSep 27 00:57:44 fs2 kernel: [26032025.115138] md: unbind<sda3>\nSep 27 00:57:44 fs2 kernel: [26032025.133178] md: export_rdev(sda3)\nSep 27 00:58:08 fs2 kernel: [26032048.442038] md: unbind<sda5>\nSep 27 00:58:08 fs2 kernel: [26032048.460046] md: export_rdev(sda5)\n```\n\n### 4. fdisk (if needed)\n\n### 5. RAID \u306b\u3082\u3069\u3059\n\n#### 5-1. \u3082\u3069\u3057\n\n```shell-session\n# mdadm --manage  /dev/md1 --add /dev/sda3\nmdadm: added /dev/sda3\n\n# mdadm --manage  /dev/md2 --add /dev/sda5\nmdadm: added /dev/sda5\n```\n\n#### 5-2. \u3082\u3069\u3057\u78ba\u8a8d\n\n```shell-session:rebuilded\n# mdadm --detail /dev/md1\n(snip)\n    Number   Major   Minor   RaidDevice State\n       3       8        3        0      active sync   /dev/sda3\n       2       8       35        1      active sync   /dev/sdc3\n```\n```shell-session:rebuilding\n# mdadm --detail /dev/md2\n(snip)\n    Number   Major   Minor   RaidDevice State\n       3       8        5        0      spare rebuilding   /dev/sda5\n       2       8       37        1      active sync   /dev/sdc5\n```\n```shell-session:syslog\nSep 27 01:16:27 fs2 kernel: [26033148.773364] md: recovery of RAID array md1\nSep 27 01:16:27 fs2 kernel: [26033148.773374] md: using maximum available idle IO bandwidth (but not more than 200000 KB/sec) for recovery.\nSep 27 01:16:33 fs2 kernel: [26033154.668741] md: delaying recovery of md2 until md1 has finished (they share one or more physical units)\nSep 27 01:17:49 fs2 kernel: [26033230.326188] md: md1: recovery done.\nSep 27 01:17:49 fs2 kernel: [26033230.339303] md: recovery of RAID array md2\nSep 27 01:17:49 fs2 kernel: [26033230.339311] md: using maximum available idle IO bandwidth (but not more than 200000 KB/sec) for recovery.\nSep 27 01:20:29 fs2 kernel: [26033390.864021] md: md2: recovery done.\n```\n```shell-session:proc\n# cat /proc/mdstat\nmd1 : active raid1 sda3[3] sdc3[2]\n      9757568 blocks super 1.2 [2/2] [UU]\n(snip)\nmd2 : active raid1 sda5[3] sdc5[2]\n      19513216 blocks super 1.2 [2/2] [UU]\n```\n\n### 6. \u624b\u52d5\u3067 Fail \u306b\u3057\u3066 Remove \u3059\u308b\u5834\u5408\n\n```shell-session\nroot@fs2:~# mdadm --detail /dev/md2\n(snip)\n    Number   Major   Minor   RaidDevice State\n       3       8        5        0      active sync   /dev/sda5\n       2       8       37        1      active sync   /dev/sdc5\n\nroot@fs2:~# mdadm /dev/md2 --fail /dev/sda5\nmdadm: set /dev/sda5 faulty in /dev/md2\n\nroot@fs2:~# mdadm /dev/md2 --remove /dev/sda5\nmdadm: hot removed /dev/sda5 from /dev/md2\n\nroot@fs2:~# mdadm --detail /dev/md2\n(snip)\n    Number   Major   Minor   RaidDevice State\n       0       0        0        0      removed\n       2       8       37        1      active sync   /dev/sdc5\n```\n\n### 7. \u304a\u308f\u308a\n\n\n", "tags": ["Linux", "RAID", "mdadm", "Ubuntu14.04"]}