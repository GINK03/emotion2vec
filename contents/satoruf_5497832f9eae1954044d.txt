{"tags": ["CoreOS", "etcd", "fleet"], "context": " More than 1 year has passed since last update.Vagrant/VirtualBox\u3084AWS\u7b49\u306e\u30d1\u30d6\u30ea\u30c3\u30af\u30af\u30e9\u30a6\u30c9\u74b0\u5883\u3067\u306e\u60c5\u5831\u306f\u3044\u308d\u3044\u308d\u3042\u3063\u305f\u3093\u3067\u3059\u304c\u3001\u30ed\u30fc\u30ab\u30eb\u306eVM\u3067\u69cb\u7bc9\u3059\u308b\u5834\u5408\u306e\u60c5\u5831\u304c\u5c11\u306a\u304b\u3063\u305f\u306e\u3067\u307e\u3068\u3081\u3066\u304a\u304d\u307e\u3059\u3002\u9593\u9055\u3044\u3084\u4ed6\u306b\u3082\u3063\u3068\u3044\u3044\u65b9\u6cd5\u304c\u3042\u308c\u3070\u3001\u662f\u975e\u30b3\u30e1\u30f3\u30c8\u304f\u3060\u3055\u3044\u3002\n\u3053\u3053\u3067\u306fCoreOS/etcd/fleet\u306e\u8a73\u7d30\u306f\u8aac\u660e\u3057\u306a\u3044\u306e\u3067\u3001mopemope\u3055\u3093\u306ehttp://qiita.com/mopemope/items/fa9424b094aae3eac580\n\u306a\u3069\u3092\u53c2\u7167\u3057\u3066\u4e0b\u3055\u3044\u3002\n\n\u69cb\u7bc9\u74b0\u5883\n\u4e0b\u8a18KVM\u30db\u30b9\u30c8\uff11\u53f0\u306e\u4e0a\u306b\u3001\uff14VM\u3092\u4f5c\u6210\u3001CoreOS\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3001etcd/fleet\u306e\u30af\u30e9\u30b9\u30bf\u3092\u69cb\u7bc9\u3057\u305f\u3002\n\nKVM\u30db\u30b9\u30c8: CentOS6.5, openQRM5.1\nCoreOS: 410.1.0 STABLE, etcd version 0.4.6, fleet version 0.6.2\n\n\nCoreOS\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u4f7f\u7528\u3057\u305f\u74b0\u5883\u3067\u306f\u65e2\u306bopenQRM\u304c\u7ba1\u7406\u3059\u308bdhcp/pxe\u30b5\u30fc\u30d0\u304c\u7a3c\u50cd\u3057\u3066\u304a\u308a\u3001Booting CoreOS via PXE\u306f\u4f7f\u3048\u306a\u3044\u306e\u3067\u3001Booting CoreOS from an ISO\u304b\u3089ISO\u30a4\u30e1\u30fc\u30b8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3001ISO\u30a4\u30e1\u30fc\u30b8\u304b\u3089VM\u3092\u8d77\u52d5\u3057\u305f\u3002\nvnc\u7b49\u3067\u30b3\u30f3\u30bd\u30fc\u30eb\u3092\u958b\u304f\u3068core\u30e6\u30fc\u30b6\u3067\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u308b\u304c\u3001vnc\u3067\u306f\u4f55\u304b\u3068\u4e0d\u4fbf\u306a\u306e\u3067\u3001PC\u304b\u3089ssh\u3067\u304d\u308b\u3088\u3046\u306b\u4eee\u306b\u30d1\u30b9\u30ef\u30fc\u30c9\u8a2d\u5b9a\u3092\u884c\u3046\u3002\n$ sudo passwd core\n\n\u8d77\u52d5\u3057\u305f\u72b6\u614b\u3067\u306f\u30e1\u30e2\u30ea\u4e0a\u306b\u30b7\u30b9\u30c6\u30e0\u304c\u5c55\u958b\u3055\u308c\u3066\u304a\u308a\u3001\u30ed\u30fc\u30ab\u30eb\u30c7\u30a3\u30b9\u30af\u306bCoreOS\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3084\u308b\u5fc5\u8981\u304c\u3042\u308b\u306e\u3067\u3001Installing CoreOS to Disk\u306b\u5f93\u3044\u3001\u307e\u305acloud-config\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n\u4f5c\u6210\u3057\u305fcloud-config\u30d5\u30a1\u30a4\u30eb\u306f\u3001core\u30e6\u30fc\u30b6\u306e\u30db\u30fc\u30e0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u76f4\u4e0b\u306b cloud-config.yaml \u3068\u540d\u4ed8\u3051\u3066\u4fdd\u5b58\u3057\u3001\u4e0b\u8a18\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3002\n$ sudo coreos-install -d /dev/vda -C stable -c ~/cloud-config.yaml\n\n-d /dev/vda \u306f\u3001\u4f7f\u7528\u74b0\u5883\u306b\u5408\u308f\u305b\u305f\u8d77\u52d5\u30c7\u30a3\u30b9\u30af\u306e\u30c7\u30d0\u30a4\u30b9\u540d(/dev/sda\u7b49)\u3092\u6307\u5b9a\u3059\u308b\u3002\n-C stable \u306f\u3001\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308bCoreOS\u306e\u30c1\u30e3\u30cd\u30eb(stable/beta/alpha)\u3092\u6307\u5b9a\u3059\u308b\u3002\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305fVM\u30a4\u30e1\u30fc\u30b8\u3092\u30af\u30ed\u30fc\u30f3\u3057\u305f\u5834\u5408\u3001 machine-id \u304c\u91cd\u8907\u3057\u3066fleet\u304c\u52d5\u304b\u306a\u304f\u306a\u308b\u306e\u3067\u3001 machine-id \u30d5\u30a1\u30a4\u30eb\u3092\u524a\u9664\u3057\u3066\u518d\u8d77\u52d5\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\n$ sudo rm /etc/machine-id\n$ sudo systemctl reboot\n\n\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u306f\u300c\u30b4\u30fc\u30eb\u30c7\u30f3\u30a4\u30e1\u30fc\u30b8\u300d\u3092\u4f5c\u6210\u3059\u308b\u5834\u5408\u306f\u3001/usr/share/OEM/\u30c7\u30a4\u30ec\u30af\u30c8\u30ea\u3092\u4f7f\u7528\u3059\u308b\u3079\u304d\u3068\u304b\u66f8\u3044\u3066\u3042\u3063\u305f\u304c\u3001\u8abf\u3079\u304d\u308c\u305a\u3002\n\ncloud-config\u30d5\u30a1\u30a4\u30eb\u306e\u8a18\u8ff0\u65b9\u6cd5\nUsing Cloud-Config\u306b\u3042\u308b\u3088\u3046\u306b\u3001cloud-config\u30d5\u30a1\u30a4\u30eb\u306f\u5fc5\u305a #cloud-config \u3092\u542b\u307f\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30ad\u30fc\u3092\u5fc5\u8981\u306b\u5fdc\u3058\u3066\u5b9a\u7fa9\u3059\u308b\u3002\n\ncoreos\nssh_authorized_keys\nhostname\nusers\nunits\nwrite_files\nmanage_etc_hosts\n\n\n(1) ssh\u8a2d\u5b9a\n\u7d76\u5bfe\u306b\u8a2d\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u306e\u306f\u3001 ssh_authorized_keys \u3068 users \u3067\u3042\u308b\u3002\nCoreOS\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u3067ssh\u304c\u516c\u958b\u9375\u8a8d\u8a3c\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u3067\u3001\u3061\u3083\u3093\u3068\u8a2d\u5b9a\u3057\u306a\u3044\u3068\u8d77\u52d5\u3057\u3066\u3082\u63a5\u7d9a\u3067\u304d\u306a\u3044\u3067\u304f\u306e\u307c\u3046VM\u306b\u306a\u308b\u3002\n\u516c\u958b\u9375\u8a8d\u8a3c\u3092\u4f7f\u3046\u5834\u5408\u306f\u3001ssh-keygen\u30b3\u30de\u30f3\u30c9\u7b49\u3067\u4f5c\u6210\u3057\u305f\u516c\u958b\u9375\u306e\u5185\u5bb9\u3092\u4e0b\u8a18\u306e\u3088\u3046\u306bcloud-config\u30d5\u30a1\u30a4\u30eb\u306b\u8a18\u8f09\u3059\u308b\u3002\n#cloud-config\n\nusers:\n  - name: core\nssh_authorized_keys:\n  - ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAweXfI2dW0jrWU....\n\n\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\u306f\u3001\u30cf\u30c3\u30b7\u30e5\u5316\u3055\u308c\u305f\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u4f5c\u6210\u3057\u3001\n\ncore@core001 ~ $ openssl passwd -1\nPassword:\nVerifying - Password:\n$1$IlTQkYPg$fndQiTnrMN.....\n\n\u4e0b\u8a18\u306e\u3088\u3046\u306bcloud-config\u30d5\u30a1\u30a4\u30eb\u306b\u8a18\u8f09\u3059\u308b\u3002\n#cloud-config\n\nusers:\n  - name: core\n    passwd: $1$IlTQkYPg$fndQiTnrMN.....\nssh_authorized_keys:\n  - ssh-rsa AAAAB3NzaC1yc2....\n\n\n(2) etcd\u8a2d\u5b9a\n\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u4f8b\u3092\u898b\u308b\u3068\n#cloud-config\n\ncoreos:\n    etcd:\n        name: node001\n    # generate a new token for each unique cluster from https://discovery.etcd.io/new\n        discovery: https://discovery.etcd.io/<token>\n    # multi-region and multi-cloud deployments need to use $public_ipv4\n        addr: $public_ipv4:4001\n        peer-addr: $private_ipv4:7001\n\n\u306e\u3088\u3046\u306b\u3055\u3089\u3063\u3068\u66f8\u3044\u3066\u3042\u308b\u304c\u3001\u3053\u3053\u3067\u30cf\u30de\u3063\u305f\u306e\u3067\u8a73\u3057\u304f\u66f8\u3044\u3066\u307f\u3088\u3046\u3002\nname: \u30ce\u30fc\u30c9\u540d\u3092\u6307\u5b9a\u3057\u305f\u3044\u5834\u5408\u306f\u3053\u3053\u306b\u66f8\u304f\u304c\u3001\u6307\u5b9a\u3057\u306a\u3051\u308c\u3070\u52dd\u624b\u306b\u751f\u6210\u3055\u308c\u308b\u3002\ndiscovery:  etcd\u306f\u3001\u30b7\u30b9\u30c6\u30e0\u8d77\u52d5\u6642\u306b\u6240\u5c5e\u3059\u308b\u30af\u30e9\u30b9\u30bf\u30e1\u30f3\u30d0\u3092 data-dir\u8a2d\u5b9a\u3067\u6307\u5b9a\u3055\u308c\u305f\u30ed\u30b0\u30c7\u30fc\u30bf\u3001 discovery\u8a2d\u5b9a\u3001 peers\u8a2d\u5b9a\u306e\u9806\u3067\u691c\u7d22\u3059\u308b\u3002\uff08Cluster Finding Process\uff09\ndata-dir\u8a2d\u5b9a\u306f\u3001\n\n$./etcd -name <name> [-data-dir=<path>]\n\n\u306e\u3088\u3046\u306b\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u3067etcd\u8d77\u52d5\u3059\u308b\u5834\u5408\u306b\u4f7f\u7528\u3067\u304d\u308b\u304c\u3001discovery\u8a2d\u5b9a\u3001\u307e\u305f\u306fpeers\u8a2d\u5b9a\u3092\u3057\u3066\u3044\u306a\u3051\u308c\u3070\u3001\u30ce\u30fc\u30c9\u8ffd\u52a0\u6642\u306b\u65e2\u5b58\u30af\u30e9\u30b9\u30bf\u306b\u53c2\u52a0\u3067\u304d\u306a\u3044\u3002\ndiscovery: \u30ad\u30fc\u306b\u8a18\u8f09\u3059\u308b\u306e\u306f\u3001etcd\u30af\u30e9\u30b9\u30bf\u30e1\u30f3\u30d0\u4ee5\u5916\u306eetcd\u30b5\u30fc\u30d0\u304cdiscovery\u30b5\u30fc\u30d3\u30b9\u3092\u63d0\u4f9b\u3057\u3066\u3044\u308b\u5834\u5408\u3001\u305d\u306eURL\u3092\u8a18\u8f09\u3059\u308b\u3002discovery\u30b5\u30fc\u30d3\u30b9\u3092\u4f7f\u7528\u3059\u308b\u30e1\u30ea\u30c3\u30c8\u306f\u3001\u30af\u30e9\u30b9\u30bf\u8ffd\u52a0\uff0f\u524a\u9664\u6642\u306e\u5404\u30af\u30e9\u30b9\u30bf\u30e1\u30f3\u30d0\u500b\u5225\u306e\u8a2d\u5b9a\u304c\u4e0d\u8981\u3067\u3042\u308b\u70b9\u3060\u304c\u3001\u30af\u30e9\u30b9\u30bf\u30e1\u30f3\u30d0\u5916\u306betcd\u30b5\u30fc\u30d0\u304c\u5fc5\u8981\u3067\u3042\u308a\u3001\u672c\u756a\u7cfb\u3067\u306f\u969c\u5bb3\u5bfe\u7b56\u3092\u8003\u616e\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002 https://discovery.etcd.io/ \u306e\u30b5\u30fc\u30d3\u30b9\u306f\u30b0\u30ed\u30fc\u30d0\u30eb\u30a2\u30c9\u30ec\u30b9\u3092\u6301\u3063\u305fetcd\u30af\u30e9\u30b9\u30bf\u3067\u306a\u3044\u3068\u4f7f\u7528\u3067\u304d\u306a\u3044\u3002\u4eca\u56de\u306fdiscovery\u30b5\u30fc\u30d3\u30b9\u7528\u306betcd\u30b5\u30fc\u30d0\u3092\u4e00\u53f0\u305f\u3066\u3066\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u6307\u5b9a\u3057\u305f\u3002\n\ndiscovery: http://192.168.0.1:4001/v2/keys/test_cluster\n\ntest_cluster \u306f\u30af\u30e9\u30b9\u30bf\u8b58\u5225\u306e\u305f\u3081\u306e\u4efb\u610f\u306e\u30ad\u30fc\u540d\u3067\u826f\u3044\u3002\npeers\u8a2d\u5b9a\u306f\u3001discovery\u30b5\u30fc\u30d3\u30b9\u3092\u4f7f\u7528\u3057\u306a\u3044\u3067\u3001\u30af\u30e9\u30b9\u30bf\u30e1\u30f3\u30d0\u3092\u660e\u793a\u7684\u306b\u6307\u5b9a\u3067\u304d\u3001etcd\u30af\u30e9\u30b9\u30bf\u30e1\u30f3\u30d0\u4ee5\u5916\u306e\u30b5\u30fc\u30d0\u306f\u5fc5\u8981\u306a\u3044\u3002\u3057\u304b\u3057\u30af\u30e9\u30b9\u30bf\u30e1\u30f3\u30d0\u5168\u3066\u3067\u500b\u5225\u306e\u8a2d\u5b9a\u304c\u5fc5\u8981\u306a\u305f\u3081\u3001\u6570\u53f0\u7a0b\u5ea6\u306e\u30af\u30e9\u30b9\u30bf\u3067\u3042\u308c\u3070\u8a2d\u5b9a\u306f\u7c21\u5358\u3060\u304c\u3001\u5927\u898f\u6a21\u306b\u306a\u308b\u3068\u904b\u7528\u7684\u306b\u7121\u7406\u3067\u3042\u308d\u3046\u3002\u8a2d\u5b9a\u306f\u3001\u81ea\u5206\u81ea\u8eab\u4ee5\u5916\u306e\u30af\u30e9\u30b9\u30bf\u30e1\u30f3\u30d0\u3092\u4e0b\u8a18\u306e\u3088\u3046\u306b\u30b3\u30f3\u30de\u3067\u3064\u306a\u3044\u3067\u6307\u5b9a\u3059\u308b\u3002\n\npeers: 192.168.0.2:7001,192.168.0.3:7001\n\naddr: \u3068 peer-addr: \u3000etcd\u901a\u4fe1\u306e\u305f\u3081\u306b\u7a3c\u50cd\u30ce\u30fc\u30c9\u306eIP\u30a2\u30c9\u30ec\u30b9\u3068\u30dd\u30fc\u30c8\u3092\u6307\u5b9a\u3059\u308b\u3002$public_ipv4\u3068$private_ipv4\u306f\u3001 Amazon EC2, Google Compute Engine, OpenStack, Rackspace, DigitalOcean, Vagrant\u3067\u3057\u304b\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u3066\u3044\u306a\u3044\u74b0\u5883\u5909\u6570\u306e\u305f\u3081\u3001\u4eca\u56de\u306f\u76f4\u63a5IP\u30a2\u30c9\u30ec\u30b9\u3092\u8a18\u8f09\u3057\u305f\u3002\n#cloud-config\n\ncoreos:\n  etcd:\n    discovery: http://192.168.0.1:4001/v2/keys/test_cluster\n    addr: 192.168.0.2:4001\n    peer-addr: 192.168.0.2:7001\n\ncloud-config\u30d5\u30a1\u30a4\u30eb\u3092\u30ce\u30fc\u30c9\u6bce\u306b\u5909\u66f4\u3057\u305f\u304f\u306a\u3044\u304c\u3001CoreOS\u306eCloud-init\u306f bootcmd \u3084 runcmd \u3092\u307e\u3060\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u3044\u306a\u3044\u3002 units \u3067 service \u3092\u4f5c\u3063\u3066\u3054\u306b\u3087\u3054\u306b\u3087\u3059\u308c\u3070\u5909\u6570\u3092\u4f7f\u3063\u3066\u306a\u3093\u3068\u304b\u3067\u304d\u305d\u3046\u306a\u6c17\u304c\u3059\u308b\u304c\u3001\u4eca\u56de\u306f\u3067\u304d\u306a\u304b\u3063\u305f\u3002\n\n(3) fleet\u8a2d\u5b9a\nfleet\u3067\u306f\u30b3\u30f3\u30c6\u30ca\u306e\u30b9\u30b1\u30b8\u30e5\u30fc\u30ea\u30f3\u30b0\u3092\u3044\u308d\u3044\u308d\u8a2d\u5b9a\u53ef\u80fd\u3067\u3042\u308b\u304c\uff08Deploying fleet\uff09\u4eca\u56de\u306f\u7279\u5225\u306a\u8a2d\u5b9a\u3092\u3057\u306a\u3044\u306e\u3067\u8a18\u8f09\u3057\u306a\u3044\u3002\n\n(4) units\u8a2d\u5b9a\nCoreOS\u8d77\u52d5\u5f8c\u306b\u7acb\u3061\u4e0a\u3052\u308b\u30b5\u30fc\u30d3\u30b9\uff08systemd\u306eunits\u3001\u4ee5\u524d\u3067\u8a00\u3048\u3070/etc/init.d/\u306e\u8a2d\u5b9a\uff09\u3092\u8a18\u8f09\u3059\u308b\u3002\n#cloud-config\n\n  units:\n    - name: etcd.service\n      command: start\n    - name: fleet.service\n      command: start\n    - name: docker-tcp.socket\n      command: start\n      enable: true\n      content: |\n        [Unit]\n        Description=Docker Socket for the API\n\n        [Socket]\n        ListenStream=2375\n        Service=docker.service\n        BindIPv6Only=both\n\n        [Install]\n        WantedBy=sockets.target\n    - name: settimezone.service\n      command: start\n      content: |\n        [Unit]\n        Description=Set the timezone\n\n        [Service]\n        ExecStart=/usr/bin/timedatectl set-timezone Asia/Tokyo\n        RemainAfterExit=yes\n        Type=oneshot\n\n- name: etcd.service, fleet.service, docker-tcp.socket \u306f\u30af\u30e9\u30b9\u30bf\u7d44\u3080\u5834\u5408\u5fc5\u9808\u3001 settimezone.service \u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30bf\u30a4\u30e0\u30be\u30fc\u30f3(UTC)\u3092\u5909\u66f4\u3059\u308b\u5834\u5408\u8a18\u8f09\u3059\u308b\u3002\uff08Configuring Date and Timezone\uff09\ncommand:, enable:, content: \u7b49\u306f\u30b5\u30fc\u30d3\u30b9\u8d77\u52d5\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u306a\u306e\u3067\u3001Using Cloud-Config\u3092\u53c2\u7167\u3059\u308b\u3002\n\n(5) cloud-config.yaml\n\u4eca\u56de\u4f7f\u7528\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u306f\u4e0b\u8a18\u306e\u901a\u308a\u3002\u3053\u308c\u3067\u6700\u4f4e\u9650\u306e\u30af\u30e9\u30b9\u30bf\u3092\u8d77\u52d5\u3067\u304d\u305f\u3002\n#cloud-config\n\ncoreos:\n  etcd:\n    discovery: http://[discovery\u30ce\u30fc\u30c9\u306eIP\u30a2\u30c9\u30ec\u30b9]:4001/v2/keys/[\u30af\u30e9\u30b9\u30bf\u8b58\u5225\u540d]\n    addr: [\u5404\u30ce\u30fc\u30c9\u306eIP\u30a2\u30c9\u30ec\u30b9]:4001\n    peer-addr: [\u5404\u30ce\u30fc\u30c9\u306eIP\u30a2\u30c9\u30ec\u30b9]:7001\n  units:\n    - name: etcd.service\n      command: start\n    - name: fleet.service\n      command: start\n    - name: docker-tcp.socket\n      command: start\n      enable: true\n      content: |\n        [Unit]\n        Description=Docker Socket for the API\n\n        [Socket]\n        ListenStream=2375\n        Service=docker.service\n        BindIPv6Only=both\n\n        [Install]\n        WantedBy=sockets.target\n    - name: settimezone.service\n      command: start\n      content: |\n        [Unit]\n        Description=Set the timezone\n\n        [Service]\n        ExecStart=/usr/bin/timedatectl set-timezone Asia/Tokyo\n        RemainAfterExit=yes\n        Type=oneshot\nusers:\n  - name: core\n        passwd: $1$IlTQkYPg$fndQiTnrMN.....\nssh_authorized_keys:\n  - ssh-rsa AAAAB3NzaC1yc2....\n\n\n\u30af\u30e9\u30b9\u30bf\u306e\u78ba\u8a8d\netcd\u306e\u72b6\u614b\u78ba\u8a8d\n$ systemctl status etcd\n\u25cf etcd.service - etcd\n   Loaded: loaded (/usr/lib64/systemd/system/etcd.service; disabled)\n  Drop-In: /run/systemd/system/etcd.service.d\n           \u2514\u250020-cloudinit.conf\n   Active: active (running) since Mon 2014-09-29 11:37:46 JST; 5h 10min ago\n Main PID: 618 (etcd)\n   CGroup: /system.slice/etcd.service\n           \u2514\u2500618 /usr/bin/etcd\n\nSep 29 11:37:47 core004 etcd[618]: [etcd] Sep 29 11:37:47.071 INFO      | core004: state changed from 'follower' to 'snapshotting'.\nSep 29 11:37:47 core004 etcd[618]: [etcd] Sep 29 11:37:47.130 INFO      | core004: peer added: 'core001'\nSep 29 11:37:47 core004 etcd[618]: [etcd] Sep 29 11:37:47.224 INFO      | core004: peer added: 'core003'\nSep 29 11:37:50 core004 etcd[618]: [etcd] Sep 29 11:37:50.271 INFO      | core004: snapshot of 1414179 events at index 1414179 completed\n\netcd\u306e\u8a2d\u5b9a\u78ba\u8a8d\n$ systemctl cat etcd\n# /usr/lib64/systemd/system/etcd.service\n[Unit]\nDescription=etcd\n\n[Service]\nUser=etcd\nPermissionsStartOnly=true\nEnvironment=ETCD_DATA_DIR=/var/lib/etcd ETCD_NAME=default\nExecStart=/usr/bin/etcd\nRestart=always\nRestartSec=10s\n\n[Install]\nWantedBy=multi-user.target\n\n# /run/systemd/system/etcd.service.d/20-cloudinit.conf\n[Service]\nEnvironment=\"ETCD_ADDR=192.168.0.2:4001\"\nEnvironment=\"ETCD_DISCOVERY=http://192.168.0.1:4001/v2/keys/cluster1\"\nEnvironment=\"ETCD_NAME=core002\"\nEnvironment=\"ETCD_PEER_ADDR=192.168.0.2:7001\"\n\netcd\u30af\u30e9\u30b9\u30bf\u306e\u78ba\u8a8d\n$ curl -L http://127.0.0.1:7001/v2/admin/machines\n[{\"name\":\"core002\",\"state\":\"follower\",\"clientURL\":\"http://192.168.0.2:4001\",\"peerURL\":\"http://192.168.0.2:7001\"},{\"name\":\"core003\",\"state\":\"leader\",\"clientURL\":\"http://192.168.0.3:4001\",\"peerURL\":\"http://192.168.0.3:7001\"},{\"name\":\"core004\",\"state\":\"follower\",\"clientURL\":\"http://192.168.0.4:4001\",\"peerURL\":\"http://192.168.0.4:7001\"}]\n\nfleet\u30e1\u30f3\u30d0\u306e\u78ba\u8a8d\n$ fleetctl list-machines -l\nMACHINE                 IP      METADATA\n1ece947bc2084053988c0b65a7bf43e8    192.168.0.2 -\n33f37f51181d46bcbf43e7162795e447    192.168.0.3 -\n3dc1196b4ccd470d9f262ab506c4649c    192.168.0.4 -\n\n\u30a8\u30e9\u30fc\u304c\u51fa\u308b\u3088\u3046\u3067\u3042\u308c\u3070\u3001etcd\u3092\u518d\u8d77\u52d5\u3059\u308b\n$ sudo systemctl restart etcd\n\nCoreOS\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5f8c\u306eCloud-config\u30d5\u30a1\u30a4\u30eb\u306f /var/lib/coreos-install/user_data  \u306b\u4fdd\u5b58\u3055\u308c\u308b\u306e\u3067\u3001\u8a2d\u5b9a\u5909\u66f4\u3059\u308b\u5834\u5408\u306f\u7de8\u96c6\u4fdd\u5b58\u5f8c\u518d\u8d77\u52d5\u3092\u884c\u3046\u3002\n$ sudo vim /var/lib/coreos-install/user_data\n$ sudo reboot\n\nVagrant/VirtualBox\u3084AWS\u7b49\u306e\u30d1\u30d6\u30ea\u30c3\u30af\u30af\u30e9\u30a6\u30c9\u74b0\u5883\u3067\u306e\u60c5\u5831\u306f\u3044\u308d\u3044\u308d\u3042\u3063\u305f\u3093\u3067\u3059\u304c\u3001\u30ed\u30fc\u30ab\u30eb\u306eVM\u3067\u69cb\u7bc9\u3059\u308b\u5834\u5408\u306e\u60c5\u5831\u304c\u5c11\u306a\u304b\u3063\u305f\u306e\u3067\u307e\u3068\u3081\u3066\u304a\u304d\u307e\u3059\u3002\u9593\u9055\u3044\u3084\u4ed6\u306b\u3082\u3063\u3068\u3044\u3044\u65b9\u6cd5\u304c\u3042\u308c\u3070\u3001\u662f\u975e\u30b3\u30e1\u30f3\u30c8\u304f\u3060\u3055\u3044\u3002\n\n\u3053\u3053\u3067\u306fCoreOS/etcd/fleet\u306e\u8a73\u7d30\u306f\u8aac\u660e\u3057\u306a\u3044\u306e\u3067\u3001mopemope\u3055\u3093\u306ehttp://qiita.com/mopemope/items/fa9424b094aae3eac580\n\u306a\u3069\u3092\u53c2\u7167\u3057\u3066\u4e0b\u3055\u3044\u3002\n\n###\u69cb\u7bc9\u74b0\u5883\n\u4e0b\u8a18KVM\u30db\u30b9\u30c8\uff11\u53f0\u306e\u4e0a\u306b\u3001\uff14VM\u3092\u4f5c\u6210\u3001CoreOS\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3001etcd/fleet\u306e\u30af\u30e9\u30b9\u30bf\u3092\u69cb\u7bc9\u3057\u305f\u3002\n\n* KVM\u30db\u30b9\u30c8: CentOS6.5, openQRM5.1\n* CoreOS: 410.1.0 STABLE, etcd version 0.4.6, fleet version 0.6.2\n\n###CoreOS\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u4f7f\u7528\u3057\u305f\u74b0\u5883\u3067\u306f\u65e2\u306bopenQRM\u304c\u7ba1\u7406\u3059\u308bdhcp/pxe\u30b5\u30fc\u30d0\u304c\u7a3c\u50cd\u3057\u3066\u304a\u308a\u3001[Booting CoreOS via PXE](https://coreos.com/docs/running-coreos/bare-metal/booting-with-pxe/ \"Booting CoreOS via PXE\")\u306f\u4f7f\u3048\u306a\u3044\u306e\u3067\u3001[Booting CoreOS from an ISO]( https://coreos.com/docs/running-coreos/platforms/iso/ \"Booting CoreOS from an ISO\")\u304b\u3089ISO\u30a4\u30e1\u30fc\u30b8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3001ISO\u30a4\u30e1\u30fc\u30b8\u304b\u3089VM\u3092\u8d77\u52d5\u3057\u305f\u3002\nvnc\u7b49\u3067\u30b3\u30f3\u30bd\u30fc\u30eb\u3092\u958b\u304f\u3068core\u30e6\u30fc\u30b6\u3067\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u308b\u304c\u3001vnc\u3067\u306f\u4f55\u304b\u3068\u4e0d\u4fbf\u306a\u306e\u3067\u3001PC\u304b\u3089ssh\u3067\u304d\u308b\u3088\u3046\u306b\u4eee\u306b\u30d1\u30b9\u30ef\u30fc\u30c9\u8a2d\u5b9a\u3092\u884c\u3046\u3002\n\n```\n$ sudo passwd core\n```\n\n\u8d77\u52d5\u3057\u305f\u72b6\u614b\u3067\u306f\u30e1\u30e2\u30ea\u4e0a\u306b\u30b7\u30b9\u30c6\u30e0\u304c\u5c55\u958b\u3055\u308c\u3066\u304a\u308a\u3001\u30ed\u30fc\u30ab\u30eb\u30c7\u30a3\u30b9\u30af\u306bCoreOS\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3084\u308b\u5fc5\u8981\u304c\u3042\u308b\u306e\u3067\u3001[Installing CoreOS to Disk](https://coreos.com/docs/running-coreos/bare-metal/installing-to-disk/ \"Installing CoreOS to Disk\")\u306b\u5f93\u3044\u3001\u307e\u305acloud-config\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n\u4f5c\u6210\u3057\u305fcloud-config\u30d5\u30a1\u30a4\u30eb\u306f\u3001core\u30e6\u30fc\u30b6\u306e\u30db\u30fc\u30e0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u76f4\u4e0b\u306b _cloud-config.yaml_ \u3068\u540d\u4ed8\u3051\u3066\u4fdd\u5b58\u3057\u3001\u4e0b\u8a18\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3002\n\n```\n$ sudo coreos-install -d /dev/vda -C stable -c ~/cloud-config.yaml\n```\n **-d /dev/vda** \u306f\u3001\u4f7f\u7528\u74b0\u5883\u306b\u5408\u308f\u305b\u305f\u8d77\u52d5\u30c7\u30a3\u30b9\u30af\u306e\u30c7\u30d0\u30a4\u30b9\u540d(/dev/sda\u7b49)\u3092\u6307\u5b9a\u3059\u308b\u3002\n **-C stable** \u306f\u3001\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308bCoreOS\u306e\u30c1\u30e3\u30cd\u30eb(stable/beta/alpha)\u3092\u6307\u5b9a\u3059\u308b\u3002\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305fVM\u30a4\u30e1\u30fc\u30b8\u3092\u30af\u30ed\u30fc\u30f3\u3057\u305f\u5834\u5408\u3001 **machine-id** \u304c\u91cd\u8907\u3057\u3066fleet\u304c\u52d5\u304b\u306a\u304f\u306a\u308b\u306e\u3067\u3001 **machine-id** \u30d5\u30a1\u30a4\u30eb\u3092\u524a\u9664\u3057\u3066\u518d\u8d77\u52d5\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n```\n$ sudo rm /etc/machine-id\n$ sudo systemctl reboot\n```\n\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u306f\u300c\u30b4\u30fc\u30eb\u30c7\u30f3\u30a4\u30e1\u30fc\u30b8\u300d\u3092\u4f5c\u6210\u3059\u308b\u5834\u5408\u306f\u3001/usr/share/OEM/\u30c7\u30a4\u30ec\u30af\u30c8\u30ea\u3092\u4f7f\u7528\u3059\u308b\u3079\u304d\u3068\u304b\u66f8\u3044\u3066\u3042\u3063\u305f\u304c\u3001\u8abf\u3079\u304d\u308c\u305a\u3002\n\n###cloud-config\u30d5\u30a1\u30a4\u30eb\u306e\u8a18\u8ff0\u65b9\u6cd5\n[Using Cloud-Config](https://coreos.com/docs/cluster-management/setup/cloudinit-cloud-config/)\u306b\u3042\u308b\u3088\u3046\u306b\u3001cloud-config\u30d5\u30a1\u30a4\u30eb\u306f\u5fc5\u305a _#cloud-config_ \u3092\u542b\u307f\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30ad\u30fc\u3092\u5fc5\u8981\u306b\u5fdc\u3058\u3066\u5b9a\u7fa9\u3059\u308b\u3002\n\n* coreos\n* ssh_authorized_keys\n* hostname\n* users\n* units\n* write_files\n* manage_etc_hosts\n\n####(1) ssh\u8a2d\u5b9a\n\u7d76\u5bfe\u306b\u8a2d\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u306e\u306f\u3001 *ssh_authorized_keys* \u3068 *users* \u3067\u3042\u308b\u3002\nCoreOS\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u3067ssh\u304c\u516c\u958b\u9375\u8a8d\u8a3c\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u3067\u3001\u3061\u3083\u3093\u3068\u8a2d\u5b9a\u3057\u306a\u3044\u3068\u8d77\u52d5\u3057\u3066\u3082\u63a5\u7d9a\u3067\u304d\u306a\u3044\u3067\u304f\u306e\u307c\u3046VM\u306b\u306a\u308b\u3002\n\u516c\u958b\u9375\u8a8d\u8a3c\u3092\u4f7f\u3046\u5834\u5408\u306f\u3001ssh-keygen\u30b3\u30de\u30f3\u30c9\u7b49\u3067\u4f5c\u6210\u3057\u305f\u516c\u958b\u9375\u306e\u5185\u5bb9\u3092\u4e0b\u8a18\u306e\u3088\u3046\u306bcloud-config\u30d5\u30a1\u30a4\u30eb\u306b\u8a18\u8f09\u3059\u308b\u3002\n\n```\n#cloud-config\n\nusers:\n  - name: core\nssh_authorized_keys:\n  - ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAweXfI2dW0jrWU....\n```\n\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\u306f\u3001\u30cf\u30c3\u30b7\u30e5\u5316\u3055\u308c\u305f\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u4f5c\u6210\u3057\u3001\n```\ncore@core001 ~ $ openssl passwd -1\nPassword:\nVerifying - Password:\n$1$IlTQkYPg$fndQiTnrMN.....\n```\n\u4e0b\u8a18\u306e\u3088\u3046\u306bcloud-config\u30d5\u30a1\u30a4\u30eb\u306b\u8a18\u8f09\u3059\u308b\u3002\n\n```\n#cloud-config\n\nusers:\n  - name: core\n    passwd: $1$IlTQkYPg$fndQiTnrMN.....\nssh_authorized_keys:\n  - ssh-rsa AAAAB3NzaC1yc2....\n```\n\n####(2) etcd\u8a2d\u5b9a\n\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u4f8b\u3092\u898b\u308b\u3068\n\n```\n#cloud-config\n\ncoreos:\n    etcd:\n        name: node001\n    # generate a new token for each unique cluster from https://discovery.etcd.io/new\n        discovery: https://discovery.etcd.io/<token>\n    # multi-region and multi-cloud deployments need to use $public_ipv4\n        addr: $public_ipv4:4001\n        peer-addr: $private_ipv4:7001\n```\n\u306e\u3088\u3046\u306b\u3055\u3089\u3063\u3068\u66f8\u3044\u3066\u3042\u308b\u304c\u3001\u3053\u3053\u3067\u30cf\u30de\u3063\u305f\u306e\u3067\u8a73\u3057\u304f\u66f8\u3044\u3066\u307f\u3088\u3046\u3002\n **name:** \u30ce\u30fc\u30c9\u540d\u3092\u6307\u5b9a\u3057\u305f\u3044\u5834\u5408\u306f\u3053\u3053\u306b\u66f8\u304f\u304c\u3001\u6307\u5b9a\u3057\u306a\u3051\u308c\u3070\u52dd\u624b\u306b\u751f\u6210\u3055\u308c\u308b\u3002\n **discovery:**  etcd\u306f\u3001\u30b7\u30b9\u30c6\u30e0\u8d77\u52d5\u6642\u306b\u6240\u5c5e\u3059\u308b\u30af\u30e9\u30b9\u30bf\u30e1\u30f3\u30d0\u3092 data-dir\u8a2d\u5b9a\u3067\u6307\u5b9a\u3055\u308c\u305f\u30ed\u30b0\u30c7\u30fc\u30bf\u3001 discovery\u8a2d\u5b9a\u3001 peers\u8a2d\u5b9a\u306e\u9806\u3067\u691c\u7d22\u3059\u308b\u3002\uff08[Cluster Finding Process](https://github.com/bmizerany/etcd-team/blob/master/Documentation/design/cluster-finding.md)\uff09\ndata-dir\u8a2d\u5b9a\u306f\u3001\n```\n$./etcd -name <name> [-data-dir=<path>]\n```\n\u306e\u3088\u3046\u306b\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u3067etcd\u8d77\u52d5\u3059\u308b\u5834\u5408\u306b\u4f7f\u7528\u3067\u304d\u308b\u304c\u3001discovery\u8a2d\u5b9a\u3001\u307e\u305f\u306fpeers\u8a2d\u5b9a\u3092\u3057\u3066\u3044\u306a\u3051\u308c\u3070\u3001\u30ce\u30fc\u30c9\u8ffd\u52a0\u6642\u306b\u65e2\u5b58\u30af\u30e9\u30b9\u30bf\u306b\u53c2\u52a0\u3067\u304d\u306a\u3044\u3002\n **discovery:** \u30ad\u30fc\u306b\u8a18\u8f09\u3059\u308b\u306e\u306f\u3001etcd\u30af\u30e9\u30b9\u30bf\u30e1\u30f3\u30d0\u4ee5\u5916\u306eetcd\u30b5\u30fc\u30d0\u304cdiscovery\u30b5\u30fc\u30d3\u30b9\u3092\u63d0\u4f9b\u3057\u3066\u3044\u308b\u5834\u5408\u3001\u305d\u306eURL\u3092\u8a18\u8f09\u3059\u308b\u3002discovery\u30b5\u30fc\u30d3\u30b9\u3092\u4f7f\u7528\u3059\u308b\u30e1\u30ea\u30c3\u30c8\u306f\u3001\u30af\u30e9\u30b9\u30bf\u8ffd\u52a0\uff0f\u524a\u9664\u6642\u306e\u5404\u30af\u30e9\u30b9\u30bf\u30e1\u30f3\u30d0\u500b\u5225\u306e\u8a2d\u5b9a\u304c\u4e0d\u8981\u3067\u3042\u308b\u70b9\u3060\u304c\u3001\u30af\u30e9\u30b9\u30bf\u30e1\u30f3\u30d0\u5916\u306betcd\u30b5\u30fc\u30d0\u304c\u5fc5\u8981\u3067\u3042\u308a\u3001\u672c\u756a\u7cfb\u3067\u306f\u969c\u5bb3\u5bfe\u7b56\u3092\u8003\u616e\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002 *https://discovery.etcd.io/* \u306e\u30b5\u30fc\u30d3\u30b9\u306f\u30b0\u30ed\u30fc\u30d0\u30eb\u30a2\u30c9\u30ec\u30b9\u3092\u6301\u3063\u305fetcd\u30af\u30e9\u30b9\u30bf\u3067\u306a\u3044\u3068\u4f7f\u7528\u3067\u304d\u306a\u3044\u3002\u4eca\u56de\u306fdiscovery\u30b5\u30fc\u30d3\u30b9\u7528\u306betcd\u30b5\u30fc\u30d0\u3092\u4e00\u53f0\u305f\u3066\u3066\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u6307\u5b9a\u3057\u305f\u3002\n```\ndiscovery: http://192.168.0.1:4001/v2/keys/test_cluster\n```\n *test_cluster* \u306f\u30af\u30e9\u30b9\u30bf\u8b58\u5225\u306e\u305f\u3081\u306e\u4efb\u610f\u306e\u30ad\u30fc\u540d\u3067\u826f\u3044\u3002\npeers\u8a2d\u5b9a\u306f\u3001discovery\u30b5\u30fc\u30d3\u30b9\u3092\u4f7f\u7528\u3057\u306a\u3044\u3067\u3001\u30af\u30e9\u30b9\u30bf\u30e1\u30f3\u30d0\u3092\u660e\u793a\u7684\u306b\u6307\u5b9a\u3067\u304d\u3001etcd\u30af\u30e9\u30b9\u30bf\u30e1\u30f3\u30d0\u4ee5\u5916\u306e\u30b5\u30fc\u30d0\u306f\u5fc5\u8981\u306a\u3044\u3002\u3057\u304b\u3057\u30af\u30e9\u30b9\u30bf\u30e1\u30f3\u30d0\u5168\u3066\u3067\u500b\u5225\u306e\u8a2d\u5b9a\u304c\u5fc5\u8981\u306a\u305f\u3081\u3001\u6570\u53f0\u7a0b\u5ea6\u306e\u30af\u30e9\u30b9\u30bf\u3067\u3042\u308c\u3070\u8a2d\u5b9a\u306f\u7c21\u5358\u3060\u304c\u3001\u5927\u898f\u6a21\u306b\u306a\u308b\u3068\u904b\u7528\u7684\u306b\u7121\u7406\u3067\u3042\u308d\u3046\u3002\u8a2d\u5b9a\u306f\u3001\u81ea\u5206\u81ea\u8eab\u4ee5\u5916\u306e\u30af\u30e9\u30b9\u30bf\u30e1\u30f3\u30d0\u3092\u4e0b\u8a18\u306e\u3088\u3046\u306b\u30b3\u30f3\u30de\u3067\u3064\u306a\u3044\u3067\u6307\u5b9a\u3059\u308b\u3002\n```\npeers: 192.168.0.2:7001,192.168.0.3:7001\n```\n\n **addr:** \u3068 **peer-addr:** \u3000etcd\u901a\u4fe1\u306e\u305f\u3081\u306b\u7a3c\u50cd\u30ce\u30fc\u30c9\u306eIP\u30a2\u30c9\u30ec\u30b9\u3068\u30dd\u30fc\u30c8\u3092\u6307\u5b9a\u3059\u308b\u3002\\$public_ipv4\u3068\\$private_ipv4\u306f\u3001 Amazon EC2, Google Compute Engine, OpenStack, Rackspace, DigitalOcean, Vagrant\u3067\u3057\u304b\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u3066\u3044\u306a\u3044\u74b0\u5883\u5909\u6570\u306e\u305f\u3081\u3001\u4eca\u56de\u306f\u76f4\u63a5IP\u30a2\u30c9\u30ec\u30b9\u3092\u8a18\u8f09\u3057\u305f\u3002\n\n```\n#cloud-config\n\ncoreos:\n  etcd:\n    discovery: http://192.168.0.1:4001/v2/keys/test_cluster\n    addr: 192.168.0.2:4001\n    peer-addr: 192.168.0.2:7001\n```\n\ncloud-config\u30d5\u30a1\u30a4\u30eb\u3092\u30ce\u30fc\u30c9\u6bce\u306b\u5909\u66f4\u3057\u305f\u304f\u306a\u3044\u304c\u3001CoreOS\u306eCloud-init\u306f *bootcmd* \u3084 *runcmd* \u3092\u307e\u3060\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u3044\u306a\u3044\u3002 *units* \u3067 *service* \u3092\u4f5c\u3063\u3066\u3054\u306b\u3087\u3054\u306b\u3087\u3059\u308c\u3070\u5909\u6570\u3092\u4f7f\u3063\u3066\u306a\u3093\u3068\u304b\u3067\u304d\u305d\u3046\u306a\u6c17\u304c\u3059\u308b\u304c\u3001\u4eca\u56de\u306f\u3067\u304d\u306a\u304b\u3063\u305f\u3002\n\n####(3) fleet\u8a2d\u5b9a\n\nfleet\u3067\u306f\u30b3\u30f3\u30c6\u30ca\u306e\u30b9\u30b1\u30b8\u30e5\u30fc\u30ea\u30f3\u30b0\u3092\u3044\u308d\u3044\u308d\u8a2d\u5b9a\u53ef\u80fd\u3067\u3042\u308b\u304c\uff08[Deploying fleet](https://github.com/coreos/fleet/blob/master/Documentation/deployment-and-configuration.md)\uff09\u4eca\u56de\u306f\u7279\u5225\u306a\u8a2d\u5b9a\u3092\u3057\u306a\u3044\u306e\u3067\u8a18\u8f09\u3057\u306a\u3044\u3002\n\n####(4) units\u8a2d\u5b9a\n\nCoreOS\u8d77\u52d5\u5f8c\u306b\u7acb\u3061\u4e0a\u3052\u308b\u30b5\u30fc\u30d3\u30b9\uff08systemd\u306eunits\u3001\u4ee5\u524d\u3067\u8a00\u3048\u3070/etc/init.d/\u306e\u8a2d\u5b9a\uff09\u3092\u8a18\u8f09\u3059\u308b\u3002\n\n```\n#cloud-config\n\n  units:\n    - name: etcd.service\n      command: start\n    - name: fleet.service\n      command: start\n    - name: docker-tcp.socket\n      command: start\n      enable: true\n      content: |\n        [Unit]\n        Description=Docker Socket for the API\n\n        [Socket]\n        ListenStream=2375\n        Service=docker.service\n        BindIPv6Only=both\n\n        [Install]\n        WantedBy=sockets.target\n    - name: settimezone.service\n      command: start\n      content: |\n        [Unit]\n        Description=Set the timezone\n\n        [Service]\n        ExecStart=/usr/bin/timedatectl set-timezone Asia/Tokyo\n        RemainAfterExit=yes\n        Type=oneshot\n```\n **- name:** *etcd.service, fleet.service, docker-tcp.socket* \u306f\u30af\u30e9\u30b9\u30bf\u7d44\u3080\u5834\u5408\u5fc5\u9808\u3001 *settimezone.service* \u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30bf\u30a4\u30e0\u30be\u30fc\u30f3(UTC)\u3092\u5909\u66f4\u3059\u308b\u5834\u5408\u8a18\u8f09\u3059\u308b\u3002\uff08[Configuring Date and Timezone](https://coreos.com/docs/cluster-management/setup/configuring-date-and-timezone/)\uff09\n **command:, enable:, content:** \u7b49\u306f\u30b5\u30fc\u30d3\u30b9\u8d77\u52d5\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u306a\u306e\u3067\u3001[Using Cloud-Config](https://coreos.com/docs/cluster-management/setup/cloudinit-cloud-config/)\u3092\u53c2\u7167\u3059\u308b\u3002\n\n####(5) cloud-config.yaml\n\n\u4eca\u56de\u4f7f\u7528\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u306f\u4e0b\u8a18\u306e\u901a\u308a\u3002\u3053\u308c\u3067\u6700\u4f4e\u9650\u306e\u30af\u30e9\u30b9\u30bf\u3092\u8d77\u52d5\u3067\u304d\u305f\u3002\n\n```\n#cloud-config\n\ncoreos:\n  etcd:\n    discovery: http://[discovery\u30ce\u30fc\u30c9\u306eIP\u30a2\u30c9\u30ec\u30b9]:4001/v2/keys/[\u30af\u30e9\u30b9\u30bf\u8b58\u5225\u540d]\n    addr: [\u5404\u30ce\u30fc\u30c9\u306eIP\u30a2\u30c9\u30ec\u30b9]:4001\n    peer-addr: [\u5404\u30ce\u30fc\u30c9\u306eIP\u30a2\u30c9\u30ec\u30b9]:7001\n  units:\n    - name: etcd.service\n      command: start\n    - name: fleet.service\n      command: start\n    - name: docker-tcp.socket\n      command: start\n      enable: true\n      content: |\n        [Unit]\n        Description=Docker Socket for the API\n\n        [Socket]\n        ListenStream=2375\n        Service=docker.service\n        BindIPv6Only=both\n\n        [Install]\n        WantedBy=sockets.target\n    - name: settimezone.service\n      command: start\n      content: |\n        [Unit]\n        Description=Set the timezone\n\n        [Service]\n        ExecStart=/usr/bin/timedatectl set-timezone Asia/Tokyo\n        RemainAfterExit=yes\n        Type=oneshot\nusers:\n  - name: core\n        passwd: $1$IlTQkYPg$fndQiTnrMN.....\nssh_authorized_keys:\n  - ssh-rsa AAAAB3NzaC1yc2....\n```\n\n###\u30af\u30e9\u30b9\u30bf\u306e\u78ba\u8a8d\netcd\u306e\u72b6\u614b\u78ba\u8a8d\n\n```\n$ systemctl status etcd\n\u25cf etcd.service - etcd\n   Loaded: loaded (/usr/lib64/systemd/system/etcd.service; disabled)\n  Drop-In: /run/systemd/system/etcd.service.d\n           \u2514\u250020-cloudinit.conf\n   Active: active (running) since Mon 2014-09-29 11:37:46 JST; 5h 10min ago\n Main PID: 618 (etcd)\n   CGroup: /system.slice/etcd.service\n           \u2514\u2500618 /usr/bin/etcd\n\nSep 29 11:37:47 core004 etcd[618]: [etcd] Sep 29 11:37:47.071 INFO      | core004: state changed from 'follower' to 'snapshotting'.\nSep 29 11:37:47 core004 etcd[618]: [etcd] Sep 29 11:37:47.130 INFO      | core004: peer added: 'core001'\nSep 29 11:37:47 core004 etcd[618]: [etcd] Sep 29 11:37:47.224 INFO      | core004: peer added: 'core003'\nSep 29 11:37:50 core004 etcd[618]: [etcd] Sep 29 11:37:50.271 INFO      | core004: snapshot of 1414179 events at index 1414179 completed\n```\n\netcd\u306e\u8a2d\u5b9a\u78ba\u8a8d\n\n```\n$ systemctl cat etcd\n# /usr/lib64/systemd/system/etcd.service\n[Unit]\nDescription=etcd\n\n[Service]\nUser=etcd\nPermissionsStartOnly=true\nEnvironment=ETCD_DATA_DIR=/var/lib/etcd ETCD_NAME=default\nExecStart=/usr/bin/etcd\nRestart=always\nRestartSec=10s\n\n[Install]\nWantedBy=multi-user.target\n\n# /run/systemd/system/etcd.service.d/20-cloudinit.conf\n[Service]\nEnvironment=\"ETCD_ADDR=192.168.0.2:4001\"\nEnvironment=\"ETCD_DISCOVERY=http://192.168.0.1:4001/v2/keys/cluster1\"\nEnvironment=\"ETCD_NAME=core002\"\nEnvironment=\"ETCD_PEER_ADDR=192.168.0.2:7001\"\n```\n\netcd\u30af\u30e9\u30b9\u30bf\u306e\u78ba\u8a8d\n\n```\n$ curl -L http://127.0.0.1:7001/v2/admin/machines\n[{\"name\":\"core002\",\"state\":\"follower\",\"clientURL\":\"http://192.168.0.2:4001\",\"peerURL\":\"http://192.168.0.2:7001\"},{\"name\":\"core003\",\"state\":\"leader\",\"clientURL\":\"http://192.168.0.3:4001\",\"peerURL\":\"http://192.168.0.3:7001\"},{\"name\":\"core004\",\"state\":\"follower\",\"clientURL\":\"http://192.168.0.4:4001\",\"peerURL\":\"http://192.168.0.4:7001\"}]\n```\nfleet\u30e1\u30f3\u30d0\u306e\u78ba\u8a8d\n\n```\n$ fleetctl list-machines -l\nMACHINE\t\t\t\t\tIP\t\tMETADATA\n1ece947bc2084053988c0b65a7bf43e8\t192.168.0.2\t-\n33f37f51181d46bcbf43e7162795e447\t192.168.0.3\t-\n3dc1196b4ccd470d9f262ab506c4649c\t192.168.0.4\t-\n```\n\n\u30a8\u30e9\u30fc\u304c\u51fa\u308b\u3088\u3046\u3067\u3042\u308c\u3070\u3001etcd\u3092\u518d\u8d77\u52d5\u3059\u308b\n\n```\n$ sudo systemctl restart etcd\n```\n\nCoreOS\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5f8c\u306eCloud-config\u30d5\u30a1\u30a4\u30eb\u306f **/var/lib/coreos-install/user_data**  \u306b\u4fdd\u5b58\u3055\u308c\u308b\u306e\u3067\u3001\u8a2d\u5b9a\u5909\u66f4\u3059\u308b\u5834\u5408\u306f\u7de8\u96c6\u4fdd\u5b58\u5f8c\u518d\u8d77\u52d5\u3092\u884c\u3046\u3002\n\n```\n$ sudo vim /var/lib/coreos-install/user_data\n$ sudo reboot\n```\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"}