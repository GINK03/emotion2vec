{"context": " More than 1 year has passed since last update.test-kitchen\u3067kitchen-docker\u3092\u4f7f\u3046\u5834\u5408\u3001.kitchen.yml\u3067\u30c6\u30b9\u30c8\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30d9\u30fc\u30b9\u30a4\u30e1\u30fc\u30b8\u3092\u8a2d\u5b9a\u3059\u308b\u65b9\u6cd5\u3068\u3057\u3066\u3001\u4ee5\u4e0b\u306e3\u7a2e\u985e\u304c\u3042\u308a\u307e\u3059\u3002\n\n\n\u8a2d\u5b9a\u3057\u306a\u3044\n(\u5185\u90e8\u3067\u306fKitchen::Driver::Docker.default_image()\u306b\u3088\u3063\u3066\u3001platform.name\u304b\u3089name:TAG\u304c\u4f5c\u3089\u308c\u308b)\n\n.kitchen.yml\n~~~ \u524d\u7565 ~~~    \nplatforms:\n  - name: centos-7.1                   # <= \u3053\u3053\u304b\u3089centos:centos7\u304c\u751f\u6210\u3055\u308c\u308b\n    driver_config:\n      privileged: true\n      run_command: /sbin/init; sleep 3\n~~~ \u5f8c\u7565 ~~~\n\n\n\n\nname:TAG\u3067\u8a2d\u5b9a\n\n.kitchen.yml\n~~~ \u524d\u7565 ~~~    \nplatforms:\n  - name: centos-7.1\n    driver_config:\n      image: centos:centos7            # <= \u30b3\u30ec\n      privileged: true\n      run_command: /sbin/init; sleep 3\n~~~ \u5f8c\u7565 ~~~\n\n\n\n\nDockerfile\u306e\u30d1\u30b9\u3092\u8a2d\u5b9a\n(\u5185\u90e8\u3067\u306ferb\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3068\u3057\u3066\u6271\u308f\u308c\u308b\u306e\u3067\u3001eRuby\u30bf\u30b0\u3067\u30de\u30fc\u30af\u30a2\u30c3\u30d7\u53ef\u80fd\u3002)\n\n.kitchen.yml\n~~~ \u524d\u7565 ~~~\nplatforms:\n  - name: centos-7.1\n    driver_config:\n      dockerfile: test/platforms/centos-7.1/Dockerfile # <= \u30b3\u30ec\n      privileged: true\n      run_command: /sbin/init; sleep 3\n~~~ \u5f8c\u7565 ~~~\n\n\n\ntest/platforms/centos-7.1/Dockerfile\nFROM centos:centos7\n\n\n\n\nkitchen-docker\u3067\u306f\u4e0a\u8a181. 2. \u306e\u5834\u5408\u30d9\u30fc\u30b9\u30a4\u30e1\u30fc\u30b8\u3068\u3057\u3066\u8a2d\u5b9a\u3055\u308c\u305f\u30a4\u30e1\u30fc\u30b8\u3092FROM\u3068\u3057\u3001test-kitchen\u3067\u4f7f\u7528\u3059\u308b\u5834\u5408\u306b\u5fc5\u8981\u3068\u306a\u308b\u30d1\u30c3\u30b1\u30fc\u30b8\u3084\u8a2d\u5b9a\u3092\u52a0\u3048\u305fDockerfile\u3092\u4f5c\u3063\u3066docker build\u3092\u884c\u3044\u3001\u30d3\u30eb\u30c9\u3055\u308c\u305f\u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\u3092\u30c6\u30b9\u30c8\u74b0\u5883\u3068\u3057\u3066\u4f7f\u7528\u3057\u307e\u3059\u3002\n\u3057\u304b\u3057\u30013. \u306e\u5834\u5408\u306f\u30d1\u30b9\u3067\u8a2d\u5b9a\u3055\u308c\u305fDockerfile\u3092\u305d\u306e\u307e\u307e\u4f7f\u3063\u3066docker build\u3059\u308b\u306e\u3067\u3001Dockerfile\u306b1. 2.\u306e\u5834\u5408\u306b\u30d3\u30eb\u30c9\u3055\u308c\u308b\u5185\u5bb9\u304c\u542b\u307e\u308c\u3066\u3044\u306a\u3044\u3068\u30c6\u30b9\u30c8\u74b0\u5883\u3068\u3057\u3066\u4f7f\u7528\u3067\u304d\u307e\u305b\u3093\u3002\n\u3068\u3044\u3046\u3053\u3068\u3067\u3001\u305d\u308c\u306b\u5bfe\u5fdc\u3057\u3066\u3044\u308bDockerfile\u304c\u4ee5\u4e0b\u306b\u306a\u308a\u307e\u3059\u3002\n\nDockerfile\n<%=     from = \"FROM #{@image}\"\n        platform = case @platform\n        when 'debian', 'ubuntu'\n          disable_upstart = <<-eos\n            RUN dpkg-divert --local --rename --add /sbin/initctl\n            RUN ln -sf /bin/true /sbin/initctl\n          eos\n          packages = <<-eos\n            ENV DEBIAN_FRONTEND noninteractive\n            RUN apt-get update\n            RUN apt-get install -y sudo openssh-server curl lsb-release\n          eos\n          @disable_upstart ? disable_upstart + packages : packages\n        when 'rhel', 'centos', 'fedora'\n          <<-eos\n            RUN yum clean all\n            RUN yum install -y sudo openssh-server openssh-clients which curl\n            RUN ssh-keygen -t rsa -f /etc/ssh/ssh_host_rsa_key -N ''\n            RUN ssh-keygen -t dsa -f /etc/ssh/ssh_host_dsa_key -N ''\n          eos\n        when 'arch'\n          <<-eos\n            RUN pacman -Syu --noconfirm\n            RUN pacman -S --noconfirm openssh sudo curl\n            RUN ssh-keygen -A -t rsa -f /etc/ssh/ssh_host_rsa_key\n            RUN ssh-keygen -A -t dsa -f /etc/ssh/ssh_host_dsa_key\n          eos\n        when 'gentoo'\n          <<-eos\n            RUN emerge sync\n            RUN emerge net-misc/openssh app-admin/sudo\n            RUN ssh-keygen -A -t rsa -f /etc/ssh/ssh_host_rsa_key\n            RUN ssh-keygen -A -t dsa -f /etc/ssh/ssh_host_dsa_key\n          eos\n        when 'gentoo-paludis'\n          <<-eos\n            RUN cave sync\n            RUN cave resolve -zx net-misc/openssh app-admin/sudo\n            RUN ssh-keygen -A -t rsa -f /etc/ssh/ssh_host_rsa_key\n            RUN ssh-keygen -A -t dsa -f /etc/ssh/ssh_host_dsa_key\n          eos\n        else\n          raise ActionFailed,\n          \"Unknown platform '#{@platform}'\"\n        end\n\n        username = @username\n        password = @password\n        public_key = IO.read(@public_key).strip\n        homedir = username == 'root' ? '/root' : \"/home/#{username}\"\n\n        base = <<-eos\n          RUN if ! getent passwd #{username}; then \\\n                useradd -d #{homedir} -m -s /bin/bash #{username}; \\\n              fi\n          RUN echo #{username}:#{password} | chpasswd\n          RUN echo '#{username} ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers\n          RUN mkdir -p /etc/sudoers.d\n          RUN echo '#{username} ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers.d/#{username}\n          RUN chmod 0440 /etc/sudoers.d/#{username}\n          RUN mkdir -p #{homedir}/.ssh\n          RUN chown -R #{username} #{homedir}/.ssh\n          RUN chmod 0700 #{homedir}/.ssh\n          RUN touch #{homedir}/.ssh/authorized_keys\n          RUN chown #{username} #{homedir}/.ssh/authorized_keys\n          RUN chmod 0600 #{homedir}/.ssh/authorized_keys\n        eos\n        custom = ''\n        Array(@provision_command).each do |cmd|\n          custom << \"RUN #{cmd}\\n\"\n        end\n        ssh_key = \"RUN echo '#{public_key}' >> #{homedir}/.ssh/authorized_keys\"\n        # Empty string to ensure the file ends with a newline.\n        [from, platform, base, custom, ssh_key, ''].join(\"\\n\")\n%>\n\n\n\n\u3053\u308c\u3092driver_config.dockerfile\u306b\u8a2d\u5b9a\u3057\u305f\u30d1\u30b9\u3078\u4fdd\u5b58\u3057\u3001\u500b\u5225\u306e\u30c6\u30b9\u30c8\u74b0\u5883\u306b\u5fc5\u8981\u306aDockerbuild\u3092\u8ffd\u8a18\u3057\u3066\u3042\u3052\u308c\u3070\u4f7f\u3048\u308b\u30cf\u30ba\u3067\u3059\u3002\n\u5b9f\u306e\u3068\u3053\u308d\u3001Kitchen::Driver::Docker.build_dockerfile\u3092\u30b3\u30d4\u30fc\u3057\u3064\u3064\u82e5\u5e72\u624b\u3092\u3044\u308c\u3066\u3001erb\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3068\u3057\u3066\u4f7f\u3048\u308b\u3088\u3046\u306b\u3057\u305f\u3060\u3051\u3067\u3059\u3002\ntest-kitchen\u3067kitchen-docker\u3092\u4f7f\u3046\u5834\u5408\u3001.kitchen.yml\u3067\u30c6\u30b9\u30c8\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30d9\u30fc\u30b9\u30a4\u30e1\u30fc\u30b8\u3092\u8a2d\u5b9a\u3059\u308b\u65b9\u6cd5\u3068\u3057\u3066\u3001\u4ee5\u4e0b\u306e3\u7a2e\u985e\u304c\u3042\u308a\u307e\u3059\u3002\n\n1. \u8a2d\u5b9a\u3057\u306a\u3044\n    (\u5185\u90e8\u3067\u306fKitchen::Driver::Docker.default_image()\u306b\u3088\u3063\u3066\u3001platform.name\u304b\u3089name:TAG\u304c\u4f5c\u3089\u308c\u308b)\n\n    ```yaml:.kitchen.yml\n    ~~~ \u524d\u7565 ~~~    \n    platforms:\n      - name: centos-7.1                   # <= \u3053\u3053\u304b\u3089centos:centos7\u304c\u751f\u6210\u3055\u308c\u308b\n        driver_config:\n          privileged: true\n          run_command: /sbin/init; sleep 3\n    ~~~ \u5f8c\u7565 ~~~\n    ```\n\n2. name:TAG\u3067\u8a2d\u5b9a\n\n    ```yaml:.kitchen.yml\n    ~~~ \u524d\u7565 ~~~    \n    platforms:\n      - name: centos-7.1\n        driver_config:\n          image: centos:centos7            # <= \u30b3\u30ec\n          privileged: true\n          run_command: /sbin/init; sleep 3\n    ~~~ \u5f8c\u7565 ~~~\n    ```\n\n3. Dockerfile\u306e\u30d1\u30b9\u3092\u8a2d\u5b9a\n    (\u5185\u90e8\u3067\u306ferb\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3068\u3057\u3066\u6271\u308f\u308c\u308b\u306e\u3067\u3001eRuby\u30bf\u30b0\u3067\u30de\u30fc\u30af\u30a2\u30c3\u30d7\u53ef\u80fd\u3002)\n\n    ```yaml:.kitchen.yml\n    ~~~ \u524d\u7565 ~~~\n    platforms:\n      - name: centos-7.1\n        driver_config:\n          dockerfile: test/platforms/centos-7.1/Dockerfile # <= \u30b3\u30ec\n          privileged: true\n          run_command: /sbin/init; sleep 3\n    ~~~ \u5f8c\u7565 ~~~\n    ```    \n\n    ```:test/platforms/centos-7.1/Dockerfile\n    FROM centos:centos7\n    ```\n\n\nkitchen-docker\u3067\u306f\u4e0a\u8a181. 2. \u306e\u5834\u5408\u30d9\u30fc\u30b9\u30a4\u30e1\u30fc\u30b8\u3068\u3057\u3066\u8a2d\u5b9a\u3055\u308c\u305f\u30a4\u30e1\u30fc\u30b8\u3092FROM\u3068\u3057\u3001test-kitchen\u3067\u4f7f\u7528\u3059\u308b\u5834\u5408\u306b\u5fc5\u8981\u3068\u306a\u308b\u30d1\u30c3\u30b1\u30fc\u30b8\u3084\u8a2d\u5b9a\u3092\u52a0\u3048\u305fDockerfile\u3092\u4f5c\u3063\u3066`docker build`\u3092\u884c\u3044\u3001\u30d3\u30eb\u30c9\u3055\u308c\u305f\u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\u3092\u30c6\u30b9\u30c8\u74b0\u5883\u3068\u3057\u3066\u4f7f\u7528\u3057\u307e\u3059\u3002\n\u3057\u304b\u3057\u30013. \u306e\u5834\u5408\u306f\u30d1\u30b9\u3067\u8a2d\u5b9a\u3055\u308c\u305fDockerfile\u3092\u305d\u306e\u307e\u307e\u4f7f\u3063\u3066`docker build`\u3059\u308b\u306e\u3067\u3001Dockerfile\u306b1. 2.\u306e\u5834\u5408\u306b\u30d3\u30eb\u30c9\u3055\u308c\u308b\u5185\u5bb9\u304c\u542b\u307e\u308c\u3066\u3044\u306a\u3044\u3068\u30c6\u30b9\u30c8\u74b0\u5883\u3068\u3057\u3066\u4f7f\u7528\u3067\u304d\u307e\u305b\u3093\u3002\n\n\u3068\u3044\u3046\u3053\u3068\u3067\u3001\u305d\u308c\u306b\u5bfe\u5fdc\u3057\u3066\u3044\u308bDockerfile\u304c\u4ee5\u4e0b\u306b\u306a\u308a\u307e\u3059\u3002\n\n```:Dockerfile\n<%=     from = \"FROM #{@image}\"\n        platform = case @platform\n        when 'debian', 'ubuntu'\n          disable_upstart = <<-eos\n            RUN dpkg-divert --local --rename --add /sbin/initctl\n            RUN ln -sf /bin/true /sbin/initctl\n          eos\n          packages = <<-eos\n            ENV DEBIAN_FRONTEND noninteractive\n            RUN apt-get update\n            RUN apt-get install -y sudo openssh-server curl lsb-release\n          eos\n          @disable_upstart ? disable_upstart + packages : packages\n        when 'rhel', 'centos', 'fedora'\n          <<-eos\n            RUN yum clean all\n            RUN yum install -y sudo openssh-server openssh-clients which curl\n            RUN ssh-keygen -t rsa -f /etc/ssh/ssh_host_rsa_key -N ''\n            RUN ssh-keygen -t dsa -f /etc/ssh/ssh_host_dsa_key -N ''\n          eos\n        when 'arch'\n          <<-eos\n            RUN pacman -Syu --noconfirm\n            RUN pacman -S --noconfirm openssh sudo curl\n            RUN ssh-keygen -A -t rsa -f /etc/ssh/ssh_host_rsa_key\n            RUN ssh-keygen -A -t dsa -f /etc/ssh/ssh_host_dsa_key\n          eos\n        when 'gentoo'\n          <<-eos\n            RUN emerge sync\n            RUN emerge net-misc/openssh app-admin/sudo\n            RUN ssh-keygen -A -t rsa -f /etc/ssh/ssh_host_rsa_key\n            RUN ssh-keygen -A -t dsa -f /etc/ssh/ssh_host_dsa_key\n          eos\n        when 'gentoo-paludis'\n          <<-eos\n            RUN cave sync\n            RUN cave resolve -zx net-misc/openssh app-admin/sudo\n            RUN ssh-keygen -A -t rsa -f /etc/ssh/ssh_host_rsa_key\n            RUN ssh-keygen -A -t dsa -f /etc/ssh/ssh_host_dsa_key\n          eos\n        else\n          raise ActionFailed,\n          \"Unknown platform '#{@platform}'\"\n        end\n\n        username = @username\n        password = @password\n        public_key = IO.read(@public_key).strip\n        homedir = username == 'root' ? '/root' : \"/home/#{username}\"\n\n        base = <<-eos\n          RUN if ! getent passwd #{username}; then \\\n                useradd -d #{homedir} -m -s /bin/bash #{username}; \\\n              fi\n          RUN echo #{username}:#{password} | chpasswd\n          RUN echo '#{username} ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers\n          RUN mkdir -p /etc/sudoers.d\n          RUN echo '#{username} ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers.d/#{username}\n          RUN chmod 0440 /etc/sudoers.d/#{username}\n          RUN mkdir -p #{homedir}/.ssh\n          RUN chown -R #{username} #{homedir}/.ssh\n          RUN chmod 0700 #{homedir}/.ssh\n          RUN touch #{homedir}/.ssh/authorized_keys\n          RUN chown #{username} #{homedir}/.ssh/authorized_keys\n          RUN chmod 0600 #{homedir}/.ssh/authorized_keys\n        eos\n        custom = ''\n        Array(@provision_command).each do |cmd|\n          custom << \"RUN #{cmd}\\n\"\n        end\n        ssh_key = \"RUN echo '#{public_key}' >> #{homedir}/.ssh/authorized_keys\"\n        # Empty string to ensure the file ends with a newline.\n        [from, platform, base, custom, ssh_key, ''].join(\"\\n\")\n%>\n\n```\n\n\u3053\u308c\u3092driver_config.dockerfile\u306b\u8a2d\u5b9a\u3057\u305f\u30d1\u30b9\u3078\u4fdd\u5b58\u3057\u3001\u500b\u5225\u306e\u30c6\u30b9\u30c8\u74b0\u5883\u306b\u5fc5\u8981\u306aDockerbuild\u3092\u8ffd\u8a18\u3057\u3066\u3042\u3052\u308c\u3070\u4f7f\u3048\u308b\u30cf\u30ba\u3067\u3059\u3002\n\n\n\u5b9f\u306e\u3068\u3053\u308d\u3001Kitchen::Driver::Docker.build_dockerfile\u3092\u30b3\u30d4\u30fc\u3057\u3064\u3064\u82e5\u5e72\u624b\u3092\u3044\u308c\u3066\u3001erb\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3068\u3057\u3066\u4f7f\u3048\u308b\u3088\u3046\u306b\u3057\u305f\u3060\u3051\u3067\u3059\u3002\n", "tags": ["test-kitchen", "kitchen-docker", "docker"]}