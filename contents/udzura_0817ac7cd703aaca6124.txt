{"context": " More than 1 year has passed since last update.mruby\u30a2\u30c9\u30d9\u30f3\u30c8\u30ab\u30ec\u30f3\u30c0\u30fc\u300121\u65e5\u76ee\u3067\u3059\uff01\uff01\uff01 \u524d\u56de\u306f\u3001harasou\u3055\u3093\u306b\u3088\u308b\u8d85\u4fbf\u5229\u30c4\u30fc\u30eb\u3067\u3057\u305f \u3002\n\u307c\u304f\u3082\u96e3\u3057\u3044\u8a18\u4e8b\u306f\u7121\u7406\u306a\u306e\u3067\u3059\u304c\u3001\u4eca\u65e5\u306f\u3001\u3042\u3093\u3061\u307d\u3055\u3093\u304c\u4ee5\u524d\u30b9\u30d1\u30a4\u30af\u3067\u4f5c\u3063\u3066\u3044\u305f libpam-mruby \u3092\u3044\u3058\u3063\u3066\u307f\u3066\u3001OS\u8a8d\u8a3c\u306emruby\u5316\u306b\u3064\u3044\u3066\u5b9f\u9a13\u3057\u3066\u307f\u308b\u3053\u3068\u306b\u3057\u307e\u3059\u3002\n\nPAM\u306b\u3064\u3044\u3066\u306e\u304a\u3055\u3089\u3044\nPAM\u3068\u306f\u3001 Pluggable Authentication Module \u306e\u7565\u3067\u3001\u5404\u7a2e\u306e\u8a8d\u8a3c\u51e6\u7406\u3092\u5b9f\u884c\u3059\u308b\u30e2\u30b8\u30e5\u30fc\u30eb\u7fa4\u3068\u3001\u305d\u308c\u3092\u5229\u7528\u3059\u308b\u305f\u3081\u306e\u6a19\u6e96\u7684\u306aAPI\u3092\u5099\u3048\u305f\u30e9\u30a4\u30d6\u30e9\u30ea\u306b\u3088\u308b\u8a8d\u8a3c\u30b7\u30b9\u30c6\u30e0\u306e\u547c\u79f0\u3067\u3059\u3002\n\u4ee3\u8868\u7684\u306b\u306f\u3001LDAP\u3001SMB\u306a\u3069\u3067\u306eLinux\u306e\u30e6\u30fc\u30b6\u8a8d\u8a3c\u306b\u5229\u7528\u3055\u308c\u3066\u3044\u308b\u305f\u3081\u3001Linux\u306e\u30e6\u30fc\u30b6\u8a8d\u8a3c\u306e\u305f\u3081\u306e\u30d7\u30e9\u30ac\u30d6\u30eb\u306a\u8a8d\u8a3c\u30b7\u30b9\u30c6\u30e0\u306e\u3053\u3068\u3068\u3044\u3046\u6587\u8108\u3067\u4f7f\u308f\u308c\u308b\u3053\u3068\u304c\u591a\u3044\u3088\u3046\u3067\u3059\u3002\nSamba\u30e6\u30fc\u30b6\u30fc\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u7ba1\u7406 PAM\u3092\u5229\u7528\u3057\u3066\u8a8d\u8a3c\u3092\u884c\u3046 \u3088\u308a\u3001\u56f3\u3092\u5f15\u7528\u3055\u305b\u3066\u3044\u305f\u3060\u304d\u307e\u3059\u3002\n\nlibpam-mruby\u306f\u3001\u305d\u306e\u3088\u3046\u306a\u8a8d\u8a3c\u306e\u4e2d\u8eab\u306e\u30ed\u30b8\u30c3\u30af\u3092mruby\u3092\u7528\u3044\u3066\u8a18\u8ff0\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308bPAM\u30df\u30c9\u30eb\u30a6\u30a7\u30a2\u3067\u3059\u3002\n\n\u307e\u305a\u306f\u30d3\u30eb\u30c9\u3092\u901a\u3059\n\u74b0\u5883\u306fCentOS 7.1\u3067\u3059\u3002\ngit clone https://github.com/pepabo/libpam-mruby.git\ncd libpam-mruby/\nsudo yum groupinstall \"Development Tools\"\nsudo yum install rake pam-devel\nrake\nsudo install build/mruby.so /usr/lib64/security/pam_mruby.so\n\n\u3053\u3053\u307e\u3067\u3067\u4e00\u5fdc\u30d3\u30eb\u30c9\u306f\u3067\u304d\u308b\u306e\u3067\u3059\u304c\u3001\u5b9f\u306f\u8a18\u4e8b\u57f7\u7b46\u76f4\u524d\u306e\u6bb5\u968e 0bd52ea \u3067\u306f\u3001\u3053\u306e\u307e\u307e\u3067\u306f\u30ed\u30fc\u30c9\u3057\u3066\u304f\u308c\u307e\u305b\u3093\u3067\u3057\u305f\u3002syslog\uff08/var/log/secure\uff09\u3092\u898b\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30a8\u30e9\u30fc\u304c\u51fa\u3066\u3044\u307e\u3059\u3002\nPAM unable to dlopen(/usr/lib64/security/pam_mruby.so): /usr/lib64/security/pam_mruby.so: undefined symbol: mrb_str_new_cstr\nPAM adding faulty module: /usr/lib64/security/pam_mruby.so\n\n\u3069\u3046\u3082mruby\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u306a\u3069\u306e\u30ea\u30f3\u30af\u306b\u5931\u6557\u3057\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\n\n\u30d3\u30eb\u30c9\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u5909\u66f4\u3059\u308b\n\u30ea\u30f3\u30af\u3092\u4e0a\u624b\u304f\u884c\u304b\u305b\u308b\u305f\u3081\u306b\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u6700\u5f8c\u306e pam_mruby.so \u3092\u751f\u6210\u3059\u308b\u30b3\u30de\u30f3\u30c9\u3092\u5909\u66f4\u3057\u307e\u3059\uff08\u6210\u679c\u7269\u306e\u540d\u524d\u3082pam\u306e\u898f\u7d04\u306b\u6cbf\u3063\u3066\u5909\u3048\u3066\u304a\u304d\u307e\u3059\uff09\u3002\n--- a/Rakefile\n+++ b/Rakefile\n@@ -21,7 +21,7 @@ end\n\n desc 'build'\n task :build => [:build_mruby_c, :build_pam_c] do\n-  sh 'ld -x --shared -o build/mruby.so build/mruby.o build/pam.o'\n+  sh 'gcc -shared -Wl,-soname=pam_mruby.so.1 -lm -lpam -o build/pam_mruby.so build/mruby.o build/pam.o mruby/build/host/lib/libmruby.a'\n end\n\n desc 'install'\n\n\u307e\u305f\u3001 build_config.rb \u3082\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u3048\u307e\u3059\u3002\n--- a/build_config.rb\n+++ b/build_config.rb\n@@ -1,4 +1,8 @@\n MRuby::Build.new do |conf|\n   toolchain :gcc\n   conf.gembox 'default'\n+\n+  conf.cc do |cc|\n+    cc.flags << '-fPIC'\n+  end\n end\n\n\u3053\u306e\u4e0a\u3067\u30d3\u30eb\u30c9\u3092\u3084\u308a\u76f4\u3059\u3068\u3001\u30ea\u30f3\u30af\u304c\u3044\u3044\u611f\u3058\u306b\u306a\u308a\u3001mruby\u3082 pam_mruby.so \u306e\u4e2d\u306b\u3061\u3083\u3093\u3068\u7d44\u307f\u8fbc\u307e\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n[vagrant@log libpam-mruby]$ ldd build/pam_mruby.so \n        linux-vdso.so.1 =>  (0x00007fffa8973000)\n        libm.so.6 => /lib64/libm.so.6 (0x00007fe657b65000)\n        libpam.so.0 => /lib64/libpam.so.0 (0x00007fe657956000)\n        libc.so.6 => /lib64/libc.so.6 (0x00007fe657594000)\n        libaudit.so.1 => /lib64/libaudit.so.1 (0x00007fe65736e000)\n        libdl.so.2 => /lib64/libdl.so.2 (0x00007fe65716a000)\n        /lib64/ld-linux-x86-64.so.2 (0x00007fe65810b000)\n\n\n\u30d1\u30b9\u30ef\u30fc\u30c9\u3092mruby\u3067\u8a8d\u8b58\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\n\u3053\u3053\u307e\u3067\u3067\u3001mruby\u3067\u8a8d\u8a3c\u304c\u53ef\u80fd\u306b\u306a\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u5b9f\u306f\u3053\u306e\u6bb5\u968e\u3067\u306fmruby\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u3067\u306f\u30e6\u30fc\u30b6\u540d\u3057\u304b\u8a8d\u8a3c\u306b\u5229\u7528\u3067\u304d\u306a\u3044\u306e\u3067\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u8a8d\u8b58\u3067\u304d\u308b\u3088\u3046\u306b\u30b3\u30fc\u30c9\u3092\u5909\u66f4\u3057\u3066\u307f\u307e\u3059\u3002\n\u4ee5\u4e0b\u306e\u3088\u3046\u306bmruby\u5468\u308a\u306e\u5b9a\u7fa9\u3092\u5909\u66f4\u3057\u3001 check \u30e1\u30bd\u30c3\u30c9\u306e\u5f15\u6570\u30921\u3064\u304b\u30892\u3064\u306b\u3057\u307e\u3059\u3002\ndiff --git a/src/mruby.c b/src/mruby.c\nindex 9606465..60c1a52 100644\n--- a/src/mruby.c\n+++ b/src/mruby.c\n@@ -1,12 +1,14 @@\n #include \"mruby.h\"\n\n-int pam_mruby_check(FILE *rbfile, const char *name)\n+int pam_mruby_check(FILE *rbfile, const char *name, const char *passwd)\n {\n   mrb_value ret;\n\n   mrb_state *mrb = mrb_open();\n   mrb_load_file(mrb, rbfile);\n-  ret = mrb_funcall(mrb, mrb_top_self(mrb), \"check\", 1, mrb_str_new_cstr(mrb, name));\n+  ret = mrb_funcall(mrb, mrb_top_self(mrb), \"check\", 2,\n+                    mrb_str_new_cstr(mrb, name),\n+                    mrb_str_new_cstr(mrb, passwd));\n   mrb_close(mrb);\n\n   if (mrb_type(ret) == MRB_TT_TRUE)\ndiff --git a/src/mruby.h b/src/mruby.h\nindex 8075ed5..6a1828e 100644\n--- a/src/mruby.h\n+++ b/src/mruby.h\n@@ -7,6 +7,6 @@\n\n #include <stdio.h>\n\n-int pam_mruby_check(FILE *rbfile, const char *name);\n+int pam_mruby_check(FILE *rbfile, const char *name, const char *passwd);\n\n #endif\n\n\u305d\u3046\u3057\u305f\u3089\u3001PAM\u8a8d\u8a3c\u306e\u809d\u3067\u3042\u308b pam_sm_authenticate \u5185\u90e8\u3067\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u53d6\u5f97\u3059\u308b\u30b3\u30fc\u30c9\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002 pam_get_authtok \u3068\u3044\u3046\u95a2\u6570\u3092\u5229\u7528\u3067\u304d\u308b\u3088\u3046\u3067\u3059\u3002\n--- a/src/pam.c\n+++ b/src/pam.c\n@@ -46,7 +46,12 @@ PAM_EXTERN int pam_sm_authenticate(pam_handle_t *pamh, int flags,int argc, const\n   }\n   if (debug) pam_syslog(pamh, LOG_DEBUG, \"username is %s\", username);\n\n-  ret = pam_mruby_check(rbfile, username);\n+  if (pam_get_authtok(pamh, PAM_AUTHTOK, &password, NULL) != PAM_SUCCESS) {\n+    pam_syslog(pamh, LOG_ERR, \"couldn't get password from PAM stack\");\n+    return PAM_AUTH_ERR;\n+  }\n+\n+  ret = pam_mruby_check(rbfile, username, password);\n   fclose(rbfile);\n\n   if (ret > 0)\n\n\n/etc/pam.d/system-auth-ac\nauth required pam_env.so\n# \u3053\u306e\u884c\u3092\u8ffd\u52a0\nauth sufficient pam_mruby.so rbfile=/etc/pam-mruby.d/auth.rb debug try_first_pass\nauth sufficient pam_unix.so nullok try_first_pass\nauth requisite pam_succeed_if.so uid >= 500 quiet\nauth required pam_deny.so\n\n\n\u307e\u305f\u3001\u3053\u306e\u307e\u307e\u3060\u3068 PAM unable to resolve symbol: pam_sm_setcred \u3068\u3044\u3046\u30ed\u30b0\u304c\uff08\u5b9f\u5bb3\u306f\u306a\u3044\u3088\u3046\u3067\u3059\u304c\uff09\u51fa\u7d9a\u3051\u3066\u3057\u307e\u3046\u306e\u3067\u3001\u4f55\u3082\u3057\u306a\u3044 pam_sm_setcred \u3092\u5b9a\u7fa9\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\ndiff --git a/src/pam.c b/src/pam.c\nindex 5d2abe2..ff7a9f5 100644\n--- a/src/pam.c\n+++ b/src/pam.c\n@@ -59,3 +59,8 @@ PAM_EXTERN int pam_sm_authenticate(pam_handle_t *pamh, int flags,int argc, const\n   else\n     return PAM_AUTH_ERR;\n }\n+\n+PAM_EXTERN int pam_sm_setcred(pam_handle_t *pamh, int flags, int argc, const char **argv)\n+{\n+  return PAM_SUCCESS;\n+}\n\n\u3053\u308c\u3067\u3001\u4e00\u901a\u308a\u306e\u5909\u66f4\u304c\u7d42\u308f\u308a\u307e\u3057\u305f\u306e\u3067\u3001\u30d3\u30eb\u30c9\u3068\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3092\u3084\u308a\u76f4\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\nmruby\u3092\u3064\u304b\u3063\u3066\u30e6\u30fc\u30b6\u8a8d\u8a3c\u3092\u3059\u308b\n\u3042\u3068\u306f\u3001\u4ee5\u4e0b\u306e\u30a8\u30f3\u30c8\u30ea\u3092 /etc/pam.d/system-auth-ac \u306b\u8ffd\u52a0\u3057\u3001\n\n/etc/pam.d/system-auth-ac\nauth required pam_env.so\n# \u3053\u3053\u3092\u8ffd\u52a0\nauth sufficient pam_mruby.so rbfile=/etc/pam-mruby.d/auth.rb debug try_first_pass\nauth sufficient pam_unix.so nullok try_first_pass\nauth requisite pam_succeed_if.so uid >= 500 quiet\nauth required pam_deny.so\n#...\n\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u8a8d\u8a3c\u306e\u305f\u3081\u306emruby\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u7528\u610f\u3057\u3066\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\uff08\u8ffd\u8a18: \u6700\u65b0\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u306f authenticate \u3068\u3044\u3046\u30e1\u30bd\u30c3\u30c9\u3092\u5b9a\u7fa9\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\uff09\n\n/etc/pam-mruby.d/auth.rb\ndef check(username, password)\n  if username == 'udzura'\n    password == 'p@ssw0rd'\n  else\n    true\n  end\nend\n\n\n$ sudo adduser udzura\n## \u96d1\u306bUNIX\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u6f70\u3059\n$ echo \"udzura:$(uuidgen)\" | sudo chpasswd\n$ su - udzura\n\u30d1\u30b9\u30ef\u30fc\u30c9: # <- p@ssw0rd \u3092\u5165\u529b\uff01\n\u6700\u7d42\u30ed\u30b0\u30a4\u30f3: 2015/12/22 (\u706b) 15:23:48 JST\u65e5\u6642 pts/0\n[udzura@mruby ~]$\n\n\u898b\u4e8b\u306bmruby\u3067\u30e6\u30fc\u30b6\u30ed\u30b0\u30a4\u30f3\u304c\u3067\u304d\u307e\u3057\u305f\uff01\n\u8a8d\u8a3c\u624b\u6bb5\u306bmruby\u3092\u5229\u7528\u3067\u304d\u308b\u3053\u3068\u3067\u3001\u4f8b\u3048\u3070\u5916\u90e8API\u3068\u306e\u9023\u643a\u306a\u3069\u3001\u69d8\u3005\u306a\u5fdc\u7528\u304c\u8003\u3048\u3089\u308c\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\u4eca\u56de\u306e\u30b3\u30fc\u30c9\u306e\u6700\u7d42\u7684\u306adiff\u306f \u3053\u3061\u3089\u306ePR \u306b\u3042\u308a\u307e\u3059\u3002\n\nPAM\u306e\u62e1\u5f35\u306b\u3064\u3044\u3066\nPAM\u306e\u62e1\u5f35\u306e\u66f8\u304d\u65b9\u306f\u3001The Linux-PAM Module Writers' Guide \u306e3\u7ae0\u306b\u3088\u308b\u3068\u3001\u4ee5\u4e0b\u306b\u5927\u5225\u3055\u308c\u308b\u305d\u3046\u3067\u3059\u3002\n\n3.2 Authentication management\n3.3 Account management\n3.4 Session management\n3.5 Password management\n\n\u3053\u308c\u306f\u3001 pam.d \u914d\u4e0b\u306e\u30d5\u30a1\u30a4\u30eb\u306e auth/account/session/password \u306e\u9805\u76ee\u306b\u5bfe\u5fdc\u3057\u3066\u3044\u307e\u3059\u3002LDAP\u3067\u306e\u8a8d\u8a3c\u306e\u3088\u3046\u306b\u3001\u81ea\u52d5\u3067LDAP\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u304b\u3089\u30a2\u30ab\u30a6\u30f3\u30c8\u3092\u4f5c\u6210\u3059\u308b\u3088\u3046\u306a\u51e6\u7406\u306f Account management \u3067\u884c\u308f\u308c\u308b\u3088\u3046\u3067\u3059\u304c\u3001\u4eca\u56de\u306f Authentication management \u306e\u307f\u3092\u884c\u3046\u306e\u3067\u3001\u65e2\u5b58\u306e\u30e6\u30fc\u30b6\u306e\u8a8d\u8a3c\u65b9\u6cd5\u3092\u64cd\u4f5c\u3067\u304d\u308b\u3068\u3044\u3046\u3053\u3068\u3067\u3057\u305f\u3002\n\u305d\u306e\u4ed6\u306e\u9805\u76ee\u306b\u3064\u3044\u3066\u3082\u5b9f\u88c5\u3059\u308c\u3070\u3001\u3088\u308a\u4fbf\u5229\u306b\u306a\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\n\u306a\u304a\u3001\u3053\u306e\u30b5\u30f3\u30d7\u30eb\u306f\u3001\u3042\u304f\u307e\u3067\u3082\u30b5\u30f3\u30d7\u30eb\u3068\u3057\u3066\u3001\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u306a\u3069\u306b\u95a2\u3057\u3066\u306f\u4e0d\u5341\u5206\u306a\u7b87\u6240\u3082\u3042\u308b\uff08\u8a8d\u8a3c\u7528\u306emruby\u30d5\u30a1\u30a4\u30eb\u304c\u4e38\u898b\u3048\u3001\u3068\u304b...\uff09\u3053\u3068\u3092\u3054\u7559\u610f\u304f\u3060\u3055\u3044\u3002\n\u660e\u65e5\uff08\u4eca\u65e5...\uff09\u306f\u3001 yasuyuki \u3055\u3093\u3067\u3059\u3002\nmruby\u30a2\u30c9\u30d9\u30f3\u30c8\u30ab\u30ec\u30f3\u30c0\u30fc\u300121\u65e5\u76ee\u3067\u3059\uff01\uff01\uff01 \u524d\u56de\u306f\u3001[harasou\u3055\u3093\u306b\u3088\u308b\u8d85\u4fbf\u5229\u30c4\u30fc\u30eb\u3067\u3057\u305f](https://harasou.github.io/2015/12/20/gfmarkdown-release/) \u3002\n\n\u307c\u304f\u3082\u96e3\u3057\u3044\u8a18\u4e8b\u306f\u7121\u7406\u306a\u306e\u3067\u3059\u304c\u3001\u4eca\u65e5\u306f\u3001\u3042\u3093\u3061\u307d\u3055\u3093\u304c\u4ee5\u524d\u30b9\u30d1\u30a4\u30af\u3067\u4f5c\u3063\u3066\u3044\u305f [libpam-mruby](https://github.com/pepabo/libpam-mruby) \u3092\u3044\u3058\u3063\u3066\u307f\u3066\u3001OS\u8a8d\u8a3c\u306emruby\u5316\u306b\u3064\u3044\u3066\u5b9f\u9a13\u3057\u3066\u307f\u308b\u3053\u3068\u306b\u3057\u307e\u3059\u3002\n\n## PAM\u306b\u3064\u3044\u3066\u306e\u304a\u3055\u3089\u3044\n\nPAM\u3068\u306f\u3001 `Pluggable Authentication Module` \u306e\u7565\u3067\u3001\u5404\u7a2e\u306e\u8a8d\u8a3c\u51e6\u7406\u3092\u5b9f\u884c\u3059\u308b\u30e2\u30b8\u30e5\u30fc\u30eb\u7fa4\u3068\u3001\u305d\u308c\u3092\u5229\u7528\u3059\u308b\u305f\u3081\u306e\u6a19\u6e96\u7684\u306aAPI\u3092\u5099\u3048\u305f\u30e9\u30a4\u30d6\u30e9\u30ea\u306b\u3088\u308b\u8a8d\u8a3c\u30b7\u30b9\u30c6\u30e0\u306e\u547c\u79f0\u3067\u3059\u3002\n\n\u4ee3\u8868\u7684\u306b\u306f\u3001LDAP\u3001SMB\u306a\u3069\u3067\u306eLinux\u306e\u30e6\u30fc\u30b6\u8a8d\u8a3c\u306b\u5229\u7528\u3055\u308c\u3066\u3044\u308b\u305f\u3081\u3001Linux\u306e\u30e6\u30fc\u30b6\u8a8d\u8a3c\u306e\u305f\u3081\u306e\u30d7\u30e9\u30ac\u30d6\u30eb\u306a\u8a8d\u8a3c\u30b7\u30b9\u30c6\u30e0\u306e\u3053\u3068\u3068\u3044\u3046\u6587\u8108\u3067\u4f7f\u308f\u308c\u308b\u3053\u3068\u304c\u591a\u3044\u3088\u3046\u3067\u3059\u3002\n\n[Samba\u30e6\u30fc\u30b6\u30fc\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u7ba1\u7406 PAM\u3092\u5229\u7528\u3057\u3066\u8a8d\u8a3c\u3092\u884c\u3046](http://www.atmarkit.co.jp/flinux/samba/sambatips02/sambatips02.html) \u3088\u308a\u3001\u56f3\u3092\u5f15\u7528\u3055\u305b\u3066\u3044\u305f\u3060\u304d\u307e\u3059\u3002\n\n![\u56f3\u3067\u3059](http://www.atmarkit.co.jp/flinux/samba/sambatips02/Samba3.gif)\n\nlibpam-mruby\u306f\u3001\u305d\u306e\u3088\u3046\u306a\u8a8d\u8a3c\u306e\u4e2d\u8eab\u306e\u30ed\u30b8\u30c3\u30af\u3092mruby\u3092\u7528\u3044\u3066\u8a18\u8ff0\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308bPAM\u30df\u30c9\u30eb\u30a6\u30a7\u30a2\u3067\u3059\u3002\n\n## \u307e\u305a\u306f\u30d3\u30eb\u30c9\u3092\u901a\u3059\n\n\u74b0\u5883\u306fCentOS 7.1\u3067\u3059\u3002\n\n```\ngit clone https://github.com/pepabo/libpam-mruby.git\ncd libpam-mruby/\nsudo yum groupinstall \"Development Tools\"\nsudo yum install rake pam-devel\nrake\nsudo install build/mruby.so /usr/lib64/security/pam_mruby.so\n```\n\n\u3053\u3053\u307e\u3067\u3067\u4e00\u5fdc\u30d3\u30eb\u30c9\u306f\u3067\u304d\u308b\u306e\u3067\u3059\u304c\u3001\u5b9f\u306f\u8a18\u4e8b\u57f7\u7b46\u76f4\u524d\u306e\u6bb5\u968e [`0bd52ea`](https://github.com/pepabo/libpam-mruby/commit/0bd52ea3ff1f5589d35a743dc66eb23cec3e843d) \u3067\u306f\u3001\u3053\u306e\u307e\u307e\u3067\u306f\u30ed\u30fc\u30c9\u3057\u3066\u304f\u308c\u307e\u305b\u3093\u3067\u3057\u305f\u3002syslog\uff08`/var/log/secure`\uff09\u3092\u898b\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30a8\u30e9\u30fc\u304c\u51fa\u3066\u3044\u307e\u3059\u3002\n\n```\nPAM unable to dlopen(/usr/lib64/security/pam_mruby.so): /usr/lib64/security/pam_mruby.so: undefined symbol: mrb_str_new_cstr\nPAM adding faulty module: /usr/lib64/security/pam_mruby.so\n```\n\n\u3069\u3046\u3082mruby\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u306a\u3069\u306e\u30ea\u30f3\u30af\u306b\u5931\u6557\u3057\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\n\n## \u30d3\u30eb\u30c9\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u5909\u66f4\u3059\u308b\n\n\u30ea\u30f3\u30af\u3092\u4e0a\u624b\u304f\u884c\u304b\u305b\u308b\u305f\u3081\u306b\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u6700\u5f8c\u306e `pam_mruby.so` \u3092\u751f\u6210\u3059\u308b\u30b3\u30de\u30f3\u30c9\u3092\u5909\u66f4\u3057\u307e\u3059\uff08\u6210\u679c\u7269\u306e\u540d\u524d\u3082pam\u306e\u898f\u7d04\u306b\u6cbf\u3063\u3066\u5909\u3048\u3066\u304a\u304d\u307e\u3059\uff09\u3002\n\n```diff\n--- a/Rakefile\n+++ b/Rakefile\n@@ -21,7 +21,7 @@ end\n \n desc 'build'\n task :build => [:build_mruby_c, :build_pam_c] do\n-  sh 'ld -x --shared -o build/mruby.so build/mruby.o build/pam.o'\n+  sh 'gcc -shared -Wl,-soname=pam_mruby.so.1 -lm -lpam -o build/pam_mruby.so build/mruby.o build/pam.o mruby/build/host/lib/libmruby.a'\n end\n \n desc 'install'\n```\n\n\u307e\u305f\u3001 `build_config.rb` \u3082\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u3048\u307e\u3059\u3002\n\n```diff\n--- a/build_config.rb\n+++ b/build_config.rb\n@@ -1,4 +1,8 @@\n MRuby::Build.new do |conf|\n   toolchain :gcc\n   conf.gembox 'default'\n+\n+  conf.cc do |cc|\n+    cc.flags << '-fPIC'\n+  end\n end\n```\n\n\u3053\u306e\u4e0a\u3067\u30d3\u30eb\u30c9\u3092\u3084\u308a\u76f4\u3059\u3068\u3001\u30ea\u30f3\u30af\u304c\u3044\u3044\u611f\u3058\u306b\u306a\u308a\u3001mruby\u3082 `pam_mruby.so` \u306e\u4e2d\u306b\u3061\u3083\u3093\u3068\u7d44\u307f\u8fbc\u307e\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n```\n[vagrant@log libpam-mruby]$ ldd build/pam_mruby.so \n        linux-vdso.so.1 =>  (0x00007fffa8973000)\n        libm.so.6 => /lib64/libm.so.6 (0x00007fe657b65000)\n        libpam.so.0 => /lib64/libpam.so.0 (0x00007fe657956000)\n        libc.so.6 => /lib64/libc.so.6 (0x00007fe657594000)\n        libaudit.so.1 => /lib64/libaudit.so.1 (0x00007fe65736e000)\n        libdl.so.2 => /lib64/libdl.so.2 (0x00007fe65716a000)\n        /lib64/ld-linux-x86-64.so.2 (0x00007fe65810b000)\n```\n\n## \u30d1\u30b9\u30ef\u30fc\u30c9\u3092mruby\u3067\u8a8d\u8b58\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\n\n\u3053\u3053\u307e\u3067\u3067\u3001mruby\u3067\u8a8d\u8a3c\u304c\u53ef\u80fd\u306b\u306a\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u5b9f\u306f\u3053\u306e\u6bb5\u968e\u3067\u306fmruby\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u3067\u306f\u30e6\u30fc\u30b6\u540d\u3057\u304b\u8a8d\u8a3c\u306b\u5229\u7528\u3067\u304d\u306a\u3044\u306e\u3067\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u8a8d\u8b58\u3067\u304d\u308b\u3088\u3046\u306b\u30b3\u30fc\u30c9\u3092\u5909\u66f4\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306bmruby\u5468\u308a\u306e\u5b9a\u7fa9\u3092\u5909\u66f4\u3057\u3001 `check` \u30e1\u30bd\u30c3\u30c9\u306e\u5f15\u6570\u30921\u3064\u304b\u30892\u3064\u306b\u3057\u307e\u3059\u3002\n\n```diff\ndiff --git a/src/mruby.c b/src/mruby.c\nindex 9606465..60c1a52 100644\n--- a/src/mruby.c\n+++ b/src/mruby.c\n@@ -1,12 +1,14 @@\n #include \"mruby.h\"\n \n-int pam_mruby_check(FILE *rbfile, const char *name)\n+int pam_mruby_check(FILE *rbfile, const char *name, const char *passwd)\n {\n   mrb_value ret;\n \n   mrb_state *mrb = mrb_open();\n   mrb_load_file(mrb, rbfile);\n-  ret = mrb_funcall(mrb, mrb_top_self(mrb), \"check\", 1, mrb_str_new_cstr(mrb, name));\n+  ret = mrb_funcall(mrb, mrb_top_self(mrb), \"check\", 2,\n+                    mrb_str_new_cstr(mrb, name),\n+                    mrb_str_new_cstr(mrb, passwd));\n   mrb_close(mrb);\n \n   if (mrb_type(ret) == MRB_TT_TRUE)\ndiff --git a/src/mruby.h b/src/mruby.h\nindex 8075ed5..6a1828e 100644\n--- a/src/mruby.h\n+++ b/src/mruby.h\n@@ -7,6 +7,6 @@\n \n #include <stdio.h>\n \n-int pam_mruby_check(FILE *rbfile, const char *name);\n+int pam_mruby_check(FILE *rbfile, const char *name, const char *passwd);\n \n #endif\n```\n\n\u305d\u3046\u3057\u305f\u3089\u3001PAM\u8a8d\u8a3c\u306e\u809d\u3067\u3042\u308b `pam_sm_authenticate` \u5185\u90e8\u3067\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u53d6\u5f97\u3059\u308b\u30b3\u30fc\u30c9\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002 `pam_get_authtok` \u3068\u3044\u3046\u95a2\u6570\u3092\u5229\u7528\u3067\u304d\u308b\u3088\u3046\u3067\u3059\u3002\n\n```diff\n--- a/src/pam.c\n+++ b/src/pam.c\n@@ -46,7 +46,12 @@ PAM_EXTERN int pam_sm_authenticate(pam_handle_t *pamh, int flags,int argc, const\n   }\n   if (debug) pam_syslog(pamh, LOG_DEBUG, \"username is %s\", username);\n \n-  ret = pam_mruby_check(rbfile, username);\n+  if (pam_get_authtok(pamh, PAM_AUTHTOK, &password, NULL) != PAM_SUCCESS) {\n+    pam_syslog(pamh, LOG_ERR, \"couldn't get password from PAM stack\");\n+    return PAM_AUTH_ERR;\n+  }\n+\n+  ret = pam_mruby_check(rbfile, username, password);\n   fclose(rbfile);\n \n   if (ret > 0)\n```\n\n```conf:/etc/pam.d/system-auth-ac\nauth required pam_env.so\n# \u3053\u306e\u884c\u3092\u8ffd\u52a0\nauth sufficient pam_mruby.so rbfile=/etc/pam-mruby.d/auth.rb debug try_first_pass\nauth sufficient pam_unix.so nullok try_first_pass\nauth requisite pam_succeed_if.so uid >= 500 quiet\nauth required pam_deny.so\n```\n\n\u307e\u305f\u3001\u3053\u306e\u307e\u307e\u3060\u3068 `PAM unable to resolve symbol: pam_sm_setcred` \u3068\u3044\u3046\u30ed\u30b0\u304c\uff08\u5b9f\u5bb3\u306f\u306a\u3044\u3088\u3046\u3067\u3059\u304c\uff09\u51fa\u7d9a\u3051\u3066\u3057\u307e\u3046\u306e\u3067\u3001\u4f55\u3082\u3057\u306a\u3044 `pam_sm_setcred` \u3092\u5b9a\u7fa9\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n```diff\ndiff --git a/src/pam.c b/src/pam.c\nindex 5d2abe2..ff7a9f5 100644\n--- a/src/pam.c\n+++ b/src/pam.c\n@@ -59,3 +59,8 @@ PAM_EXTERN int pam_sm_authenticate(pam_handle_t *pamh, int flags,int argc, const\n   else\n     return PAM_AUTH_ERR;\n }\n+\n+PAM_EXTERN int pam_sm_setcred(pam_handle_t *pamh, int flags, int argc, const char **argv)\n+{\n+  return PAM_SUCCESS;\n+}\n```\n\n\u3053\u308c\u3067\u3001\u4e00\u901a\u308a\u306e\u5909\u66f4\u304c\u7d42\u308f\u308a\u307e\u3057\u305f\u306e\u3067\u3001\u30d3\u30eb\u30c9\u3068\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3092\u3084\u308a\u76f4\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n## mruby\u3092\u3064\u304b\u3063\u3066\u30e6\u30fc\u30b6\u8a8d\u8a3c\u3092\u3059\u308b\n\n\u3042\u3068\u306f\u3001\u4ee5\u4e0b\u306e\u30a8\u30f3\u30c8\u30ea\u3092 `/etc/pam.d/system-auth-ac` \u306b\u8ffd\u52a0\u3057\u3001\n\n```conf:/etc/pam.d/system-auth-ac\nauth required pam_env.so\n# \u3053\u3053\u3092\u8ffd\u52a0\nauth sufficient pam_mruby.so rbfile=/etc/pam-mruby.d/auth.rb debug try_first_pass\nauth sufficient pam_unix.so nullok try_first_pass\nauth requisite pam_succeed_if.so uid >= 500 quiet\nauth required pam_deny.so\n#...\n```\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u8a8d\u8a3c\u306e\u305f\u3081\u306emruby\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u7528\u610f\u3057\u3066\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\uff08\u8ffd\u8a18: \u6700\u65b0\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u306f `authenticate` \u3068\u3044\u3046\u30e1\u30bd\u30c3\u30c9\u3092\u5b9a\u7fa9\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\uff09\n\n```rb:/etc/pam-mruby.d/auth.rb\ndef check(username, password)\n  if username == 'udzura'\n    password == 'p@ssw0rd'\n  else\n    true\n  end\nend\n```\n\n```console\n$ sudo adduser udzura\n## \u96d1\u306bUNIX\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u6f70\u3059\n$ echo \"udzura:$(uuidgen)\" | sudo chpasswd\n$ su - udzura\n\u30d1\u30b9\u30ef\u30fc\u30c9: # <- p@ssw0rd \u3092\u5165\u529b\uff01\n\u6700\u7d42\u30ed\u30b0\u30a4\u30f3: 2015/12/22 (\u706b) 15:23:48 JST\u65e5\u6642 pts/0\n[udzura@mruby ~]$\n```\n\n\u898b\u4e8b\u306bmruby\u3067\u30e6\u30fc\u30b6\u30ed\u30b0\u30a4\u30f3\u304c\u3067\u304d\u307e\u3057\u305f\uff01\n\n\u8a8d\u8a3c\u624b\u6bb5\u306bmruby\u3092\u5229\u7528\u3067\u304d\u308b\u3053\u3068\u3067\u3001\u4f8b\u3048\u3070\u5916\u90e8API\u3068\u306e\u9023\u643a\u306a\u3069\u3001\u69d8\u3005\u306a\u5fdc\u7528\u304c\u8003\u3048\u3089\u308c\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u4eca\u56de\u306e\u30b3\u30fc\u30c9\u306e\u6700\u7d42\u7684\u306adiff\u306f [\u3053\u3061\u3089\u306ePR](https://github.com/pepabo/libpam-mruby/pull/1) \u306b\u3042\u308a\u307e\u3059\u3002\n\n## PAM\u306e\u62e1\u5f35\u306b\u3064\u3044\u3066\n\nPAM\u306e\u62e1\u5f35\u306e\u66f8\u304d\u65b9\u306f\u3001[The Linux-PAM Module Writers' Guide](http://uw714doc.sco.com/en/SEC_pam/pam_modules-3.html) \u306e3\u7ae0\u306b\u3088\u308b\u3068\u3001\u4ee5\u4e0b\u306b\u5927\u5225\u3055\u308c\u308b\u305d\u3046\u3067\u3059\u3002\n\n* 3.2 Authentication management\n* 3.3 Account management\n* 3.4 Session management\n* 3.5 Password management\n\n\u3053\u308c\u306f\u3001 pam.d \u914d\u4e0b\u306e\u30d5\u30a1\u30a4\u30eb\u306e `auth/account/session/password` \u306e\u9805\u76ee\u306b\u5bfe\u5fdc\u3057\u3066\u3044\u307e\u3059\u3002LDAP\u3067\u306e\u8a8d\u8a3c\u306e\u3088\u3046\u306b\u3001\u81ea\u52d5\u3067LDAP\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u304b\u3089\u30a2\u30ab\u30a6\u30f3\u30c8\u3092\u4f5c\u6210\u3059\u308b\u3088\u3046\u306a\u51e6\u7406\u306f `Account management` \u3067\u884c\u308f\u308c\u308b\u3088\u3046\u3067\u3059\u304c\u3001\u4eca\u56de\u306f `Authentication management` \u306e\u307f\u3092\u884c\u3046\u306e\u3067\u3001\u65e2\u5b58\u306e\u30e6\u30fc\u30b6\u306e\u8a8d\u8a3c\u65b9\u6cd5\u3092\u64cd\u4f5c\u3067\u304d\u308b\u3068\u3044\u3046\u3053\u3068\u3067\u3057\u305f\u3002\n\n\u305d\u306e\u4ed6\u306e\u9805\u76ee\u306b\u3064\u3044\u3066\u3082\u5b9f\u88c5\u3059\u308c\u3070\u3001\u3088\u308a\u4fbf\u5229\u306b\u306a\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\n----\n\n\u306a\u304a\u3001\u3053\u306e\u30b5\u30f3\u30d7\u30eb\u306f\u3001\u3042\u304f\u307e\u3067\u3082\u30b5\u30f3\u30d7\u30eb\u3068\u3057\u3066\u3001\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u306a\u3069\u306b\u95a2\u3057\u3066\u306f\u4e0d\u5341\u5206\u306a\u7b87\u6240\u3082\u3042\u308b\uff08\u8a8d\u8a3c\u7528\u306emruby\u30d5\u30a1\u30a4\u30eb\u304c\u4e38\u898b\u3048\u3001\u3068\u304b...\uff09\u3053\u3068\u3092\u3054\u7559\u610f\u304f\u3060\u3055\u3044\u3002\n\n\u660e\u65e5\uff08\u4eca\u65e5...\uff09\u306f\u3001 [yasuyuki](http://qiita.com/yasuyuki@github/items/9b23182ae5bf93d01019) \u3055\u3093\u3067\u3059\u3002\n", "tags": ["mruby", "PAM"]}