{"context": "\u524d\u56de(vQFX10000 \u3092 KVM+GNS3 \u3067\u52d5\u304b\u3059)\u3001Juniper vQFX10000(\u4ee5\u964d vQFX) \u306e DL \u6a29\u9650\u3092\u500b\u4eba\u3067\u5f97\u3066 GNS3 \u3067\u8efd\u304f\u52d5\u4f5c\u78ba\u8a8d\u304c\u3068\u308c\u307e\u3057\u305f\u3002\n\u4eca\u56de\u306f\u300c\u4eee\u60f3\u7248\u3063\u3066 L2\u5168\u822c/L2VPN \u7cfb\u6a5f\u80fd\u304c\u52d5\u304b\u306a\u304b\u3063\u305f\u308a\u3059\u308b\u3051\u3069\u3001vQFX \u306f\u3069\u3046\u306a\u3093\u3060\uff1f...\u304a\u3001EVPN \u3082\u3061\u3083\u3093\u3068\u52d5\u304f\u3084\u3093\u3051\uff01\u300d\u3063\u3066\u3068\u3053\u308d\u307e\u3067\u3092\u898b\u3066\u3044\u304d\u307e\u3059\u3002\n\n\u6700\u521d\u306b\n\n\u672c\u9805\u3067\u3084\u308b\u3053\u3068\n\u4ee5\u4e0b\u3092\u3084\u308a\u307e\u3059\u3002\n\nvQFX \u3067 VXLAN \u306e Control Plane \u3068\u3057\u3066 EVPN \u3092\u52d5\u304b\u3059\n\n\n\u4eee\u60f3\u7248\u3060\u3068 L2VPN \u7cfb\u6a5f\u80fd\u304c\u52d5\u304b\u306a\u3044\u30a2\u30d7\u30e9\u30a4\u30a2\u30f3\u30b9\u3082\u3042\u308b\u306e\u3067\n\n\nEVPN \u306e\u9069\u7528\u7bc4\u56f2\u306f L2 \u30b7\u30f3\u30b0\u30eb\u69cb\u6210\u306e\u307f\u3067\u3001DataPlane \u3068\u3057\u3066\u306f VXLAN \u3092\u4f7f\u3046\n\n\nL2VPN \u3078\u306e L3 \u7d71\u5408\u5468\u308a(inter-subnet-forwarding \u5468\u308a)\u3084\u30de\u30eb\u30c1\u30db\u30fc\u30df\u30f3\u30b0\u306a\u3069\u306e\u6a5f\u80fd\u306f\u3001\u4eca\u56de\u306e\u7bc4\u56f2\u5916\nDataplane \u3068\u3057\u3066\u306f VXLAN \u3092\u4f7f\u3044\u3001MPLS \u306f\u53d6\u308a\u6271\u308f\u306a\u3044\n\n\n\nJuniper\u516c\u5f0f | \u30b8\u30e5\u30cb\u30d1\u30fc\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30b9 EVPN \u6b21\u4e16\u4ee3\u30c7\u30fc\u30bf\u30bb\u30f3\u30bf\u30fc \u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306e\u5b9f\u88c5 \u3067 MX \u3068 QFX5100 \u3067\u3084\u3063\u3066\u3044\u308b\u3053\u3068\u306e\u4e00\u90e8\u3092 vQFX10000 \u3067\u8a66\u3059\n\u5404\u8981\u7d20\u6280\u8853\u306e\u8a73\u7d30\u306a\u89e3\u8aac\u306f\u884c\u308f\u306a\u3044\n\n\u500b\u4eba\u7684\u306b\u306f\u30012014/12 \u6642\u70b9\u3067 VXLAN \u306e\u30de\u30eb\u30c1\u30ad\u30e3\u30b9\u30c8\u5b9f\u88c5\u3092\u78ba\u8a8d\u3057\u305f\u6642 (VyOS \u3068 Arista \u3067 VXLAN \u76f8\u4e92\u63a5\u7d9a)\u306b\u5fae\u5999\u3060\u3068\u601d\u3063\u305f\u70b9\u306b\u3082\u7740\u76ee\u3057\u3066\u304a\u304d\u305f\u3044\u3067\u3059\u3002\u4eca\u56de\u3001\u30c7\u30fc\u30bf\u30d7\u30ec\u30fc\u30f3\u5468\u308a\u306f\u307b\u307c\u540c\u3058\u69cb\u6210\u3092\u7d44\u3093\u3067\u307e\u3059\u306e\u3067\u3002\n\n\u4e0a\u306e\u8a18\u4e8b\u306e\u3006\u304c\u300c\u30de\u30eb\u30c1\u30ad\u30e3\u30b9\u30c8\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3092\u52c9\u5f37\u3057\u3088\u3046\u3002\u300d\u3060\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u3053\u306e2\u5e74\u9593\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u30a6\u30c0\u30a6\u30c0\u3084\u3063\u3066\u3044\u3066\u3001\u7279\u306b\u9032\u6357\u306f\u3042\u308a\u307e\u305b\u3093\u3067\u3057\u305f\u3002\n\n\n\u30de\u30eb\u30c1\u30ad\u30e3\u30b9\u30c8\uff1f\u3048\u30fc...\uff1f\u3046\u30fc\u3093...\n\u3048\uff1fOVSDB \u3067\u30b4\u30ea\u30b4\u30ea\uff1f\u3042\u30fc...hmm...\n\u3042\uff1fOVSDB\u3092\u4f7f\u3063\u305f\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u5c0e\u5165\u3067\u30e6\u30cb\u30ad\u30e3\u30b9\u30c8\uff1f\u3048\uff1fNSX\uff1f\u8cb7\u3048\u308b\u304b\u3088...\n\u304a\uff1f\u81ea\u524d\u3067\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u5b9f\u88c5\uff1f\u306f\u306f\u3041...\n\u3093\uff1fMP-BGP\u4f7f\u3063\u305fEVPN\uff1f\u3044\u304b\u306b\u3082\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u5c4b\u304c\u8003\u3048\u305d\u3046&\u98df\u3044\u3064\u304d\u305d\u3046\u3067\u3059\u306d\u3047...\u3067\u3082\u307e\u3042\u91e3\u3089\u308c\u3066\u307f\u308b\u304b\u3042(\u4eca\u3053\u3053)\n\n\n\u4e0a\u306e\u8a18\u4e8b\u3067\u306f VTEP \u9593\u306e\u5230\u9054\u6027\u3092\u3082\u305f\u305b\u308b\u306e\u306b\u300cVyOS \u304c\u8a8d\u8b58\u3057\u306a\u3044\u3068\u3044\u3051\u306a\u3044 Arista \u5074\u306e VTEP IP \u30a2\u30c9\u30ec\u30b9\u306f\u3001Arista \u306e Loopback \u30a2\u30c9\u30ec\u30b9\u306b\u306a\u308b\u306e\u3067\u3001StaticRoute \u3092\u8ffd\u52a0\u3057\u3066\u304a\u304d\u307e\u3059\u3002#\u3053\u308c\u3060\u3068\u62e1\u5f35\u304c\u9762\u5012\u306a\u306e\u3067\u3001\u5b9f\u74b0\u5883\u3067\u306f DefaultRoute \u304b\u52d5\u7684\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3092\u4f7f\u3046\u3053\u3068\u304c\u591a\u3044\u6c17\u304c\u3057\u307e\u3059\u3002\u300d\u3068\u304b\u66f8\u3044\u3066\u307e\u3059\u304c\u3001\u4eca\u56de\u306f\u5b9f\u74b0\u5883\u3092\u3042\u308b\u7a0b\u5ea6\u60f3\u5b9a\u3057\u305f\u4f8b\u793a\u304c\u3067\u304d\u305d\u3046\u3067\u3059\u3002\n\n\n\u6982\u8981\u69cb\u6210\u56f3 / \u74b0\u5883\n\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u69cb\u6210\u3092\u7d44\u3093\u3067\u3044\u304d\u307e\u3059\u3002node11 \u3068 node21 \u304c L2overL3 \u3067\u901a\u4fe1\u3059\u308b\u3084\u3064\u3067\u3059\u3002\n\n\u74b0\u5883\u306f\u3001\u3044\u305a\u308c\u3082\u524d\u56de\u306e\u901a\u308a\u3067\u3059\u3002\n\n\u53c2\u8003\u8cc7\u6599\n\u524d\u8ff0\u306e\u901a\u308a\u3001\u5404\u8981\u7d20\u6280\u8853\u306e\u8a73\u7d30\u306a\u89e3\u8aac\u306f\u653e\u68c4\u3057\u3066\u3044\u307e\u3059\u304c...\u3053\u3093\u306a\u30cb\u30c3\u30c1\u306a\u8a18\u4e8b\u3092\u8aad\u3080\u4eba\u5411\u3051\u306a\u306e\u3067\u3001\u307e\u3042\u306d\uff1f\n\nEVPN \u6a19\u6e96\n\n\nRFC7432 (BGP MPLS-Based Ethernet VPN)\n\nAlcatel-Lucent \u767a\u8868\u8cc7\u6599 | ETHERNET VPN Standardization and Status\n\n2015/11 \u6642\u70b9\u306e\u3082\u306e\n\u30b9\u30e9\u30a4\u30c99\u3042\u305f\u308a\u304c\u6a19\u6e96\u5316\u52d5\u5411\u306e\u6700\u65b0\u306b\u8fd1\u3044\u304b\u306a...\n\n\n\n\nVXLAN \u6a19\u6e96\n\n\n\nRFC7348 (Virtual eXtensible Local Area Network (VXLAN): A Framework for Overlaying Virtualized Layer 2 Networks over Layer 3 Networks)\n\nControl Plane \u5468\u308a\u306f\u30de\u30eb\u30c1\u30ad\u30e3\u30b9\u30c8\u5b9f\u88c5\u304c\u63d0\u793a\u3055\u308c\u3066\u3044\u308b\n\n\n\n\nJUNOS \u3067\u306e VXLAN+EVPN \u5b9f\u88c5\u30fb\u8a2d\u5b9a\u5468\u308a\n\n\n\nJuniper\u516c\u5f0f | \u30b8\u30e5\u30cb\u30d1\u30fc\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30b9 EVPN \u6b21\u4e16\u4ee3\u30c7\u30fc\u30bf\u30bb\u30f3\u30bf\u30fc \u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306e\u5b9f\u88c5\n\nMX \u3068 QFX5100 \u3067 EVPN \u306e\u8a2d\u5b9a\u30b5\u30f3\u30d7\u30eb\u3092 step by step \u3067\u89e3\u8aac\n\u65e5\u672c\u8a9e\u7248\n\n\n\nJuniper\u516c\u5f0f | Junos OS for the QFX Series, Release 15.1X53 (for QFX10000 Switches) / EVPN Control Plane and VXLAN Data Plane Feature Guide for QFX Series Switches\n\nvQFX \u3092\u52d5\u304b\u3059 15.1X53 \u3067\u306e EVPN + VxLAN \u5168\u822c\n\n\n\nJuniper\u516c\u5f0f github | JNPRAutomate/ansible-junos-evpn-vxlan\n\nMX, QFX5100, QFX10000 \u306e EVPN/VXLAN \u30b5\u30f3\u30d7\u30eb\u30b3\u30f3\u30d5\u30a3\u30b0\u3092\u542b\u3080\n\n\n\n\n\n\n\u69cb\u7bc9\uff5e\u52d5\u4f5c\u78ba\u8a8d\n\nGNS3 \u3067\u4eee\u60f3\u30de\u30b7\u30f3\u306e\u30c7\u30d7\u30ed\u30a4 \uff5e \u7d50\u7dda \uff5e \u8d77\u52d5\n\u524d\u56de\u306e\u901a\u308a\u306b\u30013\u30da\u30a2\u306e vQFX \u3092\u30c7\u30d7\u30ed\u30a4\u3057\u3066\u63a5\u7d9a\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\u4ee5\u4e0b\u306e\u611f\u3058\u3067\u3002\n\ntorSW101a \u3068 torSW201a \u3068\u3044\u3046\u306e\u306f\u3001GNS3 \u306e Ethernet Switch \u3092\u4f7f\u3063\u3066\u3044\u307e\u3059\u304c\u3001\u5404\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\u9069\u5f53\u306a dot1Q \u98df\u3048\u308b\u30b9\u30a4\u30c3\u30c1\u7f6e\u3051\u3070\u826f\u3044\u3067\u3059\u3002\n\u8a2d\u5b9a\u306f\u305d\u308c\u305e\u308c\u4ee5\u4e0b\u306e\u611f\u3058\u3067\u3059\u3002(\u4eca\u56de\u306f Port 3-4 \u306f\u4f7f\u3044\u307e\u305b\u3093\u304c)\n\n\nnode11 \u3068 node21 \u306f\u3001\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u306b IP \u30a2\u30c9\u30ec\u30b9\u4ed8\u4e0e\u3059\u308b\u3060\u3051\u306a\u306e\u3067\u3001\u9069\u5f53\u306a\u758e\u901a\u78ba\u8a8d\u7528\u30ce\u30fc\u30c9\u306a\u306e\u3067\u597d\u304d\u306a\u306e\u3092\u3069\u3046\u305e\u3002(node12 \u3068 node22 \u306f\u4eca\u56de\u4f7f\u308f\u306a\u3044\u3067\u3059)\n\u3042\u3068 captureSW \u3068\u3044\u3046\u306e\u306f GNS3 1.5.2 \u3067\u306f github gns3-gui issues | QEMU link Packet Captures \u306e\u901a\u308a\u3001qemu \u540c\u58eb\u306e\u7d50\u7dda\u3092\u30d1\u30b1\u30c3\u30c8\u30ad\u30e3\u30d7\u30c1\u30e3\u3067\u304d\u306a\u3044\u306e\u3067\u3001\u300cbb01 \u3067\u30dd\u30fc\u30c8\u30df\u30e9\u30fc\u30ea\u30f3\u30b0\u300d\u3059\u308b\u624b\u6cd5\u3092\u3068\u3063\u3066\u3044\u308b\u305f\u3081\u306b\u7f6e\u3044\u3066\u3044\u308b\u3082\u306e\u3067\u3059\u3002\n\u672a\u8a66\u884c\u3067\u3059\u304c\u3001RE \u540c\u58eb\u306e\u7d50\u7dda\u3092\u3057\u3066\u3044\u308b\u7b87\u6240(bb01 \u3068 spine[12]1)\u306b\u5168\u3066 Ethernet Switch \u3092\u631f\u3081\u3070\u3001\u30dd\u30fc\u30c8\u30df\u30e9\u30fc\u30ea\u30f3\u30b0\u4e0d\u8981\u3067\u30d1\u30b1\u30c3\u30c8\u30ad\u30e3\u30d7\u30c1\u30e3\u3067\u304d\u308b\u3068\u601d\u3044\u307e\u3059\u3002(\u305d\u3061\u3089\u306e\u65b9\u304c\u3084\u308a\u3084\u3059\u3044\u7b48)\n\u3067\u304d\u305f\u3089\u8d77\u52d5\u3057\u3066\u5f85\u3061\u307e\u3059\u3002\n\n\u57fa\u672c\u8a2d\u5b9a\n\u5404\u74b0\u5883\u306b\u5408\u308f\u305b\u3066 syslog \u306a\u308a NTP \u306a\u308a ssh key \u767b\u9332\u306a\u308a\u3057\u3066\u304a\u3044\u3066\u4e0b\u3055\u3044\u3002\n\u3042\u3001\u4eca\u56de\u306f BGP \u306e\u30ed\u30b0\u3092 /var/log/bgp.log \u306b\u6b8b\u3059\u305f\u3081\u306b\u3001\u4ee5\u4e0b\u3092\u3084\u3063\u3066\u304a\u304f\u3068\u826f\u3044\u3067\u3059\u3088\u3002\nset protocols bgp traceoptions file bgp.log\nset protocols bgp traceoptions file size 10k\nset protocols bgp traceoptions file files 30\nset protocols bgp traceoptions flag normal\n\n\nUnderlay \u8a2d\u5b9a\uff5e\u78ba\u8a8d (\u7269\u7406IF \u3068 eBGP)\n\u307e\u305a\u306f\u7269\u7406 Interface \u3068 eBGP \u5468\u308a\u3092\u8a2d\u5b9a\u3057\u3066\u3001\u5404 lo0 \u306e IP \u30a2\u30c9\u30ec\u30b9\u3092\u7d4c\u8def\u4ea4\u63db\u3067\u304d\u305f\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\u307e\u3042\u3001\u9577\u3005\u3068\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3059\u304c\u3001\u7d75\u306b\u3059\u308b\u3068\u5358\u7d14\u3067\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u611f\u3058\u3067\u3059\u3002\n\n\n\u7269\u7406IF\u8a2d\u5b9a\n\nbb01\nset interfaces xe-0/0/0 description \"DEV=spine11 IF=xe-0/0/0\"\nset interfaces xe-0/0/0 unit 0 family inet address 192.0.2.1/30\ndelete interfaces xe-0/0/0 unit 0 family inet dhcp\n\nset interfaces xe-0/0/1 description \"DEV=spine21 IF=xe-0/0/0\"\nset interfaces xe-0/0/1 unit 0 family inet address 192.0.2.5/30\ndelete interfaces xe-0/0/1 unit 0 family inet dhcp\n\nset protocols lldp port-id-subtype interface-name\nset protocols lldp interface xe-0/0/0\nset protocols lldp interface xe-0/0/1\n\n\nspine11\nset interfaces xe-0/0/0 description \"DEV=bb01 IF=xe-0/0/0\"\nset interfaces xe-0/0/0 unit 0 family inet address 192.0.2.2/30\ndelete interfaces xe-0/0/0 unit 0 family inet dhcp\n\nset protocols lldp port-id-subtype interface-name\nset protocols lldp interface xe-0/0/0\n\n\nspine21\nset interfaces xe-0/0/0 description \"DEV=bb01 IF=xe-0/0/1\"\nset interfaces xe-0/0/0 unit 0 family inet address 192.0.2.6/30\ndelete interfaces xe-0/0/0 unit 0 family inet dhcp\n\nset protocols lldp port-id-subtype interface-name\nset protocols lldp interface xe-0/0/0\n\n\n\u7269\u7406IF\u758e\u901a\u78ba\u8a8d\n\u30ea\u30bd\u30fc\u30b9\u3092\u30b1\u30c1\u3063\u305f\u304b\u3089\u304b RTT \u9577\u3059\u304e\u3067\u3059\u306d...\u3002\n\nbb01\nkotetsu@bb01> show lldp neighbors\nLocal Interface    Parent Interface    Chassis Id          Port info          System Name\nxe-0/0/0           -                   02:05:86:71:84:00   DEV=bb01 IF=xe-0/0/0 spine11            \nxe-0/0/1           -                   02:05:86:71:ff:00   DEV=bb01 IF=xe-0/0/1 spine21\n\n\nkotetsu@bb01> show route\n\ninet.0: 8 destinations, 8 routes (8 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n10.0.0.0/24        *[Direct/0] 19:47:39\n                    > via em0.0\n10.0.0.191/32      *[Local/0] 19:47:39\n                      Local via em0.0\n169.254.0.0/24     *[Direct/0] 19:57:21\n                    > via em1.0\n169.254.0.2/32     *[Local/0] 19:57:21\n                      Local via em1.0\n192.0.2.0/30       *[Direct/0] 00:17:12\n                    > via xe-0/0/0.0\n192.0.2.1/32       *[Local/0] 00:17:12\n                      Local via xe-0/0/0.0\n192.0.2.4/30       *[Direct/0] 00:07:04\n                    > via xe-0/0/1.0\n192.0.2.5/32       *[Local/0] 00:07:04\n                      Local via xe-0/0/1.0\n\ninet6.0: 1 destinations, 1 routes (1 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\nfe80::286:2b0f:fc44:ab00/128\n                   *[Direct/0] 19:56:54\n                    > via lo0.0\n\n{master:0}\nkotetsu@bb01> ping 192.0.2.2\nPING 192.0.2.2 (192.0.2.2): 56 data bytes\n64 bytes from 192.0.2.2: icmp_seq=1 ttl=64 time=2420.112 ms\n64 bytes from 192.0.2.2: icmp_seq=2 ttl=64 time=1027.245 ms\n64 bytes from 192.0.2.2: icmp_seq=3 ttl=64 time=1525.667 ms\n^C\n--- 192.0.2.2 ping statistics ---\n5 packets transmitted, 3 packets received, 40% packet loss\nround-trip min/avg/max/stddev = 1027.245/1657.675/2420.112/576.246 ms\n\n{master:0}\nkotetsu@bb01> ping 192.0.2.6\nPING 192.0.2.6 (192.0.2.6): 56 data bytes\n64 bytes from 192.0.2.6: icmp_seq=0 ttl=64 time=3378.582 ms\n64 bytes from 192.0.2.6: icmp_seq=1 ttl=64 time=1374.159 ms\n64 bytes from 192.0.2.6: icmp_seq=2 ttl=64 time=1474.743 ms\n^C\n--- 192.0.2.6 ping statistics ---\n3 packets transmitted, 3 packets received, 0% packet loss\nround-trip min/avg/max/stddev = 1374.159/2075.828/3378.582/922.101 ms\n\n\nspine11\n{master:0}\nkotetsu@spine11> show lldp neighbors\nLocal Interface    Parent Interface    Chassis Id          Port info          System Name\nxe-0/0/0           -                   02:05:86:71:55:00   DEV=spine11 IF=xe-0/0/0 bb01\n\n\n{master:0}\nkotetsu@spine11> show route\n\ninet.0: 6 destinations, 6 routes (6 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n10.0.0.0/24        *[Direct/0] 19:23:06\n                    > via em0.0\n10.0.0.201/32      *[Local/0] 19:23:06\n                      Local via em0.0\n169.254.0.0/24     *[Direct/0] 19:22:26\n                    > via em1.0\n169.254.0.2/32     *[Local/0] 19:22:26\n                      Local via em1.0\n192.0.2.0/30       *[Direct/0] 00:16:05\n                    > via xe-0/0/0.0\n192.0.2.2/32       *[Local/0] 00:16:05\n                      Local via xe-0/0/0.0\n\ninet6.0: 1 destinations, 1 routes (1 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\nfe80::286:2b0f:fca1:f500/128\n                   *[Direct/0] 19:22:25\n                    > via lo0.0\n\n\n{master:0}\nkotetsu@spine11> ping 192.0.2.1\nPING 192.0.2.1 (192.0.2.1): 56 data bytes\n64 bytes from 192.0.2.1: icmp_seq=0 ttl=64 time=2839.663 ms\n64 bytes from 192.0.2.1: icmp_seq=1 ttl=64 time=2463.433 ms\n64 bytes from 192.0.2.1: icmp_seq=2 ttl=64 time=2269.077 ms\n64 bytes from 192.0.2.1: icmp_seq=3 ttl=64 time=1548.765 ms\n64 bytes from 192.0.2.1: icmp_seq=4 ttl=64 time=844.779 ms\n64 bytes from 192.0.2.1: icmp_seq=5 ttl=64 time=505.582 ms\n64 bytes from 192.0.2.1: icmp_seq=6 ttl=64 time=852.323 ms\n64 bytes from 192.0.2.1: icmp_seq=7 ttl=64 time=1724.594 ms\n^C\n--- 192.0.2.1 ping statistics ---\n9 packets transmitted, 8 packets received, 11% packet loss\nround-trip min/avg/max/stddev = 505.582/1631.027/2839.663/795.890 ms\n\n\nspine21\n{master:0}\nkotetsu@spine21> show lldp neighbors\nLocal Interface    Parent Interface    Chassis Id          Port info          System Name\nxe-0/0/0           -                   02:05:86:71:55:00   DEV=spine21 IF=xe-0/0/0 bb01\n\n\n{master:0}\nkotetsu@spine21> show route\n\ninet.0: 6 destinations, 6 routes (6 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n10.0.0.0/24        *[Direct/0] 08:41:29\n                    > via em0.0\n10.0.0.202/32      *[Local/0] 08:41:30\n                      Local via em0.0\n169.254.0.0/24     *[Direct/0] 08:46:47\n                    > via em1.0\n169.254.0.2/32     *[Local/0] 08:46:47\n                      Local via em1.0\n192.0.2.4/30       *[Direct/0] 00:03:53\n                    > via xe-0/0/0.0\n192.0.2.6/32       *[Local/0] 00:03:53\n                      Local via xe-0/0/0.0\n\ninet6.0: 1 destinations, 1 routes (1 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\nfe80::286:2b0f:fcd0:9b00/128\n                   *[Direct/0] 08:46:47\n                    > via lo0.0\n\n\n{master:0}\nkotetsu@spine21> ping 192.0.2.5\nPING 192.0.2.5 (192.0.2.5): 56 data bytes\n64 bytes from 192.0.2.5: icmp_seq=0 ttl=64 time=427.225 ms\n64 bytes from 192.0.2.5: icmp_seq=1 ttl=64 time=709.372 ms\n64 bytes from 192.0.2.5: icmp_seq=2 ttl=64 time=1231.701 ms\n64 bytes from 192.0.2.5: icmp_seq=3 ttl=64 time=732.131 ms\n^C\n--- 192.0.2.5 ping statistics ---\n4 packets transmitted, 4 packets received, 0% packet loss\nround-trip min/avg/max/stddev = 427.225/775.107/1231.701/289.684 ms\n\n\nlo0 + eBGP \u8a2d\u5b9a\n\u4eca\u56de\u3001\u3044\u305a\u308c\u3082\u30b7\u30f3\u30b0\u30eb\u69cb\u6210\u306a\u306e\u3067\u30de\u30eb\u30c1\u30d1\u30b9\u95a2\u4fc2\u306e\u8a2d\u5b9a\u306f\u5165\u308c\u3066\u3044\u307e\u305b\u3093\u3088\u3002\n\nbb01\nset interfaces lo0 unit 0 family inet address 172.31.0.1/32\n\nset policy-options policy-statement POLICY_EXPORT_LO0 from family inet\nset policy-options policy-statement POLICY_EXPORT_LO0 from protocol direct\nset policy-options policy-statement POLICY_EXPORT_LO0 from route-filter 0.0.0.0/0 prefix-length-range /32-/32\nset policy-options policy-statement POLICY_EXPORT_LO0 then accept\n\nset routing-options router-id 172.31.0.1\nset routing-options autonomous-system 65000\n\nset protocols bgp group BGP_UNDERLAY type external\nset protocols bgp group BGP_UNDERLAY advertise-peer-as\nset protocols bgp group BGP_UNDERLAY family inet unicast loops 2\nset protocols bgp group BGP_UNDERLAY export POLICY_EXPORT_LO0\nset protocols bgp group BGP_UNDERLAY neighbor 192.0.2.2 description spine11\nset protocols bgp group BGP_UNDERLAY neighbor 192.0.2.2 peer-as 65001\nset protocols bgp group BGP_UNDERLAY neighbor 192.0.2.6 description spine21\nset protocols bgp group BGP_UNDERLAY neighbor 192.0.2.6 peer-as 65002\n\n\nspine11\nset interfaces lo0 unit 0 family inet address 172.16.1.1/32\n\nset policy-options policy-statement POLICY_EXPORT_LO0 from family inet\nset policy-options policy-statement POLICY_EXPORT_LO0 from protocol direct\nset policy-options policy-statement POLICY_EXPORT_LO0 from route-filter 0.0.0.0/0 prefix-length-range /32-/32\nset policy-options policy-statement POLICY_EXPORT_LO0 then accept\n\nset routing-options router-id 172.16.1.1\nset routing-options autonomous-system 65001\n\nset protocols bgp group BGP_UNDERLAY type external\nset protocols bgp group BGP_UNDERLAY advertise-peer-as\nset protocols bgp group BGP_UNDERLAY family inet unicast loops 2\nset protocols bgp group BGP_UNDERLAY export POLICY_EXPORT_LO0\nset protocols bgp group BGP_UNDERLAY neighbor 192.0.2.1 description bb00\nset protocols bgp group BGP_UNDERLAY neighbor 192.0.2.1 peer-as 65000\n\n\nspine21\nset interfaces lo0 unit 0 family inet address 172.16.2.1/32\n\nset policy-options policy-statement POLICY_EXPORT_LO0 from family inet\nset policy-options policy-statement POLICY_EXPORT_LO0 from protocol direct\nset policy-options policy-statement POLICY_EXPORT_LO0 from route-filter 0.0.0.0/0 prefix-length-range /32-/32\nset policy-options policy-statement POLICY_EXPORT_LO0 then accept\n\nset routing-options router-id 172.16.2.1\nset routing-options autonomous-system 65002\n\nset protocols bgp group BGP_UNDERLAY type external\nset protocols bgp group BGP_UNDERLAY advertise-peer-as\nset protocols bgp group BGP_UNDERLAY family inet unicast loops 2\nset protocols bgp group BGP_UNDERLAY export POLICY_EXPORT_LO0\nset protocols bgp group BGP_UNDERLAY neighbor 192.0.2.5 description bb00\nset protocols bgp group BGP_UNDERLAY neighbor 192.0.2.5 peer-as 65000\n\n\neBGP\u78ba\u8a8d\n\u305d\u308c\u305e\u308c lo0 \u306e IP\u30a2\u30c9\u30ec\u30b9\u3092\u76f8\u4e92\u5b66\u7fd2\u3057\u305f\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\u3053\u306e\u5f8c\u3084\u308b Overlay \u7528\u306e MP-BGP (iBGP) \u3067 bb01 \u304c Route Reflector \u306b\u306a\u308b\u306e\u3067\u3001\u5b9f\u969b\u306b\u306f bb01 \u3068 spine[12]1 \u3067\u4ea4\u63db\u3067\u304d\u3066\u3044\u308c\u3070\u5341\u5206\u306a\u7b48\u3067\u3059\u304c\u3002\n\nbb01\n{master:0}\nkotetsu@bb01> show bgp summary\nGroups: 1 Peers: 2 Down peers: 1\nTable          Tot Paths  Act Paths Suppressed    History Damp State    Pending\ninet.0\n                       1          1          0          0          0          0\nPeer                     AS      InPkt     OutPkt    OutQ   Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped...\n192.0.2.2             65001          4          4       0       0          20 1/1/1/0              0/0/0/0\n192.0.2.6             65002          1          2       0       0        5:57 OpenConfirm\n\n{master:0}\nkotetsu@bb01> show bgp summary\nGroups: 1 Peers: 2 Down peers: 0\nTable          Tot Paths  Act Paths Suppressed    History Damp State    Pending\ninet.0\n                       2          2          0          0          0          0\nPeer                     AS      InPkt     OutPkt    OutQ   Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped...\n192.0.2.2             65001          4          5       0       0          25 1/1/1/0              0/0/0/0\n192.0.2.6             65002          4          4       0       0           4 1/1/1/0              0/0/0/0\n\n{master:0}\nkotetsu@bb01>\n\n{master:0}\nkotetsu@bb01> show bgp summary\nGroups: 1 Peers: 2 Down peers: 0\nTable          Tot Paths  Act Paths Suppressed    History Damp State    Pending\ninet.0\n                       2          2          0          0          0          0\nPeer                     AS      InPkt     OutPkt    OutQ   Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped...\n192.0.2.2             65001          4          5       0       0          26 1/1/1/0              0/0/0/0\n192.0.2.6             65002          4          4       0       0           5 1/1/1/0              0/0/0/0\n\n\n{master:0}\nkotetsu@bb01> show bgp group BGP_UNDERLAY brief\nGroup Type: External                               Local AS: 65000\n  Name: BGP_UNDERLAY    Index: 0                   Flags: <Export Eval>\n  Export: [ POLICY_EXPORT_LO0 ]\n  Options: <AdvertisePeerAs>\n  Holdtime: 0\n  Total peers: 2        Established: 2\n  192.0.2.2+56114\n  192.0.2.6+49934\n  inet.0: 2/2/2/0\n\n\n{master:0}\nkotetsu@bb01> show bgp neighbor\nPeer: 192.0.2.2+56114 AS 65001 Local: 192.0.2.1+179 AS 65000\n  Description: spine11\n  Group: BGP_UNDERLAY          Routing-Instance: master\n  Forwarding routing-instance: master\n  Type: External    State: Established    Flags: <Sync>\n  Last State: OpenConfirm   Last Event: RecvKeepAlive\n  Last Error: None\n  Export: [ POLICY_EXPORT_LO0 ]\n  Options: <Preference AddressFamily PeerAS Refresh>\n  Options: <AdvertisePeerAs PeerSpecficLoopsAllowed>\n  Address families configured: inet-unicast\n  Holdtime: 90 Preference: 170\n  Number of flaps: 0\n  Peer ID: 172.16.1.1      Local ID: 172.31.0.1        Active Holdtime: 90\n  Keepalive Interval: 30         Group index: 0    Peer index: 0\n  BFD: disabled, down\n  Local Interface: xe-0/0/0.0\n  NLRI for restart configured on peer: inet-unicast\n  NLRI advertised by peer: inet-unicast\n  NLRI for this session: inet-unicast\n  Peer supports Refresh capability (2)\n  Stale routes from peer are kept for: 300\n  Peer does not support Restarter functionality\n  Restart flag received from the peer: Notification\n  NLRI that restart is negotiated for: inet-unicast\n  NLRI of received end-of-rib markers: inet-unicast\n  NLRI of all end-of-rib markers sent: inet-unicast\n  Peer does not support LLGR Restarter functionality\n  Peer supports 4 byte AS extension (peer-as 65001)\n  Peer does not support Addpath\n  Table inet.0 Bit: 10000\n    RIB State: BGP restart is complete\n    Send state: in sync\n    Active prefixes:              1\n    Received prefixes:            1\n    Accepted prefixes:            1\n    Suppressed due to damping:    0\n    Advertised prefixes:          2\n  Last traffic (seconds): Received 23   Sent 5    Checked 56\n  Input messages:  Total 179    Updates 2       Refreshes 0     Octets 3478\n  Output messages: Total 186    Updates 2       Refreshes 0     Octets 3663\n  Output Queue[0]: 0            (inet.0, inet-unicast)\n\nPeer: 192.0.2.6+49934 AS 65002 Local: 192.0.2.5+179 AS 65000\n  Description: spine21\n  Group: BGP_UNDERLAY          Routing-Instance: master\n  Forwarding routing-instance: master\n  Type: External    State: Established    Flags: <Sync>\n  Last State: OpenConfirm   Last Event: RecvKeepAlive\n  Last Error: None\n  Export: [ POLICY_EXPORT_LO0 ]\n  Options: <Preference AddressFamily PeerAS Refresh>\n  Options: <AdvertisePeerAs PeerSpecficLoopsAllowed>\n  Address families configured: inet-unicast\n  Holdtime: 90 Preference: 170\n  Number of flaps: 0\n  Peer ID: 172.16.2.1      Local ID: 172.31.0.1        Active Holdtime: 90\n  Keepalive Interval: 30         Group index: 0    Peer index: 1\n  BFD: disabled, down\n  Local Interface: xe-0/0/1.0\n  NLRI for restart configured on peer: inet-unicast\n  NLRI advertised by peer: inet-unicast\n  NLRI for this session: inet-unicast\n  Peer supports Refresh capability (2)\n  Stale routes from peer are kept for: 300\n  Peer does not support Restarter functionality\n  Restart flag received from the peer: Notification\n  NLRI that restart is negotiated for: inet-unicast\n  NLRI of received end-of-rib markers: inet-unicast\n  NLRI of all end-of-rib markers sent: inet-unicast\n  Peer does not support LLGR Restarter functionality\n  Peer supports 4 byte AS extension (peer-as 65002)\n  Peer does not support Addpath\n  Table inet.0 Bit: 10000\n    RIB State: BGP restart is complete\n    Send state: in sync\n    Active prefixes:              1\n    Received prefixes:            1\n    Accepted prefixes:            1\n    Suppressed due to damping:    0\n    Advertised prefixes:          2\n  Last traffic (seconds): Received 54   Sent 19   Checked 15\n  Input messages:  Total 92     Updates 2       Refreshes 0     Octets 1825\n  Output messages: Total 184    Updates 2       Refreshes 0     Octets 3625\n  Output Queue[0]: 0            (inet.0, inet-unicast)\n\n{master:0}\nkotetsu@bb01> show route protocol bgp\n\ninet.0: 11 destinations, 11 routes (11 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n172.16.1.1/32      *[BGP/170] 00:02:11, localpref 100\n                      AS path: 65001 I, validation-state: unverified\n                    > to 192.0.2.2 via xe-0/0/0.0\n172.16.2.1/32      *[BGP/170] 00:01:49, localpref 100\n                      AS path: 65002 I, validation-state: unverified\n                    > to 192.0.2.6 via xe-0/0/1.0\n\ninet6.0: 1 destinations, 1 routes (1 active, 0 holddown, 0 hidden)\n\n\n{master:0}\nkotetsu@bb01> ping 172.16.2.1\nPING 172.16.2.1 (172.16.2.1): 56 data bytes\n64 bytes from 172.16.2.1: icmp_seq=0 ttl=64 time=908.929 ms\n64 bytes from 172.16.2.1: icmp_seq=1 ttl=64 time=1249.259 ms\n^C\n--- 172.16.2.1 ping statistics ---\n3 packets transmitted, 2 packets received, 33% packet loss\nround-trip min/avg/max/stddev = 908.929/1079.094/1249.259/170.165 ms\n\n\n{master:0}\nkotetsu@bb01> ping 172.16.1.1\nPING 172.16.1.1 (172.16.1.1): 56 data bytes\n64 bytes from 172.16.1.1: icmp_seq=0 ttl=64 time=2595.413 ms\n64 bytes from 172.16.1.1: icmp_seq=1 ttl=64 time=1406.501 ms\n^C\n--- 172.16.1.1 ping statistics ---\n3 packets transmitted, 2 packets received, 33% packet loss\nround-trip min/avg/max/stddev = 1406.501/2000.957/2595.413/594.456 ms\n\n\nspine11\n{master:0}\nkotetsu@spine11> show bgp summary\nGroups: 1 Peers: 1 Down peers: 0\nTable          Tot Paths  Act Paths Suppressed    History Damp State    Pending\ninet.0\n                       2          2          0          0          0          0\nPeer                     AS      InPkt     OutPkt    OutQ   Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped...\n192.0.2.1             65000        174        169       0       0     1:16:34 2/2/2/0              0/0/0/0\n\n\n{master:0}\nkotetsu@spine11> show bgp group BGP_UNDERLAY brief\nGroup Type: External                               Local AS: 65001\n  Name: BGP_UNDERLAY    Index: 0                   Flags: <Export Eval>\n  Export: [ POLICY_EXPORT_LO0 ]\n  Options: <AdvertisePeerAs>\n  Holdtime: 0\n  Total peers: 1        Established: 1\n  192.0.2.1+179\n  inet.0: 2/2/2/0\n\n\n{master:0}\nkotetsu@spine11> show bgp neighbor\nPeer: 192.0.2.1+179 AS 65000   Local: 192.0.2.2+56114 AS 65001\n  Description: bb00\n  Group: BGP_UNDERLAY          Routing-Instance: master\n  Forwarding routing-instance: master\n  Type: External    State: Established    Flags: <Sync>\n  Last State: OpenConfirm   Last Event: RecvKeepAlive\n  Last Error: None\n  Export: [ POLICY_EXPORT_LO0 ]\n  Options: <Preference AddressFamily PeerAS Refresh>\n  Options: <AdvertisePeerAs PeerSpecficLoopsAllowed>\n  Address families configured: inet-unicast\n  Holdtime: 90 Preference: 170\n  Number of flaps: 0\n  Peer ID: 172.31.0.1      Local ID: 172.16.1.1        Active Holdtime: 90\n  Keepalive Interval: 30         Group index: 0    Peer index: 0\n  BFD: disabled, down\n  Local Interface: xe-0/0/0.0\n  NLRI for restart configured on peer: inet-unicast\n  NLRI advertised by peer: inet-unicast\n  NLRI for this session: inet-unicast\n  Peer supports Refresh capability (2)\n  Stale routes from peer are kept for: 300\n  Peer does not support Restarter functionality\n  Restart flag received from the peer: Notification\n  NLRI that restart is negotiated for: inet-unicast\n  NLRI of received end-of-rib markers: inet-unicast\n  NLRI of all end-of-rib markers sent: inet-unicast\n  Peer does not support LLGR Restarter functionality\n  Peer supports 4 byte AS extension (peer-as 65000)\n  Peer does not support Addpath\n  Table inet.0 Bit: 10000\n    RIB State: BGP restart is complete\n    Send state: in sync\n    Active prefixes:              2\n    Received prefixes:            2\n    Accepted prefixes:            2\n    Suppressed due to damping:    0\n    Advertised prefixes:          1\n  Last traffic (seconds): Received 9    Sent 7    Checked 50\n  Input messages:  Total 182    Updates 3       Refreshes 0     Octets 3524\n  Output messages: Total 177    Updates 1       Refreshes 0     Octets 3459\n  Output Queue[0]: 0            (inet.0, inet-unicast)\n\n{master:0}\nkotetsu@spine11> show route protocol bgp\n\ninet.0: 9 destinations, 9 routes (9 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n172.16.2.1/32      *[BGP/170] 01:22:49, localpref 100\n                      AS path: 65000 65002 I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n172.31.0.1/32      *[BGP/170] 01:23:10, localpref 100\n                      AS path: 65000 I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n\ninet6.0: 1 destinations, 1 routes (1 active, 0 holddown, 0 hidden)\n\n\n{master:0}\nkotetsu@spine11> ping 172.31.0.1\nPING 172.31.0.1 (172.31.0.1): 56 data bytes\n64 bytes from 172.31.0.1: icmp_seq=0 ttl=64 time=1597.291 ms\n64 bytes from 172.31.0.1: icmp_seq=1 ttl=64 time=1215.306 ms\n^C\n--- 172.31.0.1 ping statistics ---\n2 packets transmitted, 2 packets received, 0% packet loss\nround-trip min/avg/max/stddev = 1215.306/1406.299/1597.291/190.993 ms\n\n\n\nspine21\n{master:0}\nkotetsu@spine21> show bgp summary\nGroups: 1 Peers: 1 Down peers: 0\nTable          Tot Paths  Act Paths Suppressed    History Damp State    Pending\ninet.0\n                       2          2          0          0          0          0\nPeer                     AS      InPkt     OutPkt    OutQ   Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped...\n192.0.2.5             65000        173         88       0       0       38:05 2/2/2/0              0/0/0/0\n\n\n{master:0}\nkotetsu@spine21> show bgp group BGP_UNDERLAY brief\nGroup Type: External                               Local AS: 65002\n  Name: BGP_UNDERLAY    Index: 0                   Flags: <Export Eval>\n  Export: [ POLICY_EXPORT_LO0 ]\n  Options: <AdvertisePeerAs>\n  Holdtime: 0\n  Total peers: 1        Established: 1\n  192.0.2.5+179\n  inet.0: 2/2/2/0\n\n\nkotetsu@spine21> show bgp neighbor\nPeer: 192.0.2.5+179 AS 65000   Local: 192.0.2.6+49934 AS 65002\n  Description: bb00\n  Group: BGP_UNDERLAY          Routing-Instance: master\n  Forwarding routing-instance: master\n  Type: External    State: Established    Flags: <Sync>\n  Last State: OpenConfirm   Last Event: RecvKeepAlive\n  Last Error: None\n  Export: [ POLICY_EXPORT_LO0 ]\n  Options: <Preference AddressFamily PeerAS Refresh>\n  Options: <AdvertisePeerAs PeerSpecficLoopsAllowed>\n  Address families configured: inet-unicast\n  Holdtime: 90 Preference: 170\n  Number of flaps: 0\n  Peer ID: 172.31.0.1      Local ID: 172.16.2.1        Active Holdtime: 90\n  Keepalive Interval: 30         Group index: 0    Peer index: 0\n  BFD: disabled, down\n  Local Interface: xe-0/0/0.0\n  NLRI for restart configured on peer: inet-unicast\n  NLRI advertised by peer: inet-unicast\n  NLRI for this session: inet-unicast\n  Peer supports Refresh capability (2)\n  Stale routes from peer are kept for: 300\n  Peer does not support Restarter functionality\n  Restart flag received from the peer: Notification\n  NLRI that restart is negotiated for: inet-unicast\n  NLRI of received end-of-rib markers: inet-unicast\n  NLRI of all end-of-rib markers sent: inet-unicast\n  Peer does not support LLGR Restarter functionality\n  Peer supports 4 byte AS extension (peer-as 65000)\n  Peer does not support Addpath\n  Table inet.0 Bit: 10000\n    RIB State: BGP restart is complete\n    Send state: in sync\n    Active prefixes:              2\n    Received prefixes:            2\n    Accepted prefixes:            2\n    Suppressed due to damping:    0\n    Advertised prefixes:          1\n  Last traffic (seconds): Received 1    Sent 24   Checked 3\n  Input messages:  Total 175    Updates 3       Refreshes 0     Octets 3391\n  Output messages: Total 88     Updates 1       Refreshes 0     Octets 1768\n  Output Queue[0]: 0            (inet.0, inet-unicast)\n\n{master:0}\nkotetsu@spine21> show route protocol bgp\n\ninet.0: 9 destinations, 9 routes (9 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n172.16.1.1/32      *[BGP/170] 00:41:43, localpref 100\n                      AS path: 65000 65001 I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n172.31.0.1/32      *[BGP/170] 00:41:43, localpref 100\n                      AS path: 65000 I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n\ninet6.0: 1 destinations, 1 routes (1 active, 0 holddown, 0 hidden)\n\n\n{master:0}\nkotetsu@spine21> ping 172.31.0.1\nPING 172.31.0.1 (172.31.0.1): 56 data bytes\n64 bytes from 172.31.0.1: icmp_seq=0 ttl=64 time=691.327 ms\n64 bytes from 172.31.0.1: icmp_seq=1 ttl=64 time=1227.117 ms\n64 bytes from 172.31.0.1: icmp_seq=2 ttl=64 time=238.494 ms\n^C\n--- 172.31.0.1 ping statistics ---\n3 packets transmitted, 3 packets received, 0% packet loss\nround-trip min/avg/max/stddev = 238.494/718.979/1227.117/404.077 ms\n\n\n\nOverlay \u8a2d\u5b9a\uff5e\u78ba\u8a8d (MP-BGP)\nUnderlay eBGP \u3067\u7d4c\u8def\u4ea4\u63db\u3057\u305f\u5404 lo0 \u540c\u58eb\u3067 iBGP \u3092\u7d44\u307f\u307e\u3059\u3002\n\u307e\u3042\u3001\u9577\u3005\u3068\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3059\u304c\u3001\u7d75\u306b\u3059\u308b\u3068\u5358\u7d14\u3067\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u611f\u3058\u3067\u3059\u3002\n\n\niBGP (MP-BGP )\u8a2d\u5b9a\n\u30dd\u30a4\u30f3\u30c8\u306f1\u3064\u3060\u3051\u3067 family evpn signaling \u3092\u8a2d\u5b9a\u3057\u3066 EVPN \u306e NLRI \u3092\u6271\u3046\u3063\u3066\u3068\u3053\u3067\u3059\u304b\u306d\u3002\n\nbb01\nset protocols bgp group BGP_OVERLAY type internal\nset protocols bgp group BGP_OVERLAY local-address 172.31.0.1\nset protocols bgp group BGP_OVERLAY family evpn signaling\nset protocols bgp group BGP_OVERLAY cluster 172.31.0.1\nset protocols bgp group BGP_OVERLAY local-as 64512\nset protocols bgp group BGP_OVERLAY neighbor 172.16.1.1 description spine11\nset protocols bgp group BGP_OVERLAY neighbor 172.16.2.1 description spine21\n\n\nspine11\nset protocols bgp group BGP_OVERLAY type internal\nset protocols bgp group BGP_OVERLAY local-address 172.16.1.1\nset protocols bgp group BGP_OVERLAY family evpn signaling\nset protocols bgp group BGP_OVERLAY local-as 64512\nset protocols bgp group BGP_OVERLAY neighbor 172.31.0.1 description bb01\n\n\nspine21\nset protocols bgp group BGP_OVERLAY type internal\nset protocols bgp group BGP_OVERLAY local-address 172.16.2.1\nset protocols bgp group BGP_OVERLAY family evpn signaling\nset protocols bgp group BGP_OVERLAY local-as 64512\nset protocols bgp group BGP_OVERLAY neighbor 172.31.0.1 description bb01\n\n\niBGP (MP-BGP) \u78ba\u8a8d\n\u6700\u521d neighbor IP \u30a2\u30c9\u30ec\u30b9\u8a2d\u5b9a\u3092\u30bf\u30a4\u30dd\u3057\u305f\u305b\u3044\u3067\u3001Last Error: Open Message Error \u3068\u304b\u6b8b\u3063\u3066\u3044\u308b\u306e\u306f\u3054\u611b\u656c\u3068\u3044\u3046\u3053\u3068\u3067\u3072\u3068\u3064...\u3002\n\nbb01\n{master:0}\nkotetsu@bb01> show bgp summary\nGroups: 2 Peers: 4 Down peers: 0\nTable          Tot Paths  Act Paths Suppressed    History Damp State    Pending\ninet.0\n                       2          2          0          0          0          0\nbgp.evpn.0\n                       0          0          0          0          0          0\nPeer                     AS      InPkt     OutPkt    OutQ   Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped...\n172.16.1.1            64512          3          3       0       0          25 Establ\n  bgp.evpn.0: 0/0/0/0\n172.16.2.1            64512          3          2       0       0          12 Establ\n  bgp.evpn.0: 0/0/0/0\n192.0.2.2             65001        502        518       0       0     3:58:25 1/1/1/0              0/0/0/0\n192.0.2.6             65002        257        517       0       0     3:58:04 1/1/1/0              0/0/0/0\n\n\n{master:0}\nkotetsu@bb01> show bgp group BGP_OVERLAY\nGroup Type: Internal    AS: 64512                  Local AS: 64512\n  Name: BGP_OVERLAY     Index: 1                   Flags: <Export Eval>\n  Options: <Cluster LocalAS>\n  Holdtime: 0 Local AS: 64512 Local System AS: 65000\n  Total peers: 2        Established: 2\n  172.16.1.1+52050\n  172.16.2.1+62794\n  Trace options: normal\n  Trace file: /var/log/bgp.log size 10240 files 30\n  bgp.evpn.0: 0/0/0/0\n\n\n{master:0}\nkotetsu@bb01> show bgp neighbor\nPeer: 172.16.1.1+52050 AS 64512 Local: 172.31.0.1+179 AS 64512\n  Description: spine11\n  Group: BGP_OVERLAY           Routing-Instance: master\n  Forwarding routing-instance: master\n  Type: Internal    State: Established  (route reflector client)Flags: <Sync>\n  Last State: OpenConfirm   Last Event: RecvKeepAlive\n  Last Error: Open Message Error\n  Options: <Preference LocalAddress Cluster AddressFamily LocalAS Rib-group Refresh>\n  Address families configured: evpn\n  Local Address: 172.31.0.1 Holdtime: 90 Preference: 170 Local AS: 64512 Local System AS: 65000\n  Number of flaps: 0\n  Error: 'Open Message Error' Sent: 20 Recv: 0\n  Peer ID: 172.16.1.1      Local ID: 172.31.0.1        Active Holdtime: 90\n  Keepalive Interval: 30         Group index: 1    Peer index: 0\n  BFD: disabled, down\n  NLRI for restart configured on peer: evpn\n  NLRI advertised by peer: evpn\n  NLRI for this session: evpn\n  Peer supports Refresh capability (2)\n  Stale routes from peer are kept for: 300\n  Peer does not support Restarter functionality\n  Restart flag received from the peer: Notification\n  NLRI that restart is negotiated for: evpn\n  NLRI of received end-of-rib markers: evpn\n  NLRI of all end-of-rib markers sent: evpn\n  Peer does not support LLGR Restarter functionality\n  Peer supports 4 byte AS extension (peer-as 64512)\n  Peer does not support Addpath\n  Table bgp.evpn.0 Bit: 20000\n    RIB State: BGP restart is complete\n    RIB State: VPN restart is complete\n    Send state: in sync\n    Active prefixes:              0\n    Received prefixes:            0\n    Accepted prefixes:            0\n    Suppressed due to damping:    0\n    Advertised prefixes:          0\n  Last traffic (seconds): Received 1    Sent 9    Checked 0\n  Input messages:  Total 6      Updates 1       Refreshes 0     Octets 169\n  Output messages: Total 6      Updates 0       Refreshes 0     Octets 188\n  Output Queue[1]: 0            (bgp.evpn.0, evpn)\n  Trace options: normal\n  Trace file: /var/log/bgp.log size 10240 files 30\n\nPeer: 172.16.2.1+62794 AS 64512 Local: 172.31.0.1+179 AS 64512\n  Description: spine21\n  Group: BGP_OVERLAY           Routing-Instance: master\n  Forwarding routing-instance: master\n  Type: Internal    State: Established  (route reflector client)Flags: <Sync>\n  Last State: OpenConfirm   Last Event: RecvKeepAlive\n  Last Error: Open Message Error\n  Options: <Preference LocalAddress Cluster AddressFamily LocalAS Rib-group Refresh>\n  Address families configured: evpn\n  Local Address: 172.31.0.1 Holdtime: 90 Preference: 170 Local AS: 64512 Local System AS: 65000\n  Number of flaps: 0\n  Error: 'Open Message Error' Sent: 20 Recv: 0\n  Peer ID: 172.16.2.1      Local ID: 172.31.0.1        Active Holdtime: 90\n  Keepalive Interval: 30         Group index: 1    Peer index: 1\n  BFD: disabled, down\n  NLRI for restart configured on peer: evpn\n  NLRI advertised by peer: evpn\n  NLRI for this session: evpn\n  Peer supports Refresh capability (2)\n  Stale routes from peer are kept for: 300\n  Peer does not support Restarter functionality\n  Restart flag received from the peer: Notification\n  NLRI that restart is negotiated for: evpn\n  NLRI of received end-of-rib markers: evpn\n  NLRI of all end-of-rib markers sent: evpn\n  Peer does not support LLGR Restarter functionality\n  Peer supports 4 byte AS extension (peer-as 64512)\n  Peer does not support Addpath\n  Table bgp.evpn.0 Bit: 20000\n    RIB State: BGP restart is complete\n    RIB State: VPN restart is complete\n    Send state: in sync\n    Active prefixes:              0\n    Received prefixes:            0\n    Accepted prefixes:            0\n    Suppressed due to damping:    0\n    Advertised prefixes:          0\n  Last traffic (seconds): Received 46   Sent 0    Checked 9\n  Input messages:  Total 10     Updates 1       Refreshes 0     Octets 245\n  Output messages: Total 18     Updates 0       Refreshes 0     Octets 416\n  Output Queue[1]: 0            (bgp.evpn.0, evpn)\n  Trace options: normal\n  Trace file: /var/log/bgp.log size 10240 files 30\n\n...\n\n\n\nspine11\n{master:0}\nkotetsu@spine11> show bgp summary\nGroups: 2 Peers: 2 Down peers: 0\nTable          Tot Paths  Act Paths Suppressed    History Damp State    Pending\ninet.0\n                       2          2          0          0          0          0\nbgp.evpn.0\n                       0          0          0          0          0          0\nPeer                     AS      InPkt     OutPkt    OutQ   Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped...\n172.31.0.1            64512         21         22       0       0        9:07 Establ\n  bgp.evpn.0: 0/0/0/0\n192.0.2.1             65000        536        521       0       0     3:59:55 2/2/2/0              0/0/0/\n\n\n{master:0}\nkotetsu@spine11> show bgp group BGP_OVERLAY\nGroup Type: Internal    AS: 64512                  Local AS: 64512\n  Name: BGP_OVERLAY     Index: 1                   Flags: <Export Eval>\n  Options: <LocalAS>\n  Holdtime: 0 Local AS: 64512 Local System AS: 65001\n  Total peers: 1        Established: 1\n  172.31.0.1+179\n  Trace options: normal\n  Trace file: /var/log/bgp.log size 10240 files 30\n  bgp.evpn.0: 0/0/0/0\n\n\n{master:0}\nkotetsu@spine11> show bgp neighbor\nPeer: 172.31.0.1+179 AS 64512  Local: 172.16.1.1+52050 AS 64512\n  Description: bb01\n  Group: BGP_OVERLAY           Routing-Instance: master\n  Forwarding routing-instance: master\n  Type: Internal    State: Established    Flags: <Sync>\n  Last State: OpenConfirm   Last Event: RecvKeepAlive\n  Last Error: None\n  Options: <Preference LocalAddress AddressFamily LocalAS Rib-group Refresh>\n  Address families configured: evpn\n  Local Address: 172.16.1.1 Holdtime: 90 Preference: 170 Local AS: 64512 Local System AS: 65001\n  Number of flaps: 0\n  Peer ID: 172.31.0.1      Local ID: 172.16.1.1        Active Holdtime: 90\n  Keepalive Interval: 30         Group index: 1    Peer index: 1\n  BFD: disabled, down\n  NLRI for restart configured on peer: evpn\n  NLRI advertised by peer: evpn\n  NLRI for this session: evpn\n  Peer supports Refresh capability (2)\n  Stale routes from peer are kept for: 300\n  Peer does not support Restarter functionality\n  Restart flag received from the peer: Notification\n  NLRI that restart is negotiated for: evpn\n  NLRI of received end-of-rib markers: evpn\n  NLRI of all end-of-rib markers sent: evpn\n  Peer does not support LLGR Restarter functionality\n  Peer supports 4 byte AS extension (peer-as 64512)\n  Peer does not support Addpath\n  Table bgp.evpn.0\n    RIB State: BGP restart is complete\n    RIB State: VPN restart is complete\n    Send state: not advertising\n    Active prefixes:              0\n    Received prefixes:            0\n    Accepted prefixes:            0\n    Suppressed due to damping:    0\n  Last traffic (seconds): Received 1    Sent 8    Checked 46\n  Input messages:  Total 34     Updates 1       Refreshes 0     Octets 657\n  Output messages: Total 34     Updates 0       Refreshes 0     Octets 720\n  Trace options: normal\n  Trace file: /var/log/bgp.log size 10240 files 30\n\n...\n\n\n\nspine21\n{master:0}\nkotetsu@spine21> show bgp summary\nGroups: 2 Peers: 2 Down peers: 0\nTable          Tot Paths  Act Paths Suppressed    History Damp State    Pending\ninet.0\n                       2          2          0          0          0          0\nbgp.evpn.0\n                       0          0          0          0          0          0\nPeer                     AS      InPkt     OutPkt    OutQ   Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped...\n172.31.0.1            64512         34         19       0       0        7:30 Establ\n  bgp.evpn.0: 0/0/0/0\n192.0.2.5             65000        549        273       0       0     2:02:08 2/2/2/0              0/0/0/0\n\n\n{master:0}\nkotetsu@spine21> show bgp group BGP_OVERLAY\nGroup Type: Internal    AS: 64512                  Local AS: 64512\n  Name: BGP_OVERLAY     Index: 1                   Flags: <Export Eval>\n  Options: <LocalAS>\n  Holdtime: 0 Local AS: 64512 Local System AS: 65002\n  Total peers: 1        Established: 1\n  172.31.0.1+179\n  Trace options: normal\n  Trace file: /var/log/bgp.log size 10240 files 30\n  bgp.evpn.0: 0/0/0/0\n\n\n{master:0}\nkotetsu@spine21> show bgp neighbor\nPeer: 172.31.0.1+179 AS 64512  Local: 172.16.2.1+62794 AS 64512\n  Description: bb01\n  Group: BGP_OVERLAY           Routing-Instance: master\n  Forwarding routing-instance: master\n  Type: Internal    State: Established    Flags: <Sync>\n  Last State: OpenConfirm   Last Event: RecvKeepAlive\n  Last Error: None\n  Options: <Preference LocalAddress AddressFamily LocalAS Rib-group Refresh>\n  Address families configured: evpn\n  Local Address: 172.16.2.1 Holdtime: 90 Preference: 170 Local AS: 64512 Local System AS: 65002\n  Number of flaps: 0\n  Peer ID: 172.31.0.1      Local ID: 172.16.2.1        Active Holdtime: 90\n  Keepalive Interval: 30         Group index: 1    Peer index: 1\n  BFD: disabled, down\n  NLRI for restart configured on peer: evpn\n  NLRI advertised by peer: evpn\n  NLRI for this session: evpn\n  Peer supports Refresh capability (2)\n  Stale routes from peer are kept for: 300\n  Peer does not support Restarter functionality\n  Restart flag received from the peer: Notification\n  NLRI that restart is negotiated for: evpn\n  NLRI of received end-of-rib markers: evpn\n  NLRI of all end-of-rib markers sent: evpn\n  Peer does not support LLGR Restarter functionality\n  Peer supports 4 byte AS extension (peer-as 64512)\n  Peer does not support Addpath\n  Table bgp.evpn.0\n    RIB State: BGP restart is complete\n    RIB State: VPN restart is complete\n    Send state: not advertising\n    Active prefixes:              0\n    Received prefixes:            0\n    Accepted prefixes:            0\n    Suppressed due to damping:    0\n  Last traffic (seconds): Received 14   Sent 17   Checked 58\n  Input messages:  Total 36     Updates 1       Refreshes 0     Octets 695\n  Output messages: Total 20     Updates 0       Refreshes 0     Octets 454\n  Trace options: normal\n  Trace file: /var/log/bgp.log size 10240 files 30\n\n...\n\n\n\nOverlay\u8a2d\u5b9a\uff5e\u78ba\u8a8d(EVPN+VXLAN)\nEVPN \u306e\u8a2d\u5b9a\u3068\u3001\u305d\u306e Dataplane \u3068\u3057\u3066\u4f7f\u3046 VXLAN \u5468\u308a\u306e\u8a2d\u5b9a\u3092\u3057\u3066\u3044\u304d\u307e\u3059\u3002(\u606f\u5207\u308c)\n\nEVPN+VXLAN \u8a2d\u5b9a\n\u5192\u982d\u306e\u5168\u4f53\u69cb\u6210\u306b\u66f8\u3044\u305f\u306e\u3067\u3059\u304c bb01 \u306f\u3053\u306e\u8fba\u306e\u6319\u52d5\u306b\u95a2\u3057\u3066\u306f\u571f\u7ba1\u306b\u5fb9\u3057\u3066\u3044\u308b\u306e\u3067\u767b\u5834\u3057\u307e\u305b\u3093\u3002\nVNI \u306f 1..16777214 \u307e\u3067\u4f7f\u3048\u308b\u306e\u3067\u3001\u5358\u7d14\u306b\u5168 spine \u3067 VLAN ID \u3068 1:1 \u3067\u540c\u3058\u5bfe\u5fdc\u4ed8\u3051\u3092\u3055\u305b\u3066\u3001\u4e00\u5f8b\u3067 VLAN ID + 10000 \u306e\u5024\u3092\u632f\u3063\u3066\u307e\u3059\u3002\n\u3042\u3001VNI 10100 \u4ee5\u5916\u306f\u672c\u9805\u3067\u306f\u307e\u3060\u4f7f\u3044\u307e\u305b\u3093\u3002\n\nspine11\nset vlans VLAN0100 vlan-id 100\nset vlans VLAN0100 vxlan vni 10100\nset vlans VLAN0100 vxlan ingress-node-replication\n\nset vlans VLAN0300 vlan-id 300\nset vlans VLAN0300 vxlan vni 10300\nset vlans VLAN0300 vxlan ingress-node-replication\n\nset protocols evpn encapsulation vxlan\nset protocols evpn extended-vni-list all\nset protocols evpn multicast-mode ingress-replication\nset protocols evpn vni-options vni 10100 vrf-target export target:1:10100\nset protocols evpn vni-options vni 10300 vrf-target export target:1:10300\n\nset policy-options community COM_10100 members target:1:10100\nset policy-options community COM_10300 members target:1:10300\nset policy-options community COM_LEAF_ESI members target:9999:9999\n\nset policy-options policy-statement POLICY_VRF_IMPORT term T_10100 from community COM_10100\nset policy-options policy-statement POLICY_VRF_IMPORT term T_10100 then accept\nset policy-options policy-statement POLICY_VRF_IMPORT term T_10300 from community COM_10300\nset policy-options policy-statement POLICY_VRF_IMPORT term T_10300 then accept\nset policy-options policy-statement POLICY_VRF_IMPORT term T_99900 from community COM_LEAF_ESI\nset policy-options policy-statement POLICY_VRF_IMPORT term T_99900 then accept\nset policy-options policy-statement POLICY_VRF_IMPORT term T_99999 then reject\n\nset switch-options vtep-source-interface lo0.0\nset switch-options route-distinguisher 64512:11\nset switch-options vrf-import POLICY_VRF_IMPORT\nset switch-options vrf-target target:9999:9999\nset switch-options vrf-target auto \n\nset interfaces xe-0/0/1 description \"DEV=torSW11 IF=1\"\nset interfaces xe-0/0/1 unit 0 family ethernet-switching interface-mode trunk\nset interfaces xe-0/0/1 unit 0 family ethernet-switching vlan members all\n\n\n\nspine21\nset vlans VLAN0100 vlan-id 100\nset vlans VLAN0100 vxlan vni 10100\nset vlans VLAN0100 vxlan ingress-node-replication\n\nset vlans VLAN0200 vlan-id 200\nset vlans VLAN0200 vxlan vni 10200\nset vlans VLAN0200 vxlan ingress-node-replication\n\nset protocols evpn encapsulation vxlan\nset protocols evpn extended-vni-list all\nset protocols evpn multicast-mode ingress-replication\nset protocols evpn vni-options vni 10100 vrf-target export target:1:10100\nset protocols evpn vni-options vni 10200 vrf-target export target:1:10200\n\nset policy-options community COM_10100 members target:1:10100\nset policy-options community COM_10200 members target:1:10200\nset policy-options community COM_LEAF_ESI members target:9999:9999\n\nset policy-options policy-statement POLICY_VRF_IMPORT term T_10100 from community COM_10100\nset policy-options policy-statement POLICY_VRF_IMPORT term T_10100 then accept\nset policy-options policy-statement POLICY_VRF_IMPORT term T_10200 from community COM_10200\nset policy-options policy-statement POLICY_VRF_IMPORT term T_10200 then accept\nset policy-options policy-statement POLICY_VRF_IMPORT term T_99900 from community COM_LEAF_ESI\nset policy-options policy-statement POLICY_VRF_IMPORT term T_99900 then accept\nset policy-options policy-statement POLICY_VRF_IMPORT term T_99999 then reject\n\nset switch-options vtep-source-interface lo0.0\nset switch-options route-distinguisher 64512:21\nset switch-options vrf-import POLICY_VRF_IMPORT\nset switch-options vrf-target target:9999:9999\nset switch-options vrf-target auto \n\nset interfaces xe-0/0/1 description \"DEV=torSW21 IF=1\"\nset interfaces xe-0/0/1 unit 0 family ethernet-switching interface-mode trunk\nset interfaces xe-0/0/1 unit 0 family ethernet-switching vlan members all\n\n\n\u52d5\u4f5c\u78ba\u8a8d\n\nnode \u540c\u58eb\u306e\u758e\u901a\u78ba\u8a8d\n\nnode11\n\n$ ip a show dev ens4\n3: ens4: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 00:86:2b:8d:10:01 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.1.1/24 brd 192.168.1.255 scope global ens4\n       valid_lft forever preferred_lft forever\n    inet6 fe80::286:2bff:fe8d:1001/64 scope link\n       valid_lft forever preferred_lft forever\n\n$ ping 192.168.1.2\nPING 192.168.1.2 (192.168.1.2) 56(84) bytes of data.\n64 bytes from 192.168.1.2: icmp_seq=1 ttl=64 time=975 ms\n64 bytes from 192.168.1.2: icmp_seq=2 ttl=64 time=949 ms\n\n$ ip n show dev ens4\n192.168.1.2 lladdr 00:86:2b:5c:0d:01 STALE\n\n\nnode21\n\n$ ip a show dev ens4\n3: ens4: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 00:86:2b:5c:0d:01 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.1.2/24 brd 192.168.1.255 scope global ens4\n       valid_lft forever preferred_lft forever\n    inet6 fe80::286:2bff:fe5c:d01/64 scope link\n       valid_lft forever preferred_lft forever\n\n$ ping 192.168.1.1\nPING 192.168.1.1 (192.168.1.1) 56(84) bytes of data.\n64 bytes from 192.168.1.1: icmp_seq=1 ttl=64 time=639 ms\n64 bytes from 192.168.1.1: icmp_seq=2 ttl=64 time=926 ms\n\n$ ip n show dev ens4\n192.168.1.1 lladdr 00:86:2b:8d:10:01 STALE\n\n\nvQFX \u306e\u30c6\u30fc\u30d6\u30eb\u78ba\u8a8d\n\u524d\u8ff0\u306e Juniper\u516c\u5f0f\u65e5\u672c\u8a9e\u8cc7\u6599 \u306e\u30da\u30fc\u30b8 36 \u306b\u3088\u308b\u3068\n\nbgp.evpn.0 = Junos OS \u30eb\u30fc\u30c6\u30a3\u30f3\u30b0 \u30d7\u30ed\u30c8\u30b3\u30eb \u30d7\u30ed\u30bb\u30b9\uff08RPD\uff09\u5185\u306e\u30b0\u30ed\u30fc\u30d0\u30eb EVPN \u30eb\u30fc\u30c6\u30a3\u30f3\u30b0 \u30c6\u30fc\u30d6\u30eb\ndefault.switch.evpn.0\uff08QFX5100 \u306e\u5834\u5408\uff09 = Junos OS RPD \u5185\u306e\u30b9\u30a4\u30c3\u30c1 \u30ec\u30d9\u30eb EVPN \u8ee2\u9001\u30c6\u30fc\u30d6\u30eb\n<virtual-switch-name>.evpn.0\uff08MX \u306e\u5834\u5408\uff09 = Junos OS RPD \u5185\u306e\u4eee\u60f3\u30b9\u30a4\u30c3\u30c1 \u30ec\u30d9\u30eb EVPN \u8ee2\u9001\u30c6\u30fc\u30d6\u30eb\n\n\u3089\u3057\u3044\u3067\u3059\u3088\u3002\n\nspine11\n\u3053\u3044\u3064\u306b\u3068\u3063\u3066\u306e vtep.32769 \u3066\u306e\u306f spine21 (\u306e VTEP)\n{master:0}\nkotetsu@spine11> show ethernet-switching table\n\nMAC flags (S - static MAC, D - dynamic MAC, L - locally learned, P - Persistent static\n           SE - statistics enabled, NM - non configured MAC, R - remote PE MAC, O - ovsdb MAC)\n\n\nEthernet switching table : 2 entries, 2 learned\nRouting instance : default-switch\n   Vlan                MAC                 MAC      Logical                Active\n   name                address             flags    interface              source\n   VLAN0100            00:86:2b:5c:0d:01   D        vtep.32769             172.16.2.1\n   VLAN0100            00:86:2b:8d:10:01   D        xe-0/0/1.0\n\n\n{master:0}\nkotetsu@spine11> show interfaces vtep.32769\n  Logical interface vtep.32769 (Index 566) (SNMP ifIndex 537)\n    Flags: Up SNMP-Traps Encapsulation: ENET2\n    VXLAN Endpoint Type: Remote, VXLAN Endpoint Address: 172.16.2.1, L2 Routing Instance: default-switch, L3 Routing Instance: default\n    Input packets : 4\n    Output packets: 4\n    Protocol eth-switch, MTU: Unlimited\n      Flags: Trunk-Mode\n\n\nEVPN \u306e Type2(MAC/IP Advertisement route) \u3068 Type3(Inclusive Multicast Ethernet Tag route) \u3092 spine21 (RD 64512:21)\u304b\u3089\u5b66\u7fd2\u3057\u3066 bgp.evpn.0 \u304b\u3089 default-switch.evpn.0 \u306b\u30ed\u30fc\u30c9\u3055\u308c\u3066\u3044\u308b\u69d8\u5b50\n{master:0}\nkotetsu@spine11> show route\n\n...\n\n:vxlan.inet.0: 8 destinations, 8 routes (8 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n10.0.0.0/24        *[Direct/0] 00:23:24\n                    > via em0.0\n10.0.0.201/32      *[Local/0] 00:06:15\n                      Local via em0.0\n169.254.0.0/24     *[Direct/0] 00:23:24\n                    > via em1.0\n169.254.0.2/32     *[Local/0] 00:23:24\n                      Local via em1.0\n172.16.1.1/32      *[Direct/0] 00:23:24\n                    > via lo0.0\n172.16.2.1/32      *[Static/1] 00:13:22, metric2 0\n                    > to 192.0.2.1 via xe-0/0/0.0\n192.0.2.0/30       *[Direct/0] 00:23:24\n                    > via xe-0/0/0.0\n192.0.2.2/32       *[Local/0] 00:23:24\n                      Local via xe-0/0/0.0\n\n\nbgp.evpn.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n2:64512:21::10100::00:86:2b:5c:0d:01/304\n                   *[BGP/170] 00:08:29, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n3:64512:21::10100::172.16.2.1/304\n                   *[BGP/170] 00:13:23, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n\n\ndefault-switch.evpn.0: 5 destinations, 5 routes (5 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n2:64512:11::10100::00:86:2b:8d:10:01/304\n                   *[EVPN/170] 00:08:33\n                      Indirect\n2:64512:21::10100::00:86:2b:5c:0d:01/304\n                   *[BGP/170] 00:08:29, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n3:64512:11::10100::172.16.1.1/304\n                   *[EVPN/170] 00:23:27\n                      Indirect\n3:64512:11::10300::172.16.1.1/304\n                   *[EVPN/170] 00:15:11\n                      Indirect\n3:64512:21::10100::172.16.2.1/304\n                   *[BGP/170] 00:13:23, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n\n{master:0}\nkotetsu@spine11> show route forwarding-table\n\n...\n\nRouting table: :vxlan.inet\nInternet:\nDestination        Type RtRef Next hop           Type Index    NhRef Netif\ndefault            perm     0                    rjct     1724     1\n0.0.0.0/32         perm     0                    dscd     1722     1\n169.254.0.0/24     user     0                    rtbl        1     5\n169.254.0.2/32     user     0 169.254.0.2        locl      338     3\n172.16.1.1/32      user     0                    rtbl        1     5\n172.16.2.1/32      user     0                    indr   131070     3\n                              192.0.2.1          ucst     1719     7 xe-0/0/0.0\n192.0.2.0/30       user     0                    rtbl        1     5\n192.0.2.2/32       user     0 192.0.2.2          locl     1717     3\n224.0.0.0/4        perm     0                    mdsc     1723     1\n224.0.0.1/32       perm     0 224.0.0.1          mcst     1726     1\n255.255.255.255/32 perm     0                    bcst     1727     1\n\n...\n\nRouting table: default-switch.bridge\nBridging domain: VLAN0100.bridge\nVPLS:\nDestination        Type RtRef Next hop           Type Index    NhRef Netif\n00:86:2b:5c:0d:01/48 user     0                  comp     1707     6\n00:86:2b:8d:10:01/48 user     0                  ucst     1712     6 xe-0/0/1.0\n0x30001/51         user     0                    comp     1739     2\n0x30006/51         user     0                    comp     1732     2\n0x30002/51         user     0                    comp     1733     2\n\nRouting table: default-switch.bridge\nBridging domain: VLAN0300.bridge\nVPLS:\nDestination        Type RtRef Next hop           Type Index    NhRef Netif\n0x30007/51         user     0                    comp     1741     2\n0x30005/51         user     0                    comp     1714     2\n0x30003/51         user     0                    comp     1734     2\n\n...\n\n\nspine21\n\u3053\u3044\u3064\u306b\u3068\u3063\u3066\u306e vtep.32769 \u3066\u306e\u306f spine11 (\u306e VTEP)\n{master:0}\nkotetsu@spine21> show ethernet-switching table\n\nMAC flags (S - static MAC, D - dynamic MAC, L - locally learned, P - Persistent static\n           SE - statistics enabled, NM - non configured MAC, R - remote PE MAC, O - ovsdb MAC)\n\n\nEthernet switching table : 2 entries, 2 learned\nRouting instance : default-switch\n   Vlan                MAC                 MAC      Logical                Active\n   name                address             flags    interface              source\n   VLAN0100            00:86:2b:5c:0d:01   D        xe-0/0/1.0\n   VLAN0100            00:86:2b:8d:10:01   D        vtep.32769             172.16.1.1\n\n\nEVPN \u306e Type2(MAC/IP Advertisement route) \u3068 Type3(Inclusive Multicast Ethernet Tag route) \u3092 spine11 (RD 64512:11)\u304b\u3089\u5b66\u7fd2\u3057\u3066 bgp.evpn.0 \u304b\u3089 default-switch.evpn.0 \u306b\u30ed\u30fc\u30c9\u3055\u308c\u3066\u3044\u308b\u69d8\u5b50\n{master:0}\nkotetsu@spine21> show route\n\n...\n\n:vxlan.inet.0: 8 destinations, 8 routes (8 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n10.0.0.0/24        *[Direct/0] 00:18:41\n                    > via em0.0\n10.0.0.202/32      *[Local/0] 00:11:20\n                      Local via em0.0\n169.254.0.0/24     *[Direct/0] 00:18:41\n                    > via em1.0\n169.254.0.2/32     *[Local/0] 00:18:41\n                      Local via em1.0\n172.16.1.1/32      *[Static/1] 00:18:39, metric2 0\n                    > to 192.0.2.5 via xe-0/0/0.0\n172.16.2.1/32      *[Direct/0] 00:18:41\n                    > via lo0.0\n192.0.2.4/30       *[Direct/0] 00:18:41\n                    > via xe-0/0/0.0\n192.0.2.6/32       *[Local/0] 00:18:41\n                      Local via xe-0/0/0.0\n\nbgp.evpn.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n2:64512:11::10100::00:86:2b:8d:10:01/304\n                   *[BGP/170] 00:12:17, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n3:64512:11::10100::172.16.1.1/304\n                   *[BGP/170] 00:18:40, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n\ndefault-switch.evpn.0: 5 destinations, 5 routes (5 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n2:64512:11::10100::00:86:2b:8d:10:01/304\n                   *[BGP/170] 00:12:17, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n2:64512:21::10100::00:86:2b:5c:0d:01/304\n                   *[EVPN/170] 00:12:16\n                      Indirect\n3:64512:11::10100::172.16.1.1/304\n                   *[BGP/170] 00:18:40, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n3:64512:21::10100::172.16.2.1/304\n                   *[EVPN/170] 00:14:43\n                      Indirect\n3:64512:21::10200::172.16.2.1/304\n                   *[EVPN/170] 00:14:43\n                      Indirect\n\n{master:0}\nkotetsu@spine21> show route forwarding-table\n\n...\n\nRouting table: :vxlan.inet\nInternet:\nDestination        Type RtRef Next hop           Type Index    NhRef Netif\ndefault            perm     0                    rjct     1716     1\n0.0.0.0/32         perm     0                    dscd     1714     1\n169.254.0.0/24     user     0                    rtbl        1     5\n169.254.0.2/32     user     0 169.254.0.2        locl      334     3\n172.16.1.1/32      user     0                    indr   131070     3\n                              192.0.2.5          ucst     1711     7 xe-0/0/0.0\n172.16.2.1/32      user     0                    rtbl        1     5\n192.0.2.4/30       user     0                    rtbl        1     5\n192.0.2.6/32       user     0 192.0.2.6          locl     1709     3\n224.0.0.0/4        perm     0                    mdsc     1715     1\n224.0.0.1/32       perm     0 224.0.0.1          mcst     1718     1\n255.255.255.255/32 perm     0                    bcst     1719     1\n\n...\n\nRouting table: default-switch.bridge\nBridging domain: VLAN0100.bridge\nVPLS:\nDestination        Type RtRef Next hop           Type Index    NhRef Netif\n00:86:2b:5c:0d:01/48 user     0                  ucst     1730     6 xe-0/0/1.0\n00:86:2b:8d:10:01/48 user     0                  comp     1723     6\n0x30006/51         user     0                    comp     1731     2\n0x30004/51         user     0                    comp     1725     2\n0x30001/51         user     0                    comp     1726     2\n\nRouting table: default-switch.bridge\nBridging domain: VLAN0200.bridge\nVPLS:\nDestination        Type RtRef Next hop           Type Index    NhRef Netif\n0x30007/51         user     0                    comp     1734     2\n0x30005/51         user     0                    comp     1729     2\n0x30002/51         user     0                    comp     1728     2\n\n\n\n\n\nbb01\n{master:0}\nkotetsu@bb01> show ethernet-switching table\n\n\n\u5358\u7d14\u306b EVPN \u7d4c\u8def\u3092 reflect \u3059\u308b\u571f\u7ba1\u306a\u306e\u3067\u3000bgp.evpn.0 \u306b\u3057\u304b\u8f09\u3063\u3066\u3044\u306a\u3044\u69d8\u5b50\n{master:0}\nkotetsu@bb01> show route\n\n...\n\nbgp.evpn.0: 6 destinations, 6 routes (6 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n2:64512:11::10100::00:86:2b:8d:10:01/304\n                   *[BGP/170] 00:31:03, localpref 100, from 172.16.1.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.2 via xe-0/0/0.0\n2:64512:21::10100::00:86:2b:5c:0d:01/304\n                   *[BGP/170] 00:31:01, localpref 100, from 172.16.2.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.6 via xe-0/0/1.0\n3:64512:11::10100::172.16.1.1/304\n                   *[BGP/170] 00:46:21, localpref 100, from 172.16.1.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.2 via xe-0/0/0.0\n3:64512:11::10300::172.16.1.1/304\n                   *[BGP/170] 00:37:52, localpref 100, from 172.16.1.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.2 via xe-0/0/0.0\n3:64512:21::10100::172.16.2.1/304\n                   *[BGP/170] 00:36:05, localpref 100, from 172.16.2.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.6 via xe-0/0/1.0\n3:64512:21::10200::172.16.2.1/304\n                   *[BGP/170] 00:35:45, localpref 100, from 172.16.2.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.6 via xe-0/0/1.0\n\n\n{master:0}\nkotetsu@bb01> show route forwarding-table\n\n...\n\n\n\u30d1\u30b1\u30c3\u30c8\u30ad\u30e3\u30d7\u30c1\u30e3\n\u3044\u304f\u3064\u304b\u7279\u5fb4\u7684\u306a\u30d1\u30b1\u30c3\u30c8\u3092\u62fe\u3063\u3066\u773a\u3081\u3066\u3044\u304d\u307e\u3059\u3002\n\u524d\u8ff0\u306e\u901a\u308a\u3001\u4eca\u56de\u306f RE \u540c\u58eb\u3092\u63a5\u7d9a\u3059\u308b\u3068\u3053\u308d\u3067\u76f4\u7d50\u69cb\u6210\u306b\u3057\u3066\u3057\u307e\u3044 bb01 \u304c xe-0/0/2 \u304b\u3089 captureSW \u65b9\u9762\u306b\u30dd\u30fc\u30c8\u30df\u30e9\u30fc\u30ea\u30f3\u30b0\u3057\u3066\u3001GNS3 \u306e bb01(RE) \u3068 captureSW \u9593\u306e\u30ea\u30f3\u30af\u3092\u53f3\u30af\u30ea\u30c3\u30af\u3057\u3066 start capture \u3068\u304b\u3084\u3063\u3066\u3044\u304d\u307e\u3059\u3002\n\u306a\u306e\u3067 bb01 \u306b\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u8a2d\u5b9a\u3092\u3057\u3066\u3001xe-0/0/0 (spine11 \u5074)\u306e\u51fa\u5165\u308a\u3092 xe-0/0/2 \u306b\u30df\u30e9\u30fc\u30ea\u30f3\u30b0\u3057\u3068\u304d\u307e\u3059\u3002\nset interfaces xe-0/0/2 description \"DEV=captureSW IF=1\"\nset interfaces xe-0/0/2 unit 0 family ethernet-switching\n\nset forwarding-options analyzer ANAL_PORT input ingress interface xe-0/0/0.0\nset forwarding-options analyzer ANAL_PORT input egress interface xe-0/0/0.0\nset forwarding-options analyzer ANAL_PORT output interface xe-0/0/2.0\n\n\u898b\u8fd4\u3057\u3066\u3044\u3066\u601d\u3063\u305f\u3093\u3059\u304c\u3001\u30a2\u30ca\u30eb\u30dd\u30fc\u30c8\u3063\u3066...\u3061\u3087\u3063\u3068...\n\u3042\u3068\u3001vQFX \u3067\u3082 start shell \u3057\u3066 tcpdump \u3068\u304b\u4f7f\u3048\u307e\u3059\u3088\u3002Control Plane \u5b9b\u306e\u30c8\u30e9\u30d5\u30a3\u30c3\u30af\u3060\u3051\u3068\u308a\u305f\u3044\u6642\u3068\u304b\u306b\u306f\u3002\n\nDataPlane\nbb01 \u3067\u62fe\u3063\u305f VXLAN \u306e\u30d1\u30b1\u30c3\u30c8\u3092\u898b\u3066\u3044\u304d\u307e\u3059\u3002\nnode11 \u304b\u3089 node21 \u306b ping \u3046\u3063\u305f\u6642\u3001\u6700\u521d\u306b\u51fa\u308b ARP Request \u3068 ARP reply\nVXLAN \u30ab\u30d7\u30bb\u30eb\u306e IP \u30d8\u30c3\u30c0\u7684\u306b\u306f\u30de\u30eb\u30c1\u30ad\u30e3\u30b9\u30c8\u3067\u306f\u306a\u304f\u3001spine11 VTEP \u3068 spine21 VTEP \u9593\u306e\u30e6\u30cb\u30ad\u30e3\u30b9\u30c8\u306b\u306a\u3063\u3066\u307e\u3059\u3002\n\n\nnode11 \u3068 node21 \u9593\u306e ICMP echo Request \u3068 ICMP echo Reply\n\u3053\u308c\u306f EVPN \u4f7f\u304a\u3046\u304c\u95a2\u4fc2\u306a\u304f\u3001\u305f\u3060\u306e VXLAN \u30d8\u30c3\u30c0\u3064\u3044\u305f\u30d1\u30b1\u30c3\u30c8\u3067\u3059\u3002\n\n\n\nControlPlane\nbb01 \u3067\u62fe\u3063\u305f EVPN \u306e\u30d1\u30b1\u30c3\u30c8\u3092\u898b\u3066\u3044\u304d\u307e\u3059\u3002\n\nEVPN NLRI Type2(MAC/IP Advertisement route) Update\n\u307e\u305a\u306f node11 \u304b\u3089\u306e ARP Request \u3092\u53d7\u4fe1\u3057\u305f spine11 \u304c advertise \u3059\u308b\u69d8\u5b50\n\n\u6b21\u306b node21 \u304b\u3089\u306e ARP Reply \u3092\u53d7\u4fe1\u3057\u305f spine21 \u304c advertise \u3057\u305f\u306e\u3092 bb01 \u304c spine11 \u65b9\u9762\u306b reflect \u3059\u308b\u69d8\u5b50\n\n\nEVPN NLRI Type2(MAC/IP Advertisement route) Withdrawn\nspine11 \u3067 clear ethernet-switching table \u3057\u3066 node11 \u306e MAC \u3092\u6d88\u3059\n\n\nEVPN NLRI Type3(Inclusive Multicast Ethernet Tag route) Withdrawn\nspine21 \u3067\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u611f\u3058\u3067\u3001\u96d1\u306b VLAN 100 = VNI10100 at RD 64512:21 \u304c\u6d88\u3048\u305f\u3053\u3068\u3092 advertise \u3055\u305b\u305f\u6642\u306e\u69d8\u5b50\n{master:0}[edit]\nkotetsu@spine21# deactivate vlans VLAN0100\n\n{master:0}[edit]\nkotetsu@spine21# show | compare\n[edit vlans]\n!    inactive: VLAN0100 { ... }\n\n{master:0}[edit]\nkotetsu@spine21# commit\n\n\n\n\u6b21\u306b spine21 \u3067 VLAN 100 = VNI10100 at RD 64512:21 \u304c\u3067\u304d\u305f\u3053\u3068\u3092 advertise \u3055\u305b\u305f\u6642\u306e\u69d8\u5b50\n{master:0}[edit]\nkotetsu@spine21# activate vlans VLAN0100\n\n{master:0}[edit]\nkotetsu@spine21# show | compare\n[edit vlans]\n!    active: VLAN0100 { ... }\n\n{master:0}[edit]\nkotetsu@spine21# commit\n\n\n\n\u304a\u3057\u307e\u3044\n\n\u4eee\u60f3\u7248\u3067\u3082 Juniper vQFX \u3067 L2VPN \u6a5f\u80fd\u304c\u52d5\u304f\u3053\u3068\u3092\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\nlinux kernel \u3067 EVPN \u3057\u3083\u3079\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u305b\u3093\u304b\u306d(MPLS \u306f\u5165\u3063\u305f\u306e\u3060\u3057)\n\n\n\u5192\u982d\u306e\u7d75\u3067\u3044\u3046\u3068\u3053\u308d\u306e \u30aa\u30ec\u30f3\u30b8\u9818\u57df(L3) \u306f\u51fa\u6765\u308b\u3060\u3051\u30a8\u30f3\u30c9\u307e\u3067\u964d\u308a\u3066\u304d\u3066\u6b32\u3057\u304f\u306a\u3044\u3067\u3059\u304b\n\n\nJuniper \u306e\u4f8b\u793a\u3067\u306f\u3001ToR \u30b9\u30a4\u30c3\u30c1(QFX5100)\u307e\u3067\u306f\u304d\u3066\u3044\u307e\u3059\u3088\u306d\n\u305d\u3057\u305f\u3089 linux kernel \u307e\u3067\u964d\u308a\u3066\u304d\u3066\u3001\u7269\u7406\u30b9\u30a4\u30c3\u30c1\u306f MP-BGP \u306e\u571f\u7ba1\u306b\u306a\u308c\u3070...\u3068\u304b\u601d\u3063\u305f\u308f\u3051\u3067\u3059\n\n\n\n\n\n[\u524d\u56de(vQFX10000 \u3092 KVM+GNS3 \u3067\u52d5\u304b\u3059)](http://qiita.com/kakkotetsu/items/af579a52b02aa2e4b65e)\u3001Juniper vQFX10000(\u4ee5\u964d vQFX) \u306e DL \u6a29\u9650\u3092\u500b\u4eba\u3067\u5f97\u3066 GNS3 \u3067\u8efd\u304f\u52d5\u4f5c\u78ba\u8a8d\u304c\u3068\u308c\u307e\u3057\u305f\u3002\n\u4eca\u56de\u306f\u300c\u4eee\u60f3\u7248\u3063\u3066 L2\u5168\u822c/L2VPN \u7cfb\u6a5f\u80fd\u304c\u52d5\u304b\u306a\u304b\u3063\u305f\u308a\u3059\u308b\u3051\u3069\u3001vQFX \u306f\u3069\u3046\u306a\u3093\u3060\uff1f...\u304a\u3001EVPN \u3082\u3061\u3083\u3093\u3068\u52d5\u304f\u3084\u3093\u3051\uff01\u300d\u3063\u3066\u3068\u3053\u308d\u307e\u3067\u3092\u898b\u3066\u3044\u304d\u307e\u3059\u3002\n\n# \u6700\u521d\u306b\n\n## \u672c\u9805\u3067\u3084\u308b\u3053\u3068\n\n\u4ee5\u4e0b\u3092\u3084\u308a\u307e\u3059\u3002\n\n- vQFX \u3067 VXLAN \u306e Control Plane \u3068\u3057\u3066 EVPN \u3092\u52d5\u304b\u3059\n    - \u4eee\u60f3\u7248\u3060\u3068 L2VPN \u7cfb\u6a5f\u80fd\u304c\u52d5\u304b\u306a\u3044\u30a2\u30d7\u30e9\u30a4\u30a2\u30f3\u30b9\u3082\u3042\u308b\u306e\u3067\n- EVPN \u306e\u9069\u7528\u7bc4\u56f2\u306f L2 \u30b7\u30f3\u30b0\u30eb\u69cb\u6210\u306e\u307f\u3067\u3001DataPlane \u3068\u3057\u3066\u306f VXLAN \u3092\u4f7f\u3046\n    - L2VPN \u3078\u306e L3 \u7d71\u5408\u5468\u308a(inter-subnet-forwarding \u5468\u308a)\u3084\u30de\u30eb\u30c1\u30db\u30fc\u30df\u30f3\u30b0\u306a\u3069\u306e\u6a5f\u80fd\u306f\u3001\u4eca\u56de\u306e\u7bc4\u56f2\u5916\n    - Dataplane \u3068\u3057\u3066\u306f VXLAN \u3092\u4f7f\u3044\u3001MPLS \u306f\u53d6\u308a\u6271\u308f\u306a\u3044\n- [Juniper\u516c\u5f0f | \u30b8\u30e5\u30cb\u30d1\u30fc\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30b9 EVPN \u6b21\u4e16\u4ee3\u30c7\u30fc\u30bf\u30bb\u30f3\u30bf\u30fc \u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306e\u5b9f\u88c5](http://www.juniper.net/assets/jp/jp/local/pdf/whitepapers/2000606-jp.pdf) \u3067 MX \u3068 QFX5100 \u3067\u3084\u3063\u3066\u3044\u308b\u3053\u3068\u306e\u4e00\u90e8\u3092 vQFX10000 \u3067\u8a66\u3059\n- \u5404\u8981\u7d20\u6280\u8853\u306e\u8a73\u7d30\u306a\u89e3\u8aac\u306f\u884c\u308f\u306a\u3044\n\n\u500b\u4eba\u7684\u306b\u306f\u3001[2014/12 \u6642\u70b9\u3067 VXLAN \u306e\u30de\u30eb\u30c1\u30ad\u30e3\u30b9\u30c8\u5b9f\u88c5\u3092\u78ba\u8a8d\u3057\u305f\u6642 (VyOS \u3068 Arista \u3067 VXLAN \u76f8\u4e92\u63a5\u7d9a)](http://qiita.com/kakkotetsu/items/992b6a40f7c466401a89)\u306b\u5fae\u5999\u3060\u3068\u601d\u3063\u305f\u70b9\u306b\u3082\u7740\u76ee\u3057\u3066\u304a\u304d\u305f\u3044\u3067\u3059\u3002\u4eca\u56de\u3001\u30c7\u30fc\u30bf\u30d7\u30ec\u30fc\u30f3\u5468\u308a\u306f\u307b\u307c\u540c\u3058\u69cb\u6210\u3092\u7d44\u3093\u3067\u307e\u3059\u306e\u3067\u3002\n\n- \u4e0a\u306e\u8a18\u4e8b\u306e\u3006\u304c\u300c\u30de\u30eb\u30c1\u30ad\u30e3\u30b9\u30c8\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3092\u52c9\u5f37\u3057\u3088\u3046\u3002\u300d\u3060\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u3053\u306e2\u5e74\u9593\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u30a6\u30c0\u30a6\u30c0\u3084\u3063\u3066\u3044\u3066\u3001\u7279\u306b\u9032\u6357\u306f\u3042\u308a\u307e\u305b\u3093\u3067\u3057\u305f\u3002\n    - \u30de\u30eb\u30c1\u30ad\u30e3\u30b9\u30c8\uff1f\u3048\u30fc...\uff1f\u3046\u30fc\u3093...\n    - \u3048\uff1fOVSDB \u3067\u30b4\u30ea\u30b4\u30ea\uff1f\u3042\u30fc...hmm...\n    - \u3042\uff1fOVSDB\u3092\u4f7f\u3063\u305f\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u5c0e\u5165\u3067\u30e6\u30cb\u30ad\u30e3\u30b9\u30c8\uff1f\u3048\uff1fNSX\uff1f\u8cb7\u3048\u308b\u304b\u3088...\n    - \u304a\uff1f\u81ea\u524d\u3067\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u5b9f\u88c5\uff1f\u306f\u306f\u3041...\n    - \u3093\uff1fMP-BGP\u4f7f\u3063\u305fEVPN\uff1f\u3044\u304b\u306b\u3082\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u5c4b\u304c\u8003\u3048\u305d\u3046&\u98df\u3044\u3064\u304d\u305d\u3046\u3067\u3059\u306d\u3047...\u3067\u3082\u307e\u3042\u91e3\u3089\u308c\u3066\u307f\u308b\u304b\u3042(\u4eca\u3053\u3053)\n- \u4e0a\u306e\u8a18\u4e8b\u3067\u306f VTEP \u9593\u306e\u5230\u9054\u6027\u3092\u3082\u305f\u305b\u308b\u306e\u306b\u300cVyOS \u304c\u8a8d\u8b58\u3057\u306a\u3044\u3068\u3044\u3051\u306a\u3044 Arista \u5074\u306e VTEP IP \u30a2\u30c9\u30ec\u30b9\u306f\u3001Arista \u306e Loopback \u30a2\u30c9\u30ec\u30b9\u306b\u306a\u308b\u306e\u3067\u3001StaticRoute \u3092\u8ffd\u52a0\u3057\u3066\u304a\u304d\u307e\u3059\u3002#\u3053\u308c\u3060\u3068\u62e1\u5f35\u304c\u9762\u5012\u306a\u306e\u3067\u3001\u5b9f\u74b0\u5883\u3067\u306f DefaultRoute \u304b\u52d5\u7684\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3092\u4f7f\u3046\u3053\u3068\u304c\u591a\u3044\u6c17\u304c\u3057\u307e\u3059\u3002\u300d\u3068\u304b\u66f8\u3044\u3066\u307e\u3059\u304c\u3001\u4eca\u56de\u306f\u5b9f\u74b0\u5883\u3092\u3042\u308b\u7a0b\u5ea6\u60f3\u5b9a\u3057\u305f\u4f8b\u793a\u304c\u3067\u304d\u305d\u3046\u3067\u3059\u3002\n\n## \u6982\u8981\u69cb\u6210\u56f3 / \u74b0\u5883\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u69cb\u6210\u3092\u7d44\u3093\u3067\u3044\u304d\u307e\u3059\u3002node11 \u3068 node21 \u304c L2overL3 \u3067\u901a\u4fe1\u3059\u308b\u3084\u3064\u3067\u3059\u3002\n\n![02_90_summary.png](https://qiita-image-store.s3.amazonaws.com/0/60456/e5058a97-6c94-16ab-b1bf-11f3592fdee6.png)\n\n\u74b0\u5883\u306f\u3001\u3044\u305a\u308c\u3082[\u524d\u56de](http://qiita.com/kakkotetsu/items/af579a52b02aa2e4b65e)\u306e\u901a\u308a\u3067\u3059\u3002\n\n\n## \u53c2\u8003\u8cc7\u6599\n\n\u524d\u8ff0\u306e\u901a\u308a\u3001\u5404\u8981\u7d20\u6280\u8853\u306e\u8a73\u7d30\u306a\u89e3\u8aac\u306f\u653e\u68c4\u3057\u3066\u3044\u307e\u3059\u304c...\u3053\u3093\u306a\u30cb\u30c3\u30c1\u306a\u8a18\u4e8b\u3092\u8aad\u3080\u4eba\u5411\u3051\u306a\u306e\u3067\u3001\u307e\u3042\u306d\uff1f\n\n- EVPN \u6a19\u6e96\n    - [RFC7432 (BGP MPLS-Based Ethernet VPN)](https://tools.ietf.org/html/rfc7432)\n    - [Alcatel-Lucent \u767a\u8868\u8cc7\u6599 | ETHERNET VPN Standardization and Status](http://mpls.jp/2015/presentations/EVPN_standardization_and_status_Jorge_Rabadan_pubv1.pdf)\n        - 2015/11 \u6642\u70b9\u306e\u3082\u306e\n        - \u30b9\u30e9\u30a4\u30c99\u3042\u305f\u308a\u304c\u6a19\u6e96\u5316\u52d5\u5411\u306e\u6700\u65b0\u306b\u8fd1\u3044\u304b\u306a...\n- VXLAN \u6a19\u6e96\n    - [RFC7348 (Virtual eXtensible Local Area Network (VXLAN): A Framework for Overlaying Virtualized Layer 2 Networks over Layer 3 Networks)](https://tools.ietf.org/html/rfc7348)\n        - Control Plane \u5468\u308a\u306f\u30de\u30eb\u30c1\u30ad\u30e3\u30b9\u30c8\u5b9f\u88c5\u304c\u63d0\u793a\u3055\u308c\u3066\u3044\u308b\n- JUNOS \u3067\u306e VXLAN+EVPN \u5b9f\u88c5\u30fb\u8a2d\u5b9a\u5468\u308a\n    - [Juniper\u516c\u5f0f | \u30b8\u30e5\u30cb\u30d1\u30fc\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30b9 EVPN \u6b21\u4e16\u4ee3\u30c7\u30fc\u30bf\u30bb\u30f3\u30bf\u30fc \u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306e\u5b9f\u88c5](http://www.juniper.net/assets/jp/jp/local/pdf/whitepapers/2000606-jp.pdf)\n        - MX \u3068 QFX5100 \u3067 EVPN \u306e\u8a2d\u5b9a\u30b5\u30f3\u30d7\u30eb\u3092 step by step \u3067\u89e3\u8aac\n        - \u65e5\u672c\u8a9e\u7248\n    - [Juniper\u516c\u5f0f | Junos OS for the QFX Series, Release 15.1X53 (for QFX10000 Switches) / EVPN Control Plane and VXLAN Data Plane Feature Guide for QFX Series Switches](https://www.juniper.net/techpubs/en_US/junos15.1/information-products/pathway-pages/junos-sdn/evpn-vxlan.html)\n        - vQFX \u3092\u52d5\u304b\u3059 `15.1X53` \u3067\u306e EVPN + VxLAN \u5168\u822c\n    - [Juniper\u516c\u5f0f github | JNPRAutomate/ansible-junos-evpn-vxlan](https://github.com/JNPRAutomate/ansible-junos-evpn-vxlan)\n        - MX, QFX5100, QFX10000 \u306e EVPN/VXLAN \u30b5\u30f3\u30d7\u30eb\u30b3\u30f3\u30d5\u30a3\u30b0\u3092\u542b\u3080\n\n\n# \u69cb\u7bc9\uff5e\u52d5\u4f5c\u78ba\u8a8d\n\n## GNS3 \u3067\u4eee\u60f3\u30de\u30b7\u30f3\u306e\u30c7\u30d7\u30ed\u30a4 \uff5e \u7d50\u7dda \uff5e \u8d77\u52d5\n\n[\u524d\u56de](http://qiita.com/kakkotetsu/items/af579a52b02aa2e4b65e)\u306e\u901a\u308a\u306b\u30013\u30da\u30a2\u306e vQFX \u3092\u30c7\u30d7\u30ed\u30a4\u3057\u3066\u63a5\u7d9a\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\u4ee5\u4e0b\u306e\u611f\u3058\u3067\u3002\n\n![02_00.png](https://qiita-image-store.s3.amazonaws.com/0/60456/76ed4ac5-4973-0f2b-71f8-8d512b0576fa.png)\n\n`torSW101a` \u3068 `torSW201a` \u3068\u3044\u3046\u306e\u306f\u3001`GNS3` \u306e `Ethernet Switch` \u3092\u4f7f\u3063\u3066\u3044\u307e\u3059\u304c\u3001\u5404\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\u9069\u5f53\u306a dot1Q \u98df\u3048\u308b\u30b9\u30a4\u30c3\u30c1\u7f6e\u3051\u3070\u826f\u3044\u3067\u3059\u3002\n\u8a2d\u5b9a\u306f\u305d\u308c\u305e\u308c\u4ee5\u4e0b\u306e\u611f\u3058\u3067\u3059\u3002(\u4eca\u56de\u306f `Port 3-4` \u306f\u4f7f\u3044\u307e\u305b\u3093\u304c)\n\n![02_01_window.png](https://qiita-image-store.s3.amazonaws.com/0/60456/a7a403b6-6ed2-f8c3-c036-f7ef9010c86a.png)\n\n![02_02_window.png](https://qiita-image-store.s3.amazonaws.com/0/60456/84dc7947-db33-1daf-5bd1-831b49306e88.png)\n\n\n`node11` \u3068 `node21` \u306f\u3001\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u306b IP \u30a2\u30c9\u30ec\u30b9\u4ed8\u4e0e\u3059\u308b\u3060\u3051\u306a\u306e\u3067\u3001\u9069\u5f53\u306a\u758e\u901a\u78ba\u8a8d\u7528\u30ce\u30fc\u30c9\u306a\u306e\u3067\u597d\u304d\u306a\u306e\u3092\u3069\u3046\u305e\u3002(`node12` \u3068 `node22` \u306f\u4eca\u56de\u4f7f\u308f\u306a\u3044\u3067\u3059)\n\n\u3042\u3068 `captureSW` \u3068\u3044\u3046\u306e\u306f `GNS3 1.5.2` \u3067\u306f [github gns3-gui issues | QEMU link Packet Captures](https://github.com/GNS3/gns3-gui/issues/1414) \u306e\u901a\u308a\u3001qemu \u540c\u58eb\u306e\u7d50\u7dda\u3092\u30d1\u30b1\u30c3\u30c8\u30ad\u30e3\u30d7\u30c1\u30e3\u3067\u304d\u306a\u3044\u306e\u3067\u3001\u300c`bb01` \u3067\u30dd\u30fc\u30c8\u30df\u30e9\u30fc\u30ea\u30f3\u30b0\u300d\u3059\u308b\u624b\u6cd5\u3092\u3068\u3063\u3066\u3044\u308b\u305f\u3081\u306b\u7f6e\u3044\u3066\u3044\u308b\u3082\u306e\u3067\u3059\u3002\n\u672a\u8a66\u884c\u3067\u3059\u304c\u3001RE \u540c\u58eb\u306e\u7d50\u7dda\u3092\u3057\u3066\u3044\u308b\u7b87\u6240(`bb01` \u3068 `spine[12]1`)\u306b\u5168\u3066 `Ethernet Switch` \u3092\u631f\u3081\u3070\u3001\u30dd\u30fc\u30c8\u30df\u30e9\u30fc\u30ea\u30f3\u30b0\u4e0d\u8981\u3067\u30d1\u30b1\u30c3\u30c8\u30ad\u30e3\u30d7\u30c1\u30e3\u3067\u304d\u308b\u3068\u601d\u3044\u307e\u3059\u3002(\u305d\u3061\u3089\u306e\u65b9\u304c\u3084\u308a\u3084\u3059\u3044\u7b48)\n\n\u3067\u304d\u305f\u3089\u8d77\u52d5\u3057\u3066\u5f85\u3061\u307e\u3059\u3002\n\n## \u57fa\u672c\u8a2d\u5b9a\n\n\u5404\u74b0\u5883\u306b\u5408\u308f\u305b\u3066 syslog \u306a\u308a NTP \u306a\u308a ssh key \u767b\u9332\u306a\u308a\u3057\u3066\u304a\u3044\u3066\u4e0b\u3055\u3044\u3002\n\u3042\u3001\u4eca\u56de\u306f BGP \u306e\u30ed\u30b0\u3092 `/var/log/bgp.log` \u306b\u6b8b\u3059\u305f\u3081\u306b\u3001\u4ee5\u4e0b\u3092\u3084\u3063\u3066\u304a\u304f\u3068\u826f\u3044\u3067\u3059\u3088\u3002\n\n```\nset protocols bgp traceoptions file bgp.log\nset protocols bgp traceoptions file size 10k\nset protocols bgp traceoptions file files 30\nset protocols bgp traceoptions flag normal\n```\n\n## Underlay \u8a2d\u5b9a\uff5e\u78ba\u8a8d (\u7269\u7406IF \u3068 eBGP)\n\n\u307e\u305a\u306f\u7269\u7406 Interface \u3068 eBGP \u5468\u308a\u3092\u8a2d\u5b9a\u3057\u3066\u3001\u5404 `lo0` \u306e IP \u30a2\u30c9\u30ec\u30b9\u3092\u7d4c\u8def\u4ea4\u63db\u3067\u304d\u305f\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\u307e\u3042\u3001\u9577\u3005\u3068\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3059\u304c\u3001\u7d75\u306b\u3059\u308b\u3068\u5358\u7d14\u3067\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u611f\u3058\u3067\u3059\u3002\n\n![02_91_BGP_Underlay_cut.png](https://qiita-image-store.s3.amazonaws.com/0/60456/9b392e84-61c8-aaf8-3db4-8ef2e852a4f3.png)\n\n\n### \u7269\u7406IF\u8a2d\u5b9a\n\n#### bb01 \n\n```\nset interfaces xe-0/0/0 description \"DEV=spine11 IF=xe-0/0/0\"\nset interfaces xe-0/0/0 unit 0 family inet address 192.0.2.1/30\ndelete interfaces xe-0/0/0 unit 0 family inet dhcp\n\nset interfaces xe-0/0/1 description \"DEV=spine21 IF=xe-0/0/0\"\nset interfaces xe-0/0/1 unit 0 family inet address 192.0.2.5/30\ndelete interfaces xe-0/0/1 unit 0 family inet dhcp\n\nset protocols lldp port-id-subtype interface-name\nset protocols lldp interface xe-0/0/0\nset protocols lldp interface xe-0/0/1\n```\n\n#### spine11\n\n```\nset interfaces xe-0/0/0 description \"DEV=bb01 IF=xe-0/0/0\"\nset interfaces xe-0/0/0 unit 0 family inet address 192.0.2.2/30\ndelete interfaces xe-0/0/0 unit 0 family inet dhcp\n\nset protocols lldp port-id-subtype interface-name\nset protocols lldp interface xe-0/0/0\n```\n\n#### spine21\n\n```\nset interfaces xe-0/0/0 description \"DEV=bb01 IF=xe-0/0/1\"\nset interfaces xe-0/0/0 unit 0 family inet address 192.0.2.6/30\ndelete interfaces xe-0/0/0 unit 0 family inet dhcp\n\nset protocols lldp port-id-subtype interface-name\nset protocols lldp interface xe-0/0/0\n```\n\n### \u7269\u7406IF\u758e\u901a\u78ba\u8a8d\n\n\u30ea\u30bd\u30fc\u30b9\u3092\u30b1\u30c1\u3063\u305f\u304b\u3089\u304b `RTT` \u9577\u3059\u304e\u3067\u3059\u306d...\u3002\n\n#### bb01\n\n```\nkotetsu@bb01> show lldp neighbors\nLocal Interface    Parent Interface    Chassis Id          Port info          System Name\nxe-0/0/0           -                   02:05:86:71:84:00   DEV=bb01 IF=xe-0/0/0 spine11            \nxe-0/0/1           -                   02:05:86:71:ff:00   DEV=bb01 IF=xe-0/0/1 spine21\n\n\nkotetsu@bb01> show route\n\ninet.0: 8 destinations, 8 routes (8 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n10.0.0.0/24        *[Direct/0] 19:47:39\n                    > via em0.0\n10.0.0.191/32      *[Local/0] 19:47:39\n                      Local via em0.0\n169.254.0.0/24     *[Direct/0] 19:57:21\n                    > via em1.0\n169.254.0.2/32     *[Local/0] 19:57:21\n                      Local via em1.0\n192.0.2.0/30       *[Direct/0] 00:17:12\n                    > via xe-0/0/0.0\n192.0.2.1/32       *[Local/0] 00:17:12\n                      Local via xe-0/0/0.0\n192.0.2.4/30       *[Direct/0] 00:07:04\n                    > via xe-0/0/1.0\n192.0.2.5/32       *[Local/0] 00:07:04\n                      Local via xe-0/0/1.0\n\ninet6.0: 1 destinations, 1 routes (1 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\nfe80::286:2b0f:fc44:ab00/128\n                   *[Direct/0] 19:56:54\n                    > via lo0.0\n\n{master:0}\nkotetsu@bb01> ping 192.0.2.2\nPING 192.0.2.2 (192.0.2.2): 56 data bytes\n64 bytes from 192.0.2.2: icmp_seq=1 ttl=64 time=2420.112 ms\n64 bytes from 192.0.2.2: icmp_seq=2 ttl=64 time=1027.245 ms\n64 bytes from 192.0.2.2: icmp_seq=3 ttl=64 time=1525.667 ms\n^C\n--- 192.0.2.2 ping statistics ---\n5 packets transmitted, 3 packets received, 40% packet loss\nround-trip min/avg/max/stddev = 1027.245/1657.675/2420.112/576.246 ms\n\n{master:0}\nkotetsu@bb01> ping 192.0.2.6\nPING 192.0.2.6 (192.0.2.6): 56 data bytes\n64 bytes from 192.0.2.6: icmp_seq=0 ttl=64 time=3378.582 ms\n64 bytes from 192.0.2.6: icmp_seq=1 ttl=64 time=1374.159 ms\n64 bytes from 192.0.2.6: icmp_seq=2 ttl=64 time=1474.743 ms\n^C\n--- 192.0.2.6 ping statistics ---\n3 packets transmitted, 3 packets received, 0% packet loss\nround-trip min/avg/max/stddev = 1374.159/2075.828/3378.582/922.101 ms\n```\n\n#### spine11\n\n```\n{master:0}\nkotetsu@spine11> show lldp neighbors\nLocal Interface    Parent Interface    Chassis Id          Port info          System Name\nxe-0/0/0           -                   02:05:86:71:55:00   DEV=spine11 IF=xe-0/0/0 bb01\n\n\n{master:0}\nkotetsu@spine11> show route\n\ninet.0: 6 destinations, 6 routes (6 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n10.0.0.0/24        *[Direct/0] 19:23:06\n                    > via em0.0\n10.0.0.201/32      *[Local/0] 19:23:06\n                      Local via em0.0\n169.254.0.0/24     *[Direct/0] 19:22:26\n                    > via em1.0\n169.254.0.2/32     *[Local/0] 19:22:26\n                      Local via em1.0\n192.0.2.0/30       *[Direct/0] 00:16:05\n                    > via xe-0/0/0.0\n192.0.2.2/32       *[Local/0] 00:16:05\n                      Local via xe-0/0/0.0\n\ninet6.0: 1 destinations, 1 routes (1 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\nfe80::286:2b0f:fca1:f500/128\n                   *[Direct/0] 19:22:25\n                    > via lo0.0\n\n\n{master:0}\nkotetsu@spine11> ping 192.0.2.1\nPING 192.0.2.1 (192.0.2.1): 56 data bytes\n64 bytes from 192.0.2.1: icmp_seq=0 ttl=64 time=2839.663 ms\n64 bytes from 192.0.2.1: icmp_seq=1 ttl=64 time=2463.433 ms\n64 bytes from 192.0.2.1: icmp_seq=2 ttl=64 time=2269.077 ms\n64 bytes from 192.0.2.1: icmp_seq=3 ttl=64 time=1548.765 ms\n64 bytes from 192.0.2.1: icmp_seq=4 ttl=64 time=844.779 ms\n64 bytes from 192.0.2.1: icmp_seq=5 ttl=64 time=505.582 ms\n64 bytes from 192.0.2.1: icmp_seq=6 ttl=64 time=852.323 ms\n64 bytes from 192.0.2.1: icmp_seq=7 ttl=64 time=1724.594 ms\n^C\n--- 192.0.2.1 ping statistics ---\n9 packets transmitted, 8 packets received, 11% packet loss\nround-trip min/avg/max/stddev = 505.582/1631.027/2839.663/795.890 ms\n```\n\n#### spine21\n\n```\n{master:0}\nkotetsu@spine21> show lldp neighbors\nLocal Interface    Parent Interface    Chassis Id          Port info          System Name\nxe-0/0/0           -                   02:05:86:71:55:00   DEV=spine21 IF=xe-0/0/0 bb01\n\n\n{master:0}\nkotetsu@spine21> show route\n\ninet.0: 6 destinations, 6 routes (6 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n10.0.0.0/24        *[Direct/0] 08:41:29\n                    > via em0.0\n10.0.0.202/32      *[Local/0] 08:41:30\n                      Local via em0.0\n169.254.0.0/24     *[Direct/0] 08:46:47\n                    > via em1.0\n169.254.0.2/32     *[Local/0] 08:46:47\n                      Local via em1.0\n192.0.2.4/30       *[Direct/0] 00:03:53\n                    > via xe-0/0/0.0\n192.0.2.6/32       *[Local/0] 00:03:53\n                      Local via xe-0/0/0.0\n\ninet6.0: 1 destinations, 1 routes (1 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\nfe80::286:2b0f:fcd0:9b00/128\n                   *[Direct/0] 08:46:47\n                    > via lo0.0\n\n\n{master:0}\nkotetsu@spine21> ping 192.0.2.5\nPING 192.0.2.5 (192.0.2.5): 56 data bytes\n64 bytes from 192.0.2.5: icmp_seq=0 ttl=64 time=427.225 ms\n64 bytes from 192.0.2.5: icmp_seq=1 ttl=64 time=709.372 ms\n64 bytes from 192.0.2.5: icmp_seq=2 ttl=64 time=1231.701 ms\n64 bytes from 192.0.2.5: icmp_seq=3 ttl=64 time=732.131 ms\n^C\n--- 192.0.2.5 ping statistics ---\n4 packets transmitted, 4 packets received, 0% packet loss\nround-trip min/avg/max/stddev = 427.225/775.107/1231.701/289.684 ms\n```\n\n### lo0 + eBGP \u8a2d\u5b9a\n\n\u4eca\u56de\u3001\u3044\u305a\u308c\u3082\u30b7\u30f3\u30b0\u30eb\u69cb\u6210\u306a\u306e\u3067\u30de\u30eb\u30c1\u30d1\u30b9\u95a2\u4fc2\u306e\u8a2d\u5b9a\u306f\u5165\u308c\u3066\u3044\u307e\u305b\u3093\u3088\u3002\n\n#### bb01\n\n```\nset interfaces lo0 unit 0 family inet address 172.31.0.1/32\n\nset policy-options policy-statement POLICY_EXPORT_LO0 from family inet\nset policy-options policy-statement POLICY_EXPORT_LO0 from protocol direct\nset policy-options policy-statement POLICY_EXPORT_LO0 from route-filter 0.0.0.0/0 prefix-length-range /32-/32\nset policy-options policy-statement POLICY_EXPORT_LO0 then accept\n\nset routing-options router-id 172.31.0.1\nset routing-options autonomous-system 65000\n\nset protocols bgp group BGP_UNDERLAY type external\nset protocols bgp group BGP_UNDERLAY advertise-peer-as\nset protocols bgp group BGP_UNDERLAY family inet unicast loops 2\nset protocols bgp group BGP_UNDERLAY export POLICY_EXPORT_LO0\nset protocols bgp group BGP_UNDERLAY neighbor 192.0.2.2 description spine11\nset protocols bgp group BGP_UNDERLAY neighbor 192.0.2.2 peer-as 65001\nset protocols bgp group BGP_UNDERLAY neighbor 192.0.2.6 description spine21\nset protocols bgp group BGP_UNDERLAY neighbor 192.0.2.6 peer-as 65002\n```\n\n#### spine11\n\n```\nset interfaces lo0 unit 0 family inet address 172.16.1.1/32\n\nset policy-options policy-statement POLICY_EXPORT_LO0 from family inet\nset policy-options policy-statement POLICY_EXPORT_LO0 from protocol direct\nset policy-options policy-statement POLICY_EXPORT_LO0 from route-filter 0.0.0.0/0 prefix-length-range /32-/32\nset policy-options policy-statement POLICY_EXPORT_LO0 then accept\n\nset routing-options router-id 172.16.1.1\nset routing-options autonomous-system 65001\n\nset protocols bgp group BGP_UNDERLAY type external\nset protocols bgp group BGP_UNDERLAY advertise-peer-as\nset protocols bgp group BGP_UNDERLAY family inet unicast loops 2\nset protocols bgp group BGP_UNDERLAY export POLICY_EXPORT_LO0\nset protocols bgp group BGP_UNDERLAY neighbor 192.0.2.1 description bb00\nset protocols bgp group BGP_UNDERLAY neighbor 192.0.2.1 peer-as 65000\n```\n\n#### spine21\n\n```\nset interfaces lo0 unit 0 family inet address 172.16.2.1/32\n\nset policy-options policy-statement POLICY_EXPORT_LO0 from family inet\nset policy-options policy-statement POLICY_EXPORT_LO0 from protocol direct\nset policy-options policy-statement POLICY_EXPORT_LO0 from route-filter 0.0.0.0/0 prefix-length-range /32-/32\nset policy-options policy-statement POLICY_EXPORT_LO0 then accept\n\nset routing-options router-id 172.16.2.1\nset routing-options autonomous-system 65002\n\nset protocols bgp group BGP_UNDERLAY type external\nset protocols bgp group BGP_UNDERLAY advertise-peer-as\nset protocols bgp group BGP_UNDERLAY family inet unicast loops 2\nset protocols bgp group BGP_UNDERLAY export POLICY_EXPORT_LO0\nset protocols bgp group BGP_UNDERLAY neighbor 192.0.2.5 description bb00\nset protocols bgp group BGP_UNDERLAY neighbor 192.0.2.5 peer-as 65000\n```\n\n### eBGP\u78ba\u8a8d\n\n\u305d\u308c\u305e\u308c `lo0` \u306e IP\u30a2\u30c9\u30ec\u30b9\u3092\u76f8\u4e92\u5b66\u7fd2\u3057\u305f\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\u3053\u306e\u5f8c\u3084\u308b Overlay \u7528\u306e MP-BGP (iBGP) \u3067 `bb01` \u304c Route Reflector \u306b\u306a\u308b\u306e\u3067\u3001\u5b9f\u969b\u306b\u306f `bb01` \u3068 `spine[12]1` \u3067\u4ea4\u63db\u3067\u304d\u3066\u3044\u308c\u3070\u5341\u5206\u306a\u7b48\u3067\u3059\u304c\u3002\n\n#### bb01\n\n```\n{master:0}\nkotetsu@bb01> show bgp summary\nGroups: 1 Peers: 2 Down peers: 1\nTable          Tot Paths  Act Paths Suppressed    History Damp State    Pending\ninet.0\n                       1          1          0          0          0          0\nPeer                     AS      InPkt     OutPkt    OutQ   Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped...\n192.0.2.2             65001          4          4       0       0          20 1/1/1/0              0/0/0/0\n192.0.2.6             65002          1          2       0       0        5:57 OpenConfirm\n\n{master:0}\nkotetsu@bb01> show bgp summary\nGroups: 1 Peers: 2 Down peers: 0\nTable          Tot Paths  Act Paths Suppressed    History Damp State    Pending\ninet.0\n                       2          2          0          0          0          0\nPeer                     AS      InPkt     OutPkt    OutQ   Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped...\n192.0.2.2             65001          4          5       0       0          25 1/1/1/0              0/0/0/0\n192.0.2.6             65002          4          4       0       0           4 1/1/1/0              0/0/0/0\n\n{master:0}\nkotetsu@bb01>\n\n{master:0}\nkotetsu@bb01> show bgp summary\nGroups: 1 Peers: 2 Down peers: 0\nTable          Tot Paths  Act Paths Suppressed    History Damp State    Pending\ninet.0\n                       2          2          0          0          0          0\nPeer                     AS      InPkt     OutPkt    OutQ   Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped...\n192.0.2.2             65001          4          5       0       0          26 1/1/1/0              0/0/0/0\n192.0.2.6             65002          4          4       0       0           5 1/1/1/0              0/0/0/0\n\n\n{master:0}\nkotetsu@bb01> show bgp group BGP_UNDERLAY brief\nGroup Type: External                               Local AS: 65000\n  Name: BGP_UNDERLAY    Index: 0                   Flags: <Export Eval>\n  Export: [ POLICY_EXPORT_LO0 ]\n  Options: <AdvertisePeerAs>\n  Holdtime: 0\n  Total peers: 2        Established: 2\n  192.0.2.2+56114\n  192.0.2.6+49934\n  inet.0: 2/2/2/0\n\n\n{master:0}\nkotetsu@bb01> show bgp neighbor\nPeer: 192.0.2.2+56114 AS 65001 Local: 192.0.2.1+179 AS 65000\n  Description: spine11\n  Group: BGP_UNDERLAY          Routing-Instance: master\n  Forwarding routing-instance: master\n  Type: External    State: Established    Flags: <Sync>\n  Last State: OpenConfirm   Last Event: RecvKeepAlive\n  Last Error: None\n  Export: [ POLICY_EXPORT_LO0 ]\n  Options: <Preference AddressFamily PeerAS Refresh>\n  Options: <AdvertisePeerAs PeerSpecficLoopsAllowed>\n  Address families configured: inet-unicast\n  Holdtime: 90 Preference: 170\n  Number of flaps: 0\n  Peer ID: 172.16.1.1      Local ID: 172.31.0.1        Active Holdtime: 90\n  Keepalive Interval: 30         Group index: 0    Peer index: 0\n  BFD: disabled, down\n  Local Interface: xe-0/0/0.0\n  NLRI for restart configured on peer: inet-unicast\n  NLRI advertised by peer: inet-unicast\n  NLRI for this session: inet-unicast\n  Peer supports Refresh capability (2)\n  Stale routes from peer are kept for: 300\n  Peer does not support Restarter functionality\n  Restart flag received from the peer: Notification\n  NLRI that restart is negotiated for: inet-unicast\n  NLRI of received end-of-rib markers: inet-unicast\n  NLRI of all end-of-rib markers sent: inet-unicast\n  Peer does not support LLGR Restarter functionality\n  Peer supports 4 byte AS extension (peer-as 65001)\n  Peer does not support Addpath\n  Table inet.0 Bit: 10000\n    RIB State: BGP restart is complete\n    Send state: in sync\n    Active prefixes:              1\n    Received prefixes:            1\n    Accepted prefixes:            1\n    Suppressed due to damping:    0\n    Advertised prefixes:          2\n  Last traffic (seconds): Received 23   Sent 5    Checked 56\n  Input messages:  Total 179    Updates 2       Refreshes 0     Octets 3478\n  Output messages: Total 186    Updates 2       Refreshes 0     Octets 3663\n  Output Queue[0]: 0            (inet.0, inet-unicast)\n\nPeer: 192.0.2.6+49934 AS 65002 Local: 192.0.2.5+179 AS 65000\n  Description: spine21\n  Group: BGP_UNDERLAY          Routing-Instance: master\n  Forwarding routing-instance: master\n  Type: External    State: Established    Flags: <Sync>\n  Last State: OpenConfirm   Last Event: RecvKeepAlive\n  Last Error: None\n  Export: [ POLICY_EXPORT_LO0 ]\n  Options: <Preference AddressFamily PeerAS Refresh>\n  Options: <AdvertisePeerAs PeerSpecficLoopsAllowed>\n  Address families configured: inet-unicast\n  Holdtime: 90 Preference: 170\n  Number of flaps: 0\n  Peer ID: 172.16.2.1      Local ID: 172.31.0.1        Active Holdtime: 90\n  Keepalive Interval: 30         Group index: 0    Peer index: 1\n  BFD: disabled, down\n  Local Interface: xe-0/0/1.0\n  NLRI for restart configured on peer: inet-unicast\n  NLRI advertised by peer: inet-unicast\n  NLRI for this session: inet-unicast\n  Peer supports Refresh capability (2)\n  Stale routes from peer are kept for: 300\n  Peer does not support Restarter functionality\n  Restart flag received from the peer: Notification\n  NLRI that restart is negotiated for: inet-unicast\n  NLRI of received end-of-rib markers: inet-unicast\n  NLRI of all end-of-rib markers sent: inet-unicast\n  Peer does not support LLGR Restarter functionality\n  Peer supports 4 byte AS extension (peer-as 65002)\n  Peer does not support Addpath\n  Table inet.0 Bit: 10000\n    RIB State: BGP restart is complete\n    Send state: in sync\n    Active prefixes:              1\n    Received prefixes:            1\n    Accepted prefixes:            1\n    Suppressed due to damping:    0\n    Advertised prefixes:          2\n  Last traffic (seconds): Received 54   Sent 19   Checked 15\n  Input messages:  Total 92     Updates 2       Refreshes 0     Octets 1825\n  Output messages: Total 184    Updates 2       Refreshes 0     Octets 3625\n  Output Queue[0]: 0            (inet.0, inet-unicast)\n```\n\n\n```\n{master:0}\nkotetsu@bb01> show route protocol bgp\n\ninet.0: 11 destinations, 11 routes (11 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n172.16.1.1/32      *[BGP/170] 00:02:11, localpref 100\n                      AS path: 65001 I, validation-state: unverified\n                    > to 192.0.2.2 via xe-0/0/0.0\n172.16.2.1/32      *[BGP/170] 00:01:49, localpref 100\n                      AS path: 65002 I, validation-state: unverified\n                    > to 192.0.2.6 via xe-0/0/1.0\n\ninet6.0: 1 destinations, 1 routes (1 active, 0 holddown, 0 hidden)\n\n\n{master:0}\nkotetsu@bb01> ping 172.16.2.1\nPING 172.16.2.1 (172.16.2.1): 56 data bytes\n64 bytes from 172.16.2.1: icmp_seq=0 ttl=64 time=908.929 ms\n64 bytes from 172.16.2.1: icmp_seq=1 ttl=64 time=1249.259 ms\n^C\n--- 172.16.2.1 ping statistics ---\n3 packets transmitted, 2 packets received, 33% packet loss\nround-trip min/avg/max/stddev = 908.929/1079.094/1249.259/170.165 ms\n\n\n{master:0}\nkotetsu@bb01> ping 172.16.1.1\nPING 172.16.1.1 (172.16.1.1): 56 data bytes\n64 bytes from 172.16.1.1: icmp_seq=0 ttl=64 time=2595.413 ms\n64 bytes from 172.16.1.1: icmp_seq=1 ttl=64 time=1406.501 ms\n^C\n--- 172.16.1.1 ping statistics ---\n3 packets transmitted, 2 packets received, 33% packet loss\nround-trip min/avg/max/stddev = 1406.501/2000.957/2595.413/594.456 ms\n```\n\n\n#### spine11\n\n```\n{master:0}\nkotetsu@spine11> show bgp summary\nGroups: 1 Peers: 1 Down peers: 0\nTable          Tot Paths  Act Paths Suppressed    History Damp State    Pending\ninet.0\n                       2          2          0          0          0          0\nPeer                     AS      InPkt     OutPkt    OutQ   Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped...\n192.0.2.1             65000        174        169       0       0     1:16:34 2/2/2/0              0/0/0/0\n\n\n{master:0}\nkotetsu@spine11> show bgp group BGP_UNDERLAY brief\nGroup Type: External                               Local AS: 65001\n  Name: BGP_UNDERLAY    Index: 0                   Flags: <Export Eval>\n  Export: [ POLICY_EXPORT_LO0 ]\n  Options: <AdvertisePeerAs>\n  Holdtime: 0\n  Total peers: 1        Established: 1\n  192.0.2.1+179\n  inet.0: 2/2/2/0\n\n\n{master:0}\nkotetsu@spine11> show bgp neighbor\nPeer: 192.0.2.1+179 AS 65000   Local: 192.0.2.2+56114 AS 65001\n  Description: bb00\n  Group: BGP_UNDERLAY          Routing-Instance: master\n  Forwarding routing-instance: master\n  Type: External    State: Established    Flags: <Sync>\n  Last State: OpenConfirm   Last Event: RecvKeepAlive\n  Last Error: None\n  Export: [ POLICY_EXPORT_LO0 ]\n  Options: <Preference AddressFamily PeerAS Refresh>\n  Options: <AdvertisePeerAs PeerSpecficLoopsAllowed>\n  Address families configured: inet-unicast\n  Holdtime: 90 Preference: 170\n  Number of flaps: 0\n  Peer ID: 172.31.0.1      Local ID: 172.16.1.1        Active Holdtime: 90\n  Keepalive Interval: 30         Group index: 0    Peer index: 0\n  BFD: disabled, down\n  Local Interface: xe-0/0/0.0\n  NLRI for restart configured on peer: inet-unicast\n  NLRI advertised by peer: inet-unicast\n  NLRI for this session: inet-unicast\n  Peer supports Refresh capability (2)\n  Stale routes from peer are kept for: 300\n  Peer does not support Restarter functionality\n  Restart flag received from the peer: Notification\n  NLRI that restart is negotiated for: inet-unicast\n  NLRI of received end-of-rib markers: inet-unicast\n  NLRI of all end-of-rib markers sent: inet-unicast\n  Peer does not support LLGR Restarter functionality\n  Peer supports 4 byte AS extension (peer-as 65000)\n  Peer does not support Addpath\n  Table inet.0 Bit: 10000\n    RIB State: BGP restart is complete\n    Send state: in sync\n    Active prefixes:              2\n    Received prefixes:            2\n    Accepted prefixes:            2\n    Suppressed due to damping:    0\n    Advertised prefixes:          1\n  Last traffic (seconds): Received 9    Sent 7    Checked 50\n  Input messages:  Total 182    Updates 3       Refreshes 0     Octets 3524\n  Output messages: Total 177    Updates 1       Refreshes 0     Octets 3459\n  Output Queue[0]: 0            (inet.0, inet-unicast)\n```\n\n```\n{master:0}\nkotetsu@spine11> show route protocol bgp\n\ninet.0: 9 destinations, 9 routes (9 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n172.16.2.1/32      *[BGP/170] 01:22:49, localpref 100\n                      AS path: 65000 65002 I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n172.31.0.1/32      *[BGP/170] 01:23:10, localpref 100\n                      AS path: 65000 I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n\ninet6.0: 1 destinations, 1 routes (1 active, 0 holddown, 0 hidden)\n\n\n{master:0}\nkotetsu@spine11> ping 172.31.0.1\nPING 172.31.0.1 (172.31.0.1): 56 data bytes\n64 bytes from 172.31.0.1: icmp_seq=0 ttl=64 time=1597.291 ms\n64 bytes from 172.31.0.1: icmp_seq=1 ttl=64 time=1215.306 ms\n^C\n--- 172.31.0.1 ping statistics ---\n2 packets transmitted, 2 packets received, 0% packet loss\nround-trip min/avg/max/stddev = 1215.306/1406.299/1597.291/190.993 ms\n\n```\n\n#### spine21\n\n```\n{master:0}\nkotetsu@spine21> show bgp summary\nGroups: 1 Peers: 1 Down peers: 0\nTable          Tot Paths  Act Paths Suppressed    History Damp State    Pending\ninet.0\n                       2          2          0          0          0          0\nPeer                     AS      InPkt     OutPkt    OutQ   Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped...\n192.0.2.5             65000        173         88       0       0       38:05 2/2/2/0              0/0/0/0\n\n\n{master:0}\nkotetsu@spine21> show bgp group BGP_UNDERLAY brief\nGroup Type: External                               Local AS: 65002\n  Name: BGP_UNDERLAY    Index: 0                   Flags: <Export Eval>\n  Export: [ POLICY_EXPORT_LO0 ]\n  Options: <AdvertisePeerAs>\n  Holdtime: 0\n  Total peers: 1        Established: 1\n  192.0.2.5+179\n  inet.0: 2/2/2/0\n\n\nkotetsu@spine21> show bgp neighbor\nPeer: 192.0.2.5+179 AS 65000   Local: 192.0.2.6+49934 AS 65002\n  Description: bb00\n  Group: BGP_UNDERLAY          Routing-Instance: master\n  Forwarding routing-instance: master\n  Type: External    State: Established    Flags: <Sync>\n  Last State: OpenConfirm   Last Event: RecvKeepAlive\n  Last Error: None\n  Export: [ POLICY_EXPORT_LO0 ]\n  Options: <Preference AddressFamily PeerAS Refresh>\n  Options: <AdvertisePeerAs PeerSpecficLoopsAllowed>\n  Address families configured: inet-unicast\n  Holdtime: 90 Preference: 170\n  Number of flaps: 0\n  Peer ID: 172.31.0.1      Local ID: 172.16.2.1        Active Holdtime: 90\n  Keepalive Interval: 30         Group index: 0    Peer index: 0\n  BFD: disabled, down\n  Local Interface: xe-0/0/0.0\n  NLRI for restart configured on peer: inet-unicast\n  NLRI advertised by peer: inet-unicast\n  NLRI for this session: inet-unicast\n  Peer supports Refresh capability (2)\n  Stale routes from peer are kept for: 300\n  Peer does not support Restarter functionality\n  Restart flag received from the peer: Notification\n  NLRI that restart is negotiated for: inet-unicast\n  NLRI of received end-of-rib markers: inet-unicast\n  NLRI of all end-of-rib markers sent: inet-unicast\n  Peer does not support LLGR Restarter functionality\n  Peer supports 4 byte AS extension (peer-as 65000)\n  Peer does not support Addpath\n  Table inet.0 Bit: 10000\n    RIB State: BGP restart is complete\n    Send state: in sync\n    Active prefixes:              2\n    Received prefixes:            2\n    Accepted prefixes:            2\n    Suppressed due to damping:    0\n    Advertised prefixes:          1\n  Last traffic (seconds): Received 1    Sent 24   Checked 3\n  Input messages:  Total 175    Updates 3       Refreshes 0     Octets 3391\n  Output messages: Total 88     Updates 1       Refreshes 0     Octets 1768\n  Output Queue[0]: 0            (inet.0, inet-unicast)\n```\n\n```\n{master:0}\nkotetsu@spine21> show route protocol bgp\n\ninet.0: 9 destinations, 9 routes (9 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n172.16.1.1/32      *[BGP/170] 00:41:43, localpref 100\n                      AS path: 65000 65001 I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n172.31.0.1/32      *[BGP/170] 00:41:43, localpref 100\n                      AS path: 65000 I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n\ninet6.0: 1 destinations, 1 routes (1 active, 0 holddown, 0 hidden)\n\n\n{master:0}\nkotetsu@spine21> ping 172.31.0.1\nPING 172.31.0.1 (172.31.0.1): 56 data bytes\n64 bytes from 172.31.0.1: icmp_seq=0 ttl=64 time=691.327 ms\n64 bytes from 172.31.0.1: icmp_seq=1 ttl=64 time=1227.117 ms\n64 bytes from 172.31.0.1: icmp_seq=2 ttl=64 time=238.494 ms\n^C\n--- 172.31.0.1 ping statistics ---\n3 packets transmitted, 3 packets received, 0% packet loss\nround-trip min/avg/max/stddev = 238.494/718.979/1227.117/404.077 ms\n\n```\n\n\n## Overlay \u8a2d\u5b9a\uff5e\u78ba\u8a8d (MP-BGP)\n\nUnderlay eBGP \u3067\u7d4c\u8def\u4ea4\u63db\u3057\u305f\u5404 `lo0` \u540c\u58eb\u3067 iBGP \u3092\u7d44\u307f\u307e\u3059\u3002\n\u307e\u3042\u3001\u9577\u3005\u3068\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3059\u304c\u3001\u7d75\u306b\u3059\u308b\u3068\u5358\u7d14\u3067\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u611f\u3058\u3067\u3059\u3002\n\n![02_92_BGP_Overlay_cut.png](https://qiita-image-store.s3.amazonaws.com/0/60456/5353f8a0-620f-8de8-5f22-5824da2777e6.png)\n\n### iBGP (MP-BGP )\u8a2d\u5b9a\n\n\u30dd\u30a4\u30f3\u30c8\u306f1\u3064\u3060\u3051\u3067 `family evpn signaling` \u3092\u8a2d\u5b9a\u3057\u3066 EVPN \u306e NLRI \u3092\u6271\u3046\u3063\u3066\u3068\u3053\u3067\u3059\u304b\u306d\u3002\n\n#### bb01\n\n```\nset protocols bgp group BGP_OVERLAY type internal\nset protocols bgp group BGP_OVERLAY local-address 172.31.0.1\nset protocols bgp group BGP_OVERLAY family evpn signaling\nset protocols bgp group BGP_OVERLAY cluster 172.31.0.1\nset protocols bgp group BGP_OVERLAY local-as 64512\nset protocols bgp group BGP_OVERLAY neighbor 172.16.1.1 description spine11\nset protocols bgp group BGP_OVERLAY neighbor 172.16.2.1 description spine21\n```\n\n#### spine11\n\n```\nset protocols bgp group BGP_OVERLAY type internal\nset protocols bgp group BGP_OVERLAY local-address 172.16.1.1\nset protocols bgp group BGP_OVERLAY family evpn signaling\nset protocols bgp group BGP_OVERLAY local-as 64512\nset protocols bgp group BGP_OVERLAY neighbor 172.31.0.1 description bb01\n```\n\n\n#### spine21\n\n```\nset protocols bgp group BGP_OVERLAY type internal\nset protocols bgp group BGP_OVERLAY local-address 172.16.2.1\nset protocols bgp group BGP_OVERLAY family evpn signaling\nset protocols bgp group BGP_OVERLAY local-as 64512\nset protocols bgp group BGP_OVERLAY neighbor 172.31.0.1 description bb01\n```\n\n### iBGP (MP-BGP) \u78ba\u8a8d\n\n\u6700\u521d neighbor IP \u30a2\u30c9\u30ec\u30b9\u8a2d\u5b9a\u3092\u30bf\u30a4\u30dd\u3057\u305f\u305b\u3044\u3067\u3001`Last Error: Open Message Error` \u3068\u304b\u6b8b\u3063\u3066\u3044\u308b\u306e\u306f\u3054\u611b\u656c\u3068\u3044\u3046\u3053\u3068\u3067\u3072\u3068\u3064...\u3002\n\n#### bb01\n\n```\n{master:0}\nkotetsu@bb01> show bgp summary\nGroups: 2 Peers: 4 Down peers: 0\nTable          Tot Paths  Act Paths Suppressed    History Damp State    Pending\ninet.0\n                       2          2          0          0          0          0\nbgp.evpn.0\n                       0          0          0          0          0          0\nPeer                     AS      InPkt     OutPkt    OutQ   Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped...\n172.16.1.1            64512          3          3       0       0          25 Establ\n  bgp.evpn.0: 0/0/0/0\n172.16.2.1            64512          3          2       0       0          12 Establ\n  bgp.evpn.0: 0/0/0/0\n192.0.2.2             65001        502        518       0       0     3:58:25 1/1/1/0              0/0/0/0\n192.0.2.6             65002        257        517       0       0     3:58:04 1/1/1/0              0/0/0/0\n\n\n{master:0}\nkotetsu@bb01> show bgp group BGP_OVERLAY\nGroup Type: Internal    AS: 64512                  Local AS: 64512\n  Name: BGP_OVERLAY     Index: 1                   Flags: <Export Eval>\n  Options: <Cluster LocalAS>\n  Holdtime: 0 Local AS: 64512 Local System AS: 65000\n  Total peers: 2        Established: 2\n  172.16.1.1+52050\n  172.16.2.1+62794\n  Trace options: normal\n  Trace file: /var/log/bgp.log size 10240 files 30\n  bgp.evpn.0: 0/0/0/0\n\n\n{master:0}\nkotetsu@bb01> show bgp neighbor\nPeer: 172.16.1.1+52050 AS 64512 Local: 172.31.0.1+179 AS 64512\n  Description: spine11\n  Group: BGP_OVERLAY           Routing-Instance: master\n  Forwarding routing-instance: master\n  Type: Internal    State: Established  (route reflector client)Flags: <Sync>\n  Last State: OpenConfirm   Last Event: RecvKeepAlive\n  Last Error: Open Message Error\n  Options: <Preference LocalAddress Cluster AddressFamily LocalAS Rib-group Refresh>\n  Address families configured: evpn\n  Local Address: 172.31.0.1 Holdtime: 90 Preference: 170 Local AS: 64512 Local System AS: 65000\n  Number of flaps: 0\n  Error: 'Open Message Error' Sent: 20 Recv: 0\n  Peer ID: 172.16.1.1      Local ID: 172.31.0.1        Active Holdtime: 90\n  Keepalive Interval: 30         Group index: 1    Peer index: 0\n  BFD: disabled, down\n  NLRI for restart configured on peer: evpn\n  NLRI advertised by peer: evpn\n  NLRI for this session: evpn\n  Peer supports Refresh capability (2)\n  Stale routes from peer are kept for: 300\n  Peer does not support Restarter functionality\n  Restart flag received from the peer: Notification\n  NLRI that restart is negotiated for: evpn\n  NLRI of received end-of-rib markers: evpn\n  NLRI of all end-of-rib markers sent: evpn\n  Peer does not support LLGR Restarter functionality\n  Peer supports 4 byte AS extension (peer-as 64512)\n  Peer does not support Addpath\n  Table bgp.evpn.0 Bit: 20000\n    RIB State: BGP restart is complete\n    RIB State: VPN restart is complete\n    Send state: in sync\n    Active prefixes:              0\n    Received prefixes:            0\n    Accepted prefixes:            0\n    Suppressed due to damping:    0\n    Advertised prefixes:          0\n  Last traffic (seconds): Received 1    Sent 9    Checked 0\n  Input messages:  Total 6      Updates 1       Refreshes 0     Octets 169\n  Output messages: Total 6      Updates 0       Refreshes 0     Octets 188\n  Output Queue[1]: 0            (bgp.evpn.0, evpn)\n  Trace options: normal\n  Trace file: /var/log/bgp.log size 10240 files 30\n\nPeer: 172.16.2.1+62794 AS 64512 Local: 172.31.0.1+179 AS 64512\n  Description: spine21\n  Group: BGP_OVERLAY           Routing-Instance: master\n  Forwarding routing-instance: master\n  Type: Internal    State: Established  (route reflector client)Flags: <Sync>\n  Last State: OpenConfirm   Last Event: RecvKeepAlive\n  Last Error: Open Message Error\n  Options: <Preference LocalAddress Cluster AddressFamily LocalAS Rib-group Refresh>\n  Address families configured: evpn\n  Local Address: 172.31.0.1 Holdtime: 90 Preference: 170 Local AS: 64512 Local System AS: 65000\n  Number of flaps: 0\n  Error: 'Open Message Error' Sent: 20 Recv: 0\n  Peer ID: 172.16.2.1      Local ID: 172.31.0.1        Active Holdtime: 90\n  Keepalive Interval: 30         Group index: 1    Peer index: 1\n  BFD: disabled, down\n  NLRI for restart configured on peer: evpn\n  NLRI advertised by peer: evpn\n  NLRI for this session: evpn\n  Peer supports Refresh capability (2)\n  Stale routes from peer are kept for: 300\n  Peer does not support Restarter functionality\n  Restart flag received from the peer: Notification\n  NLRI that restart is negotiated for: evpn\n  NLRI of received end-of-rib markers: evpn\n  NLRI of all end-of-rib markers sent: evpn\n  Peer does not support LLGR Restarter functionality\n  Peer supports 4 byte AS extension (peer-as 64512)\n  Peer does not support Addpath\n  Table bgp.evpn.0 Bit: 20000\n    RIB State: BGP restart is complete\n    RIB State: VPN restart is complete\n    Send state: in sync\n    Active prefixes:              0\n    Received prefixes:            0\n    Accepted prefixes:            0\n    Suppressed due to damping:    0\n    Advertised prefixes:          0\n  Last traffic (seconds): Received 46   Sent 0    Checked 9\n  Input messages:  Total 10     Updates 1       Refreshes 0     Octets 245\n  Output messages: Total 18     Updates 0       Refreshes 0     Octets 416\n  Output Queue[1]: 0            (bgp.evpn.0, evpn)\n  Trace options: normal\n  Trace file: /var/log/bgp.log size 10240 files 30\n\n...\n\n```\n\n#### spine11\n\n```\n{master:0}\nkotetsu@spine11> show bgp summary\nGroups: 2 Peers: 2 Down peers: 0\nTable          Tot Paths  Act Paths Suppressed    History Damp State    Pending\ninet.0\n                       2          2          0          0          0          0\nbgp.evpn.0\n                       0          0          0          0          0          0\nPeer                     AS      InPkt     OutPkt    OutQ   Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped...\n172.31.0.1            64512         21         22       0       0        9:07 Establ\n  bgp.evpn.0: 0/0/0/0\n192.0.2.1             65000        536        521       0       0     3:59:55 2/2/2/0              0/0/0/\n\n\n{master:0}\nkotetsu@spine11> show bgp group BGP_OVERLAY\nGroup Type: Internal    AS: 64512                  Local AS: 64512\n  Name: BGP_OVERLAY     Index: 1                   Flags: <Export Eval>\n  Options: <LocalAS>\n  Holdtime: 0 Local AS: 64512 Local System AS: 65001\n  Total peers: 1        Established: 1\n  172.31.0.1+179\n  Trace options: normal\n  Trace file: /var/log/bgp.log size 10240 files 30\n  bgp.evpn.0: 0/0/0/0\n\n\n{master:0}\nkotetsu@spine11> show bgp neighbor\nPeer: 172.31.0.1+179 AS 64512  Local: 172.16.1.1+52050 AS 64512\n  Description: bb01\n  Group: BGP_OVERLAY           Routing-Instance: master\n  Forwarding routing-instance: master\n  Type: Internal    State: Established    Flags: <Sync>\n  Last State: OpenConfirm   Last Event: RecvKeepAlive\n  Last Error: None\n  Options: <Preference LocalAddress AddressFamily LocalAS Rib-group Refresh>\n  Address families configured: evpn\n  Local Address: 172.16.1.1 Holdtime: 90 Preference: 170 Local AS: 64512 Local System AS: 65001\n  Number of flaps: 0\n  Peer ID: 172.31.0.1      Local ID: 172.16.1.1        Active Holdtime: 90\n  Keepalive Interval: 30         Group index: 1    Peer index: 1\n  BFD: disabled, down\n  NLRI for restart configured on peer: evpn\n  NLRI advertised by peer: evpn\n  NLRI for this session: evpn\n  Peer supports Refresh capability (2)\n  Stale routes from peer are kept for: 300\n  Peer does not support Restarter functionality\n  Restart flag received from the peer: Notification\n  NLRI that restart is negotiated for: evpn\n  NLRI of received end-of-rib markers: evpn\n  NLRI of all end-of-rib markers sent: evpn\n  Peer does not support LLGR Restarter functionality\n  Peer supports 4 byte AS extension (peer-as 64512)\n  Peer does not support Addpath\n  Table bgp.evpn.0\n    RIB State: BGP restart is complete\n    RIB State: VPN restart is complete\n    Send state: not advertising\n    Active prefixes:              0\n    Received prefixes:            0\n    Accepted prefixes:            0\n    Suppressed due to damping:    0\n  Last traffic (seconds): Received 1    Sent 8    Checked 46\n  Input messages:  Total 34     Updates 1       Refreshes 0     Octets 657\n  Output messages: Total 34     Updates 0       Refreshes 0     Octets 720\n  Trace options: normal\n  Trace file: /var/log/bgp.log size 10240 files 30\n\n...\n\n```\n\n#### spine21\n\n```\n{master:0}\nkotetsu@spine21> show bgp summary\nGroups: 2 Peers: 2 Down peers: 0\nTable          Tot Paths  Act Paths Suppressed    History Damp State    Pending\ninet.0\n                       2          2          0          0          0          0\nbgp.evpn.0\n                       0          0          0          0          0          0\nPeer                     AS      InPkt     OutPkt    OutQ   Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped...\n172.31.0.1            64512         34         19       0       0        7:30 Establ\n  bgp.evpn.0: 0/0/0/0\n192.0.2.5             65000        549        273       0       0     2:02:08 2/2/2/0              0/0/0/0\n\n\n{master:0}\nkotetsu@spine21> show bgp group BGP_OVERLAY\nGroup Type: Internal    AS: 64512                  Local AS: 64512\n  Name: BGP_OVERLAY     Index: 1                   Flags: <Export Eval>\n  Options: <LocalAS>\n  Holdtime: 0 Local AS: 64512 Local System AS: 65002\n  Total peers: 1        Established: 1\n  172.31.0.1+179\n  Trace options: normal\n  Trace file: /var/log/bgp.log size 10240 files 30\n  bgp.evpn.0: 0/0/0/0\n\n\n{master:0}\nkotetsu@spine21> show bgp neighbor\nPeer: 172.31.0.1+179 AS 64512  Local: 172.16.2.1+62794 AS 64512\n  Description: bb01\n  Group: BGP_OVERLAY           Routing-Instance: master\n  Forwarding routing-instance: master\n  Type: Internal    State: Established    Flags: <Sync>\n  Last State: OpenConfirm   Last Event: RecvKeepAlive\n  Last Error: None\n  Options: <Preference LocalAddress AddressFamily LocalAS Rib-group Refresh>\n  Address families configured: evpn\n  Local Address: 172.16.2.1 Holdtime: 90 Preference: 170 Local AS: 64512 Local System AS: 65002\n  Number of flaps: 0\n  Peer ID: 172.31.0.1      Local ID: 172.16.2.1        Active Holdtime: 90\n  Keepalive Interval: 30         Group index: 1    Peer index: 1\n  BFD: disabled, down\n  NLRI for restart configured on peer: evpn\n  NLRI advertised by peer: evpn\n  NLRI for this session: evpn\n  Peer supports Refresh capability (2)\n  Stale routes from peer are kept for: 300\n  Peer does not support Restarter functionality\n  Restart flag received from the peer: Notification\n  NLRI that restart is negotiated for: evpn\n  NLRI of received end-of-rib markers: evpn\n  NLRI of all end-of-rib markers sent: evpn\n  Peer does not support LLGR Restarter functionality\n  Peer supports 4 byte AS extension (peer-as 64512)\n  Peer does not support Addpath\n  Table bgp.evpn.0\n    RIB State: BGP restart is complete\n    RIB State: VPN restart is complete\n    Send state: not advertising\n    Active prefixes:              0\n    Received prefixes:            0\n    Accepted prefixes:            0\n    Suppressed due to damping:    0\n  Last traffic (seconds): Received 14   Sent 17   Checked 58\n  Input messages:  Total 36     Updates 1       Refreshes 0     Octets 695\n  Output messages: Total 20     Updates 0       Refreshes 0     Octets 454\n  Trace options: normal\n  Trace file: /var/log/bgp.log size 10240 files 30\n\n...\n\n```\n\n## Overlay\u8a2d\u5b9a\uff5e\u78ba\u8a8d(EVPN+VXLAN)\n\nEVPN \u306e\u8a2d\u5b9a\u3068\u3001\u305d\u306e Dataplane \u3068\u3057\u3066\u4f7f\u3046 VXLAN \u5468\u308a\u306e\u8a2d\u5b9a\u3092\u3057\u3066\u3044\u304d\u307e\u3059\u3002(\u606f\u5207\u308c)\n\n### EVPN+VXLAN \u8a2d\u5b9a\n\n\u5192\u982d\u306e\u5168\u4f53\u69cb\u6210\u306b\u66f8\u3044\u305f\u306e\u3067\u3059\u304c `bb01` \u306f\u3053\u306e\u8fba\u306e\u6319\u52d5\u306b\u95a2\u3057\u3066\u306f\u571f\u7ba1\u306b\u5fb9\u3057\u3066\u3044\u308b\u306e\u3067\u767b\u5834\u3057\u307e\u305b\u3093\u3002\nVNI \u306f `1..16777214` \u307e\u3067\u4f7f\u3048\u308b\u306e\u3067\u3001\u5358\u7d14\u306b\u5168 spine \u3067 VLAN ID \u3068 1:1 \u3067\u540c\u3058\u5bfe\u5fdc\u4ed8\u3051\u3092\u3055\u305b\u3066\u3001\u4e00\u5f8b\u3067 `VLAN ID + 10000` \u306e\u5024\u3092\u632f\u3063\u3066\u307e\u3059\u3002\n\u3042\u3001VNI 10100 \u4ee5\u5916\u306f\u672c\u9805\u3067\u306f\u307e\u3060\u4f7f\u3044\u307e\u305b\u3093\u3002\n\n\n#### spine11\n\n```\nset vlans VLAN0100 vlan-id 100\nset vlans VLAN0100 vxlan vni 10100\nset vlans VLAN0100 vxlan ingress-node-replication\n\nset vlans VLAN0300 vlan-id 300\nset vlans VLAN0300 vxlan vni 10300\nset vlans VLAN0300 vxlan ingress-node-replication\n\nset protocols evpn encapsulation vxlan\nset protocols evpn extended-vni-list all\nset protocols evpn multicast-mode ingress-replication\nset protocols evpn vni-options vni 10100 vrf-target export target:1:10100\nset protocols evpn vni-options vni 10300 vrf-target export target:1:10300\n\nset policy-options community COM_10100 members target:1:10100\nset policy-options community COM_10300 members target:1:10300\nset policy-options community COM_LEAF_ESI members target:9999:9999\n\nset policy-options policy-statement POLICY_VRF_IMPORT term T_10100 from community COM_10100\nset policy-options policy-statement POLICY_VRF_IMPORT term T_10100 then accept\nset policy-options policy-statement POLICY_VRF_IMPORT term T_10300 from community COM_10300\nset policy-options policy-statement POLICY_VRF_IMPORT term T_10300 then accept\nset policy-options policy-statement POLICY_VRF_IMPORT term T_99900 from community COM_LEAF_ESI\nset policy-options policy-statement POLICY_VRF_IMPORT term T_99900 then accept\nset policy-options policy-statement POLICY_VRF_IMPORT term T_99999 then reject\n\nset switch-options vtep-source-interface lo0.0\nset switch-options route-distinguisher 64512:11\nset switch-options vrf-import POLICY_VRF_IMPORT\nset switch-options vrf-target target:9999:9999\nset switch-options vrf-target auto \n\nset interfaces xe-0/0/1 description \"DEV=torSW11 IF=1\"\nset interfaces xe-0/0/1 unit 0 family ethernet-switching interface-mode trunk\nset interfaces xe-0/0/1 unit 0 family ethernet-switching vlan members all\n\n```\n\n\n#### spine21\n\n```\nset vlans VLAN0100 vlan-id 100\nset vlans VLAN0100 vxlan vni 10100\nset vlans VLAN0100 vxlan ingress-node-replication\n\nset vlans VLAN0200 vlan-id 200\nset vlans VLAN0200 vxlan vni 10200\nset vlans VLAN0200 vxlan ingress-node-replication\n\nset protocols evpn encapsulation vxlan\nset protocols evpn extended-vni-list all\nset protocols evpn multicast-mode ingress-replication\nset protocols evpn vni-options vni 10100 vrf-target export target:1:10100\nset protocols evpn vni-options vni 10200 vrf-target export target:1:10200\n\nset policy-options community COM_10100 members target:1:10100\nset policy-options community COM_10200 members target:1:10200\nset policy-options community COM_LEAF_ESI members target:9999:9999\n\nset policy-options policy-statement POLICY_VRF_IMPORT term T_10100 from community COM_10100\nset policy-options policy-statement POLICY_VRF_IMPORT term T_10100 then accept\nset policy-options policy-statement POLICY_VRF_IMPORT term T_10200 from community COM_10200\nset policy-options policy-statement POLICY_VRF_IMPORT term T_10200 then accept\nset policy-options policy-statement POLICY_VRF_IMPORT term T_99900 from community COM_LEAF_ESI\nset policy-options policy-statement POLICY_VRF_IMPORT term T_99900 then accept\nset policy-options policy-statement POLICY_VRF_IMPORT term T_99999 then reject\n\nset switch-options vtep-source-interface lo0.0\nset switch-options route-distinguisher 64512:21\nset switch-options vrf-import POLICY_VRF_IMPORT\nset switch-options vrf-target target:9999:9999\nset switch-options vrf-target auto \n\nset interfaces xe-0/0/1 description \"DEV=torSW21 IF=1\"\nset interfaces xe-0/0/1 unit 0 family ethernet-switching interface-mode trunk\nset interfaces xe-0/0/1 unit 0 family ethernet-switching vlan members all\n```\n\n\n\n## \u52d5\u4f5c\u78ba\u8a8d\n\n### node \u540c\u58eb\u306e\u758e\u901a\u78ba\u8a8d\n\n- node11\n\n```\n$ ip a show dev ens4\n3: ens4: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 00:86:2b:8d:10:01 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.1.1/24 brd 192.168.1.255 scope global ens4\n       valid_lft forever preferred_lft forever\n    inet6 fe80::286:2bff:fe8d:1001/64 scope link\n       valid_lft forever preferred_lft forever\n\n$ ping 192.168.1.2\nPING 192.168.1.2 (192.168.1.2) 56(84) bytes of data.\n64 bytes from 192.168.1.2: icmp_seq=1 ttl=64 time=975 ms\n64 bytes from 192.168.1.2: icmp_seq=2 ttl=64 time=949 ms\n\n$ ip n show dev ens4\n192.168.1.2 lladdr 00:86:2b:5c:0d:01 STALE\n```\n\n- node21\n\n```\n$ ip a show dev ens4\n3: ens4: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 00:86:2b:5c:0d:01 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.1.2/24 brd 192.168.1.255 scope global ens4\n       valid_lft forever preferred_lft forever\n    inet6 fe80::286:2bff:fe5c:d01/64 scope link\n       valid_lft forever preferred_lft forever\n\n$ ping 192.168.1.1\nPING 192.168.1.1 (192.168.1.1) 56(84) bytes of data.\n64 bytes from 192.168.1.1: icmp_seq=1 ttl=64 time=639 ms\n64 bytes from 192.168.1.1: icmp_seq=2 ttl=64 time=926 ms\n\n$ ip n show dev ens4\n192.168.1.1 lladdr 00:86:2b:8d:10:01 STALE\n```\n\n### vQFX \u306e\u30c6\u30fc\u30d6\u30eb\u78ba\u8a8d\n\n\u524d\u8ff0\u306e [Juniper\u516c\u5f0f\u65e5\u672c\u8a9e\u8cc7\u6599](http://www.juniper.net/assets/jp/jp/local/pdf/whitepapers/2000606-jp.pdf) \u306e\u30da\u30fc\u30b8 36 \u306b\u3088\u308b\u3068\n\n> bgp.evpn.0 = Junos OS \u30eb\u30fc\u30c6\u30a3\u30f3\u30b0 \u30d7\u30ed\u30c8\u30b3\u30eb \u30d7\u30ed\u30bb\u30b9\uff08RPD\uff09\u5185\u306e\u30b0\u30ed\u30fc\u30d0\u30eb EVPN \u30eb\u30fc\u30c6\u30a3\u30f3\u30b0 \u30c6\u30fc\u30d6\u30eb\n> default.switch.evpn.0\uff08QFX5100 \u306e\u5834\u5408\uff09 = Junos OS RPD \u5185\u306e\u30b9\u30a4\u30c3\u30c1 \u30ec\u30d9\u30eb EVPN \u8ee2\u9001\u30c6\u30fc\u30d6\u30eb\n> \\<virtual-switch-name\\>.evpn.0\uff08MX \u306e\u5834\u5408\uff09 = Junos OS RPD \u5185\u306e\u4eee\u60f3\u30b9\u30a4\u30c3\u30c1 \u30ec\u30d9\u30eb EVPN \u8ee2\u9001\u30c6\u30fc\u30d6\u30eb\n\n\u3089\u3057\u3044\u3067\u3059\u3088\u3002\n\n\n#### spine11\n\n\u3053\u3044\u3064\u306b\u3068\u3063\u3066\u306e `vtep.32769` \u3066\u306e\u306f `spine21` (\u306e VTEP)\n\n```\n{master:0}\nkotetsu@spine11> show ethernet-switching table\n\nMAC flags (S - static MAC, D - dynamic MAC, L - locally learned, P - Persistent static\n           SE - statistics enabled, NM - non configured MAC, R - remote PE MAC, O - ovsdb MAC)\n\n\nEthernet switching table : 2 entries, 2 learned\nRouting instance : default-switch\n   Vlan                MAC                 MAC      Logical                Active\n   name                address             flags    interface              source\n   VLAN0100            00:86:2b:5c:0d:01   D        vtep.32769             172.16.2.1\n   VLAN0100            00:86:2b:8d:10:01   D        xe-0/0/1.0\n\n\n{master:0}\nkotetsu@spine11> show interfaces vtep.32769\n  Logical interface vtep.32769 (Index 566) (SNMP ifIndex 537)\n    Flags: Up SNMP-Traps Encapsulation: ENET2\n    VXLAN Endpoint Type: Remote, VXLAN Endpoint Address: 172.16.2.1, L2 Routing Instance: default-switch, L3 Routing Instance: default\n    Input packets : 4\n    Output packets: 4\n    Protocol eth-switch, MTU: Unlimited\n      Flags: Trunk-Mode\n\n```\n\nEVPN \u306e Type2(`MAC/IP Advertisement route`) \u3068 Type3(`Inclusive Multicast Ethernet Tag route`) \u3092 `spine21` (RD `64512:21`)\u304b\u3089\u5b66\u7fd2\u3057\u3066 `bgp.evpn.0` \u304b\u3089 `default-switch.evpn.0` \u306b\u30ed\u30fc\u30c9\u3055\u308c\u3066\u3044\u308b\u69d8\u5b50\n\n```\n{master:0}\nkotetsu@spine11> show route\n\n...\n\n:vxlan.inet.0: 8 destinations, 8 routes (8 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n10.0.0.0/24        *[Direct/0] 00:23:24\n                    > via em0.0\n10.0.0.201/32      *[Local/0] 00:06:15\n                      Local via em0.0\n169.254.0.0/24     *[Direct/0] 00:23:24\n                    > via em1.0\n169.254.0.2/32     *[Local/0] 00:23:24\n                      Local via em1.0\n172.16.1.1/32      *[Direct/0] 00:23:24\n                    > via lo0.0\n172.16.2.1/32      *[Static/1] 00:13:22, metric2 0\n                    > to 192.0.2.1 via xe-0/0/0.0\n192.0.2.0/30       *[Direct/0] 00:23:24\n                    > via xe-0/0/0.0\n192.0.2.2/32       *[Local/0] 00:23:24\n                      Local via xe-0/0/0.0\n\n\nbgp.evpn.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n2:64512:21::10100::00:86:2b:5c:0d:01/304\n                   *[BGP/170] 00:08:29, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n3:64512:21::10100::172.16.2.1/304\n                   *[BGP/170] 00:13:23, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n\n\ndefault-switch.evpn.0: 5 destinations, 5 routes (5 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n2:64512:11::10100::00:86:2b:8d:10:01/304\n                   *[EVPN/170] 00:08:33\n                      Indirect\n2:64512:21::10100::00:86:2b:5c:0d:01/304\n                   *[BGP/170] 00:08:29, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n3:64512:11::10100::172.16.1.1/304\n                   *[EVPN/170] 00:23:27\n                      Indirect\n3:64512:11::10300::172.16.1.1/304\n                   *[EVPN/170] 00:15:11\n                      Indirect\n3:64512:21::10100::172.16.2.1/304\n                   *[BGP/170] 00:13:23, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n```\n\n```\n{master:0}\nkotetsu@spine11> show route forwarding-table\n\n...\n\nRouting table: :vxlan.inet\nInternet:\nDestination        Type RtRef Next hop           Type Index    NhRef Netif\ndefault            perm     0                    rjct     1724     1\n0.0.0.0/32         perm     0                    dscd     1722     1\n169.254.0.0/24     user     0                    rtbl        1     5\n169.254.0.2/32     user     0 169.254.0.2        locl      338     3\n172.16.1.1/32      user     0                    rtbl        1     5\n172.16.2.1/32      user     0                    indr   131070     3\n                              192.0.2.1          ucst     1719     7 xe-0/0/0.0\n192.0.2.0/30       user     0                    rtbl        1     5\n192.0.2.2/32       user     0 192.0.2.2          locl     1717     3\n224.0.0.0/4        perm     0                    mdsc     1723     1\n224.0.0.1/32       perm     0 224.0.0.1          mcst     1726     1\n255.255.255.255/32 perm     0                    bcst     1727     1\n\n...\n\nRouting table: default-switch.bridge\nBridging domain: VLAN0100.bridge\nVPLS:\nDestination        Type RtRef Next hop           Type Index    NhRef Netif\n00:86:2b:5c:0d:01/48 user     0                  comp     1707     6\n00:86:2b:8d:10:01/48 user     0                  ucst     1712     6 xe-0/0/1.0\n0x30001/51         user     0                    comp     1739     2\n0x30006/51         user     0                    comp     1732     2\n0x30002/51         user     0                    comp     1733     2\n\nRouting table: default-switch.bridge\nBridging domain: VLAN0300.bridge\nVPLS:\nDestination        Type RtRef Next hop           Type Index    NhRef Netif\n0x30007/51         user     0                    comp     1741     2\n0x30005/51         user     0                    comp     1714     2\n0x30003/51         user     0                    comp     1734     2\n\n...\n```\n\n#### spine21\n\n\u3053\u3044\u3064\u306b\u3068\u3063\u3066\u306e `vtep.32769` \u3066\u306e\u306f `spine11` (\u306e VTEP)\n\n```\n{master:0}\nkotetsu@spine21> show ethernet-switching table\n\nMAC flags (S - static MAC, D - dynamic MAC, L - locally learned, P - Persistent static\n           SE - statistics enabled, NM - non configured MAC, R - remote PE MAC, O - ovsdb MAC)\n\n\nEthernet switching table : 2 entries, 2 learned\nRouting instance : default-switch\n   Vlan                MAC                 MAC      Logical                Active\n   name                address             flags    interface              source\n   VLAN0100            00:86:2b:5c:0d:01   D        xe-0/0/1.0\n   VLAN0100            00:86:2b:8d:10:01   D        vtep.32769             172.16.1.1\n\n```\n\nEVPN \u306e Type2(`MAC/IP Advertisement route`) \u3068 Type3(`Inclusive Multicast Ethernet Tag route`) \u3092 `spine11` (RD `64512:11`)\u304b\u3089\u5b66\u7fd2\u3057\u3066 `bgp.evpn.0` \u304b\u3089 `default-switch.evpn.0` \u306b\u30ed\u30fc\u30c9\u3055\u308c\u3066\u3044\u308b\u69d8\u5b50\n\n```\n{master:0}\nkotetsu@spine21> show route\n\n...\n\n:vxlan.inet.0: 8 destinations, 8 routes (8 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n10.0.0.0/24        *[Direct/0] 00:18:41\n                    > via em0.0\n10.0.0.202/32      *[Local/0] 00:11:20\n                      Local via em0.0\n169.254.0.0/24     *[Direct/0] 00:18:41\n                    > via em1.0\n169.254.0.2/32     *[Local/0] 00:18:41\n                      Local via em1.0\n172.16.1.1/32      *[Static/1] 00:18:39, metric2 0\n                    > to 192.0.2.5 via xe-0/0/0.0\n172.16.2.1/32      *[Direct/0] 00:18:41\n                    > via lo0.0\n192.0.2.4/30       *[Direct/0] 00:18:41\n                    > via xe-0/0/0.0\n192.0.2.6/32       *[Local/0] 00:18:41\n                      Local via xe-0/0/0.0\n\nbgp.evpn.0: 2 destinations, 2 routes (2 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n2:64512:11::10100::00:86:2b:8d:10:01/304\n                   *[BGP/170] 00:12:17, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n3:64512:11::10100::172.16.1.1/304\n                   *[BGP/170] 00:18:40, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n\ndefault-switch.evpn.0: 5 destinations, 5 routes (5 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n2:64512:11::10100::00:86:2b:8d:10:01/304\n                   *[BGP/170] 00:12:17, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n2:64512:21::10100::00:86:2b:5c:0d:01/304\n                   *[EVPN/170] 00:12:16\n                      Indirect\n3:64512:11::10100::172.16.1.1/304\n                   *[BGP/170] 00:18:40, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n3:64512:21::10100::172.16.2.1/304\n                   *[EVPN/170] 00:14:43\n                      Indirect\n3:64512:21::10200::172.16.2.1/304\n                   *[EVPN/170] 00:14:43\n                      Indirect\n```\n\n```\n{master:0}\nkotetsu@spine21> show route forwarding-table\n\n...\n\nRouting table: :vxlan.inet\nInternet:\nDestination        Type RtRef Next hop           Type Index    NhRef Netif\ndefault            perm     0                    rjct     1716     1\n0.0.0.0/32         perm     0                    dscd     1714     1\n169.254.0.0/24     user     0                    rtbl        1     5\n169.254.0.2/32     user     0 169.254.0.2        locl      334     3\n172.16.1.1/32      user     0                    indr   131070     3\n                              192.0.2.5          ucst     1711     7 xe-0/0/0.0\n172.16.2.1/32      user     0                    rtbl        1     5\n192.0.2.4/30       user     0                    rtbl        1     5\n192.0.2.6/32       user     0 192.0.2.6          locl     1709     3\n224.0.0.0/4        perm     0                    mdsc     1715     1\n224.0.0.1/32       perm     0 224.0.0.1          mcst     1718     1\n255.255.255.255/32 perm     0                    bcst     1719     1\n\n...\n\nRouting table: default-switch.bridge\nBridging domain: VLAN0100.bridge\nVPLS:\nDestination        Type RtRef Next hop           Type Index    NhRef Netif\n00:86:2b:5c:0d:01/48 user     0                  ucst     1730     6 xe-0/0/1.0\n00:86:2b:8d:10:01/48 user     0                  comp     1723     6\n0x30006/51         user     0                    comp     1731     2\n0x30004/51         user     0                    comp     1725     2\n0x30001/51         user     0                    comp     1726     2\n\nRouting table: default-switch.bridge\nBridging domain: VLAN0200.bridge\nVPLS:\nDestination        Type RtRef Next hop           Type Index    NhRef Netif\n0x30007/51         user     0                    comp     1734     2\n0x30005/51         user     0                    comp     1729     2\n0x30002/51         user     0                    comp     1728     2\n\n\n\n```\n\n\n#### bb01\n\n```\n{master:0}\nkotetsu@bb01> show ethernet-switching table\n\n```\n\n\u5358\u7d14\u306b EVPN \u7d4c\u8def\u3092 reflect \u3059\u308b\u571f\u7ba1\u306a\u306e\u3067\u3000`bgp.evpn.0` \u306b\u3057\u304b\u8f09\u3063\u3066\u3044\u306a\u3044\u69d8\u5b50\n\n```\n{master:0}\nkotetsu@bb01> show route\n\n...\n\nbgp.evpn.0: 6 destinations, 6 routes (6 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n2:64512:11::10100::00:86:2b:8d:10:01/304\n                   *[BGP/170] 00:31:03, localpref 100, from 172.16.1.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.2 via xe-0/0/0.0\n2:64512:21::10100::00:86:2b:5c:0d:01/304\n                   *[BGP/170] 00:31:01, localpref 100, from 172.16.2.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.6 via xe-0/0/1.0\n3:64512:11::10100::172.16.1.1/304\n                   *[BGP/170] 00:46:21, localpref 100, from 172.16.1.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.2 via xe-0/0/0.0\n3:64512:11::10300::172.16.1.1/304\n                   *[BGP/170] 00:37:52, localpref 100, from 172.16.1.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.2 via xe-0/0/0.0\n3:64512:21::10100::172.16.2.1/304\n                   *[BGP/170] 00:36:05, localpref 100, from 172.16.2.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.6 via xe-0/0/1.0\n3:64512:21::10200::172.16.2.1/304\n                   *[BGP/170] 00:35:45, localpref 100, from 172.16.2.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.6 via xe-0/0/1.0\n\n\n{master:0}\nkotetsu@bb01> show route forwarding-table\n\n...\n```\n\n### \u30d1\u30b1\u30c3\u30c8\u30ad\u30e3\u30d7\u30c1\u30e3\n\n\u3044\u304f\u3064\u304b\u7279\u5fb4\u7684\u306a\u30d1\u30b1\u30c3\u30c8\u3092\u62fe\u3063\u3066\u773a\u3081\u3066\u3044\u304d\u307e\u3059\u3002\n\n\u524d\u8ff0\u306e\u901a\u308a\u3001\u4eca\u56de\u306f RE \u540c\u58eb\u3092\u63a5\u7d9a\u3059\u308b\u3068\u3053\u308d\u3067\u76f4\u7d50\u69cb\u6210\u306b\u3057\u3066\u3057\u307e\u3044 `bb01` \u304c `xe-0/0/2` \u304b\u3089 `captureSW` \u65b9\u9762\u306b\u30dd\u30fc\u30c8\u30df\u30e9\u30fc\u30ea\u30f3\u30b0\u3057\u3066\u3001GNS3 \u306e `bb01(RE)` \u3068 `captureSW` \u9593\u306e\u30ea\u30f3\u30af\u3092\u53f3\u30af\u30ea\u30c3\u30af\u3057\u3066 `start capture` \u3068\u304b\u3084\u3063\u3066\u3044\u304d\u307e\u3059\u3002\n\u306a\u306e\u3067 `bb01` \u306b\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u8a2d\u5b9a\u3092\u3057\u3066\u3001`xe-0/0/0` (`spine11` \u5074)\u306e\u51fa\u5165\u308a\u3092 `xe-0/0/2` \u306b\u30df\u30e9\u30fc\u30ea\u30f3\u30b0\u3057\u3068\u304d\u307e\u3059\u3002\n\n```\nset interfaces xe-0/0/2 description \"DEV=captureSW IF=1\"\nset interfaces xe-0/0/2 unit 0 family ethernet-switching\n\nset forwarding-options analyzer ANAL_PORT input ingress interface xe-0/0/0.0\nset forwarding-options analyzer ANAL_PORT input egress interface xe-0/0/0.0\nset forwarding-options analyzer ANAL_PORT output interface xe-0/0/2.0\n```\n\n\u898b\u8fd4\u3057\u3066\u3044\u3066\u601d\u3063\u305f\u3093\u3059\u304c\u3001\u30a2\u30ca\u30eb\u30dd\u30fc\u30c8\u3063\u3066...\u3061\u3087\u3063\u3068...\n\n\u3042\u3068\u3001vQFX \u3067\u3082 `start shell` \u3057\u3066 `tcpdump` \u3068\u304b\u4f7f\u3048\u307e\u3059\u3088\u3002Control Plane \u5b9b\u306e\u30c8\u30e9\u30d5\u30a3\u30c3\u30af\u3060\u3051\u3068\u308a\u305f\u3044\u6642\u3068\u304b\u306b\u306f\u3002\n\n#### DataPlane\n\n`bb01` \u3067\u62fe\u3063\u305f VXLAN \u306e\u30d1\u30b1\u30c3\u30c8\u3092\u898b\u3066\u3044\u304d\u307e\u3059\u3002\n\n`node11` \u304b\u3089 `node21` \u306b ping \u3046\u3063\u305f\u6642\u3001\u6700\u521d\u306b\u51fa\u308b ARP Request \u3068 ARP reply\nVXLAN \u30ab\u30d7\u30bb\u30eb\u306e IP \u30d8\u30c3\u30c0\u7684\u306b\u306f\u30de\u30eb\u30c1\u30ad\u30e3\u30b9\u30c8\u3067\u306f\u306a\u304f\u3001`spine11 VTEP` \u3068 `spine21 VTEP` \u9593\u306e\u30e6\u30cb\u30ad\u30e3\u30b9\u30c8\u306b\u306a\u3063\u3066\u307e\u3059\u3002\n![02_10_ARP_req.png](https://qiita-image-store.s3.amazonaws.com/0/60456/e97de013-9795-7d15-13b6-dcbf7fdbadd6.png)\n\n![02_11_ARP_reply.png](https://qiita-image-store.s3.amazonaws.com/0/60456/04f90904-866c-4ed4-f3ba-3808ea1b7f55.png)\n\n\n`node11` \u3068 `node21` \u9593\u306e ICMP echo Request \u3068 ICMP echo Reply\n\u3053\u308c\u306f EVPN \u4f7f\u304a\u3046\u304c\u95a2\u4fc2\u306a\u304f\u3001\u305f\u3060\u306e VXLAN \u30d8\u30c3\u30c0\u3064\u3044\u305f\u30d1\u30b1\u30c3\u30c8\u3067\u3059\u3002\n![02_12_ICMP_req.png](https://qiita-image-store.s3.amazonaws.com/0/60456/7e65d9cd-7dd7-8886-8687-1dd351723c6c.png)\n\n![02_13_ICMP_reply.png](https://qiita-image-store.s3.amazonaws.com/0/60456/fa5f5ae0-ba69-09b0-3e59-a7573ac471dc.png)\n\n\n#### ControlPlane\n\n`bb01` \u3067\u62fe\u3063\u305f EVPN \u306e\u30d1\u30b1\u30c3\u30c8\u3092\u898b\u3066\u3044\u304d\u307e\u3059\u3002\n\n##### EVPN NLRI Type2(MAC/IP Advertisement route) Update\n\n\u307e\u305a\u306f `node11` \u304b\u3089\u306e ARP Request \u3092\u53d7\u4fe1\u3057\u305f `spine11` \u304c advertise \u3059\u308b\u69d8\u5b50\n![02_14_update_Type2_from_spine11.png](https://qiita-image-store.s3.amazonaws.com/0/60456/90f488e4-844b-faa5-479b-bc3d42ccb68e.png)\n\n\u6b21\u306b `node21` \u304b\u3089\u306e ARP Reply \u3092\u53d7\u4fe1\u3057\u305f `spine21` \u304c advertise \u3057\u305f\u306e\u3092 `bb01` \u304c `spine11` \u65b9\u9762\u306b reflect \u3059\u308b\u69d8\u5b50\n![02_15_update_Type2_from_spine21_RR.png](https://qiita-image-store.s3.amazonaws.com/0/60456/4bee8e6c-ec07-bcea-ad3b-c27bf7c4ed33.png)\n\n\n##### EVPN NLRI Type2(MAC/IP Advertisement route) Withdrawn\n\n`spine11` \u3067 `clear ethernet-switching table` \u3057\u3066 `node11` \u306e MAC \u3092\u6d88\u3059\n![02_16_update_withdrawn_Type2_from_spine11.png](https://qiita-image-store.s3.amazonaws.com/0/60456/2b3b594a-0526-1f26-db7c-d475251a3aac.png)\n\n\n##### EVPN NLRI Type3(Inclusive Multicast Ethernet Tag route) Withdrawn\n\n`spine21` \u3067\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u611f\u3058\u3067\u3001\u96d1\u306b VLAN 100 = VNI10100 at RD 64512:21 \u304c\u6d88\u3048\u305f\u3053\u3068\u3092 advertise \u3055\u305b\u305f\u6642\u306e\u69d8\u5b50\n\n```\n{master:0}[edit]\nkotetsu@spine21# deactivate vlans VLAN0100\n\n{master:0}[edit]\nkotetsu@spine21# show | compare\n[edit vlans]\n!    inactive: VLAN0100 { ... }\n\n{master:0}[edit]\nkotetsu@spine21# commit\n\n```\n\n![02_17_update_withdrawn_Type3_from_spine21.png](https://qiita-image-store.s3.amazonaws.com/0/60456/ad9284f0-1556-968b-19eb-664a4e3140ed.png)\n\n\n\u6b21\u306b `spine21` \u3067 VLAN 100 = VNI10100 at RD 64512:21 \u304c\u3067\u304d\u305f\u3053\u3068\u3092 advertise \u3055\u305b\u305f\u6642\u306e\u69d8\u5b50\n\n```\n{master:0}[edit]\nkotetsu@spine21# activate vlans VLAN0100\n\n{master:0}[edit]\nkotetsu@spine21# show | compare\n[edit vlans]\n!    active: VLAN0100 { ... }\n\n{master:0}[edit]\nkotetsu@spine21# commit\n```\n\n![02_18_update_Type3_from_spine21.png](https://qiita-image-store.s3.amazonaws.com/0/60456/39614103-07f5-33ba-7d8c-423bb6d9ebea.png)\n\n\n# \u304a\u3057\u307e\u3044\n\n- \u4eee\u60f3\u7248\u3067\u3082 Juniper vQFX \u3067 L2VPN \u6a5f\u80fd\u304c\u52d5\u304f\u3053\u3068\u3092\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\n- linux kernel \u3067 EVPN \u3057\u3083\u3079\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u305b\u3093\u304b\u306d(MPLS \u306f\u5165\u3063\u305f\u306e\u3060\u3057)\n    - \u5192\u982d\u306e\u7d75\u3067\u3044\u3046\u3068\u3053\u308d\u306e \u30aa\u30ec\u30f3\u30b8\u9818\u57df(L3) \u306f\u51fa\u6765\u308b\u3060\u3051\u30a8\u30f3\u30c9\u307e\u3067\u964d\u308a\u3066\u304d\u3066\u6b32\u3057\u304f\u306a\u3044\u3067\u3059\u304b\n        - Juniper \u306e\u4f8b\u793a\u3067\u306f\u3001ToR \u30b9\u30a4\u30c3\u30c1(QFX5100)\u307e\u3067\u306f\u304d\u3066\u3044\u307e\u3059\u3088\u306d\n        - \u305d\u3057\u305f\u3089 linux kernel \u307e\u3067\u964d\u308a\u3066\u304d\u3066\u3001\u7269\u7406\u30b9\u30a4\u30c3\u30c1\u306f MP-BGP \u306e\u571f\u7ba1\u306b\u306a\u308c\u3070...\u3068\u304b\u601d\u3063\u305f\u308f\u3051\u3067\u3059\n", "tags": ["juniper", "junos15.1X53-D60", "vxlan", "E-VPN", "GNS31.5.2"]}