{"context": " More than 1 year has passed since last update.\n\u53e4\u3081\u306eJoyent SmartOS\u3067Test-Kitchen\u3092\u3057\u3088\u3046\u3068\u3057\u305f\u3089\u3001Ohai7.2\u4ee5\u4e0a,Chef11.8\u4ee5\u4e0a\u304c\u3055\u304f\u3063\u3068\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u51fa\u6765\u306a\u3044\u72b6\u614b\u3060\u3063\u305f\u3002\nOmnibus\u306b\u3082\u5bfe\u5fdc\u3057\u3066\u306a\u3044\u306e\u3067\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u4f5c\u3063\u3066RubyGems\u304b\u3089Chef\u3092\u5165\u308c\u3066\u3044\u305f\u3051\u3069\u3001\u30d0\u30fc\u30b8\u30e7\u30f3\u6307\u5b9a\u306e\u51e6\u7406\u3092\u5b9f\u88c5\u3057\u3066\u304a\u3089\u305a\u56f0\u3063\u305f\u306e\u3067\u3001\u3068\u308a\u3042\u3048\u305a\u30e2\u30f3\u30ad\u30fc\u30d1\u30c3\u30c1\u3059\u308b\u3053\u3068\u306b\u3057\u305f\u3002\n\nruby\u30b3\u30de\u30f3\u30c9\u3067require\u3059\u308b\u3002\n\u5b9f\u884c\u6642\u306b\u9069\u5f53\u306aRuby\u30d5\u30a1\u30a4\u30eb\u3092\u8aad\u307e\u305b\u308b\u306b\u306f-r(require)\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u4ed8\u3051\u3066Ruby\u3092\u5b9f\u884c\u3059\u308c\u3070\u3088\u3044\u3002\n\nmonkey_patch/hoge.rb\nputs 'hogehoge'\n\n\n\u30d5\u30a1\u30a4\u30eb\u3092\u7528\u610f\u3057\u3066-r\n$ ruby -r ./monkey_patch/hoge ./bin/kitchen -v\nhogehoge\nTest Kitchen version 1.2.1\n\n\u305f\u3060\u6bce\u56deruby\u30b3\u30de\u30f3\u30c9\u304b\u3089kitchen\u3059\u308b\u306e\u306f\u9762\u5012\u3002\n\n\u3058\u3083\u3042.kitchen.yml\u306b\u66f8\u3044\u3061\u3083\u3046\ndriver\u3067ohai_version\u3001chef_version\u3092\u6307\u5b9a\u3057\u305f\u3089\u3001gem install\u6642\u306b\u6307\u5b9a\u3059\u308b\u3088\u3046\u306b\u3057\u305f\u304b\u3063\u305f\u306e\u3067\u3001\u5fdc\u6025\u51e6\u7f6e\u3068\u3057\u3066.kitchen.yml\u3067\u30af\u30e9\u30b9\u3092\u30aa\u30fc\u30d7\u30f3\u3057\u3066\u3057\u307e\u3046\u3053\u3068\u306b\u3057\u305f\u3002def install_chef_for_smartos\u3092\u307e\u308b\u3063\u3068\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3002\n\u306a\u3093\u304b\u8272\u3005\u3068\u9177\u3044\u6c17\u304c\u3059\u308b\u306e\u3067\u5e38\u7528\u306f\u304a\u3059\u3059\u3081\u3057\u307e\u305b\u3093\u3002\n\n.kitchen.yml\n---\ndriver_plugin: zcloudjp\ndriver_config:\n  api_key: PLEASE_REPLACE_IT_BY.kitchen.local.yml\n  ohai_version: 7.0.4\n  chef_version: 11.6.2\n\nprovisioner:\n  name: chef_solo\n  require_chef_omnibus: false\n  data_path: <%= ENV['NO_DATA'] ? \"null\" : \"data\" %>\n\nplatforms:\n- name: sm-base64\n  driver_config:\n    username: root\n    metadata_file: tk/metadata.json\n    dataset: \"sdc:sdc:base64:1.9.1\"\n    package: xxx_xxx\n    with_gcc: true\n\nsuites:\n- name: default\n  use_sudo: false\n  run_list:\n  attributes: {}\n\n\n<%\n## Monkey Patch for SmartOS 1.9.1\nrequire 'kitchen/driver/zcloudjp'\n\nmodule Kitchen\n  module Driver\n    class Zcloudjp\n      class_eval do\n        def install_chef_for_smartos(ssh_args)\n          if config[:with_gcc]\n            install_pkgs = \"gcc47 gcc47-runtime scmgit-base scmgit-docs gmake ruby193-base ruby193-yajl ruby193-nokogiri ruby193-readline pkg-config\"\n          else\n            install_pkgs = \"scmgit-base scmgit-docs ruby193-base ruby193-yajl ruby193-nokogiri ruby193-readline\"\n          end\n\n          ssh(ssh_args, <<-INSTALL.gsub(/^ {10}/, ''))\n            if [ ! -f /opt/local/bin/chef-client ]; then\n              pkgin -y install #{install_pkgs}\n\n            ## for smf cookbook\n              pkgin -y install libxslt\n\n            ## install chef\n              gem update --system --no-ri --no-rdoc\n              gem install --no-ri --no-rdoc ohai #{config[:ohai_version] ? '--version ' + %Q{'=  #{config[:ohai_version]}'} : nil }\n              gem install --no-ri --no-rdoc chef #{config[:chef_version] ? '--version ' + %Q{'=  #{config[:chef_version]}'} : nil }\n              gem install --no-ri --no-rdoc rb-readline\n            fi\n          INSTALL\n        end\n      end\n    end\n  end\nend\n%>\n\n\n\n\u5916\u90e8\u30d5\u30a1\u30a4\u30eb\u306b\u3057\u3066.kitchen.yml\u3067\u30ed\u30fc\u30c9\n\u6d41\u77f3\u306b.kitchen.yml\u304c\u8aad\u307f\u306b\u304f\u3044\u306e\u3067load\u306b\u3057\u305f\u3002SafeYAML::OPTIONS[:default_mode]\u306f\u8b66\u544a\u306e\u6291\u5236\u3002\n\n.kitchen.yml\n...\n\n<%\n## Monkey Patch for SmartOS 1.9.1\nSafeYAML::OPTIONS[:default_mode] = :unsafe\nload File.expand_path('../monkey_patch/fix_install_for191.rb', __FILE__)\n%>\n\n\n\u306a\u304a\u3001\u5f8c\u65e5Gem\u306e\u307b\u3046\u306b\u53cd\u6620\u3057\u3066\u30e2\u30f3\u30ad\u30fc\u30d1\u30c3\u30c1\u306f\u6d88\u3057\u307e\u3057\u305f\u3002\n<!-- permanent -->\n\n\u53e4\u3081\u306eJoyent SmartOS\u3067Test-Kitchen\u3092\u3057\u3088\u3046\u3068\u3057\u305f\u3089\u3001Ohai7.2\u4ee5\u4e0a,Chef11.8\u4ee5\u4e0a\u304c\u3055\u304f\u3063\u3068\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u51fa\u6765\u306a\u3044\u72b6\u614b\u3060\u3063\u305f\u3002\nOmnibus\u306b\u3082\u5bfe\u5fdc\u3057\u3066\u306a\u3044\u306e\u3067\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u4f5c\u3063\u3066RubyGems\u304b\u3089Chef\u3092\u5165\u308c\u3066\u3044\u305f\u3051\u3069\u3001\u30d0\u30fc\u30b8\u30e7\u30f3\u6307\u5b9a\u306e\u51e6\u7406\u3092\u5b9f\u88c5\u3057\u3066\u304a\u3089\u305a\u56f0\u3063\u305f\u306e\u3067\u3001\u3068\u308a\u3042\u3048\u305a\u30e2\u30f3\u30ad\u30fc\u30d1\u30c3\u30c1\u3059\u308b\u3053\u3068\u306b\u3057\u305f\u3002\n\n\n## ruby\u30b3\u30de\u30f3\u30c9\u3067require\u3059\u308b\u3002\n\n\u5b9f\u884c\u6642\u306b\u9069\u5f53\u306aRuby\u30d5\u30a1\u30a4\u30eb\u3092\u8aad\u307e\u305b\u308b\u306b\u306f-`r(require)`\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u4ed8\u3051\u3066Ruby\u3092\u5b9f\u884c\u3059\u308c\u3070\u3088\u3044\u3002\n\n```monkey_patch/hoge.rb\nputs 'hogehoge'\n```\n\n\u30d5\u30a1\u30a4\u30eb\u3092\u7528\u610f\u3057\u3066`-r`\n\n```shell:\n$ ruby -r ./monkey_patch/hoge ./bin/kitchen -v\nhogehoge\nTest Kitchen version 1.2.1\n```\n\n\n\u305f\u3060\u6bce\u56deruby\u30b3\u30de\u30f3\u30c9\u304b\u3089kitchen\u3059\u308b\u306e\u306f\u9762\u5012\u3002\n\n\n## \u3058\u3083\u3042.kitchen.yml\u306b\u66f8\u3044\u3061\u3083\u3046 \n\ndriver\u3067`ohai_version`\u3001`chef_version`\u3092\u6307\u5b9a\u3057\u305f\u3089\u3001`gem install`\u6642\u306b\u6307\u5b9a\u3059\u308b\u3088\u3046\u306b\u3057\u305f\u304b\u3063\u305f\u306e\u3067\u3001\u5fdc\u6025\u51e6\u7f6e\u3068\u3057\u3066`.kitchen.yml`\u3067\u30af\u30e9\u30b9\u3092\u30aa\u30fc\u30d7\u30f3\u3057\u3066\u3057\u307e\u3046\u3053\u3068\u306b\u3057\u305f\u3002`def install_chef_for_smartos`\u3092\u307e\u308b\u3063\u3068\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3002\n\n\u306a\u3093\u304b\u8272\u3005\u3068\u9177\u3044\u6c17\u304c\u3059\u308b\u306e\u3067\u5e38\u7528\u306f\u304a\u3059\u3059\u3081\u3057\u307e\u305b\u3093\u3002\n\n```yaml:.kitchen.yml\n---\ndriver_plugin: zcloudjp\ndriver_config:\n  api_key: PLEASE_REPLACE_IT_BY.kitchen.local.yml\n  ohai_version: 7.0.4\n  chef_version: 11.6.2\n\nprovisioner:\n  name: chef_solo\n  require_chef_omnibus: false\n  data_path: <%= ENV['NO_DATA'] ? \"null\" : \"data\" %>\n\nplatforms:\n- name: sm-base64\n  driver_config:\n    username: root\n    metadata_file: tk/metadata.json\n    dataset: \"sdc:sdc:base64:1.9.1\"\n    package: xxx_xxx\n    with_gcc: true\n\nsuites:\n- name: default\n  use_sudo: false\n  run_list:\n  attributes: {}\n\n\n<%\n## Monkey Patch for SmartOS 1.9.1\nrequire 'kitchen/driver/zcloudjp'\n\nmodule Kitchen\n  module Driver\n    class Zcloudjp\n      class_eval do\n        def install_chef_for_smartos(ssh_args)\n          if config[:with_gcc]\n            install_pkgs = \"gcc47 gcc47-runtime scmgit-base scmgit-docs gmake ruby193-base ruby193-yajl ruby193-nokogiri ruby193-readline pkg-config\"\n          else\n            install_pkgs = \"scmgit-base scmgit-docs ruby193-base ruby193-yajl ruby193-nokogiri ruby193-readline\"\n          end\n\n          ssh(ssh_args, <<-INSTALL.gsub(/^ {10}/, ''))\n            if [ ! -f /opt/local/bin/chef-client ]; then\n              pkgin -y install #{install_pkgs}\n\n            ## for smf cookbook\n              pkgin -y install libxslt\n\n            ## install chef\n              gem update --system --no-ri --no-rdoc\n              gem install --no-ri --no-rdoc ohai #{config[:ohai_version] ? '--version ' + %Q{'=  #{config[:ohai_version]}'} : nil }\n              gem install --no-ri --no-rdoc chef #{config[:chef_version] ? '--version ' + %Q{'=  #{config[:chef_version]}'} : nil }\n              gem install --no-ri --no-rdoc rb-readline\n            fi\n          INSTALL\n        end\n      end\n    end\n  end\nend\n%>\n```\n\n### \u5916\u90e8\u30d5\u30a1\u30a4\u30eb\u306b\u3057\u3066.kitchen.yml\u3067\u30ed\u30fc\u30c9\n\n\u6d41\u77f3\u306b`.kitchen.yml`\u304c\u8aad\u307f\u306b\u304f\u3044\u306e\u3067load\u306b\u3057\u305f\u3002`SafeYAML::OPTIONS[:default_mode]`\u306f\u8b66\u544a\u306e\u6291\u5236\u3002\n\n```yaml:.kitchen.yml\n...\n\n<%\n## Monkey Patch for SmartOS 1.9.1\nSafeYAML::OPTIONS[:default_mode] = :unsafe\nload File.expand_path('../monkey_patch/fix_install_for191.rb', __FILE__)\n%>\n```\n\n\u306a\u304a\u3001\u5f8c\u65e5Gem\u306e\u307b\u3046\u306b\u53cd\u6620\u3057\u3066\u30e2\u30f3\u30ad\u30fc\u30d1\u30c3\u30c1\u306f\u6d88\u3057\u307e\u3057\u305f\u3002\n", "tags": ["chef", "Ruby", "test-kitchen"]}