{"tags": ["drbd", "corosync", "pacemaker"], "context": "\n\n\u53c2\u8003\n\nClusters from Scratch\npacemaker/pcs-crmsh-quick-ref.md at master \u00b7 ClusterLabs/pacemaker\n\n\n1.\u69cb\u6210\n\nCentOS5.11 x86_64\nIP\n\n\ndrbd1.local: 192.168.100.199\ndrbd2.local: 192.168.100.200\ndrbd\u4eee\u60f3IP: 192.168.100.198\n\n\nDRBD\n\n\n/dev/vdb1\n\n\n\u30ea\u30bd\u30fc\u30b9\n\n\nmysqldata : /var/lib/mysql/\n\n\n\n\n2.\u30ea\u30dd\u30b8\u30c8\u30ea\u8ffd\u52a0\n\nepel-release\nyum install -y epel-release\n\n\n\nclusterlabs.repo\ncd /etc/yum.repos.d/\nwget http://clusterlabs.org/rpm/epel-5/clusterlabs.repo\n\n\n\n\u30d1\u30c3\u30b1\u30fc\u30b8\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nyum install {corosync,heartbeat,pacemaker}.x86_64\n\n\n\ni386\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u304c\u5165\u3089\u306a\u3044\u3088\u3046\u306b\u3001x86_64\u3092\u6307\u5b9a\u3002\n\n\n3.corosync\u8a2d\u5b9a\n\n/etc/corosync/corosync.conf\naisexec {\n  user: root\n  group: root\n}\n\nservice {\n  name: pacemaker\n  ver: 0\n  use_mgmtd: yes\n}\n\ntotem {\n  version: 2\n  secauth: off\n  threads: 0\n  rrp_mode: active\n  clear_node_high_bit: yes\n  token: 4000\n  consensus: 10000\n  rrp_problem_count_timeout: 3000\n  interface {\n      ringnumber: 0\n      bindnetaddr: 192.168.100.0\n      mcastaddr: 226.94.1.1\n      mcastport: 5405\n  }\n}\n\nlogging {\n  fileline: on\n  to_syslog: yes\n  syslog_facility: local1\n  syslog_priority: info\n  debug: off\n  timestamp: on\n}\n\n\n\n4.syslog\n\n/etc/syslog.conf\n- *.info;mail.none;authpriv.none;cron.none                /var/log/messages\n+ *.info;mail.none;authpriv.none;cron.none;local1.none    /var/log/messages\n+ local1.*                                                /var/log/pacemaker.log\n\n\n\n/var/log/pacemaker.log \u306b\u30ed\u30b0\u304c\u8a18\u9332\u3055\u308c\u307e\u3059\u3002\n\n\n5.corosync\n\n5.1. \u8d77\u52d5\n/sbin/service corosync start\n\n\n5.2. STONITH\u7121\u52b9\u5316\n\nPATH\u3092\u901a\u3059\nexport PATH=$PATH:/usr/sbin:/sbin\n\n\n\u4ee5\u4e0b\u306f\u4e00\u53f0\u3060\u3051\u3067\u5b9f\u65bd\n\n\u78ba\u8a8d\n# /usr/sbin/crm_verify -L\ncrm_verify[2097]: 2015/03/16_16:42:10 ERROR: unpack_resources: Resource start-up disabled since no STONITH resources have been defined\ncrm_verify[2097]: 2015/03/16_16:42:10 ERROR: unpack_resources: Either configure some or disable STONITH with the stonith-enabled option\ncrm_verify[2097]: 2015/03/16_16:42:10 ERROR: unpack_resources: NOTE: Clusters with shared data need STONITH to ensure data integrity\nErrors found during check: config not valid\n  -V may provide more details\n\n\n\nSTONITH\u7121\u52b9\u5316\n# crm configure property stonith-enabled=false\nINFO: building help index\n\n\n\n\u78ba\u8a8d\n# crm_verify -L\n\n\n\n5.3. \u4eee\u60f3IP\u306e\u8a2d\u5b9a\n\u3053\u308c\u306f\u4e00\u53f0\u3060\u3051\u3067\u5b9f\u65bd\n# crm configure \\\n  primitive \\\n  ClusterIP \\\n  ocf:heartbeat:IPaddr2 \\\n  params \\\n  ip=192.168.100.198 \\\n  cidr_netmask=24 \\\n  nic=eth0 \\\n  iflabel=0 \\\n  op \\\n  monitor \\\n  interval=30s \\\n  nic=eth0 \\\n  iflabel=:0\ncrm_verify[2171]: 2015/03/16_16:46:44 WARN: cluster_status: We do not have quorum - fencing and resource management disabled\n\n\n5.4. quorum\u7121\u52b9\u5316\n\u3053\u308c\u306f\u4e00\u53f0\u3060\u3051\u3067\u5b9f\u65bd\n# crm configure property no-quorum-policy=ignore\n\n\n\u30ce\u30fc\u30c9\u5fa9\u5e30\u6642\u306b\u81ea\u52d5\u3067\u30ea\u30bd\u30fc\u30b9\u3092\u5143\u306e\u30ce\u30fc\u30c9\u4e0a\u306b\u79fb\u305d\u3046\u3068\u3059\u308b\u306e\u3092\u6b62\u3081\u308b\n# crm configure rsc_defaults resource-stickiness=100\n\n\n\n6. DRBD\n\n6.1. \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nyum install drbd83 drbd83-kmod\nchkconfig drbd off\n\n\n6.2. \u8a2d\u5b9a\n\n/etc/drbd.conf\nglobal {\n    usage-count no;\n}\n\ncommon {\n    protocol C;\n}\n\nresource mysqldata{\n    meta-disk internal;\n    device    /dev/drbd0;\n    syncer {\n        verify-alg sha1;\n        rate 80M;\n    }\n    on drbd1.local {\n        disk /dev/vdb1;\n        address 192.168.100.199:7789;\n    }\n    on drbd2.local {\n        disk /dev/vdb1;\n        address 192.168.100.200:7789;\n    }\n}\n\n\n\n6.3 hosts\u306b\u3066\u540d\u524d\u89e3\u6c7a\n\n/etc/hosts\n+ 192.168.100.199   drbd1 drbd1.local\n+ 192.168.100.200   drbd2 drbd2.local\n\n\n\n6.4. create-md\n# drbdadm create-md mysqldata\nWriting meta data...\ninitializing activity log\nNOT initialized bitmap\nNew drbd meta data block successfully created.\n\nmodprobe drbd\ndrbdadm up mysqldata\n\n\n6.5. DRBD\u30c7\u30d0\u30a4\u30b9\u306e\u72b6\u614b\u78ba\u8a8d\n\n/proc/drbd\n# cat /proc/drbd\nversion: 8.3.15 (api:88/proto:86-97)\nGIT-hash: 0ce4d235fc02b5c53c1c52c53433d11a694eab8c build by mockbuild@builder10.centos.org, 2013-03-27 16:01:26\n\n 1: cs:WFConnection ro:Secondary/Unknown ds:Inconsistent/DUnknown C r----s\n    ns:0 nr:0 dw:0 dr:0 al:0 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:b oos:4194092\n\n\n\n6.6. DRBD\u30c7\u30d0\u30a4\u30b9\u306e\u521d\u671f\u5316\n\n\u521d\u671f\u5316\ndrbdadm -- --overwrite-data-of-peer primary mysqldata\nmkfs.ext3 /dev/drbd0\n\n\n\u540c\u671f\u304c\u7d42\u308f\u308b\u307e\u3067\u5f85\u3064\u3002\nmkdir /var/lib/mysql/\nmount /dev/drbd0 /var/lib/mysql/\n\n\n\u78ba\u8a8d\n# df -h /var/lib/mysql/\nFilesystem          \u30b5\u30a4\u30ba  \u4f7f\u7528  \u6b8b\u308a \u4f7f\u7528% \u30de\u30a6\u30f3\u30c8\u4f4d\u7f6e\n/dev/drbd0            4.0G   73M  3.7G   2% /var/lib/mysql\n\n\n\n7. crm (pacemaker)\n\ncorosync\u304c\u8d77\u52d5\u3057\u3066\u3044\u308b\u3053\u3068\n2\u53f0\u76ee\u3082\u52d5\u4f5c\u3057\u3066\u3044\u308b\u3053\u3068\n\n\n7.1. DRBD\u306e\u767b\u9332\n# crm\n\ncrm(live)# cib new drbd\nINFO: building help index\nINFO: drbd shadow CIB created\n\nrm(drbd)# configure primitive MySQLData ocf:heartbeat:drbd params drbd_resource=mysqldata op monitor interval=60s\nWARNING: MySQLData: default timeout 20s for start is smaller than the advised 240\nWARNING: MySQLData: default timeout 20s for stop is smaller than the advised 100\nWARNING: MySQLData: action monitor not advertised in meta-data, it may not be supported by the RA\nWARNING: MySQLData: default timeout 20s for start is smaller than the advised 240\nWARNING: MySQLData: default timeout 20s for stop is smaller than the advised 100\nWARNING: MySQLData: action monitor not advertised in meta-data, it may not be supported by the RA\n\ncrm(drbd)# configure ms MySQLDataClone MySQLData meta master-max=1 master-node-max=1 clone-max=2 clone-node-max=1 notify=true\n\ncrm(drbd)# cib commit drbd\nINFO: commited 'drbd' shadow CIB to the cluster\n\ncrm(drbd)# quit\n\n\n7.2. /var/lib/mysql/\u306e\u767b\u9332\n# crm\n\ncrm(live)# cib new fs\nINFO: fs shadow CIB created\n\ncrm(fs)# configure primitive MySQLFS ocf:heartbeat:Filesystem params device=\"/dev/drbd0\" directory=\"/var/lib/mysql\" fstype=\"ext3\"\nWARNING: MySQLFS: default timeout 20s for start is smaller than the advised 60\nWARNING: MySQLFS: default timeout 20s for stop is smaller than the advised 60\nWARNING: MySQLFS: default timeout 20s for start is smaller than the advised 60\nWARNING: MySQLFS: default timeout 20s for stop is smaller than the advised 60\n\n\nDRBD\u3068\u540c\u3058\u30ce\u30fc\u30c9\u4e0a\u3067\u52d5\u4f5c\u3055\u305b\u308b(colocation)\ncrm(fs)# configure colocation fs_on_drbd inf: MySQLFS MySQLDataClone:Master\n\n\n\nDRBD\u306e\u5f8c\u306bmount(order)\ncrm(fs)# configure order MySQLFS-after-MySQLData inf: MySQLDataClone:promote MySQLFS:start\n\n\ncrm(fs)# cib commit fs\n\ncrm(fs)# quit\n\n\n7.3. MySQL\nyum install mysql-server\n\n\n\u521d\u671f\u8a2d\u5b9a\u3059\u308b\u305f\u3081\u306bstart,stop\u3059\u308b\nservice mysqld start\nservice mysqld stop\n\n\n# ls /var/lib/mysql\nib_logfile0  ib_logfile1  ibdata1  lost+found  mysql  test\n\numount /var/lib/mysql\n\n\n7.4. pacemaker\u306bMySQL\u767b\u9332\n# crm\n\ncrm(live)# configure\n\ncrm(live)configure# primitive MySQL ocf:heartbeat:mysql params binary=/usr/bin/mysqld_safe pid=/var/run/mysqld/mysqld.pid op monitor interval=60s\nWARNING: MySQL: default timeout 20s for start is smaller than the advised 120\nWARNING: MySQL: default timeout 20s for stop is smaller than the advised 120\nWARNING: MySQL: default timeout 20s for monitor is smaller than the advised 30\n\n\nDRBD\u3068\u540c\u3058\u30ce\u30fc\u30c9\u4e0a\u3067\u52d5\u4f5c\u3055\u305b\u308b(colocation)\ncrm(live)configure# colocation MySQL-with-MySQLFS inf: MySQL MySQLFS\n\n\n\nDRBD\u306e\u5f8c\u306bmount(order)\ncrm(live)configure# order MySQL-after-MySQLFS inf: MySQLFS MySQL\n\n\n\nDRBD\u3068\u540c\u3058\u30ce\u30fc\u30c9\u4e0a\u3067\u52d5\u4f5c\u3055\u305b\u308b(colocation)\ncrm(live)configure# colocation MySQL-with-ClusterIP inf: MySQL ClusterIP\n\n\n\nDRBD\u306e\u5f8c\u306bmount(order)\ncrm(live)configure# order MySQL-after-ClusterIP inf: ClusterIP MySQL\n\n\ncrm(live)configure# commit\nWARNING: MySQL: default timeout 20s for start is smaller than the advised 120\nWARNING: MySQL: default timeout 20s for stop is smaller than the advised 120\nWARNING: MySQL: default timeout 20s for monitor is smaller than the advised 30\n\n\n7.5. \u30af\u30e9\u30b9\u30bf\u30b0\u30eb\u30fc\u30d7\u306e\u4f5c\u6210\n# crm configure group MySQLGroup MySQLFS ClusterIP MySQL\nINFO: resource references in colocation:fs_on_drbd updated\nINFO: resource references in colocation:MySQL-with-MySQLFS updated\nINFO: resource references in order:MySQLFS-after-MySQLData updated\nINFO: resource references in order:MySQL-after-MySQLFS updated\nINFO: resource references in colocation:MySQL-with-ClusterIP updated\nINFO: resource references in order:MySQL-after-ClusterIP updated\nINFO: resource references in colocation:MySQL-with-MySQLFS updated\nINFO: resource references in colocation:MySQL-with-ClusterIP updated\nINFO: resource references in order:MySQL-after-MySQLFS updated\nINFO: resource references in order:MySQL-after-ClusterIP updated\n\n\ncrm configure show\n\n\n\n8. \u52d5\u4f5c\u78ba\u8a8d\nOS\u8d77\u52d5\u5f8c\u3001\ndrbd1, drbd2 \u4e21\u65b9\u306b\u3066/sbin/service corosync start\n\n8.1. drbd1(Master), drbd2(Slave)\n\ncrm_mon\u00a0-A\nOnline: [ drbd1.local drbd2.local ]\n\n Master/Slave Set: MySQLDataClone\n     Masters: [ drbd1.local ]\n     Slaves: [ drbd2.local ]\n Resource Group: MySQLGroup\n     MySQLFS    (ocf::heartbeat:Filesystem):    Started drbd1.local\n     ClusterIP  (ocf::heartbeat:IPaddr2):   Started drbd1.local\n     MySQL  (ocf::heartbeat:mysql): Started drbd1.local\n\nNode Attributes:\n* Node drbd1.local:\n    + master-MySQLData:0                : 10\n* Node drbd2.local:\n    + master-MySQLData:1                : 10\n\n\n\n8.2. drbd1(Slave), drbd2(Master)\u306b\u5207\u66ff\n\ndrbd1\u3092\u30aa\u30d5\u30e9\u30a4\u30f3\u306b\u3059\u308b\ncrm node standby drbd1.local\n\n\n\ncrm_mon\u00a0-A\nNode drbd1.local: standby\nOnline: [ drbd2.local ]\n\n Master/Slave Set: MySQLDataClone\n     Masters: [ drbd2.local ]\n     Stopped: [ MySQLData:0 ]\n Resource Group: MySQLGroup\n     MySQLFS    (ocf::heartbeat:Filesystem):    Started drbd2.local\n     ClusterIP  (ocf::heartbeat:IPaddr2):   Started drbd2.local\n     MySQL  (ocf::heartbeat:mysql): Started drbd2.local\n\nNode Attributes:\n* Node drbd1.local:\n* Node drbd2.local:\n    + master-MySQLData:1                : 5\n\n\n\ndrbd1\u3092\u30aa\u30f3\u30e9\u30a4\u30f3\u306b\u3059\u308b\ncrm node online drbd1.local\n\n\nOnline: [ drbd1.local drbd2.local ]\n\n Master/Slave Set: MySQLDataClone\n     Masters: [ drbd2.local ]\n     Slaves: [ drbd1.local ]\n Resource Group: MySQLGroup\n     MySQLFS    (ocf::heartbeat:Filesystem):    Started drbd2.local\n     ClusterIP  (ocf::heartbeat:IPaddr2):   Started drbd2.local\n     MySQL  (ocf::heartbeat:mysql): Started drbd2.local\n\nNode Attributes:\n* Node drbd1.local:\n    + master-MySQLData:0                : 10\n* Node drbd2.local:\n    + master-MySQLData:1                : 5\n\n\n8.3. drbd1(Master), drbd2(Slave)\u306b\u623b\u3059\ncrm node standby drbd1.local\ncrm node online drbd1.local\n\n\n9. \u969c\u5bb3\u30c6\u30b9\u30c8\n\ndrbd2\u304cMaster\u306e\u6642\u3001drbd2\u3092\u518d\u8d77\u52d5\n\n\ndrbd1\u304cMaster\u306b\u5207\u308a\u66ff\u308f\u308b\n\n\n\n## \u53c2\u8003\n\n* [Clusters from Scratch](http://clusterlabs.org/doc/en-US/Pacemaker/1.1-plugin/html-single/Clusters_from_Scratch/index.html)\n* [pacemaker/pcs-crmsh-quick-ref.md at master \u00b7 ClusterLabs/pacemaker](https://github.com/ClusterLabs/pacemaker/blob/master/doc/pcs-crmsh-quick-ref.md)\n\n# 1.\u69cb\u6210\n\n* CentOS5.11 x86_64\n* IP\n  * drbd1.local: 192.168.100.199\n  * drbd2.local: 192.168.100.200\n  * drbd\u4eee\u60f3IP: 192.168.100.198\n* DRBD\n  * /dev/vdb1\n* \u30ea\u30bd\u30fc\u30b9\n  * mysqldata : /var/lib/mysql/\n\n# 2.\u30ea\u30dd\u30b8\u30c8\u30ea\u8ffd\u52a0\n\n```bash:epel-release\nyum install -y epel-release\n```\n\n```bash:clusterlabs.repo\ncd /etc/yum.repos.d/\nwget http://clusterlabs.org/rpm/epel-5/clusterlabs.repo\n```\n\n```bash:\u30d1\u30c3\u30b1\u30fc\u30b8\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nyum install {corosync,heartbeat,pacemaker}.x86_64\n```\n\n* i386\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u304c\u5165\u3089\u306a\u3044\u3088\u3046\u306b\u3001x86_64\u3092\u6307\u5b9a\u3002\n\n\n# 3.corosync\u8a2d\u5b9a\n\n\n```ruby:/etc/corosync/corosync.conf\naisexec {\n  user: root\n  group: root\n}\n\nservice {\n  name: pacemaker\n  ver: 0\n  use_mgmtd: yes\n}\n\ntotem {\n  version: 2\n  secauth: off\n  threads: 0\n  rrp_mode: active\n  clear_node_high_bit: yes\n  token: 4000\n  consensus: 10000\n  rrp_problem_count_timeout: 3000\n  interface {\n      ringnumber: 0\n      bindnetaddr: 192.168.100.0\n      mcastaddr: 226.94.1.1\n      mcastport: 5405\n  }\n}\n\nlogging {\n  fileline: on\n  to_syslog: yes\n  syslog_facility: local1\n  syslog_priority: info\n  debug: off\n  timestamp: on\n}\n```\n\n# 4.syslog\n\n\n```diff:/etc/syslog.conf\n- *.info;mail.none;authpriv.none;cron.none                /var/log/messages\n+ *.info;mail.none;authpriv.none;cron.none;local1.none    /var/log/messages\n+ local1.*                                                /var/log/pacemaker.log\n```\n\n* /var/log/pacemaker.log \u306b\u30ed\u30b0\u304c\u8a18\u9332\u3055\u308c\u307e\u3059\u3002\n\n# 5.corosync\n\n## 5.1. \u8d77\u52d5\n\n```bash:\n/sbin/service corosync start\n```\n\n\n## 5.2. STONITH\u7121\u52b9\u5316\n\n```bash:PATH\u3092\u901a\u3059\nexport PATH=$PATH:/usr/sbin:/sbin\n```\n\n\u4ee5\u4e0b\u306f\u4e00\u53f0\u3060\u3051\u3067\u5b9f\u65bd\n\n```bash:\u78ba\u8a8d\n# /usr/sbin/crm_verify -L\ncrm_verify[2097]: 2015/03/16_16:42:10 ERROR: unpack_resources: Resource start-up disabled since no STONITH resources have been defined\ncrm_verify[2097]: 2015/03/16_16:42:10 ERROR: unpack_resources: Either configure some or disable STONITH with the stonith-enabled option\ncrm_verify[2097]: 2015/03/16_16:42:10 ERROR: unpack_resources: NOTE: Clusters with shared data need STONITH to ensure data integrity\nErrors found during check: config not valid\n  -V may provide more details\n```\n\n\n```bash:STONITH\u7121\u52b9\u5316\n# crm configure property stonith-enabled=false\nINFO: building help index\n```\n\n```bash:\u78ba\u8a8d\n# crm_verify -L\n```\n\n## 5.3. \u4eee\u60f3IP\u306e\u8a2d\u5b9a\n\n\u3053\u308c\u306f\u4e00\u53f0\u3060\u3051\u3067\u5b9f\u65bd\n\n```bash:\n# crm configure \\\n  primitive \\\n  ClusterIP \\\n  ocf:heartbeat:IPaddr2 \\\n  params \\\n  ip=192.168.100.198 \\\n  cidr_netmask=24 \\\n  nic=eth0 \\\n  iflabel=0 \\\n  op \\\n  monitor \\\n  interval=30s \\\n  nic=eth0 \\\n  iflabel=:0\ncrm_verify[2171]: 2015/03/16_16:46:44 WARN: cluster_status: We do not have quorum - fencing and resource management disabled\n```\n\n## 5.4. quorum\u7121\u52b9\u5316\n\n\u3053\u308c\u306f\u4e00\u53f0\u3060\u3051\u3067\u5b9f\u65bd\n\n```bash:\n# crm configure property no-quorum-policy=ignore\n```\n\n```bash:\u30ce\u30fc\u30c9\u5fa9\u5e30\u6642\u306b\u81ea\u52d5\u3067\u30ea\u30bd\u30fc\u30b9\u3092\u5143\u306e\u30ce\u30fc\u30c9\u4e0a\u306b\u79fb\u305d\u3046\u3068\u3059\u308b\u306e\u3092\u6b62\u3081\u308b\n# crm configure rsc_defaults resource-stickiness=100\n```\n\n\n\n# 6. DRBD\n\n\n## 6.1. \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```bash:\nyum install drbd83 drbd83-kmod\nchkconfig drbd off\n```\n\n## 6.2. \u8a2d\u5b9a\n\n```ruby:/etc/drbd.conf\nglobal {\n    usage-count no;\n}\n\ncommon {\n    protocol C;\n}\n\nresource mysqldata{\n    meta-disk internal;\n    device    /dev/drbd0;\n    syncer {\n        verify-alg sha1;\n        rate 80M;\n    }\n    on drbd1.local {\n        disk /dev/vdb1;\n        address 192.168.100.199:7789;\n    }\n    on drbd2.local {\n        disk /dev/vdb1;\n        address 192.168.100.200:7789;\n    }\n}\n```\n\n## 6.3 hosts\u306b\u3066\u540d\u524d\u89e3\u6c7a\n\n```diff:/etc/hosts\n+ 192.168.100.199   drbd1 drbd1.local\n+ 192.168.100.200   drbd2 drbd2.local\n```\n\n\n## 6.4. create-md\n\n```bash:\n# drbdadm create-md mysqldata\nWriting meta data...\ninitializing activity log\nNOT initialized bitmap\nNew drbd meta data block successfully created.\n```\n\n```bash:\nmodprobe drbd\ndrbdadm up mysqldata\n```\n\n## 6.5. DRBD\u30c7\u30d0\u30a4\u30b9\u306e\u72b6\u614b\u78ba\u8a8d\n\n```bash:/proc/drbd\n# cat /proc/drbd\nversion: 8.3.15 (api:88/proto:86-97)\nGIT-hash: 0ce4d235fc02b5c53c1c52c53433d11a694eab8c build by mockbuild@builder10.centos.org, 2013-03-27 16:01:26\n\n 1: cs:WFConnection ro:Secondary/Unknown ds:Inconsistent/DUnknown C r----s\n    ns:0 nr:0 dw:0 dr:0 al:0 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:b oos:4194092\n```\n\n## 6.6. DRBD\u30c7\u30d0\u30a4\u30b9\u306e\u521d\u671f\u5316\n\n```bash:\u521d\u671f\u5316\ndrbdadm -- --overwrite-data-of-peer primary mysqldata\nmkfs.ext3 /dev/drbd0\n```\n\n\u540c\u671f\u304c\u7d42\u308f\u308b\u307e\u3067\u5f85\u3064\u3002\n\n```bash:\nmkdir /var/lib/mysql/\nmount /dev/drbd0 /var/lib/mysql/\n```\n\n\n```bash:\u78ba\u8a8d\n# df -h /var/lib/mysql/\nFilesystem          \u30b5\u30a4\u30ba  \u4f7f\u7528  \u6b8b\u308a \u4f7f\u7528% \u30de\u30a6\u30f3\u30c8\u4f4d\u7f6e\n/dev/drbd0            4.0G   73M  3.7G   2% /var/lib/mysql\n```\n\n# 7. crm (pacemaker)\n\n* corosync\u304c\u8d77\u52d5\u3057\u3066\u3044\u308b\u3053\u3068\n* 2\u53f0\u76ee\u3082\u52d5\u4f5c\u3057\u3066\u3044\u308b\u3053\u3068\n\n## 7.1. DRBD\u306e\u767b\u9332\n\n```bash:\n# crm\n```\n\n```bash:\ncrm(live)# cib new drbd\nINFO: building help index\nINFO: drbd shadow CIB created\n```\n\n```bash:\nrm(drbd)# configure primitive MySQLData ocf:heartbeat:drbd params drbd_resource=mysqldata op monitor interval=60s\nWARNING: MySQLData: default timeout 20s for start is smaller than the advised 240\nWARNING: MySQLData: default timeout 20s for stop is smaller than the advised 100\nWARNING: MySQLData: action monitor not advertised in meta-data, it may not be supported by the RA\nWARNING: MySQLData: default timeout 20s for start is smaller than the advised 240\nWARNING: MySQLData: default timeout 20s for stop is smaller than the advised 100\nWARNING: MySQLData: action monitor not advertised in meta-data, it may not be supported by the RA\n```\n\n```bash:\ncrm(drbd)# configure ms MySQLDataClone MySQLData meta master-max=1 master-node-max=1 clone-max=2 clone-node-max=1 notify=true\n```\n\n```bash:\ncrm(drbd)# cib commit drbd\nINFO: commited 'drbd' shadow CIB to the cluster\n```\n\n```bash:\ncrm(drbd)# quit\n```\n\n## 7.2. /var/lib/mysql/\u306e\u767b\u9332\n\n```bash:\n# crm\n```\n\n```bash:\ncrm(live)# cib new fs\nINFO: fs shadow CIB created\n```\n\n```bash:\ncrm(fs)# configure primitive MySQLFS ocf:heartbeat:Filesystem params device=\"/dev/drbd0\" directory=\"/var/lib/mysql\" fstype=\"ext3\"\nWARNING: MySQLFS: default timeout 20s for start is smaller than the advised 60\nWARNING: MySQLFS: default timeout 20s for stop is smaller than the advised 60\nWARNING: MySQLFS: default timeout 20s for start is smaller than the advised 60\nWARNING: MySQLFS: default timeout 20s for stop is smaller than the advised 60\n```\n\n```bash:DRBD\u3068\u540c\u3058\u30ce\u30fc\u30c9\u4e0a\u3067\u52d5\u4f5c\u3055\u305b\u308b(colocation)\ncrm(fs)# configure colocation fs_on_drbd inf: MySQLFS MySQLDataClone:Master\n```\n\n```bash:DRBD\u306e\u5f8c\u306bmount(order)\ncrm(fs)# configure order MySQLFS-after-MySQLData inf: MySQLDataClone:promote MySQLFS:start\n```\n\n```bash:\ncrm(fs)# cib commit fs\n```\n\n```bash:\ncrm(fs)# quit\n```\n\n# 7.3. MySQL\n\n```bash:\nyum install mysql-server\n```\n\n\n```bash:\u521d\u671f\u8a2d\u5b9a\u3059\u308b\u305f\u3081\u306bstart,stop\u3059\u308b\nservice mysqld start\nservice mysqld stop\n```\n\n\n```bash:\n# ls /var/lib/mysql\nib_logfile0  ib_logfile1  ibdata1  lost+found  mysql  test\n```\n\n```bash:\numount /var/lib/mysql\n```\n\n## 7.4. pacemaker\u306bMySQL\u767b\u9332\n\n```bash:\n# crm\n```\n\n```bash:\ncrm(live)# configure\n```\n\n```bash:\ncrm(live)configure# primitive MySQL ocf:heartbeat:mysql params binary=/usr/bin/mysqld_safe pid=/var/run/mysqld/mysqld.pid op monitor interval=60s\nWARNING: MySQL: default timeout 20s for start is smaller than the advised 120\nWARNING: MySQL: default timeout 20s for stop is smaller than the advised 120\nWARNING: MySQL: default timeout 20s for monitor is smaller than the advised 30\n```\n\n```bash:DRBD\u3068\u540c\u3058\u30ce\u30fc\u30c9\u4e0a\u3067\u52d5\u4f5c\u3055\u305b\u308b(colocation)\ncrm(live)configure# colocation MySQL-with-MySQLFS inf: MySQL MySQLFS\n```\n\n```bash:DRBD\u306e\u5f8c\u306bmount(order)\ncrm(live)configure# order MySQL-after-MySQLFS inf: MySQLFS MySQL\n```\n\n```bash:DRBD\u3068\u540c\u3058\u30ce\u30fc\u30c9\u4e0a\u3067\u52d5\u4f5c\u3055\u305b\u308b(colocation)\ncrm(live)configure# colocation MySQL-with-ClusterIP inf: MySQL ClusterIP\n```\n\n```bash:DRBD\u306e\u5f8c\u306bmount(order)\ncrm(live)configure# order MySQL-after-ClusterIP inf: ClusterIP MySQL\n```\n\n```bash:\ncrm(live)configure# commit\nWARNING: MySQL: default timeout 20s for start is smaller than the advised 120\nWARNING: MySQL: default timeout 20s for stop is smaller than the advised 120\nWARNING: MySQL: default timeout 20s for monitor is smaller than the advised 30\n```\n\n## 7.5. \u30af\u30e9\u30b9\u30bf\u30b0\u30eb\u30fc\u30d7\u306e\u4f5c\u6210\n\n```\n# crm configure group MySQLGroup MySQLFS ClusterIP MySQL\nINFO: resource references in colocation:fs_on_drbd updated\nINFO: resource references in colocation:MySQL-with-MySQLFS updated\nINFO: resource references in order:MySQLFS-after-MySQLData updated\nINFO: resource references in order:MySQL-after-MySQLFS updated\nINFO: resource references in colocation:MySQL-with-ClusterIP updated\nINFO: resource references in order:MySQL-after-ClusterIP updated\nINFO: resource references in colocation:MySQL-with-MySQLFS updated\nINFO: resource references in colocation:MySQL-with-ClusterIP updated\nINFO: resource references in order:MySQL-after-MySQLFS updated\nINFO: resource references in order:MySQL-after-ClusterIP updated\n```\n\n* crm configure show\n\n![crm.png](https://qiita-image-store.s3.amazonaws.com/0/25728/b67064d5-62f3-0f4d-a86e-848c9ab06880.png)\n\n\n# 8. \u52d5\u4f5c\u78ba\u8a8d\n\nOS\u8d77\u52d5\u5f8c\u3001\ndrbd1, drbd2 \u4e21\u65b9\u306b\u3066`/sbin/service corosync start`\n\n## 8.1. drbd1(Master), drbd2(Slave)\n\n```bash:crm_mon&nbsp;-A\nOnline: [ drbd1.local drbd2.local ]\n\n Master/Slave Set: MySQLDataClone\n     Masters: [ drbd1.local ]\n     Slaves: [ drbd2.local ]\n Resource Group: MySQLGroup\n     MySQLFS    (ocf::heartbeat:Filesystem):    Started drbd1.local\n     ClusterIP  (ocf::heartbeat:IPaddr2):\tStarted drbd1.local\n     MySQL\t(ocf::heartbeat:mysql): Started drbd1.local\n\nNode Attributes:\n* Node drbd1.local:\n    + master-MySQLData:0                : 10\n* Node drbd2.local:\n    + master-MySQLData:1                : 10\n```\n\n## 8.2. drbd1(Slave), drbd2(Master)\u306b\u5207\u66ff\n\n```bash:drbd1\u3092\u30aa\u30d5\u30e9\u30a4\u30f3\u306b\u3059\u308b\ncrm node standby drbd1.local\n```\n\n\n```bash:crm_mon&nbsp;-A\nNode drbd1.local: standby\nOnline: [ drbd2.local ]\n\n Master/Slave Set: MySQLDataClone\n     Masters: [ drbd2.local ]\n     Stopped: [ MySQLData:0 ]\n Resource Group: MySQLGroup\n     MySQLFS    (ocf::heartbeat:Filesystem):    Started drbd2.local\n     ClusterIP  (ocf::heartbeat:IPaddr2):\tStarted drbd2.local\n     MySQL\t(ocf::heartbeat:mysql): Started drbd2.local\n\nNode Attributes:\n* Node drbd1.local:\n* Node drbd2.local:\n    + master-MySQLData:1                : 5\n```\n\n\n\n```bash:drbd1\u3092\u30aa\u30f3\u30e9\u30a4\u30f3\u306b\u3059\u308b\ncrm node online drbd1.local\n```\n\n```bash:\nOnline: [ drbd1.local drbd2.local ]\n\n Master/Slave Set: MySQLDataClone\n     Masters: [ drbd2.local ]\n     Slaves: [ drbd1.local ]\n Resource Group: MySQLGroup\n     MySQLFS    (ocf::heartbeat:Filesystem):    Started drbd2.local\n     ClusterIP  (ocf::heartbeat:IPaddr2):\tStarted drbd2.local\n     MySQL\t(ocf::heartbeat:mysql): Started drbd2.local\n\nNode Attributes:\n* Node drbd1.local:\n    + master-MySQLData:0                : 10\n* Node drbd2.local:\n    + master-MySQLData:1                : 5\n```\n\n\n## 8.3. drbd1(Master), drbd2(Slave)\u306b\u623b\u3059\n\n```bash:\ncrm node standby drbd1.local\ncrm node online drbd1.local\n```\n\n\n# 9. \u969c\u5bb3\u30c6\u30b9\u30c8\n\n* drbd2\u304cMaster\u306e\u6642\u3001drbd2\u3092\u518d\u8d77\u52d5\n  * drbd1\u304cMaster\u306b\u5207\u308a\u66ff\u308f\u308b\n"}