{"context": "AWS Compute Blog\u3067\u7d39\u4ecb\u3055\u308c\u3066\u3044\u305fCloudWatch Events+Lambda+Route53\u3067DDNS\u3092\u69cb\u7bc9\u3059\u308b\u65b9\u6cd5\u3092\u8a66\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\u5143\u8a18\u4e8b:\nBuilding a Dynamic DNS for Route 53 using CloudWatch Events and Lambda | AWS Compute Blog\n\nAWS\u74b0\u5883\u69cb\u7bc9\n\u203barn\u306e\u30a2\u30ab\u30a6\u30f3\u30c8ID\u306b\u306f\u30c0\u30df\u30fc\u306e\u5024\u304c\u5165\u3063\u3066\u3044\u307e\u3059\u3002\n\nIAM\nLambda\u7528\u306ePolicy\u3092\u4f5c\u6210\u3002\n\n/tmp/ddns-policy.json\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [{\n    \"Effect\": \"Allow\",\n    \"Action\": \"ec2:Describe*\",\n    \"Resource\": \"*\"\n  }, {\n    \"Effect\": \"Allow\",\n    \"Action\": [\n      \"dynamodb:*\"\n    ],\n    \"Resource\": \"*\"\n  }, {\n    \"Effect\": \"Allow\",\n    \"Action\": [\n      \"logs:CreateLogGroup\",\n      \"logs:CreateLogStream\",\n      \"logs:PutLogEvents\"\n    ],\n    \"Resource\": \"*\"\n  }, {\n    \"Effect\": \"Allow\",\n    \"Action\": [\n      \"route53:*\"\n    ],\n    \"Resource\": [\n      \"*\"\n    ]\n  }]\n}\n\n\n$ aws iam create-policy --policy-name ddns-lambda-policy --policy-document file:///tmp/ddns-policy.json\n{\n    \"Policy\": {\n        \"PolicyName\": \"ddns-lambda-policy\",\n        \"CreateDate\": \"2016-05-08T05:29:31.474Z\",\n        \"AttachmentCount\": 0,\n        \"IsAttachable\": true,\n        \"PolicyId\": \"XXXXXXXXXXXXXXXXXXXXX\",\n        \"DefaultVersionId\": \"v1\",\n        \"Path\": \"/\",\n        \"Arn\": \"arn:aws:iam::000000000000:policy/ddns-lambda-policy\",\n        \"UpdateDate\": \"2016-05-08T05:29:31.474Z\"\n    }\n}\n\nLambda\u7528\u306eRole\u3092\u4f5c\u6210\u3002\n\n/tmp/ddns-trust.json\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": \"lambda.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRole\"\n    }\n  ]\n}\n\n\n$ aws iam create-role --role-name ddns-lambda-role --assume-role-policy-document file:///tmp/ddns-trust.json\n{\n    \"Role\": {\n        \"AssumeRolePolicyDocument\": {\n            \"Version\": \"2012-10-17\",\n            \"Statement\": [\n                {\n                    \"Action\": \"sts:AssumeRole\",\n                    \"Principal\": {\n                        \"Service\": \"lambda.amazonaws.com\"\n                    },\n                    \"Effect\": \"Allow\",\n                    \"Sid\": \"\"\n                }\n            ]\n        },\n        \"RoleId\": \"XXXXXXXXXXXXXXXXXXXXX\",\n        \"CreateDate\": \"2016-05-08T05:29:53.160Z\",\n        \"RoleName\": \"ddns-lambda-role\",\n        \"Path\": \"/\",\n        \"Arn\": \"arn:aws:iam::000000000000:role/ddns-lambda-role\"\n    }\n}\n\nRole\u3068Policy\u3092\u7d10\u4ed8\u3051\u3002\n$ aws iam attach-role-policy --role-name ddns-lambda-role --policy-arn arn:aws:iam::000000000000:policy/ddns-lambda-policy\n\n\nLambda\nAWS\u304c\u63d0\u4f9b\u3057\u3066\u3044\u308bLambda Function\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3002\n$ curl -L https://github.com/awslabs/aws-lambda-ddns-function/raw/master/union.py.zip -o /tmp/union.py.zip\n\nLambda\u3092\u4f5c\u6210\u3002\n$ aws lambda create-function --function-name ddns_lambda --runtime python2.7 --role arn:aws:iam::000000000000:role/ddns-lambda-role --handler union.lambda_handler --timeout 30 --zip-file \"fileb:///tmp/union.py.zip\"\n{\n    \"CodeSha256\": \"Ho7yoabYeILgQRU/hdB7n0EPC6CXtBTquiLu0GDeuhw=\",\n    \"FunctionName\": \"ddns_lambda\",\n    \"CodeSize\": 4753,\n    \"MemorySize\": 128,\n    \"FunctionArn\": \"arn:aws:lambda:ap-northeast-1:000000000000:function:ddns_lambda\",\n    \"Version\": \"$LATEST\",\n    \"Role\": \"arn:aws:iam::000000000000:role/ddns-lambda-role\",\n    \"Timeout\": 30,\n    \"LastModified\": \"2016-05-08T05:40:49.300+0000\",\n    \"Handler\": \"union.lambda_handler\",\n    \"Runtime\": \"python2.7\",\n    \"Description\": \"\"\n}\n\n\nCloudWatch Events\n\u30eb\u30fc\u30eb\u3092\u4f5c\u6210\u3002\n$ aws events put-rule --event-pattern \"{\\\"source\\\":[\\\"aws.ec2\\\"],\\\"detail-type\\\":[\\\"EC2 Instance State-change Notification\\\"],\\\"detail\\\":{\\\"state\\\":[\\\"running\\\",\\\"shutting-down\\\",\\\"stopped\\\"]}}\" --state ENABLED --name ec2_lambda_ddns_rule\n{\n    \"RuleArn\": \"arn:aws:events:ap-northeast-1:000000000000:rule/ec2_lambda_ddns_rule\"\n}\n\nTarget\u3092\u4f5c\u6210\u3002\n$ aws events put-targets --rule ec2_lambda_ddns_rule --targets Id=id123456789012,Arn=arn:aws:lambda:ap-northeast-1:000000000000:function:ddns_lambda\n{\n    \"FailedEntries\": [],\n    \"FailedEntryCount\": 0\n}\n\nEvent\u3092Lambda\u306b\u7d10\u4ed8\u3051\u3002\n$ aws lambda add-permission --function-name ddns_lambda --statement-id 45 --action lambda:InvokeFunction --principal events.amazonaws.com --source-arn arn:aws:events:ap-northeast-1:000000000000:rule/ec2_lambda_ddns_rule\n{\n    \"Statement\": \"{\\\"Condition\\\":{\\\"ArnLike\\\":{\\\"AWS:SourceArn\\\":\\\"arn:aws:events:ap-northeast-1:000000000000:rule/ec2_lambda_ddns_rule\\\"}},\\\"Action\\\":[\\\"lambda:InvokeFunction\\\"],\\\"Resource\\\":\\\"arn:aws:lambda:ap-northeast-1:000000000000:function:ddns_lambda\\\",\\\"Effect\\\":\\\"Allow\\\",\\\"Principal\\\":{\\\"Service\\\":\\\"events.amazonaws.com\\\"},\\\"Sid\\\":\\\"45\\\"}\"\n}\n\n\nRoute53\nPrivate Hosted Zone\u3092\u4f5c\u6210\u3002\n\n\nVPC\nVPC\u306eDNS Hostnames\u3092\u6709\u52b9\u306b\u5909\u66f4\u3002\n\nDHCP options set\u3092\u4f5c\u6210\u3002\n\n\n\u52d5\u4f5c\u78ba\u8a8d\n\nPrivate Hosted Zone\n\u5bfe\u8c61\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306bZONE/CNAME\u30bf\u30b0\u3092\u8a2d\u5b9a\u3057\u3066\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u8d77\u52d5\u3002\u672b\u5c3e\u306e'.'\u3092\u5fd8\u308c\u305a\u306b\u3002\n\n\u8d77\u52d5\u5f8c\u3001Route53\u306e\u8a72\u5f53\u306eHosted Zone\u306bPrivate IP\u306e\u30ec\u30b3\u30fc\u30c9\u304c\u4f5c\u6210\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3002\n\n\nPublic Hosted Zone\nPrivate Hosted Zone\u3068\u540c\u69d8\u306e\u624b\u9806\u3092\u5b9f\u65bd\u3059\u308b\u3053\u3068\u306b\u3088\u308a\u3001Public\u306eHosted Zone\u306bPublic IP\u306e\u30ec\u30b3\u30fc\u30c9\u304c\u4f5c\u6210\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u3082\u78ba\u8a8d\u6e08\u307f\u3002\n\n\u305d\u306e\u4ed6\n\u8d77\u52d5\u3059\u308b\u3068DynamoDB\u306bDDNS\u30c6\u30fc\u30d6\u30eb\u304c\u4f5c\u6210\u3055\u308c\u307e\u3059\u3002\u3053\u306e\u30c6\u30fc\u30d6\u30eb\u306eCapacity\u306fRead/Rwrite\u5171\u306b4\u306b\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u307e\u3059\u304c\u3001\u307b\u3068\u3093\u3069\u306e\u5834\u54081\u3067\u554f\u984c\u306a\u3044\u3068\u601d\u3044\u307e\u3059\u306e\u3067\u3001\u9069\u5b9c\u5909\u66f4\u3057\u307e\u3057\u3087\u3046\u3002\n\nAWS Compute Blog\u3067\u7d39\u4ecb\u3055\u308c\u3066\u3044\u305fCloudWatch Events+Lambda+Route53\u3067DDNS\u3092\u69cb\u7bc9\u3059\u308b\u65b9\u6cd5\u3092\u8a66\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n\u5143\u8a18\u4e8b:\n[Building a Dynamic DNS for Route 53 using CloudWatch Events and Lambda | AWS Compute Blog](https://aws.amazon.com/jp/blogs/compute/building-a-dynamic-dns-for-route-53-using-cloudwatch-events-and-lambda/)\n\t\n## AWS\u74b0\u5883\u69cb\u7bc9\n\n**\u203barn\u306e\u30a2\u30ab\u30a6\u30f3\u30c8ID\u306b\u306f\u30c0\u30df\u30fc\u306e\u5024\u304c\u5165\u3063\u3066\u3044\u307e\u3059\u3002**\n\n### IAM\n\nLambda\u7528\u306ePolicy\u3092\u4f5c\u6210\u3002\n\n```/tmp/ddns-policy.json\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [{\n    \"Effect\": \"Allow\",\n    \"Action\": \"ec2:Describe*\",\n    \"Resource\": \"*\"\n  }, {\n    \"Effect\": \"Allow\",\n    \"Action\": [\n      \"dynamodb:*\"\n    ],\n    \"Resource\": \"*\"\n  }, {\n    \"Effect\": \"Allow\",\n    \"Action\": [\n      \"logs:CreateLogGroup\",\n      \"logs:CreateLogStream\",\n      \"logs:PutLogEvents\"\n    ],\n    \"Resource\": \"*\"\n  }, {\n    \"Effect\": \"Allow\",\n    \"Action\": [\n      \"route53:*\"\n    ],\n    \"Resource\": [\n      \"*\"\n    ]\n  }]\n}\n```\n\n```\n$ aws iam create-policy --policy-name ddns-lambda-policy --policy-document file:///tmp/ddns-policy.json\n{\n    \"Policy\": {\n        \"PolicyName\": \"ddns-lambda-policy\",\n        \"CreateDate\": \"2016-05-08T05:29:31.474Z\",\n        \"AttachmentCount\": 0,\n        \"IsAttachable\": true,\n        \"PolicyId\": \"XXXXXXXXXXXXXXXXXXXXX\",\n        \"DefaultVersionId\": \"v1\",\n        \"Path\": \"/\",\n        \"Arn\": \"arn:aws:iam::000000000000:policy/ddns-lambda-policy\",\n        \"UpdateDate\": \"2016-05-08T05:29:31.474Z\"\n    }\n}\n```\n\nLambda\u7528\u306eRole\u3092\u4f5c\u6210\u3002\n\n```/tmp/ddns-trust.json\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": \"lambda.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRole\"\n    }\n  ]\n}\n```\n\n```\n$ aws iam create-role --role-name ddns-lambda-role --assume-role-policy-document file:///tmp/ddns-trust.json\n{\n    \"Role\": {\n        \"AssumeRolePolicyDocument\": {\n            \"Version\": \"2012-10-17\",\n            \"Statement\": [\n                {\n                    \"Action\": \"sts:AssumeRole\",\n                    \"Principal\": {\n                        \"Service\": \"lambda.amazonaws.com\"\n                    },\n                    \"Effect\": \"Allow\",\n                    \"Sid\": \"\"\n                }\n            ]\n        },\n        \"RoleId\": \"XXXXXXXXXXXXXXXXXXXXX\",\n        \"CreateDate\": \"2016-05-08T05:29:53.160Z\",\n        \"RoleName\": \"ddns-lambda-role\",\n        \"Path\": \"/\",\n        \"Arn\": \"arn:aws:iam::000000000000:role/ddns-lambda-role\"\n    }\n}\n```\n\nRole\u3068Policy\u3092\u7d10\u4ed8\u3051\u3002\n\n```\n$ aws iam attach-role-policy --role-name ddns-lambda-role --policy-arn arn:aws:iam::000000000000:policy/ddns-lambda-policy\n```\n\n### Lambda\n\nAWS\u304c\u63d0\u4f9b\u3057\u3066\u3044\u308bLambda Function\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3002\n\n```\n$ curl -L https://github.com/awslabs/aws-lambda-ddns-function/raw/master/union.py.zip -o /tmp/union.py.zip\n```\n\nLambda\u3092\u4f5c\u6210\u3002\n\n```\n$ aws lambda create-function --function-name ddns_lambda --runtime python2.7 --role arn:aws:iam::000000000000:role/ddns-lambda-role --handler union.lambda_handler --timeout 30 --zip-file \"fileb:///tmp/union.py.zip\"\n{\n    \"CodeSha256\": \"Ho7yoabYeILgQRU/hdB7n0EPC6CXtBTquiLu0GDeuhw=\",\n    \"FunctionName\": \"ddns_lambda\",\n    \"CodeSize\": 4753,\n    \"MemorySize\": 128,\n    \"FunctionArn\": \"arn:aws:lambda:ap-northeast-1:000000000000:function:ddns_lambda\",\n    \"Version\": \"$LATEST\",\n    \"Role\": \"arn:aws:iam::000000000000:role/ddns-lambda-role\",\n    \"Timeout\": 30,\n    \"LastModified\": \"2016-05-08T05:40:49.300+0000\",\n    \"Handler\": \"union.lambda_handler\",\n    \"Runtime\": \"python2.7\",\n    \"Description\": \"\"\n}\n```\n\n### CloudWatch Events\n\n\u30eb\u30fc\u30eb\u3092\u4f5c\u6210\u3002\n\n```\n$ aws events put-rule --event-pattern \"{\\\"source\\\":[\\\"aws.ec2\\\"],\\\"detail-type\\\":[\\\"EC2 Instance State-change Notification\\\"],\\\"detail\\\":{\\\"state\\\":[\\\"running\\\",\\\"shutting-down\\\",\\\"stopped\\\"]}}\" --state ENABLED --name ec2_lambda_ddns_rule\n{\n    \"RuleArn\": \"arn:aws:events:ap-northeast-1:000000000000:rule/ec2_lambda_ddns_rule\"\n}\n```\n\nTarget\u3092\u4f5c\u6210\u3002\n\n```\n$ aws events put-targets --rule ec2_lambda_ddns_rule --targets Id=id123456789012,Arn=arn:aws:lambda:ap-northeast-1:000000000000:function:ddns_lambda\n{\n    \"FailedEntries\": [],\n    \"FailedEntryCount\": 0\n}\n```\n\nEvent\u3092Lambda\u306b\u7d10\u4ed8\u3051\u3002\n\n```\n$ aws lambda add-permission --function-name ddns_lambda --statement-id 45 --action lambda:InvokeFunction --principal events.amazonaws.com --source-arn arn:aws:events:ap-northeast-1:000000000000:rule/ec2_lambda_ddns_rule\n{\n    \"Statement\": \"{\\\"Condition\\\":{\\\"ArnLike\\\":{\\\"AWS:SourceArn\\\":\\\"arn:aws:events:ap-northeast-1:000000000000:rule/ec2_lambda_ddns_rule\\\"}},\\\"Action\\\":[\\\"lambda:InvokeFunction\\\"],\\\"Resource\\\":\\\"arn:aws:lambda:ap-northeast-1:000000000000:function:ddns_lambda\\\",\\\"Effect\\\":\\\"Allow\\\",\\\"Principal\\\":{\\\"Service\\\":\\\"events.amazonaws.com\\\"},\\\"Sid\\\":\\\"45\\\"}\"\n}\n```\n\n### Route53\n\nPrivate Hosted Zone\u3092\u4f5c\u6210\u3002\n\n![Screen Shot 2016-05-08 at 2.45.13 PM.png](https://qiita-image-store.s3.amazonaws.com/0/5774/8f2a3f55-f32d-0cb8-3169-d3f843e1230d.png \"Screen Shot 2016-05-08 at 2.45.13 PM.png\")\n\n### VPC\n\nVPC\u306eDNS Hostnames\u3092\u6709\u52b9\u306b\u5909\u66f4\u3002\n\n![Screen Shot 2016-05-08 at 3.01.56 PM.png](https://qiita-image-store.s3.amazonaws.com/0/5774/8b9a22d9-27a2-1d55-7663-a9df4511c999.png \"Screen Shot 2016-05-08 at 3.01.56 PM.png\")\n\nDHCP options set\u3092\u4f5c\u6210\u3002\n\n![Screen Shot 2016-05-08 at 2.47.05 PM.png](https://qiita-image-store.s3.amazonaws.com/0/5774/3749d515-f068-e9fc-462f-52e35a0a87e6.png \"Screen Shot 2016-05-08 at 2.47.05 PM.png\")\n\n\n## \u52d5\u4f5c\u78ba\u8a8d\n\n### Private Hosted Zone\n\n\u5bfe\u8c61\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306bZONE/CNAME\u30bf\u30b0\u3092\u8a2d\u5b9a\u3057\u3066\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u8d77\u52d5\u3002\u672b\u5c3e\u306e'.'\u3092\u5fd8\u308c\u305a\u306b\u3002\n\n![Screen Shot 2016-05-08 at 3.35.17 PM.png](https://qiita-image-store.s3.amazonaws.com/0/5774/91ee4b2e-abae-4d12-3954-a3210dc665c2.png \"Screen Shot 2016-05-08 at 3.35.17 PM.png\")\n\n\u8d77\u52d5\u5f8c\u3001Route53\u306e\u8a72\u5f53\u306eHosted Zone\u306bPrivate IP\u306e\u30ec\u30b3\u30fc\u30c9\u304c\u4f5c\u6210\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3002\n\n![Screen Shot 2016-05-08 at 3.22.24 PM.png](https://qiita-image-store.s3.amazonaws.com/0/5774/c9e89acb-8a85-138d-f390-93dae1a0b8df.png \"Screen Shot 2016-05-08 at 3.22.24 PM.png\")\n\n\n### Public Hosted Zone\n\nPrivate Hosted Zone\u3068\u540c\u69d8\u306e\u624b\u9806\u3092\u5b9f\u65bd\u3059\u308b\u3053\u3068\u306b\u3088\u308a\u3001Public\u306eHosted Zone\u306bPublic IP\u306e\u30ec\u30b3\u30fc\u30c9\u304c\u4f5c\u6210\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u3082\u78ba\u8a8d\u6e08\u307f\u3002\n\n## \u305d\u306e\u4ed6\n\n\u8d77\u52d5\u3059\u308b\u3068DynamoDB\u306bDDNS\u30c6\u30fc\u30d6\u30eb\u304c\u4f5c\u6210\u3055\u308c\u307e\u3059\u3002\u3053\u306e\u30c6\u30fc\u30d6\u30eb\u306eCapacity\u306fRead/Rwrite\u5171\u306b4\u306b\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u307e\u3059\u304c\u3001\u307b\u3068\u3093\u3069\u306e\u5834\u54081\u3067\u554f\u984c\u306a\u3044\u3068\u601d\u3044\u307e\u3059\u306e\u3067\u3001\u9069\u5b9c\u5909\u66f4\u3057\u307e\u3057\u3087\u3046\u3002\n\n", "tags": ["lambda", "route53", "AWS", "CloudWatchEvents"]}