{"context": " More than 1 year has passed since last update.\u521d\u3081\u3066Sinatra\u3067\u30a2\u30d7\u30ea\u3092\u4f5c\u3063\u305f\u306e\u3067\u899a\u3048\u305f\u3053\u3068\u307e\u3068\u3081\u3002\n\u4e8b\u60c5\u306b\u3088\u308a\u30ed\u30fc\u30ab\u30eb\u306fApach + Passenger\u3001\u30ea\u30e2\u30fc\u30c8\u306fNginx + Unicorn\u306a\u306e\u3067\u3001\u4e00\u5fdc\u4e21\u65b9\u3067\u52d5\u304f\u3088\u3046\u307e\u3068\u3081\u30fb\u30fb\u30fb\u305f\u3064\u3082\u308a\u306a\u306e\u3067\u3059\u304c\u3002\n\n\u5143\u8a18\u4e8b\n\u4e0b\u8a18\u30a8\u30f3\u30c8\u30ea\u306e\u8ee2\u8f09\u306b\u306a\u308a\u307e\u3059\u3002\n\u3010Ruby\u3011Sinatra\u3067\u3001\u901f\u653b\u3067Web\u30b5\u30a4\u30c8\u3092\u516c\u958b\u3059\u308b\u305f\u3081\u306e\u74b0\u5883\u69cb\u7bc9 - rokuroFire\n\n\u4e8b\u524d\u6e96\u5099\n\nRuby\u3001bundler\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nApache\u306e\u5834\u5408\u3001Passenger\u306e\u8a2d\u5b9a\u3092\u3057\u3066\u304a\u304f\nNginx\u306e\u5834\u5408\u3001Unicorn\u306egem\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u304a\u304f\n\n\n\u30a2\u30d7\u30ea\u306e\u30d5\u30a1\u30a4\u30eb\u69cb\u6210\n\u6700\u5c0f\u69cb\u6210\u306f\u4e0b\u8a18\u3002\nprojectname/\n-main.rb    // Controller\n-config.ru  // Rack\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3002\u6700\u521d\u306b\u5b9f\u884c\u3055\u308c\u308b\u30d5\u30a1\u30a4\u30eb\n-views/\n    -index.haml // \u30d3\u30e5\u30fc\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\uff08haml\uff09\u30d5\u30a1\u30a4\u30eb\n-public/    // web\u30b5\u30fc\u30d0\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u30eb\u30fc\u30c8\u306f\u3053\u3053\u3092\u6307\u5b9a\u3002\u753b\u50cf\u3082\u3053\u3053\n\n\u500b\u4eba\u7684\u306b\u3001\u4f5c\u696d\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306b\u3057\u3066\u307f\u307e\u3057\u305f\nprojectname/\n-Gemfile    \n-config.ru  // Rack\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3002\u6700\u521d\u306b\u5b9f\u884c\u3055\u308c\u308b\u30d5\u30a1\u30a4\u30eb\n-main.rb    // Controller\n-app/       // \u4f55\u3089\u304b\u306e\u51e6\u7406\n  -module/  // \u30e2\u30b8\u30e5\u30fc\u30eb\u985e\u306e\u30d5\u30a1\u30a4\u30eb\n-views/     // \u30d3\u30e5\u30fc\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\uff08haml\uff09\u30d5\u30a1\u30a4\u30eb\n  -index.haml\n  -layout.haml\n  -style/   // sass\uff08scss\uff09\u30d5\u30a1\u30a4\u30eb\n    -baes.scss\n-db/        // \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\uff08yml\uff09\u3092\u7f6e\u304f\n-log/       // \u30ed\u30b0\u7f6e\u304d\u5834\n-public/    // web\u30b5\u30fc\u30d0\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u30eb\u30fc\u30c8\u306f\u3053\u3053\u3092\u6307\u5b9a\u3002\u753b\u50cf\u3082\u3053\u3053\n-tmp/\n-vendor/\n    -bundle/    // gem\u306e\u7ba1\u7406\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\n-unicorn.rb // unicorn\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\n\n\nSinatra\u306e\u8a2d\u5b9a\n\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u76f4\u4e0b\u306bconfig.ru\u3092\u7f6e\u304d\u307e\u3059\u3002\n\u307e\u305f\u4eca\u56de\u306fController\u3092\u5225\u30d5\u30a1\u30a4\u30eb\uff08main.rb\uff09\u306b\u3057\u307e\u3057\u305f\u3002\n\nconfig.ru\nrequire './main.rb'\nrun MainApp\n\n\n\nmain.rb\nrequire 'rubygems'\nrequire 'sinatra/base'\nrequire 'logger'\nrequire 'unicorn'\nrequire 'haml'\nrequire 'sass'\n\n# config.ru \u3067\u306f\u3053\u306e\u30af\u30e9\u30b9\u3092run\u3057\u3066\u3044\u307e\u3059\nclass MainApp < Sinatra::Base\n\n     # css\u306b\u30a2\u30af\u30bb\u30b9\u3057\u305f\u6642\u306e\u51e6\u7406\n    get %r{^/(.*)\\.css$} do\n        scss :\"style/#{params[:captures].first}\" #scss\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\n    end\n\n    # '/'\u306b\u30a2\u30af\u30bb\u30b9\u3057\u305f\u6642\u306e\u51e6\u7406\n    # views/index.haml\n    get '/' do\n        haml :index #views/index.haml\uff08haml\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\uff09\n    end\nend\n\n\n%r{^/(.*).css$} \u306e\uff08\uff09\u306e\u90e8\u5206\u306f params[:captures] \u3068\u3044\u3046\u914d\u5217\u306b\u683c\u7d0d\u3055\u308c\u308b\u3088\u3046\u3067\u3001first\u30670\u756a\u76ee\u306e\u8981\u7d20\u3092\u53d6\u5f97\u3057\u307e\u3059\u3002\n\u3064\u307e\u308a\u3053\u306e\u5834\u5408\u3001/base.css \u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001views\u4ee5\u4e0b\u306b\u3042\u308b style/base.scss \u304c\u547c\u3073\u51fa\u3055\u308c\u307e\u3059\u3002\n\nbundler\u3067gem\u306e\u7ba1\u7406\nRails\u3067\u306f\u304a\u306a\u3058\u307f\u3067\u3059\u304c\u3001Sinatra\u3067\u3082gem\u306e\u7ba1\u7406\u306bbundler\u3092\u4f7f\u3063\u3066\u307f\u307e\u3059\u3002\n# \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ gem install bundler\n\n$ cd projectname\n$ bundle init\n# Gemfile\u304c\u4f5c\u6210\u3055\u308c\u308b\n\nsource \"https://rubygems.org\"\ngem 'sinatra'\ngem 'haml'\ngem 'mysql2'\ngem 'activerecord'\ngem 'unicorn'       # Nginx + Unicorn\u306e\u5834\u5408\n\u30fb\u30fb\u30fb# \u306a\u3069\u306a\u3069\n\n#\u3010\u6ce8\u610f\u3011\n# gem\u306f \"activerecord\"\n# .rb\u5185\u3067\u306erequire\u306f \"active_record\"\n\n# gem\u3092\u5165\u308c\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\nmkdir vendor\nmkdir vendor/bundle\n\n# \u30d1\u30b9\u3092\u6307\u5b9a\u3057\u3066 bundle install\n# bundle exec \u3092\u3064\u3051\u308b\u3053\u3068\u3067\u3001Gemfile\u3067\u6307\u5b9a\u3055\u308c\u305fgem\u74b0\u5883\u3067\u30b3\u30de\u30f3\u30c9\u304c\u5b9f\u884c\u3055\u308c\u308b\n$ bundle install --path vendor/bundle\n\n# \u30ea\u30e2\u30fc\u30c8\u306eUnicorn\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u8abf\u3079\u308b\u306a\u3069\n$ bundle exec unicorn -v\nunicorn v4.7.0\n\n\nWeb\u30b5\u30fc\u30d0\uff08\u30d0\u30fc\u30c1\u30e3\u30eb\u30db\u30b9\u30c8\uff09\u306e\u8a2d\u5b9a\n\nApache x passenger\u306e\u5834\u5408\n\u9759\u7684\u306a\u30b5\u30a4\u30c8\u3068\u540c\u69d8\u3001\u30b5\u30a4\u30c8\u6570\u5206\u3001VirtualHost\u30d6\u30ed\u30c3\u30af\u3092\u8ffd\u52a0\u3059\u308b\u3060\u3051\u3067\u3059\u3002\n\u79c1\u306eUbuntu\u306eApache\u306f\u30d0\u30fc\u30c1\u30e3\u30eb\u30db\u30b9\u30c8\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u304cconfig\u3068\u306f\u5225\u30d5\u30a1\u30a4\u30eb\u306b\u306a\u3063\u3066\u3044\u307e\u3057\u305f\u3002\u74b0\u5883\u306b\u3088\u3063\u3066\u306f\u5c11\u3057\u9055\u3046\u3068\u601d\u308f\u308c\u307e\u3059\u3002\n$ cd /etc/apache2/sites-available/\n$ sudo vim projectname-test         # \u65e2\u5b58\u306e\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u3092\u30b3\u30d4\u30fc\u3067\u3082\u304a\uff4b\n\n# \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4ee5\u4e0b\u306e public \u3092\u6307\u5b9a\u3059\u308b\n# \u4eca\u56de\u306f /var/www/hogehoge/projectname/ \u304c\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\n<VirtualHost *:80>\n    RailsEnv development\n    ServerName local.projectname.com\n    DocumentRoot /var/www/hogehoge/projectname/public\n    <Directory /var/www/hogehoge/projectname/public>\n        Options Indexes -MultiViews MultiViews Includes FollowSymLinks\n        AllowOverride all\n    </Directory>\n    ErrorLog ${APACHE_LOG_DIR}/error.log\n    LogLevel warn\n    CustomLog ${APACHE_LOG_DIR}/access.log combined\n</VirtualHost>\n\nsudo a2ensite projectname-test\n// apache\u306f\u81ea\u52d5\u3067\u518d\u8d77\u52d5\u3055\u308c\u308b\n\n\nNginx x unicorn\u306e\u5834\u5408\nNginx\u3092\u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\u3068\u3057\u3066\u8a2d\u5b9a\u3057\u307e\u3059\u3002\nNginx\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u4e2d\u306b\u3001\u30b5\u30a4\u30c8\u306e\u6570\u5206\u3001upstream\u30d6\u30ed\u30c3\u30af\u3068location\u30d6\u30ed\u30c3\u30af\u3092\u5897\u3084\u3057\u307e\u3059\u3002\u4e0b\u8a18\u3067\u306f2\u500b\u306e\u30a2\u30d7\u30ea\u306b2\u500b\u306e\u30db\u30b9\u30c8\u3092\u8a2d\u5b9a\u3057\u305f\u5834\u5408\u3092\u8a18\u8ff0\u3057\u3066\u3044\u307e\u3059\u3002\n\nnginx.conf\n#\u4e0b\u8a18\u3092\u8ffd\u8a18\nworker_processes  1;\nevents {\n    worker_connections  1024;\n}\n\nhttp {\n\n    #\u30a2\u30d7\u30ea1\n    upstream app1 {\n        server unix:/tmp/app1.sock;\n    }\n\n    #\u30a2\u30d7\u30ea2\n    upstream app2 {\n        server unix:/tmp/app2.sock;\n    }\n\n    #\u30a2\u30d7\u30ea1\n    server {\n        listen       80;\n        server_name  local.projectname.com;\n\n        location / {\n            root /var/www/hogehoge/projectname/public;\n            proxy_pass http://app1;   #unicorn\u306eupstream\u3092\u6307\u5b9a\n            proxy_set_header Host $host;\n        }\n    }\n\n    #\u30a2\u30d7\u30ea2\n    server {\n        listen       80;\n        server_name  local.projectname2.com;\n\n        location / {\n            root /var/www/hogehoge/projectname2/public;\n            proxy_pass http://app2;    #unicorn\u306eupstream\u3092\u6307\u5b9a\n            proxy_set_header Host $host;\n        }\n    }\n\n}\n\n\nunicorn\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb unicorn.rb\u3092\u7de8\u96c6\u3057\u307e\u3059\u3002\n\nunicorn.rb\n# coding: utf-8\n\n# \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3078\u306e\u30d1\u30b9\n@path = \"/var/www/hogehoge/projectname/\"\n\nworker_processes 1 # CPU\u306e\u30b3\u30a2\u6570\u306b\u63c3\u3048\u308b\nworking_directory @path\ntimeout 300\nlisten '/tmp/app1.sock' # Nginx\u306econfig\u5185\u306b\u3042\u308bupstream\u3067\u3001\u3053\u306e\u30d1\u30b9\u3092\u6307\u5b9a\npid \"#{@path}tmp/pids/unicorn.pid\" # pid\u3092\u4fdd\u5b58\u3059\u308b\u30d5\u30a1\u30a4\u30eb\n# log\u3092\u4fdd\u5b58\u3059\u308b\u30d5\u30a1\u30a4\u30eb\nstderr_path \"#{@path}log/unicorn.stderr.log\"\nstdout_path \"#{@path}log/unicorn.stdout.log\"\npreload_app true\n\n\nunicorn\u306e\u8d77\u52d5\u30b3\u30de\u30f3\u30c9\n$ bundle exec unicorn -E production -c unicorn.rb -D\n\n# unicorn.rb\u306e\u3042\u308b\u30a2\u30d7\u30ea\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3067\u4e0a\u8a18\u5b9f\u884c\n# -E \u3067\u74b0\u5883\u3092\u6307\u5b9a\u3001-D \u3067\u30c7\u30fc\u30e2\u30f3\u5316\n# bundler\u3092\u5229\u7528\u3057\u3066\u3044\u308b\u5834\u5408\u306b\u306f bundle exec\n# unicorn\u3092\u505c\u6b62\u3059\u308b\u5834\u5408\u306f\u3001pid\u3092\u8abf\u3079\u3066kill\u3059\u308b\n\n\u3053\u3053\u307e\u3067\u3067\u3001\u3068\u308a\u3042\u3048\u305aSinatra\u3067Web\u30b5\u30a4\u30c8\u3092\u516c\u958b\u3059\u308b\u3053\u3068\u304c\u51fa\u6765\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u81ea\u52d5\u30ea\u30ed\u30fc\u30c9\n\u901a\u5e38\u3001\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30d5\u30a1\u30a4\u30eb\u3092\u5909\u66f4\u3057\u3066\u3082Web\u30b5\u30fc\u30d0\u3092\u518d\u8d77\u52d5\u3057\u306a\u3044\u3068\u53cd\u6620\u3055\u308c\u306a\u3044\u305f\u3081\u3001\u958b\u767a\u74b0\u5883\u3067\u306f\u81ea\u52d5\u3067\u30ea\u30ed\u30fc\u30c9\u3055\u308c\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u3002\n\nApache+Passenger\u306e\u5834\u5408\n\ntmp/always_restart.txt\n# tmp/\u4ee5\u4e0b\u306b always_restart.txt \u3092\u7f6e\u304f\u3060\u3051\u3002\u4e2d\u8eab\u306f\u7a7a\u3067OK\n\n\n\n\u305d\u308c\u4ee5\u5916\u306e\u5834\u5408\ngem install sinatra-contrib\n\n\nmain.rb\nrequire \"sinatra/reloader\"\n# if development? \u306a\u3069\u306e\u6761\u4ef6\u5206\u5c90\u3092\u3064\u3051\u3066\u304a\u304f\n\n\nGit\u3067\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u5834\u5408\u306b\u306f\u3001.gitignore\u306b\u4e0a\u8a18txt\u30d5\u30a1\u30a4\u30eb\u3092\u8ffd\u52a0 or dev\u74b0\u5883\u306e\u6642\u306e\u307f\u5b9f\u884c\u3055\u308c\u308b\u3088\u3046\u306a\u5206\u5c90\u3092\u66f8\u3044\u3066\u304a\u304f\u3002\n\nBasic\u8a8d\u8a3c\n\u3064\u3044\u3067\u306b\u30d9\u30fc\u30b7\u30c3\u30af\u8a8d\u8a3c\u306b\u3064\u3044\u3066\u3082\u8abf\u3079\u305f\u306e\u3067\u66f8\u3044\u3066\u304a\u304f\u3002\n\n\u30b5\u30a4\u30c8\u5168\u4f53\u306b\u304b\u3051\u308b\u5834\u5408\n\nmain.rb\n# \u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u30d5\u30a1\u30a4\u30eb\u306e\u6700\u521d\u306b\u8a18\u8ff0\nuse Rack::Auth::Basic do |username, password|\n    username == \"name\" && password == \"passwd\"\nend\n\n\n\n\u7279\u5b9a\u306e\u30d1\u30b9\u306b\u304b\u3051\u308b\u5834\u5408\n\nmain.rb\nhelpers do\n    def protected!\n        unless authorized?\n            response['WWW-Authenticate'] = %(Basic realm=\"Restricted Area\")\n            throw(:halt, [401, \"Not authorized\\n\"])\n        end\n    end\n    def authorized?\n        @auth ||=  Rack::Auth::Basic::Request.new(request.env)\n        @auth.provided? && @auth.basic? && @auth.credentials && @auth.credentials == ['name', 'passwd']\n    end\nend\n\nget /protectedurl do\n    protected!\n    \"\u30d9\u30fc\u30b7\u30c3\u30af\u8a8d\u8a3c\u30da\u30fc\u30b8\u3067\u3059\u3088\"\nend\n\n\n\n\u74b0\u5883\u306e\u5909\u66f4\n# sinatra\u306e\u4e2d\u3067\u5206\u5c90\u3059\u308b\u5834\u5408\u306f\u4ee5\u4e0b\u306e\u5b9a\u6570\u304c\u4f7f\u3048\u308b\nENV['RACK_ENV'] # \"development\" or \"production\"\n\n# Sinatra\u3068\u306f\u5225\u306bruby\u306e\u51e6\u7406\u3092\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u3067\u53e9\u304f\u5834\u5408\u3001\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u4ed8\u3051\u308b\n# dev\u74b0\u5883\n$ RACK_ENV=development ruby app/dataset.rb \n# production\u74b0\u5883\n$ RACK_ENV=production ruby app/dataset.rb\n\n\u540c\u69d8\u306e\u5b9a\u6570\u306b\u74b0\u5883\u540d\u304c\u5165\u308b\u306e\u3067\u5206\u5c90\u306b\u4f7f\u3048\u308b\nENV['RACK_ENV'] # \"development\" or \"production\"\n\n\n\u53c2\u8003\n\nSinatra\u3068Haml\u3068Scss\u3068CoffeeScript\u3067\u30e2\u30c0\u30f3\u306aWeb\u5236\u4f5c\u74b0\u5883\u3092\u69cb\u7bc9\u3059\u308b #2\nRuby\u306e\u5165\u9580\u3084\u66f8\u304d\u6368\u3066\u30a2\u30d7\u30ea\u3092\u4f5c\u308b\u5834\u5408\u306f sinatra\u304c\u30aa\u30b9\u30b9\u30e1\uff01\napache-passenger\u3067\u52d5\u304b\u3059sinatra\u74b0\u5883\u306e\u3088\u3055\u3052\u306a\u8a2d\u5b9a\n\u3010\u521d\u5fc3\u8005\u5411\u3051\u3011Ruby\u3068Sinatra\u3001\u30a2\u30f3\u30c6\u30ca\u30b5\u30a4\u30c8\u306e\u4f5c\u308a\u65b9\nsinatra\u3067Basic\u8a8d\u8a3c\nBundler\u518d\u5c65\u4fee: bundle exec\u3063\u3066\u4f55\uff1f gem\u306f\u3069\u3053\u306b\u5165\u308b\u306e\uff1f\n\n\u521d\u3081\u3066Sinatra\u3067\u30a2\u30d7\u30ea\u3092\u4f5c\u3063\u305f\u306e\u3067\u899a\u3048\u305f\u3053\u3068\u307e\u3068\u3081\u3002\n\u4e8b\u60c5\u306b\u3088\u308a\u30ed\u30fc\u30ab\u30eb\u306fApach + Passenger\u3001\u30ea\u30e2\u30fc\u30c8\u306fNginx + Unicorn\u306a\u306e\u3067\u3001\u4e00\u5fdc\u4e21\u65b9\u3067\u52d5\u304f\u3088\u3046\u307e\u3068\u3081\u30fb\u30fb\u30fb\u305f\u3064\u3082\u308a\u306a\u306e\u3067\u3059\u304c\u3002\n\n## \u5143\u8a18\u4e8b\n\u4e0b\u8a18\u30a8\u30f3\u30c8\u30ea\u306e\u8ee2\u8f09\u306b\u306a\u308a\u307e\u3059\u3002\n[\u3010Ruby\u3011Sinatra\u3067\u3001\u901f\u653b\u3067Web\u30b5\u30a4\u30c8\u3092\u516c\u958b\u3059\u308b\u305f\u3081\u306e\u74b0\u5883\u69cb\u7bc9 - rokuroFire](http://www.rokurofire.info/2013/11/20/sinatra_builtenv/)\n\n## \u4e8b\u524d\u6e96\u5099\n* Ruby\u3001bundler\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n* Apache\u306e\u5834\u5408\u3001Passenger\u306e\u8a2d\u5b9a\u3092\u3057\u3066\u304a\u304f\n* Nginx\u306e\u5834\u5408\u3001Unicorn\u306egem\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u304a\u304f\n\n## \u30a2\u30d7\u30ea\u306e\u30d5\u30a1\u30a4\u30eb\u69cb\u6210\n\u6700\u5c0f\u69cb\u6210\u306f\u4e0b\u8a18\u3002\n\n```\nprojectname/\n-main.rb\t// Controller\n-config.ru\t// Rack\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3002\u6700\u521d\u306b\u5b9f\u884c\u3055\u308c\u308b\u30d5\u30a1\u30a4\u30eb\n-views/\n\t-index.haml\t// \u30d3\u30e5\u30fc\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\uff08haml\uff09\u30d5\u30a1\u30a4\u30eb\n-public/\t// web\u30b5\u30fc\u30d0\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u30eb\u30fc\u30c8\u306f\u3053\u3053\u3092\u6307\u5b9a\u3002\u753b\u50cf\u3082\u3053\u3053\n```\n\n\u500b\u4eba\u7684\u306b\u3001\u4f5c\u696d\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306b\u3057\u3066\u307f\u307e\u3057\u305f\n\n```\nprojectname/\n-Gemfile\t\n-config.ru\t// Rack\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3002\u6700\u521d\u306b\u5b9f\u884c\u3055\u308c\u308b\u30d5\u30a1\u30a4\u30eb\n-main.rb\t// Controller\n-app/\t\t// \u4f55\u3089\u304b\u306e\u51e6\u7406\n  -module/\t// \u30e2\u30b8\u30e5\u30fc\u30eb\u985e\u306e\u30d5\u30a1\u30a4\u30eb\n-views/\t\t// \u30d3\u30e5\u30fc\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\uff08haml\uff09\u30d5\u30a1\u30a4\u30eb\n  -index.haml\n  -layout.haml\n  -style/\t// sass\uff08scss\uff09\u30d5\u30a1\u30a4\u30eb\n    -baes.scss\n-db/\t\t// \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\uff08yml\uff09\u3092\u7f6e\u304f\n-log/\t\t// \u30ed\u30b0\u7f6e\u304d\u5834\n-public/\t// web\u30b5\u30fc\u30d0\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u30eb\u30fc\u30c8\u306f\u3053\u3053\u3092\u6307\u5b9a\u3002\u753b\u50cf\u3082\u3053\u3053\n-tmp/\n-vendor/\n\t-bundle/\t// gem\u306e\u7ba1\u7406\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\n-unicorn.rb\t// unicorn\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\n```\n\n## Sinatra\u306e\u8a2d\u5b9a\n\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u76f4\u4e0b\u306bconfig.ru\u3092\u7f6e\u304d\u307e\u3059\u3002\n\u307e\u305f\u4eca\u56de\u306fController\u3092\u5225\u30d5\u30a1\u30a4\u30eb\uff08main.rb\uff09\u306b\u3057\u307e\u3057\u305f\u3002\n\n```config.ru\nrequire './main.rb'\nrun MainApp\n```\n```main.rb\nrequire 'rubygems'\nrequire 'sinatra/base'\nrequire 'logger'\nrequire 'unicorn'\nrequire 'haml'\nrequire 'sass'\n\n# config.ru \u3067\u306f\u3053\u306e\u30af\u30e9\u30b9\u3092run\u3057\u3066\u3044\u307e\u3059\nclass MainApp < Sinatra::Base\n\n\t # css\u306b\u30a2\u30af\u30bb\u30b9\u3057\u305f\u6642\u306e\u51e6\u7406\n\tget %r{^/(.*)\\.css$} do\n\t\tscss :\"style/#{params[:captures].first}\" #scss\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\n\tend\n\n\t# '/'\u306b\u30a2\u30af\u30bb\u30b9\u3057\u305f\u6642\u306e\u51e6\u7406\n\t# views/index.haml\n\tget '/' do\n\t\thaml :index #views/index.haml\uff08haml\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\uff09\n\tend\nend\n```\n\n%r{^/(.*)\\.css$} \u306e\uff08\uff09\u306e\u90e8\u5206\u306f params[:captures] \u3068\u3044\u3046\u914d\u5217\u306b\u683c\u7d0d\u3055\u308c\u308b\u3088\u3046\u3067\u3001first\u30670\u756a\u76ee\u306e\u8981\u7d20\u3092\u53d6\u5f97\u3057\u307e\u3059\u3002\n\u3064\u307e\u308a\u3053\u306e\u5834\u5408\u3001/base.css \u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001views\u4ee5\u4e0b\u306b\u3042\u308b style/base.scss \u304c\u547c\u3073\u51fa\u3055\u308c\u307e\u3059\u3002\n\n## bundler\u3067gem\u306e\u7ba1\u7406\nRails\u3067\u306f\u304a\u306a\u3058\u307f\u3067\u3059\u304c\u3001Sinatra\u3067\u3082gem\u306e\u7ba1\u7406\u306bbundler\u3092\u4f7f\u3063\u3066\u307f\u307e\u3059\u3002\n\n```\n# \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ gem install bundler\n\n$ cd projectname\n$ bundle init\n# Gemfile\u304c\u4f5c\u6210\u3055\u308c\u308b\n```\n\n```Gemfile\nsource \"https://rubygems.org\"\ngem 'sinatra'\ngem 'haml'\ngem 'mysql2'\ngem 'activerecord'\ngem 'unicorn'\t\t# Nginx + Unicorn\u306e\u5834\u5408\n\u30fb\u30fb\u30fb# \u306a\u3069\u306a\u3069\n\n#\u3010\u6ce8\u610f\u3011\n# gem\u306f \"activerecord\"\n# .rb\u5185\u3067\u306erequire\u306f \"active_record\"\n```\n\n```\n# gem\u3092\u5165\u308c\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\nmkdir vendor\nmkdir vendor/bundle\n\n# \u30d1\u30b9\u3092\u6307\u5b9a\u3057\u3066 bundle install\n# bundle exec \u3092\u3064\u3051\u308b\u3053\u3068\u3067\u3001Gemfile\u3067\u6307\u5b9a\u3055\u308c\u305fgem\u74b0\u5883\u3067\u30b3\u30de\u30f3\u30c9\u304c\u5b9f\u884c\u3055\u308c\u308b\n$ bundle install --path vendor/bundle\n\n# \u30ea\u30e2\u30fc\u30c8\u306eUnicorn\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u8abf\u3079\u308b\u306a\u3069\n$ bundle exec unicorn -v\nunicorn v4.7.0\n```\n\n##Web\u30b5\u30fc\u30d0\uff08\u30d0\u30fc\u30c1\u30e3\u30eb\u30db\u30b9\u30c8\uff09\u306e\u8a2d\u5b9a\n\n#####Apache x passenger\u306e\u5834\u5408\n\n\u9759\u7684\u306a\u30b5\u30a4\u30c8\u3068\u540c\u69d8\u3001\u30b5\u30a4\u30c8\u6570\u5206\u3001VirtualHost\u30d6\u30ed\u30c3\u30af\u3092\u8ffd\u52a0\u3059\u308b\u3060\u3051\u3067\u3059\u3002\n\u79c1\u306eUbuntu\u306eApache\u306f\u30d0\u30fc\u30c1\u30e3\u30eb\u30db\u30b9\u30c8\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u304cconfig\u3068\u306f\u5225\u30d5\u30a1\u30a4\u30eb\u306b\u306a\u3063\u3066\u3044\u307e\u3057\u305f\u3002\u74b0\u5883\u306b\u3088\u3063\u3066\u306f\u5c11\u3057\u9055\u3046\u3068\u601d\u308f\u308c\u307e\u3059\u3002\n\n```\n$ cd /etc/apache2/sites-available/\n$ sudo vim projectname-test\t\t\t# \u65e2\u5b58\u306e\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u3092\u30b3\u30d4\u30fc\u3067\u3082\u304a\uff4b\n```\n\n```config\u30d5\u30a1\u30a4\u30eb\n# \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4ee5\u4e0b\u306e public \u3092\u6307\u5b9a\u3059\u308b\n# \u4eca\u56de\u306f /var/www/hogehoge/projectname/ \u304c\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\n<VirtualHost *:80>\n\tRailsEnv development\n\tServerName local.projectname.com\n\tDocumentRoot /var/www/hogehoge/projectname/public\n\t<Directory /var/www/hogehoge/projectname/public>\n\t\tOptions Indexes -MultiViews MultiViews Includes FollowSymLinks\n\t\tAllowOverride all\n\t</Directory>\n\tErrorLog ${APACHE_LOG_DIR}/error.log\n\tLogLevel warn\n\tCustomLog ${APACHE_LOG_DIR}/access.log combined\n</VirtualHost>\n```\n```\nsudo a2ensite projectname-test\n// apache\u306f\u81ea\u52d5\u3067\u518d\u8d77\u52d5\u3055\u308c\u308b\n```\n\n##### Nginx x unicorn\u306e\u5834\u5408\n\nNginx\u3092\u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\u3068\u3057\u3066\u8a2d\u5b9a\u3057\u307e\u3059\u3002\nNginx\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u4e2d\u306b\u3001\u30b5\u30a4\u30c8\u306e\u6570\u5206\u3001upstream\u30d6\u30ed\u30c3\u30af\u3068location\u30d6\u30ed\u30c3\u30af\u3092\u5897\u3084\u3057\u307e\u3059\u3002\u4e0b\u8a18\u3067\u306f2\u500b\u306e\u30a2\u30d7\u30ea\u306b2\u500b\u306e\u30db\u30b9\u30c8\u3092\u8a2d\u5b9a\u3057\u305f\u5834\u5408\u3092\u8a18\u8ff0\u3057\u3066\u3044\u307e\u3059\u3002\n\n```nginx.conf\n#\u4e0b\u8a18\u3092\u8ffd\u8a18\nworker_processes  1;\nevents {\n    worker_connections  1024;\n}\n\nhttp {\n\n    #\u30a2\u30d7\u30ea1\n    upstream app1 {\n        server unix:/tmp/app1.sock;\n    }\n\n    #\u30a2\u30d7\u30ea2\n    upstream app2 {\n        server unix:/tmp/app2.sock;\n    }\n\n    #\u30a2\u30d7\u30ea1\n    server {\n        listen       80;\n        server_name  local.projectname.com;\n\n        location / {\n            root /var/www/hogehoge/projectname/public;\n            proxy_pass http://app1;   #unicorn\u306eupstream\u3092\u6307\u5b9a\n            proxy_set_header Host $host;\n        }\n    }\n\n    #\u30a2\u30d7\u30ea2\n    server {\n        listen       80;\n        server_name  local.projectname2.com;\n\n        location / {\n            root /var/www/hogehoge/projectname2/public;\n            proxy_pass http://app2;    #unicorn\u306eupstream\u3092\u6307\u5b9a\n            proxy_set_header Host $host;\n        }\n    }\n\n}\n```\n\nunicorn\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb unicorn.rb\u3092\u7de8\u96c6\u3057\u307e\u3059\u3002\n\n```unicorn.rb\n# coding: utf-8\n\n# \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3078\u306e\u30d1\u30b9\n@path = \"/var/www/hogehoge/projectname/\"\n\nworker_processes 1 # CPU\u306e\u30b3\u30a2\u6570\u306b\u63c3\u3048\u308b\nworking_directory @path\ntimeout 300\nlisten '/tmp/app1.sock'\t# Nginx\u306econfig\u5185\u306b\u3042\u308bupstream\u3067\u3001\u3053\u306e\u30d1\u30b9\u3092\u6307\u5b9a\npid \"#{@path}tmp/pids/unicorn.pid\" # pid\u3092\u4fdd\u5b58\u3059\u308b\u30d5\u30a1\u30a4\u30eb\n# log\u3092\u4fdd\u5b58\u3059\u308b\u30d5\u30a1\u30a4\u30eb\nstderr_path \"#{@path}log/unicorn.stderr.log\"\nstdout_path \"#{@path}log/unicorn.stdout.log\"\npreload_app true\n```\n\nunicorn\u306e\u8d77\u52d5\u30b3\u30de\u30f3\u30c9\n\n```\n$ bundle exec unicorn -E production -c unicorn.rb -D\n\n# unicorn.rb\u306e\u3042\u308b\u30a2\u30d7\u30ea\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3067\u4e0a\u8a18\u5b9f\u884c\n# -E \u3067\u74b0\u5883\u3092\u6307\u5b9a\u3001-D \u3067\u30c7\u30fc\u30e2\u30f3\u5316\n# bundler\u3092\u5229\u7528\u3057\u3066\u3044\u308b\u5834\u5408\u306b\u306f bundle exec\n# unicorn\u3092\u505c\u6b62\u3059\u308b\u5834\u5408\u306f\u3001pid\u3092\u8abf\u3079\u3066kill\u3059\u308b\n```\n\n\u3053\u3053\u307e\u3067\u3067\u3001\u3068\u308a\u3042\u3048\u305aSinatra\u3067Web\u30b5\u30a4\u30c8\u3092\u516c\u958b\u3059\u308b\u3053\u3068\u304c\u51fa\u6765\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\n## \u81ea\u52d5\u30ea\u30ed\u30fc\u30c9\n\u901a\u5e38\u3001\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30d5\u30a1\u30a4\u30eb\u3092\u5909\u66f4\u3057\u3066\u3082Web\u30b5\u30fc\u30d0\u3092\u518d\u8d77\u52d5\u3057\u306a\u3044\u3068\u53cd\u6620\u3055\u308c\u306a\u3044\u305f\u3081\u3001\u958b\u767a\u74b0\u5883\u3067\u306f\u81ea\u52d5\u3067\u30ea\u30ed\u30fc\u30c9\u3055\u308c\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u3002\n\n####Apache+Passenger\u306e\u5834\u5408\n```tmp/always_restart.txt\n# tmp/\u4ee5\u4e0b\u306b always_restart.txt \u3092\u7f6e\u304f\u3060\u3051\u3002\u4e2d\u8eab\u306f\u7a7a\u3067OK\n```\n\n####\u305d\u308c\u4ee5\u5916\u306e\u5834\u5408\n```\ngem install sinatra-contrib\n```\n```main.rb\nrequire \"sinatra/reloader\"\n# if development? \u306a\u3069\u306e\u6761\u4ef6\u5206\u5c90\u3092\u3064\u3051\u3066\u304a\u304f\n```\n\nGit\u3067\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u5834\u5408\u306b\u306f\u3001.gitignore\u306b\u4e0a\u8a18txt\u30d5\u30a1\u30a4\u30eb\u3092\u8ffd\u52a0 or dev\u74b0\u5883\u306e\u6642\u306e\u307f\u5b9f\u884c\u3055\u308c\u308b\u3088\u3046\u306a\u5206\u5c90\u3092\u66f8\u3044\u3066\u304a\u304f\u3002\n\n## Basic\u8a8d\u8a3c\n\u3064\u3044\u3067\u306b\u30d9\u30fc\u30b7\u30c3\u30af\u8a8d\u8a3c\u306b\u3064\u3044\u3066\u3082\u8abf\u3079\u305f\u306e\u3067\u66f8\u3044\u3066\u304a\u304f\u3002\n\n##### \u30b5\u30a4\u30c8\u5168\u4f53\u306b\u304b\u3051\u308b\u5834\u5408\n\n```main.rb\n# \u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u30d5\u30a1\u30a4\u30eb\u306e\u6700\u521d\u306b\u8a18\u8ff0\nuse Rack::Auth::Basic do |username, password|\n\tusername == \"name\" && password == \"passwd\"\nend\n```\n\n##### \u7279\u5b9a\u306e\u30d1\u30b9\u306b\u304b\u3051\u308b\u5834\u5408\n\n```main.rb\nhelpers do\n\tdef protected!\n\t\tunless authorized?\n\t\t\tresponse['WWW-Authenticate'] = %(Basic realm=\"Restricted Area\")\n\t\t\tthrow(:halt, [401, \"Not authorized\\n\"])\n\t\tend\n\tend\n\tdef authorized?\n\t\t@auth ||=  Rack::Auth::Basic::Request.new(request.env)\n\t\t@auth.provided? && @auth.basic? && @auth.credentials && @auth.credentials == ['name', 'passwd']\n\tend\nend\n\nget /protectedurl do\n\tprotected!\n\t\"\u30d9\u30fc\u30b7\u30c3\u30af\u8a8d\u8a3c\u30da\u30fc\u30b8\u3067\u3059\u3088\"\nend\n```\n\n## \u74b0\u5883\u306e\u5909\u66f4\n```cmd\n# sinatra\u306e\u4e2d\u3067\u5206\u5c90\u3059\u308b\u5834\u5408\u306f\u4ee5\u4e0b\u306e\u5b9a\u6570\u304c\u4f7f\u3048\u308b\nENV['RACK_ENV'] # \"development\" or \"production\"\n\n# Sinatra\u3068\u306f\u5225\u306bruby\u306e\u51e6\u7406\u3092\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u3067\u53e9\u304f\u5834\u5408\u3001\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u4ed8\u3051\u308b\n# dev\u74b0\u5883\n$ RACK_ENV=development ruby app/dataset.rb \n# production\u74b0\u5883\n$ RACK_ENV=production ruby app/dataset.rb\n\n\u540c\u69d8\u306e\u5b9a\u6570\u306b\u74b0\u5883\u540d\u304c\u5165\u308b\u306e\u3067\u5206\u5c90\u306b\u4f7f\u3048\u308b\nENV['RACK_ENV'] # \"development\" or \"production\"\n```\n\n##\u53c2\u8003\n* [Sinatra\u3068Haml\u3068Scss\u3068CoffeeScript\u3067\u30e2\u30c0\u30f3\u306aWeb\u5236\u4f5c\u74b0\u5883\u3092\u69cb\u7bc9\u3059\u308b #2](http://dev.classmethod.jp/server-side/language/modern-web-creating-environment-2/)\n* [Ruby\u306e\u5165\u9580\u3084\u66f8\u304d\u6368\u3066\u30a2\u30d7\u30ea\u3092\u4f5c\u308b\u5834\u5408\u306f sinatra\u304c\u30aa\u30b9\u30b9\u30e1\uff01](http://mukaer.com/archives/2013/06/06/ruby_sinatra/)\n* [apache-passenger\u3067\u52d5\u304b\u3059sinatra\u74b0\u5883\u306e\u3088\u3055\u3052\u306a\u8a2d\u5b9a](http://shimada-k.hateblo.jp/entry/2012/12/08/140935)\n* [\u3010\u521d\u5fc3\u8005\u5411\u3051\u3011Ruby\u3068Sinatra\u3001\u30a2\u30f3\u30c6\u30ca\u30b5\u30a4\u30c8\u306e\u4f5c\u308a\u65b9](http://shgam.hatenadiary.jp/entry/2013/08/25/160937)\n* [sinatra\u3067Basic\u8a8d\u8a3c](http://qiita.com/yaotti/items/11d6cea26d3c7111ea8c)\n* [Bundler\u518d\u5c65\u4fee: bundle exec\u3063\u3066\u4f55\uff1f gem\u306f\u3069\u3053\u306b\u5165\u308b\u306e\uff1f](http://memo.yomukaku.net/entries/IpCSQmo)\n", "tags": ["Ruby", "Sinatra", "nginx"]}