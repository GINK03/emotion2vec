{"context": " More than 1 year has passed since last update.\u524d\u304b\u3089\u6c17\u306b\u306a\u3063\u3066\u305f\u30c4\u30fc\u30eb\u3092\u8a66\u3059\u30b7\u30ea\u30fc\u30ba\u305d\u306e2\u3002\n\u4eca\u56de\u306f\u3001\u8907\u6570\u306eDocker\u30b3\u30f3\u30c6\u30ca\u3092\u7ba1\u7406\u3059\u308b fig \u304c\u3069\u3093\u306a\u3082\u306e\u306a\u306e\u304b\u8a66\u3059\u305f\u3081\u306b\u3001\u3053\u308c\u307e\u305f\u6c17\u306b\u306a\u3063\u3066\u305f fluentd \u3001 Elasticsearch \u3001 Kibana \u3092\u8a66\u3059\u305f\u3081\u306e\u74b0\u5883\u3092 fig \u3092\u4f7f\u3063\u3066\u69cb\u7bc9\u3057\u3066\u307f\u305f\u3002\u304c\u3001\u74b0\u5883\u69cb\u7bc9\u3067\u6e80\u8db3\u3057\u3066 fluentd \u3084 Kibana \u306e\u4f7f\u7528\u611f\u306f\u307e\u3060\u78ba\u8a8d\u3067\u304d\u3066\u306a\u3044\u3002\u3061\u3087\u3063\u3068\u6b32\u5f35\u308a\u3059\u304e\u305f\u304b\u306a\u3002\u3002\u3002\n\u306a\u304a\u3001\u74b0\u5883\u306f Mac OS X Mavericks + boot2docker\u3002\n\nfig \u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u624b\u3063\u53d6\u308a\u65e9\u304f Homebrew \u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3002\n% brew install fig\n% fig --version\nfig 1.0.1\n\n\u3061\u306a\u307f\u306b Docker \u306e\u74b0\u5883\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3002\n% docker version\nClient version: 1.3.0\nClient API version: 1.15\nGo version (client): go1.3.3\nGit commit (client): c78088f\nOS/Arch (client): darwin/amd64\nServer version: 1.3.0\nServer API version: 1.15\nGo version (server): go1.3.3\nGit commit (server): c78088f\n\n\n\u69cb\u6210\n\u4eca\u56de\u306f fig \u3092\u4f7f\u3063\u3066\u4ee5\u4e0b\u306e3\u3064\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u4f5c\u6210\u3057\u3066\u9023\u643a\u3055\u305b\u308b\u3002\n\n\u30b3\u30f3\u30c6\u30ca\u540d\uff1a web\n\nApache\nfluentd\n\n\n\u30b3\u30f3\u30c6\u30ca\u540d\uff1a elasticsearch\n\nElasticsearch\n\n\n\u30b3\u30f3\u30c6\u30ca\u540d\uff1a kibana\n\nApache\nKibana\n\n\n\nweb\u30b3\u30f3\u30c6\u30ca\u304c\u30d5\u30ed\u30f3\u30c8\u30a8\u30f3\u30c9\u306e\u30b5\u30fc\u30d0\u3068\u3044\u3046\u60f3\u5b9a\u3002\u3053\u306e\u30b5\u30fc\u30d0\u306e\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u3092 fluentd \u3092\u4f7f\u3063\u3066 Elasticsearch \u3078\u9001\u308a Kibana \u3067\u53ef\u8996\u5316\u3059\u308b\u3002\n\u5b9f\u969b\u306b\u30d7\u30ed\u30c0\u30af\u30c8\u3067\u4f7f\u7528\u3059\u308b\u969b\u306f\u3044\u304d\u306a\u308a Elasticsearch \u3078\u8ee2\u9001\u3059\u308b\u306e\u3067\u306f\u306a\u304f\u3001\u9593\u306b\u96c6\u7d04\u3059\u308b fluentd \u3092\u5165\u308c\u308b\u69cb\u6210\u306b\u3059\u308b\u306e\u304c\u3044\u3044\u3089\u3057\u3044\u3002\n\nDockerfile\n\u305d\u308c\u305e\u308c\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u4f5c\u308b\u305f\u3081\u306e Dockerfile \u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u4f5c\u6210\u3057\u305f\u3002\n\u3044\u305a\u308c\u3082 CentOS 6 \u3092\u30d9\u30fc\u30b9\u306b\u3057\u3066\u3044\u308b\u3002\n\nweb \u30b3\u30f3\u30c6\u30ca\nfluentd \u306f\u516c\u5f0f\u306e \u30c9\u30ad\u30e5\u30e1\u30f3\u30c8 \u306e\u901a\u308a\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n\u304c\u3001yum \u3067 Apache \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3068 /var/log/httpd \u304c root:root \u3067\u4f5c\u3089\u308c\u308b\u306e\u3060\u304c\u3001\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u3092\u5909\u3048\u3066\u3082\u306a\u305c\u304b td-agent \u30e6\u30fc\u30b6\u30fc\u304b\u3089\u53c2\u7167\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u306a\u304b\u3063\u305f\u3002\u8272\u3005\u8a66\u3057\u3066\u3082\u3088\u304f\u308f\u304b\u3089\u306a\u304b\u3063\u305f\u306e\u3067\u3001 \u3053\u3061\u3089 \u3092\u53c2\u8003\u306b root \u3067\u8d77\u52d5\u3059\u308b\u3088\u3046\u306b\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u66f8\u304d\u63db\u3048\u305f\u3002\nfluentd \u306b\u306f Elasticsearch \u7528\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u3082\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3002\u4f9d\u5b58\u3059\u308b libcurl-devel \u3068 gcc \u306f yum \u3067\u5165\u308c\u3066\u304a\u304f\u3002\n\nweb/Dockerfile\nFROM centos:centos6\n\n# Install core modules\nRUN yum update -y &&\\\n    yum install -y sudo tar &&\\\n    yum clean -y all\n\n# Edit sudoers file\nRUN sed -i -e \"s/Defaults    requiretty.*/ #Defaults    requiretty/g\" /etc/sudoers\n\n# Install fluentd\nRUN curl -L http://toolbelt.treasuredata.com/sh/install-redhat-td-agent2.sh | sh\nRUN sed -i -e \"s/--user td-agent/--user root/g\" /etc/init.d/td-agent &&\\\n    sed -i -e \"s/--group td-agent/--user root --group td-agent/g\" /etc/init.d/td-agent\nRUN ulimit -n 65536\nCOPY td-agent.conf /etc/td-agent/td-agent.conf\n\n# Install Fluent::Plugin::Elasticsearch\nRUN yum install -y libcurl-devel gcc &&\\\n    yum clean -y all\nRUN /opt/td-agent/embedded/bin/gem install fluent-plugin-elasticsearch\n\n# Install httpd\nRUN yum install -y httpd &&\\\n    yum clean -y all\n\nCOPY run.sh /tmp/\nEXPOSE 80\nENTRYPOINT [\"/bin/bash\", \"/tmp/run.sh\"]\n\n\nApache \u3068 fluentd \u306e\u4e21\u65b9\u306e\u30b5\u30fc\u30d3\u30b9\u3092\u8d77\u52d5\u3055\u305b\u308b\u305f\u3081\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30b7\u30a7\u30eb\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u4f5c\u6210\u3057\u3066\u30d7\u30ed\u30bb\u30b9\u304c\u30d5\u30a9\u30a2\u30b0\u30e9\u30a6\u30f3\u30c9\u3067\u52d5\u304d\u7d9a\u3051\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u308b\u3002\n\nweb/run.sh\n#!/bin/bash\n\nservice httpd start\nservice td-agent start\n\ntail -f /var/log/td-agent/td-agent.log\n\n\nfluentd \u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3067\u3042\u308b td-agent.conf \u306f\u3001\u3068\u308a\u3042\u3048\u305a\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u4f5c\u3063\u3066\u307f\u305f\u3002\n\nweb/td-agent.conf\n<source>\n  type tail\n  path /var/log/httpd/access_log\n  tag apache.web\n  pos_file /var/log/td-agent/httpd-access.log.pos\n  format apache2\n</source>\n\n<match apache.**>\n  type copy\n\n  <store>\n    type stdout\n  </store>\n\n  <store>\n    type elasticsearch\n    host elasticsearch\n    port 9200\n  </store>\n\n</match>\n\n\n\nelasticsearch \u30b3\u30f3\u30c6\u30ca\njava \u3068 which \u304c\u5fc5\u8981\u306a\u306e\u3067\u3001\u4e8b\u524d\u306b yum \u3067\u5165\u308c\u3066\u304a\u304f\u3002\u307e\u305f\u74b0\u5883\u5909\u6570 JAVA_HOME \u3092\u8a2d\u5b9a\u3057\u3001 PATH \u3082\u901a\u3057\u3066\u304a\u304f\u3002\nElasticsearch \u3082 \u30c9\u30ad\u30e5\u30e1\u30f3\u30c8 \u306e\u901a\u308a\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5148\u306f /opt/elasticsearch \u3068\u3057\u305f\u3002\n\u30af\u30ed\u30b9\u30c9\u30e1\u30a4\u30f3\u5bfe\u7b56\u306e\u305f\u3081\u3001 elasticsearch.yml \u306b\u8a2d\u5b9a\u3092\u8ffd\u52a0\u3057\u3066\u3044\u308b\u3002\n\nelasticsearch/Dockerfile\nFROM centos:centos6\n\n# Install core modules\nRUN yum update -y &&\\\n    yum install -y java-1.7.0-openjdk sudo tar which &&\\\n    yum clean -y all\n\n# Edit sudoers file\nRUN sed -i -e \"s/Defaults    requiretty.*/ #Defaults    requiretty/g\" /etc/sudoers\n\n# Set JAVA_HOME\nENV JAVA_HOME /usr/lib/jvm/java-1.7.0-openjdk.x86_64\nENV PATH $JAVA_HOME/bin:$PATH\n\n# Install elasticsearch\nENV ES_PKG_NAME elasticsearch-1.4.0\nADD https://download.elasticsearch.org/elasticsearch/elasticsearch/$ES_PKG_NAME.tar.gz /tmp/$ES_PKG_NAME.tar.gz\nRUN cd /tmp &&\\\n    tar xzvf $ES_PKG_NAME.tar.gz &&\\\n    mv $ES_PKG_NAME /opt/elasticsearch &&\\\n    rm -f $ES_PKG_NAME.tar.gz\nRUN echo 'http.cors.enabled: true' >> /opt/elasticsearch/config/elasticsearch.yml &&\\\n    echo 'http.cors.allow-origin: \"/.*/\"' >> /opt/elasticsearch/config/elasticsearch.yml\n\nEXPOSE 9200\nEXPOSE 9300\n\nENTRYPOINT [\"/opt/elasticsearch/bin/elasticsearch\"]\n\n\n\nkibana \u30b3\u30f3\u30c6\u30ca\nKibana 3 \u306f\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066 Apache \u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u30eb\u30fc\u30c8\u4ee5\u4e0b\u306b\u7a81\u3063\u8fbc\u3080\u3060\u3051\u3067\u4f7f\u3048\u308b\u3088\u3046\u306b\u306a\u308b\uff08 Kibana 4 \u304b\u3089\u306f\u3061\u3087\u3063\u3068\u69cb\u6210\u304c\u5909\u308f\u308b\u3089\u3057\u3044\uff09\u3002\u7c21\u5358\u3002\u4eca\u56de\u306f /var/www/html/kibana \u3078\u914d\u7f6e\u3057\u305f\u3002\n\nkibana/Dockerfile\nFROM centos:centos6\n\n# Install core modules\nRUN yum update -y &&\\\n    yum install -y sudo tar &&\\\n    yum clean -y all\n\n# Edit sudoers file\nRUN sed -i -e \"s/Defaults    requiretty.*/ #Defaults    requiretty/g\" /etc/sudoers\n\n# Install httpd\nRUN yum install -y httpd &&\\\n    yum clean -y all\n\n# Install kibana\nENV KIBANA_PKG_NAME kibana-3.1.2\nADD https://download.elasticsearch.org/kibana/kibana/$KIBANA_PKG_NAME.tar.gz /tmp/$KIBANA_PKG_NAME.tar.gz\nRUN cd /var/www/html &&\\\n    tar xzvf /tmp/$KIBANA_PKG_NAME.tar.gz &&\\\n    mv $KIBANA_PKG_NAME kibana\n\nCOPY run.sh /tmp/run.sh\n\nEXPOSE 80\nENTRYPOINT [\"/bin/bash\", \"/tmp/run.sh\"]\n\n\n\u4e00\u5fdc web \u30b3\u30f3\u30c6\u30ca\u3068\u540c\u69d8\u306b\u30b7\u30a7\u30eb\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u7528\u610f\u3057\u305f\u304c\u3001\u52d5\u304b\u3059\u30b5\u30fc\u30d3\u30b9\u306f1\u3064\u3060\u3051\u306a\u306e\u3067\u76f4\u63a5 Apache \u3092\u8d77\u52d5\u3057\u3066\u3082\u69cb\u308f\u306a\u3044\u3002\n\nkibana/run.sh\n#!/bin/bash\n\nservice httpd start\n\ntail -f /var/log/httpd/access_log\n\n\n\nfig.yml\nDockerfile \u304c\u3067\u304d\u305f\u306e\u3067\u3001\u6b21\u306b fig \u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\u8a2d\u5b9a\u306f YAML \u3067\u66f8\u304f\u3002 \u30ea\u30d5\u30a1\u30ec\u30f3\u30b9 \u3092\u53c2\u8003\u306b\u3057\u3066\u4ee5\u4e0b\u306e\u3088\u3046\u306a fig.yml \u3092\u4f5c\u6210\u3057\u305f\u3002\n\nfig.yml\n---\nelasticsearch:\n  build: elasticsearch\n  ports:\n    - \"9200:9200\"\n    - \"9300:9300\"\nkibana:\n  build: kibana\n  ports:\n    - \"50080:80\"\n  links:\n    - elasticsearch\nweb:\n  build: web\n  ports:\n    - \"10080:80\"\n    - \"18888:8888\"\n  links:\n    - elasticsearch\n\n\nbuild \u3067 Dockerfile \u306e\u3042\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u6307\u5b9a\u3059\u308b\u3002\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u3059\u308b\u30dd\u30fc\u30c8\u306f ports \u3067\u3001\u30ea\u30f3\u30af\u3057\u305f\u3044\u30b3\u30f3\u30c6\u30ca\u306f links \u3067\u305d\u308c\u305e\u308c\u6307\u5b9a\u3067\u304d\u308b\u3002 fig \u3092\u4f7f\u308f\u306a\u3044\u3067\u8d77\u52d5\u3057\u3088\u3046\u3068\u3059\u308b\u3068\u3001 docker run \u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u306b\u81ea\u5206\u3067\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u304c\u3001 fig \u306a\u3089\u7c21\u5358\u306b\u8a2d\u5b9a\u3067\u304d\u3066Good\u3002\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u8d77\u52d5\nDockerfile \u3092\u30d3\u30eb\u30c9\u3057\u3066\u30a4\u30e1\u30fc\u30b8\u3092\u4f5c\u308b\u3002\n% fig build\nBuilding elasticsearch...\n ---> 70441cac1ed5\nStep 1 : RUN yum update -y &&    yum install -y java-1.7.0-openjdk sudo tar which &&    yum clean -y all\n\n(...snip...)\n\nSuccessfully built c9747896561b\n\n\u3053\u308c\u3060\u3051\u3067\u3059\u3079\u3066\u306e Dockerfile \u304c\u30d3\u30eb\u30c9\u3055\u308c\u308b\u3002\u4fbf\u5229\u3002\n\u305d\u3057\u3066\u8d77\u52d5\u3002\u3053\u3061\u3089\u3082\u7c21\u5358\u4e00\u767a\u3002\n% fig up\nRecreating fluentdsample_elasticsearch_1...\nRecreating fluentdsample_web_1...\nRecreating fluentdsample_kibana_1...\nAttaching to fluentdsample_elasticsearch_1, fluentdsample_web_1, fluentdsample_kibana_1\nelasticsearch_1 | [2014-11-22 17:43:57,222][INFO ][node                     ] [Eros] version[1.4.0], pid[1], build[bc94bd8/2014-11-05T14:26:12Z]\nelasticsearch_1 | [2014-11-22 17:43:57,223][INFO ][node                     ] [Eros] initializing ...\nelasticsearch_1 | [2014-11-22 17:43:57,228][INFO ][plugins                  ] [Eros] loaded [], sites []\nweb_1           | httpd: Could not reliably determine the server's fully qualified domain name, using 172.17.0.198 for ServerName\nkibana_1        | httpd: Could not reliably determine the server's fully qualified domain name, using 172.17.0.200 for ServerName\nweb_1           | Starting httpd: [  OK  ]\nkibana_1        | Starting httpd: [  OK  ]\nweb_1           | Starting td-agent: [  OK  ]\n\n(...snip...)\n\n\u305d\u308c\u305e\u308c\u306e\u30b3\u30f3\u30c6\u30ca\u306e\u51fa\u529b\u304c\u6a19\u6e96\u51fa\u529b\u306b\u5410\u304b\u308c\u308b\u3002\n\n\u52d5\u4f5c\u78ba\u8a8d\nboot2docker \u3092\u4f7f\u7528\u3057\u3066\u3044\u308b\u306e\u3067\u3001VM\u306eIP\u30a2\u30c9\u30ec\u30b9\u3092\u78ba\u8a8d\u3057\u3066\u304a\u304f\u3002\n% boot2docker ip\n\nThe VM's Host only interface IP address is: 192.168.XX.YYY\n\n\n\u305d\u308c\u305e\u308c\u306e\u30b3\u30f3\u30c6\u30ca\u3078\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u308b\u3002\nElasticsearch \u30b3\u30f3\u30c6\u30ca\uff1a\n% curl -s \"http://192.168.XX.YYY:9200/\"\n{\n  \"status\" : 200,\n  \"name\" : \"Eros\",\n  \"cluster_name\" : \"elasticsearch\",\n  \"version\" : {\n    \"number\" : \"1.4.0\",\n    \"build_hash\" : \"bc94bd81298f81c656893ab1ddddd30a99356066\",\n    \"build_timestamp\" : \"2014-11-05T14:26:12Z\",\n    \"build_snapshot\" : false,\n    \"lucene_version\" : \"4.10.2\"\n  },\n  \"tagline\" : \"You Know, for Search\"\n}\n\nweb \u30b3\u30f3\u30c6\u30ca\uff1a\n% curl -s -I \"http://192.168.XX.YYY:10080/\"\nHTTP/1.1 403 Forbidden\nDate: Sat, 22 Nov 2014 17:52:14 GMT\nServer: Apache/2.2.15 (CentOS)\nAccept-Ranges: bytes\nContent-Length: 4954\nConnection: close\nContent-Type: text/html; charset=UTF-8\n\nkibana \u30b3\u30f3\u30c6\u30ca\uff1a\n% curl -s -I \"http://192.168.XX.YYY:50080/kibana/\"\nHTTP/1.1 200 OK\nDate: Sat, 22 Nov 2014 17:53:52 GMT\nServer: Apache/2.2.15 (CentOS)\nLast-Modified: Fri, 07 Nov 2014 15:15:25 GMT\nETag: \"cb-819-507464842dd40\"\nAccept-Ranges: bytes\nContent-Length: 2073\nConnection: close\nContent-Type: text/html; charset=UTF-8\n\n\u305d\u308c\u305e\u308c\u52d5\u4f5c\u3057\u3066\u3044\u308b\u3088\u3046\u3060\u3002\n\u307e\u305fweb\u30d6\u30e9\u30a6\u30b6\u304b\u3089 http://192.168.XX.YYY:50080/kibana/ \u3078\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001 Kibana \u306e\u753b\u9762\u304c\u304d\u3061\u3093\u3068\u8868\u793a\u3055\u308c\u305f\u3002 Elasticsearch \u3068\u306e\u9023\u643a\u304c\u3046\u307e\u304f\u3044\u3063\u3066\u3044\u306a\u3044\u3068\u3001\u30a8\u30e9\u30fc\u753b\u9762\u304c\u8868\u793a\u3055\u308c\u308b\u3002\n\n\u307e\u3068\u3081\n\u8907\u6570\u306e Dockerfile \u3092\u7d44\u307f\u5408\u308f\u305b\u3066\u4f7f\u3046\u5834\u5408\u306b fig \u306f\u3068\u3066\u3082\u4fbf\u5229\u3002\u30b3\u30f3\u30c6\u30ca\u306e\u9023\u643a\u304c\u3057\u3084\u3059\u304f\u306a\u308b\u306e\u3067\u3001\u3067\u304d\u308b\u3060\u3051\u30b3\u30f3\u30c6\u30ca\u306e\u5f79\u5272\u3092\u5206\u3051\u30661\u30641\u3064\u306e\u30b3\u30f3\u30c6\u30ca\u306e\u5f79\u5272\u3092\u660e\u78ba\u306b\u3057\u3066\u3044\u304d\u305f\u3044\u3002\n\u524d\u304b\u3089\u6c17\u306b\u306a\u3063\u3066\u305f\u30c4\u30fc\u30eb\u3092\u8a66\u3059\u30b7\u30ea\u30fc\u30ba\u305d\u306e2\u3002\n\n\u4eca\u56de\u306f\u3001\u8907\u6570\u306eDocker\u30b3\u30f3\u30c6\u30ca\u3092\u7ba1\u7406\u3059\u308b [fig](http://www.fig.sh/index.html) \u304c\u3069\u3093\u306a\u3082\u306e\u306a\u306e\u304b\u8a66\u3059\u305f\u3081\u306b\u3001\u3053\u308c\u307e\u305f\u6c17\u306b\u306a\u3063\u3066\u305f [fluentd](http://www.fluentd.org/) \u3001 [Elasticsearch](http://www.elasticsearch.org/overview/elasticsearch/) \u3001 [Kibana](http://www.elasticsearch.org/overview/kibana/) \u3092\u8a66\u3059\u305f\u3081\u306e\u74b0\u5883\u3092 fig \u3092\u4f7f\u3063\u3066\u69cb\u7bc9\u3057\u3066\u307f\u305f\u3002\u304c\u3001\u74b0\u5883\u69cb\u7bc9\u3067\u6e80\u8db3\u3057\u3066 fluentd \u3084 Kibana \u306e\u4f7f\u7528\u611f\u306f\u307e\u3060\u78ba\u8a8d\u3067\u304d\u3066\u306a\u3044\u3002\u3061\u3087\u3063\u3068\u6b32\u5f35\u308a\u3059\u304e\u305f\u304b\u306a\u3002\u3002\u3002\n\n\u306a\u304a\u3001\u74b0\u5883\u306f Mac OS X Mavericks + boot2docker\u3002\n\n## fig \u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n\u624b\u3063\u53d6\u308a\u65e9\u304f [Homebrew](http://brew.sh/) \u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3002\n\n```console\n% brew install fig\n% fig --version\nfig 1.0.1\n```\n\n\u3061\u306a\u307f\u306b Docker \u306e\u74b0\u5883\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3002\n\n```console\n% docker version\nClient version: 1.3.0\nClient API version: 1.15\nGo version (client): go1.3.3\nGit commit (client): c78088f\nOS/Arch (client): darwin/amd64\nServer version: 1.3.0\nServer API version: 1.15\nGo version (server): go1.3.3\nGit commit (server): c78088f\n```\n\n## \u69cb\u6210\n\n\u4eca\u56de\u306f fig \u3092\u4f7f\u3063\u3066\u4ee5\u4e0b\u306e3\u3064\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u4f5c\u6210\u3057\u3066\u9023\u643a\u3055\u305b\u308b\u3002\n\n* \u30b3\u30f3\u30c6\u30ca\u540d\uff1a **web**\n  - Apache\n  - fluentd\n* \u30b3\u30f3\u30c6\u30ca\u540d\uff1a **elasticsearch**\n  - Elasticsearch\n* \u30b3\u30f3\u30c6\u30ca\u540d\uff1a **kibana**\n  - Apache\n  - Kibana\n\nweb\u30b3\u30f3\u30c6\u30ca\u304c\u30d5\u30ed\u30f3\u30c8\u30a8\u30f3\u30c9\u306e\u30b5\u30fc\u30d0\u3068\u3044\u3046\u60f3\u5b9a\u3002\u3053\u306e\u30b5\u30fc\u30d0\u306e\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u3092 fluentd \u3092\u4f7f\u3063\u3066 Elasticsearch \u3078\u9001\u308a Kibana \u3067\u53ef\u8996\u5316\u3059\u308b\u3002\n\n\u5b9f\u969b\u306b\u30d7\u30ed\u30c0\u30af\u30c8\u3067\u4f7f\u7528\u3059\u308b\u969b\u306f\u3044\u304d\u306a\u308a Elasticsearch \u3078\u8ee2\u9001\u3059\u308b\u306e\u3067\u306f\u306a\u304f\u3001\u9593\u306b\u96c6\u7d04\u3059\u308b fluentd \u3092\u5165\u308c\u308b\u69cb\u6210\u306b\u3059\u308b\u306e\u304c\u3044\u3044\u3089\u3057\u3044\u3002\n\n## Dockerfile\n\n\u305d\u308c\u305e\u308c\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u4f5c\u308b\u305f\u3081\u306e Dockerfile \u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u4f5c\u6210\u3057\u305f\u3002\n\u3044\u305a\u308c\u3082 CentOS 6 \u3092\u30d9\u30fc\u30b9\u306b\u3057\u3066\u3044\u308b\u3002\n\n### web \u30b3\u30f3\u30c6\u30ca\n\n\nfluentd \u306f\u516c\u5f0f\u306e [\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](http://docs.fluentd.org/articles/install-by-rpm \"Installing Fluentd Using rpm Package\") \u306e\u901a\u308a\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n\n\u304c\u3001yum \u3067 Apache \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3068 ``/var/log/httpd`` \u304c ``root:root`` \u3067\u4f5c\u3089\u308c\u308b\u306e\u3060\u304c\u3001\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u3092\u5909\u3048\u3066\u3082\u306a\u305c\u304b td-agent \u30e6\u30fc\u30b6\u30fc\u304b\u3089\u53c2\u7167\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u306a\u304b\u3063\u305f\u3002\u8272\u3005\u8a66\u3057\u3066\u3082\u3088\u304f\u308f\u304b\u3089\u306a\u304b\u3063\u305f\u306e\u3067\u3001 [\u3053\u3061\u3089](http://qiita.com/mitzi2funk/items/8ef7e3c2707124adc739#2-5 \"\u8077\u5834\u3067\u3088\u304f\u8033\u306b\u3059\u308bfluentd\u3092\u8a66\u3057\u3066\u307f\u307e\u3057\u305f\") \u3092\u53c2\u8003\u306b root \u3067\u8d77\u52d5\u3059\u308b\u3088\u3046\u306b\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u66f8\u304d\u63db\u3048\u305f\u3002\n\nfluentd \u306b\u306f Elasticsearch \u7528\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u3082\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3002\u4f9d\u5b58\u3059\u308b ``libcurl-devel`` \u3068 ``gcc`` \u306f yum \u3067\u5165\u308c\u3066\u304a\u304f\u3002\n\n```text:web/Dockerfile\nFROM centos:centos6\n\n# Install core modules\nRUN yum update -y &&\\\n    yum install -y sudo tar &&\\\n    yum clean -y all\n\n# Edit sudoers file\nRUN sed -i -e \"s/Defaults    requiretty.*/ #Defaults    requiretty/g\" /etc/sudoers\n\n# Install fluentd\nRUN curl -L http://toolbelt.treasuredata.com/sh/install-redhat-td-agent2.sh | sh\nRUN sed -i -e \"s/--user td-agent/--user root/g\" /etc/init.d/td-agent &&\\\n    sed -i -e \"s/--group td-agent/--user root --group td-agent/g\" /etc/init.d/td-agent\nRUN ulimit -n 65536\nCOPY td-agent.conf /etc/td-agent/td-agent.conf\n\n# Install Fluent::Plugin::Elasticsearch\nRUN yum install -y libcurl-devel gcc &&\\\n    yum clean -y all\nRUN /opt/td-agent/embedded/bin/gem install fluent-plugin-elasticsearch\n\n# Install httpd\nRUN yum install -y httpd &&\\\n    yum clean -y all\n\nCOPY run.sh /tmp/\nEXPOSE 80\nENTRYPOINT [\"/bin/bash\", \"/tmp/run.sh\"]\n```\n\nApache \u3068 fluentd \u306e\u4e21\u65b9\u306e\u30b5\u30fc\u30d3\u30b9\u3092\u8d77\u52d5\u3055\u305b\u308b\u305f\u3081\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30b7\u30a7\u30eb\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u4f5c\u6210\u3057\u3066\u30d7\u30ed\u30bb\u30b9\u304c\u30d5\u30a9\u30a2\u30b0\u30e9\u30a6\u30f3\u30c9\u3067\u52d5\u304d\u7d9a\u3051\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u308b\u3002\n\n```bash:web/run.sh\n#!/bin/bash\n\nservice httpd start\nservice td-agent start\n\ntail -f /var/log/td-agent/td-agent.log\n```\n\nfluentd \u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3067\u3042\u308b ``td-agent.conf`` \u306f\u3001\u3068\u308a\u3042\u3048\u305a\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u4f5c\u3063\u3066\u307f\u305f\u3002\n\n```aconf:web/td-agent.conf\n<source>\n  type tail\n  path /var/log/httpd/access_log\n  tag apache.web\n  pos_file /var/log/td-agent/httpd-access.log.pos\n  format apache2\n</source>\n\n<match apache.**>\n  type copy\n\n  <store>\n    type stdout\n  </store>\n\n  <store>\n    type elasticsearch\n    host elasticsearch\n    port 9200\n  </store>\n\n</match>\n```\n\n### elasticsearch \u30b3\u30f3\u30c6\u30ca\n\n``java`` \u3068 ``which`` \u304c\u5fc5\u8981\u306a\u306e\u3067\u3001\u4e8b\u524d\u306b yum \u3067\u5165\u308c\u3066\u304a\u304f\u3002\u307e\u305f\u74b0\u5883\u5909\u6570 ``JAVA_HOME`` \u3092\u8a2d\u5b9a\u3057\u3001 ``PATH`` \u3082\u901a\u3057\u3066\u304a\u304f\u3002\n\nElasticsearch \u3082 [\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/_installation.html \"Install\") \u306e\u901a\u308a\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5148\u306f ``/opt/elasticsearch`` \u3068\u3057\u305f\u3002\n\n\u30af\u30ed\u30b9\u30c9\u30e1\u30a4\u30f3\u5bfe\u7b56\u306e\u305f\u3081\u3001 ``elasticsearch.yml`` \u306b\u8a2d\u5b9a\u3092\u8ffd\u52a0\u3057\u3066\u3044\u308b\u3002\n\n```text:elasticsearch/Dockerfile\nFROM centos:centos6\n\n# Install core modules\nRUN yum update -y &&\\\n    yum install -y java-1.7.0-openjdk sudo tar which &&\\\n    yum clean -y all\n\n# Edit sudoers file\nRUN sed -i -e \"s/Defaults    requiretty.*/ #Defaults    requiretty/g\" /etc/sudoers\n\n# Set JAVA_HOME\nENV JAVA_HOME /usr/lib/jvm/java-1.7.0-openjdk.x86_64\nENV PATH $JAVA_HOME/bin:$PATH\n\n# Install elasticsearch\nENV ES_PKG_NAME elasticsearch-1.4.0\nADD https://download.elasticsearch.org/elasticsearch/elasticsearch/$ES_PKG_NAME.tar.gz /tmp/$ES_PKG_NAME.tar.gz\nRUN cd /tmp &&\\\n    tar xzvf $ES_PKG_NAME.tar.gz &&\\\n    mv $ES_PKG_NAME /opt/elasticsearch &&\\\n    rm -f $ES_PKG_NAME.tar.gz\nRUN echo 'http.cors.enabled: true' >> /opt/elasticsearch/config/elasticsearch.yml &&\\\n    echo 'http.cors.allow-origin: \"/.*/\"' >> /opt/elasticsearch/config/elasticsearch.yml\n\nEXPOSE 9200\nEXPOSE 9300\n\nENTRYPOINT [\"/opt/elasticsearch/bin/elasticsearch\"]\n```\n\n### kibana \u30b3\u30f3\u30c6\u30ca\n\nKibana 3 \u306f\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066 Apache \u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u30eb\u30fc\u30c8\u4ee5\u4e0b\u306b\u7a81\u3063\u8fbc\u3080\u3060\u3051\u3067\u4f7f\u3048\u308b\u3088\u3046\u306b\u306a\u308b\uff08 Kibana 4 \u304b\u3089\u306f\u3061\u3087\u3063\u3068\u69cb\u6210\u304c\u5909\u308f\u308b\u3089\u3057\u3044\uff09\u3002\u7c21\u5358\u3002\u4eca\u56de\u306f ``/var/www/html/kibana`` \u3078\u914d\u7f6e\u3057\u305f\u3002\n\n```text:kibana/Dockerfile\nFROM centos:centos6\n\n# Install core modules\nRUN yum update -y &&\\\n    yum install -y sudo tar &&\\\n    yum clean -y all\n\n# Edit sudoers file\nRUN sed -i -e \"s/Defaults    requiretty.*/ #Defaults    requiretty/g\" /etc/sudoers\n\n# Install httpd\nRUN yum install -y httpd &&\\\n    yum clean -y all\n\n# Install kibana\nENV KIBANA_PKG_NAME kibana-3.1.2\nADD https://download.elasticsearch.org/kibana/kibana/$KIBANA_PKG_NAME.tar.gz /tmp/$KIBANA_PKG_NAME.tar.gz\nRUN cd /var/www/html &&\\\n    tar xzvf /tmp/$KIBANA_PKG_NAME.tar.gz &&\\\n    mv $KIBANA_PKG_NAME kibana\n\nCOPY run.sh /tmp/run.sh\n\nEXPOSE 80\nENTRYPOINT [\"/bin/bash\", \"/tmp/run.sh\"]\n```\n\n\u4e00\u5fdc web \u30b3\u30f3\u30c6\u30ca\u3068\u540c\u69d8\u306b\u30b7\u30a7\u30eb\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u7528\u610f\u3057\u305f\u304c\u3001\u52d5\u304b\u3059\u30b5\u30fc\u30d3\u30b9\u306f1\u3064\u3060\u3051\u306a\u306e\u3067\u76f4\u63a5 Apache \u3092\u8d77\u52d5\u3057\u3066\u3082\u69cb\u308f\u306a\u3044\u3002\n\n```bash:kibana/run.sh\n#!/bin/bash\n\nservice httpd start\n\ntail -f /var/log/httpd/access_log\n```\n\n## fig.yml\n\nDockerfile \u304c\u3067\u304d\u305f\u306e\u3067\u3001\u6b21\u306b fig \u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\u8a2d\u5b9a\u306f YAML \u3067\u66f8\u304f\u3002 [\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9](http://www.fig.sh/yml.html \"fig.yml reference\") \u3092\u53c2\u8003\u306b\u3057\u3066\u4ee5\u4e0b\u306e\u3088\u3046\u306a ``fig.yml`` \u3092\u4f5c\u6210\u3057\u305f\u3002\n\n```yaml:fig.yml\n---\nelasticsearch:\n  build: elasticsearch\n  ports:\n    - \"9200:9200\"\n    - \"9300:9300\"\nkibana:\n  build: kibana\n  ports:\n    - \"50080:80\"\n  links:\n    - elasticsearch\nweb:\n  build: web\n  ports:\n    - \"10080:80\"\n    - \"18888:8888\"\n  links:\n    - elasticsearch\n```\n\n``build`` \u3067 Dockerfile \u306e\u3042\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u6307\u5b9a\u3059\u308b\u3002\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u3059\u308b\u30dd\u30fc\u30c8\u306f ``ports`` \u3067\u3001\u30ea\u30f3\u30af\u3057\u305f\u3044\u30b3\u30f3\u30c6\u30ca\u306f ``links`` \u3067\u305d\u308c\u305e\u308c\u6307\u5b9a\u3067\u304d\u308b\u3002 fig \u3092\u4f7f\u308f\u306a\u3044\u3067\u8d77\u52d5\u3057\u3088\u3046\u3068\u3059\u308b\u3068\u3001 ``docker run`` \u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u306b\u81ea\u5206\u3067\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u304c\u3001 fig \u306a\u3089\u7c21\u5358\u306b\u8a2d\u5b9a\u3067\u304d\u3066Good\u3002\n\n## \u30b3\u30f3\u30c6\u30ca\u306e\u8d77\u52d5\n\nDockerfile \u3092\u30d3\u30eb\u30c9\u3057\u3066\u30a4\u30e1\u30fc\u30b8\u3092\u4f5c\u308b\u3002\n\n```console\n% fig build\nBuilding elasticsearch...\n ---> 70441cac1ed5\nStep 1 : RUN yum update -y &&    yum install -y java-1.7.0-openjdk sudo tar which &&    yum clean -y all\n\n(...snip...)\n\nSuccessfully built c9747896561b\n```\n\n\u3053\u308c\u3060\u3051\u3067\u3059\u3079\u3066\u306e Dockerfile \u304c\u30d3\u30eb\u30c9\u3055\u308c\u308b\u3002\u4fbf\u5229\u3002\n\n\u305d\u3057\u3066\u8d77\u52d5\u3002\u3053\u3061\u3089\u3082\u7c21\u5358\u4e00\u767a\u3002\n\n```console\n% fig up\nRecreating fluentdsample_elasticsearch_1...\nRecreating fluentdsample_web_1...\nRecreating fluentdsample_kibana_1...\nAttaching to fluentdsample_elasticsearch_1, fluentdsample_web_1, fluentdsample_kibana_1\nelasticsearch_1 | [2014-11-22 17:43:57,222][INFO ][node                     ] [Eros] version[1.4.0], pid[1], build[bc94bd8/2014-11-05T14:26:12Z]\nelasticsearch_1 | [2014-11-22 17:43:57,223][INFO ][node                     ] [Eros] initializing ...\nelasticsearch_1 | [2014-11-22 17:43:57,228][INFO ][plugins                  ] [Eros] loaded [], sites []\nweb_1           | httpd: Could not reliably determine the server's fully qualified domain name, using 172.17.0.198 for ServerName\nkibana_1        | httpd: Could not reliably determine the server's fully qualified domain name, using 172.17.0.200 for ServerName\nweb_1           | Starting httpd: [  OK  ]\nkibana_1        | Starting httpd: [  OK  ]\nweb_1           | Starting td-agent: [  OK  ]\n\n(...snip...)\n```\n\n\u305d\u308c\u305e\u308c\u306e\u30b3\u30f3\u30c6\u30ca\u306e\u51fa\u529b\u304c\u6a19\u6e96\u51fa\u529b\u306b\u5410\u304b\u308c\u308b\u3002\n\n## \u52d5\u4f5c\u78ba\u8a8d\n\nboot2docker \u3092\u4f7f\u7528\u3057\u3066\u3044\u308b\u306e\u3067\u3001VM\u306eIP\u30a2\u30c9\u30ec\u30b9\u3092\u78ba\u8a8d\u3057\u3066\u304a\u304f\u3002\n\n```console\n% boot2docker ip\n\nThe VM's Host only interface IP address is: 192.168.XX.YYY\n\n```\n\n\u305d\u308c\u305e\u308c\u306e\u30b3\u30f3\u30c6\u30ca\u3078\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u308b\u3002\n\nElasticsearch \u30b3\u30f3\u30c6\u30ca\uff1a\n\n```console\n% curl -s \"http://192.168.XX.YYY:9200/\"\n{\n  \"status\" : 200,\n  \"name\" : \"Eros\",\n  \"cluster_name\" : \"elasticsearch\",\n  \"version\" : {\n    \"number\" : \"1.4.0\",\n    \"build_hash\" : \"bc94bd81298f81c656893ab1ddddd30a99356066\",\n    \"build_timestamp\" : \"2014-11-05T14:26:12Z\",\n    \"build_snapshot\" : false,\n    \"lucene_version\" : \"4.10.2\"\n  },\n  \"tagline\" : \"You Know, for Search\"\n}\n```\n\nweb \u30b3\u30f3\u30c6\u30ca\uff1a\n\n```console\n% curl -s -I \"http://192.168.XX.YYY:10080/\"\nHTTP/1.1 403 Forbidden\nDate: Sat, 22 Nov 2014 17:52:14 GMT\nServer: Apache/2.2.15 (CentOS)\nAccept-Ranges: bytes\nContent-Length: 4954\nConnection: close\nContent-Type: text/html; charset=UTF-8\n```\n\nkibana \u30b3\u30f3\u30c6\u30ca\uff1a\n\n```console\n% curl -s -I \"http://192.168.XX.YYY:50080/kibana/\"\nHTTP/1.1 200 OK\nDate: Sat, 22 Nov 2014 17:53:52 GMT\nServer: Apache/2.2.15 (CentOS)\nLast-Modified: Fri, 07 Nov 2014 15:15:25 GMT\nETag: \"cb-819-507464842dd40\"\nAccept-Ranges: bytes\nContent-Length: 2073\nConnection: close\nContent-Type: text/html; charset=UTF-8\n```\n\n\u305d\u308c\u305e\u308c\u52d5\u4f5c\u3057\u3066\u3044\u308b\u3088\u3046\u3060\u3002\n\n\u307e\u305fweb\u30d6\u30e9\u30a6\u30b6\u304b\u3089 ``http://192.168.XX.YYY:50080/kibana/`` \u3078\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001 Kibana \u306e\u753b\u9762\u304c\u304d\u3061\u3093\u3068\u8868\u793a\u3055\u308c\u305f\u3002 Elasticsearch \u3068\u306e\u9023\u643a\u304c\u3046\u307e\u304f\u3044\u3063\u3066\u3044\u306a\u3044\u3068\u3001\u30a8\u30e9\u30fc\u753b\u9762\u304c\u8868\u793a\u3055\u308c\u308b\u3002\n\n## \u307e\u3068\u3081\n\n\u8907\u6570\u306e Dockerfile \u3092\u7d44\u307f\u5408\u308f\u305b\u3066\u4f7f\u3046\u5834\u5408\u306b fig \u306f\u3068\u3066\u3082\u4fbf\u5229\u3002\u30b3\u30f3\u30c6\u30ca\u306e\u9023\u643a\u304c\u3057\u3084\u3059\u304f\u306a\u308b\u306e\u3067\u3001\u3067\u304d\u308b\u3060\u3051\u30b3\u30f3\u30c6\u30ca\u306e\u5f79\u5272\u3092\u5206\u3051\u30661\u30641\u3064\u306e\u30b3\u30f3\u30c6\u30ca\u306e\u5f79\u5272\u3092\u660e\u78ba\u306b\u3057\u3066\u3044\u304d\u305f\u3044\u3002\n", "tags": ["docker1.3", "fig", "fluentd", "Elasticsearch", "kibana3"]}