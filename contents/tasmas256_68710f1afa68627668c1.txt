{"context": "Docker Compose \u3067 Rocketchat + mongodb + hubot + nginx \u306e\u74b0\u5883\u3092\u69cb\u7bc9\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n\u74b0\u5883\n\nCentOS Linux release 7.2.1511 (Core)\ndocker version 1.12.3, build 6b644ec\ndocker-compose version 1.9.0, build 2585387\n\u30d7\u30ed\u30ad\u30b7\u914d\u4e0b\u306e\u524d\u63d0\u306e\u8a2d\u5b9a\u3067\u3059\u3002\n\nDocker Compose\u306e\u74b0\u5883\u69cb\u7bc9\u306f\u4ee5\u4e0b\u3092\u53c2\u7167\u3002\nhttp://qiita.com/tasmas256/items/c659e0958ce7d766baf4\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n\u4f5c\u6210\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3067\u3059\u3002\nopt\n\u2514\u2500rocketchat\n    \u2502  docker-compose.yml\n    \u2502\n    \u2514\u2500dockerfiles\n        \u251c\u2500hubot-rocketchat\n        \u2502      Dockerfile\n        \u2502\n        \u2514\u2500nginx\n                Dockerfile\n                nginx.conf\n\nnginx\u3068hubot-rocketchat\u306f\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3057\u305f\u3044\u306e\u3067Dockerfile\u3067\u30d3\u30eb\u30c9\u3057\u305f\u3082\u306e\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\n\ndocker-compose.yml\n\ndocker-compose.yml\nnginx:\n  build: ./dockerfiles/nginx\n  links:\n    - rocketchat\n  ports:\n    - 80:80\n    - 443:443\n  restart: always\n\nrocketchat:\n  image: rocketchat/rocket.chat:latest\n  volumes:\n    - ./uploads:/app/uploads\n  environment:\n    - PORT=3000\n    - ROOT_URL=http://192.168.X.X\n    - MONGO_URL=mongodb://mongo:27017/rocketchat\n    - MONGO_OPLOG_URL=mongodb://mongo:27017/local\n    - MAIL_URL=smtp://192.168.X.X\n    - HTTP_PROXY=http://192.168.X.X:8080\n    - HTTPS_PROXY=http://192.168.X.X:8080\n  links:\n    - mongo:mongo\n  restart: always\n\nmongo:\n  image: mongo:3.2\n  volumes:\n    - ./data/db:/data/db\n  command: mongod --smallfiles --oplogSize 128 --replSet rs0\n  restart: always\n\nmongoinitreplica:\n  image: mongo:3.2\n  command: 'mongo mongo/rocketchat --eval \"rs.initiate({ _id: ''rs0'', members: [ { _id: 0, host: ''localhost:27017'' } ]})\"'\n  links:\n    - mongo:mongo\n\nhubot:\n  build: ./dockerfiles/hubot-rocketchat\n  environment:\n    - ROCKETCHAT_URL=rocketchat:3000\n    - ROCKETCHAT_ROOM=\n    - LISTEN_ON_ALL_PUBLIC=true\n    - ROCKETCHAT_USER=bot\n    - ROCKETCHAT_PASSWORD=manager\n    - BOT_NAME=bot\n    - EXTERNAL_SCRIPTS=hubot-help,hubot-seen,hubot-links,hubot-diagnostics,hubot-rss-reader\n    - HTTP_PROXY=http://192.168.X.X:8080\n    - HTTPS_PROXY=http://192.168.X.X:8080\n  links:\n    - rocketchat:rocketchat\n  volumes:\n    - ./scripts:/home/hubot/scripts\n  restart: always\n\n\n\nnginx\n\nDockerfile\nopenssl\u3067\u8a3c\u660e\u66f8\u3092\u4f5c\u6210\u3057\u3066\u3044\u307e\u3059\u3002\n\n/dockerfiles/nginx/Dockerfile\nFROM nginx:latest\nCOPY ./nginx.conf /etc/nginx/nginx.conf\nRUN  openssl req -x509 -nodes -days 3650 -newkey rsa:2048 -subj \"/CN=xxxx/O=xxxxx/C=JP\" -keyout /etc/nginx/certificate.key -out /etc/nginx/certificate.crt\nCMD  [\"nginx\", \"-g\", \"daemon off;\"]\n\n\n\nnginx.conf\nrocketchat\u3078\u9077\u79fb\u3055\u305b\u307e\u3059\u3002\n\ndockerfiles/nginx/nginx.conf\nuser nginx;\nworker_processes auto;\nerror_log /var/log/nginx/error.log;\npid /var/run/nginx.pid;\n\ninclude /usr/share/nginx/modules/*.conf;\n\nevents {\n    worker_connections 1024;\n}\n\nhttp {\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log  /var/log/nginx/access.log  main;\n\n    sendfile            on;\n    tcp_nopush          on;\n    tcp_nodelay         on;\n    keepalive_timeout   65;\n    types_hash_max_size 2048;\n\n    include             /etc/nginx/mime.types;\n    default_type        application/octet-stream;\n\n    include /etc/nginx/conf.d/*.conf;\n\n    index   index.html index.htm;\n\n    server {\n        listen       80;\n        server_name  192.168.X.X;\n        return 301 https://$host$request_uri;\n    }\n\n    server {\n        listen 443 ssl;\n        server_name 192.168.X.X;\n\n        error_log /var/log/nginx/rocketchat_error.log;\n\n        ssl_certificate /etc/nginx/certificate.crt;\n        ssl_certificate_key /etc/nginx/certificate.key;\n        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;\n        ssl_ciphers 'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA';\n        ssl_prefer_server_ciphers on;\n        ssl_session_cache shared:SSL:20m;\n        ssl_session_timeout 180m;\n\n        location / {\n            proxy_pass http://rocketchat:3000/;\n            proxy_http_version 1.1;\n            proxy_set_header Upgrade $http_upgrade;\n            proxy_set_header Connection \"upgrade\";\n            proxy_set_header Host $http_host;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forward-For $proxy_add_x_forwarded_for;\n            proxy_set_header X-Forward-Proto http;\n            proxy_set_header X-Nginx-Proxy true;\n            proxy_redirect off;\n        }\n    }\n}\n\n\n\nhubot-rocketchat\nhubot-rss-reader \u3092\u5165\u308c\u305f\u304b\u3063\u305f\u306e\u3067 coffee-script\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u3042\u3052\u3066\u3044\u307e\u3059\u3002\n\n/dockerfiles/hubot-rocketchat/Dockerfile\nFROM rocketchat/hubot-rocketchat\nENV http_proxy http://192.168.X.X:8080 \\ \n    https_proxy http://192.168.X.X:8080\nUSER root\nRUN npm install -g coffee-script@\">=1.10.0\" \n\n\n\nDocker Compose \u306e\u5b9f\u884c\ndocker-compose up -d --build\n\n\u3057\u3070\u3089\u304f\u5f85\u3064\u3068\u8d77\u52d5\u3057\u307e\u3059\u3002\nhubot\u306f\u53d6\u5f97\u307e\u3067\u3055\u3089\u306b\u6570\u5206\u6642\u9593\u304b\u304b\u308a\u307e\u3057\u305f\u3002\n\n\u53c2\u8003\u30b5\u30a4\u30c8\nhttps://github.com/RocketChat/Rocket.Chat.Docs/tree/master/3.%20Installation/3.%20Docker%20Containers\nDocker Compose \u3067 Rocketchat + mongodb + hubot + nginx \u306e\u74b0\u5883\u3092\u69cb\u7bc9\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n# \u74b0\u5883\n- CentOS Linux release 7.2.1511 (Core)\n- docker version 1.12.3, build 6b644ec\n- docker-compose version 1.9.0, build 2585387\n- \u30d7\u30ed\u30ad\u30b7\u914d\u4e0b\u306e\u524d\u63d0\u306e\u8a2d\u5b9a\u3067\u3059\u3002\n\nDocker Compose\u306e\u74b0\u5883\u69cb\u7bc9\u306f\u4ee5\u4e0b\u3092\u53c2\u7167\u3002\nhttp://qiita.com/tasmas256/items/c659e0958ce7d766baf4\n\n# \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n\n\u4f5c\u6210\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3067\u3059\u3002\n\n```\nopt\n\u2514\u2500rocketchat\n    \u2502  docker-compose.yml\n    \u2502\n    \u2514\u2500dockerfiles\n        \u251c\u2500hubot-rocketchat\n        \u2502      Dockerfile\n        \u2502\n        \u2514\u2500nginx\n                Dockerfile\n                nginx.conf\n```\n\nnginx\u3068hubot-rocketchat\u306f\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3057\u305f\u3044\u306e\u3067Dockerfile\u3067\u30d3\u30eb\u30c9\u3057\u305f\u3082\u306e\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\n\n## docker-compose.yml\n\n```docker-compose.yml\nnginx:\n  build: ./dockerfiles/nginx\n  links:\n    - rocketchat\n  ports:\n    - 80:80\n    - 443:443\n  restart: always\n\nrocketchat:\n  image: rocketchat/rocket.chat:latest\n  volumes:\n    - ./uploads:/app/uploads\n  environment:\n    - PORT=3000\n    - ROOT_URL=http://192.168.X.X\n    - MONGO_URL=mongodb://mongo:27017/rocketchat\n    - MONGO_OPLOG_URL=mongodb://mongo:27017/local\n    - MAIL_URL=smtp://192.168.X.X\n    - HTTP_PROXY=http://192.168.X.X:8080\n    - HTTPS_PROXY=http://192.168.X.X:8080\n  links:\n    - mongo:mongo\n  restart: always\n\nmongo:\n  image: mongo:3.2\n  volumes:\n    - ./data/db:/data/db\n  command: mongod --smallfiles --oplogSize 128 --replSet rs0\n  restart: always\n\nmongoinitreplica:\n  image: mongo:3.2\n  command: 'mongo mongo/rocketchat --eval \"rs.initiate({ _id: ''rs0'', members: [ { _id: 0, host: ''localhost:27017'' } ]})\"'\n  links:\n    - mongo:mongo\n\nhubot:\n  build: ./dockerfiles/hubot-rocketchat\n  environment:\n    - ROCKETCHAT_URL=rocketchat:3000\n    - ROCKETCHAT_ROOM=\n    - LISTEN_ON_ALL_PUBLIC=true\n    - ROCKETCHAT_USER=bot\n    - ROCKETCHAT_PASSWORD=manager\n    - BOT_NAME=bot\n    - EXTERNAL_SCRIPTS=hubot-help,hubot-seen,hubot-links,hubot-diagnostics,hubot-rss-reader\n    - HTTP_PROXY=http://192.168.X.X:8080\n    - HTTPS_PROXY=http://192.168.X.X:8080\n  links:\n    - rocketchat:rocketchat\n  volumes:\n    - ./scripts:/home/hubot/scripts\n  restart: always\n```\n\n## nginx\n\n### Dockerfile\n\nopenssl\u3067\u8a3c\u660e\u66f8\u3092\u4f5c\u6210\u3057\u3066\u3044\u307e\u3059\u3002\n\n```Dockerfile:/dockerfiles/nginx/Dockerfile\nFROM nginx:latest\nCOPY ./nginx.conf /etc/nginx/nginx.conf\nRUN  openssl req -x509 -nodes -days 3650 -newkey rsa:2048 -subj \"/CN=xxxx/O=xxxxx/C=JP\" -keyout /etc/nginx/certificate.key -out /etc/nginx/certificate.crt\nCMD  [\"nginx\", \"-g\", \"daemon off;\"]\n```\n\n### nginx.conf\n\nrocketchat\u3078\u9077\u79fb\u3055\u305b\u307e\u3059\u3002\n\n```dockerfiles/nginx/nginx.conf\nuser nginx;\nworker_processes auto;\nerror_log /var/log/nginx/error.log;\npid /var/run/nginx.pid;\n\ninclude /usr/share/nginx/modules/*.conf;\n\nevents {\n    worker_connections 1024;\n}\n\nhttp {\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log  /var/log/nginx/access.log  main;\n\n    sendfile            on;\n    tcp_nopush          on;\n    tcp_nodelay         on;\n    keepalive_timeout   65;\n    types_hash_max_size 2048;\n\n    include             /etc/nginx/mime.types;\n    default_type        application/octet-stream;\n\n    include /etc/nginx/conf.d/*.conf;\n\n    index   index.html index.htm;\n\n    server {\n        listen       80;\n        server_name  192.168.X.X;\n        return 301 https://$host$request_uri;\n    }\n\n    server {\n        listen 443 ssl;\n        server_name 192.168.X.X;\n\n        error_log /var/log/nginx/rocketchat_error.log;\n\n        ssl_certificate /etc/nginx/certificate.crt;\n        ssl_certificate_key /etc/nginx/certificate.key;\n        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;\n        ssl_ciphers 'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA';\n        ssl_prefer_server_ciphers on;\n        ssl_session_cache shared:SSL:20m;\n        ssl_session_timeout 180m;\n\n        location / {\n            proxy_pass http://rocketchat:3000/;\n            proxy_http_version 1.1;\n            proxy_set_header Upgrade $http_upgrade;\n            proxy_set_header Connection \"upgrade\";\n            proxy_set_header Host $http_host;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forward-For $proxy_add_x_forwarded_for;\n            proxy_set_header X-Forward-Proto http;\n            proxy_set_header X-Nginx-Proxy true;\n            proxy_redirect off;\n        }\n    }\n}\n```\n\n## hubot-rocketchat\n\nhubot-rss-reader \u3092\u5165\u308c\u305f\u304b\u3063\u305f\u306e\u3067 coffee-script\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u3042\u3052\u3066\u3044\u307e\u3059\u3002\n\n```Dockerfile:/dockerfiles/hubot-rocketchat/Dockerfile\nFROM rocketchat/hubot-rocketchat\nENV http_proxy http://192.168.X.X:8080 \\ \n    https_proxy http://192.168.X.X:8080\nUSER root\nRUN npm install -g coffee-script@\">=1.10.0\" \n```\n\n# Docker Compose \u306e\u5b9f\u884c\n\n```bash\ndocker-compose up -d --build\n```\n\n\u3057\u3070\u3089\u304f\u5f85\u3064\u3068\u8d77\u52d5\u3057\u307e\u3059\u3002\nhubot\u306f\u53d6\u5f97\u307e\u3067\u3055\u3089\u306b\u6570\u5206\u6642\u9593\u304b\u304b\u308a\u307e\u3057\u305f\u3002\n\n# \u53c2\u8003\u30b5\u30a4\u30c8\n\nhttps://github.com/RocketChat/Rocket.Chat.Docs/tree/master/3.%20Installation/3.%20Docker%20Containers\n", "tags": ["docker-compose", "rocketchat"]}