{"tags": ["Terraform", "GoogleCloudPlatform", "googlecomputeengine"], "context": "\n\n\u6982\u8981\nGCE \u3068 AWS \u9593\u3092 VPN \u63a5\u7d9a\u3059\u308b\u969b\u306b\u4f5c\u6210\u3057\u305f terraform \u306e\u30b3\u30fc\u30c9\u30e1\u30e2\n\n\u74b0\u5883\n\nterraform v0.6.14\n\n\n\u4f5c\u6210\u5185\u5bb9\n\n\nAWS\n\nVPC (172.31.0.0/16)\nsubnet (172.31.1.0/24)\nInternet Gateway\nCustomer Gateway\nVirtual Private Gateway\nVPN Connection\nRoute Table\n\n\n\nGCE\n\n\u9759\u7684\u30a2\u30c9\u30ec\u30b9\u53d6\u5f97\nVPN \u63a5\u7d9a\nRoute\n\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\n\n\n\n\nvpn.tf\nvariable \"aws_vpc_cidr_block\" {\n  default = \"172.31.0.0/16\"\n}\nvariable \"aws_zones\" {\n    default = {\n        zone0 = \"ap-northeast-1a\"\n        zone1 = \"ap-northeast-1c\"\n    }\n}\nvariable \"aws_public_cidr_blocks\" {\n    default = {\n        zone0 = \"172.31.1.0/24\"\n        zone1 = \"172.31.2.0/24\"\n    }\n}\nvariable \"aws_private_cidr_blocks\" {\n    default = {\n        zone0 = \"172.31.11.0/24\"\n        zone1 = \"172.31.12.0/24\"\n    }\n}\nvariable \"aws_public_cidr_count\" { default = 1 }\nvariable \"aws_private_cidr_count\" { default = 0 }\n\nresource \"google_compute_address\" \"vpn\" {\n  name = \"gateway-to-aws\"\n  region = \"${var.region}\"\n}\n\nresource \"aws_vpc\" \"default\" {\n  cidr_block = \"${var.aws_vpc_cidr_block}\"\n  enable_dns_hostnames = true\n\n  tags {\n    Name = \"${var.aws_id}\"\n  }\n}\n\nresource \"aws_internet_gateway\" \"default\" {\n  vpc_id = \"${aws_vpc.default.id}\"\n  tags {\n    Name = \"${var.aws_id}\"\n  }\n}\n\nresource \"aws_subnet\" \"public\" {\n  vpc_id = \"${aws_vpc.default.id}\"\n  cidr_block = \"${lookup(var.aws_public_cidr_blocks, concat(\"zone\", count.index))}\"\n  availability_zone = \"${lookup(var.aws_zones, concat(\"zone\", count.index))}\"\n  map_public_ip_on_launch = true\n  count = \"${var.aws_public_cidr_count}\"\n  tags {\n    Name = \"${var.aws_id}\"\n  }\n}\n\nresource \"aws_subnet\" \"private\" {\n  vpc_id = \"${aws_vpc.default.id}\"\n  cidr_block = \"${lookup(var.aws_public_cidr_blocks, concat(\"zone\", count.index))}\"\n  availability_zone = \"${lookup(var.aws_zones, concat(\"zone\", count.index))}\"\n  map_public_ip_on_launch = true\n  count = \"${var.aws_private_cidr_count}\"\n  tags {\n    Name = \"${var.aws_id}\"\n  }\n}\n\nresource \"aws_route_table\" \"default\" {\n  vpc_id = \"${aws_vpc.default.id}\"\n  propagating_vgws = [\"${aws_vpn_gateway.default.id}\"]\n  route {\n      cidr_block = \"0.0.0.0/0\"\n      gateway_id = \"${aws_internet_gateway.default.id}\"\n  }\n  tags {\n      Name = \"${var.aws_id}\"\n  }\n}\n\nresource \"aws_route_table_association\" \"public\" {\n  subnet_id = \"${element(aws_subnet.public.*.id, count.index)}\"\n  route_table_id = \"${aws_route_table.default.id}\"\n  count = \"${var.aws_public_cidr_count}\"\n}\n\nresource \"aws_route_table_association\" \"private\" {\n  subnet_id = \"${element(aws_subnet.private.*.id, count.index)}\"\n  route_table_id = \"${aws_route_table.default.id}\"\n  count = \"${var.aws_private_cidr_count}\"\n}\n\nresource \"aws_customer_gateway\" \"default\" {\n  ip_address = \"${google_compute_address.vpn.address}\"\n  bgp_asn = \"65000\"\n  type = \"ipsec.1\"\n  tags {\n    Name = \"Gateway Into GCE\"\n  }\n  depends_on = [ \"google_compute_address.vpn\" ]\n}\n\nresource \"aws_vpn_gateway\" \"default\" {\n  vpc_id = \"${aws_vpc.default.id}\"\n  tags {\n    Name = \"Gateway to GCE\"\n  }\n}\n\nresource \"aws_vpn_connection\" \"default\" {\n  vpn_gateway_id = \"${aws_vpn_gateway.default.id}\"\n  customer_gateway_id = \"${aws_customer_gateway.default.id}\"\n  type = \"ipsec.1\"\n  static_routes_only = true\n  tags {\n    Name = \"VPN to GCE\"\n  }\n}\n\nresource \"google_compute_vpn_gateway\" \"default\" {\n  name = \"vpn-to-aws\"\n  network = \"https://www.googleapis.com/compute/v1/projects/${var.project}/global/networks/${var.network}\"\n  region = \"${var.region}\"\n}\n\nresource \"google_compute_forwarding_rule\" \"esp\" {\n  name = \"vpn-to-aws-rule-esp\"\n  region = \"${var.region}\"\n  ip_protocol = \"ESP\"\n  ip_address = \"${google_compute_address.vpn.address}\"\n  target = \"${google_compute_vpn_gateway.default.self_link}\"\n}\n\nresource \"google_compute_forwarding_rule\" \"udp500\" {\n  name = \"vpn-to-aws-rule-udp500\"\n  region = \"${var.region}\"\n  ip_protocol = \"UDP\"\n  port_range = \"500\"\n  ip_address = \"${google_compute_address.vpn.address}\"\n  target = \"${google_compute_vpn_gateway.default.self_link}\"\n}\n\nresource \"google_compute_forwarding_rule\" \"udp4500\" {\n  name = \"vpn-to-aws-rule-udp4500\"\n  region = \"${var.region}\"\n  ip_protocol = \"UDP\"\n  port_range = \"4500\"\n  ip_address = \"${google_compute_address.vpn.address}\"\n  target = \"${google_compute_vpn_gateway.default.self_link}\"\n}\n\nresource \"google_compute_vpn_tunnel\" \"tunnel1\" {\n  name = \"vpn-to-aws-tunnel-1\"\n  region = \"${var.region}\"\n  peer_ip = \"${aws_vpn_connection.default.tunnel1_address}\"\n  shared_secret = \"${aws_vpn_connection.default.tunnel1_preshared_key}\"\n  ike_version = \"1\"\n  target_vpn_gateway = \"${google_compute_vpn_gateway.default.self_link}\"\n  depends_on = [\n    \"google_compute_forwarding_rule.esp\",\n    \"google_compute_forwarding_rule.udp500\",\n    \"google_compute_forwarding_rule.udp4500\"\n  ]\n}\n\nresource \"google_compute_route\" \"vpn\" {\n  name = \"gce-to-aws\"\n  network = \"${var.network}\"\n  next_hop_vpn_tunnel = \"${google_compute_vpn_tunnel.tunnel1.self_link}\"\n  dest_range = \"${var.aws_vpc_cidr_block}\"\n  priority = 1000\n}\n\nresource \"google_compute_firewall\" \"vpn\" {\n    name = \"allow-aws\"\n    network = \"${var.network}\"\n    source_ranges = [ \"${var.aws_vpc_cidr_block}\" ]\n\n    allow {\n        protocol = \"tcp\"\n        ports = [ \"0-65535\" ]\n    }\n\n    allow {\n        protocol = \"udp\"\n        ports = [ \"0-65535\" ]\n    }\n\n    allow {\n        protocol = \"icmp\"\n    }\n}\n\n\n\u63a5\u7d9a\u78ba\u8a8d\nGCE\n\nAWS\n\n# \u6982\u8981\n\nGCE \u3068 AWS \u9593\u3092 VPN \u63a5\u7d9a\u3059\u308b\u969b\u306b\u4f5c\u6210\u3057\u305f terraform \u306e\u30b3\u30fc\u30c9\u30e1\u30e2\n\n\n# \u74b0\u5883\n\n - terraform v0.6.14\n\n\n# \u4f5c\u6210\u5185\u5bb9\n\n- AWS\n   - VPC (172.31.0.0/16)\n   - subnet (172.31.1.0/24)\n   - Internet Gateway\n   - Customer Gateway\n   - Virtual Private Gateway\n   - VPN Connection\n   - Route Table\n \n- GCE\n   - \u9759\u7684\u30a2\u30c9\u30ec\u30b9\u53d6\u5f97\n   - VPN \u63a5\u7d9a\n   - Route\n   - \u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\n\n\n```HCL:vpn.tf\nvariable \"aws_vpc_cidr_block\" {\n  default = \"172.31.0.0/16\"\n}\nvariable \"aws_zones\" {\n    default = {\n        zone0 = \"ap-northeast-1a\"\n        zone1 = \"ap-northeast-1c\"\n    }\n}\nvariable \"aws_public_cidr_blocks\" {\n    default = {\n        zone0 = \"172.31.1.0/24\"\n        zone1 = \"172.31.2.0/24\"\n    }\n}\nvariable \"aws_private_cidr_blocks\" {\n    default = {\n        zone0 = \"172.31.11.0/24\"\n        zone1 = \"172.31.12.0/24\"\n    }\n}\nvariable \"aws_public_cidr_count\" { default = 1 }\nvariable \"aws_private_cidr_count\" { default = 0 }\n\nresource \"google_compute_address\" \"vpn\" {\n  name = \"gateway-to-aws\"\n  region = \"${var.region}\"\n}\n\nresource \"aws_vpc\" \"default\" {\n  cidr_block = \"${var.aws_vpc_cidr_block}\"\n  enable_dns_hostnames = true\n\n  tags {\n    Name = \"${var.aws_id}\"\n  }\n}\n\nresource \"aws_internet_gateway\" \"default\" {\n  vpc_id = \"${aws_vpc.default.id}\"\n  tags {\n    Name = \"${var.aws_id}\"\n  }\n}\n\nresource \"aws_subnet\" \"public\" {\n  vpc_id = \"${aws_vpc.default.id}\"\n  cidr_block = \"${lookup(var.aws_public_cidr_blocks, concat(\"zone\", count.index))}\"\n  availability_zone = \"${lookup(var.aws_zones, concat(\"zone\", count.index))}\"\n  map_public_ip_on_launch = true\n  count = \"${var.aws_public_cidr_count}\"\n  tags {\n    Name = \"${var.aws_id}\"\n  }\n}\n\nresource \"aws_subnet\" \"private\" {\n  vpc_id = \"${aws_vpc.default.id}\"\n  cidr_block = \"${lookup(var.aws_public_cidr_blocks, concat(\"zone\", count.index))}\"\n  availability_zone = \"${lookup(var.aws_zones, concat(\"zone\", count.index))}\"\n  map_public_ip_on_launch = true\n  count = \"${var.aws_private_cidr_count}\"\n  tags {\n    Name = \"${var.aws_id}\"\n  }\n}\n\nresource \"aws_route_table\" \"default\" {\n  vpc_id = \"${aws_vpc.default.id}\"\n  propagating_vgws = [\"${aws_vpn_gateway.default.id}\"]\n  route {\n      cidr_block = \"0.0.0.0/0\"\n      gateway_id = \"${aws_internet_gateway.default.id}\"\n  }\n  tags {\n      Name = \"${var.aws_id}\"\n  }\n}\n\nresource \"aws_route_table_association\" \"public\" {\n  subnet_id = \"${element(aws_subnet.public.*.id, count.index)}\"\n  route_table_id = \"${aws_route_table.default.id}\"\n  count = \"${var.aws_public_cidr_count}\"\n}\n\nresource \"aws_route_table_association\" \"private\" {\n  subnet_id = \"${element(aws_subnet.private.*.id, count.index)}\"\n  route_table_id = \"${aws_route_table.default.id}\"\n  count = \"${var.aws_private_cidr_count}\"\n}\n\nresource \"aws_customer_gateway\" \"default\" {\n  ip_address = \"${google_compute_address.vpn.address}\"\n  bgp_asn = \"65000\"\n  type = \"ipsec.1\"\n  tags {\n    Name = \"Gateway Into GCE\"\n  }\n  depends_on = [ \"google_compute_address.vpn\" ]\n}\n\nresource \"aws_vpn_gateway\" \"default\" {\n  vpc_id = \"${aws_vpc.default.id}\"\n  tags {\n    Name = \"Gateway to GCE\"\n  }\n}\n\nresource \"aws_vpn_connection\" \"default\" {\n  vpn_gateway_id = \"${aws_vpn_gateway.default.id}\"\n  customer_gateway_id = \"${aws_customer_gateway.default.id}\"\n  type = \"ipsec.1\"\n  static_routes_only = true\n  tags {\n    Name = \"VPN to GCE\"\n  }\n}\n\nresource \"google_compute_vpn_gateway\" \"default\" {\n  name = \"vpn-to-aws\"\n  network = \"https://www.googleapis.com/compute/v1/projects/${var.project}/global/networks/${var.network}\"\n  region = \"${var.region}\"\n}\n\nresource \"google_compute_forwarding_rule\" \"esp\" {\n  name = \"vpn-to-aws-rule-esp\"\n  region = \"${var.region}\"\n  ip_protocol = \"ESP\"\n  ip_address = \"${google_compute_address.vpn.address}\"\n  target = \"${google_compute_vpn_gateway.default.self_link}\"\n}\n\nresource \"google_compute_forwarding_rule\" \"udp500\" {\n  name = \"vpn-to-aws-rule-udp500\"\n  region = \"${var.region}\"\n  ip_protocol = \"UDP\"\n  port_range = \"500\"\n  ip_address = \"${google_compute_address.vpn.address}\"\n  target = \"${google_compute_vpn_gateway.default.self_link}\"\n}\n\nresource \"google_compute_forwarding_rule\" \"udp4500\" {\n  name = \"vpn-to-aws-rule-udp4500\"\n  region = \"${var.region}\"\n  ip_protocol = \"UDP\"\n  port_range = \"4500\"\n  ip_address = \"${google_compute_address.vpn.address}\"\n  target = \"${google_compute_vpn_gateway.default.self_link}\"\n}\n\nresource \"google_compute_vpn_tunnel\" \"tunnel1\" {\n  name = \"vpn-to-aws-tunnel-1\"\n  region = \"${var.region}\"\n  peer_ip = \"${aws_vpn_connection.default.tunnel1_address}\"\n  shared_secret = \"${aws_vpn_connection.default.tunnel1_preshared_key}\"\n  ike_version = \"1\"\n  target_vpn_gateway = \"${google_compute_vpn_gateway.default.self_link}\"\n  depends_on = [\n    \"google_compute_forwarding_rule.esp\",\n    \"google_compute_forwarding_rule.udp500\",\n    \"google_compute_forwarding_rule.udp4500\"\n  ]\n}\n\nresource \"google_compute_route\" \"vpn\" {\n  name = \"gce-to-aws\"\n  network = \"${var.network}\"\n  next_hop_vpn_tunnel = \"${google_compute_vpn_tunnel.tunnel1.self_link}\"\n  dest_range = \"${var.aws_vpc_cidr_block}\"\n  priority = 1000\n}\n\nresource \"google_compute_firewall\" \"vpn\" {\n    name = \"allow-aws\"\n    network = \"${var.network}\"\n    source_ranges = [ \"${var.aws_vpc_cidr_block}\" ]\n\n    allow {\n        protocol = \"tcp\"\n        ports = [ \"0-65535\" ]\n    }\n\n    allow {\n        protocol = \"udp\"\n        ports = [ \"0-65535\" ]\n    }\n\n    allow {\n        protocol = \"icmp\"\n    }\n}\n```\n\n**\u63a5\u7d9a\u78ba\u8a8d**\n\nGCE\n![01.png](https://qiita-image-store.s3.amazonaws.com/0/105824/c6a8bfab-1aec-8583-e4ab-dcb987487284.png)\n\n\nAWS\n![02.png](https://qiita-image-store.s3.amazonaws.com/0/105824/95f871a2-42e3-f869-a88b-e5ae91514176.png)\n\n"}