{"context": " More than 1 year has passed since last update.\n\nS3\u306e\u30dd\u30ea\u30b7\u30fc\u5909\u66f4\u30b9\u30af\u30ea\u30d7\u30c8\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u5897\u6e1b\u306b\u5408\u308f\u305b\u3066\u30d0\u30b1\u30c3\u30c8\u30dd\u30ea\u30b7\u30fc\u306e\u5909\u66f4\u3059\u308b\u306e\u304c\u9762\u5012\u306a\u306e\u3067\u81ea\u52d5\u5316\uff01\nsupported by sebastian\n\n\u5229\u7528\u4f8b\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u4ed8\u4e0e\u3055\u308c\u3066\u3044\u308b\u30bf\u30b0\u3092\u898b\u3066IP\u3092\u53d6\u5f97\u3059\u308b\u5bfe\u8c61\u3092\u5224\u65ad\u3057\u307e\u3059\u3002\n\u5bfe\u8c61\u306ePublicIP\u3092\u53d6\u5f97\u3057\u3066\u3001S3\u306e\u30d0\u30b1\u30c3\u30c8\u30dd\u30ea\u30b7\u30fc\u3092\u9069\u7528\u3057\u307e\u3059\u3002\n\u30dd\u30ea\u30b7\u30fc\u306f\u30b9\u30af\u30ea\u30d7\u30c8\u5185\u306b\u30d9\u30bf\u66f8\u304d\u3057\u3066\u307e\u3059\u3002\nbash s3_bucket_policy.sh -t tagkey -r rolename -b bucket\n\n\n\u30b9\u30af\u30ea\u30d7\u30c8\n\nbash\n#!/bin/sh\n# -----------------------------------------------------------------------------\n# AWS CLI\u306e\u78ba\u8a8d\n#\n# retval 0 OK\n# retval 1 \u30d1\u30b9\u304c\u901a\u3063\u3066\u3044\u306a\u3044\u306e\u3067\u30d1\u30b9\u3092\u901a\u3057\u305f\n# retval 2 \u898b\u3064\u304b\u3089\u306a\u304b\u3063\u305f\n# -----------------------------------------------------------------------------\nfunction checkcli() {\n    aws --version &> /dev/null\n    if [ $? -eq 127 ] ; then\n        awspath=$(which aws)\n        if [ ! $? -eq 0 ]; then\n            echo 'aws-cli\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093'\n            exit 2\n        else\n            addpath=$(echo $awspath |  sed -e 's/aws//g')\n            PATH=\"$PATH\":$addpath\n            exit 1\n        fi\n    fi\n    exit 0\n}\n# -----------------------------------------------------------------------------\n# \u5b9f\u884c\u3057\u3066\u3044\u308b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u60c5\u5831\u306e\u53d6\u5f97\n#\n# retstd PublicIp \u73fe\u5728\u51e6\u7406\u3092\u884c\u3063\u3066\u3044\u308b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306ePublicIp\u3092\u8fd4\u3059\n# retval \u6b63\u5e38\u7d42\u4e86\n# retval 10 \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4e0a\u3067\u5b9f\u884c\u3055\u308c\u3066\u3044\u306a\u3044\n# retval 11 \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30ea\u30fc\u30b8\u30e7\u30f3\u53d6\u5f97\u5931\u6557\n# -----------------------------------------------------------------------------\nfunction getregion() {\n    # \u30e1\u30bf\u30c7\u30fc\u30bf\u306e\u758e\u901a\u78ba\u8a8d\n    curl -s http://169.254.169.254  > /dev/null\n    if [ ! $? -eq 0 ] ; then\n        echo '\u30e1\u30bf\u60c5\u5831\u306b\u30a2\u30af\u30bb\u30b9\u51fa\u6765\u307e\u305b\u3093\u3002EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4e0a\u3067\u5b9f\u884c\u3057\u3066\u4e0b\u3055\u3044'\n        return 10\n    fi\n    # \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30ea\u30fc\u30b8\u30e7\u30f3\u53d6\u5f97\n    REGION=$(curl -s http://169.254.169.254/latest/meta-data/local-hostname | cut -d '.' -f2)\n    if [ -z \"${REGION}\" ] ; then\n        echo '\u30e1\u30bf\u60c5\u5831\u304b\u3089\u30ea\u30fc\u30b8\u30e7\u30f3\u306e\u53d6\u5f97\u306b\u5931\u6557\u3057\u307e\u3057\u305f'\n        return 11\n    fi\n}\n\n# -----------------------------------------------------------------------------\n#\n# \u30d8\u30eb\u30d7\u7528\u66f8\u5f0f\u8868\u793a\n#\n# -----------------------------------------------------------------------------\nfunction syntax() {\n    echo \"-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=\"\n    echo \"                                                               2014 sato(supported by sebastian)\"\n    echo\n    echo \" Purpose\"\n    echo \"   \u6307\u5b9a\u3055\u308c\u305f\u30bf\u30b0\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306eIP\u3092S3\u30d0\u30b1\u30c3\u30c8\u30dd\u30ea\u30b7\u30fc\u767b\u9332\u306b\u767b\u9332\u3057\u307e\u3059\u3002\"\n    echo\n    echo \" Syntax:\"\n        echo \" $0 [-t tagkey] [-r rolename] [-b bucket] \"\n    echo\n    echo \"   tagkey: TagKey\u3092\u5165\u529b\"\n    echo \"   rolename: TagKey\u3067\u6307\u5b9a\u3057\u305fValue\u3092\u5165\u529b\"\n    echo \"   bucket: \u30dd\u30ea\u30b7\u30fc\u3092\u5909\u66f4\u3057\u305f\u3044\u30d0\u30b1\u30c3\u30c8\u540d\u3092\u5165\u529b\"\n    echo\n    echo \"-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=\"\n    exit 0\n}\n\n# ----------------------------------------------------------------------------\n# Main\n# -----------------------------------------------------------------------------\n#\n# \u521d\u671f\u5024\n#\n\nFILE_S3_BUCKET_POLICY=\"s3-policy-readonly-stg.json\"\nBUCKET=\"\"\nTAGKEY=\"\"\nROLENAME=\"\"\n\n\n#\n#  \u5f15\u6570\u306e\u51e6\u7406\n#\n\nwhile [ ! -z \"$1\" ]; do\n    if [ \"$1\" == \"help\" ]; then\n        syntax\n    else\n        flag=$1\n        shift\n        if [ -z \"$1\" ] ; then\n            syntax\n        fi\n        case $flag in\n            '-e' )\n                ENV=$1\n            ;;\n        esac\n    fi\n    shift\ndone\n\nif [ -z \"${TAGKEY}\" ] ; then\n    echo \"TAGKEY\u3092\u6307\u5b9a\u3057\u3066\u4e0b\u3055\u3044[-t tagkey]\"\n    exit 0\nfi\nif [ -z \"${ROLENAME}\" ] ; then\n    echo \"ROLENAME\u3092\u6307\u5b9a\u3057\u3066\u4e0b\u3055\u3044[-r rolename]\"\n    exit 0\nfi\n\nif [ -z \"${BUCKET}\" ] ; then\n    echo \"BUCKET\u3092\u6307\u5b9a\u3057\u3066\u4e0b\u3055\u3044[-b bucket]\"\n    exit 0\n\n#\n# AWS CLI\u306e\u6709\u7121\n#\ncheck=`checkcli`\nresult=$?\nif [ ! $result -eq 0 ] ; then\n    echo $check\n    exit $result\nfi\n\n#\n# \u30ea\u30fc\u30b8\u30e7\u30f3\u306e\u51e6\u7406\n#\nif [ -z \"$getregion\" ] ; then\n    getregion\n    result=$?\n    if [ ! $result -eq 0 ] ; then\n        echo $pip\n        exit $result\n    fi\nfi\n\n#\n# \u5bfe\u8c61\u74b0\u5883\u306eIP\u30ea\u30b9\u30c8\u53d6\u5f97\u3001\u7f6e\u63db\n#\nHOSTLIST_TMP=`aws ec2 describe-instances --region ${REGION} --filters \"Name=tag-key,Values=${TAGKEY}\" \"Name=tag-value,Values=${ROLENAME}\" | jq '.Reservations[].Instances[].PublicIpAddress'`\nif [ ! $? -eq 0 ] ; then\n  echo 'PublicIP\u306e\u53d6\u5f97\u306b\u5931\u6557\u3057\u307e\u3057\u305f'\n  exit\nfi\n\nHOSTLIST=`echo $HOSTLIST_TMP | sed 's/null//g' | sed 's/\"  *\"/\",\"/g'`\n\n#\n# IP\u30ea\u30b9\u30c8\u78ba\u8a8d\n#\necho $HOSTLIST\necho \"S3\u306b\u767b\u9332\u3059\u308bIP\u306f\u3053\u3061\u3089\u3067\u3088\u308d\u3057\u3044\u3067\u3059\u304b\uff1f [Y/n]\"\nread ANSWER\n\ncase $ANSWER in\n    \"\" | \"Y\" | \"y\" | \"yes\" | \"Yes\" | \"YES\" ) echo \"YES!!\";;\n    * ) exit;;\nesac\n\n#\n#\u30d0\u30b1\u30c3\u30c8\u30dd\u30ea\u30b7\u30fc\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\n#\nDATE=$(date +\"%Y%m%d%H%M\")\naws s3api get-bucket-policy --bucket ${BUCKET} --region ${REGION} | jq -r '.Policy' | jq .  >  tmp/${FILE_S3_BUCKET_POLICY}_${DATE}.json\nif [ ! $? -eq 0 ] ; then\n  echo '\u30dd\u30ea\u30b7\u30fc\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306b\u5931\u6557\u3057\u307e\u3057\u305f'\n  exit\nfi\n\n#\n# \u30d0\u30b1\u30c3\u30c8\u30dd\u30ea\u30b7\u30fc\u4f5c\u6210\n#\ncat << EOF > ${FILE_S3_BUCKET_POLICY}\n{\n  \"Statement\": [\n    {\n      \"Condition\": {\n        \"IpAddress\": {\n          \"aws:SourceIp\": [${HOSTLIST}]\n        }\n      },\n      \"Resource\": \"arn:aws:s3:::${BUCKET}/*\",\n      \"Action\": \"s3:GetObject\",\n      \"Principal\": {\n        \"AWS\": \"*\"\n      },\n      \"Effect\": \"Allow\",\n      \"Sid\": \"2\"\n    }\n  ],\n  \"Id\": \"Policy EC2andCF\",\n  \"Version\": \"2008-10-17\"\n}    \nEOF\n\n#\n# \u30dd\u30ea\u30b7\u30fc\u51fa\u529b\n#\necho \"========================\u9069\u7528\u4e88\u5b9a\u306e\u30dd\u30ea\u30b7\u30fc=====================================\"\n\ncat ${FILE_S3_BUCKET_POLICY} | jq .\n\necho \"=============================================================\"\n\necho \"========================\u73fe\u5728\u306e\u30dd\u30ea\u30b7\u30fc=====================================\"\n\ncat tmp/${FILE_S3_BUCKET_POLICY}_${DATE}.json | jq .\n\necho \"=============================================================\"A\n\n\necho \"========================DIFF=====================================\"\n\ndiff -y tmp/${FILE_S3_BUCKET_POLICY}_${DATE}.json  ${FILE_S3_BUCKET_POLICY}\n\necho \"=============================================================\"\n\n#\n# IP\u30ea\u30b9\u30c8\u78ba\u8a8d\n#\necho \"\u3053\u3061\u3089\u3067\u3088\u308d\u3057\u3044\u3067\u3059\u304b\uff1f [Y/n]\"\nread ANSWER\n\ncase $ANSWER in\n    \"\" | \"Y\" | \"y\" | \"yes\" | \"Yes\" | \"YES\" ) echo \"YES!!\";;\n    * ) exit;;\nesac\n\n#\n# \u30d0\u30b1\u30c3\u30c8\u30dd\u30ea\u30b7\u30fc\u9069\u7528\n#\naws s3api put-bucket-policy --bucket ${BUCKET} --policy file://${FILE_S3_BUCKET_POLICY} --region ${REGION}\nif [ $? -eq 255 ] ; then\n    echo \"\u30dd\u30ea\u30b7\u30fc\u306e\u66f4\u65b0\u306b\u5931\u6557\u3057\u307e\u3057\u305f\"\nfi\n\n#\n# \u30dd\u30ea\u30b7\u30fc\u78ba\u8a8d\n#\naws s3api get-bucket-policy --bucket ${BUCKET} --region ${REGION} | jq -r '.Policy' | jq .\n\n\n\n\nGitHub\nhttps://github.com/SatoHiroyuki/aws/blob/master/s3_bucket_policy_edit/s3_bucket_policy.sh\n#S3\u306e\u30dd\u30ea\u30b7\u30fc\u5909\u66f4\u30b9\u30af\u30ea\u30d7\u30c8\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u5897\u6e1b\u306b\u5408\u308f\u305b\u3066\u30d0\u30b1\u30c3\u30c8\u30dd\u30ea\u30b7\u30fc\u306e\u5909\u66f4\u3059\u308b\u306e\u304c\u9762\u5012\u306a\u306e\u3067\u81ea\u52d5\u5316\uff01\n\nsupported by sebastian\n\n##\u5229\u7528\u4f8b\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u4ed8\u4e0e\u3055\u308c\u3066\u3044\u308b\u30bf\u30b0\u3092\u898b\u3066IP\u3092\u53d6\u5f97\u3059\u308b\u5bfe\u8c61\u3092\u5224\u65ad\u3057\u307e\u3059\u3002\n\n\u5bfe\u8c61\u306ePublicIP\u3092\u53d6\u5f97\u3057\u3066\u3001S3\u306e\u30d0\u30b1\u30c3\u30c8\u30dd\u30ea\u30b7\u30fc\u3092\u9069\u7528\u3057\u307e\u3059\u3002\n\n\u30dd\u30ea\u30b7\u30fc\u306f\u30b9\u30af\u30ea\u30d7\u30c8\u5185\u306b\u30d9\u30bf\u66f8\u304d\u3057\u3066\u307e\u3059\u3002\n\n```\nbash s3_bucket_policy.sh -t tagkey -r rolename -b bucket\n```\n\n##\u30b9\u30af\u30ea\u30d7\u30c8\n\n```lang:bash\n#!/bin/sh\n# -----------------------------------------------------------------------------\n# AWS CLI\u306e\u78ba\u8a8d\n#\n# retval 0 OK\n# retval 1 \u30d1\u30b9\u304c\u901a\u3063\u3066\u3044\u306a\u3044\u306e\u3067\u30d1\u30b9\u3092\u901a\u3057\u305f\n# retval 2 \u898b\u3064\u304b\u3089\u306a\u304b\u3063\u305f\n# -----------------------------------------------------------------------------\nfunction checkcli() {\n    aws --version &> /dev/null\n    if [ $? -eq 127 ] ; then\n        awspath=$(which aws)\n        if [ ! $? -eq 0 ]; then\n            echo 'aws-cli\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093'\n            exit 2\n        else\n            addpath=$(echo $awspath |  sed -e 's/aws//g')\n            PATH=\"$PATH\":$addpath\n            exit 1\n        fi\n    fi\n    exit 0\n}\n# -----------------------------------------------------------------------------\n# \u5b9f\u884c\u3057\u3066\u3044\u308b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u60c5\u5831\u306e\u53d6\u5f97\n#\n# retstd PublicIp \u73fe\u5728\u51e6\u7406\u3092\u884c\u3063\u3066\u3044\u308b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306ePublicIp\u3092\u8fd4\u3059\n# retval \u6b63\u5e38\u7d42\u4e86\n# retval 10 \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4e0a\u3067\u5b9f\u884c\u3055\u308c\u3066\u3044\u306a\u3044\n# retval 11 \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30ea\u30fc\u30b8\u30e7\u30f3\u53d6\u5f97\u5931\u6557\n# -----------------------------------------------------------------------------\nfunction getregion() {\n    # \u30e1\u30bf\u30c7\u30fc\u30bf\u306e\u758e\u901a\u78ba\u8a8d\n    curl -s http://169.254.169.254  > /dev/null\n    if [ ! $? -eq 0 ] ; then\n        echo '\u30e1\u30bf\u60c5\u5831\u306b\u30a2\u30af\u30bb\u30b9\u51fa\u6765\u307e\u305b\u3093\u3002EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4e0a\u3067\u5b9f\u884c\u3057\u3066\u4e0b\u3055\u3044'\n        return 10\n    fi\n    # \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30ea\u30fc\u30b8\u30e7\u30f3\u53d6\u5f97\n    REGION=$(curl -s http://169.254.169.254/latest/meta-data/local-hostname | cut -d '.' -f2)\n    if [ -z \"${REGION}\" ] ; then\n        echo '\u30e1\u30bf\u60c5\u5831\u304b\u3089\u30ea\u30fc\u30b8\u30e7\u30f3\u306e\u53d6\u5f97\u306b\u5931\u6557\u3057\u307e\u3057\u305f'\n        return 11\n    fi\n}\n\n# -----------------------------------------------------------------------------\n#\n# \u30d8\u30eb\u30d7\u7528\u66f8\u5f0f\u8868\u793a\n#\n# -----------------------------------------------------------------------------\nfunction syntax() {\n    echo \"-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=\"\n    echo \"                                                               2014 sato(supported by sebastian)\"\n    echo\n    echo \" Purpose\"\n    echo \"   \u6307\u5b9a\u3055\u308c\u305f\u30bf\u30b0\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306eIP\u3092S3\u30d0\u30b1\u30c3\u30c8\u30dd\u30ea\u30b7\u30fc\u767b\u9332\u306b\u767b\u9332\u3057\u307e\u3059\u3002\"\n    echo\n    echo \" Syntax:\"\n        echo \" $0 [-t tagkey] [-r rolename] [-b bucket] \"\n    echo\n    echo \"   tagkey: TagKey\u3092\u5165\u529b\"\n    echo \"   rolename: TagKey\u3067\u6307\u5b9a\u3057\u305fValue\u3092\u5165\u529b\"\n    echo \"   bucket: \u30dd\u30ea\u30b7\u30fc\u3092\u5909\u66f4\u3057\u305f\u3044\u30d0\u30b1\u30c3\u30c8\u540d\u3092\u5165\u529b\"\n    echo\n    echo \"-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=\"\n    exit 0\n}\n\n# ----------------------------------------------------------------------------\n# Main\n# -----------------------------------------------------------------------------\n#\n# \u521d\u671f\u5024\n#\n\nFILE_S3_BUCKET_POLICY=\"s3-policy-readonly-stg.json\"\nBUCKET=\"\"\nTAGKEY=\"\"\nROLENAME=\"\"\n\n\n#\n#  \u5f15\u6570\u306e\u51e6\u7406\n#\n\nwhile [ ! -z \"$1\" ]; do\n    if [ \"$1\" == \"help\" ]; then\n        syntax\n    else\n        flag=$1\n        shift\n        if [ -z \"$1\" ] ; then\n            syntax\n        fi\n        case $flag in\n            '-e' )\n                ENV=$1\n            ;;\n        esac\n    fi\n    shift\ndone\n\nif [ -z \"${TAGKEY}\" ] ; then\n    echo \"TAGKEY\u3092\u6307\u5b9a\u3057\u3066\u4e0b\u3055\u3044[-t tagkey]\"\n    exit 0\nfi\nif [ -z \"${ROLENAME}\" ] ; then\n    echo \"ROLENAME\u3092\u6307\u5b9a\u3057\u3066\u4e0b\u3055\u3044[-r rolename]\"\n    exit 0\nfi\n\nif [ -z \"${BUCKET}\" ] ; then\n    echo \"BUCKET\u3092\u6307\u5b9a\u3057\u3066\u4e0b\u3055\u3044[-b bucket]\"\n    exit 0\n\n#\n# AWS CLI\u306e\u6709\u7121\n#\ncheck=`checkcli`\nresult=$?\nif [ ! $result -eq 0 ] ; then\n    echo $check\n    exit $result\nfi\n\n#\n# \u30ea\u30fc\u30b8\u30e7\u30f3\u306e\u51e6\u7406\n#\nif [ -z \"$getregion\" ] ; then\n    getregion\n    result=$?\n    if [ ! $result -eq 0 ] ; then\n        echo $pip\n        exit $result\n    fi\nfi\n\n#\n# \u5bfe\u8c61\u74b0\u5883\u306eIP\u30ea\u30b9\u30c8\u53d6\u5f97\u3001\u7f6e\u63db\n#\nHOSTLIST_TMP=`aws ec2 describe-instances --region ${REGION} --filters \"Name=tag-key,Values=${TAGKEY}\" \"Name=tag-value,Values=${ROLENAME}\" | jq '.Reservations[].Instances[].PublicIpAddress'`\nif [ ! $? -eq 0 ] ; then\n  echo 'PublicIP\u306e\u53d6\u5f97\u306b\u5931\u6557\u3057\u307e\u3057\u305f'\n  exit\nfi\n\nHOSTLIST=`echo $HOSTLIST_TMP | sed 's/null//g' | sed 's/\"  *\"/\",\"/g'`\n\n#\n# IP\u30ea\u30b9\u30c8\u78ba\u8a8d\n#\necho $HOSTLIST\necho \"S3\u306b\u767b\u9332\u3059\u308bIP\u306f\u3053\u3061\u3089\u3067\u3088\u308d\u3057\u3044\u3067\u3059\u304b\uff1f [Y/n]\"\nread ANSWER\n\ncase $ANSWER in\n    \"\" | \"Y\" | \"y\" | \"yes\" | \"Yes\" | \"YES\" ) echo \"YES!!\";;\n    * ) exit;;\nesac\n\n#\n#\u30d0\u30b1\u30c3\u30c8\u30dd\u30ea\u30b7\u30fc\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\n#\nDATE=$(date +\"%Y%m%d%H%M\")\naws s3api get-bucket-policy --bucket ${BUCKET} --region ${REGION} | jq -r '.Policy' | jq .  >  tmp/${FILE_S3_BUCKET_POLICY}_${DATE}.json\nif [ ! $? -eq 0 ] ; then\n  echo '\u30dd\u30ea\u30b7\u30fc\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306b\u5931\u6557\u3057\u307e\u3057\u305f'\n  exit\nfi\n\n#\n# \u30d0\u30b1\u30c3\u30c8\u30dd\u30ea\u30b7\u30fc\u4f5c\u6210\n#\ncat << EOF > ${FILE_S3_BUCKET_POLICY}\n{\n  \"Statement\": [\n    {\n      \"Condition\": {\n        \"IpAddress\": {\n          \"aws:SourceIp\": [${HOSTLIST}]\n        }\n      },\n      \"Resource\": \"arn:aws:s3:::${BUCKET}/*\",\n      \"Action\": \"s3:GetObject\",\n      \"Principal\": {\n        \"AWS\": \"*\"\n      },\n      \"Effect\": \"Allow\",\n      \"Sid\": \"2\"\n    }\n  ],\n  \"Id\": \"Policy EC2andCF\",\n  \"Version\": \"2008-10-17\"\n}    \nEOF\n\n#\n# \u30dd\u30ea\u30b7\u30fc\u51fa\u529b\n#\necho \"========================\u9069\u7528\u4e88\u5b9a\u306e\u30dd\u30ea\u30b7\u30fc=====================================\"\n\ncat ${FILE_S3_BUCKET_POLICY} | jq .\n\necho \"=============================================================\"\n\necho \"========================\u73fe\u5728\u306e\u30dd\u30ea\u30b7\u30fc=====================================\"\n\ncat tmp/${FILE_S3_BUCKET_POLICY}_${DATE}.json | jq .\n\necho \"=============================================================\"A\n\n\necho \"========================DIFF=====================================\"\n\ndiff -y tmp/${FILE_S3_BUCKET_POLICY}_${DATE}.json  ${FILE_S3_BUCKET_POLICY}\n\necho \"=============================================================\"\n\n#\n# IP\u30ea\u30b9\u30c8\u78ba\u8a8d\n#\necho \"\u3053\u3061\u3089\u3067\u3088\u308d\u3057\u3044\u3067\u3059\u304b\uff1f [Y/n]\"\nread ANSWER\n\ncase $ANSWER in\n    \"\" | \"Y\" | \"y\" | \"yes\" | \"Yes\" | \"YES\" ) echo \"YES!!\";;\n    * ) exit;;\nesac\n\n#\n# \u30d0\u30b1\u30c3\u30c8\u30dd\u30ea\u30b7\u30fc\u9069\u7528\n#\naws s3api put-bucket-policy --bucket ${BUCKET} --policy file://${FILE_S3_BUCKET_POLICY} --region ${REGION}\nif [ $? -eq 255 ] ; then\n    echo \"\u30dd\u30ea\u30b7\u30fc\u306e\u66f4\u65b0\u306b\u5931\u6557\u3057\u307e\u3057\u305f\"\nfi\n\n#\n# \u30dd\u30ea\u30b7\u30fc\u78ba\u8a8d\n#\naws s3api get-bucket-policy --bucket ${BUCKET} --region ${REGION} | jq -r '.Policy' | jq .\n\n```\n\n\n##GitHub\n\nhttps://github.com/SatoHiroyuki/aws/blob/master/s3_bucket_policy_edit/s3_bucket_policy.sh\n\n", "tags": ["AWS", "\u30bb\u30d0\u30b9\u30c1\u30e3\u30f3\u306e\u6559\u3048", "S3"]}