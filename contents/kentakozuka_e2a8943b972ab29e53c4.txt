{"context": "\u73fe\u5728\u30d6\u30fc\u30c8\u30d7\u30ed\u30bb\u30b9\u4e2d\u306b\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u3066\u304a\u308a\u307e\u3059\u3002\nLoading initial ramdisk ...\n\u3092\u6700\u5f8c\u306b\u52d5\u304d\u307e\u305b\u3093\u3002\u3002\u3002\n[\u89e3\u6c7a\u6e08]\u73fe\u5728grub-install\u3067\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u3066\u304a\u308a\u307e\u3059\u3002\nhttps://teratail.com/questions/61991\n\u4ee5\u4e0b\u306e\u30b5\u30a4\u30c8\u3092\u53c2\u8003\u306b\u3057\u307e\u3057\u305f\u3002\nhttps://wiki.gentoo.org/wiki/Sakaki%27s_EFI_Install_Guide/Building_the_Gentoo_Base_System_Minus_Kernel\nhttps://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Base/ja\nhttp://note.kurodigi.com/gentoo-uefi-install/\nhttp://ririgon.hatenadiary.jp/entry/20150401/1427821349\nhttps://sharpencryptedpig.noblogs.org/post/2014/05/29/how-to-install-gentoo-hardened-with-encrypted-root-and-swapexpress-procedure/\nhttps://wiki.gentoo.org/wiki/Systemd/ja\nhttps://wiki.gentoo.org/wiki/Intel\nhttps://ja.wikipedia.org/wiki/Intel_HD_Graphics\nhttp://www.hivestream.de/gentoo-installation-with-raid-lvm-luks-and-systemd.html\nhttp://yuex.in/post/2016/12/gentoo-install-mbp-1.html\n\nUEFI\u30e2\u30fc\u30c9\u304b\u78ba\u8a8d\n# ls /sys/firmware/\napci dmi efi memmap\n\n\n\u30ad\u30fc\u30dc\u30fc\u30c9\u30ec\u30a4\u30a2\u30a6\u30c8\u3092\u5909\u66f4\n# loadkeys jp106\n\n\n\u7121\u7ddaLAN\u8a2d\u5b9a\n# ip link show\n# ip link set <interface> up\n# iwlist <interface> scanning | grep ESSID\n# wpa_supplicant -B -i <interface> -c <(wpa_passphrase <ESSID> <password>)\n# dhcpcd\n# ping google.com\n\n\n\u30c7\u30a3\u30b9\u30af\u3092LUKS\u3067\u6697\u53f7\u5316\u3057\u3066\u3044\u308b\u5834\u5408\u306f\u5fa9\u53f7\u5316\n# cryptsetup open <device-path> <luks-device-name>\n\n\n\u30c7\u30a3\u30b9\u30af\u30fblvm\u306e\u4f7f\u7528\u72b6\u6cc1\u3092\u78ba\u8a8d\n# lsblk\n# df -h\n# lvscan\n\n\n\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u4f5c\u6210\u3059\u308b\u5834\u5408\nsda1\u306fESP\uff08ef00\uff09\u306b\u8a2d\u5b9a\nsda2\u306flvm\u7528\uff088e00\uff09\u306b\u8a2d\u5b9a\n# gdisk /dev/sdX\nGPT fdisk (gdisk) version 0.8.6\n\nPartition table scan:\n  MBR: not present\n  BSD: not present\n  APM: not present\n  GPT: not present\n\nCreating new GPT entries.\n\nCommand (? for help): o\nThis option deletes all partitions and creates a new protective MBR.\nProceed? (Y/N): y\n\nCommand (? for help): n\nPartition number :\nFirst sector:\nLast sector: +512M\nHex code or GUID: ef00\n\nCommand (? for help): n\nPartition number:\nFirst sector:\nLast sector: \nHex code or GUID: 8e00\n\nCommand (? for help): w\nFinal checks complete. About to write GPT data. THIS WILL OVERWRITE EXISTING\nPARTITIONS!!\n\nDo you want to proceed?: y\nOK; writing new GUID partition table (GPT) to /dev/sda.\nThe operation has completed successfully.\n\n\nLogical Volume\u306e\u4f5c\u6210\n\u4f5c\u6210\u3059\u308b\u306e\u306f\u30eb\u30fc\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u307f\u3067\u3059\nlvcreate -L 64G vg1 -n <lv-root-name>\n\n\n\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u306e\u4f5c\u6210\next4\u3067\u4f5c\u6210\u3057\u307e\u3059\u3002\nmkfs.ext4 <lv-root-path>\n\n\n\u30b9\u30ef\u30c3\u30d7\u306f\u30aa\u30f3\u306b\u3059\u308b\n# swapon <lv-swap-path>\n\n\n\u30eb\u30fc\u30c8\u3092\u30de\u30a6\u30f3\u30c8\n# mount <lv-root-path> /mnt/gentoo\n\n\nEFI\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4f5c\u6210\u3068\u30de\u30a6\u30f3\u30c8\nmkdir -p /mnt/gentoo/boot/efi\nmount /dev/sda1 /mnt/gentoo/boot/efi\n\n\u3061\u3083\u3093\u3068\u3067\u304d\u305f\u304b\u78ba\u8a8d\n# lsblk\n\n\n\u6642\u523b\u3092\u78ba\u8a8d\n#date\n\n\ntarball\uff08\u30b9\u30c6\u30fc\u30b83\uff09\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u5c55\u958b\u3057\u307e\u3059\u3002\ncd /mnt/gentoo\n\nwget http://ftp.jaist.ac.jp/pub/Linux/Gentoo/releases/amd64/autobuilds/current-stage3-amd64/stage3-amd64-<yyyymmdd>.tar.bz2\n\ntar xvjpf stage3-amd64-<yyyymmdd>.tar.bz2 --xattrs\n\n\nmake.conf\u306e\u7de8\u96c6\nVIDEO_CARDS\u306e\u5024\u306f\u4ee5\u4e0b\u53c2\u7167\nlspci | grep VGA\n\nhttps://wiki.gentoo.org/wiki/Intel\nhttps://ja.wikipedia.org/wiki/Intel_HD_Graphics\nvi /mnt/gentoo/etc/portage/make.conf\n\n# These settings were set by the catalyst build script that automatically\n# built this stage.\n# Please consult /usr/share/portage/config/make.conf.example for a more\n# detailed example.\nCFLAGS=\"-O2 -pipe\"\nCXXFLAGS=\"${CFLAGS}\"\n\n# WARNING: Changing your CHOST is not something that should be done lightly.\n# Please consult http://www.gentoo.org/doc/en/change-chost.xml before changing.\nCHOST=\"x86_64-pc-linux-gnu\"\n\n# These are the USE and USE_EXPAND flags that were used for\n# buidling in addition to what is provided by the profile.\nUSE=\"bindist\"\nCPU_FLAGS_X86=\"mmx sse sse2\"\n\n# Important Portage directories\nPORTDIR=\"/usr/portage\"\nDISTDIR=\"${PORTDIR}/distfiles\"\nPKGDIR=\"${PORTDIR}/packages\"\n\n# Turn on logging\nPORTAGE_ELOG_CLASSES=\"info warn error log qa\"\nPORTAGE_ELOG_SYSTEM=\"save\"\n\n# Setting for X11\nVIDEO_CARDS=\"intel i965\"\nINPUT_DEVICES=\"evdev synaptics\"\n\nMAKEOPTS=\"-j4\"\nLINGUAS=\"en ja\"\n\nGRUB_PLATFORMS=\"efi-64\"\n\n\n\u30df\u30e9\u30fc\u306e\u8a2d\u5b9a\nmirrorselect -i -o >> /mnt/gentoo/etc/portage/make.conf\n\n\u4ee5\u4e0b\u3001\u5f15\u7528\n\u30e1\u30a4\u30f3\u306eGentoo\u30ea\u30dd\u30b8\u30c8\u30ea\n\u30df\u30e9\u30fc\u3092\u9078\u629e\u3059\u308b\u305f\u3081\u306b\u6b21\u306b\u91cd\u8981\u306a\u30b9\u30c6\u30c3\u30d7\u306f\u3001/etc/portage/repos.conf/gentoo.conf\u30d5\u30a1\u30a4\u30eb\u3067\u30e1\u30a4\u30f3\u306eGentoo\u30ea\u30dd\u30b8\u30c8\u30ea\u3092\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u3002\n\u3053\u306e\u30d5\u30a1\u30a4\u30eb\u306fPortage\u30c4\u30ea\u30fc\u3092\u66f4\u65b0\u3059\u308b\u3068\u304d\u306b\u5fc5\u8981\u306b\u306a\u308b\u540c\u671f\u60c5\u5831\u3092\u542b\u3093\u3067\u3044\u307e\u3059\nPortage\u30c4\u30ea\u30fc\uff1a\nPortage\u304c\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3001\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u6642\u306b\u5fc5\u8981\u306a\u3059\u3079\u3066\u306e\u60c5\u5831\u3092\u542b\u3080ebuild\u3068\u95a2\u9023\u30d5\u30a1\u30a4\u30eb\u3092\u96c6\u3081\u305f\u3082\u306e\n\u30e1\u30a4\u30f3\u306eGentoo\u30ea\u30dd\u30b8\u30c8\u30ea\u306e\u8a2d\u5b9a\u306f\u5358\u7d14\u3067\u3059\u3002\n\u6700\u521d\u306b\uff08\u5b58\u5728\u3057\u306a\u3051\u308c\u3070\uff09repos.conf\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3002 \nmkdir /mnt/gentoo/etc/portage/repos.conf\n\n\u6b21\u306b\u3001Portage\u304c\u63d0\u4f9b\u3059\u308bGentoo\u30ea\u30dd\u30b8\u30c8\u30ea\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\uff08\u65b0\u898f\u4f5c\u6210\u3057\u305f\uff09repos.conf\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u30b3\u30d4\u30fc\u3057\u307e\u3059\u3002 \ncp /mnt/gentoo/usr/share/portage/config/repos.conf /mnt/gentoo/etc/portage/repos.conf/gentoo.conf\n\n\nDNS\u60c5\u5831\u306e\u30b3\u30d4\u30fc\n/etc/resolv.conf\u3092\u30b3\u30d4\u30fc\u3057\u3066\u304a\u304f\ncp -L /etc/resolv.conf /mnt/gentoo/etc/\n\n\n\u8272\u3005\u30de\u30a6\u30f3\u30c8\u3059\u308b\n\u4ee5\u4e0b\u3001\u5f15\u7528\n\u5fc5\u8981\u306a\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3092\u30de\u30a6\u30f3\u30c8\u3059\u308b\n\u65b0\u3057\u3044\u74b0\u5883\u3092\u9069\u5207\u306b\u52d5\u4f5c\u3055\u305b\u308b\u305f\u3081\u306b\u3001\u3044\u304f\u3064\u304b\u306e\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3092\u4f7f\u3048\u308b\u3088\u3046\u306b\u3057\u306a\u3051\u308c\u3070\u306a\u308a\u307e\u305b\u3093\u3002\n/proc/ \nLinux\u30ab\u30fc\u30cd\u30eb\u304b\u3089\u60c5\u5831\u3092\u5f15\u304d\u51fa\u3059\u305f\u3081\u306e\u64ec\u4f3c\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\n/sys/\n/proc/\u540c\u69d8\u3001\u64ec\u4f3c\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3067\u3059\u3002/proc/\u3088\u308a\u69cb\u9020\u5316\u3055\u308c\u3066\u304a\u308a\u3001\u4e00\u5ea6\u306f/proc/\u3092\u7f6e\u304d\u63db\u3048\u308b\u3053\u3068\u304c\u76ee\u7684\n/dev/\n\u901a\u5e38\u306e\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3067\u3059\u3002\u4e00\u90e8\u306fLinux\u306e\u30c7\u30d0\u30a4\u30b9\u7ba1\u7406\u6a5f\u69cb(\u901a\u5e38\u306fudev)\u306b\u3088\u308a\u7ba1\u7406\u3055\u308c\u3066\u304a\u308a\u3001\u3059\u3079\u3066\u306e\u30c7\u30d0\u30a4\u30b9\u30d5\u30a1\u30a4\u30eb\u3092\u542b\u3080\u3002\n/proc/\u306f\u3001/mnt/gentoo/proc/\u306b\u30de\u30a6\u30f3\u30c8\u3055\u308c\u308b\u3067\u3057\u3087\u3046\u3002\n\u4ed6\u306e\uff12\u3064\u306fbind\u30de\u30a6\u30f3\u30c8\u3055\u308c\u307e\u3059\u3002\nmount -t proc proc /mnt/gentoo/proc\nmount --rbind /sys /mnt/gentoo/sys\nmount --make-rslave /mnt/gentoo/sys\nmount --rbind /dev /mnt/gentoo/dev\nmount --make-rslave /mnt/gentoo/dev\n\n\nchroot\u3057\u307e\u3059\u3002\nchroot /mnt/gentoo /bin/bash\nsource /etc/profile\nexport PS1=\"(chroot) $PS1\"\n\n\nportage\u306e\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\nemerge-webrsync\n\nPortage\u30c4\u30ea\u30fc\u3092\u6700\u65b0\u7248\u306b\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\n\uff08\u3084\u3089\u306a\u304f\u3066\u3082\u3088\u3044\u3068\u516c\u5f0fHP\u306b\u66f8\u3044\u3066\u3042\u308a\u307e\u3057\u305f\u3002\u7d50\u69cb\u9577\u304b\u3063\u305f\u3067\u3059\u3002\uff09\nemerge --sync --quiet\n\nPortage\u304b\u3089\u306e\u30cb\u30e5\u30fc\u30b9\n\u98db\u3070\u3057\u307e\u3059\n\n\u9078\u629e\u3067\u304d\u308b\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u306e\u78ba\u8a8d\neselect profile list\n\n\n\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u3092\u5909\u66f4\neselect profile set default/linux/amd64/13.0/desktop/gnome/systemd\n\n\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u306e\u5909\u66f4\u3092\u78ba\u8a8d\neselect profile list\n\n\n\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u3092\u5909\u66f4\u3057\u305f\u306e\u3067\u3001\u66f4\u65b0\u3059\u308b\nemerge --ask --update --deep --newuse @world\n\n\n\u7121\u7ddaLAN\u30c4\u30fc\u30eb\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u304a\u304f\nemerge -av net-wireless/wireless-tools net-wireless/wpa_supplicant net-misc/dhcpcd\n\n\n\u3044\u308d\u3044\u308demerge\n# emerge -av vim app-misc/screen cryptsetup lvm2\n\n\n\u30ed\u30b1\u30fc\u30eb\u3092\u8a2d\u5b9a\u3059\u308b\u3002\nls /usr/share/zoneinfo\necho \"Japan\" > /etc/timezone\nemerge --config sys-libs/timezone-data\n\nvim /etc/locale.gen\n:\nen_US.UTF-8 UTF-8\n:\njp_JP.UTF-8 UTF-8\n:\n\nlocale-gen\neselect locale list\neselect locale set [0-9]\nenv-update\nsource /etc/profile\nexport PS1=\"(chroot) $PS1\"\n\n\ngenkernel\u3067\u306f\u306a\u304f\u30de\u30cb\u30e5\u30a2\u30eb\u3067\u30ab\u30fc\u30cd\u30eb\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\u30ab\u30fc\u30cd\u30eb\u30bd\u30fc\u30b9\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u30ab\u30fc\u30cd\u30eb\u30bd\u30fc\u30b9\u3092/usr/src/\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\nemerge -av sys-kernel/gentoo-sources\n\n\n\u30ab\u30fc\u30cd\u30eb\u3092Make\n\n\u30ab\u30fc\u30cd\u30eb\u30b3\u30f3\u30d5\u30a3\u30ae\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u8a2d\u5b9a\u3092\u3059\u308b\ncd /usr/src/linux\nmake menuconfig\n\n    Gentoo Linux --->\n            [*] Gentoo Linux support (NEW)\n            [*] Linux dynamic and persistent device naming (userspace devfs) support (NEW)\n            [*] Select options required by Portage features (NEW)\n          Support for init systems, system and service managers --->\n            [*] OpenRC, runit and other script based systems and managers\n            [*] systemd\n[*] 64-bit kernel\n    General Setup --->\n      ()  Cross-compiler tool prefix (NEW)\n      [ ] Compile also drivers which will not load (NEW)\n      ()  Local version - append to kernel release (NEW)\n      [ ] Automatically append version information to the version string\n          Kernel compression mode (Gzip) --->\n      ((none)) Default hostname (NEW)\n      [*] Support for paging of anonymous memory (swap) (NEW)\n      :\n      -*- System V IPC\n      :\n      -*- Control Group support --->\n            --- Control Group support\n            [ ]   Example debug cgroup subsystem\n            [*]   Freezer cgroup subsystem\n            :\n            [*]   Device controller for cgroups\n            [*]   Cpuset support\n            [*]     Include legacy /proc/<pid>/cpuset file\n            [*]   Simple CPU accounting cgroup subsystem\n            [*]   Resource counters\n            [*]     Memory Resource Controller for Control Groups\n            [*]       Memory Resource Controller Swap Extension\n            [*]         Memory Resource Controller Swap Extension enabled by default\n            [*]       Memory Resource Controller for Kernel Memory accounting\n            [ ]     HugeTLB Resource Controller for Control Groups\n            [*]   Enable perf_event per-cpu per-container group (cgroup) monitoring\n            [*]   Group CPU scheduler --->\n            [*]   Block IO contoroller\n            [ ]     Enable Block IO controller debugging\n      -*- Namespaces support --->\n            --- Namespaces support\n            [*] UTS namespace\n            [*] IPC namespace\n            [*] User namepace\n            [*] PID Namespaces\n            -*- Network namespace\n      :\n      [*] Initial RAM filesystem and RAM disk (initramfs/initrd) support\n      :\n      [*] Configure standard kernel features (expert users)  --->\n            :\n            [*] Enable eventpoll support\n            [*] Enable signalfd() system call\n            [*] Enable timerfd() system call\n      :\n    -*- Enable the block layer --->\n      --- Enable the block layer\n          Partition Types --->\n             :\n            [*]   EFI GUID partition support\n\n    Processor type and features --->\n      :\n      [*] EFI runtime service support\n      [*]   EFI stub support\n      [ ]     EFI mixed-mode support\n       :\n      [*] Built-in kernel command line\n      :\n    :\n    Device Drivers --->\n          Generic Driver Options --->\n            [*] Support for uevent helper\n            (/sbin/hotplug)    path to uevent helper\n          :\n          Multiple devices driver support (RAID and LVM)  --->\n                 <*> Device mapper support\n                 <*> Crypt target support\n                 <*> Snapshot target\n                 <*> Mirror target\n                 <*> Multipath target\n                 <*>   I/O Path Selector based on the number of in-flight I/Os\n                 <*>   I/O Path Selector based on the service time\n\n    Firmware Drivers --->\n          EFI (Extensible Firmware Interface)  Support >\n                 <*> EFI Variable Support via sysfs\n-*- Cryptographic API\n     <*>  SHA256 digest algorithm (SSSE3/AVX/AVX2)\n     <*>  SHA512 digest algorithm\n     <*>  AES cipher algorithms (x86_64)\n\n\n\u30ab\u30fc\u30cd\u30eb\u306e\u30b3\u30f3\u30d1\u30a4\u30eb\u3068\u30e2\u30b8\u30e5\u30fc\u30eb\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3068\u30ab\u30fc\u30cd\u30eb\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nmake && make modules_install && make install\n\n\ninitramfs\u306e\u751f\u6210\n\u6b21\u56de\u306fdracut\u3067\u3084\u3063\u3066\u307f\u3088\u3046\nhttp://www.hivestream.de/gentoo-installation-with-raid-lvm-luks-and-systemd.html\ngenkernel\u306eemerge\n# echo \"sys-kernel/genkernel-next cryptsetup\" > /etc/portage/package.use/genkernel-next\n# emerge -av genkernel-next\n\n\ninitramfs\u306e\u4f5c\u6210\ngenkernel --udev \u2013-lvm \u2013-luks \u2013-install initramfs\nls /boot/initramfs*\n\n\u4ee5\u4e0b\u5f15\u7528\n/etc/mtab\n\u958b\u767a\u5143\u306f\u3001 /etc/mtab \u30d5\u30a1\u30a4\u30eb\u304c /proc/self/mounts \u3078\u306e\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3067\u3042\u308b\u74b0\u5883\u306e\u307f\u3092\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u3044\u307e\u3059\u3002\n\u307e\u305f\u3001\u3053\u306e\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u304c\u5b58\u5728\u3057\u306a\u3044\u5834\u5408\u3001mount (bug #434090) \u304a\u3088\u3073 df (bug #477240) \u306b\u3082\u554f\u984c\u304c\u767a\u751f\u3057\u307e\u3059\u3002\n\u304b\u3064\u3066\u4e00\u90e8\u306e\u30e6\u30fc\u30c6\u30a3\u30ea\u30c6\u30a3\u304c\u30de\u30a6\u30f3\u30c8\u30aa\u30d7\u30b7\u30e7\u30f3\u306a\u3069\u3092\u66f8\u304d\u8fbc\u3093\u3067\u3044\u305f\u305f\u3081\u3001/etc/mtab \u306f\u901a\u5e38\u306e\u30d5\u30a1\u30a4\u30eb\u3067\u3042\u308b\u3053\u3068\u304c\u671f\u5f85\u3055\u308c\u3066\u3044\u307e\u3057\u305f\u304c\u3001\u73fe\u5728\u3067\u306f\u3042\u3089\u3086\u308b\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u304c\u5bfe\u7b56\u3092\u7d42\u3048\u3066\u3044\u308b\u3082\u306e\u3068\u601d\u308f\u308c\u307e\u3059\u3002\n\u3068\u306f\u3044\u3048\u5ff5\u306e\u305f\u3081\u3001\u30d5\u30a1\u30a4\u30eb\u3092\u30ea\u30f3\u30af\u306b\u5909\u66f4\u3059\u308b\u4f5c\u696d\u3092\u884c\u3046\u524d\u306b\u3001 bug #477498 \u3092\u95b2\u89a7\u306e\u4e0a\u3001\u30b7\u30b9\u30c6\u30e0\u304c\u65e2\u77e5\u306e\u554f\u984c\u3092\u62b1\u3048\u3066\u3044\u306a\u3044\u3053\u3068\u3092\u304a\u78ba\u304b\u3081\u304f\u3060\u3055\u3044\u3002\n\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3092\u4f5c\u6210\u3059\u308b\u306b\u306f\u3001\u4ee5\u4e0b\u3092\u5b9f\u884c\u3057\u307e\u3059: \n# ln -sf /proc/self/mounts /etc/mtab\n\nLVM \u3092\u4f7f\u7528\u3059\u308b\u30b7\u30b9\u30c6\u30e0\u3067\u306f\u3001LVM \u30dc\u30ea\u30e5\u30fc\u30e0\u3092\u30de\u30a6\u30f3\u30c8\u3059\u308b\u305f\u3081\u3001systemd \u3068\u5171\u306b lvmetad \u30c7\u30fc\u30e2\u30f3\u304c\u8d77\u52d5\u3055\u308c\u306a\u3051\u308c\u3070\u306a\u308a\u307e\u305b\u3093\u3002\nlvmetad \u306f /etc/lvm/lvm.conf \u3067\u6709\u52b9\u5316\u3067\u304d\u307e\u3059:\n# vim /etc/lvm/lvm.conf\n:\nuse_lvmetad = 1\n:\n\n\u4efb\u610f\u81ea\u7531\u9078\u629e: \u30d5\u30a1\u30fc\u30e0\u30a6\u30a7\u30a2\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nemerge -av sys-kernel/linux-firmware\n\n\n\u81ea\u52d5\u30de\u30a6\u30f3\u30c8\u306e\u8a2d\u5b9a\n\u307e\u305a\u3001\u30b3\u30d4\u30da\u3067\u304d\u308b\u3088\u3046\u306bUUID\u3092/etc/fstab\u306b\u8ffd\u8a18\u3057\u307e\u3059\u3002\nblkid >> /etc/fstab\n\n/etc/fstab\u3092\u7de8\u96c6\u3059\u308b\nvim /etc/fstab\n:\n# <fs>            <mountpoint>    <type>     <opts>                  <dump/pass>\nUUID=<UUID>       /               ext4       defaults,noatime        0 1\nUUID=<UUID>       /boot/efi       vfat       defaults,noatime        0 2\nUUID=<UUID>       none            swap       sw                      0 0\n:\n\n\n\u30db\u30b9\u30c8\u30cd\u30fc\u30e0\u306e\u8a2d\u5b9a\necho <hostname> > /etc/conf.d/hostname\n\n\n\u30eb\u30fc\u30c8\u30d1\u30b9\u30ef\u30fc\u30c9\u306e\u8a2d\u5b9a\npasswd root\n\n\n\u30ad\u30fc\u30de\u30c3\u30d7\u306e\u8a2d\u5b9a\nvim /etc/conf.d/keymaps\n:\nkeymap=\"jp106\"\n:\n\n\u30b5\u30fc\u30d3\u30b9\u30fb\u30c7\u30fc\u30e2\u30f3\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u3084\u3089\u306a\u304b\u3063\u305f\nemerge -av app-admin/sysklogd sys-apps/systemd net-misc/dhcpcd\n\n/etc/hosts\u306e\u7de8\u96c6\nvim /etc/hosts\n:\n# IPv4 and IPv6 localhost aliases\n127.0.0.1       localhost <hostname>\n::1             localhost <hostname>\n:\n\n\n\u30d6\u30fc\u30c8\u30ed\u30fc\u30c0\u30fc\nGRUB2\u3068sys-fs/dosfstool\u3068efibootmgr\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nlvm\u3068luks\u3092\u4f7f\u7528\u3059\u308b\u305f\u3081\u306b\u306fGRUB\u304cdevice mapper\u3092\u30b5\u30dd\u30fc\u30c8\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n# echo \"sys-boot/grub:2 device-mapper\" >> /etc/portage/package.use/grub:2\n# emerge -av sys-boot/grub:2 sys-fs/dosfstools sys-boot/efibootmgr\n# emerge -av sys-fs/dosfstools sys-boot/efibootmgr\n\n/etc/default/grub\u3092\u7de8\u96c6\nNote\ndracut \u304c systemd \u3092\u3068\u308a\u3053\u3093\u3067\u751f\u6210\u3057\u305f initramfs \u3092\u4f7f\u7528\u3059\u308b\u3068\u304d\u306b\u306f\u3001\u3053\u306e\u4f5c\u696d\u306f\u5fc5\u8981\u3042\u308a\u307e\u305b\u3093\u3002initramfs \u304c systemd \u3092\u8d77\u52d5\u3059\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\nFILE /etc/default/grubConfigure GRUB2 for systemd\n/etc/crypttab is for when you need to decrypt any partition except 'root (/)'. In your use case scenario decryption occurs only in initramfs. \nvim /etc/default/grub\n:\nGRUB_CMDLINE_LINUX=\"cryptdevice=/dev/disk/by-uuid/<UUId>:<luks-disk-name>\" init=/usr/lib/systemd/systemd\"\n:\nGRUB_ENABLE_CRYPTODISK=y\n\nuse_lvmetad = 0\nhttps://wiki.archlinuxjp.org/index.php/%E6%97%A2%E5%AD%98%E3%81%AE_Linux_%E3%81%8B%E3%82%89%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB#lvmetad\nvim /etc/lvm/lvm.conf\n:\nvolume_list = { \"vg1\" }\n:\n\n\nGRUB2\u3092ESP\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff08\u3053\u3053\u3067\u30a8\u30e9\u30fc\u767a\u751f\u4e2d\uff09\ngrub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=gentoo_grub --recheck\n# mkdir /boot/efi/EFI/boot\n# cp /boot/efi/EFI/arch_grub/grubx64.efi  /boot/efi/EFI/boot/bootx64.efi\n# grub-mkconfig -o /boot/grub/grub.cfg\n\n\n\u3053\u308c\u3067\u7d42\u4e86\u306a\u306e\u3067\u3001\u30a2\u30f3\u30de\u30a6\u30f3\u30c8\u3057\u3066\u30ea\u30d6\u30fc\u30c8\nexit\numount -R /mnt/gentoo/\nreboot\n\n\u73fe\u5728\u30d6\u30fc\u30c8\u30d7\u30ed\u30bb\u30b9\u4e2d\u306b\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u3066\u304a\u308a\u307e\u3059\u3002\nLoading initial ramdisk ...\n\u3092\u6700\u5f8c\u306b\u52d5\u304d\u307e\u305b\u3093\u3002\u3002\u3002\n\n[\u89e3\u6c7a\u6e08]\u73fe\u5728grub-install\u3067\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u3066\u304a\u308a\u307e\u3059\u3002\nhttps://teratail.com/questions/61991\n\n\n\u4ee5\u4e0b\u306e\u30b5\u30a4\u30c8\u3092\u53c2\u8003\u306b\u3057\u307e\u3057\u305f\u3002\nhttps://wiki.gentoo.org/wiki/Sakaki%27s_EFI_Install_Guide/Building_the_Gentoo_Base_System_Minus_Kernel\nhttps://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Base/ja\nhttp://note.kurodigi.com/gentoo-uefi-install/\nhttp://ririgon.hatenadiary.jp/entry/20150401/1427821349\nhttps://sharpencryptedpig.noblogs.org/post/2014/05/29/how-to-install-gentoo-hardened-with-encrypted-root-and-swapexpress-procedure/\nhttps://wiki.gentoo.org/wiki/Systemd/ja\nhttps://wiki.gentoo.org/wiki/Intel\nhttps://ja.wikipedia.org/wiki/Intel_HD_Graphics\nhttp://www.hivestream.de/gentoo-installation-with-raid-lvm-luks-and-systemd.html\nhttp://yuex.in/post/2016/12/gentoo-install-mbp-1.html\n\n\n##### UEFI\u30e2\u30fc\u30c9\u304b\u78ba\u8a8d\n\n```\n# ls /sys/firmware/\napci dmi efi memmap\n```\n\n##### \u30ad\u30fc\u30dc\u30fc\u30c9\u30ec\u30a4\u30a2\u30a6\u30c8\u3092\u5909\u66f4\n\n```\n# loadkeys jp106\n```\n\n##### \u7121\u7ddaLAN\u8a2d\u5b9a\n\n```\n# ip link show\n# ip link set <interface> up\n# iwlist <interface> scanning | grep ESSID\n# wpa_supplicant -B -i <interface> -c <(wpa_passphrase <ESSID> <password>)\n# dhcpcd\n# ping google.com\n```\n\n\n##### \u30c7\u30a3\u30b9\u30af\u3092LUKS\u3067\u6697\u53f7\u5316\u3057\u3066\u3044\u308b\u5834\u5408\u306f\u5fa9\u53f7\u5316\n\n```\n# cryptsetup open <device-path> <luks-device-name>\n```\n\n##### \u30c7\u30a3\u30b9\u30af\u30fblvm\u306e\u4f7f\u7528\u72b6\u6cc1\u3092\u78ba\u8a8d\n\n```\n# lsblk\n# df -h\n# lvscan\n```\n\n## \u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u4f5c\u6210\u3059\u308b\u5834\u5408\n\nsda1\u306fESP\uff08ef00\uff09\u306b\u8a2d\u5b9a\nsda2\u306flvm\u7528\uff088e00\uff09\u306b\u8a2d\u5b9a\n\n```\n# gdisk /dev/sdX\nGPT fdisk (gdisk) version 0.8.6\n\nPartition table scan:\n  MBR: not present\n  BSD: not present\n  APM: not present\n  GPT: not present\n \nCreating new GPT entries.\n \nCommand (? for help): o\nThis option deletes all partitions and creates a new protective MBR.\nProceed? (Y/N): y\n \nCommand (? for help): n\nPartition number :\nFirst sector:\nLast sector: +512M\nHex code or GUID: ef00\n \nCommand (? for help): n\nPartition number:\nFirst sector:\nLast sector: \nHex code or GUID: 8e00\n \nCommand (? for help): w\nFinal checks complete. About to write GPT data. THIS WILL OVERWRITE EXISTING\nPARTITIONS!!\n \nDo you want to proceed?: y\nOK; writing new GUID partition table (GPT) to /dev/sda.\nThe operation has completed successfully.\n```\n\n\n##### Logical Volume\u306e\u4f5c\u6210\n\u4f5c\u6210\u3059\u308b\u306e\u306f\u30eb\u30fc\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u307f\u3067\u3059\n\n```\nlvcreate -L 64G vg1 -n <lv-root-name>\n```\n\n\n##### \u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u306e\u4f5c\u6210\next4\u3067\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```\nmkfs.ext4 <lv-root-path>\n```\n\n##### \u30b9\u30ef\u30c3\u30d7\u306f\u30aa\u30f3\u306b\u3059\u308b\n\n```\n# swapon <lv-swap-path>\n```\n\n##### \u30eb\u30fc\u30c8\u3092\u30de\u30a6\u30f3\u30c8\n\n```\n# mount <lv-root-path> /mnt/gentoo\n```\n\n##### EFI\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4f5c\u6210\u3068\u30de\u30a6\u30f3\u30c8\n\n```\nmkdir -p /mnt/gentoo/boot/efi\nmount /dev/sda1 /mnt/gentoo/boot/efi\n```\n\n\u3061\u3083\u3093\u3068\u3067\u304d\u305f\u304b\u78ba\u8a8d\n\n```\n# lsblk\n```\n\n\n##### \u6642\u523b\u3092\u78ba\u8a8d\n\n```\n#date\n```\n\n##### tarball\uff08\u30b9\u30c6\u30fc\u30b83\uff09\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u5c55\u958b\u3057\u307e\u3059\u3002\n\n```\ncd /mnt/gentoo\n\nwget http://ftp.jaist.ac.jp/pub/Linux/Gentoo/releases/amd64/autobuilds/current-stage3-amd64/stage3-amd64-<yyyymmdd>.tar.bz2\n\ntar xvjpf stage3-amd64-<yyyymmdd>.tar.bz2 --xattrs\n```\n\n## make.conf\u306e\u7de8\u96c6\n\nVIDEO_CARDS\u306e\u5024\u306f\u4ee5\u4e0b\u53c2\u7167\n\n```\nlspci | grep VGA\n```\n\nhttps://wiki.gentoo.org/wiki/Intel\nhttps://ja.wikipedia.org/wiki/Intel_HD_Graphics\n\n```\nvi /mnt/gentoo/etc/portage/make.conf\n\n# These settings were set by the catalyst build script that automatically\n# built this stage.\n# Please consult /usr/share/portage/config/make.conf.example for a more\n# detailed example.\nCFLAGS=\"-O2 -pipe\"\nCXXFLAGS=\"${CFLAGS}\"\n\n# WARNING: Changing your CHOST is not something that should be done lightly.\n# Please consult http://www.gentoo.org/doc/en/change-chost.xml before changing.\nCHOST=\"x86_64-pc-linux-gnu\"\n\n# These are the USE and USE_EXPAND flags that were used for\n# buidling in addition to what is provided by the profile.\nUSE=\"bindist\"\nCPU_FLAGS_X86=\"mmx sse sse2\"\n\n# Important Portage directories\nPORTDIR=\"/usr/portage\"\nDISTDIR=\"${PORTDIR}/distfiles\"\nPKGDIR=\"${PORTDIR}/packages\"\n\n# Turn on logging\nPORTAGE_ELOG_CLASSES=\"info warn error log qa\"\nPORTAGE_ELOG_SYSTEM=\"save\"\n\n# Setting for X11\nVIDEO_CARDS=\"intel i965\"\nINPUT_DEVICES=\"evdev synaptics\"\n\nMAKEOPTS=\"-j4\"\nLINGUAS=\"en ja\"\n\nGRUB_PLATFORMS=\"efi-64\"\n```\n\n\n##### \u30df\u30e9\u30fc\u306e\u8a2d\u5b9a\n\n```\nmirrorselect -i -o >> /mnt/gentoo/etc/portage/make.conf\n```\n\n\u4ee5\u4e0b\u3001\u5f15\u7528\n\u30e1\u30a4\u30f3\u306eGentoo\u30ea\u30dd\u30b8\u30c8\u30ea\n\u30df\u30e9\u30fc\u3092\u9078\u629e\u3059\u308b\u305f\u3081\u306b\u6b21\u306b\u91cd\u8981\u306a\u30b9\u30c6\u30c3\u30d7\u306f\u3001/etc/portage/repos.conf/gentoo.conf\u30d5\u30a1\u30a4\u30eb\u3067\u30e1\u30a4\u30f3\u306eGentoo\u30ea\u30dd\u30b8\u30c8\u30ea\u3092\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u3002\n\u3053\u306e\u30d5\u30a1\u30a4\u30eb\u306fPortage\u30c4\u30ea\u30fc\u3092\u66f4\u65b0\u3059\u308b\u3068\u304d\u306b\u5fc5\u8981\u306b\u306a\u308b\u540c\u671f\u60c5\u5831\u3092\u542b\u3093\u3067\u3044\u307e\u3059\nPortage\u30c4\u30ea\u30fc\uff1a\nPortage\u304c\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3001\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u6642\u306b\u5fc5\u8981\u306a\u3059\u3079\u3066\u306e\u60c5\u5831\u3092\u542b\u3080ebuild\u3068\u95a2\u9023\u30d5\u30a1\u30a4\u30eb\u3092\u96c6\u3081\u305f\u3082\u306e\n\n\u30e1\u30a4\u30f3\u306eGentoo\u30ea\u30dd\u30b8\u30c8\u30ea\u306e\u8a2d\u5b9a\u306f\u5358\u7d14\u3067\u3059\u3002\n\u6700\u521d\u306b\uff08\u5b58\u5728\u3057\u306a\u3051\u308c\u3070\uff09repos.conf\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3002 \n\n```\nmkdir /mnt/gentoo/etc/portage/repos.conf\n```\n\n\u6b21\u306b\u3001Portage\u304c\u63d0\u4f9b\u3059\u308bGentoo\u30ea\u30dd\u30b8\u30c8\u30ea\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\uff08\u65b0\u898f\u4f5c\u6210\u3057\u305f\uff09repos.conf\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u30b3\u30d4\u30fc\u3057\u307e\u3059\u3002 \n\n```\ncp /mnt/gentoo/usr/share/portage/config/repos.conf /mnt/gentoo/etc/portage/repos.conf/gentoo.conf\n```\n\n##### DNS\u60c5\u5831\u306e\u30b3\u30d4\u30fc\n/etc/resolv.conf\u3092\u30b3\u30d4\u30fc\u3057\u3066\u304a\u304f\n\n```\ncp -L /etc/resolv.conf /mnt/gentoo/etc/\n```\n\n##### \u8272\u3005\u30de\u30a6\u30f3\u30c8\u3059\u308b\n\u4ee5\u4e0b\u3001\u5f15\u7528\n\u5fc5\u8981\u306a\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3092\u30de\u30a6\u30f3\u30c8\u3059\u308b\n\u65b0\u3057\u3044\u74b0\u5883\u3092\u9069\u5207\u306b\u52d5\u4f5c\u3055\u305b\u308b\u305f\u3081\u306b\u3001\u3044\u304f\u3064\u304b\u306e\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3092\u4f7f\u3048\u308b\u3088\u3046\u306b\u3057\u306a\u3051\u308c\u3070\u306a\u308a\u307e\u305b\u3093\u3002\n/proc/ \nLinux\u30ab\u30fc\u30cd\u30eb\u304b\u3089\u60c5\u5831\u3092\u5f15\u304d\u51fa\u3059\u305f\u3081\u306e\u64ec\u4f3c\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\n/sys/\n/proc/\u540c\u69d8\u3001\u64ec\u4f3c\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3067\u3059\u3002/proc/\u3088\u308a\u69cb\u9020\u5316\u3055\u308c\u3066\u304a\u308a\u3001\u4e00\u5ea6\u306f/proc/\u3092\u7f6e\u304d\u63db\u3048\u308b\u3053\u3068\u304c\u76ee\u7684\n/dev/\n\u901a\u5e38\u306e\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3067\u3059\u3002\u4e00\u90e8\u306fLinux\u306e\u30c7\u30d0\u30a4\u30b9\u7ba1\u7406\u6a5f\u69cb(\u901a\u5e38\u306fudev)\u306b\u3088\u308a\u7ba1\u7406\u3055\u308c\u3066\u304a\u308a\u3001\u3059\u3079\u3066\u306e\u30c7\u30d0\u30a4\u30b9\u30d5\u30a1\u30a4\u30eb\u3092\u542b\u3080\u3002\n\n/proc/\u306f\u3001/mnt/gentoo/proc/\u306b\u30de\u30a6\u30f3\u30c8\u3055\u308c\u308b\u3067\u3057\u3087\u3046\u3002\n\u4ed6\u306e\uff12\u3064\u306fbind\u30de\u30a6\u30f3\u30c8\u3055\u308c\u307e\u3059\u3002\n\n```\nmount -t proc proc /mnt/gentoo/proc\nmount --rbind /sys /mnt/gentoo/sys\nmount --make-rslave /mnt/gentoo/sys\nmount --rbind /dev /mnt/gentoo/dev\nmount --make-rslave /mnt/gentoo/dev\n```\n\n##### chroot\u3057\u307e\u3059\u3002\n\n```\nchroot /mnt/gentoo /bin/bash\nsource /etc/profile\nexport PS1=\"(chroot) $PS1\"\n```\n\n\n##### portage\u306e\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\n\n```\nemerge-webrsync\n```\n\nPortage\u30c4\u30ea\u30fc\u3092\u6700\u65b0\u7248\u306b\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\n\uff08\u3084\u3089\u306a\u304f\u3066\u3082\u3088\u3044\u3068\u516c\u5f0fHP\u306b\u66f8\u3044\u3066\u3042\u308a\u307e\u3057\u305f\u3002\u7d50\u69cb\u9577\u304b\u3063\u305f\u3067\u3059\u3002\uff09\n\n```\nemerge --sync --quiet\n```\n\nPortage\u304b\u3089\u306e\u30cb\u30e5\u30fc\u30b9\n\u98db\u3070\u3057\u307e\u3059\n\n\n##### \u9078\u629e\u3067\u304d\u308b\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u306e\u78ba\u8a8d\n\n```\neselect profile list\n```\n##### \u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u3092\u5909\u66f4\n\n```\neselect profile set default/linux/amd64/13.0/desktop/gnome/systemd\n```\n\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u306e\u5909\u66f4\u3092\u78ba\u8a8d\n\n```\neselect profile list\n```\n##### \u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u3092\u5909\u66f4\u3057\u305f\u306e\u3067\u3001\u66f4\u65b0\u3059\u308b\n\n```\nemerge --ask --update --deep --newuse @world\n```\n\n\n##### \u7121\u7ddaLAN\u30c4\u30fc\u30eb\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u304a\u304f\n\n```\nemerge -av net-wireless/wireless-tools net-wireless/wpa_supplicant net-misc/dhcpcd\n```\n\n\n##### \u3044\u308d\u3044\u308demerge\n\n```\n# emerge -av vim app-misc/screen cryptsetup lvm2\n```\n\n\n##### \u30ed\u30b1\u30fc\u30eb\u3092\u8a2d\u5b9a\u3059\u308b\u3002\n\n```\nls /usr/share/zoneinfo\necho \"Japan\" > /etc/timezone\nemerge --config sys-libs/timezone-data\n```\n\n```\nvim /etc/locale.gen\n:\nen_US.UTF-8 UTF-8\n:\njp_JP.UTF-8 UTF-8\n:\n```\n\n\n```\nlocale-gen\neselect locale list\neselect locale set [0-9]\nenv-update\nsource /etc/profile\nexport PS1=\"(chroot) $PS1\"\n```\n\n\n##### genkernel\u3067\u306f\u306a\u304f\u30de\u30cb\u30e5\u30a2\u30eb\u3067\u30ab\u30fc\u30cd\u30eb\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\u30ab\u30fc\u30cd\u30eb\u30bd\u30fc\u30b9\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u30ab\u30fc\u30cd\u30eb\u30bd\u30fc\u30b9\u3092/usr/src/\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\n\n```\nemerge -av sys-kernel/gentoo-sources\n```\n\n## \u30ab\u30fc\u30cd\u30eb\u3092Make\n##### \u30ab\u30fc\u30cd\u30eb\u30b3\u30f3\u30d5\u30a3\u30ae\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u8a2d\u5b9a\u3092\u3059\u308b\n\n```\ncd /usr/src/linux\nmake menuconfig\n```\n\n```\n    Gentoo Linux --->\n            [*] Gentoo Linux support (NEW)\n            [*] Linux dynamic and persistent device naming (userspace devfs) support (NEW)\n            [*] Select options required by Portage features (NEW)\n          Support for init systems, system and service managers --->\n            [*] OpenRC, runit and other script based systems and managers\n            [*] systemd\n[*] 64-bit kernel\n    General Setup --->\n      ()  Cross-compiler tool prefix (NEW)\n      [ ] Compile also drivers which will not load (NEW)\n      ()  Local version - append to kernel release (NEW)\n      [ ] Automatically append version information to the version string\n          Kernel compression mode (Gzip) --->\n      ((none)) Default hostname (NEW)\n      [*] Support for paging of anonymous memory (swap) (NEW)\n      :\n      -*- System V IPC\n      :\n      -*- Control Group support --->\n            --- Control Group support\n            [ ]   Example debug cgroup subsystem\n            [*]   Freezer cgroup subsystem\n            :\n            [*]   Device controller for cgroups\n            [*]   Cpuset support\n            [*]     Include legacy /proc/<pid>/cpuset file\n            [*]   Simple CPU accounting cgroup subsystem\n            [*]   Resource counters\n            [*]     Memory Resource Controller for Control Groups\n            [*]       Memory Resource Controller Swap Extension\n            [*]         Memory Resource Controller Swap Extension enabled by default\n            [*]       Memory Resource Controller for Kernel Memory accounting\n            [ ]     HugeTLB Resource Controller for Control Groups\n            [*]   Enable perf_event per-cpu per-container group (cgroup) monitoring\n            [*]   Group CPU scheduler --->\n            [*]   Block IO contoroller\n            [ ]     Enable Block IO controller debugging\n      -*- Namespaces support --->\n            --- Namespaces support\n            [*] UTS namespace\n            [*] IPC namespace\n            [*] User namepace\n            [*] PID Namespaces\n            -*- Network namespace\n      :\n      [*] Initial RAM filesystem and RAM disk (initramfs/initrd) support\n      :\n      [*] Configure standard kernel features (expert users)  --->\n            :\n            [*] Enable eventpoll support\n            [*] Enable signalfd() system call\n            [*] Enable timerfd() system call\n      :\n    -*- Enable the block layer --->\n      --- Enable the block layer\n          Partition Types --->\n             :\n            [*]   EFI GUID partition support\n \n    Processor type and features --->\n      :\n      [*] EFI runtime service support\n      [*]   EFI stub support\n      [ ]     EFI mixed-mode support\n       :\n      [*] Built-in kernel command line\n      :\n    :\n    Device Drivers --->\n          Generic Driver Options --->\n            [*] Support for uevent helper\n            (/sbin/hotplug)    path to uevent helper\n          :\n          Multiple devices driver support (RAID and LVM)  --->\n                 <*> Device mapper support\n                 <*> Crypt target support\n                 <*> Snapshot target\n                 <*> Mirror target\n                 <*> Multipath target\n                 <*>   I/O Path Selector based on the number of in-flight I/Os\n                 <*>   I/O Path Selector based on the service time\n\n    Firmware Drivers --->\n          EFI (Extensible Firmware Interface)  Support >\n                 <*> EFI Variable Support via sysfs\n-*- Cryptographic API\n     <*>  SHA256 digest algorithm (SSSE3/AVX/AVX2)\n     <*>  SHA512 digest algorithm\n     <*>  AES cipher algorithms (x86_64)\n```\n\n##### \u30ab\u30fc\u30cd\u30eb\u306e\u30b3\u30f3\u30d1\u30a4\u30eb\u3068\u30e2\u30b8\u30e5\u30fc\u30eb\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3068\u30ab\u30fc\u30cd\u30eb\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```\nmake && make modules_install && make install\n```\n\n## initramfs\u306e\u751f\u6210\n\n\u6b21\u56de\u306fdracut\u3067\u3084\u3063\u3066\u307f\u3088\u3046\nhttp://www.hivestream.de/gentoo-installation-with-raid-lvm-luks-and-systemd.html\n\ngenkernel\u306eemerge\n\n```\n# echo \"sys-kernel/genkernel-next cryptsetup\" > /etc/portage/package.use/genkernel-next\n# emerge -av genkernel-next\n```\n\n## initramfs\u306e\u4f5c\u6210\n\n```\ngenkernel --udev \u2013-lvm \u2013-luks \u2013-install initramfs\nls /boot/initramfs*\n```\n\n\u4ee5\u4e0b\u5f15\u7528\n/etc/mtab\n\n\u958b\u767a\u5143\u306f\u3001 /etc/mtab \u30d5\u30a1\u30a4\u30eb\u304c /proc/self/mounts \u3078\u306e\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3067\u3042\u308b\u74b0\u5883\u306e\u307f\u3092\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u3044\u307e\u3059\u3002\n\u307e\u305f\u3001\u3053\u306e\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u304c\u5b58\u5728\u3057\u306a\u3044\u5834\u5408\u3001mount (bug #434090) \u304a\u3088\u3073 df (bug #477240) \u306b\u3082\u554f\u984c\u304c\u767a\u751f\u3057\u307e\u3059\u3002\n\u304b\u3064\u3066\u4e00\u90e8\u306e\u30e6\u30fc\u30c6\u30a3\u30ea\u30c6\u30a3\u304c\u30de\u30a6\u30f3\u30c8\u30aa\u30d7\u30b7\u30e7\u30f3\u306a\u3069\u3092\u66f8\u304d\u8fbc\u3093\u3067\u3044\u305f\u305f\u3081\u3001/etc/mtab \u306f\u901a\u5e38\u306e\u30d5\u30a1\u30a4\u30eb\u3067\u3042\u308b\u3053\u3068\u304c\u671f\u5f85\u3055\u308c\u3066\u3044\u307e\u3057\u305f\u304c\u3001\u73fe\u5728\u3067\u306f\u3042\u3089\u3086\u308b\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u304c\u5bfe\u7b56\u3092\u7d42\u3048\u3066\u3044\u308b\u3082\u306e\u3068\u601d\u308f\u308c\u307e\u3059\u3002\n\u3068\u306f\u3044\u3048\u5ff5\u306e\u305f\u3081\u3001\u30d5\u30a1\u30a4\u30eb\u3092\u30ea\u30f3\u30af\u306b\u5909\u66f4\u3059\u308b\u4f5c\u696d\u3092\u884c\u3046\u524d\u306b\u3001 bug #477498 \u3092\u95b2\u89a7\u306e\u4e0a\u3001\u30b7\u30b9\u30c6\u30e0\u304c\u65e2\u77e5\u306e\u554f\u984c\u3092\u62b1\u3048\u3066\u3044\u306a\u3044\u3053\u3068\u3092\u304a\u78ba\u304b\u3081\u304f\u3060\u3055\u3044\u3002\n\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3092\u4f5c\u6210\u3059\u308b\u306b\u306f\u3001\u4ee5\u4e0b\u3092\u5b9f\u884c\u3057\u307e\u3059: \n\n```\n# ln -sf /proc/self/mounts /etc/mtab\n```\n\n\n\nLVM \u3092\u4f7f\u7528\u3059\u308b\u30b7\u30b9\u30c6\u30e0\u3067\u306f\u3001LVM \u30dc\u30ea\u30e5\u30fc\u30e0\u3092\u30de\u30a6\u30f3\u30c8\u3059\u308b\u305f\u3081\u3001systemd \u3068\u5171\u306b lvmetad \u30c7\u30fc\u30e2\u30f3\u304c\u8d77\u52d5\u3055\u308c\u306a\u3051\u308c\u3070\u306a\u308a\u307e\u305b\u3093\u3002\nlvmetad \u306f /etc/lvm/lvm.conf \u3067\u6709\u52b9\u5316\u3067\u304d\u307e\u3059:\n\n```\n# vim /etc/lvm/lvm.conf\n:\nuse_lvmetad = 1\n:\n```\n\n\u4efb\u610f\u81ea\u7531\u9078\u629e: \u30d5\u30a1\u30fc\u30e0\u30a6\u30a7\u30a2\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```\nemerge -av sys-kernel/linux-firmware\n```\n\n##### \u81ea\u52d5\u30de\u30a6\u30f3\u30c8\u306e\u8a2d\u5b9a\n\u307e\u305a\u3001\u30b3\u30d4\u30da\u3067\u304d\u308b\u3088\u3046\u306bUUID\u3092/etc/fstab\u306b\u8ffd\u8a18\u3057\u307e\u3059\u3002\n\n```\nblkid >> /etc/fstab\n```\n\n/etc/fstab\u3092\u7de8\u96c6\u3059\u308b\n\n```\nvim /etc/fstab\n:\n# <fs>            <mountpoint>    <type>     <opts>                  <dump/pass>\nUUID=<UUID>       /               ext4       defaults,noatime        0 1\nUUID=<UUID>       /boot/efi       vfat       defaults,noatime        0 2\nUUID=<UUID>       none            swap       sw                      0 0\n:\n```\n\n##### \u30db\u30b9\u30c8\u30cd\u30fc\u30e0\u306e\u8a2d\u5b9a\n\n```\necho <hostname> > /etc/conf.d/hostname\n```\n\n##### \u30eb\u30fc\u30c8\u30d1\u30b9\u30ef\u30fc\u30c9\u306e\u8a2d\u5b9a\n\n```\npasswd root\n```\n\n##### \u30ad\u30fc\u30de\u30c3\u30d7\u306e\u8a2d\u5b9a\n\n```\nvim /etc/conf.d/keymaps\n:\nkeymap=\"jp106\"\n:\n```\n\n\u30b5\u30fc\u30d3\u30b9\u30fb\u30c7\u30fc\u30e2\u30f3\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u3084\u3089\u306a\u304b\u3063\u305f\n\n```\nemerge -av app-admin/sysklogd sys-apps/systemd net-misc/dhcpcd\n```\n\n/etc/hosts\u306e\u7de8\u96c6\n\n```\nvim /etc/hosts\n:\n# IPv4 and IPv6 localhost aliases\n127.0.0.1       localhost <hostname>\n::1             localhost <hostname>\n:\n```\n\n## \u30d6\u30fc\u30c8\u30ed\u30fc\u30c0\u30fc\n\nGRUB2\u3068sys-fs/dosfstool\u3068efibootmgr\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nlvm\u3068luks\u3092\u4f7f\u7528\u3059\u308b\u305f\u3081\u306b\u306fGRUB\u304cdevice mapper\u3092\u30b5\u30dd\u30fc\u30c8\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n```\n# echo \"sys-boot/grub:2 device-mapper\" >> /etc/portage/package.use/grub:2\n# emerge -av sys-boot/grub:2 sys-fs/dosfstools sys-boot/efibootmgr\n# emerge -av sys-fs/dosfstools sys-boot/efibootmgr\n```\n\n\n/etc/default/grub\u3092\u7de8\u96c6\n\n Note\ndracut \u304c systemd \u3092\u3068\u308a\u3053\u3093\u3067\u751f\u6210\u3057\u305f initramfs \u3092\u4f7f\u7528\u3059\u308b\u3068\u304d\u306b\u306f\u3001\u3053\u306e\u4f5c\u696d\u306f\u5fc5\u8981\u3042\u308a\u307e\u305b\u3093\u3002initramfs \u304c systemd \u3092\u8d77\u52d5\u3059\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\nFILE /etc/default/grubConfigure GRUB2 for systemd\n\n/etc/crypttab is for when you need to decrypt any partition except 'root (/)'. In your use case scenario decryption occurs only in initramfs. \n\n```\nvim /etc/default/grub\n:\nGRUB_CMDLINE_LINUX=\"cryptdevice=/dev/disk/by-uuid/<UUId>:<luks-disk-name>\" init=/usr/lib/systemd/systemd\"\n:\nGRUB_ENABLE_CRYPTODISK=y\n```\n\nuse_lvmetad = 0\nhttps://wiki.archlinuxjp.org/index.php/%E6%97%A2%E5%AD%98%E3%81%AE_Linux_%E3%81%8B%E3%82%89%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB#lvmetad\n\n```\nvim /etc/lvm/lvm.conf\n:\nvolume_list = { \"vg1\" }\n:\n```\n\n\n##### GRUB2\u3092ESP\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff08\u3053\u3053\u3067\u30a8\u30e9\u30fc\u767a\u751f\u4e2d\uff09\n\n```\ngrub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=gentoo_grub --recheck\n# mkdir /boot/efi/EFI/boot\n# cp /boot/efi/EFI/arch_grub/grubx64.efi  /boot/efi/EFI/boot/bootx64.efi\n# grub-mkconfig -o /boot/grub/grub.cfg\n```\n\n##### \u3053\u308c\u3067\u7d42\u4e86\u306a\u306e\u3067\u3001\u30a2\u30f3\u30de\u30a6\u30f3\u30c8\u3057\u3066\u30ea\u30d6\u30fc\u30c8\n\n```\nexit\numount -R /mnt/gentoo/\nreboot\n```\n", "tags": ["Gentoo"]}