{"tags": ["R", "statistics", "RStan", "Stan", "RStudio"], "context": "\u3053\u306e\u8a18\u4e8b\u306f Stan Advent Calendar 2016 \u306e17\u65e5\u76ee\u306e\u8a18\u4e8b\u3067\u3059\u3002\u76ee\u4e0b\u52c9\u5f37\u3057\u306a\u304c\u3089\u306e\u57f7\u7b46\u306e\u305f\u3081\uff0c\u3082\u3057\u9593\u9055\u3044\u3084\u3082\u3063\u3068\u52b9\u7387\u7684\u306a\u65b9\u6cd5\u304c\u3042\u308c\u3070\uff0c\u3054\u6307\u6458\u3092\u3044\u305f\u3060\u3051\u308c\u3070\u5e78\u3044\u3067\u3059\u3002\n\n\n\u306f\u3058\u3081\u306b\n\u5a92\u4ecb\u5206\u6790\u306b\u3064\u3044\u3066\u306f\uff0c\u3053\u3061\u3089\u306e\u30b5\u30a4\u30c8\u3092\u3054\u53c2\u7167\u304f\u3060\u3055\u3044\u3002\u3053\u306e\u30b5\u30a4\u30c8\u3067\u306f\uff0c\u91ce\u7403\u9078\u624b\u306e\u4f53\u91cd\uff08weight\uff09\u304c\u91cd\u304f\u306a\u308b\u307b\u3069\uff0c\u30db\u30fc\u30e0\u30e9\u30f3\u6570\uff08HR\uff09\u304c\u5897\u3048\u305f\u7d50\u679c\uff0c\u5e74\u53ce\uff08salary\uff09\u304c\u5897\u3048\u308b\u3068\u3044\u3046\uff0c\u5a92\u4ecb\u904e\u7a0b\u3092\u4f8b\u306b\u8aac\u660e\u3092\u884c\u3063\u3066\u3044\u307e\u3059\u3002Stan\u30b3\u30fc\u30c9\u3082\u516c\u958b\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\u306a\u304a\u672c\u8a18\u4e8b\u3067\u306f\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u6570\u3092\u7565\u8a18\u3059\u308b\u3053\u3068\u306b\u3057\u307e\u3059\u3002\n- X\uff1a\u8aac\u660e\u5909\u6570\n- M\uff1a\u5a92\u4ecb\u5909\u6570\n- Y\uff1a\u5fdc\u7b54\u5909\u6570\n\n\u968e\u5c64\u6027\u304c\u3042\u308b\u5a92\u4ecb\u30e2\u30c7\u30eb\uff08\u30de\u30eb\u30c1\u30ec\u30d9\u30eb\u5a92\u4ecb\u30e2\u30c7\u30eb\uff09\n\u4e0a\u8a18\u306e\u91ce\u7403\u306e\u30c7\u30fc\u30bf\u3067\u306f\uff0c\u5404\u5909\u6570\uff08\u4f53\u91cd\uff0c\u30db\u30fc\u30e0\u30e9\u30f3\u6570\uff0c\u5e74\u53ce\uff09\u306e\u5024\u306f\uff0c\u500b\u4eba\u306b\u3064\u304d\u4e00\u3064\u3067\u3057\u305f\u3002\u3057\u304b\u3057\uff0c\u3053\u308c\u3089\u306e\u30c7\u30fc\u30bf\u3092\u8907\u6570\u56de\u6e2c\u5b9a\u3059\u308c\u3070\uff0c\u3042\u308b\u5909\u6570\u306b\u3064\u3044\u3066\u500b\u4eba\u306e\u4e2d\u306b\u8907\u6570\u306e\u5024\u304c\u5b58\u5728\u3059\u308b\u3053\u3068\u306b\u306a\u308a\uff0c\u968e\u5c64\u6027\u304c\u751f\u307e\u308c\u307e\u3059\uff08\u4f8b\uff1a\u4f53\u91cd\u306e\u8a08\u6e2c1\u56de\u76ee70kg\uff0c2\u56de\u76ee71kg\uff0c3\u56de\u76ee69kg...\uff09\u3002\n\u3042\u308b\u3044\u306f\uff0c\u7403\u56e3\u3068\u9078\u624b\u306e\u95a2\u4fc2\u3092\u8003\u3048\u3066\u307f\u308b\u3068\uff0c\u9078\u624b\u306f\u3069\u3053\u304b\u306e\u7403\u56e3\u306b\u6240\u5c5e\u3057\u3066\u3044\u308b\u306e\u3067\uff0c\u3084\u306f\u308a\u968e\u5c64\u7684\u306a\u30c7\u30fc\u30bf\u3068\u307f\u306a\u3059\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\uff08\u4f8b\uff1a\u540c\u4e00\u7403\u56e3\u5185\u306e\u9078\u624bA\uff0c\u9078\u624bB\uff0c\u9078\u624bC...\uff09\n\u901a\u5e38\u306e\u56de\u5e30\u5206\u6790\u306f\uff0c\u6b8b\u5dee\u304c\u72ec\u7acb\u3067\u3042\u308b\u3053\u3068\u3092\u4eee\u5b9a\u3057\u307e\u3059\u304c\uff0c\u30c7\u30fc\u30bf\u306b\u968e\u5c64\u6027\u304c\u5b58\u5728\u3059\u308b\u5834\u5408\u306f\uff0c\u305d\u306e\u524d\u63d0\u304c\u5d29\u308c\u308b\u6050\u308c\u304c\u3042\u308a\u307e\u3059\u3002\u305d\u3053\u3067\uff0c\u30de\u30eb\u30c1\u30ec\u30d9\u30eb\u30e2\u30c7\u30eb\u3084\u968e\u5c64\u7dda\u5f62\u30e2\u30c7\u30eb\uff0c\u7dda\u5f62\u6df7\u5408\u30e2\u30c7\u30eb\u3068\u547c\u3070\u308c\u308b\u65b9\u6cd5\u306b\u3088\u308a\uff0c\u968e\u5c64\u306e\u4e0a\u4f4d\u3054\u3068\uff0c\u4e0b\u4f4d\u3054\u3068\u306e\u9055\u3044\u3082\u30e2\u30c7\u30ea\u30f3\u30b0\u3057\u307e\u3059\u3002\u9078\u624b\u306e\u30c7\u30fc\u30bf\u3092\u6570\u56de\u8a08\u6e2c\u3059\u308b\u5834\u5408\u3092\u4f8b\u306b\u6319\u3052\u308b\u3068\uff0c\u8a08\u6e2c\u9593\u3067\u306e\u9055\u3044\u3068\u9078\u624b\u9593\u306e\u9055\u3044\u3092\uff0c\u305d\u308c\u305e\u308c\u30e2\u30c7\u30ea\u30f3\u30b0\u3059\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\u305d\u306e\u3046\u3048\u3067\uff0c\u4ee5\u4e0b\u4e8c\u3064\u306e\u52b9\u679c\u306e\u7a4d\u3068\u3057\u3066\u9593\u63a5\u52b9\u679c\u3092\u5c0e\u51fa\u3057\u307e\u3059\u3002\n- X\u304cM\u306b\u53ca\u307c\u3059\u5f71\u97ff\n- M\u304cY\u306b\u53ca\u307c\u3059\u5f71\u97ff\n\n\u5b9f\u8df5\n\u5b9f\u306f\uff0cStan\u3067\u30de\u30eb\u30c1\u30ec\u30d9\u30eb\u5a92\u4ecb\u30e2\u30c7\u30eb\u306b\u3088\u308b\u5206\u6790\u3092\u884c\u3046\u305f\u3081\u306e\uff0cbmlm\u3068\u3044\u3046R\u30d1\u30c3\u30b1\u30fc\u30b8\u304c\u5b58\u5728\u3057\u307e\u3059\u3002\u3082\u3046\u3053\u308c\u3092\u4f7f\u3048\u3070\u3044\u3044\u3067\u3059\u306d\u3002\n\u3000\u3000\n...\u3067\u306f\u8a71\u304c\u7d42\u308f\u3063\u3066\u3057\u307e\u3046\u306e\u3067\uff0c\u3053\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u304b\u3089\u30b5\u30f3\u30d7\u30eb\u30c7\u30fc\u30bf\u3092\u62dd\u501f\u3057\u3066\uff0c\u81ea\u5206\u3067Stan\u30b3\u30fc\u30c9\u3092\u66f8\u3044\u3066\u307f\u307e\u3059\u3002\u4f7f\u7528\u3059\u308b\u306e\u306f\uff0cBLch9\u3068\u3044\u3046\u30c7\u30fc\u30bf\u30bb\u30c3\u30c8\u3067\u3059\u3002100\u540d\u306b\u5bfe\u3057\u3066\u7d4c\u6642\u7684\u306a\u30c7\u30fc\u30bf\u309221\u56de\u306b\u308f\u305f\u308a\u6e2c\u5b9a\u3057\u305f\u3001\u968e\u5c64\u6027\u306e\u3042\u308b\u30c7\u30fc\u30bf\u3067\u3059\u3002\u500b\u4eba\u3092\u8b58\u5225\u3059\u308b\u5909\u6570'id'\u306b\u52a0\u3048\uff0c'fwkstrs'\uff0c'fwkdis'\uff0c'freldis'\uff0c\u3068\u3044\u3046\u4e09\u3064\u306e\u5909\u6570\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\u5909\u6570\u540d\u304c\u4f3c\u3066\u3044\u308b\u306e\u3067\uff0c\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u6539\u540d\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n- X\uff08\u5143\u306ffwkstrs\uff09\uff1a\u4ed5\u4e8b\u306b\u304a\u3051\u308b\u30b9\u30c8\u30ec\u30c3\u30b5\u30fc\u306e\u6570\n- M\uff08\u5143\u306ffwkdis\uff09\uff1a\u4ed5\u4e8b\u3078\u306e\u4e0d\u6e80\u306e\u5927\u304d\u3055\n- Y\uff08\u5143\u306ffreldis\uff09\uff1a\u4eba\u9593\u95a2\u4fc2\u3078\u306e\u4e0d\u6e80\u306e\u5927\u304d\u3055\n\u307e\u305f\uff0c\u5143\u30c7\u30fc\u30bf\u3067\u306f\u500b\u4ebaID\u306f101~200\u306e100\u540d\u5206\u5b58\u5728\u3057\u307e\u3059\u304c\uff0c\u5206\u304b\u308a\u3084\u3059\u3055\u306e\u305f\u3081\uff0c1~100\u306b\u5909\u3048\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\nsample_data\nlibrary(bmlm)\nlibrary(dplyr)\n\ndata(BLch9)\ndat <- BLch9 %>%\n  dplyr::select(id, fwkstrs, fwkdis, freldis) %>% \n  dplyr::rename(X=fwkstrs, M=fwkdis, Y=freldis)\ndat$id <- dat$id - 100\n\n\n\n\n\u30c7\u30fc\u30bf\u53ef\u8996\u5316\n\u307e\u305a\u30c7\u30fc\u30bf\u306e\u7279\u5fb4\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\u3072\u3068\u307e\u305a\u500b\u4eba\u5dee\u3092\u8003\u616e\u305b\u305a\uff0c2100\u884c\u306e\u30c7\u30fc\u30bf\u3092\u7528\u3044\u3066\u6563\u5e03\u56f3\u3092\u63cf\u3044\u3066\u307f\u307e\u3059\u3002\n\nvisualization2\nlibrary(GGally)\n\ndat %>% \n  dplyr::select(-id) %>% \n  GGally::ggpairs()\n\n\n\n\u4ee5\u964d\u306e\u5206\u6790\u3067\u306f\uff0c\u5404\u5909\u6570\u306f\u6b63\u898f\u5206\u5e03\u3059\u308b\u3082\u306e\u3068\u4eee\u5b9a\u3059\u308b\u3053\u3068\u306b\u3057\u307e\u3059\u3002\n\u6b21\u306b\uff0cX\u304cM\u306b\u53ca\u307c\u3059\u5f71\u97ff\uff0cM\u304cY\u306b\u53ca\u307c\u3059\u5f71\u97ff\u306b\u306f\uff0c\u500b\u4eba\u5dee\u304c\u5b58\u5728\u3059\u308b\u304b\u3069\u3046\u304b\u3092\u8996\u899a\u5316\u3057\u307e\u3059\u3002100\u540d\u5206\u306e\u30c7\u30fc\u30bf\u3092\u63cf\u753b\u3059\u308b\u3068\u7169\u96d1\u306b\u306a\u308b\u306e\u3067\uff0cID1~10\u306e10\u540d\u3092\u629c\u7c8b\u3057\u307e\u3059\u3002\n\nvisualization2\nlibrary(ggplot2)\nlibrary(cowplot)\n\ntemp <- dat %>% dplyr::filter(id<=10)\ntemp$id <- as.factor(temp$id)\n\ng1<- ggplot(data=temp, aes(y=M, x=X, color=id))+\n  stat_smooth(method=\"lm\", se=FALSE)\ng2<- ggplot(data=temp, aes(y=Y, x=M, color=id))+\n  stat_smooth(method=\"lm\", se=FALSE)\n\ng <- cowplot::plot_grid(g1, g2, labels=c(\"X->M model\", \"M->Y model\"), align=\"h\") \nprint(g)\n\n\n\n\u5207\u7247\u3082\u50be\u304d\u3082\uff0c\u500b\u4eba\u3054\u3068\u306b\u3070\u3089\u3070\u3089\u3067\u3059\u3002\u305d\u3053\u3067\uff0c\u5207\u7247\u3068\u50be\u304d\u306b\u500b\u4eba\u5dee\u3092\u4eee\u5b9a\u3057\u305f\u30e2\u30c7\u30ea\u30f3\u30b0\u3092\u884c\u3044\u307e\u3059\u3002\n\n\u5909\u91cf\u52b9\u679c\u9593\u306b\u76f8\u95a2\u3092\u4eee\u5b9a\u201d\u3057\u306a\u3044\u201d\u5834\u5408\u306eStan\u30b3\u30fc\u30c9\n\u30bf\u30a4\u30c8\u30eb\u306f\u3072\u3068\u307e\u305a\u7121\u8996\u3057\u3066\u8aad\u307f\u9032\u3081\u3066\u304f\u3060\u3055\u3044\u3002\n\u672c\u8a18\u4e8b\u3067\u306f\uff0cStan\u3068R\u3067\u30d9\u30a4\u30ba\u7d71\u8a08\u30e2\u30c7\u30ea\u30f3\u30b0\u306e\u7b2c8\u7ae0\uff08\u968e\u5c64\u30e2\u30c7\u30eb\uff09\u3092\u53c2\u8003\u306b\u3055\u305b\u3066\u3044\u305f\u3060\u304d\u307e\u3057\u305f\u3002\u3053\u306e\u7ae0\u3067\u306f\uff0c\u5358\u56de\u5e30\u5206\u6790\u306b\u304a\u3044\u3066\uff0c\u5207\u7247\u3068\u50be\u304d\u306b\u500b\u4eba\u5dee\u3092\u4eee\u5b9a\u3057\u305f\u5834\u5408\u306e\u5206\u6790\u4f8b\u304c\u7d39\u4ecb\u3055\u308c\u3066\u3044\u307e\u3059\uff08'model8-4.stan'\uff09\u3002\n\nmultilevel_mediation1\ndata {\n  int N;                               \n  int K;                            //\u30b0\u30eb\u30fc\u30d7\u6570\n  real X[N];                        //\u8aac\u660e\u5909\u6570\n  real Y[N];                        //\u5fdc\u7b54\u5909\u6570\n  int<lower=1, upper=K> KID[N];     //\u30b0\u30eb\u30fc\u30d7\u3092\u8b58\u5225\u3059\u308bID\n}\n\nparameters {\n  real a0;                          //\u5207\u7247\u306e\u5168\u4f53\u5e73\u5747\n  real b0;                          //X\u306e\u4fc2\u6570\u306e\u5168\u4f53\u5e73\u5747\n  real a[K];                        //\u30b0\u30eb\u30fc\u30d7\u3054\u3068\u306e\u5207\u7247\n  real b[K];                        //\u30b0\u30eb\u30fc\u30d7\u3054\u3068\u306e\u50be\u304d\n  real<lower=0> s_a;                //\u5207\u7247\u306e\u30b0\u30eb\u30fc\u30d7\u9593\u3067\u306e\u3070\u3089\u3064\u304d\n  real<lower=0> s_b;                //X\u306e\u50be\u304d\u306e\u30b0\u30eb\u30fc\u30d7\u9593\u3067\u306e\u3070\u3089\u3064\u304d\n  real<lower=0> s_Y;                //\u5fdc\u7b54\u5909\u6570\u306e\u3070\u3089\u3064\u304d\n}\n\nmodel {\n  for (k in 1:K) {\n    a[k] ~ normal(a0, s_a);         //\u5207\u7247\u306e\u30b0\u30eb\u30fc\u30d7\u5dee\u306f\uff0c\u3053\u306e\u6b63\u898f\u5206\u5e03\u304b\u3089\u767a\u751f\n    b[k] ~ normal(b0, s_b);         //X\u306e\u50be\u304d\u306e\u30b0\u30eb\u30fc\u30d7\u5dee\u306f\uff0c\u3053\u306e\u6b63\u898f\u5206\u5e03\u304b\u3089\u767a\u751f\n  }\n\n  for (n in 1:N)                    //\u5fdc\u7b54\u5909\u6570\u306b\u95a2\u3059\u308b\u78ba\u7387\u30e2\u30c7\u30eb\n    Y[n] ~ normal(a[KID[n]] + b[KID[n]]*X[n], s_Y);\n}\n\n\n\n\u3053\u306e\u30b3\u30fc\u30c9\u3092\u30de\u30eb\u30c1\u30ec\u30d9\u30eb\u5a92\u4ecb\u30e2\u30c7\u30eb\u306b\u9069\u7528\u3059\u308b\u305f\u3081\u306b\u306f\uff0c\u4ee5\u4e0b2\u70b9\u306e\u8ffd\u8a18\u304c\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\u3002\n1. X\u304c\u8907\u6570\u5b58\u5728\u3059\u308b\uff0c\u91cd\u56de\u5e30\u5206\u6790\u306e\u30b3\u30fc\u30c9\u3092\u52a0\u7b46\n2. \u56de\u5e30\u4fc2\u6570\u3092\u639b\u3051\u5408\u308f\u305b\u3066\uff0c\u9593\u63a5\u52b9\u679c\u3092\u6c42\u3081\u308b\u30b3\u30fc\u30c9\u3092\u52a0\u7b46\n\u307e\u305a1\u70b9\u76ee\u306b\u3064\u3044\u3066\u3002\n\u5a92\u4ecb\u5206\u6790\u306f\uff0cX->Y\u306e\u76f4\u63a5\u7684\u306a\u95a2\u4fc2\u3092\uff0cX->M\uff0cM->Y\u3068\u3044\u3046\u9593\u63a5\u7684\u306a\u95a2\u4fc2\u3068\u3057\u3066\u8868\u73fe\u3067\u304d\u308b\u304b\u3069\u3046\u304b\u3092\u77e5\u308b\u305f\u3081\u306e\u5206\u6790\u3067\u3057\u305f\u3002\u3053\u3053\u3067X->M\u306e\u5206\u6790\u306f\uff0c\u307e\u3055\u306b\u5358\u56de\u5e30\u5206\u6790\u306b\u76f8\u5f53\u3057\u307e\u3059\u3002\u3057\u305f\u304c\u3063\u3066\uff0c\u4e0a\u8a18\u306eStan\u30b3\u30fc\u30c9\u3092\u305d\u306e\u307e\u307e\u62dd\u501f\u3059\u308b\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002\u305f\u3060\u3057\uff0cX\u3067\u4e88\u6e2c\u3057\u305f\u3044\u306e\u306fY\u3067\u306f\u306a\u304fM\u3067\u3059\u304b\u3089\uff0c\u305d\u306e\u70b9\u3092\u66f8\u304d\u63db\u3048\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u307e\u305f\uff0c\u3053\u306e\u30b3\u30fc\u30c9\u5185\u3067\u306fX->M\u30e2\u30c7\u30eb\u306b\u304a\u3051\u308b\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u63a8\u5b9a\u3057\u305f\u3044\u3053\u3068\u304c\u5206\u304b\u308b\u3088\u3046\u306b\uff0c\u30d1\u30e9\u30e1\u30fc\u30bf\u540d\u306e\u6700\u5f8c\u306b'__M'\u3068\u52a0\u7b46\u3057\u3066\u304a\u304d\u307e\u3059\u3002\nM->Y\u30e2\u30c7\u30eb\u3082\u4e00\u898b\u3059\u308b\u3068\u5358\u56de\u5e30\u5206\u6790\u306b\u898b\u3048\u307e\u3059\u304c\uff0cM\u306e\u80cc\u5f8c\u306b\u306fX\u304c\u5b58\u5728\u3059\u308b\u306e\u3067\uff0cX\u3068M\u3067Y\u3092\u4e88\u6e2c\u3059\u308b\uff0c\u91cd\u56de\u5e30\u5206\u6790\u306b\u306a\u308a\u307e\u3059\u3002\u3068\u306f\u3044\u3048\uff0c\u8aac\u660e\u5909\u6570\u306e\u6570\u3060\u3051\uff0c\u63a8\u5b9a\u3059\u308b\u50be\u304d\u30d1\u30e9\u30e1\u30fc\u30bf\uff08\u53ca\u3073\u305d\u306e\u305f\u3081\u306b\u5fc5\u8981\u306a\u30d1\u30e9\u30e1\u30fc\u30bf\uff09\u3092\u5897\u3084\u305b\u3070\u6e08\u307f\u307e\u3059\u3002M->Y\u30e2\u30c7\u30eb\u306b\u304a\u3051\u308b\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u63a8\u5b9a\u3057\u305f\u3044\u3053\u3068\u304c\u5206\u304b\u308b\u3088\u3046\u306b\uff0c\u30d1\u30e9\u30e1\u30fc\u30bf\u540d\u306e\u6700\u5f8c\u306b'__Y'\u3068\u52a0\u7b46\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\u6b21\u306b2\u70b9\u76ee\u306b\u3064\u3044\u3066\u3002\n\u3053\u3061\u3089\u306e\u30b5\u30a4\u30c8\u3067\u7d39\u4ecb\u3055\u308c\u3066\u3044\u308b\u3088\u3046\u306b\uff0cgenerated quantities\u30d6\u30ed\u30c3\u30af\u306b\u304a\u3044\u3066\uff0c\u4ee5\u4e0b\u306e\u4e8c\u3064\u3092\u639b\u3051\u5408\u308f\u305b\u308b\u3060\u3051\u3067\u3059\u3002\n- X->M\u30e2\u30c7\u30eb\u306b\u304a\u3051\u308bX\u306e\u50be\u304d\n- M->Y\u30e2\u30c7\u30eb\u306b\u304a\u3051\u308bM\u306e\u50be\u304d\n\u3053\u308c\u3089\u3092Stan\u30b3\u30fc\u30c9\u3067\u8868\u3057\u305f\u3082\u306e\u304c\u4ee5\u4e0b\u3067\u3059\u3002\n\nmultilevel_mediation1\ndata{\n  int N;                                 //\u7dcf\u30c7\u30fc\u30bf\u6570\n  int K;                                 //\u30b0\u30eb\u30fc\u30d7\u6570\n  vector[N] X;                           //\u8aac\u660e\u5909\u6570\n  vector[N] M;                           //\u5a92\u4ecb\u5909\u6570\n  vector[N] Y;                           //\u5fdc\u7b54\u5909\u6570\n  int<lower=1, upper=K> KID[N];          //\u30b0\u30eb\u30fc\u30d7\u3092\u8b58\u5225\u3059\u308bID\n}     \n\nparameters {\n  // X->M model\n  real a0__M;                            //\u5207\u7247\u306e\u5168\u4f53\u5e73\u5747\n  real b0__M;                            //X\u306e\u4fc2\u6570\u306e\u5168\u4f53\u5e73\u5747\n  real a__M[K];                          //\u30b0\u30eb\u30fc\u30d7\u3054\u3068\u306e\u5207\u7247 \n  real b__M[K];                          //\u30b0\u30eb\u30fc\u30d7\u3054\u3068\u306eX\u306e\u50be\u304d\n  real<lower=0> s_a__M;                  //\u5207\u7247\u306e\u30b0\u30eb\u30fc\u30d7\u9593\u3067\u306e\u3070\u3089\u3064\u304d\n  real<lower=0> s_b__M;                  //X\u306e\u50be\u304d\u306e\u30b0\u30eb\u30fc\u30d7\u9593\u3067\u306e\u3070\u3089\u3064\u304d\n  real<lower=0> s_Y__M;                  //\u5a92\u4ecb\u5909\u6570\u306e\u3070\u3089\u3064\u304d\n\n  // M->Y model      \n  real a0__Y;                            //\u5207\u7247\u306e\u5168\u4f53\u5e73\u5747\n  real b0__Y1;                           //X\u306e\u4fc2\u6570\u306e\u5168\u4f53\u5e73\u5747\n  real b0__Y2;                           //M\u306e\u4fc2\u6570\u306e\u5168\u4f53\u5e73\u5747\n  real a__Y[K];                          //\u30b0\u30eb\u30fc\u30d7\u3054\u3068\u306e\u5207\u7247\n  real b__Y1[K];                         //\u30b0\u30eb\u30fc\u30d7\u3054\u3068\u306eX\u306e\u4fc2\u6570\n  real b__Y2[K];                         //\u30b0\u30eb\u30fc\u30d7\u3054\u3068\u306eM\u306e\u4fc2\u6570\n  real<lower=0> s_a__Y;                  //\u5207\u7247\u306e\u30b0\u30eb\u30fc\u30d7\u9593\u3067\u306e\u3070\u3089\u3064\u304d\n  real<lower=0> s_b__Y1;                 //X\u306e\u4fc2\u6570\u306e\u30b0\u30eb\u30fc\u30d7\u9593\u3067\u306e\u3070\u3089\u3064\u304d\n  real<lower=0> s_b__Y2;                 //M\u306e\u4fc2\u6570\u306e\u30b0\u30eb\u30fc\u30d7\u9593\u3067\u306e\u3070\u3089\u3064\u304d\n  real<lower=0> s_Y__Y;                  //\u5fdc\u7b54\u5909\u6570\u306e\u3070\u3089\u3064\u304d\n}\n\nmodel {\n  for (k in 1:K) {\n    // X->M model\n    a__M[k] ~ normal(a0__M, s_a__M);     //\u5207\u7247\u306e\u30b0\u30eb\u30fc\u30d7\u5dee\u306f\uff0c\u3053\u306e\u6b63\u898f\u5206\u5e03\u304b\u3089\u767a\u751f\n    b__M[k] ~ normal(b0__M, s_b__M);     //X\u306e\u50be\u304d\u306e\u30b0\u30eb\u30fc\u30d7\u5dee\u306f\uff0c\u3053\u306e\u6b63\u898f\u5206\u5e03\u304b\u3089\u767a\u751f\n\n    // M->Y model\n    a__Y[k] ~ normal(a0__Y, s_a__Y);     //\u5207\u7247\u306e\u30b0\u30eb\u30fc\u30d7\u5dee\u306f\uff0c\u3053\u306e\u6b63\u898f\u5206\u5e03\u304b\u3089\u767a\u751f\n    b__Y1[k] ~ normal(b0__Y1, s_b__Y1);  //X\u306e\u50be\u304d\u306e\u30b0\u30eb\u30fc\u30d7\u5dee\u306f\uff0c\u3053\u306e\u6b63\u898f\u5206\u5e03\u304b\u3089\u767a\u751f\n    b__Y2[k] ~ normal(b0__Y2, s_b__Y2);  //M\u306e\u50be\u304d\u306e\u30b0\u30eb\u30fc\u30d7\u5dee\u306f\uff0c\u3053\u306e\u6b63\u898f\u5206\u5e03\u304b\u3089\u767a\u751f\n  }\n\n  for (n in 1:N) {                       //M\u3068Y\u306b\u95a2\u3059\u308b\u78ba\u7387\u30e2\u30c7\u30eb\n    M[n] ~ normal(a__M[KID[n]] + b__M[KID[n]]*X[n], s_Y__M);\n    Y[n] ~ normal(a__Y[KID[n]] + b__Y1[KID[n]]*X[n] + b__Y2[KID[n]]*M[n], s_Y__Y);\n  }\n\n  //prior\n  s_a__M ~ cauchy(0, 2.5);               //\u63a8\u5b9a\u306e\u5b89\u5b9a\u6027\u306e\u305f\u3081\uff0c\u3070\u3089\u3064\u304d\u306e\u4e8b\u524d\u5206\u5e03\u306b\u534a\u30b3\u30fc\u30b7\u30fc\u5206\u5e03\u3092\u6307\u5b9a\n  s_b__M ~ cauchy(0, 2.5);\n  s_a__Y ~ cauchy(0, 2.5);\n  s_b__Y1 ~ cauchy(0, 2.5);\n  s_b__Y2 ~ cauchy(0, 2.5);\n}\n\ngenerated quantities{\n  real indirect;                           \n  indirect = b0__M * b0__Y2;             //\u50be\u304d\u306e\u7a4d\u306b\u3088\u308a\u9593\u63a5\u52b9\u679c\u3092\u8a08\u7b97\n}\n\n\n\n\u4e0a\u8a18\u306eStan\u30b3\u30fc\u30c9\u3092\u9069\u5f53\u306a\u540d\u524d\u3067\u4fdd\u5b58\u3057\uff0c\u4ee5\u4e0b\u306eR\u30b3\u30fc\u30c9\u3067\u30b5\u30f3\u30d7\u30ea\u30f3\u30b0\u3092\u8a66\u3057\u3066\u307f\u307e\u3059\u3002\u3053\u3053\u3067\u306f'BMM.stan'\u3068\u3044\u3046\u540d\u524d\u3067\u4fdd\u5b58\u3057\u307e\u3057\u305f\u3002\n\nR_code\nlibrary(rstan)\n\nstanmodel <- stan_model('BMM.stan')\ndata=list(N=nrow(dat), K=max(dat$id), Y=dat$Y, M=dat$M, X=dat$X, KID=dat$id)\nfit <- sampling(stanmodel,\n                data=data,\n                iter=20000,\n                warmup=3000,\n                thin=5,\n                seed=1234)\n\nprint(fit, pars=c(\"a0__M\",\"b0__M\",\"s_a__M\",\"s_b__M\",\"s_Y__M\",\"a0__Y\",\"b0__Y1\",\"b0__Y2\",\"s_a__Y\",\"s_b__Y1\",\"s_b__Y2\",\"s_Y__Y\",\"indirect\"))\n\n\n\n\u7d50\u679c\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\u306a\u304a\u3053\u308c\u3089\u306f\u6a19\u6e96\u5316\u3055\u308c\u305f\u5024\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\n\u4eca\u56de\u306f\uff0citeration=20000\uff0cwarmup=3000\u3068\u3044\u3046\u5927\u304d\u306a\u56de\u6570\u3067\u30b5\u30f3\u30d7\u30ea\u30f3\u30b0\u3057\u3066\u3044\u308b\u306e\u3067\uff0cRhat\u306f\u3069\u308c\u3082\u8a31\u5bb9\u7bc4\u56f2\u306b\u53ce\u307e\u3063\u3066\u3044\u307e\u3059\u304c\uff0c's_b__Y1'\u3068\u3044\u3046\u30d1\u30e9\u30e1\u30fc\u30bf\u306en_eff\u304c\u4ed6\u3068\u6bd4\u3079\u3066\u5c0f\u3055\u3044\u3053\u3068\u304c\u5206\u304b\u308a\u307e\u3059\u3002\u30c8\u30ec\u30fc\u30b9\u30d7\u30ed\u30c3\u30c8\u7b49\u306e\u30b0\u30e9\u30d5\u306f\u7701\u7565\u3057\u307e\u3059\u304c\uff0c\u78ba\u8a8d\u3057\u3066\u307f\u308b\u3068\u81ea\u5df1\u76f8\u95a2\u304c\u9ad8\u305d\u3046\u3067\u3057\u305f\u3002\u4e8b\u524d\u306b\u30b5\u30f3\u30d7\u30ea\u30f3\u30b0\u3057\u3066\u307f\u3066\uff0c\u3053\u3046\u306a\u308b\u3053\u3068\u304c\u5206\u304b\u3063\u3066\u3044\u305f\u306e\u3067\uff0cthin=5\u3067thinning\u3092\u884c\u3063\u305f\u306e\u3067\u3059\u304c\uff0c\u3042\u307e\u308a\u6539\u5584\u3055\u308c\u3066\u3044\u306a\u3044\u307f\u305f\u3044\u3067\u3059\u3002thin\u3092\u3082\u3063\u3068\u5927\u304d\u304f\u3059\u308b\u304b\uff0cStan\u3068R\u3067\u30d9\u30a4\u30ba\u7d71\u8a08\u30e2\u30c7\u30ea\u30f3\u30b0\u306e\u7b2c4\u7ae0\u306b\u3042\u308b\u3088\u3046\u306b\uff0c\u305d\u3082\u305d\u3082\u306e\u30e2\u30c7\u30eb\u3092\u6539\u826f\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\u3068\u308a\u3042\u3048\u305a\u4eca\u56de\u306f\u3053\u306e\u307e\u307e\u9032\u3081\u307e\u3059\u3002\n\u4eca\u56de\u4e00\u756a\u95a2\u5fc3\u304c\u3042\u308b\u306e\u306f\uff0c\u9593\u63a5\u52b9\u679c\uff08indirect\uff09\u3067\u3059\u3002\u4ee5\u4e0b\u306e\u30b0\u30e9\u30d5\u3092\u898b\u308b\u9650\u308a\uff0c\u53ce\u675f\u306b\u306f\u554f\u984c\u306a\u3055\u305d\u3046\u3067\u3059\u3002\u5206\u5e03\u306f\u5de6\u53f3\u306b\u5927\u304d\u304f\u6b6a\u3093\u3067\u3044\u308b\u308f\u3051\u3067\u306f\u306a\u3044\u306e\u3067\uff0c\u4e8b\u5f8c\u5e73\u57470.03\u3092\u4ee3\u8868\u5024\u3068\u3057\u3066\u63a1\u7528\u3057\u307e\u3059\u300295%\u78ba\u4fe1\u533a\u9593\u306f0\u3092\u307e\u305f\u3044\u3067\u3044\u306a\u3044\u306e\u3067\uff0c\u300c\u4ed5\u4e8b\u306b\u304a\u3051\u308b\u30b9\u30c8\u30ec\u30c3\u30b5\u30fc\u304c\u5897\u3048\u308b\u307b\u3069\uff0c\u4ed5\u4e8b\u3078\u306e\u4e0d\u6e80\u304c\u5927\u304d\u304f\u306a\u308a\uff0c\u305d\u306e\u7d50\u679c\u3068\u3057\u3066\u4eba\u9593\u95a2\u4fc2\u3078\u306e\u4e0d\u6e80\u3082\u5927\u304d\u304f\u306a\u308b\u300d\u3068\u3044\u3046\u5a92\u4ecb\u904e\u7a0b\u304c\u5b58\u5728\u3059\u308b\u3068\uff0c\u78ba\u4fe1\u3092\u6301\u3066\u305d\u3046\u3067\u3059\u3002\n\n\n\u5909\u91cf\u52b9\u679c\u9593\u306b\u76f8\u95a2\u3092\u4eee\u5b9a\u201d\u3059\u308b\u201d\u5834\u5408\u306eStan\u30b3\u30fc\u30c9\n\u3053\u3053\u3067\u3082\u3046\u4e00\u5ea6\uff0c\u4ee5\u4e0b\u306e\u30b0\u30e9\u30d5\u306b\u6ce8\u76ee\u3057\u3066\u307f\u307e\u3059\u3002\u7279\u306b\u5de6\u306eX->M\u30e2\u30c7\u30eb\u304c\u5206\u304b\u308a\u3084\u3059\u3044\u3068\u601d\u3046\u306e\u3067\u3059\u304c\uff0c\u4f55\u3068\u306a\u304f\uff0c\u5207\u7247\u304c\u5c0f\u3055\u3044\u307b\u3069\u50be\u304d\u304c\u5927\u304d\u3044\u50be\u5411\u304c\u3042\u308b\u3088\u3046\u306b\u601d\u308f\u308c\u307e\u3059\u3002\n\n\u3082\u3068\u3082\u3068\u4ed5\u4e8b\u306b\u5bfe\u3059\u308b\u4e0d\u6e80\u304c\u4f4e\u3051\u308c\u3070\uff0c\u5c11\u3057\u306e\u30b9\u30c8\u30ec\u30c3\u30b5\u30fc\u306e\u5897\u52a0\u3067\u3082\uff0c\u4e0d\u6e80\u306f\u4e0a\u6607\u3057\u3084\u3059\u3044\u3068\u8003\u3048\u3089\u308c\u307e\u3059\u3002\u3053\u308c\u306f\u3053\u306e\u30b5\u30f3\u30d7\u30eb\u30c7\u30fc\u30bf\u306b\u9650\u3063\u305f\u8a71\u3067\u306f\u306a\u304f\uff0c\u30db\u30fc\u30e0\u30e9\u30f3\u6570\u3068\u5e74\u53ce\u306e\u95a2\u4fc2\u306b\u3082\u540c\u3058\u3088\u3046\u306b\uff0c\u5207\u7247\u304c\u5c0f\u3055\u3044\u500b\u4eba\u307b\u3069\u50be\u304d\u304c\u5927\u304d\u304f\u306a\u308a\u3084\u3059\u3044\u3068\u3044\u3046\uff0c\u8ca0\u306e\u76f8\u95a2\u304c\u8a8d\u3081\u3089\u308c\u308b\u3068\u601d\u308f\u308c\u307e\u3059\u3002\u4f38\u3073\u3057\u308d\u3067\u3059\u306d\u3002\n\u3068\u3044\u3046\u308f\u3051\u3067\uff0cStan\u30b3\u30fc\u30c9\u3092\u66f8\u304d\u63db\u3048\u3066\u307f\u307e\u3059\u3002\u5207\u7247\u3068\u50be\u304d\u306e\u500b\u4eba\u5dee\u306f\uff0c\u305d\u308c\u305e\u308c\u72ec\u7acb\u306b\u6b63\u898f\u5206\u5e03\u304b\u3089\u767a\u751f\u3057\u305f\u3068\u4eee\u5b9a\u3057\u3066\u3044\u307e\u3057\u305f\u304c\uff0c\u3055\u3089\u306b\u3053\u308c\u3089\u306e\u9593\u306b\u76f8\u95a2\u95a2\u4fc2\u3092\u60f3\u5b9a\u3057\u307e\u3059\u3002\u305d\u3053\u3067\u3053\u3061\u3089\u306e\u30b9\u30e9\u30a4\u30c9\u306e140\u679a\u76ee\u4ee5\u964d\u306b\u8a18\u8f09\u3055\u308c\u3066\u3044\u308b\u3088\u3046\u306b\uff0c\u591a\u5909\u91cf\u6b63\u898f\u5206\u5e03\u3092\u4eee\u5b9a\u3057\u305f\u66f8\u304d\u65b9\u306b\u5909\u66f4\u3057\u307e\u3059\u3002\n\nmultilevel_mediation2\ndata{\n  int N;                                 //\u7dcf\u30c7\u30fc\u30bf\u6570\n  int K;                                 //\u30b0\u30eb\u30fc\u30d7\u6570\n  vector[N] X;                           //\u8aac\u660e\u5909\u6570\n  vector[N] M;                           //\u5a92\u4ecb\u5909\u6570\n  vector[N] Y;                           //\u5fdc\u7b54\u5909\u6570\n  int<lower=1, upper=K> KID[N];          //\u30b0\u30eb\u30fc\u30d7\u3092\u8b58\u5225\u3059\u308bID\n}     \n\nparameters {\n  vector[5] f;                           //\u56fa\u5b9a\u52b9\u679c\uff08\u5e73\u5747\uff09\n  vector[5] r[K];                        //\u5909\u91cf\u52b9\u679c\n  vector<lower=0>[5] tau;                //\u5909\u91cf\u52b9\u679c\u306eSD\n  corr_matrix[5] rho;                    //\u5909\u91cf\u52b9\u679c\u306e\u76f8\u95a2\u884c\u5217\n  real<lower=0> sigma__M;                //M\u306e\u6b8b\u5deeSD\n  real<lower=0> sigma__Y;                //Y\u306e\u6b8b\u5deeSD\n}\n\ntransformed parameters{                  //\u5171\u5206\u6563\u884c\u5217\u306f\u6307\u5b9a\u304c\u96e3\u3057\u3044\u305f\u3081\u30d1\u30e9\u30e1\u30fc\u30bf\u3068\u3057\u3066\u5ba3\u8a00\u305b\u305a\uff0cSD\u3068\u76f8\u95a2\u884c\u5217\u306b\u5206\u3051\u3066\u3053\u308c\u3089\u3092\u30d1\u30e9\u30e1\u30fc\u30bf\u3067\u5ba3\u8a00\u3059\u308b\n  cov_matrix[5] taumx;                   //\u30e9\u30f3\u30c0\u30e0\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u5171\u5206\u6563\u884c\u5217\n  taumx = quad_form_diag(rho, tau);      //\u76f8\u95a2\u884c\u5217\u3068\uff08\u5909\u91cf\u52b9\u679c\u306e\uff09SD\u3092\u5171\u5206\u6563\u884c\u5217\u306b\u5909\u63db\n}\n\nmodel {\n  //M\u3068Y\u306b\u95a2\u3059\u308b\u78ba\u7387\u30e2\u30c7\u30eb\n  for (n in 1:N) {                       \n    M[n] ~ normal(r[KID[n]][1] + r[KID[n]][2]*X[n], sigma__M);\n    Y[n] ~ normal(r[KID[n]][3] + r[KID[n]][4]*X[n] + r[KID[n]][5]*M[n], sigma__Y);\n  }\n\n  //\u30e9\u30f3\u30c0\u30e0\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u5206\u5e03\u3000\u591a\u5909\u91cf\u6b63\u898f\u5206\u5e03\n  r ~ multi_normal(f, taumx);\n\n  //\u4e8b\u524d\u5206\u5e03\n  tau ~ cauchy(0, 2.5);\n  rho ~ lkj_corr(1); \u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000//\u76f8\u95a2\u884c\u5217\u306e\u7121\u60c5\u5831\u4e8b\u524d\u5206\u5e03\n  sigma__M ~ cauchy(0, 2.5);\n  sigma__Y ~ cauchy(0, 2.5);\n}\n\ngenerated quantities{\n  real indirect;                           \n  indirect = f[2]*f[5];  \u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000 //\u50be\u304d\u306e\u7a4d\u306b\u3088\u308a\u9593\u63a5\u52b9\u679c\u3092\u8a08\u7b97\n}\n\n\n\u4e0a\u8a18\u306eStan\u30b3\u30fc\u30c9\u3092'BMM2.stan'\u3068\u3044\u3046\u540d\u524d\u3067\u4fdd\u5b58\u3057\uff0c\u4ee5\u4e0b\u306eR\u30b3\u30fc\u30c9\u3092\u8d70\u3089\u305b\u307e\u3059\u3002\n\nR_code2\nlibrary(rstan)\n\nstanmodel_2 <- stan_model('BMM2.stan')\ndata=list(N=nrow(dat), K=max(dat$id), Y=dat$Y, M=dat$M, X=dat$X, KID=dat$id)\nfit2 <- sampling(stanmodel_2,\n                data=data,\n                seed=1234)\n\nprint(fit2, pars=c(\"f\", \"tau\", \"indirect\"), digits=3)\n\n\n\u30b5\u30f3\u30d7\u30ea\u30f3\u30b0\u56de\u6570\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u8a2d\u5b9a\u306b\u3057\u307e\u3057\u305f\u304c\uff0c\u53ce\u675f\u306f\u305d\u3093\u306a\u306b\u60aa\u304f\u306a\u3055\u305d\u3046\u3067\u3059\u3002\u9593\u63a5\u52b9\u679c\u306e\u4e8b\u5f8c\u5e73\u5747\u306f\uff0c\u5909\u91cf\u52b9\u679c\u9593\u306b\u76f8\u95a2\u3092\u4eee\u5b9a\u3057\u3066\u3082\u3057\u306a\u304f\u3066\u3082\uff0c\u3042\u307e\u308a\u5909\u308f\u308a\u307e\u305b\u3093\u3067\u3057\u305f\u3002\u30c7\u30fc\u30bf\u6b21\u7b2c\u3067\u306f\u7d50\u679c\u304c\u5909\u308f\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u304c\uff0c\u3053\u306e\u3042\u305f\u308a\u306f\u672a\u691c\u8a3c\u3067\u3059\u3002\n\n\n\u691c\u7b97\n\nbmlm\u30d1\u30c3\u30b1\u30fc\u30b8\n\u9593\u63a5\u52b9\u679c\u306e\u63a8\u5b9a\u304c\u3046\u307e\u304f\u3044\u3063\u3066\u3044\u308b\u304b\uff0cbmlm\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u4f7f\u3063\u3066\u8a08\u7b97\u3057\u305f\u7d50\u679c\u3068\u6bd4\u8f03\u3057\u3066\u307f\u307e\u3059\u3002Stan\u3067\u66f8\u3044\u305f\u5834\u5408\u3068\u8a2d\u5b9a\u3092\u7d71\u4e00\u3057\u3066\u30b5\u30f3\u30d7\u30ea\u30f3\u30b0\u3057\u3066\u307f\u307e\u3059\u3002\n\nbmlm_package\nlibrary(bmlm)\n\nfit3 <- mlm(dat,\n            id=\"id\", x=\"X\", m=\"M\", y=\"Y\",\n            priors=list(tau_dy=2.5, tau_dm=2.5, tau_a=2.5, tau_b=2.5),\n            iter=20000,\n            warmup=3000,\n            thin=5,\n            seed=1234)\n\nmlm_summary(fit3)\nmlm_pars_plot(fit3, type=\"hist\")\n\n\n\u7d50\u679c\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\u30d1\u30e9\u30e1\u30fc\u30bfa\u304cX->M\u30e2\u30c7\u30eb\u306b\u304a\u3051\u308b\u56de\u5e30\u4fc2\u6570\uff0c\u30d1\u30e9\u30e1\u30fc\u30bfb\u304cM->Y\u30e2\u30c7\u30eb\u306b\u304a\u3051\u308b\u56de\u5e30\u4fc2\u6570\u3092\u8868\u3057\u3066\u3044\u307e\u3059\u3002\u3053\u308c\u3089\u306e\u4e8b\u5f8c\u5e73\u5747\u306e\u7a4d\u3092\u6c42\u3081\u308b\u3068\uff0ca * b = 0.19 * 0.15 = 0.0285\u306a\u306e\u3067\uff0cStan\u3067\u66f8\u3044\u305f\u5834\u5408\u306e\u9593\u63a5\u52b9\u679c\u3068\u307b\u307c\u4e00\u81f4\u3057\u307e\u3059\u3002\u305f\u3060\uff0c\u30d1\u30e9\u30e1\u30fc\u30bfab\u304c\u9593\u63a5\u52b9\u679c\u3092\u8868\u3057\u3066\u3044\u308b\u306e\u3067\u3059\u304c\uff0c\u4e8b\u5f8c\u5e73\u5747\u306f0.05\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u306d...\u3002\n\n\nbmlm\u3067\u306f\uff0c\u56de\u5e30\u4fc2\u6570\u306e\u7a4d\u306b\u56de\u5e30\u4fc2\u6570\u9593\u306e\u5171\u5206\u6563\uff08covab\uff09\u3092\u52a0\u7b97\u3057\u305f\u5024\u304c\uff0c\u9593\u63a5\u52b9\u679c\uff08ab\uff09\u3068\u3057\u3066\u51fa\u529b\u3055\u308c\u307e\u3059\u3002\u3053\u3053\u3067\u306f\u5c0f\u6570\u70b9\u4ee5\u4e0b2\u6841\u307e\u3067\u3057\u304b\u8868\u793a\u3055\u308c\u3066\u3044\u306a\u3044\u306e\u3067\uff0c\u4e38\u3081\u3089\u308c\u3066\u3057\u307e\u3063\u3066\u5206\u304b\u308a\u3065\u3089\u3044\u3067\u3059\u304c\uff0cab\u304b\u3089covab\u3092\u6e1b\u7b97\u3059\u308b\u3068\uff0c0.05 - 0.03 = 0.02\u3068\u3044\u3046\u3053\u3068\u3067\uff0c\u4e0a\u8a18\u306e\u901a\u308aStan\u3067\u66f8\u3044\u305f\u5834\u5408\u3068\u304a\u304a\u3088\u305d\u4e00\u81f4\u3057\u307e\u3059\u3002\n\nR\u3067\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\nStan\u3068R\u3067\u30d9\u30a4\u30ba\u7d71\u8a08\u30e2\u30c7\u30ea\u30f3\u30b0\u306e\u7b2c8\u7ae0\uff08\u968e\u5c64\u30e2\u30c7\u30eb\uff09\u306b\uff0cR\u3067\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u3059\u308b\u306e\u306f\u5927\u5207\u306a\u30b9\u30c6\u30c3\u30d7\u3067\u3042\u308b\u3068\u660e\u8a18\u3055\u308c\u3066\u3044\u307e\u3059\u30022\u5909\u91cf\u6b63\u898f\u5206\u5e03\u306b\u5f93\u3046\u4e71\u6570\u3092\u767a\u751f\u3055\u305b\uff0c\u4ee5\u4e0b\u4e8c\u901a\u308a\u306e\u65b9\u6cd5\u3067\u7d50\u679c\u3092\u6bd4\u8f03\u3057\u3066\u307f\u307e\u3059\u3002\n- \u5404\u5909\u6570\u306e\u7a4d\u3092\u5e73\u5747\u5316\u3059\u308b\u5834\u5408\n- \u5404\u5909\u6570\u306e\u5e73\u5747\u306e\u7a4d\u3092\u6c42\u3081\u308b\u5834\u5408\n\nsimulation\nlibrary(mvtnorm)\n\nsigma <- matrix(c(4,2,2,3), ncol=2)\nx <- rmvnorm(n=500, mean=c(1, 2), sigma=sigma) #2\u5909\u91cf\u6b63\u898f\u5206\u5e03\u306e\u751f\u6210\ncolMeans(x) #\u5404\u5909\u6570\u306e\u5e73\u5747\nvar(x) #\u5171\u5206\u6563\u884c\u5217\n\nproduct1 <- mean(x[,1] * x[,2]) #\u5404\u5909\u6570\u306e\u7a4d\u3092\u5e73\u5747\nprint(product1)\n\nproduct2 <- colMeans(x)[1] * colMeans(x)[2] #\u5404\u5909\u6570\u306e\u5e73\u5747\u306e\u7a4d\nprint(product2)\n\nprint(product1 - product2) #\u5dee\u5206\n\n\n\u7d50\u679c\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\u5404\u5909\u6570\u306e\u5e73\u5747\u306e\u7a4d\u3092\u8a08\u7b97\u3057\u305f\u5834\u5408\u306f\uff0c\u5404\u5909\u6570\u306e\u7a4d\u3092\u5e73\u5747\u3057\u305f\u5834\u5408\u3088\u308a\u3082\u5024\u304c\u5c0f\u3055\u3044\u3067\u3059\u3002\u305d\u3057\u3066\u305d\u306e\u5dee\u5206\u306f\uff0c\u5909\u6570\u9593\u306e\u5171\u5206\u6563\u306b\u307b\u307c\u4e00\u81f4\u3057\u307e\u3059\u3002\n\n\u4e0a\u8a18\u306eStan\u30b3\u30fc\u30c9\u3067\u3082\uff0cgenerated quantities\u30d6\u30ed\u30c3\u30af\u306b\u304a\u3051\u308b\u9593\u63a5\u52b9\u679c\u306e\u8a08\u7b97\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u66f4\u3059\u308c\u3070\uff0cbmlm\u306e\u7d50\u679c\u3068\u304a\u304a\u3088\u305d\u4e00\u81f4\u3057\u307e\u3059\u3002\n\nindirect\ngenerated quantities{\n  real indirect;                           \n  indirect = f[2]*f[5] + taumx[2, 5];  //\u50be\u304d\u306e\u7a4d\u306b\u3088\u308a\u9593\u63a5\u52b9\u679c\u3092\u8a08\u7b97\n}\n\n\n\n\u3068\u3044\u3046\u308f\u3051\u3067\uff0c\u3069\u3046\u3084\u3089\u30de\u30eb\u30c1\u30ec\u30d9\u30eb\u5a92\u4ecb\u30e2\u30c7\u30eb\u306b\u304a\u3044\u3066\u9593\u63a5\u52b9\u679c\u3092\u5c0e\u51fa\u3059\u308b\u969b\u306f\uff0c\u5404\u56de\u5e30\u4fc2\u6570\u306e\u7a4d\u306b\u5171\u5206\u6563\u3092\u52a0\u7b97\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3088\u3046\u3067\u3059\u3002\n\u305f\u3060\u305d\u306e\u7406\u7531\u306b\u3064\u3044\u3066\u306f\uff0c\u57f7\u7b46\u8005\u306f\u307e\u3060\u7406\u89e3\u3067\u304d\u3066\u304a\u308a\u307e\u305b\u3093...\u3002\u305c\u3072\u3054\u6559\u6388\u304f\u3060\u3055\u3044...\u3002\n\n\u304a\u308f\u308a\u306b\n\u57f7\u7b46\u8005\u306f\u3044\u308f\u3086\u308b\u53c2\u52a0\u8005\u5185\u30c7\u30b6\u30a4\u30f3\u3067\u5b9f\u9a13\u3092\u8a08\u753b\u3059\u308b\u3053\u3068\u304c\u591a\u3044\u3067\u3059\u3002\u3053\u306e\u30c7\u30b6\u30a4\u30f3\u3067\u306f\uff0c\u5404\u5b9f\u9a13\u53c2\u52a0\u8005\u304c\u8907\u6570\u306e\u6761\u4ef6\u3092\u7d4c\u9a13\u3059\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\u500b\u4eba\u306e\u4e2d\u306b\u5404\u6761\u4ef6\u304c\u5b58\u5728\u3059\u308b\uff0c\u968e\u5c64\u69cb\u9020\u3092\u6301\u3063\u305f\u30c7\u30fc\u30bf\u3068\u3044\u3048\u307e\u3059\u3002\u4f8b\u3048\u3070\u4ee5\u4e0b\u306e\u4f8b\u3067\u306f\uff0c\u5404\u53c2\u52a0\u8005\u304c\u5b9f\u9a13\u6761\u4ef6\uff08experiment\uff09\u3068\u7d71\u5236\u6761\u4ef6\uff08control\uff09\u3092\u4e21\u65b9\u7d4c\u9a13\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u53c2\u52a0\u8005\u5185\u30c7\u30b6\u30a4\u30f3\u306e\u5b9f\u9a13\u3067\u5a92\u4ecb\u30e2\u30c7\u30eb\u3092\u4e3b\u5f35\u3057\u305f\u3044\u5834\u5408\uff0c\u30de\u30eb\u30c1\u30ec\u30d9\u30eb\u5a92\u4ecb\u30e2\u30c7\u30eb\u3092\u9069\u7528\u3059\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\u3057\u304b\u3057\uff0c\u305d\u308c\u3092\u5b9f\u73fe\u3059\u308b\u65b9\u6cd5\u304c\u3088\u304f\u5206\u304b\u3089\u306a\u304b\u3063\u305f\u306e\u3067\uff0cStan\u3067\u66f8\u3044\u3066\u307f\u3088\u3046\u3068\u601d\u3063\u305f\u306e\u304c\u672c\u8a18\u4e8b\u306e\u51fa\u767a\u70b9\u3067\u3057\u305f\u3002\u305d\u306e\u904e\u7a0b\u3067bmlm\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u5b58\u5728\u3092\u77e5\u308a\u300c\u306a\u3093\u3060\u3053\u308c\u3067\u3044\u3044\u3058\u3083\u3093\u300d\u3068\u4e00\u77ac\u601d\u3063\u305f\u3082\u306e\u306e\uff0c\u8a66\u884c\u932f\u8aa4\u3057\u306a\u304c\u3089\uff0c\u3054\u52a9\u8a00\u3092\u3044\u305f\u3060\u304d\u306a\u304c\u3089Stan\u3067\u66f8\u3044\u3066\u307f\u3066\uff0c\u8272\u3005\u3068\u52c9\u5f37\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\u3082\u3057\u672c\u8a18\u4e8b\u306b\u9593\u9055\u3044\u304c\u3042\u308a\u307e\u3057\u305f\u3089\uff0c\u3054\u6307\u6458\u3092\u9802\u3051\u308c\u3070\u5e78\u3044\u3067\u3059\u3002\n\u6700\u5f8c\u306b\uff0c\u672c\u8a18\u4e8b\u306e\u57f7\u7b46\u306b\u3042\u305f\u308a\uff0c\u3054\u52a9\u8a00\u3092\u304f\u3060\u3055\u3063\u305f\u65b9\u3005\u306b\uff0c\u5fc3\u304b\u3089\u5fa1\u793c\u7533\u3057\u4e0a\u3052\u307e\u3059\u3002\n\u3053\u306e\u8a18\u4e8b\u306f [Stan Advent Calendar 2016](http://qiita.com/advent-calendar/2016/stan) \u306e17\u65e5\u76ee\u306e\u8a18\u4e8b\u3067\u3059\u3002\u76ee\u4e0b\u52c9\u5f37\u3057\u306a\u304c\u3089\u306e\u57f7\u7b46\u306e\u305f\u3081\uff0c\u3082\u3057\u9593\u9055\u3044\u3084\u3082\u3063\u3068\u52b9\u7387\u7684\u306a\u65b9\u6cd5\u304c\u3042\u308c\u3070\uff0c\u3054\u6307\u6458\u3092\u3044\u305f\u3060\u3051\u308c\u3070\u5e78\u3044\u3067\u3059\u3002\n\n---\n#\u306f\u3058\u3081\u306b\n\u5a92\u4ecb\u5206\u6790\u306b\u3064\u3044\u3066\u306f\uff0c[\u3053\u3061\u3089\u306e\u30b5\u30a4\u30c8](http://norimune.net/2800)\u3092\u3054\u53c2\u7167\u304f\u3060\u3055\u3044\u3002\u3053\u306e\u30b5\u30a4\u30c8\u3067\u306f\uff0c\u91ce\u7403\u9078\u624b\u306e\u4f53\u91cd\uff08weight\uff09\u304c\u91cd\u304f\u306a\u308b\u307b\u3069\uff0c\u30db\u30fc\u30e0\u30e9\u30f3\u6570\uff08HR\uff09\u304c\u5897\u3048\u305f\u7d50\u679c\uff0c\u5e74\u53ce\uff08salary\uff09\u304c\u5897\u3048\u308b\u3068\u3044\u3046\uff0c\u5a92\u4ecb\u904e\u7a0b\u3092\u4f8b\u306b\u8aac\u660e\u3092\u884c\u3063\u3066\u3044\u307e\u3059\u3002Stan\u30b3\u30fc\u30c9\u3082\u516c\u958b\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\u306a\u304a\u672c\u8a18\u4e8b\u3067\u306f\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u6570\u3092\u7565\u8a18\u3059\u308b\u3053\u3068\u306b\u3057\u307e\u3059\u3002\n- X\uff1a\u8aac\u660e\u5909\u6570\n- M\uff1a\u5a92\u4ecb\u5909\u6570\n- Y\uff1a\u5fdc\u7b54\u5909\u6570\n\n\n#\u968e\u5c64\u6027\u304c\u3042\u308b\u5a92\u4ecb\u30e2\u30c7\u30eb\uff08\u30de\u30eb\u30c1\u30ec\u30d9\u30eb\u5a92\u4ecb\u30e2\u30c7\u30eb\uff09\n\u4e0a\u8a18\u306e\u91ce\u7403\u306e\u30c7\u30fc\u30bf\u3067\u306f\uff0c\u5404\u5909\u6570\uff08\u4f53\u91cd\uff0c\u30db\u30fc\u30e0\u30e9\u30f3\u6570\uff0c\u5e74\u53ce\uff09\u306e\u5024\u306f\uff0c\u500b\u4eba\u306b\u3064\u304d\u4e00\u3064\u3067\u3057\u305f\u3002\u3057\u304b\u3057\uff0c\u3053\u308c\u3089\u306e\u30c7\u30fc\u30bf\u3092\u8907\u6570\u56de\u6e2c\u5b9a\u3059\u308c\u3070\uff0c\u3042\u308b\u5909\u6570\u306b\u3064\u3044\u3066\u500b\u4eba\u306e\u4e2d\u306b\u8907\u6570\u306e\u5024\u304c\u5b58\u5728\u3059\u308b\u3053\u3068\u306b\u306a\u308a\uff0c\u968e\u5c64\u6027\u304c\u751f\u307e\u308c\u307e\u3059\uff08\u4f8b\uff1a\u4f53\u91cd\u306e\u8a08\u6e2c1\u56de\u76ee70kg\uff0c2\u56de\u76ee71kg\uff0c3\u56de\u76ee69kg...\uff09\u3002\n\n\u3042\u308b\u3044\u306f\uff0c\u7403\u56e3\u3068\u9078\u624b\u306e\u95a2\u4fc2\u3092\u8003\u3048\u3066\u307f\u308b\u3068\uff0c\u9078\u624b\u306f\u3069\u3053\u304b\u306e\u7403\u56e3\u306b\u6240\u5c5e\u3057\u3066\u3044\u308b\u306e\u3067\uff0c\u3084\u306f\u308a\u968e\u5c64\u7684\u306a\u30c7\u30fc\u30bf\u3068\u307f\u306a\u3059\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\uff08\u4f8b\uff1a\u540c\u4e00\u7403\u56e3\u5185\u306e\u9078\u624bA\uff0c\u9078\u624bB\uff0c\u9078\u624bC...\uff09\n\n\u901a\u5e38\u306e\u56de\u5e30\u5206\u6790\u306f\uff0c\u6b8b\u5dee\u304c\u72ec\u7acb\u3067\u3042\u308b\u3053\u3068\u3092\u4eee\u5b9a\u3057\u307e\u3059\u304c\uff0c\u30c7\u30fc\u30bf\u306b\u968e\u5c64\u6027\u304c\u5b58\u5728\u3059\u308b\u5834\u5408\u306f\uff0c\u305d\u306e\u524d\u63d0\u304c\u5d29\u308c\u308b\u6050\u308c\u304c\u3042\u308a\u307e\u3059\u3002\u305d\u3053\u3067\uff0c\u30de\u30eb\u30c1\u30ec\u30d9\u30eb\u30e2\u30c7\u30eb\u3084\u968e\u5c64\u7dda\u5f62\u30e2\u30c7\u30eb\uff0c\u7dda\u5f62\u6df7\u5408\u30e2\u30c7\u30eb\u3068\u547c\u3070\u308c\u308b\u65b9\u6cd5\u306b\u3088\u308a\uff0c\u968e\u5c64\u306e\u4e0a\u4f4d\u3054\u3068\uff0c\u4e0b\u4f4d\u3054\u3068\u306e\u9055\u3044\u3082\u30e2\u30c7\u30ea\u30f3\u30b0\u3057\u307e\u3059\u3002\u9078\u624b\u306e\u30c7\u30fc\u30bf\u3092\u6570\u56de\u8a08\u6e2c\u3059\u308b\u5834\u5408\u3092\u4f8b\u306b\u6319\u3052\u308b\u3068\uff0c\u8a08\u6e2c\u9593\u3067\u306e\u9055\u3044\u3068\u9078\u624b\u9593\u306e\u9055\u3044\u3092\uff0c\u305d\u308c\u305e\u308c\u30e2\u30c7\u30ea\u30f3\u30b0\u3059\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\u305d\u306e\u3046\u3048\u3067\uff0c\u4ee5\u4e0b\u4e8c\u3064\u306e\u52b9\u679c\u306e\u7a4d\u3068\u3057\u3066\u9593\u63a5\u52b9\u679c\u3092\u5c0e\u51fa\u3057\u307e\u3059\u3002\n- X\u304cM\u306b\u53ca\u307c\u3059\u5f71\u97ff\n- M\u304cY\u306b\u53ca\u307c\u3059\u5f71\u97ff\n\n\n#\u5b9f\u8df5\n\u5b9f\u306f\uff0cStan\u3067\u30de\u30eb\u30c1\u30ec\u30d9\u30eb\u5a92\u4ecb\u30e2\u30c7\u30eb\u306b\u3088\u308b\u5206\u6790\u3092\u884c\u3046\u305f\u3081\u306e\uff0c[bmlm](https://rdrr.io/cran/bmlm/)\u3068\u3044\u3046R\u30d1\u30c3\u30b1\u30fc\u30b8\u304c\u5b58\u5728\u3057\u307e\u3059\u3002**\u3082\u3046\u3053\u308c\u3092\u4f7f\u3048\u3070\u3044\u3044\u3067\u3059\u306d**\u3002\n\u3000\u3000\n...\u3067\u306f\u8a71\u304c\u7d42\u308f\u3063\u3066\u3057\u307e\u3046\u306e\u3067\uff0c\u3053\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u304b\u3089\u30b5\u30f3\u30d7\u30eb\u30c7\u30fc\u30bf\u3092\u62dd\u501f\u3057\u3066\uff0c\u81ea\u5206\u3067Stan\u30b3\u30fc\u30c9\u3092\u66f8\u3044\u3066\u307f\u307e\u3059\u3002\u4f7f\u7528\u3059\u308b\u306e\u306f\uff0cBLch9\u3068\u3044\u3046\u30c7\u30fc\u30bf\u30bb\u30c3\u30c8\u3067\u3059\u3002100\u540d\u306b\u5bfe\u3057\u3066\u7d4c\u6642\u7684\u306a\u30c7\u30fc\u30bf\u309221\u56de\u306b\u308f\u305f\u308a\u6e2c\u5b9a\u3057\u305f\u3001\u968e\u5c64\u6027\u306e\u3042\u308b\u30c7\u30fc\u30bf\u3067\u3059\u3002\u500b\u4eba\u3092\u8b58\u5225\u3059\u308b\u5909\u6570'id'\u306b\u52a0\u3048\uff0c'fwkstrs'\uff0c'fwkdis'\uff0c'freldis'\uff0c\u3068\u3044\u3046\u4e09\u3064\u306e\u5909\u6570\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\u5909\u6570\u540d\u304c\u4f3c\u3066\u3044\u308b\u306e\u3067\uff0c\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u6539\u540d\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n- X\uff08\u5143\u306ffwkstrs\uff09\uff1a\u4ed5\u4e8b\u306b\u304a\u3051\u308b\u30b9\u30c8\u30ec\u30c3\u30b5\u30fc\u306e\u6570\n- M\uff08\u5143\u306ffwkdis\uff09\uff1a\u4ed5\u4e8b\u3078\u306e\u4e0d\u6e80\u306e\u5927\u304d\u3055\n- Y\uff08\u5143\u306ffreldis\uff09\uff1a\u4eba\u9593\u95a2\u4fc2\u3078\u306e\u4e0d\u6e80\u306e\u5927\u304d\u3055\n\n\u307e\u305f\uff0c\u5143\u30c7\u30fc\u30bf\u3067\u306f\u500b\u4ebaID\u306f101~200\u306e100\u540d\u5206\u5b58\u5728\u3057\u307e\u3059\u304c\uff0c\u5206\u304b\u308a\u3084\u3059\u3055\u306e\u305f\u3081\uff0c1~100\u306b\u5909\u3048\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\n```R:sample_data\nlibrary(bmlm)\nlibrary(dplyr)\n\ndata(BLch9)\ndat <- BLch9 %>%\n  dplyr::select(id, fwkstrs, fwkdis, freldis) %>% \n  dplyr::rename(X=fwkstrs, M=fwkdis, Y=freldis)\ndat$id <- dat$id - 100\n```\n\n![sample_data.PNG](https://qiita-image-store.s3.amazonaws.com/0/151885/906e34d3-5dad-af80-ded6-de7ce6052c85.png)\n\n\n##\u30c7\u30fc\u30bf\u53ef\u8996\u5316\n\u307e\u305a\u30c7\u30fc\u30bf\u306e\u7279\u5fb4\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\u3072\u3068\u307e\u305a\u500b\u4eba\u5dee\u3092\u8003\u616e\u305b\u305a\uff0c2100\u884c\u306e\u30c7\u30fc\u30bf\u3092\u7528\u3044\u3066\u6563\u5e03\u56f3\u3092\u63cf\u3044\u3066\u307f\u307e\u3059\u3002\n\n```R:visualization2\nlibrary(GGally)\n\ndat %>% \n  dplyr::select(-id) %>% \n  GGally::ggpairs()\n```\n\n![correlations.png](https://qiita-image-store.s3.amazonaws.com/0/151885/49b44ba6-2be1-c4e4-c6c7-d0e925a81786.png)\n\n\u4ee5\u964d\u306e\u5206\u6790\u3067\u306f\uff0c\u5404\u5909\u6570\u306f\u6b63\u898f\u5206\u5e03\u3059\u308b\u3082\u306e\u3068\u4eee\u5b9a\u3059\u308b\u3053\u3068\u306b\u3057\u307e\u3059\u3002\n\u6b21\u306b\uff0cX\u304cM\u306b\u53ca\u307c\u3059\u5f71\u97ff\uff0cM\u304cY\u306b\u53ca\u307c\u3059\u5f71\u97ff\u306b\u306f\uff0c\u500b\u4eba\u5dee\u304c\u5b58\u5728\u3059\u308b\u304b\u3069\u3046\u304b\u3092\u8996\u899a\u5316\u3057\u307e\u3059\u3002100\u540d\u5206\u306e\u30c7\u30fc\u30bf\u3092\u63cf\u753b\u3059\u308b\u3068\u7169\u96d1\u306b\u306a\u308b\u306e\u3067\uff0cID1~10\u306e10\u540d\u3092\u629c\u7c8b\u3057\u307e\u3059\u3002\n\n\n```R:visualization2\nlibrary(ggplot2)\nlibrary(cowplot)\n\ntemp <- dat %>% dplyr::filter(id<=10)\ntemp$id <- as.factor(temp$id)\n\ng1<- ggplot(data=temp, aes(y=M, x=X, color=id))+\n  stat_smooth(method=\"lm\", se=FALSE)\ng2<- ggplot(data=temp, aes(y=Y, x=M, color=id))+\n  stat_smooth(method=\"lm\", se=FALSE)\n\ng <- cowplot::plot_grid(g1, g2, labels=c(\"X->M model\", \"M->Y model\"), align=\"h\") \nprint(g)\n```\n\n![Rplot.png](https://qiita-image-store.s3.amazonaws.com/0/151885/b052e859-9bde-6a44-a15e-d2e8335b2ad1.png)\n\n\n\u5207\u7247\u3082\u50be\u304d\u3082\uff0c\u500b\u4eba\u3054\u3068\u306b\u3070\u3089\u3070\u3089\u3067\u3059\u3002\u305d\u3053\u3067\uff0c\u5207\u7247\u3068\u50be\u304d\u306b\u500b\u4eba\u5dee\u3092\u4eee\u5b9a\u3057\u305f\u30e2\u30c7\u30ea\u30f3\u30b0\u3092\u884c\u3044\u307e\u3059\u3002\n\n##\u5909\u91cf\u52b9\u679c\u9593\u306b\u76f8\u95a2\u3092\u4eee\u5b9a\u201d\u3057\u306a\u3044\u201d\u5834\u5408\u306eStan\u30b3\u30fc\u30c9\n\u30bf\u30a4\u30c8\u30eb\u306f\u3072\u3068\u307e\u305a\u7121\u8996\u3057\u3066\u8aad\u307f\u9032\u3081\u3066\u304f\u3060\u3055\u3044\u3002\n\u672c\u8a18\u4e8b\u3067\u306f\uff0c[Stan\u3068R\u3067\u30d9\u30a4\u30ba\u7d71\u8a08\u30e2\u30c7\u30ea\u30f3\u30b0](http://www.kyoritsu-pub.co.jp/bookdetail/9784320112421)\u306e\u7b2c8\u7ae0\uff08\u968e\u5c64\u30e2\u30c7\u30eb\uff09\u3092\u53c2\u8003\u306b\u3055\u305b\u3066\u3044\u305f\u3060\u304d\u307e\u3057\u305f\u3002\u3053\u306e\u7ae0\u3067\u306f\uff0c\u5358\u56de\u5e30\u5206\u6790\u306b\u304a\u3044\u3066\uff0c\u5207\u7247\u3068\u50be\u304d\u306b\u500b\u4eba\u5dee\u3092\u4eee\u5b9a\u3057\u305f\u5834\u5408\u306e\u5206\u6790\u4f8b\u304c\u7d39\u4ecb\u3055\u308c\u3066\u3044\u307e\u3059\uff08'model8-4.stan'\uff09\u3002\n\n```R:multilevel_mediation1\ndata {\n  int N;                               \n  int K;                            //\u30b0\u30eb\u30fc\u30d7\u6570\n  real X[N];                        //\u8aac\u660e\u5909\u6570\n  real Y[N];                        //\u5fdc\u7b54\u5909\u6570\n  int<lower=1, upper=K> KID[N];     //\u30b0\u30eb\u30fc\u30d7\u3092\u8b58\u5225\u3059\u308bID\n}\n\nparameters {\n  real a0;                          //\u5207\u7247\u306e\u5168\u4f53\u5e73\u5747\n  real b0;                          //X\u306e\u4fc2\u6570\u306e\u5168\u4f53\u5e73\u5747\n  real a[K];                        //\u30b0\u30eb\u30fc\u30d7\u3054\u3068\u306e\u5207\u7247\n  real b[K];                        //\u30b0\u30eb\u30fc\u30d7\u3054\u3068\u306e\u50be\u304d\n  real<lower=0> s_a;                //\u5207\u7247\u306e\u30b0\u30eb\u30fc\u30d7\u9593\u3067\u306e\u3070\u3089\u3064\u304d\n  real<lower=0> s_b;                //X\u306e\u50be\u304d\u306e\u30b0\u30eb\u30fc\u30d7\u9593\u3067\u306e\u3070\u3089\u3064\u304d\n  real<lower=0> s_Y;                //\u5fdc\u7b54\u5909\u6570\u306e\u3070\u3089\u3064\u304d\n}\n\nmodel {\n  for (k in 1:K) {\n    a[k] ~ normal(a0, s_a);         //\u5207\u7247\u306e\u30b0\u30eb\u30fc\u30d7\u5dee\u306f\uff0c\u3053\u306e\u6b63\u898f\u5206\u5e03\u304b\u3089\u767a\u751f\n    b[k] ~ normal(b0, s_b);         //X\u306e\u50be\u304d\u306e\u30b0\u30eb\u30fc\u30d7\u5dee\u306f\uff0c\u3053\u306e\u6b63\u898f\u5206\u5e03\u304b\u3089\u767a\u751f\n  }\n\n  for (n in 1:N)                    //\u5fdc\u7b54\u5909\u6570\u306b\u95a2\u3059\u308b\u78ba\u7387\u30e2\u30c7\u30eb\n    Y[n] ~ normal(a[KID[n]] + b[KID[n]]*X[n], s_Y);\n}\n\n```\n\n\u3053\u306e\u30b3\u30fc\u30c9\u3092\u30de\u30eb\u30c1\u30ec\u30d9\u30eb\u5a92\u4ecb\u30e2\u30c7\u30eb\u306b\u9069\u7528\u3059\u308b\u305f\u3081\u306b\u306f\uff0c\u4ee5\u4e0b2\u70b9\u306e\u8ffd\u8a18\u304c\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\u3002\n1. X\u304c\u8907\u6570\u5b58\u5728\u3059\u308b\uff0c\u91cd\u56de\u5e30\u5206\u6790\u306e\u30b3\u30fc\u30c9\u3092\u52a0\u7b46\n2. \u56de\u5e30\u4fc2\u6570\u3092\u639b\u3051\u5408\u308f\u305b\u3066\uff0c\u9593\u63a5\u52b9\u679c\u3092\u6c42\u3081\u308b\u30b3\u30fc\u30c9\u3092\u52a0\u7b46\n\n\u307e\u305a1\u70b9\u76ee\u306b\u3064\u3044\u3066\u3002\n\u5a92\u4ecb\u5206\u6790\u306f\uff0cX->Y\u306e\u76f4\u63a5\u7684\u306a\u95a2\u4fc2\u3092\uff0cX->M\uff0cM->Y\u3068\u3044\u3046\u9593\u63a5\u7684\u306a\u95a2\u4fc2\u3068\u3057\u3066\u8868\u73fe\u3067\u304d\u308b\u304b\u3069\u3046\u304b\u3092\u77e5\u308b\u305f\u3081\u306e\u5206\u6790\u3067\u3057\u305f\u3002\u3053\u3053\u3067X->M\u306e\u5206\u6790\u306f\uff0c\u307e\u3055\u306b\u5358\u56de\u5e30\u5206\u6790\u306b\u76f8\u5f53\u3057\u307e\u3059\u3002\u3057\u305f\u304c\u3063\u3066\uff0c\u4e0a\u8a18\u306eStan\u30b3\u30fc\u30c9\u3092\u305d\u306e\u307e\u307e\u62dd\u501f\u3059\u308b\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002\u305f\u3060\u3057\uff0cX\u3067\u4e88\u6e2c\u3057\u305f\u3044\u306e\u306fY\u3067\u306f\u306a\u304fM\u3067\u3059\u304b\u3089\uff0c\u305d\u306e\u70b9\u3092\u66f8\u304d\u63db\u3048\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u307e\u305f\uff0c\u3053\u306e\u30b3\u30fc\u30c9\u5185\u3067\u306fX->M\u30e2\u30c7\u30eb\u306b\u304a\u3051\u308b\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u63a8\u5b9a\u3057\u305f\u3044\u3053\u3068\u304c\u5206\u304b\u308b\u3088\u3046\u306b\uff0c\u30d1\u30e9\u30e1\u30fc\u30bf\u540d\u306e\u6700\u5f8c\u306b'__M'\u3068\u52a0\u7b46\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\nM->Y\u30e2\u30c7\u30eb\u3082\u4e00\u898b\u3059\u308b\u3068\u5358\u56de\u5e30\u5206\u6790\u306b\u898b\u3048\u307e\u3059\u304c\uff0cM\u306e\u80cc\u5f8c\u306b\u306fX\u304c\u5b58\u5728\u3059\u308b\u306e\u3067\uff0cX\u3068M\u3067Y\u3092\u4e88\u6e2c\u3059\u308b\uff0c\u91cd\u56de\u5e30\u5206\u6790\u306b\u306a\u308a\u307e\u3059\u3002\u3068\u306f\u3044\u3048\uff0c\u8aac\u660e\u5909\u6570\u306e\u6570\u3060\u3051\uff0c\u63a8\u5b9a\u3059\u308b\u50be\u304d\u30d1\u30e9\u30e1\u30fc\u30bf\uff08\u53ca\u3073\u305d\u306e\u305f\u3081\u306b\u5fc5\u8981\u306a\u30d1\u30e9\u30e1\u30fc\u30bf\uff09\u3092\u5897\u3084\u305b\u3070\u6e08\u307f\u307e\u3059\u3002M->Y\u30e2\u30c7\u30eb\u306b\u304a\u3051\u308b\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u63a8\u5b9a\u3057\u305f\u3044\u3053\u3068\u304c\u5206\u304b\u308b\u3088\u3046\u306b\uff0c\u30d1\u30e9\u30e1\u30fc\u30bf\u540d\u306e\u6700\u5f8c\u306b'__Y'\u3068\u52a0\u7b46\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n\n\u6b21\u306b2\u70b9\u76ee\u306b\u3064\u3044\u3066\u3002\n[\u3053\u3061\u3089\u306e\u30b5\u30a4\u30c8](http://norimune.net/2800)\u3067\u7d39\u4ecb\u3055\u308c\u3066\u3044\u308b\u3088\u3046\u306b\uff0cgenerated quantities\u30d6\u30ed\u30c3\u30af\u306b\u304a\u3044\u3066\uff0c\u4ee5\u4e0b\u306e\u4e8c\u3064\u3092\u639b\u3051\u5408\u308f\u305b\u308b\u3060\u3051\u3067\u3059\u3002\n- X->M\u30e2\u30c7\u30eb\u306b\u304a\u3051\u308bX\u306e\u50be\u304d\n- M->Y\u30e2\u30c7\u30eb\u306b\u304a\u3051\u308bM\u306e\u50be\u304d\n\n\n\u3053\u308c\u3089\u3092Stan\u30b3\u30fc\u30c9\u3067\u8868\u3057\u305f\u3082\u306e\u304c\u4ee5\u4e0b\u3067\u3059\u3002\n\n\n```R:multilevel_mediation1\ndata{\n  int N;                                 //\u7dcf\u30c7\u30fc\u30bf\u6570\n  int K;                                 //\u30b0\u30eb\u30fc\u30d7\u6570\n  vector[N] X;                           //\u8aac\u660e\u5909\u6570\n  vector[N] M;                           //\u5a92\u4ecb\u5909\u6570\n  vector[N] Y;                           //\u5fdc\u7b54\u5909\u6570\n  int<lower=1, upper=K> KID[N];          //\u30b0\u30eb\u30fc\u30d7\u3092\u8b58\u5225\u3059\u308bID\n}     \n      \nparameters {\n  // X->M model\n  real a0__M;                            //\u5207\u7247\u306e\u5168\u4f53\u5e73\u5747\n  real b0__M;                            //X\u306e\u4fc2\u6570\u306e\u5168\u4f53\u5e73\u5747\n  real a__M[K];                          //\u30b0\u30eb\u30fc\u30d7\u3054\u3068\u306e\u5207\u7247 \n  real b__M[K];                          //\u30b0\u30eb\u30fc\u30d7\u3054\u3068\u306eX\u306e\u50be\u304d\n  real<lower=0> s_a__M;                  //\u5207\u7247\u306e\u30b0\u30eb\u30fc\u30d7\u9593\u3067\u306e\u3070\u3089\u3064\u304d\n  real<lower=0> s_b__M;                  //X\u306e\u50be\u304d\u306e\u30b0\u30eb\u30fc\u30d7\u9593\u3067\u306e\u3070\u3089\u3064\u304d\n  real<lower=0> s_Y__M;                  //\u5a92\u4ecb\u5909\u6570\u306e\u3070\u3089\u3064\u304d\n  \n  // M->Y model      \n  real a0__Y;                            //\u5207\u7247\u306e\u5168\u4f53\u5e73\u5747\n  real b0__Y1;                           //X\u306e\u4fc2\u6570\u306e\u5168\u4f53\u5e73\u5747\n  real b0__Y2;                           //M\u306e\u4fc2\u6570\u306e\u5168\u4f53\u5e73\u5747\n  real a__Y[K];                          //\u30b0\u30eb\u30fc\u30d7\u3054\u3068\u306e\u5207\u7247\n  real b__Y1[K];                         //\u30b0\u30eb\u30fc\u30d7\u3054\u3068\u306eX\u306e\u4fc2\u6570\n  real b__Y2[K];                         //\u30b0\u30eb\u30fc\u30d7\u3054\u3068\u306eM\u306e\u4fc2\u6570\n  real<lower=0> s_a__Y;                  //\u5207\u7247\u306e\u30b0\u30eb\u30fc\u30d7\u9593\u3067\u306e\u3070\u3089\u3064\u304d\n  real<lower=0> s_b__Y1;                 //X\u306e\u4fc2\u6570\u306e\u30b0\u30eb\u30fc\u30d7\u9593\u3067\u306e\u3070\u3089\u3064\u304d\n  real<lower=0> s_b__Y2;                 //M\u306e\u4fc2\u6570\u306e\u30b0\u30eb\u30fc\u30d7\u9593\u3067\u306e\u3070\u3089\u3064\u304d\n  real<lower=0> s_Y__Y;                  //\u5fdc\u7b54\u5909\u6570\u306e\u3070\u3089\u3064\u304d\n}\n\nmodel {\n  for (k in 1:K) {\n    // X->M model\n    a__M[k] ~ normal(a0__M, s_a__M);     //\u5207\u7247\u306e\u30b0\u30eb\u30fc\u30d7\u5dee\u306f\uff0c\u3053\u306e\u6b63\u898f\u5206\u5e03\u304b\u3089\u767a\u751f\n    b__M[k] ~ normal(b0__M, s_b__M);     //X\u306e\u50be\u304d\u306e\u30b0\u30eb\u30fc\u30d7\u5dee\u306f\uff0c\u3053\u306e\u6b63\u898f\u5206\u5e03\u304b\u3089\u767a\u751f\n    \n    // M->Y model\n    a__Y[k] ~ normal(a0__Y, s_a__Y);     //\u5207\u7247\u306e\u30b0\u30eb\u30fc\u30d7\u5dee\u306f\uff0c\u3053\u306e\u6b63\u898f\u5206\u5e03\u304b\u3089\u767a\u751f\n    b__Y1[k] ~ normal(b0__Y1, s_b__Y1);  //X\u306e\u50be\u304d\u306e\u30b0\u30eb\u30fc\u30d7\u5dee\u306f\uff0c\u3053\u306e\u6b63\u898f\u5206\u5e03\u304b\u3089\u767a\u751f\n    b__Y2[k] ~ normal(b0__Y2, s_b__Y2);  //M\u306e\u50be\u304d\u306e\u30b0\u30eb\u30fc\u30d7\u5dee\u306f\uff0c\u3053\u306e\u6b63\u898f\u5206\u5e03\u304b\u3089\u767a\u751f\n  }\n\n  for (n in 1:N) {                       //M\u3068Y\u306b\u95a2\u3059\u308b\u78ba\u7387\u30e2\u30c7\u30eb\n    M[n] ~ normal(a__M[KID[n]] + b__M[KID[n]]*X[n], s_Y__M);\n    Y[n] ~ normal(a__Y[KID[n]] + b__Y1[KID[n]]*X[n] + b__Y2[KID[n]]*M[n], s_Y__Y);\n  }\n  \n  //prior\n  s_a__M ~ cauchy(0, 2.5);               //\u63a8\u5b9a\u306e\u5b89\u5b9a\u6027\u306e\u305f\u3081\uff0c\u3070\u3089\u3064\u304d\u306e\u4e8b\u524d\u5206\u5e03\u306b\u534a\u30b3\u30fc\u30b7\u30fc\u5206\u5e03\u3092\u6307\u5b9a\n  s_b__M ~ cauchy(0, 2.5);\n  s_a__Y ~ cauchy(0, 2.5);\n  s_b__Y1 ~ cauchy(0, 2.5);\n  s_b__Y2 ~ cauchy(0, 2.5);\n}\n\ngenerated quantities{\n  real indirect;                           \n  indirect = b0__M * b0__Y2;             //\u50be\u304d\u306e\u7a4d\u306b\u3088\u308a\u9593\u63a5\u52b9\u679c\u3092\u8a08\u7b97\n}\n\n```\n\n\u4e0a\u8a18\u306eStan\u30b3\u30fc\u30c9\u3092\u9069\u5f53\u306a\u540d\u524d\u3067\u4fdd\u5b58\u3057\uff0c\u4ee5\u4e0b\u306eR\u30b3\u30fc\u30c9\u3067\u30b5\u30f3\u30d7\u30ea\u30f3\u30b0\u3092\u8a66\u3057\u3066\u307f\u307e\u3059\u3002\u3053\u3053\u3067\u306f'BMM.stan'\u3068\u3044\u3046\u540d\u524d\u3067\u4fdd\u5b58\u3057\u307e\u3057\u305f\u3002\n\n```R:R_code\nlibrary(rstan)\n\nstanmodel <- stan_model('BMM.stan')\ndata=list(N=nrow(dat), K=max(dat$id), Y=dat$Y, M=dat$M, X=dat$X, KID=dat$id)\nfit <- sampling(stanmodel,\n                data=data,\n                iter=20000,\n                warmup=3000,\n                thin=5,\n                seed=1234)\n\nprint(fit, pars=c(\"a0__M\",\"b0__M\",\"s_a__M\",\"s_b__M\",\"s_Y__M\",\"a0__Y\",\"b0__Y1\",\"b0__Y2\",\"s_a__Y\",\"s_b__Y1\",\"s_b__Y2\",\"s_Y__Y\",\"indirect\"))\n\n```\n\n\u7d50\u679c\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\u306a\u304a\u3053\u308c\u3089\u306f\u6a19\u6e96\u5316\u3055\u308c\u305f\u5024\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\n![result.PNG](https://qiita-image-store.s3.amazonaws.com/0/151885/99a0fd09-c611-144f-aca7-c16b7275aed2.png)\n\n\n\u4eca\u56de\u306f\uff0citeration=20000\uff0cwarmup=3000\u3068\u3044\u3046\u5927\u304d\u306a\u56de\u6570\u3067\u30b5\u30f3\u30d7\u30ea\u30f3\u30b0\u3057\u3066\u3044\u308b\u306e\u3067\uff0cRhat\u306f\u3069\u308c\u3082\u8a31\u5bb9\u7bc4\u56f2\u306b\u53ce\u307e\u3063\u3066\u3044\u307e\u3059\u304c\uff0c's_b__Y1'\u3068\u3044\u3046\u30d1\u30e9\u30e1\u30fc\u30bf\u306en_eff\u304c\u4ed6\u3068\u6bd4\u3079\u3066\u5c0f\u3055\u3044\u3053\u3068\u304c\u5206\u304b\u308a\u307e\u3059\u3002\u30c8\u30ec\u30fc\u30b9\u30d7\u30ed\u30c3\u30c8\u7b49\u306e\u30b0\u30e9\u30d5\u306f\u7701\u7565\u3057\u307e\u3059\u304c\uff0c\u78ba\u8a8d\u3057\u3066\u307f\u308b\u3068\u81ea\u5df1\u76f8\u95a2\u304c\u9ad8\u305d\u3046\u3067\u3057\u305f\u3002\u4e8b\u524d\u306b\u30b5\u30f3\u30d7\u30ea\u30f3\u30b0\u3057\u3066\u307f\u3066\uff0c\u3053\u3046\u306a\u308b\u3053\u3068\u304c\u5206\u304b\u3063\u3066\u3044\u305f\u306e\u3067\uff0cthin=5\u3067thinning\u3092\u884c\u3063\u305f\u306e\u3067\u3059\u304c\uff0c\u3042\u307e\u308a\u6539\u5584\u3055\u308c\u3066\u3044\u306a\u3044\u307f\u305f\u3044\u3067\u3059\u3002thin\u3092\u3082\u3063\u3068\u5927\u304d\u304f\u3059\u308b\u304b\uff0c[Stan\u3068R\u3067\u30d9\u30a4\u30ba\u7d71\u8a08\u30e2\u30c7\u30ea\u30f3\u30b0](http://www.kyoritsu-pub.co.jp/bookdetail/9784320112421)\u306e\u7b2c4\u7ae0\u306b\u3042\u308b\u3088\u3046\u306b\uff0c\u305d\u3082\u305d\u3082\u306e\u30e2\u30c7\u30eb\u3092\u6539\u826f\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\u3068\u308a\u3042\u3048\u305a\u4eca\u56de\u306f\u3053\u306e\u307e\u307e\u9032\u3081\u307e\u3059\u3002\n\n\u4eca\u56de\u4e00\u756a\u95a2\u5fc3\u304c\u3042\u308b\u306e\u306f\uff0c\u9593\u63a5\u52b9\u679c\uff08indirect\uff09\u3067\u3059\u3002\u4ee5\u4e0b\u306e\u30b0\u30e9\u30d5\u3092\u898b\u308b\u9650\u308a\uff0c\u53ce\u675f\u306b\u306f\u554f\u984c\u306a\u3055\u305d\u3046\u3067\u3059\u3002\u5206\u5e03\u306f\u5de6\u53f3\u306b\u5927\u304d\u304f\u6b6a\u3093\u3067\u3044\u308b\u308f\u3051\u3067\u306f\u306a\u3044\u306e\u3067\uff0c\u4e8b\u5f8c\u5e73\u57470.03\u3092\u4ee3\u8868\u5024\u3068\u3057\u3066\u63a1\u7528\u3057\u307e\u3059\u300295%\u78ba\u4fe1\u533a\u9593\u306f0\u3092\u307e\u305f\u3044\u3067\u3044\u306a\u3044\u306e\u3067\uff0c\u300c\u4ed5\u4e8b\u306b\u304a\u3051\u308b\u30b9\u30c8\u30ec\u30c3\u30b5\u30fc\u304c\u5897\u3048\u308b\u307b\u3069\uff0c\u4ed5\u4e8b\u3078\u306e\u4e0d\u6e80\u304c\u5927\u304d\u304f\u306a\u308a\uff0c\u305d\u306e\u7d50\u679c\u3068\u3057\u3066\u4eba\u9593\u95a2\u4fc2\u3078\u306e\u4e0d\u6e80\u3082\u5927\u304d\u304f\u306a\u308b\u300d\u3068\u3044\u3046\u5a92\u4ecb\u904e\u7a0b\u304c\u5b58\u5728\u3059\u308b\u3068\uff0c\u78ba\u4fe1\u3092\u6301\u3066\u305d\u3046\u3067\u3059\u3002\n\n![indirect.png](https://qiita-image-store.s3.amazonaws.com/0/151885/da27c2b0-2653-362d-6036-093502da8712.png)\n\n\n##\u5909\u91cf\u52b9\u679c\u9593\u306b\u76f8\u95a2\u3092\u4eee\u5b9a\u201d\u3059\u308b\u201d\u5834\u5408\u306eStan\u30b3\u30fc\u30c9\n\u3053\u3053\u3067\u3082\u3046\u4e00\u5ea6\uff0c\u4ee5\u4e0b\u306e\u30b0\u30e9\u30d5\u306b\u6ce8\u76ee\u3057\u3066\u307f\u307e\u3059\u3002\u7279\u306b\u5de6\u306eX->M\u30e2\u30c7\u30eb\u304c\u5206\u304b\u308a\u3084\u3059\u3044\u3068\u601d\u3046\u306e\u3067\u3059\u304c\uff0c\u4f55\u3068\u306a\u304f\uff0c\u5207\u7247\u304c\u5c0f\u3055\u3044\u307b\u3069\u50be\u304d\u304c\u5927\u304d\u3044\u50be\u5411\u304c\u3042\u308b\u3088\u3046\u306b\u601d\u308f\u308c\u307e\u3059\u3002\n\n![Rplot.png](https://qiita-image-store.s3.amazonaws.com/0/151885/b052e859-9bde-6a44-a15e-d2e8335b2ad1.png)\n\n\u3082\u3068\u3082\u3068\u4ed5\u4e8b\u306b\u5bfe\u3059\u308b\u4e0d\u6e80\u304c\u4f4e\u3051\u308c\u3070\uff0c\u5c11\u3057\u306e\u30b9\u30c8\u30ec\u30c3\u30b5\u30fc\u306e\u5897\u52a0\u3067\u3082\uff0c\u4e0d\u6e80\u306f\u4e0a\u6607\u3057\u3084\u3059\u3044\u3068\u8003\u3048\u3089\u308c\u307e\u3059\u3002\u3053\u308c\u306f\u3053\u306e\u30b5\u30f3\u30d7\u30eb\u30c7\u30fc\u30bf\u306b\u9650\u3063\u305f\u8a71\u3067\u306f\u306a\u304f\uff0c\u30db\u30fc\u30e0\u30e9\u30f3\u6570\u3068\u5e74\u53ce\u306e\u95a2\u4fc2\u306b\u3082\u540c\u3058\u3088\u3046\u306b\uff0c\u5207\u7247\u304c\u5c0f\u3055\u3044\u500b\u4eba\u307b\u3069\u50be\u304d\u304c\u5927\u304d\u304f\u306a\u308a\u3084\u3059\u3044\u3068\u3044\u3046\uff0c\u8ca0\u306e\u76f8\u95a2\u304c\u8a8d\u3081\u3089\u308c\u308b\u3068\u601d\u308f\u308c\u307e\u3059\u3002\u4f38\u3073\u3057\u308d\u3067\u3059\u306d\u3002\n\n\u3068\u3044\u3046\u308f\u3051\u3067\uff0cStan\u30b3\u30fc\u30c9\u3092\u66f8\u304d\u63db\u3048\u3066\u307f\u307e\u3059\u3002\u5207\u7247\u3068\u50be\u304d\u306e\u500b\u4eba\u5dee\u306f\uff0c\u305d\u308c\u305e\u308c\u72ec\u7acb\u306b\u6b63\u898f\u5206\u5e03\u304b\u3089\u767a\u751f\u3057\u305f\u3068\u4eee\u5b9a\u3057\u3066\u3044\u307e\u3057\u305f\u304c\uff0c\u3055\u3089\u306b\u3053\u308c\u3089\u306e\u9593\u306b\u76f8\u95a2\u95a2\u4fc2\u3092\u60f3\u5b9a\u3057\u307e\u3059\u3002\u305d\u3053\u3067[\u3053\u3061\u3089\u306e\u30b9\u30e9\u30a4\u30c9](http://www.slideshare.net/simizu706/stan-64926504)\u306e140\u679a\u76ee\u4ee5\u964d\u306b\u8a18\u8f09\u3055\u308c\u3066\u3044\u308b\u3088\u3046\u306b\uff0c\u591a\u5909\u91cf\u6b63\u898f\u5206\u5e03\u3092\u4eee\u5b9a\u3057\u305f\u66f8\u304d\u65b9\u306b\u5909\u66f4\u3057\u307e\u3059\u3002\n\n```R:multilevel_mediation2\ndata{\n  int N;                                 //\u7dcf\u30c7\u30fc\u30bf\u6570\n  int K;                                 //\u30b0\u30eb\u30fc\u30d7\u6570\n  vector[N] X;                           //\u8aac\u660e\u5909\u6570\n  vector[N] M;                           //\u5a92\u4ecb\u5909\u6570\n  vector[N] Y;                           //\u5fdc\u7b54\u5909\u6570\n  int<lower=1, upper=K> KID[N];          //\u30b0\u30eb\u30fc\u30d7\u3092\u8b58\u5225\u3059\u308bID\n}     \n\nparameters {\n  vector[5] f;                           //\u56fa\u5b9a\u52b9\u679c\uff08\u5e73\u5747\uff09\n  vector[5] r[K];                        //\u5909\u91cf\u52b9\u679c\n  vector<lower=0>[5] tau;                //\u5909\u91cf\u52b9\u679c\u306eSD\n  corr_matrix[5] rho;                    //\u5909\u91cf\u52b9\u679c\u306e\u76f8\u95a2\u884c\u5217\n  real<lower=0> sigma__M;                //M\u306e\u6b8b\u5deeSD\n  real<lower=0> sigma__Y;                //Y\u306e\u6b8b\u5deeSD\n}\n\ntransformed parameters{                  //\u5171\u5206\u6563\u884c\u5217\u306f\u6307\u5b9a\u304c\u96e3\u3057\u3044\u305f\u3081\u30d1\u30e9\u30e1\u30fc\u30bf\u3068\u3057\u3066\u5ba3\u8a00\u305b\u305a\uff0cSD\u3068\u76f8\u95a2\u884c\u5217\u306b\u5206\u3051\u3066\u3053\u308c\u3089\u3092\u30d1\u30e9\u30e1\u30fc\u30bf\u3067\u5ba3\u8a00\u3059\u308b\n  cov_matrix[5] taumx;                   //\u30e9\u30f3\u30c0\u30e0\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u5171\u5206\u6563\u884c\u5217\n  taumx = quad_form_diag(rho, tau);      //\u76f8\u95a2\u884c\u5217\u3068\uff08\u5909\u91cf\u52b9\u679c\u306e\uff09SD\u3092\u5171\u5206\u6563\u884c\u5217\u306b\u5909\u63db\n}\n\nmodel {\n  //M\u3068Y\u306b\u95a2\u3059\u308b\u78ba\u7387\u30e2\u30c7\u30eb\n  for (n in 1:N) {                       \n    M[n] ~ normal(r[KID[n]][1] + r[KID[n]][2]*X[n], sigma__M);\n    Y[n] ~ normal(r[KID[n]][3] + r[KID[n]][4]*X[n] + r[KID[n]][5]*M[n], sigma__Y);\n  }\n  \n  //\u30e9\u30f3\u30c0\u30e0\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u5206\u5e03\u3000\u591a\u5909\u91cf\u6b63\u898f\u5206\u5e03\n  r ~ multi_normal(f, taumx);\n\n  //\u4e8b\u524d\u5206\u5e03\n  tau ~ cauchy(0, 2.5);\n  rho ~ lkj_corr(1); \u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000//\u76f8\u95a2\u884c\u5217\u306e\u7121\u60c5\u5831\u4e8b\u524d\u5206\u5e03\n  sigma__M ~ cauchy(0, 2.5);\n  sigma__Y ~ cauchy(0, 2.5);\n}\n\ngenerated quantities{\n  real indirect;                           \n  indirect = f[2]*f[5];  \u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000 //\u50be\u304d\u306e\u7a4d\u306b\u3088\u308a\u9593\u63a5\u52b9\u679c\u3092\u8a08\u7b97\n}\n```\n\n\u4e0a\u8a18\u306eStan\u30b3\u30fc\u30c9\u3092'BMM2.stan'\u3068\u3044\u3046\u540d\u524d\u3067\u4fdd\u5b58\u3057\uff0c\u4ee5\u4e0b\u306eR\u30b3\u30fc\u30c9\u3092\u8d70\u3089\u305b\u307e\u3059\u3002\n\n```R:R_code2\nlibrary(rstan)\n\nstanmodel_2 <- stan_model('BMM2.stan')\ndata=list(N=nrow(dat), K=max(dat$id), Y=dat$Y, M=dat$M, X=dat$X, KID=dat$id)\nfit2 <- sampling(stanmodel_2,\n                data=data,\n                seed=1234)\n\nprint(fit2, pars=c(\"f\", \"tau\", \"indirect\"), digits=3)\n```\n\n\u30b5\u30f3\u30d7\u30ea\u30f3\u30b0\u56de\u6570\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u8a2d\u5b9a\u306b\u3057\u307e\u3057\u305f\u304c\uff0c\u53ce\u675f\u306f\u305d\u3093\u306a\u306b\u60aa\u304f\u306a\u3055\u305d\u3046\u3067\u3059\u3002\u9593\u63a5\u52b9\u679c\u306e\u4e8b\u5f8c\u5e73\u5747\u306f\uff0c\u5909\u91cf\u52b9\u679c\u9593\u306b\u76f8\u95a2\u3092\u4eee\u5b9a\u3057\u3066\u3082\u3057\u306a\u304f\u3066\u3082\uff0c\u3042\u307e\u308a\u5909\u308f\u308a\u307e\u305b\u3093\u3067\u3057\u305f\u3002\u30c7\u30fc\u30bf\u6b21\u7b2c\u3067\u306f\u7d50\u679c\u304c\u5909\u308f\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u304c\uff0c\u3053\u306e\u3042\u305f\u308a\u306f\u672a\u691c\u8a3c\u3067\u3059\u3002\n\n![multilevel_mediation_comparison1.png](https://qiita-image-store.s3.amazonaws.com/0/151885/8ff96d82-a1f5-edf3-1685-1402f578a7be.png)\n\n\n#\u691c\u7b97\n##bmlm\u30d1\u30c3\u30b1\u30fc\u30b8\n\u9593\u63a5\u52b9\u679c\u306e\u63a8\u5b9a\u304c\u3046\u307e\u304f\u3044\u3063\u3066\u3044\u308b\u304b\uff0cbmlm\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u4f7f\u3063\u3066\u8a08\u7b97\u3057\u305f\u7d50\u679c\u3068\u6bd4\u8f03\u3057\u3066\u307f\u307e\u3059\u3002Stan\u3067\u66f8\u3044\u305f\u5834\u5408\u3068\u8a2d\u5b9a\u3092\u7d71\u4e00\u3057\u3066\u30b5\u30f3\u30d7\u30ea\u30f3\u30b0\u3057\u3066\u307f\u307e\u3059\u3002\n\n```R:bmlm_package\nlibrary(bmlm)\n\nfit3 <- mlm(dat,\n            id=\"id\", x=\"X\", m=\"M\", y=\"Y\",\n            priors=list(tau_dy=2.5, tau_dm=2.5, tau_a=2.5, tau_b=2.5),\n            iter=20000,\n            warmup=3000,\n            thin=5,\n            seed=1234)\n\nmlm_summary(fit3)\nmlm_pars_plot(fit3, type=\"hist\")\n```\n\n\u7d50\u679c\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\u30d1\u30e9\u30e1\u30fc\u30bfa\u304cX->M\u30e2\u30c7\u30eb\u306b\u304a\u3051\u308b\u56de\u5e30\u4fc2\u6570\uff0c\u30d1\u30e9\u30e1\u30fc\u30bfb\u304cM->Y\u30e2\u30c7\u30eb\u306b\u304a\u3051\u308b\u56de\u5e30\u4fc2\u6570\u3092\u8868\u3057\u3066\u3044\u307e\u3059\u3002\u3053\u308c\u3089\u306e\u4e8b\u5f8c\u5e73\u5747\u306e\u7a4d\u3092\u6c42\u3081\u308b\u3068\uff0ca * b = 0.19 * 0.15 = 0.0285\u306a\u306e\u3067\uff0cStan\u3067\u66f8\u3044\u305f\u5834\u5408\u306e\u9593\u63a5\u52b9\u679c\u3068\u307b\u307c\u4e00\u81f4\u3057\u307e\u3059\u3002\u305f\u3060\uff0c\u30d1\u30e9\u30e1\u30fc\u30bfab\u304c\u9593\u63a5\u52b9\u679c\u3092\u8868\u3057\u3066\u3044\u308b\u306e\u3067\u3059\u304c\uff0c\u4e8b\u5f8c\u5e73\u5747\u306f0.05\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u306d...\u3002\n\n![bmlm_result.PNG](https://qiita-image-store.s3.amazonaws.com/0/151885/e916a329-df06-6614-1ffa-321125306acc.png)\n\n\n![bmlm_result_hist.png](https://qiita-image-store.s3.amazonaws.com/0/151885/2bbb28bc-11d1-8b1f-d68a-8329e5a82fa5.png)\n\n\nbmlm\u3067\u306f\uff0c\u56de\u5e30\u4fc2\u6570\u306e\u7a4d\u306b\u56de\u5e30\u4fc2\u6570\u9593\u306e\u5171\u5206\u6563\uff08covab\uff09\u3092\u52a0\u7b97\u3057\u305f\u5024\u304c\uff0c\u9593\u63a5\u52b9\u679c\uff08ab\uff09\u3068\u3057\u3066\u51fa\u529b\u3055\u308c\u307e\u3059\u3002\u3053\u3053\u3067\u306f\u5c0f\u6570\u70b9\u4ee5\u4e0b2\u6841\u307e\u3067\u3057\u304b\u8868\u793a\u3055\u308c\u3066\u3044\u306a\u3044\u306e\u3067\uff0c\u4e38\u3081\u3089\u308c\u3066\u3057\u307e\u3063\u3066\u5206\u304b\u308a\u3065\u3089\u3044\u3067\u3059\u304c\uff0cab\u304b\u3089covab\u3092\u6e1b\u7b97\u3059\u308b\u3068\uff0c0.05 - 0.03 = 0.02\u3068\u3044\u3046\u3053\u3068\u3067\uff0c\u4e0a\u8a18\u306e\u901a\u308aStan\u3067\u66f8\u3044\u305f\u5834\u5408\u3068\u304a\u304a\u3088\u305d\u4e00\u81f4\u3057\u307e\u3059\u3002\n\n\n##R\u3067\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\n[Stan\u3068R\u3067\u30d9\u30a4\u30ba\u7d71\u8a08\u30e2\u30c7\u30ea\u30f3\u30b0](http://www.kyoritsu-pub.co.jp/bookdetail/9784320112421)\u306e\u7b2c8\u7ae0\uff08\u968e\u5c64\u30e2\u30c7\u30eb\uff09\u306b\uff0cR\u3067\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u3059\u308b\u306e\u306f\u5927\u5207\u306a\u30b9\u30c6\u30c3\u30d7\u3067\u3042\u308b\u3068\u660e\u8a18\u3055\u308c\u3066\u3044\u307e\u3059\u30022\u5909\u91cf\u6b63\u898f\u5206\u5e03\u306b\u5f93\u3046\u4e71\u6570\u3092\u767a\u751f\u3055\u305b\uff0c\u4ee5\u4e0b\u4e8c\u901a\u308a\u306e\u65b9\u6cd5\u3067\u7d50\u679c\u3092\u6bd4\u8f03\u3057\u3066\u307f\u307e\u3059\u3002\n- \u5404\u5909\u6570\u306e\u7a4d\u3092\u5e73\u5747\u5316\u3059\u308b\u5834\u5408\n- \u5404\u5909\u6570\u306e\u5e73\u5747\u306e\u7a4d\u3092\u6c42\u3081\u308b\u5834\u5408\n\n```R:simulation\nlibrary(mvtnorm)\n\nsigma <- matrix(c(4,2,2,3), ncol=2)\nx <- rmvnorm(n=500, mean=c(1, 2), sigma=sigma) #2\u5909\u91cf\u6b63\u898f\u5206\u5e03\u306e\u751f\u6210\ncolMeans(x) #\u5404\u5909\u6570\u306e\u5e73\u5747\nvar(x) #\u5171\u5206\u6563\u884c\u5217\n\nproduct1 <- mean(x[,1] * x[,2]) #\u5404\u5909\u6570\u306e\u7a4d\u3092\u5e73\u5747\nprint(product1)\n\nproduct2 <- colMeans(x)[1] * colMeans(x)[2] #\u5404\u5909\u6570\u306e\u5e73\u5747\u306e\u7a4d\nprint(product2)\n\nprint(product1 - product2) #\u5dee\u5206\n```\n\n\u7d50\u679c\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002**\u5404\u5909\u6570\u306e\u5e73\u5747\u306e\u7a4d\u3092\u8a08\u7b97\u3057\u305f\u5834\u5408**\u306f\uff0c**\u5404\u5909\u6570\u306e\u7a4d\u3092\u5e73\u5747\u3057\u305f\u5834\u5408**\u3088\u308a\u3082\u5024\u304c\u5c0f\u3055\u3044\u3067\u3059\u3002\u305d\u3057\u3066\u305d\u306e\u5dee\u5206\u306f\uff0c\u5909\u6570\u9593\u306e\u5171\u5206\u6563\u306b\u307b\u307c\u4e00\u81f4\u3057\u307e\u3059\u3002\n\n![simulation.PNG](https://qiita-image-store.s3.amazonaws.com/0/151885/ef6bbde0-9220-32f6-0d01-bbc93233824f.png)\n\n\n\u4e0a\u8a18\u306eStan\u30b3\u30fc\u30c9\u3067\u3082\uff0cgenerated quantities\u30d6\u30ed\u30c3\u30af\u306b\u304a\u3051\u308b\u9593\u63a5\u52b9\u679c\u306e\u8a08\u7b97\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u66f4\u3059\u308c\u3070\uff0cbmlm\u306e\u7d50\u679c\u3068\u304a\u304a\u3088\u305d\u4e00\u81f4\u3057\u307e\u3059\u3002\n\n```r:indirect\ngenerated quantities{\n  real indirect;                           \n  indirect = f[2]*f[5] + taumx[2, 5];  //\u50be\u304d\u306e\u7a4d\u306b\u3088\u308a\u9593\u63a5\u52b9\u679c\u3092\u8a08\u7b97\n}\n```\n\n![multilevel_mediation_comparison2.png](https://qiita-image-store.s3.amazonaws.com/0/151885/61223476-d961-8786-aca1-66666e8afde6.png)\n\n\n\u3068\u3044\u3046\u308f\u3051\u3067\uff0c\u3069\u3046\u3084\u3089\u30de\u30eb\u30c1\u30ec\u30d9\u30eb\u5a92\u4ecb\u30e2\u30c7\u30eb\u306b\u304a\u3044\u3066\u9593\u63a5\u52b9\u679c\u3092\u5c0e\u51fa\u3059\u308b\u969b\u306f\uff0c\u5404\u56de\u5e30\u4fc2\u6570\u306e\u7a4d\u306b\u5171\u5206\u6563\u3092\u52a0\u7b97\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3088\u3046\u3067\u3059\u3002\n\u305f\u3060\u305d\u306e\u7406\u7531\u306b\u3064\u3044\u3066\u306f\uff0c\u57f7\u7b46\u8005\u306f\u307e\u3060\u7406\u89e3\u3067\u304d\u3066\u304a\u308a\u307e\u305b\u3093...\u3002\u305c\u3072\u3054\u6559\u6388\u304f\u3060\u3055\u3044...\u3002\n\n\n#\u304a\u308f\u308a\u306b\n\u57f7\u7b46\u8005\u306f\u3044\u308f\u3086\u308b\u53c2\u52a0\u8005\u5185\u30c7\u30b6\u30a4\u30f3\u3067\u5b9f\u9a13\u3092\u8a08\u753b\u3059\u308b\u3053\u3068\u304c\u591a\u3044\u3067\u3059\u3002\u3053\u306e\u30c7\u30b6\u30a4\u30f3\u3067\u306f\uff0c\u5404\u5b9f\u9a13\u53c2\u52a0\u8005\u304c\u8907\u6570\u306e\u6761\u4ef6\u3092\u7d4c\u9a13\u3059\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\u500b\u4eba\u306e\u4e2d\u306b\u5404\u6761\u4ef6\u304c\u5b58\u5728\u3059\u308b\uff0c\u968e\u5c64\u69cb\u9020\u3092\u6301\u3063\u305f\u30c7\u30fc\u30bf\u3068\u3044\u3048\u307e\u3059\u3002\u4f8b\u3048\u3070\u4ee5\u4e0b\u306e\u4f8b\u3067\u306f\uff0c\u5404\u53c2\u52a0\u8005\u304c\u5b9f\u9a13\u6761\u4ef6\uff08experiment\uff09\u3068\u7d71\u5236\u6761\u4ef6\uff08control\uff09\u3092\u4e21\u65b9\u7d4c\u9a13\u3057\u3066\u3044\u307e\u3059\u3002\n\n![fig2.png](https://qiita-image-store.s3.amazonaws.com/0/151885/3e912f81-57d0-b10a-d4c8-900167f61173.png)\n\n\u53c2\u52a0\u8005\u5185\u30c7\u30b6\u30a4\u30f3\u306e\u5b9f\u9a13\u3067\u5a92\u4ecb\u30e2\u30c7\u30eb\u3092\u4e3b\u5f35\u3057\u305f\u3044\u5834\u5408\uff0c\u30de\u30eb\u30c1\u30ec\u30d9\u30eb\u5a92\u4ecb\u30e2\u30c7\u30eb\u3092\u9069\u7528\u3059\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\u3057\u304b\u3057\uff0c\u305d\u308c\u3092\u5b9f\u73fe\u3059\u308b\u65b9\u6cd5\u304c\u3088\u304f\u5206\u304b\u3089\u306a\u304b\u3063\u305f\u306e\u3067\uff0cStan\u3067\u66f8\u3044\u3066\u307f\u3088\u3046\u3068\u601d\u3063\u305f\u306e\u304c\u672c\u8a18\u4e8b\u306e\u51fa\u767a\u70b9\u3067\u3057\u305f\u3002~~\u305d\u306e\u904e\u7a0b\u3067bmlm\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u5b58\u5728\u3092\u77e5\u308a\u300c\u306a\u3093\u3060\u3053\u308c\u3067\u3044\u3044\u3058\u3083\u3093\u300d\u3068\u4e00\u77ac\u601d\u3063\u305f\u3082\u306e\u306e\uff0c~~\u8a66\u884c\u932f\u8aa4\u3057\u306a\u304c\u3089\uff0c\u3054\u52a9\u8a00\u3092\u3044\u305f\u3060\u304d\u306a\u304c\u3089Stan\u3067\u66f8\u3044\u3066\u307f\u3066\uff0c\u8272\u3005\u3068\u52c9\u5f37\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n\u3082\u3057\u672c\u8a18\u4e8b\u306b\u9593\u9055\u3044\u304c\u3042\u308a\u307e\u3057\u305f\u3089\uff0c\u3054\u6307\u6458\u3092\u9802\u3051\u308c\u3070\u5e78\u3044\u3067\u3059\u3002\n\u6700\u5f8c\u306b\uff0c\u672c\u8a18\u4e8b\u306e\u57f7\u7b46\u306b\u3042\u305f\u308a\uff0c\u3054\u52a9\u8a00\u3092\u304f\u3060\u3055\u3063\u305f\u65b9\u3005\u306b\uff0c\u5fc3\u304b\u3089\u5fa1\u793c\u7533\u3057\u4e0a\u3052\u307e\u3059\u3002\n\n"}