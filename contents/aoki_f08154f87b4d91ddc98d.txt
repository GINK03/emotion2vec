{"context": "\n\n\u306f\u3058\u3081\u306b\nLinux \u306e netns veth \u3068\u3044\u3063\u305f\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u4eee\u60f3\u5316\u6a5f\u80fd\u3068 systemd-nspawn \u3084 quagga \u3092\u7d44\u307f\u5408\u308f\u305b\u3066\u3001\u4eee\u60f3\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u74b0\u5883\u3092\u69cb\u7bc9\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\u4eca\u56de\u306f\u4e0b\u8a18\u306e\u30c8\u30dd\u30ed\u30b8\u3092\u69cb\u7bc9\u3057\u307e\u3059\u3002\n\n\n\u69cb\u6210\u8981\u7d20\u306e\u7c21\u5358\u306a\u8aac\u660e\n\n\nnetns\n\n\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306e\u540d\u524d\u7a7a\u9593\u3092\u5206\u3051\u308c\u308b\u3084\u3064\n\u4eca\u56de\u306f\u30a8\u30f3\u30c9\u30c7\u30d0\u30a4\u30b9\u3068\u3057\u3066\u4f7f\u7528\n\n\n\nveth\n\n\u4eee\u60f3 LAN\u30b1\u30fc\u30d6\u30eb\n\u4eee\u60f3NIC \u306e\u30da\u30a2\u3092\u4f5c\u308b\n\n\n\nsystemd-nspawn\n\nchroot \u306e\u5f37\u3044\u3084\u3064\n\n\n\nquagga\n\nLinux \u4e0a\u3067\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u30d7\u30ed\u30c8\u30b3\u30eb\u3092\u52d5\u304b\u3059\u3084\u3064\n\n\n\n\n\u74b0\u5883\n\n\u30db\u30b9\u30c8OS: Arch Linux (systemd \u304c\u5165\u3063\u3066\u3044\u308c\u3070\u3069\u306e\u30c7\u30a3\u30b9\u30c8\u30ea\u3067\u3082 OK?\uff09\n\n\n\u624b\u98061 Arch Linux \u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u7701\u7565\n\n\u624b\u98062 Arch Linux \u5185\u306b systemd-nspawn \u3067 Arch Linux \u3092\u69cb\u7bc9\nhttps://wiki.archlinuxjp.org/index.php/Systemd-nspawn \u3053\u308c\u3092\u53c2\u8003\u306b\u4f5c\u308b\n$ sudo pacman -S arch-install-scripts\n$ mkdir router1\n$ sudo pacstrap -icd router1 base --ignore linux\n\n\n\u624b\u98063 systemd-nspawn Arch \u3092\u8a2d\u5b9a\n\n\u5165\u308b\n\n$ sudo systemd-nspawn -bD router1 --capabilyty=all\n# login: root\n\n\nquagga \u5165\u308c\u308b\n\n\nsystemd-nspawn\u5185\npacman -S quagga\n\ntouch /etc/quagga/zebra.conf\ntouch /etc/quagga/ospfd.conf\nchmod -R 777 /etc/quagga/\n\nsystemctl start zebra\nsystemctl start ospfd\n\nsystemctl enable zebra\nsystemctl enable ospfd\n\nvtysh\n# Cisco \u30e9\u30a4\u30af\u306a\u3084\u3064\u304c\u7acb\u3061\u4e0a\u304c\u308b\u4e8b\u3092\u78ba\u8a8d\u3059\u308b\n\n# Ctrl + ]]] \u9023\u6253\u3067 systemd-nspawn \u304b\u3089\u629c\u3051\u308b\n\n\n\n\nrouter \u3092\u8907\u88fd\u3059\u308b\n\nsudp cp -r router1 router2\n\n\n\u624b\u98064 netns, veth \u306e\u6e96\u5099\n# veth \u306e\u4f5c\u6210\nip link add r1-to-r2 type veth peer name r2-to-r1\nip link add r1-to-ns1 type veth peer name ns1-to-r1\nip link add r2-to-ns2 type veth peer name ns2-to-r2\n\n# netns \u306e\u4f5c\u6210\nip netns add ns1\nip netns add ns2\n\n\n\nip netns exec ns1 ip link set dev lo up\nip netns exec ns1 ip addr add 127.0.0.1/8 dev lo\n\nip netns exec ns2 ip link set dev lo up\nip netns exec ns2 ip addr add 127.0.0.1/8 dev lo\n\n\nip link set ns1-to-r1 netns ns1\nip link set ns2-to-r2 netns ns2\n\nip netns exec ns1 ip link set dev ns1-to-r1 up\nip netns exec ns1 ip addr add 192.168.81.2/24 dev ns1-to-r1\nip netns exec ns1 ip route add default via 192.168.81.1\n\nip netns exec ns2 ip link set dev ns2-to-r2 up\nip netns exec ns2 ip addr add 192.168.82.2/24 dev ns2-to-r2\nip netns exec ns2 ip route add default via 192.168.82.1\n\n\n\u624b\u98065 \u5404 router \u306e\u8a2d\u5b9a\n\u30a4\u30f3\u30bf\u30d5\u30a7\u30fc\u30b9\u306b IP \u30a2\u30c9\u30ec\u30b9\u3092\u5272\u308a\u632f\u308a\u3001 OSPF \u3067\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3055\u305b\u307e\u3059\u3002\n\nrouter1\n\n$ sudo systemd-nspawn -bD router1 --capability=all --network-interface=r1-to-r2 --network-interface=r1-to-ns1\n\n$ ip link set dev r1-to-r2 up\n$ ip link set dev r1-to-ns1 up\n\n$ ip addr add 172.16.80.1/24 dev r1-to-r2\n$ ip addr add 192.168.81.1/24 dev r1-to-ns1\n\n$ vtysh\n\nrouter1# conf t\nrouter1(config)# router ospf\nrouter1(config-router)# network 172.16.80.0/24 area 0\nrouter1(config-router)# network 192.168.81.0/24 area 0\n\n\nrouter2\n\n$ sudo systemd-nspawn -bD router2 --capability=all --network-interface=r2-to-r1 --network-interface=r2-to-ns2\n\n$ ip link set dev r2-to-r1 up\n$ ip link set dev r2-to-ns2 up\n\n$ ip addr add 172.16.80.2/24 dev r2-to-r1\n$ ip addr add 192.168.82.1/24 dev r2-to-ns2\n\n\n$ vtysh\n\nrouter1# conf t\nrouter1(config)# router ospf\nrouter1(config-router)# network 172.16.80.0/24 area 0\nrouter1(config-router)# network 192.168.82.0/24 area 0\n\n\n\u624b\u98066 \u758e\u901a\u78ba\u8a8d\nip netns exec r1 /bin/bash\n\nping 192.168.82.2\n\nPING 192.168.82.2 (192.168.82.2) 56(84) bytes of data.\n64 bytes from 192.168.82.2: icmp_seq=1 ttl=62 time=0.059 ms\n64 bytes from 192.168.82.2: icmp_seq=2 ttl=62 time=0.060 ms\n64 bytes from 192.168.82.2: icmp_seq=3 ttl=62 time=0.073 ms\n\n--- 192.168.82.2 ping statistics ---\n3 packets transmitted, 3 received, 0% packet loss, time 2022ms\nrtt min/avg/max/mdev = 0.059/0.064/0.073/0.006 ms\n\n\n\n\n\u307e\u3068\u3081\nsystemd-nspawn + quagga \u306a\u3069\u3092\u5229\u7528\u3059\u308b\u3053\u3068\u3067\u3001\u7c21\u5358\u306a\u4eee\u60f3\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u74b0\u5883\u3092\u69cb\u7bc9\u3057\u307e\u3057\u305f\u3002\n\u4eca\u5f8c\u306f\u3001kvm \u3084 ovs \u306e\u63a5\u7d9a\u306a\u3069\u3092\u3084\u3063\u3066\u307f\u3088\u3046\u3068\u601d\u3044\u307e\u3059\u3002\n#\u306f\u3058\u3081\u306b\nLinux \u306e `netns` `veth` \u3068\u3044\u3063\u305f\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u4eee\u60f3\u5316\u6a5f\u80fd\u3068 `systemd-nspawn` \u3084 `quagga` \u3092\u7d44\u307f\u5408\u308f\u305b\u3066\u3001\u4eee\u60f3\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u74b0\u5883\u3092\u69cb\u7bc9\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n\u4eca\u56de\u306f\u4e0b\u8a18\u306e\u30c8\u30dd\u30ed\u30b8\u3092\u69cb\u7bc9\u3057\u307e\u3059\u3002\n![quagga-netns.png](https://qiita-image-store.s3.amazonaws.com/0/31573/4e473c41-4673-f0cc-3b61-e0f8d8bd113c.png)\n\n## \u69cb\u6210\u8981\u7d20\u306e\u7c21\u5358\u306a\u8aac\u660e\n+ netns\n    + \u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306e\u540d\u524d\u7a7a\u9593\u3092\u5206\u3051\u308c\u308b\u3084\u3064\n    + \u4eca\u56de\u306f\u30a8\u30f3\u30c9\u30c7\u30d0\u30a4\u30b9\u3068\u3057\u3066\u4f7f\u7528\n\n+ veth\n    + \u4eee\u60f3 LAN\u30b1\u30fc\u30d6\u30eb\n    + \u4eee\u60f3NIC \u306e\u30da\u30a2\u3092\u4f5c\u308b\n\n+ systemd-nspawn\n    + chroot \u306e\u5f37\u3044\u3084\u3064\n\n+ quagga\n    + Linux \u4e0a\u3067\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u30d7\u30ed\u30c8\u30b3\u30eb\u3092\u52d5\u304b\u3059\u3084\u3064\n\n## \u74b0\u5883\n\n+ \u30db\u30b9\u30c8OS: Arch Linux (systemd \u304c\u5165\u3063\u3066\u3044\u308c\u3070\u3069\u306e\u30c7\u30a3\u30b9\u30c8\u30ea\u3067\u3082 OK?\uff09\n\n\n## \u624b\u98061 Arch Linux \u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u7701\u7565\n\n## \u624b\u98062 Arch Linux \u5185\u306b systemd-nspawn \u3067 Arch Linux \u3092\u69cb\u7bc9\nhttps://wiki.archlinuxjp.org/index.php/Systemd-nspawn \u3053\u308c\u3092\u53c2\u8003\u306b\u4f5c\u308b\n\n```\n$ sudo pacman -S arch-install-scripts\n$ mkdir router1\n$ sudo pacstrap -icd router1 base --ignore linux\n```\n\n## \u624b\u98063 systemd-nspawn Arch \u3092\u8a2d\u5b9a\n\n+ \u5165\u308b\n\n```\n$ sudo systemd-nspawn -bD router1 --capabilyty=all\n# login: root\n```\n\n+ quagga \u5165\u308c\u308b\n\n```bash:systemd-nspawn\u5185\npacman -S quagga\n\ntouch /etc/quagga/zebra.conf\ntouch /etc/quagga/ospfd.conf\nchmod -R 777 /etc/quagga/\n\nsystemctl start zebra\nsystemctl start ospfd\n\nsystemctl enable zebra\nsystemctl enable ospfd\n\nvtysh\n# Cisco \u30e9\u30a4\u30af\u306a\u3084\u3064\u304c\u7acb\u3061\u4e0a\u304c\u308b\u4e8b\u3092\u78ba\u8a8d\u3059\u308b\n\n# Ctrl + ]]] \u9023\u6253\u3067 systemd-nspawn \u304b\u3089\u629c\u3051\u308b\n\n```\n\n+ router \u3092\u8907\u88fd\u3059\u308b\n\n```\nsudp cp -r router1 router2\n```\n\n\n## \u624b\u98064 netns, veth \u306e\u6e96\u5099\n\n```\n# veth \u306e\u4f5c\u6210\nip link add r1-to-r2 type veth peer name r2-to-r1\nip link add r1-to-ns1 type veth peer name ns1-to-r1\nip link add r2-to-ns2 type veth peer name ns2-to-r2\n\n# netns \u306e\u4f5c\u6210\nip netns add ns1\nip netns add ns2\n\n\n\nip netns exec ns1 ip link set dev lo up\nip netns exec ns1 ip addr add 127.0.0.1/8 dev lo\n\nip netns exec ns2 ip link set dev lo up\nip netns exec ns2 ip addr add 127.0.0.1/8 dev lo\n\n\nip link set ns1-to-r1 netns ns1\nip link set ns2-to-r2 netns ns2\n\nip netns exec ns1 ip link set dev ns1-to-r1 up\nip netns exec ns1 ip addr add 192.168.81.2/24 dev ns1-to-r1\nip netns exec ns1 ip route add default via 192.168.81.1\n\nip netns exec ns2 ip link set dev ns2-to-r2 up\nip netns exec ns2 ip addr add 192.168.82.2/24 dev ns2-to-r2\nip netns exec ns2 ip route add default via 192.168.82.1\n```\n\n\n## \u624b\u98065 \u5404 router \u306e\u8a2d\u5b9a\n\n\u30a4\u30f3\u30bf\u30d5\u30a7\u30fc\u30b9\u306b IP \u30a2\u30c9\u30ec\u30b9\u3092\u5272\u308a\u632f\u308a\u3001 OSPF \u3067\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3055\u305b\u307e\u3059\u3002\n\n+ router1\n\n```\n$ sudo systemd-nspawn -bD router1 --capability=all --network-interface=r1-to-r2 --network-interface=r1-to-ns1\n\n$ ip link set dev r1-to-r2 up\n$ ip link set dev r1-to-ns1 up\n\n$ ip addr add 172.16.80.1/24 dev r1-to-r2\n$ ip addr add 192.168.81.1/24 dev r1-to-ns1\n\n$ vtysh\n\nrouter1# conf t\nrouter1(config)# router ospf\nrouter1(config-router)# network 172.16.80.0/24 area 0\nrouter1(config-router)# network 192.168.81.0/24 area 0\n```\n\n\n\n\n+ router2\n\n```\n$ sudo systemd-nspawn -bD router2 --capability=all --network-interface=r2-to-r1 --network-interface=r2-to-ns2\n\n$ ip link set dev r2-to-r1 up\n$ ip link set dev r2-to-ns2 up\n\n$ ip addr add 172.16.80.2/24 dev r2-to-r1\n$ ip addr add 192.168.82.1/24 dev r2-to-ns2\n\n\n$ vtysh\n\nrouter1# conf t\nrouter1(config)# router ospf\nrouter1(config-router)# network 172.16.80.0/24 area 0\nrouter1(config-router)# network 192.168.82.0/24 area 0\n```\n\n\n## \u624b\u98066 \u758e\u901a\u78ba\u8a8d\n\n```\nip netns exec r1 /bin/bash\n\nping 192.168.82.2\n\nPING 192.168.82.2 (192.168.82.2) 56(84) bytes of data.\n64 bytes from 192.168.82.2: icmp_seq=1 ttl=62 time=0.059 ms\n64 bytes from 192.168.82.2: icmp_seq=2 ttl=62 time=0.060 ms\n64 bytes from 192.168.82.2: icmp_seq=3 ttl=62 time=0.073 ms\n\n--- 192.168.82.2 ping statistics ---\n3 packets transmitted, 3 received, 0% packet loss, time 2022ms\nrtt min/avg/max/mdev = 0.059/0.064/0.073/0.006 ms\n\n\n```\n\n\n\n## \u307e\u3068\u3081\n`systemd-nspawn` + `quagga` \u306a\u3069\u3092\u5229\u7528\u3059\u308b\u3053\u3068\u3067\u3001\u7c21\u5358\u306a\u4eee\u60f3\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u74b0\u5883\u3092\u69cb\u7bc9\u3057\u307e\u3057\u305f\u3002\n\u4eca\u5f8c\u306f\u3001kvm \u3084 ovs \u306e\u63a5\u7d9a\u306a\u3069\u3092\u3084\u3063\u3066\u307f\u3088\u3046\u3068\u601d\u3044\u307e\u3059\u3002\n", "tags": ["systemd-nspawn", "quagga", "netns", "archLinux"]}