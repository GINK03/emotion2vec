{"context": " More than 1 year has passed since last update.\n\n1. \u5fc5\u8981\u306agem\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\ngem 'devise'\ngem 'omniauth'\ngem 'omniauth-google-oauth2'\n\n\n\u30bf\u30fc\u30df\u30ca\u30eb\n$ bundle install\n$ rails g devise:install\n$ rails g devise user\n\n\n\n2. devise\u304c\u4f5c\u6210\u3057\u305fUser\u30e2\u30c7\u30eb\u306bOmniAuth\u306b\u5fc5\u8981\u306a\u30ab\u30e9\u30e0\u3092\u8ffd\u52a0\n\n\u30bf\u30fc\u30df\u30ca\u30eb\n$ rails g migration add_omniauth_to_users\n\n\n\ndb/migrate/add_omniauth_to_users.rb\nclass AddOmniauthToUsers < ActiveRecord::Migration\n  def change\n    add_column :users, :provider, :string\n    add_column :users, :uid, :string\n    add_column :users, :name, :string\n    add_column :users, :token, :string\n  end\nend\n\n\n\n\u30bf\u30fc\u30df\u30ca\u30eb\n$ rake db:migrate\n\n\n\n3. devise\u3067OmniAuth\u3092\u6709\u52b9\u306b\u3059\u308b\ndevise\u30e1\u30bd\u30c3\u30c9\u306b:omniauthable\u3092\u8ffd\u52a0\n\napp/models/user.rb\nclass User < ActiveRecord::Base\n  # Include default devise modules. Others available are:\n  # :confirmable, :lockable, and :timeoutable\n  devise :database_authenticatable, :registerable,\n         :recoverable, :rememberable, :trackable, :validatable, :omniauthable\nend\n\n\n\n4. \u4efb\u610f\u306e\u30da\u30fc\u30b8\u306b\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u305f\u3081\u306e\u30ea\u30f3\u30af\u3092\u8cbc\u308b\n\napplication.html/erb\n<%= link_to 'Signin with Google', user_omniauth_authorize_path(:google_oauth2) %>\n\n\n\n5. ClientID\u306e\u53d6\u5f97\nGoogle\u306b\u3066\u30af\u30e9\u30a4\u30a2\u30f3\u30c8ID\u3092\u53d6\u5f97\u3059\u308b\nhttps://console.developers.google.com/project\n\u4e0a\u8a18URL\u3088\u308a\n\u2460\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u4f5c\u6210\n\u2461\u300eContacts API\u300f\u300eGoogle+ API\u300f\u306e\uff12\u3064\u3092ON\u306b\u3059\u308b\n\u2462\u8a8d\u8a3c\u60c5\u5831\u3092\u8ffd\u52a0\u3059\u308b\n\u2463\u8a8d\u8a3c\u6e08\u307f\u306ejavascript\u751f\u6210\u5143\u306b\u4ee5\u4e0b\u3092\u5165\u529b(\u672c\u756a\u74b0\u5883\u306f\u5225)\nhttps://localhost:3000\n\u2464\u8a8d\u8a3c\u6e08\u307f\u306e\u30ea\u30c0\u30a4\u30ec\u30af\u30c8URL\u306b\u4ee5\u4e0b\u3092\u5165\u529b(\u672c\u756a\u74b0\u5883\u306f\u5225)\nhttp://localhost:3000/users/auth/google_oauth2/callback\n\u2465\u300eClient ID\u300f\u3068\u300eClient Secret\u300f\u3092\u30b3\u30d4\u30fc\u3059\u308b\n\u2466config/secrets.yml\u306b\u8cbc\u308a\u4ed8\u3051\u308b\n\nconfig/secrets.yml\ndevelopment:\n  secret_key_base: XXXXXXXXXXXXXXXXX\n  google_client_id: \u53d6\u5f97\u3057\u305f Client ID\n  google_client_secret: \u53d6\u5f97\u3057\u305f Client Secret\n\n\n\u2467config/initializers/devise.rb\u3092\u7de8\u96c6\u3059\u308b\n\nconfig/initializers/devise.rb\nconfig.omniauth :google_oauth2,\n                  Rails.application.secrets.google_client_id,\n                  Rails.application.secrets.google_client_secret\n\n\n\n6. Rails\u5074\u306e\u5b9f\u88c5\n\n\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3092\u5b9a\u7fa9\n\nconfig/routes.rb\ndevise_for :users, controllers: {\n    omniauth_callbacks: \"users/omniauth_callbacks\"\n}\n\n\n\n\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3067\u547c\u3073\u51fa\u3055\u308c\u308b\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u3092\u5b9a\u7fa9\napp/controllers/users \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3057\u3001\u305d\u306e\u4e2d\u306b omniauth_callbacks_controller.rb \u3068\u3044\u3046\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u3092\u4f5c\u6210\n\napp/controllers/users/omniauth_callbacks_controller.rb\nclass Users::OmniauthCallbacksController < Devise::OmniauthCallbacksController\n  def google_oauth2\n    @user = User.find_for_google_oauth2(request.env[\"omniauth.auth\"])\n\n    # \u4fdd\u5b58\u6e08\u307f\u304b\u3069\u3046\u304b\u306e\u30c1\u30a7\u30c3\u30af\n    if @user.persisted?\n      flash[:notice] = I18n.t \"devise.omniauth_callbacks.success\", :kind => \"Google\"\n      sign_in_and_redirect @user, :event => :authentication\n    else\n      session[\"devise.google_data\"] = request.env[\"omniauth.auth\"]\n      redirect_to new_user_registration_url\n    end\n  end\nend\n\n\n\nUser\u30e2\u30c7\u30eb\u306efind_for_google_oauth2\u30e1\u30bd\u30c3\u30c9\u3092\u5b9a\u7fa9\n\napp/models/user.rb\ndef self.find_for_google_oauth2(auth)\n    user = User.where(email: auth.info.email).first\n\n    unless user\n      user = User.create(name:     auth.info.name,\n                         provider: auth.provider,\n                         uid:      auth.uid,\n                         email:    auth.info.email,\n                         token:    auth.credentials.token,\n                         password: Devise.friendly_token[0, 20])\n    end\n    user\n  end\n\n\n\n\u53c2\u7167\nhttp://www.ohmyenter.com/?p=668\n\n##1. \u5fc5\u8981\u306agem\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```Gemfile\ngem 'devise'\ngem 'omniauth'\ngem 'omniauth-google-oauth2'\n```\n\n```bash:\u30bf\u30fc\u30df\u30ca\u30eb\n$ bundle install\n$ rails g devise:install\n$ rails g devise user\n```\n\n##2. devise\u304c\u4f5c\u6210\u3057\u305fUser\u30e2\u30c7\u30eb\u306bOmniAuth\u306b\u5fc5\u8981\u306a\u30ab\u30e9\u30e0\u3092\u8ffd\u52a0\n\n```bash:\u30bf\u30fc\u30df\u30ca\u30eb\n$ rails g migration add_omniauth_to_users\n```\n\n```ruby:db/migrate/add_omniauth_to_users.rb\nclass AddOmniauthToUsers < ActiveRecord::Migration\n  def change\n    add_column :users, :provider, :string\n    add_column :users, :uid, :string\n    add_column :users, :name, :string\n    add_column :users, :token, :string\n  end\nend\n```\n\n```bash:\u30bf\u30fc\u30df\u30ca\u30eb\n$ rake db:migrate\n```\n\n##3. devise\u3067OmniAuth\u3092\u6709\u52b9\u306b\u3059\u308b\ndevise\u30e1\u30bd\u30c3\u30c9\u306b:omniauthable\u3092\u8ffd\u52a0\n\n```ruby:app/models/user.rb\nclass User < ActiveRecord::Base\n  # Include default devise modules. Others available are:\n  # :confirmable, :lockable, and :timeoutable\n  devise :database_authenticatable, :registerable,\n         :recoverable, :rememberable, :trackable, :validatable, :omniauthable\nend\n```\n\n##4. \u4efb\u610f\u306e\u30da\u30fc\u30b8\u306b\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u305f\u3081\u306e\u30ea\u30f3\u30af\u3092\u8cbc\u308b\n\n```html:application.html/erb\n<%= link_to 'Signin with Google', user_omniauth_authorize_path(:google_oauth2) %>\n```\n\n##5. ClientID\u306e\u53d6\u5f97\n\nGoogle\u306b\u3066\u30af\u30e9\u30a4\u30a2\u30f3\u30c8ID\u3092\u53d6\u5f97\u3059\u308b\nhttps://console.developers.google.com/project\n\n\u4e0a\u8a18URL\u3088\u308a\n\u2460\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u4f5c\u6210\n\u2461\u300eContacts API\u300f\u300eGoogle+ API\u300f\u306e\uff12\u3064\u3092ON\u306b\u3059\u308b\n\u2462\u8a8d\u8a3c\u60c5\u5831\u3092\u8ffd\u52a0\u3059\u308b\n\u2463\u8a8d\u8a3c\u6e08\u307f\u306ejavascript\u751f\u6210\u5143\u306b\u4ee5\u4e0b\u3092\u5165\u529b(\u672c\u756a\u74b0\u5883\u306f\u5225)\nhttps://localhost:3000\n\u2464\u8a8d\u8a3c\u6e08\u307f\u306e\u30ea\u30c0\u30a4\u30ec\u30af\u30c8URL\u306b\u4ee5\u4e0b\u3092\u5165\u529b(\u672c\u756a\u74b0\u5883\u306f\u5225)\nhttp://localhost:3000/users/auth/google_oauth2/callback\n\u2465\u300eClient ID\u300f\u3068\u300eClient Secret\u300f\u3092\u30b3\u30d4\u30fc\u3059\u308b\n\u2466config/secrets.yml\u306b\u8cbc\u308a\u4ed8\u3051\u308b\n\n```yml:config/secrets.yml\ndevelopment:\n  secret_key_base: XXXXXXXXXXXXXXXXX\n  google_client_id: \u53d6\u5f97\u3057\u305f Client ID\n  google_client_secret: \u53d6\u5f97\u3057\u305f Client Secret\n```\n\n\u2467config/initializers/devise.rb\u3092\u7de8\u96c6\u3059\u308b\n\n```ruby:config/initializers/devise.rb\nconfig.omniauth :google_oauth2,\n                  Rails.application.secrets.google_client_id,\n                  Rails.application.secrets.google_client_secret\n```\n\n##6. Rails\u5074\u306e\u5b9f\u88c5\n\n###\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3092\u5b9a\u7fa9\n\n```ruby:config/routes.rb\ndevise_for :users, controllers: {\n    omniauth_callbacks: \"users/omniauth_callbacks\"\n}\n```\n\n###\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3067\u547c\u3073\u51fa\u3055\u308c\u308b\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u3092\u5b9a\u7fa9\n\napp/controllers/users \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3057\u3001\u305d\u306e\u4e2d\u306b omniauth_callbacks_controller.rb \u3068\u3044\u3046\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u3092\u4f5c\u6210\n\n```ruby:app/controllers/users/omniauth_callbacks_controller.rb\nclass Users::OmniauthCallbacksController < Devise::OmniauthCallbacksController\n  def google_oauth2\n    @user = User.find_for_google_oauth2(request.env[\"omniauth.auth\"])\n \n    # \u4fdd\u5b58\u6e08\u307f\u304b\u3069\u3046\u304b\u306e\u30c1\u30a7\u30c3\u30af\n    if @user.persisted?\n      flash[:notice] = I18n.t \"devise.omniauth_callbacks.success\", :kind => \"Google\"\n      sign_in_and_redirect @user, :event => :authentication\n    else\n      session[\"devise.google_data\"] = request.env[\"omniauth.auth\"]\n      redirect_to new_user_registration_url\n    end\n  end\nend\n```\n\n###User\u30e2\u30c7\u30eb\u306efind_for_google_oauth2\u30e1\u30bd\u30c3\u30c9\u3092\u5b9a\u7fa9\n\n```ruby:app/models/user.rb\ndef self.find_for_google_oauth2(auth)\n    user = User.where(email: auth.info.email).first\n \n    unless user\n      user = User.create(name:     auth.info.name,\n                         provider: auth.provider,\n                         uid:      auth.uid,\n                         email:    auth.info.email,\n                         token:    auth.credentials.token,\n                         password: Devise.friendly_token[0, 20])\n    end\n    user\n  end\n```\n\n##\u53c2\u7167\nhttp://www.ohmyenter.com/?p=668\n", "tags": ["omniauth-google-oauth", "Rails", "OmniAuth", "devise"]}