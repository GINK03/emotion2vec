{"tags": ["proxmox", "ZFS"], "context": "\n\n\u306f\u3058\u3081\u306b\nProxmox VE\u306fZFS\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3067\u304d\u307e\u3059\u304c\u3001\u30b7\u30b9\u30c6\u30e0\u3092\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3057\u3088\u3046\u3068\u3059\u308b\u3068ZFS\u30b9\u30c8\u30ec\u30fc\u30b8\u30d7\u30fc\u30eb(zpool)\u306e\u540d\u524d\u304c\u885d\u7a81\u3057\u3066\u3057\u307e\u3044\u307e\u3059\u3002GRUB\u3092\u3082\u3046\u4e00\u3064\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308c\u3070\u3044\u3044\u306f\u305a\u3067\u3059\u304c\u3001\u3053\u306e\u969bgummiboot\u3068\u3044\u3046UEFI\u7528\u306e\u30b7\u30f3\u30d7\u30eb\u306a\u30d6\u30fc\u30c8\u30ed\u30fc\u30c0\u30fc\u3092\u4f7f\u3063\u3066\u307f\u307e\u3059\u3002\n\ngummiboot\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n\u65b0\u3057\u3044USB\u30e1\u30e2\u30ea\u30fc\u3092\u4e00\u3064\u7528\u610f\u3057\u3066\u305d\u3053\u306b\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\nEFI System partition\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u4f5c\u6210\ndev='/dev/<sdX>' &&\nsgdisk -Z $dev && #\u65e2\u5b58\u306eGPT\u3068MBR\u3092\u6d88\u53bb\nsgdisk -o $dev && #GPT\uff08\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30c6\u30fc\u30d6\u30eb\uff09\u3092\u4f5c\u6210\nsgdisk -n 1::+512M -t 1:ef00 $dev && #\u7b2c1\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306bEFI System partition\u3092\u4f5c\u6210\nsgdisk -p $dev && #GPT\u3092\u78ba\u8a8d\nsgdisk -i 1 $dev #\u7b2c1\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u78ba\u8a8d\n\n\n\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\ndev='/dev/<sdX>' &&\nmkfs.vfat -F32 \"${dev}1\"\n\n\ngummiboot\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\napt-get install gummiboot\n\n\n\u30d6\u30fc\u30c8\u30ed\u30fc\u30c0\u30fc\u3092\u4f5c\u6210\ndev='/dev/<sdX>' &&\nesp='/mnt/boot' &&\nmkdir $esp &&\nmount \"${dev}1\" $esp &&\ngummiboot install --path $esp &&\ncp '/boot/initrd.img-4.4.6-1-pve' \"$esp/initrd.img-4.4.6-1-pve\" &&\ncp '/boot/vmlinuz-4.4.6-1-pve' \"$esp/vmlinuz-4.4.6-1-pve\"\n\n\n\u30d6\u30fc\u30c8\u30ed\u30fc\u30c0\u30fc\u3092\u8a2d\u5b9a\n\n$esp/loader/loader.conf\u3092\u4f5c\u6210\ndefault pve\ntimeout 5\neditor 0\n\n\n$esp/loader/entries/pve.conf\u3092\u4f5c\u6210\ntitle          Proxmox Virtual Environment\nlinux          /vmlinuz-4.4.6-1-pve\ninitrd         /initrd.img-4.4.6-1-pve\noptions        root=ZFS=rpool/ROOT/pve-1 rw boot=zfs quiet rootdelay=2\n\n\n\u30de\u30a6\u30f3\u30c8\u3092\u6052\u4e45\u5316\nvi /etc/fstab\n\n\u4e0b\u8a18\u306e\u884c\u3092\u8ffd\u52a0\nPARTUUID=<partuuid> $esp vfat defaults,noatime,nofail 0 2\n\n\n\u78ba\u8a8d\n\u3053\u308c\u3067\u65e2\u5b58\u306eProxmox VE\u3092gummiboot\u304b\u3089\u30d6\u30fc\u30c8\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u306f\u305a\u3067\u3059\u3002Proxmox VE\u3067\u306fZFS Root\u306e\u30d6\u30fc\u30c8\u306fBIOS\u30d6\u30fc\u30c8\u3057\u304b\u5bfe\u5fdc\u3057\u3066\u3044\u307e\u305b\u3093\u304c\u3001gummiboot\u306b\u3088\u3063\u3066UEFI\u30d6\u30fc\u30c8\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\nZFS Root\u3092\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\n\u3055\u304d\u307b\u3069\u306eUSB\u30e1\u30e2\u30ea\u30fc\u306b\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\nZFS\u7528\u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u4f5c\u6210\ndev='/dev/<sdX>' &&\nsgdisk -n 2:: -t 2:bf01 -c 2:'zfs' $dev && #\u7b2c2\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306bSolaris /usr & Mac ZFS\u3092\u4f5c\u6210\n\n\u3053\u306e\u5f8c\u3001\u518d\u8d77\u52d5\u304c\u5fc5\u8981\u306b\u306a\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\nZFS\u30b9\u30c8\u30ec\u30fc\u30b8\u30d7\u30fc\u30eb\u3092\u4f5c\u6210\nzpoolname1='rpool' &&\nzpoolname2='rpool2' &&\npartuuid='<partuuid>' &&\nzpool create -o ashift=12 $zpoolname2 \"/dev/disk/by-partuuid/$partuuid\" &&\nzfs set compression=lz4 $zpoolname2 &&\nzfs set atime=off $zpoolname2 &&\nzfs set sync=standard $zpoolname2\n\n\nZFS\u3092\u4f5c\u6210\nzpoolname2='rpool2' &&\nzfs create $zpoolname2/ROOT &&\nzfs create -V 1G -b 4K -o primarycache=metadata -o sync=always -o com.sun:auto-snapshot=false $zpoolname2/swap &&\n\n\u30b9\u30ef\u30c3\u30d7\u306f\u901a\u5e382GB\u306e\u3068\u3053\u308d1GB\u306b\u3057\u3066\u3042\u308a\u307e\u3059\u304c\u3001\u304a\u597d\u307f\u3067\u5909\u66f4\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\nZFS\u3092\u30b3\u30d4\u30fc\nzpoolname1='rpool' &&\nzpoolname2='rpool2' &&\nzfs snapshot $zpoolname1/ROOT/pve-1@temp &&\nzfs send     $zpoolname1/ROOT/pve-1@temp | zfs recv $zpoolname2/ROOT/pve-1 &&\nzfs destroy  $zpoolname1/ROOT/pve-1@temp &&\nzfs destroy  $zpoolname2/ROOT/pve-1@temp\n\n\nZFS\u306e\u30de\u30a6\u30f3\u30c8\u30dd\u30a4\u30f3\u30c8\u3092\u8a2d\u5b9a\nzpoolname2='rpool2' &&\nzpool export $zpoolname2 &&\nzpool import -d /dev/disk/by-partuuid -R /mnt/$zpoolname2 $zpoolname2 &&\nzfs set mountpoint=/ $zpoolname2/ROOT/pve-1 &&\nzfs set mountpoint=/$zpoolname2 $zpoolname2\n\n\n\u30b9\u30ef\u30c3\u30d7\u3092\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\nzpoolname2='rpool2' &&\nmkswap /dev/zvol/$zpoolname2/swap\n\n\n\u30b9\u30ef\u30c3\u30d7\u306e\u30d7\u30fc\u30eb\u540d\u3092\u4fee\u6b63\nvi /mnt/$zpoolname2/etc/fstab\n\n\u4e0b\u8a18\u306e\u884c\u3092$zpoolname1\u304b\u3089$zpoolname2\u306b\u4fee\u6b63\u3059\u308b\n/dev/zvol/$zpoolname2/swap none swap sw 0 0\n\n\n$esp/loader/entries/pve2.conf\u3092\u4f5c\u6210\ntitle          Proxmox Virtual Environment 2\nlinux          /vmlinuz-4.4.6-1-pve\ninitrd         /initrd.img-4.4.6-1-pve\noptions        root=ZFS=$zpoolname2/ROOT/pve-1 rw boot=zfs quiet rootdelay=2\n\n\u518d\u8d77\u52d5\u5f8c\u3001\u30d6\u30fc\u30c8\u6642\u306bProxmox Virtual Environment 2\u3092\u9078\u3079\u3070\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3057\u305f\u65b9\u304b\u3089\u30d6\u30fc\u30c8\u3059\u308b\u306f\u305a\u3067\u3059\u3002\n\n\u5f8c\u59cb\u672b\n\u3053\u306e\u5f8c\u3001gummiboot\u3092\u30a2\u30f3\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3001/etc/initramfs/post-update.d//zz-update-gummiboot\u3092\u624b\u52d5\u3067\u524a\u9664\u3057\u306a\u3044\u3068\u30ab\u30fc\u30cd\u30eb\u306e\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u306b\u652f\u969c\u3092\u6765\u3059\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n#\u306f\u3058\u3081\u306b\nProxmox VE\u306fZFS\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3067\u304d\u307e\u3059\u304c\u3001\u30b7\u30b9\u30c6\u30e0\u3092\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3057\u3088\u3046\u3068\u3059\u308b\u3068ZFS\u30b9\u30c8\u30ec\u30fc\u30b8\u30d7\u30fc\u30eb(zpool)\u306e\u540d\u524d\u304c\u885d\u7a81\u3057\u3066\u3057\u307e\u3044\u307e\u3059\u3002GRUB\u3092\u3082\u3046\u4e00\u3064\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308c\u3070\u3044\u3044\u306f\u305a\u3067\u3059\u304c\u3001\u3053\u306e\u969bgummiboot\u3068\u3044\u3046UEFI\u7528\u306e\u30b7\u30f3\u30d7\u30eb\u306a\u30d6\u30fc\u30c8\u30ed\u30fc\u30c0\u30fc\u3092\u4f7f\u3063\u3066\u307f\u307e\u3059\u3002\n\n#gummiboot\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n\u65b0\u3057\u3044USB\u30e1\u30e2\u30ea\u30fc\u3092\u4e00\u3064\u7528\u610f\u3057\u3066\u305d\u3053\u306b\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n##EFI System partition\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u4f5c\u6210\n```\ndev='/dev/<sdX>' &&\nsgdisk -Z $dev && #\u65e2\u5b58\u306eGPT\u3068MBR\u3092\u6d88\u53bb\nsgdisk -o $dev && #GPT\uff08\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30c6\u30fc\u30d6\u30eb\uff09\u3092\u4f5c\u6210\nsgdisk -n 1::+512M -t 1:ef00 $dev && #\u7b2c1\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306bEFI System partition\u3092\u4f5c\u6210\nsgdisk -p $dev && #GPT\u3092\u78ba\u8a8d\nsgdisk -i 1 $dev #\u7b2c1\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u78ba\u8a8d\n```\n\n##\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\n```\ndev='/dev/<sdX>' &&\nmkfs.vfat -F32 \"${dev}1\"\n```\n\n##gummiboot\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n```\napt-get install gummiboot\n```\n\n##\u30d6\u30fc\u30c8\u30ed\u30fc\u30c0\u30fc\u3092\u4f5c\u6210\n```\ndev='/dev/<sdX>' &&\nesp='/mnt/boot' &&\nmkdir $esp &&\nmount \"${dev}1\" $esp &&\ngummiboot install --path $esp &&\ncp '/boot/initrd.img-4.4.6-1-pve' \"$esp/initrd.img-4.4.6-1-pve\" &&\ncp '/boot/vmlinuz-4.4.6-1-pve' \"$esp/vmlinuz-4.4.6-1-pve\"\n```\n\n##\u30d6\u30fc\u30c8\u30ed\u30fc\u30c0\u30fc\u3092\u8a2d\u5b9a\n###$esp/loader/loader.conf\u3092\u4f5c\u6210\n```\ndefault pve\ntimeout 5\neditor 0\n```\n\n###$esp/loader/entries/pve.conf\u3092\u4f5c\u6210\n```\ntitle          Proxmox Virtual Environment\nlinux          /vmlinuz-4.4.6-1-pve\ninitrd         /initrd.img-4.4.6-1-pve\noptions        root=ZFS=rpool/ROOT/pve-1 rw boot=zfs quiet rootdelay=2\n```\n\n##\u30de\u30a6\u30f3\u30c8\u3092\u6052\u4e45\u5316\n```\nvi /etc/fstab\n\n\u4e0b\u8a18\u306e\u884c\u3092\u8ffd\u52a0\nPARTUUID=<partuuid> $esp vfat defaults,noatime,nofail 0 2\n```\n\n##\u78ba\u8a8d\n\u3053\u308c\u3067\u65e2\u5b58\u306eProxmox VE\u3092gummiboot\u304b\u3089\u30d6\u30fc\u30c8\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u306f\u305a\u3067\u3059\u3002Proxmox VE\u3067\u306fZFS Root\u306e\u30d6\u30fc\u30c8\u306fBIOS\u30d6\u30fc\u30c8\u3057\u304b\u5bfe\u5fdc\u3057\u3066\u3044\u307e\u305b\u3093\u304c\u3001gummiboot\u306b\u3088\u3063\u3066UEFI\u30d6\u30fc\u30c8\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n#ZFS Root\u3092\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\n\u3055\u304d\u307b\u3069\u306eUSB\u30e1\u30e2\u30ea\u30fc\u306b\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n##ZFS\u7528\u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u4f5c\u6210\n```\ndev='/dev/<sdX>' &&\nsgdisk -n 2:: -t 2:bf01 -c 2:'zfs' $dev && #\u7b2c2\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306bSolaris /usr & Mac ZFS\u3092\u4f5c\u6210\n```\n\u3053\u306e\u5f8c\u3001\u518d\u8d77\u52d5\u304c\u5fc5\u8981\u306b\u306a\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\n##ZFS\u30b9\u30c8\u30ec\u30fc\u30b8\u30d7\u30fc\u30eb\u3092\u4f5c\u6210\n```\nzpoolname1='rpool' &&\nzpoolname2='rpool2' &&\npartuuid='<partuuid>' &&\nzpool create -o ashift=12 $zpoolname2 \"/dev/disk/by-partuuid/$partuuid\" &&\nzfs set compression=lz4 $zpoolname2 &&\nzfs set atime=off $zpoolname2 &&\nzfs set sync=standard $zpoolname2\n```\n\n##ZFS\u3092\u4f5c\u6210\n```\nzpoolname2='rpool2' &&\nzfs create $zpoolname2/ROOT &&\nzfs create -V 1G -b 4K -o primarycache=metadata -o sync=always -o com.sun:auto-snapshot=false $zpoolname2/swap &&\n```\n\u30b9\u30ef\u30c3\u30d7\u306f\u901a\u5e382GB\u306e\u3068\u3053\u308d1GB\u306b\u3057\u3066\u3042\u308a\u307e\u3059\u304c\u3001\u304a\u597d\u307f\u3067\u5909\u66f4\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n##ZFS\u3092\u30b3\u30d4\u30fc\n```\nzpoolname1='rpool' &&\nzpoolname2='rpool2' &&\nzfs snapshot $zpoolname1/ROOT/pve-1@temp &&\nzfs send     $zpoolname1/ROOT/pve-1@temp | zfs recv $zpoolname2/ROOT/pve-1 &&\nzfs destroy  $zpoolname1/ROOT/pve-1@temp &&\nzfs destroy  $zpoolname2/ROOT/pve-1@temp\n```\n\n##ZFS\u306e\u30de\u30a6\u30f3\u30c8\u30dd\u30a4\u30f3\u30c8\u3092\u8a2d\u5b9a\n```\nzpoolname2='rpool2' &&\nzpool export $zpoolname2 &&\nzpool import -d /dev/disk/by-partuuid -R /mnt/$zpoolname2 $zpoolname2 &&\nzfs set mountpoint=/ $zpoolname2/ROOT/pve-1 &&\nzfs set mountpoint=/$zpoolname2 $zpoolname2\n```\n\n##\u30b9\u30ef\u30c3\u30d7\u3092\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\n```\nzpoolname2='rpool2' &&\nmkswap /dev/zvol/$zpoolname2/swap\n```\n\n##\u30b9\u30ef\u30c3\u30d7\u306e\u30d7\u30fc\u30eb\u540d\u3092\u4fee\u6b63\n```\nvi /mnt/$zpoolname2/etc/fstab\n\n\u4e0b\u8a18\u306e\u884c\u3092$zpoolname1\u304b\u3089$zpoolname2\u306b\u4fee\u6b63\u3059\u308b\n/dev/zvol/$zpoolname2/swap none swap sw 0 0\n```\n\n###$esp/loader/entries/pve2.conf\u3092\u4f5c\u6210\n```\ntitle          Proxmox Virtual Environment 2\nlinux          /vmlinuz-4.4.6-1-pve\ninitrd         /initrd.img-4.4.6-1-pve\noptions        root=ZFS=$zpoolname2/ROOT/pve-1 rw boot=zfs quiet rootdelay=2\n```\n\u518d\u8d77\u52d5\u5f8c\u3001\u30d6\u30fc\u30c8\u6642\u306bProxmox Virtual Environment 2\u3092\u9078\u3079\u3070\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3057\u305f\u65b9\u304b\u3089\u30d6\u30fc\u30c8\u3059\u308b\u306f\u305a\u3067\u3059\u3002\n\n#\u5f8c\u59cb\u672b\n\u3053\u306e\u5f8c\u3001gummiboot\u3092\u30a2\u30f3\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3001/etc/initramfs/post-update.d//zz-update-gummiboot\u3092\u624b\u52d5\u3067\u524a\u9664\u3057\u306a\u3044\u3068\u30ab\u30fc\u30cd\u30eb\u306e\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u306b\u652f\u969c\u3092\u6765\u3059\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n"}