{"context": " More than 1 year has passed since last update.\n\ngit diff --stat \u306e\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u304b\u3089\u30d5\u30a1\u30a4\u30eb\u4e00\u89a7\u3092\u5f97\u308b\n$ git diff --stat=256 origin/master..HEAD\n test/lib/populus/test_configuration.rb | 36 ++++++++++++++++++++++++++++++++++++\n test/lib/test_populus.rb               |  7 +++++++\n 2 files changed, 43 insertions(+)\n\ngit diff --stat \u306e\u30d5\u30a3\u30fc\u30eb\u30c9\u306f\u3001\u7a7a\u767d\u3067\u5206\u5272\u3059\u308b\u3068\uff11\u756a\u76ee\u304c\u30d5\u30a1\u30a4\u30eb\u30d1\u30b9\u3001\uff14\u756a\u76ee\u304c\u8ffd\u52a0\u524a\u9664\u306e\u69d8\u5b50\u3001\u306b\u306a\u308b\u306e\u3067\u305d\u308c\u3092\u5229\u7528\u3067\u304d\u308b\u3002\n\u9577\u3044\u30d5\u30a1\u30a4\u30eb\u540d\u3060\u3068truncate\u3055\u308c\u308b\u306e\u3067 --stat=256 \u307f\u305f\u3044\u306b\u6a2a\u5e45\u3092\u660e\u793a\u3059\u308b\u3068\u826f\u3055\u305d\u3046\u3002\n# origin/master..${current SHA1} \u307f\u305f\u3044\u306a\u306e\u3092\u6e21\u3059\n@range = ARGV[0]\ndata = `git diff --stat=256 --no-color #{@range}`\nrolenames = data.lines\n  .map {|l| l.strip.split(/\\s+/) }\n  .select {|r| r[3].include? '+' }\n  .map {|r| detect_foobar_from_filename(r[0]) }\n  .compact\n  .flatten\n\ndetect_foobar_from_filename \u3067\u3001\u4f8b\u3048\u3070\u30d5\u30a1\u30a4\u30eb\u540d\u304b\u3089Puppet\u3084Chef\u306e\u30ed\u30fc\u30eb\u3092\u691c\u51fa\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u305d\u3046\u3002\u624b\u5143\u3067\u306f\u3001\u30ed\u30fc\u30eb\u3092\u5c0e\u51fa\u3057\u3066\u6700\u5f8c\u306b\u8a08\u7b97\u3057\u3066git diff\u304b\u3089\u4e00\u756a\u5f71\u97ff\u3092\u4e0e\u3048\u308b\u30ed\u30fc\u30eb\u3092\u691c\u51fa\u3057\u3001\u305d\u306e\u30ed\u30fc\u30eb\u3060\u3051\u30c6\u30b9\u30c8\u3059\u308b\u307f\u305f\u3044\u306a\u3053\u3068\u3092\u3084\u3063\u305f\u3002\n\n\u30d1\u30c3\u30da\u30c3\u30c8\u4e8b\u4f8b\u306e\u3054\u7d39\u4ecb\n\u4ee5\u4e0b\u3001\u601d\u3044\u3063\u304d\u308aPuppet\u306e\u4e8b\u4f8b\u3060\u304c\u3001\u307f\u3093\u306a Puppet \u4f7f\u3063\u3066\u308b\u3068\u601d\u3046\u3057\u3001\u3042\u3068\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u69cb\u6210\u306f \u540d\u8457 \u306e\u69cb\u6210\u3092\u524d\u63d0\u306b\u3057\u305f\u3082\u306e\u3068\u3057\u3066\u3044\u308b\u306e\u3067\u305d\u306e\u307e\u307e\u4f7f\u3048\u308b\u3068\u601d\u3046\u3002\u3048\u3001\u3042\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u69cb\u6210\u3092\u5b88\u3063\u3066\u306a\u3044\u3093\u3067\u3059\u304b......\u3002\n@range = ARGV[0]\ndata = `git diff --stat=256 --no-color #{@range}`\n\ndetect_role_from_filename = lambda {|filename|\n  case filename\n  when %r<^roles/([_a-z]+)/.*$>\n    # \u30ed\u30fc\u30eb\u306e\u30de\u30cb\u30d5\u30a7\u30b9\u30c8\u76f4\u63a5\u5909\u66f4\u306e\u5834\u5408\u306f10\u30dd\u30a4\u30f3\u30c8\n    [$1] * 10\n  when %r<^spec/([_a-z]+)/.*\\.rb$>\n    # \u95a2\u9023\u3059\u308bspec\u306e\u5909\u66f4\u306e\u5834\u5408\u306f5\u30dd\u30a4\u30f3\u30c8\n    # \u3053\u306e\u8fba\u306e\u50be\u659c\u306f\u5f90\u3005\u306b\u8abf\u6574\u3059\u308b\u3068\u3044\u3044\u306e\u3067\u306f\n    if $1 != 'support' # serverspec\u30b5\u30dd\u30fc\u30c8\u7528\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u9664\u5916\u3059\u308b\n      [$1] * 5\n    else\n      nil\n    end\n  when %r<^modules/([_a-z]+)/.*>\n    # \u305d\u306e\u307b\u304b\u3001\u666e\u901a\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u306f\n    # \u5f71\u97ff\u5ea6\u3092\u96d1\u306b\u8a08\u7b97\u3057\u3066\u3044\u308b\n    `git grep 'include ::#{$1}' roles/`\n      .lines\n      .map{|l| l.split('/')[1] }\n      .uniq\n  else\n    nil # detection failed\n  end\n}\n\nrolenames = data.lines\n  .map {|l| l.strip.split(/\\s+/) }\n  # \u30d5\u30a1\u30a4\u30eb\u524a\u9664\u306e\u5834\u5408\u306f\u7121\u8996\n  .select {|r| r[3].include? '+' }\n  .map {|r| detect_role_from_filename.(r[0]) }\n  .compact\n  .flatten\n\n# group_by \u307f\u305f\u3044\u306a\u3093\u3092\u81ea\u5206\u3067\u3084\u3063\u3066\u308b...\nstats = rolenames.inject({}) { |dst, record|\n  dst[record] ||= 0\n  dst[record] += 1\n  dst\n}\n\n$stderr.puts \"Summary: #{stats.inspect}\"\n\n# TODO: \u540c\u7387\u306e\u5834\u5408\u8f9e\u66f8\u9806...\ndetected = stats.max_by{|(k, v)| v }\n\nif detected\n  $stderr.puts \"Detected: role #{detected.inspect}\"\n  puts detected[0]\nelse\n  $stderr.puts \"No role detected. Fall back to testing against <base>\"\n  puts 'base'\nend\n\n# \u304a\u3057\u307e\u3044\nexit\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3001stdout\u306b\u6700\u7d42\u7684\u306b www \u307f\u305f\u3044\u306a\u30ed\u30fc\u30eb\u3092\u5410\u304d\u51fa\u3059\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u3066\u3001\u30b7\u30a7\u30eb\u30b9\u30af\u30ea\u30d7\u30c8\u5185\u90e8\u3067\u5909\u6570\u306b\u30a2\u30b5\u30a4\u30f3\u3067\u304d\u308b\u3002\n$ role=$( script/get_role_by_change.rb origin/master..a123bc45 )\n=> stderr: Summary: {\"www\"=>5, \"log\"=>3}\n=> stderr: Detected: role [\"www\", 5]\n=> `www' is assigned to $role\n\n\u95a2\u4fc2\u306a\u3044\u3068\u3053\u3092\u30c6\u30b9\u30c8\u3057\u3066\u53ad\u3063\u307d\u3044\u3068\u304b\u6642\u9593\u304b\u304b\u308a\u3059\u304e\u308b\u3068\u304b\u3001\u3088\u304f\u3042\u308b\u3068\u601d\u3046\u306e\u3067\u3001\u3053\u3046\u3044\u3046\u30cf\u30c3\u30af\u3092\u3057\u3066\u4e57\u308a\u5207\u308b\u306e\u3082\u4e00\u8208\u3060\u3068\u601d\u3046\u3002\n## `git diff --stat` \u306e\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u304b\u3089\u30d5\u30a1\u30a4\u30eb\u4e00\u89a7\u3092\u5f97\u308b\n\n```console\n$ git diff --stat=256 origin/master..HEAD\n test/lib/populus/test_configuration.rb | 36 ++++++++++++++++++++++++++++++++++++\n test/lib/test_populus.rb               |  7 +++++++\n 2 files changed, 43 insertions(+)\n```\n\n`git diff --stat` \u306e\u30d5\u30a3\u30fc\u30eb\u30c9\u306f\u3001\u7a7a\u767d\u3067\u5206\u5272\u3059\u308b\u3068\uff11\u756a\u76ee\u304c\u30d5\u30a1\u30a4\u30eb\u30d1\u30b9\u3001\uff14\u756a\u76ee\u304c\u8ffd\u52a0\u524a\u9664\u306e\u69d8\u5b50\u3001\u306b\u306a\u308b\u306e\u3067\u305d\u308c\u3092\u5229\u7528\u3067\u304d\u308b\u3002\n\n\u9577\u3044\u30d5\u30a1\u30a4\u30eb\u540d\u3060\u3068truncate\u3055\u308c\u308b\u306e\u3067 `--stat=256` \u307f\u305f\u3044\u306b\u6a2a\u5e45\u3092\u660e\u793a\u3059\u308b\u3068\u826f\u3055\u305d\u3046\u3002\n\n```ruby\n# origin/master..${current SHA1} \u307f\u305f\u3044\u306a\u306e\u3092\u6e21\u3059\n@range = ARGV[0]\ndata = `git diff --stat=256 --no-color #{@range}`\nrolenames = data.lines\n  .map {|l| l.strip.split(/\\s+/) }\n  .select {|r| r[3].include? '+' }\n  .map {|r| detect_foobar_from_filename(r[0]) }\n  .compact\n  .flatten\n```\n\n`detect_foobar_from_filename` \u3067\u3001\u4f8b\u3048\u3070\u30d5\u30a1\u30a4\u30eb\u540d\u304b\u3089Puppet\u3084Chef\u306e\u30ed\u30fc\u30eb\u3092\u691c\u51fa\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u305d\u3046\u3002\u624b\u5143\u3067\u306f\u3001\u30ed\u30fc\u30eb\u3092\u5c0e\u51fa\u3057\u3066\u6700\u5f8c\u306b\u8a08\u7b97\u3057\u3066git diff\u304b\u3089\u4e00\u756a\u5f71\u97ff\u3092\u4e0e\u3048\u308b\u30ed\u30fc\u30eb\u3092\u691c\u51fa\u3057\u3001\u305d\u306e\u30ed\u30fc\u30eb\u3060\u3051\u30c6\u30b9\u30c8\u3059\u308b\u307f\u305f\u3044\u306a\u3053\u3068\u3092\u3084\u3063\u305f\u3002\n\n### \u30d1\u30c3\u30da\u30c3\u30c8\u4e8b\u4f8b\u306e\u3054\u7d39\u4ecb\n\n\u4ee5\u4e0b\u3001\u601d\u3044\u3063\u304d\u308aPuppet\u306e\u4e8b\u4f8b\u3060\u304c\u3001\u307f\u3093\u306a Puppet \u4f7f\u3063\u3066\u308b\u3068\u601d\u3046\u3057\u3001\u3042\u3068\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u69cb\u6210\u306f [\u540d\u8457](http://www.amazon.co.jp/%E5%85%A5%E9%96%80Puppet-Automate-Your-Infrastructure-%E6%A0%97%E6%9E%97%E5%81%A5%E5%A4%AA%E9%83%8E-ebook/dp/B00CL92JC0) \u306e\u69cb\u6210\u3092\u524d\u63d0\u306b\u3057\u305f\u3082\u306e\u3068\u3057\u3066\u3044\u308b\u306e\u3067\u305d\u306e\u307e\u307e\u4f7f\u3048\u308b\u3068\u601d\u3046\u3002\u3048\u3001\u3042\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u69cb\u6210\u3092\u5b88\u3063\u3066\u306a\u3044\u3093\u3067\u3059\u304b......\u3002\n\n```ruby\n@range = ARGV[0]\ndata = `git diff --stat=256 --no-color #{@range}`\n\ndetect_role_from_filename = lambda {|filename|\n  case filename\n  when %r<^roles/([_a-z]+)/.*$>\n    # \u30ed\u30fc\u30eb\u306e\u30de\u30cb\u30d5\u30a7\u30b9\u30c8\u76f4\u63a5\u5909\u66f4\u306e\u5834\u5408\u306f10\u30dd\u30a4\u30f3\u30c8\n    [$1] * 10\n  when %r<^spec/([_a-z]+)/.*\\.rb$>\n    # \u95a2\u9023\u3059\u308bspec\u306e\u5909\u66f4\u306e\u5834\u5408\u306f5\u30dd\u30a4\u30f3\u30c8\n    # \u3053\u306e\u8fba\u306e\u50be\u659c\u306f\u5f90\u3005\u306b\u8abf\u6574\u3059\u308b\u3068\u3044\u3044\u306e\u3067\u306f\n    if $1 != 'support' # serverspec\u30b5\u30dd\u30fc\u30c8\u7528\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u9664\u5916\u3059\u308b\n      [$1] * 5\n    else\n      nil\n    end\n  when %r<^modules/([_a-z]+)/.*>\n    # \u305d\u306e\u307b\u304b\u3001\u666e\u901a\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u306f\n    # \u5f71\u97ff\u5ea6\u3092\u96d1\u306b\u8a08\u7b97\u3057\u3066\u3044\u308b\n    `git grep 'include ::#{$1}' roles/`\n      .lines\n      .map{|l| l.split('/')[1] }\n      .uniq\n  else\n    nil # detection failed\n  end\n}\n\nrolenames = data.lines\n  .map {|l| l.strip.split(/\\s+/) }\n  # \u30d5\u30a1\u30a4\u30eb\u524a\u9664\u306e\u5834\u5408\u306f\u7121\u8996\n  .select {|r| r[3].include? '+' }\n  .map {|r| detect_role_from_filename.(r[0]) }\n  .compact\n  .flatten\n\n# group_by \u307f\u305f\u3044\u306a\u3093\u3092\u81ea\u5206\u3067\u3084\u3063\u3066\u308b...\nstats = rolenames.inject({}) { |dst, record|\n  dst[record] ||= 0\n  dst[record] += 1\n  dst\n}\n\n$stderr.puts \"Summary: #{stats.inspect}\"\n\n# TODO: \u540c\u7387\u306e\u5834\u5408\u8f9e\u66f8\u9806...\ndetected = stats.max_by{|(k, v)| v }\n\nif detected\n  $stderr.puts \"Detected: role #{detected.inspect}\"\n  puts detected[0]\nelse\n  $stderr.puts \"No role detected. Fall back to testing against <base>\"\n  puts 'base'\nend\n\n# \u304a\u3057\u307e\u3044\nexit\n```\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3001stdout\u306b\u6700\u7d42\u7684\u306b `www` \u307f\u305f\u3044\u306a\u30ed\u30fc\u30eb\u3092\u5410\u304d\u51fa\u3059\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u3066\u3001\u30b7\u30a7\u30eb\u30b9\u30af\u30ea\u30d7\u30c8\u5185\u90e8\u3067\u5909\u6570\u306b\u30a2\u30b5\u30a4\u30f3\u3067\u304d\u308b\u3002\n\n```console\n$ role=$( script/get_role_by_change.rb origin/master..a123bc45 )\n=> stderr: Summary: {\"www\"=>5, \"log\"=>3}\n=> stderr: Detected: role [\"www\", 5]\n=> `www' is assigned to $role\n```\n\n\u95a2\u4fc2\u306a\u3044\u3068\u3053\u3092\u30c6\u30b9\u30c8\u3057\u3066\u53ad\u3063\u307d\u3044\u3068\u304b\u6642\u9593\u304b\u304b\u308a\u3059\u304e\u308b\u3068\u304b\u3001\u3088\u304f\u3042\u308b\u3068\u601d\u3046\u306e\u3067\u3001\u3053\u3046\u3044\u3046\u30cf\u30c3\u30af\u3092\u3057\u3066\u4e57\u308a\u5207\u308b\u306e\u3082\u4e00\u8208\u3060\u3068\u601d\u3046\u3002\n", "tags": ["Ruby>=2", "Puppet>=3"]}