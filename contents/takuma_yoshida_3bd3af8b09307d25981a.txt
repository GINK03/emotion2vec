{"context": " More than 1 year has passed since last update.S3\u3068Lambda\u3068Cognito\u3092\u4f7f\u3063\u3066\u3001\u7c21\u5358\u3067\u30bb\u30ad\u30e5\u30a2\u306a\u304a\u554f\u3044\u5408\u308f\u305b\u30d5\u30a9\u30fc\u30e0\u30b7\u30b9\u30c6\u30e0\u3092\u4f5c\u3063\u3066\u307f\u307e\u3059\u3002\nCognito\u304c\u30d0\u30fc\u30b8\u30cb\u30a2/\u30a2\u30a4\u30eb\u30e9\u30f3\u30c9\u306e\u307f\u5229\u7528\u53ef\u80fd\u3067\u3059\u306e\u3067\u3001\u4eca\u56de\u306fS3/Lambda/Congito\u5168\u90e8\u30d0\u30fc\u30b8\u30cb\u30a2(us-east-1)\u306b\u63c3\u3048\u307e\u3059\uff08S3\u3068Lambda\u306f\u30ea\u30fc\u30b8\u30e7\u30f3\u63c3\u3048\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\uff09\n\n\u5168\u4f53\u50cf\nS3\u4e0a\u306b\u30db\u30b9\u30c6\u30a3\u30f3\u30b0\u3057\u3066\u3044\u308b\u304a\u554f\u3044\u5408\u308f\u305b\u30d5\u30a9\u30fc\u30e0\u304b\u3089\u6295\u7a3f\u3059\u308b\u3068\u3001S3\u4e0a\u306bJSON\u5f62\u5f0f\u3067\u5185\u5bb9\u304cupload\u3055\u308c\u307e\u3059\u3002\u30d5\u30a1\u30a4\u30eb\u304cupload\u3055\u308c\u308b\u3068\u3001Lambda\u304c\u30a4\u30d9\u30f3\u30c8\u30d5\u30c3\u30af\u3057\u3066\u5185\u5bb9\u3092Gmail\u306b\u9001\u4fe1\u3059\u308b\u69cb\u9020\u3067\u3059\u3002\n\u304a\u554f\u3044\u5408\u308f\u305b\u6570\u306e\u5c11\u306a\u3044\u30b5\u30a4\u30c8\u3067\u306f\u3001\u3053\u308c\u3067\u5341\u5206\u3067\u3057\u3087\u3046\u3002\nSQL\u30a4\u30f3\u30b8\u30a7\u30af\u30b7\u30e7\u30f3\u3068\u306f\u7121\u7e01\u3067\u3059\u3057\u3001\u8ca0\u8377\u3082\u6c17\u306b\u3057\u306a\u304f\u3066\u826f\u3044\u306e\u3067\u3001\u9078\u629e\u80a2\u3068\u3057\u3066\u306f\u3042\u308a\u304b\u306a\u3068\u601d\u3044\u307e\u3059\u3002\n\n0 \u6e96\u5099\n\n0-1 : S3\u30d0\u30b1\u30c3\u30c8\u306e\u4f5c\u6210\n\u30db\u30b9\u30c6\u30a3\u30f3\u30b0\u7528\u306eS3\u30d0\u30b1\u30c3\u30c8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u4eee\u306b\u30d0\u30b1\u30c3\u30c8\u540d\u3092xxx.example.com\u3068\u3057\u3001Static Web Hosting\u3092ON\u306b\u3057\u307e\u3059\u3002\n\n1 Cognito\n\u30d5\u30a9\u30fc\u30e0\u6295\u7a3f\u30dc\u30bf\u30f3\u3092\u62bc\u3057\u305f\u6642\u306b\u3001\u30c7\u30fc\u30bf\u3092S3\u306b\u6642\u9650\u3067upload\u53ef\u80fd\u306aIAM Role\u3092\u767a\u884c\u3057\u3066\u3082\u3089\u3046\u305f\u3081\u3001AWS Cognito\u306eSecurity Token Service\u3092\u4f7f\u3044\u307e\u3059\u3002\n\n1-1: Cognito\u3067 identity pool\u4f5c\u6210\nCognito\u30c8\u30c3\u30d7\u304b\u3089Create identity pool\u3092\u3057\u307e\u3059\u3002\nIdentity Pool Name: \u9069\u5f53\u306a\u30d7\u30fc\u30eb\u540d\u3092\u5165\u308c\u3066\u304f\u3060\u3055\u3044\nEnable Access to Unauthenticated Identities: \u8a8d\u8a3c\u306a\u3057\u3067\u3001\u6642\u9650IAM Role\u3092\u767a\u884c\u3057\u307e\u3059\u3002Amazon/Facebook/Twitter\u306a\u3069\u306e\u30a2\u30ab\u30a6\u30f3\u30c8\u3092\u8981\u6c42\u3059\u308b\u3053\u3068\u3082\u53ef\u80fd\u3067\u3059\u3002\n\n\nidentity pool\u304c\u4f5c\u6210\u3055\u308c\u305f\u3089\u3001identity pool id\u3092\u30e1\u30e2\u3057\u307e\u3059\u3002\n\n\n1-2: \u81ea\u52d5\u4f5c\u6210\u3057\u305fIAM Role\u306bS3 upload\u6a29\u9650\u3092\u8ffd\u52a0\n\u6b21\u306b\u81ea\u52d5\u4f5c\u6210\u3057\u305fIAM Role\u306bs3:PutObject / s3:PutObjectAcl\u6a29\u9650\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\n\n\n1-3: S3\u30d0\u30b1\u30c3\u30c8\u306bCORS\u8a31\u53ef\nJavaScript\u3067S3\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u305f\u3081\u3001S3\u306bCORS(Cross-Origin Resource Sharing)\u3092\u8a31\u53ef\u3057\u307e\u3059\u3002\nS3\u30d0\u30b1\u30c3\u30c8(xxx.example.com) => Permissions => Edit CORS Configuration \u3067CORS\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\nAllowedmethod: PUT\uff08upload\uff09\u306e\u307f\u8a31\u53ef\u3057\u307e\u3059 \nAllowedOrigin: \u304a\u554f\u3044\u5408\u308f\u305b\u30d5\u30a9\u30fc\u30e0\u306e\u3042\u308b\u30c9\u30e1\u30a4\u30f3\u3092\u6307\u5b9a\uff08*\u306b\u3057\u3066\u3057\u307e\u3046\u3068\u3001\u3069\u3053\u304b\u3089\u3067\u3082cognito\u3067\u767a\u884c\u3057\u305fSecurity Token\u3067S3 put\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002S3 put\u653b\u6483\u3055\u308c\u305f\u304f\u306a\u3044\u306e\u3067\u3001\u3053\u3053\u306f\u5236\u9650\u3057\u307e\u3059\uff09\n\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<CORSConfiguration xmlns=\"http://s3.amazonaws.com/doc/2006-03-01/\">\n    <CORSRule>\n        <AllowedOrigin>xxx.example.com.s3-website-us-east-1.amazonaws.com</AllowedOrigin>\n        <AllowedMethod>PUT</AllowedMethod>\n        <AllowedHeader>*</AllowedHeader>\n    </CORSRule>\n</CORSConfiguration>\n\n\u4ee5\u4e0a\u3067\u3001\u304a\u554f\u3044\u5408\u308f\u305b\u30d5\u30a9\u30fc\u30e0\uff08xxx.example.com\uff09\u304b\u3089\u306e\u307f\u3001\u6642\u9650\u3067s3\u306b\u30d5\u30a1\u30a4\u30eb\u3092put\u3067\u304d\u308bIAM Role\u304c\u767a\u884c\u53ef\u80fd\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n2 \u304a\u554f\u3044\u5408\u308f\u305b\u30d5\u30a9\u30fc\u30e0\u672c\u4f53\n\u6b21\u306b\u304a\u554f\u3044\u5408\u308f\u305b\u30d5\u30a9\u30fc\u30e0\u672c\u4f53\u3092s3\u306bupload\u3057\u307e\u3057\u3087\u3046\u3002\n\u4eca\u56de\u306f\u3001\u300c\u554f\u3044\u5408\u308f\u305b\u30bf\u30a4\u30c8\u30eb\u300d\u300c\u8fd4\u4fe1\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u300d\u300c\u672c\u6587\u300d\u306e3\u9805\u76ee\u3092\u6295\u7a3f\u3055\u305b\u307e\u3059\u3002\n\u91cd\u8981\u306a\u306e\u306f\u3001IdentityPoolId\u306e\u6b04\u306b\u3001\u5148\u307b\u3069\u30e1\u30e2\u3063\u305fID\u3092\u30b3\u30d4\u30da\u3059\u308b\u3053\u3068\u3067\u3059\u3002\naws-sdk.min.js\u3068\u4ee5\u4e0b\u306eindex.html\u3092S3\u30d0\u30b1\u30c3\u30c8\u306bupload\u3057\u307e\u3059\u3002\n\nindex.html\n<!DOCTYPE html>\n<html>\n<head>\n    <meta charset=\"UTF-8\">\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"import.css\">\n    <script src=\"aws-sdk.min.js\"></script>\n    <title>\u6295\u66f8\u753b\u9762</title>\n    <script>\n        var $id = function(id) { return document.getElementById(id); };\n        AWS.config.region = \"us-east-1\";\n        AWS.config.credentials = new AWS.CognitoIdentityCredentials({IdentityPoolId: \"Cognito\u3067\u4f5c\u6210\u3057\u305fIdentityPoolId\"});\n        AWS.config.credentials.get(function(err) {\n            if (!err) {\n                console.log(\"Cognito Identify Id: \" + AWS.config.credentials.identityId);\n            }\n        });\n\n        function uploadFile() {\n            AWS.config.region = 'us-east-1';\n            var s3BucketName = \"xxx.example.com\";\n            var now = new Date();\n            var obj = {\"title\":$id(\"title\").value, \"mail\":$id(\"mail\").value ,\"contents\":$id(\"contents\").value, \"date\": now.toLocaleString()};\n            var s3 = new AWS.S3({params: {Bucket: s3BucketName}});\n            var blob = new Blob([JSON.stringify(obj, null, 2)], {type:'text/plain'});\n            s3.putObject({Key: \"uploads/\" +now.getTime()+\".txt\", ContentType: \"text/plain\", Body: blob, ACL: \"public-read\"},\n            function(err, data){\n                if(data !== null){\n                    alert(\"\u304a\u554f\u3044\u5408\u308f\u305b\u5b8c\u4e86\u81f4\u3057\u307e\u3057\u305f\");\n                }\n                else{\n                    alert(\"Upload Failed\" + err.message);\n                }\n            });\n        }\n    </script>\n</head>\n<body>\n    <div class=\"wrapper\">\n        <div id=\"postform\">\n            <form>\n                <table>\n                    <tr>\n                        <th>\u4ef6\u540d</th>\n                        <td>\n                            <input id=\"title\" type=\"text\" name=\"title\" class=\"titletext fontchange\" maxlength=\"40\" value=\"\" />\n                        </td>\n                    </tr>\n                    <tr>\n                        <th>\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9</th>\n                        <td>\n                            <input id=\"mail\" type=\"email\" name=\"mail\" size=\"30\" maxlength=\"50\" />\n                        </td>\n                    </tr>\n                    <tr>\n                        <th>\u304a\u554f\u3044\u5408\u308f\u305b\u5185\u5bb9</th>\n                        <td>\n                            <TEXTAREA id=\"contents\" cols=\"40\" rows=\"6\" name=\"contents\" class=\"fontchange\"></TEXTAREA>\n                        </td>\n                    </tr>\n                </table>\n                <div id=\"button_area\" class=\"clearfix\">\n                    <input onClick=\"uploadFile();\" type=\"button\" value=\"\u6295\u7a3f\" id=\"css_button\" class=\"button_right\" />\n                </div>\n            </form>\n        </div>\n        <! --loginform-->\n    </div>\n    <! --wrapper -->\n</body>\n</html>\n\n\n\n3 Lambda\n\n3-1 \u6e96\u5099\n\u4ee5\u4e0b2\u3064\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u3092DL\u3057\u307e\u3059\u3002\n\nAWS-SDK\n\nnpm install aws-sdk\n\n\n\nnodemailer \uff08Gmail\u8ee2\u9001\u7528\uff09\n\nnpm install nodemailer\n\n\u4ee5\u4e0a\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3068\u4ee5\u4e0b\u306e\u901a\u308anode_modules\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4ee5\u4e0b\u306b\u4fdd\u5b58\u3055\u308c\u307e\u3059\u3002\n[~] ls node_modules\naws-sdk nodemailer\n\n\u5f8c\u307b\u3069\u3001\u4f5c\u6210\u3059\u308bindex.js\u3068\u5171\u306bzip\u306b\u3057\u3066Lambda\u306bupload\u3057\u307e\u3059\u3002\n\n3-2 Lambda function\n\u4ee5\u4e0b\u306e\u611f\u3058\u3067\u4f5c\u6210\u3057\u307e\u3059\n\nindex.js\nconsole.log(\"Loading event\")\nvar aws = require('aws-sdk');\nvar s3 = new aws.S3({apiVersion: '2006-03-01'});\nvar mailer = require('nodemailer');\n\nvar settings = {\n    service: 'Gmail',\n    auth: {\n        user: '\u9001\u4fe1\u5143Gmail\u30a2\u30c9\u30ec\u30b9',\n        pass: 'Gmail\u30d1\u30b9\u30ef\u30fc\u30c9',\n        port: 25\n    }\n};\n\nvar smtp = mailer.createTransport(settings);\n\nexports.handler = function(event, context) {\n    console.log('Received event:', JSON.stringify(event, null, 2));\n    var bucket = event.Records[0].s3.bucket.name;\n    var key = event.Records[0].s3.object.key;\n    s3.getObject({Bucket: bucket, Key: key},\n        function(err, data) {\n            if (err){\n                context.done('error', 'error getting file' + err);\n            } else {\n                var message = JSON.parse(data.Body);\n                var options = {\n                    to : '\u9001\u4fe1\u5148Gmail\u30a2\u30c9\u30ec\u30b9',\n                    replyTo : message.mail,\n                    subject: message.title,\n                    text: ' ' + message.contents\n                };\n                smtp.sendMail(options, function(error, info){\n                    if (error){\n                        console.log('error:' + error);\n                    } else {\n                        console.log('Message sent:' + info.response);\n                    }\n                })\n            }\n        }\n    );\n};\n\n\n\u4ee5\u4e0a\u3092zip\u3067\u56fa\u3081\u3066Lambda function\u306bup\u3057\u307e\u3059\nzip -r s3_form.zip index.js node_modules\nfunction\u540d\u306fS3mail_semd\u3068\u3057\u307e\u3059\u3002\uff08\u30bf\u30a4\u30dd...\uff09\n3-3: \u5bfe\u8c61S3\u30d0\u30b1\u30c3\u30c8\u306e\u30a4\u30d9\u30f3\u30c8\u30d5\u30c3\u30af\u4f5c\u6210\n\u6700\u5f8c\u306b\u5bfe\u8c61S3\u30d0\u30b1\u30c3\u30c8\u3067\u3001\u4e0b\u56f3\u306e\u901a\u308aEvent Notifications\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n\u4ee5\u4e0a\u3067\u3072\u3068\u901a\u308a\u5b8c\u4e86\u3067\u3059\u3002\n\n\u78ba\u8a8d\n\u3053\u3093\u306a\u611f\u3058\u3067\u6295\u7a3f\u3059\u308b\u3068\n\n\u7121\u4e8bGmail\u3067\u53d7\u3051\u53d6\u308c\u307e\u3057\u305f\n\n\n\u53c2\u8003\u30b5\u30a4\u30c8\nhttps://www.system-i-enter.com/blog/blog/2015/02/03/s3/\nhttps://www.system-i-enter.com/blog/blog/2015/02/10/aws-lambda/\nhttp://dev.classmethod.jp/cloud/cors-cross-origin-resource-sharing-cross-domain/\nhttp://dev.classmethod.jp/etc/about-cors/\nS3\u3068Lambda\u3068Cognito\u3092\u4f7f\u3063\u3066\u3001\u7c21\u5358\u3067\u30bb\u30ad\u30e5\u30a2\u306a\u304a\u554f\u3044\u5408\u308f\u305b\u30d5\u30a9\u30fc\u30e0\u30b7\u30b9\u30c6\u30e0\u3092\u4f5c\u3063\u3066\u307f\u307e\u3059\u3002\n\n**Cognito\u304c\u30d0\u30fc\u30b8\u30cb\u30a2/\u30a2\u30a4\u30eb\u30e9\u30f3\u30c9\u306e\u307f\u5229\u7528\u53ef\u80fd\u3067\u3059\u306e\u3067\u3001\u4eca\u56de\u306fS3/Lambda/Congito\u5168\u90e8\u30d0\u30fc\u30b8\u30cb\u30a2(us-east-1)\u306b\u63c3\u3048\u307e\u3059\uff08S3\u3068Lambda\u306f\u30ea\u30fc\u30b8\u30e7\u30f3\u63c3\u3048\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\uff09**\n\n# \u5168\u4f53\u50cf\n\nS3\u4e0a\u306b\u30db\u30b9\u30c6\u30a3\u30f3\u30b0\u3057\u3066\u3044\u308b\u304a\u554f\u3044\u5408\u308f\u305b\u30d5\u30a9\u30fc\u30e0\u304b\u3089\u6295\u7a3f\u3059\u308b\u3068\u3001S3\u4e0a\u306bJSON\u5f62\u5f0f\u3067\u5185\u5bb9\u304cupload\u3055\u308c\u307e\u3059\u3002\u30d5\u30a1\u30a4\u30eb\u304cupload\u3055\u308c\u308b\u3068\u3001Lambda\u304c\u30a4\u30d9\u30f3\u30c8\u30d5\u30c3\u30af\u3057\u3066\u5185\u5bb9\u3092Gmail\u306b\u9001\u4fe1\u3059\u308b\u69cb\u9020\u3067\u3059\u3002\n\u304a\u554f\u3044\u5408\u308f\u305b\u6570\u306e\u5c11\u306a\u3044\u30b5\u30a4\u30c8\u3067\u306f\u3001\u3053\u308c\u3067\u5341\u5206\u3067\u3057\u3087\u3046\u3002\n\nSQL\u30a4\u30f3\u30b8\u30a7\u30af\u30b7\u30e7\u30f3\u3068\u306f\u7121\u7e01\u3067\u3059\u3057\u3001\u8ca0\u8377\u3082\u6c17\u306b\u3057\u306a\u304f\u3066\u826f\u3044\u306e\u3067\u3001\u9078\u629e\u80a2\u3068\u3057\u3066\u306f\u3042\u308a\u304b\u306a\u3068\u601d\u3044\u307e\u3059\u3002\n\n# 0 \u6e96\u5099\n## 0-1 : S3\u30d0\u30b1\u30c3\u30c8\u306e\u4f5c\u6210\n\n\u30db\u30b9\u30c6\u30a3\u30f3\u30b0\u7528\u306eS3\u30d0\u30b1\u30c3\u30c8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u4eee\u306b\u30d0\u30b1\u30c3\u30c8\u540d\u3092xxx.example.com\u3068\u3057\u3001Static Web Hosting\u3092ON\u306b\u3057\u307e\u3059\u3002\n\n# 1 Cognito\n\n\u30d5\u30a9\u30fc\u30e0\u6295\u7a3f\u30dc\u30bf\u30f3\u3092\u62bc\u3057\u305f\u6642\u306b\u3001\u30c7\u30fc\u30bf\u3092S3\u306b\u6642\u9650\u3067upload\u53ef\u80fd\u306aIAM Role\u3092\u767a\u884c\u3057\u3066\u3082\u3089\u3046\u305f\u3081\u3001AWS Cognito\u306e[Security Token Service](http://docs.aws.amazon.com/ja_jp/STS/latest/UsingSTS/Welcome.html)\u3092\u4f7f\u3044\u307e\u3059\u3002\n\n## 1-1: Cognito\u3067 identity pool\u4f5c\u6210\n\nCognito\u30c8\u30c3\u30d7\u304b\u3089Create identity pool\u3092\u3057\u307e\u3059\u3002\n\n\nIdentity Pool Name: \u9069\u5f53\u306a\u30d7\u30fc\u30eb\u540d\u3092\u5165\u308c\u3066\u304f\u3060\u3055\u3044\nEnable Access to Unauthenticated Identities: \u8a8d\u8a3c\u306a\u3057\u3067\u3001\u6642\u9650IAM Role\u3092\u767a\u884c\u3057\u307e\u3059\u3002Amazon/Facebook/Twitter\u306a\u3069\u306e\u30a2\u30ab\u30a6\u30f3\u30c8\u3092\u8981\u6c42\u3059\u308b\u3053\u3068\u3082\u53ef\u80fd\u3067\u3059\u3002\n\n![cognito0](https://s3-ap-northeast-1.amazonaws.com/qiita-3-shake.com/cognito_0.png)\n\n![cognito1](https://s3-ap-northeast-1.amazonaws.com/qiita-3-shake.com/cognito_1.png)\n\nidentity pool\u304c\u4f5c\u6210\u3055\u308c\u305f\u3089\u3001identity pool id\u3092\u30e1\u30e2\u3057\u307e\u3059\u3002\n\n![cognitox](https://s3-ap-northeast-1.amazonaws.com/qiita-3-shake.com/cognito_x.png)\n\n## 1-2: \u81ea\u52d5\u4f5c\u6210\u3057\u305fIAM Role\u306bS3 upload\u6a29\u9650\u3092\u8ffd\u52a0\n\u6b21\u306b\u81ea\u52d5\u4f5c\u6210\u3057\u305fIAM Role\u306bs3:PutObject / s3:PutObjectAcl\u6a29\u9650\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\n![cognito2](https://s3-ap-northeast-1.amazonaws.com/qiita-3-shake.com/cognito_2.png)\n\n![cognito3](https://s3-ap-northeast-1.amazonaws.com/qiita-3-shake.com/cognito_3.png)\n\n## 1-3: S3\u30d0\u30b1\u30c3\u30c8\u306bCORS\u8a31\u53ef\n\nJavaScript\u3067S3\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u305f\u3081\u3001S3\u306b[CORS(Cross-Origin Resource Sharing)](http://docs.aws.amazon.com/ja_jp/AmazonS3/latest/dev/cors.html)\u3092\u8a31\u53ef\u3057\u307e\u3059\u3002\n\nS3\u30d0\u30b1\u30c3\u30c8(xxx.example.com) => Permissions => Edit CORS Configuration \u3067CORS\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n- Allowedmethod: PUT\uff08upload\uff09\u306e\u307f\u8a31\u53ef\u3057\u307e\u3059 \n- AllowedOrigin: \u304a\u554f\u3044\u5408\u308f\u305b\u30d5\u30a9\u30fc\u30e0\u306e\u3042\u308b\u30c9\u30e1\u30a4\u30f3\u3092\u6307\u5b9a\uff08*\u306b\u3057\u3066\u3057\u307e\u3046\u3068\u3001\u3069\u3053\u304b\u3089\u3067\u3082cognito\u3067\u767a\u884c\u3057\u305fSecurity Token\u3067S3 put\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002S3 put\u653b\u6483\u3055\u308c\u305f\u304f\u306a\u3044\u306e\u3067\u3001\u3053\u3053\u306f\u5236\u9650\u3057\u307e\u3059\uff09\n\n```\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<CORSConfiguration xmlns=\"http://s3.amazonaws.com/doc/2006-03-01/\">\n    <CORSRule>\n        <AllowedOrigin>xxx.example.com.s3-website-us-east-1.amazonaws.com</AllowedOrigin>\n        <AllowedMethod>PUT</AllowedMethod>\n        <AllowedHeader>*</AllowedHeader>\n    </CORSRule>\n</CORSConfiguration>\n```\n\n\u4ee5\u4e0a\u3067\u3001\u304a\u554f\u3044\u5408\u308f\u305b\u30d5\u30a9\u30fc\u30e0\uff08xxx.example.com\uff09\u304b\u3089\u306e\u307f\u3001\u6642\u9650\u3067s3\u306b\u30d5\u30a1\u30a4\u30eb\u3092put\u3067\u304d\u308bIAM Role\u304c\u767a\u884c\u53ef\u80fd\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n# 2 \u304a\u554f\u3044\u5408\u308f\u305b\u30d5\u30a9\u30fc\u30e0\u672c\u4f53\n\n\u6b21\u306b\u304a\u554f\u3044\u5408\u308f\u305b\u30d5\u30a9\u30fc\u30e0\u672c\u4f53\u3092s3\u306bupload\u3057\u307e\u3057\u3087\u3046\u3002\n\u4eca\u56de\u306f\u3001\u300c\u554f\u3044\u5408\u308f\u305b\u30bf\u30a4\u30c8\u30eb\u300d\u300c\u8fd4\u4fe1\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u300d\u300c\u672c\u6587\u300d\u306e3\u9805\u76ee\u3092\u6295\u7a3f\u3055\u305b\u307e\u3059\u3002\n\u91cd\u8981\u306a\u306e\u306f\u3001IdentityPoolId\u306e\u6b04\u306b\u3001\u5148\u307b\u3069\u30e1\u30e2\u3063\u305fID\u3092\u30b3\u30d4\u30da\u3059\u308b\u3053\u3068\u3067\u3059\u3002\n\n[aws-sdk.min.js](http://docs.aws.amazon.com/AWSJavaScriptSDK/guide/browser-intro.html)\u3068\u4ee5\u4e0b\u306eindex.html\u3092S3\u30d0\u30b1\u30c3\u30c8\u306bupload\u3057\u307e\u3059\u3002\n\n\n\n\n```html:index.html\n<!DOCTYPE html>\n<html>\n<head>\n    <meta charset=\"UTF-8\">\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"import.css\">\n    <script src=\"aws-sdk.min.js\"></script>\n    <title>\u6295\u66f8\u753b\u9762</title>\n    <script>\n        var $id = function(id) { return document.getElementById(id); };\n        AWS.config.region = \"us-east-1\";\n        AWS.config.credentials = new AWS.CognitoIdentityCredentials({IdentityPoolId: \"Cognito\u3067\u4f5c\u6210\u3057\u305fIdentityPoolId\"});\n        AWS.config.credentials.get(function(err) {\n            if (!err) {\n                console.log(\"Cognito Identify Id: \" + AWS.config.credentials.identityId);\n            }\n        });\n\n        function uploadFile() {\n            AWS.config.region = 'us-east-1';\n            var s3BucketName = \"xxx.example.com\";\n            var now = new Date();\n            var obj = {\"title\":$id(\"title\").value, \"mail\":$id(\"mail\").value ,\"contents\":$id(\"contents\").value, \"date\": now.toLocaleString()};\n            var s3 = new AWS.S3({params: {Bucket: s3BucketName}});\n            var blob = new Blob([JSON.stringify(obj, null, 2)], {type:'text/plain'});\n            s3.putObject({Key: \"uploads/\" +now.getTime()+\".txt\", ContentType: \"text/plain\", Body: blob, ACL: \"public-read\"},\n            function(err, data){\n                if(data !== null){\n                    alert(\"\u304a\u554f\u3044\u5408\u308f\u305b\u5b8c\u4e86\u81f4\u3057\u307e\u3057\u305f\");\n                }\n                else{\n                    alert(\"Upload Failed\" + err.message);\n                }\n            });\n        }\n    </script>\n</head>\n<body>\n    <div class=\"wrapper\">\n        <div id=\"postform\">\n            <form>\n                <table>\n                    <tr>\n                        <th>\u4ef6\u540d</th>\n                        <td>\n                            <input id=\"title\" type=\"text\" name=\"title\" class=\"titletext fontchange\" maxlength=\"40\" value=\"\" />\n                        </td>\n                    </tr>\n                    <tr>\n                        <th>\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9</th>\n                        <td>\n                            <input id=\"mail\" type=\"email\" name=\"mail\" size=\"30\" maxlength=\"50\" />\n                        </td>\n                    </tr>\n                    <tr>\n                        <th>\u304a\u554f\u3044\u5408\u308f\u305b\u5185\u5bb9</th>\n                        <td>\n                            <TEXTAREA id=\"contents\" cols=\"40\" rows=\"6\" name=\"contents\" class=\"fontchange\"></TEXTAREA>\n                        </td>\n                    </tr>\n                </table>\n                <div id=\"button_area\" class=\"clearfix\">\n                    <input onClick=\"uploadFile();\" type=\"button\" value=\"\u6295\u7a3f\" id=\"css_button\" class=\"button_right\" />\n                </div>\n            </form>\n        </div>\n        <! --loginform-->\n    </div>\n    <! --wrapper -->\n</body>\n</html>\n```\n\n# 3 Lambda\n## 3-1 \u6e96\u5099\n\u4ee5\u4e0b2\u3064\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u3092DL\u3057\u307e\u3059\u3002\n\n- [AWS-SDK](http://aws.amazon.com/jp/sdk-for-node-js/)\n\n```\nnpm install aws-sdk\n```\n\n- [nodemailer](https://github.com/andris9/Nodemailer) \uff08Gmail\u8ee2\u9001\u7528\uff09\n\n```\nnpm install nodemailer\n```\n\n\u4ee5\u4e0a\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3068\u4ee5\u4e0b\u306e\u901a\u308anode_modules\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4ee5\u4e0b\u306b\u4fdd\u5b58\u3055\u308c\u307e\u3059\u3002\n\n```\n[~] ls node_modules\naws-sdk nodemailer\n```\n\n\u5f8c\u307b\u3069\u3001\u4f5c\u6210\u3059\u308bindex.js\u3068\u5171\u306bzip\u306b\u3057\u3066Lambda\u306bupload\u3057\u307e\u3059\u3002\n\n## 3-2 Lambda function\n\n\u4ee5\u4e0b\u306e\u611f\u3058\u3067\u4f5c\u6210\u3057\u307e\u3059\n\n```js:index.js\nconsole.log(\"Loading event\")\nvar aws = require('aws-sdk');\nvar s3 = new aws.S3({apiVersion: '2006-03-01'});\nvar mailer = require('nodemailer');\n\nvar settings = {\n    service: 'Gmail',\n    auth: {\n        user: '\u9001\u4fe1\u5143Gmail\u30a2\u30c9\u30ec\u30b9',\n        pass: 'Gmail\u30d1\u30b9\u30ef\u30fc\u30c9',\n        port: 25\n    }\n};\n\nvar smtp = mailer.createTransport(settings);\n\nexports.handler = function(event, context) {\n    console.log('Received event:', JSON.stringify(event, null, 2));\n    var bucket = event.Records[0].s3.bucket.name;\n    var key = event.Records[0].s3.object.key;\n    s3.getObject({Bucket: bucket, Key: key},\n        function(err, data) {\n            if (err){\n                context.done('error', 'error getting file' + err);\n            } else {\n                var message = JSON.parse(data.Body);\n                var options = {\n                    to : '\u9001\u4fe1\u5148Gmail\u30a2\u30c9\u30ec\u30b9',\n                    replyTo : message.mail,\n                    subject: message.title,\n                    text: ' ' + message.contents\n                };\n                smtp.sendMail(options, function(error, info){\n                    if (error){\n                        console.log('error:' + error);\n                    } else {\n                        console.log('Message sent:' + info.response);\n                    }\n                })\n            }\n        }\n    );\n};\n```\n\n\u4ee5\u4e0a\u3092zip\u3067\u56fa\u3081\u3066Lambda function\u306bup\u3057\u307e\u3059\n\n```zip -r s3_form.zip index.js node_modules```\n\nfunction\u540d\u306fS3mail_semd\u3068\u3057\u307e\u3059\u3002\uff08\u30bf\u30a4\u30dd...\uff09\n\n3-3: \u5bfe\u8c61S3\u30d0\u30b1\u30c3\u30c8\u306e\u30a4\u30d9\u30f3\u30c8\u30d5\u30c3\u30af\u4f5c\u6210\n\n\u6700\u5f8c\u306b\u5bfe\u8c61S3\u30d0\u30b1\u30c3\u30c8\u3067\u3001\u4e0b\u56f3\u306e\u901a\u308aEvent Notifications\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n![hook](https://s3-ap-northeast-1.amazonaws.com/qiita-3-shake.com/cognito_4.png)\n\n\n\u4ee5\u4e0a\u3067\u3072\u3068\u901a\u308a\u5b8c\u4e86\u3067\u3059\u3002\n\n# \u78ba\u8a8d\n\n\u3053\u3093\u306a\u611f\u3058\u3067\u6295\u7a3f\u3059\u308b\u3068\n![mail](https://s3-ap-northeast-1.amazonaws.com/qiita-3-shake.com/mail.png)\n\n\u7121\u4e8bGmail\u3067\u53d7\u3051\u53d6\u308c\u307e\u3057\u305f\n\n![reply](https://s3-ap-northeast-1.amazonaws.com/qiita-3-shake.com/reply-mail.png)\n\n# \u53c2\u8003\u30b5\u30a4\u30c8\nhttps://www.system-i-enter.com/blog/blog/2015/02/03/s3/\nhttps://www.system-i-enter.com/blog/blog/2015/02/10/aws-lambda/\nhttp://dev.classmethod.jp/cloud/cors-cross-origin-resource-sharing-cross-domain/\nhttp://dev.classmethod.jp/etc/about-cors/\n", "tags": ["lambda", "AWS", "S3", "cognito"]}