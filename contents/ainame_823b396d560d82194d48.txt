{"context": " More than 1 year has passed since last update.Rails\u7b49\u3067\u6bce\u65e5API\u3092\u7d0d\u54c1\u3057\u3066\u3044\u308b\u754c\u9688\u306e\u7686\u69d8\u65b9\u306f\u3001\u30ea\u30af\u30a8\u30b9\u30c8\u6bce\u306b\u30b0\u30ed\u30fc\u30d0\u30eb\u306a\u5909\u6570\u3092\u6301\u3061\u305f\u3044\u6642\u306f\u305f\u307e\u306b\u3042\u308b\u304b\u3068\u601d\u3044\u307e\u3059\u3002\u4f8b\u3048\u3070\u3001\u30ed\u30b0\u3092\u5410\u304f\u305f\u3081\u306bRack::Request\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u30ed\u30ac\u30fc\u304b\u3089\u53c2\u7167\u3057\u305f\u3044\u3068\u304b\u3002\u30e2\u30c7\u30eb\u3084\u30b5\u30fc\u30d3\u30b9\u5c64\u3067\u3042\u308b\u51e6\u7406\u304c\u547c\u3070\u308c\u308b\u6bce\u306b\u30ea\u30af\u30a8\u30b9\u30c8\u8005\u306eAudit\u30ed\u30b0\u3092\u6b8b\u3057\u305f\u3044\u5834\u5408\u306a\u3069\u305d\u3046\u306a\u308a\u305d\u3046\u3067\u3059\u3002\nclass PostEditService\n  def initialize(post, request)\n    @post, @request = post, request\n  end\n\n  def call(new_body)\n    @post.body = some_normalize(new_body)\n    #...\n    Rails.logger.info(\"[audit] ip: #{@request.ip}, ua: #{@request.user_agent}\")\n  end\nend\n\n\u30b5\u30f3\u30d7\u30eb\u306e\u30b3\u30fc\u30c9\u306f\u3059\u3054\u3044\u9069\u5f53\u3067\u3059\u304c\u3001\u672c\u5f53\u306b\u4f55\u3082\u8003\u3048\u305a\u306b\u5b9f\u88c5\u3059\u308b\u3068\u3053\u3093\u306a\u304b\u3093\u3058\u3067\u5f15\u6570\u3067\u5f15\u304d\u56de\u3059\u5b9f\u88c5\u304c\u601d\u3044\u6d6e\u304b\u3073\u307e\u3059\u3002\u3057\u304b\u3057\u3001\u3053\u308c\u3067\u306fService\u5c64\u306b\u672c\u8cea\u3068\u95a2\u4fc2\u306a\u3044\u30ed\u30b0\u3092\u6b8b\u3059\u305f\u3081\u306b\u3044\u3061\u3044\u3061request\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092Controller\u304b\u3089\u6e21\u3059\u306e\u306f\u3044\u307e\u3044\u3061\u3067\u3059\u3002\u3067\u306f\u3001\u30b0\u30ed\u30fc\u30d0\u30eb\u306a\u6240\u304b\u3089\u53c2\u7167\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308b\u3068\u5f15\u304d\u56de\u3055\u305a\u306b\u6e08\u3093\u3067\u826f\u3055\u305d\u3046\u3067\u3059\u3002\n\u3053\u3061\u3089\u3082\u4f55\u3082\u8003\u3048\u305a\u306b\u5b9f\u88c5\u3059\u308b\u3068\u3001\u3053\u3093\u306a\u611f\u3058\u306b\u306a\u3063\u3061\u3083\u3046\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\nclass GlobalRequestStore\n  cattr_accessor :request\nend\n\n# .... \nclass ApplicationController\n  before_action :store_request\n\n  private\n  def store_request\n    GlobalRequestStore.request = request\n  end\nend\n\n# ...\nclass PostEditService\n  def call(new_body)\n    #...\n    request = GlobalRequestStore.request\n    Rails.logger.info(\"[audit] ip: #{request.ip}, ua: #{request.user_agent}\")\n  end\nend\n\n\u3053\u308c\u3060\u3068\u3001controller\u304b\u3089\u4fdd\u6301\u3059\u308brequest\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306f\u3001Rails\u306eModule#cattr_accessor\u306b\u3088\u3063\u3066GlobalRequestStore\u306e\u30af\u30e9\u30b9\u5909\u6570(@@request)\u306b\u683c\u7d0d\u3055\u308c\u308b\u3060\u3051\u3067\u30b9\u30ec\u30c3\u30c9\u30bb\u30fc\u30d5\u3067\u306f\u306a\u3044\u3067\u3059\u3002\n\u3058\u3083\u3042\u30b9\u30ec\u30c3\u30c9\u30bb\u30fc\u30d5\u306a\u3089\u826f\u3044\u306e\u304b\u3068\u3044\u3046\u3053\u3068\u3067\u3001\u3053\u3046\u3044\u3046\u5b9f\u88c5\u3092\u8003\u3048\u3066\u307f\u307e\u3059\u3002\nclass ThreadLocalRequestStore\n  def self.request=(req)\n    Thread.current[:request] = req\n  end\n\n  def self.request\n    Thread.current[:request]\n  end\nend\n\n# .... \nclass ApplicationController\n  before_action :store_request\n\n  private\n  def store_request\n    ThreadLocalRequestStore.request = request\n  end\nend\n\n# ...\nclass PostEditService\n  def call(new_body)\n    #...\n    request = ThreadLocalRequestStore.request\n    Rails.logger.info(\"[audit] ip: #{request.ip}, ua: #{request.user_agent}\")\n  end\nend\n\n\u3053\u308c\u306fThread#[]=\u30e1\u30bd\u30c3\u30c9\u3092\u4f7f\u3063\u3066\u3044\u3066\u3001current\u306e\u30b9\u30ec\u30c3\u30c9\u306e\u30ed\u30fc\u30ab\u30eb\u306a\u3089\u9818\u57df\u306b\u30c7\u30fc\u30bf\u3092\u683c\u7d0d\u3067\u304d\u3066\u307e\u3059\u3002\u3057\u304b\u3057\u3053\u308c\u3067\u3082\u307e\u3060\u30c0\u30e1\u3067\u30011\u30ea\u30af\u30a8\u30b9\u30c8\u3054\u3068\u306bRuby\u30d7\u30ed\u30bb\u30b9\u304c\u7d42\u4e86\u3057\u3066\u304f\u308c\u306a\u3051\u308c\u3070\u3001\u540c\u3058\u30b9\u30ec\u30c3\u30c9\u3092\u4f7f\u3063\u3066\u4f55\u3089\u304b\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u4ee5\u5916\u306e\u51e6\u7406\u304c\u5b9f\u884c\u3055\u308c\u305f\u6642\u306b\u524d\u56de\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3067ThreadLocalRequestStore\u306b\u683c\u7d0d\u3057\u305f\u5024\u304c\u524a\u9664\u3055\u308c\u305a\u306b\u6b8b\u3063\u3066\u3057\u307e\u3063\u3066\u3044\u308b\u305f\u3081\u3001\u53c2\u7167\u3055\u308c\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\u305d\u3053\u3067RequestStore gem\u306e\u767b\u5834\u3067\u3059\u3002\u3053\u306egem\u3082\u4e0a\u8a18\u3068\u540c\u69d8Thread.current#[]=\u3092\u5229\u7528\u3057\u3066\u3044\u3066\u3001\u3055\u3089\u306bRack::Middleware\u306e\u5c64\u3067\u3001\u30ea\u30af\u30a8\u30b9\u30c8\u6bce\u306bThread.current\u306e\u5024\u3092\u30af\u30ea\u30a2\u3057\u3066\u3044\u307e\u3059\u3002\u307e\u3041\u4ed5\u7d44\u307f\u306f\u5358\u7d14\u3067\u3059\u826f\u3044\u3067\u3059\u3002\n\nlib/request_store/middleware.rb\nmodule RequestStore\n  class Middleware\n    def initialize(app)\n      @app = app\n    end\n\n    def call(env)\n      @app.call(env)\n    ensure\n      RequestStore.clear!\n    end\n  end\nend\n\n\nhttps://github.com/steveklabnik/request_store/blob/master/lib/request_store/middleware.rb\nclass ApplicationController\n  before_action :store_request\n\n  private\n  def store_request\n    RequestStore.store[:request] = request\n  end\nend\n\nclass PostsController < ApplicationController\n  def update\n    service = PostEditService.new(Post.find(params[:id])\n    service.call(params[:body])\n    # ...\n  end\nend\n\nclass PostEditService\n  def initialize(post)\n    @post = post\n  end\n\n  def call(body)\n    @post.body = some_normalize(body)\n    #...\n    ActiveSupport::Notification.instrument('posts.audit')\n  end\nend\n\nclass AuditLogger < ActiveSupport::LogSubscriber\n  def posts(event)\n    request = RequestStore.store[:request]\n    info(\"[request] - ip: #{request.ip}, ua: #{request.user_agent}\")\n  end\nend\n\nAuditLogSubscriber.attach_to :audit\n\n\u3053\u308c\u3067\u3088\u3046\u3084\u304f\u30ea\u30af\u30a8\u30b9\u30c8\u6bce\u306b\u30b0\u30ed\u30fc\u30d0\u30eb\u306a\u53c2\u7167\u3067\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u304c\u3084\u308a\u3068\u308a\u51fa\u6765\u308b\u3088\u3046\u306b\u306a\u308a\u3001\u30ed\u30b0\u3092\u6b8b\u3059\u306a\u3069\u306e\u305f\u3081\u3060\u3051\u306b\u5404\u7a2e\u30af\u30e9\u30b9\u306b\u672c\u8cea\u7684\u3067\u306f\u306a\u3044request\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u5f15\u6570\u3068\u3057\u3066\u5f15\u304d\u56de\u3059\u306a\u3069\u306e\u8a2d\u8a08\u3092\u5ec3\u6b62\u3057\u3001ActiveSupport::Notification\u306b\u3088\u308b\u5b9f\u88c5\u306b\u5909\u66f4\u3059\u308b\u3053\u3068\u3082\u53ef\u80fd\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\u53c2\u8003:\n\nhttps://github.com/steveklabnik/request_store\nhttp://d.hatena.ne.jp/hirokidaichi/20101102/1288718980\n\nRails\u7b49\u3067\u6bce\u65e5API\u3092\u7d0d\u54c1\u3057\u3066\u3044\u308b\u754c\u9688\u306e\u7686\u69d8\u65b9\u306f\u3001\u30ea\u30af\u30a8\u30b9\u30c8\u6bce\u306b\u30b0\u30ed\u30fc\u30d0\u30eb\u306a\u5909\u6570\u3092\u6301\u3061\u305f\u3044\u6642\u306f\u305f\u307e\u306b\u3042\u308b\u304b\u3068\u601d\u3044\u307e\u3059\u3002\u4f8b\u3048\u3070\u3001\u30ed\u30b0\u3092\u5410\u304f\u305f\u3081\u306bRack::Request\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u30ed\u30ac\u30fc\u304b\u3089\u53c2\u7167\u3057\u305f\u3044\u3068\u304b\u3002\u30e2\u30c7\u30eb\u3084\u30b5\u30fc\u30d3\u30b9\u5c64\u3067\u3042\u308b\u51e6\u7406\u304c\u547c\u3070\u308c\u308b\u6bce\u306b\u30ea\u30af\u30a8\u30b9\u30c8\u8005\u306eAudit\u30ed\u30b0\u3092\u6b8b\u3057\u305f\u3044\u5834\u5408\u306a\u3069\u305d\u3046\u306a\u308a\u305d\u3046\u3067\u3059\u3002\n\n```rb\nclass PostEditService\n  def initialize(post, request)\n    @post, @request = post, request\n  end\n\n  def call(new_body)\n    @post.body = some_normalize(new_body)\n    #...\n    Rails.logger.info(\"[audit] ip: #{@request.ip}, ua: #{@request.user_agent}\")\n  end\nend\n```\n\n\u30b5\u30f3\u30d7\u30eb\u306e\u30b3\u30fc\u30c9\u306f\u3059\u3054\u3044\u9069\u5f53\u3067\u3059\u304c\u3001\u672c\u5f53\u306b\u4f55\u3082\u8003\u3048\u305a\u306b\u5b9f\u88c5\u3059\u308b\u3068\u3053\u3093\u306a\u304b\u3093\u3058\u3067\u5f15\u6570\u3067\u5f15\u304d\u56de\u3059\u5b9f\u88c5\u304c\u601d\u3044\u6d6e\u304b\u3073\u307e\u3059\u3002\u3057\u304b\u3057\u3001\u3053\u308c\u3067\u306fService\u5c64\u306b\u672c\u8cea\u3068\u95a2\u4fc2\u306a\u3044\u30ed\u30b0\u3092\u6b8b\u3059\u305f\u3081\u306b\u3044\u3061\u3044\u3061request\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092Controller\u304b\u3089\u6e21\u3059\u306e\u306f\u3044\u307e\u3044\u3061\u3067\u3059\u3002\u3067\u306f\u3001\u30b0\u30ed\u30fc\u30d0\u30eb\u306a\u6240\u304b\u3089\u53c2\u7167\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308b\u3068\u5f15\u304d\u56de\u3055\u305a\u306b\u6e08\u3093\u3067\u826f\u3055\u305d\u3046\u3067\u3059\u3002\n\n\u3053\u3061\u3089\u3082\u4f55\u3082\u8003\u3048\u305a\u306b\u5b9f\u88c5\u3059\u308b\u3068\u3001\u3053\u3093\u306a\u611f\u3058\u306b\u306a\u3063\u3061\u3083\u3046\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\n```rb\nclass GlobalRequestStore\n  cattr_accessor :request\nend\n\n# .... \nclass ApplicationController\n  before_action :store_request\n\n  private\n  def store_request\n    GlobalRequestStore.request = request\n  end\nend\n\n# ...\nclass PostEditService\n  def call(new_body)\n    #...\n    request = GlobalRequestStore.request\n    Rails.logger.info(\"[audit] ip: #{request.ip}, ua: #{request.user_agent}\")\n  end\nend\n```\n\n\u3053\u308c\u3060\u3068\u3001controller\u304b\u3089\u4fdd\u6301\u3059\u308brequest\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306f\u3001Rails\u306eModule#cattr_accessor\u306b\u3088\u3063\u3066GlobalRequestStore\u306e\u30af\u30e9\u30b9\u5909\u6570(@@request)\u306b\u683c\u7d0d\u3055\u308c\u308b\u3060\u3051\u3067\u30b9\u30ec\u30c3\u30c9\u30bb\u30fc\u30d5\u3067\u306f\u306a\u3044\u3067\u3059\u3002\n\n\u3058\u3083\u3042\u30b9\u30ec\u30c3\u30c9\u30bb\u30fc\u30d5\u306a\u3089\u826f\u3044\u306e\u304b\u3068\u3044\u3046\u3053\u3068\u3067\u3001\u3053\u3046\u3044\u3046\u5b9f\u88c5\u3092\u8003\u3048\u3066\u307f\u307e\u3059\u3002\n\n```rb\nclass ThreadLocalRequestStore\n  def self.request=(req)\n    Thread.current[:request] = req\n  end\n\n  def self.request\n    Thread.current[:request]\n  end\nend\n\n# .... \nclass ApplicationController\n  before_action :store_request\n\n  private\n  def store_request\n    ThreadLocalRequestStore.request = request\n  end\nend\n\n# ...\nclass PostEditService\n  def call(new_body)\n    #...\n    request = ThreadLocalRequestStore.request\n    Rails.logger.info(\"[audit] ip: #{request.ip}, ua: #{request.user_agent}\")\n  end\nend\n```\n\n\u3053\u308c\u306f[Thread#[]=](http://docs.ruby-lang.org/ja/2.1.0/class/Thread.html#I_--5B--5D--3D)\u30e1\u30bd\u30c3\u30c9\u3092\u4f7f\u3063\u3066\u3044\u3066\u3001current\u306e\u30b9\u30ec\u30c3\u30c9\u306e\u30ed\u30fc\u30ab\u30eb\u306a\u3089\u9818\u57df\u306b\u30c7\u30fc\u30bf\u3092\u683c\u7d0d\u3067\u304d\u3066\u307e\u3059\u3002\u3057\u304b\u3057\u3053\u308c\u3067\u3082\u307e\u3060\u30c0\u30e1\u3067\u30011\u30ea\u30af\u30a8\u30b9\u30c8\u3054\u3068\u306bRuby\u30d7\u30ed\u30bb\u30b9\u304c\u7d42\u4e86\u3057\u3066\u304f\u308c\u306a\u3051\u308c\u3070\u3001\u540c\u3058\u30b9\u30ec\u30c3\u30c9\u3092\u4f7f\u3063\u3066\u4f55\u3089\u304b\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u4ee5\u5916\u306e\u51e6\u7406\u304c\u5b9f\u884c\u3055\u308c\u305f\u6642\u306b\u524d\u56de\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3067`ThreadLocalRequestStore`\u306b\u683c\u7d0d\u3057\u305f\u5024\u304c\u524a\u9664\u3055\u308c\u305a\u306b\u6b8b\u3063\u3066\u3057\u307e\u3063\u3066\u3044\u308b\u305f\u3081\u3001\u53c2\u7167\u3055\u308c\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\n\u305d\u3053\u3067[RequestStore](https://github.com/steveklabnik/request_store) gem\u306e\u767b\u5834\u3067\u3059\u3002\u3053\u306egem\u3082\u4e0a\u8a18\u3068\u540c\u69d8Thread.current#[]=\u3092\u5229\u7528\u3057\u3066\u3044\u3066\u3001\u3055\u3089\u306bRack::Middleware\u306e\u5c64\u3067\u3001\u30ea\u30af\u30a8\u30b9\u30c8\u6bce\u306bThread.current\u306e\u5024\u3092\u30af\u30ea\u30a2\u3057\u3066\u3044\u307e\u3059\u3002\u307e\u3041\u4ed5\u7d44\u307f\u306f\u5358\u7d14\u3067\u3059\u826f\u3044\u3067\u3059\u3002\n\n```rb:lib/request_store/middleware.rb\nmodule RequestStore\n  class Middleware\n    def initialize(app)\n      @app = app\n    end\n\n    def call(env)\n      @app.call(env)\n    ensure\n      RequestStore.clear!\n    end\n  end\nend\n```\nhttps://github.com/steveklabnik/request_store/blob/master/lib/request_store/middleware.rb\n\n```rb\nclass ApplicationController\n  before_action :store_request\n\n  private\n  def store_request\n    RequestStore.store[:request] = request\n  end\nend\n\nclass PostsController < ApplicationController\n  def update\n    service = PostEditService.new(Post.find(params[:id])\n    service.call(params[:body])\n    # ...\n  end\nend\n\nclass PostEditService\n  def initialize(post)\n    @post = post\n  end\n\n  def call(body)\n    @post.body = some_normalize(body)\n    #...\n    ActiveSupport::Notification.instrument('posts.audit')\n  end\nend\n\nclass AuditLogger < ActiveSupport::LogSubscriber\n  def posts(event)\n    request = RequestStore.store[:request]\n    info(\"[request] - ip: #{request.ip}, ua: #{request.user_agent}\")\n  end\nend\n\nAuditLogSubscriber.attach_to :audit\n```\n\n\u3053\u308c\u3067\u3088\u3046\u3084\u304f\u30ea\u30af\u30a8\u30b9\u30c8\u6bce\u306b\u30b0\u30ed\u30fc\u30d0\u30eb\u306a\u53c2\u7167\u3067\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u304c\u3084\u308a\u3068\u308a\u51fa\u6765\u308b\u3088\u3046\u306b\u306a\u308a\u3001\u30ed\u30b0\u3092\u6b8b\u3059\u306a\u3069\u306e\u305f\u3081\u3060\u3051\u306b\u5404\u7a2e\u30af\u30e9\u30b9\u306b\u672c\u8cea\u7684\u3067\u306f\u306a\u3044request\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u5f15\u6570\u3068\u3057\u3066\u5f15\u304d\u56de\u3059\u306a\u3069\u306e\u8a2d\u8a08\u3092\u5ec3\u6b62\u3057\u3001ActiveSupport::Notification\u306b\u3088\u308b\u5b9f\u88c5\u306b\u5909\u66f4\u3059\u308b\u3053\u3068\u3082\u53ef\u80fd\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n\u53c2\u8003:\n\n* https://github.com/steveklabnik/request_store\n* http://d.hatena.ne.jp/hirokidaichi/20101102/1288718980\n", "tags": ["Rails", "rack", "Ruby"]}