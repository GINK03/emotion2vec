{"context": " More than 1 year has passed since last update.\n\n\u3053\u306e\u30cf\u30f3\u30ba\u30aa\u30f3\u306b\u3064\u3044\u3066\n\n\u3053\u306e\u30cf\u30f3\u30ba\u30aa\u30f3\u3067\u306f\u3001Directory Service\u3067\u4f5c\u6210\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u30e6\u30fc\u30b6\u3067Management Console\u306b\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u307e\u3067\u306e\u4f5c\u696d\u3092\u5b9f\u65bd\u3057\u307e\u3059\u3002\n\u4eca\u56de\u306e\u30cf\u30f3\u30ba\u30aa\u30f3\u3067\u306f\u3001AD-Connector\u306f\u5bfe\u8c61\u5916\u3068\u3057\u307e\u3059\u3002\n\u4e00\u90e8\u306e\u64cd\u4f5c\u306fManagement Console\u3067\u5b9f\u65bd\u3057\u307e\u3059\u3002\nMac\u3092\u304a\u4f7f\u3044\u306e\u65b9\u306f\u3001Windows Server\u3067\u30ea\u30e2\u30fc\u30c8\u30c7\u30b9\u30af\u30c8\u30c3\u30d7\u63a5\u7d9a\u304c\u51fa\u6765\u308b\u30a2\u30d7\u30ea\u3092\u3054\u7528\u610f\u304f\u3060\u3055\u3044\u3002\nWindows Server\u3092\u30c9\u30e1\u30a4\u30f3\u306b\u53c2\u52a0\u3055\u305b\u308b\u305f\u3081\u3001SSM\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002SSM\u304c\u5229\u7528\u53ef\u80fd\u306a\u30ea\u30fc\u30b8\u30e7\u30f3\u3092\u5229\u7528\u3057\u3066\u304f\u3060\u3055\u3044\u3002\u3053\u306e\u624b\u9806\u3067\u306f\u30aa\u30ec\u30b4\u30f3\u3092\u5229\u7528\u3057\u307e\u3059\u3002\n\n\n\u524d\u63d0\u6761\u4ef6\n\n\u30d0\u30fc\u30b8\u30e7\u30f3\u78ba\u8a8d\n\u3053\u306e\u30cf\u30f3\u30ba\u30aa\u30f3\u306f\u4ee5\u4e0b\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u52d5\u4f5c\u78ba\u8a8d\u3092\u884c\u3044\u307e\u3057\u305f\u3002\n\n\u30b3\u30de\u30f3\u30c9\naws --version\n\n\n\n\u7d50\u679c\naws-cli/1.9.5 Python/2.7.10 Linux/4.1.10-17.31.amzn1.x86_64 botocore/1.3.5\n\n\n\n\u5fc5\u8981\u306a\u6a29\u9650\n\u4f5c\u696d\u306b\u3042\u305f\u3063\u3066\u306f\u3001\u4ee5\u4e0b\u306e\u6a29\u9650\u3092\u6709\u3057\u305fIAM\u30e6\u30fc\u30b6\u3082\u3057\u304f\u306fIAM\u30ed\u30fc\u30eb\u3092\u5229\u7528\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\nEC2\u306b\u5bfe\u3059\u308b\u30d5\u30eb\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u6a29\u9650\nDirectory Service\u306b\u95a2\u3059\u308b\u30d5\u30eb\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u6a29\u9650\nIAM\u306b\u95a2\u3059\u308b\u30d5\u30eb\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u6a29\u9650\nSSM\u306b\u95a2\u3059\u308b\u30d5\u30eb\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u6a29\u9650\n\n\n0. \u6e96\u5099\n\n\u30ea\u30fc\u30b8\u30e7\u30f3\u3092\u6307\u5b9a\n\n\u30b3\u30de\u30f3\u30c9\nexport AWS_DEFAULT_REGION='us-west-2'\n\n\n\n\u8cc7\u683c\u60c5\u5831\u3092\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws configure list\n\n\n\n\u7d50\u679c\n      Name                    Value             Type    Location\n      ----                    -----             ----    --------\n   profile                <not set>             None    None\naccess_key     ****************PZ4A         iam-role\nsecret_key     ****************AZ55         iam-role\n    region                us-west-2              env    AWS_DEFAULT_REGION\n\n\n\n1. VPC\u306e\u4f5c\u6210\n\nVPC\u306eCIDR\u3092\u6307\u5b9a\n\n\u30b3\u30de\u30f3\u30c9\nCIDR_BLOCK='10.0.0.0/16'\n\n\n\n\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n   VPC_CIDR_BLOCK: \"${CIDR_BLOCK}\"\n\nETX\n\n\n\n\u7d50\u679c\n   VPC_CIDR_BLOCK: \"10.0.0.0/16\"\n\n\n\nVPC\u3092\u4f5c\u6210\n\n\u30b3\u30de\u30f3\u30c9\nVPC_ID=`aws ec2 create-vpc --cidr-block ${CIDR_BLOCK} | jq -r .[].VpcId`\necho ${VPC_ID}\n\n\n\n\u7d50\u679c\nvpc-********\n\n\n\nTag\u3092\u4ed8\u4e0e\n\n\u30b3\u30de\u30f3\u30c9\naws ec2 create-tags --resources ${VPC_ID} --tags Key=Name,Value=jawsug-cli\n\n\n\n\u7d50\u679c\n\uff08\u8fd4\u5024\u7121\u3057\uff09\n\n\n\n\u4f5c\u6210\u3057\u305fVPC\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws ec2 describe-vpcs --vpc-ids ${VPC_ID}\n\n\n\n\u7d50\u679c\n{\n    \"Vpcs\": [\n        {\n            \"VpcId\": \"vpc-********\",\n            \"InstanceTenancy\": \"default\",\n            \"Tags\": [\n                {\n                    \"Value\": \"jawsug-cli\",\n                    \"Key\": \"Name\"\n                }\n            ],\n            \"State\": \"available\",\n            \"DhcpOptionsId\": \"dopt-********\",\n            \"CidrBlock\": \"10.0.0.0/16\",\n            \"IsDefault\": false\n        }\n    ]\n}\n\n\n\n2. Internet Gateway\u306e\u4f5c\u6210\u3001\u30a2\u30bf\u30c3\u30c1\n\n\u30a4\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u306e\u4f5c\u6210\n\n\u30b3\u30de\u30f3\u30c9\nIGW_ID=`aws ec2 create-internet-gateway | jq -r .[].InternetGatewayId`\necho ${IGW_ID}\n\n\n\n\u7d50\u679c\nigw-********\n\n\n\nTag\u3092\u4ed8\u4e0e\n\n\u30b3\u30de\u30f3\u30c9\naws ec2 create-tags --resources ${IGW_ID} --tags Key=Name,Value=jawsug-cli\n\n\n\n\u7d50\u679c\n\uff08\u8fd4\u5024\u7121\u3057\uff09\n\n\n\n\u4f5c\u6210\u3057\u305fInternet Gateway\u3092\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws ec2 describe-internet-gateways --internet-gateway-ids ${IGW_ID}\n\n\n\n\u7d50\u679c\n{\n    \"InternetGateways\": [\n        {\n            \"Tags\": [\n                {\n                    \"Value\": \"jawsug-cli\",\n                    \"Key\": \"Name\"\n                }\n            ],\n            \"InternetGatewayId\": \"igw-********\",\n            \"Attachments\": []\n        }\n    ]\n}\n\n\n\n\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n   VPC_ID: \"${VPC_ID}\"\n   InternetGateat_ID: \"${IGW_ID}\"\n\nETX\n\n\n\n\u7d50\u679c\n   VPC_ID: \"vpc-********\"\n   InternetGateat_ID: \"igw-********\"\n\n\n\nVPC\u306b\u30a4\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u3092\u30a2\u30bf\u30c3\u30c1\n\n\u30b3\u30de\u30f3\u30c9\naws ec2 attach-internet-gateway --internet-gateway-id ${IGW_ID} --vpc-id ${VPC_ID}\n\n\n\n\u7d50\u679c\n(\u8fd4\u5024\u306a\u3057)\n\n\n\n\u30a2\u30bf\u30c3\u30c1\u3057\u305f\u7d50\u679c\u3092\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws ec2 describe-internet-gateways --internet-gateway-ids ${IGW_ID}\n\n\n\n\u7d50\u679c\n{\n    \"InternetGateways\": [\n        {\n            \"Tags\": [\n                {\n                    \"Value\": \"jawsug-cli\",\n                    \"Key\": \"Name\"\n                }\n            ],\n            \"InternetGatewayId\": \"igw-********\",\n            \"Attachments\": [\n                {\n                    \"State\": \"available\",\n                    \"VpcId\": \"vpc-********\"\n                }\n            ]\n        }\n    ]\n}\n\n\n\n3. Subnet\u306e\u4f5c\u6210\nSimple-AD\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306f2\u91cd\u5316\u3055\u308c\u308b\u305f\u3081\u3001\u7570\u306a\u308bAvailability-Zone\u306e\u30b5\u30d6\u30cd\u30c3\u30c8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\uff08\u30aa\u30ec\u30b4\u30f3\u306e\u5834\u5408\u3001a, b, c\u306e3\u3064\u304b\u3089\u9078\u629e\u53ef\u80fd\u3067\u3059\u3002\uff09\n\n\u30b5\u30d6\u30cd\u30c3\u30c8\u3092\u6307\u5b9a\n\n\u30b3\u30de\u30f3\u30c9\nCIDR_BLOCK_SUBNET_A='10.0.0.0/24'\nCIDR_BLOCK_SUBNET_C='10.0.1.0/24'\n\n\n\n\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n   VPC_ID: \"${VPC_ID}\"\n   Subnet_CIDR_BLOCK_on_${AWS_DEFAULT_REGION}a: \"${CIDR_BLOCK_SUBNET_A}\"\n   Subnet_CIDR_BLOCK_on_${AWS_DEFAULT_REGION}c: \"${CIDR_BLOCK_SUBNET_C}\"\n\nETX\n\n\n\n\u7d50\u679c\n   VPC_ID: \"vpc-********\"\n   Subnet_CIDR_BLOCK_on_us-west-2a: \"10.0.0.0/24\"\n   Subnet_CIDR_BLOCK_on_us-west-2c: \"10.0.1.0/24\"\n\n\n\n\u30b5\u30d6\u30cd\u30c3\u30c8\u3092\u4f5c\u6210\n\n\u30b3\u30de\u30f3\u30c9\nSUBNET_A_ID=`aws ec2 create-subnet --vpc-id ${VPC_ID} --cidr-block ${CIDR_BLOCK_SUBNET_A} --availability-zone ${AWS_DEFAULT_REGION}a | jq -r .[].SubnetId`\necho ${SUBNET_A_ID}\n\n\n\n\u30b3\u30de\u30f3\u30c9\nSUBNET_C_ID=`aws ec2 create-subnet --vpc-id ${VPC_ID} --cidr-block ${CIDR_BLOCK_SUBNET_C} --availability-zone ${AWS_DEFAULT_REGION}c | jq -r .[].SubnetId`\necho ${SUBNET_C_ID}\n\n\n\n\u4f5c\u6210\u3057\u305f\u30b5\u30d6\u30cd\u30c3\u30c8\u3092\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws ec2 describe-subnets --subnet-ids ${SUBNET_A_ID} ${SUBNET_C_ID}\n\n\n\n\u7d50\u679c\n{\n    \"Subnets\": [\n        {\n            \"VpcId\": \"vpc-********\",\n            \"CidrBlock\": \"10.0.0.0/24\",\n            \"MapPublicIpOnLaunch\": false,\n            \"DefaultForAz\": false,\n            \"State\": \"available\",\n            \"AvailabilityZone\": \"us-west-2a\",\n            \"SubnetId\": \"subnet-********\",\n            \"AvailableIpAddressCount\": 251\n        },\n        {\n            \"VpcId\": \"vpc-********\",\n            \"CidrBlock\": \"10.0.1.0/24\",\n            \"MapPublicIpOnLaunch\": false,\n            \"DefaultForAz\": false,\n            \"State\": \"available\",\n            \"AvailabilityZone\": \"us-west-2c\",\n            \"SubnetId\": \"subnet-********\",\n            \"AvailableIpAddressCount\": 251\n        }\n    ]\n}\n\n\n\n4. Route Table\u306e\u7de8\u96c6\n\n\u4f5c\u6210\u3057\u305fVPC\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30eb\u30fc\u30c8\u30c6\u30fc\u30d6\u30ebID\u3092\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\nROUTE_TABLE_ID=`aws ec2 describe-route-tables --query RouteTables[?VpcId==\\'${VPC_ID}\\'].[RouteTableId] | jq -r \".[] | .[]\"`\necho ${ROUTE_TABLE_ID}\n\n\n\n\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n   RouteTable_ID: \"${ROUTE_TABLE_ID}\"\n   InternetGateat_ID: \"${IGW_ID}\"\n\nETX\n\n\n\n\u7d50\u679c\n   RouteTable_ID: \"rtb-********\"\n   InternetGateat_ID: \"igw-********\"\n\n\n\n\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30eb\u30fc\u30c8\u30c6\u30fc\u30d6\u30eb\u306b\u30c7\u30d5\u30a9\u30eb\u30c8\u30eb\u30fc\u30c8\u3092\u8ffd\u52a0\n\n\u30b3\u30de\u30f3\u30c9\naws ec2 create-route --route-table-id ${ROUTE_TABLE_ID} --destination-cidr-block '0.0.0.0/0' --gateway-id ${IGW_ID}\n\n\n\n\u7d50\u679c\n{\n    \"Return\": true\n}\n\n\n\n\u30eb\u30fc\u30c8\u30c6\u30fc\u30d6\u30eb\u306b\u8ffd\u52a0\u3057\u305f\u30eb\u30fc\u30c8\u3092\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws ec2 describe-route-tables --query RouteTables[?VpcId==\\'${VPC_ID}\\']\n\n\n\n\u7d50\u679c\n[\n    {\n        \"Associations\": [\n            {\n                \"RouteTableAssociationId\": \"rtbassoc-********\",\n                \"Main\": true,\n                \"RouteTableId\": \"rtb-********\"\n            }\n        ],\n        \"RouteTableId\": \"rtb-********\",\n        \"VpcId\": \"vpc-********\",\n        \"PropagatingVgws\": [],\n        \"Tags\": [],\n        \"Routes\": [\n            {\n                \"GatewayId\": \"local\",\n                \"DestinationCidrBlock\": \"10.0.0.0/16\",\n                \"State\": \"active\",\n                \"Origin\": \"CreateRouteTable\"\n            },\n            {\n                \"GatewayId\": \"igw-********\",\n                \"DestinationCidrBlock\": \"0.0.0.0/0\",\n                \"State\": \"active\",\n                \"Origin\": \"CreateRoute\"\n            }\n        ]\n    }\n]\n\n\n\n5. Sucurity Group\u306e\u4f5c\u6210\u3001\u8a2d\u5b9a\n\nSecurity Group\u306e\u540d\u524d\u3092\u8a2d\u5b9a\n\n\u30b3\u30de\u30f3\u30c9\nSG_GROUP_NAME='WindowsServer'\nSG_DESCRIPTION='RemoteDesktop'\n\n\n\n\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n   SG_GROUP_NAME: ${SG_GROUP_NAME}\n   SG_DESCRIPTION: ${SG_DESCRIPTION}\n\nETX\n\n\n\n\u7d50\u679c\n   SG_GROUP_NAME: WindowsServer\n   SG_DESCRIPTION: RemoteDesktop\n\n\n\n\u30e6\u30fc\u30b6\u4f5c\u6210\u7528\u306eEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u8a2d\u5b9a\u3059\u308bSecurity Group\u3092\u4f5c\u6210\n\n\u30b3\u30de\u30f3\u30c9\naws ec2 create-security-group --group-name ${SG_GROUP_NAME} --description ${SG_DESCRIPTION} --vpc-id ${VPC_ID}\n\n\n\n\u7d50\u679c\n{\n    \"GroupId\": \"sg-********\"\n}\n\n\n\n\u30b3\u30de\u30f3\u30c9\nSG_ID=`aws ec2 describe-security-groups --filter Name=group-name,Values=\"${SG_GROUP_NAME}\" | jq -r \" .[] | .[] | .GroupId\"`\necho ${SG_ID}\n\n\n\n\u7d50\u679c\nsg-********\n\n\n\n\u4f5c\u6210\u3057\u305fSecurity Group\u3092\u78ba\u8a8d\n\uff08\u30a2\u30a6\u30c8\u30d0\u30a6\u30f3\u30c9\u306e\u901a\u4fe1\u306e\u307f\u5168\u3066\u8a31\u53ef\u3059\u308b\u8a2d\u5b9a\u306e\u307f\u3001\u304c\u30c7\u30d5\u30a9\u30eb\u30c8\uff09\n\n\u30b3\u30de\u30f3\u30c9\naws ec2 describe-security-groups --group-ids ${SG_ID}\n\n\n\n\u7d50\u679c\n{\n    \"SecurityGroups\": [\n        {\n            \"IpPermissionsEgress\": [\n                {\n                    \"IpProtocol\": \"-1\",\n                    \"IpRanges\": [\n                        {\n                            \"CidrIp\": \"0.0.0.0/0\"\n                        }\n                    ],\n                    \"UserIdGroupPairs\": [],\n                    \"PrefixListIds\": []\n                }\n            ],\n            \"Description\": \"RemoteDesktop\",\n            \"IpPermissions\": [],\n            \"GroupName\": \"WindowsServer\",\n            \"VpcId\": \"vpc-********\",\n            \"OwnerId\": \"************\",\n            \"GroupId\": \"sg-********\"\n        }\n    ]\n}\n\n\n\n\u30a4\u30f3\u30d0\u30a6\u30f3\u30c9\u306e\u30eb\u30fc\u30eb\u3092\u8ffd\u52a0\n\uff08\u30ea\u30e2\u30fc\u30c8\u30c7\u30b9\u30af\u30c8\u30c3\u30d7\u63a5\u7d9a\u3092\u8a31\u53ef\uff09\n\u63a5\u7d9a\u5143\u306eIP\u30a2\u30c9\u30ec\u30b9\u3092\u5236\u9650\u3057\u305f\u3044\u5834\u5408\u306b\u306f\u3001\u78ba\u8a8d\u541b\u306a\u3069\u3067IP\u30a2\u30c9\u30ec\u30b9\u3092\u78ba\u8a8d\u3057\u3066\u304f\u3060\u3055\u3044\u3002\nhttp://www.ugtop.com/spill.shtml\n\n\u30b3\u30de\u30f3\u30c9\naws ec2 authorize-security-group-ingress --group-id ${SG_ID} --protocol 'tcp' --port 3389 --cidr 0.0.0.0/0\n\n\n\n\u8ffd\u52a0\u3055\u308c\u305f\u30eb\u30fc\u30eb\u3092\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws ec2 describe-security-groups --group-ids ${SG_ID}\n\n\n\n\u7d50\u679c\n{\n    \"SecurityGroups\": [\n        {\n            \"IpPermissionsEgress\": [\n                {\n                    \"IpProtocol\": \"-1\",\n                    \"IpRanges\": [\n                        {\n                            \"CidrIp\": \"0.0.0.0/0\"\n                        }\n                    ],\n                    \"UserIdGroupPairs\": [],\n                    \"PrefixListIds\": []\n                }\n            ],\n            \"Description\": \"RemoteDesktop\",\n            \"IpPermissions\": [\n                {\n                    \"PrefixListIds\": [],\n                    \"FromPort\": 3389,\n                    \"IpRanges\": [\n                        {\n                            \"CidrIp\": \"0.0.0.0/0\"\n                        }\n                    ],\n                    \"ToPort\": 3389,\n                    \"IpProtocol\": \"tcp\",\n                    \"UserIdGroupPairs\": []\n                }\n            ],\n            \"GroupName\": \"WindowsServer\",\n            \"VpcId\": \"vpc-********\",\n            \"OwnerId\": \"************\",\n            \"GroupId\": \"sg-********\"\n        }\n    ]\n}\n\n\n\n6. Key Pair\u306e\u4f5c\u6210\n\nKeyPair\u306e\u540d\u524d\u304a\u3088\u3073\u79d8\u5bc6\u9375\u306e\u30d5\u30a1\u30a4\u30eb\u540d\u3092\u8a2d\u5b9a\n\n\u30b3\u30de\u30f3\u30c9\nKEY_PAIR_NAME='UserManagementServer'\nKEY_MATERIAL_FILE='key.pem'\n\n\n\n\u540c\u540d\u306eKey Pair\u304a\u3088\u3073\u79d8\u5bc6\u9375\u30d5\u30a1\u30a4\u30eb\u304c\u5b58\u5728\u3057\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws ec2 describe-key-pairs --key-names ${KEY_PAIR_NAME}\n\n\n\n\u7d50\u679c\nA client error (InvalidKeyPair.NotFound) occurred when calling the DescribeKeyPairs operation: The key pair 'UserManagementServer' does not exist\n\n\n\n\u30b3\u30de\u30f3\u30c9\nls -al ~/.ssh | grep ${KEY_MATERIAL_FILE}\n\n\n\n\u7d50\u679c\n\uff08\u8fd4\u5024\u7121\u3057\uff09\n\n\n\n\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n   KEY_PAIR_NAME: ${KEY_PAIR_NAME}\n   KEY_MATERIAL_FILE: ${KEY_MATERIAL_FILE}\n\nETX\n\n\n\n\u7d50\u679c\n   KEY_PAIR_NAME: UserManagementServer\n   KEY_MATERIAL_FILE: key.pem\n\n\n\nKeyPair\u306e\u4f5c\u6210\n\n\u30b3\u30de\u30f3\u30c9\naws ec2 create-key-pair --key-name ${KEY_PAIR_NAME} | jq -r .KeyMaterial > ~/.ssh/${KEY_MATERIAL_FILE}\n\n\n\nKey Pair\u304c\u4f5c\u6210\u3055\u308c\u305f\u3053\u3068\u3092\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws ec2 describe-key-pairs --key-names ${KEY_PAIR_NAME}\n\n\n\n\u7d50\u679c\n{\n    \"KeyPairs\": [\n        {\n            \"KeyName\": \"UserManagementServer\",\n            \"KeyFingerprint\": \"**:**:**:**:**:**:**:**:**:**:**:**:**:**:**:**:**:**:**:**\"\n        }\n    ]\n}\n\n\n\n7. \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n\n\u540c\u540d\u306e\u30ed\u30fc\u30eb\u304c\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\nSSM_ROLE_NAME='ssm-role'\naws iam get-role --role-name ${SSM_ROLE_NAME}\n\n\n\n\u7d50\u679c\nA client error (NoSuchEntity) occurred when calling the GetRole operation: The role with name ssm-role cannot be found.\n\n\n\n\u4fe1\u983c\u95a2\u4fc2\u306e\u5b9a\u7fa9\n\n\u30b3\u30de\u30f3\u30c9\nTRUST_POLICY_DOMAIN_JOIN_FILE='Trust-Policy-domain-join.json'\n\n\n\n\u30b3\u30de\u30f3\u30c9\ncat << EOF > ${TRUST_POLICY_DOMAIN_JOIN_FILE}\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": \"ec2.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRole\"\n    }\n  ]\n}\nEOF\n\n\nJSON\u30d5\u30a1\u30a4\u30eb\u3092\u691c\u8a3c\n\n\u30b3\u30de\u30f3\u30c9\njsonlint -q ${TRUST_POLICY_DOMAIN_JOIN_FILE}\n\n\n\nIAM\u30ed\u30fc\u30eb\u306e\u4f5c\u6210\n\n\u30b3\u30de\u30f3\u30c9\naws iam create-role --role-name ${SSM_ROLE_NAME} --assume-role-policy-document file://${TRUST_POLICY_DOMAIN_JOIN_FILE}\n\n\n\n\u7d50\u679c\n{\n    \"Role\": {\n        \"AssumeRolePolicyDocument\": {\n            \"Version\": \"2012-10-17\",\n            \"Statement\": [\n                {\n                    \"Action\": \"sts:AssumeRole\",\n                    \"Principal\": {\n                        \"Service\": \"ec2.amazonaws.com\"\n                    },\n                    \"Effect\": \"Allow\",\n                    \"Sid\": \"\"\n                }\n            ]\n        },\n        \"RoleId\": \"A********************\",\n        \"CreateDate\": \"2015-10-25T14:30:52.049Z\",\n        \"RoleName\": \"ssm-role\",\n        \"Path\": \"/\",\n        \"Arn\": \"arn:aws:iam::************:role/ssm-role\"\n    }\n}\n\n\n\nIAM\u30ed\u30fc\u30eb\u306bManaged Policy\u3092\u30a2\u30bf\u30c3\u30c1\n\n\u30b3\u30de\u30f3\u30c9\nSSM_POLICY_ARN='arn:aws:iam::aws:policy/AmazonSSMFullAccess'\naws iam attach-role-policy --role-name ${SSM_ROLE_NAME} --policy-arn ${SSM_POLICY_ARN}\n\n\n\n\u7d50\u679c\n\uff08\u8fd4\u5024\u7121\u3057\uff09\n\n\n\nIAM Role\u306b\u30dd\u30ea\u30b7\u30fc\u304c\u30a2\u30bf\u30c3\u30c1\u3055\u308c\u305f\u3053\u3068\u3092\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws iam list-attached-role-policies --role-name ${SSM_ROLE_NAME}\n\n\n\n\u7d50\u679c\n{\n    \"AttachedPolicies\": [\n        {\n            \"PolicyName\": \"AmazonSSMFullAccess\",\n            \"PolicyArn\": \"arn:aws:iam::aws:policy/AmazonSSMFullAccess\"\n        }\n    ]\n}\n\n\n\n\u540c\u540d\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u304c\u5b58\u5728\u3057\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws iam get-instance-profile --instance-profile-name ${SSM_ROLE_NAME}\n\n\n\n\u7d50\u679c\nA client error (NoSuchEntity) occurred when calling the GetInstanceProfile operation: Instance Profile ssm-role cannot be found.\n\n\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\n\n\u30b3\u30de\u30f3\u30c9\naws iam create-instance-profile --instance-profile-name ${SSM_ROLE_NAME}\n\n\n\n\u7d50\u679c\n{\n    \"InstanceProfile\": {\n        \"InstanceProfileId\": \"A********************\",\n        \"Roles\": [],\n        \"CreateDate\": \"2015-10-25T14:42:25.839Z\",\n        \"InstanceProfileName\": \"ssm-role\",\n        \"Path\": \"/\",\n        \"Arn\": \"arn:aws:iam::************:instance-profile/ssm-role\"\n    }\n}\n\n\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u304c\u4f5c\u6210\u3055\u308c\u305f\u3053\u3068\u3092\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws iam get-instance-profile --instance-profile-name ${SSM_ROLE_NAME}\n\n\n\n\u7d50\u679c\n{\n    \"InstanceProfile\": {\n        \"InstanceProfileId\": \"A********************\",\n        \"Roles\": [],\n        \"CreateDate\": \"2015-10-25T14:42:25Z\",\n        \"InstanceProfileName\": \"ssm-role\",\n        \"Path\": \"/\",\n        \"Arn\": \"arn:aws:iam::************:instance-profile/ssm-role\"\n    }\n}\n\n\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u306bIAM Role\u3092\u8ffd\u52a0\n\n\u30b3\u30de\u30f3\u30c9\naws iam add-role-to-instance-profile --instance-profile-name ${SSM_ROLE_NAME} --role-name ${SSM_ROLE_NAME}\n\n\n\n\u7d50\u679c\n\uff08\u8fd4\u5024\u7121\u3057\uff09\n\n\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u306bIAM Role\u304c\u8ffd\u52a0\u3055\u308c\u305f\u3053\u3068\u3092\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws iam get-instance-profile --instance-profile-name ${SSM_ROLE_NAME}\n\n\n\n\u7d50\u679c\n{\n    \"InstanceProfile\": {\n        \"InstanceProfileId\": \"A********************\",\n        \"Roles\": [\n            {\n                \"AssumeRolePolicyDocument\": {\n                    \"Version\": \"2012-10-17\",\n                    \"Statement\": [\n                        {\n                            \"Action\": \"sts:AssumeRole\",\n                            \"Principal\": {\n                                \"Service\": \"ec2.amazonaws.com\"\n                            },\n                            \"Effect\": \"Allow\",\n                            \"Sid\": \"\"\n                        }\n                    ]\n                },\n                \"RoleId\": \"A********************\",\n                \"CreateDate\": \"2015-10-25T14:30:52Z\",\n                \"RoleName\": \"ssm-role\",\n                \"Path\": \"/\",\n                \"Arn\": \"arn:aws:iam::************:role/ssm-role\"\n            }\n        ],\n        \"CreateDate\": \"2015-10-25T14:42:25Z\",\n        \"InstanceProfileName\": \"ssm-role\",\n        \"Path\": \"/\",\n        \"Arn\": \"arn:aws:iam::************:instance-profile/ssm-role\"\n    }\n}\n\n\n\n8. EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u4f5c\u6210\n\nWindows Server\u306e\u6700\u65b0AMI\u306eImage ID\u3092\u78ba\u8a8d\nWindows Server 2012 R2\u3092\u5229\u7528\u3057\u305f\u304b\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u306a\u305c\u304b\u30e6\u30fc\u30b6\u306e\u4f5c\u6210\u306b\u5931\u6557\u3059\u308b\u305f\u3081\u3001Windows Server 2012\u3092\u5229\u7528\u3057\u307e\u3059\u3002\n\uff08\u30d5\u30a9\u30fc\u30e9\u30e0\u306b\u3044\u304f\u3064\u304b\u4e0d\u5177\u5408\u5831\u544a\u3042\u308a\uff09\nAdding a User to a Simple AD instance generates error.\nWindows Server 2012\u306eAMI\u306e\u3046\u3061\u3001\u4f5c\u6210\u65e5\u304c\u6700\u65b0\u306eAMI\u3092\u5229\u7528\u3057\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\nAMI_ID=`aws ec2 describe-images --owners amazon --filters Name=description,Values='Microsoft Windows Server 2012 RTM 64-bit Locale English Base AMI provided by Amazon' | jq -r \".[] | sort_by(.CreationDate) | .[] | .ImageId\" | awk 'END {print}'` && echo ${AMI_ID}\n\n\n\n\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\nAWS_ID=$( \\\n        aws iam get-user \\\n          --query 'User.Arn' \\\n          --output text | \\\n          sed 's/^.*:://' | \\\n          sed 's/:.*$//' \\\n      ) \\\n        && echo ${AWS_ID}\n\n\n\n\u7d50\u679c\n************\n\n\n\n\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n   AWS_ID: ${AWS_ID}\n   AMI_ID: \"${AMI_ID}\"\n   KEY_PAIR_NAME: ${KEY_PAIR_NAME}\n   SecurityGroup_ID: \"${SG_ID}\"\n   Subnet_ID: \"${SUBNET_A_ID}\"\n   Instance Profile ARN: arn:aws:iam::${AWS_ID}:instance-profile/${SSM_ROLE_NAME}\n\nETX\n\n\n\n\u7d50\u679c\n   AWS_ID: ************\n   AMI_ID: \"ami-********\"\n   KEY_PAIR_NAME: UserManagementServer\n   SecurityGroup_ID: \"sg-********\"\n   Subnet_ID: \"subnet-********\"\n   Instance Profile ARN: arn:aws:iam::************:instance-profile/ssm-role\n\n\n\nEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u4f5c\u6210\n\u3053\u3053\u3067\u306f\u7121\u6599\u67a0\u306e\u5bfe\u8c61\u3067\u3042\u308bt2.micro\u3092\u5229\u7528\u3057\u3066\u3044\u307e\u3059\u304c\u3001\u52d5\u304d\u304c\u304b\u306a\u308a\u3082\u3063\u3055\u308a\u3067\u3059\u3002\n\u30a4\u30e9\u30a4\u30e9\u3057\u305f\u304f\u306a\u3044\u65b9\u306f\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30bf\u30a4\u30d7\u3092\u5909\u66f4\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u30b3\u30de\u30f3\u30c9\nINSTANCE_ID=`aws ec2 run-instances --image-id ${AMI_ID} --key-name ${KEY_PAIR_NAME} --security-group-ids ${SG_ID} --instance-type 't2.micro' --subnet-id ${SUBNET_A_ID} --associate-public-ip-address --iam-instance-profile Arn=arn:aws:iam::${AWS_ID}:instance-profile/${SSM_ROLE_NAME} | jq -r \".Instances | .[].InstanceId\"` && echo ${INSTANCE_ID}\n\n\n\nEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u4f5c\u6210\u3055\u308c\u305f\u3053\u3068\u3092\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws ec2 describe-instances --instance-ids ${INSTANCE_ID}\n\n\n\n\u7d50\u679c\n{\n    \"Reservations\": [\n        {\n            \"OwnerId\": \"************\",\n            \"ReservationId\": \"r-********\",\n            \"Groups\": [],\n            \"Instances\": [\n                {\n                    \"Monitoring\": {\n                        \"State\": \"disabled\"\n                    },\n                    \"PublicDnsName\": \"\",\n                    \"Platform\": \"windows\",\n                    \"State\": {\n                        \"Code\": 16,\n                        \"Name\": \"running\"\n                    },\n                    \"EbsOptimized\": false,\n                    \"LaunchTime\": \"2015-10-11T06:45:58.000Z\",\n                    \"PublicIpAddress\": \"**.**.***.***\",\n                    \"PrivateIpAddress\": \"10.0.0.162\",\n                    \"ProductCodes\": [],\n                    \"VpcId\": \"vpc-********\",\n                    \"StateTransitionReason\": \"\",\n                    \"InstanceId\": \"i-********\",\n                    \"ImageId\": \"ami-********\",\n                    \"PrivateDnsName\": \"ip-10-0-0-162.us-west-2.compute.internal\",\n                    \"KeyName\": \"UserManagementServer\",\n                    \"SecurityGroups\": [\n                        {\n                            \"GroupName\": \"WindowsServer\",\n                            \"GroupId\": \"sg-********\"\n                        }\n                    ],\n                    \"ClientToken\": \"\",\n                    \"SubnetId\": \"subnet-********\",\n                    \"InstanceType\": \"t2.medium\",\n                    \"NetworkInterfaces\": [\n                        {\n                            \"Status\": \"in-use\",\n                            \"MacAddress\": \"**:**:**:**:**:**\",\n                            \"SourceDestCheck\": true,\n                            \"VpcId\": \"vpc-********\",\n                            \"Description\": \"\",\n                            \"Association\": {\n                                \"PublicIp\": \"**.**.***.***\",\n                                \"PublicDnsName\": \"\",\n                                \"IpOwnerId\": \"amazon\"\n                            },\n                            \"NetworkInterfaceId\": \"eni-********\",\n                            \"PrivateIpAddresses\": [\n                                {\n                                    \"Association\": {\n                                        \"PublicIp\": \"**.**.***.***\",\n                                        \"PublicDnsName\": \"\",\n                                        \"IpOwnerId\": \"amazon\"\n                                    },\n                                    \"Primary\": true,\n                                    \"PrivateIpAddress\": \"10.0.0.162\"\n                                }\n                            ],\n                            \"Attachment\": {\n                                \"Status\": \"attached\",\n                                \"DeviceIndex\": 0,\n                                \"DeleteOnTermination\": true,\n                                \"AttachmentId\": \"eni-attach-********\",\n                                \"AttachTime\": \"2015-10-11T06:45:58.000Z\"\n                            },\n                            \"Groups\": [\n                                {\n                                    \"GroupName\": \"WindowsServer\",\n                                    \"GroupId\": \"sg-********\"\n                                }\n                            ],\n                            \"SubnetId\": \"subnet-********\",\n                            \"OwnerId\": \"************\",\n                            \"PrivateIpAddress\": \"10.0.0.162\"\n                        }\n                    ],\n                    \"SourceDestCheck\": true,\n                    \"Placement\": {\n                        \"Tenancy\": \"default\",\n                        \"GroupName\": \"\",\n                        \"AvailabilityZone\": \"us-west-2a\"\n                    },\n                    \"Hypervisor\": \"xen\",\n                    \"BlockDeviceMappings\": [\n                        {\n                            \"DeviceName\": \"/dev/sda1\",\n                            \"Ebs\": {\n                                \"Status\": \"attached\",\n                                \"DeleteOnTermination\": true,\n                                \"VolumeId\": \"vol-********\",\n                                \"AttachTime\": \"2015-10-11T06:46:02.000Z\"\n                            }\n                        }\n                    ],\n                    \"Architecture\": \"x86_64\",\n                    \"RootDeviceType\": \"ebs\",\n                    \"RootDeviceName\": \"/dev/sda1\",\n                    \"VirtualizationType\": \"hvm\",\n                    \"AmiLaunchIndex\": 0\n                }\n            ]\n        }\n    ]\n}\n\n\n\n9. Windows\u30d1\u30b9\u30ef\u30fc\u30c9\u306e\u78ba\u8a8d\u3001Public IP\u306e\u78ba\u8a8d\n\n\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n   Instance_ID: \"${INSTANCE_ID}\"\n   KeyMaterialFile: \"${KEY_MATERIAL_FILE}\"\n\nETX\n\n\n\n\u7d50\u679c\n   Instance_ID: \"i-********\"\n   KeyMaterialFile: \"key.pem\"\n\n\n\n\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u5fa9\u53f7\u5316\nEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u4f5c\u6210\u304b\u3089\u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u8868\u793a\u3055\u308c\u308b\u307e\u3067\u306b\u6570\u5206\u306e\u6642\u9593\u304c\u304b\u304b\u308a\u307e\u3059\u3002\n\u3057\u304b\u3057\u3001SSM\u306b\u3088\u308b\u30c9\u30e1\u30a4\u30f3\u53c2\u52a0\u304c\u6210\u529f\u3057\u305f\u5834\u5408\u306b\u306f\u4e0d\u8981\u306a\u305f\u3081\u3001\u6b21\u306e\u624b\u9806\u306b\u9032\u307f\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\naws ec2 get-password-data --instance-id ${INSTANCE_ID} --priv-launch-key ~/.ssh/${KEY_MATERIAL_FILE}\n\n\n\n\u7d50\u679c\n{\n    \"InstanceId\": \"i-********\",\n    \"Timestamp\": \"2015-10-11T06:48:35.000Z\",\n    \"PasswordData\": \"**********\"\n}\n\n\n\n\u30d1\u30d6\u30ea\u30c3\u30afIP\u3092\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\nPUBLIC_IP_ADDRESS=`aws ec2 describe-instances --instance-ids ${INSTANCE_ID} | jq -r \".[] | .[].Instances | .[].PublicIpAddress\"` && echo ${PUBLIC_IP_ADDRESS}\n\n\n\u4ee5\u4e0a\u3067\u3059\u3002\n# \u3053\u306e\u30cf\u30f3\u30ba\u30aa\u30f3\u306b\u3064\u3044\u3066\n\n- \u3053\u306e\u30cf\u30f3\u30ba\u30aa\u30f3\u3067\u306f\u3001Directory Service\u3067\u4f5c\u6210\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u30e6\u30fc\u30b6\u3067Management Console\u306b\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u307e\u3067\u306e\u4f5c\u696d\u3092\u5b9f\u65bd\u3057\u307e\u3059\u3002\n- \u4eca\u56de\u306e\u30cf\u30f3\u30ba\u30aa\u30f3\u3067\u306f\u3001AD-Connector\u306f\u5bfe\u8c61\u5916\u3068\u3057\u307e\u3059\u3002\n- \u4e00\u90e8\u306e\u64cd\u4f5c\u306fManagement Console\u3067\u5b9f\u65bd\u3057\u307e\u3059\u3002\n- Mac\u3092\u304a\u4f7f\u3044\u306e\u65b9\u306f\u3001Windows Server\u3067\u30ea\u30e2\u30fc\u30c8\u30c7\u30b9\u30af\u30c8\u30c3\u30d7\u63a5\u7d9a\u304c\u51fa\u6765\u308b\u30a2\u30d7\u30ea\u3092\u3054\u7528\u610f\u304f\u3060\u3055\u3044\u3002\n- Windows Server\u3092\u30c9\u30e1\u30a4\u30f3\u306b\u53c2\u52a0\u3055\u305b\u308b\u305f\u3081\u3001SSM\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002SSM\u304c\u5229\u7528\u53ef\u80fd\u306a\u30ea\u30fc\u30b8\u30e7\u30f3\u3092\u5229\u7528\u3057\u3066\u304f\u3060\u3055\u3044\u3002\u3053\u306e\u624b\u9806\u3067\u306f\u30aa\u30ec\u30b4\u30f3\u3092\u5229\u7528\u3057\u307e\u3059\u3002\n\n# \u524d\u63d0\u6761\u4ef6\n\n## \u30d0\u30fc\u30b8\u30e7\u30f3\u78ba\u8a8d\n\n\u3053\u306e\u30cf\u30f3\u30ba\u30aa\u30f3\u306f\u4ee5\u4e0b\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u52d5\u4f5c\u78ba\u8a8d\u3092\u884c\u3044\u307e\u3057\u305f\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws --version\n```\n\n```text:\u7d50\u679c\naws-cli/1.9.5 Python/2.7.10 Linux/4.1.10-17.31.amzn1.x86_64 botocore/1.3.5\n```\n\n## \u5fc5\u8981\u306a\u6a29\u9650\n\n\u4f5c\u696d\u306b\u3042\u305f\u3063\u3066\u306f\u3001\u4ee5\u4e0b\u306e\u6a29\u9650\u3092\u6709\u3057\u305fIAM\u30e6\u30fc\u30b6\u3082\u3057\u304f\u306fIAM\u30ed\u30fc\u30eb\u3092\u5229\u7528\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n- EC2\u306b\u5bfe\u3059\u308b\u30d5\u30eb\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u6a29\u9650\n- Directory Service\u306b\u95a2\u3059\u308b\u30d5\u30eb\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u6a29\u9650\n- IAM\u306b\u95a2\u3059\u308b\u30d5\u30eb\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u6a29\u9650\n- SSM\u306b\u95a2\u3059\u308b\u30d5\u30eb\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u6a29\u9650\n\n# 0. \u6e96\u5099\n\n## \u30ea\u30fc\u30b8\u30e7\u30f3\u3092\u6307\u5b9a\n\n```bash:\u30b3\u30de\u30f3\u30c9\nexport AWS_DEFAULT_REGION='us-west-2'\n```\n\n## \u8cc7\u683c\u60c5\u5831\u3092\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws configure list\n```\n\n```text:\u7d50\u679c\n      Name                    Value             Type    Location\n      ----                    -----             ----    --------\n   profile                <not set>             None    None\naccess_key     ****************PZ4A         iam-role\nsecret_key     ****************AZ55         iam-role\n    region                us-west-2              env    AWS_DEFAULT_REGION\n```\n\n# 1. VPC\u306e\u4f5c\u6210\n\n## VPC\u306eCIDR\u3092\u6307\u5b9a\n\n```bash:\u30b3\u30de\u30f3\u30c9\nCIDR_BLOCK='10.0.0.0/16'\n```\n\n## \u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n   VPC_CIDR_BLOCK: \"${CIDR_BLOCK}\"\n\nETX\n```\n\n```text:\u7d50\u679c\n   VPC_CIDR_BLOCK: \"10.0.0.0/16\"\n```\n\n## VPC\u3092\u4f5c\u6210\n\n```bash:\u30b3\u30de\u30f3\u30c9\nVPC_ID=`aws ec2 create-vpc --cidr-block ${CIDR_BLOCK} | jq -r .[].VpcId`\necho ${VPC_ID}\n```\n\n```text:\u7d50\u679c\nvpc-********\n```\n\n## Tag\u3092\u4ed8\u4e0e\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws ec2 create-tags --resources ${VPC_ID} --tags Key=Name,Value=jawsug-cli\n```\n\n```text:\u7d50\u679c\n\uff08\u8fd4\u5024\u7121\u3057\uff09\n```\n\n## \u4f5c\u6210\u3057\u305fVPC\u306e\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws ec2 describe-vpcs --vpc-ids ${VPC_ID}\n```\n\n```json:\u7d50\u679c\n{\n    \"Vpcs\": [\n        {\n            \"VpcId\": \"vpc-********\",\n            \"InstanceTenancy\": \"default\",\n            \"Tags\": [\n                {\n                    \"Value\": \"jawsug-cli\",\n                    \"Key\": \"Name\"\n                }\n            ],\n            \"State\": \"available\",\n            \"DhcpOptionsId\": \"dopt-********\",\n            \"CidrBlock\": \"10.0.0.0/16\",\n            \"IsDefault\": false\n        }\n    ]\n}\n```\n\n# 2. Internet Gateway\u306e\u4f5c\u6210\u3001\u30a2\u30bf\u30c3\u30c1\n\n## \u30a4\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u306e\u4f5c\u6210\n\n```bash:\u30b3\u30de\u30f3\u30c9\nIGW_ID=`aws ec2 create-internet-gateway | jq -r .[].InternetGatewayId`\necho ${IGW_ID}\n```\n\n```text:\u7d50\u679c\nigw-********\n```\n\n## Tag\u3092\u4ed8\u4e0e\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws ec2 create-tags --resources ${IGW_ID} --tags Key=Name,Value=jawsug-cli\n```\n\n```text:\u7d50\u679c\n\uff08\u8fd4\u5024\u7121\u3057\uff09\n```\n\n## \u4f5c\u6210\u3057\u305fInternet Gateway\u3092\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws ec2 describe-internet-gateways --internet-gateway-ids ${IGW_ID}\n```\n\n```json:\u7d50\u679c\n{\n    \"InternetGateways\": [\n        {\n            \"Tags\": [\n                {\n                    \"Value\": \"jawsug-cli\",\n                    \"Key\": \"Name\"\n                }\n            ],\n            \"InternetGatewayId\": \"igw-********\",\n            \"Attachments\": []\n        }\n    ]\n}\n```\n\n## \u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n   VPC_ID: \"${VPC_ID}\"\n   InternetGateat_ID: \"${IGW_ID}\"\n\nETX\n```\n\n```text:\u7d50\u679c\n   VPC_ID: \"vpc-********\"\n   InternetGateat_ID: \"igw-********\"\n```\n\n## VPC\u306b\u30a4\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u3092\u30a2\u30bf\u30c3\u30c1\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws ec2 attach-internet-gateway --internet-gateway-id ${IGW_ID} --vpc-id ${VPC_ID}\n```\n\n```text:\u7d50\u679c\n(\u8fd4\u5024\u306a\u3057)\n```\n\n## \u30a2\u30bf\u30c3\u30c1\u3057\u305f\u7d50\u679c\u3092\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws ec2 describe-internet-gateways --internet-gateway-ids ${IGW_ID}\n```\n\n```json:\u7d50\u679c\n{\n    \"InternetGateways\": [\n        {\n            \"Tags\": [\n                {\n                    \"Value\": \"jawsug-cli\",\n                    \"Key\": \"Name\"\n                }\n            ],\n            \"InternetGatewayId\": \"igw-********\",\n            \"Attachments\": [\n                {\n                    \"State\": \"available\",\n                    \"VpcId\": \"vpc-********\"\n                }\n            ]\n        }\n    ]\n}\n```\n\n# 3. Subnet\u306e\u4f5c\u6210\n\nSimple-AD\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306f2\u91cd\u5316\u3055\u308c\u308b\u305f\u3081\u3001\u7570\u306a\u308bAvailability-Zone\u306e\u30b5\u30d6\u30cd\u30c3\u30c8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\uff08\u30aa\u30ec\u30b4\u30f3\u306e\u5834\u5408\u3001a, b, c\u306e3\u3064\u304b\u3089\u9078\u629e\u53ef\u80fd\u3067\u3059\u3002\uff09\n\n## \u30b5\u30d6\u30cd\u30c3\u30c8\u3092\u6307\u5b9a\n\n```bash:\u30b3\u30de\u30f3\u30c9\nCIDR_BLOCK_SUBNET_A='10.0.0.0/24'\nCIDR_BLOCK_SUBNET_C='10.0.1.0/24'\n```\n\n## \u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n   VPC_ID: \"${VPC_ID}\"\n   Subnet_CIDR_BLOCK_on_${AWS_DEFAULT_REGION}a: \"${CIDR_BLOCK_SUBNET_A}\"\n   Subnet_CIDR_BLOCK_on_${AWS_DEFAULT_REGION}c: \"${CIDR_BLOCK_SUBNET_C}\"\n\nETX\n```\n\n```text:\u7d50\u679c\n   VPC_ID: \"vpc-********\"\n   Subnet_CIDR_BLOCK_on_us-west-2a: \"10.0.0.0/24\"\n   Subnet_CIDR_BLOCK_on_us-west-2c: \"10.0.1.0/24\"\n```\n\n## \u30b5\u30d6\u30cd\u30c3\u30c8\u3092\u4f5c\u6210\n\n```bash:\u30b3\u30de\u30f3\u30c9\nSUBNET_A_ID=`aws ec2 create-subnet --vpc-id ${VPC_ID} --cidr-block ${CIDR_BLOCK_SUBNET_A} --availability-zone ${AWS_DEFAULT_REGION}a | jq -r .[].SubnetId`\necho ${SUBNET_A_ID}\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9\nSUBNET_C_ID=`aws ec2 create-subnet --vpc-id ${VPC_ID} --cidr-block ${CIDR_BLOCK_SUBNET_C} --availability-zone ${AWS_DEFAULT_REGION}c | jq -r .[].SubnetId`\necho ${SUBNET_C_ID}\n```\n\n## \u4f5c\u6210\u3057\u305f\u30b5\u30d6\u30cd\u30c3\u30c8\u3092\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws ec2 describe-subnets --subnet-ids ${SUBNET_A_ID} ${SUBNET_C_ID}\n```\n\n```json:\u7d50\u679c\n{\n    \"Subnets\": [\n        {\n            \"VpcId\": \"vpc-********\",\n            \"CidrBlock\": \"10.0.0.0/24\",\n            \"MapPublicIpOnLaunch\": false,\n            \"DefaultForAz\": false,\n            \"State\": \"available\",\n            \"AvailabilityZone\": \"us-west-2a\",\n            \"SubnetId\": \"subnet-********\",\n            \"AvailableIpAddressCount\": 251\n        },\n        {\n            \"VpcId\": \"vpc-********\",\n            \"CidrBlock\": \"10.0.1.0/24\",\n            \"MapPublicIpOnLaunch\": false,\n            \"DefaultForAz\": false,\n            \"State\": \"available\",\n            \"AvailabilityZone\": \"us-west-2c\",\n            \"SubnetId\": \"subnet-********\",\n            \"AvailableIpAddressCount\": 251\n        }\n    ]\n}\n```\n\n# 4. Route Table\u306e\u7de8\u96c6\n\n## \u4f5c\u6210\u3057\u305fVPC\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30eb\u30fc\u30c8\u30c6\u30fc\u30d6\u30ebID\u3092\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\nROUTE_TABLE_ID=`aws ec2 describe-route-tables --query RouteTables[?VpcId==\\'${VPC_ID}\\'].[RouteTableId] | jq -r \".[] | .[]\"`\necho ${ROUTE_TABLE_ID}\n```\n\n## \u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n   RouteTable_ID: \"${ROUTE_TABLE_ID}\"\n   InternetGateat_ID: \"${IGW_ID}\"\n\nETX\n```\n\n```text:\u7d50\u679c\n   RouteTable_ID: \"rtb-********\"\n   InternetGateat_ID: \"igw-********\"\n```\n\n## \u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30eb\u30fc\u30c8\u30c6\u30fc\u30d6\u30eb\u306b\u30c7\u30d5\u30a9\u30eb\u30c8\u30eb\u30fc\u30c8\u3092\u8ffd\u52a0\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws ec2 create-route --route-table-id ${ROUTE_TABLE_ID} --destination-cidr-block '0.0.0.0/0' --gateway-id ${IGW_ID}\n```\n\n```text:\u7d50\u679c\n{\n    \"Return\": true\n}\n```\n\n## \u30eb\u30fc\u30c8\u30c6\u30fc\u30d6\u30eb\u306b\u8ffd\u52a0\u3057\u305f\u30eb\u30fc\u30c8\u3092\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws ec2 describe-route-tables --query RouteTables[?VpcId==\\'${VPC_ID}\\']\n```\n\n```json:\u7d50\u679c\n[\n    {\n        \"Associations\": [\n            {\n                \"RouteTableAssociationId\": \"rtbassoc-********\",\n                \"Main\": true,\n                \"RouteTableId\": \"rtb-********\"\n            }\n        ],\n        \"RouteTableId\": \"rtb-********\",\n        \"VpcId\": \"vpc-********\",\n        \"PropagatingVgws\": [],\n        \"Tags\": [],\n        \"Routes\": [\n            {\n                \"GatewayId\": \"local\",\n                \"DestinationCidrBlock\": \"10.0.0.0/16\",\n                \"State\": \"active\",\n                \"Origin\": \"CreateRouteTable\"\n            },\n            {\n                \"GatewayId\": \"igw-********\",\n                \"DestinationCidrBlock\": \"0.0.0.0/0\",\n                \"State\": \"active\",\n                \"Origin\": \"CreateRoute\"\n            }\n        ]\n    }\n]\n```\n\n# 5. Sucurity Group\u306e\u4f5c\u6210\u3001\u8a2d\u5b9a\n\n## Security Group\u306e\u540d\u524d\u3092\u8a2d\u5b9a\n\n```bash:\u30b3\u30de\u30f3\u30c9\nSG_GROUP_NAME='WindowsServer'\nSG_DESCRIPTION='RemoteDesktop'\n```\n\n## \u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n   SG_GROUP_NAME: ${SG_GROUP_NAME}\n   SG_DESCRIPTION: ${SG_DESCRIPTION}\n\nETX\n```\n\n```text:\u7d50\u679c\n   SG_GROUP_NAME: WindowsServer\n   SG_DESCRIPTION: RemoteDesktop\n```\n\n## \u30e6\u30fc\u30b6\u4f5c\u6210\u7528\u306eEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u8a2d\u5b9a\u3059\u308bSecurity Group\u3092\u4f5c\u6210\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws ec2 create-security-group --group-name ${SG_GROUP_NAME} --description ${SG_DESCRIPTION} --vpc-id ${VPC_ID}\n```\n\n```json:\u7d50\u679c\n{\n    \"GroupId\": \"sg-********\"\n}\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9\nSG_ID=`aws ec2 describe-security-groups --filter Name=group-name,Values=\"${SG_GROUP_NAME}\" | jq -r \" .[] | .[] | .GroupId\"`\necho ${SG_ID}\n```\n\n```text:\u7d50\u679c\nsg-********\n```\n\n## \u4f5c\u6210\u3057\u305fSecurity Group\u3092\u78ba\u8a8d\n\n\uff08\u30a2\u30a6\u30c8\u30d0\u30a6\u30f3\u30c9\u306e\u901a\u4fe1\u306e\u307f\u5168\u3066\u8a31\u53ef\u3059\u308b\u8a2d\u5b9a\u306e\u307f\u3001\u304c\u30c7\u30d5\u30a9\u30eb\u30c8\uff09\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws ec2 describe-security-groups --group-ids ${SG_ID}\n```\n\n```json:\u7d50\u679c\n{\n    \"SecurityGroups\": [\n        {\n            \"IpPermissionsEgress\": [\n                {\n                    \"IpProtocol\": \"-1\",\n                    \"IpRanges\": [\n                        {\n                            \"CidrIp\": \"0.0.0.0/0\"\n                        }\n                    ],\n                    \"UserIdGroupPairs\": [],\n                    \"PrefixListIds\": []\n                }\n            ],\n            \"Description\": \"RemoteDesktop\",\n            \"IpPermissions\": [],\n            \"GroupName\": \"WindowsServer\",\n            \"VpcId\": \"vpc-********\",\n            \"OwnerId\": \"************\",\n            \"GroupId\": \"sg-********\"\n        }\n    ]\n}\n```\n\n## \u30a4\u30f3\u30d0\u30a6\u30f3\u30c9\u306e\u30eb\u30fc\u30eb\u3092\u8ffd\u52a0\n\n\uff08\u30ea\u30e2\u30fc\u30c8\u30c7\u30b9\u30af\u30c8\u30c3\u30d7\u63a5\u7d9a\u3092\u8a31\u53ef\uff09\n\n\u63a5\u7d9a\u5143\u306eIP\u30a2\u30c9\u30ec\u30b9\u3092\u5236\u9650\u3057\u305f\u3044\u5834\u5408\u306b\u306f\u3001\u78ba\u8a8d\u541b\u306a\u3069\u3067IP\u30a2\u30c9\u30ec\u30b9\u3092\u78ba\u8a8d\u3057\u3066\u304f\u3060\u3055\u3044\u3002\nhttp://www.ugtop.com/spill.shtml\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws ec2 authorize-security-group-ingress --group-id ${SG_ID} --protocol 'tcp' --port 3389 --cidr 0.0.0.0/0\n```\n\n## \u8ffd\u52a0\u3055\u308c\u305f\u30eb\u30fc\u30eb\u3092\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws ec2 describe-security-groups --group-ids ${SG_ID}\n```\n\n```json:\u7d50\u679c\n{\n    \"SecurityGroups\": [\n        {\n            \"IpPermissionsEgress\": [\n                {\n                    \"IpProtocol\": \"-1\",\n                    \"IpRanges\": [\n                        {\n                            \"CidrIp\": \"0.0.0.0/0\"\n                        }\n                    ],\n                    \"UserIdGroupPairs\": [],\n                    \"PrefixListIds\": []\n                }\n            ],\n            \"Description\": \"RemoteDesktop\",\n            \"IpPermissions\": [\n                {\n                    \"PrefixListIds\": [],\n                    \"FromPort\": 3389,\n                    \"IpRanges\": [\n                        {\n                            \"CidrIp\": \"0.0.0.0/0\"\n                        }\n                    ],\n                    \"ToPort\": 3389,\n                    \"IpProtocol\": \"tcp\",\n                    \"UserIdGroupPairs\": []\n                }\n            ],\n            \"GroupName\": \"WindowsServer\",\n            \"VpcId\": \"vpc-********\",\n            \"OwnerId\": \"************\",\n            \"GroupId\": \"sg-********\"\n        }\n    ]\n}\n```\n\n# 6. Key Pair\u306e\u4f5c\u6210\n\n## KeyPair\u306e\u540d\u524d\u304a\u3088\u3073\u79d8\u5bc6\u9375\u306e\u30d5\u30a1\u30a4\u30eb\u540d\u3092\u8a2d\u5b9a\n\n```bash:\u30b3\u30de\u30f3\u30c9\nKEY_PAIR_NAME='UserManagementServer'\nKEY_MATERIAL_FILE='key.pem'\n```\n\n## \u540c\u540d\u306eKey Pair\u304a\u3088\u3073\u79d8\u5bc6\u9375\u30d5\u30a1\u30a4\u30eb\u304c\u5b58\u5728\u3057\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws ec2 describe-key-pairs --key-names ${KEY_PAIR_NAME}\n```\n\n```text:\u7d50\u679c\nA client error (InvalidKeyPair.NotFound) occurred when calling the DescribeKeyPairs operation: The key pair 'UserManagementServer' does not exist\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9\nls -al ~/.ssh | grep ${KEY_MATERIAL_FILE}\n```\n\n```text:\u7d50\u679c\n\uff08\u8fd4\u5024\u7121\u3057\uff09\n```\n\n## \u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n   KEY_PAIR_NAME: ${KEY_PAIR_NAME}\n   KEY_MATERIAL_FILE: ${KEY_MATERIAL_FILE}\n\nETX\n```\n\n```text:\u7d50\u679c\n   KEY_PAIR_NAME: UserManagementServer\n   KEY_MATERIAL_FILE: key.pem\n```\n\n## KeyPair\u306e\u4f5c\u6210\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws ec2 create-key-pair --key-name ${KEY_PAIR_NAME} | jq -r .KeyMaterial > ~/.ssh/${KEY_MATERIAL_FILE}\n```\n\n## Key Pair\u304c\u4f5c\u6210\u3055\u308c\u305f\u3053\u3068\u3092\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws ec2 describe-key-pairs --key-names ${KEY_PAIR_NAME}\n```\n\n```json:\u7d50\u679c\n{\n    \"KeyPairs\": [\n        {\n            \"KeyName\": \"UserManagementServer\",\n            \"KeyFingerprint\": \"**:**:**:**:**:**:**:**:**:**:**:**:**:**:**:**:**:**:**:**\"\n        }\n    ]\n}\n```\n\n# 7. \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n\n## \u540c\u540d\u306e\u30ed\u30fc\u30eb\u304c\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\nSSM_ROLE_NAME='ssm-role'\naws iam get-role --role-name ${SSM_ROLE_NAME}\n```\n\n```text:\u7d50\u679c\nA client error (NoSuchEntity) occurred when calling the GetRole operation: The role with name ssm-role cannot be found.\n```\n\n## \u4fe1\u983c\u95a2\u4fc2\u306e\u5b9a\u7fa9\n\n```bash:\u30b3\u30de\u30f3\u30c9\nTRUST_POLICY_DOMAIN_JOIN_FILE='Trust-Policy-domain-join.json'\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9\ncat << EOF > ${TRUST_POLICY_DOMAIN_JOIN_FILE}\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": \"ec2.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRole\"\n    }\n  ]\n}\nEOF\n```\n\nJSON\u30d5\u30a1\u30a4\u30eb\u3092\u691c\u8a3c\n\n```bash:\u30b3\u30de\u30f3\u30c9\njsonlint -q ${TRUST_POLICY_DOMAIN_JOIN_FILE}\n```\n\n## IAM\u30ed\u30fc\u30eb\u306e\u4f5c\u6210\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws iam create-role --role-name ${SSM_ROLE_NAME} --assume-role-policy-document file://${TRUST_POLICY_DOMAIN_JOIN_FILE}\n```\n\n```json:\u7d50\u679c\n{\n    \"Role\": {\n        \"AssumeRolePolicyDocument\": {\n            \"Version\": \"2012-10-17\",\n            \"Statement\": [\n                {\n                    \"Action\": \"sts:AssumeRole\",\n                    \"Principal\": {\n                        \"Service\": \"ec2.amazonaws.com\"\n                    },\n                    \"Effect\": \"Allow\",\n                    \"Sid\": \"\"\n                }\n            ]\n        },\n        \"RoleId\": \"A********************\",\n        \"CreateDate\": \"2015-10-25T14:30:52.049Z\",\n        \"RoleName\": \"ssm-role\",\n        \"Path\": \"/\",\n        \"Arn\": \"arn:aws:iam::************:role/ssm-role\"\n    }\n}\n```\n\n## IAM\u30ed\u30fc\u30eb\u306bManaged Policy\u3092\u30a2\u30bf\u30c3\u30c1\n\n```bash:\u30b3\u30de\u30f3\u30c9\nSSM_POLICY_ARN='arn:aws:iam::aws:policy/AmazonSSMFullAccess'\naws iam attach-role-policy --role-name ${SSM_ROLE_NAME} --policy-arn ${SSM_POLICY_ARN}\n```\n\n```text:\u7d50\u679c\n\uff08\u8fd4\u5024\u7121\u3057\uff09\n```\n\n## IAM Role\u306b\u30dd\u30ea\u30b7\u30fc\u304c\u30a2\u30bf\u30c3\u30c1\u3055\u308c\u305f\u3053\u3068\u3092\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws iam list-attached-role-policies --role-name ${SSM_ROLE_NAME}\n```\n\n```json:\u7d50\u679c\n{\n    \"AttachedPolicies\": [\n        {\n            \"PolicyName\": \"AmazonSSMFullAccess\",\n            \"PolicyArn\": \"arn:aws:iam::aws:policy/AmazonSSMFullAccess\"\n        }\n    ]\n}\n```\n\n## \u540c\u540d\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u304c\u5b58\u5728\u3057\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws iam get-instance-profile --instance-profile-name ${SSM_ROLE_NAME}\n```\n\n```text:\u7d50\u679c\nA client error (NoSuchEntity) occurred when calling the GetInstanceProfile operation: Instance Profile ssm-role cannot be found.\n```\n\n## \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws iam create-instance-profile --instance-profile-name ${SSM_ROLE_NAME}\n```\n\n```json:\u7d50\u679c\n{\n    \"InstanceProfile\": {\n        \"InstanceProfileId\": \"A********************\",\n        \"Roles\": [],\n        \"CreateDate\": \"2015-10-25T14:42:25.839Z\",\n        \"InstanceProfileName\": \"ssm-role\",\n        \"Path\": \"/\",\n        \"Arn\": \"arn:aws:iam::************:instance-profile/ssm-role\"\n    }\n}\n```\n\n## \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u304c\u4f5c\u6210\u3055\u308c\u305f\u3053\u3068\u3092\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws iam get-instance-profile --instance-profile-name ${SSM_ROLE_NAME}\n```\n\n```json:\u7d50\u679c\n{\n    \"InstanceProfile\": {\n        \"InstanceProfileId\": \"A********************\",\n        \"Roles\": [],\n        \"CreateDate\": \"2015-10-25T14:42:25Z\",\n        \"InstanceProfileName\": \"ssm-role\",\n        \"Path\": \"/\",\n        \"Arn\": \"arn:aws:iam::************:instance-profile/ssm-role\"\n    }\n}\n```\n\n## \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u306bIAM Role\u3092\u8ffd\u52a0\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws iam add-role-to-instance-profile --instance-profile-name ${SSM_ROLE_NAME} --role-name ${SSM_ROLE_NAME}\n```\n\n```text:\u7d50\u679c\n\uff08\u8fd4\u5024\u7121\u3057\uff09\n```\n\n## \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u306bIAM Role\u304c\u8ffd\u52a0\u3055\u308c\u305f\u3053\u3068\u3092\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws iam get-instance-profile --instance-profile-name ${SSM_ROLE_NAME}\n```\n\n```json:\u7d50\u679c\n{\n    \"InstanceProfile\": {\n        \"InstanceProfileId\": \"A********************\",\n        \"Roles\": [\n            {\n                \"AssumeRolePolicyDocument\": {\n                    \"Version\": \"2012-10-17\",\n                    \"Statement\": [\n                        {\n                            \"Action\": \"sts:AssumeRole\",\n                            \"Principal\": {\n                                \"Service\": \"ec2.amazonaws.com\"\n                            },\n                            \"Effect\": \"Allow\",\n                            \"Sid\": \"\"\n                        }\n                    ]\n                },\n                \"RoleId\": \"A********************\",\n                \"CreateDate\": \"2015-10-25T14:30:52Z\",\n                \"RoleName\": \"ssm-role\",\n                \"Path\": \"/\",\n                \"Arn\": \"arn:aws:iam::************:role/ssm-role\"\n            }\n        ],\n        \"CreateDate\": \"2015-10-25T14:42:25Z\",\n        \"InstanceProfileName\": \"ssm-role\",\n        \"Path\": \"/\",\n        \"Arn\": \"arn:aws:iam::************:instance-profile/ssm-role\"\n    }\n}\n```\n\n# 8. EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u4f5c\u6210\n\n## Windows Server\u306e\u6700\u65b0AMI\u306eImage ID\u3092\u78ba\u8a8d\nWindows Server 2012 R2\u3092\u5229\u7528\u3057\u305f\u304b\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u306a\u305c\u304b\u30e6\u30fc\u30b6\u306e\u4f5c\u6210\u306b\u5931\u6557\u3059\u308b\u305f\u3081\u3001Windows Server 2012\u3092\u5229\u7528\u3057\u307e\u3059\u3002\n\uff08\u30d5\u30a9\u30fc\u30e9\u30e0\u306b\u3044\u304f\u3064\u304b\u4e0d\u5177\u5408\u5831\u544a\u3042\u308a\uff09\n[Adding a User to a Simple AD instance generates error.](https://forums.aws.amazon.com/thread.jspa?messageID=678259)\n\nWindows Server 2012\u306eAMI\u306e\u3046\u3061\u3001\u4f5c\u6210\u65e5\u304c\u6700\u65b0\u306eAMI\u3092\u5229\u7528\u3057\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9\nAMI_ID=`aws ec2 describe-images --owners amazon --filters Name=description,Values='Microsoft Windows Server 2012 RTM 64-bit Locale English Base AMI provided by Amazon' | jq -r \".[] | sort_by(.CreationDate) | .[] | .ImageId\" | awk 'END {print}'` && echo ${AMI_ID}\n```\n\n## \u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\nAWS_ID=$( \\\n        aws iam get-user \\\n          --query 'User.Arn' \\\n          --output text | \\\n          sed 's/^.*:://' | \\\n          sed 's/:.*$//' \\\n      ) \\\n        && echo ${AWS_ID}\n```\n\n```text:\u7d50\u679c\n************\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n   AWS_ID: ${AWS_ID}\n   AMI_ID: \"${AMI_ID}\"\n   KEY_PAIR_NAME: ${KEY_PAIR_NAME}\n   SecurityGroup_ID: \"${SG_ID}\"\n   Subnet_ID: \"${SUBNET_A_ID}\"\n   Instance Profile ARN: arn:aws:iam::${AWS_ID}:instance-profile/${SSM_ROLE_NAME}\n\nETX\n```\n\n```text:\u7d50\u679c\n   AWS_ID: ************\n   AMI_ID: \"ami-********\"\n   KEY_PAIR_NAME: UserManagementServer\n   SecurityGroup_ID: \"sg-********\"\n   Subnet_ID: \"subnet-********\"\n   Instance Profile ARN: arn:aws:iam::************:instance-profile/ssm-role\n```\n\n## EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u4f5c\u6210\n\n\u3053\u3053\u3067\u306f\u7121\u6599\u67a0\u306e\u5bfe\u8c61\u3067\u3042\u308bt2.micro\u3092\u5229\u7528\u3057\u3066\u3044\u307e\u3059\u304c\u3001\u52d5\u304d\u304c\u304b\u306a\u308a\u3082\u3063\u3055\u308a\u3067\u3059\u3002\n\u30a4\u30e9\u30a4\u30e9\u3057\u305f\u304f\u306a\u3044\u65b9\u306f\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30bf\u30a4\u30d7\u3092\u5909\u66f4\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9\nINSTANCE_ID=`aws ec2 run-instances --image-id ${AMI_ID} --key-name ${KEY_PAIR_NAME} --security-group-ids ${SG_ID} --instance-type 't2.micro' --subnet-id ${SUBNET_A_ID} --associate-public-ip-address --iam-instance-profile Arn=arn:aws:iam::${AWS_ID}:instance-profile/${SSM_ROLE_NAME} | jq -r \".Instances | .[].InstanceId\"` && echo ${INSTANCE_ID}\n```\n\n## EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u4f5c\u6210\u3055\u308c\u305f\u3053\u3068\u3092\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws ec2 describe-instances --instance-ids ${INSTANCE_ID}\n```\n\n```json:\u7d50\u679c\n{\n    \"Reservations\": [\n        {\n            \"OwnerId\": \"************\",\n            \"ReservationId\": \"r-********\",\n            \"Groups\": [],\n            \"Instances\": [\n                {\n                    \"Monitoring\": {\n                        \"State\": \"disabled\"\n                    },\n                    \"PublicDnsName\": \"\",\n                    \"Platform\": \"windows\",\n                    \"State\": {\n                        \"Code\": 16,\n                        \"Name\": \"running\"\n                    },\n                    \"EbsOptimized\": false,\n                    \"LaunchTime\": \"2015-10-11T06:45:58.000Z\",\n                    \"PublicIpAddress\": \"**.**.***.***\",\n                    \"PrivateIpAddress\": \"10.0.0.162\",\n                    \"ProductCodes\": [],\n                    \"VpcId\": \"vpc-********\",\n                    \"StateTransitionReason\": \"\",\n                    \"InstanceId\": \"i-********\",\n                    \"ImageId\": \"ami-********\",\n                    \"PrivateDnsName\": \"ip-10-0-0-162.us-west-2.compute.internal\",\n                    \"KeyName\": \"UserManagementServer\",\n                    \"SecurityGroups\": [\n                        {\n                            \"GroupName\": \"WindowsServer\",\n                            \"GroupId\": \"sg-********\"\n                        }\n                    ],\n                    \"ClientToken\": \"\",\n                    \"SubnetId\": \"subnet-********\",\n                    \"InstanceType\": \"t2.medium\",\n                    \"NetworkInterfaces\": [\n                        {\n                            \"Status\": \"in-use\",\n                            \"MacAddress\": \"**:**:**:**:**:**\",\n                            \"SourceDestCheck\": true,\n                            \"VpcId\": \"vpc-********\",\n                            \"Description\": \"\",\n                            \"Association\": {\n                                \"PublicIp\": \"**.**.***.***\",\n                                \"PublicDnsName\": \"\",\n                                \"IpOwnerId\": \"amazon\"\n                            },\n                            \"NetworkInterfaceId\": \"eni-********\",\n                            \"PrivateIpAddresses\": [\n                                {\n                                    \"Association\": {\n                                        \"PublicIp\": \"**.**.***.***\",\n                                        \"PublicDnsName\": \"\",\n                                        \"IpOwnerId\": \"amazon\"\n                                    },\n                                    \"Primary\": true,\n                                    \"PrivateIpAddress\": \"10.0.0.162\"\n                                }\n                            ],\n                            \"Attachment\": {\n                                \"Status\": \"attached\",\n                                \"DeviceIndex\": 0,\n                                \"DeleteOnTermination\": true,\n                                \"AttachmentId\": \"eni-attach-********\",\n                                \"AttachTime\": \"2015-10-11T06:45:58.000Z\"\n                            },\n                            \"Groups\": [\n                                {\n                                    \"GroupName\": \"WindowsServer\",\n                                    \"GroupId\": \"sg-********\"\n                                }\n                            ],\n                            \"SubnetId\": \"subnet-********\",\n                            \"OwnerId\": \"************\",\n                            \"PrivateIpAddress\": \"10.0.0.162\"\n                        }\n                    ],\n                    \"SourceDestCheck\": true,\n                    \"Placement\": {\n                        \"Tenancy\": \"default\",\n                        \"GroupName\": \"\",\n                        \"AvailabilityZone\": \"us-west-2a\"\n                    },\n                    \"Hypervisor\": \"xen\",\n                    \"BlockDeviceMappings\": [\n                        {\n                            \"DeviceName\": \"/dev/sda1\",\n                            \"Ebs\": {\n                                \"Status\": \"attached\",\n                                \"DeleteOnTermination\": true,\n                                \"VolumeId\": \"vol-********\",\n                                \"AttachTime\": \"2015-10-11T06:46:02.000Z\"\n                            }\n                        }\n                    ],\n                    \"Architecture\": \"x86_64\",\n                    \"RootDeviceType\": \"ebs\",\n                    \"RootDeviceName\": \"/dev/sda1\",\n                    \"VirtualizationType\": \"hvm\",\n                    \"AmiLaunchIndex\": 0\n                }\n            ]\n        }\n    ]\n}\n```\n\n# 9. Windows\u30d1\u30b9\u30ef\u30fc\u30c9\u306e\u78ba\u8a8d\u3001Public IP\u306e\u78ba\u8a8d\n\n## \u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n   Instance_ID: \"${INSTANCE_ID}\"\n   KeyMaterialFile: \"${KEY_MATERIAL_FILE}\"\n\nETX\n```\n\n```text:\u7d50\u679c\n   Instance_ID: \"i-********\"\n   KeyMaterialFile: \"key.pem\"\n```\n\n## \u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u5fa9\u53f7\u5316\nEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u4f5c\u6210\u304b\u3089\u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u8868\u793a\u3055\u308c\u308b\u307e\u3067\u306b\u6570\u5206\u306e\u6642\u9593\u304c\u304b\u304b\u308a\u307e\u3059\u3002\n\n\u3057\u304b\u3057\u3001SSM\u306b\u3088\u308b\u30c9\u30e1\u30a4\u30f3\u53c2\u52a0\u304c\u6210\u529f\u3057\u305f\u5834\u5408\u306b\u306f\u4e0d\u8981\u306a\u305f\u3081\u3001\u6b21\u306e\u624b\u9806\u306b\u9032\u307f\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws ec2 get-password-data --instance-id ${INSTANCE_ID} --priv-launch-key ~/.ssh/${KEY_MATERIAL_FILE}\n```\n\n```json:\u7d50\u679c\n{\n    \"InstanceId\": \"i-********\",\n    \"Timestamp\": \"2015-10-11T06:48:35.000Z\",\n    \"PasswordData\": \"**********\"\n}\n```\n\n## \u30d1\u30d6\u30ea\u30c3\u30afIP\u3092\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\nPUBLIC_IP_ADDRESS=`aws ec2 describe-instances --instance-ids ${INSTANCE_ID} | jq -r \".[] | .[].Instances | .[].PublicIpAddress\"` && echo ${PUBLIC_IP_ADDRESS}\n```\n\n\u4ee5\u4e0a\u3067\u3059\u3002\n", "tags": ["aws-cli"]}