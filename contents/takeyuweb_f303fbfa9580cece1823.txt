{"tags": ["Rails", "ActiveRecord", "Arel"], "context": " More than 1 year has passed since last update.\u305f\u3068\u3048\u3070\n\u300c\u30e6\u30fc\u30b6\u30fc1\u304c\u30b3\u30e1\u30f3\u30c8\u3057\u305f\u8a18\u4e8b\u306e\u4e2d\u3067\u3001\u30b3\u30e1\u30f3\u30c8\u306elike\u6570\u304c1\u4ee5\u4e0a\u306e\u8a18\u4e8b\u3092\u691c\u7d22\u3059\u308b\u300d\nSELECT `posts`.* \nFROM `posts` \n  INNER JOIN (\n    SELECT `comments`.* \n    FROM `comments`\n    WHERE \n      `comments`.`user_id` = 1 AND\n      `comments`.`likes_count` >= 1\n  ) liked_user_comments ON liked_user_comments.`post_id` = `posts`.`id`\n\n\u3053\u3093\u306a\u306e\u3092Rails\u3067\u66f8\u304f\u306b\u306f\uff1f\n\n\u30b3\u30fc\u30c9\n\nArel::Table \u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306e\u53d6\u5f97\nuser = User.find(1)\nposts = Post.arel_table\ncomments = Comment.arel_table \n\n\n\u30b5\u30d6\u30af\u30a8\u30ea\u306e\u7d44\u307f\u7acb\u3066\n.project \u306a\u3069\u306b\u3088\u3063\u3066\u3067\u304d\u308b Arel::SelectManager\u30aa\u30d6\u30b8\u30a7\u30af\u30c8 \u306e .as \u3092\u547c\u3076\u3068 Arel::Nodes::TableAlias\u30aa\u30d6\u30b8\u30a7\u30af\u30c8 \u3092\u5f97\u308b\u3053\u3068\u304c\u3067\u304d\u3001\u30c6\u30fc\u30d6\u30eb\u3068\u540c\u69d8\u306b\u6271\u3046\u3053\u3068\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\nliked_user_comments = comments\n                          .project(Arel.sql('*'))\n                          .where(comments[:user_id]\n                              .eq(user.id)\n                              .and(comments[:likes_count].gtdq(1)))\n                          .as('liked_user_comments') # \u3053\u308c\n\n\n\nJOIN\u53e5\u306e\u7d44\u307f\u7acb\u3066\n\u5148\u307b\u3069\u5f97\u305f Arel::Nodes::TableAlias \u3092 .join \u306b\u6e21\u3059\u3068\u30b5\u30d6\u30af\u30a8\u30ea\u306b\u306a\u308a\u307e\u3059\u3002\n\u6700\u5f8c\u306b .join_sources \u3092\u547c\u3076\u3053\u3068\u3067JOIN\u306e\u53f3\u8fba\u3092\u53d6\u308a\u51fa\u3059\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\uff08Arel::Nodes::InnerJoin\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\uff09\njoin_conds = posts\n                 .join(liked_user_comments, Arel::Nodes::InnerJoin)\n                 .on(liked_user_comments[:post_id].eq(posts[:id]))\n                 .join_sources\n\n\nActiveRecord \u306e joins \u306b\u6e21\u3059\nPost.joins(join_conds)\n\n\n\u53c2\u8003\nhttp://qiita.com/tkawa/items/e65c8847e57a5329f336\n\u305f\u3068\u3048\u3070\n\n\u300c\u30e6\u30fc\u30b6\u30fc1\u304c\u30b3\u30e1\u30f3\u30c8\u3057\u305f\u8a18\u4e8b\u306e\u4e2d\u3067\u3001\u30b3\u30e1\u30f3\u30c8\u306elike\u6570\u304c1\u4ee5\u4e0a\u306e\u8a18\u4e8b\u3092\u691c\u7d22\u3059\u308b\u300d\n\n```sql\nSELECT `posts`.* \nFROM `posts` \n  INNER JOIN (\n    SELECT `comments`.* \n    FROM `comments`\n    WHERE \n      `comments`.`user_id` = 1 AND\n      `comments`.`likes_count` >= 1\n  ) liked_user_comments ON liked_user_comments.`post_id` = `posts`.`id`\n```\n\n\u3053\u3093\u306a\u306e\u3092Rails\u3067\u66f8\u304f\u306b\u306f\uff1f\n\n## \u30b3\u30fc\u30c9\n\n### Arel::Table \u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306e\u53d6\u5f97\n\n```rb\nuser = User.find(1)\nposts = Post.arel_table\ncomments = Comment.arel_table \n```\n\n### \u30b5\u30d6\u30af\u30a8\u30ea\u306e\u7d44\u307f\u7acb\u3066\n\n.project \u306a\u3069\u306b\u3088\u3063\u3066\u3067\u304d\u308b Arel::SelectManager\u30aa\u30d6\u30b8\u30a7\u30af\u30c8 \u306e .as \u3092\u547c\u3076\u3068 Arel::Nodes::TableAlias\u30aa\u30d6\u30b8\u30a7\u30af\u30c8 \u3092\u5f97\u308b\u3053\u3068\u304c\u3067\u304d\u3001\u30c6\u30fc\u30d6\u30eb\u3068\u540c\u69d8\u306b\u6271\u3046\u3053\u3068\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n```rb\nliked_user_comments = comments\n                          .project(Arel.sql('*'))\n                          .where(comments[:user_id]\n                              .eq(user.id)\n                              .and(comments[:likes_count].gtdq(1)))\n                          .as('liked_user_comments') # \u3053\u308c\n\n```\n\n### JOIN\u53e5\u306e\u7d44\u307f\u7acb\u3066\n\n\u5148\u307b\u3069\u5f97\u305f Arel::Nodes::TableAlias \u3092 .join \u306b\u6e21\u3059\u3068\u30b5\u30d6\u30af\u30a8\u30ea\u306b\u306a\u308a\u307e\u3059\u3002\n\u6700\u5f8c\u306b .join_sources \u3092\u547c\u3076\u3053\u3068\u3067JOIN\u306e\u53f3\u8fba\u3092\u53d6\u308a\u51fa\u3059\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\uff08Arel::Nodes::InnerJoin\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\uff09\n\n```rb\njoin_conds = posts\n                 .join(liked_user_comments, Arel::Nodes::InnerJoin)\n                 .on(liked_user_comments[:post_id].eq(posts[:id]))\n                 .join_sources\n```\n\n### ActiveRecord \u306e joins \u306b\u6e21\u3059\n\n```rb\nPost.joins(join_conds)\n```\n\n## \u53c2\u8003\n\nhttp://qiita.com/tkawa/items/e65c8847e57a5329f336\n\n"}