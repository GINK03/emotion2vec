{"context": " More than 1 year has passed since last update.\n\nAD\u306b\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u6210\u3059\u308b\n\u30c9\u30e1\u30a4\u30f3\u540d =  openid.local\nC:\\Windows\\System32>dsquery user -samid %username%\n\n\"CN=Administrator,CN=Users,DC=openid,DC=local\"\n\napache@openid.local \u3092\u4f5c\u6210\n@echo off\n\nSET USER=apache\nSET DOMAIN=DC=openid,DC=local\nSET PN=\"CN=%USER%,CN=Users,%DOMAIN%\"\nSET PWD=twitter!@2014\nSET GROUP=\"CN=Domain Admins,CN=Users,%DOMAIN%\"\n\n\ndsadd user %PN% -pwd %PWD% -mustchpwd no -pwdneverexpires yes -memberof %GROUP%\n\n\u78ba\u8a8d\nC:\\Windows\\System32>dsquery user -samid apache\n\n\"CN=apache,CN=Users,DC=openid,DC=local\"\n\n\nSPN(\u30b5\u30fc\u30d3\u30b9 \u30d7\u30ea\u30f3\u30b7\u30d1\u30eb\u540d)\u3068\u30ad\u30fc\u30bf\u30d6\u3092\u4f5c\u308b\n\u30ad\u30fc\u30bf\u30d6 = SPN + Key\n\u4f5c\u6210\u30b9\u30af\u30ea\u30d7\u30c8\n@echo off\n\nREM --- AD Domain \nSET REALM=OPENID.LOCAL                      \nSET NTDOM=OPENID\n\nREM --- Server\nSET CNAME=ubuntu.openid.local\nSET SPN=HTTP/%CNAME%@%REALM%\n\nREM --- User\nSET SERVICE_USER=apache\nSET USER=%SERVICE_USER%@%NTDOM%\n\nREM --- Crypto\nSET CRYPTO=RC4-HMAC-NT\nREM --- Principal Type\nSET PTYPE=KRB5_NT_PRINCIPAL\nREM --- Keytab File\nSET OUT=%SERVICE_USER%.krb5.http.keytab\n\nktpass -princ %SPN% -mapuser %USER%  -crypto %CRYPTO% -ptype %PTYPE% -out %OUT%  +rndPass\n\n\u78ba\u8a8d:\nC:> setspn -Q HTTP/*\n\n\u30c9\u30e1\u30a4\u30f3 DC=openid,DC=local \u3092\u78ba\u8a8d\u3057\u3066\u3044\u307e\u3059\nCN=apache,CN=Users,DC=openid,DC=local\n        HTTP/ubuntu.openid.local               \n\u65e2\u5b58\u306e SPN \u304c\u898b\u3064\u304b\u308a\u307e\u3057\u305f\n\n\u30d1\u30e9\u30e1\u30fc\u30bf\u5909\u3048\u3066\u4f5c\u308a\u76f4\u3059\u6642\u306f\u524a\u9664\u3059\u308b\nC:>setspn -d HTTP/ubuntu.openid.local apache\n\nCN=apache,CN=Users,DC=openid,DC=local \u306e ServicePrincipalNames  \n\u306e\u767b\u9332\u3092\u89e3\u9664\u3057\u3066\u3044\u307e\u3059\n    HTTP/ubuntu.openid.local\n\u66f4\u65b0\u3055\u308c\u305f\u30aa\u30d6\u30b8\u30a7\u30af\u30c8                \n\n\nmod_auth_kerb\nUbuntu:\n$ sudo apt-get install libapache2-mod-auth-kerb krb5-user -y\n\n\n/etc/krb5.conf\n[libdefaults]\n    default_realm = OPENID.LOCAL\n\n[realms]\n    OPENID.LOCAL = {\n            kdc = windomain.openid.local\n            admin_server = windomain.openid.local\n    }\n[domain_realm]\n    .openid.local = OPENID.LOCAL\n    openid.local = OPENID.LOCAL\n\n\nkeytab\u3092Ubuntu\u306b\u8a2d\u5b9a\n\u30b3\u30d4\u30fc\u3057\u3066 400\n$ sudo cp apache.krb5.http.keytab  /etc\n$ sudo chown www-data:www-data /etc/apache.krb5.http.keytab \n$ sudo chmod 400 /etc/apache.krb5.http.keytab     \n\n\u5185\u5bb9:\n$ sudo ktutil list\nktutil:\n\nktutil:  rkt /etc/apache.krb5.http.keytab\n\nktutil:  l\nslot KVNO Principal\n---- ---- ---------------------------------------------------------------------\n   1    4    HTTP/ubuntu.openid.local@OPENID.LOCAL\n\n\n\u3042\u308b\u3044\u306f\n\n\n$ sudo -u www-data klist -k /etc/apache2/krb/abop.deb.keytab\n\nKeytab name: FILE:/etc/apache2/krb/abop.deb.keytab\nKVNO Principal\n---- --------------------------------------------------------------------------\n   3 HTTP/ubuntu.tact.local@TACT.LOCAL\n\n\n\n\u521d\u671f\u5316\n\n    $ sudo -u www-data kinit -k -t /etc/apache.krb5.http.keytab HTTP/ubuntu.openid.local@OPENID.LOCAL\n\n    $ sudo -u www-data klist -e\n\n    Ticket cache: FILE:/tmp/krb5cc_33\n    Default principal: HTTP/ubuntu.openid.local@OPENID.LOCAL\n\n    Valid starting       Expires              Service principal\n    2014-07-18T16:13:44  2014-07-19T02:13:44  krbtgt/OPENID.LOCAL@OPENID.LOCAL\n        renew until 2014-07-19T16:13:44, Etype (skey, tkt): arcfour-hmac, aes256-cts-hmac-sha1-96\n\n\n\n$ ls -al /tmp/k*\n\n\n-rw------- 1 www-data www-data 1518 11\u6708 13 19:14 /tmp/krb5cc_33\n\n\n\nkinit: Permission denied while getting initial credentials\n\u3053\u306e\u30a8\u30e9\u30fc\u304c\u3067\u305f\u3089\u30ad\u30fc\u30bf\u30d6\u30d5\u30a1\u30a4\u30eb\u306e\u6a29\u9650\u304c\u304a\u304b\u3057\u3044\u3067\u3059\u3002 chown(www-data), chmod (400) \u3092\u6b63\u3057\u304f\n\nkdestroy: \u30c1\u30b1\u30c3\u30c8\u30ad\u30e3\u30c3\u30b7\u30e5\u30af\u30ea\u30a2\n\n\u7279\u5b9a\u306e\u30c1\u30b1\u30c3\u30c8\u3092\u6307\u5b9a\u3057\u3066\u30af\u30ea\u30a2\u3067\u304d\u307e\u305b\u3093\n\n\n$ sudo -u www-data kdestroy\n\n$ sudo -u www-data klist -e\n\nklist: No credentials cache found (ticket cache FILE:/tmp/krb5cc_33)\n\n\napache\u4eee\u60f3\u30b5\u30a4\u30c8\n\u30eb\u30fc\u30c8\u306bSPNEGO(Negotiate)\u8a8d\u8a3c\u8a2d\u5b9a\u3059\u308b\n<VirtualHost ubuntu.openid.local:80>\n\n    ServerAdmin admin@i-c-i.jp\n    ServerName  ubuntu.openid.local\n    DocumentRoot /home/hdknr/apache/www\n\n    LogLevel debug\n    ErrorLog /home/hdknr/apache/logs/error.log\n    CustomLog /home/hdknr/apache/logs/access.log combined\n\n    <Location / >\n    #Require all granted\n\n    AuthType Kerberos\n    AuthName \"AD Auth for OPENID.LOCAL\"\n\n    KrbAuthRealms OPENID.LOCAL\n    Krb5KeyTab /etc/apache.krb5.http.keytab\n    KrbMethodNegotiate on\n    KrbMethodK5Passwd off\n    KrbServiceName Any\n\n    require valid-user\n    </Location>\n\n</VirtualHost>    \n\n\n\u78ba\u8a8d\n\nUser Agent\n\nIE\u306e\u8a2d\u5b9a\n\n\n\n\nWindows \u7d71\u5408\u8a8d\u8a3c\u3092\u6709\u52b9\u306b\u3059\u308b\n\n\nFirefox\n\nabout:config\nnetwork.negotiate-auth.delegation-uris\nnetwork.negotiate-auth.trusted-uris\n\n\n\nphpinfo() \u306e\u30da\u30fc\u30b8\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u308b\n\nActive Directory\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u305fWindows\u306e\u30c7\u30b9\u30af\u30c8\u30c3\u30d7\u3067\u30a2\u30af\u30bb\u30b9\n\u30d1\u30b9\u30ef\u30fc\u30c9\u5165\u529b\u306a\u3057\u3067\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\n\nerrors.log\u306e\u30c7\u30d0\u30c3\u30b0\u30e1\u30c3\u30bb\u30fc\u30b8\n AH01626: authorization result of <RequireAny>: denied (no authenticated user yet)\n kerb_authenticate_user entered with user (NULL) and auth_type Kerberos\n AH01626: authorization result of Require valid-user : denied (no authenticated user yet)\n AH01626: authorization result of <RequireAny>: denied (no authenticated user yet)\n kerb_authenticate_user entered with user (NULL) and auth_type Kerberos\n Verifying client data using KRB5 GSS-API with our SPNEGO lib\n Client didn't delegate us their credential\n GSS-API token of length 180 bytes will be sent back\n AH01626: authorization result of Require valid-user : granted\n AH01626: authorization result of <RequireAny>: granted\n\n\n\nREMOTE_USER \u306b hide@OPENID.LOCAL \u3067\u8a8d\u8a3c\u3057\u3066\u3044\u308b\u3053\u3068\u304c\u8868\u793a\u3055\u308c\u3066\u308b\n\nAUTH_TYPE \u306b Negotiate \u3067\u8a8d\u8a3c\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u8868\u793a\u3055\u308c\u3066\u3044\u308b\n\n\n# AD\u306b\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u6210\u3059\u308b\n\u30c9\u30e1\u30a4\u30f3\u540d =  openid.local\n\n    C:\\Windows\\System32>dsquery user -samid %username%\n    \n    \"CN=Administrator,CN=Users,DC=openid,DC=local\"\n\n\napache@openid.local \u3092\u4f5c\u6210\n\n\n    @echo off\n\n    SET USER=apache\n    SET DOMAIN=DC=openid,DC=local\n    SET PN=\"CN=%USER%,CN=Users,%DOMAIN%\"\n    SET PWD=twitter!@2014\n    SET GROUP=\"CN=Domain Admins,CN=Users,%DOMAIN%\"\n\n\n    dsadd user %PN% -pwd %PWD% -mustchpwd no -pwdneverexpires yes -memberof %GROUP%\n\n\u78ba\u8a8d\n\n    C:\\Windows\\System32>dsquery user -samid apache\n    \n    \"CN=apache,CN=Users,DC=openid,DC=local\"\n\n\n\n# SPN(\u30b5\u30fc\u30d3\u30b9 \u30d7\u30ea\u30f3\u30b7\u30d1\u30eb\u540d)\u3068\u30ad\u30fc\u30bf\u30d6\u3092\u4f5c\u308b\n\n\u30ad\u30fc\u30bf\u30d6 = SPN + Key\n\n\u4f5c\u6210\u30b9\u30af\u30ea\u30d7\u30c8\n\n    @echo off\n\n    REM --- AD Domain \n    SET REALM=OPENID.LOCAL                      \n    SET NTDOM=OPENID\n\n    REM --- Server\n    SET CNAME=ubuntu.openid.local\n    SET SPN=HTTP/%CNAME%@%REALM%\n    \n    REM --- User\n    SET SERVICE_USER=apache\n    SET USER=%SERVICE_USER%@%NTDOM%\n\n    REM --- Crypto\n    SET CRYPTO=RC4-HMAC-NT\n    REM --- Principal Type\n    SET PTYPE=KRB5_NT_PRINCIPAL\n    REM --- Keytab File\n    SET OUT=%SERVICE_USER%.krb5.http.keytab\n\n    ktpass -princ %SPN% -mapuser %USER%  -crypto %CRYPTO% -ptype %PTYPE% -out %OUT%  +rndPass\n\n\u78ba\u8a8d:\n\n    C:> setspn -Q HTTP/*\n    \n    \u30c9\u30e1\u30a4\u30f3 DC=openid,DC=local \u3092\u78ba\u8a8d\u3057\u3066\u3044\u307e\u3059\n    CN=apache,CN=Users,DC=openid,DC=local\n            HTTP/ubuntu.openid.local               \n    \u65e2\u5b58\u306e SPN \u304c\u898b\u3064\u304b\u308a\u307e\u3057\u305f\n\n\n\u30d1\u30e9\u30e1\u30fc\u30bf\u5909\u3048\u3066\u4f5c\u308a\u76f4\u3059\u6642\u306f\u524a\u9664\u3059\u308b\n\n    C:>setspn -d HTTP/ubuntu.openid.local apache\n    \n    CN=apache,CN=Users,DC=openid,DC=local \u306e ServicePrincipalNames  \n    \u306e\u767b\u9332\u3092\u89e3\u9664\u3057\u3066\u3044\u307e\u3059\n        HTTP/ubuntu.openid.local\n    \u66f4\u65b0\u3055\u308c\u305f\u30aa\u30d6\u30b8\u30a7\u30af\u30c8                \n\n    \n# mod_auth_kerb\n\nUbuntu:\n\n    $ sudo apt-get install libapache2-mod-auth-kerb krb5-user -y\n\n# /etc/krb5.conf\n\n\n    [libdefaults]\n        default_realm = OPENID.LOCAL\n        \n    [realms]\n        OPENID.LOCAL = {\n                kdc = windomain.openid.local\n                admin_server = windomain.openid.local\n        }\n    [domain_realm]\n        .openid.local = OPENID.LOCAL\n        openid.local = OPENID.LOCAL\n    \n    \n# keytab\u3092Ubuntu\u306b\u8a2d\u5b9a\n\n\u30b3\u30d4\u30fc\u3057\u3066 400\n\n    $ sudo cp apache.krb5.http.keytab  /etc\n    $ sudo chown www-data:www-data /etc/apache.krb5.http.keytab \n    $ sudo chmod 400 /etc/apache.krb5.http.keytab     \n \n\u5185\u5bb9:\n    \n\n\n    $ sudo ktutil list\n    ktutil:\n\n    ktutil:  rkt /etc/apache.krb5.http.keytab\n\n    ktutil:  l\n    slot KVNO Principal\n    ---- ---- ---------------------------------------------------------------------\n       1    4    HTTP/ubuntu.openid.local@OPENID.LOCAL\n\n\n- \u3042\u308b\u3044\u306f\n\n```bash\n\n$ sudo -u www-data klist -k /etc/apache2/krb/abop.deb.keytab\n\nKeytab name: FILE:/etc/apache2/krb/abop.deb.keytab\nKVNO Principal\n---- --------------------------------------------------------------------------\n   3 HTTP/ubuntu.tact.local@TACT.LOCAL\n\n```\n\n\n# \u521d\u671f\u5316\n\n~~~\n\n    $ sudo -u www-data kinit -k -t /etc/apache.krb5.http.keytab HTTP/ubuntu.openid.local@OPENID.LOCAL\n\n    $ sudo -u www-data klist -e\n\n    Ticket cache: FILE:/tmp/krb5cc_33\n    Default principal: HTTP/ubuntu.openid.local@OPENID.LOCAL\n\n    Valid starting       Expires              Service principal\n    2014-07-18T16:13:44  2014-07-19T02:13:44  krbtgt/OPENID.LOCAL@OPENID.LOCAL\n        renew until 2014-07-19T16:13:44, Etype (skey, tkt): arcfour-hmac, aes256-cts-hmac-sha1-96\n\n~~~\n\n```bash\n\n$ ls -al /tmp/k*\n\n\n-rw------- 1 www-data www-data 1518 11\u6708 13 19:14 /tmp/krb5cc_33\n\n```\n\n##  kinit: Permission denied while getting initial credentials\n\n\u3053\u306e\u30a8\u30e9\u30fc\u304c\u3067\u305f\u3089\u30ad\u30fc\u30bf\u30d6\u30d5\u30a1\u30a4\u30eb\u306e\u6a29\u9650\u304c\u304a\u304b\u3057\u3044\u3067\u3059\u3002 chown(www-data), chmod (400) \u3092\u6b63\u3057\u304f\n   \n## kdestroy: \u30c1\u30b1\u30c3\u30c8\u30ad\u30e3\u30c3\u30b7\u30e5\u30af\u30ea\u30a2\n\n- \u7279\u5b9a\u306e\u30c1\u30b1\u30c3\u30c8\u3092\u6307\u5b9a\u3057\u3066\u30af\u30ea\u30a2\u3067\u304d\u307e\u305b\u3093\n\n```bash\n\n$ sudo -u www-data kdestroy\n\n$ sudo -u www-data klist -e\n\nklist: No credentials cache found (ticket cache FILE:/tmp/krb5cc_33)\n```\n    \n# apache\u4eee\u60f3\u30b5\u30a4\u30c8\n\n\u30eb\u30fc\u30c8\u306bSPNEGO(Negotiate)\u8a8d\u8a3c\u8a2d\u5b9a\u3059\u308b\n\n    <VirtualHost ubuntu.openid.local:80>\n\n        ServerAdmin admin@i-c-i.jp\n        ServerName  ubuntu.openid.local\n        DocumentRoot /home/hdknr/apache/www\n\n        LogLevel debug\n        ErrorLog /home/hdknr/apache/logs/error.log\n        CustomLog /home/hdknr/apache/logs/access.log combined\n\n        <Location / >\n        #Require all granted\n\n        AuthType Kerberos\n        AuthName \"AD Auth for OPENID.LOCAL\"\n\n        KrbAuthRealms OPENID.LOCAL\n        Krb5KeyTab /etc/apache.krb5.http.keytab\n        KrbMethodNegotiate on\n        KrbMethodK5Passwd off\n        KrbServiceName Any\n\n        require valid-user\n        </Location>\n\n    </VirtualHost>    \n \n# \u78ba\u8a8d \n \n## User Agent \n \n### IE\u306e\u8a2d\u5b9a\n\n* ![\u30ed\u30fc\u30ab\u30eb\u30a4\u30f3\u30c8\u30e9\u30cd\u30c3\u30c8\u306b\u4eee\u60f3\u30db\u30b9\u30c8\u3092\u8ffd\u52a0\u3059\u308b\u3053\u3068](https://lh4.googleusercontent.com/-cqikesub0Ng/U8m5Bek1QVI/AAAAAAAAAiU/eapCt7F52dk/w746-h512-no/%25E3%2582%25B9%25E3%2582%25AF%25E3%2583%25AA%25E3%2583%25BC%25E3%2583%25B3%25E3%2582%25B7%25E3%2583%25A7%25E3%2583%2583%25E3%2583%2588+2014-07-19+9.16.20.png)    \n* Windows \u7d71\u5408\u8a8d\u8a3c\u3092\u6709\u52b9\u306b\u3059\u308b\n\n\n### Firefox\n\n* about:config\n* network.negotiate-auth.delegation-uris\n* network.negotiate-auth.trusted-uris\n\n![negotiate \u3067URL\u3092\u8a2d\u5b9a\u3059\u308b](https://lh3.googleusercontent.com/-cATBYJ5g9Lo/U8m5cpO7MgI/AAAAAAAAAi4/r3DJl1JjlUY/w786-h321-no/%25E3%2582%25B9%25E3%2582%25AF%25E3%2583%25AA%25E3%2583%25BC%25E3%2583%25B3%25E3%2582%25B7%25E3%2583%25A7%25E3%2583%2583%25E3%2583%2588+2014-07-19+9.18.32.png)\n\n## phpinfo() \u306e\u30da\u30fc\u30b8\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u308b\n\n* Active Directory\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u305fWindows\u306e\u30c7\u30b9\u30af\u30c8\u30c3\u30d7\u3067\u30a2\u30af\u30bb\u30b9\n* \u30d1\u30b9\u30ef\u30fc\u30c9\u5165\u529b\u306a\u3057\u3067\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\n\n\nerrors.log\u306e\u30c7\u30d0\u30c3\u30b0\u30e1\u30c3\u30bb\u30fc\u30b8\n\n     AH01626: authorization result of <RequireAny>: denied (no authenticated user yet)\n     kerb_authenticate_user entered with user (NULL) and auth_type Kerberos\n     AH01626: authorization result of Require valid-user : denied (no authenticated user yet)\n     AH01626: authorization result of <RequireAny>: denied (no authenticated user yet)\n     kerb_authenticate_user entered with user (NULL) and auth_type Kerberos\n     Verifying client data using KRB5 GSS-API with our SPNEGO lib\n     Client didn't delegate us their credential\n     GSS-API token of length 180 bytes will be sent back\n     AH01626: authorization result of Require valid-user : granted\n     AH01626: authorization result of <RequireAny>: granted\n\n\n* `REMOTE_USER` \u306b hide@OPENID.LOCAL \u3067\u8a8d\u8a3c\u3057\u3066\u3044\u308b\u3053\u3068\u304c\u8868\u793a\u3055\u308c\u3066\u308b\n* `AUTH_TYPE` \u306b `Negotiate` \u3067\u8a8d\u8a3c\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u8868\u793a\u3055\u308c\u3066\u3044\u308b\n\n     \n", "tags": ["ActiveDirectory", "Apache", "SPNEGO"]}