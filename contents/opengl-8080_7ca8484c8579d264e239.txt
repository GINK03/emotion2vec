{"tags": ["websocket", "Java", "JavaScript"], "context": " More than 1 year has passed since last update.Java \u3067 WebSocket \u3092\u5b9f\u88c5\u3057\u3066\u307f\u308b\u3002\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u306f JavaScript \u3067\u5b9f\u88c5\u3002\n\n\u74b0\u5883\n\nAP \u30b5\u30fc\u30d0\u30fc\nTomcat 8.0.15\n\n\u30d6\u30e9\u30a6\u30b6\n\nIE11\nGoogle Chrome 38\nFirefox 33\n\n\nHelloWorld\n\nbuild.gradle\n\nbuild.gradle\napply plugin: 'war'\n\nwar.baseName = 'websocket'\n\nrepositories {\n    mavenCentral()\n}\n\ndependencies {\n    providedCompile 'javax.websocket:javax.websocket-api:1.1'\n}\n\n\n\n\u30d5\u30a9\u30eb\u30c0\u69cb\u6210\n|-build.gradle\n`-src/main/\n  |-java/sample/websocket/\n  |  `-SampleWebSocket.java\n  `-webapp/\n     |-index.html\n     `-script.js\n\n\n\u30b5\u30fc\u30d0\u30fc\u5074\u5b9f\u88c5\n\nSampleWebSocket.java\npackage sample.websocket;\n\nimport javax.websocket.OnMessage;\nimport javax.websocket.server.ServerEndpoint;\n\n@ServerEndpoint(\"/echo\")\npublic class SampleWebSocket {\n\n    @OnMessage\n    public String echo(String message) {\n        System.out.println(message);\n        return message;\n    }\n}\n\n\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u5b9f\u88c5\n\nindex.html\n<!DOCTYPE html>\n<html>\n  <head>\n    <title>WebSocket Sample</title>\n    <script src=\"jquery.min.js\"></script>\n    <script src=\"script.js\"></script>\n  </head>\n  <body>\n    <span id=\"message\"></span>\n  </body>\n</html>\n\n\n\nscript.js\n$(function() {\n    var url = 'ws://localhost:8080/websocket/echo';\n    var ws = new WebSocket(url);\n\n    ws.onmessage = function(receive) {\n        $('#message').text(receive.data);\n    };\n\n    ws.onopen = function() {\n        ws.send('Hello WebSocket');\n    }\n});\n\n\n\n\u52d5\u4f5c\u78ba\u8a8d\nwar \u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u3066 tomcat \u306b\u30c7\u30d7\u30ed\u30a4\u3057\u3001\u30d6\u30e9\u30a6\u30b6\u3067 http://localhost:8080/websocket/ \u306b\u30a2\u30af\u30bb\u30b9\u3002\n\n\n\u30b5\u30fc\u30d0\u30fc\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\nHello WebSocket\n\n\n\n\u8aac\u660e\n\n\u30b5\u30fc\u30d0\u30fc\u5074\n@ServerEndpoint(\"/echo\")\npublic class SampleWebSocket {\n\n    @OnMessage\n    public String echo(String message) {\n        System.out.println(message);\n        return message;\n    }\n}\n\n\n\n@ServerEndpoiint \u3067\u30a2\u30ce\u30c6\u30fc\u30c8\u3057\u305f\u30af\u30e9\u30b9\u304c\u3001\u30b5\u30fc\u30d0\u30fc\u5074\u306e WebSocket \u306e\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u306b\u306a\u308b\u3002\n\n\n\nvalue \u5c5e\u6027\u3067\u30d1\u30b9\u3092\u5b9a\u7fa9\u3059\u308b\u3002\n\n\n\n@OnMessage \u3067\u30e1\u30bd\u30c3\u30c9\u3092\u30a2\u30ce\u30c6\u30fc\u30c8\u3059\u308b\u3068\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u53d7\u4fe1\u3057\u305f\u3068\u304d\u306b\u3001\u305d\u306e\u30e1\u30bd\u30c3\u30c9\u304c\u5b9f\u884c\u3055\u308c\u308b\u3002\n\n\n\u5f15\u6570\u306b\u53d7\u4fe1\u3057\u305f\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u53d7\u3051\u53d6\u308c\u308b\u3002\n\u623b\u308a\u5024\u304c\u3001\u305d\u306e\u307e\u307e\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u8fd4\u4fe1\u3055\u308c\u308b\u3002\n\n\n\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\n$(function() {\n    var url = 'ws://localhost:8080/websocket/echo';\n    var ws = new WebSocket(url);\n\n    ws.onmessage = function(receive) {\n        $('#message').text(receive.data);\n    };\n\n    ws.onopen = function() {\n        ws.send('Hello WebSocket');\n    }\n});\n\n\n\nWebSocket \u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u751f\u6210\u3059\u308b\u3068\u30b5\u30fc\u30d0\u30fc\u3078\u306e\u63a5\u7d9a\u3092\u958b\u59cb\u3059\u308b\u3002\n\u63a5\u7d9a\u304c\u5b8c\u4e86\u3059\u308b\u3068\u3001 onopen \u306b\u6e21\u3057\u305f\u95a2\u6570\u304c\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3055\u308c\u308b\u3002\n\nsend() \u30e1\u30bd\u30c3\u30c9\u3067\u30b5\u30fc\u30d0\u30fc\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u4fe1\u3059\u308b\u3002\n\u30b5\u30fc\u30d0\u30fc\u304b\u3089\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u9001\u3089\u308c\u308b\u3068\u3001 onmessage \u306b\u8a2d\u5b9a\u3057\u305f\u95a2\u6570\u304c\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3055\u308c\u308b\u3002\n\n\n\u5f15\u6570\u306b\u306f MessageEvent \u30aa\u30d6\u30b8\u30a7\u30af\u30c8 \u304c\u6e21\u3055\u308c\u308b\u3002\n\n\n\n\n\u30b5\u30fc\u30d0\u30fc\u304b\u3089\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u4fe1\u3059\u308b\n\u30b5\u30fc\u30d0\u30fc\u304b\u3089\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u308b\u65b9\u6cd5\u306f\u3001\u5927\u304d\u304f\uff12\u3064\u3042\u308b\u3002\n\uff11\u3064\u306f Hello World \u306e\u3068\u3053\u308d\u306e\u5b9f\u88c5\u306e\u3088\u3046\u306b\u3001 @OnMessage \u3067\u30a2\u30ce\u30c6\u30fc\u30c8\u3057\u305f\u30e1\u30bd\u30c3\u30c9\u306e\u623b\u308a\u5024\u3092\u4f7f\u3046\u65b9\u6cd5\u3002\n\u3082\u3046\uff11\u3064\u306f\u3001 RemoteEndpoint \u3092\u4f7f\u3046\u65b9\u6cd5\u3002\npackage sample.websocket;\n\nimport java.io.IOException;\n\nimport javax.websocket.OnMessage;\nimport javax.websocket.Session;\nimport javax.websocket.server.ServerEndpoint;\n\n@ServerEndpoint(\"/echo\")\npublic class SampleWebSocket {\n\n    @OnMessage\n    public void echo(String message, Session session) throws IOException {\n        session.getBasicRemote().sendText(message);\n    }\n}\n\n\n\njavax.websocket.Session \u3092\u5f15\u6570\u306b\u8ffd\u52a0\u3057\u3066\u3001 getBasicRemote() \u30e1\u30bd\u30c3\u30c9\u3067 RemoteEndpoint \u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u53d6\u5f97\u3057\u3001 sendText() \u30e1\u30bd\u30c3\u30c9\u3067\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u4fe1\u3059\u308b\u3002\n\n\n\u975e\u540c\u671f\u3067\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u4fe1\u3059\u308b\ngetBasicRemote() \u3067\u53d6\u5f97\u3067\u304d\u308b RemoteEndpoint \u306f\u3001\u30e1\u30c3\u30bb\u30fc\u30b8\u306e\u9001\u4fe1\u304c\u5b8c\u4e86\u3059\u308b\u307e\u3067\u51e6\u7406\u3092\u5f85\u6a5f\u3059\u308b\u3002\n\u7d42\u4e86\u3092\u5f85\u3061\u305f\u304f\u306a\u3044\u5834\u5408\u306f\u3001 getAsyncRemote() \u3067 RemoteEndpoint \u3092\u53d6\u5f97\u3059\u308b\u3002\npackage sample.websocket;\n\nimport java.io.IOException;\n\nimport javax.websocket.OnMessage;\nimport javax.websocket.Session;\nimport javax.websocket.server.ServerEndpoint;\n\n@ServerEndpoint(\"/echo\")\npublic class SampleWebSocket {\n\n    @OnMessage\n    public void echo(String message, Session session) throws IOException {\n        session.getAsyncRemote().sendText(message);\n    }\n}\n\n\n\u63a5\u7d9a\u4e2d\u306e\u5168\u3066\u306e\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u4fe1\u3059\u308b\n\n\u5b9f\u88c5\npackage sample.websocket;\n\nimport java.io.IOException;\n\nimport javax.websocket.OnMessage;\nimport javax.websocket.Session;\nimport javax.websocket.server.ServerEndpoint;\n\n@ServerEndpoint(\"/broadcast\")\npublic class SampleWebSocket {\n\n    @OnMessage\n    public void broadcast(String message, Session session) throws IOException {\n        session.getOpenSessions().forEach(s -> {\n            s.getAsyncRemote().sendText(message);\n        });\n    }\n}\n\n<!DOCTYPE html>\n<html>\n  <head>\n    <title>WebSocket Sample</title>\n    <script src=\"jquery.min.js\"></script>\n    <script src=\"script.js\"></script>\n  </head>\n  <body>\n    <input type=\"text\" id=\"message\" />\n    <button id=\"send\">Send</button>\n\n    <hr>\n\n    <span id=\"receive\"></span>\n  </body>\n</html>\n\n$(function() {\n    $('#send').attr('disabled', true);\n    var ws = new WebSocket('ws://localhost:8080/websocket/broadcast');\n\n    ws.onopen = function() {\n        $('#send').attr('disabled', false);\n    };\n\n    ws.onmessage = function(receive) {\n        $('#receive').text(receive.data);\n    };\n\n    $('#send').on('click', function() {\n        var sendMessage = $('#message').val();\n        ws.send(sendMessage);\n    });\n});\n\n\n\u52d5\u4f5c\u78ba\u8a8d\nIE, Chrome, Firefox \u3067\u30da\u30fc\u30b8\u3092\u958b\u3044\u3066\u3001 IE \u3067\u30c6\u30ad\u30b9\u30c8\u3092\u5165\u529b\u3001\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3002\n\n\u3059\u308b\u3068\u3001 Chrome, Firefox \u306b IE \u3067\u5165\u529b\u3057\u305f\u6587\u5b57\u304c\u51fa\u529b\u3055\u308c\u308b\u3002\n\n\u8aac\u660e\n\n\nSession.getOpenSessions() \u3067\u3001\u73fe\u5728\u63a5\u7d9a\u4e2d\u306e\u5168\u3066\u306e\u30bb\u30c3\u30b7\u30e7\u30f3\u3092\u53d6\u5f97\u3067\u304d\u308b\u3002\n\n\n\u554f\u984c\u70b9\n\u3053\u306e\u5b9f\u88c5\u65b9\u6cd5\u3067\u3001\u30d6\u30ed\u30fc\u30c9\u30ad\u30e3\u30b9\u30c8\u306f\u554f\u984c\u306a\u304f\u5b9f\u88c5\u3067\u304d\u308b\u3002\n\u3057\u304b\u3057\u3001\u3053\u306e\u5b9f\u88c5\u306b\u306f\u7121\u99c4\u304c\u591a\u3044\u3002\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u9001\u4fe1\u3059\u308b\u30c7\u30fc\u30bf\u306f\u5168\u3066\u540c\u3058\u5185\u5bb9\u3060\u304c\u3001\u9001\u4fe1\u3059\u308b\u305f\u3081\u306e\u5f62\u5f0f\u306b\u30c7\u30fc\u30bf\u3092\u5909\u63db\u3059\u308b\u51e6\u7406\u304c\u6bce\u56de\u884c\u308f\u308c\u3066\u3044\u308b\u3002\n\u540c\u3058\u30c7\u30fc\u30bf\u306f\u4f7f\u3044\u307e\u308f\u305b\u308b\u3088\u3046\u306b\u3059\u308b\u3068\u52b9\u7387\u304c\u826f\u3044\u304b\u3001\u73fe\u72b6 WebSocket \u306e API \u306b\u306f\u3053\u308c\u3092\u5b9f\u73fe\u3059\u308b\u3082\u306e\u304c\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u306a\u3044\u3002\n\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u5b9f\u88c5\u3067\u3042\u308b Tyrus \u3092\u4f7f\u3063\u3066\u3044\u308c\u3070\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5b9f\u88c5\u3059\u308b\u3053\u3068\u3067\u3053\u306e\u7121\u99c4\u3092\u56de\u907f\u3067\u304d\u308b\u3002\n@OnMessage\npublic void onMessage(Session s, String m) {\n  ((TyrusSession) s).broadcast(m);\n}\n\n\u4eca\u5f8c\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u3067\u6539\u5584\u3055\u308c\u308b\u304b\u3082\u3057\u308c\u306a\u3044\u3002\n\u53c2\u8003\n- Oracle Blogs \u65e5\u672c\u8a9e\u306e\u307e\u3068\u3081: [Java] Optimized WebSocket broadcast\n\n\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\n\n\u5b9f\u88c5\npackage sample.websocket;\n\nimport javax.websocket.OnClose;\nimport javax.websocket.OnError;\nimport javax.websocket.OnOpen;\nimport javax.websocket.Session;\nimport javax.websocket.server.ServerEndpoint;\n\n@ServerEndpoint(\"/event\")\npublic class SampleWebSocket {\n\n    @OnOpen\n    public void onOpen(Session session) {\n        System.out.println(\"open : \" + session.getId());\n    }\n\n    @OnClose\n    public void onClose(Session session) {\n        System.out.println(\"close : \" + session.getId());\n    }\n\n    @OnError\n    public void onError(Session session, Throwable cause) {\n        System.out.println(\"error : \" + session.getId() + \", \" + cause.getMessage());\n    }\n}\n\nnew WebSocket('ws://localhost:8080/websocket/event');\n\n\n\u52d5\u4f5c\u78ba\u8a8d\n\u30d6\u30e9\u30a6\u30b6\u3067 http://localhost:8080/websocket/ \u3092\u8868\u793a\u3002\n\n\u30b5\u30fc\u30d0\u30fc\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\nopen : 0\n\n\nF5 \u3067\u753b\u9762\u3092\u518d\u63cf\u753b\u3002\n\n\u30b5\u30fc\u30d0\u30fc\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\nclose : 0\nopen : 1\n\n\n\u30d6\u30e9\u30a6\u30b6\u3092\u9589\u3058\u308b\u3002\n\n\u30b5\u30fc\u30d0\u30fc\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\nerror : 1, java.util.concurrent.ExecutionException: java.io.IOException: \u78ba\u7acb\u3055\u308c\u305f\u63a5\u7d9a\u304c\u30db\u30b9\u30c8 \u30b3\u30f3\u30d4\u30e5\u30fc\u30bf\u30fc\u306e\u30bd\u30a6\u30c8\u30a6\u30a7\u30a2\u306b\u3088\u3063\u3066\u4e2d\u6b62\u3055\u308c\u307e\u3057\u305f\u3002\nclose : 1\n\n\n\n\u8aac\u660e\n\n\n@OnOpen \u3067\u63a5\u7d9a\u958b\u59cb\u6642\u3001 @OnClose \u3067\u63a5\u7d9a\u7d42\u4e86\u6642\u3001 @OnError \u3067\u901a\u4fe1\u30a8\u30e9\u30fc\u6642\u306e\u51e6\u7406\u3092\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u3067\u304d\u308b\u3002\nWebSocket \u306e\u30bb\u30c3\u30b7\u30e7\u30f3\u3068 HttpServletSession \u306f\u5b8c\u5168\u306b\u5225\u7269\u3002\n\u30d6\u30e9\u30a6\u30b6\u304c\u518d\u63cf\u753b\u3055\u308c\u308c\u3070 JavaScript \u3082\u5b9f\u884c\u3055\u308c\u76f4\u3059\u306e\u3067\u3001\u524d\u306e\u63a5\u7d9a\uff08\u30bb\u30c3\u30b7\u30e7\u30f3\uff09\u306f\u5207\u65ad\u3055\u308c\u308b\u3002\n\n\n\u30d1\u30b9\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u4f7f\u7528\u3059\u308b\n\n\u5b9f\u88c5\npackage sample.websocket;\n\nimport javax.websocket.OnClose;\nimport javax.websocket.OnMessage;\nimport javax.websocket.OnOpen;\nimport javax.websocket.server.PathParam;\nimport javax.websocket.server.ServerEndpoint;\n\n@ServerEndpoint(\"/pathparam/{string}/{number}\")\npublic class SampleWebSocket {\n\n    @OnOpen\n    public void open(@PathParam(\"string\") String string, @PathParam(\"number\") int number) {\n        System.out.printf(\"OnOpen : string=%s, number=%d%n\", string, number);\n    }\n\n    @OnMessage\n    public void message(String message, @PathParam(\"string\") String string, @PathParam(\"number\") int number) {\n        System.out.printf(\"Message : message=%s, string=%s, number=%d%n\", message, string, number);\n    }\n\n    @OnClose\n    public void close(@PathParam(\"string\") String string, @PathParam(\"number\") int number) {\n        System.out.printf(\"Close : string=%s, number=%d%n\", string, number);\n    }\n}\n\n<!DOCTYPE html>\n<html>\n  <head>\n    <title>WebSocket Sample</title>\n    <script src=\"jquery.min.js\"></script>\n    <script src=\"script.js\"></script>\n  </head>\n  <body>\n    <button id=\"hoge\">hoge</button>\n    <button id=\"fuga\">fuga</button>\n  </body>\n</html>\n\n$(function() {\n    $('#hoge').on('click', function() {\n        var ws = new WebSocket('ws://localhost:8080/websocket/pathparam/hoge/11');\n        ws.onopen = function() {\n            ws.send('hoge message');\n            ws.close();\n        };\n    });\n\n    $('#fuga').on('click', function() {\n        var ws = new WebSocket('ws://localhost:8080/websocket/pathparam/fuga/22');\n        ws.onopen = function() {\n            ws.send('fuga message');\n            ws.close();\n        };\n    });\n});\n\n\n\u52d5\u4f5c\u78ba\u8a8d\n\u30d6\u30e9\u30a6\u30b6\u3067\u30da\u30fc\u30b8\u3092\u958b\u3044\u3066\u3001\u300choge\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3002\n\n\u30b5\u30fc\u30d0\u30fc\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\nOnOpen : string=hoge, number=11\nMessage : message=hoge message, string=hoge, number=11\nClose : string=hoge, number=11\n\n\n\u300cfuga\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3002\n\n\u30b5\u30fc\u30d0\u30fc\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\nOnOpen : string=fuga, number=22\nMessage : message=fuga message, string=fuga, number=22\nClose : string=fuga, number=22\n\n\n\n\u8aac\u660e\n\n\n@ServerEndpoint \u306e value \u5c5e\u6027\u306b\u6307\u5b9a\u3059\u308b\u30d1\u30b9\u306b\u3001 {\u30d1\u30e9\u30e1\u30fc\u30bf\u540d} \u3068\u3044\u3046\u5f62\u5f0f\u3067\u30d1\u30b9\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u5b9a\u7fa9\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\u30d1\u30b9\u30d1\u30e9\u30e1\u30fc\u30bf\u306f\u3001 @OnOpen, @OnMessage, @OnClose, @OnError \u306a\u3069\u306e\u5404\u30e1\u30bd\u30c3\u30c9\u3067\u5f15\u6570\u3068\u3057\u3066\u53d7\u3051\u53d6\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\u30e1\u30bd\u30c3\u30c9\u5f15\u6570\u306b\u306f\u3001 @PathParam(\"\u30d1\u30e9\u30e1\u30fc\u30bf\u540d\") \u3068\u3044\u3046\u5f62\u3067\u53d7\u3051\u53d6\u308b\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u6307\u5b9a\u3059\u308b\u3002\n\u57fa\u672c\u306f String \u3060\u304c\u3001 int \u306a\u3069\u306e\u30d7\u30ea\u30df\u30c6\u30a3\u30d6\u578b\u3067\u53d7\u3051\u53d6\u308b\u3053\u3068\u3082\u53ef\u80fd\u3002\n\n\n\u63a5\u7d9a\u3092\u9589\u3058\u308b\n\n\u30b5\u30fc\u30d0\u30fc\u5074\u304b\u3089\u9589\u3058\u308b\n\n\u5b9f\u88c5\npackage sample.websocket;\n\nimport java.io.IOException;\n\nimport javax.websocket.OnMessage;\nimport javax.websocket.Session;\nimport javax.websocket.server.ServerEndpoint;\n\n@ServerEndpoint(\"/close\")\npublic class SampleWebSocket {\n\n    @OnMessage\n    public void close(String message, Session session) throws IOException {\n        session.close();\n    }\n}\n\nvar ws = new WebSocket('ws://localhost:8080/websocket/close');\n\nws.onopen = function() {\n    ws.send(null);\n}\n\nws.onclose = function(closeEvent) {\n    console.log('code = ' + closeEvent.code + ', reason = ' + closeEvent.reason);\n};\n\n\n\u52d5\u4f5c\u78ba\u8a8d\n\n\u30d6\u30e9\u30a6\u30b6\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\ncode = 1000, reason =  \n\n\n\n\u30d6\u30e9\u30a6\u30b6\u5074\u304b\u3089\u9589\u3058\u308b\n\n\u5b9f\u88c5\nvar ws = new WebSocket('ws://localhost:8080/websocket/close');\n\nws.onopen = function() {\n    ws.close();\n}\n\npackage sample.websocket;\n\nimport java.io.IOException;\n\nimport javax.websocket.CloseReason;\nimport javax.websocket.OnClose;\nimport javax.websocket.Session;\nimport javax.websocket.server.ServerEndpoint;\n\n@ServerEndpoint(\"/close\")\npublic class SampleWebSocket {\n\n    @OnClose\n    public void onClose(Session session, CloseReason reason) throws IOException {\n        System.out.println(\"code = \" + reason.getCloseCode().getCode() + \", reason = \" + reason.getReasonPhrase());\n    }\n}\n\n\n\u52d5\u4f5c\u78ba\u8a8d\n\n\u30b5\u30fc\u30d0\u30fc\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\ncode = 1000, reason = null\n\n\n\n\u8aac\u660e\n\n\u30b5\u30fc\u30d0\u30fc\u304b\u3089\u5207\u65ad\u3059\u308b\u5834\u5408\u306f\u3001 Session#close() \u30e1\u30bd\u30c3\u30c9\u3092\u4f7f\u7528\u3059\u308b\u3002\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u5207\u65ad\u3059\u308b\u5834\u5408\u306f\u3001 WebSocket#close() \u30e1\u30bd\u30c3\u30c9\u3092\u4f7f\u7528\u3059\u308b\u3002\n\n\nServerEndpoint \u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306f\u30bb\u30c3\u30b7\u30e7\u30f3\u3054\u3068\u306b\u751f\u6210\u3055\u308c\u308b\n\n\u5b9f\u88c5\npackage sample.websocket;\n\nimport javax.websocket.OnMessage;\nimport javax.websocket.server.ServerEndpoint;\n\n@ServerEndpoint(\"/instance\")\npublic class SampleWebSocket {\n\n    @OnMessage\n    public void message(String message) {\n        System.out.println(this.hashCode());\n    }\n}\n\n<!DOCTYPE html>\n<html>\n  <head>\n    <title>WebSocket Sample</title>\n    <script src=\"jquery.min.js\"></script>\n    <script src=\"script.js\"></script>\n  </head>\n  <body>\n    <button id=\"send\">Send</button>\n  </body>\n</html>\n\n$(function() {\n    var ws = new WebSocket('ws://localhost:8080/websocket/instance');\n\n    ws.onopen = function() {\n        $('#send').on('click', function() {\n            ws.send('message');\n        });\n    }\n});\n\n\n\u52d5\u4f5c\u78ba\u8a8d\n\u30d6\u30e9\u30a6\u30b6\uff08Chrome\uff09\u3092\u958b\u304d\u3001\u300cSend\u300d\u30dc\u30bf\u30f3\u3092\u4f55\u56de\u304b\u30af\u30ea\u30c3\u30af\u3002\n\n\u30b5\u30fc\u30d0\u30fc\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\n1962593639\n1962593639\n1962593639\n1962593639\n\n\n\u65b0\u3057\u3044\u30bf\u30d6\u3067\u30da\u30fc\u30b8\u3092\u958b\u304d\u3001\u305d\u3061\u3089\u3067\u300cSend\u300d\u30dc\u30bf\u30f3\u3092\u4f55\u56de\u304b\u30af\u30ea\u30c3\u30af\u3002\n\n\u30b5\u30fc\u30d0\u30fc\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\n2050833800\n2050833800\n2050833800\n2050833800\n\n\nF5\u3067\u753b\u9762\u3092\u518d\u63cf\u753b\u3057\u3066\u304b\u3089\u3001\u300cSend\u300d\u30dc\u30bf\u30f3\u3092\u4f55\u56de\u304b\u30af\u30ea\u30c3\u30af\u3002\n\n\u30b5\u30fc\u30d0\u30fc\u5074\n1334674039\n1334674039\n1334674039\n\n\n\n\u8aac\u660e\nServerEndpoint \u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306f\u3001\u30bb\u30c3\u30b7\u30e7\u30f3\u3054\u3068\uff08\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u3054\u3068\uff09\u306b\u4f5c\u6210\u3055\u308c\u308b\u3002\n\uff11\u3064\u306e\u30bb\u30c3\u30b7\u30e7\u30f3\u306e\u4e2d\u3067\u306f\u3001\u5e38\u306b\u540c\u3058 ServerEndpoint \u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u5229\u7528\u3055\u308c\u308b\u3002\n\u307e\u305f\u3001 ServerEndpoint \u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306f\u5e38\u306b\uff11\u3064\u306e\u30b9\u30ec\u30c3\u30c9\u3068\u3060\u3051\u95a2\u9023\u4ed8\u3051\u3089\u308c\u308b\u3002\n\u3064\u307e\u308a\u3001\u30bb\u30c3\u30b7\u30e7\u30f3\u3054\u3068\u306e\u60c5\u5831\u3092\u4fdd\u6301\u3057\u3066\u304a\u304d\u305f\u3044\u5834\u5408\u306f\u3001 ServerEndpoint \u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30d5\u30a3\u30fc\u30eb\u30c9\u306b\u4fdd\u6301\u3057\u3066\u304a\u3051\u3070\u826f\u3044\u3002\n\nNote:\nAs opposed to servlets, WebSocket endpoints are instantiated multiple times.\n\uff08\u7565\uff09\nEach instance is associated with one and only one connection. This facilitates keeping user state for each connection and makes development easier, because there is only one thread executing the code of an endpoint instance at any given time.\n\nThe Java EE 7 Tutorial:Creating WebSocket Applications in the Java EE Platform | Java EE Documentation\n\n\u30b5\u30fc\u30d0\u30fc\u304b\u3089\u81ea\u767a\u7684\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u4fe1\u3059\u308b\n\u3053\u3053\u307e\u3067\u306e\u5b9f\u88c5\u65b9\u6cd5\u3060\u3068\u3001\u30b5\u30fc\u30d0\u30fc\u5074\u304b\u3089\u81ea\u767a\u7684\u306b\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u308b\u3053\u3068\u304c\u3067\u304d\u306a\u3044\u3002\n\u30b5\u30fc\u30d0\u30fc\u5074\u304b\u3089\u81ea\u767a\u7684\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u4fe1\u3059\u308b\u306b\u306f\u3001 ServerEndpoint \u306e static \u30d5\u30a3\u30fc\u30eb\u30c9\u306b Session \u3092\u4fdd\u6301\u3057\u3066\u304a\u304d\u3001 static \u30e1\u30bd\u30c3\u30c9\u3092\u4ecb\u3057\u3066 Session \u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3002\n\n\u5b9f\u88c5\n\nSampleWebSocket.java\npackage sample.websocket;\n\nimport java.text.SimpleDateFormat;\nimport java.util.Date;\nimport java.util.Queue;\nimport java.util.concurrent.ConcurrentLinkedQueue;\nimport java.util.concurrent.Executors;\nimport java.util.concurrent.ScheduledExecutorService;\nimport java.util.concurrent.TimeUnit;\n\nimport javax.websocket.OnClose;\nimport javax.websocket.OnOpen;\nimport javax.websocket.Session;\nimport javax.websocket.server.ServerEndpoint;\n\n@ServerEndpoint(\"/broadcast\")\npublic class SampleWebSocket {\n\n    private static final Queue<Session> sessions = new ConcurrentLinkedQueue<>();\n\n    static {\n        ScheduledExecutorService service = Executors.newSingleThreadScheduledExecutor();\n        service.scheduleWithFixedDelay(SampleWebSocket::broadcast, 5, 5, TimeUnit.SECONDS);\n    }\n\n    @OnOpen\n    public void connect(Session session) {\n        sessions.add(session);\n    }\n\n    @OnClose\n    public void remove(Session session) {\n        sessions.remove(session);\n    }\n\n    public static void broadcast() {\n        Date now = new Date();\n        SimpleDateFormat formatter = new SimpleDateFormat(\"yyyy/MM/dd HH:mm:ss\");\n\n        sessions.forEach(session -> {\n            session.getAsyncRemote().sendText(\"Broadcast : \" + formatter.format(now));\n        });\n    }\n}\n\n\n<!DOCTYPE html>\n<html>\n  <head>\n    <title>WebSocket Sample</title>\n    <script src=\"jquery.min.js\"></script>\n    <script src=\"script.js\"></script>\n  </head>\n  <body>\n    <span id=\"message\"></span>\n  </body>\n</html>\n\n$(function() {\n    var ws = new WebSocket('ws://localhost:8080/websocket/broadcast');\n\n    ws.onmessage = function(e) {\n        $('#message').text(e.data);\n    };\n});\n\n\n\u52d5\u4f5c\u78ba\u8a8d\n\u30d6\u30e9\u30a6\u30b6\u3092\u3044\u304f\u3064\u304b\u7acb\u3061\u4e0a\u3052\u3066\u3001 http://lcoalhost:8080/broadcast \u3092\u958b\u304f\u3002\n\u6700\u521d\u306e\u30a2\u30af\u30bb\u30b9\u304b\u3089\uff15\u79d2\u307b\u3069\u7d4c\u904e\u3059\u308b\u3068\u3001\u5404\u30d6\u30e9\u30a6\u30b6\u306b\u73fe\u5728\u6642\u523b\u304c\u51fa\u529b\u3055\u308c\u308b\u3002\n\n\u4ee5\u5f8c\u3001\uff15\u79d2\u3054\u3068\u306b\u6642\u523b\u306e\u8868\u793a\u304c\u66f4\u65b0\u3055\u308c\u308b\u3002\n\n\u8aac\u660e\n\n\n@OnOpen \u306e\u3068\u304d\u306b Session \u3092 static \u5ba3\u8a00\u3057\u305f ConcurrentLinkedQueue \u306b\u683c\u7d0d\u3057\u3066\u3044\u308b\u3002\n\u307e\u305f\u3001 @OnClose \u306e\u3068\u304d\u306b Session \u3092\u30ad\u30e5\u30fc\u304b\u3089\u524a\u9664\u3057\u3066\u3044\u308b\u3002\n\n\u81ea\u4f5c\u306e static \u30d5\u30a3\u30fc\u30eb\u30c9\u306b\u4fdd\u5b58\u3057\u3066\u7ba1\u7406\u3059\u308b\u3068\u3044\u3046\u306e\u304c\u3001\u306a\u3093\u3060\u304b\u5927\u4e08\u592b\u306a\u306e\u304b\u306a\u3068\u4e0d\u5b89\u306b\u306a\u308b\u3051\u3069\u3001 \u516c\u5f0f\u306e\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb \u304c\u3053\u3046\u306a\u3063\u3066\u3044\u308b\u306e\u3060\u304b\u3089\u3001\u304d\u3063\u3068\u5927\u4e08\u592b\u306a\u306e\u3060\u308d\u3046\u3002\n\u3061\u306a\u307f\u306b\u3001 JavaEE \u74b0\u5883\u306a\u3089 CDI \u306e Event \u3092\u4f7f\u3063\u3066\u3082\u3046\u3061\u3087\u3063\u3068\u30b9\u30de\u30fc\u30c8\uff1f\u306b\u5b9f\u88c5\u3059\u308b\u65b9\u6cd5\u304c Stack Overflow \u3067\u7d39\u4ecb\u3055\u308c\u3066\u3044\u308b\u3002\njava - How to get an existing websocket instance - Stack Overflow\n\n\u30e1\u30c3\u30bb\u30fc\u30b8\u3092 Java \u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306b\u30de\u30c3\u30d4\u30f3\u30b0\u3059\u308b\u305f\u3081\u306e\u4ed5\u7d44\u307f\u3092\u5229\u7528\u3059\u308b\n\n\u30c7\u30b3\u30fc\u30c0\u30fc\uff08\u30e1\u30c3\u30bb\u30fc\u30b8\u2192Java\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\uff09\n\n\u5b9f\u88c5\n\nHoge.java\npackage sample.websocket;\n\npublic class Hoge {\n\n    public int id;\n    public String name;\n\n    @Override\n    public String toString() {\n        return \"Hoge [id=\" + id + \", name=\" + name + \"]\";\n    }\n}\n\n\n\nHogeDecoder.java\npackage sample.websocket;\n\nimport javax.websocket.DecodeException;\nimport javax.websocket.Decoder;\nimport javax.websocket.EndpointConfig;\n\npublic class HogeDecoder implements Decoder.Text<Hoge> {\n\n    @Override\n    public void init(EndpointConfig config) {\n        System.out.println(\"init\");\n    }\n\n    @Override\n    public boolean willDecode(String s) {\n        System.out.println(\"willDecode\");\n        return true;\n    }\n\n    @Override\n    public Hoge decode(String s) throws DecodeException {\n        System.out.println(\"decode\");\n\n        String[] tokens = s.split(\":\");\n\n        Hoge hoge = new Hoge();\n        hoge.id = Integer.parseInt(tokens[0]);\n        hoge.name = tokens[1];\n\n        return hoge;\n    }\n\n    @Override\n    public void destroy() {\n        System.out.println(\"destroy\");\n    }\n}\n\n\n\nSampleWebSocket.java\npackage sample.websocket;\n\nimport javax.websocket.OnMessage;\nimport javax.websocket.server.ServerEndpoint;\n\n@ServerEndpoint(value=\"/decode\", decoders=HogeDecoder.class)\npublic class SampleWebSocket {\n\n    @OnMessage\n    public void message(Hoge hoge) {\n        System.out.println(hoge);\n    }\n}\n\n\n<!DOCTYPE html>\n<html>\n  <head>\n    <title>WebSocket Sample</title>\n    <script src=\"jquery.min.js\"></script>\n    <script src=\"script.js\"></script>\n  </head>\n  <body>\n    <button id=\"send\">Send</button>\n    <button id=\"close\">Close</button>\n  </body>\n</html>\n\n$(function() {\n    var ws = new WebSocket('ws://localhost:8080/websocket/decode');\n\n    ws.onopen = function(e) {\n        $('#send').on('click', function() {\n            ws.send('12:Hoge');\n        });\n\n        $('#close').on('click', function() {\n            ws.close();\n        });\n    };\n});\n\n\n\u52d5\u4f5c\u78ba\u8a8d\nWeb \u30d6\u30e9\u30a6\u30b6\u3067\u30da\u30fc\u30b8\u3092\u8868\u793a\u3002\n\n\u30b5\u30fc\u30d0\u30fc\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\ninit\n\n\n\u300cSend\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3002\n\n\u30b5\u30fc\u30d0\u30fc\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\nwillDecode\ndecode\nHoge [id=12, name=Hoge]\n\n\n\u3082\u3046\u4e00\u56de\u30af\u30ea\u30c3\u30af\u3002\n\n\u30b5\u30fc\u30d0\u30fc\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\nwillDecode\ndecode\nHoge [id=12, name=Hoge]\n\n\n\u300cClose\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3002\n\n\u30b5\u30fc\u30d0\u30fc\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\ndestroy\n\n\n\n\u8aac\u660e\n\n\nDecoder \u3092\u5b9f\u88c5\u3057\u305f\u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3057\u3001 @ServerEndpoint \u306e decoders \u306b\u6307\u5b9a\u3059\u308b\u3002\n\nDecoder \u306b\u306f\u30c6\u30ad\u30b9\u30c8\u3092\u5909\u63db\u3059\u308b Text<T> \u3084\u3001\u30d0\u30a4\u30ca\u30ea\u30c7\u30fc\u30bf\u3092\u5909\u63db\u3059\u308b Binary<T> \u3068\u3044\u3046\u30b5\u30d6\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u304c\u7528\u610f\u3055\u308c\u3066\u304a\u308a\u3001\u5b9f\u969b\u306f\u3053\u308c\u3089\u3092\u5b9f\u88c5\u3057\u305f\u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3002\n\u30c7\u30b3\u30fc\u30c0\u30fc\u304c\u6307\u5b9a\u3055\u308c\u3066\u3044\u308b\u3068\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u306f\u4e00\u65e6\u3053\u306e\u30c7\u30b3\u30fc\u30c0\u30fc\u306b\u6e21\u3055\u308c\u308b\u3002\n\u30c7\u30b3\u30fc\u30c0\u30fc\u3067\u306f\u3001\u4ee5\u4e0b\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u5b9f\u88c5\u3059\u308b\u3002\n\n\n\n\n\u30e1\u30bd\u30c3\u30c9\n\u8aac\u660e\n\n\n\n\ninit\n\u521d\u671f\u5316\u51e6\u7406\u3002\u30bb\u30c3\u30b7\u30e7\u30f3\u304c\u78ba\u7acb\u3055\u308c\u305f\u3068\u304d\u306b\uff11\u5ea6\u3060\u3051\u5b9f\u884c\u3055\u308c\u308b\u3002\n\n\nwillDecode\n\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u30c7\u30b3\u30fc\u30c9\u3059\u308b\u304b\u3069\u3046\u304b\u3092\u5224\u5b9a\u3059\u308b\u3002false\u3092\u8fd4\u3057\u305f\u5834\u5408\u3001 decode() \u30e1\u30bd\u30c3\u30c9\u306f\u5b9f\u884c\u3055\u308c\u306a\u3044\u3002\n\n\ndecode\n\u30e1\u30c3\u30bb\u30fc\u30b8\u3092 Java \u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306b\u5909\u63db\u3059\u308b\u30c7\u30b3\u30fc\u30c9\u51e6\u7406\u3092\u5b9f\u88c5\u3059\u308b\u3002\n\n\ndestroy\n\u30bb\u30c3\u30b7\u30e7\u30f3\u304c\u7834\u68c4\u3055\u308c\u308b\u3068\u304d\u306b\uff11\u5ea6\u3060\u3051\u5b9f\u884c\u3055\u308c\u308b\u3002\n\n\n\n\n\n@OnMessage \u3067\u30a2\u30ce\u30c6\u30fc\u30c8\u3057\u305f ServerEndpoint \u306e\u30e1\u30bd\u30c3\u30c9\u306b\u306f\u3001\u30c7\u30b3\u30fc\u30c0\u30fc\u304c\u4f5c\u6210\u3057\u305f Java \u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u304c\u5f15\u6570\u306b\u6e21\u3055\u308c\u308b\u3002\n\n\n\u30a8\u30f3\u30b3\u30fc\u30c0\u30fc\uff08Java\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u2192\u30e1\u30c3\u30bb\u30fc\u30b8\uff09\n\n\u5b9f\u88c5\n\nHogeEncoder.java\npackage sample.websocket;\n\nimport javax.websocket.EncodeException;\nimport javax.websocket.Encoder;\nimport javax.websocket.EndpointConfig;\n\npublic class HogeEncoder implements Encoder.Text<Hoge>{\n\n    @Override\n    public void init(EndpointConfig config) {\n        System.out.println(\"init\");\n    }\n\n    @Override\n    public String encode(Hoge hoge) throws EncodeException {\n        System.out.println(\"encode\");\n        return hoge.id + \":\" + hoge.name;\n    }\n\n    @Override\n    public void destroy() {\n        System.out.println(\"destroy\");\n\n    }\n}\n\n\n\nSampleWebSocket.java\npackage sample.websocket;\n\nimport javax.websocket.OnMessage;\nimport javax.websocket.server.ServerEndpoint;\n\n@ServerEndpoint(value=\"/encode\", encoders=HogeEncoder.class)\npublic class SampleWebSocket {\n\n    @OnMessage\n    public Hoge message(String message) {\n        System.out.println(\"message\");\n        Hoge hoge = new Hoge();\n        hoge.id = 20;\n        hoge.name = \"HOGE\";\n\n        return hoge;\n    }\n}\n\n\n$(function() {\n    var ws = new WebSocket('ws://localhost:8080/websocket/encode');\n\n    ws.onopen = function() {\n        $('#send').on('click', function() {\n            ws.send(null);\n        });\n\n        $('#close').on('click', function() {\n            ws.close();\n        });\n    };\n\n    ws.onmessage = function(e) {\n        console.log(e.data);\n    };\n});\n\n\n\u52d5\u4f5c\u78ba\u8a8d\n\u30d6\u30e9\u30a6\u30b6\u3067\u30da\u30fc\u30b8\u3092\u8868\u793a\u3002\n\n\u30b5\u30fc\u30d0\u30fc\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\ninit\n\n\n\u300cSend\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3002\n\n\u30b5\u30fc\u30d0\u30fc\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\nmessage\nencode\n\n\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\n20:HOGE\n\n\n\u300cClose\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3002\n\n\u30b5\u30fc\u30d0\u30fc\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\ndestroy\n\n\n\n\u8aac\u660e\n\n\u30c7\u30b3\u30fc\u30c0\u30fc\u306e\u9006\u3002\u5909\u63db\u306e\u5411\u304d\u304c\u9006\u306b\u306a\u3063\u305f\u3053\u3068\u4ee5\u5916\u3001\u7279\u306b\u5927\u304d\u306a\u9055\u3044\u306f\u306a\u3044\u3002\n\n\n\u304a\u307e\u3051\nEncoder \u3068 Decoder \u306f\u3001\u305d\u306e\u307e\u307e\u3060\u3068\u30d1\u30e9\u30e1\u30fc\u30bf\u3067\u4f7f\u3046\u578b\u306e\u6570\u3060\u3051\u4f5c\u6210\u3057\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u305f\u3081\u3001\u3061\u3087\u3063\u3068\u30a4\u30b1\u3066\u306a\u3044\u3002\n\u3068\u3044\u3046\u3053\u3068\u3067\u3001 json \u3068\u4efb\u610f\u306e\u578b\u3068\u3092\u5909\u63db\u3059\u308b Encoder \u3068 Decoder \u3092\u5b9f\u88c5\u3057\u3066\u307f\u305f\u3002\n\nbuild.gradle\n\nbuild.gradle\ndependencies {\n    compile 'com.fasterxml.jackson.core:jackson-databind:2.4.3'\n    providedCompile 'javax.websocket:javax.websocket-api:1.1'\n}\n\n\njson \u306e\u5909\u63db\u306b\u306f Jackson \u3092\u5229\u7528\u3059\u308b\u3002\n\n\u5b9f\u88c5\n\nJsonConverter.java\npackage sample.websocket;\n\nimport java.io.IOException;\nimport java.lang.reflect.Method;\nimport java.lang.reflect.Parameter;\nimport java.util.Map;\nimport java.util.function.Predicate;\nimport java.util.stream.Stream;\n\nimport javax.websocket.DecodeException;\nimport javax.websocket.Decoder;\nimport javax.websocket.EncodeException;\nimport javax.websocket.Encoder;\nimport javax.websocket.EndpointConfig;\nimport javax.websocket.OnMessage;\nimport javax.websocket.Session;\nimport javax.websocket.server.PathParam;\n\nimport com.fasterxml.jackson.core.JsonProcessingException;\nimport com.fasterxml.jackson.databind.ObjectMapper;\n\npublic class JsonConverter implements Encoder.Text<Object>, Decoder.Text<Object> {\n\n    public static final String ENDPOINT_CLASS = \"json.endpoint.class\";\n\n    private ObjectMapper mapper = new ObjectMapper();\n    private Map<String, Object> userProperties;\n    private Class<?> messageClass;\n\n    @Override\n    public void init(EndpointConfig config) {\n        this.userProperties = config.getUserProperties();\n    }\n\n    @Override\n    public Object decode(String s) throws DecodeException {\n        try {\n            Class<?> messageClass = this.getMessageClass();\n            return this.mapper.readValue(s, messageClass);\n        } catch (IOException e) {\n            throw new DecodeException(s, \"failed to decode message.\", e);\n        }\n    }\n\n    private Class<?> getMessageClass() {\n        if (this.messageClass == null) {\n            this.initMessageClass();\n        }\n\n        return this.messageClass;\n    }\n\n    private void initMessageClass() {\n        Class<?> endpointClass = (Class<?>)userProperties.get(ENDPOINT_CLASS);\n\n        Method onMessageMethod = this.findOnMessageMethod(endpointClass);\n        Parameter messageParameter = this.findMessageParameter(onMessageMethod);\n\n        this.messageClass = messageParameter.getType();\n    }\n\n    private Method findOnMessageMethod(Class<?> endpointClass) {\n        return this.findFromArray(endpointClass.getMethods(), this::isOnMessageMethod, \"method annotated by @OnMessage is not found.\");\n    }\n\n    private boolean isOnMessageMethod(Method method) {\n        return method.isAnnotationPresent(OnMessage.class);\n    }\n\n    private Parameter findMessageParameter(Method onMessageMethod) {\n        return this.findFromArray(onMessageMethod.getParameters(), this::isMessageParameter, \"message parameter is not found.\");\n    }\n\n    private boolean isMessageParameter(Parameter parameter) {\n        return this.isNotSession(parameter) && this.isNotPathParam(parameter);\n    }\n\n    private boolean isNotSession(Parameter parameter) {\n        return !Session.class.isAssignableFrom(parameter.getType());\n    }\n\n    private boolean isNotPathParam(Parameter parameter) {\n        return !parameter.isAnnotationPresent(PathParam.class);\n    }\n\n    private <T> T findFromArray(T[] array, Predicate<T> condition, String exceptionMessage) {\n        return Stream.of(array)\n                     .filter(condition)\n                     .findFirst()\n                     .orElseThrow(() -> new RuntimeException(exceptionMessage));\n    }\n\n    @Override\n    public String encode(Object object) throws EncodeException {\n        try {\n            return this.mapper.writeValueAsString(object);\n        } catch (JsonProcessingException e) {\n            throw new EncodeException(object, \"failed to encode message.\", e);\n        }\n    }\n\n    @Override\n    public boolean willDecode(String s) {\n        return true;\n    }\n\n    @Override public void destroy() {/*no use*/}\n}\n\n\npackage sample.websocket;\n\nimport javax.websocket.EndpointConfig;\nimport javax.websocket.OnMessage;\nimport javax.websocket.OnOpen;\nimport javax.websocket.Session;\nimport javax.websocket.server.ServerEndpoint;\n\n@ServerEndpoint(value=\"/json\", encoders=JsonConverter.class, decoders=JsonConverter.class)\npublic class SampleWebSocket {\n\n    @OnOpen\n    public void open(EndpointConfig config) {\n        config.getUserProperties().put(JsonConverter.ENDPOINT_CLASS, SampleWebSocket.class);\n    }\n\n    @OnMessage\n    public Hoge message(Hoge message, Session session) {\n        System.out.println(\"message = \" + message);\n\n        Hoge hoge = new Hoge();\n        hoge.id = 33;\n        hoge.name = \"fuga\";\n\n        return hoge;\n    }\n}\n\n<!DOCTYPE html>\n<html>\n  <head>\n    <title>WebSocket Sample</title>\n    <script src=\"jquery.min.js\"></script>\n    <script src=\"script.js\"></script>\n  </head>\n  <body>\n    <button id=\"send\">Send</button>\n    <button id=\"close\">Close</button>\n  </body>\n</html>\n\n$(function() {\n    var ws = new WebSocket('ws://localhost:8080/websocket/json');\n\n    ws.onopen = function() {\n        $('#send').on('click', function() {\n            var message = {id: 15, name: \"Hoge\"};\n            ws.send(JSON.stringify(message));\n        });\n\n        $('#close').on('click', function() {\n            ws.close();\n        });\n    };\n\n    ws.onmessage = function(e) {\n        console.log(e.data);\n    };\n});\n\n\n\u52d5\u4f5c\u78ba\u8a8d\n\u30d6\u30e9\u30a6\u30b6\u3067\u30da\u30fc\u30b8\u3092\u8868\u793a\u3057\u3066\u3001\u300cSend\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3002\n\n\u30b5\u30fc\u30d0\u30fc\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\nmessage = Hoge [id=15, name=Hoge]\n\n\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\n{\"id\":33,\"name\":\"fuga\"}\n\n\n\n\u8aac\u660e\n\n\nEndpointConfig#getUserProperties() \u3067\u53d6\u5f97\u3067\u304d\u308b Map \uff08UserProperties\uff09\u3092\u4ecb\u3057\u3066\u3001 ServerEndpoint \u306e\u578b\u306e\u60c5\u5831\u3092\u3084\u308a\u53d6\u308a\u3057\u3066\u3044\u308b\u3002\n\nSampleWebSocket \u306e open() \u30e1\u30bd\u30c3\u30c9\u5185\u3067\u3001 ServerEndpoint \u306e\u578b\u3092 UserProperties \u306b\u8a2d\u5b9a\u3059\u308b\u3002\n\nJsonConverter \u5074\u306f\u3001 init() \u30e1\u30bd\u30c3\u30c9\u3067 UserProperties \u3092\u53d6\u5f97\u3057\u3066\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u5909\u6570\u306b\u4fdd\u5b58\u3057\u3066\u304a\u304f\u3002\n\n\n\nSampleWebSocket \u306e open() \u30e1\u30bd\u30c3\u30c9\u3088\u308a JsonConverter \u306e init() \u30e1\u30bd\u30c3\u30c9\u304c\u5148\u306b\u547c\u3070\u308c\u308b\u3002\n\u3053\u306e\u305f\u3081\u3001\u3053\u306e\u6642\u70b9\u3067\u306f UserProperties \u306b\u578b\u60c5\u5831\u306f\u4fdd\u5b58\u3055\u308c\u3066\u3044\u306a\u3044\u3002\n\n\n\u305d\u3057\u3066\u3001 decode() \u30e1\u30bd\u30c3\u30c9\u304c\u547c\u3070\u308c\u305f\u3068\u304d\u306b\u5909\u63db\u5f8c\u306e\u578b\u60c5\u5831\u3092\u30ea\u30d5\u30ec\u30af\u30b7\u30e7\u30f3\u3067\u53d6\u5f97\u3057\u3001 Jackson \u3067\u30c7\u30b3\u30fc\u30c9\u3057\u3066\u3044\u308b\u3002\n\n\u3053\u308c\u3067 JsonConverter \u306f\u4f7f\u3044\u56de\u3057\u3057\u3084\u3059\u304f\u306a\u308b\u306f\u305a\u3002\n\n\u53c2\u8003\n\nJSR 356\u2015Java\u6a19\u6e96\u306eWebSocket API - Programming Studio\nTyrus 1.8.3 User Guide\nWebSocket API (Windows)\n\nJava \u3067 WebSocket \u3092\u5b9f\u88c5\u3057\u3066\u307f\u308b\u3002\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u306f JavaScript \u3067\u5b9f\u88c5\u3002\n\n#\u74b0\u5883\n##AP \u30b5\u30fc\u30d0\u30fc\nTomcat 8.0.15\n\n##\u30d6\u30e9\u30a6\u30b6\n- IE11\n- Google Chrome 38\n- Firefox 33\n\n#HelloWorld\n##build.gradle\n```groovy:build.gradle\napply plugin: 'war'\n\nwar.baseName = 'websocket'\n\nrepositories {\n    mavenCentral()\n}\n\ndependencies {\n    providedCompile 'javax.websocket:javax.websocket-api:1.1'\n}\n```\n\n##\u30d5\u30a9\u30eb\u30c0\u69cb\u6210\n```text:\n|-build.gradle\n`-src/main/\n  |-java/sample/websocket/\n  |  `-SampleWebSocket.java\n  `-webapp/\n     |-index.html\n     `-script.js\n```\n\n##\u30b5\u30fc\u30d0\u30fc\u5074\u5b9f\u88c5\n```java:SampleWebSocket.java\npackage sample.websocket;\n\nimport javax.websocket.OnMessage;\nimport javax.websocket.server.ServerEndpoint;\n\n@ServerEndpoint(\"/echo\")\npublic class SampleWebSocket {\n    \n    @OnMessage\n    public String echo(String message) {\n        System.out.println(message);\n        return message;\n    }\n}\n```\n\n##\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u5b9f\u88c5\n```html:index.html\n<!DOCTYPE html>\n<html>\n  <head>\n    <title>WebSocket Sample</title>\n    <script src=\"jquery.min.js\"></script>\n    <script src=\"script.js\"></script>\n  </head>\n  <body>\n    <span id=\"message\"></span>\n  </body>\n</html>\n```\n\n```js:script.js\n$(function() {\n    var url = 'ws://localhost:8080/websocket/echo';\n    var ws = new WebSocket(url);\n    \n    ws.onmessage = function(receive) {\n        $('#message').text(receive.data);\n    };\n    \n    ws.onopen = function() {\n        ws.send('Hello WebSocket');\n    }\n});\n```\n\n##\u52d5\u4f5c\u78ba\u8a8d\nwar \u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u3066 tomcat \u306b\u30c7\u30d7\u30ed\u30a4\u3057\u3001\u30d6\u30e9\u30a6\u30b6\u3067 `http://localhost:8080/websocket/` \u306b\u30a2\u30af\u30bb\u30b9\u3002\n\n![websocket.JPG](https://qiita-image-store.s3.amazonaws.com/0/28302/1e12b446-451a-6416-2cd2-201eef5191d0.jpeg)\n\n```text:\u30b5\u30fc\u30d0\u30fc\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\nHello WebSocket\n```\n\n##\u8aac\u660e\n###\u30b5\u30fc\u30d0\u30fc\u5074\n```java:\n@ServerEndpoint(\"/echo\")\npublic class SampleWebSocket {\n    \n    @OnMessage\n    public String echo(String message) {\n        System.out.println(message);\n        return message;\n    }\n}\n```\n\n- `@ServerEndpoiint` \u3067\u30a2\u30ce\u30c6\u30fc\u30c8\u3057\u305f\u30af\u30e9\u30b9\u304c\u3001\u30b5\u30fc\u30d0\u30fc\u5074\u306e WebSocket \u306e\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u306b\u306a\u308b\u3002\n    - `value` \u5c5e\u6027\u3067\u30d1\u30b9\u3092\u5b9a\u7fa9\u3059\u308b\u3002\n- `@OnMessage` \u3067\u30e1\u30bd\u30c3\u30c9\u3092\u30a2\u30ce\u30c6\u30fc\u30c8\u3059\u308b\u3068\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u53d7\u4fe1\u3057\u305f\u3068\u304d\u306b\u3001\u305d\u306e\u30e1\u30bd\u30c3\u30c9\u304c\u5b9f\u884c\u3055\u308c\u308b\u3002\n    - \u5f15\u6570\u306b\u53d7\u4fe1\u3057\u305f\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u53d7\u3051\u53d6\u308c\u308b\u3002\n    - \u623b\u308a\u5024\u304c\u3001\u305d\u306e\u307e\u307e\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u8fd4\u4fe1\u3055\u308c\u308b\u3002\n\n###\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\n```js:\n$(function() {\n    var url = 'ws://localhost:8080/websocket/echo';\n    var ws = new WebSocket(url);\n    \n    ws.onmessage = function(receive) {\n        $('#message').text(receive.data);\n    };\n    \n    ws.onopen = function() {\n        ws.send('Hello WebSocket');\n    }\n});\n```\n\n- `WebSocket` \u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u751f\u6210\u3059\u308b\u3068\u30b5\u30fc\u30d0\u30fc\u3078\u306e\u63a5\u7d9a\u3092\u958b\u59cb\u3059\u308b\u3002\n- \u63a5\u7d9a\u304c\u5b8c\u4e86\u3059\u308b\u3068\u3001 `onopen` \u306b\u6e21\u3057\u305f\u95a2\u6570\u304c\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3055\u308c\u308b\u3002\n- `send()` \u30e1\u30bd\u30c3\u30c9\u3067\u30b5\u30fc\u30d0\u30fc\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u4fe1\u3059\u308b\u3002\n- \u30b5\u30fc\u30d0\u30fc\u304b\u3089\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u9001\u3089\u308c\u308b\u3068\u3001 `onmessage` \u306b\u8a2d\u5b9a\u3057\u305f\u95a2\u6570\u304c\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3055\u308c\u308b\u3002\n    - \u5f15\u6570\u306b\u306f [MessageEvent \u30aa\u30d6\u30b8\u30a7\u30af\u30c8](http://msdn.microsoft.com/ja-jp/library/ie/ff974343%28v=vs.85%29.aspx) \u304c\u6e21\u3055\u308c\u308b\u3002\n\n#\u30b5\u30fc\u30d0\u30fc\u304b\u3089\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u4fe1\u3059\u308b\n\u30b5\u30fc\u30d0\u30fc\u304b\u3089\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u308b\u65b9\u6cd5\u306f\u3001\u5927\u304d\u304f\uff12\u3064\u3042\u308b\u3002\n\uff11\u3064\u306f Hello World \u306e\u3068\u3053\u308d\u306e\u5b9f\u88c5\u306e\u3088\u3046\u306b\u3001 `@OnMessage` \u3067\u30a2\u30ce\u30c6\u30fc\u30c8\u3057\u305f\u30e1\u30bd\u30c3\u30c9\u306e\u623b\u308a\u5024\u3092\u4f7f\u3046\u65b9\u6cd5\u3002\n\u3082\u3046\uff11\u3064\u306f\u3001 `RemoteEndpoint` \u3092\u4f7f\u3046\u65b9\u6cd5\u3002\n\n```java:\npackage sample.websocket;\n\nimport java.io.IOException;\n\nimport javax.websocket.OnMessage;\nimport javax.websocket.Session;\nimport javax.websocket.server.ServerEndpoint;\n\n@ServerEndpoint(\"/echo\")\npublic class SampleWebSocket {\n    \n    @OnMessage\n    public void echo(String message, Session session) throws IOException {\n        session.getBasicRemote().sendText(message);\n    }\n}\n```\n\n- `javax.websocket.Session` \u3092\u5f15\u6570\u306b\u8ffd\u52a0\u3057\u3066\u3001 `getBasicRemote()` \u30e1\u30bd\u30c3\u30c9\u3067 `RemoteEndpoint` \u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u53d6\u5f97\u3057\u3001 `sendText()` \u30e1\u30bd\u30c3\u30c9\u3067\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u4fe1\u3059\u308b\u3002\n\n##\u975e\u540c\u671f\u3067\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u4fe1\u3059\u308b\n`getBasicRemote()` \u3067\u53d6\u5f97\u3067\u304d\u308b `RemoteEndpoint` \u306f\u3001\u30e1\u30c3\u30bb\u30fc\u30b8\u306e\u9001\u4fe1\u304c\u5b8c\u4e86\u3059\u308b\u307e\u3067\u51e6\u7406\u3092\u5f85\u6a5f\u3059\u308b\u3002\n\u7d42\u4e86\u3092\u5f85\u3061\u305f\u304f\u306a\u3044\u5834\u5408\u306f\u3001 `getAsyncRemote()` \u3067 `RemoteEndpoint` \u3092\u53d6\u5f97\u3059\u308b\u3002\n\n```java:\npackage sample.websocket;\n\nimport java.io.IOException;\n\nimport javax.websocket.OnMessage;\nimport javax.websocket.Session;\nimport javax.websocket.server.ServerEndpoint;\n\n@ServerEndpoint(\"/echo\")\npublic class SampleWebSocket {\n    \n    @OnMessage\n    public void echo(String message, Session session) throws IOException {\n        session.getAsyncRemote().sendText(message);\n    }\n}\n```\n\n#\u63a5\u7d9a\u4e2d\u306e\u5168\u3066\u306e\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u4fe1\u3059\u308b\n##\u5b9f\u88c5\n```java:\npackage sample.websocket;\n\nimport java.io.IOException;\n\nimport javax.websocket.OnMessage;\nimport javax.websocket.Session;\nimport javax.websocket.server.ServerEndpoint;\n\n@ServerEndpoint(\"/broadcast\")\npublic class SampleWebSocket {\n    \n    @OnMessage\n    public void broadcast(String message, Session session) throws IOException {\n        session.getOpenSessions().forEach(s -> {\n            s.getAsyncRemote().sendText(message);\n        });\n    }\n}\n```\n\n```html:\n<!DOCTYPE html>\n<html>\n  <head>\n    <title>WebSocket Sample</title>\n    <script src=\"jquery.min.js\"></script>\n    <script src=\"script.js\"></script>\n  </head>\n  <body>\n    <input type=\"text\" id=\"message\" />\n    <button id=\"send\">Send</button>\n    \n    <hr>\n    \n    <span id=\"receive\"></span>\n  </body>\n</html>\n```\n\n```js:\n$(function() {\n    $('#send').attr('disabled', true);\n    var ws = new WebSocket('ws://localhost:8080/websocket/broadcast');\n    \n    ws.onopen = function() {\n        $('#send').attr('disabled', false);\n    };\n    \n    ws.onmessage = function(receive) {\n        $('#receive').text(receive.data);\n    };\n    \n    $('#send').on('click', function() {\n        var sendMessage = $('#message').val();\n        ws.send(sendMessage);\n    });\n});\n```\n\n##\u52d5\u4f5c\u78ba\u8a8d\nIE, Chrome, Firefox \u3067\u30da\u30fc\u30b8\u3092\u958b\u3044\u3066\u3001 IE \u3067\u30c6\u30ad\u30b9\u30c8\u3092\u5165\u529b\u3001\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3002\n\n![websocket.JPG](https://qiita-image-store.s3.amazonaws.com/0/28302/cd7ef833-ae83-ec7a-b5c4-86d3f2cd3c16.jpeg)\n\n\u3059\u308b\u3068\u3001 Chrome, Firefox \u306b IE \u3067\u5165\u529b\u3057\u305f\u6587\u5b57\u304c\u51fa\u529b\u3055\u308c\u308b\u3002\n\n##\u8aac\u660e\n- `Session.getOpenSessions()` \u3067\u3001\u73fe\u5728\u63a5\u7d9a\u4e2d\u306e\u5168\u3066\u306e\u30bb\u30c3\u30b7\u30e7\u30f3\u3092\u53d6\u5f97\u3067\u304d\u308b\u3002\n\n##\u554f\u984c\u70b9\n\u3053\u306e\u5b9f\u88c5\u65b9\u6cd5\u3067\u3001\u30d6\u30ed\u30fc\u30c9\u30ad\u30e3\u30b9\u30c8\u306f\u554f\u984c\u306a\u304f\u5b9f\u88c5\u3067\u304d\u308b\u3002\n\n\u3057\u304b\u3057\u3001\u3053\u306e\u5b9f\u88c5\u306b\u306f\u7121\u99c4\u304c\u591a\u3044\u3002\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u9001\u4fe1\u3059\u308b\u30c7\u30fc\u30bf\u306f\u5168\u3066\u540c\u3058\u5185\u5bb9\u3060\u304c\u3001\u9001\u4fe1\u3059\u308b\u305f\u3081\u306e\u5f62\u5f0f\u306b\u30c7\u30fc\u30bf\u3092\u5909\u63db\u3059\u308b\u51e6\u7406\u304c\u6bce\u56de\u884c\u308f\u308c\u3066\u3044\u308b\u3002\n\n\u540c\u3058\u30c7\u30fc\u30bf\u306f\u4f7f\u3044\u307e\u308f\u305b\u308b\u3088\u3046\u306b\u3059\u308b\u3068\u52b9\u7387\u304c\u826f\u3044\u304b\u3001\u73fe\u72b6 WebSocket \u306e API \u306b\u306f\u3053\u308c\u3092\u5b9f\u73fe\u3059\u308b\u3082\u306e\u304c\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u306a\u3044\u3002\n\n\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u5b9f\u88c5\u3067\u3042\u308b Tyrus \u3092\u4f7f\u3063\u3066\u3044\u308c\u3070\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5b9f\u88c5\u3059\u308b\u3053\u3068\u3067\u3053\u306e\u7121\u99c4\u3092\u56de\u907f\u3067\u304d\u308b\u3002\n\n```java:\n@OnMessage\npublic void onMessage(Session s, String m) {\n  ((TyrusSession) s).broadcast(m);\n}\n```\n\n\u4eca\u5f8c\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u3067\u6539\u5584\u3055\u308c\u308b\u304b\u3082\u3057\u308c\u306a\u3044\u3002\n\n**\u53c2\u8003**\n- [Oracle Blogs \u65e5\u672c\u8a9e\u306e\u307e\u3068\u3081: [Java] Optimized WebSocket broadcast](http://orablogs-jp.blogspot.jp/2013/12/optimized-websocket-broadcast.html)\n\n#\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\n##\u5b9f\u88c5\n```java:\npackage sample.websocket;\n\nimport javax.websocket.OnClose;\nimport javax.websocket.OnError;\nimport javax.websocket.OnOpen;\nimport javax.websocket.Session;\nimport javax.websocket.server.ServerEndpoint;\n\n@ServerEndpoint(\"/event\")\npublic class SampleWebSocket {\n    \n    @OnOpen\n    public void onOpen(Session session) {\n        System.out.println(\"open : \" + session.getId());\n    }\n    \n    @OnClose\n    public void onClose(Session session) {\n        System.out.println(\"close : \" + session.getId());\n    }\n    \n    @OnError\n    public void onError(Session session, Throwable cause) {\n        System.out.println(\"error : \" + session.getId() + \", \" + cause.getMessage());\n    }\n}\n```\n\n```js:\nnew WebSocket('ws://localhost:8080/websocket/event');\n```\n\n##\u52d5\u4f5c\u78ba\u8a8d\n\u30d6\u30e9\u30a6\u30b6\u3067 `http://localhost:8080/websocket/` \u3092\u8868\u793a\u3002\n\n```text:\u30b5\u30fc\u30d0\u30fc\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\nopen : 0\n```\n\nF5 \u3067\u753b\u9762\u3092\u518d\u63cf\u753b\u3002\n\n```text:\u30b5\u30fc\u30d0\u30fc\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\nclose : 0\nopen : 1\n```\n\n\u30d6\u30e9\u30a6\u30b6\u3092\u9589\u3058\u308b\u3002\n\n```text:\u30b5\u30fc\u30d0\u30fc\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\nerror : 1, java.util.concurrent.ExecutionException: java.io.IOException: \u78ba\u7acb\u3055\u308c\u305f\u63a5\u7d9a\u304c\u30db\u30b9\u30c8 \u30b3\u30f3\u30d4\u30e5\u30fc\u30bf\u30fc\u306e\u30bd\u30a6\u30c8\u30a6\u30a7\u30a2\u306b\u3088\u3063\u3066\u4e2d\u6b62\u3055\u308c\u307e\u3057\u305f\u3002\nclose : 1\n```\n\n##\u8aac\u660e\n- `@OnOpen` \u3067\u63a5\u7d9a\u958b\u59cb\u6642\u3001 `@OnClose` \u3067\u63a5\u7d9a\u7d42\u4e86\u6642\u3001 `@OnError` \u3067\u901a\u4fe1\u30a8\u30e9\u30fc\u6642\u306e\u51e6\u7406\u3092\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u3067\u304d\u308b\u3002\n- WebSocket \u306e\u30bb\u30c3\u30b7\u30e7\u30f3\u3068 HttpServletSession \u306f\u5b8c\u5168\u306b\u5225\u7269\u3002\n- \u30d6\u30e9\u30a6\u30b6\u304c\u518d\u63cf\u753b\u3055\u308c\u308c\u3070 JavaScript \u3082\u5b9f\u884c\u3055\u308c\u76f4\u3059\u306e\u3067\u3001\u524d\u306e\u63a5\u7d9a\uff08\u30bb\u30c3\u30b7\u30e7\u30f3\uff09\u306f\u5207\u65ad\u3055\u308c\u308b\u3002\n\n#\u30d1\u30b9\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u4f7f\u7528\u3059\u308b\n##\u5b9f\u88c5\n```java:\npackage sample.websocket;\n\nimport javax.websocket.OnClose;\nimport javax.websocket.OnMessage;\nimport javax.websocket.OnOpen;\nimport javax.websocket.server.PathParam;\nimport javax.websocket.server.ServerEndpoint;\n\n@ServerEndpoint(\"/pathparam/{string}/{number}\")\npublic class SampleWebSocket {\n\n    @OnOpen\n    public void open(@PathParam(\"string\") String string, @PathParam(\"number\") int number) {\n        System.out.printf(\"OnOpen : string=%s, number=%d%n\", string, number);\n    }\n    \n    @OnMessage\n    public void message(String message, @PathParam(\"string\") String string, @PathParam(\"number\") int number) {\n        System.out.printf(\"Message : message=%s, string=%s, number=%d%n\", message, string, number);\n    }\n    \n    @OnClose\n    public void close(@PathParam(\"string\") String string, @PathParam(\"number\") int number) {\n        System.out.printf(\"Close : string=%s, number=%d%n\", string, number);\n    }\n}\n```\n\n```html:\n<!DOCTYPE html>\n<html>\n  <head>\n    <title>WebSocket Sample</title>\n    <script src=\"jquery.min.js\"></script>\n    <script src=\"script.js\"></script>\n  </head>\n  <body>\n    <button id=\"hoge\">hoge</button>\n    <button id=\"fuga\">fuga</button>\n  </body>\n</html>\n```\n\n```js:\n$(function() {\n    $('#hoge').on('click', function() {\n        var ws = new WebSocket('ws://localhost:8080/websocket/pathparam/hoge/11');\n        ws.onopen = function() {\n            ws.send('hoge message');\n            ws.close();\n        };\n    });\n    \n    $('#fuga').on('click', function() {\n        var ws = new WebSocket('ws://localhost:8080/websocket/pathparam/fuga/22');\n        ws.onopen = function() {\n            ws.send('fuga message');\n            ws.close();\n        };\n    });\n});\n```\n\n##\u52d5\u4f5c\u78ba\u8a8d\n\u30d6\u30e9\u30a6\u30b6\u3067\u30da\u30fc\u30b8\u3092\u958b\u3044\u3066\u3001\u300choge\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3002\n\n```text:\u30b5\u30fc\u30d0\u30fc\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\nOnOpen : string=hoge, number=11\nMessage : message=hoge message, string=hoge, number=11\nClose : string=hoge, number=11\n```\n\n\u300cfuga\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3002\n\n```text:\u30b5\u30fc\u30d0\u30fc\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\nOnOpen : string=fuga, number=22\nMessage : message=fuga message, string=fuga, number=22\nClose : string=fuga, number=22\n```\n\n##\u8aac\u660e\n- `@ServerEndpoint` \u306e `value` \u5c5e\u6027\u306b\u6307\u5b9a\u3059\u308b\u30d1\u30b9\u306b\u3001 `{\u30d1\u30e9\u30e1\u30fc\u30bf\u540d}` \u3068\u3044\u3046\u5f62\u5f0f\u3067\u30d1\u30b9\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u5b9a\u7fa9\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n- \u30d1\u30b9\u30d1\u30e9\u30e1\u30fc\u30bf\u306f\u3001 `@OnOpen`, `@OnMessage`, `@OnClose`, `@OnError` \u306a\u3069\u306e\u5404\u30e1\u30bd\u30c3\u30c9\u3067\u5f15\u6570\u3068\u3057\u3066\u53d7\u3051\u53d6\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n- \u30e1\u30bd\u30c3\u30c9\u5f15\u6570\u306b\u306f\u3001 `@PathParam(\"\u30d1\u30e9\u30e1\u30fc\u30bf\u540d\")` \u3068\u3044\u3046\u5f62\u3067\u53d7\u3051\u53d6\u308b\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u6307\u5b9a\u3059\u308b\u3002\n- \u57fa\u672c\u306f `String` \u3060\u304c\u3001 `int` \u306a\u3069\u306e\u30d7\u30ea\u30df\u30c6\u30a3\u30d6\u578b\u3067\u53d7\u3051\u53d6\u308b\u3053\u3068\u3082\u53ef\u80fd\u3002\n\n#\u63a5\u7d9a\u3092\u9589\u3058\u308b\n##\u30b5\u30fc\u30d0\u30fc\u5074\u304b\u3089\u9589\u3058\u308b\n###\u5b9f\u88c5\n```java:\npackage sample.websocket;\n\nimport java.io.IOException;\n\nimport javax.websocket.OnMessage;\nimport javax.websocket.Session;\nimport javax.websocket.server.ServerEndpoint;\n\n@ServerEndpoint(\"/close\")\npublic class SampleWebSocket {\n    \n    @OnMessage\n    public void close(String message, Session session) throws IOException {\n        session.close();\n    }\n}\n```\n\n```js:\nvar ws = new WebSocket('ws://localhost:8080/websocket/close');\n\nws.onopen = function() {\n    ws.send(null);\n}\n\nws.onclose = function(closeEvent) {\n    console.log('code = ' + closeEvent.code + ', reason = ' + closeEvent.reason);\n};\n```\n\n###\u52d5\u4f5c\u78ba\u8a8d\n```text:\u30d6\u30e9\u30a6\u30b6\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\ncode = 1000, reason =  \n```\n\n##\u30d6\u30e9\u30a6\u30b6\u5074\u304b\u3089\u9589\u3058\u308b\n###\u5b9f\u88c5\n```js:\nvar ws = new WebSocket('ws://localhost:8080/websocket/close');\n\nws.onopen = function() {\n    ws.close();\n}\n```\n\n```java:\npackage sample.websocket;\n\nimport java.io.IOException;\n\nimport javax.websocket.CloseReason;\nimport javax.websocket.OnClose;\nimport javax.websocket.Session;\nimport javax.websocket.server.ServerEndpoint;\n\n@ServerEndpoint(\"/close\")\npublic class SampleWebSocket {\n    \n    @OnClose\n    public void onClose(Session session, CloseReason reason) throws IOException {\n        System.out.println(\"code = \" + reason.getCloseCode().getCode() + \", reason = \" + reason.getReasonPhrase());\n    }\n}\n```\n\n###\u52d5\u4f5c\u78ba\u8a8d\n```text:\u30b5\u30fc\u30d0\u30fc\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\ncode = 1000, reason = null\n```\n\n##\u8aac\u660e\n- \u30b5\u30fc\u30d0\u30fc\u304b\u3089\u5207\u65ad\u3059\u308b\u5834\u5408\u306f\u3001 `Session#close()` \u30e1\u30bd\u30c3\u30c9\u3092\u4f7f\u7528\u3059\u308b\u3002\n- \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u5207\u65ad\u3059\u308b\u5834\u5408\u306f\u3001 `WebSocket#close()` \u30e1\u30bd\u30c3\u30c9\u3092\u4f7f\u7528\u3059\u308b\u3002\n\n#ServerEndpoint \u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306f\u30bb\u30c3\u30b7\u30e7\u30f3\u3054\u3068\u306b\u751f\u6210\u3055\u308c\u308b\n##\u5b9f\u88c5\n```java:\npackage sample.websocket;\n\nimport javax.websocket.OnMessage;\nimport javax.websocket.server.ServerEndpoint;\n\n@ServerEndpoint(\"/instance\")\npublic class SampleWebSocket {\n    \n    @OnMessage\n    public void message(String message) {\n        System.out.println(this.hashCode());\n    }\n}\n```\n\n```html:\n<!DOCTYPE html>\n<html>\n  <head>\n    <title>WebSocket Sample</title>\n    <script src=\"jquery.min.js\"></script>\n    <script src=\"script.js\"></script>\n  </head>\n  <body>\n    <button id=\"send\">Send</button>\n  </body>\n</html>\n```\n\n```js:\n$(function() {\n    var ws = new WebSocket('ws://localhost:8080/websocket/instance');\n\n    ws.onopen = function() {\n        $('#send').on('click', function() {\n            ws.send('message');\n        });\n    }\n});\n```\n\n##\u52d5\u4f5c\u78ba\u8a8d\n\u30d6\u30e9\u30a6\u30b6\uff08Chrome\uff09\u3092\u958b\u304d\u3001\u300cSend\u300d\u30dc\u30bf\u30f3\u3092\u4f55\u56de\u304b\u30af\u30ea\u30c3\u30af\u3002\n\n```text:\u30b5\u30fc\u30d0\u30fc\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\n1962593639\n1962593639\n1962593639\n1962593639\n```\n\n\u65b0\u3057\u3044\u30bf\u30d6\u3067\u30da\u30fc\u30b8\u3092\u958b\u304d\u3001\u305d\u3061\u3089\u3067\u300cSend\u300d\u30dc\u30bf\u30f3\u3092\u4f55\u56de\u304b\u30af\u30ea\u30c3\u30af\u3002\n\n```text:\u30b5\u30fc\u30d0\u30fc\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\n2050833800\n2050833800\n2050833800\n2050833800\n```\n\nF5\u3067\u753b\u9762\u3092\u518d\u63cf\u753b\u3057\u3066\u304b\u3089\u3001\u300cSend\u300d\u30dc\u30bf\u30f3\u3092\u4f55\u56de\u304b\u30af\u30ea\u30c3\u30af\u3002\n\n```text:\u30b5\u30fc\u30d0\u30fc\u5074\n1334674039\n1334674039\n1334674039\n```\n\n##\u8aac\u660e\nServerEndpoint \u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306f\u3001\u30bb\u30c3\u30b7\u30e7\u30f3\u3054\u3068\uff08\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u3054\u3068\uff09\u306b\u4f5c\u6210\u3055\u308c\u308b\u3002\n\n\uff11\u3064\u306e\u30bb\u30c3\u30b7\u30e7\u30f3\u306e\u4e2d\u3067\u306f\u3001\u5e38\u306b\u540c\u3058 ServerEndpoint \u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u5229\u7528\u3055\u308c\u308b\u3002\n\u307e\u305f\u3001 ServerEndpoint \u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306f\u5e38\u306b\uff11\u3064\u306e\u30b9\u30ec\u30c3\u30c9\u3068\u3060\u3051\u95a2\u9023\u4ed8\u3051\u3089\u308c\u308b\u3002\n\n\u3064\u307e\u308a\u3001\u30bb\u30c3\u30b7\u30e7\u30f3\u3054\u3068\u306e\u60c5\u5831\u3092\u4fdd\u6301\u3057\u3066\u304a\u304d\u305f\u3044\u5834\u5408\u306f\u3001 ServerEndpoint \u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30d5\u30a3\u30fc\u30eb\u30c9\u306b\u4fdd\u6301\u3057\u3066\u304a\u3051\u3070\u826f\u3044\u3002\n\n> Note:\n> As opposed to servlets, WebSocket endpoints are instantiated multiple times.\n> \uff08\u7565\uff09\n> Each instance is associated with one and only one connection. This facilitates keeping user state for each connection and makes development easier, because there is only one thread executing the code of an endpoint instance at any given time.\n\n[The Java EE 7 Tutorial:Creating WebSocket Applications in the Java EE Platform | Java EE Documentation](https://docs.oracle.com/javaee/7/tutorial/doc/websocket002.htm)\n\n#\u30b5\u30fc\u30d0\u30fc\u304b\u3089\u81ea\u767a\u7684\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u4fe1\u3059\u308b\n\u3053\u3053\u307e\u3067\u306e\u5b9f\u88c5\u65b9\u6cd5\u3060\u3068\u3001\u30b5\u30fc\u30d0\u30fc\u5074\u304b\u3089\u81ea\u767a\u7684\u306b\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u308b\u3053\u3068\u304c\u3067\u304d\u306a\u3044\u3002\n\n\u30b5\u30fc\u30d0\u30fc\u5074\u304b\u3089\u81ea\u767a\u7684\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u4fe1\u3059\u308b\u306b\u306f\u3001 ServerEndpoint \u306e static \u30d5\u30a3\u30fc\u30eb\u30c9\u306b Session \u3092\u4fdd\u6301\u3057\u3066\u304a\u304d\u3001 static \u30e1\u30bd\u30c3\u30c9\u3092\u4ecb\u3057\u3066 Session \u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3002\n\n##\u5b9f\u88c5\n```java:SampleWebSocket.java\npackage sample.websocket;\n\nimport java.text.SimpleDateFormat;\nimport java.util.Date;\nimport java.util.Queue;\nimport java.util.concurrent.ConcurrentLinkedQueue;\nimport java.util.concurrent.Executors;\nimport java.util.concurrent.ScheduledExecutorService;\nimport java.util.concurrent.TimeUnit;\n\nimport javax.websocket.OnClose;\nimport javax.websocket.OnOpen;\nimport javax.websocket.Session;\nimport javax.websocket.server.ServerEndpoint;\n\n@ServerEndpoint(\"/broadcast\")\npublic class SampleWebSocket {\n    \n    private static final Queue<Session> sessions = new ConcurrentLinkedQueue<>();\n    \n    static {\n        ScheduledExecutorService service = Executors.newSingleThreadScheduledExecutor();\n        service.scheduleWithFixedDelay(SampleWebSocket::broadcast, 5, 5, TimeUnit.SECONDS);\n    }\n    \n    @OnOpen\n    public void connect(Session session) {\n        sessions.add(session);\n    }\n    \n    @OnClose\n    public void remove(Session session) {\n        sessions.remove(session);\n    }\n    \n    public static void broadcast() {\n        Date now = new Date();\n        SimpleDateFormat formatter = new SimpleDateFormat(\"yyyy/MM/dd HH:mm:ss\");\n        \n        sessions.forEach(session -> {\n            session.getAsyncRemote().sendText(\"Broadcast : \" + formatter.format(now));\n        });\n    }\n}\n```\n\n```html:\n<!DOCTYPE html>\n<html>\n  <head>\n    <title>WebSocket Sample</title>\n    <script src=\"jquery.min.js\"></script>\n    <script src=\"script.js\"></script>\n  </head>\n  <body>\n    <span id=\"message\"></span>\n  </body>\n</html>\n```\n\n```js:\n$(function() {\n    var ws = new WebSocket('ws://localhost:8080/websocket/broadcast');\n    \n    ws.onmessage = function(e) {\n        $('#message').text(e.data);\n    };\n});\n```\n\n##\u52d5\u4f5c\u78ba\u8a8d\n\u30d6\u30e9\u30a6\u30b6\u3092\u3044\u304f\u3064\u304b\u7acb\u3061\u4e0a\u3052\u3066\u3001 `http://lcoalhost:8080/broadcast` \u3092\u958b\u304f\u3002\n\n\u6700\u521d\u306e\u30a2\u30af\u30bb\u30b9\u304b\u3089\uff15\u79d2\u307b\u3069\u7d4c\u904e\u3059\u308b\u3068\u3001\u5404\u30d6\u30e9\u30a6\u30b6\u306b\u73fe\u5728\u6642\u523b\u304c\u51fa\u529b\u3055\u308c\u308b\u3002\n\n![websocket.JPG](https://qiita-image-store.s3.amazonaws.com/0/28302/2330d1eb-8f3f-7469-f870-68d456864727.jpeg)\n\n\u4ee5\u5f8c\u3001\uff15\u79d2\u3054\u3068\u306b\u6642\u523b\u306e\u8868\u793a\u304c\u66f4\u65b0\u3055\u308c\u308b\u3002\n\n##\u8aac\u660e\n- `@OnOpen` \u306e\u3068\u304d\u306b `Session` \u3092 static \u5ba3\u8a00\u3057\u305f `ConcurrentLinkedQueue` \u306b\u683c\u7d0d\u3057\u3066\u3044\u308b\u3002\n- \u307e\u305f\u3001 `@OnClose` \u306e\u3068\u304d\u306b `Session` \u3092\u30ad\u30e5\u30fc\u304b\u3089\u524a\u9664\u3057\u3066\u3044\u308b\u3002\n\n\u81ea\u4f5c\u306e static \u30d5\u30a3\u30fc\u30eb\u30c9\u306b\u4fdd\u5b58\u3057\u3066\u7ba1\u7406\u3059\u308b\u3068\u3044\u3046\u306e\u304c\u3001\u306a\u3093\u3060\u304b\u5927\u4e08\u592b\u306a\u306e\u304b\u306a\u3068\u4e0d\u5b89\u306b\u306a\u308b\u3051\u3069\u3001 [\u516c\u5f0f\u306e\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb](https://docs.oracle.com/javaee/7/tutorial/doc/websocket011.htm#BABGCEHE) \u304c\u3053\u3046\u306a\u3063\u3066\u3044\u308b\u306e\u3060\u304b\u3089\u3001\u304d\u3063\u3068\u5927\u4e08\u592b\u306a\u306e\u3060\u308d\u3046\u3002\n\n\u3061\u306a\u307f\u306b\u3001 JavaEE \u74b0\u5883\u306a\u3089 CDI \u306e Event \u3092\u4f7f\u3063\u3066\u3082\u3046\u3061\u3087\u3063\u3068\u30b9\u30de\u30fc\u30c8\uff1f\u306b\u5b9f\u88c5\u3059\u308b\u65b9\u6cd5\u304c Stack Overflow \u3067\u7d39\u4ecb\u3055\u308c\u3066\u3044\u308b\u3002\n\n[java - How to get an existing websocket instance - Stack Overflow](http://stackoverflow.com/questions/18481597/how-to-get-an-existing-websocket-instance)\n\n#\u30e1\u30c3\u30bb\u30fc\u30b8\u3092 Java \u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306b\u30de\u30c3\u30d4\u30f3\u30b0\u3059\u308b\u305f\u3081\u306e\u4ed5\u7d44\u307f\u3092\u5229\u7528\u3059\u308b\n##\u30c7\u30b3\u30fc\u30c0\u30fc\uff08\u30e1\u30c3\u30bb\u30fc\u30b8\u2192Java\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\uff09\n###\u5b9f\u88c5\n```java:Hoge.java\npackage sample.websocket;\n\npublic class Hoge {\n    \n    public int id;\n    public String name;\n    \n    @Override\n    public String toString() {\n        return \"Hoge [id=\" + id + \", name=\" + name + \"]\";\n    }\n}\n```\n\n```java:HogeDecoder.java\npackage sample.websocket;\n\nimport javax.websocket.DecodeException;\nimport javax.websocket.Decoder;\nimport javax.websocket.EndpointConfig;\n\npublic class HogeDecoder implements Decoder.Text<Hoge> {\n\n    @Override\n    public void init(EndpointConfig config) {\n        System.out.println(\"init\");\n    }\n\n    @Override\n    public boolean willDecode(String s) {\n        System.out.println(\"willDecode\");\n        return true;\n    }\n\n    @Override\n    public Hoge decode(String s) throws DecodeException {\n        System.out.println(\"decode\");\n        \n        String[] tokens = s.split(\":\");\n        \n        Hoge hoge = new Hoge();\n        hoge.id = Integer.parseInt(tokens[0]);\n        hoge.name = tokens[1];\n        \n        return hoge;\n    }\n    \n    @Override\n    public void destroy() {\n        System.out.println(\"destroy\");\n    }\n}\n```\n\n```java:SampleWebSocket.java\npackage sample.websocket;\n\nimport javax.websocket.OnMessage;\nimport javax.websocket.server.ServerEndpoint;\n\n@ServerEndpoint(value=\"/decode\", decoders=HogeDecoder.class)\npublic class SampleWebSocket {\n    \n    @OnMessage\n    public void message(Hoge hoge) {\n        System.out.println(hoge);\n    }\n}\n```\n\n```html:\n<!DOCTYPE html>\n<html>\n  <head>\n    <title>WebSocket Sample</title>\n    <script src=\"jquery.min.js\"></script>\n    <script src=\"script.js\"></script>\n  </head>\n  <body>\n    <button id=\"send\">Send</button>\n    <button id=\"close\">Close</button>\n  </body>\n</html>\n```\n\n```js:\n$(function() {\n    var ws = new WebSocket('ws://localhost:8080/websocket/decode');\n    \n    ws.onopen = function(e) {\n        $('#send').on('click', function() {\n            ws.send('12:Hoge');\n        });\n\n        $('#close').on('click', function() {\n            ws.close();\n        });\n    };\n});\n```\n\n###\u52d5\u4f5c\u78ba\u8a8d\nWeb \u30d6\u30e9\u30a6\u30b6\u3067\u30da\u30fc\u30b8\u3092\u8868\u793a\u3002\n\n```text:\u30b5\u30fc\u30d0\u30fc\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\ninit\n```\n\n\u300cSend\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3002\n\n```text:\u30b5\u30fc\u30d0\u30fc\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\nwillDecode\ndecode\nHoge [id=12, name=Hoge]\n```\n\n\u3082\u3046\u4e00\u56de\u30af\u30ea\u30c3\u30af\u3002\n\n```text:\u30b5\u30fc\u30d0\u30fc\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\nwillDecode\ndecode\nHoge [id=12, name=Hoge]\n```\n\n\u300cClose\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3002\n\n```text:\u30b5\u30fc\u30d0\u30fc\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\ndestroy\n```\n\n###\u8aac\u660e\n- `Decoder` \u3092\u5b9f\u88c5\u3057\u305f\u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3057\u3001 `@ServerEndpoint` \u306e `decoders` \u306b\u6307\u5b9a\u3059\u308b\u3002\n- `Decoder` \u306b\u306f\u30c6\u30ad\u30b9\u30c8\u3092\u5909\u63db\u3059\u308b `Text<T>` \u3084\u3001\u30d0\u30a4\u30ca\u30ea\u30c7\u30fc\u30bf\u3092\u5909\u63db\u3059\u308b `Binary<T>` \u3068\u3044\u3046\u30b5\u30d6\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u304c\u7528\u610f\u3055\u308c\u3066\u304a\u308a\u3001\u5b9f\u969b\u306f\u3053\u308c\u3089\u3092\u5b9f\u88c5\u3057\u305f\u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3002\n- \u30c7\u30b3\u30fc\u30c0\u30fc\u304c\u6307\u5b9a\u3055\u308c\u3066\u3044\u308b\u3068\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u306f\u4e00\u65e6\u3053\u306e\u30c7\u30b3\u30fc\u30c0\u30fc\u306b\u6e21\u3055\u308c\u308b\u3002\n- \u30c7\u30b3\u30fc\u30c0\u30fc\u3067\u306f\u3001\u4ee5\u4e0b\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u5b9f\u88c5\u3059\u308b\u3002\n\n|\u30e1\u30bd\u30c3\u30c9|\u8aac\u660e|\n|:--|:--|\n|init|\u521d\u671f\u5316\u51e6\u7406\u3002\u30bb\u30c3\u30b7\u30e7\u30f3\u304c\u78ba\u7acb\u3055\u308c\u305f\u3068\u304d\u306b\uff11\u5ea6\u3060\u3051\u5b9f\u884c\u3055\u308c\u308b\u3002|\n|willDecode|\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u30c7\u30b3\u30fc\u30c9\u3059\u308b\u304b\u3069\u3046\u304b\u3092\u5224\u5b9a\u3059\u308b\u3002false\u3092\u8fd4\u3057\u305f\u5834\u5408\u3001 `decode()` \u30e1\u30bd\u30c3\u30c9\u306f\u5b9f\u884c\u3055\u308c\u306a\u3044\u3002|\n|decode|\u30e1\u30c3\u30bb\u30fc\u30b8\u3092 Java \u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306b\u5909\u63db\u3059\u308b\u30c7\u30b3\u30fc\u30c9\u51e6\u7406\u3092\u5b9f\u88c5\u3059\u308b\u3002|\n|destroy|\u30bb\u30c3\u30b7\u30e7\u30f3\u304c\u7834\u68c4\u3055\u308c\u308b\u3068\u304d\u306b\uff11\u5ea6\u3060\u3051\u5b9f\u884c\u3055\u308c\u308b\u3002|\n\n- `@OnMessage` \u3067\u30a2\u30ce\u30c6\u30fc\u30c8\u3057\u305f ServerEndpoint \u306e\u30e1\u30bd\u30c3\u30c9\u306b\u306f\u3001\u30c7\u30b3\u30fc\u30c0\u30fc\u304c\u4f5c\u6210\u3057\u305f Java \u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u304c\u5f15\u6570\u306b\u6e21\u3055\u308c\u308b\u3002\n\n##\u30a8\u30f3\u30b3\u30fc\u30c0\u30fc\uff08Java\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u2192\u30e1\u30c3\u30bb\u30fc\u30b8\uff09\n###\u5b9f\u88c5\n```java:HogeEncoder.java\npackage sample.websocket;\n\nimport javax.websocket.EncodeException;\nimport javax.websocket.Encoder;\nimport javax.websocket.EndpointConfig;\n\npublic class HogeEncoder implements Encoder.Text<Hoge>{\n\n    @Override\n    public void init(EndpointConfig config) {\n        System.out.println(\"init\");\n    }\n\n    @Override\n    public String encode(Hoge hoge) throws EncodeException {\n        System.out.println(\"encode\");\n        return hoge.id + \":\" + hoge.name;\n    }\n\n    @Override\n    public void destroy() {\n        System.out.println(\"destroy\");\n        \n    }\n}\n```\n\n```java:SampleWebSocket.java\npackage sample.websocket;\n\nimport javax.websocket.OnMessage;\nimport javax.websocket.server.ServerEndpoint;\n\n@ServerEndpoint(value=\"/encode\", encoders=HogeEncoder.class)\npublic class SampleWebSocket {\n    \n    @OnMessage\n    public Hoge message(String message) {\n        System.out.println(\"message\");\n        Hoge hoge = new Hoge();\n        hoge.id = 20;\n        hoge.name = \"HOGE\";\n        \n        return hoge;\n    }\n}\n```\n\n```js:\n$(function() {\n    var ws = new WebSocket('ws://localhost:8080/websocket/encode');\n    \n    ws.onopen = function() {\n        $('#send').on('click', function() {\n            ws.send(null);\n        });\n\n        $('#close').on('click', function() {\n            ws.close();\n        });\n    };\n    \n    ws.onmessage = function(e) {\n        console.log(e.data);\n    };\n});\n```\n\n###\u52d5\u4f5c\u78ba\u8a8d\n\u30d6\u30e9\u30a6\u30b6\u3067\u30da\u30fc\u30b8\u3092\u8868\u793a\u3002\n\n```text:\u30b5\u30fc\u30d0\u30fc\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\ninit\n```\n\n\u300cSend\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3002\n\n```text:\u30b5\u30fc\u30d0\u30fc\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\nmessage\nencode\n```\n\n```text:\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\n20:HOGE\n```\n\n\u300cClose\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3002\n\n```text:\u30b5\u30fc\u30d0\u30fc\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\ndestroy\n```\n\n###\u8aac\u660e\n- \u30c7\u30b3\u30fc\u30c0\u30fc\u306e\u9006\u3002\u5909\u63db\u306e\u5411\u304d\u304c\u9006\u306b\u306a\u3063\u305f\u3053\u3068\u4ee5\u5916\u3001\u7279\u306b\u5927\u304d\u306a\u9055\u3044\u306f\u306a\u3044\u3002\n\n#\u304a\u307e\u3051\nEncoder \u3068 Decoder \u306f\u3001\u305d\u306e\u307e\u307e\u3060\u3068\u30d1\u30e9\u30e1\u30fc\u30bf\u3067\u4f7f\u3046\u578b\u306e\u6570\u3060\u3051\u4f5c\u6210\u3057\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u305f\u3081\u3001\u3061\u3087\u3063\u3068\u30a4\u30b1\u3066\u306a\u3044\u3002\n\n\u3068\u3044\u3046\u3053\u3068\u3067\u3001 json \u3068\u4efb\u610f\u306e\u578b\u3068\u3092\u5909\u63db\u3059\u308b Encoder \u3068 Decoder \u3092\u5b9f\u88c5\u3057\u3066\u307f\u305f\u3002\n\n##build.gradle\n```groovy:build.gradle\ndependencies {\n    compile 'com.fasterxml.jackson.core:jackson-databind:2.4.3'\n    providedCompile 'javax.websocket:javax.websocket-api:1.1'\n}\n```\n\njson \u306e\u5909\u63db\u306b\u306f Jackson \u3092\u5229\u7528\u3059\u308b\u3002\n\n##\u5b9f\u88c5\n```java:JsonConverter.java\npackage sample.websocket;\n\nimport java.io.IOException;\nimport java.lang.reflect.Method;\nimport java.lang.reflect.Parameter;\nimport java.util.Map;\nimport java.util.function.Predicate;\nimport java.util.stream.Stream;\n\nimport javax.websocket.DecodeException;\nimport javax.websocket.Decoder;\nimport javax.websocket.EncodeException;\nimport javax.websocket.Encoder;\nimport javax.websocket.EndpointConfig;\nimport javax.websocket.OnMessage;\nimport javax.websocket.Session;\nimport javax.websocket.server.PathParam;\n\nimport com.fasterxml.jackson.core.JsonProcessingException;\nimport com.fasterxml.jackson.databind.ObjectMapper;\n\npublic class JsonConverter implements Encoder.Text<Object>, Decoder.Text<Object> {\n    \n    public static final String ENDPOINT_CLASS = \"json.endpoint.class\";\n    \n    private ObjectMapper mapper = new ObjectMapper();\n    private Map<String, Object> userProperties;\n    private Class<?> messageClass;\n    \n    @Override\n    public void init(EndpointConfig config) {\n        this.userProperties = config.getUserProperties();\n    }\n\n    @Override\n    public Object decode(String s) throws DecodeException {\n        try {\n            Class<?> messageClass = this.getMessageClass();\n            return this.mapper.readValue(s, messageClass);\n        } catch (IOException e) {\n            throw new DecodeException(s, \"failed to decode message.\", e);\n        }\n    }\n    \n    private Class<?> getMessageClass() {\n        if (this.messageClass == null) {\n            this.initMessageClass();\n        }\n        \n        return this.messageClass;\n    }\n    \n    private void initMessageClass() {\n        Class<?> endpointClass = (Class<?>)userProperties.get(ENDPOINT_CLASS);\n        \n        Method onMessageMethod = this.findOnMessageMethod(endpointClass);\n        Parameter messageParameter = this.findMessageParameter(onMessageMethod);\n        \n        this.messageClass = messageParameter.getType();\n    }\n    \n    private Method findOnMessageMethod(Class<?> endpointClass) {\n        return this.findFromArray(endpointClass.getMethods(), this::isOnMessageMethod, \"method annotated by @OnMessage is not found.\");\n    }\n    \n    private boolean isOnMessageMethod(Method method) {\n        return method.isAnnotationPresent(OnMessage.class);\n    }\n    \n    private Parameter findMessageParameter(Method onMessageMethod) {\n        return this.findFromArray(onMessageMethod.getParameters(), this::isMessageParameter, \"message parameter is not found.\");\n    }\n    \n    private boolean isMessageParameter(Parameter parameter) {\n        return this.isNotSession(parameter) && this.isNotPathParam(parameter);\n    }\n\n    private boolean isNotSession(Parameter parameter) {\n        return !Session.class.isAssignableFrom(parameter.getType());\n    }\n\n    private boolean isNotPathParam(Parameter parameter) {\n        return !parameter.isAnnotationPresent(PathParam.class);\n    }\n    \n    private <T> T findFromArray(T[] array, Predicate<T> condition, String exceptionMessage) {\n        return Stream.of(array)\n                     .filter(condition)\n                     .findFirst()\n                     .orElseThrow(() -> new RuntimeException(exceptionMessage));\n    }\n\n    @Override\n    public String encode(Object object) throws EncodeException {\n        try {\n            return this.mapper.writeValueAsString(object);\n        } catch (JsonProcessingException e) {\n            throw new EncodeException(object, \"failed to encode message.\", e);\n        }\n    }\n\n    @Override\n    public boolean willDecode(String s) {\n        return true;\n    }\n\n    @Override public void destroy() {/*no use*/}\n}\n```\n\n```java:\npackage sample.websocket;\n\nimport javax.websocket.EndpointConfig;\nimport javax.websocket.OnMessage;\nimport javax.websocket.OnOpen;\nimport javax.websocket.Session;\nimport javax.websocket.server.ServerEndpoint;\n\n@ServerEndpoint(value=\"/json\", encoders=JsonConverter.class, decoders=JsonConverter.class)\npublic class SampleWebSocket {\n\n    @OnOpen\n    public void open(EndpointConfig config) {\n        config.getUserProperties().put(JsonConverter.ENDPOINT_CLASS, SampleWebSocket.class);\n    }\n\n    @OnMessage\n    public Hoge message(Hoge message, Session session) {\n        System.out.println(\"message = \" + message);\n\n        Hoge hoge = new Hoge();\n        hoge.id = 33;\n        hoge.name = \"fuga\";\n\n        return hoge;\n    }\n}\n```\n\n```html:\n<!DOCTYPE html>\n<html>\n  <head>\n    <title>WebSocket Sample</title>\n    <script src=\"jquery.min.js\"></script>\n    <script src=\"script.js\"></script>\n  </head>\n  <body>\n    <button id=\"send\">Send</button>\n    <button id=\"close\">Close</button>\n  </body>\n</html>\n```\n\n```js:\n$(function() {\n    var ws = new WebSocket('ws://localhost:8080/websocket/json');\n    \n    ws.onopen = function() {\n        $('#send').on('click', function() {\n            var message = {id: 15, name: \"Hoge\"};\n            ws.send(JSON.stringify(message));\n        });\n\n        $('#close').on('click', function() {\n            ws.close();\n        });\n    };\n    \n    ws.onmessage = function(e) {\n        console.log(e.data);\n    };\n});\n```\n\n##\u52d5\u4f5c\u78ba\u8a8d\n\u30d6\u30e9\u30a6\u30b6\u3067\u30da\u30fc\u30b8\u3092\u8868\u793a\u3057\u3066\u3001\u300cSend\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3002\n\n```text:\u30b5\u30fc\u30d0\u30fc\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\nmessage = Hoge [id=15, name=Hoge]\n```\n\n```text:\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u30b3\u30f3\u30bd\u30fc\u30eb\u51fa\u529b\n{\"id\":33,\"name\":\"fuga\"}\n```\n\n##\u8aac\u660e\n- `EndpointConfig#getUserProperties()` \u3067\u53d6\u5f97\u3067\u304d\u308b Map \uff08`UserProperties`\uff09\u3092\u4ecb\u3057\u3066\u3001 ServerEndpoint \u306e\u578b\u306e\u60c5\u5831\u3092\u3084\u308a\u53d6\u308a\u3057\u3066\u3044\u308b\u3002\n- `SampleWebSocket` \u306e `open()` \u30e1\u30bd\u30c3\u30c9\u5185\u3067\u3001 ServerEndpoint \u306e\u578b\u3092 `UserProperties` \u306b\u8a2d\u5b9a\u3059\u308b\u3002\n- `JsonConverter` \u5074\u306f\u3001 `init()` \u30e1\u30bd\u30c3\u30c9\u3067 `UserProperties` \u3092\u53d6\u5f97\u3057\u3066\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u5909\u6570\u306b\u4fdd\u5b58\u3057\u3066\u304a\u304f\u3002\n    - `SampleWebSocket` \u306e `open()` \u30e1\u30bd\u30c3\u30c9\u3088\u308a `JsonConverter` \u306e `init()` \u30e1\u30bd\u30c3\u30c9\u304c\u5148\u306b\u547c\u3070\u308c\u308b\u3002\n    - \u3053\u306e\u305f\u3081\u3001\u3053\u306e\u6642\u70b9\u3067\u306f `UserProperties` \u306b\u578b\u60c5\u5831\u306f\u4fdd\u5b58\u3055\u308c\u3066\u3044\u306a\u3044\u3002\n- \u305d\u3057\u3066\u3001 `decode()` \u30e1\u30bd\u30c3\u30c9\u304c\u547c\u3070\u308c\u305f\u3068\u304d\u306b\u5909\u63db\u5f8c\u306e\u578b\u60c5\u5831\u3092\u30ea\u30d5\u30ec\u30af\u30b7\u30e7\u30f3\u3067\u53d6\u5f97\u3057\u3001 Jackson \u3067\u30c7\u30b3\u30fc\u30c9\u3057\u3066\u3044\u308b\u3002\n\n\u3053\u308c\u3067 `JsonConverter` \u306f\u4f7f\u3044\u56de\u3057\u3057\u3084\u3059\u304f\u306a\u308b\u306f\u305a\u3002\n\n#\u53c2\u8003\n- [JSR 356\u2015Java\u6a19\u6e96\u306eWebSocket API - Programming Studio](http://www.coppermine.jp/docs/programming/2013/12/jsr356-fundamental.html)\n- [Tyrus 1.8.3 User Guide](https://tyrus.java.net/documentation/1.8.3/user-guide.html)\n- [WebSocket API (Windows)](http://msdn.microsoft.com/ja-jp/library/ie/hh673567%28v=vs.85%29.aspx)\n"}