{"context": " More than 1 year has passed since last update.\u3044\u307eDiscourse\u8aad\u3093\u3067\u308b\u306e\u3067\u601d\u3044\u3064\u3044\u305f\u3084\u3064\u3092\u601d\u3044\u3064\u3044\u305f\u307e\u307e\u30e1\u30e2\u3063\u3066\u307e\u3059\u3002\n\nconstraints\u3092\u4f7f\u3044\u307e\u3059\nUser\u3068\u3044\u3046Devise\u7528\u306e\u30e2\u30c7\u30eb\u304c\u3042\u308b\u3068\u3057\u3066\u3001\u3044\u308f\u3086\u308bcurrent_user\u306e\u53d6\u5f97\u6210\u529f\u3092\u4ee5\u3066\u627f\u8a8d\u3068\u3057\u307e\u3059\u3002\nclass Constraint::Config\n  def matches?(request)\n    !!warden(request).authenticate(scope: :user)\n  end\n\n  def warden(request)\n    request.env['warden']\n  end\nend\n\n\nroutes.rb\n  scope :configs, module: :users, constraints: Constraint::Config.new do\n    get 'index', to: 'configs#index'\n    get 'password', to: 'passwords#edit'\n    put 'password', to: 'passwords#update'\n  end\n\n  get 'configs/*path', to: ->(env) { [403, {'Content-Type' => 'text/plain'}, ['forbidden']] }\n\n\nDiscourse\u306eadmin\u30eb\u30fc\u30c8\u3067\u306fActionController::RoutingError\u3067\u6295\u3052\u3063\u3071\u306a\u3057\u3067\u3057\u305f\u304c\u3001\u30e6\u30fc\u30b6\u30fc\u30da\u30fc\u30b8\u3067\u3042\u308b\u3053\u3068\u3092\u8003\u616e\u3057\u3066403\u3068\u304b\u4f55\u304b\u51fa\u3059\u307f\u305f\u3044\u306a\u611f\u3058\u3067\u3002\n\n\u3068\u3053\u308d\u3067request_spec\u3067Devise\u30a2\u30ab\u30a6\u30f3\u30c8\u306b\u30b5\u30a4\u30f3\u30a4\u30f3\u3059\u308b\u306b\u306f\nrequest_spec\u30d5\u30a1\u30a4\u30eb\u5185\u3067\ninclude Warden::Test::Helpers\n\n\u3057\u3068\u3044\u3066\nlogin_as @user, scope: :user, :run_callbacks => false\n\n\u53c2\u8003\nRequestSpec\u3067Devise\u3092\u4f7f\u3063\u305f\u30e6\u30fc\u30b6\u30fc\u3067\u30ed\u30b0\u30a4\u30f3\u3055\u305b\u308b\n\u3044\u307e[Discourse](https://github.com/discourse/discourse)\u8aad\u3093\u3067\u308b\u306e\u3067\u601d\u3044\u3064\u3044\u305f\u3084\u3064\u3092\u601d\u3044\u3064\u3044\u305f\u307e\u307e\u30e1\u30e2\u3063\u3066\u307e\u3059\u3002\n\n# constraints\u3092\u4f7f\u3044\u307e\u3059\n\n`User`\u3068\u3044\u3046Devise\u7528\u306e\u30e2\u30c7\u30eb\u304c\u3042\u308b\u3068\u3057\u3066\u3001\u3044\u308f\u3086\u308b`current_user`\u306e\u53d6\u5f97\u6210\u529f\u3092\u4ee5\u3066\u627f\u8a8d\u3068\u3057\u307e\u3059\u3002\n\n```rb\nclass Constraint::Config\n  def matches?(request)\n    !!warden(request).authenticate(scope: :user)\n  end\n\n  def warden(request)\n    request.env['warden']\n  end\nend\n```\n\n```rb:routes.rb\n  scope :configs, module: :users, constraints: Constraint::Config.new do\n    get 'index', to: 'configs#index'\n    get 'password', to: 'passwords#edit'\n    put 'password', to: 'passwords#update'\n  end\n\n  get 'configs/*path', to: ->(env) { [403, {'Content-Type' => 'text/plain'}, ['forbidden']] }\n```\n\nDiscourse\u306eadmin\u30eb\u30fc\u30c8\u3067\u306f`ActionController::RoutingError`\u3067\u6295\u3052\u3063\u3071\u306a\u3057\u3067\u3057\u305f\u304c\u3001\u30e6\u30fc\u30b6\u30fc\u30da\u30fc\u30b8\u3067\u3042\u308b\u3053\u3068\u3092\u8003\u616e\u3057\u3066`403`\u3068\u304b\u4f55\u304b\u51fa\u3059\u307f\u305f\u3044\u306a\u611f\u3058\u3067\u3002\n\n# \u3068\u3053\u308d\u3067request_spec\u3067Devise\u30a2\u30ab\u30a6\u30f3\u30c8\u306b\u30b5\u30a4\u30f3\u30a4\u30f3\u3059\u308b\u306b\u306f\n\nrequest_spec\u30d5\u30a1\u30a4\u30eb\u5185\u3067\n\n```rb\ninclude Warden::Test::Helpers\n```\n\n\u3057\u3068\u3044\u3066\n\n```rb\nlogin_as @user, scope: :user, :run_callbacks => false\n```\n\n\u53c2\u8003\n[RequestSpec\u3067Devise\u3092\u4f7f\u3063\u305f\u30e6\u30fc\u30b6\u30fc\u3067\u30ed\u30b0\u30a4\u30f3\u3055\u305b\u308b](http://319ring.net/blog/archives/2052)\n\n", "tags": ["Rails", "devise"]}