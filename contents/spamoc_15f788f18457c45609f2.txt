{"tags": ["nginx", "Jenkins", "jetty"], "context": "\u4ed6\u306e\u30a2\u30d7\u30ea\u3092jetty\u3067\u52d5\u304b\u3057\u305f\u5b9f\u7e3e\u304c\u3042\u3063\u305f\u306e\u3067war\u304b\u3089jenkins\u3092\u52d5\u304b\u3057\u3066\u307f\u305f\u304c\u3001\u30ed\u30b0\u30a4\u30f3\u3060\u306e\u8a2d\u5b9a\u5909\u66f4\u3060\u306e\u3059\u308b\u5ea6\u306bhttp\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u308c\u3066\u30a4\u30e9\u30a4\u30e9\u3057\u305f\u3063\u3066\u8a71\u3002\nhttp://qiita.com/spamoc/items/fb005dc6e544249035c9 \u3068\u5927\u307e\u304b\u306a\u5185\u5bb9\u306f\u540c\u3058\u3002\u3053\u3063\u3061\u306e\u65b9\u304c\u5099\u5fd8\u9332\u5bc4\u308a\u3002\n\n\u3044\u304d\u3055\u3064\n\njenkins\u3092nginx\u306e\u4e0b\u306b\u7acb\u3066\u3088\u3046\u3068\u3057\u305f\nhttps\u3067\u53d7\u3051\u3066http\u3067jenkins.war\u3092\u52d5\u304b\u3057\u305fjetty\u306b\u6d41\u3059\u3088\u3046\u306b\u3057\u305f\n\u30ed\u30b0\u30a4\u30f3/\u30a2\u30a6\u30c8\u6642\u306bhttp\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u308c\u308b\nhttps\u3057\u304b\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u3067\u8a31\u53ef\u3057\u3066\u306a\u304b\u3063\u305f\u306e\u3067\u6012\u3089\u308c\u308b\n\n\u305d\u3093\u306a\u611f\u3058\u3002\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u3092\u958b\u3051\u308b\u5bfe\u5fdc\u306f\u4eca\u56de\u5165\u308c\u306a\u3044\u3088\u3046\u306b\u3057\u3066\u3044\u308b\u3002\n\n\u3068\u308a\u3042\u3048\u305a\u8a66\u3059\n\nnginx\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3084SSL\u306e\u9375\u4e91\u3005\u306b\u3064\u3044\u3066\u306f\u7701\u7565\u3002\u3068\u306b\u304b\u304f\u30d7\u30ed\u30ad\u30b7\u5468\u308a\u306e\u8a2d\u5b9a\u3092\u3076\u3061\u8fbc\u3080\u3002\n\nssl.conf\nserver {\n    listen       443;\n    server_name  _;\n\n    ssl                  on;\n    ssl_certificate      ssl/cert.crt;\n    ssl_certificate_key  ssl/cert.key;\n\n    ssl_session_timeout  5m;\n    ssl_protocols  TLSv1;\n    ssl_ciphers  ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP;\n    ssl_prefer_server_ciphers   on;\n\n    location /jenkins/ {\n        proxy_pass http://localhost:8080;\n        proxy_redirect off;\n        proxy_set_header Host $host;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Host $host:$server_port;\n        proxy_set_header X-Forwarded-Port $server_port;\n        proxy_set_header X-Forwarded-Server $host;\n        proxy_set_header X-Real-IP $remote_addr;\n    }\n}\n\n\n\njetty\n\n\njetty\u516c\u5f0f\u30da\u30fc\u30b8\u3088\u308a9.3.11.v20160721\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9(\u203b\u3053\u308c\u3092\u66f8\u3044\u3066\u3044\u308b\u73fe\u5728\u3067\u306f9.3.12\u307e\u3067\u51fa\u3066\u3044\u308b)\u3002\u89e3\u51cd\u3057\u3066/etc/jetty\u306b\u914d\u7f6e\u3059\u308b\u3002\n\njenkins\u516c\u5f0f\u30da\u30fc\u30b8\u3088\u308ajenkins.war\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066/etc/jetty/webapps\u306e\u4e2d\u306b\u3076\u3061\u8fbc\u3080\u3002\nwebapps\u306e\u4e0b\u306bjenkins.xml\u3092\u8a2d\u7f6e\u3059\u308b\u3002\n\n\njenkins.xml\n<Configure class=\"org.eclipse.jetty.webapp.WebAppContext\">\n  <Set name=\"contextPath\">/jenkins</Set>\n  <Set name=\"war\"><SystemProperty name=\"jetty.home\" default=\".\"/>/webapps/jenkins.war</Set>\n  <Get name=\"securityHandler\">\n    <Set name=\"loginService\">\n      <New class=\"org.eclipse.jetty.security.HashLoginService\">\n        <Set name=\"name\">Jenkins Realm</Set>\n        <Set name=\"config\"><SystemProperty name=\"jetty.home\" default=\".\"/>/etc/realm.properties</Set>\n      </New>\n    </Set>\n  </Get>\n</Configure>\n\n\n\u3053\u308c\u3067java -jar start.jar\u3059\u308c\u3070\u3072\u3068\u307e\u305a\u52d5\u304f\u3088\u3046\u306b\u306a\u3063\u305f\u3002\n\n\u52d5\u4f5c\u7d50\u679c\n\u6700\u521d\u306b\u66f8\u3044\u305f\u901a\u308a\u3002\u76ee\u3092\u3064\u3076\u308c\u3070\u306a\u3093\u3068\u304b\u306a\u308b\u3093\u3060\u304c\u3001\u64cd\u4f5c\u3059\u308b\u305f\u3073\u306bhttp\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u308c\u3066\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u306b\u306a\u308b\u306e\u3067\u6d41\u77f3\u306b\u4f7f\u3048\u306a\u3044\u3002\n\njenkins\u306e\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u306b\u3064\u3044\u3066\ngithub\u3067\u2193\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u306b\u5bfe\u3057\u3066\"sendRedirect\"\u306a\u3069\u3068\u691c\u7d22\u3057\u3066\u307f\u308b\u3068\u7d50\u69cb\u5f15\u3063\u304b\u304b\u308b\u3002\u3068\u304b\u3044\u308d\u3044\u308d\u6398\u3063\u3066\u3044\u304f\u306b\u5f53\u305f\u3063\u3066\u3053\u308c\u304c\u81ed\u3044\u3068\u7768\u3080\u3002\nhttps://github.com/jenkinsci/jenkins\n\u8272\u3005\u898b\u3066\u307f\u308b\u3068response.sendRedirect(request.getContextPath()+\"/hoge\");\u3068\u3044\u3046\u3088\u3046\u306a\u66f8\u304d\u65b9\u3092\u3057\u3066\u3044\u308b\u3068\u3053\u308d\u304c\u307b\u3068\u3093\u3069\u3067\u3001\u30a2\u30d7\u30ea\u4e0a\u3067\u306f\"/jenkins/hoge\"\u3068\u3044\u3046\u3088\u3046\u306a\u5f62\u3067\u3057\u304b\u30d1\u30b9\u3092\u6e21\u3057\u3066\u3044\u306a\u3044\u3053\u3068\u304c\u5206\u304b\u3063\u305f\u3002\n\nsimplehttpserver\u3067\u6e21\u3057\u3066\u308b\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u78ba\u8a8d\u3057\u3066\u307f\u308b\n\u3072\u3068\u307e\u305ajenkins\u3092\u6b62\u3081\u3066\u2193\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u52d5\u304b\u3057\u3066\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u308b\u3002\n\nsimple.py\n#!/usr/bin/env python\nimport SimpleHTTPServer\nimport SocketServer\n\nclass ServerHandler(SimpleHTTPServer.SimpleHTTPRequestHandler):\n    def do_GET(self):\n        print(self.headers)\n        SimpleHTTPServer.SimpleHTTPRequestHandler.do_GET(self)\n\nHandler = ServerHandler\nSocketServer.TCPServer((\"\", 8080), Handler).serve_forever()\n\n\n\u7d50\u679c:\n127.0.0.1 - - [21/Sep/2016 00:00:00] \"GET /jenkins/ HTTP/1.0\" 404 -\nHost: hoge.example.jp\nX-Forwarded-Proto: https\nX-Forwarded-For: 192.128.0.2\nX-Forwarded-Host: hoge.example.jp:443\nX-Forwarded-Port: 443\nX-Forwarded-Server: hoge.example.jp\nX-Real-IP: 192.128.0.2\n\n\u601d\u3063\u305f\u901a\u308a\u306e\u7d50\u679c\u304c\u8fd4\u3063\u3066\u304d\u3066\u308b\u3002\u3053\u308c\u3067\u3082\u30c0\u30e1\u306a\u306e\u3060\u308d\u3046\u304b\uff1f\n\ntomcat\u3067\u8a66\u3057\u3066\u307f\u308b\n\u4e0b\u8a18\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u3063\u3066javac -classpath \"./lib/servlet-api.jar\" Risa.java\u3068\u3084\u3063\u3066\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u305f\u5f8c\u3088\u3057\u306a\u306b\u3084\u3063\u3066jenkins\u30a2\u30d7\u30ea\u3092\u4f5c\u308b\u3002\n\nRisa.java\nimport javax.servlet.*;\nimport javax.servlet.http.*;\nimport java.io.*;\npublic class Risa extends HttpServlet{\n  public void doGet(HttpServletRequest req,\n                      HttpServletResponse res) \n                      throws ServletException, IOException {\n    System.out.println(req.getContextPath());\n    res.sendRedirect(req.getContextPath());\n  }\n}\n\n\n\nweb.xml\n<?xml version=\"1.0\" encoding=\"ISO-8859-1\"?>\n<web-app xmlns=\"http://java.sun.com/xml/ns/j2ee\"\n        xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n        xsi:schemaLocation=\"http://java.sun.com/xml/ns/j2ee\n        http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd\"\n        version=\"2.4\">\n    <servlet>\n        <servlet-name>Risa</servlet-name>\n        <servlet-class>Risa</servlet-class>\n    </servlet>\n    <servlet-mapping>\n        <servlet-name>Risa</servlet-name>\n        <url-pattern>/test</url-pattern>\n    </servlet-mapping>\n</web-app>\n\n\n\u305d\u3057\u3066\u5148\u307b\u3069\u306esimplehttpserver\u306e\u30a2\u30d7\u30ea\u3092\u843d\u3068\u3057\u305f\u5f8c./bin/startup.sh\u3092\u5b9f\u884c\u3057\u3066\u30a2\u30af\u30bb\u30b9\u304b\u3051\u3066\u307f\u308b\u3068http\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u308c\u305f\u3002\n\ntomcat\u3067\u4f55\u3068\u304b\u3057\u3066\u307f\u308b\n\u898b\u305f\u3068\u3053\u308d\u6b63\u3057\u304fproxy\u3068\u3057\u3066\u6e21\u3057\u305f\u30d1\u30e9\u30e1\u30fc\u30bf\u30fc\u304c\u4f7f\u308f\u308c\u3066\u3044\u306a\u3044\u3089\u3057\u3044\u3002\u3068\u3044\u3046\u3068\u3053\u308d\u3067\u8abf\u67fb\u3002\nconf/server.xml\u4ee5\u4e0b\u306e\u8981\u7d20\u3092\u4ed6\u306eValve\u306e\u8fd1\u304f\u306b\u7f6e\u304d\u8db3\u3059\u3053\u3068\u3067\u7121\u4e8b\u89e3\u6c7a\u3002\u52b9\u679c\u306f\u66f8\u3044\u3066\u308b\u5185\u5bb9\u901a\u308a\u3067X-Forward-Proto\u306e\u5185\u5bb9\u3092\u8aad\u3080\u3068\u3044\u3046\u3082\u306e\u3002\u4e0a\u8a18\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u304c\u8fd4\u3063\u3066\u304d\u3066\u308b\u306e\u3067\u3053\u306e\u5834\u5408https\u3067\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u304c\u901a\u308b\u3088\u3046\u306b\u306a\u308b\u3002\n<Valve className=\"org.apache.catalina.valves.RemoteIpValve\"\n   protocolHeader=\"x-forwarded-proto\"/>\n\n\u3053\u308c\u3067\u30b5\u30fc\u30d0\u30fc\u5074\u306e\u8a2d\u5b9a\u3067\u4f55\u3068\u304b\u306a\u308b\u3001\u3068\u3044\u3046\u8aac\u5f97\u529b\u3092\u5f97\u308b\u3002\n\njetty\u3067\u8a66\u3057\u3066\u307f\u308b\n\u3082\u3068\u3082\u3068jenkins\u306fjetty\u3067\u52d5\u304b\u3057\u3066\u308b\u3093\u3060\u304b\u3089\u3053\u3063\u3061\u3067\u78ba\u304b\u3081\u306a\u3044\u3068\u610f\u5473\u304c\u306a\u3044\u3001\u3068\u3044\u3046\u3053\u3068\u3067\u3044\u308d\u3044\u308d\u8a66\u3057\u3066\u307f\u308b\u3002\u8981\u306ftomcat\u3068\u540c\u3058\u3060\u308d\uff1f\u3068\u601d\u3063\u3066\u305f\u3089\u7d50\u69cb\u75db\u3044\u76ee\u3092\u898b\u305f\u3002\n\u52d5\u4f5c\u306e\u691c\u8a3c\u3092\u884c\u3046\u969b\u306b\u306ftomcat\u306e\u691c\u8a3c\u6642\u306b\u4f5c\u3063\u305fjenkins\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u305d\u306e\u307e\u307ejetty\u306b\u6301\u3063\u3066\u304d\u3066\u52d5\u304b\u3057\u305f\u3002jar\u3068\u304bwar\u3068\u304b\u3067\u52d5\u304b\u3059\u65b9\u6cd5\u3057\u304b\u77e5\u3089\u306a\u304b\u3063\u305f\u304b\u3089\u305d\u308c\u3067\u52d5\u304f\u3068\u306f\u601d\u308f\u306a\u304b\u3063\u305f(\u30af\u30bd)\u3002\nweb.xml\u3082\u66f8\u304d\u63db\u3048\u305f\u3002\u5ba3\u8a00\u3060\u3051\u66f8\u304d\u63db\u3048\u3066\u308b\u3051\u3069\u6b63\u76f4\u610f\u5473\u304c\u3042\u308b\u304b\u306f\u308f\u304b\u3089\u306a\u3044\u3002\u306a\u3044\u3068\u601d\u3046\u3002\n\nweb.xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE web-app PUBLIC\n        \"-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN\"\n        \"http://java.sun.com/dtd/web-app_2_3.dtd\">\n<web-app>\n    <servlet>\n        <servlet-name>Risa</servlet-name>\n        <servlet-class>Risa</servlet-class>\n        <load-on-startup>1</load-on-startup>\n    </servlet>\n    <servlet-mapping>\n        <servlet-name>Risa</servlet-name>\n        <url-pattern>/test</url-pattern>\n    </servlet-mapping>\n</web-app>\n\n\n\u3053\u308c\u3067https://hoge.example.jp/jenkins/test \u3068\u30a2\u30af\u30bb\u30b9\u3092\u3059\u308b\u3068\u7121\u4e8bhttp://hoge.example.jp \u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u308c\u305f\u3002\n\njetty\u3092\u4f55\u3068\u304b\u3059\u308b\njetty\u306e9.3\u7cfb\u3060\u3068/etc\u4ee5\u4e0b\u306e\u30d5\u30a1\u30a4\u30eb\u306b\u3044\u308d\u3044\u308dxml\u30d5\u30a1\u30a4\u30eb\u304c\u5165\u3063\u3066\u308b\u3002\u305d\u306e\u3046\u3061\u306ejetty-http-forwarded.xml\u30d5\u30a1\u30a4\u30eb\u306e\u4e2d\u306bX-Forwarded\u7cfb\u3092\u5229\u7528\u3059\u308b\u8a2d\u5b9a\u3092\u542b\u3080\u8a18\u8ff0\u304c\u3042\u3063\u305f\u305f\u3081\u305d\u308c\u3092\u305d\u306e\u307e\u307e\u4f7f\u3046\u3088\u3046\u306b\u3057\u305f\u3002\n\njetty-http-forwarded.xml\n<?xml version=\"1.0\"?>\n<!DOCTYPE Configure PUBLIC \"-//Jetty//Configure//EN\" \"http://www.eclipse.org/jetty/configure_9_3.dtd\">\n<Configure id=\"httpConfig\" class=\"org.eclipse.jetty.server.HttpConfiguration\">\n  <Call name=\"addCustomizer\">\n    <Arg>\n      <New class=\"org.eclipse.jetty.server.ForwardedRequestCustomizer\">\n        <Set name=\"forwardedHostHeader\"><Property name=\"jetty.httpConfig.forwardedHostHeader\" default=\"X-Forwarded-Host\"/></Set>\n        <Set name=\"forwardedServerHeader\"><Property name=\"jetty.httpConfig.forwardedServerHeader\" default=\"X-Forwarded-Server\"/></Set>\n        <Set name=\"forwardedProtoHeader\"><Property name=\"jetty.httpConfig.forwardedProtoHeader\" default=\"X-Forwarded-Proto\"/></Set>\n        <Set name=\"forwardedForHeader\"><Property name=\"jetty.httpConfig.forwardedForHeader\" default=\"X-Forwarded-For\"/></Set>\n        <Set name=\"forwardedSslSessionIdHeader\"><Property name=\"jetty.httpConfig.forwardedSslSessionIdHeader\" /></Set>\n        <Set name=\"forwardedCipherSuiteHeader\"><Property name=\"jetty.httpConfig.forwardedCipherSuiteHeader\" /></Set>\n      </New>\n    </Arg>\n  </Call>\n</Configure>\n\n\n\u3053\u308c\u3092\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u5b9f\u884c\u6642\u306b\u5f15\u6570\u3068\u3057\u3066\u52a0\u3048\u308b\u3088\u3046\u306b\u3057\u3066\u7121\u4e8b\u89e3\u6c7a\u3002\u3053\u308c\u3067jenkins\u3092\u30aa\u30fc\u30ebhttps\u3067\u5229\u7528\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u3002\u3084\u3063\u305f\u306d\uff01\n\nrun.sh\n#!/bin/sh\ncd `dirname $0`\n/usr/bin/java -jar start.jar ./etc/jetty-http-forwarded.xml\n\n\n\u203bjetty\u306f$JETTY_HOME/bin/jetty.sh\u3067\u5b9f\u884c\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u304c\u3001supervisor\u3067\u7ba1\u7406\u3059\u308b\u305f\u3081\u306b\u5225\u9014\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u66f8\u3044\u3066\u308b\u3002jetty.sh\u3067\u5b9f\u884c\u3059\u308b\u305f\u3081\u306e\u65b9\u6cd5\u306b\u3064\u3044\u3066\u306f\u672a\u78ba\u8a8d\u3002\n\u4ed6\u306e\u30a2\u30d7\u30ea\u3092jetty\u3067\u52d5\u304b\u3057\u305f\u5b9f\u7e3e\u304c\u3042\u3063\u305f\u306e\u3067war\u304b\u3089jenkins\u3092\u52d5\u304b\u3057\u3066\u307f\u305f\u304c\u3001\u30ed\u30b0\u30a4\u30f3\u3060\u306e\u8a2d\u5b9a\u5909\u66f4\u3060\u306e\u3059\u308b\u5ea6\u306bhttp\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u308c\u3066\u30a4\u30e9\u30a4\u30e9\u3057\u305f\u3063\u3066\u8a71\u3002\n\nhttp://qiita.com/spamoc/items/fb005dc6e544249035c9 \u3068\u5927\u307e\u304b\u306a\u5185\u5bb9\u306f\u540c\u3058\u3002\u3053\u3063\u3061\u306e\u65b9\u304c\u5099\u5fd8\u9332\u5bc4\u308a\u3002\n\n\n## \u3044\u304d\u3055\u3064\n\n* jenkins\u3092nginx\u306e\u4e0b\u306b\u7acb\u3066\u3088\u3046\u3068\u3057\u305f\n* https\u3067\u53d7\u3051\u3066http\u3067jenkins.war\u3092\u52d5\u304b\u3057\u305fjetty\u306b\u6d41\u3059\u3088\u3046\u306b\u3057\u305f\n* \u30ed\u30b0\u30a4\u30f3/\u30a2\u30a6\u30c8\u6642\u306bhttp\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u308c\u308b\n* https\u3057\u304b\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u3067\u8a31\u53ef\u3057\u3066\u306a\u304b\u3063\u305f\u306e\u3067\u6012\u3089\u308c\u308b\n\n\u305d\u3093\u306a\u611f\u3058\u3002\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u3092\u958b\u3051\u308b\u5bfe\u5fdc\u306f\u4eca\u56de\u5165\u308c\u306a\u3044\u3088\u3046\u306b\u3057\u3066\u3044\u308b\u3002\n\n## \u3068\u308a\u3042\u3048\u305a\u8a66\u3059\n\n### nginx\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3084SSL\u306e\u9375\u4e91\u3005\u306b\u3064\u3044\u3066\u306f\u7701\u7565\u3002\u3068\u306b\u304b\u304f\u30d7\u30ed\u30ad\u30b7\u5468\u308a\u306e\u8a2d\u5b9a\u3092\u3076\u3061\u8fbc\u3080\u3002\n\n```ssl.conf\nserver {\n    listen       443;\n    server_name  _;\n\n    ssl                  on;\n    ssl_certificate      ssl/cert.crt;\n    ssl_certificate_key  ssl/cert.key;\n\n    ssl_session_timeout  5m;\n    ssl_protocols  TLSv1;\n    ssl_ciphers  ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP;\n    ssl_prefer_server_ciphers   on;\n\n    location /jenkins/ {\n        proxy_pass http://localhost:8080;\n        proxy_redirect off;\n        proxy_set_header Host $host;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Host $host:$server_port;\n        proxy_set_header X-Forwarded-Port $server_port;\n        proxy_set_header X-Forwarded-Server $host;\n        proxy_set_header X-Real-IP $remote_addr;\n    }\n}\n```\n\n### jetty\n\n1. [jetty\u516c\u5f0f\u30da\u30fc\u30b8](http://www.eclipse.org/jetty/)\u3088\u308a9.3.11.v20160721\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9(\u203b\u3053\u308c\u3092\u66f8\u3044\u3066\u3044\u308b\u73fe\u5728\u3067\u306f9.3.12\u307e\u3067\u51fa\u3066\u3044\u308b)\u3002\u89e3\u51cd\u3057\u3066/etc/jetty\u306b\u914d\u7f6e\u3059\u308b\u3002\n2. [jenkins\u516c\u5f0f\u30da\u30fc\u30b8](https://jenkins.io/)\u3088\u308ajenkins.war\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066/etc/jetty/webapps\u306e\u4e2d\u306b\u3076\u3061\u8fbc\u3080\u3002\n3. webapps\u306e\u4e0b\u306bjenkins.xml\u3092\u8a2d\u7f6e\u3059\u308b\u3002\n\n```jenkins.xml\n<Configure class=\"org.eclipse.jetty.webapp.WebAppContext\">\n  <Set name=\"contextPath\">/jenkins</Set>\n  <Set name=\"war\"><SystemProperty name=\"jetty.home\" default=\".\"/>/webapps/jenkins.war</Set>\n  <Get name=\"securityHandler\">\n    <Set name=\"loginService\">\n      <New class=\"org.eclipse.jetty.security.HashLoginService\">\n        <Set name=\"name\">Jenkins Realm</Set>\n        <Set name=\"config\"><SystemProperty name=\"jetty.home\" default=\".\"/>/etc/realm.properties</Set>\n      </New>\n    </Set>\n  </Get>\n</Configure>\n```\n\n\u3053\u308c\u3067`java -jar start.jar`\u3059\u308c\u3070\u3072\u3068\u307e\u305a\u52d5\u304f\u3088\u3046\u306b\u306a\u3063\u305f\u3002\n\n\n## \u52d5\u4f5c\u7d50\u679c\n\n\u6700\u521d\u306b\u66f8\u3044\u305f\u901a\u308a\u3002\u76ee\u3092\u3064\u3076\u308c\u3070\u306a\u3093\u3068\u304b\u306a\u308b\u3093\u3060\u304c\u3001\u64cd\u4f5c\u3059\u308b\u305f\u3073\u306bhttp\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u308c\u3066\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u306b\u306a\u308b\u306e\u3067\u6d41\u77f3\u306b\u4f7f\u3048\u306a\u3044\u3002\n\n\n## jenkins\u306e\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u306b\u3064\u3044\u3066\n\ngithub\u3067\u2193\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u306b\u5bfe\u3057\u3066\"sendRedirect\"\u306a\u3069\u3068\u691c\u7d22\u3057\u3066\u307f\u308b\u3068\u7d50\u69cb\u5f15\u3063\u304b\u304b\u308b\u3002\u3068\u304b\u3044\u308d\u3044\u308d\u6398\u3063\u3066\u3044\u304f\u306b\u5f53\u305f\u3063\u3066\u3053\u308c\u304c\u81ed\u3044\u3068\u7768\u3080\u3002\n\nhttps://github.com/jenkinsci/jenkins\n\n\u8272\u3005\u898b\u3066\u307f\u308b\u3068`response.sendRedirect(request.getContextPath()+\"/hoge\");`\u3068\u3044\u3046\u3088\u3046\u306a\u66f8\u304d\u65b9\u3092\u3057\u3066\u3044\u308b\u3068\u3053\u308d\u304c\u307b\u3068\u3093\u3069\u3067\u3001\u30a2\u30d7\u30ea\u4e0a\u3067\u306f\"/jenkins/hoge\"\u3068\u3044\u3046\u3088\u3046\u306a\u5f62\u3067\u3057\u304b\u30d1\u30b9\u3092\u6e21\u3057\u3066\u3044\u306a\u3044\u3053\u3068\u304c\u5206\u304b\u3063\u305f\u3002\n\n## simplehttpserver\u3067\u6e21\u3057\u3066\u308b\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u78ba\u8a8d\u3057\u3066\u307f\u308b\n\n\u3072\u3068\u307e\u305ajenkins\u3092\u6b62\u3081\u3066\u2193\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u52d5\u304b\u3057\u3066\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u308b\u3002\n\n```simple.py\n#!/usr/bin/env python\nimport SimpleHTTPServer\nimport SocketServer\n\nclass ServerHandler(SimpleHTTPServer.SimpleHTTPRequestHandler):\n    def do_GET(self):\n        print(self.headers)\n        SimpleHTTPServer.SimpleHTTPRequestHandler.do_GET(self)\n\nHandler = ServerHandler\nSocketServer.TCPServer((\"\", 8080), Handler).serve_forever()\n```\n\n\u7d50\u679c:\n\n```\n127.0.0.1 - - [21/Sep/2016 00:00:00] \"GET /jenkins/ HTTP/1.0\" 404 -\nHost: hoge.example.jp\nX-Forwarded-Proto: https\nX-Forwarded-For: 192.128.0.2\nX-Forwarded-Host: hoge.example.jp:443\nX-Forwarded-Port: 443\nX-Forwarded-Server: hoge.example.jp\nX-Real-IP: 192.128.0.2\n```\n\n\u601d\u3063\u305f\u901a\u308a\u306e\u7d50\u679c\u304c\u8fd4\u3063\u3066\u304d\u3066\u308b\u3002\u3053\u308c\u3067\u3082\u30c0\u30e1\u306a\u306e\u3060\u308d\u3046\u304b\uff1f\n\n\n## tomcat\u3067\u8a66\u3057\u3066\u307f\u308b\n\n\u4e0b\u8a18\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u3063\u3066`javac -classpath \"./lib/servlet-api.jar\" Risa.java`\u3068\u3084\u3063\u3066\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u305f\u5f8c\u3088\u3057\u306a\u306b\u3084\u3063\u3066jenkins\u30a2\u30d7\u30ea\u3092\u4f5c\u308b\u3002\n\n```Risa.java\nimport javax.servlet.*;\nimport javax.servlet.http.*;\nimport java.io.*;\npublic class Risa extends HttpServlet{\n  public void doGet(HttpServletRequest req,\n                      HttpServletResponse res) \n                      throws ServletException, IOException {\n    System.out.println(req.getContextPath());\n    res.sendRedirect(req.getContextPath());\n  }\n}\n```\n\n```web.xml\n<?xml version=\"1.0\" encoding=\"ISO-8859-1\"?>\n<web-app xmlns=\"http://java.sun.com/xml/ns/j2ee\"\n        xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n        xsi:schemaLocation=\"http://java.sun.com/xml/ns/j2ee\n        http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd\"\n        version=\"2.4\">\n    <servlet>\n        <servlet-name>Risa</servlet-name>\n        <servlet-class>Risa</servlet-class>\n    </servlet>\n    <servlet-mapping>\n        <servlet-name>Risa</servlet-name>\n        <url-pattern>/test</url-pattern>\n    </servlet-mapping>\n</web-app>\n```\n\n\u305d\u3057\u3066\u5148\u307b\u3069\u306esimplehttpserver\u306e\u30a2\u30d7\u30ea\u3092\u843d\u3068\u3057\u305f\u5f8c`./bin/startup.sh`\u3092\u5b9f\u884c\u3057\u3066\u30a2\u30af\u30bb\u30b9\u304b\u3051\u3066\u307f\u308b\u3068http\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u308c\u305f\u3002\n\n\n## tomcat\u3067\u4f55\u3068\u304b\u3057\u3066\u307f\u308b\n\n\u898b\u305f\u3068\u3053\u308d\u6b63\u3057\u304fproxy\u3068\u3057\u3066\u6e21\u3057\u305f\u30d1\u30e9\u30e1\u30fc\u30bf\u30fc\u304c\u4f7f\u308f\u308c\u3066\u3044\u306a\u3044\u3089\u3057\u3044\u3002\u3068\u3044\u3046\u3068\u3053\u308d\u3067\u8abf\u67fb\u3002\n\nconf/server.xml\u4ee5\u4e0b\u306e\u8981\u7d20\u3092\u4ed6\u306eValve\u306e\u8fd1\u304f\u306b\u7f6e\u304d\u8db3\u3059\u3053\u3068\u3067\u7121\u4e8b\u89e3\u6c7a\u3002\u52b9\u679c\u306f\u66f8\u3044\u3066\u308b\u5185\u5bb9\u901a\u308a\u3067X-Forward-Proto\u306e\u5185\u5bb9\u3092\u8aad\u3080\u3068\u3044\u3046\u3082\u306e\u3002\u4e0a\u8a18\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u304c\u8fd4\u3063\u3066\u304d\u3066\u308b\u306e\u3067\u3053\u306e\u5834\u5408https\u3067\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u304c\u901a\u308b\u3088\u3046\u306b\u306a\u308b\u3002\n\n```\n<Valve className=\"org.apache.catalina.valves.RemoteIpValve\"\n   protocolHeader=\"x-forwarded-proto\"/>\n```\n\n\u3053\u308c\u3067\u30b5\u30fc\u30d0\u30fc\u5074\u306e\u8a2d\u5b9a\u3067\u4f55\u3068\u304b\u306a\u308b\u3001\u3068\u3044\u3046\u8aac\u5f97\u529b\u3092\u5f97\u308b\u3002\n\n## jetty\u3067\u8a66\u3057\u3066\u307f\u308b\n\n\u3082\u3068\u3082\u3068jenkins\u306fjetty\u3067\u52d5\u304b\u3057\u3066\u308b\u3093\u3060\u304b\u3089\u3053\u3063\u3061\u3067\u78ba\u304b\u3081\u306a\u3044\u3068\u610f\u5473\u304c\u306a\u3044\u3001\u3068\u3044\u3046\u3053\u3068\u3067\u3044\u308d\u3044\u308d\u8a66\u3057\u3066\u307f\u308b\u3002\u8981\u306ftomcat\u3068\u540c\u3058\u3060\u308d\uff1f\u3068\u601d\u3063\u3066\u305f\u3089\u7d50\u69cb\u75db\u3044\u76ee\u3092\u898b\u305f\u3002\n\n\u52d5\u4f5c\u306e\u691c\u8a3c\u3092\u884c\u3046\u969b\u306b\u306ftomcat\u306e\u691c\u8a3c\u6642\u306b\u4f5c\u3063\u305fjenkins\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u305d\u306e\u307e\u307ejetty\u306b\u6301\u3063\u3066\u304d\u3066\u52d5\u304b\u3057\u305f\u3002jar\u3068\u304bwar\u3068\u304b\u3067\u52d5\u304b\u3059\u65b9\u6cd5\u3057\u304b\u77e5\u3089\u306a\u304b\u3063\u305f\u304b\u3089\u305d\u308c\u3067\u52d5\u304f\u3068\u306f\u601d\u308f\u306a\u304b\u3063\u305f(\u30af\u30bd)\u3002\n\nweb.xml\u3082\u66f8\u304d\u63db\u3048\u305f\u3002\u5ba3\u8a00\u3060\u3051\u66f8\u304d\u63db\u3048\u3066\u308b\u3051\u3069\u6b63\u76f4\u610f\u5473\u304c\u3042\u308b\u304b\u306f\u308f\u304b\u3089\u306a\u3044\u3002\u306a\u3044\u3068\u601d\u3046\u3002\n\n```web.xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE web-app PUBLIC\n        \"-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN\"\n        \"http://java.sun.com/dtd/web-app_2_3.dtd\">\n<web-app>\n    <servlet>\n        <servlet-name>Risa</servlet-name>\n        <servlet-class>Risa</servlet-class>\n        <load-on-startup>1</load-on-startup>\n    </servlet>\n    <servlet-mapping>\n        <servlet-name>Risa</servlet-name>\n        <url-pattern>/test</url-pattern>\n    </servlet-mapping>\n</web-app>\n```\n\n\u3053\u308c\u3067https://hoge.example.jp/jenkins/test \u3068\u30a2\u30af\u30bb\u30b9\u3092\u3059\u308b\u3068\u7121\u4e8bhttp://hoge.example.jp \u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u308c\u305f\u3002\n\n## jetty\u3092\u4f55\u3068\u304b\u3059\u308b\n\njetty\u306e9.3\u7cfb\u3060\u3068/etc\u4ee5\u4e0b\u306e\u30d5\u30a1\u30a4\u30eb\u306b\u3044\u308d\u3044\u308dxml\u30d5\u30a1\u30a4\u30eb\u304c\u5165\u3063\u3066\u308b\u3002\u305d\u306e\u3046\u3061\u306ejetty-http-forwarded.xml\u30d5\u30a1\u30a4\u30eb\u306e\u4e2d\u306bX-Forwarded\u7cfb\u3092\u5229\u7528\u3059\u308b\u8a2d\u5b9a\u3092\u542b\u3080\u8a18\u8ff0\u304c\u3042\u3063\u305f\u305f\u3081\u305d\u308c\u3092\u305d\u306e\u307e\u307e\u4f7f\u3046\u3088\u3046\u306b\u3057\u305f\u3002\n\n```jetty-http-forwarded.xml\n<?xml version=\"1.0\"?>\n<!DOCTYPE Configure PUBLIC \"-//Jetty//Configure//EN\" \"http://www.eclipse.org/jetty/configure_9_3.dtd\">\n<Configure id=\"httpConfig\" class=\"org.eclipse.jetty.server.HttpConfiguration\">\n  <Call name=\"addCustomizer\">\n    <Arg>\n      <New class=\"org.eclipse.jetty.server.ForwardedRequestCustomizer\">\n        <Set name=\"forwardedHostHeader\"><Property name=\"jetty.httpConfig.forwardedHostHeader\" default=\"X-Forwarded-Host\"/></Set>\n        <Set name=\"forwardedServerHeader\"><Property name=\"jetty.httpConfig.forwardedServerHeader\" default=\"X-Forwarded-Server\"/></Set>\n        <Set name=\"forwardedProtoHeader\"><Property name=\"jetty.httpConfig.forwardedProtoHeader\" default=\"X-Forwarded-Proto\"/></Set>\n        <Set name=\"forwardedForHeader\"><Property name=\"jetty.httpConfig.forwardedForHeader\" default=\"X-Forwarded-For\"/></Set>\n        <Set name=\"forwardedSslSessionIdHeader\"><Property name=\"jetty.httpConfig.forwardedSslSessionIdHeader\" /></Set>\n        <Set name=\"forwardedCipherSuiteHeader\"><Property name=\"jetty.httpConfig.forwardedCipherSuiteHeader\" /></Set>\n      </New>\n    </Arg>\n  </Call>\n</Configure>\n```\n\n\u3053\u308c\u3092\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u5b9f\u884c\u6642\u306b\u5f15\u6570\u3068\u3057\u3066\u52a0\u3048\u308b\u3088\u3046\u306b\u3057\u3066\u7121\u4e8b\u89e3\u6c7a\u3002\u3053\u308c\u3067jenkins\u3092\u30aa\u30fc\u30ebhttps\u3067\u5229\u7528\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u3002\u3084\u3063\u305f\u306d\uff01\n\n```run.sh\n#!/bin/sh\ncd `dirname $0`\n/usr/bin/java -jar start.jar ./etc/jetty-http-forwarded.xml\n```\n\n\u203bjetty\u306f$JETTY_HOME/bin/jetty.sh\u3067\u5b9f\u884c\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u304c\u3001supervisor\u3067\u7ba1\u7406\u3059\u308b\u305f\u3081\u306b\u5225\u9014\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u66f8\u3044\u3066\u308b\u3002jetty.sh\u3067\u5b9f\u884c\u3059\u308b\u305f\u3081\u306e\u65b9\u6cd5\u306b\u3064\u3044\u3066\u306f\u672a\u78ba\u8a8d\u3002\n\n"}