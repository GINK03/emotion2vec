{"context": " More than 1 year has passed since last update.\n\nRoket\n\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u3001\nCoreOS: 723.3.0\nrkt: 0.5.5\n\u306e\u8a71\u3002\n\u4eca\u306eAzure\u306estable\u3067\u3059\u3002\n\nRocket\u3063\u3066\u4f55\uff1f\n\u3056\u3063\u304f\u308a\u7c21\u5358\u306b\u8a00\u3063\u3066Docker\u306b\u5909\u308f\u308b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b3\u30f3\u30c6\u30ca\u6280\u8853\u3001\u3067\u3059\u304b\u306d\u3002\n\u7279\u306b\u5927\u304d\u304f\u9055\u3046\u3068\u3053\u308d\u306fdocker\u304c\u4eee\u60f3\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u7d4c\u7531\u306e\u3068\u3053\u308d\u3092Rocket\u306f\u30db\u30b9\u30c8\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3092\u4f7f\u3046\u3001\u3068\u3044\u3046\u3068\u3053\u308d\u3067\u3059\u3002\n\u306a\u306e\u3067\u3001\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306b\u3064\u3044\u3066\u3042\u308c\u3053\u308c\u60a9\u3080\u5fc5\u8981\u304c\u7121\u3044\u306e\u304c\u7279\u5fb4\u3067\u3059\u3002\n\n\u5143\u30c7\u30fc\u30bf\u4f5c\u6210\n\nACI\u5143\u30c7\u30fc\u30bf\u3092\u3064\u304f\u308b\n\u5143\u306b\u306a\u308bnginx\u306fDockerHub\u304b\u3089\u6301\u3063\u3066\u304d\u307e\u3059\u3002\ndocker2aci\u3068\u3044\u3046\u30c4\u30fc\u30eb\u3092\u4f7f\u3048\u3070\u697d\u3067\u304d\u308b\u3093\u3067\u3059\u304c\u3001\u306a\u3093\u3060\u304b\u30b3\u30f3\u30d1\u30a4\u30eb\u3067\u304d\u306a\u304b\u3063\u305f\u306e\u3067\u3001\u624b\u4f5c\u696d\u3067\u4f5c\u308a\u307e\u3059\u3002\n\u4f5c\u308a\u65b9\u306f\u3001\n1. Docker\u3092pull\u3057\u3066run\u3059\u308b\n2. run\u3057\u3066\u308bDocker\u3092export\u3057\u3066roots\u4e0b\u306b\u4fdd\u5b58\n\u3068\u3001\u3053\u3093\u306a\u611f\u3058\u3002\n\u306a\u306e\u3067\u3001\u3042\u3089\u304b\u3058\u3081Docker\u3092\u52d5\u304b\u305b\u308b\u3088\u3046\u306b\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n/var/lib/coreos-install/user_data\ncoreos:\n  units:\n    - name: docker.service\n      command: start\n\n\n$ docker pull nginx\nlatest: Pulling from nginx\n\n902b87aaaec9: Pull complete \n9a61b6b1315e: Pull complete \naface2a79f55: Pull complete \n5dd2638d10a1: Pull complete \n97df1ddba09e: Pull complete \n56c99fa886e8: Pull complete \ncd27805ea89f: Pull complete \n5e95ac0e9a79: Pull complete \n9f36f81a1ccb: Pull complete \n4c1809b04591: Pull complete \n98c9ccd75644: Pull complete \n6886fb5a9b8d: Pull complete \nDigest: sha256:29ff4c68a1c9a014c06678f0882c8976bd83df501110aeb9e659bdfa2929e3c4\nStatus: Downloaded newer image for nginx:latest\n$ docker images\nREPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\nnginx               latest              6886fb5a9b8d        4 weeks ago         132.8 MB\n$ docker run -it nginx /bin/bash\n\n$ mkdir -p ~/nginx/aci/rootfs\n$ cd ~/nginx/aci/rootfs\n$ docker ps\nCONTAINER ID        IMAGE               COMMAND             CREATED              STATUS              PORTS               NAMES\ne2ff0d86ca1b        nginx:latest        \"/bin/bash\"         About a minute ago   Up About a minute   80/tcp, 443/tcp     agitated_lumiere    \n$ docker export e2ff0d86ca1b | tar xvp\n\n\u3053\u308c\u3067ACI\u7528\u306b\u30b3\u30d4\u30fc\u304c\u53d6\u308c\u307e\u3059\u3002\n\nmanifest\u30d5\u30a1\u30a4\u30eb\u3092\u66f8\u304f\n\u30b3\u30d4\u30fc\u3057\u3066\u304d\u305f\u30d5\u30a1\u30a4\u30eb\u306e\u5185\u5bb9\u306b\u5408\u308f\u305b\u3066manifest\u30d5\u30a1\u30a4\u30eb\u3092\u66f8\u304d\u307e\u3059\u3002\n\u3053\u3053\u3067\u306f\u3001\u52d5\u304b\u3059\u30e6\u30fc\u30b6\u30fc\u306froot\u3001\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u3092\u697d\u306b\u3059\u308b\u305f\u3081\u306bconf.d\u7528\u3068site\u7528\u3001log\u7528\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092ACI\u306e\u5916\u304b\u3089\u30de\u30a6\u30f3\u30c8\u3059\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n~/nginx/aci/manifest\n{\n    \"acKind\": \"ImageManifest\",\n    \"acVersion\": \"0.6.1\",\n    \"name\": \"nginx\",\n    \"labels\": [\n        {\"name\": \"os\", \"value\": \"linux\"},\n        {\"name\": \"arch\", \"value\": \"amd64\"}\n    ],\n    \"app\": {\n        \"user\": \"0\",\n        \"group\": \"0\",\n        \"exec\": [\n            \"/usr/sbin/nginx\"\n        ],\n        \"ports\": [\n            {\n                \"name\": \"http\",\n                \"protocol\": \"tcp\",\n                \"port\": 80\n            }, {\n                \"name\": \"https\",\n                \"protocol\": \"tcp\",\n                \"port\": 443\n            }\n        ],\n        \"mountPoints\": [\n            {\n                \"name\": \"conf\",\n                \"path\": \"/opt/nginx/conf\",\n                \"readOnly\": true\n            }, {\n                \"name\": \"sites\",\n                \"path\": \"/opt/nginx/sites\",\n                \"readOnly\": false\n            }, {\n                \"name\": \"log\",\n                \"path\": \"/opt/nginx/log\",\n                \"readOnly\": false\n            }\n        ]\n    }\n}\n\n\n\u5b9f\u306f\u591a\u3044\u306b\u5d4c\u307e\u3063\u3066\u3057\u307e\u3063\u305f\u306e\u3067\u3059\u304c\u3001exec\u306e\u4e2d\u306f\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u5f15\u6570\u3092\u66f8\u3051\u307e\u305b\u3093\u3002\ncommand not found \u3068\u304b\u8a00\u308f\u308c\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\u306a\u306e\u3067\u3001\u66f8\u304f\u306e\u306f\u5b9f\u884c\u30d5\u30a1\u30a4\u30eb\u306e\u307f\uff08\u3057\u304b\u3082\u30d5\u30eb\u30d1\u30b9\uff09\u3002\nforeground\u306b\u3059\u308b\u30aa\u30d7\u30b7\u30e7\u30f3\u3001 daemon off; \u306f\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306b\u66f8\u304b\u306a\u3044\u3068\u3044\u3051\u307e\u305b\u3093\u3002\n\u307e\u3042\u3001\u81ea\u5206\u304c\u77e5\u3089\u306a\u3044\u3060\u3051\u3067\u66f8\u304d\u65b9\u306f\u3042\u308b\u3068\u601d\u3046\u3093\u3067\u3059\u3051\u3069\u306d\u30fc\u3002\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u66f8\u304d\u63db\u3048\u308b\nlog\u30d5\u30a1\u30a4\u30eb\u3084\u3089include\u30d1\u30b9\u3084\u3089\u3092manifest\u3067\u8ffd\u52a0\u3057\u3066\u3044\u308b\u30d1\u30b9\u306b\u5408\u308f\u305b\u307e\u3059\u3002\n\u3042\u3068\u3001\u4e0a\u8a18\u3067\u66f8\u3044\u305f\u901a\u308a\u3001 daemon off; \u3092\u66f8\u3044\u3066\u304a\u304d\u307e\u3059\u3002\n\n~/nginx/aci/root/etc/nginx/nginx.conf\nuser  nginx;\nworker_processes  1;\ndaemon off;\n\nerror_log  /opt/nginx/log/error.log warn;\npid        /var/run/nginx.pid;\n\n\nevents {\n    worker_connections  1024;\n}\n\n\nhttp {\n    include       /etc/nginx/mime.types;\n    default_type  application/octet-stream;\n\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log  /opt/nginx/log/access.log  main;\n\n    sendfile        on;\n    #tcp_nopush     on;\n\n    keepalive_timeout  65;\n\n    #gzip  on;\n\n    include /opt/nginx/conf/*.conf;\n}\n\n\n\nACI\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u308b\n\u3053\u308c\u306f\u666e\u901a\u306b\u4f5c\u308c\u3070\u304a\u3063\u3051\u30fc\u3002\n$ cd ~/nginx\n$ actool build aci nginx.aci\n\n\nnginx\u7528\u306e\u8a2d\u5b9a\u3092\u3057\u3066\u304a\u304f\n\u3053\u3053\u3067\u306f\u3001\u30db\u30b9\u30c8\u306e\n/mnt/data/conf/nginx \u3092nginx\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u7f6e\u304f\u5834\u6240\u306b\u3001\n/mnt/data/sites \u3092\u30b5\u30a4\u30c8\u306e\u30c7\u30fc\u30bf\u3092\u7f6e\u304f\u5834\u6240\u306b\u3001\n/mnt/data/log \u3092\u30ed\u30b0\u3092\u7f6e\u304f\u5834\u6240\u306b\u3001\n\u305d\u308c\u305e\u308c\u6307\u5b9a\u3057\u307e\u3059\u3002\n\u305d\u306e\u305f\u3081\u3001\n\n/mnt/data/conf/nginx/default.conf\nserver {\n    listen 80;\n    server_name localhost;\n\n    location / {\n        root /opt/nginx/sites/root;\n        index index.html index.htm;\n    }\n\n    error_page 500 502 503 504 /50x.html;\n    location = /50x.html {\n        root /opt/nginx/sites/root;\n    }\n}\n\n\n\u3068\u304b\n\n/mnt/data/sites/root/index.html\n<html>\n <head>\n  <title>Test</title>\n </head>\n\n <body>\n  <h1>Hello, world</h1>\n  <p>good morning !</p>\n </body>\n</html>\n\n\n\u306a\u3069\u306e\u3088\u3046\u306a\u30d5\u30a1\u30a4\u30eb\u3092\u4eee\u306b\u7f6e\u3044\u3066\u304a\u304d\u307e\u3059\u3002\n\n\u8a66\u3057\u306b\u5b9f\u884c\u3057\u3066\u307f\u308b\nmanifest\u3067\u6307\u5b9a\u3057\u3066\u3044\u308b\u30de\u30a6\u30f3\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u5f15\u6570\u3067\u6307\u5b9a\u3057\u3066\u5b9f\u884c\u3057\u307e\u3059\u3002\n$ sudo rkt --insecure-skip-verify --debug run --volume=conf,kind=host,source=/mnt/data/conf/nginx --volume=sites,kind=host,source=/mnt/data/sites --volume=log,kind=host,source=/mnt/data/log ~/nginx/nginx.aci\n\n--volume=[manifest\u3067\u6307\u5b9a\u3057\u3066\u3044\u308bname],kind=host,source=[\u5b9f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea] \u3068\u3044\u3046\u611f\u3058\u3067\u5f15\u6570\u306b\u6307\u5b9a\u3057\u307e\u3059\u3002\n\u540d\u524d\u540c\u58eb\u3067\u5b9f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3068manifest\u3067\u6307\u5b9a\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304c\u30ea\u30f3\u30af\u3057\u3001\u540c\u4e00\u306e\u3082\u306e\u3068\u3057\u3066\u6271\u308f\u308c\u307e\u3059\u3002\n\u307e\u305f\u3001\u7f72\u540d\u3057\u3066\u3044\u306a\u3044\u306e\u3067 --insecure-skip-verify \u30aa\u30d7\u30b7\u30e7\u30f3\u304c\u5fc5\u8981\u3067\u3059\u3002\n\u3053\u308c\u3067\u3068\u308a\u3042\u3048\u305anginx\u304c\u52d5\u304d\u307e\u3059\u3002\n\u8a66\u3057\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n$ curl http://localhost/\n<html>\n <head>\n  <title>Test</title>\n </head>\n\n <body>\n  <h1>Hello, world</h1>\n  <p>good morning !</p>\n </body>\n</html>\n\n\u3069\u3046\u3067\u3059\uff1f\n\u8868\u793a\u3055\u308c\u307e\u3057\u305f\u304b\uff1f\n\u3084\u30fc\u3002\nlocalhost\u3067\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u306e\u697d\u3060\u308f\u3002\n\u3084\u3063\u3071\u3002\n\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u3092\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n$ tail /mnt/data/log/access.log\n127.0.0.1 - - [20/Aug/2015:01:40:43 +0000] \"GET / HTTP/1.1\" 200 121 \"-\" \"curl/7.42.1\" \"-\"\n\n\u30ed\u30b0\u3082\u66f8\u304b\u308c\u3066\u3044\u307e\u3059\u3002\n\u30db\u30b9\u30c8\u74b0\u5883\u3068\u306e\u53d7\u3051\u6e21\u3057\u3082\u3067\u304d\u3066\u3044\u307e\u3059\u306d\u3002\n\n\u81ea\u52d5\u8d77\u52d5\n\n\u81ea\u52d5\u8d77\u52d5\u3055\u305b\u308b\u3088\u3046\u306b\u3059\u308b\n\u81ea\u52d5\u8d77\u52d5\u306b\u3055\u305b\u308b\u3088\u3046\u306b\u3059\u308b\u306b\u306f\u3001\u3044\u3064\u3082\u306e\u3054\u3068\u304fcloud-config\u306b\u66f8\u3044\u3066\u304a\u304d\u307e\u3059\u3002\n\n/var/lib/coreos-install/user_data\ncoreos:\n  units:\n    - name: nginx.service\n      command: start\n      content: |\n        [Unit]\n        Description=Nginx next generation web server\n        Requires=network-online.target\n        After=network-online.target\n\n        [Service]\n        ExecStart=/usr/bin/rkt --insecure-skip-verify run --volume=conf,kind=host,source=/mnt/data/conf/nginx --volume=sites,kind=host,source=/mnt/data/sites --volume=log,kind=host,source=/mnt/data/log /home/xxx/nginx/nginx.aci\n        KillMode=mixed\n        Restart=always\n\n\n\u66f8\u3044\u305f\u3089\u4e00\u5ea6\u8a66\u3057\u307e\u3059\u3002\n$ sudo coreos-cloudinit -from-file=/var/lib/coreos-install/user_data\n   :\n2015/08/20 10:22:03 Calling unit command \"start\" on \"nginx.service\"'\n2015/08/20 10:22:03 Result of \"start\" on \"nginx.service\": done\n\n\u554f\u984c\u306a\u3051\u308c\u3070done\u306b\u306a\u308b\u306f\u305a\u3067\u3059\u3002\n\u4e00\u5ea6\u8a66\u3059\u3068\u3001system\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u304c\u66f8\u304b\u308c\u307e\u3059\u306e\u3067\u3001\u3042\u3068\u306fsystemctl\u3067\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\n$ sudo systemctl status nginx.service\n\u25cf nginx.service - Nginx next generation web server\n   Loaded: loaded (/etc/systemd/system/nginx.service; static; vendor preset: disabled)\n   Active: active (running) since Wed 2015-08-19 15:52:23 JST; 18h ago\n Main PID: 658 (ld-linux-x86-64)\n   Memory: 24.5M\n      CPU: 22.217s\n   CGroup: /system.slice/nginx.service\n           mq658 stage1/rootfs/usr/lib/ld-linux-x86-64.so.2 stage1/rootfs/usr...\n\nAug 19 15:52:23 logmanager systemd[1]: Started Nginx next generation web server.\nAug 19 15:52:23 logmanager systemd[1]: Starting Nginx next generation web s.....\nAug 20 10:20:24 logmanager systemd[1]: Started Nginx next generation web server.\nAug 20 10:22:03 logmanager systemd[1]: Started Nginx next generation web server.\nHint: Some lines were ellipsized, use -l to show in full.\n\n\u7121\u4e8b\u3001\u52d5\u304b\u3059\u3053\u3068\u304c\u3067\u304d\u307e\u3057\u305f\u3002\n\u8a66\u9a13\u74b0\u5883\u306a\u3089sudo restart\u3068\u304b\u3057\u3066\u307f\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\n\nnginx\u3092reload\u3055\u305b\u308b\n\u8a2d\u5b9a\u3092\u66f8\u304d\u63db\u3048\u305f\u3068\u304d\u306bnginx\u3092\u30ea\u30b9\u30bf\u30fc\u30c8\u3055\u305b\u308b\u65b9\u6cd5\u3067\u3059\u3002\nRocket\u306e\u30ea\u30b9\u30c8\u3092\u53d6\u5f97\u3057\u3001\u4e2d\u306b\u5165\u308a\u3001nginx\u3092\u64cd\u4f5c\u3057\u307e\u3059\u3002\n$ sudo rkt list\nUUID            ACI     STATE   NETWORKS\n31ffb1b9        nginx   running\n\n$ sudo rkt enter 31ffb1b9\nNo command specified, assuming \"/bin/bash\"\nroot@rkt-31ffb1b9-fa8c-498c-9bbe-53e1842ae085:/# nginx -s reload\n\n# Roket\n\n\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u3001\nCoreOS: 723.3.0\nrkt: 0.5.5\n\u306e\u8a71\u3002\n\u4eca\u306eAzure\u306estable\u3067\u3059\u3002\n\n## Rocket\u3063\u3066\u4f55\uff1f\n\n\u3056\u3063\u304f\u308a\u7c21\u5358\u306b\u8a00\u3063\u3066Docker\u306b\u5909\u308f\u308b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b3\u30f3\u30c6\u30ca\u6280\u8853\u3001\u3067\u3059\u304b\u306d\u3002\n\u7279\u306b\u5927\u304d\u304f\u9055\u3046\u3068\u3053\u308d\u306fdocker\u304c\u4eee\u60f3\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u7d4c\u7531\u306e\u3068\u3053\u308d\u3092Rocket\u306f\u30db\u30b9\u30c8\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3092\u4f7f\u3046\u3001\u3068\u3044\u3046\u3068\u3053\u308d\u3067\u3059\u3002\n\u306a\u306e\u3067\u3001\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306b\u3064\u3044\u3066\u3042\u308c\u3053\u308c\u60a9\u3080\u5fc5\u8981\u304c\u7121\u3044\u306e\u304c\u7279\u5fb4\u3067\u3059\u3002\n\n# \u5143\u30c7\u30fc\u30bf\u4f5c\u6210\n\n## ACI\u5143\u30c7\u30fc\u30bf\u3092\u3064\u304f\u308b\n\n\u5143\u306b\u306a\u308bnginx\u306fDockerHub\u304b\u3089\u6301\u3063\u3066\u304d\u307e\u3059\u3002\n[docker2aci](https://github.com/appc/docker2aci)\u3068\u3044\u3046\u30c4\u30fc\u30eb\u3092\u4f7f\u3048\u3070\u697d\u3067\u304d\u308b\u3093\u3067\u3059\u304c\u3001\u306a\u3093\u3060\u304b\u30b3\u30f3\u30d1\u30a4\u30eb\u3067\u304d\u306a\u304b\u3063\u305f\u306e\u3067\u3001\u624b\u4f5c\u696d\u3067\u4f5c\u308a\u307e\u3059\u3002\n\n\u4f5c\u308a\u65b9\u306f\u3001\n1. Docker\u3092pull\u3057\u3066run\u3059\u308b\n2. run\u3057\u3066\u308bDocker\u3092export\u3057\u3066roots\u4e0b\u306b\u4fdd\u5b58\n\u3068\u3001\u3053\u3093\u306a\u611f\u3058\u3002\n\u306a\u306e\u3067\u3001\u3042\u3089\u304b\u3058\u3081Docker\u3092\u52d5\u304b\u305b\u308b\u3088\u3046\u306b\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n```yaml:/var/lib/coreos-install/user_data\ncoreos:\n  units:\n    - name: docker.service\n      command: start\n```\n\n```bash\n$ docker pull nginx\nlatest: Pulling from nginx\n\n902b87aaaec9: Pull complete \n9a61b6b1315e: Pull complete \naface2a79f55: Pull complete \n5dd2638d10a1: Pull complete \n97df1ddba09e: Pull complete \n56c99fa886e8: Pull complete \ncd27805ea89f: Pull complete \n5e95ac0e9a79: Pull complete \n9f36f81a1ccb: Pull complete \n4c1809b04591: Pull complete \n98c9ccd75644: Pull complete \n6886fb5a9b8d: Pull complete \nDigest: sha256:29ff4c68a1c9a014c06678f0882c8976bd83df501110aeb9e659bdfa2929e3c4\nStatus: Downloaded newer image for nginx:latest\n$ docker images\nREPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\nnginx               latest              6886fb5a9b8d        4 weeks ago         132.8 MB\n$ docker run -it nginx /bin/bash\n```\n\n```bash\n$ mkdir -p ~/nginx/aci/rootfs\n$ cd ~/nginx/aci/rootfs\n$ docker ps\nCONTAINER ID        IMAGE               COMMAND             CREATED              STATUS              PORTS               NAMES\ne2ff0d86ca1b        nginx:latest        \"/bin/bash\"         About a minute ago   Up About a minute   80/tcp, 443/tcp     agitated_lumiere    \n$ docker export e2ff0d86ca1b | tar xvp\n```\n\n\u3053\u308c\u3067ACI\u7528\u306b\u30b3\u30d4\u30fc\u304c\u53d6\u308c\u307e\u3059\u3002\n\n## manifest\u30d5\u30a1\u30a4\u30eb\u3092\u66f8\u304f\n\n\u30b3\u30d4\u30fc\u3057\u3066\u304d\u305f\u30d5\u30a1\u30a4\u30eb\u306e\u5185\u5bb9\u306b\u5408\u308f\u305b\u3066manifest\u30d5\u30a1\u30a4\u30eb\u3092\u66f8\u304d\u307e\u3059\u3002\n\u3053\u3053\u3067\u306f\u3001\u52d5\u304b\u3059\u30e6\u30fc\u30b6\u30fc\u306froot\u3001\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u3092\u697d\u306b\u3059\u308b\u305f\u3081\u306bconf.d\u7528\u3068site\u7528\u3001log\u7528\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092ACI\u306e\u5916\u304b\u3089\u30de\u30a6\u30f3\u30c8\u3059\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n```json:~/nginx/aci/manifest\n{\n    \"acKind\": \"ImageManifest\",\n    \"acVersion\": \"0.6.1\",\n    \"name\": \"nginx\",\n    \"labels\": [\n        {\"name\": \"os\", \"value\": \"linux\"},\n        {\"name\": \"arch\", \"value\": \"amd64\"}\n    ],\n    \"app\": {\n        \"user\": \"0\",\n        \"group\": \"0\",\n        \"exec\": [\n            \"/usr/sbin/nginx\"\n        ],\n        \"ports\": [\n            {\n                \"name\": \"http\",\n                \"protocol\": \"tcp\",\n                \"port\": 80\n            }, {\n                \"name\": \"https\",\n                \"protocol\": \"tcp\",\n                \"port\": 443\n            }\n        ],\n        \"mountPoints\": [\n            {\n                \"name\": \"conf\",\n                \"path\": \"/opt/nginx/conf\",\n                \"readOnly\": true\n            }, {\n                \"name\": \"sites\",\n                \"path\": \"/opt/nginx/sites\",\n                \"readOnly\": false\n            }, {\n                \"name\": \"log\",\n                \"path\": \"/opt/nginx/log\",\n                \"readOnly\": false\n            }\n        ]\n    }\n}\n```\n\n\u5b9f\u306f\u591a\u3044\u306b\u5d4c\u307e\u3063\u3066\u3057\u307e\u3063\u305f\u306e\u3067\u3059\u304c\u3001exec\u306e\u4e2d\u306f\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u5f15\u6570\u3092\u66f8\u3051\u307e\u305b\u3093\u3002\n`command not found` \u3068\u304b\u8a00\u308f\u308c\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\u306a\u306e\u3067\u3001\u66f8\u304f\u306e\u306f\u5b9f\u884c\u30d5\u30a1\u30a4\u30eb\u306e\u307f\uff08\u3057\u304b\u3082\u30d5\u30eb\u30d1\u30b9\uff09\u3002\nforeground\u306b\u3059\u308b\u30aa\u30d7\u30b7\u30e7\u30f3\u3001 `daemon off;` \u306f\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306b\u66f8\u304b\u306a\u3044\u3068\u3044\u3051\u307e\u305b\u3093\u3002\n\u307e\u3042\u3001\u81ea\u5206\u304c\u77e5\u3089\u306a\u3044\u3060\u3051\u3067\u66f8\u304d\u65b9\u306f\u3042\u308b\u3068\u601d\u3046\u3093\u3067\u3059\u3051\u3069\u306d\u30fc\u3002\n\n## \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u66f8\u304d\u63db\u3048\u308b\n\nlog\u30d5\u30a1\u30a4\u30eb\u3084\u3089include\u30d1\u30b9\u3084\u3089\u3092manifest\u3067\u8ffd\u52a0\u3057\u3066\u3044\u308b\u30d1\u30b9\u306b\u5408\u308f\u305b\u307e\u3059\u3002\n\u3042\u3068\u3001\u4e0a\u8a18\u3067\u66f8\u3044\u305f\u901a\u308a\u3001 `daemon off;` \u3092\u66f8\u3044\u3066\u304a\u304d\u307e\u3059\u3002\n\n```nginx:~/nginx/aci/root/etc/nginx/nginx.conf\nuser  nginx;\nworker_processes  1;\ndaemon off;\n\nerror_log  /opt/nginx/log/error.log warn;\npid        /var/run/nginx.pid;\n\n\nevents {\n    worker_connections  1024;\n}\n\n\nhttp {\n    include       /etc/nginx/mime.types;\n    default_type  application/octet-stream;\n\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log  /opt/nginx/log/access.log  main;\n\n    sendfile        on;\n    #tcp_nopush     on;\n\n    keepalive_timeout  65;\n\n    #gzip  on;\n\n    include /opt/nginx/conf/*.conf;\n}\n```\n\n## ACI\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u308b\n\n\u3053\u308c\u306f\u666e\u901a\u306b\u4f5c\u308c\u3070\u304a\u3063\u3051\u30fc\u3002\n\n```bash\n$ cd ~/nginx\n$ actool build aci nginx.aci\n```\n\n## nginx\u7528\u306e\u8a2d\u5b9a\u3092\u3057\u3066\u304a\u304f\n\n\u3053\u3053\u3067\u306f\u3001\u30db\u30b9\u30c8\u306e\n/mnt/data/conf/nginx \u3092nginx\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u7f6e\u304f\u5834\u6240\u306b\u3001\n/mnt/data/sites \u3092\u30b5\u30a4\u30c8\u306e\u30c7\u30fc\u30bf\u3092\u7f6e\u304f\u5834\u6240\u306b\u3001\n/mnt/data/log \u3092\u30ed\u30b0\u3092\u7f6e\u304f\u5834\u6240\u306b\u3001\n\u305d\u308c\u305e\u308c\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n\u305d\u306e\u305f\u3081\u3001\n\n```nginx:/mnt/data/conf/nginx/default.conf\nserver {\n    listen 80;\n    server_name localhost;\n\n    location / {\n        root /opt/nginx/sites/root;\n        index index.html index.htm;\n    }\n\n    error_page 500 502 503 504 /50x.html;\n    location = /50x.html {\n        root /opt/nginx/sites/root;\n    }\n}\n```\n\n\u3068\u304b\n\n```html:/mnt/data/sites/root/index.html\n<html>\n <head>\n  <title>Test</title>\n </head>\n\n <body>\n  <h1>Hello, world</h1>\n  <p>good morning !</p>\n </body>\n</html>\n```\n\n\u306a\u3069\u306e\u3088\u3046\u306a\u30d5\u30a1\u30a4\u30eb\u3092\u4eee\u306b\u7f6e\u3044\u3066\u304a\u304d\u307e\u3059\u3002\n\n## \u8a66\u3057\u306b\u5b9f\u884c\u3057\u3066\u307f\u308b\n\nmanifest\u3067\u6307\u5b9a\u3057\u3066\u3044\u308b\u30de\u30a6\u30f3\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u5f15\u6570\u3067\u6307\u5b9a\u3057\u3066\u5b9f\u884c\u3057\u307e\u3059\u3002\n\n```bash\n$ sudo rkt --insecure-skip-verify --debug run --volume=conf,kind=host,source=/mnt/data/conf/nginx --volume=sites,kind=host,source=/mnt/data/sites --volume=log,kind=host,source=/mnt/data/log ~/nginx/nginx.aci\n```\n\n`--volume=[manifest\u3067\u6307\u5b9a\u3057\u3066\u3044\u308bname],kind=host,source=[\u5b9f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea]` \u3068\u3044\u3046\u611f\u3058\u3067\u5f15\u6570\u306b\u6307\u5b9a\u3057\u307e\u3059\u3002\n\u540d\u524d\u540c\u58eb\u3067\u5b9f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3068manifest\u3067\u6307\u5b9a\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304c\u30ea\u30f3\u30af\u3057\u3001\u540c\u4e00\u306e\u3082\u306e\u3068\u3057\u3066\u6271\u308f\u308c\u307e\u3059\u3002\n\u307e\u305f\u3001\u7f72\u540d\u3057\u3066\u3044\u306a\u3044\u306e\u3067 `--insecure-skip-verify` \u30aa\u30d7\u30b7\u30e7\u30f3\u304c\u5fc5\u8981\u3067\u3059\u3002\n\n\u3053\u308c\u3067\u3068\u308a\u3042\u3048\u305anginx\u304c\u52d5\u304d\u307e\u3059\u3002\n\u8a66\u3057\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\n```bash\n$ curl http://localhost/\n<html>\n <head>\n  <title>Test</title>\n </head>\n\n <body>\n  <h1>Hello, world</h1>\n  <p>good morning !</p>\n </body>\n</html>\n```\n\n\u3069\u3046\u3067\u3059\uff1f\n\u8868\u793a\u3055\u308c\u307e\u3057\u305f\u304b\uff1f\n\n\u3084\u30fc\u3002\nlocalhost\u3067\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u306e\u697d\u3060\u308f\u3002\n\u3084\u3063\u3071\u3002\n\n\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u3092\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\n```bash\n$ tail /mnt/data/log/access.log\n127.0.0.1 - - [20/Aug/2015:01:40:43 +0000] \"GET / HTTP/1.1\" 200 121 \"-\" \"curl/7.42.1\" \"-\"\n```\n\n\u30ed\u30b0\u3082\u66f8\u304b\u308c\u3066\u3044\u307e\u3059\u3002\n\u30db\u30b9\u30c8\u74b0\u5883\u3068\u306e\u53d7\u3051\u6e21\u3057\u3082\u3067\u304d\u3066\u3044\u307e\u3059\u306d\u3002\n\n# \u81ea\u52d5\u8d77\u52d5\n\n## \u81ea\u52d5\u8d77\u52d5\u3055\u305b\u308b\u3088\u3046\u306b\u3059\u308b\n\n\u81ea\u52d5\u8d77\u52d5\u306b\u3055\u305b\u308b\u3088\u3046\u306b\u3059\u308b\u306b\u306f\u3001\u3044\u3064\u3082\u306e\u3054\u3068\u304fcloud-config\u306b\u66f8\u3044\u3066\u304a\u304d\u307e\u3059\u3002\n\n```yaml:/var/lib/coreos-install/user_data\ncoreos:\n  units:\n    - name: nginx.service\n      command: start\n      content: |\n        [Unit]\n        Description=Nginx next generation web server\n        Requires=network-online.target\n        After=network-online.target\n\n        [Service]\n        ExecStart=/usr/bin/rkt --insecure-skip-verify run --volume=conf,kind=host,source=/mnt/data/conf/nginx --volume=sites,kind=host,source=/mnt/data/sites --volume=log,kind=host,source=/mnt/data/log /home/xxx/nginx/nginx.aci\n        KillMode=mixed\n        Restart=always\n```\n\n\u66f8\u3044\u305f\u3089\u4e00\u5ea6\u8a66\u3057\u307e\u3059\u3002\n\n```bash\n$ sudo coreos-cloudinit -from-file=/var/lib/coreos-install/user_data\n   :\n2015/08/20 10:22:03 Calling unit command \"start\" on \"nginx.service\"'\n2015/08/20 10:22:03 Result of \"start\" on \"nginx.service\": done\n```\n\n\u554f\u984c\u306a\u3051\u308c\u3070done\u306b\u306a\u308b\u306f\u305a\u3067\u3059\u3002\n\u4e00\u5ea6\u8a66\u3059\u3068\u3001system\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u304c\u66f8\u304b\u308c\u307e\u3059\u306e\u3067\u3001\u3042\u3068\u306fsystemctl\u3067\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\n\n```bash\n$ sudo systemctl status nginx.service\n\u25cf nginx.service - Nginx next generation web server\n   Loaded: loaded (/etc/systemd/system/nginx.service; static; vendor preset: disabled)\n   Active: active (running) since Wed 2015-08-19 15:52:23 JST; 18h ago\n Main PID: 658 (ld-linux-x86-64)\n   Memory: 24.5M\n      CPU: 22.217s\n   CGroup: /system.slice/nginx.service\n           mq658 stage1/rootfs/usr/lib/ld-linux-x86-64.so.2 stage1/rootfs/usr...\n\nAug 19 15:52:23 logmanager systemd[1]: Started Nginx next generation web server.\nAug 19 15:52:23 logmanager systemd[1]: Starting Nginx next generation web s.....\nAug 20 10:20:24 logmanager systemd[1]: Started Nginx next generation web server.\nAug 20 10:22:03 logmanager systemd[1]: Started Nginx next generation web server.\nHint: Some lines were ellipsized, use -l to show in full.\n```\n\n\u7121\u4e8b\u3001\u52d5\u304b\u3059\u3053\u3068\u304c\u3067\u304d\u307e\u3057\u305f\u3002\n\u8a66\u9a13\u74b0\u5883\u306a\u3089sudo restart\u3068\u304b\u3057\u3066\u307f\u3066\u304f\u3060\u3055\u3044\u3002\n\n# \u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\n\n## nginx\u3092reload\u3055\u305b\u308b\n\n\u8a2d\u5b9a\u3092\u66f8\u304d\u63db\u3048\u305f\u3068\u304d\u306bnginx\u3092\u30ea\u30b9\u30bf\u30fc\u30c8\u3055\u305b\u308b\u65b9\u6cd5\u3067\u3059\u3002\nRocket\u306e\u30ea\u30b9\u30c8\u3092\u53d6\u5f97\u3057\u3001\u4e2d\u306b\u5165\u308a\u3001nginx\u3092\u64cd\u4f5c\u3057\u307e\u3059\u3002\n\n```bash\n$ sudo rkt list\nUUID            ACI     STATE   NETWORKS\n31ffb1b9        nginx   running\n\n$ sudo rkt enter 31ffb1b9\nNo command specified, assuming \"/bin/bash\"\nroot@rkt-31ffb1b9-fa8c-498c-9bbe-53e1842ae085:/# nginx -s reload\n```\n\n", "tags": ["CoreOS", "Rocket", "nginx"]}