{"context": " More than 1 year has passed since last update.\n\nIntro\n\u4ed5\u4e8b\u3067ES/td-agent\u3092\u89e6\u308b\u3053\u3068\u304c\u591a\u304f\u306a\u308a\u30ed\u30fc\u30ab\u30eb\u30de\u30b7\u30f3\u3067\u3082\n\u30c6\u30b9\u30c8\u74b0\u5883\u304c\u5fc5\u8981\u306b\u306a\u3063\u305f\u306e\u3067\u305d\u306e\u69cb\u7bc9\u30e1\u30e2\u306b\u306a\u308a\u307e\u3059\u3002(Vagrant\u4e0a\u306eCentOS6.5)\n\u30ed\u30fc\u30ab\u30ebApache\u306e\u30ed\u30b0\u3092\u30b5\u30f3\u30d7\u30eb\u306btd-agent\u3068ES\u306e\u9023\u643a\u3082\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u74b0\u5883\n\nCentos6.5(Vagrant on Mac)\nElasticSearch 1.3.6\ntd-agent 0.10.55\n\n\n\u524d\u63d0\nVM\u306f\u307e\u3063\u3055\u3089\u306e\u72b6\u614b\u3067\u3059\u3002\nroot\u3067\u4f5c\u696d\u3057\u3066\u307e\u3059\u3002\n\n\u624b\u9806\u3081\u3082\n\n1.Developer Tool\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u3042\u3068\u3067fluent\u306eplugin\u5165\u308c\u308b\u3068\u304d\u306b\u56f0\u308b\u306e\u3067\u5165\u308c\u3066\u304a\u304d\u307e\u3059\u3002\ngcc\u3068\u304b\u305d\u306e\u4ed6\u305f\u304f\u3055\u3093\u5165\u308a\u307e\u3059\u3002\n\nbash\nyum groupinstall \"Development Tools\"\nyum install libcurl-devel #\u3053\u308c\u5165\u308c\u3066\u306a\u3044\u3068\u3060\u3081\u3060\u3063\u305f\n\n\n\n2.JDK\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nhttp://www.oracle.com/technetwork/java/javase/downloads/index.html\nOracle\u306ejdk-7u71\u3092\u4f7f\u3044\u307e\u3059\u3002Mac\u3067\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\n\u5171\u6709\u30d5\u30a9\u30eb\u30c0\u3067vagrant\u5074\u306b\u30b3\u30d4\u30fc\u3057\u3066\u4f7f\u3044\u307e\u3059\u3002\n\nbash\nrpm -ivh jdk-7u71-linux-x64.rpm\n\n\n\nbash\n$ java -version\njava version \"1.7.0_71\"\n\n\n\n3.Apache\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nbash\nyum install httpd\nchkconfig httpd on\nchkconfig --list | grep httpd\nservice httpd start\n\n\n\n4.ElasticSearch\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u4ed5\u4e8b\u306e\u90fd\u5408\u4e0a1.3.6\u3092\u5165\u308c\u308b\u306e\u3067ES\u516c\u5f0f\u304b\u3089rpm\u843d\u3068\u3057\u3066\u304d\u3066\u5165\u308c\u307e\u3059\u3002\n\nbash\nwget https://download.elasticsearch.org/elasticsearch/elasticsearch/elasticsearch-1.3.6.noarch.rpm\nrpm -ivh elasticsearch-1.3.6.noarch.rpm\nchkconfig --add elasticsearch\nchkconfig elasticsearch on\nservice elasticsearch start\ntail -f /var/log/elasticsearch/elasticsearch.log\n\n\n\u8d77\u52d5\u304c\u78ba\u8a8d\u3067\u304d\u308c\u3070OK\n\n5.ElasticSearch\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\n\nbash\ncd /usr/share/elasticsearch/\n\n\n\nmarvel\n\u7ba1\u7406\u30fb\u30e2\u30cb\u30bf\u30fc\u7528\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\n\nbash\n./bin/plugin -install elasticsearch/marvel/latest\n\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5f8c\u8d77\u52d5\u3059\u308c\u3070\u4e0b\u8a18\u3067\u307f\u308c\u307e\u3059\u3002\nhttp://{vagrant\u306eIP}:9200/_plugin/marvel/\n\nHead\nElasticSearch\u306e\u64cd\u4f5cGUI\u30d7\u30e9\u30b0\u30a4\u30f3\n\nbash\n./bin/plugin -install mobz/elasticsearch-head\n\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5f8c\u8d77\u52d5\u3059\u308c\u3070\u4e0b\u8a18\u3067\u307f\u308c\u307e\u3059\u3002\nhttp://{vagrant\u306eIP}:9200/_plugin/head/\n\nkuromoji\n\u65e5\u672c\u8a9e\u89e3\u6790\u30d7\u30e9\u30b0\u30a4\u30f3\nES1.3\u7cfb\u3060\u30682.3.0\u3092\u3044\u308c\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u307f\u305f\u3044\u3067\u3059\u3002\nhttps://github.com/elasticsearch/elasticsearch-analysis-kuromoji\n\nbash\n./bin/plugin -install elasticsearch/elasticsearch-analysis-kuromoji/2.3.0\n\n\n\ninquisitor\n\u30af\u30a8\u30ea\u306e\u30c7\u30d0\u30c3\u30af\u306a\u3069\n\nbash\n./bin/plugin -install polyfractal/elasticsearch-inquisitor\n\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5f8c\u8d77\u52d5\u3059\u308c\u3070\u4e0b\u8a18\u3067\u307f\u308c\u307e\u3059\u3002\nhttp://{vagrant\u306eIP}:9200/_plugin/inquisitor/#/\n\n6.kibana\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nplugin\u7d4c\u7531\u3067\u306f\u306a\u304fApache\u7d4c\u7531\u3067\u898b\u3048\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\nbash\ncurl -sL https://download.elasticsearch.org/kibana/kibana/kibana-3.1.2.tar.gz | sudo tar zxf - -C /var/www/html\nmv /var/www/html/kibana-3.1.2 /var/www/html/kibana\n\n\nhttp://{vagrant\u306eIP}/kibana/index.html\n\u3067kibana\u304c\u307f\u308c\u308c\u3070OK\n\n7.td-agent\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u524d\u306e\u521d\u671f\u8a2d\u5b9a\n\u516c\u5f0f\u30b5\u30a4\u30c8\u3092\u307f\u308b\u3068os\u5074\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u5909\u66f4\u304c\u5fc5\u8981\u306a\u306e\u3067\u4e8b\u524d\u306b\u3084\u3063\u3066\u304a\u304f\nhttp://docs.fluentd.org/ja/articles/before-install\n\n/etc/security/limits.conf\n#\u4e0b\u8a18\u3092\u8ffd\u52a0\nroot soft nofile 65536\nroot hard nofile 65536\n* soft nofile 65536\n* hard nofile 65536\n\n\n\n/etc/sysctl.conf\n#\u4e0b\u8a18\u3092\u8ffd\u52a0\nnet.ipv4.tcp_tw_recycle = 1\nnet.ipv4.tcp_tw_reuse = 1\nnet.ipv4.ip_local_port_range = 10240    65535\n\n\n\u30b5\u30fc\u30d0\u3092\u518d\u8d77\u52d5\u3059\u308b\u3002\n\n8.td-agent\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3082\u516c\u5f0f\u3092\u53c2\u8003\u306bsh\u3092\u5b9f\u884c\nhttp://docs.fluentd.org/ja/articles/install-by-rpm\n\nbash\ncurl -L http://toolbelt.treasuredata.com/sh/install-redhat.sh | sh\nchkconfig td-agent on\nchkconfig --list | grep td-agent\nservice td-agent start\ntail -f /var/log/td-agent/td-agent.log\n\n\n\u6b63\u5e38\u306b\u8d77\u52d5\u3059\u308c\u3070OK\n\n9.td-agent\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n\u5fc5\u8981\u306a\u3082\u306e + \u4fbf\u5229\u306a\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n\nfluent-plugin-rewrite-tag-filter\n\n\u30ec\u30b3\u30fc\u30c9\u306e\u5185\u5bb9\u306b\u3088\u308a\u30bf\u30b0\u3092\u5909\u66f4\u3059\u308b\u30d7\u30e9\u30b0\u30a4\u30f3\n\n\n\nfluent-plugin-record-reformer\n\n\u30bf\u30b0\u306e\u60c5\u5831\u3092\u30ec\u30b3\u30fc\u30c9\u306e\u5185\u5bb9\u306b\u5909\u63db\u3059\u308b\u30d7\u30e9\u30b0\u30a4\u30f3\n\n\n\nfluent-plugin-rewrite\n\n\u30ec\u30b3\u30fc\u30c9\u306e\u5185\u5bb9\u306b\u3088\u308a\u5024\u3092\u66f8\u63db(\u7121\u8996\u3057\u305f\u308a\u3001\u5024\u3092\u66f8\u304d\u63db\u3048\u305f\u308a)\n\n\n\nfluent-plugin-parser\n\n\u30ec\u30b3\u30fc\u30c9\u3092\u6b63\u898f\u8868\u73fe\u3067parse\u3057\u3066\u5024\u306b\u5165\u308c\u8fbc\u3093\u3060\u308a\u3001\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u5909\u66f4\u3057\u305f\u308a\u3002\n\n\n\nfluent-plugin-tail-ex\n\nin_tail\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u62e1\u5f35\u3002tail\u5148\u3092\u30ef\u30a4\u30eb\u30c9\u30ab\u30fc\u30c9\u3067\u6307\u5b9a\u304c\u53ef\u80fd\u306b\u3002\n\n\n\nfluent-plugin-typecast\n\n\u30c7\u30fc\u30bf\u306e\u578b\u3092\u5909\u63db\u3059\u308b\u30d7\u30e9\u30b0\u30a4\u30f3\n\n\n\nfluent-plugin-forest\n\n\u30bf\u30b0\u6bce\u306bOutput\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u30b9\u30ec\u30c3\u30c9\u3092\u81ea\u52d5\u7684\u306b\u751f\u6210\u3057\u3066\u304f\u308c\u308b\u3002\n\u308f\u304b\u308a\u3084\u3059\u3044\u306e\u3067\u3053\u3053\u3092\u3069\u3046\u305e\n\n\n\nfluent-plugin-filter\n\nallow/deny\u3067\u30ec\u30b3\u30fc\u30c9\u3092filter\u3092\u3057\u3066\u304f\u308c\u308b\u3002\n\n\n\nfluent-plugin-multiprocess\n\nfluent\u3092\u30de\u30eb\u30c1\u30d7\u30ed\u30bb\u30b9\u5316\u3059\u308b\u30d7\u30e9\u30b0\u30a4\u30f3\n\n\n\nfluent-plugin-elasticsearch\n\nelasticsearch\u306b\u30c7\u30fc\u30bf\u3092\u9001\u308b\u305f\u3081\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\n\n\n\n\nbash\ncd /usr/lib64/fluent/ruby/bin/\n./fluent-gem install fluent-plugin-rewrite-tag-filter --no-ri --no-rdoc -V\n./fluent-gem install fluent-plugin-rewrite --no-ri --no-rdoc -V\n./fluent-gem install fluent-plugin-elasticsearch --no-ri --no-rdoc -V\n./fluent-gem install fluent-plugin-parser --no-ri --no-rdoc -V\n./fluent-gem install fluent-plugin-tail-ex --no-ri --no-rdoc -V\n./fluent-gem install fluent-plugin-record-reformer --no-ri --no-rdoc -V\n./fluent-gem install fluent-plugin-typecast --no-ri --no-rdoc -V\n./fluent-gem install fluent-plugin-forest --no-ri --no-rdoc -V\n./fluent-gem install fluent-plugin-filter --no-ri --no-rdoc -V\n./fluent-gem install fluent-plugin-multiprocess --no-ri --no-rdoc -V\n\n\n\n10.ElasticSearch\u3068td-agent\u306e\u9023\u643a\n\u30ed\u30fc\u30ab\u30eb\u306eApache\u306e\u30ed\u30b0\u3092\u53d6\u308a\u8fbc\u3080\u8a2d\u5b9a\u3092\u3057\u3066\u307f\u307e\u3059\u3002\napache\u306elog\u3092td-agent\u306e\u8d77\u52d5\u30e6\u30fc\u30b6\u3067\u307f\u308c\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\nbash\nchown -R td-agent:td-agent /var/log/httpd/\n\n\n\nES\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u4f5c\u4f5c\u6210\n\u30d5\u30a3\u30fc\u30eb\u30c9\u5b9a\u7fa9\u304c\u3081\u3093\u3069\u304f\u3055\u3044\u306e\u3067dynamic template\u4f7f\u3044\u3001\u3059\u3079\u3066String\u3067\u5b9a\u7fa9\u3057\u3061\u3083\u3044\u307e\u3059\u3002\n\nbash\ncurl -XPUT 'http://localhost:9200/_template/itopantest01' -d '\n{\n  \"template\": \"itopantest01-*\",\n  \"mappings\": {\n    \"_default_\": {\n      \"dynamic_templates\": [{\n        \"string_with_raw\": {\n          \"match\": \"*\",\n          \"match_mapping_type\": \"string\",\n          \"mapping\": {\n            \"type\": \"string\",\n            \"fields\": {\n              \"raw\": {\n                \"type\": \"string\",\n                \"index\": \"not_analyzed\" \n              }\n            }\n          }\n        }\n      }]\n    }\n  }\n}\n'\n\n\n{\"acknowledged\":true}\u300d\u3068\u8868\u793a\u3055\u308c\u308b\u3053\u3068\u3092\u78ba\u8a8d\n\ntd-agent\u5074\u306e\u8a2d\u5b9a\nclient\npath\nmethod\nsize\ncontext\n.\n.\n\u307f\u305f\u3044\u306b\u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u30ad\u30c1\u30f3\u3068\u5206\u3051\u3066\u691c\u7d22\u3067\u304d\u308b\u3088\u3046\u306b\u767b\u9332\u3057\u307e\u3059\u3002\napache2\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3067parse\u3055\u308c\u305f\u3082\u306e\u304b\u3089\u8ffd\u52a0\u3067\u3067url\u306equery\u3084\ncontext\u306a\u3069\u3082\u96c6\u8a08\u3057\u305f\u3044\u306e\u3067\u9014\u4e2d\u3067\u5206\u89e3\u3059\u308b\u51e6\u7406\u304c\u5165\u3063\u3066\u3044\u307e\u3059\u3002\n\u5148\u307b\u3069\u3044\u308c\u305fplugin\u3082\u7e54\u308a\u4ea4\u305c\u3066config\u3092\u66f8\u3044\u3066\u307f\u307e\u3059\u3002\n\n/etc/td-agent/td-agent.conf\n# Input\n# \u30ed\u30fc\u30ab\u30eb\u306e\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u3092\u76e3\u8996\u3059\u308b\n<source>\n  type tail\n  path /var/log/httpd/access_log\n  format apache2\n  pos_file /var/log/td-agent/itopantest01_access_log.pos\n  tag raw.apache.itopantest01.access\n</source>\n\n# \u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u306e\u30d1\u30b9\u90e8\u5206\u304b\u3089\u30af\u30a8\u30ea\u6587\u5b57\u5217\u3092\u5206\u96e2\u3059\u308b\n#  raw.apache.itopantest01.access\n#    -> separated.apache.itopantest01.access\n<match raw.**>\n  type parser\n  reserve_data yes\n  key_name path\n  format /^(?<path>[^?]+)(\\?(?<query>.+))?$/\n  tag separated.apache.itopantest01.access\n</match>\n\n# \u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u306e\u30d1\u30b9\u90e8\u5206\u304b\u3089\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u3092\u62bd\u51fa\u3059\u308b\n#\n# separated.apache.itopantest01.access.**\n#   -> separated2.apache.itopantest01.access.**\n<match separated.**>\n  type parser\n  reserve_data yes\n  key_name path\n  format /^(?<context>/[^/]*).*$/\n  tag separated2.apache.itopantest01.access\n</match>\n\n# size\u30d5\u30a3\u30fc\u30eb\u30c9\u3092integer\u306b\u30ad\u30e3\u30b9\u30c8\u3059\u308b\n#\n# separated2.apache.itopantest01.access.**\n#   -> casted.apache.itopantest01.access.**\n#\n<match separated2.**>\n   type typecast\n   item_types size:integer\n   tag casted.apache.itopantest01.access\n</match>\n\n# \u30db\u30b9\u30c8\u540d\u3092\u8ffd\u52a0\u3059\u308b\n# apache2\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3067host\u3068\u3057\u3066\u89e3\u6790\u3055\u308c\u3066\u3044\u305f\n# \u30d5\u30a3\u30fc\u30eb\u30c9\u306f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8IP\u306a\u306e\u3067client\u30d5\u30a3\u30fc\u30eb\u30c9\u306b\u5909\u63db\u3059\u308b\u3002\n# casted.apache.itopantest01.access.**\n#   -> toelastic.apache.itopantest01.access.**\n#\n<match casted.**>\n  type record_reformer\n  renew_record false\n  enable_ruby false\n  <record>\n    client ${host}\n    host ${hostname}\n  </record>\n  tag toelastic.apache.itopantest01.access\n</match>\n\n#\n# elasticsearch\u306b\u767b\u9332\u3059\u308b\n#\n<match toelastic.apache.itopantest01.access.**>\n  type elasticsearch\n  host localhost\n  port 9200\n  type_name itopantest01 #type\u540d\u3002\u306a\u3093\u3067\u3082\u3088\u3044\n  include_tag_key true\n  logstash_format true\n  logstash_template itopantest01 #\u3055\u3063\u304d\u6307\u5b9a\u3057\u305ftemplate\u540d\n  logstash_prefix itopantest01 #\u3053\u3053\u3067index\u540d\u304c\u6307\u5b9a\u3067\u304d\u307e\u3059\u3002\n  buffer_type file\n  buffer_path /var/log/td-agent/tmp/out_elasticsearch.*.buffer\n  buffer_chunk_limit 8m\n  buffer_queue_limit 256\n  flush_interval 10s\n  retry_limit 17\n  retry_wait 1s\n</match>\n\n\n\ntd-agent\u3092\u518d\u8d77\u52d5\u3002\n\n\u78ba\u8a8d\ntd-agent\u306e\u30ed\u30b0\u3082\u898b\u3064\u3064\u30ed\u30fc\u30ab\u30eb\u306ekibana\u3092\u9069\u5f53\u306b\u30a2\u30af\u30bb\u30b9\u5f8c\u3001\nhead\u30d7\u30e9\u30b0\u30a4\u30f3\u306eOverview\u3084browser\u3067index\u304c\u78ba\u8a8d\u3067\u304d\u308c\u3070OK\nOverview\n\nBrowser\n\u30d5\u30a3\u30fc\u30eb\u30c9\u3082\u30ad\u30c1\u30f3\u3068\u5206\u304b\u308c\u3066\u307e\u3059\u306d\u3002\n\n\u3042\u3068\u306fkibana\u3067\u3067\u304d\u305findex\u3092\u6307\u5b9a\u3057\u3066\u30b0\u30e9\u30d5\u5316\u3059\u308b\u306a\u308a\u697d\u3057\u3044\u4e16\u754c\u304c\u5f85\u3063\u3066\u3044\u307e\u3059\u3002\n\n\u53c2\u8003URL\nhttp://www.oracle.com/technetwork/java/javase/downloads/index.html\nhttp://www.elasticsearch.org/overview/kibana/installation/\nhttp://qiita.com/harukasan/items/0e69f5c17f12db7b2e98\nhttp://blog.kentarok.org/entry/2012/07/01/000518\nhttp://d.hatena.ne.jp/tagomoris/20120410/1334040981\nhttp://muddydixon.hatenablog.com/entry/2012/08/31/144853\nhttp://docs.fluentd.org/articles/in_multiprocess\n#Intro\n\u4ed5\u4e8b\u3067ES/td-agent\u3092\u89e6\u308b\u3053\u3068\u304c\u591a\u304f\u306a\u308a\u30ed\u30fc\u30ab\u30eb\u30de\u30b7\u30f3\u3067\u3082\n\u30c6\u30b9\u30c8\u74b0\u5883\u304c\u5fc5\u8981\u306b\u306a\u3063\u305f\u306e\u3067\u305d\u306e\u69cb\u7bc9\u30e1\u30e2\u306b\u306a\u308a\u307e\u3059\u3002(Vagrant\u4e0a\u306eCentOS6.5)\n\u30ed\u30fc\u30ab\u30ebApache\u306e\u30ed\u30b0\u3092\u30b5\u30f3\u30d7\u30eb\u306btd-agent\u3068ES\u306e\u9023\u643a\u3082\u3057\u3066\u307f\u307e\u3059\u3002\n\n#\u74b0\u5883\n* Centos6.5(Vagrant on Mac)\n* ElasticSearch 1.3.6\n* td-agent 0.10.55\n\n#\u524d\u63d0\nVM\u306f\u307e\u3063\u3055\u3089\u306e\u72b6\u614b\u3067\u3059\u3002\nroot\u3067\u4f5c\u696d\u3057\u3066\u307e\u3059\u3002\n\n#\u624b\u9806\u3081\u3082\n##1.Developer Tool\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u3042\u3068\u3067fluent\u306eplugin\u5165\u308c\u308b\u3068\u304d\u306b\u56f0\u308b\u306e\u3067\u5165\u308c\u3066\u304a\u304d\u307e\u3059\u3002\ngcc\u3068\u304b\u305d\u306e\u4ed6\u305f\u304f\u3055\u3093\u5165\u308a\u307e\u3059\u3002\n\n```bash:bash\nyum groupinstall \"Development Tools\"\nyum install libcurl-devel #\u3053\u308c\u5165\u308c\u3066\u306a\u3044\u3068\u3060\u3081\u3060\u3063\u305f\n```\n\n##2.JDK\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nhttp://www.oracle.com/technetwork/java/javase/downloads/index.html\nOracle\u306ejdk-7u71\u3092\u4f7f\u3044\u307e\u3059\u3002Mac\u3067\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\n\u5171\u6709\u30d5\u30a9\u30eb\u30c0\u3067vagrant\u5074\u306b\u30b3\u30d4\u30fc\u3057\u3066\u4f7f\u3044\u307e\u3059\u3002\n\n```bash:bash\nrpm -ivh jdk-7u71-linux-x64.rpm\n```\n\n```bash:bash\n$ java -version\njava version \"1.7.0_71\"\n```\n\n\n##3.Apache\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```bash:bash\nyum install httpd\nchkconfig httpd on\nchkconfig --list | grep httpd\nservice httpd start\n```\n\n##4.ElasticSearch\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u4ed5\u4e8b\u306e\u90fd\u5408\u4e0a1.3.6\u3092\u5165\u308c\u308b\u306e\u3067ES\u516c\u5f0f\u304b\u3089rpm\u843d\u3068\u3057\u3066\u304d\u3066\u5165\u308c\u307e\u3059\u3002\n\n```bash:bash\nwget https://download.elasticsearch.org/elasticsearch/elasticsearch/elasticsearch-1.3.6.noarch.rpm\nrpm -ivh elasticsearch-1.3.6.noarch.rpm\nchkconfig --add elasticsearch\nchkconfig elasticsearch on\nservice elasticsearch start\ntail -f /var/log/elasticsearch/elasticsearch.log\n```\n\u8d77\u52d5\u304c\u78ba\u8a8d\u3067\u304d\u308c\u3070OK\n\n##5.ElasticSearch\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\n\n```bash:bash\ncd /usr/share/elasticsearch/\n```\n\n###marvel\n\n\u7ba1\u7406\u30fb\u30e2\u30cb\u30bf\u30fc\u7528\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\n\n```bash:bash\n./bin/plugin -install elasticsearch/marvel/latest\n```\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5f8c\u8d77\u52d5\u3059\u308c\u3070\u4e0b\u8a18\u3067\u307f\u308c\u307e\u3059\u3002\nhttp://{vagrant\u306eIP}:9200/_plugin/marvel/\n\n\n###Head\nElasticSearch\u306e\u64cd\u4f5cGUI\u30d7\u30e9\u30b0\u30a4\u30f3\n\n```bash:bash\n./bin/plugin -install mobz/elasticsearch-head\n```\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5f8c\u8d77\u52d5\u3059\u308c\u3070\u4e0b\u8a18\u3067\u307f\u308c\u307e\u3059\u3002\nhttp://{vagrant\u306eIP}:9200/_plugin/head/\n\n###kuromoji\n\u65e5\u672c\u8a9e\u89e3\u6790\u30d7\u30e9\u30b0\u30a4\u30f3\nES1.3\u7cfb\u3060\u30682.3.0\u3092\u3044\u308c\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u307f\u305f\u3044\u3067\u3059\u3002\nhttps://github.com/elasticsearch/elasticsearch-analysis-kuromoji\n\n```bash:bash\n./bin/plugin -install elasticsearch/elasticsearch-analysis-kuromoji/2.3.0\n```\n\n###inquisitor\n\u30af\u30a8\u30ea\u306e\u30c7\u30d0\u30c3\u30af\u306a\u3069\n\n```bash:bash\n./bin/plugin -install polyfractal/elasticsearch-inquisitor\n```\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5f8c\u8d77\u52d5\u3059\u308c\u3070\u4e0b\u8a18\u3067\u307f\u308c\u307e\u3059\u3002\nhttp://{vagrant\u306eIP}:9200/_plugin/inquisitor/#/\n\n\n##6.kibana\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nplugin\u7d4c\u7531\u3067\u306f\u306a\u304fApache\u7d4c\u7531\u3067\u898b\u3048\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\n```bash:bash\ncurl -sL https://download.elasticsearch.org/kibana/kibana/kibana-3.1.2.tar.gz | sudo tar zxf - -C /var/www/html\nmv /var/www/html/kibana-3.1.2 /var/www/html/kibana\n```\nhttp://{vagrant\u306eIP}/kibana/index.html\n\u3067kibana\u304c\u307f\u308c\u308c\u3070OK\n\n##7.td-agent\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u524d\u306e\u521d\u671f\u8a2d\u5b9a\n\u516c\u5f0f\u30b5\u30a4\u30c8\u3092\u307f\u308b\u3068os\u5074\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u5909\u66f4\u304c\u5fc5\u8981\u306a\u306e\u3067\u4e8b\u524d\u306b\u3084\u3063\u3066\u304a\u304f\nhttp://docs.fluentd.org/ja/articles/before-install\n\n```bash:/etc/security/limits.conf\n#\u4e0b\u8a18\u3092\u8ffd\u52a0\nroot soft nofile 65536\nroot hard nofile 65536\n* soft nofile 65536\n* hard nofile 65536\n```\n\n```bash:/etc/sysctl.conf \n#\u4e0b\u8a18\u3092\u8ffd\u52a0\nnet.ipv4.tcp_tw_recycle = 1\nnet.ipv4.tcp_tw_reuse = 1\nnet.ipv4.ip_local_port_range = 10240    65535\n```\n\u30b5\u30fc\u30d0\u3092\u518d\u8d77\u52d5\u3059\u308b\u3002\n\n##8.td-agent\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3082\u516c\u5f0f\u3092\u53c2\u8003\u306bsh\u3092\u5b9f\u884c\nhttp://docs.fluentd.org/ja/articles/install-by-rpm\n\n```bash:bash\ncurl -L http://toolbelt.treasuredata.com/sh/install-redhat.sh | sh\nchkconfig td-agent on\nchkconfig --list | grep td-agent\nservice td-agent start\ntail -f /var/log/td-agent/td-agent.log\n```\n\u6b63\u5e38\u306b\u8d77\u52d5\u3059\u308c\u3070OK\n\n##9.td-agent\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n####\u5fc5\u8981\u306a\u3082\u306e + \u4fbf\u5229\u306a\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n- [fluent-plugin-rewrite-tag-filter](https://github.com/fluent/fluent-plugin-rewrite-tag-filter)\n    - \u30ec\u30b3\u30fc\u30c9\u306e\u5185\u5bb9\u306b\u3088\u308a\u30bf\u30b0\u3092\u5909\u66f4\u3059\u308b\u30d7\u30e9\u30b0\u30a4\u30f3\n- [fluent-plugin-record-reformer](https://github.com/sonots/fluent-plugin-record-reformer)\n    - \u30bf\u30b0\u306e\u60c5\u5831\u3092\u30ec\u30b3\u30fc\u30c9\u306e\u5185\u5bb9\u306b\u5909\u63db\u3059\u308b\u30d7\u30e9\u30b0\u30a4\u30f3\n- [fluent-plugin-rewrite](https://github.com/kentaro/fluent-plugin-rewrite)\n    - \u30ec\u30b3\u30fc\u30c9\u306e\u5185\u5bb9\u306b\u3088\u308a\u5024\u3092\u66f8\u63db(\u7121\u8996\u3057\u305f\u308a\u3001\u5024\u3092\u66f8\u304d\u63db\u3048\u305f\u308a)\n- [fluent-plugin-parser](https://github.com/tagomoris/fluent-plugin-parser)\n    - \u30ec\u30b3\u30fc\u30c9\u3092\u6b63\u898f\u8868\u73fe\u3067parse\u3057\u3066\u5024\u306b\u5165\u308c\u8fbc\u3093\u3060\u308a\u3001\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u5909\u66f4\u3057\u305f\u308a\u3002\n- [fluent-plugin-tail-ex](https://github.com/yosisa/fluent-plugin-tail-ex)\n    - in_tail\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u62e1\u5f35\u3002tail\u5148\u3092\u30ef\u30a4\u30eb\u30c9\u30ab\u30fc\u30c9\u3067\u6307\u5b9a\u304c\u53ef\u80fd\u306b\u3002\n- [fluent-plugin-typecast](https://github.com/tarom/fluent-plugin-typecast)\n    - \u30c7\u30fc\u30bf\u306e\u578b\u3092\u5909\u63db\u3059\u308b\u30d7\u30e9\u30b0\u30a4\u30f3\n- [fluent-plugin-forest](https://github.com/tagomoris/fluent-plugin-forest)\n    - \u30bf\u30b0\u6bce\u306bOutput\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u30b9\u30ec\u30c3\u30c9\u3092\u81ea\u52d5\u7684\u306b\u751f\u6210\u3057\u3066\u304f\u308c\u308b\u3002\n    - \u308f\u304b\u308a\u3084\u3059\u3044\u306e\u3067[\u3053\u3053](http://qiita.com/harukasan/items/0e69f5c17f12db7b2e98)\u3092\u3069\u3046\u305e\n- [fluent-plugin-filter](https://github.com/muddydixon/fluent-plugin-filter)\n    - allow/deny\u3067\u30ec\u30b3\u30fc\u30c9\u3092filter\u3092\u3057\u3066\u304f\u308c\u308b\u3002\n- [fluent-plugin-multiprocess](http://docs.fluentd.org/articles/in_multiprocess)\n    - fluent\u3092\u30de\u30eb\u30c1\u30d7\u30ed\u30bb\u30b9\u5316\u3059\u308b\u30d7\u30e9\u30b0\u30a4\u30f3\n- [fluent-plugin-elasticsearch](https://github.com/uken/fluent-plugin-elasticsearch)\n    - elasticsearch\u306b\u30c7\u30fc\u30bf\u3092\u9001\u308b\u305f\u3081\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\n\n```bash:bash\ncd /usr/lib64/fluent/ruby/bin/\n./fluent-gem install fluent-plugin-rewrite-tag-filter --no-ri --no-rdoc -V\n./fluent-gem install fluent-plugin-rewrite --no-ri --no-rdoc -V\n./fluent-gem install fluent-plugin-elasticsearch --no-ri --no-rdoc -V\n./fluent-gem install fluent-plugin-parser --no-ri --no-rdoc -V\n./fluent-gem install fluent-plugin-tail-ex --no-ri --no-rdoc -V\n./fluent-gem install fluent-plugin-record-reformer --no-ri --no-rdoc -V\n./fluent-gem install fluent-plugin-typecast --no-ri --no-rdoc -V\n./fluent-gem install fluent-plugin-forest --no-ri --no-rdoc -V\n./fluent-gem install fluent-plugin-filter --no-ri --no-rdoc -V\n./fluent-gem install fluent-plugin-multiprocess --no-ri --no-rdoc -V\n```\n\n##10.ElasticSearch\u3068td-agent\u306e\u9023\u643a\n\u30ed\u30fc\u30ab\u30eb\u306eApache\u306e\u30ed\u30b0\u3092\u53d6\u308a\u8fbc\u3080\u8a2d\u5b9a\u3092\u3057\u3066\u307f\u307e\u3059\u3002\n\napache\u306elog\u3092td-agent\u306e\u8d77\u52d5\u30e6\u30fc\u30b6\u3067\u307f\u308c\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\n```bash:bash\nchown -R td-agent:td-agent /var/log/httpd/\n```\n\n###ES\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u4f5c\u4f5c\u6210\n\u30d5\u30a3\u30fc\u30eb\u30c9\u5b9a\u7fa9\u304c\u3081\u3093\u3069\u304f\u3055\u3044\u306e\u3067dynamic template\u4f7f\u3044\u3001\u3059\u3079\u3066String\u3067\u5b9a\u7fa9\u3057\u3061\u3083\u3044\u307e\u3059\u3002\n\n```bash:bash\ncurl -XPUT 'http://localhost:9200/_template/itopantest01' -d '\n{\n  \"template\": \"itopantest01-*\",\n  \"mappings\": {\n    \"_default_\": {\n      \"dynamic_templates\": [{\n        \"string_with_raw\": {\n          \"match\": \"*\",\n          \"match_mapping_type\": \"string\",\n          \"mapping\": {\n            \"type\": \"string\",\n            \"fields\": {\n              \"raw\": {\n                \"type\": \"string\",\n                \"index\": \"not_analyzed\" \n              }\n            }\n          }\n        }\n      }]\n    }\n  }\n}\n'\n```\n{\"acknowledged\":true}\u300d\u3068\u8868\u793a\u3055\u308c\u308b\u3053\u3068\u3092\u78ba\u8a8d\n\n###td-agent\u5074\u306e\u8a2d\u5b9a\nclient\npath\nmethod\nsize\ncontext\n.\n.\n\u307f\u305f\u3044\u306b\u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u30ad\u30c1\u30f3\u3068\u5206\u3051\u3066\u691c\u7d22\u3067\u304d\u308b\u3088\u3046\u306b\u767b\u9332\u3057\u307e\u3059\u3002\napache2\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3067parse\u3055\u308c\u305f\u3082\u306e\u304b\u3089\u8ffd\u52a0\u3067\u3067url\u306equery\u3084\ncontext\u306a\u3069\u3082\u96c6\u8a08\u3057\u305f\u3044\u306e\u3067\u9014\u4e2d\u3067\u5206\u89e3\u3059\u308b\u51e6\u7406\u304c\u5165\u3063\u3066\u3044\u307e\u3059\u3002\n\u5148\u307b\u3069\u3044\u308c\u305fplugin\u3082\u7e54\u308a\u4ea4\u305c\u3066config\u3092\u66f8\u3044\u3066\u307f\u307e\u3059\u3002\n\n```vim:/etc/td-agent/td-agent.conf\n# Input\n# \u30ed\u30fc\u30ab\u30eb\u306e\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u3092\u76e3\u8996\u3059\u308b\n<source>\n  type tail\n  path /var/log/httpd/access_log\n  format apache2\n  pos_file /var/log/td-agent/itopantest01_access_log.pos\n  tag raw.apache.itopantest01.access\n</source>\n\n# \u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u306e\u30d1\u30b9\u90e8\u5206\u304b\u3089\u30af\u30a8\u30ea\u6587\u5b57\u5217\u3092\u5206\u96e2\u3059\u308b\n#  raw.apache.itopantest01.access\n#    -> separated.apache.itopantest01.access\n<match raw.**>\n  type parser\n  reserve_data yes\n  key_name path\n  format /^(?<path>[^?]+)(\\?(?<query>.+))?$/\n  tag separated.apache.itopantest01.access\n</match>\n\n# \u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u306e\u30d1\u30b9\u90e8\u5206\u304b\u3089\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u3092\u62bd\u51fa\u3059\u308b\n#\n# separated.apache.itopantest01.access.**\n#   -> separated2.apache.itopantest01.access.**\n<match separated.**>\n  type parser\n  reserve_data yes\n  key_name path\n  format /^(?<context>/[^/]*).*$/\n  tag separated2.apache.itopantest01.access\n</match>\n\n# size\u30d5\u30a3\u30fc\u30eb\u30c9\u3092integer\u306b\u30ad\u30e3\u30b9\u30c8\u3059\u308b\n#\n# separated2.apache.itopantest01.access.**\n#   -> casted.apache.itopantest01.access.**\n#\n<match separated2.**>\n   type typecast\n   item_types size:integer\n   tag casted.apache.itopantest01.access\n</match>\n\n# \u30db\u30b9\u30c8\u540d\u3092\u8ffd\u52a0\u3059\u308b\n# apache2\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3067host\u3068\u3057\u3066\u89e3\u6790\u3055\u308c\u3066\u3044\u305f\n# \u30d5\u30a3\u30fc\u30eb\u30c9\u306f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8IP\u306a\u306e\u3067client\u30d5\u30a3\u30fc\u30eb\u30c9\u306b\u5909\u63db\u3059\u308b\u3002\n# casted.apache.itopantest01.access.**\n#   -> toelastic.apache.itopantest01.access.**\n#\n<match casted.**>\n  type record_reformer\n  renew_record false\n  enable_ruby false\n  <record>\n    client ${host}\n    host ${hostname}\n  </record>\n  tag toelastic.apache.itopantest01.access\n</match>\n\n#\n# elasticsearch\u306b\u767b\u9332\u3059\u308b\n#\n<match toelastic.apache.itopantest01.access.**>\n  type elasticsearch\n  host localhost\n  port 9200\n  type_name itopantest01 #type\u540d\u3002\u306a\u3093\u3067\u3082\u3088\u3044\n  include_tag_key true\n  logstash_format true\n  logstash_template itopantest01 #\u3055\u3063\u304d\u6307\u5b9a\u3057\u305ftemplate\u540d\n  logstash_prefix itopantest01 #\u3053\u3053\u3067index\u540d\u304c\u6307\u5b9a\u3067\u304d\u307e\u3059\u3002\n  buffer_type file\n  buffer_path /var/log/td-agent/tmp/out_elasticsearch.*.buffer\n  buffer_chunk_limit 8m\n  buffer_queue_limit 256\n  flush_interval 10s\n  retry_limit 17\n  retry_wait 1s\n</match>\n\n```\ntd-agent\u3092\u518d\u8d77\u52d5\u3002\n\n\n###\u78ba\u8a8d\ntd-agent\u306e\u30ed\u30b0\u3082\u898b\u3064\u3064\u30ed\u30fc\u30ab\u30eb\u306ekibana\u3092\u9069\u5f53\u306b\u30a2\u30af\u30bb\u30b9\u5f8c\u3001\nhead\u30d7\u30e9\u30b0\u30a4\u30f3\u306eOverview\u3084browser\u3067index\u304c\u78ba\u8a8d\u3067\u304d\u308c\u3070OK\n\nOverview\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2014-12-11 0.00.06.png](https://qiita-image-store.s3.amazonaws.com/0/56598/e288a7b1-5ff9-5c36-1433-bb7983b3cbb5.png)\n\nBrowser\n\u30d5\u30a3\u30fc\u30eb\u30c9\u3082\u30ad\u30c1\u30f3\u3068\u5206\u304b\u308c\u3066\u307e\u3059\u306d\u3002\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2014-12-11 0.20.39.png](https://qiita-image-store.s3.amazonaws.com/0/56598/71bf917c-8918-6919-4f50-5705049f458a.png)\n\n\u3042\u3068\u306fkibana\u3067\u3067\u304d\u305findex\u3092\u6307\u5b9a\u3057\u3066\u30b0\u30e9\u30d5\u5316\u3059\u308b\u306a\u308a\u697d\u3057\u3044\u4e16\u754c\u304c\u5f85\u3063\u3066\u3044\u307e\u3059\u3002\n\n\n#\u53c2\u8003URL\nhttp://www.oracle.com/technetwork/java/javase/downloads/index.html\nhttp://www.elasticsearch.org/overview/kibana/installation/\nhttp://qiita.com/harukasan/items/0e69f5c17f12db7b2e98\nhttp://blog.kentarok.org/entry/2012/07/01/000518\nhttp://d.hatena.ne.jp/tagomoris/20120410/1334040981\nhttp://muddydixon.hatenablog.com/entry/2012/08/31/144853\nhttp://docs.fluentd.org/articles/in_multiprocess\n", "tags": ["Elasticsearch", "fluentd", "vagrant"]}