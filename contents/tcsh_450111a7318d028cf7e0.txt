{"tags": ["AWS", "aws-cli", "RDS", "PostgreSQL"], "context": "\n\n\u524d\u63d0\u6761\u4ef6\n\nRDS\u3078\u306e\u6a29\u9650\nRDS\u306b\u5bfe\u3057\u3066\u30d5\u30eb\u6a29\u9650\u304c\u3042\u308b\u3053\u3068\u3002\n\nEC2\u3078\u306e\u6a29\u9650\nEC2\u3078\u306e\u8aad\u307f\u53d6\u308a\u6a29\u9650\u304c\u3042\u308b\u3053\u3068\u3002\n\nAWS CLI\n\u4ee5\u4e0b\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u52d5\u4f5c\u78ba\u8a8d\u6e08\n\nAWS CLI 1.11.14\n\n\n\u30b3\u30de\u30f3\u30c9\naws --version\n\n\n\n\u7d50\u679c(\u4f8b)\n      aws-cli/1.11.14 Python/2.7.10 Darwin/15.6.0 botocore/1.4.71\n\n\n\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u53e4\u3044\u5834\u5408\u306f\u6700\u65b0\u7248\u306b\u66f4\u65b0\u3057\u307e\u3057\u3087\u3046\u3002\n\n\u30b3\u30de\u30f3\u30c9\nsudo -H pip install -U awscli\n\n\n\nAWS\u30a2\u30ab\u30a6\u30f3\u30c8\u306e\u5c5e\u6027\nAWS\u30a2\u30ab\u30a6\u30f3\u30c8\u304cEC2-Classic\u306b\u5bfe\u5fdc\u3057\u3066\u3044\u306a\u3044\u3053\u3068\u3002\n\n\u30b3\u30de\u30f3\u30c9\nAWS_SUPPORT_PLATFORMS=$( \\\n               aws ec2 describe-account-attributes \\\n                 --query 'AccountAttributes[?AttributeName == `supported-platforms`].AttributeValues[].AttributeValue' \\\n                 --output text \\\n      ) && echo ${AWS_SUPPORT_PLATFORMS}\n\n\n\n\u7d50\u679c(\u4f8b)\n      VPC\n\n\n'VPC'\u306e\u4ed6\u306b'EC2'\u304c\u8868\u793a\u3055\u308c\u308b\u5834\u5408\u3001\u5225\u306e\u30a2\u30ab\u30a6\u30f3\u30c8\u3092\u4f5c\u6210\u3082\u3057\u304f\u306f\u5229\u7528\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u30c7\u30d5\u30a9\u30eb\u30c8VPC\u306e\u5b58\u5728\n\u30c7\u30d5\u30a9\u30eb\u30c8VPC\u304c\u5b58\u5728\u3059\u308b\u3053\u3068\u3002\n\npsql\u30b3\u30de\u30f3\u30c9\u306e\u5b58\u5728\n\n\u30b3\u30de\u30f3\u30c9\nwhich psql\n\n\n\n\u7d50\u679c(\u5b58\u5728\u3059\u308b\u5834\u5408\u306e\u4f8b)\n      /opt/local/bin/psql\n\n\n\n\u7d50\u679c(\u5b58\u5728\u3057\u306a\u3044\u5834\u5408\u306e\u4f8b)\n      psql: Command not found.\n\n\n\n0. \u6e96\u5099\n\n0.1. \u30ea\u30fc\u30b8\u30e7\u30f3\u306e\u6c7a\u5b9a\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nexport AWS_DEFAULT_REGION='ap-northeast-1'\n\n\n\n0.2. \u5909\u6570\u306e\u78ba\u8a8d\n\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u304c\u60f3\u5b9a\u306e\u3082\u306e\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\u5909\u6570\u306e\u78ba\u8a8d\naws configure list\n\n\n\n\u7d50\u679c(\u4f8b)\n            Name                    Value             Type    Location\n            ----                    -----             ----    --------\n         profile       rdsFull-prjz-mbp13        env    AWS_DEFAULT_PROFILE\n      access_key     ****************XXXX shared-credentials-file\n      secret_key     ****************XXXX shared-credentials-file\n          region        ap-northeast-1        env    AWS_DEFAULT_REGION\n\n\n\n0.3. \u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30fc\u30b0\u30eb\u30fc\u30d7\u306e\u6307\u5b9a\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nVPC_SG_NAME='rds-posgre-inbound'\n\n\n\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30fc\u30b0\u30eb\u30fc\u30d7\u306eID\u3092\u53d6\u5f97\u3057\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\nVPC_SG_ID=$( \\\n        aws ec2 describe-security-groups \\\n          --filter Name=group-name,Values=${VPC_SG_NAME} \\\n          --query 'SecurityGroups[].GroupId' \\\n          --output text \\\n) \\\n        && echo ${VPC_SG_ID}\n\n\n\n\u7d50\u679c(\u4f8b)\n      sg-xxxxxxxx\n\n\n\n1. \u4e8b\u524d\u4f5c\u696d\n\n1.1. DB\u30a8\u30f3\u30b8\u30f3\u306e\u6c7a\u5b9a\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nRDS_ENGINE_NAME='postgres'\n\n\n\n1.2. License Model\nPostgreSQL\u306e\u30e9\u30a4\u30bb\u30f3\u30b9\u30e2\u30c7\u30eb\u306f1\u3064\u306e\u307f\u3067\u3059\u3002\n\u30c7\u30d5\u30a9\u30eb\u30c8\u5024: postgresql-license\n\n1.3. DB Instance Class\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nRDS_INSTANCE_CLASS='db.t2.micro'\n\n\n\n1.4. Allocated Storage\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u7528\u306b5GB\u306e\u30b9\u30c8\u30ec\u30fc\u30b8\u3092\u5272\u308a\u5f53\u3066\u307e\u3059\u3002\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nRDS_STORAGE_SIZE='5'\n\n\n\n1.5. DB Instance Identifier\nDB\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u540d\u3092\u6c7a\u5b9a\u3057\u307e\u3059\u3002\n\u9078\u629e\u3057\u305f\u30ea\u30fc\u30b8\u30e7\u30f3\u5185\u3067\u3001\u81ea\u5206\u306e\u30a2\u30ab\u30a6\u30f3\u30c8\u306b\u5bfe\u3057\u3066\u4e00\u610f\u3067\u3042\u308b\u3053\u3068\u304c\u5fc5\u8981\u3067\u3059\u3002\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nRDS_INSTANCE_IDENT=\"postgre-handson-$(date +%Y%m%d)\" \\\n        && echo ${RDS_INSTANCE_IDENT}\n\n\n\n1.6. Master Username\nDB \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u30ed\u30b0\u30aa\u30f3\u3059\u308b\u305f\u3081\u306e\u30de\u30b9\u30bf\u30fc\u30e6\u30fc\u30b6\u30fc\u540d\u3092\u82f1\u6570\u5b57\u3067\u5165\u529b\u3057\u307e\u3059\u3002\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nRDS_USER_NAME='pgadmin'\n\n\n\n1.6. Master Password\n\u30de\u30b9\u30bf\u30fc\u30d1\u30b9\u30ef\u30fc\u30c9\u3068\u3057\u3066 8\uff5e128 \u500b\u306e\u8868\u793a\u53ef\u80fd\u306a ASCII \u6587\u5b57\uff08/\u3001\"\u3001@ \u4ee5\u5916\uff09\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n\u5909\u6570\u306e\u8a2d\u5b9a(\u4f8b)\nRDS_USER_PASS='#dbPass123'\n\n\n\n1.7 \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u540d\u306e\u6307\u5b9a\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u540d\u524d\u3092\u3001\u82f1\u6570\u5b57 63 \u6587\u5b57\u4ee5\u5185\u3067\u5165\u529b\u3057\u307e\u3059\u3002 (\u8d77\u52d5\u5f8c\u306b\u8ffd\u52a0\u3067\u304d\u306a\u3044)\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nRDS_DB_NAME=\"handson$(date +%Y%m%d)\" \\\n        && echo ${RDS_DB_NAME}\n\n\n\u6ce8\u91c8: \u540d\u524d\u3092\u6307\u5b9a\u3057\u306a\u3044\u5834\u5408\u3001DB \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3067\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306f\u4f5c\u6210\u3055\u308c\u307e\u305b\u3093\u3002\n\n1.8 \u30dd\u30fc\u30c8\u306e\u6307\u5b9a (\u7701\u7565)\nDB\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3068\u30dd\u30fc\u30c8\u3092\u5909\u66f4\u3067\u304d\u306a\u3044\u305f\u3081\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u3068\u7570\u306a\u308b\u30dd\u30fc\u30c8\u3092\u5229\u7528\u3059\u308b\u5834\u5408\u306f\u3001DB\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4f5c\u6210\u6642\u306b\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u30c7\u30d5\u30a9\u30eb\u30c8\u5024: 5432 (PostgreSQL\u306e\u5834\u5408)\n\n1.9. VPC ID\u306e\u53d6\u5f97\n\n\u30b3\u30de\u30f3\u30c9\nVPC_ID=$( \\\n        aws ec2 describe-vpcs \\\n          --filters Name=isDefault,Values=true \\\n          --query 'Vpcs[].VpcId' \\\n          --output text \\\n  ) \\\n          && echo ${VPC_ID}\n\n\n\n\u7d50\u679c(\u4f8b)\n      vpc-xxxxxxxx\n\n\n\n1.10. \u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\u306e\u914d\u5217\u3078\u306e\u8ffd\u52a0\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nARRAY_SG_ID=\"${VPC_SG_ID} ${ARRAY_SG_ID}\" \\\n        && echo ${ARRAY_SG_ID}\n\n\n\n2. DB\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u4f5c\u6210\n\n2.1. \u8d77\u52d5\u6642\u523b\u306e\u78ba\u8a8d\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nDATETIME_UTC=$( date -u '+%Y-%m-%dT%H:%MZ' ) \\\n        && echo ${DATETIME_UTC}\n\n\n\n\u7d50\u679c(\u4f8b)\n      2016-11-13T01:23Z\n\n\n\n2.2. DB\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u8d77\u52d5\n\n\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n        RDS_INSTANCE_IDENT: ${RDS_INSTANCE_IDENT}\n        RDS_STORAGE_SIZE:   ${RDS_STORAGE_SIZE}\n        RDS_INSTANCE_CLASS: ${RDS_INSTANCE_CLASS}\n        RDS_ENGINE_NAME:    ${RDS_ENGINE_NAME}\n        RDS_USER_NAME:      ${RDS_USER_NAME}\n        RDS_USER_PASS:      ${RDS_USER_PASS}\n        RDS_DB_NAME:        ${RDS_DB_NAME}\n        ARRAY_SG_ID:        ${ARRAY_SG_ID}\n\nETX\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws rds create-db-instance \\\n        --db-instance-identifier ${RDS_INSTANCE_IDENT} \\\n        --allocated-storage ${RDS_STORAGE_SIZE} \\\n        --db-instance-class ${RDS_INSTANCE_CLASS} \\\n        --engine ${RDS_ENGINE_NAME} \\\n        --master-username ${RDS_USER_NAME} \\\n        --master-user-password ${RDS_USER_PASS} \\\n        --db-name ${RDS_DB_NAME} \\\n        --vpc-security-group-ids ${ARRAY_SG_ID}\n\n\n\n\u7d50\u679c(\u4f8b)\n      {\n        \"DBInstance\": {\n          \"PubliclyAccessible\": true,\n          \"MasterUsername\": \"pgadmin\",\n          \"MonitoringInterval\": 0,\n          \"LicenseModel\": \"postgresql-license\",\n          \"VpcSecurityGroups\": [\n              {\n                  \"Status\": \"active\",\n                  \"VpcSecurityGroupId\": \"sg-xxxxxxxx\"\n              }\n          ],\n          \"CopyTagsToSnapshot\": false,\n          \"OptionGroupMemberships\": [\n              {\n                  \"Status\": \"in-sync\",\n                  \"OptionGroupName\": \"default:postgres-9-5\"\n              }\n          ],\n          \"PendingModifiedValues\": {\n              \"MasterUserPassword\": \"****\"\n          },\n          \"Engine\": \"postgres\",\n          \"MultiAZ\": false,\n          \"DBSecurityGroups\": [],\n          \"DBParameterGroups\": [\n              {\n                  \"DBParameterGroupName\": \"default.postgres9.5\",\n                  \"ParameterApplyStatus\": \"in-sync\"\n              }\n          ],\n          \"AutoMinorVersionUpgrade\": true,\n          \"PreferredBackupWindow\": \"14:30-15:00\",\n          \"DBSubnetGroup\": {\n              \"Subnets\": [\n                  {\n                      \"SubnetStatus\": \"Active\",\n                      \"SubnetIdentifier\": \"subnet-xxxxxxxx\",\n                      \"SubnetAvailabilityZone\": {\n                          \"Name\": \"ap-northeast-1a\"\n                      }\n                  },\n                  {\n                      \"SubnetStatus\": \"Active\",\n                      \"SubnetIdentifier\": \"subnet-xxxxxxxx\",\n                      \"SubnetAvailabilityZone\": {\n                          \"Name\": \"ap-northeast-1c\"\n                      }\n                  }\n              ],\n              \"DBSubnetGroupName\": \"default\",\n              \"VpcId\": \"vpc-xxxxxxxx\",\n              \"DBSubnetGroupDescription\": \"default\",\n              \"SubnetGroupStatus\": \"Complete\"\n          },\n          \"ReadReplicaDBInstanceIdentifiers\": [],\n          \"AllocatedStorage\": 5,\n          \"DBInstanceArn\": \"arn:aws:rds:ap-northeast-1:XXXXXXXXXXXX:db:postgre-handson-20161114\",\n          \"BackupRetentionPeriod\": 1,\n          \"DBName\": \"handson20161114\",\n          \"PreferredMaintenanceWindow\": \"sat:17:17-sat:17:47\",\n          \"DBInstanceStatus\": \"creating\",\n          \"EngineVersion\": \"9.5.4\",\n          \"DomainMemberships\": [],\n          \"StorageType\": \"standard\",\n          \"DbiResourceId\": \"db-XXXXXXXXXXXXXXXXXXXXXXXXXX\",\n          \"CACertificateIdentifier\": \"rds-ca-2015\",\n          \"StorageEncrypted\": false,\n          \"DBInstanceClass\": \"db.t2.micro\",\n          \"DbInstancePort\": 0,\n          \"DBInstanceIdentifier\": \"postgre-handson-20161114\"\n        }\n      }\n\n\n\nDB\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u72b6\u614b\u78ba\u8a8d\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nRDS_INSTANCE_STATUS=$( \\\n        aws rds describe-db-instances \\\n          --db-instance-identifier ${RDS_INSTANCE_IDENT} \\\n          --query 'DBInstances[].DBInstanceStatus' \\\n          --output text \\\n) \\\n          && echo ${RDS_INSTANCE_STATUS}\n\n\n\n\u7d50\u679c(\u4f8b)\n      creating\n\n\navailable\u306b\u306a\u308c\u3070\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u5229\u7528\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u6ce8\u91c8: t2\u3067\u3082\u8d77\u52d5\u306b7\u5206\u304f\u3089\u3044\u304b\u304b\u308b\u3088\u3046\u3067\u3059\u3002\n\n3. \u4e8b\u5f8c\u78ba\u8a8d\n\n3.1. \u30a4\u30d9\u30f3\u30c8\u306e\u78ba\u8a8d\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nRDS_EVENT_TYPE='db-instance'\nRDS_EVENT_START=${DATETIME_UTC}\nRDS_MAX_ITEMS='3'\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws rds describe-events \\\n        --start-time ${RDS_EVENT_START} \\\n        --source-type ${RDS_EVENT_TYPE} \\\n        --max-items ${RDS_MAX_ITEMS}\n\n\n\n\u7d50\u679c(\u4f8b)\n      {\n        \"Events\": [\n          {\n              \"EventCategories\": [\n                  \"creation\"\n              ],\n              \"SourceType\": \"db-instance\",\n              \"SourceArn\": \"arn:aws:rds:ap-northeast-1:XXXXXXXXXXXX:db:postgre-handson-20161114\",\n              \"Date\": \"2016-11-13T05:28:38.782Z\",\n              \"Message\": \"DB instance created\",\n              \"SourceIdentifier\": \"postgre-handson-20161114\"\n          },\n          {\n              \"EventCategories\": [\n                  \"backup\"\n              ],\n              \"SourceType\": \"db-instance\",\n              \"SourceArn\": \"arn:aws:rds:ap-northeast-1:XXXXXXXXXXXX:db:postgre-handson-20161114\",\n              \"Date\": \"2016-11-13T05:29:47.617Z\",\n              \"Message\": \"Backing up DB instance\",\n              \"SourceIdentifier\": \"postgre-handson-20161114\"\n          },\n          {\n              \"EventCategories\": [\n                  \"backup\"\n              ],\n              \"SourceType\": \"db-instance\",\n              \"SourceArn\": \"arn:aws:rds:ap-northeast-1:XXXXXXXXXXXX:db:postgre-handson-20161114\",\n              \"Date\": \"2016-11-13T05:32:17.561Z\",\n              \"Message\": \"Finished DB Instance backup\",\n              \"SourceIdentifier\": \"postgre-handson-20161114\"\n          }\n        ]\n      }\n\n\n\n3.2. DB\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u60c5\u5831\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws rds describe-db-instances \\\n        --db-instance-identifier ${RDS_INSTANCE_IDENT}\n\n\n\n\u7d50\u679c(\u4f8b)\n      {\n        \"DBInstances\": [\n          {\n              \"PubliclyAccessible\": true,\n              \"MasterUsername\": \"pgadmin\",\n              \"MonitoringInterval\": 0,\n              \"LicenseModel\": \"postgresql-license\",\n              \"VpcSecurityGroups\": [\n                  {\n                      \"Status\": \"active\",\n                      \"VpcSecurityGroupId\": \"sg-xxxxxxxx\"\n                  }\n              ],\n              \"InstanceCreateTime\": \"2016-11-13T05:28:38.651Z\",\n              \"CopyTagsToSnapshot\": false,\n              \"OptionGroupMemberships\": [\n                  {\n                      \"Status\": \"in-sync\",\n                      \"OptionGroupName\": \"default:postgres-9-5\"\n                  }\n              ],\n              \"PendingModifiedValues\": {},\n              \"Engine\": \"postgres\",\n              \"MultiAZ\": false,\n              \"LatestRestorableTime\": \"2016-11-13T05:29:47.646Z\",\n              \"DBSecurityGroups\": [],\n              \"DBParameterGroups\": [\n                  {\n                      \"DBParameterGroupName\": \"default.postgres9.5\",\n                      \"ParameterApplyStatus\": \"in-sync\"\n                  }\n              ],\n              \"AutoMinorVersionUpgrade\": true,\n              \"PreferredBackupWindow\": \"14:30-15:00\",\n              \"DBSubnetGroup\": {\n                  \"Subnets\": [\n                      {\n                          \"SubnetStatus\": \"Active\",\n                          \"SubnetIdentifier\": \"subnet-xxxxxxxx\",\n                          \"SubnetAvailabilityZone\": {\n                              \"Name\": \"ap-northeast-1a\"\n                          }\n                      },\n                      {\n                          \"SubnetStatus\": \"Active\",\n                          \"SubnetIdentifier\": \"subnet-xxxxxxxx\",\n                          \"SubnetAvailabilityZone\": {\n                              \"Name\": \"ap-northeast-1c\"\n                          }\n                      }\n                  ],\n                  \"DBSubnetGroupName\": \"default\",\n                  \"VpcId\": \"vpc-xxxxxxxx\",\n                  \"DBSubnetGroupDescription\": \"default\",\n                  \"SubnetGroupStatus\": \"Complete\"\n              },\n              \"ReadReplicaDBInstanceIdentifiers\": [],\n              \"AllocatedStorage\": 5,\n              \"DBInstanceArn\": \"arn:aws:rds:ap-northeast-1:XXXXXXXXXXXX:db:postgre-handson-20161114\",\n              \"BackupRetentionPeriod\": 1,\n              \"DBName\": \"handson20161114\",\n              \"PreferredMaintenanceWindow\": \"sat:17:17-sat:17:47\",\n              \"Endpoint\": {\n                  \"HostedZoneId\": \"Z24O6O9L7SGTNB\",\n                  \"Port\": 5432,\n                  \"Address\": \"postgre-handson-20161114.xxxxxxxxxxxx.ap-northeast-1.rds.amazonaws.com\"\n              },\n              \"DBInstanceStatus\": \"available\",\n              \"EngineVersion\": \"9.5.4\",\n              \"AvailabilityZone\": \"ap-northeast-1a\",\n              \"DomainMemberships\": [],\n              \"StorageType\": \"standard\",\n              \"DbiResourceId\": \"db-XXXXXXXXXXXXXXXXXXXXXXXXXX\",\n              \"CACertificateIdentifier\": \"rds-ca-2015\",\n              \"StorageEncrypted\": false,\n              \"DBInstanceClass\": \"db.t2.micro\",\n              \"DbInstancePort\": 0,\n              \"DBInstanceIdentifier\": \"postgre-handson-20161114\"\n          }\n        ]\n      }\n\n\n\n3.3. \u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u306e\u78ba\u8a8d\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nRDS_INSTANCE_ENDPOINT=$( \\\n        aws rds describe-db-instances \\\n          --db-instance-identifier ${RDS_INSTANCE_IDENT} \\\n          --query 'DBInstances[].Endpoint.Address' \\\n          --output text \\\n) \\\n        && echo ${RDS_INSTANCE_ENDPOINT}\n\n\n\n\u7d50\u679c(\u4f8b)\n      postgre-handson-ap-northeast-1.xxxxxxxxxxxx.ap-northeast-1.rds.amazonaws.com\n\n\n\n3.4. \u63a5\u7d9a\u60c5\u5831\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n\n\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n        RDS_INSTANCE_ENDPOINT: ${RDS_INSTANCE_ENDPOINT}\n        VPC_SG_PORT:           ${VPC_SG_PORT}\n        RDS_DB_NAME:           ${RDS_DB_NAME}\n        RDS_USER_NAME:         ${RDS_USER_NAME}\n        RDS_USER_PASS:         ${RDS_USER_PASS}\n\nETX\n\n\n\n\u30b3\u30de\u30f3\u30c9\necho \"${RDS_INSTANCE_ENDPOINT}:${VPC_SG_PORT}:${RDS_DB_NAME}:${RDS_USER_NAME}:${RDS_USER_PASS}\" >> ${HOME}/.pgpass \\\n        && chmod 600 ${HOME}/.pgpass \\\n        && cat ${HOME}/.pgpass\n\n\n\n3.4. \u63a5\u7d9a\n\n\u30b3\u30de\u30f3\u30c9\npsql \\\n        --host=${RDS_INSTANCE_ENDPOINT} \\\n        --username=${RDS_USER_NAME} \\\n        --dbname=${RDS_DB_NAME}\n\n\n\n\u7d50\u679c\n      psql (9.5.5, server 9.5.4)\n      SSL connection (protocol: TLSv1.2, cipher: ECDHE-RSA-AES256-GCM-SHA384, bits: 256, compression: off)\n      Type \"help\" for help.\n\n      handson20161114=>\n\n\nDB\u30b3\u30de\u30f3\u30c9\u306e\u30c6\u30b9\u30c8\u5b9f\u884c\u3092\u3057\u3066\u307f\u307e\u3059\u3002\n\nSQL\nselect version();\n\n\n\n\u7d50\u679c(\u4f8b)\n                                                       version\n      ----------------------------------------------------------------------------------------------------------\n        PostgreSQL 9.5.4 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.8.2 20140120 (Red Hat 4.8.2-16), 64-bit\n       (1 row)\n\n\nDB\u3078\u306e\u63a5\u7d9a\u3092\u5207\u65ad\u3057\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\n\\q\n\n\n\n3.5. \u4e88\u5b9a\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u30a2\u30af\u30b7\u30e7\u30f3\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws rds describe-pending-maintenance-actions \\\n        --filter Name=db-instance-id,Values=${RDS_INSTANCE_IDENT}\n\n\n\n\u7d50\u679c(\u4f8b)\n      {\n          \"PendingMaintenanceActions\": []\n      }\n\n\n\n3.6. DBMS\u306e\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u78ba\u8a8d\n\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u306e\u4e00\u89a7\u3092\u8868\u793a\u3057\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\naws rds describe-db-log-files \\\n        --db-instance-identifier ${RDS_INSTANCE_IDENT}\n\n\n\n\u7d50\u679c(\u4f8b)\n      {\n        \"DescribeDBLogFiles\": [\n          {\n              \"LastWritten\": 1479014886000,\n              \"LogFileName\": \"error/postgres.log\",\n              \"Size\": 307\n          },\n          {\n              \"LastWritten\": 1479015287000,\n              \"LogFileName\": \"error/postgresql.log.2016-11-13-05\",\n              \"Size\": 1729\n          }\n        ]\n      }\n\n\n\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u307e\u3059\u3002\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nRDS_LOG_NAME=<\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308bLogFileName>\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws rds download-db-log-file-portion \\\n        --db-instance-identifier ${RDS_INSTANCE_IDENT} \\\n        --log-file-name ${RDS_LOG_NAME} \\\n        --query 'LogFileData' \\\n        --output text\n\n\n\n\u7d50\u679c(\u4f8b)\n      2016-11-13 05:28:06 UTC::@:[3317]:LOG:  MultiXact member wraparound protections are now enabled\n      2016-11-13 05:28:06 UTC::@:[3315]:LOG:  database system is ready to accept connections\n      2016-11-13 05:28:06 UTC::@:[3321]:LOG:  autovacuum launcher started\n      2016-11-13 05:28:09 UTC::@:[3318]:LOG:  checkpoint starting: immediate force wait flush-all\n      2016-11-13 05:28:09 UTC::@:[3318]:LOG:  checkpoint complete: wrote 21 buffers (0.1%); 0 transaction log file(s) added, 0 removed, 0 recycled; write=0.001 s, sync=0.008 s, total=0.031 s; sync files=19, longest=0.008 s, average=0.000 s; distance=17 kB, estimate=17 kB\n      2016-11-13 05:28:10 UTC::@:[3318]:LOG:  checkpoint starting: immediate force wait\n      2016-11-13 05:28:10 UTC::@:[3318]:LOG:  checkpoint complete: wrote 0 buffers (0.0%); 0 transaction log file(s) added, 0 removed, 0 recycled; write=0.000 s, sync=0.000 s, total=0.084 s; sync files=0, longest=0.000 s, average=0.000 s; distance=0 kB, estimate=15 kB\n      2016-11-13 05:29:47 UTC::@:[3318]:LOG:  checkpoint starting: force wait\n      2016-11-13 05:29:51 UTC::@:[3318]:LOG:  checkpoint complete: wrote 38 buffers (0.1%); 0 transaction log file(s) added, 0 removed, 0 recycled; write=3.736 s, sync=0.058 s, total=4.092 s; sync files=33, longest=0.058 s, average=0.001 s; distance=5516 kB, estimate=5516 kB\n      2016-11-13 05:34:47 UTC::@:[3318]:LOG:  checkpoint starting: time\n      2016-11-13 05:34:47 UTC::@:[3318]:LOG:  checkpoint complete: wrote 1 buffers (0.0%); 0 transaction log file(s) added, 0 removed, 0 recycled; write=0.000 s, sync=0.003 s, total=0.017 s; sync files=1, longest=0.003 s, average=0.003 s; distance=16384 kB, estimate=16384 kB\n      2016-11-13 05:39:47 UTC::@:[3318]:LOG:  checkpoint starting: time\n      2016-11-13 05:39:47 UTC::@:[3318]:LOG:  checkpoint complete: wrote 1 buffers (0.0%); 0 transaction log file(s) added, 0 removed, 0 recycled; write=0.000 s, sync=0.002 s, total=0.016 s; sync files=1, longest=0.002 s, average=0.002 s; distance=16384 kB, estimate=16384 kB\n\n\n\n\u5b8c\u4e86\n\n\u524d\u63d0\u6761\u4ef6\n========\n\n\nRDS\u3078\u306e\u6a29\u9650\n-----------\n\nRDS\u306b\u5bfe\u3057\u3066\u30d5\u30eb\u6a29\u9650\u304c\u3042\u308b\u3053\u3068\u3002\n\n\nEC2\u3078\u306e\u6a29\u9650\n-----------\n\nEC2\u3078\u306e\u8aad\u307f\u53d6\u308a\u6a29\u9650\u304c\u3042\u308b\u3053\u3068\u3002\n\n\nAWS CLI\n-------\n\n\u4ee5\u4e0b\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u52d5\u4f5c\u78ba\u8a8d\u6e08\n\n- AWS CLI 1.11.14\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws --version\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      aws-cli/1.11.14 Python/2.7.10 Darwin/15.6.0 botocore/1.4.71\n```\n\n\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u53e4\u3044\u5834\u5408\u306f\u6700\u65b0\u7248\u306b\u66f4\u65b0\u3057\u307e\u3057\u3087\u3046\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nsudo -H pip install -U awscli\n```\n\n\nAWS\u30a2\u30ab\u30a6\u30f3\u30c8\u306e\u5c5e\u6027\n-------------------\n\nAWS\u30a2\u30ab\u30a6\u30f3\u30c8\u304cEC2-Classic\u306b\u5bfe\u5fdc\u3057\u3066\u3044\u306a\u3044\u3053\u3068\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nAWS_SUPPORT_PLATFORMS=$( \\\n               aws ec2 describe-account-attributes \\\n                 --query 'AccountAttributes[?AttributeName == `supported-platforms`].AttributeValues[].AttributeValue' \\\n                 --output text \\\n      ) && echo ${AWS_SUPPORT_PLATFORMS}\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      VPC\n```\n\n'VPC'\u306e\u4ed6\u306b'EC2'\u304c\u8868\u793a\u3055\u308c\u308b\u5834\u5408\u3001\u5225\u306e\u30a2\u30ab\u30a6\u30f3\u30c8\u3092\u4f5c\u6210\u3082\u3057\u304f\u306f\u5229\u7528\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\n\u30c7\u30d5\u30a9\u30eb\u30c8VPC\u306e\u5b58\u5728\n-------------------\n\n\u30c7\u30d5\u30a9\u30eb\u30c8VPC\u304c\u5b58\u5728\u3059\u308b\u3053\u3068\u3002\n\n\npsql\u30b3\u30de\u30f3\u30c9\u306e\u5b58\u5728\n------------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nwhich psql\n```\n\n```text:\u7d50\u679c(\u5b58\u5728\u3059\u308b\u5834\u5408\u306e\u4f8b):\n      /opt/local/bin/psql\n```\n\n```text:\u7d50\u679c(\u5b58\u5728\u3057\u306a\u3044\u5834\u5408\u306e\u4f8b):\n      psql: Command not found.\n```\n\n\n0. \u6e96\u5099\n=======\n\n\n0.1. \u30ea\u30fc\u30b8\u30e7\u30f3\u306e\u6c7a\u5b9a\n---------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a\nexport AWS_DEFAULT_REGION='ap-northeast-1'\n```\n\n\n0.2. \u5909\u6570\u306e\u78ba\u8a8d\n---------------\n\n\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u304c\u60f3\u5b9a\u306e\u3082\u306e\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d:\naws configure list\n```\n\n```text:\u7d50\u679c(\u4f8b):\n            Name                    Value             Type    Location\n            ----                    -----             ----    --------\n         profile       rdsFull-prjz-mbp13        env    AWS_DEFAULT_PROFILE\n      access_key     ****************XXXX shared-credentials-file\n      secret_key     ****************XXXX shared-credentials-file\n          region        ap-northeast-1        env    AWS_DEFAULT_REGION\n```\n\n\n0.3. \u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30fc\u30b0\u30eb\u30fc\u30d7\u306e\u6307\u5b9a\n---------------------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nVPC_SG_NAME='rds-posgre-inbound'\n```\n\n\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30fc\u30b0\u30eb\u30fc\u30d7\u306eID\u3092\u53d6\u5f97\u3057\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nVPC_SG_ID=$( \\\n        aws ec2 describe-security-groups \\\n          --filter Name=group-name,Values=${VPC_SG_NAME} \\\n          --query 'SecurityGroups[].GroupId' \\\n          --output text \\\n) \\\n        && echo ${VPC_SG_ID}\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      sg-xxxxxxxx\n```\n\n\n1. \u4e8b\u524d\u4f5c\u696d\n===========\n\n\n1.1. DB\u30a8\u30f3\u30b8\u30f3\u306e\u6c7a\u5b9a\n---------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nRDS_ENGINE_NAME='postgres'\n```\n\n\n1.2. License Model\n------------------\n\nPostgreSQL\u306e\u30e9\u30a4\u30bb\u30f3\u30b9\u30e2\u30c7\u30eb\u306f1\u3064\u306e\u307f\u3067\u3059\u3002\n\n\u30c7\u30d5\u30a9\u30eb\u30c8\u5024: postgresql-license\n\n\n1.3. DB Instance Class\n----------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nRDS_INSTANCE_CLASS='db.t2.micro'\n```\n\n\n1.4. Allocated Storage\n----------------------\n\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u7528\u306b5GB\u306e\u30b9\u30c8\u30ec\u30fc\u30b8\u3092\u5272\u308a\u5f53\u3066\u307e\u3059\u3002\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nRDS_STORAGE_SIZE='5'\n```\n\n\n1.5. DB Instance Identifier\n---------------------------\n\nDB\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u540d\u3092\u6c7a\u5b9a\u3057\u307e\u3059\u3002\n\n\u9078\u629e\u3057\u305f\u30ea\u30fc\u30b8\u30e7\u30f3\u5185\u3067\u3001\u81ea\u5206\u306e\u30a2\u30ab\u30a6\u30f3\u30c8\u306b\u5bfe\u3057\u3066\u4e00\u610f\u3067\u3042\u308b\u3053\u3068\u304c\u5fc5\u8981\u3067\u3059\u3002\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nRDS_INSTANCE_IDENT=\"postgre-handson-$(date +%Y%m%d)\" \\\n        && echo ${RDS_INSTANCE_IDENT}\n```\n\n\n1.6. Master Username\n--------------------\n\nDB \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u30ed\u30b0\u30aa\u30f3\u3059\u308b\u305f\u3081\u306e\u30de\u30b9\u30bf\u30fc\u30e6\u30fc\u30b6\u30fc\u540d\u3092\u82f1\u6570\u5b57\u3067\u5165\u529b\u3057\u307e\u3059\u3002\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nRDS_USER_NAME='pgadmin'\n```\n\n\n1.6. Master Password\n--------------------\n\n\u30de\u30b9\u30bf\u30fc\u30d1\u30b9\u30ef\u30fc\u30c9\u3068\u3057\u3066 8\uff5e128 \u500b\u306e\u8868\u793a\u53ef\u80fd\u306a ASCII \u6587\u5b57\uff08/\u3001\"\u3001@ \u4ee5\u5916\uff09\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a(\u4f8b):\nRDS_USER_PASS='#dbPass123'\n```\n\n\n1.7 \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u540d\u306e\u6307\u5b9a\n------------------------\n\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u540d\u524d\u3092\u3001\u82f1\u6570\u5b57 63 \u6587\u5b57\u4ee5\u5185\u3067\u5165\u529b\u3057\u307e\u3059\u3002 (\u8d77\u52d5\u5f8c\u306b\u8ffd\u52a0\u3067\u304d\u306a\u3044)\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nRDS_DB_NAME=\"handson$(date +%Y%m%d)\" \\\n        && echo ${RDS_DB_NAME}\n```\n\n\u6ce8\u91c8: \u540d\u524d\u3092\u6307\u5b9a\u3057\u306a\u3044\u5834\u5408\u3001DB \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3067\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306f\u4f5c\u6210\u3055\u308c\u307e\u305b\u3093\u3002\n\n\n1.8 \u30dd\u30fc\u30c8\u306e\u6307\u5b9a (\u7701\u7565)\n-----------------------\n\nDB\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3068\u30dd\u30fc\u30c8\u3092\u5909\u66f4\u3067\u304d\u306a\u3044\u305f\u3081\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u3068\u7570\u306a\u308b\u30dd\u30fc\u30c8\u3092\u5229\u7528\u3059\u308b\u5834\u5408\u306f\u3001DB\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4f5c\u6210\u6642\u306b\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n\u30c7\u30d5\u30a9\u30eb\u30c8\u5024: 5432 (PostgreSQL\u306e\u5834\u5408)\n\n\n1.9. VPC ID\u306e\u53d6\u5f97\n-----------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nVPC_ID=$( \\\n        aws ec2 describe-vpcs \\\n          --filters Name=isDefault,Values=true \\\n          --query 'Vpcs[].VpcId' \\\n          --output text \\\n  ) \\\n          && echo ${VPC_ID}\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      vpc-xxxxxxxx\n```\n\n\n1.10. \u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\u306e\u914d\u5217\u3078\u306e\u8ffd\u52a0\n----------------------------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nARRAY_SG_ID=\"${VPC_SG_ID} ${ARRAY_SG_ID}\" \\\n        && echo ${ARRAY_SG_ID}\n```\n\n\n2. DB\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u4f5c\u6210\n=======================\n\n\n2.1. \u8d77\u52d5\u6642\u523b\u306e\u78ba\u8a8d\n-------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nDATETIME_UTC=$( date -u '+%Y-%m-%dT%H:%MZ' ) \\\n        && echo ${DATETIME_UTC}\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      2016-11-13T01:23Z\n```\n\n\n2.2. DB\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u8d77\u52d5\n-------------------------\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d:\ncat << ETX\n\n        RDS_INSTANCE_IDENT: ${RDS_INSTANCE_IDENT}\n        RDS_STORAGE_SIZE:   ${RDS_STORAGE_SIZE}\n        RDS_INSTANCE_CLASS: ${RDS_INSTANCE_CLASS}\n        RDS_ENGINE_NAME:    ${RDS_ENGINE_NAME}\n        RDS_USER_NAME:      ${RDS_USER_NAME}\n        RDS_USER_PASS:      ${RDS_USER_PASS}\n        RDS_DB_NAME:        ${RDS_DB_NAME}\n        ARRAY_SG_ID:        ${ARRAY_SG_ID}\n\nETX\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws rds create-db-instance \\\n        --db-instance-identifier ${RDS_INSTANCE_IDENT} \\\n        --allocated-storage ${RDS_STORAGE_SIZE} \\\n        --db-instance-class ${RDS_INSTANCE_CLASS} \\\n        --engine ${RDS_ENGINE_NAME} \\\n        --master-username ${RDS_USER_NAME} \\\n        --master-user-password ${RDS_USER_PASS} \\\n        --db-name ${RDS_DB_NAME} \\\n        --vpc-security-group-ids ${ARRAY_SG_ID}\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      {\n        \"DBInstance\": {\n          \"PubliclyAccessible\": true,\n          \"MasterUsername\": \"pgadmin\",\n          \"MonitoringInterval\": 0,\n          \"LicenseModel\": \"postgresql-license\",\n          \"VpcSecurityGroups\": [\n              {\n                  \"Status\": \"active\",\n                  \"VpcSecurityGroupId\": \"sg-xxxxxxxx\"\n              }\n          ],\n          \"CopyTagsToSnapshot\": false,\n          \"OptionGroupMemberships\": [\n              {\n                  \"Status\": \"in-sync\",\n                  \"OptionGroupName\": \"default:postgres-9-5\"\n              }\n          ],\n          \"PendingModifiedValues\": {\n              \"MasterUserPassword\": \"****\"\n          },\n          \"Engine\": \"postgres\",\n          \"MultiAZ\": false,\n          \"DBSecurityGroups\": [],\n          \"DBParameterGroups\": [\n              {\n                  \"DBParameterGroupName\": \"default.postgres9.5\",\n                  \"ParameterApplyStatus\": \"in-sync\"\n              }\n          ],\n          \"AutoMinorVersionUpgrade\": true,\n          \"PreferredBackupWindow\": \"14:30-15:00\",\n          \"DBSubnetGroup\": {\n              \"Subnets\": [\n                  {\n                      \"SubnetStatus\": \"Active\",\n                      \"SubnetIdentifier\": \"subnet-xxxxxxxx\",\n                      \"SubnetAvailabilityZone\": {\n                          \"Name\": \"ap-northeast-1a\"\n                      }\n                  },\n                  {\n                      \"SubnetStatus\": \"Active\",\n                      \"SubnetIdentifier\": \"subnet-xxxxxxxx\",\n                      \"SubnetAvailabilityZone\": {\n                          \"Name\": \"ap-northeast-1c\"\n                      }\n                  }\n              ],\n              \"DBSubnetGroupName\": \"default\",\n              \"VpcId\": \"vpc-xxxxxxxx\",\n              \"DBSubnetGroupDescription\": \"default\",\n              \"SubnetGroupStatus\": \"Complete\"\n          },\n          \"ReadReplicaDBInstanceIdentifiers\": [],\n          \"AllocatedStorage\": 5,\n          \"DBInstanceArn\": \"arn:aws:rds:ap-northeast-1:XXXXXXXXXXXX:db:postgre-handson-20161114\",\n          \"BackupRetentionPeriod\": 1,\n          \"DBName\": \"handson20161114\",\n          \"PreferredMaintenanceWindow\": \"sat:17:17-sat:17:47\",\n          \"DBInstanceStatus\": \"creating\",\n          \"EngineVersion\": \"9.5.4\",\n          \"DomainMemberships\": [],\n          \"StorageType\": \"standard\",\n          \"DbiResourceId\": \"db-XXXXXXXXXXXXXXXXXXXXXXXXXX\",\n          \"CACertificateIdentifier\": \"rds-ca-2015\",\n          \"StorageEncrypted\": false,\n          \"DBInstanceClass\": \"db.t2.micro\",\n          \"DbInstancePort\": 0,\n          \"DBInstanceIdentifier\": \"postgre-handson-20161114\"\n        }\n      }\n```\n\n\nDB\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u72b6\u614b\u78ba\u8a8d\n------------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nRDS_INSTANCE_STATUS=$( \\\n        aws rds describe-db-instances \\\n          --db-instance-identifier ${RDS_INSTANCE_IDENT} \\\n          --query 'DBInstances[].DBInstanceStatus' \\\n          --output text \\\n) \\\n          && echo ${RDS_INSTANCE_STATUS}\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      creating\n```\n\navailable\u306b\u306a\u308c\u3070\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u5229\u7528\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n\u6ce8\u91c8: t2\u3067\u3082\u8d77\u52d5\u306b7\u5206\u304f\u3089\u3044\u304b\u304b\u308b\u3088\u3046\u3067\u3059\u3002\n\n\n3. \u4e8b\u5f8c\u78ba\u8a8d\n===========\n\n\n3.1. \u30a4\u30d9\u30f3\u30c8\u306e\u78ba\u8a8d\n-------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nRDS_EVENT_TYPE='db-instance'\nRDS_EVENT_START=${DATETIME_UTC}\nRDS_MAX_ITEMS='3'\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws rds describe-events \\\n        --start-time ${RDS_EVENT_START} \\\n        --source-type ${RDS_EVENT_TYPE} \\\n        --max-items ${RDS_MAX_ITEMS}\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      {\n        \"Events\": [\n          {\n              \"EventCategories\": [\n                  \"creation\"\n              ],\n              \"SourceType\": \"db-instance\",\n              \"SourceArn\": \"arn:aws:rds:ap-northeast-1:XXXXXXXXXXXX:db:postgre-handson-20161114\",\n              \"Date\": \"2016-11-13T05:28:38.782Z\",\n              \"Message\": \"DB instance created\",\n              \"SourceIdentifier\": \"postgre-handson-20161114\"\n          },\n          {\n              \"EventCategories\": [\n                  \"backup\"\n              ],\n              \"SourceType\": \"db-instance\",\n              \"SourceArn\": \"arn:aws:rds:ap-northeast-1:XXXXXXXXXXXX:db:postgre-handson-20161114\",\n              \"Date\": \"2016-11-13T05:29:47.617Z\",\n              \"Message\": \"Backing up DB instance\",\n              \"SourceIdentifier\": \"postgre-handson-20161114\"\n          },\n          {\n              \"EventCategories\": [\n                  \"backup\"\n              ],\n              \"SourceType\": \"db-instance\",\n              \"SourceArn\": \"arn:aws:rds:ap-northeast-1:XXXXXXXXXXXX:db:postgre-handson-20161114\",\n              \"Date\": \"2016-11-13T05:32:17.561Z\",\n              \"Message\": \"Finished DB Instance backup\",\n              \"SourceIdentifier\": \"postgre-handson-20161114\"\n          }\n        ]\n      }\n```\n\n\n3.2. DB\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u60c5\u5831\u306e\u78ba\u8a8d\n-----------------------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws rds describe-db-instances \\\n        --db-instance-identifier ${RDS_INSTANCE_IDENT}\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      {\n        \"DBInstances\": [\n          {\n              \"PubliclyAccessible\": true,\n              \"MasterUsername\": \"pgadmin\",\n              \"MonitoringInterval\": 0,\n              \"LicenseModel\": \"postgresql-license\",\n              \"VpcSecurityGroups\": [\n                  {\n                      \"Status\": \"active\",\n                      \"VpcSecurityGroupId\": \"sg-xxxxxxxx\"\n                  }\n              ],\n              \"InstanceCreateTime\": \"2016-11-13T05:28:38.651Z\",\n              \"CopyTagsToSnapshot\": false,\n              \"OptionGroupMemberships\": [\n                  {\n                      \"Status\": \"in-sync\",\n                      \"OptionGroupName\": \"default:postgres-9-5\"\n                  }\n              ],\n              \"PendingModifiedValues\": {},\n              \"Engine\": \"postgres\",\n              \"MultiAZ\": false,\n              \"LatestRestorableTime\": \"2016-11-13T05:29:47.646Z\",\n              \"DBSecurityGroups\": [],\n              \"DBParameterGroups\": [\n                  {\n                      \"DBParameterGroupName\": \"default.postgres9.5\",\n                      \"ParameterApplyStatus\": \"in-sync\"\n                  }\n              ],\n              \"AutoMinorVersionUpgrade\": true,\n              \"PreferredBackupWindow\": \"14:30-15:00\",\n              \"DBSubnetGroup\": {\n                  \"Subnets\": [\n                      {\n                          \"SubnetStatus\": \"Active\",\n                          \"SubnetIdentifier\": \"subnet-xxxxxxxx\",\n                          \"SubnetAvailabilityZone\": {\n                              \"Name\": \"ap-northeast-1a\"\n                          }\n                      },\n                      {\n                          \"SubnetStatus\": \"Active\",\n                          \"SubnetIdentifier\": \"subnet-xxxxxxxx\",\n                          \"SubnetAvailabilityZone\": {\n                              \"Name\": \"ap-northeast-1c\"\n                          }\n                      }\n                  ],\n                  \"DBSubnetGroupName\": \"default\",\n                  \"VpcId\": \"vpc-xxxxxxxx\",\n                  \"DBSubnetGroupDescription\": \"default\",\n                  \"SubnetGroupStatus\": \"Complete\"\n              },\n              \"ReadReplicaDBInstanceIdentifiers\": [],\n              \"AllocatedStorage\": 5,\n              \"DBInstanceArn\": \"arn:aws:rds:ap-northeast-1:XXXXXXXXXXXX:db:postgre-handson-20161114\",\n              \"BackupRetentionPeriod\": 1,\n              \"DBName\": \"handson20161114\",\n              \"PreferredMaintenanceWindow\": \"sat:17:17-sat:17:47\",\n              \"Endpoint\": {\n                  \"HostedZoneId\": \"Z24O6O9L7SGTNB\",\n                  \"Port\": 5432,\n                  \"Address\": \"postgre-handson-20161114.xxxxxxxxxxxx.ap-northeast-1.rds.amazonaws.com\"\n              },\n              \"DBInstanceStatus\": \"available\",\n              \"EngineVersion\": \"9.5.4\",\n              \"AvailabilityZone\": \"ap-northeast-1a\",\n              \"DomainMemberships\": [],\n              \"StorageType\": \"standard\",\n              \"DbiResourceId\": \"db-XXXXXXXXXXXXXXXXXXXXXXXXXX\",\n              \"CACertificateIdentifier\": \"rds-ca-2015\",\n              \"StorageEncrypted\": false,\n              \"DBInstanceClass\": \"db.t2.micro\",\n              \"DbInstancePort\": 0,\n              \"DBInstanceIdentifier\": \"postgre-handson-20161114\"\n          }\n        ]\n      }\n```\n\n\n3.3. \u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u306e\u78ba\u8a8d\n-------------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nRDS_INSTANCE_ENDPOINT=$( \\\n        aws rds describe-db-instances \\\n          --db-instance-identifier ${RDS_INSTANCE_IDENT} \\\n          --query 'DBInstances[].Endpoint.Address' \\\n          --output text \\\n) \\\n        && echo ${RDS_INSTANCE_ENDPOINT}\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      postgre-handson-ap-northeast-1.xxxxxxxxxxxx.ap-northeast-1.rds.amazonaws.com\n```\n\n\n3.4. \u63a5\u7d9a\u60c5\u5831\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n-------------------------------\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d:\ncat << ETX\n\n        RDS_INSTANCE_ENDPOINT: ${RDS_INSTANCE_ENDPOINT}\n        VPC_SG_PORT:           ${VPC_SG_PORT}\n        RDS_DB_NAME:           ${RDS_DB_NAME}\n        RDS_USER_NAME:         ${RDS_USER_NAME}\n        RDS_USER_PASS:         ${RDS_USER_PASS}\n\nETX\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\necho \"${RDS_INSTANCE_ENDPOINT}:${VPC_SG_PORT}:${RDS_DB_NAME}:${RDS_USER_NAME}:${RDS_USER_PASS}\" >> ${HOME}/.pgpass \\\n        && chmod 600 ${HOME}/.pgpass \\\n        && cat ${HOME}/.pgpass\n```\n\n\n3.4. \u63a5\u7d9a\n---------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\npsql \\\n        --host=${RDS_INSTANCE_ENDPOINT} \\\n        --username=${RDS_USER_NAME} \\\n        --dbname=${RDS_DB_NAME}\n```\n\n```text:\u7d50\u679c:\n      psql (9.5.5, server 9.5.4)\n      SSL connection (protocol: TLSv1.2, cipher: ECDHE-RSA-AES256-GCM-SHA384, bits: 256, compression: off)\n      Type \"help\" for help.\n\n      handson20161114=>\n```\n\nDB\u30b3\u30de\u30f3\u30c9\u306e\u30c6\u30b9\u30c8\u5b9f\u884c\u3092\u3057\u3066\u307f\u307e\u3059\u3002\n\n```sql:SQL:\nselect version();\n```\n\n```text:\u7d50\u679c(\u4f8b):\n                                                       version\n      ----------------------------------------------------------------------------------------------------------\n        PostgreSQL 9.5.4 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.8.2 20140120 (Red Hat 4.8.2-16), 64-bit\n       (1 row)\n```\n\nDB\u3078\u306e\u63a5\u7d9a\u3092\u5207\u65ad\u3057\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9:\n\\q\n```\n\n\n3.5. \u4e88\u5b9a\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u30a2\u30af\u30b7\u30e7\u30f3\u306e\u78ba\u8a8d\n-------------------------------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws rds describe-pending-maintenance-actions \\\n        --filter Name=db-instance-id,Values=${RDS_INSTANCE_IDENT}\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      {\n          \"PendingMaintenanceActions\": []\n      }\n```\n\n\n3.6. DBMS\u306e\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u78ba\u8a8d\n---------------------------\n\n\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u306e\u4e00\u89a7\u3092\u8868\u793a\u3057\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws rds describe-db-log-files \\\n        --db-instance-identifier ${RDS_INSTANCE_IDENT}\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      {\n        \"DescribeDBLogFiles\": [\n          {\n              \"LastWritten\": 1479014886000,\n              \"LogFileName\": \"error/postgres.log\",\n              \"Size\": 307\n          },\n          {\n              \"LastWritten\": 1479015287000,\n              \"LogFileName\": \"error/postgresql.log.2016-11-13-05\",\n              \"Size\": 1729\n          }\n        ]\n      }\n```\n\n\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u307e\u3059\u3002\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nRDS_LOG_NAME=<\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308bLogFileName>\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws rds download-db-log-file-portion \\\n        --db-instance-identifier ${RDS_INSTANCE_IDENT} \\\n        --log-file-name ${RDS_LOG_NAME} \\\n        --query 'LogFileData' \\\n        --output text\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      2016-11-13 05:28:06 UTC::@:[3317]:LOG:  MultiXact member wraparound protections are now enabled\n      2016-11-13 05:28:06 UTC::@:[3315]:LOG:  database system is ready to accept connections\n      2016-11-13 05:28:06 UTC::@:[3321]:LOG:  autovacuum launcher started\n      2016-11-13 05:28:09 UTC::@:[3318]:LOG:  checkpoint starting: immediate force wait flush-all\n      2016-11-13 05:28:09 UTC::@:[3318]:LOG:  checkpoint complete: wrote 21 buffers (0.1%); 0 transaction log file(s) added, 0 removed, 0 recycled; write=0.001 s, sync=0.008 s, total=0.031 s; sync files=19, longest=0.008 s, average=0.000 s; distance=17 kB, estimate=17 kB\n      2016-11-13 05:28:10 UTC::@:[3318]:LOG:  checkpoint starting: immediate force wait\n      2016-11-13 05:28:10 UTC::@:[3318]:LOG:  checkpoint complete: wrote 0 buffers (0.0%); 0 transaction log file(s) added, 0 removed, 0 recycled; write=0.000 s, sync=0.000 s, total=0.084 s; sync files=0, longest=0.000 s, average=0.000 s; distance=0 kB, estimate=15 kB\n      2016-11-13 05:29:47 UTC::@:[3318]:LOG:  checkpoint starting: force wait\n      2016-11-13 05:29:51 UTC::@:[3318]:LOG:  checkpoint complete: wrote 38 buffers (0.1%); 0 transaction log file(s) added, 0 removed, 0 recycled; write=3.736 s, sync=0.058 s, total=4.092 s; sync files=33, longest=0.058 s, average=0.001 s; distance=5516 kB, estimate=5516 kB\n      2016-11-13 05:34:47 UTC::@:[3318]:LOG:  checkpoint starting: time\n      2016-11-13 05:34:47 UTC::@:[3318]:LOG:  checkpoint complete: wrote 1 buffers (0.0%); 0 transaction log file(s) added, 0 removed, 0 recycled; write=0.000 s, sync=0.003 s, total=0.017 s; sync files=1, longest=0.003 s, average=0.003 s; distance=16384 kB, estimate=16384 kB\n      2016-11-13 05:39:47 UTC::@:[3318]:LOG:  checkpoint starting: time\n      2016-11-13 05:39:47 UTC::@:[3318]:LOG:  checkpoint complete: wrote 1 buffers (0.0%); 0 transaction log file(s) added, 0 removed, 0 recycled; write=0.000 s, sync=0.002 s, total=0.016 s; sync files=1, longest=0.002 s, average=0.002 s; distance=16384 kB, estimate=16384 kB\n```\n\n\n\u5b8c\u4e86\n====\n"}