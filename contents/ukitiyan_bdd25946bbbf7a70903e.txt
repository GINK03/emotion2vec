{"context": "\n\n\u306f\u3058\u3081\u306b\n\n\nServerless Advent Calendar 2016\u306e22\u65e5\u76ee\u3067\u3059\u3002\n\u30b5\u30fc\u30d0\u30ec\u30b9\u30cd\u30bf\u3068\u3057\u3066\u306f\u3001\u4ee5\u524d \u5728\u5e2d\u7ba1\u7406\u3092Slack\u3068AWS\u306e\u30b5\u30fc\u30d0\u30ec\u30b9\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u3067\u89e3\u6c7a\u3057\u3066\u307f\u305f\uff08iruca API\u7de8\uff09 \u3066\u306a\u8a18\u4e8b\u3082\u66f8\u3044\u3066\u308b\u306e\u3067\u3001\u305d\u3061\u3089\u3082\u826f\u304b\u3063\u305f\u3089\u30c1\u30a7\u30c3\u30af\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u672c\u8a18\u4e8b\u3067\u306f\u3001\u30b5\u30fc\u30d0\u30ec\u30b9\u3067\u3001\u4f55\u3068\u304b\u5148\u8f29\u306e\u624b\u3092\u7169\u308f\u305b\u306a\u3044\u305f\u3081\u306b\u3069\u3046\u3057\u305f\u3082\u306e\u304b\u3068\u8003\u3048\u3066\u305f\u5185\u5bb9\u3092\u66f8\u304d\u307e\u3059\u3002\n\u6765\u5e74\u3082\u81ea\u5206\u306e\u305f\u3081\u3060\u3051\u3058\u3083\u306a\u304f\u3066\u3001\u4eba\u306e\u305f\u3081\u306b\u3082\u30b5\u30fc\u30d0\u30ec\u30b9\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u3092\u8003\u3048\u3066\u751f\u304d\u3066\u3044\u304d\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n\n\u8981\u4ef6\n\n\u4e16\u754c\u5c55\u958b\u3092\u884c\u3046EC\u30b7\u30b9\u30c6\u30e0\u3067\u3001\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30ec\u30a4\u30c6\u30f3\u30b7\u30fc\u3092\u89e3\u6d88\u3059\u308b\u305f\u3081\u306b\u3001AWS\u306e\u5404\u30ea\u30fc\u30b8\u30e7\u30f3\u306b\u30d5\u30ed\u30f3\u30c8\u30a8\u30f3\u30c9\u6a5f\u80fd\u3092\u8a2d\u7f6e\u3059\u308b\u3002\n\u4f46\u3057\u3001\u500b\u4eba\u60c5\u5831\u306f\u65e2\u5b58\u306eDC\u306b\u4fdd\u7ba1\u3059\u308b\u3082\u306e\u3068\u3057\u3066\u3001EC\u3067\u767a\u751f\u3057\u305f\u30aa\u30fc\u30c0\u30fc\u30c7\u30fc\u30bf\u7b49\u306e\u500b\u4eba\u60c5\u5831\u306b\u3064\u3044\u3066\u3082\u4e00\u5b9a\u671f\u9593\u4ee5\u4e0a AWS\u306eDB\u306b\u4fdd\u6301\u3057\u3066\u306f\u306a\u3089\u306a\u3044\u3002\n\u5c1a\u3001\u4eca\u56de\u5229\u7528\u3059\u308bEC\u30d1\u30c3\u30b1\u30fc\u30b8\u306f\u3001\u30aa\u30fc\u30c0\u30fc\u304c\u5165\u308b\u3068\u540c\u4e00\u30ea\u30fc\u30b8\u30e7\u30f3\u306e\u30aa\u30fc\u30c0\u30fc\u30c6\u30fc\u30d6\u30eb\u306b\u30c7\u30fc\u30bf\u304c\u767b\u9332\u3055\u308c\u308b\u3002\n\n\n\u30bd\u30ea\u30e5\u30fc\u30b7\u30e7\u30f3\n\nEC\u306f\u3001\u30d1\u30c3\u30b1\u30fc\u30b8\u5229\u7528\u60f3\u5b9a\u306a\u306e\u3067\u3001\u306a\u308b\u3079\u304f\u30a4\u30b8\u3089\u306a\u3044\u306e\u304c\u30bb\u30aa\u30ea\u30fc\u3002\n\u3067\u3001\u30aa\u30fc\u30c0\u30fc\u30c6\u30fc\u30d6\u30eb\u306b\u767b\u9332\u3055\u308c\u305f\u30ec\u30b3\u30fc\u30c9\u3092\u666e\u901a\u306b\u79fb\u52d5\u3055\u305b\u308c\u3070\u826f\u3044\u306e\u3067\u3001\u4ee5\u4e0b\u306e\u69cb\u6210\u306f\u666e\u901a\u306b\u601d\u3044\u3064\u304f\u308f\u3051\u3067\u3059\u3002\n\n\n\n\u4e0a\u8a18\u3060\u3068\u3001\u3044\u304b\u3093\u305b\u3093\u30b5\u30fc\u30d0\u30ec\u30b9\u3058\u3083\u306a\u3044\u306e\u3067\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u69cb\u6210\u304c\u767a\u6848\u3055\u308c\u307e\u3059\u3002\n\n\n\n\u3057\u304b\u3057\u306a\u304c\u3089\u3001\u4e0a\u8a18\u3060\u3068\u8d64\u4e38\u90e8\u5206\u3067\u30aa\u30fc\u30c0\u30fc\u3068\u540c\u6642\u306bSQS\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u6295\u3052\u308b\u3068\u3044\u3046EC\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u6539\u4fee\u304c\u5fc5\u8981\u3068\u306a\u308b\u306e\u3067\u30b2\u30f3\u30ca\u30ea\u3057\u307e\u3059\u3002\uff08\u3053\u308c\u3092\u901a\u3059\u3068\u5148\u8f29\u306e\u624b\u3092\u7169\u308f\u305b\u308b\u3053\u3068\u306b...\uff09\n\u7d50\u5408\u5ea6\u3082\u9ad8\u3044\u306e\u3067\u3001\u758e\u7d50\u5408\u306a\u30b5\u30fc\u30d0\u30ec\u30b9\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u3068\u3057\u3066\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u69cb\u6210\u304c\u767a\u6848\u3055\u308c\u307e\u3059\u3002\n\u56e0\u307f\u306bRDS\u306e\u30a8\u30f3\u30b8\u30f3\u306f\u3001\u826f\u3044\u3053\u3068\u3057\u304b\u306a\u3044\u306e\u3067Aurora\u306b\u3057\u307e\u3057\u3087\u3046\u3002\n\n\n\n\u30c6\u30fc\u30d6\u30eb\u3078\u306eInsert\u901a\u77e5\u3092Serverless\u3067\u51e6\u7406\u3059\u308b\n\n\u4e0a\u8a18\u3092\u8e0f\u307e\u3048\u3066\u30c6\u30fc\u30d6\u30eb\u3078\u306eInsert\u901a\u77e5\u3092Serverless\u3067\u51e6\u7406\u3059\u308b\u65b9\u6cd5\u3092\u7d39\u4ecb\u3057\u307e\u3059\u3002\n\u5177\u4f53\u7684\u306b\u306f\u3001\u30aa\u30fc\u30c0\u30fc\u30c6\u30fc\u30d6\u30eb\u3078\u306eAfter Insert\u306bTrigger\u4ed5\u8fbc\u3093\u3067\u3001Lambda\u7d4c\u7531\u3067SQS\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u767b\u9332\u3059\u308b\u65b9\u6cd5\u306b\u306a\u308a\u307e\u3059\u3002\nSQS\u306b\u4f1d\u308f\u308c\u3070\u305d\u306e\u5148\u306f\u5e7e\u3089\u3067\u3082\u3084\u308a\u3088\u3046\u304c\u3042\u308b\u3068\u601d\u3044\u307e\u3059\u3002\nTrigger\u306f\u3001\u8907\u96d1\u904e\u304e\u308b\u3068\u826f\u3044\u3053\u3068\u306a\u3044\u306e\u3067\u3001\u30b7\u30f3\u30d7\u30eb\u306b\u4f7f\u3044\u307e\u3057\u3087\u3046\u3002\n\n\n\nIAM Role\u3092\u4f5c\u6210\u3059\u308b\n\nLambda\u7528Role\n\n\n\n\n\u9805\u76ee\n\u8a2d\u5b9a\u5185\u5bb9\n\n\n\n\n\u30ed\u30fc\u30eb\u540d\n\uff08\u4efb\u610f\uff1a[\u4f8b] LambdaDbTriggerTestRole\uff09\n\n\nAWS \u30b5\u30fc\u30d3\u30b9\u30ed\u30fc\u30eb\nAWS Lambda\n\n\n\u30a2\u30bf\u30c3\u30c1\u3059\u308b\u30dd\u30ea\u30b7\u30fc\nAmazonSQSFullAccess\n\n\n\n\nRDS\u7528Role\n\n\n\n\n\u9805\u76ee\n\u8a2d\u5b9a\u5185\u5bb9\n\n\n\n\n\u30ed\u30fc\u30eb\u540d\n\uff08\u4efb\u610f\uff1a[\u4f8b] RdsDbTriggerTestRole\uff09\n\n\nAWS \u30b5\u30fc\u30d3\u30b9\u30ed\u30fc\u30eb\nAWS RDS\n\n\n\u30a2\u30bf\u30c3\u30c1\u3059\u308b\u30dd\u30ea\u30b7\u30fc\n\u7121\u3057\n\n\n\u203b\u8d85\u91cd\u8981\u203b\n\u4f5c\u6210\u5f8c\u3001\u30a2\u30af\u30bb\u30b9\u8a31\u53ef\u30bf\u30d6\u3067AWSLamdbaRole\u3092\u30a2\u30bf\u30c3\u30c1\n\n\n\n\nSQS\u3067Queue\u3092\u4f5c\u6210\u3059\u308b\n\n\u4efb\u610f\u306e\u30ad\u30e5\u30fc\u540d\u3067\u30ad\u30e5\u30fc\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\u4f8b\uff09DbTriggerTestQueue\n\n\nLambda\u3067Function\u3092\u4f5c\u6210\u3059\u308b\n\nRDS\u304b\u3089\u30ad\u30c3\u30af\u3055\u308c\u3001SQS\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u9001\u4fe1\u3059\u308bLambda\u30d5\u30a1\u30f3\u30af\u30b7\u30e7\u30f3\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n\n\n\n\u9805\u76ee\n\u8a2d\u5b9a\u5185\u5bb9\n\n\n\n\nRuntime\nPython 2.7\n\n\nHandler\nlambda_function.lambda_handler\n\n\nRole\n\u5148\u7a0b\u4f5c\u6210\u3057\u305fLambda\u7528Role\n\n\n\n\n\u30b3\u30fc\u30c9\u306f\u4ee5\u4e0b\u306e\u5185\u5bb9\u3067\u3059\u3002\uff08queueName\u306f\u3001\u5148\u7a0b\u4f5c\u6210\u3057\u305fqueueName\u3092\u6307\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\uff09\n\n\nmain.py\nimport boto3\nimport json\nimport logging\n\nqueueName='DbTriggerTestQueue'\n\ndef lambda_handler(event, context):\n  try:\n    logger.info(event)\n    response = boto3.resource('sqs').get_queue_by_name(\n      QueueName = queueName\n    ).send_message(\n      MessageBody = json.dumps(event)\n    )\n    logger.info(response)\n    return response\n\n  except Exception as e:\n    logger.error(e)\n    raise e\n\n\n\nAurora\u3092\u8d77\u52d5\u3059\u308b\n\n\u4ee5\u4e0b\u306e\u5185\u5bb9\u3067\u8d77\u52d5\u3057\u307e\u3057\u305f\u3002\n\n\n\n\n\u9805\u76ee\n\u8a2d\u5b9a\u5185\u5bb9\n\n\n\n\n\u30ea\u30fc\u30b8\u30e7\u30f3\nap-northeast-1\n\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30af\u30e9\u30b9\ndb.t2.medium\n\n\n\u30de\u30eb\u30c1AZ\nNo\n\n\n\u30b5\u30d6\u30cd\u30c3\u30c8\u30b0\u30eb\u30fc\u30d7\nDefault\n\n\n\u30d1\u30d6\u30ea\u30c3\u30af\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\nNo\n\n\nAvailability Zone\nap-northeast-1a\n\n\n\u30d1\u30e9\u30e1\u30fc\u30bf\u30b0\u30eb\u30fc\u30d7\n\u65b0\u898f\u306eDB Parameter Group\u65b0\u898f\u306eDB Cluster Parameter Group\n\n\n\n\nAurora\u306bIAM\u30ed\u30fc\u30eb\u3092\u8a2d\u5b9a\u3059\u308b\n\n\u30af\u30e9\u30b9\u30bf\u30fc\u306eIAM\u30ed\u30fc\u30eb\u306e\u7ba1\u7406\u304b\u3089\u5148\u7a0b\u4f5c\u6210\u3057\u305fRDS\u7528Role\u3092\u7d10\u4ed8\u3051\u307e\u3059\u3002\n\n\n\n\u5148\u7a0b\u4f5c\u6210\uff06Aurora\u306b\u6307\u5b9a\u3057\u305fDB Cluster Parameter Group\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u7de8\u96c6\u304b\u3089\u3001aws_default_lambda_role\u306e\u5024\u306b\u3001\u5148\u7a0b\u4f5c\u6210\u3057\u305fRDS\u7528Role\u306eARN\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\u4f8b\uff09arn:aws:iam::xxxxxxxxxx:role/RdsDbTriggerTestRole\n\n\n\nDB\u30af\u30e9\u30b9\u30bf\u30d1\u30e9\u30e1\u30fc\u30bf\u30b0\u30eb\u30fc\u30d7\u304cpending-reboot\u306b\u306a\u308b\u306f\u305a\u306a\u306e\u3067\u3001Aurora\u3092\u518d\u8d77\u52d5\u3057\u307e\u3059\u3002\n\n\nTrigger\u3092\u4f5c\u6210\u3059\u308b\n\n\u518d\u8d77\u52d5\u3057\u305f\u3089Aurora\u306b\u63a5\u7d9a\u3057\u3066\u3001\u4ee5\u4e0b\u306eStored Procedure\u3001Table\u3001Trigger\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n\nStored Procedure\n\n\nmysql.lambda_async\u306e\u7b2c\u4e00\u5f15\u6570\u306f\u3001\u5148\u7a0b\u4f5c\u6210\u3057\u305fLambda\u306eARN\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n\n\n\nsqs_order_data_ai_message.sql\nDROP PROCEDURE IF EXISTS sqs_order_data_ai_message;\nDELIMITER ;;\nCREATE PROCEDURE sqs_order_data_ai_message (IN id INT(11), \n                                      IN item VARCHAR(50)) LANGUAGE SQL \nBEGIN\n  CALL mysql.lambda_async('arn:aws:lambda:ap-northeast-1:xxxxxxxx:function:TestFunction',  \n    CONCAT('{ \"id\" : \"', id, \n            '\", \"item\" : \"', item, '\" }')\n     );\nEND\n;;\nDELIMITER ;\n\n\n\nTable\n\n\norder_data.sql\nCREATE TABLE `order_data` (\n  `id` int(11) NOT NULL AUTO_INCREMENT,\n  `item` varchar(50) NOT NULL,\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n\n\n\nTrigger\n\n\ntrigger_order_data_ai.sql\nDELIMITER ;;\nCREATE TRIGGER trigger_order_data_ai \n  AFTER INSERT ON order_data \n  FOR EACH ROW\nBEGIN\n  CALL sqs_order_data_ai_message(NEW.id, NEW.item);\nEND\n;;\nDELIMITER ;\n\n\n\n\u52d5\u4f5c\u30c6\u30b9\u30c8\n\n\u4ee5\u4e0b\u306eSQL\u3092\u5b9f\u884c\u3057\u3066\u307f\u307e\u3059\u3002\n\n\ninsert.sql\nINSERT INTO order_data VALUES (NULL, 'item_001');\n\n\n\n\u53d6\u308a\u6025\u304e\u3001SQS\u306e\u753b\u9762\u3067\u5229\u7528\u53ef\u80fd\u306a\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u30ab\u30a6\u30f3\u30c8\u30a2\u30c3\u30d7\u3055\u308c\u3066\u3044\u308c\u3070\u6210\u529f\u3067\u3059\u3002\n\n\n\n\u5099\u8003\n\n\u30a8\u30f3\u30b8\u30f3\u306fAurora\u4e00\u629e\u3067\u3059\u3002MySQL\u3092\u9078\u3093\u3060\u3068\u3053\u308d\u3067\u4ee5\u4e0b\u306e\u3088\u3046\u306bmysql.lambda_async\u304c\u30b3\u30fc\u30eb\u51fa\u6765\u306a\u3044\u3067\u3059\u3002\n\n\nMySQL\nmysql> show create procedure mysql.lambda_async \\G\nERROR 1305 (42000): PROCEDURE lambda_async does not exist\n\n\n\n\u53c2\u8003\n\nhttp://dev.classmethod.jp/cloud/aws/invoke-lambda-from-aurora/\nhttp://qiita.com/eci/items/3eddcd815cd0af121202\nhttp://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Aurora.Lambda.html\n\n\n\n# \u306f\u3058\u3081\u306b\n* [Serverless Advent Calendar 2016](http://qiita.com/advent-calendar/2016/serverless)\u306e22\u65e5\u76ee\u3067\u3059\u3002\n* \u30b5\u30fc\u30d0\u30ec\u30b9\u30cd\u30bf\u3068\u3057\u3066\u306f\u3001\u4ee5\u524d [\u5728\u5e2d\u7ba1\u7406\u3092Slack\u3068AWS\u306e\u30b5\u30fc\u30d0\u30ec\u30b9\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u3067\u89e3\u6c7a\u3057\u3066\u307f\u305f\uff08iruca API\u7de8\uff09](http://qiita.com/ukitiyan/items/fdc83bfd99e4440c6f30) \u3066\u306a\u8a18\u4e8b\u3082\u66f8\u3044\u3066\u308b\u306e\u3067\u3001\u305d\u3061\u3089\u3082\u826f\u304b\u3063\u305f\u3089\u30c1\u30a7\u30c3\u30af\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n* \u672c\u8a18\u4e8b\u3067\u306f\u3001\u30b5\u30fc\u30d0\u30ec\u30b9\u3067\u3001\u4f55\u3068\u304b\u5148\u8f29\u306e\u624b\u3092\u7169\u308f\u305b\u306a\u3044\u305f\u3081\u306b\u3069\u3046\u3057\u305f\u3082\u306e\u304b\u3068\u8003\u3048\u3066\u305f\u5185\u5bb9\u3092\u66f8\u304d\u307e\u3059\u3002\n* \u6765\u5e74\u3082\u81ea\u5206\u306e\u305f\u3081\u3060\u3051\u3058\u3083\u306a\u304f\u3066\u3001\u4eba\u306e\u305f\u3081\u306b\u3082\u30b5\u30fc\u30d0\u30ec\u30b9\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u3092\u8003\u3048\u3066\u751f\u304d\u3066\u3044\u304d\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n# \u8981\u4ef6\n* \u4e16\u754c\u5c55\u958b\u3092\u884c\u3046EC\u30b7\u30b9\u30c6\u30e0\u3067\u3001\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30ec\u30a4\u30c6\u30f3\u30b7\u30fc\u3092\u89e3\u6d88\u3059\u308b\u305f\u3081\u306b\u3001AWS\u306e\u5404\u30ea\u30fc\u30b8\u30e7\u30f3\u306b\u30d5\u30ed\u30f3\u30c8\u30a8\u30f3\u30c9\u6a5f\u80fd\u3092\u8a2d\u7f6e\u3059\u308b\u3002\n* \u4f46\u3057\u3001\u500b\u4eba\u60c5\u5831\u306f\u65e2\u5b58\u306eDC\u306b\u4fdd\u7ba1\u3059\u308b\u3082\u306e\u3068\u3057\u3066\u3001EC\u3067\u767a\u751f\u3057\u305f\u30aa\u30fc\u30c0\u30fc\u30c7\u30fc\u30bf\u7b49\u306e\u500b\u4eba\u60c5\u5831\u306b\u3064\u3044\u3066\u3082\u4e00\u5b9a\u671f\u9593\u4ee5\u4e0a AWS\u306eDB\u306b\u4fdd\u6301\u3057\u3066\u306f\u306a\u3089\u306a\u3044\u3002\n* \u5c1a\u3001\u4eca\u56de\u5229\u7528\u3059\u308bEC\u30d1\u30c3\u30b1\u30fc\u30b8\u306f\u3001\u30aa\u30fc\u30c0\u30fc\u304c\u5165\u308b\u3068\u540c\u4e00\u30ea\u30fc\u30b8\u30e7\u30f3\u306e\u30aa\u30fc\u30c0\u30fc\u30c6\u30fc\u30d6\u30eb\u306b\u30c7\u30fc\u30bf\u304c\u767b\u9332\u3055\u308c\u308b\u3002\n\n# \u30bd\u30ea\u30e5\u30fc\u30b7\u30e7\u30f3\n* EC\u306f\u3001\u30d1\u30c3\u30b1\u30fc\u30b8\u5229\u7528\u60f3\u5b9a\u306a\u306e\u3067\u3001\u306a\u308b\u3079\u304f\u30a4\u30b8\u3089\u306a\u3044\u306e\u304c\u30bb\u30aa\u30ea\u30fc\u3002\n* \u3067\u3001\u30aa\u30fc\u30c0\u30fc\u30c6\u30fc\u30d6\u30eb\u306b\u767b\u9332\u3055\u308c\u305f\u30ec\u30b3\u30fc\u30c9\u3092\u666e\u901a\u306b\u79fb\u52d5\u3055\u305b\u308c\u3070\u826f\u3044\u306e\u3067\u3001\u4ee5\u4e0b\u306e\u69cb\u6210\u306f\u666e\u901a\u306b\u601d\u3044\u3064\u304f\u308f\u3051\u3067\u3059\u3002\n\n![ec architecture1](https://qiita-image-store.s3.amazonaws.com/0/39596/a4975df1-f4ff-fbe2-02d3-5b15f682ae30.png \"skitch.2.png\")\n\n* \u4e0a\u8a18\u3060\u3068\u3001\u3044\u304b\u3093\u305b\u3093\u30b5\u30fc\u30d0\u30ec\u30b9\u3058\u3083\u306a\u3044\u306e\u3067\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u69cb\u6210\u304c\u767a\u6848\u3055\u308c\u307e\u3059\u3002\n\n![ec architecture2](https://qiita-image-store.s3.amazonaws.com/0/39596/b3515890-ddbf-02e4-ad2c-598b48c2e2b9.png \"skitch.png\")\n\n* \u3057\u304b\u3057\u306a\u304c\u3089\u3001\u4e0a\u8a18\u3060\u3068\u8d64\u4e38\u90e8\u5206\u3067\u30aa\u30fc\u30c0\u30fc\u3068\u540c\u6642\u306bSQS\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u6295\u3052\u308b\u3068\u3044\u3046EC\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u6539\u4fee\u304c\u5fc5\u8981\u3068\u306a\u308b\u306e\u3067\u30b2\u30f3\u30ca\u30ea\u3057\u307e\u3059\u3002\uff08\u3053\u308c\u3092\u901a\u3059\u3068\u5148\u8f29\u306e\u624b\u3092\u7169\u308f\u305b\u308b\u3053\u3068\u306b...\uff09\n* \u7d50\u5408\u5ea6\u3082\u9ad8\u3044\u306e\u3067\u3001\u758e\u7d50\u5408\u306a\u30b5\u30fc\u30d0\u30ec\u30b9\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u3068\u3057\u3066\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u69cb\u6210\u304c\u767a\u6848\u3055\u308c\u307e\u3059\u3002\n* \u56e0\u307f\u306bRDS\u306e\u30a8\u30f3\u30b8\u30f3\u306f\u3001\u826f\u3044\u3053\u3068\u3057\u304b\u306a\u3044\u306e\u3067Aurora\u306b\u3057\u307e\u3057\u3087\u3046\u3002\n\n![ec architecture3](https://qiita-image-store.s3.amazonaws.com/0/39596/9bb29d0e-ab5a-94fe-8c7c-950e2932c44e.png \"skitch.1.png\")\n\n# \u30c6\u30fc\u30d6\u30eb\u3078\u306eInsert\u901a\u77e5\u3092Serverless\u3067\u51e6\u7406\u3059\u308b\n\n* \u4e0a\u8a18\u3092\u8e0f\u307e\u3048\u3066\u30c6\u30fc\u30d6\u30eb\u3078\u306eInsert\u901a\u77e5\u3092Serverless\u3067\u51e6\u7406\u3059\u308b\u65b9\u6cd5\u3092\u7d39\u4ecb\u3057\u307e\u3059\u3002\n* \u5177\u4f53\u7684\u306b\u306f\u3001\u30aa\u30fc\u30c0\u30fc\u30c6\u30fc\u30d6\u30eb\u3078\u306eAfter Insert\u306bTrigger\u4ed5\u8fbc\u3093\u3067\u3001Lambda\u7d4c\u7531\u3067SQS\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u767b\u9332\u3059\u308b\u65b9\u6cd5\u306b\u306a\u308a\u307e\u3059\u3002\n* SQS\u306b\u4f1d\u308f\u308c\u3070\u305d\u306e\u5148\u306f\u5e7e\u3089\u3067\u3082\u3084\u308a\u3088\u3046\u304c\u3042\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n* Trigger\u306f\u3001\u8907\u96d1\u904e\u304e\u308b\u3068\u826f\u3044\u3053\u3068\u306a\u3044\u306e\u3067\u3001\u30b7\u30f3\u30d7\u30eb\u306b\u4f7f\u3044\u307e\u3057\u3087\u3046\u3002\n\n![ec architecture4](https://qiita-image-store.s3.amazonaws.com/0/39596/021e3f76-6d27-2649-e94e-d2ddd482a582.png \"skitch.3.png\")\n\n## IAM Role\u3092\u4f5c\u6210\u3059\u308b\n* Lambda\u7528Role\n\n| \u9805\u76ee | \u8a2d\u5b9a\u5185\u5bb9 |\n|:-----------|:------------|\n| \u30ed\u30fc\u30eb\u540d    | \uff08\u4efb\u610f\uff1a[\u4f8b] LambdaDbTriggerTestRole\uff09 | \n| AWS \u30b5\u30fc\u30d3\u30b9\u30ed\u30fc\u30eb    | AWS Lambda | \n| \u30a2\u30bf\u30c3\u30c1\u3059\u308b\u30dd\u30ea\u30b7\u30fc    | AmazonSQSFullAccess | \n\n* RDS\u7528Role\n\n| \u9805\u76ee | \u8a2d\u5b9a\u5185\u5bb9 |\n|:-----------|:------------|\n| \u30ed\u30fc\u30eb\u540d    | \uff08\u4efb\u610f\uff1a[\u4f8b] RdsDbTriggerTestRole\uff09 | \n| AWS \u30b5\u30fc\u30d3\u30b9\u30ed\u30fc\u30eb    | AWS RDS | \n| \u30a2\u30bf\u30c3\u30c1\u3059\u308b\u30dd\u30ea\u30b7\u30fc    | \u7121\u3057 | \n| \u203b\u8d85\u91cd\u8981\u203b    | \u4f5c\u6210\u5f8c\u3001\u30a2\u30af\u30bb\u30b9\u8a31\u53ef\u30bf\u30d6\u3067`AWSLamdbaRole`\u3092\u30a2\u30bf\u30c3\u30c1 | \n\n## SQS\u3067Queue\u3092\u4f5c\u6210\u3059\u308b\n* \u4efb\u610f\u306e\u30ad\u30e5\u30fc\u540d\u3067\u30ad\u30e5\u30fc\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n* \u4f8b\uff09DbTriggerTestQueue\n\n## Lambda\u3067Function\u3092\u4f5c\u6210\u3059\u308b\n* RDS\u304b\u3089\u30ad\u30c3\u30af\u3055\u308c\u3001SQS\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u9001\u4fe1\u3059\u308bLambda\u30d5\u30a1\u30f3\u30af\u30b7\u30e7\u30f3\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n| \u9805\u76ee | \u8a2d\u5b9a\u5185\u5bb9 |\n|:-----------|:------------|\n| Runtime    | Python 2.7 | \n| Handler| lambda_function.lambda_handler | \n| Role    | \u5148\u7a0b\u4f5c\u6210\u3057\u305fLambda\u7528Role | \n\n* \u30b3\u30fc\u30c9\u306f\u4ee5\u4e0b\u306e\u5185\u5bb9\u3067\u3059\u3002\uff08queueName\u306f\u3001\u5148\u7a0b\u4f5c\u6210\u3057\u305fqueueName\u3092\u6307\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\uff09\n\n```Python:main.py\nimport boto3\nimport json\nimport logging\n\nqueueName='DbTriggerTestQueue'\n\ndef lambda_handler(event, context):\n  try:\n    logger.info(event)\n    response = boto3.resource('sqs').get_queue_by_name(\n      QueueName = queueName\n    ).send_message(\n      MessageBody = json.dumps(event)\n    )\n    logger.info(response)\n    return response\n\n  except Exception as e:\n    logger.error(e)\n    raise e\n```\n\n\n## Aurora\u3092\u8d77\u52d5\u3059\u308b\n* \u4ee5\u4e0b\u306e\u5185\u5bb9\u3067\u8d77\u52d5\u3057\u307e\u3057\u305f\u3002\n\n| \u9805\u76ee | \u8a2d\u5b9a\u5185\u5bb9 |\n|:-----------|:------------|\n|\u30ea\u30fc\u30b8\u30e7\u30f3|ap-northeast-1|\n|\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30af\u30e9\u30b9|db.t2.medium|\n|\u30de\u30eb\u30c1AZ|No|\n|\u30b5\u30d6\u30cd\u30c3\u30c8\u30b0\u30eb\u30fc\u30d7|Default|\n|\u30d1\u30d6\u30ea\u30c3\u30af\u30a2\u30af\u30bb\u30b9\u53ef\u80fd|No|\n|Availability Zone|ap-northeast-1a|\n|\u30d1\u30e9\u30e1\u30fc\u30bf\u30b0\u30eb\u30fc\u30d7|\u65b0\u898f\u306eDB Parameter Group<br>\u65b0\u898f\u306eDB Cluster Parameter Group|\n\n## Aurora\u306bIAM\u30ed\u30fc\u30eb\u3092\u8a2d\u5b9a\u3059\u308b\n\n* \u30af\u30e9\u30b9\u30bf\u30fc\u306eIAM\u30ed\u30fc\u30eb\u306e\u7ba1\u7406\u304b\u3089\u5148\u7a0b\u4f5c\u6210\u3057\u305f`RDS\u7528Role`\u3092\u7d10\u4ed8\u3051\u307e\u3059\u3002\n\n![skitch.4.png](https://qiita-image-store.s3.amazonaws.com/0/39596/fcc3a1e9-eee1-e33a-bddd-ad1eb548973c.png \"skitch.4.png\")\n\n* \u5148\u7a0b\u4f5c\u6210\uff06Aurora\u306b\u6307\u5b9a\u3057\u305f`DB Cluster Parameter Group`\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u7de8\u96c6\u304b\u3089\u3001`aws_default_lambda_role`\u306e\u5024\u306b\u3001\u5148\u7a0b\u4f5c\u6210\u3057\u305f`RDS\u7528Role`\u306eARN\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n* \u4f8b\uff09arn:aws:iam::xxxxxxxxxx:role/RdsDbTriggerTestRole\n\n![skitch.6.png](https://qiita-image-store.s3.amazonaws.com/0/39596/1a9b396e-1f06-0245-5368-6f16bc65f976.png \"skitch.6.png\")\n\n* DB\u30af\u30e9\u30b9\u30bf\u30d1\u30e9\u30e1\u30fc\u30bf\u30b0\u30eb\u30fc\u30d7\u304c`pending-reboot`\u306b\u306a\u308b\u306f\u305a\u306a\u306e\u3067\u3001Aurora\u3092\u518d\u8d77\u52d5\u3057\u307e\u3059\u3002\n\n## Trigger\u3092\u4f5c\u6210\u3059\u308b\n* \u518d\u8d77\u52d5\u3057\u305f\u3089Aurora\u306b\u63a5\u7d9a\u3057\u3066\u3001\u4ee5\u4e0b\u306eStored Procedure\u3001Table\u3001Trigger\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n<br><br>\n* Stored Procedure\n\t* mysql.lambda_async\u306e\u7b2c\u4e00\u5f15\u6570\u306f\u3001\u5148\u7a0b\u4f5c\u6210\u3057\u305fLambda\u306eARN\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n```SQL:sqs_order_data_ai_message.sql\nDROP PROCEDURE IF EXISTS sqs_order_data_ai_message;\nDELIMITER ;;\nCREATE PROCEDURE sqs_order_data_ai_message (IN id INT(11), \n                                      IN item VARCHAR(50)) LANGUAGE SQL \nBEGIN\n  CALL mysql.lambda_async('arn:aws:lambda:ap-northeast-1:xxxxxxxx:function:TestFunction',  \n    CONCAT('{ \"id\" : \"', id, \n            '\", \"item\" : \"', item, '\" }')\n     );\nEND\n;;\nDELIMITER ;\n```\n\n* Table\n\n```SQL:order_data.sql\nCREATE TABLE `order_data` (\n  `id` int(11) NOT NULL AUTO_INCREMENT,\n  `item` varchar(50) NOT NULL,\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n```\n\n* Trigger\n\n```SQL:trigger_order_data_ai.sql\nDELIMITER ;;\nCREATE TRIGGER trigger_order_data_ai \n  AFTER INSERT ON order_data \n  FOR EACH ROW\nBEGIN\n  CALL sqs_order_data_ai_message(NEW.id, NEW.item);\nEND\n;;\nDELIMITER ;\n```\n\n## \u52d5\u4f5c\u30c6\u30b9\u30c8\n* \u4ee5\u4e0b\u306eSQL\u3092\u5b9f\u884c\u3057\u3066\u307f\u307e\u3059\u3002\n\n```SQL:insert.sql\nINSERT INTO order_data VALUES (NULL, 'item_001');\n```\n\n* \u53d6\u308a\u6025\u304e\u3001SQS\u306e\u753b\u9762\u3067\u5229\u7528\u53ef\u80fd\u306a\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u30ab\u30a6\u30f3\u30c8\u30a2\u30c3\u30d7\u3055\u308c\u3066\u3044\u308c\u3070\u6210\u529f\u3067\u3059\u3002\n\n![skitch.7.png](https://qiita-image-store.s3.amazonaws.com/0/39596/002c80de-3f8e-960d-dc2b-b04a8412abcf.png \"skitch.7.png\")\n\n\n# \u5099\u8003\n* \u30a8\u30f3\u30b8\u30f3\u306f`Aurora`\u4e00\u629e\u3067\u3059\u3002`MySQL`\u3092\u9078\u3093\u3060\u3068\u3053\u308d\u3067\u4ee5\u4e0b\u306e\u3088\u3046\u306b`mysql.lambda_async`\u304c\u30b3\u30fc\u30eb\u51fa\u6765\u306a\u3044\u3067\u3059\u3002\n\n```SQL:MySQL\nmysql> show create procedure mysql.lambda_async \\G\nERROR 1305 (42000): PROCEDURE lambda_async does not exist\n```\n\n# \u53c2\u8003\n* http://dev.classmethod.jp/cloud/aws/invoke-lambda-from-aurora/\n* http://qiita.com/eci/items/3eddcd815cd0af121202\n* http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Aurora.Lambda.html\n\n\n", "tags": ["AWS", "Aurora", "lambda", "sqs", "serverless"]}