{"context": "\n\nBenchmark/Profiling/Optimization(a little)\n\nD\u8a00\u8a9e\u3067\u901f\u3044\u30b3\u30fc\u30c9\u3092\u66f8\u304f\u305f\u3081\u306e\u6e96\u5099\n\n\n\nbenchmark\n\n\u63a8\u6e2c\u3059\u308b\u306a\u3001\u8a08\u6e2c\u305b\u3088\n\n\nprofiling\u306e\u3068\u3053\u3067\u3082\u89e6\u308c\u307e\u3059\u304c\n\n\nbenchmark\u306f\u30a8\u30d3\u30c7\u30f3\u30b9\n\n\n\u63d0\u6848\u304c\u307b\u3093\u3068\u306b\u52b9\u679c\u3042\u308b\u304b\u3068\u304b\n\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u306b\u5f71\u97ff\u304c\u3042\u308bor\u306a\u3044\u306e\u8a3c\u660e\u3068\u304b\n\n\n\u30c4\u30fc\u30eb\u3046\u3093\u306c\u3093\u3088\u308a\u3082\u3044\u308d\u3044\u308d\u306a\u30d1\u30bf\u30fc\u30f3\u3067\u3068\u308b\u306e\u304c\u5927\u4e8b\n\n\n\nstd.datetime.benchmark\n\nstd.datetime\u306b\u306fbenchmark\u95a2\u6570\u4ee5\u5916\u3082\u3042\u308b\u3051\u3069\u3001\u307e\u3042\u304a\u597d\u307f\u3067\n\n\n\u8868\u793a\u304c\u5f31\u3044(\u3060\u3081\u3058\u3083\u3093\u306d\u2026)\n\n\n\u306a\u3093\u3067std.datetime...?\n\n    auto results = benchmark!(makeSlice, makeSliceOpt)(100);\n    foreach (r; results)\n        r.to!Duration.writeln;\n/*\n$ shibuyad-talk% rdmd benchmark1.d\n74 ms, 173 \u03bcs, and 9 hnsec\n41 ms, 427 \u03bcs, and 2 hnsec\n*/\n\n\n\nCPU profiling\n\n\u63a8\u6e2c\u3059\u308b\u306a\u3001\u8a08\u6e2c\u305b\u3088\n\n\n\u3069\u3046\u3084\u3063\u3066\u30dc\u30c8\u30eb\u30cd\u30c3\u30af\u307f\u3064\u3051\u308b\u304b\n\u52d8\u3068\u304b\u3001\u77e5\u8b58\u3068\u304b\u307e\u3042\u60aa\u304f\u306f\u306a\u3044\u3051\u3069\n\n\n\u5b9f\u306f\u6700\u9069\u5316\u3057\u3066\u304f\u308c\u3066\u308b\u3068\u304b\u30b3\u30fc\u30c9\u307f\u305f\u3060\u3051\u3067\u308f\u304b\u308a\u307e\u3059\uff1f\n\u3051\u3063\u304d\u3087\u304f\u30dc\u30c8\u30eb\u30cd\u30c3\u30af\u3058\u3083\u306a\u3044\u304b\u3082\u3057\u308c\u306a\u3044\n\n\n\n\n\n\n\nTools\n\ndmd -profile\nperf\ncallgrind / cachegrind\n\n\n\ndmd -profile\n\ndmd -profile\n\n\nQueryPerformanceCounter (Windows)\nrdtsc (Other OSs, x86/x86_64)\n\n\n\n$ dmd -g -profile dmdprofile.d\n$ cat trace.log\n\n\n\u3053\u3053\u304c\u3044\u3044: D\u8a00\u8a9e\u306eruntime\u5074\u3067hook\u3057\u3066\u308b\u306e\u3067\u4f59\u8a08\u306a\u60c5\u5831\u304c\u5165\u3089\u306a\u3044\u3001\u4f7f\u3046\u306e\u7c21\u5358\n\u3053\u3053\u304c\u3060\u3081: D\u95a2\u4fc2\u306a\u3044\u3068\u3053\u306f\u3068\u308c\u306a\u3044(runtime\u3092skip\u3059\u308b\u3068\u3060\u3081)\u3001\u3068\u308c\u308b\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u306f\u9650\u5b9a\u7684\n\n\n\nperf (1)\n\nPerformance Counter (CPU_CLK_UNHALTED) + ftrace\u306asampling profiler\n\n\nftrace\u3067\u30ab\u30fc\u30cd\u30eb\u306e\u95a2\u6570\u3068\u304b\u306b\u3082\u30d5\u30c3\u30af\nmsr\u30ec\u30b8\u30b9\u30bf\u304c\u301c\u3068\u304b\u66f8\u3053\u3046\u3068\u601d\u3063\u305f\u3051\u3069\u3081\u3093\u3069\u304f\u3055\u304f\u306a\u3063\u305f\n\n\nrdtsc\u3068\u6bd4\u3079\u308b\u3068\u4f4e\u6d88\u8cbb\u96fb\u529b\u30e2\u30fc\u30c9\u306e\u5f71\u97ff\u3092\u53d7\u3051\u306a\u3044\n\u7dcfinstruction\u6570\u3001L1/L2\u30ad\u30e3\u30c3\u30b7\u30e5\u30d2\u30c3\u30c8\u7387\u3068\u304b\u3082\u308f\u304b\u308b\n\n# perf record dmdprofile\n# perf report\n... # \u306a\u3093\u304b\u3067\u308b\n\n\n\u3053\u3053\u304c\u3044\u3044: \u4f7f\u3046\u306e\u7c21\u5358\u3001\u304b\u306a\u308a\u3044\u308d\u3044\u308d\u3068\u308c\u308b\n\u3053\u3053\u304c\u3060\u3081: \u4f7f\u3048\u308b\u306e\u306fLinux\u306e\u307f\u3001root\u6a29\u9650\u304c\u5fc5\u8981\n\n\n\u307e\u3042*BSD\u306a\u3089DTrace\u3067\u3057\u3087\u3001\u3068\u3044\u3046\n\n\n\n\n\ncallgrind/cachegrind\n\nvalgrind tool\n\n\ncallgrind: callstack ratio\n\n\n\u4f55\u56de\u547c\u3073\u51fa\u3055\u308c\u308b\u304b\u3001\u5168\u4f53\u306e\u5272\u5408\u3067\u3069\u306e\u304f\u3089\u3044\u304b\u3068\u304b\n\n\ncachegrind: \u30ad\u30e3\u30c3\u30b7\u30e5\n\n\nLinux\u3067\u306fDWARF\u306e\u60c5\u5831\u8aad\u3080\nOSX\u3067\u3082\u52d5\u3044\u3066\u304f\u308c\u308b\n\n% valgrind --tool=callgrind ./dmdprofile\n==25424== Callgrind, a call-graph generating cache profiler\n==25424== Copyright (C) 2002-2013, and GNU GPL'd, by Josef Weidendorfer et al.\n==25424== Using Valgrind-3.10.0 and LibVEX; rerun with -h for copyright info\n==25424== Command: ./dmdprofile\n==25424==\n==25424== For interactive control, run 'callgrind_control -h'.\n==25424==\n==25424== Events    : Ir\n==25424== Collected : 682915\n==25424==\n==25424== I   refs:      682,915\n% callfring_annoate callgrind.out.25424\n... # \u306a\u3093\u304b\u3044\u3063\u3071\u3044\u3067\u308b\n\n\n\u3053\u3053\u304c\u3044\u3044: \u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u306e\u5dee\u7570\u306f\u5438\u53ce\u3001\u4f7f\u3046\u306e\u3082\u96e3\u3057\u304f\u306f\u306a\u3044\n\u3053\u3053\u304c\u3060\u3081: \u3081\u3061\u3083\u304f\u3061\u3083\u9045\u3044\u3001\u5b9f\u884c\u6642profiling\u306a\u3093\u3066\u3082\u3063\u3066\u306e\u307b\u304b\n\n\n\n\u4ed6\u306b\u3082\u3044\u308d\u3044\u308d\u3042\u308b\n\noproifle\n\n\n\u6614\u306f\u5272\u308a\u8fbc\u307f\u5f0f\u3060\u3063\u305f\u3051\u3069\u4eca\u306fperf\u3068\u540c\u3058\u304b\u3093\u3058\u306b\u52d5\u304f\n\n\nGoogle CPU Profiler\n\n\nC/C++\u5411\u3051\u306eSampling Profiler\npprof(Go)\u3068\u304bstackprof(Ruby)\u3068\u304b\u306b\u5f71\u97ff\n\u672c\u756a\u74b0\u5883\u3067\u3082profiling\u3067\u304d\u308b\u306e\u304c\u5b09\u3057\u3044\n\n\n\n\u307e\u3042\u9577\u304f\u306a\u308a\u3059\u304e\u308b\u306e\u3067\u2026\n\n\n\u6240\u611f\n\nprofiler\u306f\u5f97\u610f\u30fb\u4e0d\u5f97\u610f\u306a\u3082\u306e\u304c\u3042\u3063\u305f\u308a\u3059\u308b\n\u57fa\u672c\u4f7f\u3044\u3084\u3059\u3044\u3055\u3067\u9078\u3079\u3070\u826f\u3044\n\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\u3082\u8003\u3048\u3088\u3046\n\n\n\u672c\u756a\u74b0\u5883\u3067\u8a08\u6e2c\u3092\u3068\u308b\u3053\u3068\u306f\u5927\u4e8b\n\n\nVisualize\u3082\u3042\u308b\u3068\u306a\u304a\u3088\u3057\n\n\nflamegraph / kCacheGrind / etc...\n\n\n\n\n\nMemory Profiling\n\n\nGC Configuration\n\n\u6700\u8fd1\u306f\u5b9f\u884c\u6642\u306bGC\u5411\u3051\u306eConfig\u3092\u55b0\u308f\u305b\u3089\u308c\u308b\u3088\u3046\u306b\n\nhttp://dlang.org/spec/garbage.html\n\nstats\n\n $ ./gctuning \"--DRT-gcopt=profile:2\"\n        Number of collections:  5\n        Total GC prep time:  0 milliseconds\n        Total mark time:  1 milliseconds\n        Total sweep time:  0 milliseconds\n        Total page recovery time:  0 milliseconds\n        Max Pause Time:  0 milliseconds\n        Grand total GC time:  1 milliseconds\nGC summary:  268 MB,    5 GC    1 ms, Pauses    1 ms <    0 ms\n\n\n\nOS/libc\n\n\n\u751f\u3067\u3055\u308f\u308b\u3053\u3068\u3082\u7c21\u5358\u306b\u3067\u304d\u308b\n\nmallinfo(3) (Linux/Glibc)\nproc/[PID]/statm (Linux)\n\n\n\n\u57fa\u672c\u5f8c\u8ff0\u306eresusage\u4f7f\u3046\u3063\u305f\u307b\u3046\u304c\u3088\u3044\n\n\u4e8b\u60c5\u3082\u3042\u308b\nshared library\u3060\u3068runtime\u306f\u90aa\u9b54\n\n\n\n\n\nlibc\u306f\u697d\u306b\u89e6\u308c\u308b\n\n\nC\u3068\u306e\u9023\u643a\u306e\u697d\u3055\n\n\n\nextern(C) {\n    struct mallinfo_ {\n        ...\n    }\n    mallinfo_ mallinfo();\n}\n\n\n\nDUB Package\n\n\nresusage\n\n\u308f\u308a\u3068\u30dd\u30fc\u30bf\u30d6\u30eb(Windows/Linux/FreeBSD)\n\u3088\u307b\u3069\u4e8b\u60c5\u304c\u306a\u3044\u9650\u308a\u81ea\u524d\u3067\u66f8\u304f\u5fc5\u8981\u306f\u306a\u3044\n\n\n\n\n\n\u6240\u611f\n\nCPU\u306b\u6bd4\u3079\u308b\u3068\u8efd\u8996\u3055\u308c\u304c\u3061\u3060\u3051\u3069\n\n\n\u3067\u304d\u308c\u3070\u3061\u3083\u3093\u3068\u3068\u3063\u3068\u304f\n\n\nMemory Leaks\u306fvalgrind\u3068\u304b\u4f7f\u304a\u3046\n\n\n\nperformance\n\nGC Tuning\nmemcpy(3)\n\n\n\nGC\n\u30ac\u30d9\u30fc\u30b8\u30b3\u30ec\u30af\u30b7\u30e7\u30f3\n\n\u30e2\u30c0\u30f3\u306aGC\u306f\u3001\u904e\u53bb\u306e\u9045\u3044\u3082\u306e\u3088\u308a\u9059\u304b\u306b\u767a\u5c55\u3057\u3066\u3044\u307e\u3059\u3002 \u4e16\u4ee3\u578b\u306e\u30b3\u30d4\u30fcGC\u306b\u306f\u3001 \u6614\u306e\u30de\u30fc\u30af\uff06\u30b9\u30a4\u30fc\u30d7\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u306e\u975e\u52b9\u7387\u3055\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\u30e2\u30c0\u30f3\u306aGC\u306f\u30d2\u30fc\u30d7\u306e\u8a70\u3081\u76f4\u3057\u3092\u884c\u3044\u307e\u3059\u3002 \u3053\u308c\u306b\u3088\u3063\u3066\u30d7\u30ed\u30b0\u30e9\u30e0\u304c\u6d3b\u767a\u306b\u53c2\u7167\u3059\u308b\u30da\u30fc\u30b8\u306e\u6570\u3092\u6e1b\u3089\u3057\u3001 \u30ad\u30e3\u30c3\u30b7\u30e5\u30d2\u30c3\u30c8\u7387\u3092\u9ad8\u3081\u3001 \u30b9\u30ef\u30c3\u30c3\u30d7\u56de\u6570\u304c\u6e1b\u308a\u307e\u3059\u3002\n\n\n\n\u305d\u3093\u306a\u3046\u307e\u3044\u306f\u306a\u3057\u306f\u306a\u304b\u3063\u305f\u3002\u3002\n\nMark and Sweep / Stop The World\nconcurrent\u3068\u304bcopying\u3068\u304bgenerational\u3068\u304b\u306a\u3044\n\n\u30aa\u30ea\u30b8\u30ca\u30eb\u304b\u3089\u6587\u8a00\u304c\u6d88\u3048\u3066\u308b! http://dlang.org/spec/garbage.html\n\n\nconservative GC\n\n\u3044\u308f\u3086\u308b\u4fdd\u5b88\u7684GC\n\n\n\u30dd\u30a4\u30f3\u30bf\u3063\u307d\u3044\u3084\u3064\u3060\u3063\u305f\u3089mark\u3057\u3068\u3053w\n\n\n\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u30b5\u30a4\u30ba\u306b\u3088\u3063\u3066Pool\u3092\u7528\u610f\n\n\nSmallObjectPool(<=2K\u306e\u30aa\u30d6\u30b8\u30a7\u30af\u30c8) / LargeObjectPool(>2K)\n\n\nPage\u5358\u4f4d\u306b\u306a\u308b\u3088\u3046\u306b(\u30da\u30fc\u30b8\u30b5\u30a4\u30ba=4K)\n\n\n\u30c7\u30d6\u306f\u96fb\u8eca\u306b\u4e57\u308b\u306a\n\u8907\u6570\u306ePool\u3092\u914d\u5217\u3067\u7ba1\u7406\n\n\n\n\n\nGC Tuning parameters\n\n\u8a73\u3057\u3044\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\u306e\u89e3\u8aac\u306f\u306a\u3044\n\n\n\u81ea\u5206\u3067\u8a66\u3059\u3057\u304b\u306a\u3044\nGC\u5b9f\u88c5\u306e\u77e5\u8b58\u3092\u8981\u6c42\u3059\u308b\u306e\u3067\u3088\u304f\u306a\u3044\u30c7\u30b6\u30a4\u30f3\n\n\n\ninitReserve:N - initial memory to reserve in MB\nminPoolSize:N - initial and minimum pool size in MB\nmaxPoolSize:N - maximum pool size in MB\nincPoolSize:N - pool size increment MB\nheapSizeFactor:N - targeted heap size to used memory ratio\n\n\n\u5404\u81ea\u304c\u3093\u3070\u3063\u3066\u304f\u308c\u2026\n\n\n\n\u305d\u306e\u307b\u304b\u3067\u304d\u308b\u3053\u3068\n\n\u305d\u308c\u307b\u3069\u601d\u3044\u3064\u304b\u306a\u3044...\nOut-of-Band GC\u306fvibe.d\u306b\u306f\u60aa\u624b\n\n\n\u52b9\u679c\u306a\u3044\u4e0a\u306b\u5168\u4f53\u306e\u30b9\u30eb\u30fc\u30d7\u30c3\u30c8\u306f\u52a3\u5316\n\n\njemalloc/tcmalloc\u8a66\u3059\u3068\u304b\uff1f\n\n\n\u3067\u3082pool\u306e\u4ed5\u7d44\u307f\u306f\u3059\u3067\u306b\u3042\u308b\u3057\u306a...\nLargeObjectPool\u306efragment\u306b\u306f\u52b9\u679c\u306a\u3055\u305d\u3046\n\n\n\n\n\nManual GC\n\nGC Config\u3067\u5207\u308a\u66ff\u3048\u53ef\u80fd\n\n$ ./gctuning \"--DRT-gc:manual gcopt=profile:2\"\n\n\u8584\u3044\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u3068\u30e1\u30e2\u30ea\u30a8\u30e9\u30fc\u51e6\u7406\u3060\u3051\u63d0\u4f9b\n\n\n\u81ea\u524d\u3067\u9811\u5f35\u308b\u4eba\u5411\u3051\n\u5404\u81ea(ry\n\n\n\n\n\nmemcpy(3)\n\n\u30b3\u30d4\u30fc\u6e1b\u3089\u3059\u306e\u306f\u5e38\u5957\u624b\u6bb5\n\n\nstring\u9023\u7d50\u3068\u304b\u3057\u306a\u3044\u3067std.array.appender\u4f7f\u3046\u3068\u304b\n\n\n\n\n\n\u6240\u611f\n\n\u7528\u9014\u306b\u3082\u3088\u308b\u3057\u3044\u308d\u3044\u308d\u8a66\u3057\u3066\u307f\u308b\u3057\u304b\u306a\u3044\n\n\nGC\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3068\u304b\n\u81ea\u524d\u3067GC\u7d44\u3080\u3068\u304b\n\n\n\u57fa\u672c\u306f\u8a00\u8a9e\u975e\u4f9d\u5b58\u306a\u77e5\u8b58\u3067\u3044\u3051\u308b\n\n\n\u307e\u305a\u30c7\u30fc\u30bf\u69cb\u9020\u30fb\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3092\u898b\u76f4\u3059\n\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u767a\u884c\u56de\u6570\u6e1b\u3089\u3059\n\u30e1\u30e2\u30ea\u30b3\u30d4\u30fc\u3092\u6e1b\u3089\u3059\n\u30ad\u30e3\u30c3\u30b7\u30e5\u30ec\u30a4\u30e4\u3084\u30da\u30fc\u30b8\u30b5\u30a4\u30ba\u3092\u610f\u8b58\n\n\n\u305d\u306e\u4e0a\u3067\u3057\u3063\u304b\u308a\u8a08\u6e2c\u3059\u308b\n\n\n\n\u304a\u3057\u307e\u3044\nAny Questions?\n## Benchmark/Profiling/Optimization(a little)\n\n- D\u8a00\u8a9e\u3067\u901f\u3044\u30b3\u30fc\u30c9\u3092\u66f8\u304f\u305f\u3081\u306e\u6e96\u5099\n\n---\n\n## benchmark\n\n- \u63a8\u6e2c\u3059\u308b\u306a\u3001\u8a08\u6e2c\u305b\u3088\n    - profiling\u306e\u3068\u3053\u3067\u3082\u89e6\u308c\u307e\u3059\u304c\n- benchmark\u306f\u30a8\u30d3\u30c7\u30f3\u30b9\n    - \u63d0\u6848\u304c\u307b\u3093\u3068\u306b\u52b9\u679c\u3042\u308b\u304b\u3068\u304b\n    - \u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u306b\u5f71\u97ff\u304c\u3042\u308bor\u306a\u3044\u306e\u8a3c\u660e\u3068\u304b\n- \u30c4\u30fc\u30eb\u3046\u3093\u306c\u3093\u3088\u308a\u3082\u3044\u308d\u3044\u308d\u306a\u30d1\u30bf\u30fc\u30f3\u3067\u3068\u308b\u306e\u304c\u5927\u4e8b\n\n---\n\n### std.datetime.benchmark\n\n- std.datetime\u306b\u306fbenchmark\u95a2\u6570\u4ee5\u5916\u3082\u3042\u308b\u3051\u3069\u3001\u307e\u3042\u304a\u597d\u307f\u3067\n    - \u8868\u793a\u304c\u5f31\u3044(\u3060\u3081\u3058\u3083\u3093\u306d\u2026)\n- \u306a\u3093\u3067std.datetime...?\n\n```d\n    auto results = benchmark!(makeSlice, makeSliceOpt)(100);\n    foreach (r; results)\n        r.to!Duration.writeln;\n/*\n$ shibuyad-talk% rdmd benchmark1.d\n74 ms, 173 \u03bcs, and 9 hnsec\n41 ms, 427 \u03bcs, and 2 hnsec\n*/\n```\n\n---\n\n## CPU profiling\n\n- \u63a8\u6e2c\u3059\u308b\u306a\u3001\u8a08\u6e2c\u305b\u3088\n    - \u3069\u3046\u3084\u3063\u3066\u30dc\u30c8\u30eb\u30cd\u30c3\u30af\u307f\u3064\u3051\u308b\u304b\n    - \u52d8\u3068\u304b\u3001\u77e5\u8b58\u3068\u304b\u307e\u3042\u60aa\u304f\u306f\u306a\u3044\u3051\u3069\n        - \u5b9f\u306f\u6700\u9069\u5316\u3057\u3066\u304f\u308c\u3066\u308b\u3068\u304b\u30b3\u30fc\u30c9\u307f\u305f\u3060\u3051\u3067\u308f\u304b\u308a\u307e\u3059\uff1f\n        - \u3051\u3063\u304d\u3087\u304f\u30dc\u30c8\u30eb\u30cd\u30c3\u30af\u3058\u3083\u306a\u3044\u304b\u3082\u3057\u308c\u306a\u3044\n\n---\n\n### Tools\n\n- dmd -profile\n- perf\n- callgrind / cachegrind\n\n---\n\n### dmd -profile\n\n- dmd -profile\n    - QueryPerformanceCounter (Windows)\n    - rdtsc (Other OSs, x86/x86_64)\n\n```console\n$ dmd -g -profile dmdprofile.d\n$ cat trace.log\n```\n\n- \u3053\u3053\u304c\u3044\u3044: D\u8a00\u8a9e\u306eruntime\u5074\u3067hook\u3057\u3066\u308b\u306e\u3067\u4f59\u8a08\u306a\u60c5\u5831\u304c\u5165\u3089\u306a\u3044\u3001\u4f7f\u3046\u306e\u7c21\u5358\n- \u3053\u3053\u304c\u3060\u3081: D\u95a2\u4fc2\u306a\u3044\u3068\u3053\u306f\u3068\u308c\u306a\u3044(runtime\u3092skip\u3059\u308b\u3068\u3060\u3081)\u3001\u3068\u308c\u308b\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u306f\u9650\u5b9a\u7684\n\n---\n\n### perf (1)\n\n- Performance Counter (`CPU_CLK_UNHALTED`) + ftrace\u306asampling profiler\n    - ftrace\u3067\u30ab\u30fc\u30cd\u30eb\u306e\u95a2\u6570\u3068\u304b\u306b\u3082\u30d5\u30c3\u30af\n    - msr\u30ec\u30b8\u30b9\u30bf\u304c\u301c\u3068\u304b\u66f8\u3053\u3046\u3068\u601d\u3063\u305f\u3051\u3069\u3081\u3093\u3069\u304f\u3055\u304f\u306a\u3063\u305f\n- rdtsc\u3068\u6bd4\u3079\u308b\u3068\u4f4e\u6d88\u8cbb\u96fb\u529b\u30e2\u30fc\u30c9\u306e\u5f71\u97ff\u3092\u53d7\u3051\u306a\u3044\n- \u7dcfinstruction\u6570\u3001L1/L2\u30ad\u30e3\u30c3\u30b7\u30e5\u30d2\u30c3\u30c8\u7387\u3068\u304b\u3082\u308f\u304b\u308b\n\n```console\n# perf record dmdprofile\n# perf report\n... # \u306a\u3093\u304b\u3067\u308b\n```\n\n- \u3053\u3053\u304c\u3044\u3044: \u4f7f\u3046\u306e\u7c21\u5358\u3001\u304b\u306a\u308a\u3044\u308d\u3044\u308d\u3068\u308c\u308b\n- \u3053\u3053\u304c\u3060\u3081: \u4f7f\u3048\u308b\u306e\u306fLinux\u306e\u307f\u3001root\u6a29\u9650\u304c\u5fc5\u8981\n    - \u307e\u3042*BSD\u306a\u3089DTrace\u3067\u3057\u3087\u3001\u3068\u3044\u3046\n\n---\n\n### callgrind/cachegrind\n\n- valgrind tool\n    - callgrind: callstack ratio\n        - \u4f55\u56de\u547c\u3073\u51fa\u3055\u308c\u308b\u304b\u3001\u5168\u4f53\u306e\u5272\u5408\u3067\u3069\u306e\u304f\u3089\u3044\u304b\u3068\u304b\n    - cachegrind: \u30ad\u30e3\u30c3\u30b7\u30e5\n- Linux\u3067\u306fDWARF\u306e\u60c5\u5831\u8aad\u3080\n- OSX\u3067\u3082\u52d5\u3044\u3066\u304f\u308c\u308b\n\n```console\n% valgrind --tool=callgrind ./dmdprofile\n==25424== Callgrind, a call-graph generating cache profiler\n==25424== Copyright (C) 2002-2013, and GNU GPL'd, by Josef Weidendorfer et al.\n==25424== Using Valgrind-3.10.0 and LibVEX; rerun with -h for copyright info\n==25424== Command: ./dmdprofile\n==25424==\n==25424== For interactive control, run 'callgrind_control -h'.\n==25424==\n==25424== Events    : Ir\n==25424== Collected : 682915\n==25424==\n==25424== I   refs:      682,915\n% callfring_annoate callgrind.out.25424\n... # \u306a\u3093\u304b\u3044\u3063\u3071\u3044\u3067\u308b\n```\n\n- \u3053\u3053\u304c\u3044\u3044: \u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u306e\u5dee\u7570\u306f\u5438\u53ce\u3001\u4f7f\u3046\u306e\u3082\u96e3\u3057\u304f\u306f\u306a\u3044\n- \u3053\u3053\u304c\u3060\u3081: \u3081\u3061\u3083\u304f\u3061\u3083\u9045\u3044\u3001\u5b9f\u884c\u6642profiling\u306a\u3093\u3066\u3082\u3063\u3066\u306e\u307b\u304b\n\n---\n\n### \u4ed6\u306b\u3082\u3044\u308d\u3044\u308d\u3042\u308b\n\n- oproifle\n    - \u6614\u306f\u5272\u308a\u8fbc\u307f\u5f0f\u3060\u3063\u305f\u3051\u3069\u4eca\u306fperf\u3068\u540c\u3058\u304b\u3093\u3058\u306b\u52d5\u304f\n- Google CPU Profiler\n    - C/C++\u5411\u3051\u306eSampling Profiler\n    - pprof(Go)\u3068\u304bstackprof(Ruby)\u3068\u304b\u306b\u5f71\u97ff\n    - \u672c\u756a\u74b0\u5883\u3067\u3082profiling\u3067\u304d\u308b\u306e\u304c\u5b09\u3057\u3044\n\n\u307e\u3042\u9577\u304f\u306a\u308a\u3059\u304e\u308b\u306e\u3067\u2026\n\n---\n\n### \u6240\u611f\n\n- profiler\u306f\u5f97\u610f\u30fb\u4e0d\u5f97\u610f\u306a\u3082\u306e\u304c\u3042\u3063\u305f\u308a\u3059\u308b\n- \u57fa\u672c\u4f7f\u3044\u3084\u3059\u3044\u3055\u3067\u9078\u3079\u3070\u826f\u3044\n- \u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\u3082\u8003\u3048\u3088\u3046\n    - \u672c\u756a\u74b0\u5883\u3067\u8a08\u6e2c\u3092\u3068\u308b\u3053\u3068\u306f\u5927\u4e8b\n- Visualize\u3082\u3042\u308b\u3068\u306a\u304a\u3088\u3057\n    - flamegraph / kCacheGrind / etc...\n\n---\n\n## Memory Profiling\n\n---\n\n### GC Configuration\n\n- \u6700\u8fd1\u306f\u5b9f\u884c\u6642\u306bGC\u5411\u3051\u306eConfig\u3092\u55b0\u308f\u305b\u3089\u308c\u308b\u3088\u3046\u306b\n\nhttp://dlang.org/spec/garbage.html\n\n- stats\n\n```\n $ ./gctuning \"--DRT-gcopt=profile:2\"\n        Number of collections:  5\n        Total GC prep time:  0 milliseconds\n        Total mark time:  1 milliseconds\n        Total sweep time:  0 milliseconds\n        Total page recovery time:  0 milliseconds\n        Max Pause Time:  0 milliseconds\n        Grand total GC time:  1 milliseconds\nGC summary:  268 MB,    5 GC    1 ms, Pauses    1 ms <    0 ms\n```\n\n---\n\n### OS/libc\n\n- \u751f\u3067\u3055\u308f\u308b\u3053\u3068\u3082\u7c21\u5358\u306b\u3067\u304d\u308b\n    - mallinfo(3) (Linux/Glibc)\n    - proc/[PID]/statm (Linux)\n\n- \u57fa\u672c\u5f8c\u8ff0\u306eresusage\u4f7f\u3046\u3063\u305f\u307b\u3046\u304c\u3088\u3044\n    - \u4e8b\u60c5\u3082\u3042\u308b\n    - shared library\u3060\u3068runtime\u306f\u90aa\u9b54\n\n---\n\n- libc\u306f\u697d\u306b\u89e6\u308c\u308b\n    - C\u3068\u306e\u9023\u643a\u306e\u697d\u3055\n\n```d\nextern(C) {\n    struct mallinfo_ {\n        ...\n    }\n    mallinfo_ mallinfo();\n}\n```\n\n---\n\n### DUB Package\n\n- [resusage](http://code.dlang.org/packages/resusage)\n    - \u308f\u308a\u3068\u30dd\u30fc\u30bf\u30d6\u30eb(Windows/Linux/FreeBSD)\n    - \u3088\u307b\u3069\u4e8b\u60c5\u304c\u306a\u3044\u9650\u308a\u81ea\u524d\u3067\u66f8\u304f\u5fc5\u8981\u306f\u306a\u3044\n\n---\n\n### \u6240\u611f\n\n- CPU\u306b\u6bd4\u3079\u308b\u3068\u8efd\u8996\u3055\u308c\u304c\u3061\u3060\u3051\u3069\n    - \u3067\u304d\u308c\u3070\u3061\u3083\u3093\u3068\u3068\u3063\u3068\u304f\n- Memory Leaks\u306fvalgrind\u3068\u304b\u4f7f\u304a\u3046\n\n---\n\n## performance\n\n* GC Tuning\n* memcpy(3)\n\n---\n\n### GC\n\n[\u30ac\u30d9\u30fc\u30b8\u30b3\u30ec\u30af\u30b7\u30e7\u30f3](http://www.kmonos.net/alang/d/garbage.html)\n\n> \u30e2\u30c0\u30f3\u306aGC\u306f\u3001\u904e\u53bb\u306e\u9045\u3044\u3082\u306e\u3088\u308a\u9059\u304b\u306b\u767a\u5c55\u3057\u3066\u3044\u307e\u3059\u3002 \u4e16\u4ee3\u578b\u306e\u30b3\u30d4\u30fcGC\u306b\u306f\u3001 \u6614\u306e\u30de\u30fc\u30af\uff06\u30b9\u30a4\u30fc\u30d7\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u306e\u975e\u52b9\u7387\u3055\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n> \u30e2\u30c0\u30f3\u306aGC\u306f\u30d2\u30fc\u30d7\u306e\u8a70\u3081\u76f4\u3057\u3092\u884c\u3044\u307e\u3059\u3002 \u3053\u308c\u306b\u3088\u3063\u3066\u30d7\u30ed\u30b0\u30e9\u30e0\u304c\u6d3b\u767a\u306b\u53c2\u7167\u3059\u308b\u30da\u30fc\u30b8\u306e\u6570\u3092\u6e1b\u3089\u3057\u3001 \u30ad\u30e3\u30c3\u30b7\u30e5\u30d2\u30c3\u30c8\u7387\u3092\u9ad8\u3081\u3001 \u30b9\u30ef\u30c3\u30c3\u30d7\u56de\u6570\u304c\u6e1b\u308a\u307e\u3059\u3002\n\n---\n\n#### \u305d\u3093\u306a\u3046\u307e\u3044\u306f\u306a\u3057\u306f\u306a\u304b\u3063\u305f\u3002\u3002\n\n- Mark and Sweep / Stop The World\n- concurrent\u3068\u304bcopying\u3068\u304bgenerational\u3068\u304b\u306a\u3044\n\n\u30aa\u30ea\u30b8\u30ca\u30eb\u304b\u3089\u6587\u8a00\u304c\u6d88\u3048\u3066\u308b! http://dlang.org/spec/garbage.html\n\n---\n\n#### conservative GC\n\n- \u3044\u308f\u3086\u308b\u4fdd\u5b88\u7684GC\n    - \u30dd\u30a4\u30f3\u30bf\u3063\u307d\u3044\u3084\u3064\u3060\u3063\u305f\u3089mark\u3057\u3068\u3053w\n- \u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u30b5\u30a4\u30ba\u306b\u3088\u3063\u3066Pool\u3092\u7528\u610f\n    - SmallObjectPool(<=2K\u306e\u30aa\u30d6\u30b8\u30a7\u30af\u30c8) / LargeObjectPool(>2K)\n        - Page\u5358\u4f4d\u306b\u306a\u308b\u3088\u3046\u306b(\u30da\u30fc\u30b8\u30b5\u30a4\u30ba=4K)\n    - \u30c7\u30d6\u306f\u96fb\u8eca\u306b\u4e57\u308b\u306a\n    - \u8907\u6570\u306ePool\u3092\u914d\u5217\u3067\u7ba1\u7406\n\n---\n\n#### GC Tuning parameters\n\n- \u8a73\u3057\u3044\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\u306e\u89e3\u8aac\u306f\u306a\u3044\n    - \u81ea\u5206\u3067\u8a66\u3059\u3057\u304b\u306a\u3044\n    - GC\u5b9f\u88c5\u306e\u77e5\u8b58\u3092\u8981\u6c42\u3059\u308b\u306e\u3067\u3088\u304f\u306a\u3044\u30c7\u30b6\u30a4\u30f3\n\n```\ninitReserve:N - initial memory to reserve in MB\nminPoolSize:N - initial and minimum pool size in MB\nmaxPoolSize:N - maximum pool size in MB\nincPoolSize:N - pool size increment MB\nheapSizeFactor:N - targeted heap size to used memory ratio\n```\n\n- \u5404\u81ea\u304c\u3093\u3070\u3063\u3066\u304f\u308c\u2026\n\n---\n\n#### \u305d\u306e\u307b\u304b\u3067\u304d\u308b\u3053\u3068\n\n- \u305d\u308c\u307b\u3069\u601d\u3044\u3064\u304b\u306a\u3044...\n- Out-of-Band GC\u306fvibe.d\u306b\u306f\u60aa\u624b\n    - \u52b9\u679c\u306a\u3044\u4e0a\u306b\u5168\u4f53\u306e\u30b9\u30eb\u30fc\u30d7\u30c3\u30c8\u306f\u52a3\u5316\n- jemalloc/tcmalloc\u8a66\u3059\u3068\u304b\uff1f\n    - \u3067\u3082pool\u306e\u4ed5\u7d44\u307f\u306f\u3059\u3067\u306b\u3042\u308b\u3057\u306a...\n    - LargeObjectPool\u306efragment\u306b\u306f\u52b9\u679c\u306a\u3055\u305d\u3046\n\n---\n\n#### Manual GC\n\n- GC Config\u3067\u5207\u308a\u66ff\u3048\u53ef\u80fd\n\n`$ ./gctuning \"--DRT-gc:manual gcopt=profile:2\"`\n\n- \u8584\u3044\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u3068\u30e1\u30e2\u30ea\u30a8\u30e9\u30fc\u51e6\u7406\u3060\u3051\u63d0\u4f9b\n    - \u81ea\u524d\u3067\u9811\u5f35\u308b\u4eba\u5411\u3051\n    - \u5404\u81ea(ry\n\n---\n\n### memcpy(3)\n\n- \u30b3\u30d4\u30fc\u6e1b\u3089\u3059\u306e\u306f\u5e38\u5957\u624b\u6bb5\n    - string\u9023\u7d50\u3068\u304b\u3057\u306a\u3044\u3067std.array.appender\u4f7f\u3046\u3068\u304b\n\n---\n\n#### \u6240\u611f\n\n- \u7528\u9014\u306b\u3082\u3088\u308b\u3057\u3044\u308d\u3044\u308d\u8a66\u3057\u3066\u307f\u308b\u3057\u304b\u306a\u3044\n    - GC\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3068\u304b\n    - \u81ea\u524d\u3067GC\u7d44\u3080\u3068\u304b\n- \u57fa\u672c\u306f\u8a00\u8a9e\u975e\u4f9d\u5b58\u306a\u77e5\u8b58\u3067\u3044\u3051\u308b\n    - \u307e\u305a\u30c7\u30fc\u30bf\u69cb\u9020\u30fb\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3092\u898b\u76f4\u3059\n    - \u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u767a\u884c\u56de\u6570\u6e1b\u3089\u3059\n    - \u30e1\u30e2\u30ea\u30b3\u30d4\u30fc\u3092\u6e1b\u3089\u3059\n    - \u30ad\u30e3\u30c3\u30b7\u30e5\u30ec\u30a4\u30e4\u3084\u30da\u30fc\u30b8\u30b5\u30a4\u30ba\u3092\u610f\u8b58\n- \u305d\u306e\u4e0a\u3067\u3057\u3063\u304b\u308a\u8a08\u6e2c\u3059\u308b\n\n---\n\n## \u304a\u3057\u307e\u3044\n\nAny Questions?\n", "tags": ["dlang"]}