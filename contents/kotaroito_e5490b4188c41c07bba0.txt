{"context": " More than 1 year has passed since last update.\u30af\u30fc\u30d3\u30c3\u30af\u3067\u306f\u3053\u308c\u307e\u3067 Vagrant\u3067\u4f5c\u6210\u3057\u305fVM\u3092\u7528\u3044\u3066\u3001\u30ed\u30fc\u30ab\u30eb\u30de\u30b7\u30f3\u3067 itamae \u306e\u30c6\u30b9\u30c8\u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3057\u305f\u3002\n\u7ba1\u7406\u3059\u3079\u304d\u30ed\u30fc\u30eb\u304c\u5897\u3048\u308b\u306b\u3064\u308c\u6bce\u56de\u30c6\u30b9\u30c8\u3092\u56de\u3059\u306e\u304c\u30c4\u30e9\u304f\u306a\u3063\u3066\u304d\u305f\u305f\u3081\u3001CircleCI \u306b\u3088\u308b\u7d99\u7d9a\u7684\u30a4\u30f3\u30c6\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u691c\u8a0e\u3059\u308b\u3053\u3068\u306b\u3057\u307e\u3057\u305f\u3002\n\u5229\u7528\u74b0\u5883\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\n\n\n\nEnv / Tool\nVersion\n\n\n\n\nOS\nUbuntu 14.04\n\n\nProvisioning\nitamae (1.3.6)\n\n\nTest\nserverspec (2.19.0)\n\n\n\n\u307e\u305f\u3001\u30ea\u30dd\u30b8\u30c8\u30ea\u306e\u69cb\u6210\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\ncookbooks \u306b\u306f Itamae \u306e\u30ec\u30b7\u30d4\u304c\u3001spec \u306b\u306f\u30c6\u30b9\u30c8\u304c\u5165\u3063\u3066\u3044\u307e\u3059\u3002\n$ tree -L 1\n.\n\u251c\u2500\u2500 .ssh\n\u251c\u2500\u2500 Dockerfile\n\u251c\u2500\u2500 Gemfile\n\u251c\u2500\u2500 Gemfile.lock\n\u251c\u2500\u2500 Rakefile\n\u251c\u2500\u2500 circle.yml\n\u251c\u2500\u2500 cookbooks\n\u2514\u2500\u2500 spec\n\n\n\u4e8b\u4f8b\u8abf\u67fb\nCircleCI \u3067 Serverspec\u306b\u3088\u308b\u30c6\u30b9\u30c8\u306e\u4e8b\u4f8b\u3092\u3044\u304f\u3064\u304b\u8abf\u67fb\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\nVagrant + EC2\n\nKAIZEN platform Inc.\u306b\u304a\u3051\u308b\u904b\u7528\u81ea\u52d5\u5316\n\n\nDocker + Serverspec + Itamae\n\nCircleCI \u3067 Docker Container \u3092 Serverspec \u3067\u30c6\u30b9\u30c8\u3059\u308b\nitamae\u306b\u5165\u9580\u3057\u3066Docker\u8abf\u7406\u3057\u3066\u307f\u305f\nDocker on CircleCI\u3067chef\u306ecookbook\u3092serverspec\u3067\u30c6\u30b9\u30c8\n\nproduction \u3067\u306f\u30b3\u30f3\u30c6\u30ca\u3092\u5229\u7528\u3057\u3066\u3044\u306a\u3044\u306e\u3067\u3001prodution \u3068 test \u74b0\u5883\u3067\u4e56\u96e2\u304c\u767a\u751f\u3059\u308b\u306e\u304c\u3084\u3084\u6c17\u306b\u306a\u308a\u307e\u3059\u304c\u3001Docker \u306a\u3089\u7279\u306b\u8ffd\u52a0\u8cbb\u7528\u304c\u639b\u304b\u3089\u305a\u3001\u8d77\u52d5\u3082\u901f\u3044\u306e\u3067 Docker \u3092\u4f7f\u3046\u3053\u3068\u3068\u3057\u307e\u3057\u305f\u3002\n\nDocker\n\u4f55\u306f\u3068\u3082\u3042\u308c\u3001\u30ed\u30fc\u30ab\u30eb\u3067 Docker \u3092\u52d5\u304b\u3059\u305f\u3081\u306e\u74b0\u5883\u3092\u69cb\u7bc9\u3057\u307e\u3059\u3002\nMac OS X \u3067\u3042\u308c\u3070\u3001Docker Toolbox \u3092\u4f7f\u3046\u306e\u304c\u6700\u3082\u30ab\u30f3\u30bf\u30f3\u3068\u601d\u308f\u308c\u307e\u3059\u3002\nDocker \u306b\u89e6\u308c\u305f\u3053\u3068\u304c\u306a\u3051\u308c\u3070\u3001Get Started with Docker for Mac OS X \u3092\u4e00\u901a\u308a\u8a66\u3059\u306e\u304c\u3088\u3044\u3067\u3059\u3002\n\nbackend\n\u30ed\u30fc\u30ab\u30eb\u74b0\u5883\u69cb\u7bc9\u304c\u6e08\u3093\u3060\u3089\u3001docker \u3068\u306e I/O \u3092\u691c\u8a0e\u3057\u307e\u3059\u3002\nItamae \u3068 Serverspec \u3069\u3061\u3089\u3082\u5185\u90e8\u3067 Specinfra \u3092\u5229\u7528\u3057\u3066\u304a\u308a\u3001backend \u3068\u3057\u3066 ssh \u3042\u308b\u3044\u306f docker \u306e\u6307\u5b9a\u304c\u53ef\u80fd\u3067\u3059\u3002production \u3067\u306f backend \u306b ssh \u3092\u5229\u7528\u3057\u3066\u308b\u306e\u3067\u3001docker \u306b\u3082 ssh \u7d4c\u7531\u3067\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3053\u3068\u306b\u3057\u307e\u3059\u3002\n\u306a\u304a\u3001Why you don't need to run SSHd in your Docker containers \u3068\u3044\u3046\u8b70\u8ad6\u3082\u3042\u308a\u307e\u3059\u304c\u3001\u30b3\u30f3\u30c6\u30ca\u306fCircleCI\u3067\u3057\u304b\u5229\u7528\u3057\u306a\u3044\u306e\u3067\u4eca\u56de\u306f\u3088\u3057\u3068\u3057\u307e\u3057\u305f\u3002\n\nDockerfile\nssh \u3067\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306a\u30a4\u30e1\u30fc\u30b8\u3092\u6e96\u5099\u3057\u307e\u3059\u3002\nFROM ubuntu:14.04\n\nRUN apt-get update && apt-get -y upgrade && apt-get install -y build-essential libssl-dev libreadline-dev zlib1g-dev language-pack-ja\nRUN apt-get -y install openssh-server ufw curl\nRUN mkdir /var/run/sshd\n\nRUN useradd -m docker && echo \"docker:docker\" | chpasswd && gpasswd -a docker sudo\nRUN mkdir -p /home/docker/.ssh; chown docker /home/docker/.ssh; chmod 700 /home/docker/.ssh\n\nADD ./authorized_keys /home/docker/.ssh/authorized_keys\nRUN chown docker /home/docker/.ssh/authorized_keys; chmod 600 /home/docker/.ssh/authorized_keys\n\nCMD /usr/sbin/sshd -D && tail -f /dev/null\n\n\u5de5\u592b\u3057\u305f\u30dd\u30a4\u30f3\u30c8\u3092\u3044\u304f\u3064\u304b\u3002\nRUN useradd -m docker && echo \"docker:docker\" | chpasswd && gpasswd -a docker sudo\n\n\u3067 docker \u30e6\u30fc\u30b6\u3092\u4f5c\u6210\u3057\u3001sudo \u30b0\u30eb\u30fc\u30d7\u306b\u767b\u9332\u3057\u3066\u3044\u307e\u3059\u3002\nCMD /usr/sbin/sshd -D && tail -f /dev/null\n\n/dev/null \u3092 tail -f \u3059\u308b\u306e\u306f sshd \u3092\u518d\u8d77\u52d5\u3057\u305f\u969b\u306b\u3001\u30b3\u30f3\u30c6\u30ca\u304c exit \u3057\u306a\u3044\u305f\u3081\u306e\u5de5\u592b\u3067\u3059\u3002\n\nCircleCI\ncircle.yml \u3092\u6e96\u5099\u3057\u307e\u3059\u3002\nmachine:\n  services:\n    - docker\n\ndependencies:\n  pre: \n    - ssh-keygen -t rsa -b 2048 -N \"\" -C \"docker\" -f  ~/.ssh/id_rsa.docker\n    - cat ~/.ssh/id_rsa.docker.pub > authorized_keys\n    - cat .ssh/config >> ~/.ssh/config\n    - docker build -t kotaroito/ubuntu .\n    - docker run --privileged -d -p 2222:22 kotaroito/ubuntu\ntest:\n  pre:\n    - env SUDO_PASSWORD=docker bundle exec itamae ssh -h example cookbooks/recipe.rb\n  override:\n    - env SUDO_PASSWORD=docker bundle exec rake spec\n\ndocker \u30e6\u30fc\u30b6\u3067 ssh \u3059\u308b\u305f\u3081\u306b\u3001ssh-keygen \u3067 \u79d8\u5bc6\u9375\u30fb\u516c\u958b\u9375\u3092\u751f\u6210\u3057\u3066\u3001docker build \u6642\u306b authorized_keys \u3092 image \u306b\u7d44\u307f\u8fbc\u3093\u3067\u3044\u307e\u3059\u3002 \n\u307e\u305f\u3001.ssh/config \u30d5\u30a1\u30a4\u30eb\u3092\u7528\u610f\u3057\u3066\u304a\u304d\u3001itamae ssh -h examle \u3067\u304d\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002 \nHost example\n  HostName localhost\n  User docker\n  Port 2222\n  StrictHostKeyChecking no\n  PasswordAuthentication no\n  IdentityFile /home/ubuntu/.ssh/id_rsa.docker\n\n\u306a\u304a\u3001privileged \u30aa\u30d7\u30b7\u30e7\u30f3\u306f itamae \u3067 ufw \u7b49\u3092\u5b9f\u884c\u3059\u308b\u5834\u5408\u306b\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n\u5b9f\u884c\u7d50\u679c\n\n\u7121\u4e8b CircleCI + Docker \u3067 Itamae \u30ec\u30b7\u30d4\u306e\u7d99\u7d9a\u7684\u30a4\u30f3\u30c6\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3057\u305f\u3002\n\n\u53c2\u8003\u30b5\u30a4\u30c8\nDockerfile \u3068 circle.yml \u306f\u3001\u4ee5\u4e0b\u3092\u53c2\u8003\u306b\u3055\u305b\u3066\u3044\u305f\u3060\u304d\u307e\u3057\u305f\u3002\n\nhttp://tech.feedforce.jp/serverci-by-docker.html\nhttp://qiita.com/comutt/items/1251cc19885947cd6d3d\n\n\n\u30af\u30fc\u30d3\u30c3\u30af\u3067\u306f\u3053\u308c\u307e\u3067 Vagrant\u3067\u4f5c\u6210\u3057\u305fVM\u3092\u7528\u3044\u3066\u3001\u30ed\u30fc\u30ab\u30eb\u30de\u30b7\u30f3\u3067 itamae \u306e\u30c6\u30b9\u30c8\u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3057\u305f\u3002\n\n\u7ba1\u7406\u3059\u3079\u304d\u30ed\u30fc\u30eb\u304c\u5897\u3048\u308b\u306b\u3064\u308c\u6bce\u56de\u30c6\u30b9\u30c8\u3092\u56de\u3059\u306e\u304c\u30c4\u30e9\u304f\u306a\u3063\u3066\u304d\u305f\u305f\u3081\u3001CircleCI \u306b\u3088\u308b\u7d99\u7d9a\u7684\u30a4\u30f3\u30c6\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u691c\u8a0e\u3059\u308b\u3053\u3068\u306b\u3057\u307e\u3057\u305f\u3002\n\n\u5229\u7528\u74b0\u5883\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\n\n| Env / Tool | Version |\n|:-----------|------------:|\n| OS       |        Ubuntu 14.04 |\n| Provisioning     |      itamae (1.3.6) |\n| Test     |      serverspec (2.19.0) |\n\n\n\u307e\u305f\u3001\u30ea\u30dd\u30b8\u30c8\u30ea\u306e\u69cb\u6210\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\ncookbooks \u306b\u306f Itamae \u306e\u30ec\u30b7\u30d4\u304c\u3001spec \u306b\u306f\u30c6\u30b9\u30c8\u304c\u5165\u3063\u3066\u3044\u307e\u3059\u3002\n\n```\n$ tree -L 1\n.\n\u251c\u2500\u2500 .ssh\n\u251c\u2500\u2500 Dockerfile\n\u251c\u2500\u2500 Gemfile\n\u251c\u2500\u2500 Gemfile.lock\n\u251c\u2500\u2500 Rakefile\n\u251c\u2500\u2500 circle.yml\n\u251c\u2500\u2500 cookbooks\n\u2514\u2500\u2500 spec\n```\n\n\n\n## \u4e8b\u4f8b\u8abf\u67fb\nCircleCI \u3067 Serverspec\u306b\u3088\u308b\u30c6\u30b9\u30c8\u306e\u4e8b\u4f8b\u3092\u3044\u304f\u3064\u304b\u8abf\u67fb\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n#### Vagrant + EC2\n* [KAIZEN platform Inc.\u306b\u304a\u3051\u308b\u904b\u7528\u81ea\u52d5\u5316](\nhttp://sssslide.com/speakerdeck.com/naoya/kaizen-platform-inc-niokeruyun-yong-zi-dong-hua)\n\n#### Docker + Serverspec + Itamae\n\n* [CircleCI \u3067 Docker Container \u3092 Serverspec \u3067\u30c6\u30b9\u30c8\u3059\u308b](http://ja.ngs.io/2015/09/26/circleci-docker-serverspec/)\n\n* [itamae\u306b\u5165\u9580\u3057\u3066Docker\u8abf\u7406\u3057\u3066\u307f\u305f]\n(http://www.slideshare.net/NaokiIshibashi/itamaedocker)\n\n* [Docker on CircleCI\u3067chef\u306ecookbook\u3092serverspec\u3067\u30c6\u30b9\u30c8]\n(http://hoppie.hatenablog.com/entry/2015/02/02/014455)\n\n\nproduction \u3067\u306f\u30b3\u30f3\u30c6\u30ca\u3092\u5229\u7528\u3057\u3066\u3044\u306a\u3044\u306e\u3067\u3001prodution \u3068 test \u74b0\u5883\u3067\u4e56\u96e2\u304c\u767a\u751f\u3059\u308b\u306e\u304c\u3084\u3084\u6c17\u306b\u306a\u308a\u307e\u3059\u304c\u3001Docker \u306a\u3089\u7279\u306b\u8ffd\u52a0\u8cbb\u7528\u304c\u639b\u304b\u3089\u305a\u3001\u8d77\u52d5\u3082\u901f\u3044\u306e\u3067 Docker \u3092\u4f7f\u3046\u3053\u3068\u3068\u3057\u307e\u3057\u305f\u3002\n\n\n## Docker\n\n\n\u4f55\u306f\u3068\u3082\u3042\u308c\u3001\u30ed\u30fc\u30ab\u30eb\u3067 Docker \u3092\u52d5\u304b\u3059\u305f\u3081\u306e\u74b0\u5883\u3092\u69cb\u7bc9\u3057\u307e\u3059\u3002\nMac OS X \u3067\u3042\u308c\u3070\u3001[Docker Toolbox](https://www.docker.com/docker-toolbox) \u3092\u4f7f\u3046\u306e\u304c\u6700\u3082\u30ab\u30f3\u30bf\u30f3\u3068\u601d\u308f\u308c\u307e\u3059\u3002\n\nDocker \u306b\u89e6\u308c\u305f\u3053\u3068\u304c\u306a\u3051\u308c\u3070\u3001[Get Started with Docker for Mac OS X](http://docs.docker.com/mac/started/) \u3092\u4e00\u901a\u308a\u8a66\u3059\u306e\u304c\u3088\u3044\u3067\u3059\u3002\n\n\n### backend\n\n\u30ed\u30fc\u30ab\u30eb\u74b0\u5883\u69cb\u7bc9\u304c\u6e08\u3093\u3060\u3089\u3001docker \u3068\u306e I/O \u3092\u691c\u8a0e\u3057\u307e\u3059\u3002\n\nItamae \u3068 Serverspec \u3069\u3061\u3089\u3082\u5185\u90e8\u3067 Specinfra \u3092\u5229\u7528\u3057\u3066\u304a\u308a\u3001backend \u3068\u3057\u3066 ssh \u3042\u308b\u3044\u306f docker \u306e\u6307\u5b9a\u304c\u53ef\u80fd\u3067\u3059\u3002production \u3067\u306f backend \u306b ssh \u3092\u5229\u7528\u3057\u3066\u308b\u306e\u3067\u3001docker \u306b\u3082 ssh \u7d4c\u7531\u3067\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3053\u3068\u306b\u3057\u307e\u3059\u3002\n\n\n\u306a\u304a\u3001[Why you don't need to run SSHd in your Docker containers](http://blog.docker.com/2014/06/why-you-dont-need-to-run-sshd-in-docker/) \u3068\u3044\u3046\u8b70\u8ad6\u3082\u3042\u308a\u307e\u3059\u304c\u3001\u30b3\u30f3\u30c6\u30ca\u306fCircleCI\u3067\u3057\u304b\u5229\u7528\u3057\u306a\u3044\u306e\u3067\u4eca\u56de\u306f\u3088\u3057\u3068\u3057\u307e\u3057\u305f\u3002\n\n\n### Dockerfile\n\nssh \u3067\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306a\u30a4\u30e1\u30fc\u30b8\u3092\u6e96\u5099\u3057\u307e\u3059\u3002\n\n```\nFROM ubuntu:14.04\n\nRUN apt-get update && apt-get -y upgrade && apt-get install -y build-essential libssl-dev libreadline-dev zlib1g-dev language-pack-ja\nRUN apt-get -y install openssh-server ufw curl\nRUN mkdir /var/run/sshd\n\nRUN useradd -m docker && echo \"docker:docker\" | chpasswd && gpasswd -a docker sudo\nRUN mkdir -p /home/docker/.ssh; chown docker /home/docker/.ssh; chmod 700 /home/docker/.ssh\n \nADD ./authorized_keys /home/docker/.ssh/authorized_keys\nRUN chown docker /home/docker/.ssh/authorized_keys; chmod 600 /home/docker/.ssh/authorized_keys\n\nCMD /usr/sbin/sshd -D && tail -f /dev/null\n```\n\n\u5de5\u592b\u3057\u305f\u30dd\u30a4\u30f3\u30c8\u3092\u3044\u304f\u3064\u304b\u3002\n\n```\nRUN useradd -m docker && echo \"docker:docker\" | chpasswd && gpasswd -a docker sudo\n```\n\n\u3067 docker \u30e6\u30fc\u30b6\u3092\u4f5c\u6210\u3057\u3001sudo \u30b0\u30eb\u30fc\u30d7\u306b\u767b\u9332\u3057\u3066\u3044\u307e\u3059\u3002\n\n\n```\nCMD /usr/sbin/sshd -D && tail -f /dev/null\n```\n\n/dev/null \u3092 tail -f \u3059\u308b\u306e\u306f sshd \u3092\u518d\u8d77\u52d5\u3057\u305f\u969b\u306b\u3001\u30b3\u30f3\u30c6\u30ca\u304c exit \u3057\u306a\u3044\u305f\u3081\u306e\u5de5\u592b\u3067\u3059\u3002\n\n\n## CircleCI\n\ncircle.yml \u3092\u6e96\u5099\u3057\u307e\u3059\u3002\n\n```yaml\nmachine:\n  services:\n    - docker\n\ndependencies:\n  pre: \n    - ssh-keygen -t rsa -b 2048 -N \"\" -C \"docker\" -f  ~/.ssh/id_rsa.docker\n    - cat ~/.ssh/id_rsa.docker.pub > authorized_keys\n    - cat .ssh/config >> ~/.ssh/config\n    - docker build -t kotaroito/ubuntu .\n    - docker run --privileged -d -p 2222:22 kotaroito/ubuntu\ntest:\n  pre:\n    - env SUDO_PASSWORD=docker bundle exec itamae ssh -h example cookbooks/recipe.rb\n  override:\n    - env SUDO_PASSWORD=docker bundle exec rake spec\n```\n\n\ndocker \u30e6\u30fc\u30b6\u3067 ssh \u3059\u308b\u305f\u3081\u306b\u3001ssh-keygen \u3067 \u79d8\u5bc6\u9375\u30fb\u516c\u958b\u9375\u3092\u751f\u6210\u3057\u3066\u3001docker build \u6642\u306b authorized_keys \u3092 image \u306b\u7d44\u307f\u8fbc\u3093\u3067\u3044\u307e\u3059\u3002 \n\n\u307e\u305f\u3001.ssh/config \u30d5\u30a1\u30a4\u30eb\u3092\u7528\u610f\u3057\u3066\u304a\u304d\u3001itamae ssh -h examle \u3067\u304d\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002 \n\n```\nHost example\n  HostName localhost\n  User docker\n  Port 2222\n  StrictHostKeyChecking no\n  PasswordAuthentication no\n  IdentityFile /home/ubuntu/.ssh/id_rsa.docker\n```\n\n\u306a\u304a\u3001privileged \u30aa\u30d7\u30b7\u30e7\u30f3\u306f itamae \u3067 ufw \u7b49\u3092\u5b9f\u884c\u3059\u308b\u5834\u5408\u306b\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n\n### \u5b9f\u884c\u7d50\u679c\n\n![circleci.png](https://qiita-image-store.s3.amazonaws.com/0/20304/2bd63284-e6ed-b763-64fb-4f6cdbaccc24.png \"circleci.png\")\n\n\n\u7121\u4e8b CircleCI + Docker \u3067 Itamae \u30ec\u30b7\u30d4\u306e\u7d99\u7d9a\u7684\u30a4\u30f3\u30c6\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3057\u305f\u3002\n\n\n## \u53c2\u8003\u30b5\u30a4\u30c8\nDockerfile \u3068 circle.yml \u306f\u3001\u4ee5\u4e0b\u3092\u53c2\u8003\u306b\u3055\u305b\u3066\u3044\u305f\u3060\u304d\u307e\u3057\u305f\u3002\n\n * http://tech.feedforce.jp/serverci-by-docker.html\n * http://qiita.com/comutt/items/1251cc19885947cd6d3d\n\n", "tags": ["itamae", "docker", "serverspec", "CircleCI"]}