{"tags": ["CodeDeploy", "Ansible", "Terraform"], "context": " More than 1 year has passed since last update.\u3088\u304f\u5927\u5b87\u5b99\u72b6\u614b(\u8b0e)\u306b\u306a\u3063\u3066\u3044\u308b\u5148\u8f29\u304c\u3001terraform+codedeploy+ansible\u3092\u8a66\u3057\u3066\u3044\u305f\u306e\u3067\n\u672c\u5f53\u306b\u4f7f\u3048\u308b\u304b\u3069\u3046\u304b\u5b9f\u8df5\u3057\u3066\u307f\u307e\u3057\u305f\u3002\nAWS CodeDeploy\u3092\u4f7f\u3063\u3066Ansible or itamae + Serverspec\nhttp://qiita.com/gamisan9999/items/c4e26bf99189bed82748\n\n\u5168\u4f53\u50cf\n\u5148\u8f29\u306e\u8a18\u4e8b\u3060\u3051\u898b\u3066\u3044\u308b\u3068\u4f55\u3057\u3066\u3044\u308b\u304b\u3088\u304f\u308f\u304b\u3093\u306a\u304b\u3063\u305f\u306e\u3067\u3001\u308f\u304b\u308a\u3084\u3059\u304f\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\u3061\u306a\u307f\u306b\u3001Terraform\u3068CodeDeploy+Ansible\u306f\u5b8c\u5168\u306b\u5225\u7269\u3067\u3059\u3002\n\u9023\u643a\u306f\u307e\u3063\u305f\u304f\u3042\u308a\u307e\u305b\u3093\u306e\u3067\u3042\u3057\u304b\u3089\u305a\u3002\nTerraform\u3067AWS\u74b0\u5883\u3092\u69cb\u7bc9\u3001EC2\u3068\u304bCodeDeploy\u3068\u304b\u3082\u308d\u3082\u308d\u4f5c\u6210\u3002\nAnsible\u30ec\u30b7\u30d4\u3092Codedeploy\u3067S3\u306b\u30a2\u30c3\u30d7\u3002\nCodeDeploy\u304b\u3089S3\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u30c7\u30d7\u30ed\u30a4\u3002\n\u5f8c\u306f\u3001\u5bfe\u8c61\u306e\u30ed\u30fc\u30ab\u30eb\u3067\u6307\u5b9a\u306e\u3082\u306e\u304c\u52d5\u304d\u307e\u3059\u3002\n\u4eca\u56de\u306fAnsible\u3067\u3059\u3002\n\n\nAWS\u74b0\u5883\u69cb\u7bc9\n\nCodeDeploy Agent\nCodeDeploy\u3092\u4f7f\u7528\u3059\u308b\u306b\u306f\u3001\u30b5\u30fc\u30d0\u30fc\u5074\u3067CodeDeployAgent\u3092\u8d77\u52d5\u3057\u3066\u304a\u304f\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\nhttp://docs.aws.amazon.com/ja_jp/codedeploy/latest/userguide/how-to-run-agent.html\n\u3057\u304b\u3057Agent\u3092\u5165\u308c\u308b\u306e\u306b\u3001\u308f\u3056\u308f\u3056BaseAMI\u3092\u7528\u610f\u3059\u308b\u306e\u306f\u9762\u5012\u306a\u306e\u3067\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u8d77\u52d5\u6642\u306euser_data\u306b\u4ee5\u4e0b\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u5165\u308c\u308c\u3070\ncodedeploy\u306eAgent\u304c\u5165\u308a\u307e\u3059\u3002\nhttp://docs.aws.amazon.com/ja_jp/codedeploy/latest/userguide/how-to-set-up-new-instance.html\n#!/bin/bash\nyum -y update\nyum install -y ruby\nyum install -y aws-cli\ncd /home/ec2-user\naws s3 cp s3://bucket-name/latest/install . --region region-name\nchmod +x ./install\n./install auto\n\nyum update\u3068\u304b\u4e0d\u8981\u3067\u3042\u308c\u3070\u5916\u305b\u307e\u3059\u3002\nAWS-CLI\u3067\u4e0a\u3052\u308b\u306a\u3089\u3053\u3093\u306a\u611f\u3058\u3002\naws ec2 run-instances \\\n  --image-id amiID \\\n  --key-name keyName \\\n  --user-data file://instance-setup.sh \\\n  --count 1 \\\n  --instance-type instanceType \\\n  --iam-instance-profile Name=CodeDeployDemo-EC2-Instance-Profile\n\n\nAWS\u74b0\u5883\u69cb\u7bc9\n\u4f8b\u306b\u7fd2\u3063\u3066Terraform\u3067\u74b0\u5883\u69cb\u7bc9\u3002\nAutoScale\u3068\u304b\u3057\u3066\u306a\u3044\u3067\u30011\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4e0a\u3052\u308b\u3060\u3051\u3002\nTerraForm\u306e\u4f7f\u3044\u65b9\u306f\u5225\u9014\u30b0\u30fc\u30b0\u30eb\u5148\u751f\u3068\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092\u53c2\u8003\u306b\u3057\u3066\u3044\u305f\u3060\u304d\u305f\u304f\u3002\n\u5225\u306bTerraform\u4f7f\u308f\u306a\u304f\u3066\u3082\u5927\u4e08\u592b\u3067\u3059\u3002\n\nEC2\n\u6c17\u306b\u3059\u308b\u3068\u3053\u308d\u306f\u3001user_data\u3068\u30bf\u30b0\u540d\u3002\nuser_data\u306fCodeDeployAgent\u7528\u3001\n\u30bf\u30b0\u306fDeploy\u5bfe\u8c61\u306e\u6642\u306e\u30d5\u30a3\u30eb\u30bf\u30fc\u306b\u4f7f\u3044\u307e\u3059\u3002\nresource \"aws_instance\" \"web-1\" {\n  instance_type = \"${var.web_instance_type}\"\n  ami = \"${var.ami_id}\"\n  subnet_id = \"${aws_subnet.public-1c-subnet.id}\"\n  security_groups = [\"${aws_security_group.common.id}\"]\n  associate_public_ip_address = true\n  key_name  = \"${var.key_name}\"\n  iam_instance_profile = \"${aws_iam_instance_profile.public-profile.name}\"\n  user_data = \"${file(\"./shells/user_data.sh\")}\" \u203b\u3053\u3053\u306buser_data\u6307\u5b9a\n  tags = {\n    Name = \"web-1\"\n    Role = \"web\" \u203bcodedeploy\u306b\u7528\u306b\u30bf\u30b0\u6307\u5b9a\n  }\n  root_block_device = {\n    volume_type = \"gp2\"\n    volume_size = \"100\"\n  }\n}\n\n\nS3\nCodeDeploy\u3067\u4f7f\u7528\u3059\u308bS3\u30d0\u30b1\u30c3\u30c8\u3092\u4f5c\u308b\u3002\n\u30d0\u30fc\u30b8\u30e7\u30cb\u30f3\u30b0\u3092\u6709\u52b9\u306b\u3059\u308b\u3002\nresource \"aws_s3_bucket\" \"deploy_bucket\" {\n    bucket = \"hogehoge-deploy-bucket\"\n    acl= \"private\"\n    region = \"ap-northeast-1\"\n    tags {\n        Name = \"hogehoge-deploy-bucket\"\n    }\n    versioning {\n      enabled = true\n    }\n}\n\n\nCodedeploy\n\nIAM\nCodeDeploy\u81ea\u4f53\u304c\u4f7f\u7528\u3059\u308bIAMRole\u3092\u4f5c\u6210\u3002\nhttp://docs.aws.amazon.com/ja_jp/codedeploy/latest/userguide/how-to-create-service-role.html\nresource \"aws_iam_role\" \"codedeploy_role\" {\n    name = \"codedeploy_role\"\n    assume_role_policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": [\n          \"codedeploy.amazonaws.com\"\n        ]\n      },\n      \"Action\": \"sts:AssumeRole\"\n    }\n  ]\n}\nEOF\n}\n\n\nresource \"aws_iam_role_policy\" \"codedeploy_policy\" {\n    name = \"codedeploy_policy\"\n    role = \"${aws_iam_role.codedeploy_role.id}\"\n    policy = <<EOF\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"autoscaling:CompleteLifecycleAction\",\n                \"autoscaling:DeleteLifecycleHook\",\n                \"autoscaling:DescribeAutoScalingGroups\",\n                \"autoscaling:DescribeLifecycleHooks\",\n                \"autoscaling:PutLifecycleHook\",\n                \"autoscaling:RecordLifecycleActionHeartbeat\",\n                \"ec2:DescribeInstances\",\n                \"ec2:DescribeInstanceStatus\",\n                \"tag:GetTags\",\n                \"tag:GetResources\"\n            ],\n            \"Resource\": \"*\"\n        }\n    ]\n}\nEOF\n}\n\n\nCodeDeploy\u306e\u5b9a\u7fa9\u3092\u4f5c\u6210\n\u5bfe\u8c61\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30d5\u30a3\u30eb\u30bf\u30fc\u306f\u30bf\u30b0\u540d\u3067\u884c\u3063\u3066\u307e\u3059\u3002\n\u5148\u8f29\u306e\u8a18\u4e8b\u306b\u306f\u3001\u30bf\u30b0\u304c2\u3064\u6307\u5b9a\u3055\u308c\u3066\u307e\u3059\u304c\u3001CodeDeploy\u306e\u30bf\u30b0\u306fAND\u6761\u4ef6\u3067\u306f\u306a\u3044\u306e\u3067\u3001\n2\u3064\u4ed8\u3051\u3066\u3082\u5bfe\u8c61\u304c\u5897\u3048\u308b\u3060\u3051\u3067\u3059\u3002\nresource \"aws_codedeploy_app\" \"web-provisioning\"\n{\n  name = \"web-provisioning\"\n}\n\nresource \"aws_codedeploy_deployment_group\" \"web-provisioning-group\"\n{\n  app_name = \"${aws_codedeploy_app.web-provisioning.name}\"\n  deployment_group_name = \"web-group\"\n  service_role_arn = \"${aws_iam_role.codedeploy_role.arn}\"\n  ec2_tag_filter {\n    key = \"Role\"\n    value = \"web\"\n    type = \"KEY_AND_VALUE\"\n  }\n  deployment_config_name = \"CodeDeployDefault.AllAtOnce\"\n}\n\n\u3053\u308c\u3067AWS\u69cb\u7bc9\u306f\u7d42\u308f\u308a\u3002\n\nAnsible + CodeDeploy\n\nAnsible\u4f5c\u6210\n\u52d5\u4f5c\u3068\u3057\u3066\u306f\u3001S3\u306b\u914d\u7f6e\u3057\u3066\u3044\u308bAnsible\u3092\u914d\u5e03\u3001\u5404\u30b5\u30fc\u30d0\u81ea\u8eab\u3067LocalHost\u5b9b\u306b\u5b9f\u884c\u3057\u307e\u3059\u3002\nappspec.yml\u306e\u66f8\u304d\u65b9\u3055\u3048\u308f\u304b\u308c\u3070\u3001\u5f8c\u306fAnsible\u306e\u66f8\u304d\u65b9\u304c\u308f\u304b\u308c\u3070\u5927\u4e08\u592b\u3067\u3059\u3002\n\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u968e\u5c64\u306f\u3053\u3061\u3089\u3092\u53c2\u8003\u306b\u3057\u3066\u307e\u3059\u3002\nhttps://github.com/awslabs/aws-codedeploy-samples/tree/master/conf-mgmt/ansible/local-only\nappspec.yml\nversion: 0.0\nos: linux\nfiles:\n  - source: /\n    destination: /etc/ansible/codedeploy\nhooks:\n  BeforeInstall:\n    - location: before_install.sh\n      timeout: 300\n      runas: root\n  ApplicationStart:\n    - location: application_start.sh\n      timeout: 300\n      runas: root\n  ValidateService:\n    - location: verify_service.sh\n      timeout: 300\n      runas: root\n\n\nCodeDeploy\u306bpush\nweb\u3068\u3044\u3046\u30d5\u30a9\u30eb\u30c0\u306b\u3001\u5148\u307b\u3069\u306e\u30d5\u30a1\u30a4\u30eb\u69cb\u6210\u306e\u3082\u306e\u3092\u6e96\u5099\u3057\u3066push\u3059\u308b\u3002\naws deploy push \\\n--application-name web-provisioning \\\n--s3-location s3://hogehoge-deploy-bucket/web-ansible.zip \\\n--source ./web/ \\\n--ignore-hidden-files \\\n--profile hoehoge \\\n--region ap-northeast-1\n\n\nDeploy\n\u5f8c\u306fCLI\u3067push\u3059\u308b\u3082\u3088\u3057\u3001Console\u304b\u3089Deploy\u3059\u308b\u3082\u3088\u3057\u3068\u306a\u308a\u307e\u3059\u3002\n\n\n\u4f7f\u3063\u3066\u307f\u3066\nTerraform\u306f\u4fbf\u5229\u3067\u3059\u3002\nCodeDeploy\u306fAnsible\u3092\u4f5c\u308b\u624b\u9593\u3068\u3001\u4e00\u3005push\u3059\u308b\u306e\u304c\u9762\u5012\u3067\u3057\u305f\u3002\n\u307e\u305f\u3001push\u3057\u305f\u5f8c\u306eDeploy\u3082\u9762\u5012\u3002\n\u73fe\u72b6\u3060\u3068\u3001\u30ed\u30fc\u30ab\u30eb\u304b\u3089Ansible\u3092\u666e\u901a\u306b\u5b9f\u884c\u3057\u305f\u307b\u3046\u304c\u4fbf\u5229\u3058\u3083\u306a\u3044\u304b\uff1f\u3063\u3068\u601d\u3044\u307e\u3057\u305f\u304c\u3001\n\u30d0\u30fc\u30b8\u30e7\u30f3\u7ba1\u7406\u7b49\u306fCodeDeploy\u304c\u512a\u308c\u3066\u3044\u308b\u304b\u306a\u3068\u601d\u3044\u307e\u3057\u305f\u3002\nAnsible\u306e\u8cc7\u7523\u304c\u3042\u3063\u3066\u3082\u3001\u4fee\u6b63\u3059\u308b\u624b\u9593\u306f\u591a\u5c11\u3042\u308b\u306e\u3067\u305d\u306e\u5206\u306e\u4fa1\u5024\u304c\u898b\u3044\u3060\u305b\u308b\u304b\u3068\u3044\u3046\u3068\u5fae\u5999\u3002\nAuto Scaling \u7b49\u306e\u7d44\u307f\u5408\u308f\u305b\u304cCodeDeploy\u306b\u306f\u3088\u3055\u305d\u3046\u3067\u3059\u306e\u3067\u3001\u3082\u3046\u5c11\u3057\u89e6\u3063\u3066\u304b\u3089\u7d50\u8ad6\u3092\u51fa\u3057\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u3088\u304f\u5927\u5b87\u5b99\u72b6\u614b(\u8b0e)\u306b\u306a\u3063\u3066\u3044\u308b\u5148\u8f29\u304c\u3001terraform+codedeploy+ansible\u3092\u8a66\u3057\u3066\u3044\u305f\u306e\u3067\n\u672c\u5f53\u306b\u4f7f\u3048\u308b\u304b\u3069\u3046\u304b\u5b9f\u8df5\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\nAWS CodeDeploy\u3092\u4f7f\u3063\u3066Ansible or itamae + Serverspec\nhttp://qiita.com/gamisan9999/items/c4e26bf99189bed82748\n\n## \u5168\u4f53\u50cf\n\n\u5148\u8f29\u306e\u8a18\u4e8b\u3060\u3051\u898b\u3066\u3044\u308b\u3068\u4f55\u3057\u3066\u3044\u308b\u304b\u3088\u304f\u308f\u304b\u3093\u306a\u304b\u3063\u305f\u306e\u3067\u3001\u308f\u304b\u308a\u3084\u3059\u304f\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n\u3061\u306a\u307f\u306b\u3001Terraform\u3068CodeDeploy+Ansible\u306f\u5b8c\u5168\u306b\u5225\u7269\u3067\u3059\u3002\n\u9023\u643a\u306f\u307e\u3063\u305f\u304f\u3042\u308a\u307e\u305b\u3093\u306e\u3067\u3042\u3057\u304b\u3089\u305a\u3002\n\nTerraform\u3067AWS\u74b0\u5883\u3092\u69cb\u7bc9\u3001EC2\u3068\u304bCodeDeploy\u3068\u304b\u3082\u308d\u3082\u308d\u4f5c\u6210\u3002\nAnsible\u30ec\u30b7\u30d4\u3092Codedeploy\u3067S3\u306b\u30a2\u30c3\u30d7\u3002\nCodeDeploy\u304b\u3089S3\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u30c7\u30d7\u30ed\u30a4\u3002\n\u5f8c\u306f\u3001\u5bfe\u8c61\u306e\u30ed\u30fc\u30ab\u30eb\u3067\u6307\u5b9a\u306e\u3082\u306e\u304c\u52d5\u304d\u307e\u3059\u3002\n\u4eca\u56de\u306fAnsible\u3067\u3059\u3002\n\n![terraform-codedeploy.png](https://f001.backblaze.com/b2api/v1/b2_download_file_by_id?fileId=4_z43eaf387432065b9561d0b15_f11203b1fdff6ce26_d20151204_m043437_c001_v0001012_t0008)\n\n# AWS\u74b0\u5883\u69cb\u7bc9\n## CodeDeploy Agent\n\nCodeDeploy\u3092\u4f7f\u7528\u3059\u308b\u306b\u306f\u3001\u30b5\u30fc\u30d0\u30fc\u5074\u3067CodeDeployAgent\u3092\u8d77\u52d5\u3057\u3066\u304a\u304f\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\nhttp://docs.aws.amazon.com/ja_jp/codedeploy/latest/userguide/how-to-run-agent.html\n\n\u3057\u304b\u3057Agent\u3092\u5165\u308c\u308b\u306e\u306b\u3001\u308f\u3056\u308f\u3056BaseAMI\u3092\u7528\u610f\u3059\u308b\u306e\u306f\u9762\u5012\u306a\u306e\u3067\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u8d77\u52d5\u6642\u306euser_data\u306b\u4ee5\u4e0b\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u5165\u308c\u308c\u3070\ncodedeploy\u306eAgent\u304c\u5165\u308a\u307e\u3059\u3002\n\nhttp://docs.aws.amazon.com/ja_jp/codedeploy/latest/userguide/how-to-set-up-new-instance.html\n\n```\n#!/bin/bash\nyum -y update\nyum install -y ruby\nyum install -y aws-cli\ncd /home/ec2-user\naws s3 cp s3://bucket-name/latest/install . --region region-name\nchmod +x ./install\n./install auto\n```\n\nyum update\u3068\u304b\u4e0d\u8981\u3067\u3042\u308c\u3070\u5916\u305b\u307e\u3059\u3002\n\nAWS-CLI\u3067\u4e0a\u3052\u308b\u306a\u3089\u3053\u3093\u306a\u611f\u3058\u3002\n\n```\naws ec2 run-instances \\\n  --image-id amiID \\\n  --key-name keyName \\\n  --user-data file://instance-setup.sh \\\n  --count 1 \\\n  --instance-type instanceType \\\n  --iam-instance-profile Name=CodeDeployDemo-EC2-Instance-Profile\n```\n\n## AWS\u74b0\u5883\u69cb\u7bc9\n\n\u4f8b\u306b\u7fd2\u3063\u3066Terraform\u3067\u74b0\u5883\u69cb\u7bc9\u3002\nAutoScale\u3068\u304b\u3057\u3066\u306a\u3044\u3067\u30011\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4e0a\u3052\u308b\u3060\u3051\u3002\n\nTerraForm\u306e\u4f7f\u3044\u65b9\u306f\u5225\u9014\u30b0\u30fc\u30b0\u30eb\u5148\u751f\u3068\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092\u53c2\u8003\u306b\u3057\u3066\u3044\u305f\u3060\u304d\u305f\u304f\u3002\n\u5225\u306bTerraform\u4f7f\u308f\u306a\u304f\u3066\u3082\u5927\u4e08\u592b\u3067\u3059\u3002\n\n### EC2\n\n\u6c17\u306b\u3059\u308b\u3068\u3053\u308d\u306f\u3001user_data\u3068\u30bf\u30b0\u540d\u3002\n\nuser_data\u306fCodeDeployAgent\u7528\u3001\n\u30bf\u30b0\u306fDeploy\u5bfe\u8c61\u306e\u6642\u306e\u30d5\u30a3\u30eb\u30bf\u30fc\u306b\u4f7f\u3044\u307e\u3059\u3002\n\n```\nresource \"aws_instance\" \"web-1\" {\n  instance_type = \"${var.web_instance_type}\"\n  ami = \"${var.ami_id}\"\n  subnet_id = \"${aws_subnet.public-1c-subnet.id}\"\n  security_groups = [\"${aws_security_group.common.id}\"]\n  associate_public_ip_address = true\n  key_name  = \"${var.key_name}\"\n  iam_instance_profile = \"${aws_iam_instance_profile.public-profile.name}\"\n  user_data = \"${file(\"./shells/user_data.sh\")}\" \u203b\u3053\u3053\u306buser_data\u6307\u5b9a\n  tags = {\n    Name = \"web-1\"\n    Role = \"web\" \u203bcodedeploy\u306b\u7528\u306b\u30bf\u30b0\u6307\u5b9a\n  }\n  root_block_device = {\n    volume_type = \"gp2\"\n    volume_size = \"100\"\n  }\n}\n```\n\n## S3\n\nCodeDeploy\u3067\u4f7f\u7528\u3059\u308bS3\u30d0\u30b1\u30c3\u30c8\u3092\u4f5c\u308b\u3002\n\u30d0\u30fc\u30b8\u30e7\u30cb\u30f3\u30b0\u3092\u6709\u52b9\u306b\u3059\u308b\u3002\n\n```\nresource \"aws_s3_bucket\" \"deploy_bucket\" {\n    bucket = \"hogehoge-deploy-bucket\"\n    acl= \"private\"\n    region = \"ap-northeast-1\"\n    tags {\n        Name = \"hogehoge-deploy-bucket\"\n    }\n    versioning {\n      enabled = true\n    }\n}\n```\n\n## Codedeploy\n\n### IAM\n\nCodeDeploy\u81ea\u4f53\u304c\u4f7f\u7528\u3059\u308bIAMRole\u3092\u4f5c\u6210\u3002\n\nhttp://docs.aws.amazon.com/ja_jp/codedeploy/latest/userguide/how-to-create-service-role.html\n\n```\nresource \"aws_iam_role\" \"codedeploy_role\" {\n    name = \"codedeploy_role\"\n    assume_role_policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": [\n          \"codedeploy.amazonaws.com\"\n        ]\n      },\n      \"Action\": \"sts:AssumeRole\"\n    }\n  ]\n}\nEOF\n}\n\n\nresource \"aws_iam_role_policy\" \"codedeploy_policy\" {\n    name = \"codedeploy_policy\"\n    role = \"${aws_iam_role.codedeploy_role.id}\"\n    policy = <<EOF\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"autoscaling:CompleteLifecycleAction\",\n                \"autoscaling:DeleteLifecycleHook\",\n                \"autoscaling:DescribeAutoScalingGroups\",\n                \"autoscaling:DescribeLifecycleHooks\",\n                \"autoscaling:PutLifecycleHook\",\n                \"autoscaling:RecordLifecycleActionHeartbeat\",\n                \"ec2:DescribeInstances\",\n                \"ec2:DescribeInstanceStatus\",\n                \"tag:GetTags\",\n                \"tag:GetResources\"\n            ],\n            \"Resource\": \"*\"\n        }\n    ]\n}\nEOF\n}\n```\n\n\n### CodeDeploy\u306e\u5b9a\u7fa9\u3092\u4f5c\u6210\n\n\u5bfe\u8c61\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30d5\u30a3\u30eb\u30bf\u30fc\u306f\u30bf\u30b0\u540d\u3067\u884c\u3063\u3066\u307e\u3059\u3002\n\u5148\u8f29\u306e\u8a18\u4e8b\u306b\u306f\u3001\u30bf\u30b0\u304c2\u3064\u6307\u5b9a\u3055\u308c\u3066\u307e\u3059\u304c\u3001CodeDeploy\u306e\u30bf\u30b0\u306fAND\u6761\u4ef6\u3067\u306f\u306a\u3044\u306e\u3067\u3001\n2\u3064\u4ed8\u3051\u3066\u3082\u5bfe\u8c61\u304c\u5897\u3048\u308b\u3060\u3051\u3067\u3059\u3002\n\n```\nresource \"aws_codedeploy_app\" \"web-provisioning\"\n{\n  name = \"web-provisioning\"\n}\n\nresource \"aws_codedeploy_deployment_group\" \"web-provisioning-group\"\n{\n  app_name = \"${aws_codedeploy_app.web-provisioning.name}\"\n  deployment_group_name = \"web-group\"\n  service_role_arn = \"${aws_iam_role.codedeploy_role.arn}\"\n  ec2_tag_filter {\n    key = \"Role\"\n    value = \"web\"\n    type = \"KEY_AND_VALUE\"\n  }\n  deployment_config_name = \"CodeDeployDefault.AllAtOnce\"\n}\n```\n\n\n\n\u3053\u308c\u3067AWS\u69cb\u7bc9\u306f\u7d42\u308f\u308a\u3002\n\n\n# Ansible + CodeDeploy\n\n## Ansible\u4f5c\u6210\n\n\u52d5\u4f5c\u3068\u3057\u3066\u306f\u3001S3\u306b\u914d\u7f6e\u3057\u3066\u3044\u308bAnsible\u3092\u914d\u5e03\u3001\u5404\u30b5\u30fc\u30d0\u81ea\u8eab\u3067LocalHost\u5b9b\u306b\u5b9f\u884c\u3057\u307e\u3059\u3002\n\nappspec.yml\u306e\u66f8\u304d\u65b9\u3055\u3048\u308f\u304b\u308c\u3070\u3001\u5f8c\u306fAnsible\u306e\u66f8\u304d\u65b9\u304c\u308f\u304b\u308c\u3070\u5927\u4e08\u592b\u3067\u3059\u3002\n\n\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u968e\u5c64\u306f\u3053\u3061\u3089\u3092\u53c2\u8003\u306b\u3057\u3066\u307e\u3059\u3002\n\nhttps://github.com/awslabs/aws-codedeploy-samples/tree/master/conf-mgmt/ansible/local-only\n\nappspec.yml\n\n```\nversion: 0.0\nos: linux\nfiles:\n  - source: /\n    destination: /etc/ansible/codedeploy\nhooks:\n  BeforeInstall:\n    - location: before_install.sh\n      timeout: 300\n      runas: root\n  ApplicationStart:\n    - location: application_start.sh\n      timeout: 300\n      runas: root\n  ValidateService:\n    - location: verify_service.sh\n      timeout: 300\n      runas: root\n```\n\n## CodeDeploy\u306bpush\n\nweb\u3068\u3044\u3046\u30d5\u30a9\u30eb\u30c0\u306b\u3001\u5148\u307b\u3069\u306e\u30d5\u30a1\u30a4\u30eb\u69cb\u6210\u306e\u3082\u306e\u3092\u6e96\u5099\u3057\u3066push\u3059\u308b\u3002\n\n```\naws deploy push \\\n--application-name web-provisioning \\\n--s3-location s3://hogehoge-deploy-bucket/web-ansible.zip \\\n--source ./web/ \\\n--ignore-hidden-files \\\n--profile hoehoge \\\n--region ap-northeast-1\n```\n\n\n## Deploy\n\n\u5f8c\u306fCLI\u3067push\u3059\u308b\u3082\u3088\u3057\u3001Console\u304b\u3089Deploy\u3059\u308b\u3082\u3088\u3057\u3068\u306a\u308a\u307e\u3059\u3002\n\n![AWS_CodeDeploy_Management.jpg](https://qiita-image-store.s3.amazonaws.com/0/49877/b657d735-403f-e955-23a9-2175a86a7160.jpeg)\n\n\n#\u4f7f\u3063\u3066\u307f\u3066\n\nTerraform\u306f\u4fbf\u5229\u3067\u3059\u3002\n\nCodeDeploy\u306fAnsible\u3092\u4f5c\u308b\u624b\u9593\u3068\u3001\u4e00\u3005push\u3059\u308b\u306e\u304c\u9762\u5012\u3067\u3057\u305f\u3002\n\u307e\u305f\u3001push\u3057\u305f\u5f8c\u306eDeploy\u3082\u9762\u5012\u3002\n\n\u73fe\u72b6\u3060\u3068\u3001\u30ed\u30fc\u30ab\u30eb\u304b\u3089Ansible\u3092\u666e\u901a\u306b\u5b9f\u884c\u3057\u305f\u307b\u3046\u304c\u4fbf\u5229\u3058\u3083\u306a\u3044\u304b\uff1f\u3063\u3068\u601d\u3044\u307e\u3057\u305f\u304c\u3001\n\u30d0\u30fc\u30b8\u30e7\u30f3\u7ba1\u7406\u7b49\u306fCodeDeploy\u304c\u512a\u308c\u3066\u3044\u308b\u304b\u306a\u3068\u601d\u3044\u307e\u3057\u305f\u3002\n\nAnsible\u306e\u8cc7\u7523\u304c\u3042\u3063\u3066\u3082\u3001\u4fee\u6b63\u3059\u308b\u624b\u9593\u306f\u591a\u5c11\u3042\u308b\u306e\u3067\u305d\u306e\u5206\u306e\u4fa1\u5024\u304c\u898b\u3044\u3060\u305b\u308b\u304b\u3068\u3044\u3046\u3068\u5fae\u5999\u3002\n\nAuto Scaling \u7b49\u306e\u7d44\u307f\u5408\u308f\u305b\u304cCodeDeploy\u306b\u306f\u3088\u3055\u305d\u3046\u3067\u3059\u306e\u3067\u3001\u3082\u3046\u5c11\u3057\u89e6\u3063\u3066\u304b\u3089\u7d50\u8ad6\u3092\u51fa\u3057\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n"}