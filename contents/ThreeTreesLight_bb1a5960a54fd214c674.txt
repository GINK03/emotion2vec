{"context": " More than 1 year has passed since last update.\u4eca\u66f4\u306a\u304c\u3089\u3001\u8907\u6570\u53f0\u30b5\u30fc\u30d0\u30fc\u306b\u5bfe\u5fdc\u3055\u305b\u308b\u305f\u3081session\u7ba1\u7406\u3092memcached\u3092\u4f7f\u3063\u3066\u5916\u90e8\u5316\u3057\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\nRequire\n\nrails 4\nunicorn\nmemcached\nosx\n\n\n\u306a\u3093\u3067memcached\n\u4ee5\u524d\u306fredis-store\u3092\u4f7f\u3063\u3066\u307f\u305f\u306e\u3067\u3059\u3002\n\u30ec\u30d7\u30ea\u3082\u3067\u304d\u308b\u3057\u3001\u8907\u96d1\u306a\u578b\u3082\u6271\u3048\u308b\u304b\u3089redis\u304c\u3044\u3044\u306a\u30fc\u3068\u601d\u3063\u3066\u3044\u308b\u306e\u3067\u5e78\u305b\u304c\u5f85\u3063\u3066\u3044\u308b\u81ed\u3044\u304c\u3057\u307e\u3059\u3002\n\u304c\u3001\u6700\u8fd1\u66f4\u65b0\u6ede\u3063\u3066\u308b\u3057\u3001\u3001\u3001\u3063\u3066\u3044\u3046\u5f8c\u308d\u5411\u304d\u306a\u7406\u7531\u3067dalli + memcached\u3067\u3059\u3002\nMemcache vs. Redis?\n\nInstall memcached and setup launchclt\n\u3068\u308a\u3042\u3048\u305a\u5165\u308c\u308b\n$ brew install memcached\nmemcached: stable 1.4.20 (bottled)\nhttp://memcached.org/\nConflicts with: mysql-cluster\n/opt/boxen/homebrew/Cellar/memcached/1.4.20 (10 files, 184K) *\n  Built from source\nFrom: https://github.com/Homebrew/homebrew/commits/master/Library/Formula/memcached.rb\n==> Dependencies\nRequired: libevent \u2714\n==> Options\n--enable-sasl\n        Enable SASL support -- disables ASCII protocol!\n--enable-sasl-pwdb\n        Enable SASL with memcached's own plain text password db support -- disables ASCII protocol!\n==> Caveats\nTo have launchd start memcached at login:\n    ln -sfv /opt/boxen/homebrew/opt/memcached/*.plist ~/Library/LaunchAgents\nThen to load memcached now:\n    launchctl load ~/Library/LaunchAgents/homebrew.mxc\n\n\u66f8\u3044\u3066\u3042\u308b\u901a\u308alaunchdCtl\u3067\u81ea\u52d5\u8d77\u52d5\u8a2d\u5b9a\n$ ln -sfv /opt/boxen/homebrew/opt/memcached/*.plist ~/Library/LaunchAgents\n$ launchctl load ~/Library/LaunchAgents/homebrew.mxcl.memcached.plist\n\n\u78ba\u8a8d\n# \u30d7\u30ed\u30bb\u30b9\n$  ps axu | ag memcached\nfoo      84598   0.0  0.0  2464188    380   ??  S     9:16PM   0:00.06 /opt/boxen/homebrew/opt/memcached/bin/memcached -l localhost\n\n# \u7e4b\u3052\u308b\n$ telnet localhost 11211\nstats\n...\n\n\nok\n\nrails\u5074\u306b\u8a2d\u5b9a\nmemcache client\u306fdalli\u3092\u5229\u7528\u3057\u307e\u3059\n$ vim Gemfile\ngem 'dalli'\n\n$ bundle\n\n\u3068\u308a\u3042\u3048\u305adevelop\u30e2\u30fc\u30c9\u3067\u52d5\u304f\u3088\u3046\u306b\u3057\u307e\u3059\u3002\ncache\u3068session\u8a2d\u5b9a\u3092dalli\u7d4c\u7531\u306b\u5909\u66f4\n$ vim config/environment/development.rb\n\nAppName::Application.configure do\n  ...\n  config.cache_store = :dalli_store\n  ...\n\n$ vim config/initialize/session_store.rb\nFooRails::Application.config.session_store ActionDispatch::Session::CacheStore, key: '_foo_session', expire_after: 1.month\n\nconsole\u3067cache\u30c6\u30b9\u30c8\n$ rails c\npry> Rails.cache.write 'foo', 'bar'\nCache write: foo\nDalli::Server#connect 127.0.0.1:11211\n=> 144115188075855872\n\npry> Rails.cache.read 'foo'\nCache read: foo\n=> \"bar\"\n\nok\n\ndeploy\u5f8c\u306b\u518d\u63a5\u7d9a\ndalli 2.0.4\u304b\u3089\u518d\u63a5\u7d9a\u306f\u4e0d\u8981\u3067\u3059\nhttps://github.com/petergoldstein/dalli/issues/208\nunicorn\u306eafter fork\u6642\u306b\u3001memcached\u3068\u306e\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u3092\u5f35\u308a\u76f4\u3057\u307e\u3059\u3002\nafter_fork do |server,worker|\n  ...\n  if defined?(ActiveSupport::Cache::DalliStore) && Rails.cache.is_a?(ActiveSupport::Cache::DalliStore)\n    Rails.cache.reset\n    ObjectSpace.each_object(ActionDispatch::Session::DalliStore) { |obj| obj.reset }\n  end\n\n\n\u74b0\u5883\u5909\u6570\u306e\u5916\u3060\u3057\n\u6700\u7d42\u7684\u306b\u306fElasticCache\u3078\u306e\u63a5\u7d9a\u3057\u305f\u3044\u7269\u306e\u3001VM\u5185\u3067\u306e\u69cb\u7bc9\u8a66\u9a13\u3059\u308b\u305f\u3081\u306b\u308f\u3056\u308f\u3056EC2\u7d4c\u7531\u3059\u308b\u3068\u304b\u3057\u305f\u304f\u306a\u3044\u306e\u3067\u3001dotenv gem\u3092\u5229\u7528\u3057\u3066\u8a2d\u5b9a\u3092\u5916\u90e8\u5316\u3057\u307e\u3059\u3002\n.evn\u8a2d\u5b9a\n$ vim .env\n# nil is connecting to local memcached\nCACHE_STORE=nil\n\n\n\u74b0\u5883\u5909\u6570\u5f15\u3063\u5f35\u308b\u69d8\u306b\u5909\u66f4\n# develop\u304b\u3089\u5916\u3057\u3066\n$ vim config/environment/development.rb\n\n- AppName::Application.configure do\n-   ...\n-   config.cache_store = :dalli_store, ENV['CACHE_STORE']\n-   ...\n\n# production\u306e\u307f\u8ffd\u52a0\n$ vim config/environment/production.rb\n\nAppName::Application.configure do\n  ...\n  config.cache_store = :dalli_store, ENV['CACHE_STORE']\n\n\u3053\u3093\u306a\u611f\u3058\u3067\u3002\n\n\u4eca\u66f4\u306a\u304c\u3089\u3001\u8907\u6570\u53f0\u30b5\u30fc\u30d0\u30fc\u306b\u5bfe\u5fdc\u3055\u305b\u308b\u305f\u3081session\u7ba1\u7406\u3092memcached\u3092\u4f7f\u3063\u3066\u5916\u90e8\u5316\u3057\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n## Require\n\n* rails 4\n* unicorn\n* memcached\n* osx\n\n## \u306a\u3093\u3067memcached\n\n\u4ee5\u524d\u306f[redis-store](https://github.com/redis-store/redis-store)\u3092\u4f7f\u3063\u3066\u307f\u305f\u306e\u3067\u3059\u3002\n\n\u30ec\u30d7\u30ea\u3082\u3067\u304d\u308b\u3057\u3001\u8907\u96d1\u306a\u578b\u3082\u6271\u3048\u308b\u304b\u3089redis\u304c\u3044\u3044\u306a\u30fc\u3068\u601d\u3063\u3066\u3044\u308b\u306e\u3067\u5e78\u305b\u304c\u5f85\u3063\u3066\u3044\u308b\u81ed\u3044\u304c\u3057\u307e\u3059\u3002\n\n\u304c\u3001\u6700\u8fd1\u66f4\u65b0\u6ede\u3063\u3066\u308b\u3057\u3001\u3001\u3001\u3063\u3066\u3044\u3046\u5f8c\u308d\u5411\u304d\u306a\u7406\u7531\u3067dalli + memcached\u3067\u3059\u3002\n\n[Memcache vs. Redis?](http://stackoverflow.com/questions/10558465/memcache-vs-redis)\n\n## Install memcached and setup launchclt\n\n\n\u3068\u308a\u3042\u3048\u305a\u5165\u308c\u308b\n\n```bash\n$ brew install memcached\nmemcached: stable 1.4.20 (bottled)\nhttp://memcached.org/\nConflicts with: mysql-cluster\n/opt/boxen/homebrew/Cellar/memcached/1.4.20 (10 files, 184K) *\n  Built from source\nFrom: https://github.com/Homebrew/homebrew/commits/master/Library/Formula/memcached.rb\n==> Dependencies\nRequired: libevent \u2714\n==> Options\n--enable-sasl\n        Enable SASL support -- disables ASCII protocol!\n--enable-sasl-pwdb\n        Enable SASL with memcached's own plain text password db support -- disables ASCII protocol!\n==> Caveats\nTo have launchd start memcached at login:\n    ln -sfv /opt/boxen/homebrew/opt/memcached/*.plist ~/Library/LaunchAgents\nThen to load memcached now:\n    launchctl load ~/Library/LaunchAgents/homebrew.mxc\n```\n\n\u66f8\u3044\u3066\u3042\u308b\u901a\u308alaunchdCtl\u3067\u81ea\u52d5\u8d77\u52d5\u8a2d\u5b9a\n\n```\n$ ln -sfv /opt/boxen/homebrew/opt/memcached/*.plist ~/Library/LaunchAgents\n$ launchctl load ~/Library/LaunchAgents/homebrew.mxcl.memcached.plist\n```\n\n\u78ba\u8a8d\n\n```bash\n# \u30d7\u30ed\u30bb\u30b9\n$  ps axu | ag memcached\nfoo      84598   0.0  0.0  2464188    380   ??  S     9:16PM   0:00.06 /opt/boxen/homebrew/opt/memcached/bin/memcached -l localhost\n\n# \u7e4b\u3052\u308b\n$ telnet localhost 11211\nstats\n...\n\n```\n\nok\n\n\n## rails\u5074\u306b\u8a2d\u5b9a\n\nmemcache client\u306f[dalli](https://github.com/mperham/dalli)\u3092\u5229\u7528\u3057\u307e\u3059\n\n```bash\n$ vim Gemfile\ngem 'dalli'\n\n$ bundle\n```\n\n\u3068\u308a\u3042\u3048\u305adevelop\u30e2\u30fc\u30c9\u3067\u52d5\u304f\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\ncache\u3068session\u8a2d\u5b9a\u3092dalli\u7d4c\u7531\u306b\u5909\u66f4\n\n```ruby\n$ vim config/environment/development.rb\n\nAppName::Application.configure do\n  ...\n  config.cache_store = :dalli_store\n  ...\n\n$ vim config/initialize/session_store.rb\nFooRails::Application.config.session_store ActionDispatch::Session::CacheStore, key: '_foo_session', expire_after: 1.month\n```\n\nconsole\u3067cache\u30c6\u30b9\u30c8\n\n```ruby\n$ rails c\npry> Rails.cache.write 'foo', 'bar'\nCache write: foo\nDalli::Server#connect 127.0.0.1:11211\n=> 144115188075855872\n\npry> Rails.cache.read 'foo'\nCache read: foo\n=> \"bar\"\n```\n\nok\n\n## deploy\u5f8c\u306b\u518d\u63a5\u7d9a\n\n**dalli 2.0.4\u304b\u3089\u518d\u63a5\u7d9a\u306f\u4e0d\u8981\u3067\u3059**\n**https://github.com/petergoldstein/dalli/issues/208**\n\n[unicorn](https://github.com/defunkt/unicorn)\u306eafter fork\u6642\u306b\u3001memcached\u3068\u306e\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u3092\u5f35\u308a\u76f4\u3057\u307e\u3059\u3002\n\n```ruby\nafter_fork do |server,worker|\n  ...\n  if defined?(ActiveSupport::Cache::DalliStore) && Rails.cache.is_a?(ActiveSupport::Cache::DalliStore)\n    Rails.cache.reset\n    ObjectSpace.each_object(ActionDispatch::Session::DalliStore) { |obj| obj.reset }\n  end\n```\n\n## \u74b0\u5883\u5909\u6570\u306e\u5916\u3060\u3057\n\n\u6700\u7d42\u7684\u306b\u306fElasticCache\u3078\u306e\u63a5\u7d9a\u3057\u305f\u3044\u7269\u306e\u3001VM\u5185\u3067\u306e\u69cb\u7bc9\u8a66\u9a13\u3059\u308b\u305f\u3081\u306b\u308f\u3056\u308f\u3056EC2\u7d4c\u7531\u3059\u308b\u3068\u304b\u3057\u305f\u304f\u306a\u3044\u306e\u3067\u3001[dotenv gem](https://github.com/bkeepers/dotenv)\u3092\u5229\u7528\u3057\u3066\u8a2d\u5b9a\u3092\u5916\u90e8\u5316\u3057\u307e\u3059\u3002\n\n.evn\u8a2d\u5b9a\n\n```\n$ vim .env\n# nil is connecting to local memcached\nCACHE_STORE=nil\n \n```\n\n\u74b0\u5883\u5909\u6570\u5f15\u3063\u5f35\u308b\u69d8\u306b\u5909\u66f4\n\n```\n# develop\u304b\u3089\u5916\u3057\u3066\n$ vim config/environment/development.rb\n\n- AppName::Application.configure do\n-   ...\n-   config.cache_store = :dalli_store, ENV['CACHE_STORE']\n-   ...\n\n# production\u306e\u307f\u8ffd\u52a0\n$ vim config/environment/production.rb\n\nAppName::Application.configure do\n  ...\n  config.cache_store = :dalli_store, ENV['CACHE_STORE']\n```\n\n\u3053\u3093\u306a\u611f\u3058\u3067\u3002\n", "tags": ["Memcached", "Rails"]}