{"tags": ["GitHub", "shell", "Jenkins", "CI"], "context": "\n\n\u6982\u8981\ngithub\u3067push\u3055\u308c\u305f\u3089\u3001Job\u3092\u8d77\u52d5\u3057\u3066\u3001Push\u306e\u5185\u5bb9\u306b\u3088\u3063\u3066\u6b21\u306eJob\u306b\u7e4b\u3052\u308b\u51e6\u7406\u3092\u30b7\u30a7\u30eb\u3067\u66f8\u304d\u307e\u3059\u3002\n\u30b7\u30a7\u30eb\u3067\u66f8\u3044\u3066\u304a\u304f\u30e1\u30ea\u30c3\u30c8\u306f\u3001\u30b3\u30de\u30f3\u30c9\u30ec\u30d9\u30eb\u3067\u4f55\u3092\u3057\u3066\u3044\u308b\u306e\u304b\u304c\u7406\u89e3\u3067\u304d\u308b\u3053\u3068\u3067\u3057\u3087\u3046\u3002\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\njenkins\nhomebrew\u3067\u5165\u308c\u3066\u307e\u3059\u3002\n$ brew update\n$ brew cask install java\n$ brew install jenkins\n\n\u8a2d\u5b9a\u306f\u30cd\u30c3\u30c8\u3067\u63a2\u305b\u3070\u3059\u3050\u51fa\u3066\u304f\u308b\u306e\u3067\u5272\u611b\u3002\n\njq\n\u30b7\u30a7\u30eb\u3067json\u3092\u6271\u3046\u30c4\u30fc\u30eb\u3067\u3059\u3002github\u306epush\u3092\u89e3\u6790\u3059\u308b\u306e\u306b\u5229\u7528\u3057\u307e\u3059\u3002\n$ brew install jq\n\n\nGithub\nGithub API\u3092\u5229\u7528\u3059\u308b\u305f\u3081\u30c8\u30fc\u30af\u30f3\u3092\u767a\u884c\u3057\u307e\u3059\u3002\n\u30c8\u30fc\u30af\u30f3\u306f\u3001github\u306e\u30da\u30fc\u30b8\u3092\u53c2\u8003\u306b\u4f5c\u6210\u3057\u3066\u304f\u3060\u3055\u3044\u3002\npush\u3092jenkins\u306b\u77e5\u3089\u305b\u308b\u305f\u3081github\u306eWebHook\u3067\u8a2d\u5b9a\u3057\u307e\u3059\u3002\nAdd Service \u3067 Jenkins (GitHub plugin) \u3092\u9078\u629e\u3057\u307e\u3059\u3002\n\nJenkins hook url \u3067\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5165\u529b\u3057\u3066\u3001Active\u306b\u30c1\u30a7\u30c3\u30af\u3092\u5165\u308c\u3066\u304a\u304d\u307e\u3059\u3002\nhttp://<userid>:<password>@<\u30db\u30b9\u30c8\u540d>:8080/job//buildWithParameters\n\n\u60f3\u5b9a\u904b\u7528\nGit\u3067push\u3092\u3057\u305f\u3089\u3001\u30d6\u30e9\u30f3\u30c1\u3054\u3068\u306eJob\u3092\u547c\u3073\u51fa\u3057\u307e\u3059\u3002\nWIP\u306aPull Request\u3067\u904b\u7528\u3059\u308b\u306e\u3067\u3001feature\u30d6\u30e9\u30f3\u30c1\u3084bugfix\u30d6\u30e9\u30f3\u30c1\u306e\u5834\u5408\u306f\u3001\u3059\u3050\u306b\u30ec\u30d3\u30e5\u30fc\u3092\u3057\u3066\u6b32\u3057\u3044\u306e\u3067\u3001\u30c1\u30e3\u30c3\u30c8\u306b\u9001\u4fe1\u3057\u307e\u3059\u3002(\u4eca\u56de\u306fChatwork\u306b\u9001\u3063\u3066\u3044\u307e\u3059)\n\u3059\u3079\u3066\u306e\u30d6\u30e9\u30f3\u30c1\u3067\u5358\u4f53\u30c6\u30b9\u30c8\u3092\u52d5\u4f5c\u3055\u305b\u308bJob\u3092\u547c\u3073\u307e\u3059\u3002\n\nJob\n\nJenkins\u306eGUI\u8a2d\u5b9a\n\u307e\u305a\u306f\u3001GUI\u4e0a\u3067\u8a18\u8ff0\u3057\u307e\u3059\n\n\u30d3\u30eb\u30c9\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u5316\u306b\u30c1\u30a7\u30c3\u30af\u3092\u5165\u308c\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\n\n\n\u30d3\u30eb\u30c9\u306e\u30b7\u30a7\u30eb\u306e\u5b9f\u884c\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n\u6700\u521d\u306eif\u6587\u3067\u3001branch\u3092\u524a\u9664\u3057\u305f\u5834\u5408\u3084\u30d7\u30ed\u30b0\u30e9\u30e0\u306b\u3088\u3063\u3066push\u3055\u308c\u3066\u304d\u305f(github-bot-user\u306f\u30d7\u30ed\u30b0\u30e9\u30e0\u3067push\u3059\u308b\u3068\u304d\u306b\u5229\u7528\u3057\u3066\u3044\u308b\u30e6\u30fc\u30b6)\u5834\u5408\u306f\u7121\u8996\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\u30d6\u30e9\u30f3\u30c1\u304creview \u3068 release\u306e\u5834\u5408\u306b\u30d3\u30eb\u30c9\u3057\u3066Fabric\u3067\u8ee2\u9001\u3059\u308bJob\u3092\u547c\u3073\u307e\u3059\u3002\uff08\u4ed6\u306e\u8a18\u4e8b\u3092\u53c2\u7167\uff09\n\u307e\u305f\u3001feature.* \u3084 bugfix.* \u30d6\u30e9\u30f3\u30c1\u306e\u5834\u5408\u306f\u3001\u30c1\u30e3\u30c3\u30c8\u3067\u77e5\u3089\u305b\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\u3042\u3068\u306f\u3001\u5358\u4f53\u30c6\u30b9\u30c8\u7528\u306eJob\u3092\u547c\u3073\u51fa\u3057\u3066\u3044\u307e\u3059\u3002\uff08\u4ed6\u306e\u8a18\u4e8b\u3092\u53c2\u7167\uff09\n#!/bin/bash -l\n\nset -eux\n\nchatworkToken=XXXXXXXXXX\n\ndeleted=`echo $payload | jq -r '.deleted'`\nauthor=`echo $payload | jq -r '.head_commit.author.name'`\n\nif  [[ $deleted != \"true\" ]] && [[ $author != \"github-bot-user\" ]]; then\n\n  GIT_BRANCH=`echo $payload | jq -r '.ref' | sed \"s/refs\\/heads\\///\"`\n\n  if  [[ $GIT_BRANCH =~ review.* ]]; then\n\n    curl -X POST \"http://<\u30db\u30b9\u30c8\u540d>:8080/job/<Fabric\u8ee2\u9001\u3059\u308bJOB\u540d>/buildWithParameters?server=develop&branch=${GIT_BRANCH}\"\n\n  elif [[ $GIT_BRANCH =~ release.* ]]; then\n\n    curl -X POST \"http://<\u30db\u30b9\u30c8\u540d>:8080/job/<Fabric\u8ee2\u9001\u3059\u308bJOB\u540d>/buildWithParameters?server=staging&branch=${GIT_BRANCH}\"\n\n  elif [[ $GIT_BRANCH =~ (feature|bugfix).* ]]; then\n    pusher=`echo $payload | jq -r '.pusher.name'`\n    curl -X POST -H \"X-ChatWorkToken: ${chatworkToken}\" -d \"body=${pusher}\u304c${GIT_BRANCH}\u306bPush\u3057\u305f\u306e\u3067\u30ec\u30d3\u30e5\u30fc\u3057\u3066\u3002\" \"https://api.chatwork.com/v1/rooms/\uff1c\u30eb\u30fc\u30e0ID\uff1e/messages\"\n\n  fi\n\n  curl -X POST \"http://<\u30db\u30b9\u30c8\u540d>:8080/job/<\u5358\u4f53\u30c6\u30b9\u30c8\u306eJOB\u540d>/buildWithParameters?branch=${GIT_BRANCH}\"\n\nfi\n\n\n# \u6982\u8981\n\ngithub\u3067push\u3055\u308c\u305f\u3089\u3001Job\u3092\u8d77\u52d5\u3057\u3066\u3001Push\u306e\u5185\u5bb9\u306b\u3088\u3063\u3066\u6b21\u306eJob\u306b\u7e4b\u3052\u308b\u51e6\u7406\u3092\u30b7\u30a7\u30eb\u3067\u66f8\u304d\u307e\u3059\u3002\n\n\u30b7\u30a7\u30eb\u3067\u66f8\u3044\u3066\u304a\u304f\u30e1\u30ea\u30c3\u30c8\u306f\u3001\u30b3\u30de\u30f3\u30c9\u30ec\u30d9\u30eb\u3067\u4f55\u3092\u3057\u3066\u3044\u308b\u306e\u304b\u304c\u7406\u89e3\u3067\u304d\u308b\u3053\u3068\u3067\u3057\u3087\u3046\u3002\n\n# \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n## jenkins\n\nhomebrew\u3067\u5165\u308c\u3066\u307e\u3059\u3002\n\n```\n$ brew update\n$ brew cask install java\n$ brew install jenkins\n```\n\n\u8a2d\u5b9a\u306f\u30cd\u30c3\u30c8\u3067\u63a2\u305b\u3070\u3059\u3050\u51fa\u3066\u304f\u308b\u306e\u3067\u5272\u611b\u3002\n\n## jq\n\n\u30b7\u30a7\u30eb\u3067json\u3092\u6271\u3046\u30c4\u30fc\u30eb\u3067\u3059\u3002github\u306epush\u3092\u89e3\u6790\u3059\u308b\u306e\u306b\u5229\u7528\u3057\u307e\u3059\u3002\n\n```\n$ brew install jq\n```\n\n# Github\n\nGithub API\u3092\u5229\u7528\u3059\u308b\u305f\u3081\u30c8\u30fc\u30af\u30f3\u3092\u767a\u884c\u3057\u307e\u3059\u3002\n\u30c8\u30fc\u30af\u30f3\u306f\u3001[github\u306e\u30da\u30fc\u30b8](https://help.github.com/articles/creating-an-access-token-for-command-line-use/)\u3092\u53c2\u8003\u306b\u4f5c\u6210\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\npush\u3092jenkins\u306b\u77e5\u3089\u305b\u308b\u305f\u3081github\u306eWebHook\u3067\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n```Add Service``` \u3067 ```Jenkins (GitHub plugin)``` \u3092\u9078\u629e\u3057\u307e\u3059\u3002\n\n![github-webhook.png](https://qiita-image-store.s3.amazonaws.com/0/10494/f8c52f88-5235-d9cf-e0ad-a70f062d2a8c.png \"github-webhook.png\")\n\n\n\n```Jenkins hook url``` \u3067\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5165\u529b\u3057\u3066\u3001Active\u306b\u30c1\u30a7\u30c3\u30af\u3092\u5165\u308c\u3066\u304a\u304d\u307e\u3059\u3002\n\nhttp://\\<userid\\>:\\<password\\>@\\<\u30db\u30b9\u30c8\u540d\\>:8080/job/<JOB\u540d>/buildWithParameters\n\n# \u60f3\u5b9a\u904b\u7528\n\nGit\u3067push\u3092\u3057\u305f\u3089\u3001\u30d6\u30e9\u30f3\u30c1\u3054\u3068\u306eJob\u3092\u547c\u3073\u51fa\u3057\u307e\u3059\u3002\nWIP\u306aPull Request\u3067\u904b\u7528\u3059\u308b\u306e\u3067\u3001feature\u30d6\u30e9\u30f3\u30c1\u3084bugfix\u30d6\u30e9\u30f3\u30c1\u306e\u5834\u5408\u306f\u3001\u3059\u3050\u306b\u30ec\u30d3\u30e5\u30fc\u3092\u3057\u3066\u6b32\u3057\u3044\u306e\u3067\u3001\u30c1\u30e3\u30c3\u30c8\u306b\u9001\u4fe1\u3057\u307e\u3059\u3002(\u4eca\u56de\u306fChatwork\u306b\u9001\u3063\u3066\u3044\u307e\u3059)\n\u3059\u3079\u3066\u306e\u30d6\u30e9\u30f3\u30c1\u3067\u5358\u4f53\u30c6\u30b9\u30c8\u3092\u52d5\u4f5c\u3055\u305b\u308bJob\u3092\u547c\u3073\u307e\u3059\u3002\n\n# Job\n\n## Jenkins\u306eGUI\u8a2d\u5b9a\n\n\u307e\u305a\u306f\u3001GUI\u4e0a\u3067\u8a18\u8ff0\u3057\u307e\u3059\n\n* \u30d3\u30eb\u30c9\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u5316\u306b\u30c1\u30a7\u30c3\u30af\u3092\u5165\u308c\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\n![github-parameter.png](https://qiita-image-store.s3.amazonaws.com/0/10494/9250e258-4a6b-e75b-e12e-46321cf160fc.png \"github-parameter.png\")\n\n* \u30d3\u30eb\u30c9\u306e\u30b7\u30a7\u30eb\u306e\u5b9f\u884c\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n\u6700\u521d\u306eif\u6587\u3067\u3001branch\u3092\u524a\u9664\u3057\u305f\u5834\u5408\u3084\u30d7\u30ed\u30b0\u30e9\u30e0\u306b\u3088\u3063\u3066push\u3055\u308c\u3066\u304d\u305f(github-bot-user\u306f\u30d7\u30ed\u30b0\u30e9\u30e0\u3067push\u3059\u308b\u3068\u304d\u306b\u5229\u7528\u3057\u3066\u3044\u308b\u30e6\u30fc\u30b6)\u5834\u5408\u306f\u7121\u8996\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\u30d6\u30e9\u30f3\u30c1\u304c```review``` \u3068 ```release```\u306e\u5834\u5408\u306b\u30d3\u30eb\u30c9\u3057\u3066Fabric\u3067\u8ee2\u9001\u3059\u308bJob\u3092\u547c\u3073\u307e\u3059\u3002\uff08[\u4ed6\u306e\u8a18\u4e8b\u3092\u53c2\u7167](http://qiita.com/ko2ic/items/86c66766e94551d4c726)\uff09\n\u307e\u305f\u3001```feature.*``` \u3084 ```bugfix.*``` \u30d6\u30e9\u30f3\u30c1\u306e\u5834\u5408\u306f\u3001\u30c1\u30e3\u30c3\u30c8\u3067\u77e5\u3089\u305b\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\u3042\u3068\u306f\u3001\u5358\u4f53\u30c6\u30b9\u30c8\u7528\u306eJob\u3092\u547c\u3073\u51fa\u3057\u3066\u3044\u307e\u3059\u3002\uff08\u4ed6\u306e\u8a18\u4e8b\u3092\u53c2\u7167\uff09\n\n\n\n```\n#!/bin/bash -l\n\nset -eux\n\nchatworkToken=XXXXXXXXXX\n\ndeleted=`echo $payload | jq -r '.deleted'`\nauthor=`echo $payload | jq -r '.head_commit.author.name'`\n\nif  [[ $deleted != \"true\" ]] && [[ $author != \"github-bot-user\" ]]; then\n\n  GIT_BRANCH=`echo $payload | jq -r '.ref' | sed \"s/refs\\/heads\\///\"`\n\n  if  [[ $GIT_BRANCH =~ review.* ]]; then\n\n    curl -X POST \"http://<\u30db\u30b9\u30c8\u540d>:8080/job/<Fabric\u8ee2\u9001\u3059\u308bJOB\u540d>/buildWithParameters?server=develop&branch=${GIT_BRANCH}\"\n\n  elif [[ $GIT_BRANCH =~ release.* ]]; then\n\n    curl -X POST \"http://<\u30db\u30b9\u30c8\u540d>:8080/job/<Fabric\u8ee2\u9001\u3059\u308bJOB\u540d>/buildWithParameters?server=staging&branch=${GIT_BRANCH}\"\n\n  elif [[ $GIT_BRANCH =~ (feature|bugfix).* ]]; then\n    pusher=`echo $payload | jq -r '.pusher.name'`\n    curl -X POST -H \"X-ChatWorkToken: ${chatworkToken}\" -d \"body=${pusher}\u304c${GIT_BRANCH}\u306bPush\u3057\u305f\u306e\u3067\u30ec\u30d3\u30e5\u30fc\u3057\u3066\u3002\" \"https://api.chatwork.com/v1/rooms/\uff1c\u30eb\u30fc\u30e0ID\uff1e/messages\"\n\n  fi\n\n  curl -X POST \"http://<\u30db\u30b9\u30c8\u540d>:8080/job/<\u5358\u4f53\u30c6\u30b9\u30c8\u306eJOB\u540d>/buildWithParameters?branch=${GIT_BRANCH}\"\n\nfi\n```\n"}