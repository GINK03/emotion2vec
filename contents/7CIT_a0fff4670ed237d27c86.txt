{"context": "\u3053\u3061\u3089\u306e\u8a18\u4e8b\u3092\u53c2\u8003\u306b\u3055\u305b\u3066\u9802\u304d\u8a2d\u5b9a\u3057\u305f\u304c\u3001ALB\u306e\u5834\u5408\u3046\u307e\u304f\u884c\u304b\u306a\u304b\u3063\u305f\u306e\u3067\u3001\u3084\u308a\u65b9\u3092\u8a18\u8f09\n\nLet's Encrypt \u8a3c\u660e\u66f8\u306e\u81ea\u52d5\u767a\u884c\u3068ELB\u81ea\u52d5\u767b\u9332\u3092\u884c\u3063\u305f\u30ed\u30b0\n\n\n\u30dd\u30a4\u30f3\u30c8\u306f\u3001ALB\u306fELB\u306eAPI\u3068\u306f\u7570\u306a\u308a\u3001\u3055\u3089\u306b\u30d1\u30e9\u30e1\u30fc\u30bf\u30fc\u304c\u9055\u3046\u3068\u3044\u3046\u3053\u3068\u3002\n\u305d\u308c\u306b\u3088\u308a\u3001\u4ee5\u4e0b\u306e\u9055\u3044\u304c\u3042\u308b\n\nALB\u306faws elb \u2192 aws elbv2\n\u5bfe\u8c61\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u306e\u6307\u5b9a\u65b9\u6cd5\u304c\u3001ELB_NAME\u3067\u306e\u6307\u5b9a\u3067\u306f\u306a\u304fLISTNER_ARN\u306b\u306a\u3063\u305f\u3001SSL\u30dd\u30fc\u30c8\u306e\u65b9\u3092\u6307\u5b9a\n\u30e1\u30bd\u30c3\u30c9\u3082aws elb set-load-balancer-listener-ssl-certificate\u304b\u3089aws elbv2 modify-listener\u3078\n\u306f\u307e\u308a\u30dd\u30a4\u30f3\u30c8\u3068\u3057\u3066\u306f\u4e00\u5fdcaws elb describe-load-balancers\u3067\u3082ALB\u306e\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u3082\u30ea\u30b9\u30c8\u306b\u51fa\u3066\u6765\u308b\u304celb set-load-balancer-listener-ssl-certificate\u3092\u5b9f\u884c\u3059\u308b\u3068\u3001\u305d\u3093\u306a\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u306f\u5b58\u5728\u3057\u306a\u3044\u3068\u8a00\u308f\u308c\u3066\u3057\u307e\u3046\u3002\n\n\nAWS CLI elbv2(ALB) modify-listener \u306e API\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u306f\u3053\u3061\u3089\n\nmodify-listener\n\n\nSSL\u8a3c\u660e\u66f8\u81ea\u52d5\u66f4\u65b0\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u5909\u66f4\u70b9\n\u3053\u306e\u90e8\u5206\u3092\n# ELB \u306b\u65b0\u3057\u3044\u30b5\u30fc\u30d0\u30fc\u8a3c\u660e\u66f8\u3092\u8a2d\u5b9a\n$EXEC_AWS elb set-load-balancer-listener-ssl-certificate \\\n  --load-balancer-name $ELB_NAME \\\n  --load-balancer-port 443 \\\n  --ssl-certificate-id $SERVER_CERT_ARN\n\n\u2193\n# ELB \u306b\u65b0\u3057\u3044\u30b5\u30fc\u30d0\u30fc\u8a3c\u660e\u66f8\u3092\u8a2d\u5b9a\n$EXEC_AWS elbv2 modify-listener \\\n  --listener-arn $LISTNER_ARN \\\n  --port 443 \\\n  --protocol HTTPS \\\n  --certificates CertificateArn=$SERVER_CERT_ARN\n\n\u306b\u5909\u66f4\n\nSSL\u8a3c\u660e\u66f8\u81ea\u52d5\u66f4\u65b0\u30b9\u30af\u30ea\u30d7\u30c8\u5168\u4f53\n#!/bin/bash\nset -e\ncd $(dirname $0)\n\n# \u73fe\u5728\u65e5\u4ed8\u306eYYYYMMDD\nDATE_CURRENT_YMD=$(date '+%Y%m%d')\n\n# AWS Profile \u540d\nAWS_PROFILE=elb_update_cert\n\n# \u72ec\u81ea\u30c9\u30e1\u30a4\u30f3\nDOMAINS=(\n  \"example.com\"\n)\n\n# IAM \u4e0a\u306e\u30b5\u30fc\u30d0\u30fc\u8a3c\u660e\u66f8\u540d\u3002\u5f8c\u308d\u306b \"-\" + $DATE_CURRENT_YMD \u304c\u4ed8\u304f\u3002\nCERT_NAME=\"letsencrypt-cert\"\n\n# \u5bfe\u8c61 ELB \u306e\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fcARN\nLISTNER_ARN=\"arn:aws:elasticloadbalancing:ap-northeast-1:xxxxxxxxxxxxxxxx\"\n\n# aws-cli \u5b9f\u884c\u30b3\u30de\u30f3\u30c9\nEXEC_AWS=\"aws --profile elb_update_cert\"\n\n# Let's Encrypt \u306e\u9023\u7d61\u7528\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\nLE_EMAIL=info@example.com\n\n# Let's Encrypt Client \u3092 clone \u3057\u305f\u30d1\u30b9\nLE_HOME=/usr/local/certbot\n\n# letsencrypt-auto \u5b9f\u884c\u30b3\u30de\u30f3\u30c9\nEXEC_LE_AUTO=\"${LE_HOME}/cert-auto --email $LE_EMAIL --agree-tos\"\n\n# \u53d6\u5f97\u3057\u305f\u8a3c\u660e\u66f8\u30d5\u30a1\u30a4\u30eb\u306e\u30ea\u30f3\u30af\u7fa4\u304c\u914d\u7f6e\u3055\u308c\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\n# letsencrypt-auto \u306b\u4e0e\u3048\u305f\u6700\u521d\u306e\u30c9\u30e1\u30a4\u30f3\u540d\u304c\u63a1\u7528\u3055\u308c\u308b\nLE_FILES_ROOT=/etc/letsencrypt/live/${DOMAINS[0]}\n\n# \u8a3c\u660e\u66f8\u30d5\u30a1\u30a4\u30eb\u7fa4\u306e\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u306e\u30d1\u30b9\nCERT_PATH=$LE_FILES_ROOT/cert.pem\nCHAIN_PATH=$LE_FILES_ROOT/chain.pem\nFULLCHAIN_PATH=$LE_FILES_ROOT/fullchain.pem\nPRIVKEY_PATH=$LE_FILES_ROOT/privkey.pem\n\n# DOMAINS \u3092 \"-d\" \u3068\u30da\u30a2\u3067\u7e4b\u3052\u305f\u30d1\u30e9\u30e1\u30fc\u30bf (-d \"yourdomain.com\" -d \"www1.yourdomain.com\" ... )\nLE_PARAM_DOMAINS=()\nfor domain in \"${DOMAINS[@]}\"; do\n  LE_PARAM_DOMAINS+=(\"-d\" \"$domain\")\ndone\nLE_PARAM_DOMAINS=\"${LE_PARAM_DOMAINS[@]}\"\n\n# \u8a3c\u660e\u66f8\u3092(\u518d)\u767a\u884c\u3002\n$EXEC_LE_AUTO certonly --webroot \\\n    --renew-by-default \\\n    -w /var/www/letsencrypt \\\n    $LE_PARAM_DOMAINS\n\n# \u73fe\u6642\u70b9\u306e\u30b5\u30fc\u30d0\u30fc\u8a3c\u660e\u66f8\u540d\u30ea\u30b9\u30c8\u3092\u53d6\u5f97\nOLD_SERVER_CERT_NAMES=$($EXEC_AWS iam list-server-certificates | jq -r \".ServerCertificateMetadataList[] | select(.ServerCertificateName | contains(\\\"${CERT_NAME}\\\")).ServerCertificateName\")\n\n# \u65b0\u3057\u3044\u8a3c\u660e\u66f8\u306e\u30b5\u30fc\u30d0\u30fc\u8a3c\u660e\u66f8\u540d\nNEW_SERVER_CERT_NAME=\"${CERT_NAME}-${DATE_CURRENT_YMD}\"\n\n# \u65b0\u3057\u3044\u8a3c\u660e\u66f8\u3092 IAM \u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\n$EXEC_AWS iam upload-server-certificate --server-certificate-name $NEW_SERVER_CERT_NAME \\\n  --certificate-body file://$CERT_PATH \\\n  --private-key file://$PRIVKEY_PATH \\\n  --certificate-chain file://$CHAIN_PATH\n\n# \u53cd\u6620\u3092\u5f85\u3064\nsleep 15\n\n# \u65b0\u3057\u3044\u8a3c\u660e\u66f8\u306e ARN \u3092\u53d6\u5f97\nSERVER_CERT_ARN=$($EXEC_AWS iam list-server-certificates | jq -r \".ServerCertificateMetadataList[] | select(.ServerCertificateName == \\\"${NEW_SERVER_CERT_NAME}\\\").Arn\")\n\n# ELB \u306b\u65b0\u3057\u3044\u30b5\u30fc\u30d0\u30fc\u8a3c\u660e\u66f8\u3092\u8a2d\u5b9a\n$EXEC_AWS elbv2 modify-listener \\\n  --listener-arn $LISTNER_ARN \\\n  --port 443 \\\n  --protocol HTTPS \\\n  --certificates CertificateArn=$SERVER_CERT_ARN\n\n# \u53cd\u6620\u3092\u5f85\u3064\nsleep 15\n\n# \u53e4\u3044\u8a3c\u660e\u66f8\u3092\u524a\u9664\nfor cert_name in $OLD_SERVER_CERT_NAMES; do\n  $EXEC_AWS iam delete-server-certificate --server-certificate-name $cert_name\ndone\n\n\u3053\u3061\u3089\u306e\u8a18\u4e8b\u3092\u53c2\u8003\u306b\u3055\u305b\u3066\u9802\u304d\u8a2d\u5b9a\u3057\u305f\u304c\u3001ALB\u306e\u5834\u5408\u3046\u307e\u304f\u884c\u304b\u306a\u304b\u3063\u305f\u306e\u3067\u3001\u3084\u308a\u65b9\u3092\u8a18\u8f09\n\n* [Let's Encrypt \u8a3c\u660e\u66f8\u306e\u81ea\u52d5\u767a\u884c\u3068ELB\u81ea\u52d5\u767b\u9332\u3092\u884c\u3063\u305f\u30ed\u30b0\n](http://qiita.com/hidekuro/items/482520f220a305dc147b)\n\n\u30dd\u30a4\u30f3\u30c8\u306f\u3001ALB\u306fELB\u306eAPI\u3068\u306f\u7570\u306a\u308a\u3001\u3055\u3089\u306b\u30d1\u30e9\u30e1\u30fc\u30bf\u30fc\u304c\u9055\u3046\u3068\u3044\u3046\u3053\u3068\u3002\n\u305d\u308c\u306b\u3088\u308a\u3001\u4ee5\u4e0b\u306e\u9055\u3044\u304c\u3042\u308b\n\n* ALB\u306faws elb \u2192 aws elbv2\n* \u5bfe\u8c61\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u306e\u6307\u5b9a\u65b9\u6cd5\u304c\u3001ELB_NAME\u3067\u306e\u6307\u5b9a\u3067\u306f\u306a\u304fLISTNER_ARN\u306b\u306a\u3063\u305f\u3001SSL\u30dd\u30fc\u30c8\u306e\u65b9\u3092\u6307\u5b9a\n* \u30e1\u30bd\u30c3\u30c9\u3082aws elb set-load-balancer-listener-ssl-certificate\u304b\u3089aws elbv2 modify-listener\u3078\n* \u306f\u307e\u308a\u30dd\u30a4\u30f3\u30c8\u3068\u3057\u3066\u306f\u4e00\u5fdcaws elb describe-load-balancers\u3067\u3082ALB\u306e\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u3082\u30ea\u30b9\u30c8\u306b\u51fa\u3066\u6765\u308b\u304celb set-load-balancer-listener-ssl-certificate\u3092\u5b9f\u884c\u3059\u308b\u3068\u3001\u305d\u3093\u306a\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u306f\u5b58\u5728\u3057\u306a\u3044\u3068\u8a00\u308f\u308c\u3066\u3057\u307e\u3046\u3002\n\n# AWS CLI elbv2(ALB) modify-listener \u306e API\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u306f\u3053\u3061\u3089\n  * [modify-listener](http://docs.aws.amazon.com/cli/latest/reference/elbv2/modify-listener.html)\n\n# SSL\u8a3c\u660e\u66f8\u81ea\u52d5\u66f4\u65b0\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u5909\u66f4\u70b9\n\n\u3053\u306e\u90e8\u5206\u3092\n\n```bash\n# ELB \u306b\u65b0\u3057\u3044\u30b5\u30fc\u30d0\u30fc\u8a3c\u660e\u66f8\u3092\u8a2d\u5b9a\n$EXEC_AWS elb set-load-balancer-listener-ssl-certificate \\\n  --load-balancer-name $ELB_NAME \\\n  --load-balancer-port 443 \\\n  --ssl-certificate-id $SERVER_CERT_ARN\n```\n\n\u2193\n\n```bash\n# ELB \u306b\u65b0\u3057\u3044\u30b5\u30fc\u30d0\u30fc\u8a3c\u660e\u66f8\u3092\u8a2d\u5b9a\n$EXEC_AWS elbv2 modify-listener \\\n  --listener-arn $LISTNER_ARN \\\n  --port 443 \\\n  --protocol HTTPS \\\n  --certificates CertificateArn=$SERVER_CERT_ARN\n```\n\n\u306b\u5909\u66f4\n\n# SSL\u8a3c\u660e\u66f8\u81ea\u52d5\u66f4\u65b0\u30b9\u30af\u30ea\u30d7\u30c8\u5168\u4f53\n\n```bash\n#!/bin/bash\nset -e\ncd $(dirname $0)\n\n# \u73fe\u5728\u65e5\u4ed8\u306eYYYYMMDD\nDATE_CURRENT_YMD=$(date '+%Y%m%d')\n\n# AWS Profile \u540d\nAWS_PROFILE=elb_update_cert\n\n# \u72ec\u81ea\u30c9\u30e1\u30a4\u30f3\nDOMAINS=(\n  \"example.com\"\n)\n\n# IAM \u4e0a\u306e\u30b5\u30fc\u30d0\u30fc\u8a3c\u660e\u66f8\u540d\u3002\u5f8c\u308d\u306b \"-\" + $DATE_CURRENT_YMD \u304c\u4ed8\u304f\u3002\nCERT_NAME=\"letsencrypt-cert\"\n\n# \u5bfe\u8c61 ELB \u306e\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fcARN\nLISTNER_ARN=\"arn:aws:elasticloadbalancing:ap-northeast-1:xxxxxxxxxxxxxxxx\"\n\n# aws-cli \u5b9f\u884c\u30b3\u30de\u30f3\u30c9\nEXEC_AWS=\"aws --profile elb_update_cert\"\n\n# Let's Encrypt \u306e\u9023\u7d61\u7528\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\nLE_EMAIL=info@example.com\n\n# Let's Encrypt Client \u3092 clone \u3057\u305f\u30d1\u30b9\nLE_HOME=/usr/local/certbot\n\n# letsencrypt-auto \u5b9f\u884c\u30b3\u30de\u30f3\u30c9\nEXEC_LE_AUTO=\"${LE_HOME}/cert-auto --email $LE_EMAIL --agree-tos\"\n\n# \u53d6\u5f97\u3057\u305f\u8a3c\u660e\u66f8\u30d5\u30a1\u30a4\u30eb\u306e\u30ea\u30f3\u30af\u7fa4\u304c\u914d\u7f6e\u3055\u308c\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\n# letsencrypt-auto \u306b\u4e0e\u3048\u305f\u6700\u521d\u306e\u30c9\u30e1\u30a4\u30f3\u540d\u304c\u63a1\u7528\u3055\u308c\u308b\nLE_FILES_ROOT=/etc/letsencrypt/live/${DOMAINS[0]}\n\n# \u8a3c\u660e\u66f8\u30d5\u30a1\u30a4\u30eb\u7fa4\u306e\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u306e\u30d1\u30b9\nCERT_PATH=$LE_FILES_ROOT/cert.pem\nCHAIN_PATH=$LE_FILES_ROOT/chain.pem\nFULLCHAIN_PATH=$LE_FILES_ROOT/fullchain.pem\nPRIVKEY_PATH=$LE_FILES_ROOT/privkey.pem\n\n# DOMAINS \u3092 \"-d\" \u3068\u30da\u30a2\u3067\u7e4b\u3052\u305f\u30d1\u30e9\u30e1\u30fc\u30bf (-d \"yourdomain.com\" -d \"www1.yourdomain.com\" ... )\nLE_PARAM_DOMAINS=()\nfor domain in \"${DOMAINS[@]}\"; do\n  LE_PARAM_DOMAINS+=(\"-d\" \"$domain\")\ndone\nLE_PARAM_DOMAINS=\"${LE_PARAM_DOMAINS[@]}\"\n\n# \u8a3c\u660e\u66f8\u3092(\u518d)\u767a\u884c\u3002\n$EXEC_LE_AUTO certonly --webroot \\\n    --renew-by-default \\\n    -w /var/www/letsencrypt \\\n    $LE_PARAM_DOMAINS\n\n# \u73fe\u6642\u70b9\u306e\u30b5\u30fc\u30d0\u30fc\u8a3c\u660e\u66f8\u540d\u30ea\u30b9\u30c8\u3092\u53d6\u5f97\nOLD_SERVER_CERT_NAMES=$($EXEC_AWS iam list-server-certificates | jq -r \".ServerCertificateMetadataList[] | select(.ServerCertificateName | contains(\\\"${CERT_NAME}\\\")).ServerCertificateName\")\n\n# \u65b0\u3057\u3044\u8a3c\u660e\u66f8\u306e\u30b5\u30fc\u30d0\u30fc\u8a3c\u660e\u66f8\u540d\nNEW_SERVER_CERT_NAME=\"${CERT_NAME}-${DATE_CURRENT_YMD}\"\n\n# \u65b0\u3057\u3044\u8a3c\u660e\u66f8\u3092 IAM \u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\n$EXEC_AWS iam upload-server-certificate --server-certificate-name $NEW_SERVER_CERT_NAME \\\n  --certificate-body file://$CERT_PATH \\\n  --private-key file://$PRIVKEY_PATH \\\n  --certificate-chain file://$CHAIN_PATH\n\n# \u53cd\u6620\u3092\u5f85\u3064\nsleep 15\n\n# \u65b0\u3057\u3044\u8a3c\u660e\u66f8\u306e ARN \u3092\u53d6\u5f97\nSERVER_CERT_ARN=$($EXEC_AWS iam list-server-certificates | jq -r \".ServerCertificateMetadataList[] | select(.ServerCertificateName == \\\"${NEW_SERVER_CERT_NAME}\\\").Arn\")\n\n# ELB \u306b\u65b0\u3057\u3044\u30b5\u30fc\u30d0\u30fc\u8a3c\u660e\u66f8\u3092\u8a2d\u5b9a\n$EXEC_AWS elbv2 modify-listener \\\n  --listener-arn $LISTNER_ARN \\\n  --port 443 \\\n  --protocol HTTPS \\\n  --certificates CertificateArn=$SERVER_CERT_ARN\n\n# \u53cd\u6620\u3092\u5f85\u3064\nsleep 15\n\n# \u53e4\u3044\u8a3c\u660e\u66f8\u3092\u524a\u9664\nfor cert_name in $OLD_SERVER_CERT_NAMES; do\n  $EXEC_AWS iam delete-server-certificate --server-certificate-name $cert_name\ndone\n```\n\n", "tags": ["AWS", "letsencrypt", "ALB"]}