{"context": " More than 1 year has passed since last update.\u4eca\u56de\u306fRails\u30a2\u30d7\u30eaawesome_events\uff08\u66f8\u7c4d\"\u30d1\u30fc\u30d5\u30a7\u30af\u30c8Ruby on Rails\"\u3067\u5199\u7d4c\u3057\u305f\u3084\u3064\uff09\u3092Cloudn\u4e0a\u3067\u52d5\u304b\u3059\u3088\u3046\u306b\u3057\u307e\u3059\u3002\ncapistrano\u8a2d\u5b9a\u306b\u3064\u3044\u3066\u306fQiita\u8a18\u4e8b\u3092\u53c2\u8003\u306b\u69cb\u7bc9\u3057\u307e\u3057\u305f\u304c\u3001\u3064\u307e\u3063\u305f\u3068\u3053\u308d\u304c\u3042\u308b\u306e\u3067\u81ea\u5206\u30e1\u30e2\u3068\u3057\u3066\u6574\u7406\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\u53c2\u8003\uff1a\n\nunicorn + rails \u7528 Capistrano 3 \u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\nCapistrano3\u3067rails\u3092deploy\u3057\u3066\u307f\u308b\n\n\nCloudn\u4e0a\u3067Rails\u304c\u52d5\u304f\u74b0\u5883\u3092\u69cb\u7bc9\n\nCloudn\u4e0a\u306b\u65b0\u3057\u3044\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7testapp\u3092\u4f5c\u6210\n1.\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306e\"\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\u306e\u8ffd\u52a0\"\u304b\u3089\u65b0\u3057\u3044\u30b0\u30eb\u30fc\u30d7testapp\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n2.testapp\u3092\u958b\u304d\u3001\u6b21\u306e\u30dd\u30fc\u30c8\u8a2d\u5b9a\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\u53d7\u4fe1\u898f\u5247\u306bport:22 0.0.0.0./0\n\u53d7\u4fe1\u898f\u5247\u306bport:443 0.0.0.0./0\n\u53d7\u4fe1\u898f\u5247\u306bport:80 0.0.0.0./0\n\u7406\u7531\u306f\u308f\u304b\u3063\u3066\u307e\u305b\u3093\u304c\u3001\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\u306e\u72b6\u614b\u306b\u3088\u3063\u3066\u306f\u3001\u521d\u671f\u30d1\u30b9\u30ef\u30fc\u30c9\u3067\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u3002\n\uff08Permission denied, please try again.\u3068\u8868\u793a\u3055\u308c\u307e\u3057\u305f\uff09\n\u65b0\u898f\u3067\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\u3092\u4f5c\u308c\u3070\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u307e\u3057\u305f\u3002\n\nCloudn\u4e0a\u306b\u65b0\u3057\u3044\u4eee\u60f3\u30b5\u30fc\u30d0\u30fctestapp\u3092\u4f5c\u6210\n1.\"\u4eee\u60f3\u30b5\u30fc\u30d0\u30fc\u306e\u8ffd\u52a0\"\u304b\u3089\u65b0\u3057\u3044\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\nISO \u307e\u305f\u306f\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306e\u9078\u629e:\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\n\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\uff1aUbuntu Server v14.04 64bit\n\u4eee\u60f3\u30b5\u30fc\u30d0\u30fc\u30d7\u30e9\u30f3\uff1at1.micro\n\u30c7\u30fc\u30bf\u30c7\u30a3\u30b9\u30af\uff1a\u8a2d\u5b9a\u3057\u306a\u3044\n\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\uff1atestapp\n\u540d\u524d\uff1atestapp\n\n2.\u521d\u671f\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u30e1\u30e2\u3057\u307e\u3059\u3002\n1\u3067\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3068\u3001\u6700\u5f8c\u306b\u30c0\u30a4\u30a2\u30ed\u30b0\u304c\u8868\u793a\u3055\u308c\u3001\u521d\u671f\u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u8868\u793a\u3055\u308c\u307e\u3059\u3002\n\u305d\u308c\u3092\u30e1\u30e2\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n3.\u4eee\u60f3\u30b5\u30fc\u30d0\u30fc\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u307e\u3059\u3002\n\u4eee\u60f3\u30b5\u30fc\u30d0\u30fc\u4e00\u89a7\u304b\u3089\u4f5c\u6210\u3057\u305ftestapp\u3092\u9078\u629e\u3057\u3001NIC\u30bf\u30d6\u304b\u3089IP\u30a2\u30c9\u30ec\u30b9\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\u305d\u306e\u30a2\u30c9\u30ec\u30b9\u306b\u5bfe\u3057ssh\u3067\u30ed\u30b0\u30a4\u30f3\u3057\u307e\u3059\u3002\uff08Ubuntu\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u521d\u671f\u30e6\u30fc\u30b6\u30fc\u306fubuntu\uff09\nssh ubuntu@xxx.xxx.xxx.xxx\n\u30d1\u30b9\u30ef\u30fc\u30c9\u306f\u5148\u307b\u3069\u30e1\u30e2\u3057\u305f\u3082\u306e\u3067\u3059\u3002\n\u3082\u3057WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!\u3068\u8868\u793a\u3055\u308c\u305f\u5834\u5408\u306f\u3001~/.ssh/known_hosts\u304b\u3089\u8a72\u5f53\u3059\u308bIP\u30a2\u30c9\u30ec\u30b9\u306e\u884c\u3092\u524a\u9664\u3057\u307e\u3059\n4.\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u5909\u66f4\u3057\u307e\u3059\npasswd\n\n\u4eee\u60f3\u30b5\u30fc\u30d0\u30fc\u306bruby\u306e\u74b0\u5883\u3092\u69cb\u7bc9\nchef\u7b49\u3067\u4e00\u6c17\u306b\u3084\u308b\u3079\u304d\u3068\u601d\u3044\u307e\u3059\u304c\u3001\u81ea\u524d\u306eDockerfile\u306e\u624b\u9806\u3092\u624b\u52d5\u3067\u884c\u3044\u307e\u3057\u305f\u3002\nruby\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u7ba1\u7406\u306b\u306frbenv\u3092\u4f7f\u3044\u307e\u3059\u3002\nsudo apt-get update\nsudo apt-get install -y build-essential wget curl git\nsudo apt-get install -y zlib1g-dev libssl-dev libreadline-dev libyaml-dev libxml2-dev libxslt-dev\nsudo apt-get install -y sqlite3 libsqlite3-dev\nsudo apt-get clean\n\nsudo rm /etc/localtime\nsudo ln -s /usr/share/zoneinfo/Asia/Tokyo /etc/localtime\n\ngit clone https://github.com/sstephenson/ruby-build.git .ruby-build\nsudo .ruby-build/install.sh\nrm -fr .ruby-build\n\nsudo ruby-build 2.1.2 /usr/local\n\ngit clone https://github.com/sstephenson/rbenv.git ~/.rbenv\necho 'export PATH=\"$HOME/.rbenv/bin:$PATH\"' >> ~/.bash_profile\necho 'eval \"$(rbenv init -)\"' >> ~/.bash_profile\nsource ~/.bash_profile\nrbenv install 2.1.2\nrbenv global 2.1.2\n\ngem update --system\ngem install bundler --no-rdoc --no-ri\nrbenv rehash\n\n\nRails\u30a2\u30d7\u30ea\u306bCapistrano\u8a2d\u5b9a\u3092\u8ffd\u52a0\n\ndeploy\u7528\u306estaging\u74b0\u5883\u7528\u306e\u8a2d\u5b9a\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\ndatabase.yml\u306bstaging\u8a2d\u5b9a\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\nconfig/database.yml\n:\nstaging:\n  <<: *default\n  database: db/staging.sqlite3\n:\n\n\nconfig/environments/development.rb\u3092\u30b3\u30d4\u30fc\u3057\u3066config/environments/staging.rb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\uff08staging\u74b0\u5883\u306e\u4f4d\u7f6e\u3065\u3051\u306b\u3088\u3063\u3066\u306fproduction.rb\u304b\u3089\u30b3\u30d4\u30fc\u3057\u305f\u65b9\u304c\u826f\u3044\u3068\u601d\u3044\u307e\u3059\uff09\n\nconfig/environments/staging.rb\nRails.application.configure do\n  # Settings specified here will take precedence over those in config/application.rb.\n\n  # In the development environment your application's code is reloaded on\n  # every request. This slows down response time but is perfect for development\n  # since you don't have to restart the web server when you make code changes.\n  config.cache_classes = false\n\n  # Do not eager load code on boot.\n  config.eager_load = false\n\n  # Show full error reports and disable caching.\n  config.consider_all_requests_local       = true\n  config.action_controller.perform_caching = false\n\n  # Don't care if the mailer can't send.\n  config.action_mailer.raise_delivery_errors = false\n\n  # Print deprecation notices to the Rails logger.\n  config.active_support.deprecation = :log\n\n  # Raise an error on page load if there are pending migrations.\n  config.active_record.migration_error = :page_load\n\n  # Debug mode disables concatenation and preprocessing of assets.\n  # This option may cause significant delays in view rendering with a large\n  # number of complex assets.\n  config.assets.debug = true\n\n  # Adds additional error checking when serving assets at runtime.\n  # Checks for improperly declared sprockets dependencies.\n  # Raises helpful error messages.\n  config.assets.raise_runtime_errors = true\n\n  # Raises error for missing translations\n  # config.action_view.raise_on_missing_translations = true\nend\n\n\nconfig/secrets.yml\u306bsecret_key\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\nkey\u306e\u5024(xxxxxxxxxxxxxx\u306e\u90e8\u5206)\u306fdevelopment\u3068\u540c\u3058\u5024\u3092\u5165\u308c\u307e\u3057\u305f\u3002\n\nconfig/secrets.yml\n:\nstaging:\n  secret_key_base: xxxxxxxxxxxxxx\n  <<: *default_twitter\n:\n\n\n\nJavaScript\u30a8\u30f3\u30b8\u30f3\u306e\u8a2d\u5b9a\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\u30bf\u30fc\u30b2\u30c3\u30c8\u304cUbuntu\u306a\u306e\u3067Gemfile\u306etherubyracer\u3092\u6709\u52b9\u306b\u3057\u307e\u3059\u3002\n\nGemfile\n:\ngem 'therubyracer',  platforms: :ruby\n:\n\n\nbundle install\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\n\nunicorn\u306e\u8a2d\u5b9a\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\nGemfile\u306eunicorn\u306e\u8a2d\u5b9a\u3092\u6709\u52b9\u306b\u3057\u307e\u3059\u3002\n\nGemfile\n:\ngem 'unicorn'\n:\n\n\nbundle install\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\nconfig/unicorn/staging.rb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\nconfig/unicorn/staging.rb\n# Sample verbose configuration file for Unicorn (not Rack)\n#\n# This configuration file documents many features of Unicorn\n# that may not be needed for some applications. See\n# http://unicorn.bogomips.org/examples/unicorn.conf.minimal.rb\n# for a much simpler configuration file.\n#\n# See http://unicorn.bogomips.org/Unicorn/Configurator.html for complete\n# documentation.\n\n# Use at least one worker per core if you're on a dedicated server,\n# more will usually help for _short_ waits on databases/caches.\nworker_processes 4\n\n# Since Unicorn is never exposed to outside clients, it does not need to\n# run on the standard HTTP port (80), there is no reason to start Unicorn\n# as root unless it's from system init scripts.\n# If running the master process as root and the workers as an unprivileged\n# user, do this to switch euid/egid in the workers (also chowns logs):\n# user \"unprivileged_user\", \"unprivileged_group\"\n\n# Help ensure your application will always spawn in the symlinked\n# \"current\" directory that Capistrano sets up.\napp_path = '/var/www/awesome_events'\napp_shared_path = \"#{app_path}/shared\"\nworking_directory \"#{app_path}/current/\" # available in 0.94.0+\n\n# listen on both a Unix domain socket and a TCP port,\n# we use a shorter backlog for quicker failover when busy\nlisten \"#{app_shared_path}/tmp/sockets/unicorn.sock\"\nlisten 8080, :tcp_nopush => true\n\n# nuke workers after 30 seconds instead of 60 seconds (the default)\ntimeout 30\n\n# feel free to point this anywhere accessible on the filesystem\npid \"#{app_shared_path}/tmp/pids/unicorn.pid\"\n\n By default, the Unicorn logger will write to stderr.\n# Additionally, ome applications/frameworks log to stderr or stdout,\n# so prevent them from going to /dev/null when daemonized here:\nstderr_path \"#{app_shared_path}/log/unicorn.stderr.log\"\nstdout_path \"#{app_shared_path}/log/unicorn.stdout.log\"\n\n# combine Ruby 2.0.0dev or REE with \"preload_app true\" for memory savings\n# http://rubyenterpriseedition.com/faq.html#adapt_apps_for_cow\npreload_app true\nGC.respond_to?(:copy_on_write_friendly=) and\n  GC.copy_on_write_friendly = true\n\n# Enable this flag to have unicorn test client connections by writing the\n# beginning of the HTTP headers before calling the application.  This\n# prevents calling the application for connections that have disconnected\n# while queued.  This is only guaranteed to detect clients on the same\n# host unicorn runs on, and unlikely to detect disconnects even on a\n# fast LAN.\ncheck_client_connection false\n\nbefore_fork do |server, worker|\n  ENV['BUNDLE_GEMFILE'] = File.expand_path('Gemfile', ENV['RAILS_ROOT'])\n\n  # the following is highly recomended for Rails + \"preload_app true\"\n  # as there's no need for the master process to hold a connection\n  defined?(ActiveRecord::Base) and\n    ActiveRecord::Base.connection.disconnect!\n\n  # The following is only recommended for memory/DB-constrained\n  # installations.  It is not needed if your system can house\n  # twice as many worker_processes as you have configured.\n  #\n  # # This allows a new master process to incrementally\n  # # phase out the old master process with SIGTTOU to avoid a\n  # # thundering herd (especially in the \"preload_app false\" case)\n  # # when doing a transparent upgrade.  The last worker spawned\n  # # will then kill off the old master process with a SIGQUIT.\n  old_pid = \"#{server.config[:pid]}.oldbin\"\n  if old_pid != server.pid\n    begin\n      sig = (worker.nr + 1) >= server.worker_processes ? :QUIT : :TTOU\n      Process.kill(sig, File.read(old_pid).to_i)\n    rescue Errno::ENOENT, Errno::ESRCH\n    end\n  end\n  #\n  # Throttle the master from forking too quickly by sleeping.  Due\n  # to the implementation of standard Unix signal handlers, this\n  # helps (but does not completely) prevent identical, repeated signals\n  # from being lost when the receiving process is busy.\n  # sleep 1\nend\n\nafter_fork do |server, worker|\n  # per-process listener ports for debugging/admin/migrations\n  # addr = \"127.0.0.1:#{9293 + worker.nr}\"\n  # server.listen(addr, :tries => -1, :delay => 5, :tcp_nopush => true)\n\n  # the following is *required* for Rails + \"preload_app true\",\n  defined?(ActiveRecord::Base) and\n    ActiveRecord::Base.establish_connection\n\n  # if preload_app is true, then you may also want to check and\n  # restart any other shared sockets/descriptors such as Memcached,\n  # and Redis.  TokyoCabinet file handles are safe to reuse\n  # between any number of forked children (assuming your kernel\n  # correctly implements pread()/pwrite() system calls)\nend\n\n\n\nconfig/unicorn/staging.rb\u306f\u3001~/.rbenv/versions/2.1.2/lib/ruby/gems/2.1.0/gems/unicorn-4.8.3/examples/unicorn.conf.rb\u3092\u30b3\u30d4\u30fc\u3057\u3066\u4f5c\u308a\u307e\u3057\u305f\u3002\npath\u7b49\u306e\u8a2d\u5b9a\u3060\u3051\u3067\u306fcap\u5b9f\u884c\u6642\u306bunicorn\u306ereload\u3067\u3053\u3051\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u3002\n\u305d\u3053\u306f\u6b21\u306e2\u3064\u306e\u5bfe\u5fdc\u3067\u89e3\u6c7a\u3057\u307e\u3057\u305f\u3002\nENV['BUNDLE_GEMFILE'] = File.expand_path('Gemfile', ENV['RAILS_ROOT'])\n\n\u306e\u884c\u3092\u8ffd\u52a0\u3002\nold_pid = \"#{server.config[:pid]}.oldbin\"\n  if old_pid != server.pid\n    begin\n      sig = (worker.nr + 1) >= server.worker_processes ? :QUIT : :TTOU\n      Process.kill(sig, File.read(old_pid).to_i)\n    rescue Errno::ENOENT, Errno::ESRCH\n    end\n  end\n\n\u306e\u884c\u3092\u6709\u52b9\u5316\u3002\n\ncapistrano\u95a2\u9023\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\nGemfile\u306bcapistrano\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\nGemfile\ngroup :development, :test do\n  gem 'capistrano', :require => false\n  gem 'capistrano-rails', :require => false\n  gem 'capistrano-rbenv', :require => false\n  gem 'capistrano-bundler', :require => false\nend\n\n\nbundle install\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\nbundle exec cap install\u3092\u5b9f\u884c\u3057\u3001capistrano\u95a2\u9023\u30d5\u30a1\u30a4\u30eb\u3092\u751f\u6210\u3057\u307e\u3059\u3002\nCapfile\u3092\u4fee\u6b63\u3057\u307e\u3059\u3002\n\nCapfile\n# Load DSL and Setup Up Stages\nrequire 'capistrano/setup'\n\n# Includes default deployment tasks\nrequire 'capistrano/deploy'\n\n# Includes tasks from other gems included in your Gemfile\n#\n# For documentation on these, see for example:\n#\n#   https://github.com/capistrano/rvm\n#   https://github.com/capistrano/rbenv\n#   https://github.com/capistrano/chruby\n#   https://github.com/capistrano/bundler\n#   https://github.com/capistrano/rails\n#\n# require 'capistrano/rvm'\nrequire 'capistrano/rbenv'\nset :rbenv_type, :user\nset :rbenv_ruby, '2.1.2'\n# require 'capistrano/chruby'\nrequire 'capistrano/bundler'\nrequire 'capistrano/rails/assets'\nrequire 'capistrano/rails/migrations'\n\n# Loads custom tasks from `lib/capistrano/tasks' if you have any defined.\nDir.glob('lib/capistrano/tasks/*.cap').each { |r| import r }\n\n\n\u6700\u5f8c\u306e\u884c\u306f\u3082\u3068\u3082\u3068tasks/.rb\u3068\u306a\u3063\u3066\u3044\u305f\u306e\u3067\u3001tasks/.cap\u306b\u5909\u66f4\u3057\u3066\u3044\u307e\u3059\u3002\n\uff08\u305d\u306e\u307e\u307e\u4f7f\u3046\u5834\u5408\u306f\u3001\u5f8c\u8ff0\u306elib/capistrano/tasks/unicorn.cap\u3092lib/capistrano/tasks/unicorn.rb\u3068\u3044\u3046\u540d\u524d\u306b\u3059\u308c\u3070\u826f\u3044\u3067\u3057\u3087\u3046\uff09\nconfig/deploy.rb\u3092\u4fee\u6b63\u3057\u307e\u3059\u3002\nURL\u7b49\u306f\u81ea\u5206\u306e\u74b0\u5883\u306b\u7f6e\u304d\u63db\u3048\u3066\u304f\u3060\u3055\u3044\u3002\n\nconfig/deploy.rb\n# config valid only for Capistrano 3.1\nlock '3.2.1'\n\nset :application, 'awesome_events'\nset :repo_url, 'https://github.com/t-oginogin/awesome_eventes.git'\n\n# Default branch is :master\n# ask :branch, proc { `git rev-parse --abbrev-ref HEAD`.chomp }.call\nset :branch, :master\n\n# Default deploy_to directory is /var/www/my_app\nset :deploy_to, '/var/www/awesome_events'\n\n# Default value for :scm is :git\nset :scm, :git\n\n# Default value for :format is :pretty\n# set :format, :pretty\n\n# Default value for :log_level is :debug\nset :log_level, :debug\n\n# Default value for :pty is false\nset :pty, true\n\n# Default value for :linked_files is []\n# set :linked_files, %w{config/database.yml}\n\n# Default value for linked_dirs is []\nset :linked_dirs, %w{bin log tmp/pids tmp/cache tmp/sockets vendor/bundle public/system public/assets}\n\n# Default value for default_env is {}\nset :default_env, { path: \"/usr/local/rbenv/shims:/usr/local/rbenv/bin:$PATH\" }\n\n# Default value for keep_releases is 5\nset :keep_releases, 5\n\nnamespace :deploy do\n\n  desc 'Restart application'\n  task :restart do\n    invoke 'unicorn:restart'\n  end\n\n  after :publishing, :restart\n\nend\n\n\nconfig/deploy/staging.rb\u3092\u4fee\u6b63\u3057\u307e\u3059\u3002\n\u30bf\u30fc\u30b2\u30c3\u30c8\u30b5\u30fc\u30d0\u30fc\u306e\u30a2\u30c9\u30ec\u30b9\u3001\u30ed\u30b0\u30a4\u30f3\u60c5\u5831\u306f\u74b0\u5883\u5909\u6570\u304b\u3089\u53d6\u5f97\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\nconfig/deploy/staging.rb\nset :stage, :staging\n#\n# Simple Role Syntax\n# ==================\n# Supports bulk-adding hosts to roles, the primary server in each group\n# is considered to be the first unless any hosts have the primary\n# property set.  Don't declare `role :all`, it's a meta role.\n\nrole :app, %W{#{ENV['AWESOME_USER']}@#{ENV['AWESOME_ADDRESS']}}\nrole :web, %W{#{ENV['AWESOME_USER']}@#{ENV['AWESOME_ADDRESS']}}\nrole :db,  %W{#{ENV['AWESOME_USER']}@#{ENV['AWESOME_ADDRESS']}}\n\n\n# Extended Server Syntax\n# ======================\n# This can be used to drop a more detailed server definition into the\n# server list. The second argument is a, or duck-types, Hash and is\n# used to set extended properties on the server.\n\nserver \"#{ENV['AWESOME_ADDRESS']}\", user: \"#{ENV['AWESOME_USER']}\", roles: %w{web app db}\n\n# Custom SSH Options\n# ==================\n# You may pass any option but keep in mind that net/ssh understands a\n# limited set of options, consult[net/ssh documentation](http://net-ssh.github.io/net-ssh/classes/Net/SSH.html#method-c-start).\n#\n# Global options\n# --------------\nset :ssh_options, {\n#    keys: %w(/home/rlisowski/.ssh/id_rsa),\n#    forward_agent: false,\n  auth_methods: %w(password),\n  password: ENV['AWESOME_PASS']\n}\n#\n# And/or per server (overrides global)\n# ------------------------------------\n# server 'example.com',\n#   user: 'user_name',\n#   roles: %w{web app},\n#   ssh_options: {\n#     user: 'user_name', # overrides user setting above\n#     keys: %w(/home/user_name/.ssh/id_rsa),\n#     forward_agent: false,\n#     auth_methods: %w(publickey password)\n#     # password: 'please use keys'\n#   }\n\n\nlib/capistrano/tasks/unicorn.cap\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\nNginx\u3068\u306fport8080\u3067\u901a\u4fe1\u3059\u308b\u60f3\u5b9a\u3067\u3059\u3002\n\nlib/capistrano/tasks/unicorn.cap\nnamespace :unicorn do\n  task :environment do\n    set :unicorn_pid, \"#{shared_path}/tmp/pids/unicorn.pid\"\n    set :unicorn_config, \"#{current_path}/config/unicorn/#{fetch(:rails_env)}.rb\"\n  end\n\n  def start_unicorn\n    within current_path do\n      execute :bundle, :exec, :unicorn_rails, \"-c #{fetch(:unicorn_config)} -E #{fetch(:rails_env)} -p 8080 -D\"\n    end\n  end\n\n  def stop_unicorn\n    execute :kill, \"-s QUIT $(< #{fetch(:unicorn_pid)})\"\n  end\n\n  def reload_unicorn\n    execute :kill, \"-s USR2 $(< #{fetch(:unicorn_pid)})\"\n  end\n\n  def force_stop_unicorn\n    execute :kill, \"$(< #{fetch(:unicorn_pid)})\"\n  end\n\n  desc \"Start unicorn server\"\n  task :start => :environment do\n    on roles(:app) do\n      start_unicorn\n    end\n  end\n\n  desc \"Stop unicorn server gracefully\"\n  task :stop => :environment do\n    on roles(:app) do\n      stop_unicorn\n    end\n  end\n\n  desc \"Restart unicorn server gracefully\"\n  task :restart => :environment do\n    on roles(:app) do\n      if test(\"[ -f #{fetch(:unicorn_pid)} ]\")\n        reload_unicorn\n      else\n        start_unicorn\n      end\n    end\n  end\n\n  desc \"Stop unicorn server immediately\"\n  task :force_stop => :environment do\n    on roles(:app) do\n      force_stop_unicorn\n    end\n  end\nend\n\n\n\n\u30bf\u30fc\u30b2\u30c3\u30c8\u30b5\u30fc\u30d0\u30fc\u4e0a\u3067Nginx\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\u672c\u5f53\u306f\u3053\u3053\u3082\u81ea\u52d5\u5316\u3057\u3066\u304a\u304d\u305f\u3044\u3068\u3053\u308d\u3067\u3059\u304c\u3001\u4eca\u56de\u306f\u624b\u52d5\u3067\u8a2d\u5b9a\u3057\u307e\u3057\u305f\u3002\n\uff08jenkins\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304c\u53c2\u8003\u306b\u306a\u308a\u307e\u3059\uff09\nsudo aptitude -y install nginx\ncd /etc/nginx/sites-available\nsudo rm default ../sites-enabled/default\n\n/etc/nginx/sites-available\u306bawesome_events\u3092\u914d\u7f6e\u3057\u307e\u3059\u3002\nunicorn\u3068\u306fport8080\u3067\u901a\u4fe1\u3055\u305b\u307e\u3059\u3002\n\n/etc/nginx/sites-available/awesome_events\nupstream app_server {\n    server 127.0.0.1:8080 fail_timeout=0;\n}\n\nserver {\n    listen 80;\n    listen [::]:80 default ipv6only=on;\n    server_name awesome_events;\n\n    location / {\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header Host $http_host;\n        proxy_redirect off;\n\n        if (!-f $request_filename) {\n            proxy_pass http://app_server;\n            break;\n        }\n    }\n}\n\n\nsudo ln -s /etc/nginx/sites-available/awesome_events /etc/nginx/sites-enabled/\nsudo service nginx restart\n\n\ndeploy\u5834\u6240\u3092\u4f5c\u3063\u3066\u304a\u304d\u307e\u3059\u3002\nsudo mkdir /var/www\nsudo chown ubuntu /var/www\nsudo chgrp ubuntu /var/www\nsudo chmod +rwx /var/www\n\n\n\u30ed\u30fc\u30ab\u30eb\u30de\u30b7\u30f3\u304b\u3089depoy\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\n\u30ed\u30fc\u30ab\u30eb\u30de\u30b7\u30f3\u306b\u623b\u3063\u3066\u3001cap\u30b3\u30de\u30f3\u30c9\u3067\u30c7\u30d7\u30ed\u30a4\u3057\u307e\u3059\u3002\n\u3044\u304f\u3064\u304b\u74b0\u5883\u5909\u6570\u3067\u8a2d\u5b9a\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u308b\u306e\u3067\u3001\u5fd8\u308c\u305a\u8a2d\u5b9a\u3057\u307e\u3059\u3002\nbundle exec cap staging deploy AWESOME_ADDRESS=xxx.xxx.xxx.xxx AWESOME_USER=ubuntu  AWESOME_PASS=your_password\n\n\u7121\u4e8b\u30c7\u30d7\u30ed\u30a4\u3067\u304d\u307e\u3057\u305f\u3002\n\u30bd\u30fc\u30b9\u306fGitHub\u306b\u7f6e\u3044\u3066\u3044\u307e\u3059\u3002\nhttps://github.com/t-oginogin/awesome_eventes\n\n\u4eca\u56de\u306fRails\u30a2\u30d7\u30eaawesome_events\uff08\u66f8\u7c4d\"\u30d1\u30fc\u30d5\u30a7\u30af\u30c8Ruby on Rails\"\u3067\u5199\u7d4c\u3057\u305f\u3084\u3064\uff09\u3092Cloudn\u4e0a\u3067\u52d5\u304b\u3059\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\ncapistrano\u8a2d\u5b9a\u306b\u3064\u3044\u3066\u306fQiita\u8a18\u4e8b\u3092\u53c2\u8003\u306b\u69cb\u7bc9\u3057\u307e\u3057\u305f\u304c\u3001\u3064\u307e\u3063\u305f\u3068\u3053\u308d\u304c\u3042\u308b\u306e\u3067\u81ea\u5206\u30e1\u30e2\u3068\u3057\u3066\u6574\u7406\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n\u53c2\u8003\uff1a\n\n- [unicorn + rails \u7528 Capistrano 3 \u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb](http://qiita.com/satococoa/items/9b0cc416ffc042680b9b)\n- [Capistrano3\u3067rails\u3092deploy\u3057\u3066\u307f\u308b](http://qiita.com/ea54595/items/12ab7b3a8213b35cca10)\n\n## Cloudn\u4e0a\u3067Rails\u304c\u52d5\u304f\u74b0\u5883\u3092\u69cb\u7bc9\n\n### Cloudn\u4e0a\u306b\u65b0\u3057\u3044\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7testapp\u3092\u4f5c\u6210\n\n1.\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306e\"\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\u306e\u8ffd\u52a0\"\u304b\u3089\u65b0\u3057\u3044\u30b0\u30eb\u30fc\u30d7testapp\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\n2.testapp\u3092\u958b\u304d\u3001\u6b21\u306e\u30dd\u30fc\u30c8\u8a2d\u5b9a\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\n\u53d7\u4fe1\u898f\u5247\u306bport:22 0.0.0.0./0\n\u53d7\u4fe1\u898f\u5247\u306bport:443 0.0.0.0./0\n\u53d7\u4fe1\u898f\u5247\u306bport:80 0.0.0.0./0\n\n*\u7406\u7531\u306f\u308f\u304b\u3063\u3066\u307e\u305b\u3093\u304c\u3001\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\u306e\u72b6\u614b\u306b\u3088\u3063\u3066\u306f\u3001\u521d\u671f\u30d1\u30b9\u30ef\u30fc\u30c9\u3067\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u3002\n\uff08`Permission denied, please try again.`\u3068\u8868\u793a\u3055\u308c\u307e\u3057\u305f\uff09\n\u65b0\u898f\u3067\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\u3092\u4f5c\u308c\u3070\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u307e\u3057\u305f\u3002*\n\n### Cloudn\u4e0a\u306b\u65b0\u3057\u3044\u4eee\u60f3\u30b5\u30fc\u30d0\u30fctestapp\u3092\u4f5c\u6210\n\n1.\"\u4eee\u60f3\u30b5\u30fc\u30d0\u30fc\u306e\u8ffd\u52a0\"\u304b\u3089\u65b0\u3057\u3044\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```\nISO \u307e\u305f\u306f\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306e\u9078\u629e:\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\n\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\uff1aUbuntu Server v14.04 64bit\n\u4eee\u60f3\u30b5\u30fc\u30d0\u30fc\u30d7\u30e9\u30f3\uff1at1.micro\n\u30c7\u30fc\u30bf\u30c7\u30a3\u30b9\u30af\uff1a\u8a2d\u5b9a\u3057\u306a\u3044\n\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\uff1atestapp\n\u540d\u524d\uff1atestapp\n```\n\n2.\u521d\u671f\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u30e1\u30e2\u3057\u307e\u3059\u3002\n1\u3067\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3068\u3001\u6700\u5f8c\u306b\u30c0\u30a4\u30a2\u30ed\u30b0\u304c\u8868\u793a\u3055\u308c\u3001\u521d\u671f\u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u8868\u793a\u3055\u308c\u307e\u3059\u3002\n\u305d\u308c\u3092\u30e1\u30e2\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n3.\u4eee\u60f3\u30b5\u30fc\u30d0\u30fc\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u307e\u3059\u3002\n\u4eee\u60f3\u30b5\u30fc\u30d0\u30fc\u4e00\u89a7\u304b\u3089\u4f5c\u6210\u3057\u305ftestapp\u3092\u9078\u629e\u3057\u3001NIC\u30bf\u30d6\u304b\u3089IP\u30a2\u30c9\u30ec\u30b9\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\u305d\u306e\u30a2\u30c9\u30ec\u30b9\u306b\u5bfe\u3057ssh\u3067\u30ed\u30b0\u30a4\u30f3\u3057\u307e\u3059\u3002\uff08Ubuntu\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u521d\u671f\u30e6\u30fc\u30b6\u30fc\u306fubuntu\uff09\n\n`ssh ubuntu@xxx.xxx.xxx.xxx`\n\n\u30d1\u30b9\u30ef\u30fc\u30c9\u306f\u5148\u307b\u3069\u30e1\u30e2\u3057\u305f\u3082\u306e\u3067\u3059\u3002\n\n`\u3082\u3057WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!\u3068\u8868\u793a\u3055\u308c\u305f\u5834\u5408\u306f\u3001~/.ssh/known_hosts\u304b\u3089\u8a72\u5f53\u3059\u308bIP\u30a2\u30c9\u30ec\u30b9\u306e\u884c\u3092\u524a\u9664\u3057\u307e\u3059`\n\n4.\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u5909\u66f4\u3057\u307e\u3059\n\n`passwd`\n\n## \u4eee\u60f3\u30b5\u30fc\u30d0\u30fc\u306bruby\u306e\u74b0\u5883\u3092\u69cb\u7bc9\n\nchef\u7b49\u3067\u4e00\u6c17\u306b\u3084\u308b\u3079\u304d\u3068\u601d\u3044\u307e\u3059\u304c\u3001[\u81ea\u524d\u306eDockerfile](https://github.com/t-oginogin/dockerfiles/blob/master/ubuntu/Dockerfile_ruby)\u306e\u624b\u9806\u3092\u624b\u52d5\u3067\u884c\u3044\u307e\u3057\u305f\u3002\nruby\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u7ba1\u7406\u306b\u306frbenv\u3092\u4f7f\u3044\u307e\u3059\u3002\n\n```bash\nsudo apt-get update\nsudo apt-get install -y build-essential wget curl git\nsudo apt-get install -y zlib1g-dev libssl-dev libreadline-dev libyaml-dev libxml2-dev libxslt-dev\nsudo apt-get install -y sqlite3 libsqlite3-dev\nsudo apt-get clean\n\nsudo rm /etc/localtime\nsudo ln -s /usr/share/zoneinfo/Asia/Tokyo /etc/localtime\n\ngit clone https://github.com/sstephenson/ruby-build.git .ruby-build\nsudo .ruby-build/install.sh\nrm -fr .ruby-build\n\nsudo ruby-build 2.1.2 /usr/local\n\ngit clone https://github.com/sstephenson/rbenv.git ~/.rbenv\necho 'export PATH=\"$HOME/.rbenv/bin:$PATH\"' >> ~/.bash_profile\necho 'eval \"$(rbenv init -)\"' >> ~/.bash_profile\nsource ~/.bash_profile\nrbenv install 2.1.2\nrbenv global 2.1.2\n\ngem update --system\ngem install bundler --no-rdoc --no-ri\nrbenv rehash\n```\n\n## Rails\u30a2\u30d7\u30ea\u306bCapistrano\u8a2d\u5b9a\u3092\u8ffd\u52a0\n\n###deploy\u7528\u306estaging\u74b0\u5883\u7528\u306e\u8a2d\u5b9a\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\ndatabase.yml\u306bstaging\u8a2d\u5b9a\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\n```yaml:config/database.yml\n:\nstaging:\n  <<: *default\n  database: db/staging.sqlite3\n:\n```\n\nconfig/environments/development.rb\u3092\u30b3\u30d4\u30fc\u3057\u3066config/environments/staging.rb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\uff08staging\u74b0\u5883\u306e\u4f4d\u7f6e\u3065\u3051\u306b\u3088\u3063\u3066\u306fproduction.rb\u304b\u3089\u30b3\u30d4\u30fc\u3057\u305f\u65b9\u304c\u826f\u3044\u3068\u601d\u3044\u307e\u3059\uff09\n\n```rb:config/environments/staging.rb\nRails.application.configure do\n  # Settings specified here will take precedence over those in config/application.rb.\n\n  # In the development environment your application's code is reloaded on\n  # every request. This slows down response time but is perfect for development\n  # since you don't have to restart the web server when you make code changes.\n  config.cache_classes = false\n\n  # Do not eager load code on boot.\n  config.eager_load = false\n\n  # Show full error reports and disable caching.\n  config.consider_all_requests_local       = true\n  config.action_controller.perform_caching = false\n\n  # Don't care if the mailer can't send.\n  config.action_mailer.raise_delivery_errors = false\n\n  # Print deprecation notices to the Rails logger.\n  config.active_support.deprecation = :log\n\n  # Raise an error on page load if there are pending migrations.\n  config.active_record.migration_error = :page_load\n\n  # Debug mode disables concatenation and preprocessing of assets.\n  # This option may cause significant delays in view rendering with a large\n  # number of complex assets.\n  config.assets.debug = true\n\n  # Adds additional error checking when serving assets at runtime.\n  # Checks for improperly declared sprockets dependencies.\n  # Raises helpful error messages.\n  config.assets.raise_runtime_errors = true\n\n  # Raises error for missing translations\n  # config.action_view.raise_on_missing_translations = true\nend\n```\n\nconfig/secrets.yml\u306bsecret_key\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\nkey\u306e\u5024(xxxxxxxxxxxxxx\u306e\u90e8\u5206)\u306fdevelopment\u3068\u540c\u3058\u5024\u3092\u5165\u308c\u307e\u3057\u305f\u3002\n\n```yaml:config/secrets.yml\n:\nstaging:\n  secret_key_base: xxxxxxxxxxxxxx\n  <<: *default_twitter\n:\n```\n\n###JavaScript\u30a8\u30f3\u30b8\u30f3\u306e\u8a2d\u5b9a\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\u30bf\u30fc\u30b2\u30c3\u30c8\u304cUbuntu\u306a\u306e\u3067Gemfile\u306etherubyracer\u3092\u6709\u52b9\u306b\u3057\u307e\u3059\u3002\n\n```rb:Gemfile\n:\ngem 'therubyracer',  platforms: :ruby\n:\n```\n`bundle install`\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\n\n###unicorn\u306e\u8a2d\u5b9a\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\nGemfile\u306eunicorn\u306e\u8a2d\u5b9a\u3092\u6709\u52b9\u306b\u3057\u307e\u3059\u3002\n\n```rb:Gemfile\n:\ngem 'unicorn'\n:\n```\n`bundle install`\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\n\nconfig/unicorn/staging.rb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```rb:config/unicorn/staging.rb\n# Sample verbose configuration file for Unicorn (not Rack)\n#\n# This configuration file documents many features of Unicorn\n# that may not be needed for some applications. See\n# http://unicorn.bogomips.org/examples/unicorn.conf.minimal.rb\n# for a much simpler configuration file.\n#\n# See http://unicorn.bogomips.org/Unicorn/Configurator.html for complete\n# documentation.\n\n# Use at least one worker per core if you're on a dedicated server,\n# more will usually help for _short_ waits on databases/caches.\nworker_processes 4\n\n# Since Unicorn is never exposed to outside clients, it does not need to\n# run on the standard HTTP port (80), there is no reason to start Unicorn\n# as root unless it's from system init scripts.\n# If running the master process as root and the workers as an unprivileged\n# user, do this to switch euid/egid in the workers (also chowns logs):\n# user \"unprivileged_user\", \"unprivileged_group\"\n\n# Help ensure your application will always spawn in the symlinked\n# \"current\" directory that Capistrano sets up.\napp_path = '/var/www/awesome_events'\napp_shared_path = \"#{app_path}/shared\"\nworking_directory \"#{app_path}/current/\" # available in 0.94.0+\n\n# listen on both a Unix domain socket and a TCP port,\n# we use a shorter backlog for quicker failover when busy\nlisten \"#{app_shared_path}/tmp/sockets/unicorn.sock\"\nlisten 8080, :tcp_nopush => true\n\n# nuke workers after 30 seconds instead of 60 seconds (the default)\ntimeout 30\n\n# feel free to point this anywhere accessible on the filesystem\npid \"#{app_shared_path}/tmp/pids/unicorn.pid\"\n\n By default, the Unicorn logger will write to stderr.\n# Additionally, ome applications/frameworks log to stderr or stdout,\n# so prevent them from going to /dev/null when daemonized here:\nstderr_path \"#{app_shared_path}/log/unicorn.stderr.log\"\nstdout_path \"#{app_shared_path}/log/unicorn.stdout.log\"\n\n# combine Ruby 2.0.0dev or REE with \"preload_app true\" for memory savings\n# http://rubyenterpriseedition.com/faq.html#adapt_apps_for_cow\npreload_app true\nGC.respond_to?(:copy_on_write_friendly=) and\n  GC.copy_on_write_friendly = true\n\n# Enable this flag to have unicorn test client connections by writing the\n# beginning of the HTTP headers before calling the application.  This\n# prevents calling the application for connections that have disconnected\n# while queued.  This is only guaranteed to detect clients on the same\n# host unicorn runs on, and unlikely to detect disconnects even on a\n# fast LAN.\ncheck_client_connection false\n\nbefore_fork do |server, worker|\n  ENV['BUNDLE_GEMFILE'] = File.expand_path('Gemfile', ENV['RAILS_ROOT'])\n\n  # the following is highly recomended for Rails + \"preload_app true\"\n  # as there's no need for the master process to hold a connection\n  defined?(ActiveRecord::Base) and\n    ActiveRecord::Base.connection.disconnect!\n\n  # The following is only recommended for memory/DB-constrained\n  # installations.  It is not needed if your system can house\n  # twice as many worker_processes as you have configured.\n  #\n  # # This allows a new master process to incrementally\n  # # phase out the old master process with SIGTTOU to avoid a\n  # # thundering herd (especially in the \"preload_app false\" case)\n  # # when doing a transparent upgrade.  The last worker spawned\n  # # will then kill off the old master process with a SIGQUIT.\n  old_pid = \"#{server.config[:pid]}.oldbin\"\n  if old_pid != server.pid\n    begin\n      sig = (worker.nr + 1) >= server.worker_processes ? :QUIT : :TTOU\n      Process.kill(sig, File.read(old_pid).to_i)\n    rescue Errno::ENOENT, Errno::ESRCH\n    end\n  end\n  #\n  # Throttle the master from forking too quickly by sleeping.  Due\n  # to the implementation of standard Unix signal handlers, this\n  # helps (but does not completely) prevent identical, repeated signals\n  # from being lost when the receiving process is busy.\n  # sleep 1\nend\n\nafter_fork do |server, worker|\n  # per-process listener ports for debugging/admin/migrations\n  # addr = \"127.0.0.1:#{9293 + worker.nr}\"\n  # server.listen(addr, :tries => -1, :delay => 5, :tcp_nopush => true)\n\n  # the following is *required* for Rails + \"preload_app true\",\n  defined?(ActiveRecord::Base) and\n    ActiveRecord::Base.establish_connection\n\n  # if preload_app is true, then you may also want to check and\n  # restart any other shared sockets/descriptors such as Memcached,\n  # and Redis.  TokyoCabinet file handles are safe to reuse\n  # between any number of forked children (assuming your kernel\n  # correctly implements pread()/pwrite() system calls)\nend\n\n```\n\nconfig/unicorn/staging.rb\u306f\u3001`~/.rbenv/versions/2.1.2/lib/ruby/gems/2.1.0/gems/unicorn-4.8.3/examples/unicorn.conf.rb`\u3092\u30b3\u30d4\u30fc\u3057\u3066\u4f5c\u308a\u307e\u3057\u305f\u3002\n\npath\u7b49\u306e\u8a2d\u5b9a\u3060\u3051\u3067\u306fcap\u5b9f\u884c\u6642\u306bunicorn\u306ereload\u3067\u3053\u3051\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u3002\n\u305d\u3053\u306f\u6b21\u306e2\u3064\u306e\u5bfe\u5fdc\u3067\u89e3\u6c7a\u3057\u307e\u3057\u305f\u3002\n\n```\nENV['BUNDLE_GEMFILE'] = File.expand_path('Gemfile', ENV['RAILS_ROOT'])\n```\n\n\u306e\u884c\u3092\u8ffd\u52a0\u3002\n\n```\nold_pid = \"#{server.config[:pid]}.oldbin\"\n  if old_pid != server.pid\n    begin\n      sig = (worker.nr + 1) >= server.worker_processes ? :QUIT : :TTOU\n      Process.kill(sig, File.read(old_pid).to_i)\n    rescue Errno::ENOENT, Errno::ESRCH\n    end\n  end\n```\n\n\u306e\u884c\u3092\u6709\u52b9\u5316\u3002\n\n###capistrano\u95a2\u9023\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\nGemfile\u306bcapistrano\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\n```:Gemfile\ngroup :development, :test do\n  gem 'capistrano', :require => false\n  gem 'capistrano-rails', :require => false\n  gem 'capistrano-rbenv', :require => false\n  gem 'capistrano-bundler', :require => false\nend\n```\n`bundle install`\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\n\n`bundle exec cap install`\u3092\u5b9f\u884c\u3057\u3001capistrano\u95a2\u9023\u30d5\u30a1\u30a4\u30eb\u3092\u751f\u6210\u3057\u307e\u3059\u3002\n\nCapfile\u3092\u4fee\u6b63\u3057\u307e\u3059\u3002\n\n```rb:Capfile\n# Load DSL and Setup Up Stages\nrequire 'capistrano/setup'\n\n# Includes default deployment tasks\nrequire 'capistrano/deploy'\n\n# Includes tasks from other gems included in your Gemfile\n#\n# For documentation on these, see for example:\n#\n#   https://github.com/capistrano/rvm\n#   https://github.com/capistrano/rbenv\n#   https://github.com/capistrano/chruby\n#   https://github.com/capistrano/bundler\n#   https://github.com/capistrano/rails\n#\n# require 'capistrano/rvm'\nrequire 'capistrano/rbenv'\nset :rbenv_type, :user\nset :rbenv_ruby, '2.1.2'\n# require 'capistrano/chruby'\nrequire 'capistrano/bundler'\nrequire 'capistrano/rails/assets'\nrequire 'capistrano/rails/migrations'\n\n# Loads custom tasks from `lib/capistrano/tasks' if you have any defined.\nDir.glob('lib/capistrano/tasks/*.cap').each { |r| import r }\n```\n\n\u6700\u5f8c\u306e\u884c\u306f\u3082\u3068\u3082\u3068tasks/*.rb\u3068\u306a\u3063\u3066\u3044\u305f\u306e\u3067\u3001tasks/*.cap\u306b\u5909\u66f4\u3057\u3066\u3044\u307e\u3059\u3002\n\uff08\u305d\u306e\u307e\u307e\u4f7f\u3046\u5834\u5408\u306f\u3001\u5f8c\u8ff0\u306e`lib/capistrano/tasks/unicorn.cap`\u3092`lib/capistrano/tasks/unicorn.rb`\u3068\u3044\u3046\u540d\u524d\u306b\u3059\u308c\u3070\u826f\u3044\u3067\u3057\u3087\u3046\uff09\n\nconfig/deploy.rb\u3092\u4fee\u6b63\u3057\u307e\u3059\u3002\nURL\u7b49\u306f\u81ea\u5206\u306e\u74b0\u5883\u306b\u7f6e\u304d\u63db\u3048\u3066\u304f\u3060\u3055\u3044\u3002\n\n```rb:config/deploy.rb\n# config valid only for Capistrano 3.1\nlock '3.2.1'\n\nset :application, 'awesome_events'\nset :repo_url, 'https://github.com/t-oginogin/awesome_eventes.git'\n\n# Default branch is :master\n# ask :branch, proc { `git rev-parse --abbrev-ref HEAD`.chomp }.call\nset :branch, :master\n\n# Default deploy_to directory is /var/www/my_app\nset :deploy_to, '/var/www/awesome_events'\n\n# Default value for :scm is :git\nset :scm, :git\n\n# Default value for :format is :pretty\n# set :format, :pretty\n\n# Default value for :log_level is :debug\nset :log_level, :debug\n\n# Default value for :pty is false\nset :pty, true\n\n# Default value for :linked_files is []\n# set :linked_files, %w{config/database.yml}\n\n# Default value for linked_dirs is []\nset :linked_dirs, %w{bin log tmp/pids tmp/cache tmp/sockets vendor/bundle public/system public/assets}\n\n# Default value for default_env is {}\nset :default_env, { path: \"/usr/local/rbenv/shims:/usr/local/rbenv/bin:$PATH\" }\n\n# Default value for keep_releases is 5\nset :keep_releases, 5\n\nnamespace :deploy do\n\n  desc 'Restart application'\n  task :restart do\n    invoke 'unicorn:restart'\n  end\n\n  after :publishing, :restart\n\nend\n```\n\nconfig/deploy/staging.rb\u3092\u4fee\u6b63\u3057\u307e\u3059\u3002\n\n\u30bf\u30fc\u30b2\u30c3\u30c8\u30b5\u30fc\u30d0\u30fc\u306e\u30a2\u30c9\u30ec\u30b9\u3001\u30ed\u30b0\u30a4\u30f3\u60c5\u5831\u306f\u74b0\u5883\u5909\u6570\u304b\u3089\u53d6\u5f97\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\n```rb:config/deploy/staging.rb\nset :stage, :staging\n#\n# Simple Role Syntax\n# ==================\n# Supports bulk-adding hosts to roles, the primary server in each group\n# is considered to be the first unless any hosts have the primary\n# property set.  Don't declare `role :all`, it's a meta role.\n\nrole :app, %W{#{ENV['AWESOME_USER']}@#{ENV['AWESOME_ADDRESS']}}\nrole :web, %W{#{ENV['AWESOME_USER']}@#{ENV['AWESOME_ADDRESS']}}\nrole :db,  %W{#{ENV['AWESOME_USER']}@#{ENV['AWESOME_ADDRESS']}}\n\n\n# Extended Server Syntax\n# ======================\n# This can be used to drop a more detailed server definition into the\n# server list. The second argument is a, or duck-types, Hash and is\n# used to set extended properties on the server.\n\nserver \"#{ENV['AWESOME_ADDRESS']}\", user: \"#{ENV['AWESOME_USER']}\", roles: %w{web app db}\n\n# Custom SSH Options\n# ==================\n# You may pass any option but keep in mind that net/ssh understands a\n# limited set of options, consult[net/ssh documentation](http://net-ssh.github.io/net-ssh/classes/Net/SSH.html#method-c-start).\n#\n# Global options\n# --------------\nset :ssh_options, {\n#    keys: %w(/home/rlisowski/.ssh/id_rsa),\n#    forward_agent: false,\n  auth_methods: %w(password),\n  password: ENV['AWESOME_PASS']\n}\n#\n# And/or per server (overrides global)\n# ------------------------------------\n# server 'example.com',\n#   user: 'user_name',\n#   roles: %w{web app},\n#   ssh_options: {\n#     user: 'user_name', # overrides user setting above\n#     keys: %w(/home/user_name/.ssh/id_rsa),\n#     forward_agent: false,\n#     auth_methods: %w(publickey password)\n#     # password: 'please use keys'\n#   }\n```\n\nlib/capistrano/tasks/unicorn.cap\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\nNginx\u3068\u306fport8080\u3067\u901a\u4fe1\u3059\u308b\u60f3\u5b9a\u3067\u3059\u3002\n\n```rb:lib/capistrano/tasks/unicorn.cap\nnamespace :unicorn do\n  task :environment do\n    set :unicorn_pid, \"#{shared_path}/tmp/pids/unicorn.pid\"\n    set :unicorn_config, \"#{current_path}/config/unicorn/#{fetch(:rails_env)}.rb\"\n  end\n\n  def start_unicorn\n    within current_path do\n      execute :bundle, :exec, :unicorn_rails, \"-c #{fetch(:unicorn_config)} -E #{fetch(:rails_env)} -p 8080 -D\"\n    end\n  end\n\n  def stop_unicorn\n    execute :kill, \"-s QUIT $(< #{fetch(:unicorn_pid)})\"\n  end\n\n  def reload_unicorn\n    execute :kill, \"-s USR2 $(< #{fetch(:unicorn_pid)})\"\n  end\n\n  def force_stop_unicorn\n    execute :kill, \"$(< #{fetch(:unicorn_pid)})\"\n  end\n\n  desc \"Start unicorn server\"\n  task :start => :environment do\n    on roles(:app) do\n      start_unicorn\n    end\n  end\n\n  desc \"Stop unicorn server gracefully\"\n  task :stop => :environment do\n    on roles(:app) do\n      stop_unicorn\n    end\n  end\n\n  desc \"Restart unicorn server gracefully\"\n  task :restart => :environment do\n    on roles(:app) do\n      if test(\"[ -f #{fetch(:unicorn_pid)} ]\")\n        reload_unicorn\n      else\n        start_unicorn\n      end\n    end\n  end\n\n  desc \"Stop unicorn server immediately\"\n  task :force_stop => :environment do\n    on roles(:app) do\n      force_stop_unicorn\n    end\n  end\nend\n```\n\n###\u30bf\u30fc\u30b2\u30c3\u30c8\u30b5\u30fc\u30d0\u30fc\u4e0a\u3067Nginx\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\u672c\u5f53\u306f\u3053\u3053\u3082\u81ea\u52d5\u5316\u3057\u3066\u304a\u304d\u305f\u3044\u3068\u3053\u308d\u3067\u3059\u304c\u3001\u4eca\u56de\u306f\u624b\u52d5\u3067\u8a2d\u5b9a\u3057\u307e\u3057\u305f\u3002\n\uff08[jenkins\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb](https://wiki.jenkins-ci.org/display/JENKINS/Installing+Jenkins+on+Ubuntu)\u304c\u53c2\u8003\u306b\u306a\u308a\u307e\u3059\uff09\n\n```bash\nsudo aptitude -y install nginx\ncd /etc/nginx/sites-available\nsudo rm default ../sites-enabled/default\n```\n\n/etc/nginx/sites-available\u306bawesome_events\u3092\u914d\u7f6e\u3057\u307e\u3059\u3002\nunicorn\u3068\u306fport8080\u3067\u901a\u4fe1\u3055\u305b\u307e\u3059\u3002\n\n```bash:/etc/nginx/sites-available/awesome_events\nupstream app_server {\n    server 127.0.0.1:8080 fail_timeout=0;\n}\n\nserver {\n    listen 80;\n    listen [::]:80 default ipv6only=on;\n    server_name awesome_events;\n\n    location / {\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header Host $http_host;\n        proxy_redirect off;\n\n        if (!-f $request_filename) {\n            proxy_pass http://app_server;\n            break;\n        }\n    }\n}\n```\n\n```bash\nsudo ln -s /etc/nginx/sites-available/awesome_events /etc/nginx/sites-enabled/\nsudo service nginx restart\n```\n\n###deploy\u5834\u6240\u3092\u4f5c\u3063\u3066\u304a\u304d\u307e\u3059\u3002\n\n```bash\nsudo mkdir /var/www\nsudo chown ubuntu /var/www\nsudo chgrp ubuntu /var/www\nsudo chmod +rwx /var/www\n```\n\n##\u30ed\u30fc\u30ab\u30eb\u30de\u30b7\u30f3\u304b\u3089depoy\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\n\n\u30ed\u30fc\u30ab\u30eb\u30de\u30b7\u30f3\u306b\u623b\u3063\u3066\u3001cap\u30b3\u30de\u30f3\u30c9\u3067\u30c7\u30d7\u30ed\u30a4\u3057\u307e\u3059\u3002\n\u3044\u304f\u3064\u304b\u74b0\u5883\u5909\u6570\u3067\u8a2d\u5b9a\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u308b\u306e\u3067\u3001\u5fd8\u308c\u305a\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n```bash\nbundle exec cap staging deploy AWESOME_ADDRESS=xxx.xxx.xxx.xxx AWESOME_USER=ubuntu  AWESOME_PASS=your_password\n```\n\n\u7121\u4e8b\u30c7\u30d7\u30ed\u30a4\u3067\u304d\u307e\u3057\u305f\u3002\n\n\u30bd\u30fc\u30b9\u306fGitHub\u306b\u7f6e\u3044\u3066\u3044\u307e\u3059\u3002\nhttps://github.com/t-oginogin/awesome_eventes\n", "tags": ["capistrano", "Rails", "Cloudn"]}