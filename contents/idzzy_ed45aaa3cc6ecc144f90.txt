{"tags": ["openstack", "nova"], "context": " More than 1 year has passed since last update.\n\nNova Migration Type\nhttp://docs.openstack.org/admin-guide-cloud/compute-configuring-migrations.html\n\nThe migration types are:\n\nNon-live migration (sometimes referred to simply as \u2018migration\u2019)\nThe instance is shut down for a period of time to be moved to another hypervisor. In this case, the instance recognizes that it was rebooted.\n\nLive migration (or \u2018true live migration\u2019)\nAlmost no instance downtime. Useful when the instances must be kept running during the migration.\nThe different types of live migration are:\n\n2-1. Shared storage-based live migration \n   Both hypervisors have access to shared storage.\n2-2. Block live migration \n   No shared storage is required. Incompatible with read-only devices such as CD-ROMs and Configuration Drive (config_drive).\n2-3. Volume-backed live migration \n   Instances are backed by volumes rather than ephemeral disk, no shared storage is required, and migration is supported (currently only available for libvirt-based hypervisors).\n\n\n\n\n\nWhat's this?\n2-1. Shared storage-based live migration \u306e AZ \u9593\nNova instance (running \u72b6\u614b) \u3092\u5225\u306e AZ \u306e Hypervisor (Compute node) \u3078\u79fb\u52d5\n[Case]\n1. Cinder volume \u3092\u63a5\u7d9a\u3057\u3066\u3044\u306a\u3044\u5834\u5408\n2. Cinder volume \u3092\u63a5\u7d9a\u3057\u3066\u3044\u308b\u5834\u5408\n[\u6761\u4ef6]\n\nShared Storage \u3042\u308a\n\u79fb\u52d5\u3059\u308b\u969b\u306b Target Hypervisor (Compute node) \u3092\u6307\u5b9a\n\n\n[Case1] Migrate Nova instance (w/o Cinder volume)\n\nInitial state\n\nHypervisor (Compute node)\n# nova hypervisor-list\n+----+-----------------------+\n| ID | Hypervisor hostname   |\n+----+-----------------------+\n| 6  | node-27               |\n| 9  | node-28               |\n| 15 | node-31               |\n+----+-----------------------+\n\n\nAZ\n# nova availability-zone-list | egrep -A 10 \"^\\| nova\"\n| nova                     | available                              |\n| |- node-27               |                                        |\n| | |- nova-compute        | enabled :-) 2015-02-24T08:01:42.000000 |\n| |- node-28               |                                        |\n| | |- nova-compute        | enabled :-) 2015-02-24T08:01:45.000000 |\n| nova2                    | available                              |\n| |- node-31               |                                        |\n| | |- nova-compute        | enabled :-) 2015-02-24T08:01:42.000000 |\n+--------------------------+----------------------------------------+\n\n\nNova instance is on node-27 of AZ:nova\n# nova list --field name,status,,OS-EXT-STS:vm_state,OS-EXT-AZ:availability_zone,OS-EXT-SRV-ATTR:hypervisor_hostname\n+--------------------------------------+------------+--------+--+----------------------+------------------------------+--------------------------------------+\n| ID                                   | Name       | Status |  | OS-EXT-STS: Vm State | OS-EXT-AZ: Availability Zone | OS-EXT-SRV-ATTR: Hypervisor Hostname |\n+--------------------------------------+------------+--------+--+----------------------+------------------------------+--------------------------------------+\n| 25fc9e72-1236-4580-b103-0edc5520ee8e | admin_vm01 | ACTIVE |  | active               | nova                         | node-27                              |\n+--------------------------------------+------------+--------+--+----------------------+------------------------------+--------------------------------------+\n\n\nMigrate Nova instance\n\nMigration from node-27 to node-31\n# nova live-migration admin_vm01 node-31\n\n\nCheck the migration result\nNova instance is moved from node-27 of AZ:nova to node-31 of AZ:nova2\n# nova list --field name,status,,OS-EXT-STS:vm_state,OS-EXT-AZ:availability_zone,OS-EXT-SRV-ATTR:hypervisor_hostname\n+--------------------------------------+------------+--------+--+----------------------+------------------------------+--------------------------------------+\n| ID                                   | Name       | Status |  | OS-EXT-STS: Vm State | OS-EXT-AZ: Availability Zone | OS-EXT-SRV-ATTR: Hypervisor Hostname |\n+--------------------------------------+------------+--------+--+----------------------+------------------------------+--------------------------------------+\n| 25fc9e72-1236-4580-b103-0edc5520ee8e | admin_vm01 | ACTIVE |  | active               | nova2                        | node-31                              |\n+--------------------------------------+------------+--------+--+----------------------+------------------------------+--------------------------------------+\n\n\n[Case2] Migrate Nova instance (w/ Cinder volume)\n\nInitial State\n\nHypervisor (Compute node)\n# nova hypervisor-list\n+----+-----------------------+\n| ID | Hypervisor hostname   |\n+----+-----------------------+\n| 6  | node-27               |\n| 9  | node-28               |\n| 15 | node-31               |\n+----+-----------------------+\n\n\nAZ\n# nova availability-zone-list | egrep -A 10 \"^\\| nova\"\n| nova                     | available                              |\n| |- node-27               |                                        |\n| | |- nova-compute        | enabled :-) 2015-02-24T08:01:42.000000 |\n| |- node-28               |                                        |\n| | |- nova-compute        | enabled :-) 2015-02-24T08:01:45.000000 |\n| nova2                    | available                              |\n| |- node-31               |                                        |\n| | |- nova-compute        | enabled :-) 2015-02-24T08:01:42.000000 |\n+--------------------------+----------------------------------------+\n\n\nNova instance is on node-28 of AZ:nova\n# nova list --field name,status,,OS-EXT-STS:vm_state,OS-EXT-AZ:availability_zone,OS-EXT-SRV-ATTR:hypervisor_hostname\n+--------------------------------------+------------+--------+--+----------------------+------------------------------+--------------------------------------+\n| ID                                   | Name       | Status |  | OS-EXT-STS: Vm State | OS-EXT-AZ: Availability Zone | OS-EXT-SRV-ATTR: Hypervisor Hostname |\n+--------------------------------------+------------+--------+--+----------------------+------------------------------+--------------------------------------+\n| e08aa732-5af9-417e-a577-95495da77da1 | admin_vm01 | ACTIVE |  | active               | nova                         | node-28                              |\n+--------------------------------------+------------+--------+--+----------------------+------------------------------+--------------------------------------+\n\n\nWith Cinder volume\n# cinder list\n+--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+\n|                  ID                  |   Status  | Display Name | Size | Volume Type | Bootable |             Attached to              |\n+--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+\n| 41dc0b12-b7fd-4ae7-b77e-478c97ee308c |   in-use  | admin_vol01  |  1   |     None    |  false   | e08aa732-5af9-417e-a577-95495da77da1 |\n+--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+\n\n# cinder show admin_vol01 | egrep \"Property|availability_zone\"\n|            Property            | Value                   |\n|       availability_zone        | nova                    |\n\n# nova show admin_vm01 | egrep \"Property|volumes_attached\"\n| Property                             | Value                                                    |\n| os-extended-volumes:volumes_attached | [{\"id\": \"41dc0b12-b7fd-4ae7-b77e-478c97ee308c\"}]         |\n\n\nInstance\n$ ssh cirros@{INSTANCE} lsblk\nNAME   MAJ:MIN RM    SIZE RO TYPE MOUNTPOINT\nvda    253:0    0      1G  0 disk\n`-vda1 253:1    0 1011.9M  0 part /\nvdb    253:16   0      1G  0 disk\n`-vdb1 253:17   0   1023M  0 part /mnt/vol01\n\n$ ssh cirros@{INSTANCE} df -h /mnt/vol01/\nFilesystem                Size      Used Available Use% Mounted on\n/dev/vdb1              1006.9M     17.3M    938.5M   2% /mnt/vol01\n\n\nMigrate Nova instance\n\nMigration from node-28 to node-31\n# nova live-migration admin_vm01 node-31\n\n\nCheck the migration result\n\nNova instance is moved from node-28 of AZ:nova to node-31 of AZ:nova2\n\n    # nova list --field name,status,,OS-EXT-STS:vm_state,OS-EXT-AZ:availability_zone,OS-EXT-SRV-ATTR:hypervisor_hostname\n    +--------------------------------------+------------+--------+--+----------------------+------------------------------+--------------------------------------+\n    | ID                                   | Name       | Status |  | OS-EXT-STS: Vm State | OS-EXT-AZ: Availability Zone | OS-EXT-SRV-ATTR: Hypervisor Hostname |\n    +--------------------------------------+------------+--------+--+----------------------+------------------------------+--------------------------------------+\n    | e08aa732-5af9-417e-a577-95495da77da1 | admin_vm01 | ACTIVE |  | active               | nova2                        | node-31                              |\n    +--------------------------------------+------------+--------+--+----------------------+------------------------------+--------------------------------------+\n\n\nCinder status\n\n    $ ssh cirros@{INSTANCE} lsblk\n    NAME   MAJ:MIN RM    SIZE RO TYPE MOUNTPOINT\n    vda    253:0    0      1G  0 disk\n    `-vda1 253:1    0 1011.9M  0 part /\n    vdb    253:16   0      1G  0 disk\n    `-vdb1 253:17   0   1023M  0 part /mnt/vol01\n\n\nInstance\n\n    $ ssh cirros@{INSTANCE} df -h /mnt/vol01/\n    Filesystem                Size      Used Available Use% Mounted on\n    /dev/vdb1              1006.9M     17.3M    938.5M   2% /mnt/vol01\n\n\nEnvironment\n\nOpenstack : Juno\nCeph : Firefly\n\n\nReference\nNova Migration (non live migration) to Different Hypervisor\nNova Migration (non live migration) to Different Hypervisor between AZ\nNova Migration (true live migration) to Different Hypervisor\nNova Migration (true live migration) to Different Hypervisor between AZ\nNova Migration (Manually) between AZ\nNova Migration (Manually) between Region\nNova Migration (true live migration) to Different Hypervisor - Volume-backend live migration (instance)\nNova Migration (true live migration) to Different Hypervisor - Volume-backend live migration (instance) between AZ\n## Nova Migration Type\n\nhttp://docs.openstack.org/admin-guide-cloud/compute-configuring-migrations.html\n\n> **The migration types are:**\n>\n> 1. **Non-live migration** (sometimes referred to simply as \u2018migration\u2019)\n> The instance is shut down for a period of time to be moved to another hypervisor. In this case, the instance recognizes that it was rebooted.\n>\n> 2. **Live migration** (or \u2018true live migration\u2019)\n> Almost no instance downtime. Useful when the instances must be kept running during the migration.\n> The different types of live migration are:\n>     - 2-1. **Shared storage-based live migration** <br>\n>            Both hypervisors have access to shared storage.\n>     - 2-2. **Block live migration** <br>\n>            No shared storage is required. Incompatible with read-only devices such as CD-ROMs and Configuration Drive (config_drive).\n>     - 2-3. **Volume-backed live migration** <br>\n>            Instances are backed by volumes rather than ephemeral disk, no shared storage is required, and migration is supported (currently only available for libvirt-based hypervisors).\n\n## What's this?\n\n**2-1. Shared storage-based live migration** \u306e AZ \u9593\n\nNova instance (running \u72b6\u614b) \u3092\u5225\u306e AZ \u306e Hypervisor (Compute node) \u3078\u79fb\u52d5\n\n[Case]\n1. Cinder volume \u3092\u63a5\u7d9a\u3057\u3066\u3044\u306a\u3044\u5834\u5408\n2. Cinder volume \u3092\u63a5\u7d9a\u3057\u3066\u3044\u308b\u5834\u5408\n\n[\u6761\u4ef6]\n\n* Shared Storage \u3042\u308a\n* \u79fb\u52d5\u3059\u308b\u969b\u306b Target Hypervisor (Compute node) \u3092\u6307\u5b9a\n\n\n## [Case1] Migrate Nova instance (w/o Cinder volume)\n\n### Initial state\n\n#### Hypervisor (Compute node)\n\n    # nova hypervisor-list\n    +----+-----------------------+\n    | ID | Hypervisor hostname   |\n    +----+-----------------------+\n    | 6  | node-27               |\n    | 9  | node-28               |\n    | 15 | node-31               |\n    +----+-----------------------+\n\n#### AZ\n\n    # nova availability-zone-list | egrep -A 10 \"^\\| nova\"\n    | nova                     | available                              |\n    | |- node-27               |                                        |\n    | | |- nova-compute        | enabled :-) 2015-02-24T08:01:42.000000 |\n    | |- node-28               |                                        |\n    | | |- nova-compute        | enabled :-) 2015-02-24T08:01:45.000000 |\n    | nova2                    | available                              |\n    | |- node-31               |                                        |\n    | | |- nova-compute        | enabled :-) 2015-02-24T08:01:42.000000 |\n    +--------------------------+----------------------------------------+\n\n#### Nova instance is on node-27 of AZ:nova\n\n    # nova list --field name,status,,OS-EXT-STS:vm_state,OS-EXT-AZ:availability_zone,OS-EXT-SRV-ATTR:hypervisor_hostname\n    +--------------------------------------+------------+--------+--+----------------------+------------------------------+--------------------------------------+\n    | ID                                   | Name       | Status |  | OS-EXT-STS: Vm State | OS-EXT-AZ: Availability Zone | OS-EXT-SRV-ATTR: Hypervisor Hostname |\n    +--------------------------------------+------------+--------+--+----------------------+------------------------------+--------------------------------------+\n    | 25fc9e72-1236-4580-b103-0edc5520ee8e | admin_vm01 | ACTIVE |  | active               | nova                         | node-27                              |\n    +--------------------------------------+------------+--------+--+----------------------+------------------------------+--------------------------------------+\n\n### Migrate Nova instance\n\n#### Migration from node-27 to node-31\n\n    # nova live-migration admin_vm01 node-31\n\n#### Check the migration result\n\nNova instance is moved from node-27 of AZ:nova to node-31 of AZ:nova2\n\n    # nova list --field name,status,,OS-EXT-STS:vm_state,OS-EXT-AZ:availability_zone,OS-EXT-SRV-ATTR:hypervisor_hostname\n    +--------------------------------------+------------+--------+--+----------------------+------------------------------+--------------------------------------+\n    | ID                                   | Name       | Status |  | OS-EXT-STS: Vm State | OS-EXT-AZ: Availability Zone | OS-EXT-SRV-ATTR: Hypervisor Hostname |\n    +--------------------------------------+------------+--------+--+----------------------+------------------------------+--------------------------------------+\n    | 25fc9e72-1236-4580-b103-0edc5520ee8e | admin_vm01 | ACTIVE |  | active               | nova2                        | node-31                              |\n    +--------------------------------------+------------+--------+--+----------------------+------------------------------+--------------------------------------+\n\n\n\n\n## [Case2] Migrate Nova instance (w/ Cinder volume)\n\n### Initial State\n\n#### Hypervisor (Compute node)\n\n    # nova hypervisor-list\n    +----+-----------------------+\n    | ID | Hypervisor hostname   |\n    +----+-----------------------+\n    | 6  | node-27               |\n    | 9  | node-28               |\n    | 15 | node-31               |\n    +----+-----------------------+\n\n#### AZ\n\n    # nova availability-zone-list | egrep -A 10 \"^\\| nova\"\n    | nova                     | available                              |\n    | |- node-27               |                                        |\n    | | |- nova-compute        | enabled :-) 2015-02-24T08:01:42.000000 |\n    | |- node-28               |                                        |\n    | | |- nova-compute        | enabled :-) 2015-02-24T08:01:45.000000 |\n    | nova2                    | available                              |\n    | |- node-31               |                                        |\n    | | |- nova-compute        | enabled :-) 2015-02-24T08:01:42.000000 |\n    +--------------------------+----------------------------------------+\n\n#### Nova instance is on node-28 of AZ:nova\n\n    # nova list --field name,status,,OS-EXT-STS:vm_state,OS-EXT-AZ:availability_zone,OS-EXT-SRV-ATTR:hypervisor_hostname\n    +--------------------------------------+------------+--------+--+----------------------+------------------------------+--------------------------------------+\n    | ID                                   | Name       | Status |  | OS-EXT-STS: Vm State | OS-EXT-AZ: Availability Zone | OS-EXT-SRV-ATTR: Hypervisor Hostname |\n    +--------------------------------------+------------+--------+--+----------------------+------------------------------+--------------------------------------+\n    | e08aa732-5af9-417e-a577-95495da77da1 | admin_vm01 | ACTIVE |  | active               | nova                         | node-28                              |\n    +--------------------------------------+------------+--------+--+----------------------+------------------------------+--------------------------------------+\n\n#### With Cinder volume\n\n    # cinder list\n    +--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+\n    |                  ID                  |   Status  | Display Name | Size | Volume Type | Bootable |             Attached to              |\n    +--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+\n    | 41dc0b12-b7fd-4ae7-b77e-478c97ee308c |   in-use  | admin_vol01  |  1   |     None    |  false   | e08aa732-5af9-417e-a577-95495da77da1 |\n    +--------------------------------------+-----------+--------------+------+-------------+----------+--------------------------------------+\n\n    # cinder show admin_vol01 | egrep \"Property|availability_zone\"\n    |            Property            | Value                   |\n    |       availability_zone        | nova                    |\n\n    # nova show admin_vm01 | egrep \"Property|volumes_attached\"\n    | Property                             | Value                                                    |\n    | os-extended-volumes:volumes_attached | [{\"id\": \"41dc0b12-b7fd-4ae7-b77e-478c97ee308c\"}]         |\n\n#### Instance\n\n    $ ssh cirros@{INSTANCE} lsblk\n    NAME   MAJ:MIN RM    SIZE RO TYPE MOUNTPOINT\n    vda    253:0    0      1G  0 disk\n    `-vda1 253:1    0 1011.9M  0 part /\n    vdb    253:16   0      1G  0 disk\n    `-vdb1 253:17   0   1023M  0 part /mnt/vol01\n\n    $ ssh cirros@{INSTANCE} df -h /mnt/vol01/\n    Filesystem                Size      Used Available Use% Mounted on\n    /dev/vdb1              1006.9M     17.3M    938.5M   2% /mnt/vol01\n\n\n### Migrate Nova instance\n\n#### Migration from node-28 to node-31\n\n    # nova live-migration admin_vm01 node-31\n\n#### Check the migration result\n\n* Nova instance is moved from node-28 of AZ:nova to node-31 of AZ:nova2\n\n````\n    # nova list --field name,status,,OS-EXT-STS:vm_state,OS-EXT-AZ:availability_zone,OS-EXT-SRV-ATTR:hypervisor_hostname\n    +--------------------------------------+------------+--------+--+----------------------+------------------------------+--------------------------------------+\n    | ID                                   | Name       | Status |  | OS-EXT-STS: Vm State | OS-EXT-AZ: Availability Zone | OS-EXT-SRV-ATTR: Hypervisor Hostname |\n    +--------------------------------------+------------+--------+--+----------------------+------------------------------+--------------------------------------+\n    | e08aa732-5af9-417e-a577-95495da77da1 | admin_vm01 | ACTIVE |  | active               | nova2                        | node-31                              |\n    +--------------------------------------+------------+--------+--+----------------------+------------------------------+--------------------------------------+\n````\n\n* Cinder status\n\n````\n    $ ssh cirros@{INSTANCE} lsblk\n    NAME   MAJ:MIN RM    SIZE RO TYPE MOUNTPOINT\n    vda    253:0    0      1G  0 disk\n    `-vda1 253:1    0 1011.9M  0 part /\n    vdb    253:16   0      1G  0 disk\n    `-vdb1 253:17   0   1023M  0 part /mnt/vol01\n````\n\n* Instance\n\n````\n    $ ssh cirros@{INSTANCE} df -h /mnt/vol01/\n    Filesystem                Size      Used Available Use% Mounted on\n    /dev/vdb1              1006.9M     17.3M    938.5M   2% /mnt/vol01\n````\n\n## Environment\n\n* Openstack : Juno\n* Ceph : Firefly\n\n## Reference\n\n[Nova Migration (non live migration) to Different Hypervisor][link-01]\n[Nova Migration (non live migration) to Different Hypervisor between AZ][link-02]\n[Nova Migration (true live migration) to Different Hypervisor][link-03]\n[Nova Migration (true live migration) to Different Hypervisor between AZ][link-04]\n[Nova Migration (Manually) between AZ][link-05]\n[Nova Migration (Manually) between Region][link-06]\n[Nova Migration (true live migration) to Different Hypervisor - Volume-backend live migration (instance)][link-07]\n[Nova Migration (true live migration) to Different Hypervisor - Volume-backend live migration (instance) between AZ][link-08]\n\n[link-01]:http://qiita.com/idzzy/items/a3032dce3110f959e11b\n[link-02]:http://qiita.com/idzzy/items/3d67b3cedd42d39a8e2a\n[link-03]:http://qiita.com/idzzy/items/a03b19e0c0289a63e491\n[link-04]:http://qiita.com/idzzy/items/ed45aaa3cc6ecc144f90\n[link-05]:http://qiita.com/idzzy/items/98967887a0d3771a7795\n[link-06]:http://qiita.com/idzzy/items/01b32f52e7cf0e4c5f55\n[link-07]:http://qiita.com/idzzy/items/515776f1461bb5c96eea\n[link-08]:http://qiita.com/idzzy/items/5c54443c0d36f0a14e72\n"}