{"context": " More than 1 year has passed since last update.\n\n\u3084\u308a\u305f\u304b\u3063\u305f\u4e8b\n\najax\u3067\u30d5\u30a1\u30a4\u30eb\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\uff08\u3053\u306e\u6642\u70b9\u3067\u30b5\u30fc\u30d0\u306b\u30ea\u30bd\u30fc\u30b9\u98df\u308f\u305b\u305f\u304f\u306a\u3044\u306e\u3067\u30c1\u30a7\u30c3\u30af\u306e\u307f\uff09\nPHP\u3067\u30d5\u30a1\u30a4\u30eb\u30c1\u30a7\u30c3\u30af + S3\u306e\u30dd\u30ea\u30b7\u30fc\u4f5c\u6210\u3092\u3057\u3066\u8fd4\u5374\nXMLHttpRequest\u3067\u30d5\u30a1\u30a4\u30eb\u30c7\u30fc\u30bf\u3092S3\u306b\u76f4\u63a5\u9001\u4fe1\n\u30a6\u30de\u30fc\n\n\u5fc5\u8981\u306a\u306e\u3067\u8abf\u67fb\u3057\u305f\u3051\u3069\u3074\u3063\u305f\u308a\u306a\u3082\u306e\u304c\u306a\u304b\u3063\u305f\u306e\u3067\u30b5\u30fc\u30d0\u30b5\u30a4\u30c9\u304cRuby\u7248\u306e\u4ee5\u4e0b\u3092\u53c2\u8003\u306bPHP\u3067\u30b9\u30ea\u30e0\u306b\u4f5c\u308a\u76f4\u3057\u305f\u3002\nQiita\u306e\u753b\u50cf\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u6a5f\u80fd\u3082\u7c21\u5358\u306b\u5b9f\u88c5\u3067\u304d\u308b\u3002\u305d\u3046\u3001S3\u306a\u3089\u306d\u3002\n\u5c11\u3005\u8a70\u307e\u3063\u305f\u90e8\u5206\u3082\u3042\u3063\u305f\u3051\u3069\u52d5\u4f5c\u3057\u305f\u306e\u3067\u5099\u5fd8\u9332\u7684\u306b\u3002\n\n\u30bd\u30fc\u30b9\n\u307e\u305a\u306f\u30b5\u30fc\u30d0\u30b5\u30a4\u30c9\u304b\u3089\u3002\ngetPolicy.php\n\n<?php\n\n$accesskey = 'Your AWS Access Key' // TODO\n$secret = 'Your AWS Access Secret'; // TODO\n$bucket = 'Your Bucket Name'; // TODO\n\n$key = 'path/to/updatefilename'; // TODO\n$expiration = gmdate(\"Y-m-d\\TH:i:s\\Z\",strtotime(\"1 minute\")); // Policy Limit\n$acl = 'public-read'; // set acl (private | public-read | public-read-write | authenticated-read | bucket-owner-read | bucket-owner-full-control)\n$status = '200'; // return this status code when upload success.\n\n$ctype = $_GET['ctype'];\n$clength = $_GET['clength'];\n$policy = <<<EOS\n    {\n        \"expiration\": \"$expiration\",\n        \"conditions\": [\n            {\"bucket\": \"$bucket\"},\n            {\"key\": \"$key\"},\n            {\"acl\": \"$acl\"},\n            {\"success_action_status\": \"$status\"},\n            {\"Content-Type\": \"$ctype\"},\n            [\"content-length-range\", $clength, $clength]\n        ]\n    }\nEOS;\n//var_dump($policy);\n$signature = hash_hmac(\"sha1\", base64_encode($policy), $secret, true);\nexit(json_encode(array(\n    'url' => 'http://'.$bucket.'.s3.amazonaws.com/',\n    'form' => array(\n        'AWSAccessKeyId' => $accesskey,\n        'signature' => base64_encode($signature),\n        'policy' => base64_encode($policy),\n        'key' => $key,\n        'acl' => $acl,\n        'success_action_status' => $status,\n        'Content-Type' => $ctype\n    )\n), true));\n\n?>\n\n\nTODO\u306e\u90e8\u5206\u306f\u66f8\u304d\u63db\u3048\u304c\u5fc5\u8981\u3067\u3059\u3088\u3002\n\u6b21\u306b\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u3002\nindex.html\n\n<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:fb=\"http://ogp.me/ns/fb#\">\n<head>\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"/>\n<script src=\"//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js\"></script>\n<script>\n    $().ready(function() {\n        $('#s3form input[type=\"file\"]').on('change', function (e) {\n            // \u30d5\u30a1\u30a4\u30eb\u306e\u60c5\u5831\u3092\u30c1\u30a7\u30c3\u30af\u3057\u3066\u30d1\u30e9\u30e1\u30fc\u30bf\u751f\u6210.\u5fc5\u8981\u3067\u3042\u308c\u3070\u8a31\u53ef\u30d5\u30a1\u30a4\u30eb\u4ee5\u5916\u3092\u306f\u3058\u304f.\n            var file = e.target.files[0];\n            var data = {ctype:file.type, clength:file.size};\n\n            // \u30b5\u30fc\u30d0\u304b\u3089policy\u3068signature\u3092\u53d6\u5f97.\n            var $form = $('#s3form');\n            $.ajax({\n                url: $form.attr('action'),\n                type: $form.attr('method'),\n                dataType: 'json',\n                data: data\n            }).done(function (data) {\n                    // \u30b5\u30fc\u30d0\u304c\u8fd4\u3057\u305f\u60c5\u5831\u3092\u305d\u306e\u307e\u307e\u4f7f\u3063\u3066FormData\u3092\u4f5c\u308b.\n                    var name, fd = new FormData();\n                    for (name in data.form) if (data.form.hasOwnProperty(name)) {\n                        fd.append(name, data.form[name]);\n                    }\n                    fd.append('file', file); // \u30d5\u30a1\u30a4\u30eb\u6dfb\u4ed8.\n\n                    // \u9001\u4fe1\n                    var xhr = new XMLHttpRequest();\n                    xhr.open('POST', data.url, true);\n                    xhr.send(fd);\n                })\n        });\n    });\n</script>\n</head>\n<body>\n    <form id=\"s3form\" action=\"getPolicy.php\" method=\"get\" enctype=\"multipart/form-data\">\n        <input type=\"file\"   name=\"file\"/>\n    </form>\n</body>\n</html>\n\n\n\n\u56f0\u3063\u305f\u4e8b\n\n\u9001\u4fe1\u6210\u529f\u5f8c\u3082\u30b9\u30c6\u30fc\u30bf\u30b9\u30b3\u30fc\u30c9200\u3067Firebugs\u304c\u30a8\u30e9\u30fc\u5410\u304f\n\u6587\u5b57\u304c1\u6587\u5b57\u3082\u51fa\u529b\u3055\u308c\u306a\u3044\u4e8b\u304c\u554f\u984c\u304b\u3068\u601d\u3063\u3066(Flash\u304c\u305d\u3046\u3060\u3063\u305f\u3088\u3046\u306a\u6c17\u304c\u3057\u3066)\nsuccess_action_redirect\n\u3068\u3044\u3046\u30d1\u30e9\u30e1\u30fc\u30bf\u3067\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u5148\u3092\u6307\u5b9a\u3059\u308b\u3068\u8ee2\u9001\u3055\u308c\u308b\u306e\u3067\u305d\u3061\u3089\u304b\u3089\u7d50\u679c\u3092\u8fd4\u3057\u3066\u307f\u305f\u3051\u3069\u7d50\u679c\u5909\u308f\u3089\u305a\u3002\u3002\n\u5c11\u3057\u8abf\u3079\u3066\u307f\u308b\u3068\u30af\u30ed\u30b9\u30c9\u30e1\u30a4\u30f3\u7684\u306a\u554f\u984c\u3060\u308d\u3046\u3068\u601d\u3044\u30b9\u30eb\u30fc\u3059\u308b\u4e8b\u306b\u3002\n\u203bFireBugs\u306b\u306f\u4ee5\u4e0b\u306e\u69d8\u306b\u51fa\u529b\u3055\u308c\u3066\u3044\u308b\u306e\u3060\u3051\u3069\u540c\u3058\u30ea\u30af\u30a8\u30b9\u30c8\u6295\u3052\u308b\u3068\u4f55\u3082\u8fd4\u3089\u306a\u3044\u30fb\u30fb\u30fb\u8b0e\n\nXML \u30d1\u30fc\u30b9\u30a8\u30e9\u30fc: \u8981\u7d20\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093\u3002 URL: moz-nullprincipal:{8712ffa2-7301-d54a-aa47-f22e156c6d6d} \u884c\u756a\u53f7: 1, \u5217\u756a\u53f7: 1:\n\n\n400 Bad Request\u304c\u8fd4\u3063\u3066\u304f\u308b\n\u3053\u308c\u306fLive Http headers\u3067\u89e3\u6790\u3057\u305f\u3089\u3044\u304f\u3064\u304b\u539f\u56e0\u304c\u3042\u3063\u305f\n\u30fb\u4f5c\u6210\u3057\u305fPolicy\u306e\u5185\u5bb9\u3068\u30d5\u30a9\u30fc\u30e0\u304b\u3089\u9001\u4fe1\u3057\u3066\u3044\u308b\u30d1\u30e9\u30e1\u30fc\u30bf\u304c\u9055\u3063\u3066\u3044\u308b => \u4e0a\u8a18\u30bd\u30fc\u30b9\u306e\u901a\u308acontent-length-range\u306e\u307f\u306f\u30b9\u30eb\u30fc\u3055\u308c\u3066\u3044\u308b\u3088\u3046\n\u30fb\u5b9f\u9a13\u3057\u3059\u304e\u3066Policy\u6709\u52b9\u671f\u9650\u306e1\u5206\u3092\u8d85\u3048\u3066\u3044\u305f\n\u30fbPolicy\u304cjson\u5f62\u5f0f\u306b\u306a\u3063\u3066\u3044\u306a\u3044 => \u901a\u5e38\u306ejson\uff08\u30b3\u30ed\u30f3\u533a\u5207\u308a\u306e{}\u9589\u3058\uff09\u3068\u5165\u308c\u5f8c\u5f62\u5f0f\uff08\u30ab\u30f3\u30de\u533a\u5207\u308a\u306e[]\u9589\u3058\uff09\u306e\u9593\u9055\u3044\n\u306a\u305e\u306a\u305e\u3067\u3057\u305f\u3002\n\u4ee5\u4e0a\u3002\n## \u3084\u308a\u305f\u304b\u3063\u305f\u4e8b\n\n1. ajax\u3067\u30d5\u30a1\u30a4\u30eb\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\uff08\u3053\u306e\u6642\u70b9\u3067\u30b5\u30fc\u30d0\u306b\u30ea\u30bd\u30fc\u30b9\u98df\u308f\u305b\u305f\u304f\u306a\u3044\u306e\u3067\u30c1\u30a7\u30c3\u30af\u306e\u307f\uff09\n2. PHP\u3067\u30d5\u30a1\u30a4\u30eb\u30c1\u30a7\u30c3\u30af + S3\u306e\u30dd\u30ea\u30b7\u30fc\u4f5c\u6210\u3092\u3057\u3066\u8fd4\u5374\n3. XMLHttpRequest\u3067\u30d5\u30a1\u30a4\u30eb\u30c7\u30fc\u30bf\u3092S3\u306b\u76f4\u63a5\u9001\u4fe1\n4. \u30a6\u30de\u30fc\n\n\n\u5fc5\u8981\u306a\u306e\u3067\u8abf\u67fb\u3057\u305f\u3051\u3069\u3074\u3063\u305f\u308a\u306a\u3082\u306e\u304c\u306a\u304b\u3063\u305f\u306e\u3067\u30b5\u30fc\u30d0\u30b5\u30a4\u30c9\u304cRuby\u7248\u306e\u4ee5\u4e0b\u3092\u53c2\u8003\u306bPHP\u3067\u30b9\u30ea\u30e0\u306b\u4f5c\u308a\u76f4\u3057\u305f\u3002\n\n[Qiita\u306e\u753b\u50cf\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u6a5f\u80fd\u3082\u7c21\u5358\u306b\u5b9f\u88c5\u3067\u304d\u308b\u3002\u305d\u3046\u3001S3\u306a\u3089\u306d\u3002](http://qiita.com/yuku_t/items/40b7daf018d3dab48974)\n\n\u5c11\u3005\u8a70\u307e\u3063\u305f\u90e8\u5206\u3082\u3042\u3063\u305f\u3051\u3069\u52d5\u4f5c\u3057\u305f\u306e\u3067\u5099\u5fd8\u9332\u7684\u306b\u3002\n\n## \u30bd\u30fc\u30b9\n\n\u307e\u305a\u306f\u30b5\u30fc\u30d0\u30b5\u30a4\u30c9\u304b\u3089\u3002\n**getPolicy.php**\n\n```php\n\n<?php\n\n$accesskey = 'Your AWS Access Key' // TODO\n$secret = 'Your AWS Access Secret'; // TODO\n$bucket = 'Your Bucket Name'; // TODO\n\n$key = 'path/to/updatefilename'; // TODO\n$expiration = gmdate(\"Y-m-d\\TH:i:s\\Z\",strtotime(\"1 minute\")); // Policy Limit\n$acl = 'public-read'; // set acl (private | public-read | public-read-write | authenticated-read | bucket-owner-read | bucket-owner-full-control)\n$status = '200'; // return this status code when upload success.\n\n$ctype = $_GET['ctype'];\n$clength = $_GET['clength'];\n$policy = <<<EOS\n    {\n        \"expiration\": \"$expiration\",\n        \"conditions\": [\n            {\"bucket\": \"$bucket\"},\n            {\"key\": \"$key\"},\n            {\"acl\": \"$acl\"},\n            {\"success_action_status\": \"$status\"},\n            {\"Content-Type\": \"$ctype\"},\n            [\"content-length-range\", $clength, $clength]\n        ]\n    }\nEOS;\n//var_dump($policy);\n$signature = hash_hmac(\"sha1\", base64_encode($policy), $secret, true);\nexit(json_encode(array(\n    'url' => 'http://'.$bucket.'.s3.amazonaws.com/',\n    'form' => array(\n        'AWSAccessKeyId' => $accesskey,\n        'signature' => base64_encode($signature),\n        'policy' => base64_encode($policy),\n        'key' => $key,\n        'acl' => $acl,\n        'success_action_status' => $status,\n        'Content-Type' => $ctype\n    )\n), true));\n\n?>\n\n```\n\n**TODO**\u306e\u90e8\u5206\u306f\u66f8\u304d\u63db\u3048\u304c\u5fc5\u8981\u3067\u3059\u3088\u3002\n\u6b21\u306b\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u3002\n\n**index.html**\n\n```html\n\n<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:fb=\"http://ogp.me/ns/fb#\">\n<head>\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"/>\n<script src=\"//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js\"></script>\n<script>\n    $().ready(function() {\n        $('#s3form input[type=\"file\"]').on('change', function (e) {\n            // \u30d5\u30a1\u30a4\u30eb\u306e\u60c5\u5831\u3092\u30c1\u30a7\u30c3\u30af\u3057\u3066\u30d1\u30e9\u30e1\u30fc\u30bf\u751f\u6210.\u5fc5\u8981\u3067\u3042\u308c\u3070\u8a31\u53ef\u30d5\u30a1\u30a4\u30eb\u4ee5\u5916\u3092\u306f\u3058\u304f.\n            var file = e.target.files[0];\n            var data = {ctype:file.type, clength:file.size};\n\n            // \u30b5\u30fc\u30d0\u304b\u3089policy\u3068signature\u3092\u53d6\u5f97.\n            var $form = $('#s3form');\n            $.ajax({\n                url: $form.attr('action'),\n                type: $form.attr('method'),\n                dataType: 'json',\n                data: data\n            }).done(function (data) {\n                    // \u30b5\u30fc\u30d0\u304c\u8fd4\u3057\u305f\u60c5\u5831\u3092\u305d\u306e\u307e\u307e\u4f7f\u3063\u3066FormData\u3092\u4f5c\u308b.\n                    var name, fd = new FormData();\n                    for (name in data.form) if (data.form.hasOwnProperty(name)) {\n                        fd.append(name, data.form[name]);\n                    }\n                    fd.append('file', file); // \u30d5\u30a1\u30a4\u30eb\u6dfb\u4ed8.\n\n                    // \u9001\u4fe1\n                    var xhr = new XMLHttpRequest();\n                    xhr.open('POST', data.url, true);\n                    xhr.send(fd);\n                })\n        });\n    });\n</script>\n</head>\n<body>\n    <form id=\"s3form\" action=\"getPolicy.php\" method=\"get\" enctype=\"multipart/form-data\">\n        <input type=\"file\"   name=\"file\"/>\n    </form>\n</body>\n</html>\n\n```\n\n## \u56f0\u3063\u305f\u4e8b\n\n### \u9001\u4fe1\u6210\u529f\u5f8c\u3082\u30b9\u30c6\u30fc\u30bf\u30b9\u30b3\u30fc\u30c9200\u3067Firebugs\u304c\u30a8\u30e9\u30fc\u5410\u304f\n\n\u6587\u5b57\u304c1\u6587\u5b57\u3082\u51fa\u529b\u3055\u308c\u306a\u3044\u4e8b\u304c\u554f\u984c\u304b\u3068\u601d\u3063\u3066(Flash\u304c\u305d\u3046\u3060\u3063\u305f\u3088\u3046\u306a\u6c17\u304c\u3057\u3066)\n*success_action_redirect*\n\u3068\u3044\u3046\u30d1\u30e9\u30e1\u30fc\u30bf\u3067\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u5148\u3092\u6307\u5b9a\u3059\u308b\u3068\u8ee2\u9001\u3055\u308c\u308b\u306e\u3067\u305d\u3061\u3089\u304b\u3089\u7d50\u679c\u3092\u8fd4\u3057\u3066\u307f\u305f\u3051\u3069\u7d50\u679c\u5909\u308f\u3089\u305a\u3002\u3002\n\u5c11\u3057\u8abf\u3079\u3066\u307f\u308b\u3068\u30af\u30ed\u30b9\u30c9\u30e1\u30a4\u30f3\u7684\u306a\u554f\u984c\u3060\u308d\u3046\u3068\u601d\u3044\u30b9\u30eb\u30fc\u3059\u308b\u4e8b\u306b\u3002\n\u203bFireBugs\u306b\u306f\u4ee5\u4e0b\u306e\u69d8\u306b\u51fa\u529b\u3055\u308c\u3066\u3044\u308b\u306e\u3060\u3051\u3069\u540c\u3058\u30ea\u30af\u30a8\u30b9\u30c8\u6295\u3052\u308b\u3068\u4f55\u3082\u8fd4\u3089\u306a\u3044\u30fb\u30fb\u30fb\u8b0e\n\n```\n\nXML \u30d1\u30fc\u30b9\u30a8\u30e9\u30fc: \u8981\u7d20\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093\u3002 URL: moz-nullprincipal:{8712ffa2-7301-d54a-aa47-f22e156c6d6d} \u884c\u756a\u53f7: 1, \u5217\u756a\u53f7: 1:\n```\n\n\n### 400 Bad Request\u304c\u8fd4\u3063\u3066\u304f\u308b\n\n\n\u3053\u308c\u306fLive Http headers\u3067\u89e3\u6790\u3057\u305f\u3089\u3044\u304f\u3064\u304b\u539f\u56e0\u304c\u3042\u3063\u305f\n\u30fb\u4f5c\u6210\u3057\u305fPolicy\u306e\u5185\u5bb9\u3068\u30d5\u30a9\u30fc\u30e0\u304b\u3089\u9001\u4fe1\u3057\u3066\u3044\u308b\u30d1\u30e9\u30e1\u30fc\u30bf\u304c\u9055\u3063\u3066\u3044\u308b => \u4e0a\u8a18\u30bd\u30fc\u30b9\u306e\u901a\u308a*content-length-range*\u306e\u307f\u306f\u30b9\u30eb\u30fc\u3055\u308c\u3066\u3044\u308b\u3088\u3046\n\u30fb\u5b9f\u9a13\u3057\u3059\u304e\u3066Policy\u6709\u52b9\u671f\u9650\u306e1\u5206\u3092\u8d85\u3048\u3066\u3044\u305f\n\u30fbPolicy\u304cjson\u5f62\u5f0f\u306b\u306a\u3063\u3066\u3044\u306a\u3044 => \u901a\u5e38\u306ejson\uff08\u30b3\u30ed\u30f3\u533a\u5207\u308a\u306e{}\u9589\u3058\uff09\u3068\u5165\u308c\u5f8c\u5f62\u5f0f\uff08\u30ab\u30f3\u30de\u533a\u5207\u308a\u306e[]\u9589\u3058\uff09\u306e\u9593\u9055\u3044\n\n\u306a\u305e\u306a\u305e\u3067\u3057\u305f\u3002\n\n\u4ee5\u4e0a\u3002", "tags": ["S3", "Ajax"]}