{"tags": ["Ansible1.9.4", "CentOS7.1.1503", "MovableType6.2"], "context": " More than 1 year has passed since last update.Ansible \u3067 CentOS 7 \u306b Movable Type 6 \u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3059\u308b\u624b\u9806\u306e\u307e\u3068\u3081\u3002\n\u3053\u3053\u3067\u306f VirtualBox \u3067 CentOS 7 \u30922\u3064\u7acb\u3061\u4e0a\u3052\u3066\u30c6\u30b9\u30c8\u3002\n\nAnsible\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nyum -y install epel-release\nyum -y install ansible\n\n\n\u63a5\u7d9a\n\n\u63a5\u7d9a\u5148\u306e\u8a2d\u5b9a\ncp /etc/ansible/hosts{,.org}\ncat <<_EOD_ > /etc/ansible/hosts\n[webservers]\n192.168.56.102\n\n[all:vars]\nansible_ssh_port=22\nansible_ssh_user=root\nansible_ssh_pass=p@ssW0rd\n_EOD_\n\n\u30c6\u30b9\u30c8\u306a\u306e\u3067\u3068\u308a\u3042\u3048\u305aroot\u3067\u76f4\u63a5\u63a5\u7d9a\u3002\u5b9f\u969b\u306b\u306f\u74b0\u5883\u306b\u5fdc\u3058\u3066\u8a2d\u5b9a\u3002\n\nSSH key host checking \u306e\u7121\u52b9\u5316\ncp /etc/ansible/ansible.cfg{,.org}\nsed -i '/#host_key_checking/s/#//' /etc/ansible/ansible.cfg;\n\n\u3053\u308c\u3082\u30c6\u30b9\u30c8\u306a\u306e\u3067\u3068\u308a\u3042\u3048\u305a\u3002\n\n\u63a5\u7d9a\u30c6\u30b9\u30c8\nansible all -m ping\n\n192.168.56.102 | success >> {\n    \"changed\": false,\n    \"ping\": \"pong\"\n}\n\n\u4e0a\u8a18\u304c\u8fd4\u3063\u3066\u304f\u308c\u3070\u6210\u529f\u3002\n192.168.56.102 | FAILED => SSH Error: ssh: connect to host 192.168.56.102 port 22: No route to host\n    while connecting to 192.168.56.102:22\nIt is sometimes useful to re-run the command using -vvvv, which prints SSH debug output to help diagnose the issue.\n\n\u63a5\u7d9a\u5148\u304c\u9593\u9055\u3063\u3066\u3044\u308b\u306a\u3069\u3002\n192.168.56.102 | FAILED => Using a SSH password instead of a key is not possible because Host Key checking is enabled and sshpass does not support this.  Please add this host's fingerprint to your known_hosts file to manage this host.\n\nSSH key host checking \u3067\u3072\u3063\u304b\u304b\u3063\u3066\u3044\u308b\u306e\u3067 host_key \u3092\u767b\u9332\u3059\u308b\u304b\u30c1\u30a7\u30c3\u30af\u3092\u7121\u52b9\u5316\u3059\u308b\u3002\n\nPlaybook\n\nPlaybook\u306e\u4f5c\u6210\ncat <<_EOD_ > playbook.yml\n---\n- hosts: all\n  user: root\n  tasks:\n\n  # SELinux\n  - name: disable SELinux\n    selinux: state=disabled\n\n  # Yum Update\n  - name: yum update\n    yum: name=* state=latest\n\n  # Apache\n  - name: install httpd\n    yum: name=httpd state=installed\n  - name: firewall-cmd --permanent --add-service=http\n    firewalld: service=http permanent=true state=enabled immediate=true\n  - name: enable cgi-script handler\n    replace:\n      dest=/etc/httpd/conf/httpd.conf\n      regexp='#AddHandler cgi-script'\n      replace='AddHandler cgi-script'\n  - name: httpd start\n    service: name=httpd state=started enabled=yes\n\n  # Memcached\n  - name: install Memcached\n    yum: name=memcached state=installed\n  - name: memcached start\n    service: name=memcached state=started enabled=yes\n\n  # MySQL\n  - name: install MySQL Yum Repository\n    yum: name=http://dev.mysql.com/get/mysql-community-release-el7-5.noarch.rpm state=installed\n  - name: install mysql-community-server\n    yum: name=mysql-community-server state=installed\n  - name: install perl-DBD-MySQL\n    yum: name=perl-DBD-MySQL state=installed\n  - name: install MySQL-python for Ansible\n    yum: name=MySQL-python state=installed\n  - name: mysqld start\n    service: name=mysqld state=started enabled=yes\n  - name: create database\n    mysql_db: name=mt state=present encoding=utf8\n  - name: create mysql user\n    mysql_user: name=mt password=passw0rd priv=mt.*:ALL,GRANT state=present\n\n  # Movable Type\n  - name: copy MT.zip\n    copy: src=/root/MT-6.2.zip dest=/var/www/MT-6.2.zip owner=apache group=apache mode=0644\n  - name: install unzip\n    yum: name=unzip state=installed\n  - name: unarchive MT.zip\n    unarchive: src=/var/www/MT-6.2.zip dest=/var/www/cgi-bin copy=no\n  - name: rename MT-6.2 to mt\n    command: mv /var/www/cgi-bin/MT-6.2 /var/www/cgi-bin/mt\n    when: MT-6.2\n  - name: ln -s /var/www/cgi-bin/mt/mt-static /var/www/html/mt-static\n    file: src=/var/www/cgi-bin/mt/mt-static dest=/var/www/html/mt-static owner=apache group=apache state=link\n  - name: chmod /var/www/html\n    file: path=/var/www/html owner=apache group=apache mode=0777\n  - name: chmod /var/www/cgi-bin/mt\n    file: path=/var/www/cgi-bin/mt owner=apache group=apache mode=0777\n  - name: chmod /var/www/cgi-bin/mt/mt-static/support\n    file: path=/var/www/cgi-bin/mt/mt-static/support owner=apache group=apache mode=0777\n\n  # Perl libraries\n  - name: install Perl libraries by Yum\n    yum: name=\"{{ item }}\" state=installed\n    with_items:\n       - perl-App-cpanminus\n       - perl-IPC-Run\n       - perl-DBD-ODBC\n       - perl-Archive-Tar\n       - perl-XML-LibXML\n       - perl-Test-Simple\n       - perl-XMLRPC-Lite\n       - perl-LDAP\n       - perl-GD\n       - perl-CGI-Emulate-PSGI\n       - ImageMagick-perl\n       - perl-Authen-SASL\n       - perl-CGI\n       - perl-Mozilla-CA\n       - perl-YAML-Syck\n       - perl-IO-String\n       - perl-DB_File\n       - perl-Crypt-DSA\n       - perl-Cache-Memcached\n       - perl-Heap\n       - perl-File-NFSLock\n       - perl-Crypt-SSLeay\n       - perl-Text-CSV_XS\n       - expat-devel\n\n  # Perl CPAN libraries\n  - name: install cpan-modules with cpanm\n    cpanm: name={{item}} notest=True\n    with_items:\n    - Cache::File\n    - XML::SAX::Expat\n    - XML::SAX::ExpatXS\n    - Imager\n_EOD_\n\n\nDry-run\u3067\u5b9f\u884c\nansible-playbook playbook.yml --check -vvvv\n\n\u30c6\u30b9\u30c8\u306a\u306e\u3067\u9014\u4e2d\u3067\u901f\u653b\u3067\u3053\u3051\u308b\u3002\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3057\u3066\u901a\u3059\u3068\u304b\u3002\u3061\u3087\u3063\u3068\u691c\u8a0e\u3002\n\n\u672c\u756a\u5b9f\u884c\nansible-playbook playbook.yml\n\n\n\u30e2\u30b8\u30e5\u30fc\u30eb\u985e\u306e\u78ba\u8a8d\n\nhttp://192.168.56.102/cgi-bin/mt/mt-check.cgi\n\n\n\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n\nhttp://192.168.56.102/cgi-bin/mt/mt.cgi\n\n\u30d6\u30e9\u30a6\u30b6\u30fc\u3067\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u306f\u9762\u5012\u306a\u306e\u3067\u3001\u4e8b\u524d\u306bSQL\u3092\u7528\u610f\u3057\u305f\u65b9\u304c\u826f\u3044\u304b\u3082\u3057\u308c\u306a\u3044\u3002\n\nmt-config.cgi\n\nmt-config.cgi\nImageDriver ImageMagick\nMemcachedServers localhost:11211\n\n\n\u3068\u308a\u3042\u3048\u305a\u3002\u305d\u306e\u3046\u3061PSGI\u5bfe\u5fdc\u7248\u3092\u691c\u8a0e\u3002\n\n\u305d\u306e\u4ed6\n\n\nhttp://note103.hateblo.jp/entry/2015/04/17/010528\n\u982d\u3067\u5909\u6570\u307e\u3068\u3081\u305f\u65b9\u304c\u3088\u3055\u305d\u3046\u3002\u3042\u3068\u3067\u30c1\u30a7\u30c3\u30af\u3002\n\nhttp://wp.graphact.com/2015/08/08/vagrant-ansible-mt\n\u672a\u78ba\u8a8d\u3002\u3042\u3068\u3067\u30c1\u30a7\u30c3\u30af\u3002\n\nhttps://github.com/ichika-r/ansible-playbook-mt\n\u672a\u78ba\u8a8d\u3002\u3042\u3068\u3067\u30c1\u30a7\u30c3\u30af\u3002\n\nAnsible \u3067 CentOS 7 \u306b Movable Type 6 \u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3059\u308b\u624b\u9806\u306e\u307e\u3068\u3081\u3002\n\u3053\u3053\u3067\u306f VirtualBox \u3067 CentOS 7 \u30922\u3064\u7acb\u3061\u4e0a\u3052\u3066\u30c6\u30b9\u30c8\u3002\n\n## Ansible\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n```bash\nyum -y install epel-release\nyum -y install ansible\n```\n## \u63a5\u7d9a\n#### \u63a5\u7d9a\u5148\u306e\u8a2d\u5b9a\n```bash\ncp /etc/ansible/hosts{,.org}\ncat <<_EOD_ > /etc/ansible/hosts\n[webservers]\n192.168.56.102\n\n[all:vars]\nansible_ssh_port=22\nansible_ssh_user=root\nansible_ssh_pass=p@ssW0rd\n_EOD_\n```\n\u30c6\u30b9\u30c8\u306a\u306e\u3067\u3068\u308a\u3042\u3048\u305aroot\u3067\u76f4\u63a5\u63a5\u7d9a\u3002\u5b9f\u969b\u306b\u306f\u74b0\u5883\u306b\u5fdc\u3058\u3066\u8a2d\u5b9a\u3002\n\n#### SSH key host checking \u306e\u7121\u52b9\u5316\n```bash\ncp /etc/ansible/ansible.cfg{,.org}\nsed -i '/#host_key_checking/s/#//' /etc/ansible/ansible.cfg;\n```\n\u3053\u308c\u3082\u30c6\u30b9\u30c8\u306a\u306e\u3067\u3068\u308a\u3042\u3048\u305a\u3002\n\n#### \u63a5\u7d9a\u30c6\u30b9\u30c8\n```bash\nansible all -m ping\n```\n```\n192.168.56.102 | success >> {\n    \"changed\": false,\n    \"ping\": \"pong\"\n}\n```\n\u4e0a\u8a18\u304c\u8fd4\u3063\u3066\u304f\u308c\u3070\u6210\u529f\u3002\n\n```\n192.168.56.102 | FAILED => SSH Error: ssh: connect to host 192.168.56.102 port 22: No route to host\n    while connecting to 192.168.56.102:22\nIt is sometimes useful to re-run the command using -vvvv, which prints SSH debug output to help diagnose the issue.\n```\n\u63a5\u7d9a\u5148\u304c\u9593\u9055\u3063\u3066\u3044\u308b\u306a\u3069\u3002\n\n```\n192.168.56.102 | FAILED => Using a SSH password instead of a key is not possible because Host Key checking is enabled and sshpass does not support this.  Please add this host's fingerprint to your known_hosts file to manage this host.\n```\nSSH key host checking \u3067\u3072\u3063\u304b\u304b\u3063\u3066\u3044\u308b\u306e\u3067 host_key \u3092\u767b\u9332\u3059\u308b\u304b\u30c1\u30a7\u30c3\u30af\u3092\u7121\u52b9\u5316\u3059\u308b\u3002\n\n## Playbook\n#### Playbook\u306e\u4f5c\u6210\n```bash\ncat <<_EOD_ > playbook.yml\n---\n- hosts: all\n  user: root\n  tasks:\n\n  # SELinux\n  - name: disable SELinux\n    selinux: state=disabled\n\n  # Yum Update\n  - name: yum update\n    yum: name=* state=latest\n\n  # Apache\n  - name: install httpd\n    yum: name=httpd state=installed\n  - name: firewall-cmd --permanent --add-service=http\n    firewalld: service=http permanent=true state=enabled immediate=true\n  - name: enable cgi-script handler\n    replace:\n      dest=/etc/httpd/conf/httpd.conf\n      regexp='#AddHandler cgi-script'\n      replace='AddHandler cgi-script'\n  - name: httpd start\n    service: name=httpd state=started enabled=yes\n\n  # Memcached\n  - name: install Memcached\n    yum: name=memcached state=installed\n  - name: memcached start\n    service: name=memcached state=started enabled=yes\n\n  # MySQL\n  - name: install MySQL Yum Repository\n    yum: name=http://dev.mysql.com/get/mysql-community-release-el7-5.noarch.rpm state=installed\n  - name: install mysql-community-server\n    yum: name=mysql-community-server state=installed\n  - name: install perl-DBD-MySQL\n    yum: name=perl-DBD-MySQL state=installed\n  - name: install MySQL-python for Ansible\n    yum: name=MySQL-python state=installed\n  - name: mysqld start\n    service: name=mysqld state=started enabled=yes\n  - name: create database\n    mysql_db: name=mt state=present encoding=utf8\n  - name: create mysql user\n    mysql_user: name=mt password=passw0rd priv=mt.*:ALL,GRANT state=present\n\n  # Movable Type\n  - name: copy MT.zip\n    copy: src=/root/MT-6.2.zip dest=/var/www/MT-6.2.zip owner=apache group=apache mode=0644\n  - name: install unzip\n    yum: name=unzip state=installed\n  - name: unarchive MT.zip\n    unarchive: src=/var/www/MT-6.2.zip dest=/var/www/cgi-bin copy=no\n  - name: rename MT-6.2 to mt\n    command: mv /var/www/cgi-bin/MT-6.2 /var/www/cgi-bin/mt\n    when: MT-6.2\n  - name: ln -s /var/www/cgi-bin/mt/mt-static /var/www/html/mt-static\n    file: src=/var/www/cgi-bin/mt/mt-static dest=/var/www/html/mt-static owner=apache group=apache state=link\n  - name: chmod /var/www/html\n    file: path=/var/www/html owner=apache group=apache mode=0777\n  - name: chmod /var/www/cgi-bin/mt\n    file: path=/var/www/cgi-bin/mt owner=apache group=apache mode=0777\n  - name: chmod /var/www/cgi-bin/mt/mt-static/support\n    file: path=/var/www/cgi-bin/mt/mt-static/support owner=apache group=apache mode=0777\n\n  # Perl libraries\n  - name: install Perl libraries by Yum\n    yum: name=\"{{ item }}\" state=installed\n    with_items:\n       - perl-App-cpanminus\n       - perl-IPC-Run\n       - perl-DBD-ODBC\n       - perl-Archive-Tar\n       - perl-XML-LibXML\n       - perl-Test-Simple\n       - perl-XMLRPC-Lite\n       - perl-LDAP\n       - perl-GD\n       - perl-CGI-Emulate-PSGI\n       - ImageMagick-perl\n       - perl-Authen-SASL\n       - perl-CGI\n       - perl-Mozilla-CA\n       - perl-YAML-Syck\n       - perl-IO-String\n       - perl-DB_File\n       - perl-Crypt-DSA\n       - perl-Cache-Memcached\n       - perl-Heap\n       - perl-File-NFSLock\n       - perl-Crypt-SSLeay\n       - perl-Text-CSV_XS\n       - expat-devel\n\n  # Perl CPAN libraries\n  - name: install cpan-modules with cpanm\n    cpanm: name={{item}} notest=True\n    with_items:\n    - Cache::File\n    - XML::SAX::Expat\n    - XML::SAX::ExpatXS\n    - Imager\n_EOD_\n```\n\n#### Dry-run\u3067\u5b9f\u884c\n```bash\nansible-playbook playbook.yml --check -vvvv\n```\n\u30c6\u30b9\u30c8\u306a\u306e\u3067\u9014\u4e2d\u3067\u901f\u653b\u3067\u3053\u3051\u308b\u3002\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3057\u3066\u901a\u3059\u3068\u304b\u3002\u3061\u3087\u3063\u3068\u691c\u8a0e\u3002\n\n#### \u672c\u756a\u5b9f\u884c\n```bash\nansible-playbook playbook.yml\n```\n\n#### \u30e2\u30b8\u30e5\u30fc\u30eb\u985e\u306e\u78ba\u8a8d\n* http://192.168.56.102/cgi-bin/mt/mt-check.cgi\n\n#### \u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n* http://192.168.56.102/cgi-bin/mt/mt.cgi\n\n\u30d6\u30e9\u30a6\u30b6\u30fc\u3067\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u306f\u9762\u5012\u306a\u306e\u3067\u3001\u4e8b\u524d\u306bSQL\u3092\u7528\u610f\u3057\u305f\u65b9\u304c\u826f\u3044\u304b\u3082\u3057\u308c\u306a\u3044\u3002\n\n#### mt-config.cgi\n```mt-config.cgi\nImageDriver ImageMagick\nMemcachedServers localhost:11211\n```\n\u3068\u308a\u3042\u3048\u305a\u3002\u305d\u306e\u3046\u3061PSGI\u5bfe\u5fdc\u7248\u3092\u691c\u8a0e\u3002\n\n## \u305d\u306e\u4ed6\n* http://note103.hateblo.jp/entry/2015/04/17/010528\n\u982d\u3067\u5909\u6570\u307e\u3068\u3081\u305f\u65b9\u304c\u3088\u3055\u305d\u3046\u3002\u3042\u3068\u3067\u30c1\u30a7\u30c3\u30af\u3002\n* http://wp.graphact.com/2015/08/08/vagrant-ansible-mt\n\u672a\u78ba\u8a8d\u3002\u3042\u3068\u3067\u30c1\u30a7\u30c3\u30af\u3002\n* https://github.com/ichika-r/ansible-playbook-mt\n\u672a\u78ba\u8a8d\u3002\u3042\u3068\u3067\u30c1\u30a7\u30c3\u30af\u3002\n"}