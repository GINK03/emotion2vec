{"tags": ["postfix", "Linux", "\u30e1\u30fc\u30eb", "SSL", "\u30b5\u30fc\u30d0\u30fc"], "context": " More than 1 year has passed since last update.\u203b\u81ea\u5df1\u8a3c\u660e\u66f8\u3067\u306e\u9001\u4fe1\u3067\u3059\u3002\n\u203bPostfix\u3067\u3059\u3002\n\nSSL\u8a3c\u660e\u66f8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u4f5c\u6210\nmkdir /etc/postfix/ssl/SERVER\n\n\nCA\u5c40\u767a\u884c\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u4fee\u6b63\ncp /usr/lib/ssl/misc/CA.sh /etc/postfix/ssl/\n\nvi /etc/postfix/ssl/CA.sh\nif [ -z \"$DAYS\" ] ; then DAYS=\"-days 36500\" ; fi        # 100 year\nCADAYS=\"-days 36500\"     # 100 years\nif [ -z \"$CATOP\" ] ; then CATOP=/etc/postfix/ssl/CA ; fi\n\n\nopenssl\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u4fee\u6b63\ncp -pi /etc/ssl/openssl.cnf /etc/ssl/openssl.cnf.org\nvi /etc/ssl/openssl.cnf\n\u203b2\u30f6\u6240\u306e\u30d1\u30b9\u4fee\u6b63\n[ CA_default ]\ndir             = /etc/postfix/ssl/CA\n[ tsa_config1 ]\ndir             = /etc/postfix/ssl/CA\n\n\nCA\u5c40\u306e\u4f5c\u6210\n\nCA\u79d8\u5bc6\u9375\u306e\u4f5c\u6210\nsh /etc/postfix/ssl/CA.sh -newca\n\n \u203bcakey.pem\u306e\u30d1\u30b9\u30d5\u30ec\u30fc\u30ba\u3092\u5165\u529b\n \u203bSubject\u60c5\u5831\u3092\u5165\u529b\n   Country Name (2 letter code) [AU]:JP\n   State or Province Name (full name) [Some-State]:Fukuoka\n   Locality Name (eg, city) []:Fukuoka-shi\n   Organization Name (eg, company) [Internet Widgits Pty Ltd]:Alterbooth Inc.\n   Organizational Unit Name (eg, section) []:TechRoom\n   Common Name (eg, YOUR name) []:FQDN\n   Email Address []:\u8a2d\u5b9a\u4e0d\u8981\n\n\nCA\u8a3c\u660e\u66f8\u306e\u4f5c\u6210\nopenssl req -new -x509 -keyout /etc/postfix/ssl/CA/private/cakey.pem -out /etc/postfix/ssl/CA/cacert.pem -days 36500\n\n\n\u30b5\u30fc\u30d0\u30fc\u8a3c\u660e\u66f8\u306e\u4f5c\u6210\n\n\u79d8\u5bc6\u9375\u306e\u4f5c\u6210\nopenssl genrsa -rand rand.dat -des3 2048 > /etc/postfix/ssl/SERVER/FQDN.key.pem\n\n\n\u9375\u30d1\u30b9\u30d5\u30ec\u30fc\u30ba\u306e\u524a\u9664\nopenssl rsa -in /etc/postfix/ssl/SERVER/FQDN.key.pem -out /etc/postfix/ssl/SERVER/FQDN.key.pem\n\n\n\u8a3c\u660e\u66f8\u8981\u6c42\uff08CSR\uff09\u306e\u4f5c\u6210\nopenssl req -new -days 36500 -key /etc/postfix/ssl/SERVER/FQDN.key.pem -out /etc/postfix/ssl/SERVER/FQDN.csr.pem\n\n Subject\u60c5\u5831\u3092\u5165\u529b\n   Country Name (2 letter code) [AU]:JP\n   State or Province Name (full name) [Some-State]:Fukuoka\n   Locality Name (eg, city) []:Fukuoka-shi\n   Organization Name (eg, company) [Internet Widgits Pty Ltd]:Alterbooth Inc.\n   Organizational Unit Name (eg, section) []:TechRoom\n   Common Name (eg, YOUR name) []:FQDN\n   Email Address []:\u8a2d\u5b9a\u4e0d\u8981\n\n\n\u8a3c\u660e\u66f8\u306e\u4f5c\u6210\nopenssl ca -in /etc/postfix/ssl/SERVER/FQDN.csr.pem -keyfile /etc/postfix/ssl/CA/private/cakey.pem -cert /etc/postfix/ssl/CA/cacert.pem -out /etc/postfix/ssl/SERVER/FQDN.crt.pem\n\n\nPostfix\u8a2d\u5b9a\u5909\u66f4\n\nmain.cf\u4fee\u6b63\nvi /etc/postfix/main.cf\n\u4ee5\u4e0b\u3092\u8ffd\u8a18\n#-------------------------------------#\n# TLS\n#-------------------------------------#\nsmtp_tls_session_cache_database = btree:/var/lib/postfix/smtp_tls_session_cache\nsmtp_tls_security_level = may\nsmtp_tls_CAfile = /etc/ssl/certs/ca-certificates.crt\nsmtpd_tls_CAfile = /etc/postfix/ssl/CA/cacert.pem\nsmtpd_tls_cert_file = /etc/postfix/ssl/SERVER/FQDN.crt.pem\nsmtpd_tls_key_file = /etc/postfix/ssl/SERVER/FQDN.key.pem\nsmtpd_tls_session_cache_database = btree:/var/lib/postfix/smtpd_tls_session_cache\nsmtpd_tls_security_level = may\nsmtp_tls_loglevel = 2\n\n\nmaster.cf\u306e\u4fee\u6b63\nvi /etc/postfix/master.cf\nsmtps     inet  n       -       -       -       -       smtpd\n  -o syslog_name=postfix/smtps\n  -o smtpd_tls_wrappermode=yes\n  -o smtpd_sasl_auth_enable=yes\n\n\npostfix \u518d\u8d77\u52d5\nservice postfix restart\n\n\n\u9001\u4fe1\u30c6\u30b9\u30c8\nopenssl s_client -connect FQDN:465\n\nMAIL FROM: \u9001\u4fe1\u5143\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\nRCPT TO: \u5b9b\u5148\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\nDATA\nSubject:Mail Send Test\nFrom:\u9001\u4fe1\u5143\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\nTo:\u5b9b\u5148\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\nTest Mail\n.\n\n\u203b\u81ea\u5df1\u8a3c\u660e\u66f8\u3067\u306e\u9001\u4fe1\u3067\u3059\u3002\n\u203bPostfix\u3067\u3059\u3002\n\n## SSL\u8a3c\u660e\u66f8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u4f5c\u6210\n```\nmkdir /etc/postfix/ssl/SERVER\n```\n\n## CA\u5c40\u767a\u884c\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u4fee\u6b63\n```\ncp /usr/lib/ssl/misc/CA.sh /etc/postfix/ssl/\n\nvi /etc/postfix/ssl/CA.sh\nif [ -z \"$DAYS\" ] ; then DAYS=\"-days 36500\" ; fi        # 100 year\nCADAYS=\"-days 36500\"     # 100 years\nif [ -z \"$CATOP\" ] ; then CATOP=/etc/postfix/ssl/CA ; fi\n```\n\n## openssl\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u4fee\u6b63\n```\ncp -pi /etc/ssl/openssl.cnf /etc/ssl/openssl.cnf.org\nvi /etc/ssl/openssl.cnf\n\u203b2\u30f6\u6240\u306e\u30d1\u30b9\u4fee\u6b63\n[ CA_default ]\ndir             = /etc/postfix/ssl/CA\n[ tsa_config1 ]\ndir             = /etc/postfix/ssl/CA\n```\n\n## CA\u5c40\u306e\u4f5c\u6210\n### CA\u79d8\u5bc6\u9375\u306e\u4f5c\u6210\n```\nsh /etc/postfix/ssl/CA.sh -newca\n\n \u203bcakey.pem\u306e\u30d1\u30b9\u30d5\u30ec\u30fc\u30ba\u3092\u5165\u529b\n \u203bSubject\u60c5\u5831\u3092\u5165\u529b\n   Country Name (2 letter code) [AU]:JP\n   State or Province Name (full name) [Some-State]:Fukuoka\n   Locality Name (eg, city) []:Fukuoka-shi\n   Organization Name (eg, company) [Internet Widgits Pty Ltd]:Alterbooth Inc.\n   Organizational Unit Name (eg, section) []:TechRoom\n   Common Name (eg, YOUR name) []:FQDN\n   Email Address []:\u8a2d\u5b9a\u4e0d\u8981\n```\n\n### CA\u8a3c\u660e\u66f8\u306e\u4f5c\u6210\n```\nopenssl req -new -x509 -keyout /etc/postfix/ssl/CA/private/cakey.pem -out /etc/postfix/ssl/CA/cacert.pem -days 36500\n```\n\n## \u30b5\u30fc\u30d0\u30fc\u8a3c\u660e\u66f8\u306e\u4f5c\u6210\n### \u79d8\u5bc6\u9375\u306e\u4f5c\u6210\n```\nopenssl genrsa -rand rand.dat -des3 2048 > /etc/postfix/ssl/SERVER/FQDN.key.pem\n```\n\n### \u9375\u30d1\u30b9\u30d5\u30ec\u30fc\u30ba\u306e\u524a\u9664\n```\nopenssl rsa -in /etc/postfix/ssl/SERVER/FQDN.key.pem -out /etc/postfix/ssl/SERVER/FQDN.key.pem\n```\n\n### \u8a3c\u660e\u66f8\u8981\u6c42\uff08CSR\uff09\u306e\u4f5c\u6210\n```\nopenssl req -new -days 36500 -key /etc/postfix/ssl/SERVER/FQDN.key.pem -out /etc/postfix/ssl/SERVER/FQDN.csr.pem\n\n Subject\u60c5\u5831\u3092\u5165\u529b\n   Country Name (2 letter code) [AU]:JP\n   State or Province Name (full name) [Some-State]:Fukuoka\n   Locality Name (eg, city) []:Fukuoka-shi\n   Organization Name (eg, company) [Internet Widgits Pty Ltd]:Alterbooth Inc.\n   Organizational Unit Name (eg, section) []:TechRoom\n   Common Name (eg, YOUR name) []:FQDN\n   Email Address []:\u8a2d\u5b9a\u4e0d\u8981\n```\n\n### \u8a3c\u660e\u66f8\u306e\u4f5c\u6210\n```\nopenssl ca -in /etc/postfix/ssl/SERVER/FQDN.csr.pem -keyfile /etc/postfix/ssl/CA/private/cakey.pem -cert /etc/postfix/ssl/CA/cacert.pem -out /etc/postfix/ssl/SERVER/FQDN.crt.pem\n```\n\n## Postfix\u8a2d\u5b9a\u5909\u66f4\n### main.cf\u4fee\u6b63\n```\nvi /etc/postfix/main.cf\n\u4ee5\u4e0b\u3092\u8ffd\u8a18\n#-------------------------------------#\n# TLS\n#-------------------------------------#\nsmtp_tls_session_cache_database = btree:/var/lib/postfix/smtp_tls_session_cache\nsmtp_tls_security_level = may\nsmtp_tls_CAfile = /etc/ssl/certs/ca-certificates.crt\nsmtpd_tls_CAfile = /etc/postfix/ssl/CA/cacert.pem\nsmtpd_tls_cert_file = /etc/postfix/ssl/SERVER/FQDN.crt.pem\nsmtpd_tls_key_file = /etc/postfix/ssl/SERVER/FQDN.key.pem\nsmtpd_tls_session_cache_database = btree:/var/lib/postfix/smtpd_tls_session_cache\nsmtpd_tls_security_level = may\nsmtp_tls_loglevel = 2\n```\n\n### master.cf\u306e\u4fee\u6b63\n```\nvi /etc/postfix/master.cf\nsmtps     inet  n       -       -       -       -       smtpd\n  -o syslog_name=postfix/smtps\n  -o smtpd_tls_wrappermode=yes\n  -o smtpd_sasl_auth_enable=yes\n```\n\n### postfix \u518d\u8d77\u52d5\n```\nservice postfix restart\n```\n\n## \u9001\u4fe1\u30c6\u30b9\u30c8\n```\nopenssl s_client -connect FQDN:465\n\nMAIL FROM: \u9001\u4fe1\u5143\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\nRCPT TO: \u5b9b\u5148\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\nDATA\nSubject:Mail Send Test\nFrom:\u9001\u4fe1\u5143\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\nTo:\u5b9b\u5148\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\nTest Mail\n.\n```\n"}