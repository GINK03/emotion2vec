{"context": "CloudFormation\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092Ruby\u30b9\u30af\u30ea\u30d7\u30c8\u3067\u4f5c\u6210\u3067\u304d\u308bHumidifier\u3068\u3044\u3046gem\u3092\u4f7f\u3063\u3066VPC\u74b0\u5883\u3092\u69cb\u7bc9\u3057\u307e\u3059\u3002Humidifier\u306f\u6a19\u6e96\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u8a18\u6cd5(JSON)\u3067\u306f\u5b9f\u88c5\u3067\u304d\u306a\u3044\u74b0\u5883\u5909\u6570\u3084\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u53d6\u308a\u8fbc\u307f\u3001\u6761\u4ef6\u5224\u65ad\u3001\u30eb\u30fc\u30d7\u306a\u3069\u3092CloudFormation\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306e\u4f5c\u6210\u6642\u306b\u7d44\u307f\u8fbc\u3080\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002\n\n\u53c2\u7167\u5143\nhttps://github.com/localytics/humidifier\n\n\u524d\u63d0\u6761\u4ef6\n\nOS: macOS Sierra\nRuby\u30d0\u30fc\u30b8\u30e7\u30f3: 2.2.5\n\n\n\u6e96\u5099\n\nAWS\u30a2\u30ab\u30a6\u30f3\u30c8\u306e\u8a2d\u5b9a\n\u74b0\u5883\u5909\u6570\u306bAWS\u8a8d\u8a3c\u60c5\u5831\u3068CloudFormation\u30b9\u30bf\u30c3\u30af\u3092\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u30ea\u30fc\u30b8\u30e7\u30f3\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\nexport AWS_REGION=ap-northeast-1\nexport AWS_ACCESS_KEY_ID=AKIA****************\nexport AWS_SECRET_ACCESS_KEY=******************************\n\n\nHumidifier\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nGemfile\ngem \"humidifier\" \ngem \"rake\"\n\n\nbundle install\n\n\n\u57fa\u672c\u7684\u306a\u4f7f\u3044\u65b9\n\u6700\u521d\u306bCloudFormation\u30b9\u30bf\u30c3\u30af\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\nstack = Humidifier::Stack.new(name: \"sample-stack\", aws_template_format_version: \"2010-09-09\")\n\n\u6b21\u306b\u4f5c\u6210\u3057\u305f\u30b9\u30bf\u30c3\u30af\u306b\u30ea\u30bd\u30fc\u30b9\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\u3053\u306e\u4f8b\u3067\u306fAWS::EC2::VPC\u3092\u30b9\u30bf\u30c3\u30af\u306b\u8ffd\u52a0\u3057\u3066\u3044\u307e\u3059\u3002\nvpc = Humidifier::EC2::VPC.new(\n  cidr_block: Humidifier.ref(\"VpcCidr\"),\n  enable_dns_support: true,\n  enable_dns_hostnames: true\n)\nstack.add('VPC', vpc)\n\n\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u4ed5\u69d8\u306fCloudFormation\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306e\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u30b9\u30cd\u30fc\u30af\u30b1\u30fc\u30b9\u5316\u3057\u305f\u3082\u306e\u3067\u3059\u3002\n\u5f15\u7528\u5143: https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-vpc.html\n{\n   \"Type\" : \"AWS::EC2::VPC\",\n   \"Properties\" : {\n      \"CidrBlock\" : String,\n      \"EnableDnsSupport\" : Boolean,\n      \"EnableDnsHostnames\" : Boolean,\n      \"InstanceTenancy\" : String,\n      \"Tags\" : [ Resource Tag, ... ]\n   }\n}  \n\n\u30d1\u30e9\u30e1\u30fc\u30bf\u3082\u8ffd\u52a0\u3067\u304d\u307e\u3059\u3002\nstack.add_parameter(\"VpcCidr\", type: \"String\", no_echo: false)\n\n\u4e0a\u8a18Humidifier::EC2::VPC.new\u30e1\u30bd\u30c3\u30c9\u3067Humidifier.ref\u30e1\u30bd\u30c3\u30c9\u3092\u4f7f\u7528\u3057\u3066VpcCidr\u306e\u5024\u3092\u53c2\u7167\u3057\u3066\u3044\u307e\u3059\u3002\n\u6700\u5f8c\u306b\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u6307\u5b9a\u3057\u3066\u30c7\u30d7\u30ed\u30a4\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\nstack.deploy_and_wait(parameters: [ { parameter_key: \"VpcCidr\", parameter_value: \"10.0.0.0/16\" } ])\n\n\u30c1\u30a7\u30f3\u30b8\u30bb\u30c3\u30c8\u3092\u4f5c\u6210\u3059\u308b\u5834\u5408\u306f\u4ee5\u4e0b\u3067\u3059\u3002\nstack.create_change_set(parameters: [ { parameter_key: \"VpcCidr\", parameter_value: \"10.0.0.0/16\" } ])\n\nTemplate\u30d5\u30a1\u30a4\u30eb\u306fto_cf\u30e1\u30bd\u30c3\u30c9\u3067\u53d6\u5f97\u3067\u304d\u307e\u3059\u3002\nputs stack.to_cf\n\n\n\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u4f8b\nCloudFormation\u30b9\u30bf\u30c3\u30af\u306e\u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3057\u3001Rakefile\u304b\u3089\u5b9f\u884c\u3059\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u4f8b\u3067\u3059\u3002\n\nCloudFormation\u30b9\u30bf\u30c3\u30af\u3092\u69cb\u7bc9\u3059\u308b\u30af\u30e9\u30b9\nVPC\u3092\u4f5c\u6210\u3059\u308b\u30af\u30e9\u30b9\u3067\u3059\n\nvpc.rb\nrequire \"humidifier\"\n\nclass VPC\n\n  ##\n  #=== \u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\n  def initialize(stack_name)\n    @stack_name = stack_name\n    stack.add_parameter(\"VpcCidr\", type: \"String\", no_echo: false)\n    stack.add(\"VPC\", vpc)\n    stack.add(\"Subnet1\", subnet1)\n    stack.add(\"Subnet2\", subnet2)\n    stack.add(\"InternetGateway\", internet_gateway)\n    stack.add(\"VPCGatewayAttachment\", vpc_gateway_attachment)\n    stack.add(\"PublicRouteTable\", public_route_table)\n    stack.add(\"PublicRoute\", public_route)\n    stack.add(\"Subnet1RouteTableAssociation\", subnet1_route_table_association)\n    stack.add(\"Subnet2RouteTableAssociation\", subnet2_route_table_association)\n    stack.add(\"PublicNetworkAcl\", public_network_acl)\n    stack.add(\"InboundHTTPPublicNetworkAclEntry\", inbound_http_public_network_acl_entry)\n    stack.add(\"InboundSSHPublicNetworkAclEntry\", inbound_ssh_public_network_acl_entry)\n    stack.add(\"InboundEphemeralPublicNetworkAclEntry\", inbound_ephemeral_public_network_acl_entry)\n    stack.add(\"OutboundPublicNetworkAclEntry\", outbound_public_network_acl_entry)\n    stack.add(\"Subnet1NetworkAclAssociation\", subnet1_network_acl_association)\n    stack.add(\"Subnet2NetworkAclAssociation\", subnet2_network_acl_association)\n    stack.add(\"DHCPOptions\", dhcp_options)\n    stack.add_output(\"VpcId\", value: Humidifier.ref(\"VPC\"))\n    stack.add_output(\"Subnet1Id\", value: Humidifier.ref(\"Subnet1\"))\n    stack.add_output(\"Subnet2Id\", value: Humidifier.ref(\"Subnet2\"))\n  end\n\n  ##\n  #=== CloudFormation\u30b9\u30bf\u30c3\u30af\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-properties-stack.html AWS::CloudFormation::Stack\n  def stack\n    @stack ||= Humidifier::Stack.new(\n      name: @stack_name,\n      aws_template_format_version: \"2010-09-09\",\n      description: \"Sample CloudFormation Stack\"\n    )\n  end\n\n  private\n\n  ##\n  #=== VPC\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-vpc.html\n  def vpc\n    Humidifier::EC2::VPC.new(\n      cidr_block: Humidifier.ref(\"VpcCidr\"),\n      enable_dns_support: true,\n      enable_dns_hostnames: true\n    )\n  end\n\n  ##\n  #=== \u30b5\u30d6\u30cd\u30c3\u30c81\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-subnet.html\n  def subnet1\n    Humidifier::EC2::Subnet.new(\n      vpc_id: Humidifier.ref(\"VPC\"),\n      availability_zone: \"ap-northeast-1b\",\n      cidr_block: \"10.0.0.0/24\"\n    )\n  end\n\n  ##\n  #=== \u30b5\u30d6\u30cd\u30c3\u30c82\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-subnet.html\n  def subnet2\n    Humidifier::EC2::Subnet.new(\n      vpc_id: Humidifier.ref(\"VPC\"),\n      availability_zone: \"ap-northeast-1c\",\n      cidr_block: \"10.0.1.0/24\"\n    )\n  end\n\n  ##\n  #=== \u30a4\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-internet-gateway.html\n  def internet_gateway\n    Humidifier::EC2::InternetGateway.new\n  end\n\n  ##\n  #=== VPC\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u30a2\u30bf\u30c3\u30c1\u30e1\u30f3\u30c8\n  def vpc_gateway_attachment\n    Humidifier::EC2::VPCGatewayAttachment.new(\n      vpc_id: Humidifier.ref(\"VPC\"),\n      internet_gateway_id: Humidifier.ref(\"InternetGateway\")\n    )\n  end\n\n  ##\n  #=== \u30d1\u30d6\u30ea\u30c3\u30af\u30eb\u30fc\u30c8\u30c6\u30fc\u30d6\u30eb\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-route-table.html\n  def public_route_table\n    Humidifier::EC2::RouteTable.new(\n      vpc_id: Humidifier.ref(\"VPC\")\n    )\n  end\n\n  ##\n  #=== \u30d1\u30d6\u30ea\u30c3\u30af\u30eb\u30fc\u30c8\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-route.html\n  def public_route\n    Humidifier::EC2::Route.new(\n      route_table_id: Humidifier.ref(\"PublicRouteTable\"),\n      destination_cidr_block: \"0.0.0.0/0\",\n      gateway_id: Humidifier.ref(\"InternetGateway\")\n    )\n  end\n\n  ##\n  #=== \u30b5\u30d6\u30cd\u30c3\u30c81\u3092\u30eb\u30fc\u30c8\u30c6\u30fc\u30d6\u30eb\u306b\u95a2\u9023\u4ed8\u3051\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-subnet-route-table-assoc.html\n  def subnet1_route_table_association\n    Humidifier::EC2::SubnetRouteTableAssociation.new(\n      subnet_id: Humidifier.ref(\"Subnet1\"),\n      route_table_id: Humidifier.ref(\"PublicRouteTable\")\n    )\n  end\n\n  ##\n  #=== \u30b5\u30d6\u30cd\u30c3\u30c82\u3092\u30eb\u30fc\u30c8\u30c6\u30fc\u30d6\u30eb\u306b\u95a2\u9023\u4ed8\u3051\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-subnet-route-table-assoc.html\n  def subnet2_route_table_association\n    Humidifier::EC2::SubnetRouteTableAssociation.new(\n      subnet_id: Humidifier.ref(\"Subnet2\"),\n      route_table_id: Humidifier.ref(\"PublicRouteTable\")\n    )\n  end\n\n  ##\n  #=== \u30b5\u30d6\u30cd\u30c3\u30c82\u3092\u30eb\u30fc\u30c8\u30c6\u30fc\u30d6\u30eb\u306b\u95a2\u9023\u4ed8\u3051\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-subnet-route-table-assoc.html\n  def public_network_acl\n    Humidifier::EC2::NetworkAcl.new(\n      vpc_id: Humidifier.ref(\"VPC\")\n    )\n  end\n\n  ##\n  #=== \u30cd\u30c3\u30c8\u30ef\u30fc\u30afACL\u306b\u30a8\u30f3\u30c8\u30ea(http)\u3092\u4f5c\u6210\u3057\u307e\u3059\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-network-acl-entry.html\n  def inbound_http_public_network_acl_entry\n    Humidifier::EC2::NetworkAclEntry.new(\n      network_acl_id: Humidifier.ref(\"PublicNetworkAcl\"),\n      rule_number: 100,\n      protocol: 6,\n      rule_action: \"allow\",\n      egress: false,\n      cidr_block: \"0.0.0.0/0\",\n      port_range: { From: 80, To: 80 }\n    )\n  end\n\n  ##\n  #=== \u30cd\u30c3\u30c8\u30ef\u30fc\u30afACL\u306b\u30a8\u30f3\u30c8\u30ea(ssh)\u3092\u4f5c\u6210\u3057\u307e\u3059\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-network-acl-entry.html\n  def inbound_ssh_public_network_acl_entry\n    Humidifier::EC2::NetworkAclEntry.new(\n      network_acl_id: Humidifier.ref(\"PublicNetworkAcl\"),\n      rule_number: 102,\n      protocol: 6,\n      rule_action: \"allow\",\n      egress: false,\n      cidr_block: \"0.0.0.0/0\",\n      port_range: { From: 22, To: 22 },\n    )\n  end\n\n  ##\n  #=== \u30cd\u30c3\u30c8\u30ef\u30fc\u30afACL\u306b\u30a8\u30f3\u30c8\u30ea(\u30a8\u30d5\u30a7\u30e1\u30e9\u30eb\u30dd\u30fc\u30c8)\u3092\u4f5c\u6210\u3057\u307e\u3059\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-network-acl-entry.html\n  def inbound_ephemeral_public_network_acl_entry\n    Humidifier::EC2::NetworkAclEntry.new(\n      network_acl_id: Humidifier.ref(\"PublicNetworkAcl\"),\n      rule_number: 103,\n      protocol: 6,\n      rule_action: \"allow\",\n      egress: false,\n      cidr_block: \"0.0.0.0/0\",\n      port_range: { From: 1024, To: 65535 },\n    )\n  end\n\n  ##\n  #=== \u30cd\u30c3\u30c8\u30ef\u30fc\u30afACL\u306b\u30a8\u30f3\u30c8\u30ea(\u30a2\u30a6\u30c8\u30d0\u30a6\u30f3\u30c9)\u3092\u4f5c\u6210\u3057\u307e\u3059\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-network-acl-entry.html\n  def outbound_public_network_acl_entry\n    Humidifier::EC2::NetworkAclEntry.new(\n      network_acl_id: Humidifier.ref(\"PublicNetworkAcl\"),\n      rule_number: 100,\n      protocol: 6,\n      rule_action: \"allow\",\n      egress: true,\n      cidr_block: \"0.0.0.0/0\",\n      port_range: { From: 0, To: 65535 },\n    )\n  end\n\n  ##\n  #=== \u30b5\u30d6\u30cd\u30c3\u30c81\u3092\u30cd\u30c3\u30c8\u30ef\u30fc\u30af ACL \u306b\u95a2\u9023\u4ed8\u3051\u307e\u3059\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-subnet-network-acl-assoc.html\n  def subnet1_network_acl_association\n    Humidifier::EC2::SubnetNetworkAclAssociation.new(\n      subnet_id: Humidifier.ref(\"Subnet1\"),\n      network_acl_id: Humidifier.ref(\"PublicNetworkAcl\")\n    )\n  end\n\n  ##\n  #=== \u30b5\u30d6\u30cd\u30c3\u30c82\u3092\u30cd\u30c3\u30c8\u30ef\u30fc\u30af ACL \u306b\u95a2\u9023\u4ed8\u3051\u307e\u3059\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-subnet-network-acl-assoc.html\n  def subnet2_network_acl_association\n    Humidifier::EC2::SubnetNetworkAclAssociation.new(\n      subnet_id: Humidifier.ref(\"Subnet2\"),\n      network_acl_id: Humidifier.ref(\"PublicNetworkAcl\")\n    )\n  end\n\n  ##\n  #=== VPC \u7528\u306e DHCP \u30aa\u30d7\u30b7\u30e7\u30f3\u30bb\u30c3\u30c8\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-dhcp-options.html\n  def dhcp_options\n    Humidifier::EC2::DHCPOptions.new(\n      domain_name: \"ap-northeast-1.compute.internal\",\n      domain_name_servers: [ \"AmazonProvidedDNS\" ]\n    )\n  end\nend\n\n\n\nRakefile\u306e\u4f5c\u6210\n\u4f5c\u6210\u3057\u305fVPC\u30af\u30e9\u30b9\u3092\u5b9f\u884c\u3059\u308bRakefile\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u3053\u3053\u3067\u30b9\u30bf\u30c3\u30af\u540d\u3084\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u6307\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002ENV\u306a\u3069\u3067\u74b0\u5883\u5909\u6570\u304b\u3089\u3082\u5024\u3092\u53d6\u5f97\u3067\u304d\u307e\u3059\u3002\n\nRakefile\nrequire \"rake\"\n\nstack_name = \"sample-stack\"\nparameters = [\n  { parameter_key: \"VpcCidr\", parameter_value: \"10.0.0.0/16\" }\n]\n\nnamespace \"VPC\" do\n  desc \"VPC\u306e\u30c7\u30d7\u30ed\u30a4\"\n  task :deploy do\n    require \"./vpc\"\n    vpc = VPC.new(stack_name)\n    vpc.stack.deploy_and_wait(parameters: parameters)\n  end\n\n  desc \"VPC\u306e\u30c1\u30a7\u30f3\u30b8\u30bb\u30c3\u30c8\u306e\u4f5c\u6210\"\n  task :create_change_set do\n    require \"./vpc\"\n    vpc = VPC.new(stack_name)\n    vpc.stack.create_change_set(parameters: parameters)\n  end\n\n  desc \"CloudFormation\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306e\u4f5c\u6210\"\n  task :template do\n    require \"./vpc\"\n    vpc = VPC.new(stack_name)\n    puts vpc.stack.to_cf\n  end\nend\n\n\n\n\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u5b9f\u884c\n\nVPC\u3092\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u5834\u5408\nrake VPC:deploy\n\n\u30b9\u30bf\u30c3\u30af\u304c\u4f5c\u6210\u3055\u308c\u307e\u3057\u305f\n\n\u30d1\u30e9\u30e1\u30fc\u30bf\u3082\u6307\u5b9a\u3055\u308c\u3066\u3044\u307e\u3059\n\n\u51fa\u529b\u7d50\u679c\n\n\n\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306e\u51fa\u529b\nrake VPC:template\n\n\n\u30c1\u30a7\u30f3\u30b8\u30bb\u30c3\u30c8\u306e\u4f5c\u6210\nrake VPC:create_change_set\n\n\u30c1\u30a7\u30f3\u30b8\u30bb\u30c3\u30c8\u304c\u4f5c\u6210\u3055\u308c\u308b\n\n\u5909\u66f4\u3055\u308c\u308b\u5185\u5bb9\u3092\u78ba\u8a8d\u3057\u3066\u5b9f\u884c\n\n\n\u30b5\u30f3\u30d7\u30eb\u30b9\u30af\u30ea\u30d7\u30c8\u306b\u3064\u3044\u3066\nGithub\u306b\u7f6e\u3044\u3066\u307e\u3059\u3002\nhttps://github.com/ytabira/humidifier_sample\nCloudFormation\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092Ruby\u30b9\u30af\u30ea\u30d7\u30c8\u3067\u4f5c\u6210\u3067\u304d\u308bHumidifier\u3068\u3044\u3046gem\u3092\u4f7f\u3063\u3066VPC\u74b0\u5883\u3092\u69cb\u7bc9\u3057\u307e\u3059\u3002Humidifier\u306f\u6a19\u6e96\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u8a18\u6cd5(JSON)\u3067\u306f\u5b9f\u88c5\u3067\u304d\u306a\u3044\u74b0\u5883\u5909\u6570\u3084\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u53d6\u308a\u8fbc\u307f\u3001\u6761\u4ef6\u5224\u65ad\u3001\u30eb\u30fc\u30d7\u306a\u3069\u3092CloudFormation\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306e\u4f5c\u6210\u6642\u306b\u7d44\u307f\u8fbc\u3080\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002\n\n\n# \u53c2\u7167\u5143\nhttps://github.com/localytics/humidifier\n\n# \u524d\u63d0\u6761\u4ef6\n* OS: macOS Sierra\n* Ruby\u30d0\u30fc\u30b8\u30e7\u30f3: 2.2.5\n\n# \u6e96\u5099\n\n## AWS\u30a2\u30ab\u30a6\u30f3\u30c8\u306e\u8a2d\u5b9a\n\n\u74b0\u5883\u5909\u6570\u306bAWS\u8a8d\u8a3c\u60c5\u5831\u3068CloudFormation\u30b9\u30bf\u30c3\u30af\u3092\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u30ea\u30fc\u30b8\u30e7\u30f3\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n```bash\nexport AWS_REGION=ap-northeast-1\nexport AWS_ACCESS_KEY_ID=AKIA****************\nexport AWS_SECRET_ACCESS_KEY=******************************\n```\n\n## Humidifier\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```ruby:Gemfile\ngem \"humidifier\" \ngem \"rake\"\n```\n\n```bash\nbundle install\n```\n\n# \u57fa\u672c\u7684\u306a\u4f7f\u3044\u65b9\n\n\u6700\u521d\u306bCloudFormation\u30b9\u30bf\u30c3\u30af\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```ruby\nstack = Humidifier::Stack.new(name: \"sample-stack\", aws_template_format_version: \"2010-09-09\")\n```\n\n\u6b21\u306b\u4f5c\u6210\u3057\u305f\u30b9\u30bf\u30c3\u30af\u306b\u30ea\u30bd\u30fc\u30b9\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\u3053\u306e\u4f8b\u3067\u306f`AWS::EC2::VPC`\u3092\u30b9\u30bf\u30c3\u30af\u306b\u8ffd\u52a0\u3057\u3066\u3044\u307e\u3059\u3002\n\n```ruby\nvpc = Humidifier::EC2::VPC.new(\n  cidr_block: Humidifier.ref(\"VpcCidr\"),\n  enable_dns_support: true,\n  enable_dns_hostnames: true\n)\nstack.add('VPC', vpc)\n```\n\n\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u4ed5\u69d8\u306fCloudFormation\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306e\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u30b9\u30cd\u30fc\u30af\u30b1\u30fc\u30b9\u5316\u3057\u305f\u3082\u306e\u3067\u3059\u3002\n\u5f15\u7528\u5143: https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-vpc.html\n\n```json\n{\n   \"Type\" : \"AWS::EC2::VPC\",\n   \"Properties\" : {\n      \"CidrBlock\" : String,\n      \"EnableDnsSupport\" : Boolean,\n      \"EnableDnsHostnames\" : Boolean,\n      \"InstanceTenancy\" : String,\n      \"Tags\" : [ Resource Tag, ... ]\n   }\n}  \n```\n\n\u30d1\u30e9\u30e1\u30fc\u30bf\u3082\u8ffd\u52a0\u3067\u304d\u307e\u3059\u3002\n\n```ruby\nstack.add_parameter(\"VpcCidr\", type: \"String\", no_echo: false)\n```\n\u4e0a\u8a18`Humidifier::EC2::VPC.new`\u30e1\u30bd\u30c3\u30c9\u3067`Humidifier.ref`\u30e1\u30bd\u30c3\u30c9\u3092\u4f7f\u7528\u3057\u3066`VpcCidr`\u306e\u5024\u3092\u53c2\u7167\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u6700\u5f8c\u306b\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u6307\u5b9a\u3057\u3066\u30c7\u30d7\u30ed\u30a4\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\n\n```ruby\nstack.deploy_and_wait(parameters: [ { parameter_key: \"VpcCidr\", parameter_value: \"10.0.0.0/16\" } ])\n```\n\n\u30c1\u30a7\u30f3\u30b8\u30bb\u30c3\u30c8\u3092\u4f5c\u6210\u3059\u308b\u5834\u5408\u306f\u4ee5\u4e0b\u3067\u3059\u3002\n\n```ruby\nstack.create_change_set(parameters: [ { parameter_key: \"VpcCidr\", parameter_value: \"10.0.0.0/16\" } ])\n```\n\nTemplate\u30d5\u30a1\u30a4\u30eb\u306f`to_cf`\u30e1\u30bd\u30c3\u30c9\u3067\u53d6\u5f97\u3067\u304d\u307e\u3059\u3002\n\n```ruby\nputs stack.to_cf\n```\n\n# \u30b9\u30af\u30ea\u30d7\u30c8\u306e\u4f8b\nCloudFormation\u30b9\u30bf\u30c3\u30af\u306e\u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3057\u3001Rakefile\u304b\u3089\u5b9f\u884c\u3059\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u4f8b\u3067\u3059\u3002\n\n## CloudFormation\u30b9\u30bf\u30c3\u30af\u3092\u69cb\u7bc9\u3059\u308b\u30af\u30e9\u30b9\nVPC\u3092\u4f5c\u6210\u3059\u308b\u30af\u30e9\u30b9\u3067\u3059\n\n```ruby:vpc.rb\nrequire \"humidifier\"\n\nclass VPC\n\n  ##\n  #=== \u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\n  def initialize(stack_name)\n    @stack_name = stack_name\n    stack.add_parameter(\"VpcCidr\", type: \"String\", no_echo: false)\n    stack.add(\"VPC\", vpc)\n    stack.add(\"Subnet1\", subnet1)\n    stack.add(\"Subnet2\", subnet2)\n    stack.add(\"InternetGateway\", internet_gateway)\n    stack.add(\"VPCGatewayAttachment\", vpc_gateway_attachment)\n    stack.add(\"PublicRouteTable\", public_route_table)\n    stack.add(\"PublicRoute\", public_route)\n    stack.add(\"Subnet1RouteTableAssociation\", subnet1_route_table_association)\n    stack.add(\"Subnet2RouteTableAssociation\", subnet2_route_table_association)\n    stack.add(\"PublicNetworkAcl\", public_network_acl)\n    stack.add(\"InboundHTTPPublicNetworkAclEntry\", inbound_http_public_network_acl_entry)\n    stack.add(\"InboundSSHPublicNetworkAclEntry\", inbound_ssh_public_network_acl_entry)\n    stack.add(\"InboundEphemeralPublicNetworkAclEntry\", inbound_ephemeral_public_network_acl_entry)\n    stack.add(\"OutboundPublicNetworkAclEntry\", outbound_public_network_acl_entry)\n    stack.add(\"Subnet1NetworkAclAssociation\", subnet1_network_acl_association)\n    stack.add(\"Subnet2NetworkAclAssociation\", subnet2_network_acl_association)\n    stack.add(\"DHCPOptions\", dhcp_options)\n    stack.add_output(\"VpcId\", value: Humidifier.ref(\"VPC\"))\n    stack.add_output(\"Subnet1Id\", value: Humidifier.ref(\"Subnet1\"))\n    stack.add_output(\"Subnet2Id\", value: Humidifier.ref(\"Subnet2\"))\n  end\n\n  ##\n  #=== CloudFormation\u30b9\u30bf\u30c3\u30af\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-properties-stack.html AWS::CloudFormation::Stack\n  def stack\n    @stack ||= Humidifier::Stack.new(\n      name: @stack_name,\n      aws_template_format_version: \"2010-09-09\",\n      description: \"Sample CloudFormation Stack\"\n    )\n  end\n\n  private\n\n  ##\n  #=== VPC\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-vpc.html\n  def vpc\n    Humidifier::EC2::VPC.new(\n      cidr_block: Humidifier.ref(\"VpcCidr\"),\n      enable_dns_support: true,\n      enable_dns_hostnames: true\n    )\n  end\n\n  ##\n  #=== \u30b5\u30d6\u30cd\u30c3\u30c81\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-subnet.html\n  def subnet1\n    Humidifier::EC2::Subnet.new(\n      vpc_id: Humidifier.ref(\"VPC\"),\n      availability_zone: \"ap-northeast-1b\",\n      cidr_block: \"10.0.0.0/24\"\n    )\n  end\n\n  ##\n  #=== \u30b5\u30d6\u30cd\u30c3\u30c82\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-subnet.html\n  def subnet2\n    Humidifier::EC2::Subnet.new(\n      vpc_id: Humidifier.ref(\"VPC\"),\n      availability_zone: \"ap-northeast-1c\",\n      cidr_block: \"10.0.1.0/24\"\n    )\n  end\n\n  ##\n  #=== \u30a4\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-internet-gateway.html\n  def internet_gateway\n    Humidifier::EC2::InternetGateway.new\n  end\n\n  ##\n  #=== VPC\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u30a2\u30bf\u30c3\u30c1\u30e1\u30f3\u30c8\n  def vpc_gateway_attachment\n    Humidifier::EC2::VPCGatewayAttachment.new(\n      vpc_id: Humidifier.ref(\"VPC\"),\n      internet_gateway_id: Humidifier.ref(\"InternetGateway\")\n    )\n  end\n\n  ##\n  #=== \u30d1\u30d6\u30ea\u30c3\u30af\u30eb\u30fc\u30c8\u30c6\u30fc\u30d6\u30eb\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-route-table.html\n  def public_route_table\n    Humidifier::EC2::RouteTable.new(\n      vpc_id: Humidifier.ref(\"VPC\")\n    )\n  end\n\n  ##\n  #=== \u30d1\u30d6\u30ea\u30c3\u30af\u30eb\u30fc\u30c8\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-route.html\n  def public_route\n    Humidifier::EC2::Route.new(\n      route_table_id: Humidifier.ref(\"PublicRouteTable\"),\n      destination_cidr_block: \"0.0.0.0/0\",\n      gateway_id: Humidifier.ref(\"InternetGateway\")\n    )\n  end\n\n  ##\n  #=== \u30b5\u30d6\u30cd\u30c3\u30c81\u3092\u30eb\u30fc\u30c8\u30c6\u30fc\u30d6\u30eb\u306b\u95a2\u9023\u4ed8\u3051\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-subnet-route-table-assoc.html\n  def subnet1_route_table_association\n    Humidifier::EC2::SubnetRouteTableAssociation.new(\n      subnet_id: Humidifier.ref(\"Subnet1\"),\n      route_table_id: Humidifier.ref(\"PublicRouteTable\")\n    )\n  end\n\n  ##\n  #=== \u30b5\u30d6\u30cd\u30c3\u30c82\u3092\u30eb\u30fc\u30c8\u30c6\u30fc\u30d6\u30eb\u306b\u95a2\u9023\u4ed8\u3051\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-subnet-route-table-assoc.html\n  def subnet2_route_table_association\n    Humidifier::EC2::SubnetRouteTableAssociation.new(\n      subnet_id: Humidifier.ref(\"Subnet2\"),\n      route_table_id: Humidifier.ref(\"PublicRouteTable\")\n    )\n  end\n\n  ##\n  #=== \u30b5\u30d6\u30cd\u30c3\u30c82\u3092\u30eb\u30fc\u30c8\u30c6\u30fc\u30d6\u30eb\u306b\u95a2\u9023\u4ed8\u3051\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-subnet-route-table-assoc.html\n  def public_network_acl\n    Humidifier::EC2::NetworkAcl.new(\n      vpc_id: Humidifier.ref(\"VPC\")\n    )\n  end\n\n  ##\n  #=== \u30cd\u30c3\u30c8\u30ef\u30fc\u30afACL\u306b\u30a8\u30f3\u30c8\u30ea(http)\u3092\u4f5c\u6210\u3057\u307e\u3059\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-network-acl-entry.html\n  def inbound_http_public_network_acl_entry\n    Humidifier::EC2::NetworkAclEntry.new(\n      network_acl_id: Humidifier.ref(\"PublicNetworkAcl\"),\n      rule_number: 100,\n      protocol: 6,\n      rule_action: \"allow\",\n      egress: false,\n      cidr_block: \"0.0.0.0/0\",\n      port_range: { From: 80, To: 80 }\n    )\n  end\n\n  ##\n  #=== \u30cd\u30c3\u30c8\u30ef\u30fc\u30afACL\u306b\u30a8\u30f3\u30c8\u30ea(ssh)\u3092\u4f5c\u6210\u3057\u307e\u3059\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-network-acl-entry.html\n  def inbound_ssh_public_network_acl_entry\n    Humidifier::EC2::NetworkAclEntry.new(\n      network_acl_id: Humidifier.ref(\"PublicNetworkAcl\"),\n      rule_number: 102,\n      protocol: 6,\n      rule_action: \"allow\",\n      egress: false,\n      cidr_block: \"0.0.0.0/0\",\n      port_range: { From: 22, To: 22 },\n    )\n  end\n\n  ##\n  #=== \u30cd\u30c3\u30c8\u30ef\u30fc\u30afACL\u306b\u30a8\u30f3\u30c8\u30ea(\u30a8\u30d5\u30a7\u30e1\u30e9\u30eb\u30dd\u30fc\u30c8)\u3092\u4f5c\u6210\u3057\u307e\u3059\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-network-acl-entry.html\n  def inbound_ephemeral_public_network_acl_entry\n    Humidifier::EC2::NetworkAclEntry.new(\n      network_acl_id: Humidifier.ref(\"PublicNetworkAcl\"),\n      rule_number: 103,\n      protocol: 6,\n      rule_action: \"allow\",\n      egress: false,\n      cidr_block: \"0.0.0.0/0\",\n      port_range: { From: 1024, To: 65535 },\n    )\n  end\n\n  ##\n  #=== \u30cd\u30c3\u30c8\u30ef\u30fc\u30afACL\u306b\u30a8\u30f3\u30c8\u30ea(\u30a2\u30a6\u30c8\u30d0\u30a6\u30f3\u30c9)\u3092\u4f5c\u6210\u3057\u307e\u3059\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-network-acl-entry.html\n  def outbound_public_network_acl_entry\n    Humidifier::EC2::NetworkAclEntry.new(\n      network_acl_id: Humidifier.ref(\"PublicNetworkAcl\"),\n      rule_number: 100,\n      protocol: 6,\n      rule_action: \"allow\",\n      egress: true,\n      cidr_block: \"0.0.0.0/0\",\n      port_range: { From: 0, To: 65535 },\n    )\n  end\n\n  ##\n  #=== \u30b5\u30d6\u30cd\u30c3\u30c81\u3092\u30cd\u30c3\u30c8\u30ef\u30fc\u30af ACL \u306b\u95a2\u9023\u4ed8\u3051\u307e\u3059\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-subnet-network-acl-assoc.html\n  def subnet1_network_acl_association\n    Humidifier::EC2::SubnetNetworkAclAssociation.new(\n      subnet_id: Humidifier.ref(\"Subnet1\"),\n      network_acl_id: Humidifier.ref(\"PublicNetworkAcl\")\n    )\n  end\n\n  ##\n  #=== \u30b5\u30d6\u30cd\u30c3\u30c82\u3092\u30cd\u30c3\u30c8\u30ef\u30fc\u30af ACL \u306b\u95a2\u9023\u4ed8\u3051\u307e\u3059\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-subnet-network-acl-assoc.html\n  def subnet2_network_acl_association\n    Humidifier::EC2::SubnetNetworkAclAssociation.new(\n      subnet_id: Humidifier.ref(\"Subnet2\"),\n      network_acl_id: Humidifier.ref(\"PublicNetworkAcl\")\n    )\n  end\n\n  ##\n  #=== VPC \u7528\u306e DHCP \u30aa\u30d7\u30b7\u30e7\u30f3\u30bb\u30c3\u30c8\n  # @see https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-dhcp-options.html\n  def dhcp_options\n    Humidifier::EC2::DHCPOptions.new(\n      domain_name: \"ap-northeast-1.compute.internal\",\n      domain_name_servers: [ \"AmazonProvidedDNS\" ]\n    )\n  end\nend\n```\n\n## Rakefile\u306e\u4f5c\u6210\n\u4f5c\u6210\u3057\u305fVPC\u30af\u30e9\u30b9\u3092\u5b9f\u884c\u3059\u308bRakefile\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u3053\u3053\u3067\u30b9\u30bf\u30c3\u30af\u540d\u3084\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u6307\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002ENV\u306a\u3069\u3067\u74b0\u5883\u5909\u6570\u304b\u3089\u3082\u5024\u3092\u53d6\u5f97\u3067\u304d\u307e\u3059\u3002\n\n```ruby:Rakefile\nrequire \"rake\"\n\nstack_name = \"sample-stack\"\nparameters = [\n  { parameter_key: \"VpcCidr\", parameter_value: \"10.0.0.0/16\" }\n]\n\nnamespace \"VPC\" do\n  desc \"VPC\u306e\u30c7\u30d7\u30ed\u30a4\"\n  task :deploy do\n    require \"./vpc\"\n    vpc = VPC.new(stack_name)\n    vpc.stack.deploy_and_wait(parameters: parameters)\n  end\n\n  desc \"VPC\u306e\u30c1\u30a7\u30f3\u30b8\u30bb\u30c3\u30c8\u306e\u4f5c\u6210\"\n  task :create_change_set do\n    require \"./vpc\"\n    vpc = VPC.new(stack_name)\n    vpc.stack.create_change_set(parameters: parameters)\n  end\n\n  desc \"CloudFormation\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306e\u4f5c\u6210\"\n  task :template do\n    require \"./vpc\"\n    vpc = VPC.new(stack_name)\n    puts vpc.stack.to_cf\n  end\nend\n```\n\n## \u30b9\u30af\u30ea\u30d7\u30c8\u306e\u5b9f\u884c\n\n### VPC\u3092\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u5834\u5408\n```bash\nrake VPC:deploy\n```\n\n\u30b9\u30bf\u30c3\u30af\u304c\u4f5c\u6210\u3055\u308c\u307e\u3057\u305f\n![CloudFormation_Management_Console.png](https://qiita-image-store.s3.amazonaws.com/0/81973/8317757b-5d7c-9ae8-9067-78a16f418299.png)\n\n\u30d1\u30e9\u30e1\u30fc\u30bf\u3082\u6307\u5b9a\u3055\u308c\u3066\u3044\u307e\u3059\n![CloudFormation_Management_Console.png](https://qiita-image-store.s3.amazonaws.com/0/81973/930fe96c-5515-5438-320a-1bc9dc719b90.png)\n\n\u51fa\u529b\u7d50\u679c\n![CloudFormation_Management_Console.png](https://qiita-image-store.s3.amazonaws.com/0/81973/7a9ff353-05fd-4cb8-30f6-c8a6a609b83a.png)\n\n### \u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306e\u51fa\u529b\n```bash\nrake VPC:template\n```\n\n### \u30c1\u30a7\u30f3\u30b8\u30bb\u30c3\u30c8\u306e\u4f5c\u6210\n```bash\nrake VPC:create_change_set\n```\n\u30c1\u30a7\u30f3\u30b8\u30bb\u30c3\u30c8\u304c\u4f5c\u6210\u3055\u308c\u308b\n![CloudFormation_Management_Console.png](https://qiita-image-store.s3.amazonaws.com/0/81973/95ca085a-1187-f481-5ab5-fc2213b938d8.png)\n\n\u5909\u66f4\u3055\u308c\u308b\u5185\u5bb9\u3092\u78ba\u8a8d\u3057\u3066\u5b9f\u884c\n![Change_Set_Detail.png](https://qiita-image-store.s3.amazonaws.com/0/81973/aa054722-57cc-431c-1209-b08f081af3ff.png)\n\n# \u30b5\u30f3\u30d7\u30eb\u30b9\u30af\u30ea\u30d7\u30c8\u306b\u3064\u3044\u3066\nGithub\u306b\u7f6e\u3044\u3066\u307e\u3059\u3002\nhttps://github.com/ytabira/humidifier_sample\n", "tags": ["AWS", "CloudFormation", "Ruby", "vpc"]}