{"tags": ["AWS", "WordPress", "CloudWatch", "wp-cli"], "context": "wp-cli \u306e core verify-checksums \u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u3046\u3068\u3001\u30b3\u30a2\u30bd\u30fc\u30b9\u306b\u6539\u7ac4\u304c\u3042\u308b\u304b\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\n\u305d\u308c\u3092\u5143\u306b CloudWatch \u306e\u30ab\u30b9\u30bf\u30e0\u30e1\u30c8\u30ea\u30af\u30b9\u306b\u6539\u7ac4\u3055\u308c\u305f\u30d5\u30a1\u30a4\u30eb\u6570\u3092\u9001\u3063\u3066\u76e3\u8996\u3057\u3066\u3057\u307e\u304a\u3046\u3068\u3044\u3046\u304a\u8a71\u3002\n\u3053\u3093\u306a\u611f\u3058\u306e\u30b7\u30a7\u30eb\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u4f5c\u3063\u3066\u3001cron \u30675\u5206\u3054\u3068\u306b\u56de\u3059\u3068\u3044\u3044\u3093\u3067\u306a\u3044\u304b\u306a\u3068\u601d\u3044\u307e\u3059\u3002\n\nwp-verify-checksums.sh\n#!/bin/bash\n\n# WordPress \u306e Web \u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u30eb\u30fc\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3078\u306e\u30d1\u30b9\nwp_path='/path/to/wordpress'\n\n# EC2 \u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9 ID \u3092\u53d6\u5f97\ninstanceid=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)\n\n# region \u3092\u53d6\u5f97\naz=$(curl -s http://169.254.169.254/latest/meta-data/placement/availability-zone)\n_length=$(echo $((${#az} - 1)))\nregion=$(echo ${az} | cut -c 1-${_length})\n\n# WP verify checksums\ntmpfile=$(mktemp)\nwp --path=${wp_path} core verify-checksums 2>&1 > /dev/null | grep -v \"Success\" > ${tmpfile}\nerr_count=$(cat ${tmpfile} | grep \"Error\" | wc -l)\nwarn_count=$(cat ${tmpfile} | grep \"Warning\" | wc -l)\nrm -f ${tmpfile}\n\n# put metric data\naws cloudwatch put-metric-data \\\n --region ${region} \\\n --namespace \"WordPress\" \\\n --dimensions InstanceId=${instanceid} \\\n --unit Count \\\n --metric-name \"WordPress verify checksums(Error)\" \\\n --value \"${err_count}\"\naws cloudwatch put-metric-data \\\n --region ${region} \\\n --namespace \"WordPress\" \\\n --dimensions InstanceId=${instanceid} \\\n --unit Count \\\n --metric-name \"WordPress verify checksums(Warning)\" \\\n --value \"${warn_count}\"\n\n\n[wp-cli](http://wp-cli.org/) \u306e ```core verify-checksums``` \u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u3046\u3068\u3001\u30b3\u30a2\u30bd\u30fc\u30b9\u306b\u6539\u7ac4\u304c\u3042\u308b\u304b\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\n\u305d\u308c\u3092\u5143\u306b CloudWatch \u306e\u30ab\u30b9\u30bf\u30e0\u30e1\u30c8\u30ea\u30af\u30b9\u306b\u6539\u7ac4\u3055\u308c\u305f\u30d5\u30a1\u30a4\u30eb\u6570\u3092\u9001\u3063\u3066\u76e3\u8996\u3057\u3066\u3057\u307e\u304a\u3046\u3068\u3044\u3046\u304a\u8a71\u3002\n\n\u3053\u3093\u306a\u611f\u3058\u306e\u30b7\u30a7\u30eb\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u4f5c\u3063\u3066\u3001cron \u30675\u5206\u3054\u3068\u306b\u56de\u3059\u3068\u3044\u3044\u3093\u3067\u306a\u3044\u304b\u306a\u3068\u601d\u3044\u307e\u3059\u3002\n\n```bash:wp-verify-checksums.sh\n#!/bin/bash\n\n# WordPress \u306e Web \u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u30eb\u30fc\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3078\u306e\u30d1\u30b9\nwp_path='/path/to/wordpress'\n\n# EC2 \u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9 ID \u3092\u53d6\u5f97\ninstanceid=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)\n\n# region \u3092\u53d6\u5f97\naz=$(curl -s http://169.254.169.254/latest/meta-data/placement/availability-zone)\n_length=$(echo $((${#az} - 1)))\nregion=$(echo ${az} | cut -c 1-${_length})\n\n# WP verify checksums\ntmpfile=$(mktemp)\nwp --path=${wp_path} core verify-checksums 2>&1 > /dev/null | grep -v \"Success\" > ${tmpfile}\nerr_count=$(cat ${tmpfile} | grep \"Error\" | wc -l)\nwarn_count=$(cat ${tmpfile} | grep \"Warning\" | wc -l)\nrm -f ${tmpfile}\n\n# put metric data\naws cloudwatch put-metric-data \\\n --region ${region} \\\n --namespace \"WordPress\" \\\n --dimensions InstanceId=${instanceid} \\\n --unit Count \\\n --metric-name \"WordPress verify checksums(Error)\" \\\n --value \"${err_count}\"\naws cloudwatch put-metric-data \\\n --region ${region} \\\n --namespace \"WordPress\" \\\n --dimensions InstanceId=${instanceid} \\\n --unit Count \\\n --metric-name \"WordPress verify checksums(Warning)\" \\\n --value \"${warn_count}\"\n```\n"}