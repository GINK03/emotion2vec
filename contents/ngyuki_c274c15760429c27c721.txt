{"context": "libvirt \u306a KVM \u306e\u30db\u30b9\u30c8\u306b\u3001\u30d9\u30fc\u30b9\u3068\u306a\u308b\u30a4\u30e1\u30fc\u30b8\u304b\u3089\u30b2\u30b9\u30c8\u3092\u30c0\u30d0\u30fc\u3063\u3068\u4f5c\u308a\u305f\u304b\u3063\u305f\u3093\u3067\u3059\u3051\u3069\u3001IP \u30a2\u30c9\u30ec\u30b9\u3084\u30db\u30b9\u30c8\u540d\u306e\u8a2d\u5b9a\u3092\u500b\u5225\u306b\u3084\u308b\u306e\u306f\u6d41\u77f3\u306b\u3057\u3093\u3069\u3044\u3068\u601d\u3063\u305f\u306e\u3067 cloud-init \u3092\u4f7f\u3063\u3066\u307f\u305f\u30e1\u30e2\u3002\n\u6700\u521d\u306f libvirt \u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306e DHCP \u3067\u3069\u3046\u306b\u304b\u3057\u3088\u3046\u3068\u601d\u3044\u307e\u3057\u305f\u304c\u3001\u30b2\u30b9\u30c8\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3092\u30d6\u30ea\u30c3\u30b8\u306b\u3057\u305f\u304b\u3063\u305f\u306e\u3067\u8ae6\u3081\u307e\u3057\u305f\u3002\n\n\u30d9\u30fc\u30b9\u30a4\u30e1\u30fc\u30b8\u306e cloud-init\n\u30d9\u30fc\u30b9\u30a4\u30e1\u30fc\u30b8\u306e\u30b2\u30b9\u30c8\u306b cloud-init \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\nyum -y install cloud-init cloud-utils-growpart\n\n\u6b21\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\ncp -a /etc/cloud/cloud.cfg{,.orig}\n\ncat <<EOS | sudo tee /etc/cloud/cloud.cfg\ndatasource_list:\n  - NoCloud\n\ncloud_init_modules:\n  - write-files\n  - bootcmd\n  - growpart\n  - resizefs\n  - set_hostname\n  - update_hostname\n\ncloud_config_modules:\n  - timezone\n  - runcmd\n\ncloud_final_modules:\n  - scripts-per-once\n  - scripts-per-boot\n  - scripts-per-instance\n  - scripts-user\n  - final-message\n\nsystem_info:\n  distro: rhel\nEOS\n\ncloud-init \u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u306f\u4f7f\u3044\u305d\u3046\u306a\u3084\u3064\u3060\u3051\u6709\u52b9\u306b\u3057\u3066\u3044\u307e\u3059\u3002\u307e\u305f\u3001\u30c7\u30fc\u30bf\u30bd\u30fc\u30b9\u306b\u306f NoCloud \u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\u7d42\u308f\u3063\u305f\u3089\u30b2\u30b9\u30c8\u306f\u30b7\u30e3\u30c3\u30c8\u30c0\u30a6\u30f3\u3057\u3066\u304a\u304d\u307e\u3059\u3002\nshutdown -h now\n\n\n\u30b2\u30b9\u30c8\u3092\u4f5c\u6210\uff08\u3072\u3068\u3064\uff09\n\u30b2\u30b9\u30c8\u3092 1 \u3064\u3060\u3051\u4f5c\u6210\u3057\u3066\u307f\u307e\u3059\u3002\n\u30d9\u30fc\u30b9\u30a4\u30e1\u30fc\u30b8\u304b\u3089\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u3067\u65b0\u305f\u3057\u3044\u30a4\u30e1\u30fc\u30b8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\nlvcreate -s /dev/vg1/base -n ore-no-server -L 5G\n\n\u30e1\u30bf\u30c7\u30fc\u30bf\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u3068\u308a\u3042\u3048\u305a instance-id \u3060\u3051\u3042\u308c\u3070\u306a\u3093\u3068\u304b\u306a\u308a\u307e\u3057\u305f\u3002\ncat <<EOS> meta-data\ninstance-id: $(uuidgen)\nEOS\n\n\u30e6\u30fc\u30b6\u30fc\u30c7\u30fc\u30bf\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002cloud-init \u3067 I/F \u3092\u8a2d\u5b9a\u3059\u308b\u3046\u307e\u3044\u65b9\u6cd5\u304c\u308f\u304b\u3089\u306a\u304b\u3063\u305f\u306e\u3067 ifcfg-eth0 \u3092\u4f5c\u6210\u3057\u3066 ifdown/ifup \u3057\u3066\u3044\u307e\u3059\u3002\ncat <<EOS> user-data\n#cloud-config\n\nhostname: ore-no-server\ntimezone: \"Asia/Tokyo\"\n\nwrite_files:\n  - path: /etc/sysconfig/network-scripts/ifcfg-eth0\n    owner: root:root\n    permissions: '0644'\n    content: |\n      TYPE=Ethernet\n      DEVICE=eth0\n      ONBOOT=yes\n      BOOTPROTO=none\n      IPADDR=192.168.8.10\n      PREFIX=24\n      GATEWAY=192.168.8.1\n      DNS1=192.168.8.1\n      DEFROUTE=yes\n      PEERDNS=yes\n      PEERROUTES=yes\n      IPV4_FAILURE_FATAL=no\n      IPV6INIT=no\n\nbootcmd:\n  - ifdown eth0\n  - ifup eth0\nEOS\n\n\u3053\u308c\u3089 2 \u3064\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u542b\u3080 ISO \u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\ngenisoimage -output ore-no-server.iso -volid cidata -joliet -rock user-data meta-data\n\n\u30b2\u30b9\u30c8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u3053\u306e\u3068\u304d\u2191\u3067\u4f5c\u6210\u3057\u305f ISO \u3082\u30a2\u30bf\u30c3\u30c1\u3057\u307e\u3059\u3002\nvirt-install \\\n  --name ore-no-server \\\n  --disk path=/dev/vg1/ore-no-server \\\n  --disk path=\"$PWD/ore-no-server.iso,bus=ide,device=cdrom\" \\\n  --network bridge=br1 \\\n  --hvm --virt-type kvm \\\n  --vcpus 1 --ram 1024 --arch x86_64 \\\n  --os-type linux --os-variant rhel7 \\\n  --boot hd --graphics none --serial pty --console pty \\\n  --import --noreboot\n\n\u30b2\u30b9\u30c8\u3092\u958b\u59cb\u3057\u307e\u3059\u3002\nvirsh start ore-no-server\n\nIP \u30a2\u30c9\u30ec\u30b9\u3084\u30db\u30b9\u30c8\u540d\u306e\u8a2d\u5b9a\u304c\u3067\u304d\u3066\u3044\u308b\u304b\u78ba\u8a8d\u3057\u307e\u3059\u3002\nssh root@192.168.8.10 uname -n\n\n\u610f\u56f3\u3057\u305f\u901a\u308a\u306b\u8868\u793a\u3055\u308c\u308c\u3070\u6210\u529f\u3067\u3059\u3002\n\n\u30b2\u30b9\u30c8\u306e\u4f5c\u6210\uff08\u305f\u304f\u3055\u3093\uff09\n\u30b2\u30b9\u30c8\u3092\u305f\u304f\u3055\u3093\u30c0\u30d0\u30fc\u3063\u3068\u4f5c\u6210\u3057\u3066\u307f\u307e\u3059\u3002\n\u4f5c\u6210\u3059\u308b\u30b2\u30b9\u30c8\u306e\u30db\u30b9\u30c8\u540d\u3068 IP \u30a2\u30c9\u30ec\u30b9\u306e\u4e00\u89a7\u3092\u914d\u5217\u306b\u5165\u308c\u307e\u3059\u3002\nguests=(\n  sv01:192.168.8.11\n  sv02:192.168.8.12\n  sv03:192.168.8.13\n  sv04:192.168.8.14\n  sv05:192.168.8.15\n  sv06:192.168.8.16\n  sv07:192.168.8.17\n  sv08:192.168.8.18\n)\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\nfor guest in \"${guests[@]}\"; do\n  name=${guest%:*}\n  lvcreate -s /dev/vg1/base -n \"$name\" -L 5G\ndone\n\n\u30e1\u30bf\u30c7\u30fc\u30bf\u3068\u30e6\u30fc\u30b6\u30fc\u30c7\u30fc\u30bf\u306e ISO \u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\nfor guest in \"${guests[@]}\"; do\n  addr=${guest#*:}\n  name=${guest%:*}\n\n  cat <<EOS> meta-data\ninstance-id: $(uuidgen)\nEOS\n\n  cat <<EOS> user-data\n#cloud-config\n\nhostname: $name\ntimezone: \"Asia/Tokyo\"\n\nwrite_files:\n  - path: /etc/sysconfig/network-scripts/ifcfg-eth0\n    owner: root:root\n    permissions: '0644'\n    content: |\n      TYPE=Ethernet\n      DEVICE=eth0\n      ONBOOT=yes\n      BOOTPROTO=none\n      IPADDR=$addr\n      PREFIX=24\n      GATEWAY=192.168.8.10\n      DNS1=192.168.8.1\n      DEFROUTE=yes\n      PEERDNS=yes\n      PEERROUTES=yes\n      IPV4_FAILURE_FATAL=no\n      IPV6INIT=no\n\nbootcmd:\n  - ifdown eth0\n  - ifup eth0\nEOS\n\n  genisoimage -output \"$name.iso\" -volid cidata -joliet -rock user-data meta-data\ndone\n\n\u30b2\u30b9\u30c8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n(\n  set -eux\n  for guest in \"${guests[@]}\"; do\n    name=${guest%:*}\n    virt-install \\\n      --name \"$name\" \\\n      --disk path=\"/dev/vg1/$name\" \\\n      --disk path=\"$PWD/$name.iso,bus=ide,device=cdrom\" \\\n      --network bridge=br1 \\\n      --hvm --virt-type kvm \\\n      --vcpus 1 --ram 1024 --arch x86_64 \\\n      --os-type linux --os-variant rhel7 \\\n      --boot hd --graphics none --serial pty --console pty \\\n      --import --noreboot\n\n    virsh start \"$name\"\n  done\n)\n\nlibvirt \u306a KVM \u306e\u30db\u30b9\u30c8\u306b\u3001\u30d9\u30fc\u30b9\u3068\u306a\u308b\u30a4\u30e1\u30fc\u30b8\u304b\u3089\u30b2\u30b9\u30c8\u3092\u30c0\u30d0\u30fc\u3063\u3068\u4f5c\u308a\u305f\u304b\u3063\u305f\u3093\u3067\u3059\u3051\u3069\u3001IP \u30a2\u30c9\u30ec\u30b9\u3084\u30db\u30b9\u30c8\u540d\u306e\u8a2d\u5b9a\u3092\u500b\u5225\u306b\u3084\u308b\u306e\u306f\u6d41\u77f3\u306b\u3057\u3093\u3069\u3044\u3068\u601d\u3063\u305f\u306e\u3067 cloud-init \u3092\u4f7f\u3063\u3066\u307f\u305f\u30e1\u30e2\u3002\n\n\u6700\u521d\u306f libvirt \u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306e DHCP \u3067\u3069\u3046\u306b\u304b\u3057\u3088\u3046\u3068\u601d\u3044\u307e\u3057\u305f\u304c\u3001\u30b2\u30b9\u30c8\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3092\u30d6\u30ea\u30c3\u30b8\u306b\u3057\u305f\u304b\u3063\u305f\u306e\u3067\u8ae6\u3081\u307e\u3057\u305f\u3002\n\n## \u30d9\u30fc\u30b9\u30a4\u30e1\u30fc\u30b8\u306e cloud-init\n\n\u30d9\u30fc\u30b9\u30a4\u30e1\u30fc\u30b8\u306e\u30b2\u30b9\u30c8\u306b cloud-init \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\n```sh\nyum -y install cloud-init cloud-utils-growpart\n```\n\n\u6b21\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```sh\ncp -a /etc/cloud/cloud.cfg{,.orig}\n\ncat <<EOS | sudo tee /etc/cloud/cloud.cfg\ndatasource_list:\n  - NoCloud\n\ncloud_init_modules:\n  - write-files\n  - bootcmd\n  - growpart\n  - resizefs\n  - set_hostname\n  - update_hostname\n\ncloud_config_modules:\n  - timezone\n  - runcmd\n\ncloud_final_modules:\n  - scripts-per-once\n  - scripts-per-boot\n  - scripts-per-instance\n  - scripts-user\n  - final-message\n\nsystem_info:\n  distro: rhel\nEOS\n```\n\ncloud-init \u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u306f\u4f7f\u3044\u305d\u3046\u306a\u3084\u3064\u3060\u3051\u6709\u52b9\u306b\u3057\u3066\u3044\u307e\u3059\u3002\u307e\u305f\u3001\u30c7\u30fc\u30bf\u30bd\u30fc\u30b9\u306b\u306f [NoCloud](http://cloudinit.readthedocs.io/en/latest/topics/datasources.html#no-cloud) \u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n\u7d42\u308f\u3063\u305f\u3089\u30b2\u30b9\u30c8\u306f\u30b7\u30e3\u30c3\u30c8\u30c0\u30a6\u30f3\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n```sh\nshutdown -h now\n```\n\n## \u30b2\u30b9\u30c8\u3092\u4f5c\u6210\uff08\u3072\u3068\u3064\uff09\n\n\u30b2\u30b9\u30c8\u3092 1 \u3064\u3060\u3051\u4f5c\u6210\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u30d9\u30fc\u30b9\u30a4\u30e1\u30fc\u30b8\u304b\u3089\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u3067\u65b0\u305f\u3057\u3044\u30a4\u30e1\u30fc\u30b8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```sh\nlvcreate -s /dev/vg1/base -n ore-no-server -L 5G\n```\n\n\u30e1\u30bf\u30c7\u30fc\u30bf\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u3068\u308a\u3042\u3048\u305a `instance-id` \u3060\u3051\u3042\u308c\u3070\u306a\u3093\u3068\u304b\u306a\u308a\u307e\u3057\u305f\u3002\n\n```sh\ncat <<EOS> meta-data\ninstance-id: $(uuidgen)\nEOS\n```\n\n\u30e6\u30fc\u30b6\u30fc\u30c7\u30fc\u30bf\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002cloud-init \u3067 I/F \u3092\u8a2d\u5b9a\u3059\u308b\u3046\u307e\u3044\u65b9\u6cd5\u304c\u308f\u304b\u3089\u306a\u304b\u3063\u305f\u306e\u3067 ifcfg-eth0 \u3092\u4f5c\u6210\u3057\u3066 ifdown/ifup \u3057\u3066\u3044\u307e\u3059\u3002\n\n```sh\ncat <<EOS> user-data\n#cloud-config\n\nhostname: ore-no-server\ntimezone: \"Asia/Tokyo\"\n\nwrite_files:\n  - path: /etc/sysconfig/network-scripts/ifcfg-eth0\n    owner: root:root\n    permissions: '0644'\n    content: |\n      TYPE=Ethernet\n      DEVICE=eth0\n      ONBOOT=yes\n      BOOTPROTO=none\n      IPADDR=192.168.8.10\n      PREFIX=24\n      GATEWAY=192.168.8.1\n      DNS1=192.168.8.1\n      DEFROUTE=yes\n      PEERDNS=yes\n      PEERROUTES=yes\n      IPV4_FAILURE_FATAL=no\n      IPV6INIT=no\n\nbootcmd:\n  - ifdown eth0\n  - ifup eth0\nEOS\n```\n\n\u3053\u308c\u3089 2 \u3064\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u542b\u3080 ISO \u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```sh\ngenisoimage -output ore-no-server.iso -volid cidata -joliet -rock user-data meta-data\n```\n\n\u30b2\u30b9\u30c8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u3053\u306e\u3068\u304d\u2191\u3067\u4f5c\u6210\u3057\u305f ISO \u3082\u30a2\u30bf\u30c3\u30c1\u3057\u307e\u3059\u3002\n\n```sh\nvirt-install \\\n  --name ore-no-server \\\n  --disk path=/dev/vg1/ore-no-server \\\n  --disk path=\"$PWD/ore-no-server.iso,bus=ide,device=cdrom\" \\\n  --network bridge=br1 \\\n  --hvm --virt-type kvm \\\n  --vcpus 1 --ram 1024 --arch x86_64 \\\n  --os-type linux --os-variant rhel7 \\\n  --boot hd --graphics none --serial pty --console pty \\\n  --import --noreboot\n```\n\n\u30b2\u30b9\u30c8\u3092\u958b\u59cb\u3057\u307e\u3059\u3002\n\n```sh\nvirsh start ore-no-server\n```\n\nIP \u30a2\u30c9\u30ec\u30b9\u3084\u30db\u30b9\u30c8\u540d\u306e\u8a2d\u5b9a\u304c\u3067\u304d\u3066\u3044\u308b\u304b\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```sh\nssh root@192.168.8.10 uname -n\n```\n\n\u610f\u56f3\u3057\u305f\u901a\u308a\u306b\u8868\u793a\u3055\u308c\u308c\u3070\u6210\u529f\u3067\u3059\u3002\n\n## \u30b2\u30b9\u30c8\u306e\u4f5c\u6210\uff08\u305f\u304f\u3055\u3093\uff09\n\n\u30b2\u30b9\u30c8\u3092\u305f\u304f\u3055\u3093\u30c0\u30d0\u30fc\u3063\u3068\u4f5c\u6210\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u4f5c\u6210\u3059\u308b\u30b2\u30b9\u30c8\u306e\u30db\u30b9\u30c8\u540d\u3068 IP \u30a2\u30c9\u30ec\u30b9\u306e\u4e00\u89a7\u3092\u914d\u5217\u306b\u5165\u308c\u307e\u3059\u3002\n\n```sh\nguests=(\n  sv01:192.168.8.11\n  sv02:192.168.8.12\n  sv03:192.168.8.13\n  sv04:192.168.8.14\n  sv05:192.168.8.15\n  sv06:192.168.8.16\n  sv07:192.168.8.17\n  sv08:192.168.8.18\n)\n```\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```sh\nfor guest in \"${guests[@]}\"; do\n  name=${guest%:*}\n  lvcreate -s /dev/vg1/base -n \"$name\" -L 5G\ndone\n```\n\n\u30e1\u30bf\u30c7\u30fc\u30bf\u3068\u30e6\u30fc\u30b6\u30fc\u30c7\u30fc\u30bf\u306e ISO \u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```sh\nfor guest in \"${guests[@]}\"; do\n  addr=${guest#*:}\n  name=${guest%:*}\n\n  cat <<EOS> meta-data\ninstance-id: $(uuidgen)\nEOS\n\n  cat <<EOS> user-data\n#cloud-config\n\nhostname: $name\ntimezone: \"Asia/Tokyo\"\n\nwrite_files:\n  - path: /etc/sysconfig/network-scripts/ifcfg-eth0\n    owner: root:root\n    permissions: '0644'\n    content: |\n      TYPE=Ethernet\n      DEVICE=eth0\n      ONBOOT=yes\n      BOOTPROTO=none\n      IPADDR=$addr\n      PREFIX=24\n      GATEWAY=192.168.8.10\n      DNS1=192.168.8.1\n      DEFROUTE=yes\n      PEERDNS=yes\n      PEERROUTES=yes\n      IPV4_FAILURE_FATAL=no\n      IPV6INIT=no\n\nbootcmd:\n  - ifdown eth0\n  - ifup eth0\nEOS\n\n  genisoimage -output \"$name.iso\" -volid cidata -joliet -rock user-data meta-data\ndone\n```\n\n\u30b2\u30b9\u30c8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```sh\n(\n  set -eux\n  for guest in \"${guests[@]}\"; do\n    name=${guest%:*}\n    virt-install \\\n      --name \"$name\" \\\n      --disk path=\"/dev/vg1/$name\" \\\n      --disk path=\"$PWD/$name.iso,bus=ide,device=cdrom\" \\\n      --network bridge=br1 \\\n      --hvm --virt-type kvm \\\n      --vcpus 1 --ram 1024 --arch x86_64 \\\n      --os-type linux --os-variant rhel7 \\\n      --boot hd --graphics none --serial pty --console pty \\\n      --import --noreboot\n\n    virsh start \"$name\"\n  done\n)\n```\n", "tags": ["KVM", "libvirt", "cloud-init"]}