{"context": " More than 1 year has passed since last update.Phoenix \u3092\u4f7f\u3063\u3066\u30d6\u30e9\u30a6\u30b6\u4e0a\u3067\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u3092\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u306b tail \u3059\u308b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u4f5c\u3063\u3066\u307f\u307e\u3059\u3002\n\u305d\u3046\u3001\u3064\u307e\u308a\u3053\u308c\u306f\u3001Phoenix Tail\u3002\n\uff3f\u4eba\u4eba\u4eba\u4eba\u4eba\u4eba\u4eba\u4eba\u4eba\u4eba\uff3f\n\uff1e\u3000\u30d5\u30a7\u30cb\u30c3\u30af\u30b9\u306e\u5c3e1\u3000\uff1c\n\uffe3Y^Y^Y^Y^Y^Y^Y^Y^Y\uffe3\n\n\u5b8c\u6210\u30a4\u30e1\u30fc\u30b8\n\u3053\u3093\u306a\u611f\u3058\u3067\u3059\u3002\n\n\nPhoenix \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3059\u308b\n\u65e9\u901f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u4f5c\u3063\u3066\u3044\u304d\u307e\u3057\u3087\u3046\u3002\nPhoenixTail \u3068\u3044\u3046\u540d\u524d\u3067\u4f5c\u308a\u307e\u3059\u3002\n$ mix phoenix.new phoenix_tail\n\nWebSocket \u306e\u8a2d\u5b9a\u3092\u3057\u3066\u304a\u304d\u307e\u3059\uff08\u8a73\u7d30\u306f\u30b3\u30c1\u30e9\uff09\n\nweb/channels/user_socket.ex\ndefmodule PhoenixTail.UserSocket do\n  use Phoenix.Socket\n\n  ## Channels\n  # \u4ee5\u4e0b\u306e\u884c\u3092\u8ffd\u52a0\n  channel \"tails:*\", PhoenixTail.TailChannel\n\n  ## Transports\n  transport :websocket, Phoenix.Transports.WebSocket\n  ...\nend\n\n\nTailChannel \u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u4eca\u56de\u306f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u306e Push \u306f\u60f3\u5b9a\u3057\u3066\u3044\u306a\u3044\u306e\u3067\u3001join \u3060\u3051\u5b9f\u88c5\u3057\u307e\u3059\u3002\n\nweb/channels/tail_channel.ex\ndefmodule PhoenixTail.TailChannel do\n  use Phoenix.Channel\n\n  def join(\"tails:sample\", auth_msg, socket) do\n    {:ok, socket}\n  end\n  def join(\"tails:\" <> _private_room_id, _auth_msg, socket) do\n    {:error, %{reason: \"unauthorized\"}}\n  end\nend\n\n\n\n\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u3092\u76e3\u8996\u3059\u308b\u30d7\u30ed\u30bb\u30b9\u3092\u4f5c\u308b\n\u6b21\u306b\u3001tail \u306e\u5bfe\u8c61\u3068\u3059\u308b\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u3092\u76e3\u8996\u3059\u308b\u90e8\u5206\u3092\u5b9f\u88c5\u3057\u307e\u3059\u3002\n\u51e6\u7406\u306e\u6d41\u308c\u3068\u3057\u3066\u306f\u3001\n\n\u5b9a\u671f\u7684\u306b\u5bfe\u8c61\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u30c1\u30a7\u30c3\u30af\n\u5909\u66f4\u304c\u5165\u3063\u3066\u3044\u308c\u3070\u3001\u524d\u56de\u53d6\u5f97\u884c\u4ee5\u964d\u306e\u884c\u3092\u53d6\u5f97\n\u53d6\u5f97\u3057\u305f\u5185\u5bb9\u3092 WebSocket \u306b broadcast\n\n\u3068\u3044\u3046\u611f\u3058\u3067\u3001\u30b5\u30fc\u30d0\u3078\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u306a\u3069\u3068\u306f\u4e00\u5207\u95a2\u4fc2\u306a\u3044\u3082\u306e\u3068\u306a\u308a\u307e\u3059\u3002\n\u3064\u307e\u308a\u3001\u72ec\u7acb\u3057\u305f\u30d7\u30ed\u30bb\u30b9\u3092\u4f5c\u308b\u5fc5\u8981\u304c\u3042\u308b\u306e\u3067\u3059\u304c\u3001\u3053\u308c\u306f Elixir \u304c\u3059\u3053\u3076\u308b\u5f97\u610f\u3068\u3059\u308b\u5206\u91ce\u3067\u3001GenServer \u3068\u3044\u3046\u6982\u5ff5\u3092\u4f7f\u3046\u3068\u30b7\u30f3\u30d7\u30eb\u306b\u5b9f\u88c5\u3067\u304d\u307e\u3059\u3002GenServer \u306b\u3064\u3044\u3066\u306f\u3001@naoya@github \u3055\u3093\u306e\u30b3\u30c1\u30e9\u306e\u8a18\u4e8b\u304c\u5927\u5909\u53c2\u8003\u306b\u306a\u308a\u307e\u3059\u3002\n\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306e\u5168\u5bb9\u306f\u3053\u3093\u306a\u611f\u3058\u3067\u3059\u3002\n\nlib/phoenix_tail/tail.ex\ndefmodule PhoenixTail.Tail do\n  use GenServer\n\n  # \u89aa\u30d7\u30ed\u30bb\u30b9\u3068\u306e\u30ea\u30f3\u30af\u51e6\u7406\n  def start_link(file) do\n    # \u5f15\u6570\u3067\u53d7\u3051\u53d6\u3063\u305f\u30bf\u30fc\u30b2\u30c3\u30c8\u30d5\u30a1\u30a4\u30eb\u306e\u30d1\u30b9\u3092\u6e21\u3057\u307e\u3059\n    GenServer.start_link(__MODULE__, {file})\n  end\n\n  # \u521d\u671f\u5316\u51e6\u7406\n  def init({file}) do\n    # \u53d7\u3051\u53d6\u3063\u305f\u30d5\u30a1\u30a4\u30eb\u30d1\u30b9\u3092\u30b9\u30c8\u30ea\u30fc\u30e0\u306b\u3057\u3066\u3001cast \u3092\u547c\u3073\u307e\u3059\n    stream = File.stream!(file)\n    GenServer.cast(self, :check)\n    {:ok, {stream, nil, 0}}\n  end\n\n  def handle_cast(:check, {stream, last_modified, position}) do\n    # \u5909\u66f4\u3092\u30c1\u30a7\u30c3\u30af\u3057\u3066 broadcast \u3057\u307e\u3059\n    {last_modified, position} = cast_new_lines(stream, last_modified, position)\n    # 1\u79d2\u30b9\u30ea\u30fc\u30d7\u5f8c\u3001\u51e6\u7406\u3092\u518d\u5e30\u3057\u307e\u3059\n    :timer.sleep(1000)\n    GenServer.cast(self, :check)\n    {:noreply, {stream, last_modified, position}}\n  end\n\n  defp cast_new_lines(stream, last_modified, position) do\n    cond do\n      # \u30d5\u30a1\u30a4\u30eb\u304c\u5b58\u5728\u3057\u306a\u3044\u5834\u5408\u306f\u30b9\u30eb\u30fc\n      !File.exists?(stream.path) ->\n        {last_modified, position}\n      # \u30d5\u30a1\u30a4\u30eb\u304c\u524d\u56de\u30c1\u30a7\u30c3\u30af\u6642\u3088\u308a\u66f4\u65b0\u3055\u308c\u3066\u3044\u306a\u3044\u5834\u5408\u3082\u30b9\u30eb\u30fc\n      File.stat!(stream.path).mtime == last_modified ->\n        # \u30ab\u30ec\u30f3\u30c8\u30dd\u30b8\u30b7\u30e7\u30f3\u306f\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3057\u3066\u304a\u304d\u307e\u3059\n        {last_modified, length(Enum.into(stream, []))}\n      true ->\n        # \u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\u6f14\u7b97\u5b50\u3092\u4f7f\u3063\u3066\u3001\u30ab\u30ec\u30f3\u30c8\u30dd\u30b8\u30b7\u30e7\u30f3\u4ee5\u964d\u306e\u884c\u3092\u30ea\u30b9\u30c8\u5316\n        lines = stream\n        |> Stream.drop(position)\n        |> Enum.into([])\n        if (length(lines) > 0) do\n          # \"tails:sample\" \u30c1\u30e3\u30f3\u30cd\u30eb\u306b\u884c\u306e\u30ea\u30b9\u30c8\u3092 broadcast\n          PhoenixTail.Endpoint.broadcast! \"tails:sample\", \"new_lines\", %{lines: lines}\n        end\n        # \u6700\u7d42\u66f4\u65b0\u65e5\u6642\u3068\u30ab\u30ec\u30f3\u30c8\u30dd\u30b8\u30b7\u30e7\u30f3\u3092\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3057\u3066\u304a\u304d\u307e\u3059\n        {File.stat!(stream.path).mtime, position + length(lines)}\n    end\n  end\nend\n\n\nGenServer \u304c\u7528\u610f\u3057\u3066\u3044\u308b callback \u7528\u306e\u95a2\u6570\u3060\u3051\u3067\u5b9f\u88c5\u3067\u304d\u307e\u3057\u305f\u3002\nGenServer \u7406\u89e3\u306e\uff11\u3064\u306e\u30dd\u30a4\u30f3\u30c8\u3068\u3057\u3066\u3001\u300c\u72b6\u614b\u3092\u4fdd\u6301\u3055\u305b\u308b\u300d\u3068\u3044\u3046\u3053\u3068\u304c\u3042\u308a\u307e\u3059\u3002\u3053\u306e\u300c\u72b6\u614b\u300d\u3068\u3044\u3046\u306e\u306f\u3001init/1 \u3084 handle_cast/2 \u3067 return \u3057\u3066\u3044\u308b\u5185\u5bb9\u3067\u3059\u3002\u3053\u308c\u304c\u6b21\u56de\u306e\u95a2\u6570\u30b3\u30fc\u30eb\u306b\u5f15\u304d\u56de\u3055\u308c\u308b\u3053\u3068\u3067\u3001\u72b6\u614b\u306e\u4fdd\u6301\u3092\u5b9f\u73fe\u3057\u3066\u3044\u307e\u3059\u3002\n\u30d7\u30ed\u30bb\u30b9\u6307\u5411\u72ec\u7279\u306e\u6982\u5ff5\u3067\u3061\u3087\u3063\u3068\u5206\u304b\u308a\u3065\u3089\u3044\u3067\u3059\u304c...\u601d\u8003\u3092\u30b7\u30d5\u30c8\u3055\u305b\u307e\u3057\u3087\u3046\u3002\n\n\u30d7\u30ed\u30bb\u30b9\u3092 Supervisor \u306b\u767b\u9332\u3059\u308b\n\u30d7\u30ed\u30bb\u30b9\u306e\u5b9f\u88c5\u304c\u7d42\u308f\u3063\u305f\u3089\u3001\u305d\u308c\u3092 Phoenix \u306e Supervisor \u306b\u767b\u9332\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\nlib/phoenix_tail.ex\ndefmodule PhoenixTail do\n  use Application\n\n  # See http://elixir-lang.org/docs/stable/elixir/Application.html\n  # for more information on OTP Applications\n  def start(_type, _args) do\n    import Supervisor.Spec, warn: false\n\n    children = [\n      # Start the endpoint when the application starts\n      supervisor(PhoenixTail.Endpoint, []),\n      # Start the Ecto repository\n      worker(PhoenixTail.Repo, []),\n      # Here you could define other workers and supervisors as children\n      # worker(PhoenixTail.Worker, [arg1, arg2, arg3]),\n\n      # \u4ee5\u4e0b\u306e1\u884c\u3092\u8ffd\u52a0\n      worker(PhoenixTail.Tail, [\"data/sample.log\"])\n    ]\n    ...\n  end\n  ...\nend\n\n\n\u3053\u308c\u3067\u8d77\u52d5\u6642\u306b\u30d7\u30ed\u30bb\u30b9\u304c\u7acb\u3061\u4e0a\u304c\u308a\u3001\u76e3\u8996\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\u5f15\u6570\u3067\u6e21\u3057\u3066\u3044\u308b data/sample.log \u304c tail \u306e\u30bf\u30fc\u30b2\u30c3\u30c8\u3068\u306a\u308b\u306e\u3067\u3059\u304c\u3001\u3053\u306e\u30d5\u30a1\u30a4\u30eb\u306b\u3064\u3044\u3066\u306f\u5f8c\u8ff0\u3057\u307e\u3059\u3002\n\n\u30d5\u30ed\u30f3\u30c8\u30a8\u30f3\u30c9\u3092\u4f5c\u308b\n\u6b21\u306b\u3001\u30b5\u30fc\u30d0\u304b\u3089 broadcast \u3055\u308c\u308b\u30ed\u30b0\u60c5\u5831\u3092\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u3059\u308b\u90e8\u5206\u3092\u4f5c\u308a\u307e\u3059\u3002\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u751f\u6210\u3055\u308c\u308b\u30da\u30fc\u30b8\u3092\u3061\u3087\u308d\u3063\u3068\u6539\u9020\u3057\u3066\u6e08\u307e\u305b\u307e\u3057\u3087\u3046\u3002\n\u307e\u305a\u306f\u4f9d\u5b58 JS \u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\nBrunch \u3092\u4f7f\u3063\u3066\u3082\u3044\u3044\u306e\u3067\u3059\u304c\u3001\u624b\u9593\u306a\u306e\u3067 CDN \u304b\u3089\u76f4\u63a5\u8aad\u307f\u8fbc\u307e\u305b\u307e\u3059\u3002\n\nweb/templates/layout/app.html.eex\n    ...\n\n      <%= @inner %>\n\n    </div> <!-- /container -->\n    <script src=\"//code.jquery.com/jquery-2.1.4.min.js\"></script>\n    <script src=\"//cdn.jsdelivr.net/jsrender/1.0pre35/jsrender.min.js\"></script>\n    <script src=\"<%= static_path(@conn, \"/js/app.js\") %>\"></script>\n  </body>\n</html>\n\n\n\n\u6b21\u306b\u30b3\u30f3\u30c6\u30f3\u30c4\u3067\u3059\u3002\n\u65e2\u5b58\u30b3\u30fc\u30c9\u3092\u5168\u6d88\u3057\u3057\u3066\u4ee5\u4e0b\u306e\u3082\u306e\u3060\u3051\u306b\u3057\u3066\u5927\u4e08\u592b\u3067\u3059\u3002\n\nweb/templates/page/index.html.eex\n<div class=\"row\">\n  <div class=\"col-xs-12\">\n    <ul id=\"loglines\" class=\"list-unstyled\">\n    </ul>\n  </div>\n</div>\n\n<script id=\"tmpl-logline\" type=\"text/x-jsrender\">\n  <li class=\"logline\">\n    {{>#data}}\n  </li>\n</script>\n\n\nJS \u306f\u3053\u3093\u306a\u611f\u3058\u3067\u3059\u3002\n\u3053\u308c\u3082\u65e2\u5b58\u306f\u5168\u6d88\u3057\u3067 OK \u3067\u3059\u3002\n\nweb/static/js/app.js\nimport {Socket} from \"deps/phoenix/web/static/js/phoenix/\"\n\nvar socket = new Socket(\"/socket\");\nsocket.connect();\nvar channel = socket.channel(\"tails:sample\", {});\nchannel.join();\n\nvar tmpl = $(\"#tmpl-logline\"),\n    loglines = $(\"#loglines\");\n\nchannel.on(\"new_lines\", function(dt) {\n    var lines = tmpl.render(dt.lines);\n    $(lines).each(function(i, e) {\n        $(e).animate({ \"background-color\": \"#fff\" }, 1000);\n    });\n    loglines.prepend(lines);\n});\n\n\n\u6700\u5f8c\u306b CSS\u3000\u3067\u3059\u3002\n\u3053\u308c\u306f\u672b\u5c3e\u306b\u8ffd\u52a0\u3067\u3002\u30d6\u30e9\u30a6\u30b6\u5dee\u5206\u306a\u3069\u306f\u9069\u5b9c\u8abf\u6574\u3057\u3066\u304f\u3060\u3055\u3044...\n\nweb/static/css/app.css\n...\n.logline {\n  font-size: 8px;\n  margin: 5px 0;\n  padding: 5px 0;\n  border-radius: 4px;\n  border-bottom: 1px solid #ddd;\n  background-color: #fff;\n  animation-name: animation;\n  animation-duration: 1s;\n  animation-timing-function: ease-in-out;\n  animation-iteration-count: 1;\n}\n.logline:first-child {\n  font-size: 16px;\n}\n@-webkit-keyframes animation {\n    0%     {background-color: #f5f5dc;}\n    100.0%  {background-color: #ffffff;}\n}\n\n\n\u4ee5\u4e0a\u3067\u30d5\u30ed\u30f3\u30c8\u30a8\u30f3\u30c9\u306f\u5b8c\u4e86\u3067\u3059\u3002\n\n\u30c0\u30df\u30fc\u306e\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u308b\n\u672c\u5f53\u306f\u5b9f\u969b\u306b Web \u30b5\u30fc\u30d3\u30b9\u304c\u7a3c\u50cd\u3057\u3066\u3044\u308b\u30b5\u30fc\u30d0\u306e apache \u30ed\u30b0\u3092\u5bfe\u8c61\u306b\u3057\u305f\u304b\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u624b\u9803\u306a\u3082\u306e\u304c\u306a\u304b\u3063\u305f\u306e\u3067\u3001\u30c0\u30df\u30fc\u3092\u751f\u6210\u3057\u307e\u3059\u3002\n\u4e16\u306e\u4e2d\u4fbf\u5229\u306a\u3082\u306e\u3067\u3001apache \u30ed\u30b0\u3092\u751f\u6210\u3057\u3066\u304f\u308c\u308b\u30c4\u30fc\u30eb\u304c\u5b58\u5728\u3057\u307e\u3057\u305f\u3002\ntamtam180/apache_log_gen\n\u3053\u308c\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3001\u5148\u307b\u3069\u6307\u5b9a\u3057\u305f data/sample.log \u306b\u30c4\u30e9\u30c4\u30e9\u3068\u30c0\u30df\u30fc\u3092\u51fa\u529b\u3055\u305b\u3066\u304a\u304d\u307e\u3057\u3087\u3046\uff08\u76f8\u5bfe\u30d1\u30b9\u306a\u306e\u3067\u5b9f\u884c\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u306f\u3054\u7559\u610f\u304f\u3060\u3055\u3044\uff09\n$ apache-loggen --rate=2 data/sample.log\n\n\n\u52d5\u4f5c\u3092\u78ba\u8a8d\u3059\u308b\n\u3055\u3066\u3001\u4ee5\u4e0a\u3067\u6e96\u5099\u306f\u6574\u3044\u307e\u3057\u305f\u3002\n\u304a\u3082\u3080\u308d\u306b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u8d77\u52d5\u3057\u3066\u3001localhost:4000 \u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\n\u3044\u3044\u611f\u3058\u3067\u3059\u306d\uff01\n\u4e00\u5b9a\u91cf\u306e\u30c0\u30df\u30fc\u304c\u751f\u6210\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u611f\u304c\u8584\u3044\u3067\u3059\u304c\u3001\u7d1b\u308c\u3082\u306a\u304f tail \u306e\u6319\u52d5\u3067\u3059\u3002\n\n\u611f\u60f3\n\n\u30cd\u30bf\u3067\u3084\u3063\u305f\u3064\u3082\u308a\u304c\u3001\u610f\u5916\u3068 GenServer \u306e\u52c9\u5f37\u306b\u306a\u3063\u305f\n\u300c\u958b\u767a\u6642\u306b\u30ed\u30b0\u3092\u898b\u308b\u306a\u3089tail\u3088\u308a\u3082less\uff01\uff01\u300d\u3068\u3044\u3046\u30c4\u30c3\u30b3\u30df\u306fNG\n\u30d6\u30e9\u30a6\u30b6\u304b\u3089 tail \u3059\u308b\u30d5\u30a1\u30a4\u30eb\u3092\u6307\u5b9a\u3067\u304d\u305f\u308a\u3059\u308b\u3068\u7d20\u6575\n\u30b5\u30fc\u30d0\u3092\u307e\u305f\u3044\u3067\u30d5\u30a1\u30a4\u30eb\u3092\u6307\u5b9a\u3067\u304d\u308b\u3068\u3082\u3063\u3068\u7d20\u6575\n\n\n\n\n\n\u6b8b\u5ff5\u306a\u304c\u3089\u6b63\u78ba\u306b\u306f Phoenix Down \u3068\u8a33\u3059\u3089\u3057\u3044\u3002\u00a0\u21a9\n\n\n\nPhoenix \u3092\u4f7f\u3063\u3066\u30d6\u30e9\u30a6\u30b6\u4e0a\u3067\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u3092\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u306b tail \u3059\u308b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u4f5c\u3063\u3066\u307f\u307e\u3059\u3002\n\n\u305d\u3046\u3001\u3064\u307e\u308a\u3053\u308c\u306f\u3001Phoenix Tail\u3002\n\n\uff3f\u4eba\u4eba\u4eba\u4eba\u4eba\u4eba\u4eba\u4eba\u4eba\u4eba\uff3f\n\uff1e\u3000\u30d5\u30a7\u30cb\u30c3\u30af\u30b9\u306e\u5c3e[^1]\u3000\uff1c\n\uffe3Y^Y^Y^Y^Y^Y^Y^Y^Y\uffe3\n\n[^1]: \u6b8b\u5ff5\u306a\u304c\u3089\u6b63\u78ba\u306b\u306f Phoenix Down \u3068\u8a33\u3059\u3089\u3057\u3044\u3002\n\n# \u5b8c\u6210\u30a4\u30e1\u30fc\u30b8\n\n\u3053\u3093\u306a\u611f\u3058\u3067\u3059\u3002\n\n<img width=\"600\" alt=\"capture.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/77513/56003d85-8692-008f-529c-95e37423875d.png\">\n\n\n# Phoenix \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3059\u308b\n\n\u65e9\u901f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u4f5c\u3063\u3066\u3044\u304d\u307e\u3057\u3087\u3046\u3002\nPhoenixTail \u3068\u3044\u3046\u540d\u524d\u3067\u4f5c\u308a\u307e\u3059\u3002\n\n```bash\n$ mix phoenix.new phoenix_tail\n```\n\nWebSocket \u306e\u8a2d\u5b9a\u3092\u3057\u3066\u304a\u304d\u307e\u3059\uff08\u8a73\u7d30\u306f[\u30b3\u30c1\u30e9](http://qiita.com/mserizawa/items/2c67031e794964f3a740)\uff09\n\n```ex:web/channels/user_socket.ex\ndefmodule PhoenixTail.UserSocket do\n  use Phoenix.Socket\n\n  ## Channels\n  # \u4ee5\u4e0b\u306e\u884c\u3092\u8ffd\u52a0\n  channel \"tails:*\", PhoenixTail.TailChannel\n\n  ## Transports\n  transport :websocket, Phoenix.Transports.WebSocket\n  ...\nend\n```\n\nTailChannel \u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u4eca\u56de\u306f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u306e Push \u306f\u60f3\u5b9a\u3057\u3066\u3044\u306a\u3044\u306e\u3067\u3001join \u3060\u3051\u5b9f\u88c5\u3057\u307e\u3059\u3002\n\n```ex:web/channels/tail_channel.ex\ndefmodule PhoenixTail.TailChannel do\n  use Phoenix.Channel\n\n  def join(\"tails:sample\", auth_msg, socket) do\n    {:ok, socket}\n  end\n  def join(\"tails:\" <> _private_room_id, _auth_msg, socket) do\n    {:error, %{reason: \"unauthorized\"}}\n  end\nend\n```\n\n# \u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u3092\u76e3\u8996\u3059\u308b\u30d7\u30ed\u30bb\u30b9\u3092\u4f5c\u308b\n\n\u6b21\u306b\u3001tail \u306e\u5bfe\u8c61\u3068\u3059\u308b\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u3092\u76e3\u8996\u3059\u308b\u90e8\u5206\u3092\u5b9f\u88c5\u3057\u307e\u3059\u3002\n\u51e6\u7406\u306e\u6d41\u308c\u3068\u3057\u3066\u306f\u3001\n\n* \u5b9a\u671f\u7684\u306b\u5bfe\u8c61\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u30c1\u30a7\u30c3\u30af\n* \u5909\u66f4\u304c\u5165\u3063\u3066\u3044\u308c\u3070\u3001\u524d\u56de\u53d6\u5f97\u884c\u4ee5\u964d\u306e\u884c\u3092\u53d6\u5f97\n* \u53d6\u5f97\u3057\u305f\u5185\u5bb9\u3092 WebSocket \u306b broadcast\n\n\u3068\u3044\u3046\u611f\u3058\u3067\u3001\u30b5\u30fc\u30d0\u3078\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u306a\u3069\u3068\u306f\u4e00\u5207\u95a2\u4fc2\u306a\u3044\u3082\u306e\u3068\u306a\u308a\u307e\u3059\u3002\n\u3064\u307e\u308a\u3001\u72ec\u7acb\u3057\u305f\u30d7\u30ed\u30bb\u30b9\u3092\u4f5c\u308b\u5fc5\u8981\u304c\u3042\u308b\u306e\u3067\u3059\u304c\u3001\u3053\u308c\u306f Elixir \u304c\u3059\u3053\u3076\u308b\u5f97\u610f\u3068\u3059\u308b\u5206\u91ce\u3067\u3001GenServer \u3068\u3044\u3046\u6982\u5ff5\u3092\u4f7f\u3046\u3068\u30b7\u30f3\u30d7\u30eb\u306b\u5b9f\u88c5\u3067\u304d\u307e\u3059\u3002GenServer \u306b\u3064\u3044\u3066\u306f\u3001@naoya@github \u3055\u3093\u306e[\u30b3\u30c1\u30e9\u306e\u8a18\u4e8b](http://qiita.com/naoya@github/items/ae17a8166e52fc463012#%E3%83%93%E3%83%98%E3%82%A4%E3%83%93%E3%82%A2%E3%81%AB%E4%B9%97%E3%81%A3%E3%81%8B%E3%81%A3%E3%81%9F%E3%81%8A%E3%81%8B%E3%81%92%E3%81%A7--supervisor)\u304c\u5927\u5909\u53c2\u8003\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306e\u5168\u5bb9\u306f\u3053\u3093\u306a\u611f\u3058\u3067\u3059\u3002\n\n```ex:lib/phoenix_tail/tail.ex\ndefmodule PhoenixTail.Tail do\n  use GenServer\n\n  # \u89aa\u30d7\u30ed\u30bb\u30b9\u3068\u306e\u30ea\u30f3\u30af\u51e6\u7406\n  def start_link(file) do\n    # \u5f15\u6570\u3067\u53d7\u3051\u53d6\u3063\u305f\u30bf\u30fc\u30b2\u30c3\u30c8\u30d5\u30a1\u30a4\u30eb\u306e\u30d1\u30b9\u3092\u6e21\u3057\u307e\u3059\n    GenServer.start_link(__MODULE__, {file})\n  end\n\n  # \u521d\u671f\u5316\u51e6\u7406\n  def init({file}) do\n    # \u53d7\u3051\u53d6\u3063\u305f\u30d5\u30a1\u30a4\u30eb\u30d1\u30b9\u3092\u30b9\u30c8\u30ea\u30fc\u30e0\u306b\u3057\u3066\u3001cast \u3092\u547c\u3073\u307e\u3059\n    stream = File.stream!(file)\n    GenServer.cast(self, :check)\n    {:ok, {stream, nil, 0}}\n  end\n\n  def handle_cast(:check, {stream, last_modified, position}) do\n    # \u5909\u66f4\u3092\u30c1\u30a7\u30c3\u30af\u3057\u3066 broadcast \u3057\u307e\u3059\n    {last_modified, position} = cast_new_lines(stream, last_modified, position)\n    # 1\u79d2\u30b9\u30ea\u30fc\u30d7\u5f8c\u3001\u51e6\u7406\u3092\u518d\u5e30\u3057\u307e\u3059\n    :timer.sleep(1000)\n    GenServer.cast(self, :check)\n    {:noreply, {stream, last_modified, position}}\n  end\n\n  defp cast_new_lines(stream, last_modified, position) do\n    cond do\n      # \u30d5\u30a1\u30a4\u30eb\u304c\u5b58\u5728\u3057\u306a\u3044\u5834\u5408\u306f\u30b9\u30eb\u30fc\n      !File.exists?(stream.path) ->\n        {last_modified, position}\n      # \u30d5\u30a1\u30a4\u30eb\u304c\u524d\u56de\u30c1\u30a7\u30c3\u30af\u6642\u3088\u308a\u66f4\u65b0\u3055\u308c\u3066\u3044\u306a\u3044\u5834\u5408\u3082\u30b9\u30eb\u30fc\n      File.stat!(stream.path).mtime == last_modified ->\n        # \u30ab\u30ec\u30f3\u30c8\u30dd\u30b8\u30b7\u30e7\u30f3\u306f\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3057\u3066\u304a\u304d\u307e\u3059\n        {last_modified, length(Enum.into(stream, []))}\n      true ->\n        # \u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\u6f14\u7b97\u5b50\u3092\u4f7f\u3063\u3066\u3001\u30ab\u30ec\u30f3\u30c8\u30dd\u30b8\u30b7\u30e7\u30f3\u4ee5\u964d\u306e\u884c\u3092\u30ea\u30b9\u30c8\u5316\n        lines = stream\n        |> Stream.drop(position)\n        |> Enum.into([])\n        if (length(lines) > 0) do\n          # \"tails:sample\" \u30c1\u30e3\u30f3\u30cd\u30eb\u306b\u884c\u306e\u30ea\u30b9\u30c8\u3092 broadcast\n          PhoenixTail.Endpoint.broadcast! \"tails:sample\", \"new_lines\", %{lines: lines}\n        end\n        # \u6700\u7d42\u66f4\u65b0\u65e5\u6642\u3068\u30ab\u30ec\u30f3\u30c8\u30dd\u30b8\u30b7\u30e7\u30f3\u3092\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3057\u3066\u304a\u304d\u307e\u3059\n        {File.stat!(stream.path).mtime, position + length(lines)}\n    end\n  end\nend\n```\n\nGenServer \u304c\u7528\u610f\u3057\u3066\u3044\u308b callback \u7528\u306e\u95a2\u6570\u3060\u3051\u3067\u5b9f\u88c5\u3067\u304d\u307e\u3057\u305f\u3002\n\nGenServer \u7406\u89e3\u306e\uff11\u3064\u306e\u30dd\u30a4\u30f3\u30c8\u3068\u3057\u3066\u3001\u300c\u72b6\u614b\u3092\u4fdd\u6301\u3055\u305b\u308b\u300d\u3068\u3044\u3046\u3053\u3068\u304c\u3042\u308a\u307e\u3059\u3002\u3053\u306e\u300c\u72b6\u614b\u300d\u3068\u3044\u3046\u306e\u306f\u3001`init/1` \u3084 `handle_cast/2` \u3067 return \u3057\u3066\u3044\u308b\u5185\u5bb9\u3067\u3059\u3002\u3053\u308c\u304c\u6b21\u56de\u306e\u95a2\u6570\u30b3\u30fc\u30eb\u306b\u5f15\u304d\u56de\u3055\u308c\u308b\u3053\u3068\u3067\u3001\u72b6\u614b\u306e\u4fdd\u6301\u3092\u5b9f\u73fe\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u30d7\u30ed\u30bb\u30b9\u6307\u5411\u72ec\u7279\u306e\u6982\u5ff5\u3067\u3061\u3087\u3063\u3068\u5206\u304b\u308a\u3065\u3089\u3044\u3067\u3059\u304c...\u601d\u8003\u3092\u30b7\u30d5\u30c8\u3055\u305b\u307e\u3057\u3087\u3046\u3002\n\n# \u30d7\u30ed\u30bb\u30b9\u3092 Supervisor \u306b\u767b\u9332\u3059\u308b\n\n\u30d7\u30ed\u30bb\u30b9\u306e\u5b9f\u88c5\u304c\u7d42\u308f\u3063\u305f\u3089\u3001\u305d\u308c\u3092 Phoenix \u306e Supervisor \u306b\u767b\u9332\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\n```ex:lib/phoenix_tail.ex\ndefmodule PhoenixTail do\n  use Application\n\n  # See http://elixir-lang.org/docs/stable/elixir/Application.html\n  # for more information on OTP Applications\n  def start(_type, _args) do\n    import Supervisor.Spec, warn: false\n\n    children = [\n      # Start the endpoint when the application starts\n      supervisor(PhoenixTail.Endpoint, []),\n      # Start the Ecto repository\n      worker(PhoenixTail.Repo, []),\n      # Here you could define other workers and supervisors as children\n      # worker(PhoenixTail.Worker, [arg1, arg2, arg3]),\n\n      # \u4ee5\u4e0b\u306e1\u884c\u3092\u8ffd\u52a0\n      worker(PhoenixTail.Tail, [\"data/sample.log\"])\n    ]\n    ...\n  end\n  ...\nend\n```\n\n\u3053\u308c\u3067\u8d77\u52d5\u6642\u306b\u30d7\u30ed\u30bb\u30b9\u304c\u7acb\u3061\u4e0a\u304c\u308a\u3001\u76e3\u8996\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\u5f15\u6570\u3067\u6e21\u3057\u3066\u3044\u308b `data/sample.log` \u304c tail \u306e\u30bf\u30fc\u30b2\u30c3\u30c8\u3068\u306a\u308b\u306e\u3067\u3059\u304c\u3001\u3053\u306e\u30d5\u30a1\u30a4\u30eb\u306b\u3064\u3044\u3066\u306f\u5f8c\u8ff0\u3057\u307e\u3059\u3002\n\n# \u30d5\u30ed\u30f3\u30c8\u30a8\u30f3\u30c9\u3092\u4f5c\u308b\n\n\u6b21\u306b\u3001\u30b5\u30fc\u30d0\u304b\u3089 broadcast \u3055\u308c\u308b\u30ed\u30b0\u60c5\u5831\u3092\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u3059\u308b\u90e8\u5206\u3092\u4f5c\u308a\u307e\u3059\u3002\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u751f\u6210\u3055\u308c\u308b\u30da\u30fc\u30b8\u3092\u3061\u3087\u308d\u3063\u3068\u6539\u9020\u3057\u3066\u6e08\u307e\u305b\u307e\u3057\u3087\u3046\u3002\n\n\u307e\u305a\u306f\u4f9d\u5b58 JS \u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\nBrunch \u3092\u4f7f\u3063\u3066\u3082\u3044\u3044\u306e\u3067\u3059\u304c\u3001\u624b\u9593\u306a\u306e\u3067 CDN \u304b\u3089\u76f4\u63a5\u8aad\u307f\u8fbc\u307e\u305b\u307e\u3059\u3002\n\n```jsp:web/templates/layout/app.html.eex\n    ...\n\n      <%= @inner %>\n\n    </div> <!-- /container -->\n    <script src=\"//code.jquery.com/jquery-2.1.4.min.js\"></script>\n    <script src=\"//cdn.jsdelivr.net/jsrender/1.0pre35/jsrender.min.js\"></script>\n    <script src=\"<%= static_path(@conn, \"/js/app.js\") %>\"></script>\n  </body>\n</html>\n\n```\n\n\u6b21\u306b\u30b3\u30f3\u30c6\u30f3\u30c4\u3067\u3059\u3002\n\u65e2\u5b58\u30b3\u30fc\u30c9\u3092\u5168\u6d88\u3057\u3057\u3066\u4ee5\u4e0b\u306e\u3082\u306e\u3060\u3051\u306b\u3057\u3066\u5927\u4e08\u592b\u3067\u3059\u3002\n\n```jsp:web/templates/page/index.html.eex\n<div class=\"row\">\n  <div class=\"col-xs-12\">\n    <ul id=\"loglines\" class=\"list-unstyled\">\n    </ul>\n  </div>\n</div>\n\n<script id=\"tmpl-logline\" type=\"text/x-jsrender\">\n  <li class=\"logline\">\n    {{>#data}}\n  </li>\n</script>\n```\n\nJS \u306f\u3053\u3093\u306a\u611f\u3058\u3067\u3059\u3002\n\u3053\u308c\u3082\u65e2\u5b58\u306f\u5168\u6d88\u3057\u3067 OK \u3067\u3059\u3002\n\n```js:web/static/js/app.js\nimport {Socket} from \"deps/phoenix/web/static/js/phoenix/\"\n\nvar socket = new Socket(\"/socket\");\nsocket.connect();\nvar channel = socket.channel(\"tails:sample\", {});\nchannel.join();\n\nvar tmpl = $(\"#tmpl-logline\"),\n    loglines = $(\"#loglines\");\n\nchannel.on(\"new_lines\", function(dt) {\n    var lines = tmpl.render(dt.lines);\n    $(lines).each(function(i, e) {\n        $(e).animate({ \"background-color\": \"#fff\" }, 1000);\n    });\n    loglines.prepend(lines);\n});\n```\n\n\u6700\u5f8c\u306b CSS\u3000\u3067\u3059\u3002\n\u3053\u308c\u306f\u672b\u5c3e\u306b\u8ffd\u52a0\u3067\u3002\u30d6\u30e9\u30a6\u30b6\u5dee\u5206\u306a\u3069\u306f\u9069\u5b9c\u8abf\u6574\u3057\u3066\u304f\u3060\u3055\u3044...\n\n```css:web/static/css/app.css\n...\n.logline {\n  font-size: 8px;\n  margin: 5px 0;\n  padding: 5px 0;\n  border-radius: 4px;\n  border-bottom: 1px solid #ddd;\n  background-color: #fff;\n  animation-name: animation;\n  animation-duration: 1s;\n  animation-timing-function: ease-in-out;\n  animation-iteration-count: 1;\n}\n.logline:first-child {\n  font-size: 16px;\n}\n@-webkit-keyframes animation {\n    0%     {background-color: #f5f5dc;}\n    100.0%  {background-color: #ffffff;}\n}\n```\n\n\u4ee5\u4e0a\u3067\u30d5\u30ed\u30f3\u30c8\u30a8\u30f3\u30c9\u306f\u5b8c\u4e86\u3067\u3059\u3002\n\n# \u30c0\u30df\u30fc\u306e\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u308b\n\n\u672c\u5f53\u306f\u5b9f\u969b\u306b Web \u30b5\u30fc\u30d3\u30b9\u304c\u7a3c\u50cd\u3057\u3066\u3044\u308b\u30b5\u30fc\u30d0\u306e apache \u30ed\u30b0\u3092\u5bfe\u8c61\u306b\u3057\u305f\u304b\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u624b\u9803\u306a\u3082\u306e\u304c\u306a\u304b\u3063\u305f\u306e\u3067\u3001\u30c0\u30df\u30fc\u3092\u751f\u6210\u3057\u307e\u3059\u3002\n\u4e16\u306e\u4e2d\u4fbf\u5229\u306a\u3082\u306e\u3067\u3001apache \u30ed\u30b0\u3092\u751f\u6210\u3057\u3066\u304f\u308c\u308b\u30c4\u30fc\u30eb\u304c\u5b58\u5728\u3057\u307e\u3057\u305f\u3002\n\n[tamtam180/apache_log_gen]( https://github.com/tamtam180/apache_log_gen)\n\n\u3053\u308c\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3001\u5148\u307b\u3069\u6307\u5b9a\u3057\u305f `data/sample.log` \u306b\u30c4\u30e9\u30c4\u30e9\u3068\u30c0\u30df\u30fc\u3092\u51fa\u529b\u3055\u305b\u3066\u304a\u304d\u307e\u3057\u3087\u3046\uff08\u76f8\u5bfe\u30d1\u30b9\u306a\u306e\u3067\u5b9f\u884c\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u306f\u3054\u7559\u610f\u304f\u3060\u3055\u3044\uff09\n\n```bash\n$ apache-loggen --rate=2 data/sample.log\n```\n\n# \u52d5\u4f5c\u3092\u78ba\u8a8d\u3059\u308b\n\n\u3055\u3066\u3001\u4ee5\u4e0a\u3067\u6e96\u5099\u306f\u6574\u3044\u307e\u3057\u305f\u3002\n\u304a\u3082\u3080\u308d\u306b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u8d77\u52d5\u3057\u3066\u3001`localhost:4000` \u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\n![capture.gif](https://qiita-image-store.s3.amazonaws.com/0/77513/3e6cbe11-37da-bf5e-acba-9a1250f0cebc.gif)\n\n\u3044\u3044\u611f\u3058\u3067\u3059\u306d\uff01\n\u4e00\u5b9a\u91cf\u306e\u30c0\u30df\u30fc\u304c\u751f\u6210\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u611f\u304c\u8584\u3044\u3067\u3059\u304c\u3001\u7d1b\u308c\u3082\u306a\u304f tail \u306e\u6319\u52d5\u3067\u3059\u3002\n\n# \u611f\u60f3\n\n* \u30cd\u30bf\u3067\u3084\u3063\u305f\u3064\u3082\u308a\u304c\u3001\u610f\u5916\u3068 GenServer \u306e\u52c9\u5f37\u306b\u306a\u3063\u305f\n* \u300c[\u958b\u767a\u6642\u306b\u30ed\u30b0\u3092\u898b\u308b\u306a\u3089tail\u3088\u308a\u3082less\uff01\uff01](http://qiita.com/yusabana/items/b5cc2a706be8c031043e)\u300d\u3068\u3044\u3046\u30c4\u30c3\u30b3\u30df\u306fNG\n* \u30d6\u30e9\u30a6\u30b6\u304b\u3089 tail \u3059\u308b\u30d5\u30a1\u30a4\u30eb\u3092\u6307\u5b9a\u3067\u304d\u305f\u308a\u3059\u308b\u3068\u7d20\u6575\n* \u30b5\u30fc\u30d0\u3092\u307e\u305f\u3044\u3067\u30d5\u30a1\u30a4\u30eb\u3092\u6307\u5b9a\u3067\u304d\u308b\u3068\u3082\u3063\u3068\u7d20\u6575\n", "tags": ["Phoenix", "Elixir"]}