{"context": "\n\n\u69cb\u7bc9\u3057\u305f\u3044\u74b0\u5883\n\nCentOS7\nPHP7\nApache\nMySQL5.7\n\n\n\u5e8f\u8ad6\n\u4ed5\u4e8b\u3067PHP\u3092\u4f7f\u3046\u3053\u3068\u306b\u306a\u308a\u305d\u3046\u3060\u3063\u305f\u306e\u3067\u3001\u52c9\u5f37\u304c\u3066\u3089PHP\u306e\u52d5\u4f5c\u74b0\u5883\u3092\u69cb\u7bc9\u3057\u305f\u3002\n\u4eca\u5f8c\u3001\u983b\u7e41\u306b\u4f7f\u3046\u3053\u3068\u306b\u306a\u308b\u3068\u601d\u3046\u306e\u3067\u624b\u9806\u3092\u30e1\u30e2\u3057\u3066\u304a\u304f\u3002\n\u306a\u304a\u3001\u30db\u30b9\u30c8OS\u306f\u3001EI Capitan\u3067\u3042\u308a\u3001vagrant\u3001virtual box\u306f\u3001\u30db\u30b9\u30c8OS\u306b\u5c0e\u5165\u6e08\u3067\u3042\u308b\u3053\u3068\u3092\u524d\u63d0\u3068\u3057\u3066\u3044\u308b\u3002\nCentOS7\u4e0a\u3067\u306f\u3001chef-client\u306elocal mode\u3067chef\u3092\u5b9f\u884c\u3059\u308b\u3002\nchef\u3092\u5b9f\u884c\u3059\u308b\u305f\u3081\u306eruby\u306f\u3001rvm\u3067ruby 2.3\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n\u306a\u304a\u3001rvm\u3001ruby\u3001chef\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u53ca\u3073chef\u306e\u5b9f\u884c\u306f\u3001Vagrant\u306e\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u3067\u5b9f\u884c\u3057\u305f\u3002\n\u307e\u305f\u3001\u4eca\u56de\u4f7f\u7528\u3057\u305fchef\u306e\u30af\u30c3\u30af\u30d6\u30c3\u30af\u306f\u3001\u4e88\u3081GitHub\u306b\u767b\u9332\u3057\u3066\u304a\u304d\u3001clone\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u308b\u3002\nchef\u306e\u30af\u30c3\u30af\u30d6\u30c3\u30af\u306e\u4f5c\u6210\u624b\u9806\u306f\u3001\u672c\u8a18\u4e8b\u306e\u672b\u5c3e\u306b\u8a18\u8f09\u3057\u3066\u3044\u308b\u3002\n\u305d\u306e\u5f8c\u306eMySQL\u306e\u521d\u671f\u8a2d\u5b9a\u306f\u3001\u81ea\u52d5\u5316\u3067\u304d\u305d\u3046\u3082\u306a\u3044\u306e\u3067\u30b5\u30fc\u30d0\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u305f\u72b6\u614b\u3067\u5b9f\u65bd\u3057\u305f\u3002\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nvagrant\u3067centos7\u306e\u521d\u671f\u8a2d\u5b9a\u3092\u3059\u308b\u3002\n% vagrant init centos/7\n\n\n\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306e\u8a2d\u5b9a\u3068\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u306e\u8a2d\u5b9a\u3092\u3059\u308b\u3002\n\u5b9f\u884c\u3059\u308b\u30b3\u30de\u30f3\u30c9\u3092\u5358\u7d14\u306b\u7f85\u5217\u3057\u305f\u3060\u3051\u3060\u3068\u3001\u6240\u5b9a\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3(rvm\u3084ruby)\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5f8c\u306b\u3001\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u30d1\u30b9\u304c\u5373\u6709\u52b9\u306b\u306a\u3089\u305a\u306b\u30a8\u30e9\u30fc\u306b\u306a\u308b\u3002\n\u3053\u308c\u3092\u56de\u907f\u3059\u308b\u305f\u3081\u306b\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u5185\u3067xxx_install_script\u3068\u4f55\u500b\u304b\u306b\u5206\u5272\u3057\u3066\u3044\u308b\u3002\n\u3082\u3046\u5c11\u3057\u30b9\u30de\u30fc\u30c8\u306a\u56de\u907f\u7b56\u306f\u306a\u3044\u3082\u306e\u304b\u2026\u3002\n% vi Vagrantfile\n# config.vm.network :private_network, ip: \"192.168.33.10\"\n    \u2191\u3053\u306e\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3092\u5916\u3059\u3002IP\u306f\u9069\u5f53\u306b\u3002\n\n<\u7701\u7565>\n\n  first_install_script = <<SCRIPT\n    # TimeZone : UTC -> JST\n    timedatectl set-timezone Asia/Tokyo\n\n    # install rvm, ruby2.3\n    gpg2 --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3\n    curl -L https://get.rvm.io | sudo bash -s stable\n    gpasswd -a vagrant rvm\nSCRIPT\n\n  second_install_script = <<SCRIPT\n    sudo -i -u vagrant rvm install 2.3 --default\nSCRIPT\n\n  third_install_script = <<SCRIPT\n    # gem install for chef\n    sudo -i -u vagrant gem install bundler\n    sudo -i -u vagrant gem install chef\n    sudo -i -u vagrant gem install knife-solo\nSCRIPT\n\n  fourth_install_script = <<SCRIPT\n    # install git for to download cookbook repository\n    yum -y update\n    yum -y install git\n\n    sudo -u vagrant git clone https://github.com/eidera/chef-php-env.git\n\n    # execute chef\n    cd /home/vagrant/chef-php-env && rvmsudo_secure_path=1 /usr/local/rvm/bin/rvmsudo chef-client --local-mode -j nodes/chef.json -c chef.rb\nSCRIPT\n\n  config.vm.provision :shell, :inline => first_install_script\n  config.vm.provision :shell, :inline => second_install_script\n  config.vm.provision :shell, :inline => third_install_script\n  config.vm.provision :shell, :inline => fourth_install_script\n\n\n\u4eee\u60f3\u30de\u30b7\u30f3\u3092\u7acb\u3061\u4e0a\u3052\u308b\u3002\n% vagrant up\n\n\n\u901a\u5e38\u306essh\u30b3\u30de\u30f3\u30c9\u3067\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u3059\u308b\u3002\n% vagrant ssh-config --host local.phpdev >> ~/.ssh/config\n% ssh local.phpdev\n\n\nMySQL\u306e\u8a2d\u5b9a\nroot\u306e\u521d\u671f\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u78ba\u8a8d\u3059\u308b\u3002\n% sudo less /var/log/mysqld.log\ntemporary password\u3092\u691c\u7d22\u3057\u3066\u3001root\u306e\u521d\u671f\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u78ba\u8a8d\n\nmysql\u306e\u521d\u671f\u8a2d\u5b9a(root\u30d1\u30b9\u30ef\u30fc\u30c9\u5909\u66f4\u306a\u3069)\n% mysql_secure_installation\n\u6307\u793a\u901a\u308a\u5165\u529b\u3057\u3066\u3044\u304f\n\n\u30e6\u30fc\u30b6\u30fc(username)\u3092\u8ffd\u52a0\u3059\u308b\u3002\n\u306a\u304a\u3001\u4e0b\u8a18\u3067\u306f\u3001\u5168\u3066\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u5bfe\u3057\u3066192.168.\u4ee5\u4e0b\u5168\u3066\u306eIP\u304b\u3089\u306e\u5916\u90e8\u63a5\u7d9a\u3092\u8a31\u53ef\u3057\u3066\u3044\u308b\u3002\n\u3053\u306e\u8fba\u308a\u306e\u8a2d\u5b9a\u306f\u74b0\u5883\u306b\u5fdc\u3058\u3066\u3001\u9069\u5b9c\u4fee\u6b63\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n% mysql -u root -p\n\u65b0\u898f\u30d1\u30b9\u30ef\u30fc\u30c9\u5165\u529b\nmysql> GRANT ALL PRIVILEGES ON *.* TO username@localhost IDENTIFIED BY 'passwd_hogehoge';\nmysql> GRANT ALL privileges ON *.* TO username@\"192.168.%.%\" IDENTIFIED BY 'passwd_hogehoge' WITH GRANT OPTION;\nmysql> flush privileges;\nmysql> select user,host from mysql.user;\n\n\u306a\u304a\u3001\u30ed\u30fc\u30ab\u30eb\u306e\u958b\u767a\u74b0\u5883\u306a\u306e\u3067\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u7c21\u5358\u306b\u3057\u305f\u3044\u3068\u3044\u3046\u5834\u5408\u306b\u306f\u3001\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3059\u308c\u3070\u4f8b\u3048\u3070\u3001\u9577\u3055\u3084\u30dd\u30ea\u30b7\u30fc\u3092\u5909\u66f4\u3067\u304d\u308b\u3002\nmysql> SET GLOBAL validate_password_length=4;\nmysql> SET GLOBAL validate_password_policy=LOW;\nmysql> SHOW VARIABLES LIKE 'validate_password%';\n  \u2192\u8a2d\u5b9a\u306e\u78ba\u8a8d\n\n\nApache\u306e\u958b\u767a\u74b0\u5883\u7528\u521d\u671f\u8a2d\u5b9a\n\u30db\u30b9\u30c8OS\u5074\u3067\u4fee\u6b63\u3059\u308b\u305f\u3081\u306b\u3001DocumentRoot\u3092\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u306b\u5909\u66f4\u3059\u308b\u3002\n\u4f46\u3057\u3001SELinux\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\u3001\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u306fForbidden\u306b\u306a\u3063\u3066\u3057\u307e\u3046\u3002\n\u958b\u767a\u74b0\u5883\u306a\u306e\u3067SELinux\u3092\u7121\u52b9\u306b\u3057\u305f\u3002\n% sudo mv /var/www/html /var/www/html.orig\n% cd /var/www && sudo ln -s /vagrant/html\n% sudo setenforce 0\n\n\u306a\u304a\u3001\u30db\u30b9\u30c8\u5074\u3067\u30d5\u30a1\u30a4\u30eb\u3092\u5909\u66f4\u3059\u308b\u5ea6\u306brsync\u3067\u540c\u671f\u3059\u308b\u305f\u3081\u306b\u306f\u3001\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u3066\u304a\u304f\u3002\n% vagrant rsync-auto\n\n\u4ee5\u4e0a\u3067\u74b0\u5883\u69cb\u7bc9\u306f\u7d42\u4e86\u3002\n\nchef\u306e\u30af\u30c3\u30af\u30d6\u30c3\u30af\u306e\u4f5c\u6210\u624b\u9806\n\u30af\u30c3\u30af\u30d6\u30c3\u30af\u306e\u4f5c\u6210\u624b\u9806\u3092\u5099\u5fd8\u9332\u3068\u3057\u3066\u6b8b\u3057\u3066\u304a\u304f\u3002\nphp\u3084Apache\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306a\u3069\u8ffd\u52a0\u3057\u3066\u3044\u3063\u305f\u3082\u306e\u306f\u3053\u3053\u306b\u8a18\u8f09\u3057\u3066\u3044\u306a\u3044\u306e\u3067\u3001GitHub\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u3092\u76f4\u63a5\u78ba\u8a8d\u3057\u305f\u65b9\u304c\u3088\u3044\u3002\n% cd\n% mkdir chef-php-env\n% cd chef-php-env\n% knife solo init .\n% knife cookbook create develop_tools_cookbook -o site-cookbooks\n% knife cookbook create php7_cookbook -o site-cookbooks\n% knife cookbook create apache_cookbook -o site-cookbooks\n% knife cookbook create mysql_cookbook -o site-cookbooks\n\n\u958b\u767a\u95a2\u9023\u306e\u30c4\u30fc\u30eb\u306ecookbook\u306b\u3001git\u3084development tools\u306a\u3069\u306e\u30ec\u30b7\u30d4\u3092\u4f5c\u6210\u3059\u308b\u3002\n\nchef-php-env/site-cookbooks/develop_tools_cookbook/recipes/default.rb\npackages = %w(zsh git screen unzip fontconfig-devel)\npackages.each do |pkg|\n  package pkg do\n    action :install\n  end\nend\n\nexecute \"development_tools\" do\n  user \"root\"\n  command 'yum -y groupinstall \"Development Tools\"'\n  action :run\nend\n\n\nPHP7\u7528\u306e\u30ec\u30b7\u30d4\u3092\u4f5c\u6210\u3059\u308b\u3002\n\nchef-php-env/site-cookbooks/php7_cookbook/recipes/default.rb\n# epel\npackage 'epel-release.noarch' do\n  action :install\nend\n\n# remi\nremote_file \"#{Chef::Config[:file_cache_path]}/remi-release-7.rpm\" do\n    source \"http://rpms.famillecollet.com/enterprise/remi-release-7.rpm\"\n    not_if \"rpm -qa | grep -q '^remi-release'\"\n    action :create\n    notifies :install, \"rpm_package[remi-release]\", :immediately\nend\n\nrpm_package \"remi-release\" do\n    source \"#{Chef::Config[:file_cache_path]}/remi-release-7.rpm\"\n    action :nothing\nend\n\n# php7\npackage 'php' do\n  flush_cache [:before]\n  action :install\n  options \"--enablerepo=remi --enablerepo=remi-php70\"\nend\n\n%w(php-openssl php-common php-mbstring php-xml).each do |pkg|\n  package pkg do\n    action :install\n    options \"--enablerepo=remi --enablerepo=remi-php70\"\n  end\nend\n\n# composer\nbash 'install_composer' do\n  not_if { File.exists?(\"/usr/local/bin/composer\") }\n  user 'root'\n  cwd '/tmp'\n  code <<-EOH\n    curl -sS https://getcomposer.org/installer | php -- --install-dir=/tmp\n    mv /tmp/composer.phar /usr/local/bin/composer\n  EOH\nend\n\n\nApache\u7528\u306e\u30ec\u30b7\u30d4\u3092\u4f5c\u6210\u3059\u308b\u3002\n\nchef-php-env/site-cookbooks/apache_cookbook/recipes/default.rb\npackage 'httpd' do\n  action :install\nend\n\nbash 'service_setting' do\n  user 'root'\n  code <<-EOH\n    systemctl restart httpd.service\n    systemctl enable httpd.service\n  EOH\nend\n\n\nMySQL\u7528\u306e\u30ec\u30b7\u30d4\u3092\u4f5c\u6210\u3059\u308b\u3002\n\nchef-php-env/site-cookbooks/mysql_cookbook/recipes/default.rb\n# mysql rpm\nremote_file \"#{Chef::Config[:file_cache_path]}/mysql57-community-release-el7-7.noarch.rpm\" do\n  source \"http://dev.mysql.com/get/mysql57-community-release-el7-7.noarch.rpm\"\n  not_if \"rpm -qa | grep -q '^mysql57'\"\n  action :create\n  notifies :install, \"rpm_package[mysql57]\", :immediately\nend\n\nrpm_package \"mysql57\" do\n  source \"#{Chef::Config[:file_cache_path]}/mysql57-community-release-el7-7.noarch.rpm\"\n  action :nothing\nend\n\npackage 'mysql-community-server' do\n  action :install\nend\n\ncookbook_file \"/etc/my.cnf\" do\n  source \"my.cnf\"\n  mode 00644\n  owner 'root'\n  group 'root'\nend\n\nbash 'service_setting' do\n  user 'root'\n  code <<-EOH\n    systemctl restart mysqld.service\n    systemctl enable mysqld.service\n  EOH\nend\n\n\ncookbook_file\u306b\u8a2d\u5b9a\u3057\u3066my.cnf\u306f\u4ee5\u4e0b\u3002\u6700\u5f8c\u306e2\u884c\u3092\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u3082\u306e\u306b\u8ffd\u52a0\u3057\u3066\u3044\u308b\u3002\n\nutf8\u306b\u3059\u308b\u3002\npassword\u306e\u6709\u52b9\u671f\u9650\u3092\u7121\u671f\u9650\u306b\u3059\u308b\u3002\n\n\nchef-php-env/site-cookbooks/mysql_cookbook/files/default/my.cnf\n# For advice on how to change settings please see\n# http://dev.mysql.com/doc/refman/5.7/en/server-configuration-defaults.html\n\n[mysqld]\n#\n# Remove leading # and set to the amount of RAM for the most important data\n# cache in MySQL. Start at 70% of total RAM for dedicated server, else 10%.\n# innodb_buffer_pool_size = 128M\n#\n# Remove leading # to turn on a very important data integrity option: logging\n# changes to the binary log between backups.\n# log_bin\n#\n# Remove leading # to set options mainly useful for reporting servers.\n# The server defaults are faster for transactions and fast SELECTs.\n# Adjust sizes as needed, experiment to find the optimal values.\n# join_buffer_size = 128M\n# sort_buffer_size = 2M\n# read_rnd_buffer_size = 2M\ndatadir=/var/lib/mysql\nsocket=/var/lib/mysql/mysql.sock\n\n# Disabling symbolic-links is recommended to prevent assorted security risks\nsymbolic-links=0\n\nlog-error=/var/log/mysqld.log\npid-file=/var/run/mysqld/mysqld.pid\n\ncharacter-set-server = utf8\ndefault_password_lifetime = 0\n\n\n\nchef-php-env/chef.rb\ncurrent_dir = File.absolute_path( File.dirname(__FILE__) )\ncookbook_path [ \"#{current_dir}/site-cookbooks\" ]\nrole_path \"#{current_dir}/roles\"\n\n\n\nchef-php-env/nodes/chef.json\n{\n  \"run_list\": [\n    \"recipe[develop_tools_cookbook]\",\n    \"recipe[php7_cookbook]\",\n    \"recipe[apache_cookbook]\",\n    \"recipe[mysql_cookbook]\"\n  ]\n}\n\n\n\nchef\u306e\u5b9f\u884c\n$ rvmsudo_secure_path=1 rvmsudo chef-client --local-mode -j nodes/chef.json -c chef.rb\n\n\n\u53c2\u8003\u306b\u3055\u305b\u3066\u9802\u3044\u305f\u30b5\u30a4\u30c8\nhttp://qiita.com/Esfahan/items/8f47382e9e712253feee\nhttp://qiita.com/makoto_kw/items/53a84380559c087eb8fb\nhttp://tanakakns.hatenablog.com/entry/20140401/1396337863\n# \u69cb\u7bc9\u3057\u305f\u3044\u74b0\u5883\n\n* CentOS7\n* PHP7\n* Apache\n* MySQL5.7\n\n# \u5e8f\u8ad6\n\n\u4ed5\u4e8b\u3067PHP\u3092\u4f7f\u3046\u3053\u3068\u306b\u306a\u308a\u305d\u3046\u3060\u3063\u305f\u306e\u3067\u3001\u52c9\u5f37\u304c\u3066\u3089PHP\u306e\u52d5\u4f5c\u74b0\u5883\u3092\u69cb\u7bc9\u3057\u305f\u3002\n\u4eca\u5f8c\u3001\u983b\u7e41\u306b\u4f7f\u3046\u3053\u3068\u306b\u306a\u308b\u3068\u601d\u3046\u306e\u3067\u624b\u9806\u3092\u30e1\u30e2\u3057\u3066\u304a\u304f\u3002\n\n\u306a\u304a\u3001\u30db\u30b9\u30c8OS\u306f\u3001EI Capitan\u3067\u3042\u308a\u3001vagrant\u3001virtual box\u306f\u3001\u30db\u30b9\u30c8OS\u306b\u5c0e\u5165\u6e08\u3067\u3042\u308b\u3053\u3068\u3092\u524d\u63d0\u3068\u3057\u3066\u3044\u308b\u3002\n\nCentOS7\u4e0a\u3067\u306f\u3001chef-client\u306elocal mode\u3067chef\u3092\u5b9f\u884c\u3059\u308b\u3002\nchef\u3092\u5b9f\u884c\u3059\u308b\u305f\u3081\u306eruby\u306f\u3001rvm\u3067ruby 2.3\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n\n\u306a\u304a\u3001rvm\u3001ruby\u3001chef\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u53ca\u3073chef\u306e\u5b9f\u884c\u306f\u3001Vagrant\u306e\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u3067\u5b9f\u884c\u3057\u305f\u3002\n\u307e\u305f\u3001\u4eca\u56de\u4f7f\u7528\u3057\u305fchef\u306e\u30af\u30c3\u30af\u30d6\u30c3\u30af\u306f\u3001\u4e88\u3081GitHub\u306b\u767b\u9332\u3057\u3066\u304a\u304d\u3001clone\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u308b\u3002\nchef\u306e\u30af\u30c3\u30af\u30d6\u30c3\u30af\u306e\u4f5c\u6210\u624b\u9806\u306f\u3001\u672c\u8a18\u4e8b\u306e\u672b\u5c3e\u306b\u8a18\u8f09\u3057\u3066\u3044\u308b\u3002\n\n\u305d\u306e\u5f8c\u306eMySQL\u306e\u521d\u671f\u8a2d\u5b9a\u306f\u3001\u81ea\u52d5\u5316\u3067\u304d\u305d\u3046\u3082\u306a\u3044\u306e\u3067\u30b5\u30fc\u30d0\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u305f\u72b6\u614b\u3067\u5b9f\u65bd\u3057\u305f\u3002\n\n# \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n## vagrant\u3067centos7\u306e\u521d\u671f\u8a2d\u5b9a\u3092\u3059\u308b\u3002\n\n```\n% vagrant init centos/7\n```\n\n## \u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306e\u8a2d\u5b9a\u3068\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u306e\u8a2d\u5b9a\u3092\u3059\u308b\u3002\n\n\u5b9f\u884c\u3059\u308b\u30b3\u30de\u30f3\u30c9\u3092\u5358\u7d14\u306b\u7f85\u5217\u3057\u305f\u3060\u3051\u3060\u3068\u3001\u6240\u5b9a\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3(rvm\u3084ruby)\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5f8c\u306b\u3001\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u30d1\u30b9\u304c\u5373\u6709\u52b9\u306b\u306a\u3089\u305a\u306b\u30a8\u30e9\u30fc\u306b\u306a\u308b\u3002\n\u3053\u308c\u3092\u56de\u907f\u3059\u308b\u305f\u3081\u306b\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u5185\u3067xxx_install_script\u3068\u4f55\u500b\u304b\u306b\u5206\u5272\u3057\u3066\u3044\u308b\u3002\n\u3082\u3046\u5c11\u3057\u30b9\u30de\u30fc\u30c8\u306a\u56de\u907f\u7b56\u306f\u306a\u3044\u3082\u306e\u304b\u2026\u3002\n\n```\n% vi Vagrantfile\n# config.vm.network :private_network, ip: \"192.168.33.10\"\n    \u2191\u3053\u306e\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3092\u5916\u3059\u3002IP\u306f\u9069\u5f53\u306b\u3002\n\n<\u7701\u7565>\n\n  first_install_script = <<SCRIPT\n    # TimeZone : UTC -> JST\n    timedatectl set-timezone Asia/Tokyo\n\n    # install rvm, ruby2.3\n    gpg2 --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3\n    curl -L https://get.rvm.io | sudo bash -s stable\n    gpasswd -a vagrant rvm\nSCRIPT\n\n  second_install_script = <<SCRIPT\n    sudo -i -u vagrant rvm install 2.3 --default\nSCRIPT\n\n  third_install_script = <<SCRIPT\n    # gem install for chef\n    sudo -i -u vagrant gem install bundler\n    sudo -i -u vagrant gem install chef\n    sudo -i -u vagrant gem install knife-solo\nSCRIPT\n\n  fourth_install_script = <<SCRIPT\n    # install git for to download cookbook repository\n    yum -y update\n    yum -y install git\n\n    sudo -u vagrant git clone https://github.com/eidera/chef-php-env.git\n\n    # execute chef\n    cd /home/vagrant/chef-php-env && rvmsudo_secure_path=1 /usr/local/rvm/bin/rvmsudo chef-client --local-mode -j nodes/chef.json -c chef.rb\nSCRIPT\n\n  config.vm.provision :shell, :inline => first_install_script\n  config.vm.provision :shell, :inline => second_install_script\n  config.vm.provision :shell, :inline => third_install_script\n  config.vm.provision :shell, :inline => fourth_install_script\n```\n\n## \u4eee\u60f3\u30de\u30b7\u30f3\u3092\u7acb\u3061\u4e0a\u3052\u308b\u3002\n\n```\n% vagrant up\n```\n\n## \u901a\u5e38\u306essh\u30b3\u30de\u30f3\u30c9\u3067\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u3059\u308b\u3002\n\n```\n% vagrant ssh-config --host local.phpdev >> ~/.ssh/config\n% ssh local.phpdev\n```\n\n# MySQL\u306e\u8a2d\u5b9a\n\nroot\u306e\u521d\u671f\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u78ba\u8a8d\u3059\u308b\u3002\n\n```\n% sudo less /var/log/mysqld.log\ntemporary password\u3092\u691c\u7d22\u3057\u3066\u3001root\u306e\u521d\u671f\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u78ba\u8a8d\n```\n\nmysql\u306e\u521d\u671f\u8a2d\u5b9a(root\u30d1\u30b9\u30ef\u30fc\u30c9\u5909\u66f4\u306a\u3069)\n\n```\n% mysql_secure_installation\n\u6307\u793a\u901a\u308a\u5165\u529b\u3057\u3066\u3044\u304f\n```\n\n\u30e6\u30fc\u30b6\u30fc(username)\u3092\u8ffd\u52a0\u3059\u308b\u3002\n\u306a\u304a\u3001\u4e0b\u8a18\u3067\u306f\u3001\u5168\u3066\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u5bfe\u3057\u3066192.168.\u4ee5\u4e0b\u5168\u3066\u306eIP\u304b\u3089\u306e\u5916\u90e8\u63a5\u7d9a\u3092\u8a31\u53ef\u3057\u3066\u3044\u308b\u3002\n\u3053\u306e\u8fba\u308a\u306e\u8a2d\u5b9a\u306f\u74b0\u5883\u306b\u5fdc\u3058\u3066\u3001\u9069\u5b9c\u4fee\u6b63\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\n```\n% mysql -u root -p\n\u65b0\u898f\u30d1\u30b9\u30ef\u30fc\u30c9\u5165\u529b\nmysql> GRANT ALL PRIVILEGES ON *.* TO username@localhost IDENTIFIED BY 'passwd_hogehoge';\nmysql> GRANT ALL privileges ON *.* TO username@\"192.168.%.%\" IDENTIFIED BY 'passwd_hogehoge' WITH GRANT OPTION;\nmysql> flush privileges;\nmysql> select user,host from mysql.user;\n```\n\n\u306a\u304a\u3001\u30ed\u30fc\u30ab\u30eb\u306e\u958b\u767a\u74b0\u5883\u306a\u306e\u3067\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u7c21\u5358\u306b\u3057\u305f\u3044\u3068\u3044\u3046\u5834\u5408\u306b\u306f\u3001\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3059\u308c\u3070\u4f8b\u3048\u3070\u3001\u9577\u3055\u3084\u30dd\u30ea\u30b7\u30fc\u3092\u5909\u66f4\u3067\u304d\u308b\u3002\n\n```\nmysql> SET GLOBAL validate_password_length=4;\nmysql> SET GLOBAL validate_password_policy=LOW;\nmysql> SHOW VARIABLES LIKE 'validate_password%';\n  \u2192\u8a2d\u5b9a\u306e\u78ba\u8a8d\n```\n\n# Apache\u306e\u958b\u767a\u74b0\u5883\u7528\u521d\u671f\u8a2d\u5b9a\n\n\u30db\u30b9\u30c8OS\u5074\u3067\u4fee\u6b63\u3059\u308b\u305f\u3081\u306b\u3001DocumentRoot\u3092\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u306b\u5909\u66f4\u3059\u308b\u3002\n\u4f46\u3057\u3001SELinux\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\u3001\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u306fForbidden\u306b\u306a\u3063\u3066\u3057\u307e\u3046\u3002\n\u958b\u767a\u74b0\u5883\u306a\u306e\u3067SELinux\u3092\u7121\u52b9\u306b\u3057\u305f\u3002\n\n```\n% sudo mv /var/www/html /var/www/html.orig\n% cd /var/www && sudo ln -s /vagrant/html\n% sudo setenforce 0\n```\n\n\u306a\u304a\u3001\u30db\u30b9\u30c8\u5074\u3067\u30d5\u30a1\u30a4\u30eb\u3092\u5909\u66f4\u3059\u308b\u5ea6\u306brsync\u3067\u540c\u671f\u3059\u308b\u305f\u3081\u306b\u306f\u3001\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u3066\u304a\u304f\u3002\n\n```\n% vagrant rsync-auto\n```\n\n\u4ee5\u4e0a\u3067\u74b0\u5883\u69cb\u7bc9\u306f\u7d42\u4e86\u3002\n\n# chef\u306e\u30af\u30c3\u30af\u30d6\u30c3\u30af\u306e\u4f5c\u6210\u624b\u9806\n\n\u30af\u30c3\u30af\u30d6\u30c3\u30af\u306e\u4f5c\u6210\u624b\u9806\u3092\u5099\u5fd8\u9332\u3068\u3057\u3066\u6b8b\u3057\u3066\u304a\u304f\u3002\nphp\u3084Apache\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306a\u3069\u8ffd\u52a0\u3057\u3066\u3044\u3063\u305f\u3082\u306e\u306f\u3053\u3053\u306b\u8a18\u8f09\u3057\u3066\u3044\u306a\u3044\u306e\u3067\u3001GitHub\u306e[\u30ea\u30dd\u30b8\u30c8\u30ea](https://github.com/eidera/chef-php-env)\u3092\u76f4\u63a5\u78ba\u8a8d\u3057\u305f\u65b9\u304c\u3088\u3044\u3002\n\n```\n% cd\n% mkdir chef-php-env\n% cd chef-php-env\n% knife solo init .\n% knife cookbook create develop_tools_cookbook -o site-cookbooks\n% knife cookbook create php7_cookbook -o site-cookbooks\n% knife cookbook create apache_cookbook -o site-cookbooks\n% knife cookbook create mysql_cookbook -o site-cookbooks\n```\n\n\u958b\u767a\u95a2\u9023\u306e\u30c4\u30fc\u30eb\u306ecookbook\u306b\u3001git\u3084development tools\u306a\u3069\u306e\u30ec\u30b7\u30d4\u3092\u4f5c\u6210\u3059\u308b\u3002\n\n``` ruby:chef-php-env/site-cookbooks/develop_tools_cookbook/recipes/default.rb\npackages = %w(zsh git screen unzip fontconfig-devel)\npackages.each do |pkg|\n  package pkg do\n    action :install\n  end\nend\n\nexecute \"development_tools\" do\n  user \"root\"\n  command 'yum -y groupinstall \"Development Tools\"'\n  action :run\nend\n```\n\nPHP7\u7528\u306e\u30ec\u30b7\u30d4\u3092\u4f5c\u6210\u3059\u308b\u3002\n\n``` ruby:chef-php-env/site-cookbooks/php7_cookbook/recipes/default.rb\n# epel\npackage 'epel-release.noarch' do\n  action :install\nend\n\n# remi\nremote_file \"#{Chef::Config[:file_cache_path]}/remi-release-7.rpm\" do\n    source \"http://rpms.famillecollet.com/enterprise/remi-release-7.rpm\"\n    not_if \"rpm -qa | grep -q '^remi-release'\"\n    action :create\n    notifies :install, \"rpm_package[remi-release]\", :immediately\nend\n\nrpm_package \"remi-release\" do\n    source \"#{Chef::Config[:file_cache_path]}/remi-release-7.rpm\"\n    action :nothing\nend\n\n# php7\npackage 'php' do\n  flush_cache [:before]\n  action :install\n  options \"--enablerepo=remi --enablerepo=remi-php70\"\nend\n\n%w(php-openssl php-common php-mbstring php-xml).each do |pkg|\n  package pkg do\n    action :install\n    options \"--enablerepo=remi --enablerepo=remi-php70\"\n  end\nend\n\n# composer\nbash 'install_composer' do\n  not_if { File.exists?(\"/usr/local/bin/composer\") }\n  user 'root'\n  cwd '/tmp'\n  code <<-EOH\n    curl -sS https://getcomposer.org/installer | php -- --install-dir=/tmp\n    mv /tmp/composer.phar /usr/local/bin/composer\n  EOH\nend\n```\n\nApache\u7528\u306e\u30ec\u30b7\u30d4\u3092\u4f5c\u6210\u3059\u308b\u3002\n\n``` ruby:chef-php-env/site-cookbooks/apache_cookbook/recipes/default.rb\npackage 'httpd' do\n  action :install\nend\n\nbash 'service_setting' do\n  user 'root'\n  code <<-EOH\n    systemctl restart httpd.service\n    systemctl enable httpd.service\n  EOH\nend\n```\n\nMySQL\u7528\u306e\u30ec\u30b7\u30d4\u3092\u4f5c\u6210\u3059\u308b\u3002\n\n``` ruby:chef-php-env/site-cookbooks/mysql_cookbook/recipes/default.rb\n# mysql rpm\nremote_file \"#{Chef::Config[:file_cache_path]}/mysql57-community-release-el7-7.noarch.rpm\" do\n  source \"http://dev.mysql.com/get/mysql57-community-release-el7-7.noarch.rpm\"\n  not_if \"rpm -qa | grep -q '^mysql57'\"\n  action :create\n  notifies :install, \"rpm_package[mysql57]\", :immediately\nend\n\nrpm_package \"mysql57\" do\n  source \"#{Chef::Config[:file_cache_path]}/mysql57-community-release-el7-7.noarch.rpm\"\n  action :nothing\nend\n\npackage 'mysql-community-server' do\n  action :install\nend\n\ncookbook_file \"/etc/my.cnf\" do\n  source \"my.cnf\"\n  mode 00644\n  owner 'root'\n  group 'root'\nend\n\nbash 'service_setting' do\n  user 'root'\n  code <<-EOH\n    systemctl restart mysqld.service\n    systemctl enable mysqld.service\n  EOH\nend\n```\n\ncookbook_file\u306b\u8a2d\u5b9a\u3057\u3066my.cnf\u306f\u4ee5\u4e0b\u3002\u6700\u5f8c\u306e2\u884c\u3092\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u3082\u306e\u306b\u8ffd\u52a0\u3057\u3066\u3044\u308b\u3002\n\n* utf8\u306b\u3059\u308b\u3002\n* password\u306e\u6709\u52b9\u671f\u9650\u3092\u7121\u671f\u9650\u306b\u3059\u308b\u3002\n\n``` :chef-php-env/site-cookbooks/mysql_cookbook/files/default/my.cnf\n# For advice on how to change settings please see\n# http://dev.mysql.com/doc/refman/5.7/en/server-configuration-defaults.html\n\n[mysqld]\n#\n# Remove leading # and set to the amount of RAM for the most important data\n# cache in MySQL. Start at 70% of total RAM for dedicated server, else 10%.\n# innodb_buffer_pool_size = 128M\n#\n# Remove leading # to turn on a very important data integrity option: logging\n# changes to the binary log between backups.\n# log_bin\n#\n# Remove leading # to set options mainly useful for reporting servers.\n# The server defaults are faster for transactions and fast SELECTs.\n# Adjust sizes as needed, experiment to find the optimal values.\n# join_buffer_size = 128M\n# sort_buffer_size = 2M\n# read_rnd_buffer_size = 2M\ndatadir=/var/lib/mysql\nsocket=/var/lib/mysql/mysql.sock\n\n# Disabling symbolic-links is recommended to prevent assorted security risks\nsymbolic-links=0\n\nlog-error=/var/log/mysqld.log\npid-file=/var/run/mysqld/mysqld.pid\n\ncharacter-set-server = utf8\ndefault_password_lifetime = 0\n```\n\n``` ruby:chef-php-env/chef.rb\ncurrent_dir = File.absolute_path( File.dirname(__FILE__) )\ncookbook_path [ \"#{current_dir}/site-cookbooks\" ]\nrole_path \"#{current_dir}/roles\"\n```\n\n``` json:chef-php-env/nodes/chef.json\n{\n  \"run_list\": [\n    \"recipe[develop_tools_cookbook]\",\n    \"recipe[php7_cookbook]\",\n    \"recipe[apache_cookbook]\",\n    \"recipe[mysql_cookbook]\"\n  ]\n}\n```\n\n### chef\u306e\u5b9f\u884c\n\n```\n$ rvmsudo_secure_path=1 rvmsudo chef-client --local-mode -j nodes/chef.json -c chef.rb\n```\n\n# \u53c2\u8003\u306b\u3055\u305b\u3066\u9802\u3044\u305f\u30b5\u30a4\u30c8\n\nhttp://qiita.com/Esfahan/items/8f47382e9e712253feee\nhttp://qiita.com/makoto_kw/items/53a84380559c087eb8fb\nhttp://tanakakns.hatenablog.com/entry/20140401/1396337863\n", "tags": ["vagrant", "chef", "PHP7", "centos7"]}