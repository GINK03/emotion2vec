{"context": " More than 1 year has passed since last update.\n\n\u8a18\u4e8b\u6295\u7a3f\u306e\u52d5\u6a5f\nWeb\u30b5\u30fc\u30d3\u30b9\uff08\u4eba\u9593\u5411\u3051\u306e\u30a4\u30f3\u30bf\u30d5\u30a7\u30fc\u30b9\u3092\u7528\u610f\uff09\u3092\u4f5c\u308b\u3068\u304d\u3001\u672c\u4eba\u3092\u7279\u5b9a\u3059\u308b\u305f\u3081\u306e\u8a8d\u8a3c\u304c\u5fc5\u8981\u306b\u306a\u308b\u3002yesod\u3067\u3053\u308c\u3092\u5b9f\u73fe\u3059\u308b\u306e\u306f\u3068\u3066\u3082\u7c21\u5358\u3067\u3001\u516c\u5f0f\u30ac\u30a4\u30c9\u306eAuthentication and Authorization\u3092\u8aad\u307f\u9032\u3081\u308c\u3070\u3001\u7b2c\u4e09\u8005\u8a8d\u8a3c(browzerid\u306a\u3069)\u306e\u4ed5\u7d44\u307f\u3092\u4f5c\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\u4e00\u65b9\u3001\u8a8d\u8a3c\u5f8c\u306e\u30e6\u30fc\u30b6\u304c\u5229\u7528\u3059\u308b\u3053\u3068\u306b\u306a\u308b\u6a5f\u80fd\u3092\u30d7\u30ed\u30b0\u30e9\u30e0\u306b\u5229\u7528\u3055\u305b\u305f\u304f\u306a\u308b\u30b1\u30fc\u30b9\u304c\u3042\u308b\u3002\u3053\u306e\u30a4\u30f3\u30bf\u30d5\u30a7\u30fc\u30b9\u304cWebAPI\u306a\u306e\u3060\u304c\u3001\u30ac\u30a4\u30c9\u306b\u66f8\u3044\u3066\u3042\u308b\u5185\u5bb9\u306e\u307e\u307e\u3067\u306f\u4f7f\u3048\u306a\u3044\u3002\u30d7\u30ed\u30b0\u30e9\u30e0\u304b\u3089\u306f\u7b2c\u4e09\u8005\u8a8d\u8a3c\u3092\u884c\u3046\u3053\u3068\u304c\u96e3\u3057\u3044\uff08\u3067\u304d\u306a\u3044\uff1f\uff09\u304b\u3089\u3060\u3002\n\u305d\u3053\u3067\u3001\u3042\u308b\u6a5f\u80fd\u3092\u4eba\u9593\u3001\u30d7\u30ed\u30b0\u30e9\u30e0\u306e\u3069\u3061\u3089\u304b\u3089\u3082\u5229\u7528\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u305f\u3081\u306b\u5de5\u592b\u3057\u305f\u3053\u3068\u3092\u66f8\u3044\u3066\u304a\u304f\u3002\n\u203b\u8a18\u4e8b\u306e\u5185\u5bb9\u306f\u3001\u30ac\u30a4\u30c9\u306e\u5185\u5bb9\u304a\u3088\u3073yesod\u306e\u8a8d\u8a3c\u3001\u8a8d\u53ef\u306e\u4ed5\u7d44\u307f\u3092\u5c11\u3005\u77e5\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u524d\u63d0\u3068\u3057\u3066\u3044\u307e\u3059\u3002\n\u203b\u8a18\u4e8b\u3092\u66f8\u3044\u3066\u3044\u308b\u6700\u4e2d\u306b\u3001\u3088\u308a\u826f\u3044\u65b9\u6cd5\u3092\u898b\u3064\u3051\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u3002\u300c\u5de5\u592b\u3057\u305f\u3053\u3068\u30fb\u65b0\u300d\u3068\u3044\u3046\u6587\u7ae0\u304c\u305d\u308c\u306b\u3042\u305f\u308a\u307e\u3059\u3002\n\n\u5de5\u592b\u3057\u305f\u3053\u3068\u30fb\u65b0\nhaddocks\u3092\u78ba\u8a8d\u3059\u308b\u3068\u3001maybeAuthId\u306b\u3064\u3044\u3066\u6b21\u306e\u3088\u3046\u306b\u8a18\u8f09\u3055\u308c\u3066\u3044\u308b\u3002\n\nRetrieves user credentials, if user is authenticated.\nBy default, this calls defaultMaybeAuthId to get the user ID from the session. This can be overridden to allow authentication via other means, such as checking for a special token in a request header. This is especially useful for creating an API to be accessed via some means other than a browser.\n\n\u901a\u5e38\u3053\u306e\u95a2\u6570\u306f\uff08\u7b2c\u4e09\u8005\u8a8d\u8a3c\u306a\u3069\u3067\uff09\u4fdd\u6301\u3057\u3066\u3044\u308b\u30bb\u30c3\u30b7\u30e7\u30f3\u304b\u3089ID\u3092\u53d6\u5f97\u3059\u308b\u304c\u3001\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3059\u308b\u3053\u3068\u3067\u30ea\u30af\u30a8\u30b9\u30c8\u30d8\u30c3\u30c0\u306b\u542b\u307e\u308c\u308b\u30c8\u30fc\u30af\u30f3\u3092\u30c1\u30a7\u30c3\u30af\u3059\u308b\u306a\u3069\u3057\u3066\u3001WebAPI\u3068\u3057\u3066\u306e\u5229\u7528\u3082\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308b\u3001\u3068\u3044\u3046\u3053\u3068\u3060\u3002\n\u3068\u3044\u3046\u3053\u3068\u3067\u3001\u5de5\u592b\u70b9\u306fmaybeAuthId\u3092\u30aa\u30fc\u30d0\u30e9\u30a4\u30c9\u3059\u308b\u3053\u3068\u3067\u3042\u308a\u3001\u3053\u306e\u3088\u3046\u306b\u5b9a\u7fa9\u3057\u305f\u3002\u4eca\u56de\u306f\u30c8\u30fc\u30af\u30f3\u306f\u3001\u30af\u30a8\u30ea\u30d1\u30e9\u30e1\u30fc\u30bf\u304b\u3089\u53d7\u3051\u53d6\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u308b\u3002\u306a\u304a\u3001\u30c8\u30fc\u30af\u30f3\u306e\u751f\u6210\u65b9\u5f0f\u306b\u3064\u3044\u3066\u306f\u4eca\u56de\u306f\u5272\u611b\u3057\u3066\u3044\u308b\u3002\n\ninstance YesodAuth \u5185\ninstance YesodAuth App where\n    type AuthId App = UserId\n\n    -- Where to send a user after successful login\n    loginDest _ = RootR\n    -- Where to send a user after logout\n    logoutDest _ = RootR\n    -- Override the above two destinations when a Referer: header is present\n    redirectToReferer _ = True\n\n\u3053\u3053\u3092\u8ffd\u52a0\n    maybeAuthId = do\n        muid <- userIdFromToken\n        case muid of\n            Nothing -> defaultMaybeAuthId\n            _       -> return muid\n\u3053\u3053\u307e\u3067\n\n    getAuthId creds = do\n        Entity uid _ <- runDB $ getBy404 $ UniqueUser $ credsIdent creds\n        return $ Just uid\n\n    -- You can add other plugins like BrowserID, email or OAuth here\n    authPlugins _ = [authBrowserId def]\n\n    authHttpManager = getHttpManager\n\n\u30c8\u30c3\u30d7\u30ec\u30d9\u30eb\u3067\u5b9a\u7fa9\n-- \u30af\u30a8\u30ea\u30d1\u30e9\u30e1\u30fc\u30bf\u304b\u3089\u30c8\u30fc\u30af\u30f3\u3092\u53d7\u3051\u53d6\u308a\u3001\u5bfe\u5fdc\u3059\u308b\u30e6\u30fc\u30b6ID\u3092\u8fd4\u3059\u3002\u5931\u6557\u3059\u308b\u3053\u3068\u3082\u3042\u308b\u3002\nuserIdFromToken :: Handler (Maybe (Key User))\nuserIdFromToken = do\n    mtoken <- lookupGetParam \"token\"\n    case mtoken of\n        Nothing -> return Nothing\n        _ -> do\n            mu <- runDB $ selectFirst [UserPassword ==.  mtoken] []\n            case mu of\n                Just (Entity uid _) -> return $ Just uid\n                _ -> return Nothing\n\n\n\u3042\u3068\u306f\u3001\u500b\u5225\u306e\u30ea\u30bd\u30fc\u30b9\u306b\u5bfe\u3059\u308b\u8a8d\u8a3c\u30fb\u8a8d\u53ef\u306e\u5b9a\u7fa9\u3092\u3059\u308b\u3053\u3068\u306b\u306a\u308b\u3002\n\ninstance Yesod \u5185\nYesod\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u5ba3\u8a00\u5185\u3067\u3001\u8a8d\u8a3c\u30fb\u8a8d\u53ef\u306e\u5236\u5fa1\u3092\u884c\u3046\u3002\u521d\u671f\u72b6\u614b\u306f\u5168\u3066\u306e\u30a2\u30af\u30bb\u30b9\u3092\u8a8d\u53ef\u3059\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n    -- Default to Authorized for now.\n    isAuthorized _ _ = return Authorized\n\n\u30d1\u30bf\u30fc\u30f3\u30de\u30c3\u30c1\u3092\u4f7f\u3063\u3066\u3001\u3053\u306e\u5b9a\u7fa9\u3088\u308a\u3082\u524d\u306b\u500b\u5225\u306e\u30ea\u30bd\u30fc\u30b9\u306b\u5bfe\u3057\u3066\u5236\u5fa1\u3092\u8a18\u8ff0\u3057\u3066\u3044\u304f\u3053\u3068\u306b\u306a\u308b\u3002\u3053\u3053\u3067\u7279\u306bWeb\u30b5\u30fc\u30d3\u30b9\u306a\u306e\u304b\u3001WebAPI\u306a\u306e\u304b\u3092\u610f\u8b58\u3059\u308b\u3053\u3068\u306f\u306a\u3044\u3002\n\u500b\u5225\u306e\u30ea\u30bd\u30fc\u30b9\u306b\u5bfe\u3059\u308b\u8a8d\u8a3c\u30fb\u8a8d\u53ef\u5b9a\u7fa9\u3092\u7d42\u3048\u305f\u3089\u3001\u7d9a\u3051\u3066\u6b21\u306e\u3088\u3046\u306b\u66f8\u3044\u3066\u304a\u304f\u3068\u826f\u3044\u3060\u308d\u3046\u3002\n    -- Write \u30e1\u30bd\u30c3\u30c9\u306f\u3001\u57fa\u672c\u7684\u306b\u8a8d\u8a3c\u304c\u5fc5\u8981\n    isAuthorized _ True = do\n        mauth <- maybeAuth\n        case mauth of\n            Nothing -> return AuthenticationRequired\n            Just _ -> return Authorized\n    -- \u500b\u5225\u306b\u5b9a\u7fa9\u3057\u306a\u3044\u30ea\u30bd\u30fc\u30b9\u306f\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\n    isAuthorized _ _ = return Authorized --\u521d\u671f\u72b6\u614b\n\n\n\u5de5\u592b\u3057\u305f\u3053\u3068\u30fb\u65e7\uff08\u8aad\u307e\u306a\u304f\u3066OK)\n\u203b\u3053\u3061\u3089\u306e\u5185\u5bb9\u306f\u3001\u300c\u5de5\u592b\u3057\u305f\u3053\u3068\u30fb\u65b0\u300d\u306e\u5185\u5bb9\u3067\u3059\u3079\u3066\u7f6e\u304d\u63db\u3048\u307e\u3059\u3002\u79c1\u304c\u6700\u7d42\u7684\u306a\u65b9\u91dd\u3092\u898b\u3064\u3051\u51fa\u3059\u307e\u3067\u306e\u8ecc\u8de1\u3068\u3057\u3066\u30e1\u30e2\u3057\u3066\u3044\u307e\u3059\u3002\n\nFoundation.hs\n\u666e\u901a\u306b\u3001site\u578b\u306b\u3001YesodAuth\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u4e0e\u3048\u308b\u3002\nnstance YesodAuth App where\n    type AuthId App = UserId --use ID of USER table as AuthID\n\n    -- Where to send a user after successful login\n    loginDest _ = RootR\n    -- Where to send a user after logout\n    logoutDest _ = RootR\n    -- Override the above two destinations when a Referer: header is present\n    redirectToReferer _ = True\n\n    -- retrieve user id for AuthID by taking credential\n    getAuthId creds = do\n        Entity uid _ <- runDB $ getBy404 $ UniqueUser $ credsIdent creds\n        return $ Just uid\n\n    -- use BrowserId plugin\n    authPlugins _ = [authBrowserId def]\n\nYesod\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u5ba3\u8a00\u5185\u3067\u3001\u8a8d\u8a3c\u30fb\u8a8d\u53ef\u306e\u5236\u5fa1\u3092\u884c\u3046\u3002\u521d\u671f\u72b6\u614b\u306f\u5168\u3066\u306e\u30a2\u30af\u30bb\u30b9\u3092\u8a8d\u53ef\u3059\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n    -- Default to Authorized for now.\n    isAuthorized _ _ = return Authorized\n\n\u30d1\u30bf\u30fc\u30f3\u30de\u30c3\u30c1\u3092\u4f7f\u3063\u3066\u3001\u3053\u306e\u5b9a\u7fa9\u3088\u308a\u3082\u524d\u306b\u500b\u5225\u306e\u30ea\u30bd\u30fc\u30b9\u306b\u5bfe\u3057\u3066\u5236\u5fa1\u3092\u8a18\u8ff0\u3057\u3066\u3044\u304f\u3053\u3068\u306b\u306a\u308b\u3002\u3053\u3053\u3067\u306e\u5de5\u592b\u70b9\u306f\u3001\u8a8d\u8a3c\u306b\u5931\u6557\u3057\u305f\u5834\u5408\u306e\u5236\u5fa1\u3067\u3042\u308b\u3002\u8a8d\u8a3c\u306b\u5931\u6557\u3057\u305f\u5834\u5408\u306b\u5fc5\u305a\u30ed\u30b0\u30a4\u30f3\u30da\u30fc\u30b8\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u305b\u308b\u3088\u3046\u306a\u5236\u5fa1\u3060\u3068\u3001\u30d7\u30ed\u30b0\u30e9\u30e0\u304b\u3089\u5229\u7528\u3067\u304d\u306a\u3044\u3002\n\nisAuthorized\u306e\u4f8b\ninstance Yesod App where\n    isAuthorized RequestsR _ = do\n        mauth <- maybeAuth\n        case mauth of\n            Nothing ->return AuthenticationRequired\n            Just (Entity uid u)\n                | isAdmin u -> return Authorized -- \u7ba1\u7406\u8005\u6a29\u9650\u304c\u3042\u308c\u3070\u8a8d\u53ef\n                | otherwise -> return $ Unauthorized (\"\u3053\u306e\u30da\u30fc\u30b8\u306f\u8868\u793a\u3067\u304d\u307e\u305b\u3093\" :: Text)\n\nisAdmin :: User -> Bool\nisAdmin = userAdmin\n\n\n\u305d\u3053\u3067\u3001\u6b21\u306e\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u306e\u3088\u3046\u306b\u3001\u51e6\u7406\u3092\u5206\u5c90\u3055\u305b\u308b\u3002\n\nisAuthorized\u306e\u4f8b'\ninstance Yesod App where\n    isAuthorized RequestsR _ = do\n        mauth <- maybeAuth\n        case mauth of\n            Nothing -> do\n-- \u5909\u66f4\u70b9 from\n                -- WebAPI\u304b\u3089\u306e\u30a2\u30af\u30bb\u30b9\u306f\u3001token \u3092\u53d7\u3051\u53d6\u308b\n                muid <- userIdFromToken\n                case muid of\n                    Just x -> return Authorized\n                    _      -> return AuthenticationRequired\n-- \u5909\u66f4\u70b9 to\n            Just (Entity uid u)\n                | isAdmin u -> return Authorized\n                | otherwise -> return $ Unauthorized (\"\u3053\u306e\u30da\u30fc\u30b8\u306f\u8868\u793a\u3067\u304d\u307e\u305b\u3093\" :: Text)\n\nisAdmin :: User -> Bool\nisAdmin = userAdmin\n\n-- \u30af\u30a8\u30ea\u30d1\u30e9\u30e1\u30fc\u30bf\u304b\u3089\u30c8\u30fc\u30af\u30f3\u3092\u53d7\u3051\u53d6\u308a\u3001\u5bfe\u5fdc\u3059\u308b\u30e6\u30fc\u30b6ID\u3092\u8fd4\u3059\u3002\u5931\u6557\u3059\u308b\u3053\u3068\u3082\u3042\u308b\u3002\nuserIdFromToken :: Handler (Maybe (Key User))\nuserIdFromToken = do\n    mtoken <- lookupGetParam \"token\"\n    case mtoken of\n        Nothing -> return Nothing\n        _ -> do\n            mu <- runDB $ selectFirst [UserPassword ==.  mtoken] []\n            case mu of\n                Just (Entity uid _) -> return $ Just uid\n                _ -> return Nothing\n\n\n\n\u3053\u3046\u3059\u308b\u3053\u3068\u3067\u3001\u8a8d\u8a3c\u3092\u56de\u907f\u3057\u3001\u304b\u3064\u5236\u9650\u3055\u308c\u305f\u30e6\u30fc\u30b6\u306e\u307f\u306b\u30ea\u30bd\u30fc\u30b9\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3053\u3068\u3092\u8a31\u53ef\u3067\u304d\u308b\u3002\n\u307e\u305f\u3001\u500b\u5225\u306e\u30ea\u30bd\u30fc\u30b9\u306b\u5bfe\u3059\u308b\u8a8d\u8a3c\u30fb\u8a8d\u53ef\u5b9a\u7fa9\u3092\u7d42\u3048\u305f\u3089\u3001\u7d9a\u3051\u3066\u6b21\u306e\u3088\u3046\u306b\u66f8\u3044\u3066\u304a\u304f\u3068\u826f\u3044\u3060\u308d\u3046\u3002\n    -- Write \u30e1\u30bd\u30c3\u30c9\u306f\u3001\u57fa\u672c\u7684\u306b\u8a8d\u8a3c\u304c\u5fc5\u8981\n    isAuthorized _ True = do\n        mauth <- maybeAuth\n        case mauth of\n            Nothing -> return AuthenticationRequired\n            Just _ -> return Authorized\n    -- \u500b\u5225\u306b\u5b9a\u7fa9\u3057\u306a\u3044\u30ea\u30bd\u30fc\u30b9\u306f\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\n    isAuthorized _ _ = return Authorized\n\n\n\u30cf\u30f3\u30c9\u30e9\n\u30cf\u30f3\u30c9\u30e9\u5185\u3067\u306f\u3001\u5fc5\u8981\u306a\u6642\u306b\u8a8d\u8a3cID\u3092\u53d6\u308a\u51fa\u3059\u3053\u3068\u304c\u3067\u304d\u308b\u3002\u53d6\u5f97\u65b9\u6cd5\u306f\u5927\u304d\u304f\uff12\u3064\u3042\u308b\uff08\u5b9f\u969b\u306f\uff14\u3064\u3060\u304c\u3001\u7c21\u5358\u306e\u305f\u3081\uff09\u3002\nmaybeAuthId :: HandlerT master IO (Maybe (AuthId master))\nrequireAuthId :: YesodAuth master => HandlerT master IO (AuthId master)\n\n\u53d6\u5f97\u3059\u308b\u60c5\u5831\u304c\u3001Maybe\u578b\u3067\u5305\u307e\u308c\u3066\u3044\u308b\u304b\u3044\u306a\u3044\u304b\u3068\u3044\u3046\u70b9\u3068\u3001requireAuth\u306f\u3082\u3057\u8a8d\u8a3cID\u3092\u53d6\u308a\u51fa\u305b\u306a\u3051\u308c\u3070\u30ed\u30b0\u30a4\u30f3\u753b\u9762\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u305b\u308b\u3001\u3068\u3044\u3046\u70b9\u304c\u3001\uff12\u3064\u306e\u51e6\u7406\u306e\u9055\u3044\u3067\u3042\u308b\u3002\n\u79c1\u306f\u30b3\u30fc\u30c9\u3092\u7c21\u6f54\u306b\u3059\u308b\u3053\u3068\u3092\u4e3b\u76ee\u7684\u3068\u3057\u3066\u3001\u8a8d\u8a3cID\u3092\u751f\u3067\u53d6\u308a\u51fa\u305b\u308b\u3088\u3046\u306b\u3001\u6b21\u306e\u3088\u3046\u306b\u66f8\u3044\u3066\u3044\u305f\u3002\n\n\u6700\u521d\u306b\u66f8\u3044\u305f\u30b3\u30fc\u30c9\ngetRootR :: Handler Html\ngetRootR = do\n    uid <- requireAuth\n\n...\n\n\n\u3057\u304b\u3057\u3001 \u3053\u308c\u3067\u306f\u3084\u306f\u308a\u3001\u8a8d\u8a3c\u306b\u5931\u6557\u3059\u308b\u3068\u30ed\u30b0\u30a4\u30f3\u30da\u30fc\u30b8\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u308c\u3066\u3057\u307e\u3046\u305f\u3081\u3001\u30d7\u30ed\u30b0\u30e9\u30e0\u304b\u3089\u5229\u7528\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u306a\u3044\u3002\u3057\u305f\u304c\u3063\u3066\u3001\u30cf\u30f3\u30c9\u30e9\u5185\u3067requireAuth\u3092\u4f7f\u3046\u306e\u306f\u3001WebAPI\u306e\u89b3\u70b9\u304b\u3089\u306f\u3088\u308d\u3057\u304f\u306a\u3044\u3060\u308d\u3046\u3002\u3053\u308c\u304c\u5de5\u592b\u70b9\u3068\u306a\u308b\u3002\n\n\u5de5\u592b\u5f8c\u306e\u30b3\u30fc\u30c9\ngetRootR :: Handler Html\ngetRootR = do\n    Just (Entity uid _) <- maybeAuth -- \u8a8d\u8a3cID\u3092\u53d6\u5f97\u3067\u304d\u306a\u304f\u3066\u3082\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3057\u306a\u3044\n\n...\n\n\n## \u8a18\u4e8b\u6295\u7a3f\u306e\u52d5\u6a5f\nWeb\u30b5\u30fc\u30d3\u30b9\uff08\u4eba\u9593\u5411\u3051\u306e\u30a4\u30f3\u30bf\u30d5\u30a7\u30fc\u30b9\u3092\u7528\u610f\uff09\u3092\u4f5c\u308b\u3068\u304d\u3001\u672c\u4eba\u3092\u7279\u5b9a\u3059\u308b\u305f\u3081\u306e\u8a8d\u8a3c\u304c\u5fc5\u8981\u306b\u306a\u308b\u3002yesod\u3067\u3053\u308c\u3092\u5b9f\u73fe\u3059\u308b\u306e\u306f\u3068\u3066\u3082\u7c21\u5358\u3067\u3001\u516c\u5f0f\u30ac\u30a4\u30c9\u306e[Authentication and Authorization](http://www.yesodweb.com/book/authentication-and-authorization)\u3092\u8aad\u307f\u9032\u3081\u308c\u3070\u3001[\u7b2c\u4e09\u8005\u8a8d\u8a3c(browzerid\u306a\u3069)](http://www.mozilla.jp/persona/)\u306e\u4ed5\u7d44\u307f\u3092\u4f5c\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\u4e00\u65b9\u3001\u8a8d\u8a3c\u5f8c\u306e\u30e6\u30fc\u30b6\u304c\u5229\u7528\u3059\u308b\u3053\u3068\u306b\u306a\u308b\u6a5f\u80fd\u3092\u30d7\u30ed\u30b0\u30e9\u30e0\u306b\u5229\u7528\u3055\u305b\u305f\u304f\u306a\u308b\u30b1\u30fc\u30b9\u304c\u3042\u308b\u3002\u3053\u306e\u30a4\u30f3\u30bf\u30d5\u30a7\u30fc\u30b9\u304cWebAPI\u306a\u306e\u3060\u304c\u3001\u30ac\u30a4\u30c9\u306b\u66f8\u3044\u3066\u3042\u308b\u5185\u5bb9\u306e\u307e\u307e\u3067\u306f\u4f7f\u3048\u306a\u3044\u3002\u30d7\u30ed\u30b0\u30e9\u30e0\u304b\u3089\u306f\u7b2c\u4e09\u8005\u8a8d\u8a3c\u3092\u884c\u3046\u3053\u3068\u304c\u96e3\u3057\u3044\uff08\u3067\u304d\u306a\u3044\uff1f\uff09\u304b\u3089\u3060\u3002\n\n\u305d\u3053\u3067\u3001\u3042\u308b\u6a5f\u80fd\u3092\u4eba\u9593\u3001\u30d7\u30ed\u30b0\u30e9\u30e0\u306e\u3069\u3061\u3089\u304b\u3089\u3082\u5229\u7528\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u305f\u3081\u306b\u5de5\u592b\u3057\u305f\u3053\u3068\u3092\u66f8\u3044\u3066\u304a\u304f\u3002\n\n\u203b\u8a18\u4e8b\u306e\u5185\u5bb9\u306f\u3001\u30ac\u30a4\u30c9\u306e\u5185\u5bb9\u304a\u3088\u3073yesod\u306e\u8a8d\u8a3c\u3001\u8a8d\u53ef\u306e\u4ed5\u7d44\u307f\u3092\u5c11\u3005\u77e5\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u524d\u63d0\u3068\u3057\u3066\u3044\u307e\u3059\u3002\n\u203b\u8a18\u4e8b\u3092\u66f8\u3044\u3066\u3044\u308b\u6700\u4e2d\u306b\u3001\u3088\u308a\u826f\u3044\u65b9\u6cd5\u3092\u898b\u3064\u3051\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u3002\u300c\u5de5\u592b\u3057\u305f\u3053\u3068\u30fb\u65b0\u300d\u3068\u3044\u3046\u6587\u7ae0\u304c\u305d\u308c\u306b\u3042\u305f\u308a\u307e\u3059\u3002\n\n## \u5de5\u592b\u3057\u305f\u3053\u3068\u30fb\u65b0\n[haddocks](http://haddocks.fpcomplete.com/fp/7.8/20140916-162/yesod-auth/Yesod-Auth.html#v:maybeAuthId)\u3092\u78ba\u8a8d\u3059\u308b\u3068\u3001`maybeAuthId`\u306b\u3064\u3044\u3066\u6b21\u306e\u3088\u3046\u306b\u8a18\u8f09\u3055\u308c\u3066\u3044\u308b\u3002\n\n> Retrieves user credentials, if user is authenticated.\nBy default, this calls defaultMaybeAuthId to get the user ID from the session. This can be overridden to allow authentication via other means, such as checking for a special token in a request header. This is especially useful for creating an API to be accessed via some means other than a browser.\n\n\u901a\u5e38\u3053\u306e\u95a2\u6570\u306f\uff08\u7b2c\u4e09\u8005\u8a8d\u8a3c\u306a\u3069\u3067\uff09\u4fdd\u6301\u3057\u3066\u3044\u308b\u30bb\u30c3\u30b7\u30e7\u30f3\u304b\u3089ID\u3092\u53d6\u5f97\u3059\u308b\u304c\u3001\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3059\u308b\u3053\u3068\u3067\u30ea\u30af\u30a8\u30b9\u30c8\u30d8\u30c3\u30c0\u306b\u542b\u307e\u308c\u308b\u30c8\u30fc\u30af\u30f3\u3092\u30c1\u30a7\u30c3\u30af\u3059\u308b\u306a\u3069\u3057\u3066\u3001WebAPI\u3068\u3057\u3066\u306e\u5229\u7528\u3082\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308b\u3001\u3068\u3044\u3046\u3053\u3068\u3060\u3002\n\n\u3068\u3044\u3046\u3053\u3068\u3067\u3001\u5de5\u592b\u70b9\u306f**`maybeAuthId`\u3092\u30aa\u30fc\u30d0\u30e9\u30a4\u30c9\u3059\u308b\u3053\u3068**\u3067\u3042\u308a\u3001\u3053\u306e\u3088\u3046\u306b\u5b9a\u7fa9\u3057\u305f\u3002\u4eca\u56de\u306f\u30c8\u30fc\u30af\u30f3\u306f\u3001\u30af\u30a8\u30ea\u30d1\u30e9\u30e1\u30fc\u30bf\u304b\u3089\u53d7\u3051\u53d6\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u308b\u3002\u306a\u304a\u3001\u30c8\u30fc\u30af\u30f3\u306e\u751f\u6210\u65b9\u5f0f\u306b\u3064\u3044\u3066\u306f\u4eca\u56de\u306f\u5272\u611b\u3057\u3066\u3044\u308b\u3002\n\n### instance YesodAuth \u5185\n```hs\ninstance YesodAuth App where\n    type AuthId App = UserId\n\n    -- Where to send a user after successful login\n    loginDest _ = RootR\n    -- Where to send a user after logout\n    logoutDest _ = RootR\n    -- Override the above two destinations when a Referer: header is present\n    redirectToReferer _ = True\n\n\u3053\u3053\u3092\u8ffd\u52a0\n    maybeAuthId = do\n        muid <- userIdFromToken\n        case muid of\n            Nothing -> defaultMaybeAuthId\n            _       -> return muid\n\u3053\u3053\u307e\u3067\n\n    getAuthId creds = do\n        Entity uid _ <- runDB $ getBy404 $ UniqueUser $ credsIdent creds\n        return $ Just uid\n\n    -- You can add other plugins like BrowserID, email or OAuth here\n    authPlugins _ = [authBrowserId def]\n\n    authHttpManager = getHttpManager\n\n\u30c8\u30c3\u30d7\u30ec\u30d9\u30eb\u3067\u5b9a\u7fa9\n-- \u30af\u30a8\u30ea\u30d1\u30e9\u30e1\u30fc\u30bf\u304b\u3089\u30c8\u30fc\u30af\u30f3\u3092\u53d7\u3051\u53d6\u308a\u3001\u5bfe\u5fdc\u3059\u308b\u30e6\u30fc\u30b6ID\u3092\u8fd4\u3059\u3002\u5931\u6557\u3059\u308b\u3053\u3068\u3082\u3042\u308b\u3002\nuserIdFromToken :: Handler (Maybe (Key User))\nuserIdFromToken = do\n    mtoken <- lookupGetParam \"token\"\n    case mtoken of\n        Nothing -> return Nothing\n        _ -> do\n            mu <- runDB $ selectFirst [UserPassword ==.  mtoken] []\n            case mu of\n                Just (Entity uid _) -> return $ Just uid\n                _ -> return Nothing\n    \n```\n\n\u3042\u3068\u306f\u3001\u500b\u5225\u306e\u30ea\u30bd\u30fc\u30b9\u306b\u5bfe\u3059\u308b\u8a8d\u8a3c\u30fb\u8a8d\u53ef\u306e\u5b9a\u7fa9\u3092\u3059\u308b\u3053\u3068\u306b\u306a\u308b\u3002\n\n### instance Yesod \u5185\n`Yesod`\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u5ba3\u8a00\u5185\u3067\u3001\u8a8d\u8a3c\u30fb\u8a8d\u53ef\u306e\u5236\u5fa1\u3092\u884c\u3046\u3002\u521d\u671f\u72b6\u614b\u306f\u5168\u3066\u306e\u30a2\u30af\u30bb\u30b9\u3092\u8a8d\u53ef\u3059\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\n```hs\n    -- Default to Authorized for now.\n    isAuthorized _ _ = return Authorized\n```\n\n\u30d1\u30bf\u30fc\u30f3\u30de\u30c3\u30c1\u3092\u4f7f\u3063\u3066\u3001\u3053\u306e\u5b9a\u7fa9\u3088\u308a\u3082\u524d\u306b\u500b\u5225\u306e\u30ea\u30bd\u30fc\u30b9\u306b\u5bfe\u3057\u3066\u5236\u5fa1\u3092\u8a18\u8ff0\u3057\u3066\u3044\u304f\u3053\u3068\u306b\u306a\u308b\u3002\u3053\u3053\u3067\u7279\u306bWeb\u30b5\u30fc\u30d3\u30b9\u306a\u306e\u304b\u3001WebAPI\u306a\u306e\u304b\u3092\u610f\u8b58\u3059\u308b\u3053\u3068\u306f\u306a\u3044\u3002\n\u500b\u5225\u306e\u30ea\u30bd\u30fc\u30b9\u306b\u5bfe\u3059\u308b\u8a8d\u8a3c\u30fb\u8a8d\u53ef\u5b9a\u7fa9\u3092\u7d42\u3048\u305f\u3089\u3001\u7d9a\u3051\u3066\u6b21\u306e\u3088\u3046\u306b\u66f8\u3044\u3066\u304a\u304f\u3068\u826f\u3044\u3060\u308d\u3046\u3002\n\n```hs\n    -- Write \u30e1\u30bd\u30c3\u30c9\u306f\u3001\u57fa\u672c\u7684\u306b\u8a8d\u8a3c\u304c\u5fc5\u8981\n    isAuthorized _ True = do\n        mauth <- maybeAuth\n        case mauth of\n            Nothing -> return AuthenticationRequired\n            Just _ -> return Authorized\n    -- \u500b\u5225\u306b\u5b9a\u7fa9\u3057\u306a\u3044\u30ea\u30bd\u30fc\u30b9\u306f\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\n    isAuthorized _ _ = return Authorized --\u521d\u671f\u72b6\u614b\n```\n\n## \u5de5\u592b\u3057\u305f\u3053\u3068\u30fb\u65e7\uff08\u8aad\u307e\u306a\u304f\u3066OK)\n\u203b\u3053\u3061\u3089\u306e\u5185\u5bb9\u306f\u3001\u300c\u5de5\u592b\u3057\u305f\u3053\u3068\u30fb\u65b0\u300d\u306e\u5185\u5bb9\u3067\u3059\u3079\u3066\u7f6e\u304d\u63db\u3048\u307e\u3059\u3002\u79c1\u304c\u6700\u7d42\u7684\u306a\u65b9\u91dd\u3092\u898b\u3064\u3051\u51fa\u3059\u307e\u3067\u306e\u8ecc\u8de1\u3068\u3057\u3066\u30e1\u30e2\u3057\u3066\u3044\u307e\u3059\u3002\n### Foundation.hs\n\u666e\u901a\u306b\u3001`site`\u578b\u306b\u3001`YesodAuth`\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u4e0e\u3048\u308b\u3002\n\n```hs\nnstance YesodAuth App where\n    type AuthId App = UserId --use ID of USER table as AuthID\n\n    -- Where to send a user after successful login\n    loginDest _ = RootR\n    -- Where to send a user after logout\n    logoutDest _ = RootR\n    -- Override the above two destinations when a Referer: header is present\n    redirectToReferer _ = True\n\n    -- retrieve user id for AuthID by taking credential\n    getAuthId creds = do\n        Entity uid _ <- runDB $ getBy404 $ UniqueUser $ credsIdent creds\n        return $ Just uid\n\n    -- use BrowserId plugin\n    authPlugins _ = [authBrowserId def]\n```\n\n`Yesod`\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u5ba3\u8a00\u5185\u3067\u3001\u8a8d\u8a3c\u30fb\u8a8d\u53ef\u306e\u5236\u5fa1\u3092\u884c\u3046\u3002\u521d\u671f\u72b6\u614b\u306f\u5168\u3066\u306e\u30a2\u30af\u30bb\u30b9\u3092\u8a8d\u53ef\u3059\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\n```hs\n    -- Default to Authorized for now.\n    isAuthorized _ _ = return Authorized\n```\n\n\u30d1\u30bf\u30fc\u30f3\u30de\u30c3\u30c1\u3092\u4f7f\u3063\u3066\u3001\u3053\u306e\u5b9a\u7fa9\u3088\u308a\u3082\u524d\u306b\u500b\u5225\u306e\u30ea\u30bd\u30fc\u30b9\u306b\u5bfe\u3057\u3066\u5236\u5fa1\u3092\u8a18\u8ff0\u3057\u3066\u3044\u304f\u3053\u3068\u306b\u306a\u308b\u3002\u3053\u3053\u3067\u306e\u5de5\u592b\u70b9\u306f\u3001**\u8a8d\u8a3c\u306b\u5931\u6557\u3057\u305f\u5834\u5408\u306e\u5236\u5fa1\u3067\u3042\u308b\u3002\u8a8d\u8a3c\u306b\u5931\u6557\u3057\u305f\u5834\u5408\u306b\u5fc5\u305a\u30ed\u30b0\u30a4\u30f3\u30da\u30fc\u30b8\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u305b\u308b\u3088\u3046\u306a\u5236\u5fa1\u3060\u3068\u3001\u30d7\u30ed\u30b0\u30e9\u30e0\u304b\u3089\u5229\u7528\u3067\u304d\u306a\u3044\u3002**\n\n```hs:isAuthorized\u306e\u4f8b\ninstance Yesod App where\n    isAuthorized RequestsR _ = do\n        mauth <- maybeAuth\n        case mauth of\n            Nothing ->return AuthenticationRequired\n            Just (Entity uid u)\n                | isAdmin u -> return Authorized -- \u7ba1\u7406\u8005\u6a29\u9650\u304c\u3042\u308c\u3070\u8a8d\u53ef\n                | otherwise -> return $ Unauthorized (\"\u3053\u306e\u30da\u30fc\u30b8\u306f\u8868\u793a\u3067\u304d\u307e\u305b\u3093\" :: Text)\n\nisAdmin :: User -> Bool\nisAdmin = userAdmin\n```\n\n\u305d\u3053\u3067\u3001\u6b21\u306e\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u306e\u3088\u3046\u306b\u3001\u51e6\u7406\u3092\u5206\u5c90\u3055\u305b\u308b\u3002\n\n```hs:isAuthorized\u306e\u4f8b'\ninstance Yesod App where\n    isAuthorized RequestsR _ = do\n        mauth <- maybeAuth\n        case mauth of\n            Nothing -> do\n-- \u5909\u66f4\u70b9 from\n                -- WebAPI\u304b\u3089\u306e\u30a2\u30af\u30bb\u30b9\u306f\u3001token \u3092\u53d7\u3051\u53d6\u308b\n                muid <- userIdFromToken\n                case muid of\n                    Just x -> return Authorized\n                    _      -> return AuthenticationRequired\n-- \u5909\u66f4\u70b9 to\n            Just (Entity uid u)\n                | isAdmin u -> return Authorized\n                | otherwise -> return $ Unauthorized (\"\u3053\u306e\u30da\u30fc\u30b8\u306f\u8868\u793a\u3067\u304d\u307e\u305b\u3093\" :: Text)\n\nisAdmin :: User -> Bool\nisAdmin = userAdmin\n\n-- \u30af\u30a8\u30ea\u30d1\u30e9\u30e1\u30fc\u30bf\u304b\u3089\u30c8\u30fc\u30af\u30f3\u3092\u53d7\u3051\u53d6\u308a\u3001\u5bfe\u5fdc\u3059\u308b\u30e6\u30fc\u30b6ID\u3092\u8fd4\u3059\u3002\u5931\u6557\u3059\u308b\u3053\u3068\u3082\u3042\u308b\u3002\nuserIdFromToken :: Handler (Maybe (Key User))\nuserIdFromToken = do\n    mtoken <- lookupGetParam \"token\"\n    case mtoken of\n        Nothing -> return Nothing\n        _ -> do\n            mu <- runDB $ selectFirst [UserPassword ==.  mtoken] []\n            case mu of\n                Just (Entity uid _) -> return $ Just uid\n                _ -> return Nothing\n    \n```\n\n\u3053\u3046\u3059\u308b\u3053\u3068\u3067\u3001\u8a8d\u8a3c\u3092\u56de\u907f\u3057\u3001\u304b\u3064\u5236\u9650\u3055\u308c\u305f\u30e6\u30fc\u30b6\u306e\u307f\u306b\u30ea\u30bd\u30fc\u30b9\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3053\u3068\u3092\u8a31\u53ef\u3067\u304d\u308b\u3002\n\u307e\u305f\u3001\u500b\u5225\u306e\u30ea\u30bd\u30fc\u30b9\u306b\u5bfe\u3059\u308b\u8a8d\u8a3c\u30fb\u8a8d\u53ef\u5b9a\u7fa9\u3092\u7d42\u3048\u305f\u3089\u3001\u7d9a\u3051\u3066\u6b21\u306e\u3088\u3046\u306b\u66f8\u3044\u3066\u304a\u304f\u3068\u826f\u3044\u3060\u308d\u3046\u3002\n\n```hs\n    -- Write \u30e1\u30bd\u30c3\u30c9\u306f\u3001\u57fa\u672c\u7684\u306b\u8a8d\u8a3c\u304c\u5fc5\u8981\n    isAuthorized _ True = do\n        mauth <- maybeAuth\n        case mauth of\n            Nothing -> return AuthenticationRequired\n            Just _ -> return Authorized\n    -- \u500b\u5225\u306b\u5b9a\u7fa9\u3057\u306a\u3044\u30ea\u30bd\u30fc\u30b9\u306f\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\n    isAuthorized _ _ = return Authorized\n```\n\n###\u30cf\u30f3\u30c9\u30e9\n\u30cf\u30f3\u30c9\u30e9\u5185\u3067\u306f\u3001\u5fc5\u8981\u306a\u6642\u306b\u8a8d\u8a3cID\u3092\u53d6\u308a\u51fa\u3059\u3053\u3068\u304c\u3067\u304d\u308b\u3002\u53d6\u5f97\u65b9\u6cd5\u306f\u5927\u304d\u304f\uff12\u3064\u3042\u308b\uff08\u5b9f\u969b\u306f\uff14\u3064\u3060\u304c\u3001\u7c21\u5358\u306e\u305f\u3081\uff09\u3002\n\n```hs\nmaybeAuthId :: HandlerT master IO (Maybe (AuthId master))\nrequireAuthId :: YesodAuth master => HandlerT master IO (AuthId master)\n```\n\n\u53d6\u5f97\u3059\u308b\u60c5\u5831\u304c\u3001`Maybe`\u578b\u3067\u5305\u307e\u308c\u3066\u3044\u308b\u304b\u3044\u306a\u3044\u304b\u3068\u3044\u3046\u70b9\u3068\u3001`requireAuth`\u306f\u3082\u3057\u8a8d\u8a3cID\u3092\u53d6\u308a\u51fa\u305b\u306a\u3051\u308c\u3070\u30ed\u30b0\u30a4\u30f3\u753b\u9762\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u305b\u308b\u3001\u3068\u3044\u3046\u70b9\u304c\u3001\uff12\u3064\u306e\u51e6\u7406\u306e\u9055\u3044\u3067\u3042\u308b\u3002\n\n\u79c1\u306f\u30b3\u30fc\u30c9\u3092\u7c21\u6f54\u306b\u3059\u308b\u3053\u3068\u3092\u4e3b\u76ee\u7684\u3068\u3057\u3066\u3001\u8a8d\u8a3cID\u3092\u751f\u3067\u53d6\u308a\u51fa\u305b\u308b\u3088\u3046\u306b\u3001\u6b21\u306e\u3088\u3046\u306b\u66f8\u3044\u3066\u3044\u305f\u3002\n\n```hs:\u6700\u521d\u306b\u66f8\u3044\u305f\u30b3\u30fc\u30c9\ngetRootR :: Handler Html\ngetRootR = do\n    uid <- requireAuth\n\n...\n```\n\n\u3057\u304b\u3057\u3001 **\u3053\u308c\u3067\u306f\u3084\u306f\u308a\u3001\u8a8d\u8a3c\u306b\u5931\u6557\u3059\u308b\u3068\u30ed\u30b0\u30a4\u30f3\u30da\u30fc\u30b8\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u308c\u3066\u3057\u307e\u3046\u305f\u3081\u3001\u30d7\u30ed\u30b0\u30e9\u30e0\u304b\u3089\u5229\u7528\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u306a\u3044\u3002**\u3057\u305f\u304c\u3063\u3066\u3001\u30cf\u30f3\u30c9\u30e9\u5185\u3067`requireAuth`\u3092\u4f7f\u3046\u306e\u306f\u3001WebAPI\u306e\u89b3\u70b9\u304b\u3089\u306f\u3088\u308d\u3057\u304f\u306a\u3044\u3060\u308d\u3046\u3002\u3053\u308c\u304c\u5de5\u592b\u70b9\u3068\u306a\u308b\u3002\n\n```hs:\u5de5\u592b\u5f8c\u306e\u30b3\u30fc\u30c9\ngetRootR :: Handler Html\ngetRootR = do\n    Just (Entity uid _) <- maybeAuth -- \u8a8d\u8a3cID\u3092\u53d6\u5f97\u3067\u304d\u306a\u304f\u3066\u3082\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3057\u306a\u3044\n\n...\n", "tags": ["yesod", "Haskell"]}