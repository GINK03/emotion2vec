{"context": "Views\u306f\u4fbf\u5229\u3067\u3059\u304c\u3001\u30ed\u30b8\u30c3\u30af\u3067\u3054\u306b\u3087\u3054\u306b\u3087\u3067\u304d\u308b\u3068\u3001\n\u3088\u308a\u4e00\u5c64\u4fbf\u5229\u3067\nhook_views_query_alter \u3092\u4f7f\u3044\u307e\u3059\u3002\nviews_join \u306b\u3064\u3044\u3066\u306f\u3053\u3061\u3089\u3092\u53c2\u7167\u3002\nadd_relationship\u306b\u3064\u3044\u3066\u306f\u3053\u3061\u3089\u3092\u53c2\u7167\u3002\n/**\n * Implementation of hook_views_query_alter().\n */\nfunction MYMODULE_views_query_alter(&$view, &$query) {\n\n    // do something.\n\n    $join = new views_join();\n    $join->table = 'field_data_field_hoge';\n    $join->field = 'entity_id';\n    $join->left_table = 'node';\n    $join->left_field = 'nid';\n    $join->type = 'left';\n\n    $query->add_relationship('field_hoge', $join, 'node');\n\n    // \u4ee5\u4e0b\u306f\u304a\u307e\u3051\n    $query->where[1]['conditions'][] = array(\n        'field' => 'field_hoge.bundle',\n        'value' => array('content_type_A', 'content_type_B'),\n        'operator' => 'IN'\n    );\n}\n\n\u3059\u308b\u3068\u3001\u4ee5\u4e0b\u306eSQL\u306b\u306a\u308b\u3002\nSELECT\n  -- \u7701\u7565\nFROM\n  node node \n  LEFT JOIN field_data_field_hoge field_hoge \n    ON node.nid = field_hoge.entity_id\nWHERE\n  field_hoge.bundle IN ('contents_type_A', 'contents_type_B')\n\n\u3061\u306a\u307f\u306b\u3001\u753b\u9762\u304b\u3089\u306e\u691c\u7d22\u30ad\u30fc\u30ef\u30fc\u30c9\u3067\u30e9\u30a4\u30af\u3057\u3066\u307f\u308b\u3002\n$word = '%' . filter_xss($view->exposed_input['search_word']) . '%';\n\n$or_condition = db_or();\n$or_condition->condition('node.title', $word, 'ILIKE'); // ILIKE \u306fPostgreSQL\u306e\u65b9\u8a00\n$query->add_where(1, $or_condition);\n\n\u3059\u308b\u3068\nSELECT\n  -- \u7701\u7565\nFROM\n  node node \n  LEFT JOIN field_data_field_hoge field_hoge\n    ON node.nid = field_hoge.entity_id\nWHERE\n  field_hoge.bundle IN ('content_type_A', 'content_type_B')\n  AND node.title ILIKE '%neko%'\n\n\u7121\u4e8b\u306b\u30e9\u30a4\u30af\u3067\u304d\u308b\u3002\n\n\u5099\u8003\n$view->exposed_input \u306e\u5024\u3063\u3066\u30b5\u30cb\u30bf\u30a4\u30ba\u3055\u308c\u308b\u3093\u3058\u3083\u306a\u304b\u3063\u305f\u3067\u3057\u305f\u3063\u3051\uff1f\n\u81ea\u524d\u3067Views\u306e\u691c\u7d22\u6761\u4ef6\u3068\u3057\u3066\u753b\u9762\u9805\u76ee\u3092\u8ffd\u52a0\u3057\u305f\u969b\u306e\u8a2d\u5b9a\u6f0f\u308c\u306a\u306e\u304b\u306a\u3002\u3002\n\u308f\u3056\u308f\u3056 filter_xss \u3084 check_plain \u306f\u3057\u306a\u304f\u3066\u3088\u304b\u3063\u305f\u30cf\u30ba\u3002\n\uff08\u00b4-`\uff09.\uff61oO\uff08\u3042\u3068\u3067\u8abf\u3079\u308b\uff09\nViews\u306f\u4fbf\u5229\u3067\u3059\u304c\u3001\u30ed\u30b8\u30c3\u30af\u3067\u3054\u306b\u3087\u3054\u306b\u3087\u3067\u304d\u308b\u3068\u3001\n\u3088\u308a\u4e00\u5c64\u4fbf\u5229\u3067\n\nhook_views_query_alter \u3092\u4f7f\u3044\u307e\u3059\u3002\nviews_join \u306b\u3064\u3044\u3066\u306f[\u3053\u3061\u3089](https://api.drupal.org/api/views/includes!handlers.inc/class/views_join/7)\u3092\u53c2\u7167\u3002\nadd_relationship\u306b\u3064\u3044\u3066\u306f[\u3053\u3061\u3089](https://api.drupal.org/api/views/plugins!views_plugin_query_default.inc/function/views_plugin_query_default%3A%3Aadd_relationship/7.x-3.x)\u3092\u53c2\u7167\u3002\n\n```php\n/**\n * Implementation of hook_views_query_alter().\n */\nfunction MYMODULE_views_query_alter(&$view, &$query) {\n\n\t// do something.\n\n\t$join = new views_join();\n\t$join->table = 'field_data_field_hoge';\n\t$join->field = 'entity_id';\n\t$join->left_table = 'node';\n\t$join->left_field = 'nid';\n\t$join->type = 'left';\n\n\t$query->add_relationship('field_hoge', $join, 'node');\n\n\t// \u4ee5\u4e0b\u306f\u304a\u307e\u3051\n\t$query->where[1]['conditions'][] = array(\n\t    'field' => 'field_hoge.bundle',\n\t    'value' => array('content_type_A', 'content_type_B'),\n\t    'operator' => 'IN'\n\t);\n}\n```\n\u3059\u308b\u3068\u3001\u4ee5\u4e0b\u306eSQL\u306b\u306a\u308b\u3002\n\n```sql\nSELECT\n  -- \u7701\u7565\nFROM\n  node node \n  LEFT JOIN field_data_field_hoge field_hoge \n    ON node.nid = field_hoge.entity_id\nWHERE\n  field_hoge.bundle IN ('contents_type_A', 'contents_type_B')\n```\n\n\u3061\u306a\u307f\u306b\u3001\u753b\u9762\u304b\u3089\u306e\u691c\u7d22\u30ad\u30fc\u30ef\u30fc\u30c9\u3067\u30e9\u30a4\u30af\u3057\u3066\u307f\u308b\u3002\n\n```php\n$word = '%' . filter_xss($view->exposed_input['search_word']) . '%';\n\n$or_condition = db_or();\n$or_condition->condition('node.title', $word, 'ILIKE'); // ILIKE \u306fPostgreSQL\u306e\u65b9\u8a00\n$query->add_where(1, $or_condition);\n```\n\n\u3059\u308b\u3068\n\n```sql\nSELECT\n  -- \u7701\u7565\nFROM\n  node node \n  LEFT JOIN field_data_field_hoge field_hoge\n    ON node.nid = field_hoge.entity_id\nWHERE\n  field_hoge.bundle IN ('content_type_A', 'content_type_B')\n  AND node.title ILIKE '%neko%'\n```\n\n\u7121\u4e8b\u306b\u30e9\u30a4\u30af\u3067\u304d\u308b\u3002\n\n#\u5099\u8003\n$view->exposed_input \u306e\u5024\u3063\u3066\u30b5\u30cb\u30bf\u30a4\u30ba\u3055\u308c\u308b\u3093\u3058\u3083\u306a\u304b\u3063\u305f\u3067\u3057\u305f\u3063\u3051\uff1f\n\u81ea\u524d\u3067Views\u306e\u691c\u7d22\u6761\u4ef6\u3068\u3057\u3066\u753b\u9762\u9805\u76ee\u3092\u8ffd\u52a0\u3057\u305f\u969b\u306e\u8a2d\u5b9a\u6f0f\u308c\u306a\u306e\u304b\u306a\u3002\u3002\n\u308f\u3056\u308f\u3056 filter_xss \u3084 check_plain \u306f\u3057\u306a\u304f\u3066\u3088\u304b\u3063\u305f\u30cf\u30ba\u3002\n\uff08\u00b4-`\uff09.\uff61oO\uff08\u3042\u3068\u3067\u8abf\u3079\u308b\uff09\n", "tags": ["Drupal7", "Drupal", "Views", "SQL"]}