{"context": "\n\nbefore_destroy\nOmniAuth\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u308b\u30b5\u30fc\u30d3\u30b9\u3092\u3064\u304f\u308b\u3068\u304d\u3001facebook,twitter,github,google\u306a\u3069\u8907\u6570\u306e\u30d7\u30ed\u30d0\u30a4\u30c0\u30fc\u3068\u30a2\u30ab\u30a6\u30f3\u30c8\u3092\u9023\u643a\u3055\u305b\u308b\u3053\u3068\u304c\u3042\u308a\u307e\u3059\u3002\n\u3067\u3082\u3001\u3059\u3079\u3066\u306e\u30a2\u30ab\u30a6\u30f3\u30c8\u9023\u643a\u3092\u89e3\u9664\u3057\u3066\u3057\u307e\u3046\u3068\u30bb\u30c3\u30b7\u30e7\u30f3\u304c\u5207\u308c\u305f\u6642\u306b\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u306a\u304f\u306a\u3063\u3066\u3057\u307e\u3046\u306e\u3067\u5c11\u306a\u304f\u3068\u3082\u4e00\u3064\u306e\u8a8d\u8a3c\u7528\u30a2\u30ab\u30a6\u30f3\u30c8\u304c\u5fc5\u8981\u3067\u3059\u3002\n\u305d\u3093\u306a\u3068\u304d\u306b\u3001destroy\u30e1\u30bd\u30c3\u30c9\u306b\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u3092\u3064\u3051\u308b\u305f\u3081\u306b\u3001Rails4\u307e\u3067\u306fbefore_destroy\u3092\u4f7f\u3044\u3001return false\u3092\u8fd4\u3059\u3068\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u304c\u30b9\u30c8\u30c3\u30d7\u3057\u3066\u304f\u308c\u308b\u306e\u3067\u305d\u3046\u3057\u3066\u307e\u3057\u305f\u3002\n\nrails5\u304b\u3089\u306fthrow :abort\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\u4eca\u307e\u3067\u901a\u308aerrors.full_messages\u306a\u3069\u304c\u4f7f\u3048\u307e\u3059\u3002\n\n\nsocial_profile.rb\nclass SocialProfile < ActiveRecord::Base\n  belongs_to :user\n  store :other\n  validates :uid, uniqueness: { scope: :provider }, length: { in: 6..128 }\n  validates :provider, inclusion: { in: Settings.auth_config.keys.map(&:to_s) }\n  include Logic::SocialProfile\n  include Logic::SocialProfile::InitializeWithCallbackInfo\n\n  # before_destroy\u3067destroy\u30e1\u30bd\u30c3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u524d\u306b\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u3092\u304b\u3051\u307e\u3059\n  before_destroy :least_one\n\n  private\n\n  def least_one\n    if self.user.social_profiles.count == 1\n      errors.add :base, '\u5c11\u306a\u304f\u3068\u30821\u3064\u3001\u30ed\u30b0\u30a4\u30f3\u7528\u306e\u8a8d\u8a3c\u304c\u5fc5\u8981\u3067\u3059'\n      # return false\u3000\u3067\u306f\u306a\u304f throw :abort\n      throw :abort\n    end\n  end\nend\n\n\nrails\u306f\u4ed5\u69d8\u5909\u66f4\u3082\u697d\u3057\u3044\u3067\u3059\u306d\n# before_destroy\nOmniAuth\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u308b\u30b5\u30fc\u30d3\u30b9\u3092\u3064\u304f\u308b\u3068\u304d\u3001facebook,twitter,github,google\u306a\u3069\u8907\u6570\u306e\u30d7\u30ed\u30d0\u30a4\u30c0\u30fc\u3068\u30a2\u30ab\u30a6\u30f3\u30c8\u3092\u9023\u643a\u3055\u305b\u308b\u3053\u3068\u304c\u3042\u308a\u307e\u3059\u3002\n\u3067\u3082\u3001\u3059\u3079\u3066\u306e\u30a2\u30ab\u30a6\u30f3\u30c8\u9023\u643a\u3092\u89e3\u9664\u3057\u3066\u3057\u307e\u3046\u3068\u30bb\u30c3\u30b7\u30e7\u30f3\u304c\u5207\u308c\u305f\u6642\u306b\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u306a\u304f\u306a\u3063\u3066\u3057\u307e\u3046\u306e\u3067\u5c11\u306a\u304f\u3068\u3082\u4e00\u3064\u306e\u8a8d\u8a3c\u7528\u30a2\u30ab\u30a6\u30f3\u30c8\u304c\u5fc5\u8981\u3067\u3059\u3002\n\n\u305d\u3093\u306a\u3068\u304d\u306b\u3001destroy\u30e1\u30bd\u30c3\u30c9\u306b\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u3092\u3064\u3051\u308b\u305f\u3081\u306b\u3001Rails4\u307e\u3067\u306f**before_destroy**\u3092\u4f7f\u3044\u3001`return false`\u3092\u8fd4\u3059\u3068\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u304c\u30b9\u30c8\u30c3\u30d7\u3057\u3066\u304f\u308c\u308b\u306e\u3067\u305d\u3046\u3057\u3066\u307e\u3057\u305f\u3002\n\n# rails5\u304b\u3089\u306f`throw :abort`\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n\u4eca\u307e\u3067\u901a\u308a`errors.full_messages`\u306a\u3069\u304c\u4f7f\u3048\u307e\u3059\u3002\n\n[<img width=\"732\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-24 0.22.29.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/108235/5b902ba5-0122-8511-afbb-250f831245db.png\">](https://speakerdeck.com/claudiob/better-callbacks-in-rails-5)\n\n# \n\n```rb:social_profile.rb\nclass SocialProfile < ActiveRecord::Base\n  belongs_to :user\n  store :other\n  validates :uid, uniqueness: { scope: :provider }, length: { in: 6..128 }\n  validates :provider, inclusion: { in: Settings.auth_config.keys.map(&:to_s) }\n  include Logic::SocialProfile\n  include Logic::SocialProfile::InitializeWithCallbackInfo\n\n  # before_destroy\u3067destroy\u30e1\u30bd\u30c3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u524d\u306b\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u3092\u304b\u3051\u307e\u3059\n  before_destroy :least_one\n\n  private\n\n  def least_one\n    if self.user.social_profiles.count == 1\n      errors.add :base, '\u5c11\u306a\u304f\u3068\u30821\u3064\u3001\u30ed\u30b0\u30a4\u30f3\u7528\u306e\u8a8d\u8a3c\u304c\u5fc5\u8981\u3067\u3059'\n      # return false\u3000\u3067\u306f\u306a\u304f throw :abort\n      throw :abort\n    end\n  end\nend\n```\n\nrails\u306f\u4ed5\u69d8\u5909\u66f4\u3082\u697d\u3057\u3044\u3067\u3059\u306d\n", "tags": ["Rails5"]}