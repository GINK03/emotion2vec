{"tags": ["PostGIS", "GIS", "PHP", "PostgreSQL"], "context": " More than 1 year has passed since last update.\n\n\u524d\u63d0\u3068\u3059\u308b\u74b0\u5883 PHP\uff0bPostgreSQL(PostGIS)\n\u3053\u3061\u3089\u306e\u8aac\u660e\u306f\u4ee5\u4e0b\u306e\u74b0\u5883\u3092\u524d\u63d0\u3068\u3057\u3066\u3044\u307e\u3059\u3002\n\u30fbPHP\u304c\u52d5\u4f5c\u3059\u308bWeb\u30b5\u30fc\u30d0(IIS,Apache,Nginx)\u306a\u3069\n\u30fbPostgreSQL\uff08PostGIS\u306e\u62e1\u5f35\u6a5f\u80fd\u3092\u5229\u7528\u3057\u307e\u3059\uff09\n\nPostGIS\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nPostgreSQL 9.1 \u4ee5\u4e0a\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u306f\u3001PostGIS\u306e\u5c0e\u5165\u304cSQL\u306e\u5b9f\u884c\u3060\u3051\u3067\u5b8c\u4e86\u3059\u308b\u305f\u3081\u975e\u5e38\u306b\u7c21\u5358\u306b\u306a\u308a\u307e\u3057\u305f\u3002\nCREATE EXTENSION postgis;\n\n\u307e\u305f\u3001Amazon Web Service\u3067\u306fRDS\u3068\u3044\u3046PostgreSQL\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u30ec\u30f3\u30bf\u30eb\u3059\u308b\u3053\u3068\u3082\u53ef\u80fd\u3067\u3059\u3002\n\n\u4efb\u610f\u306e\u534a\u5f84\u306e\u30dd\u30ea\u30b4\u30f3\u3092PostGIS\u3067\u4f5c\u6210\u3059\u308b\n\nGIS\u51e6\u7406\u306e\u57fa\u672c\n\u7c21\u5358\u3067\u3059\u304c\u3001PostgreSQL\u306eGIS\u51e6\u7406\u306e\u6982\u5ff5\u3092\u8aac\u660e\u3067\u3059\u3002\u8a73\u3057\u304f\u306f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092\u5fa1\u89a7\u304f\u3060\u3055\u3044\u3002\n\n\u30c7\u30fc\u30bf\u578b\nPostGIS\u306b\u306f\u7a7a\u9593\u60c5\u5831\u3092\u51e6\u7406\u3059\u308b\u305f\u3081\u306b\u5c02\u7528\u306e\u30c7\u30fc\u30bf\u578b\u304c2\u3064\u6709\u308a\u307e\u3059\u3002\n\u30fb\u5e73\u9762\u30c7\u30fc\u30bf\u306e geometry\u578b\n\u30fb\u7403\u9762\u30c7\u30fc\u30bf\u306e geography\u578b\n\u4eca\u56de\u306f\u7c21\u5358\u304b\u3064\u6b63\u78ba\u306b\u30e1\u30fc\u30c8\u30eb\u5358\u4f4d\u3067\u306e\u5186\u5f62\u3092\u4f5c\u6210\u3059\u308b\u305f\u3081\u306b\u7403\u9762\u30c7\u30fc\u30bf\u3092\u6271\u3046\u3001geography\u578b\u3092\u7528\u3044\u307e\u3059\u3002\n\nSQL\u306b\u3088\u308b\u5186\u5f62\u30dd\u30ea\u30b4\u30f3\u306e\u4f5c\u6210\nPostGIS\u306e\u95a2\u6570\u3092\u6d3b\u7528\u3057\u3066\u3001\u7def\u5ea6\u7d4c\u5ea6\u304b\u3089\u70b9\u3092\u4f5c\u6210\u3057\u3001\u70b9\u3092\u5186\u5f62\u306e\u30dd\u30ea\u30b4\u30f3\u306b\u5909\u63db\u3057\u307e\u3059\u3002\n\u8907\u6570\u306e\u95a2\u6570\u3092\u7d44\u307f\u5408\u308f\u305b\u3066\u51e6\u7406\u3059\u308b\u305f\u3081\u3001\u305d\u308c\u305e\u308c\u306e\u95a2\u6570\u6bce\u306b\u30b9\u30c6\u30c3\u30d7\u3092\u8e0f\u3093\u3067\u8aac\u660e\u81f4\u3057\u307e\u3059\u3002\n\u4eca\u5f8c\u306f\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306e\u4e2d\u3067\u3001\u7def\u5ea6\u3092lat\u3001\u7d4c\u5ea6\u3092lon\u3068\u8868\u8a18\u3057\u307e\u3059\u3002\n\n\u30b9\u30c6\u30c3\u30d71 : \u70b9\u30c7\u30fc\u30bf\u306e\u4f5c\u6210\nST_Point\u95a2\u6570\u3092\u7528\u3044\u3066\u3001\u70b9\u30c7\u30fc\u30bf\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n\u70b9\u306e\u4f5c\u6210\n SELECT ST_POINT( lon, lat) ;\n\n\n\n\u30b9\u30c6\u30c3\u30d72 : \u7403\u9762\u30c7\u30fc\u30bf\u578b\u3078\u30ad\u30e3\u30b9\u30c8\n\u30b9\u30c6\u30c3\u30d7\uff11\u3067\u306f\u5e73\u9762\u30c7\u30fc\u30bf\u578b\u306egeometry\u578b\u304c\u751f\u6210\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001geography\u95a2\u6570\u3092\u7528\u3044\u3066\u7403\u9762\u30c7\u30fc\u30bf\u578b\u306egeography\u578b\u3078\u30ad\u30e3\u30b9\u30c8\u3057\u307e\u3059\u3002\n\ngeometry\u578b\u304b\u3089geography\u578b\u3078\u30ad\u30e3\u30b9\u30c8\n SELECT GEOGRAPHY( ST_POINT( lon, lat) );\n\n\n\n\u30b9\u30c6\u30c3\u30d7\uff13 : \u70b9\u3092\u5186\u5f62\u306b\u5909\u63db\n\u70b9\u3092\u5186\u30d0\u30c3\u30d5\u30a1\u306b\u5909\u63db\u3057\u307e\u3059\u3002ST_Buffer( geography\u578b , \u534a\u5f84(\u30e1\u30fc\u30c8\u30eb))\u95a2\u6570\u3092\u7528\u3044\u3066\u3001\u70b9\u30c7\u30fc\u30bf\u3092\u5186\u5f62\u306e\u30dd\u30ea\u30b4\u30f3\u30c7\u30fc\u30bf\u306b\u5909\u63db\u3057\u307e\u3059\u3002\u4f8b\u3067\u306f1,000m\n\n\u30dd\u30a4\u30f3\u30c8\u30c7\u30fc\u30bf\u304b\u3089\u30dd\u30ea\u30b4\u30f3\u30c7\u30fc\u30bf\u306b\n SELECT ST_Buffer( GEOGRAPHY( ST_POINT( lon, lat) ) , 1000 );\n\n\n\n\u30b9\u30c6\u30c3\u30d74 : KML\u306e\u30dd\u30ea\u30b4\u30f3\u30bf\u30b0\u3078\u5909\u63db\nST_AsKML\u3092\u7528\u3044\u3066\u3001geography\u578b\u304b\u3089kml\u306e\u30dd\u30ea\u30b4\u30f3\u5f62\u72b6\u306e\u5b9a\u7fa9\u90e8\u5206\u306e\u6587\u5b57\u5217\u3092\u51fa\u529b\u3057\u307e\u3059\u3002\n\ngeography\u578b\u304b\u3089KML\u6587\u5b57\u5217\u3078\u5909\u63db\n SELECT ST_AsKML(ST_Buffer( GEOGRAPHY( ST_POINT( lon, lat) ) , 1000 ));\n\n\n\nPHP\u306b\u3088\u308bAPI\u5316\n\u7def\u5ea6\u7d4c\u5ea6\u3068\u534a\u5f84\u3092\u30d1\u30e9\u30e1\u30fc\u30bf\u3068\u3057\u3066\u53d6\u5f97\u3057\u3001\u52d5\u7684\u306b\u5186\u5f62\u306e\u30dd\u30ea\u30b4\u30f3\u3092\u51fa\u529b\u3059\u308bAPI\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n\u5165\u529b\u30d1\u30e9\u30e1\u30fc\u30bf\n\nlon : \u7d4c\u5ea6 \nlat\uff1a\u7def\u5ea6 \nr : \u534a\u5f84 \ncolor : \u8272 ( \u03b1bgr )\n\u4eca\u56de\u306f\u5404\u5024\u306b\u30c7\u30d5\u30a9\u30eb\u30c8\u5024\u3092\u7528\u610f\u3057\u3066\u3001\u5165\u529b\u304c\u7121\u304f\u3066\u3082\u52d5\u4f5c\u3057\u307e\u3059\u3002 \n\n\nURL\u4f8b\nhttp://\u30c9\u30e1\u30a4\u30f3\u540d/getcircle.php?lon=140.0&lat=36.6&r=300&440000ff\n\ngetcircle.php\n<?php\n//\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3078\u63a5\u7d9a\n$conn_string = \"host=localhost port=5432 dbname=database1 user=user1 password=*****\";\n$conn = pg_pconnect($conn_string);\nif (!$conn) {\n  echo \"An error occurred.\\n\";\n  exit;\n}\n\n//\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u53d6\u5f97\nif(isset($_GET['lon']) ){\n$lon = $_GET['lon'];\n} else {\n    $lon=139.989136553437;\n}\nif(isset($_GET['lat']) ){\n$lat = $_GET['lat'];\n}else {\n    $lat = 35.65945922265559;\n}\nif(isset($_GET['r']) ){\n$radius = $_GET['r'];\n}else {\n    $radius = 1000;\n\n}\nif(isset($_GET['o']) ){\n$color = $_GET['o'];\n}else {\n $color =\"4cff7b00\";\n}\n\n//SQL\u306e\u4f5c\u6210\n$sql =\"SELECT ST_AsKML(ST_Buffer( GEOGRAPHY(ST_Point(\".$lon.\",\".$lat.\")) , \".$radius.\")) AS p ;\";\n//\u691c\u7d22\u5b9f\u884c\n$result = pg_query($conn, $sql);\nif (!$result) {\n  echo \"An error occurred.\\n\";\n  exit;\n}\n//\u691c\u7d22\u7d50\u679c\u306e\u53d6\u5f97\n$row = pg_fetch_row($result);\n\n//KML\u6587\u5b57\u5217\u306e\u53d6\u5f97\n$str = <<<EOD\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<kml xmlns=\"http://www.opengis.net/kml/2.2\" xmlns:gx=\"http://www.google.com/kml/ext/2.2\" xmlns:kml=\"http://www.opengis.net/kml/2.2\" xmlns:atom=\"http://www.w3.org/2005/Atom\">\n<Document>\n    <name></name>\n    <Style id=\"s\">\n        <LineStyle>\n            <color>{$color}</color>\n        </LineStyle>\n        <PolyStyle>\n            <color>{$color}</color>\n        </PolyStyle>\n    </Style>\n    <Placemark>\n        <name>polygon</name>\n        <styleUrl>#s</styleUrl>\n        {$row[0]}\n    </Placemark>\n</Document>\n</kml>\nEOD;\nheader('Content-Type: application/vnd.google-earth.kml+xml kml');\nheader('Content-Disposition: attachment; filename=\"mar.kml\"');\nprint $str;\n?>\n\n\n##\u524d\u63d0\u3068\u3059\u308b\u74b0\u5883 PHP\uff0bPostgreSQL(PostGIS)\n\u3053\u3061\u3089\u306e\u8aac\u660e\u306f\u4ee5\u4e0b\u306e\u74b0\u5883\u3092\u524d\u63d0\u3068\u3057\u3066\u3044\u307e\u3059\u3002\n\u30fbPHP\u304c\u52d5\u4f5c\u3059\u308bWeb\u30b5\u30fc\u30d0(IIS,Apache,Nginx)\u306a\u3069\n\u30fbPostgreSQL\uff08PostGIS\u306e\u62e1\u5f35\u6a5f\u80fd\u3092\u5229\u7528\u3057\u307e\u3059\uff09\n##PostGIS\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nPostgreSQL 9.1 \u4ee5\u4e0a\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u306f\u3001PostGIS\u306e\u5c0e\u5165\u304cSQL\u306e\u5b9f\u884c\u3060\u3051\u3067\u5b8c\u4e86\u3059\u308b\u305f\u3081\u975e\u5e38\u306b\u7c21\u5358\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n```sql\nCREATE EXTENSION postgis;\n```\n\u307e\u305f\u3001[Amazon Web Service](http://aws.amazon.com/jp/)\u3067\u306fRDS\u3068\u3044\u3046PostgreSQL\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u30ec\u30f3\u30bf\u30eb\u3059\u308b\u3053\u3068\u3082\u53ef\u80fd\u3067\u3059\u3002\n\n#\u4efb\u610f\u306e\u534a\u5f84\u306e\u30dd\u30ea\u30b4\u30f3\u3092PostGIS\u3067\u4f5c\u6210\u3059\u308b\n##GIS\u51e6\u7406\u306e\u57fa\u672c\n\u7c21\u5358\u3067\u3059\u304c\u3001PostgreSQL\u306eGIS\u51e6\u7406\u306e\u6982\u5ff5\u3092\u8aac\u660e\u3067\u3059\u3002\u8a73\u3057\u304f\u306f[\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](http://www.finds.jp/docs/pgisman/2.2.0/index.html)\u3092\u5fa1\u89a7\u304f\u3060\u3055\u3044\u3002\n###\u30c7\u30fc\u30bf\u578b\nPostGIS\u306b\u306f\u7a7a\u9593\u60c5\u5831\u3092\u51e6\u7406\u3059\u308b\u305f\u3081\u306b\u5c02\u7528\u306e\u30c7\u30fc\u30bf\u578b\u304c2\u3064\u6709\u308a\u307e\u3059\u3002\n\u30fb\u5e73\u9762\u30c7\u30fc\u30bf\u306e geometry\u578b\n\u30fb\u7403\u9762\u30c7\u30fc\u30bf\u306e geography\u578b\n\n\u4eca\u56de\u306f\u7c21\u5358\u304b\u3064\u6b63\u78ba\u306b\u30e1\u30fc\u30c8\u30eb\u5358\u4f4d\u3067\u306e\u5186\u5f62\u3092\u4f5c\u6210\u3059\u308b\u305f\u3081\u306b\u7403\u9762\u30c7\u30fc\u30bf\u3092\u6271\u3046\u3001geography\u578b\u3092\u7528\u3044\u307e\u3059\u3002\n\n#SQL\u306b\u3088\u308b\u5186\u5f62\u30dd\u30ea\u30b4\u30f3\u306e\u4f5c\u6210\nPostGIS\u306e\u95a2\u6570\u3092\u6d3b\u7528\u3057\u3066\u3001\u7def\u5ea6\u7d4c\u5ea6\u304b\u3089\u70b9\u3092\u4f5c\u6210\u3057\u3001\u70b9\u3092\u5186\u5f62\u306e\u30dd\u30ea\u30b4\u30f3\u306b\u5909\u63db\u3057\u307e\u3059\u3002\n\u8907\u6570\u306e\u95a2\u6570\u3092\u7d44\u307f\u5408\u308f\u305b\u3066\u51e6\u7406\u3059\u308b\u305f\u3081\u3001\u305d\u308c\u305e\u308c\u306e\u95a2\u6570\u6bce\u306b\u30b9\u30c6\u30c3\u30d7\u3092\u8e0f\u3093\u3067\u8aac\u660e\u81f4\u3057\u307e\u3059\u3002\n\n\u4eca\u5f8c\u306f\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306e\u4e2d\u3067\u3001\u7def\u5ea6\u3092lat\u3001\u7d4c\u5ea6\u3092lon\u3068\u8868\u8a18\u3057\u307e\u3059\u3002\n\n###\u30b9\u30c6\u30c3\u30d71 : \u70b9\u30c7\u30fc\u30bf\u306e\u4f5c\u6210\nST_Point\u95a2\u6570\u3092\u7528\u3044\u3066\u3001\u70b9\u30c7\u30fc\u30bf\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```sql:\u70b9\u306e\u4f5c\u6210\n SELECT ST_POINT( lon, lat) ;\n```\n\n###\u30b9\u30c6\u30c3\u30d72 : \u7403\u9762\u30c7\u30fc\u30bf\u578b\u3078\u30ad\u30e3\u30b9\u30c8\n\u30b9\u30c6\u30c3\u30d7\uff11\u3067\u306f\u5e73\u9762\u30c7\u30fc\u30bf\u578b\u306egeometry\u578b\u304c\u751f\u6210\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001geography\u95a2\u6570\u3092\u7528\u3044\u3066\u7403\u9762\u30c7\u30fc\u30bf\u578b\u306egeography\u578b\u3078\u30ad\u30e3\u30b9\u30c8\u3057\u307e\u3059\u3002\n\n```sql:geometry\u578b\u304b\u3089geography\u578b\u3078\u30ad\u30e3\u30b9\u30c8\n SELECT GEOGRAPHY( ST_POINT( lon, lat) );\n```\n###\u30b9\u30c6\u30c3\u30d7\uff13 : \u70b9\u3092\u5186\u5f62\u306b\u5909\u63db\n\u70b9\u3092\u5186\u30d0\u30c3\u30d5\u30a1\u306b\u5909\u63db\u3057\u307e\u3059\u3002ST_Buffer( geography\u578b , \u534a\u5f84(\u30e1\u30fc\u30c8\u30eb))\u95a2\u6570\u3092\u7528\u3044\u3066\u3001\u70b9\u30c7\u30fc\u30bf\u3092\u5186\u5f62\u306e\u30dd\u30ea\u30b4\u30f3\u30c7\u30fc\u30bf\u306b\u5909\u63db\u3057\u307e\u3059\u3002\u4f8b\u3067\u306f1,000m\n\n```sql:\u30dd\u30a4\u30f3\u30c8\u30c7\u30fc\u30bf\u304b\u3089\u30dd\u30ea\u30b4\u30f3\u30c7\u30fc\u30bf\u306b\n SELECT ST_Buffer( GEOGRAPHY( ST_POINT( lon, lat) ) , 1000 );\n```\n\n###\u30b9\u30c6\u30c3\u30d74 : KML\u306e\u30dd\u30ea\u30b4\u30f3\u30bf\u30b0\u3078\u5909\u63db\nST_AsKML\u3092\u7528\u3044\u3066\u3001geography\u578b\u304b\u3089kml\u306e\u30dd\u30ea\u30b4\u30f3\u5f62\u72b6\u306e\u5b9a\u7fa9\u90e8\u5206\u306e\u6587\u5b57\u5217\u3092\u51fa\u529b\u3057\u307e\u3059\u3002\n\n```sql:geography\u578b\u304b\u3089KML\u6587\u5b57\u5217\u3078\u5909\u63db\n SELECT ST_AsKML(ST_Buffer( GEOGRAPHY( ST_POINT( lon, lat) ) , 1000 ));\n```\n\n#PHP\u306b\u3088\u308bAPI\u5316\n\u7def\u5ea6\u7d4c\u5ea6\u3068\u534a\u5f84\u3092\u30d1\u30e9\u30e1\u30fc\u30bf\u3068\u3057\u3066\u53d6\u5f97\u3057\u3001\u52d5\u7684\u306b\u5186\u5f62\u306e\u30dd\u30ea\u30b4\u30f3\u3092\u51fa\u529b\u3059\u308bAPI\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n###\u5165\u529b\u30d1\u30e9\u30e1\u30fc\u30bf\n* lon : \u7d4c\u5ea6 \n* lat\uff1a\u7def\u5ea6 \n* r : \u534a\u5f84 \n* color : \u8272 ( \u03b1bgr )\n\u4eca\u56de\u306f\u5404\u5024\u306b\u30c7\u30d5\u30a9\u30eb\u30c8\u5024\u3092\u7528\u610f\u3057\u3066\u3001\u5165\u529b\u304c\u7121\u304f\u3066\u3082\u52d5\u4f5c\u3057\u307e\u3059\u3002 \n\n###URL\u4f8b\nhttp://\u30c9\u30e1\u30a4\u30f3\u540d/getcircle.php?lon=140.0&lat=36.6&r=300&440000ff\n\n\n\n```php:getcircle.php\n<?php\n//\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3078\u63a5\u7d9a\n$conn_string = \"host=localhost port=5432 dbname=database1 user=user1 password=*****\";\n$conn = pg_pconnect($conn_string);\nif (!$conn) {\n  echo \"An error occurred.\\n\";\n  exit;\n}\n\n//\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u53d6\u5f97\nif(isset($_GET['lon']) ){\n$lon = $_GET['lon'];\n} else {\n\t$lon=139.989136553437;\n}\nif(isset($_GET['lat']) ){\n$lat = $_GET['lat'];\n}else {\n\t$lat = 35.65945922265559;\n}\nif(isset($_GET['r']) ){\n$radius = $_GET['r'];\n}else {\n\t$radius = 1000;\n\t\n}\nif(isset($_GET['o']) ){\n$color = $_GET['o'];\n}else {\n $color =\"4cff7b00\";\n}\n\n//SQL\u306e\u4f5c\u6210\n$sql =\"SELECT ST_AsKML(ST_Buffer( GEOGRAPHY(ST_Point(\".$lon.\",\".$lat.\")) , \".$radius.\")) AS p ;\";\n//\u691c\u7d22\u5b9f\u884c\n$result = pg_query($conn, $sql);\nif (!$result) {\n  echo \"An error occurred.\\n\";\n  exit;\n}\n//\u691c\u7d22\u7d50\u679c\u306e\u53d6\u5f97\n$row = pg_fetch_row($result);\n\n//KML\u6587\u5b57\u5217\u306e\u53d6\u5f97\n$str = <<<EOD\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<kml xmlns=\"http://www.opengis.net/kml/2.2\" xmlns:gx=\"http://www.google.com/kml/ext/2.2\" xmlns:kml=\"http://www.opengis.net/kml/2.2\" xmlns:atom=\"http://www.w3.org/2005/Atom\">\n<Document>\n\t<name></name>\n\t<Style id=\"s\">\n\t\t<LineStyle>\n\t\t\t<color>{$color}</color>\n\t\t</LineStyle>\n\t\t<PolyStyle>\n\t\t\t<color>{$color}</color>\n\t\t</PolyStyle>\n\t</Style>\n\t<Placemark>\n\t\t<name>polygon</name>\n\t\t<styleUrl>#s</styleUrl>\n\t\t{$row[0]}\n\t</Placemark>\n</Document>\n</kml>\nEOD;\nheader('Content-Type: application/vnd.google-earth.kml+xml kml');\nheader('Content-Disposition: attachment; filename=\"mar.kml\"');\nprint $str;\n?>\n```\n"}