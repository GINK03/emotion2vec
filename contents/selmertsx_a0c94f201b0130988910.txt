{"context": "\n\n\u4eca\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\nrequire 'yaml'\n\ndef local_conf\n  conf = YAML.load_file('path_to_settings.local.yml')\n  conf['puma']\nend\n\ndirectory 'path_to_app_directory'\n\nworkers local_conf['workers']\nthreads_count = local_conf['threads']\nthreads threads_count, threads_count\nphased_restart = local_conf['phased_restart']\n\npreload_app! unless phased_restart\nprune_bundler if phased_restart\n\nrackup DefaultRackup\nport 3000\nworker_timeout local_conf['worker_timeout']\npidfile File.expand_path('tmp/pids/puma.pid')\nstate_path File.expand_path('tmp/pids/puma.state')\nstdout_redirect File.expand_path('log/puma_access.log'), File.expand_path('log/puma_error.log'), true\n\nbefore_fork do\n  ActiveRecord::Base.connection_pool.disconnect! unless phased_restart\nend\n\non_worker_boot do\n  unless phased_restart\n    ActiveSupport.on_load(:active_record) do\n      ActiveRecord::Base.establish_connection\n    end\n  end\nend\n\nplugin :tmp_restart\n\n\n\n\n5\u3064\u306e\u8a2d\u5b9a\u30dd\u30a4\u30f3\u30c8\n\nzero downtime\u3092\u5b9f\u73fe\u3059\u308b\u305f\u3081\u306e clustered mode\u8a2d\u5b9a\ndatabase connection poolings\nlogrotate\u8a2d\u5b9a\ncapistrano-puma\u306e\u8a2d\u5b9a\nprune_bundler\u306e\u8a2d\u5b9a\n\n\nzero downtime\u3092\u5b9f\u73fe\u3059\u308b\u305f\u3081\u306e clustered mode\npuma\u306b\u304a\u3044\u3066\u3001zero downtime\u3001 zero hanging request\u3092\u5b9f\u73fe\u3059\u308b\u305f\u3081\u306b\u306f\u3001\nclustered mode\u3092\u4f7f\u3046\u5fc5\u8981\u304c\u3042\u308b\u3002clustered mode\u306fworker\u6570\u3092\u6307\u5b9a\u3059\u308b\u3060\u3051\u3067\u8d77\u52d5\u3059\u308b\u3002\n\npuma.rb\n# clustered mode\u3092\u4f7f\u308f\u306a\u3044\u5834\u5408\u3001workers\u306f0\u3068\u3059\u308b\nworkers 2\nthreads_count = 5\nthreads threads_count, threads_count\n\n\nworker\u306e\u6570\u306fCPU\u306e\u30b3\u30a2\u6570\u3068\u4e00\u81f4\u3055\u305b\u308b\u3002\n\u306a\u304a\u30012 worker 5 thread\u3067\u304c\u3063\u3064\u308a\u8ca0\u8377\u3092\u304b\u3051\u305f\u3089\u30012GB\u4ee5\u4e0a\u306e\u30e1\u30e2\u30ea\u3092\u6d88\u8cbb\u3057\u305f\u3002\n\u5c11\u306a\u3044\u30e1\u30e2\u30ea\u3067 zero downtime\u3092\u5b9f\u73fe\u3057\u305f\u3044\u5834\u5408\u3001unicorn\u306e\u65b9\u304c\u9069\u3057\u3066\u3044\u308b\u304b\u3082\u77e5\u308c\u306a\u3044\u3002\n(\u3082\u3061\u308d\u3093\u3001\u5b9f\u884c\u3057\u3066\u3044\u308b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306b\u3088\u3063\u3066\u7570\u306a\u308b)\nhttps://github.com/puma/puma#clustered-mode\n\ndatabase connection pools\nActiveRecord\u306econnection\u306fworker\u6bce\u306b\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u3002\n\u305d\u306e\u305f\u3081database connection pools\u306e\u5024\u306b\u306f\u30011 worker\u3054\u3068\u306e thread\u6570\u3092\u8a2d\u5b9a\u3059\u308b\u3002\nrails \u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\u3001ENV['RAILS_MAX_THREADS']\u306b\u5024\u3092\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u304c\u30c7\u30d5\u30a9\u30eb\u30c8\u3068\u306a\u3063\u3066\u3044\u308b\u3002\n\nlogrotate\u8a2d\u5b9a\u306b\u3064\u3044\u3066\n\u203b Rails\u306eLogger\u306b\u3066\u3001rotate & \u524a\u9664\u3092\u3057\u3066\u3044\u308b\u4eba\u306f\u6c17\u306b\u3059\u308b\u5fc5\u8981\u304c\u7121\u3044\u3067\u3059.\nunicorn\u3068\u9055\u3044\u3001Puma\u306fsignal\u3092\u9001\u3063\u3066\u3082 puma\u81ea\u4f53\u306eLog\u306eRotate\u3057\u304b\u884c\u3044\u307e\u305b\u3093\u3002\n\u305d\u306e\u305f\u3081\u3001chrono_logger\u3092\u4f7f\u3046\u306a\u308a\u3001copytruncate\u3092\u5229\u7528\u3059\u308b\u306a\u308a\u3001\n\u4eca\u307e\u3067\u3068\u306f\u7570\u306a\u308b\u65b9\u6cd5\u3067 Logrotate\u3092\u884c\u3046\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\ncapistrano-puma\u306e\u8a2d\u5b9a\u306b\u3064\u3044\u3066\npuma_preload_app\u3092true\u306b\u3059\u308b\u3068\u3001phased-restart\u304c\u51fa\u6765\u306a\u3044\u3002\n\u306e\u3067\u3001cluster mode\u306e\u3068\u304d\u306f\u3001puma_preload_app\u3092false\u306b\u3057\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u3002\n#lib/capistrano/tasks/puma.rake\n  task :smart_restart do\n    if !puma_preload_app? && puma_workers.to_i > 1\n      invoke 'puma:phased-restart'\n    else\n      invoke 'puma:restart'\n    end\n  end\n\n\nPrune Bundler\u306e\u8a2d\u5b9a\n\u3053\u3053\u591a\u5206\u3044\u3061\u3070\u3093\u5927\u5207\u3002\nprune bundler \u306f cluster process\u304c\u8aad\u307f\u306b\u884c\u304f GEM_FILE\u3092\u6307\u5b9a\u3059\u308b\u3082\u306e\u3002\n\u3053\u308c\u3092\u3057\u306a\u3044\u3068\u3001Gemfile \u3092\u66f8\u304d\u63db\u3048\u3066\u3082\u8aad\u307f\u8fbc\u3093\u3067\u304f\u308c\u306a\u304f\u306a\u308b\u3057\u3001\u6b63\u3057\u304f current directory\u306b\n\u5b58\u5728\u3059\u308b Gemfile \u3092\u898b\u3066\u304f\u308c\u305a\u3001\u904e\u53bb\u306eGemfile\u304c\u53c2\u7167\u3067\u304d\u306a\u304f\u306a\u3063\u305f\u30bf\u30a4\u30df\u30f3\u30b0\u3067 puma \u306e\u30d7\u30ed\u30bb\u30b9\u304c\u843d\u3061\u3066\u3057\u307e\u3046\u3002\n# launcher.rb\n    def prune_bundler\n      return unless defined?(Bundler)\n      puma = Bundler.rubygems.loaded_specs(\"puma\")\n      dirs = puma.require_paths.map { |x| File.join(puma.full_gem_path, x) }\n      puma_lib_dir = dirs.detect { |x| File.exist? File.join(x, '../bin/puma-wild') }\n\n      unless puma_lib_dir\n        log \"! Unable to prune Bundler environment, continuing\"\n        return\n      end\n\n      deps = puma.runtime_dependencies.map do |d|\n        spec = Bundler.rubygems.loaded_specs(d.name)\n        \"#{d.name}:#{spec.version.to_s}\"\n      end\n\n      log '* Pruning Bundler environment'\n      home = ENV['GEM_HOME']\n      Bundler.with_clean_env do\n        ENV['GEM_HOME'] = home\n        ENV['PUMA_BUNDLER_PRUNED'] = '1'\n        wild = File.expand_path(File.join(puma_lib_dir, \"../bin/puma-wild\"))\n        args = [Gem.ruby, wild, '-I', dirs.join(':'), deps.join(',')] + @original_argv\n        Kernel.exec(*args)\n      end\n    end\n\n\u51e6\u7406\u306f\u3053\u3093\u306a\u611f\u3058\u3002\nBundler.with_clean_env \u306f BUNDLE_ \u306e\u74b0\u5883\u5909\u6570\u3092\u6d88\u3057\u3066 yield\u3092\u5b9f\u884c\u3059\u308b\u306e\u3067\u3001\n\u65b0\u3057\u3044Bundler\u3092\u8aad\u307f\u8fbc\u3082\u3046\u3068\u3057\u3066\u3044\u308b\u3053\u3068\u304c\u5206\u304b\u308b\u3002\n\u306a\u304a\u3001prune_bundler\u3092\u4f7f\u3044\u305f\u3044\u3068\u304d\u306f\u3001preload_app \u3092false\u306b\u3057\u3066\u3001\nworkers\u30922\u4ee5\u4e0a\u306b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n# launcher.rb\n    def prune_bundler?\n      @options[:prune_bundler] && clustered? && !@options[:preload_app]\n    end\n\n    def clustered?\n      (@options[:workers] || 0) > 0\n    end\n\n# \u78ba\u8a8d\u65b9\u6cd5 (by capistrano)\ncap staging puma:start\nDEBUG [xxxx]       * Pruning Bundler environment\nDEBUG [xxxx]       [xxxx] Puma starting in cluster mode...\n\n\u53c2\u8003\u8cc7\u6599:\nhttps://devcenter.heroku.com/articles/deploying-rails-applications-with-the-puma-web-server#database-connections\nhttps://devcenter.heroku.com/articles/concurrency-and-database-connections\nhttp://qiita.com/ma2ge/items/1fba78a08e8d3b82b3c2#logger--logrotate\nhttps://github.com/puma/puma/blob/master/DEPLOYMENT.md#restarting\n## \u4eca\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\n\n```ruby\nrequire 'yaml'\n\ndef local_conf\n  conf = YAML.load_file('path_to_settings.local.yml')\n  conf['puma']\nend\n\ndirectory 'path_to_app_directory'\n\nworkers local_conf['workers']\nthreads_count = local_conf['threads']\nthreads threads_count, threads_count\nphased_restart = local_conf['phased_restart']\n\npreload_app! unless phased_restart\nprune_bundler if phased_restart\n\nrackup DefaultRackup\nport 3000\nworker_timeout local_conf['worker_timeout']\npidfile File.expand_path('tmp/pids/puma.pid')\nstate_path File.expand_path('tmp/pids/puma.state')\nstdout_redirect File.expand_path('log/puma_access.log'), File.expand_path('log/puma_error.log'), true\n\nbefore_fork do\n  ActiveRecord::Base.connection_pool.disconnect! unless phased_restart\nend\n\non_worker_boot do\n  unless phased_restart\n    ActiveSupport.on_load(:active_record) do\n      ActiveRecord::Base.establish_connection\n    end\n  end\nend\n\nplugin :tmp_restart\n\n\n```\n\n## 5\u3064\u306e\u8a2d\u5b9a\u30dd\u30a4\u30f3\u30c8\n- zero downtime\u3092\u5b9f\u73fe\u3059\u308b\u305f\u3081\u306e clustered mode\u8a2d\u5b9a\n- database connection poolings\n- logrotate\u8a2d\u5b9a\n- capistrano-puma\u306e\u8a2d\u5b9a\n- prune_bundler\u306e\u8a2d\u5b9a\n\n## zero downtime\u3092\u5b9f\u73fe\u3059\u308b\u305f\u3081\u306e clustered mode\npuma\u306b\u304a\u3044\u3066\u3001zero downtime\u3001 zero hanging request\u3092\u5b9f\u73fe\u3059\u308b\u305f\u3081\u306b\u306f\u3001\nclustered mode\u3092\u4f7f\u3046\u5fc5\u8981\u304c\u3042\u308b\u3002clustered mode\u306fworker\u6570\u3092\u6307\u5b9a\u3059\u308b\u3060\u3051\u3067\u8d77\u52d5\u3059\u308b\u3002\n\n```puma.rb\n# clustered mode\u3092\u4f7f\u308f\u306a\u3044\u5834\u5408\u3001workers\u306f0\u3068\u3059\u308b\nworkers 2\nthreads_count = 5\nthreads threads_count, threads_count\n```\n\nworker\u306e\u6570\u306fCPU\u306e\u30b3\u30a2\u6570\u3068\u4e00\u81f4\u3055\u305b\u308b\u3002\n\n\u306a\u304a\u30012 worker 5 thread\u3067\u304c\u3063\u3064\u308a\u8ca0\u8377\u3092\u304b\u3051\u305f\u3089\u30012GB\u4ee5\u4e0a\u306e\u30e1\u30e2\u30ea\u3092\u6d88\u8cbb\u3057\u305f\u3002\n\u5c11\u306a\u3044\u30e1\u30e2\u30ea\u3067 zero downtime\u3092\u5b9f\u73fe\u3057\u305f\u3044\u5834\u5408\u3001unicorn\u306e\u65b9\u304c\u9069\u3057\u3066\u3044\u308b\u304b\u3082\u77e5\u308c\u306a\u3044\u3002\n(\u3082\u3061\u308d\u3093\u3001\u5b9f\u884c\u3057\u3066\u3044\u308b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306b\u3088\u3063\u3066\u7570\u306a\u308b)\n\nhttps://github.com/puma/puma#clustered-mode\n\n## database connection pools\n\nActiveRecord\u306econnection\u306fworker\u6bce\u306b\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u3002\n\u305d\u306e\u305f\u3081database connection pools\u306e\u5024\u306b\u306f\u30011 worker\u3054\u3068\u306e thread\u6570\u3092\u8a2d\u5b9a\u3059\u308b\u3002\nrails \u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\u3001ENV['RAILS_MAX_THREADS']\u306b\u5024\u3092\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u304c[\u30c7\u30d5\u30a9\u30eb\u30c8](https://github.com/rails/rails/pull/23057/files)\u3068\u306a\u3063\u3066\u3044\u308b\u3002\n\n## logrotate\u8a2d\u5b9a\u306b\u3064\u3044\u3066\n\u203b Rails\u306eLogger\u306b\u3066\u3001rotate & \u524a\u9664\u3092\u3057\u3066\u3044\u308b\u4eba\u306f\u6c17\u306b\u3059\u308b\u5fc5\u8981\u304c\u7121\u3044\u3067\u3059.\n\nunicorn\u3068\u9055\u3044\u3001Puma\u306fsignal\u3092\u9001\u3063\u3066\u3082 puma\u81ea\u4f53\u306eLog\u306eRotate\u3057\u304b\u884c\u3044\u307e\u305b\u3093\u3002\n\u305d\u306e\u305f\u3081\u3001chrono_logger\u3092\u4f7f\u3046\u306a\u308a\u3001copytruncate\u3092\u5229\u7528\u3059\u308b\u306a\u308a\u3001\n\u4eca\u307e\u3067\u3068\u306f\u7570\u306a\u308b\u65b9\u6cd5\u3067 Logrotate\u3092\u884c\u3046\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n## capistrano-puma\u306e\u8a2d\u5b9a\u306b\u3064\u3044\u3066\n\npuma_preload_app\u3092true\u306b\u3059\u308b\u3068\u3001phased-restart\u304c\u51fa\u6765\u306a\u3044\u3002\n\u306e\u3067\u3001cluster mode\u306e\u3068\u304d\u306f\u3001puma_preload_app\u3092false\u306b\u3057\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u3002\n\n```rb\n#lib/capistrano/tasks/puma.rake\n  task :smart_restart do\n    if !puma_preload_app? && puma_workers.to_i > 1\n      invoke 'puma:phased-restart'\n    else\n      invoke 'puma:restart'\n    end\n  end\n```\n\n## Prune Bundler\u306e\u8a2d\u5b9a\n\n\u3053\u3053\u591a\u5206\u3044\u3061\u3070\u3093\u5927\u5207\u3002\nprune bundler \u306f cluster process\u304c\u8aad\u307f\u306b\u884c\u304f GEM_FILE\u3092\u6307\u5b9a\u3059\u308b\u3082\u306e\u3002\n\u3053\u308c\u3092\u3057\u306a\u3044\u3068\u3001Gemfile \u3092\u66f8\u304d\u63db\u3048\u3066\u3082\u8aad\u307f\u8fbc\u3093\u3067\u304f\u308c\u306a\u304f\u306a\u308b\u3057\u3001\u6b63\u3057\u304f current directory\u306b\n\u5b58\u5728\u3059\u308b Gemfile \u3092\u898b\u3066\u304f\u308c\u305a\u3001\u904e\u53bb\u306eGemfile\u304c\u53c2\u7167\u3067\u304d\u306a\u304f\u306a\u3063\u305f\u30bf\u30a4\u30df\u30f3\u30b0\u3067 puma \u306e\u30d7\u30ed\u30bb\u30b9\u304c\u843d\u3061\u3066\u3057\u307e\u3046\u3002\n\n```ruby\n# launcher.rb\n    def prune_bundler\n      return unless defined?(Bundler)\n      puma = Bundler.rubygems.loaded_specs(\"puma\")\n      dirs = puma.require_paths.map { |x| File.join(puma.full_gem_path, x) }\n      puma_lib_dir = dirs.detect { |x| File.exist? File.join(x, '../bin/puma-wild') }\n\n      unless puma_lib_dir\n        log \"! Unable to prune Bundler environment, continuing\"\n        return\n      end\n\n      deps = puma.runtime_dependencies.map do |d|\n        spec = Bundler.rubygems.loaded_specs(d.name)\n        \"#{d.name}:#{spec.version.to_s}\"\n      end\n\n      log '* Pruning Bundler environment'\n      home = ENV['GEM_HOME']\n      Bundler.with_clean_env do\n        ENV['GEM_HOME'] = home\n        ENV['PUMA_BUNDLER_PRUNED'] = '1'\n        wild = File.expand_path(File.join(puma_lib_dir, \"../bin/puma-wild\"))\n        args = [Gem.ruby, wild, '-I', dirs.join(':'), deps.join(',')] + @original_argv\n        Kernel.exec(*args)\n      end\n    end\n```\n\u51e6\u7406\u306f\u3053\u3093\u306a\u611f\u3058\u3002\nBundler.with_clean_env \u306f BUNDLE_ \u306e\u74b0\u5883\u5909\u6570\u3092\u6d88\u3057\u3066 yield\u3092\u5b9f\u884c\u3059\u308b\u306e\u3067\u3001\n\u65b0\u3057\u3044Bundler\u3092\u8aad\u307f\u8fbc\u3082\u3046\u3068\u3057\u3066\u3044\u308b\u3053\u3068\u304c\u5206\u304b\u308b\u3002\n\n\u306a\u304a\u3001prune_bundler\u3092\u4f7f\u3044\u305f\u3044\u3068\u304d\u306f\u3001preload_app \u3092false\u306b\u3057\u3066\u3001\nworkers\u30922\u4ee5\u4e0a\u306b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\n```ruby\n# launcher.rb\n    def prune_bundler?\n      @options[:prune_bundler] && clustered? && !@options[:preload_app]\n    end\n\n    def clustered?\n      (@options[:workers] || 0) > 0\n    end\n```\n\n```\n# \u78ba\u8a8d\u65b9\u6cd5 (by capistrano)\ncap staging puma:start\nDEBUG [xxxx]       * Pruning Bundler environment\nDEBUG [xxxx]       [xxxx] Puma starting in cluster mode...\n```\n\n\u53c2\u8003\u8cc7\u6599:\nhttps://devcenter.heroku.com/articles/deploying-rails-applications-with-the-puma-web-server#database-connections\nhttps://devcenter.heroku.com/articles/concurrency-and-database-connections\nhttp://qiita.com/ma2ge/items/1fba78a08e8d3b82b3c2#logger--logrotate\nhttps://github.com/puma/puma/blob/master/DEPLOYMENT.md#restarting\n", "tags": ["puma", "Rails5", "Rails"]}