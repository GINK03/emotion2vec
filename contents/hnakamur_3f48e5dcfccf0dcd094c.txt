{"context": " More than 1 year has passed since last update.\n\nVCL\u30d5\u30a1\u30a4\u30eb\u3092C\u306b\u624b\u52d5\u3067\u5909\u63db\u3059\u308b\nvarnishd \u2014 Varnish version 4.1.0 documentation\u306e -C \u30aa\u30d7\u30b7\u30e7\u30f3\u306e\u8aac\u660e\u306b\u66f8\u304b\u308c\u3066\u3044\u308b\u3088\u3046\u306bVCL\u30d5\u30a1\u30a4\u30eb\u306fC\u306b\u5909\u63db\u3057\u3066\u30b3\u30f3\u30d1\u30a4\u30eb\u3055\u308c\u307e\u3059\u3002\n\u904b\u7528\u6642\u306fVarnish\u8d77\u52d5\u6642\u306b\u81ea\u52d5\u7684\u306bVCL\u30d5\u30a1\u30a4\u30eb\u3092C\u306b\u5909\u63db\u30fb\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u3066\u8aad\u307f\u8fbc\u3093\u3067\u304f\u308c\u308b\u306e\u3067\u7279\u306b\u6c17\u306b\u3059\u308b\u5fc5\u8981\u306f\u306a\u3044\u3067\u3059\u3002\n\u5909\u63db\u7d50\u679c\u306eC\u306e\u30bd\u30fc\u30b9\u30d5\u30a1\u30a4\u30eb\u3092\u898b\u305f\u3044\u5834\u5408\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u624b\u52d5\u3067\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u307e\u3059\u3002\nsudo varnishd -C -f ${VCL\u30d5\u30a1\u30a4\u30eb\u540d} > ${C\u30d5\u30a1\u30a4\u30eb\u540d} 2>&1\n\n\n\u4f8b1: \u30ea\u30af\u30a8\u30b9\u30c8\u3055\u308c\u305f\u30db\u30b9\u30c8\u540d\u306b\u5fdc\u3058\u3066\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3092\u5207\u308a\u66ff\u3048\u308bVCL\nBackends and virtual hosts in Varnish\u3067\u7d39\u4ecb\u3055\u308c\u3066\u3044\u307e\u3059\u3002\nvarnish-compiled-vcl-examples/virtualhost_backend.vcl at 9e0320d\nsub vcl_recv {\n    if (req.http.host ~ \"foo.com\") {\n        set req.backend_hint = foo;\n    } elsif (req.http.host ~ \"bar.com\") {\n        set req.backend_hint = bar;\n    }\n}\n\nC\u306b\u5909\u63db\u3057\u305f\u7d50\u679c\u306fvarnish-compiled-vcl-examples/virtualhost_backend.c at 9e0320d\u3067\u3059\u3002\nint __match_proto__(vcl_func_f)\nVGC_function_vcl_recv(VRT_CTX)\n{\n  /* ... from ('input' Line 13 Pos 5) */\n  {\n    {\n      VRT_count(ctx, 1);\n      if (\n        VRT_re_match(ctx, VRT_GetHdr(ctx, &VGC_HDR_REQ_host), VGC_re_2)\n      )\n        {\n          VRT_count(ctx, 2);\n          VRT_l_req_backend_hint(ctx, \n            vgc_backend_foo\n          );\n        }\n      else if (\n        VRT_re_match(ctx, VRT_GetHdr(ctx, &VGC_HDR_REQ_host), VGC_re_3)\n      )\n        {\n          VRT_count(ctx, 3);\n          VRT_l_req_backend_hint(ctx, \n            vgc_backend_bar\n          );\n        }\n...(snip)...\n\nVCL\u30d5\u30a1\u30a4\u30eb\u5185\u3067\u660e\u793a\u7684\u306breturn\u3057\u3066\u3044\u306a\u3044\u5834\u5408\u306f\u3001built-in\u306eVCL\u306e\u5185\u5bb9\u304c\u81ea\u5206\u306eVCL\u306e\u5f8c\u306b\u5dee\u3057\u8fbc\u307e\u308c\u307e\u3059\u3002\nbuilt-in\u306e vcl_recv \u306e\u5185\u5bb9\u306f\nvarnish-compiled-vcl-examples/builtin.vcl at 643ddc5\n# sub vcl_recv {\n#     if (req.method == \"PRI\") {\n#   /* We do not support SPDY or HTTP/2.0 */\n#   return (synth(405));\n#     }\n#     if (req.method != \"GET\" &&\n#       req.method != \"HEAD\" &&\n#       req.method != \"PUT\" &&\n#       req.method != \"POST\" &&\n#       req.method != \"TRACE\" &&\n#       req.method != \"OPTIONS\" &&\n#       req.method != \"DELETE\") {\n#         /* Non-RFC2616 or CONNECT which is weird. */\n#         return (pipe);\n#     }\n# \n#     if (req.method != \"GET\" && req.method != \"HEAD\") {\n#         /* We only deal with GET and HEAD by default */\n#         return (pass);\n#     }\n#     if (req.http.Authorization || req.http.Cookie) {\n#         /* Not cacheable by default */\n#         return (pass);\n#     }\n#     return (hash);\n# }\n\n\u3068\u306a\u3063\u3066\u3044\u3066\u3001C\u3078\u306e\u5909\u63db\u7d50\u679c\u306fvarnish-compiled-vcl-examples/virtualhost_backend.c at 9e0320d\u3068\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n  /* ... from ('Builtin' Line 47 Pos 5) */\n  {\n    {\n      VRT_count(ctx, 7);\n      if (\n        !VRT_strcmp(VRT_r_req_method(ctx), \"PRI\")\n      )\n        {\n          VRT_count(ctx, 8);\n          VRT_synth(ctx,\n            405\n            ,\n            (const char*)0\n          );\n          VRT_handling(ctx, VCL_RET_SYNTH);\n          return (1);\n        }\n      VRT_count(ctx, 9);\n      if (\n        (\n          VRT_strcmp(VRT_r_req_method(ctx), \"GET\")&&\n          VRT_strcmp(VRT_r_req_method(ctx), \"HEAD\")&&\n          VRT_strcmp(VRT_r_req_method(ctx), \"PUT\")&&\n          VRT_strcmp(VRT_r_req_method(ctx), \"POST\")&&\n          VRT_strcmp(VRT_r_req_method(ctx), \"TRACE\")&&\n          VRT_strcmp(VRT_r_req_method(ctx), \"OPTIONS\")&&\n          VRT_strcmp(VRT_r_req_method(ctx), \"DELETE\"))\n      )\n        {\n          VRT_count(ctx, 10);\n          VRT_handling(ctx, VCL_RET_PIPE);\n          return (1);\n        }\n      VRT_count(ctx, 11);\n      if (\n        (\n          VRT_strcmp(VRT_r_req_method(ctx), \"GET\")&&\n          VRT_strcmp(VRT_r_req_method(ctx), \"HEAD\"))\n      )\n        {\n          VRT_count(ctx, 12);\n          VRT_handling(ctx, VCL_RET_PASS);\n          return (1);\n        }\n      VRT_count(ctx, 13);\n      if (\n        (\n          (VRT_GetHdr(ctx, &VGC_HDR_REQ_Authorization) != 0)||\n          (VRT_GetHdr(ctx, &VGC_HDR_REQ_Cookie) != 0))\n      )\n        {\n          VRT_count(ctx, 14);\n          VRT_handling(ctx, VCL_RET_PASS);\n          return (1);\n        }\n      VRT_count(ctx, 15);\n      VRT_handling(ctx, VCL_RET_HASH);\n      return (1);\n    }\n  }\n}\n\nVCL\u3067\u306e return \u306fC\u3067\u306f VRT_handling \u95a2\u6570\u547c\u3073\u51fa\u3057\u306b\u5909\u63db\u3055\u308c\u308b\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3059\u3002\n\n\u4f8b2: \u30ea\u30af\u30a8\u30b9\u30c8\u3055\u308c\u305f\u30db\u30b9\u30c8\u540d\u306b\u5fdc\u3058\u3066\u30b9\u30c8\u30ec\u30fc\u30b8\u3092\u5207\u308a\u66ff\u3048\u308bVCL\nPartitioning your Varnish Cache\u3067\u7d39\u4ecb\u3055\u308c\u3066\u3044\u307e\u3059\u3002\nvarnish-compiled-vcl-examples/partition_storage.vcl at 643ddc5\nsub vcl_backend_response {\n    if (bereq.http.host ~ \"foo\") {\n        set beresp.storage_hint = \"foo\";\n        set beresp.http.x-storage = \"foo\";\n    } else if (bereq.http.host ~ \"bar\") {\n        set beresp.storage_hint = \"bar\";\n        set beresp.http.x-storage = \"bar\";\n    } else {\n        set beresp.storage_hint = \"default\";\n        set beresp.http.x-storage = \"default\";\n    }\n}\n\nC\u306b\u5909\u63db\u3057\u305f\u7d50\u679c\u306fvarnish-compiled-vcl-examples/partition_storage.c at 643ddc5\u3067\u3059\u3002\nint __match_proto__(vcl_func_f)\nVGC_function_vcl_backend_response(VRT_CTX)\n{\n  /* ... from ('input' Line 12 Pos 5) */\n  {\n    {\n      VRT_count(ctx, 2);\n      if (\n        VRT_re_match(ctx, VRT_GetHdr(ctx, &VGC_HDR_BEREQ_host), VGC_re_1)\n      )\n        {\n          VRT_count(ctx, 3);\n          VRT_l_beresp_storage_hint(ctx, \n            \"foo\",\n              vrt_magic_string_end\n          );\n          VRT_SetHdr(ctx, &VGC_HDR_BERESP_x_2d_storage,\n            \"foo\",\n              vrt_magic_string_end\n          );\n        }\n      else if (\n        VRT_re_match(ctx, VRT_GetHdr(ctx, &VGC_HDR_BEREQ_host), VGC_re_2)\n      )\n        {\n          VRT_count(ctx, 4);\n          VRT_l_beresp_storage_hint(ctx, \n            \"bar\",\n              vrt_magic_string_end\n          );\n          VRT_SetHdr(ctx, &VGC_HDR_BERESP_x_2d_storage,\n            \"bar\",\n              vrt_magic_string_end\n          );\n        }\n      else\n        {\n          VRT_count(ctx, 5);\n          VRT_l_beresp_storage_hint(ctx, \n            \"default\",\n              vrt_magic_string_end\n          );\n          VRT_SetHdr(ctx, &VGC_HDR_BERESP_x_2d_storage,\n            \"default\",\n              vrt_magic_string_end\n          );\n        }\n    }\n  }\n...(snip)...\n\n\u3053\u3061\u3089\u3082 vcl_backend_response \u5185\u306b return \u3092\u66f8\u3044\u3066\u3044\u306a\u3044\u306e\u3067\u3001\u3053\u306e\u5f8c\u306bbuilt-in\u306e vcl_backend_response \u306e\u5185\u5bb9\u304c\u5dee\u3057\u8fbc\u307e\u308c\u307e\u3059\u3002\nvarnish-compiled-vcl-examples/builtin.vcl at 643ddc5\n# sub vcl_backend_response {\n#     if (beresp.ttl <= 0s ||\n#       beresp.http.Set-Cookie ||\n#       beresp.http.Surrogate-control ~ \"no-store\" ||\n#       (!beresp.http.Surrogate-Control &&\n#         beresp.http.Cache-Control ~ \"no-cache|no-store|private\") ||\n#       beresp.http.Vary == \"*\") {\n#         /*\n#         * Mark as \"Hit-For-Pass\" for the next 2 minutes\n#         */\n#         set beresp.ttl = 120s;\n#         set beresp.uncacheable = true;\n#     }\n#     return (deliver);\n# }\n\nC\u3078\u306e\u5909\u63db\u7d50\u679c\u306fvarnish-compiled-vcl-examples/partition_storage.c at 643ddc5\u3067\u3059\u3002\n  /* ... from ('Builtin' Line 154 Pos 5) */\n  {\n    {\n      VRT_count(ctx, 31);\n      if (\n        (\n          (VRT_r_beresp_ttl(ctx) <= 0)||\n          (VRT_GetHdr(ctx, &VGC_HDR_BERESP_Set_2d_Cookie) != 0)||\n          VRT_re_match(ctx, VRT_GetHdr(ctx, &VGC_HDR_BERESP_Surrogate_2d_control), VGC_re_3)||\n          ((\n            !((VRT_GetHdr(ctx, &VGC_HDR_BERESP_Surrogate_2d_Control) != 0))&&\n            VRT_re_match(ctx, VRT_GetHdr(ctx, &VGC_HDR_BERESP_Cache_2d_Control), VGC_re_4)))||\n          !VRT_strcmp(VRT_GetHdr(ctx, &VGC_HDR_BERESP_Vary), \"*\"))\n      )\n        {\n          VRT_count(ctx, 32);\n          VRT_l_beresp_ttl(ctx, \n            120\n          );\n          VRT_l_beresp_uncacheable(ctx, \n            (0==0)\n          );\n        }\n      VRT_count(ctx, 33);\n      VRT_handling(ctx, VCL_RET_DELIVER);\n      return (1);\n    }\n  }\n}\n\n## VCL\u30d5\u30a1\u30a4\u30eb\u3092C\u306b\u624b\u52d5\u3067\u5909\u63db\u3059\u308b\n\n[varnishd \u2014 Varnish version 4.1.0 documentation](https://www.varnish-cache.org/docs/4.1/reference/varnishd.html)\u306e `-C` \u30aa\u30d7\u30b7\u30e7\u30f3\u306e\u8aac\u660e\u306b\u66f8\u304b\u308c\u3066\u3044\u308b\u3088\u3046\u306bVCL\u30d5\u30a1\u30a4\u30eb\u306fC\u306b\u5909\u63db\u3057\u3066\u30b3\u30f3\u30d1\u30a4\u30eb\u3055\u308c\u307e\u3059\u3002\n\n\u904b\u7528\u6642\u306fVarnish\u8d77\u52d5\u6642\u306b\u81ea\u52d5\u7684\u306bVCL\u30d5\u30a1\u30a4\u30eb\u3092C\u306b\u5909\u63db\u30fb\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u3066\u8aad\u307f\u8fbc\u3093\u3067\u304f\u308c\u308b\u306e\u3067\u7279\u306b\u6c17\u306b\u3059\u308b\u5fc5\u8981\u306f\u306a\u3044\u3067\u3059\u3002\n\n\u5909\u63db\u7d50\u679c\u306eC\u306e\u30bd\u30fc\u30b9\u30d5\u30a1\u30a4\u30eb\u3092\u898b\u305f\u3044\u5834\u5408\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u624b\u52d5\u3067\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u307e\u3059\u3002\n\n```shell-session\nsudo varnishd -C -f ${VCL\u30d5\u30a1\u30a4\u30eb\u540d} > ${C\u30d5\u30a1\u30a4\u30eb\u540d} 2>&1\n```\n\n## \u4f8b1: \u30ea\u30af\u30a8\u30b9\u30c8\u3055\u308c\u305f\u30db\u30b9\u30c8\u540d\u306b\u5fdc\u3058\u3066\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3092\u5207\u308a\u66ff\u3048\u308bVCL\n\n[Backends and virtual hosts in Varnish](https://www.varnish-cache.org/docs/trunk/users-guide/vcl-backends.html#backends-and-virtual-hosts-in-varnish)\u3067\u7d39\u4ecb\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n[varnish-compiled-vcl-examples/virtualhost_backend.vcl at 9e0320d](https://github.com/hnakamur/varnish-compiled-vcl-examples/blob/9e0320d876212c0b259ecb9efe976abdded910b3/virtualhost_backend.vcl#L13-L19)\n\n```\nsub vcl_recv {\n    if (req.http.host ~ \"foo.com\") {\n        set req.backend_hint = foo;\n    } elsif (req.http.host ~ \"bar.com\") {\n        set req.backend_hint = bar;\n    }\n}\n```\n\nC\u306b\u5909\u63db\u3057\u305f\u7d50\u679c\u306f[varnish-compiled-vcl-examples/virtualhost_backend.c at 9e0320d](https://github.com/hnakamur/varnish-compiled-vcl-examples/blob/9e0320d876212c0b259ecb9efe976abdded910b3/virtualhost_backend.c#L1402-L1426)\u3067\u3059\u3002\n\n```c\nint __match_proto__(vcl_func_f)\nVGC_function_vcl_recv(VRT_CTX)\n{\n  /* ... from ('input' Line 13 Pos 5) */\n  {\n    {\n      VRT_count(ctx, 1);\n      if (\n        VRT_re_match(ctx, VRT_GetHdr(ctx, &VGC_HDR_REQ_host), VGC_re_2)\n      )\n        {\n          VRT_count(ctx, 2);\n          VRT_l_req_backend_hint(ctx, \n            vgc_backend_foo\n          );\n        }\n      else if (\n        VRT_re_match(ctx, VRT_GetHdr(ctx, &VGC_HDR_REQ_host), VGC_re_3)\n      )\n        {\n          VRT_count(ctx, 3);\n          VRT_l_req_backend_hint(ctx, \n            vgc_backend_bar\n          );\n        }\n...(snip)...\n```\n\nVCL\u30d5\u30a1\u30a4\u30eb\u5185\u3067\u660e\u793a\u7684\u306breturn\u3057\u3066\u3044\u306a\u3044\u5834\u5408\u306f\u3001built-in\u306eVCL\u306e\u5185\u5bb9\u304c\u81ea\u5206\u306eVCL\u306e\u5f8c\u306b\u5dee\u3057\u8fbc\u307e\u308c\u307e\u3059\u3002\n\nbuilt-in\u306e `vcl_recv` \u306e\u5185\u5bb9\u306f\n[varnish-compiled-vcl-examples/builtin.vcl at 643ddc5](https://github.com/hnakamur/varnish-compiled-vcl-examples/blob/643ddc5e322d4309d7f443b68deb337fe95e24a3/builtin.vcl#L6-L31)\n\n```\n# sub vcl_recv {\n#     if (req.method == \"PRI\") {\n# \t/* We do not support SPDY or HTTP/2.0 */\n# \treturn (synth(405));\n#     }\n#     if (req.method != \"GET\" &&\n#       req.method != \"HEAD\" &&\n#       req.method != \"PUT\" &&\n#       req.method != \"POST\" &&\n#       req.method != \"TRACE\" &&\n#       req.method != \"OPTIONS\" &&\n#       req.method != \"DELETE\") {\n#         /* Non-RFC2616 or CONNECT which is weird. */\n#         return (pipe);\n#     }\n# \n#     if (req.method != \"GET\" && req.method != \"HEAD\") {\n#         /* We only deal with GET and HEAD by default */\n#         return (pass);\n#     }\n#     if (req.http.Authorization || req.http.Cookie) {\n#         /* Not cacheable by default */\n#         return (pass);\n#     }\n#     return (hash);\n# }\n```\n\n\u3068\u306a\u3063\u3066\u3044\u3066\u3001C\u3078\u306e\u5909\u63db\u7d50\u679c\u306f[varnish-compiled-vcl-examples/virtualhost_backend.c at 9e0320d](https://github.com/hnakamur/varnish-compiled-vcl-examples/blob/9e0320d876212c0b259ecb9efe976abdded910b3/virtualhost_backend.c#L1430-L1490)\u3068\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n```c\n  /* ... from ('Builtin' Line 47 Pos 5) */\n  {\n    {\n      VRT_count(ctx, 7);\n      if (\n        !VRT_strcmp(VRT_r_req_method(ctx), \"PRI\")\n      )\n        {\n          VRT_count(ctx, 8);\n          VRT_synth(ctx,\n            405\n            ,\n            (const char*)0\n          );\n          VRT_handling(ctx, VCL_RET_SYNTH);\n          return (1);\n        }\n      VRT_count(ctx, 9);\n      if (\n        (\n          VRT_strcmp(VRT_r_req_method(ctx), \"GET\")&&\n          VRT_strcmp(VRT_r_req_method(ctx), \"HEAD\")&&\n          VRT_strcmp(VRT_r_req_method(ctx), \"PUT\")&&\n          VRT_strcmp(VRT_r_req_method(ctx), \"POST\")&&\n          VRT_strcmp(VRT_r_req_method(ctx), \"TRACE\")&&\n          VRT_strcmp(VRT_r_req_method(ctx), \"OPTIONS\")&&\n          VRT_strcmp(VRT_r_req_method(ctx), \"DELETE\"))\n      )\n        {\n          VRT_count(ctx, 10);\n          VRT_handling(ctx, VCL_RET_PIPE);\n          return (1);\n        }\n      VRT_count(ctx, 11);\n      if (\n        (\n          VRT_strcmp(VRT_r_req_method(ctx), \"GET\")&&\n          VRT_strcmp(VRT_r_req_method(ctx), \"HEAD\"))\n      )\n        {\n          VRT_count(ctx, 12);\n          VRT_handling(ctx, VCL_RET_PASS);\n          return (1);\n        }\n      VRT_count(ctx, 13);\n      if (\n        (\n          (VRT_GetHdr(ctx, &VGC_HDR_REQ_Authorization) != 0)||\n          (VRT_GetHdr(ctx, &VGC_HDR_REQ_Cookie) != 0))\n      )\n        {\n          VRT_count(ctx, 14);\n          VRT_handling(ctx, VCL_RET_PASS);\n          return (1);\n        }\n      VRT_count(ctx, 15);\n      VRT_handling(ctx, VCL_RET_HASH);\n      return (1);\n    }\n  }\n}\n```\n\nVCL\u3067\u306e `return` \u306fC\u3067\u306f `VRT_handling` \u95a2\u6570\u547c\u3073\u51fa\u3057\u306b\u5909\u63db\u3055\u308c\u308b\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3059\u3002\n\n## \u4f8b2: \u30ea\u30af\u30a8\u30b9\u30c8\u3055\u308c\u305f\u30db\u30b9\u30c8\u540d\u306b\u5fdc\u3058\u3066\u30b9\u30c8\u30ec\u30fc\u30b8\u3092\u5207\u308a\u66ff\u3048\u308bVCL\n\n[Partitioning your Varnish Cache](http://info.varnish-software.com/blog/partitioning-your-varnish-cache)\u3067\u7d39\u4ecb\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n[varnish-compiled-vcl-examples/partition_storage.vcl at 643ddc5](https://github.com/hnakamur/varnish-compiled-vcl-examples/blob/643ddc5e322d4309d7f443b68deb337fe95e24a3/partition_storage.vcl#L12-L23)\n\n```\nsub vcl_backend_response {\n    if (bereq.http.host ~ \"foo\") {\n        set beresp.storage_hint = \"foo\";\n        set beresp.http.x-storage = \"foo\";\n    } else if (bereq.http.host ~ \"bar\") {\n        set beresp.storage_hint = \"bar\";\n        set beresp.http.x-storage = \"bar\";\n    } else {\n        set beresp.storage_hint = \"default\";\n        set beresp.http.x-storage = \"default\";\n    }\n}\n```\n\nC\u306b\u5909\u63db\u3057\u305f\u7d50\u679c\u306f[varnish-compiled-vcl-examples/partition_storage.c at 643ddc5](https://github.com/hnakamur/varnish-compiled-vcl-examples/blob/643ddc5e322d4309d7f443b68deb337fe95e24a3/partition_storage.c#L1181-L1229)\u3067\u3059\u3002\n\n```c\nint __match_proto__(vcl_func_f)\nVGC_function_vcl_backend_response(VRT_CTX)\n{\n  /* ... from ('input' Line 12 Pos 5) */\n  {\n    {\n      VRT_count(ctx, 2);\n      if (\n        VRT_re_match(ctx, VRT_GetHdr(ctx, &VGC_HDR_BEREQ_host), VGC_re_1)\n      )\n        {\n          VRT_count(ctx, 3);\n          VRT_l_beresp_storage_hint(ctx, \n            \"foo\",\n              vrt_magic_string_end\n          );\n          VRT_SetHdr(ctx, &VGC_HDR_BERESP_x_2d_storage,\n            \"foo\",\n              vrt_magic_string_end\n          );\n        }\n      else if (\n        VRT_re_match(ctx, VRT_GetHdr(ctx, &VGC_HDR_BEREQ_host), VGC_re_2)\n      )\n        {\n          VRT_count(ctx, 4);\n          VRT_l_beresp_storage_hint(ctx, \n            \"bar\",\n              vrt_magic_string_end\n          );\n          VRT_SetHdr(ctx, &VGC_HDR_BERESP_x_2d_storage,\n            \"bar\",\n              vrt_magic_string_end\n          );\n        }\n      else\n        {\n          VRT_count(ctx, 5);\n          VRT_l_beresp_storage_hint(ctx, \n            \"default\",\n              vrt_magic_string_end\n          );\n          VRT_SetHdr(ctx, &VGC_HDR_BERESP_x_2d_storage,\n            \"default\",\n              vrt_magic_string_end\n          );\n        }\n    }\n  }\n...(snip)...\n```\n\n\u3053\u3061\u3089\u3082 `vcl_backend_response` \u5185\u306b `return` \u3092\u66f8\u3044\u3066\u3044\u306a\u3044\u306e\u3067\u3001\u3053\u306e\u5f8c\u306bbuilt-in\u306e `vcl_backend_response` \u306e\u5185\u5bb9\u304c\u5dee\u3057\u8fbc\u307e\u308c\u307e\u3059\u3002\n\n[varnish-compiled-vcl-examples/builtin.vcl at 643ddc5](https://github.com/hnakamur/varnish-compiled-vcl-examples/blob/643ddc5e322d4309d7f443b68deb337fe95e24a3/builtin.vcl#L113-L127)\n\n```\n# sub vcl_backend_response {\n#     if (beresp.ttl <= 0s ||\n#       beresp.http.Set-Cookie ||\n#       beresp.http.Surrogate-control ~ \"no-store\" ||\n#       (!beresp.http.Surrogate-Control &&\n#         beresp.http.Cache-Control ~ \"no-cache|no-store|private\") ||\n#       beresp.http.Vary == \"*\") {\n#         /*\n#         * Mark as \"Hit-For-Pass\" for the next 2 minutes\n#         */\n#         set beresp.ttl = 120s;\n#         set beresp.uncacheable = true;\n#     }\n#     return (deliver);\n# }\n```\n\nC\u3078\u306e\u5909\u63db\u7d50\u679c\u306f[varnish-compiled-vcl-examples/partition_storage.c at 643ddc5](https://github.com/hnakamur/varnish-compiled-vcl-examples/blob/643ddc5e322d4309d7f443b68deb337fe95e24a3/partition_storage.c#L1230-L1258)\u3067\u3059\u3002\n\n```c\n  /* ... from ('Builtin' Line 154 Pos 5) */\n  {\n    {\n      VRT_count(ctx, 31);\n      if (\n        (\n          (VRT_r_beresp_ttl(ctx) <= 0)||\n          (VRT_GetHdr(ctx, &VGC_HDR_BERESP_Set_2d_Cookie) != 0)||\n          VRT_re_match(ctx, VRT_GetHdr(ctx, &VGC_HDR_BERESP_Surrogate_2d_control), VGC_re_3)||\n          ((\n            !((VRT_GetHdr(ctx, &VGC_HDR_BERESP_Surrogate_2d_Control) != 0))&&\n            VRT_re_match(ctx, VRT_GetHdr(ctx, &VGC_HDR_BERESP_Cache_2d_Control), VGC_re_4)))||\n          !VRT_strcmp(VRT_GetHdr(ctx, &VGC_HDR_BERESP_Vary), \"*\"))\n      )\n        {\n          VRT_count(ctx, 32);\n          VRT_l_beresp_ttl(ctx, \n            120\n          );\n          VRT_l_beresp_uncacheable(ctx, \n            (0==0)\n          );\n        }\n      VRT_count(ctx, 33);\n      VRT_handling(ctx, VCL_RET_DELIVER);\n      return (1);\n    }\n  }\n}\n```\n", "tags": ["Varnish"]}