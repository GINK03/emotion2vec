{"context": " More than 1 year has passed since last update.English translation follows Japanese paragraph\nSmartOS\u3092VMware Player\u3067\u52d5\u304b\u3059\u3067\u7c21\u5358\u306b\u7d39\u4ecb\u3057\u3066\u3044\u307e\u3059\u3088\u3046\u306b\u3001SmartOS\u306f\u3001ZFS + DTrace + Zones \u305d\u3057\u3066\u3001\u306a\u3093\u3068 Solaris\u7cfb\u306b\u3082\u304b\u304b\u308f\u3089\u305aKVM\u3084Docker\u304c\u4f7f\u3048\u308b\u30aa\u30fc\u30d7\u30f3\u30bd\u30fc\u30b9OS\u3067\u3059\u3002Sun Microsystems(\u73fe\u5728\u306eOracle)\u304c\u30aa\u30fc\u30d7\u30f3\u30bd\u30fc\u30b9\u5316\u3057\u3066\u3044\u305f Open Solaris\u304b\u3089\u6d3e\u751f\u3057\u305fillumos\u306e\u30ab\u30fc\u30cd\u30eb\u3092\u4f7f\u3063\u305fOS\u3067\u3059\uff08SmartOS\u3067\u904a\u3093\u3058\u3083\u3046\uff1f\u3067\u7c21\u5358\u306bSmartOS\u3092\u7d39\u4ecb\u3057\u3066\u3044\u307e\u3059\uff09\u3002\nSmartOS is an Open Source virtualizaton platform and operating system in which you can use its native container, Linux container, KVM virtual machine and Docker(with open source SmartDatacenter).SmartOS is a distribution of illumos OS which is derived from Open Solaris Sun Microsystems(now Oracle) had open-sourced.ZFS is used as a storage infrastructure underneath SmartOS's virtualization functions and you can use DTrace to investigate kernel and your application's performance and other problems.\nSmartOS\u306f\u4eee\u60f3\u5316\u30c6\u30af\u30ce\u30ed\u30b8\u3068\u3057\u3066\u4ee5\u4e0b\u306e\u6a5f\u80fd\u3092\u6301\u3063\u3066\u3044\u307e\u3059\u3002\n\nSmartOS\u306b\u3088\u308bOS\u4eee\u60f3\u5316\uff08\u30b3\u30f3\u30c6\u30ca\uff09\uff1a\n\n\nSmartOS\u306eZone(SmartMachine)\nLinux\u306eZone\uff08LX Branded Zone\uff09\n\n\nSmartOS\u7d44\u307f\u8fbc\u307f\u306e\u30cf\u30a4\u30d1\u30fc\u30d0\u30a4\u30b6\u30d9\u30fc\u30b9\u306e\u4eee\u60f3\u5316\n\n\nKVM\n\n\n\nSmartOS supports the following virtualization technologies.\n\nOS Virtualizaion aka Container\n\n\nSmartOS's native Zone(aka SmartMachine) \nLinux Zone(LX Branded Zone)\n\n\nHardware virtualization based on Hypervior\n\n\nKVM\n\n\n\n\u3053\u3053\u3067\u306f\u3001SmartOS\u306eKVM\u4e0a\u3067CentOS7(7.1.1503)\u3092\u52d5\u304b\u3057\u3066\u307f\u307e\u3059\u3002\nIn this article we will explore KVM virtual machine on SmartOS and you can see how you can  deploy CentOS7(7.1.1503) on SmartOS as a KVM virtual machine.\nSmartOS\u306eKVM\u306f\u3001zfs\u306esnapshot(clone)\u6a5f\u80fd\u3092\u5229\u7528\u3057\u3066template\u3068\u306a\u308bVM image\u304b\u3089\u9ad8\u901f\u306b\u65b0\u3057\u3044VM\u3092\u751f\u6210\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\u4ee5\u4e0b\u306e\u4f8b\u3067\u306f\u5b9f\u969b\u306bCentOS\u306eVM\u3092\u4f5c\u308b\u30b3\u30de\u30f3\u30c9\uff08vmadm create\uff09\u306e\u5b9f\u884c\u6642\u9593\u306f\u3001\u6570\u79d2\u3067\u3057\u305f\u3002\u4f7f\u3044\u6368\u3066\u306eVM\u74b0\u5883\u3092\u983b\u7e41\u306b\u4f5c\u6210\u3059\u308b\u5834\u5408\u306b\u306f\u3001vagrant\u4ee5\u4e0a\u306b\u5f37\u529b\u306a\u89e3\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002VPS\u306e\u3088\u3046\u306a\u30b5\u30fc\u30d3\u30b9\u306b\u3082\u5411\u3044\u3066\u3044\u305d\u3046\u3067\u3059\u3002\nKVM VM on SmartOS can be created by vmadm create command.This command will create a zfs snapshot of an existing VM image and then create a zfs clone from this snapshot.ZFS snapshot and clone are just metadata operation until you change data of new VM.So this command will complete less than 10 seconds typically.\n\nSmartOS\u306eGlobal Zone\uff08\u5927\u57df\u30be\u30fc\u30f3\uff09\u3092\u7528\u610f\u3059\u308b(Prepare SmartOS Global Zone)\nSmartOS\u3092VMware Player\u3067\u52d5\u304b\u3059\u306e\u624b\u9806\u3067VMware Player\u4e0a\u306bGlobal Zone\u3092\u7528\u610f\u3057\u307e\u3059\u3002\u3082\u3061\u308d\u3093\u3001\u30d9\u30a2\u30e1\u30bf\u30eb\u4e0a\u3067\u3082OK\u3067\u3059\uff08SmartOS\u7528\u306b\u5c02\u7528\u3067\u4f7f\u3048\u308b\u30cf\u30fc\u30c9\u30c7\u30a3\u30b9\u30af\u304c\u4f59\u3063\u3066\u3044\u308c\u3070\u3001\u3080\u3057\u308d\u30d9\u30a2\u30e1\u30bf\u30eb\u306e\u65b9\u304c\u7c21\u5358\u3067\u3059\uff09\u3002\u305f\u3060\u3057\u3001Hyper-V\u3084VirtualBox\u306e\u3088\u3046\u306a Nested Virtualization\u306b\u5bfe\u5fdc\u3057\u3066\u3044\u306a\u3044\u30cf\u30a4\u30d1\u30fc\u30d0\u30a4\u30b6\u4e0a\u3067\u306f\u3001KVM\u306f\u4f7f\u7528\u3067\u304d\u307e\u305b\u3093\u3002Linux KVM\u306f\u3001Nested Virtualization\u306b\u5bfe\u5fdc\u3057\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u306e\u3067\u5927\u4e08\u592b\u305d\u3046\u3067\u3059\u304c\u8a66\u3057\u3066\u3044\u307e\u305b\u3093\uff08VMware\u306f\u3001Virtualized VM\u3068\u3044\u3046\u5f62\u3067\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u7684\u306bNested Virtualization\u306b\u5bfe\u5fdc\u3057\u3066\u3044\u307e\u3059\u3002Intel Haswell CPU\u306f\u3001VMCS shadowing\u3068\u3044\u3046Nested Virtualization\u3092\u30cf\u30fc\u30c9\u30a6\u30a7\u30a2\u3067\u652f\u63f4\u3059\u308b\u6a5f\u80fd\u3092\u6301\u3063\u3066\u3044\u307e\u3059\u306e\u3067\u3001\u5404\u30cf\u30a4\u30d1\u30fc\u30d0\u30a4\u30b6\u30fc\u304c\u65e9\u304f\u5bfe\u5fdc\u3057\u3066\u304f\u308c\u308b\u3068\u5b09\u3057\u3044\u306e\u3067\u3059\u304c\u3002\u3002\u3002\u5bfe\u5fdc\u3057\u3066\u3044\u308b\u3082\u306e\u306f\u3042\u308b\u306e\u3067\u3057\u3087\u3046\u304b\uff1f\uff09\u3002\nBefore deploying KVM VM,you need to prepare SmartOS itself aka Global Zone on your physical machine or virtual machine.If you have extra disk drives it is easy to setup your SmartOS.If you don't have extra drive you can use VMware Player or workstation or Fusion since VMware supports nested virtualization by software.In my last article(Japanese),I used VMware Player.If you are a Mac user you can find step by step guide in the official document \"SmartOS as a VMware Guest:VMware Fusion\".\nIt seems like that KVM also support nested virtualization,so you may be able to use KVM.Virtual Box does not support netsted virtualization and AFAIK there is no plan to support it,so you can not use Virtual Box for KVM on SmartOS.Though Intel Haswell introduced VMCS shadowing which assists netsted virtualization by hardware,AFAIK there is no hypervisor which exploits this new technology yet.Though Virtual Box cannot be used for KVM VM on SmartOS setup,you can use it for OS virtualization like SmartOS Zone and Linux container(LX Braded Zone) since these technology doesn't need hardware assistance like VT-x(Oracle Solaris's new zone type \"kernel zone\" needs hardware assistance,so Oracle's VBox also cannot be used to test Oracle Solaris's kernel zone.Though \"kernel zone\" can be considered as hardware virtulization becasuse each zone have its own kernel, it supports solaris only.You can use Oracle Solaris's native zone on VBox).\n\u306a\u304a\u3001SmartOS\u3092VMware Player\u3067\u52d5\u304b\u3059\u306e\u624b\u9806\u3067\u306f\u3001SmartOS\u306b\u306f\u30011GB\u306e\u30e1\u30e2\u30ea\u30681\u3064\u306e\u30d7\u30ed\u30bb\u30c3\u30b5\u30b3\u30a2\u3092\u5272\u308a\u5f53\u3066\u3066\u3044\u307e\u3059\u3002\u3053\u306e\u307e\u307e\u3067\u3059\u3068KVM VM\u306e\u4f5c\u6210\u4e2d\u306b SmartOS\u81ea\u4f53\u304c\u30cf\u30f3\u30b0\u3057\u307e\u3059\u3002\u30e1\u30e2\u30ea\u30922GB\u4ee5\u4e0a\u3001\u30d7\u30ed\u30bb\u30c3\u30b5\u30922\u500b\u4ee5\u4e0a\u306b\u5909\u66f4\u3057\u3066\u304a\u304d\u307e\u3059\u3002\nIn my last article(Japanese) I assigned only 1GB memory and 1 processor to VM(SmartOS).When you try to create KVM VM with this configuration,SmartOS might be hang.So before deploying KVM VM you may want to increase memory and processor assignment for your SmartOS setup.\n\n\nCentOS7\u306eKVM VM image\u3092 import \u3059\u308b(Import CentOS KVM image)\n\nGlobal Zone\u306b\u30ed\u30b0\u30a4\u30f3(Login Global Zone)\nVMware Player\u306e\u30b3\u30f3\u30bd\u30fc\u30eb\u30d3\u30e5\u30fc\u3067\u3001SmartOS\uff08\u306eGlobal Zone\uff09\u3078root\u3067\u30ed\u30b0\u30a4\u30f3\u3057\u307e\u3059\u3002ssh\u3067\u5165\u308a\u305f\u3044\u5834\u5408\u306f\u3001\u30b3\u30f3\u30bd\u30fc\u30eb\u30d3\u30e5\u30fc\u3067ifconfig -a \u3057\u3066 ip address \u3092\u78ba\u8a8d\u3057\u3066\u304a\u304d\u307e\u3059\u3002\nLogin to the global zone from VMware Player's console view.In order that you can use ssh,you can check IP address by ifconfig -a.\n\n\n\u5229\u7528\u53ef\u80fd\u306aKVM VM image\u3092\u78ba\u8a8d\u3059\u308b(Obtain a list of available KVM VMs)\nSmartOS\u3092\u958b\u767a\u30fb\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u3057\u3066\u3044\u308b Joyent \u304c\u63d0\u4f9b\u3057\u3066\u3044\u308b KVM VM image \u3068 zone template image \u3092 imgadm avail\u30b3\u30de\u30f3\u30c9\u3067\u78ba\u8a8d\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\uff08\u3082\u3057\u304f\u306f\u3001Joyent Cloud Images\u3067\u898b\u3064\u3051\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\uff09\u3002\nYou can get a list of available VM images provided by Joyent by using imgadm avail command in Global Zone.You can also refer to Joyent Cloud Images.\n# imgadm avail | egrep -i \"name|centos\"\nUUID                                  NAME                    VERSION     OS       PUBLISHED\ne4cd7b9e-4330-11e1-81cf-3bb50a972bda  centos-6                1.0.1       linux    2012-04-04T02:51:46Z\n8700b668-0da4-11e2-bde4-17221283a2f4  centos-6                1.3.0       linux    2012-10-03T22:14:08Z\n2539f6de-0b5a-11e2-b647-fb08c3503fb2  centos-5.7              1.3.0       linux    2012-11-21T00:14:48Z\n87c556ac-ab9d-11e2-914d-07682fcab47d  centos-6                2.4.1       linux    2013-04-24T15:48:05Z\n30e9e4c8-bbf2-11e2-ac3b-3b598ee13393  centos-6                2.4.2       linux    2013-05-13T19:42:33Z\n325dbc5e-2b90-11e3-8a3e-bfdcb1582a8d  centos-6                2.5.0       linux    2013-10-02T18:26:47Z\ndf81f45e-8f9f-11e3-a819-93fab527c81e  centos-6                2.6.0       linux    2014-02-07T02:30:56Z\n19daa264-c4c4-11e3-bec3-c30e2c0d4ec0  centos-6                2.6.1       linux    2014-04-15T17:33:47Z\n61a3035a-0864-11e4-b55b-9f87d4149e90  centos-6                20140710    linux    2014-07-10T18:59:55Z\n5e164fac-286d-11e4-9cf7-b3f73eefcd01  centos-7                20140820    linux    2014-08-20T13:24:52Z\nbf67d2fc-2ed1-11e4-a6ef-a7df3cdba7e9  centos-6                20140828    linux    2014-08-28T16:38:32Z\n26f85622-497a-11e4-ba93-3fe7b89aea1a  centos-6                20141001    linux    2014-10-01T14:49:31Z\n553da8ba-499e-11e4-8bee-5f8dadc234ce  centos-7                20141001    linux    2014-10-01T19:08:31Z\nf37b10cc-6a9f-11e4-9181-e3d137d947bf  centos-6                20141112    linux    2014-11-12T19:13:14Z\n1f061f26-6aa9-11e4-941b-ff1a9c437feb  centos-7                20141112    linux    2014-11-12T20:18:53Z\nb1df4936-7a5c-11e4-98ed-dfe1fa3a813a  centos-7                20141202    linux    2014-12-02T19:52:06Z\nb94d11d6-7a65-11e4-add0-93f38d3f5c5c  centos-6                20141202    linux    2014-12-02T20:56:44Z\n02dbab66-a70a-11e4-819b-b3dc41b361d6  centos-7                20150128    linux    2015-01-28T16:23:36Z\n5becfd74-a70d-11e4-93a6-470507be237c  centos-6                20150128    linux    2015-01-28T16:47:34Z\nf7c19252-c998-11e4-be95-3315493f3741  lx-centos-6             20150313    other    2015-03-13T15:52:35Z\neb4128ec-cf12-11e4-960d-8780cec6463f  lx-centos-6             20150320    other    2015-03-20T15:08:09Z\n7a50b1da-d22c-11e4-8ffe-071989ea571f  centos-6                20150324    linux    2015-03-24T13:48:40Z\n3269b9fa-d22e-11e4-afcc-2b4d49a11805  centos-7                20150324    linux    2015-03-24T14:00:58Z\nc41bf236-dc75-11e4-88e5-038814c07c11  centos-7                20150406    linux    2015-04-06T15:58:28Z\n\n\nCentOS7\u306eKVM VM image\u3092 import \u3059\u308b(Import CentOS7 VM image)\n\u4e0a\u306e imgadm avai \u306e\u51fa\u529b\u4e2d\u3067\u6700\u65b0\u306e\u3082\u306e\uff08UUID:c41bf236-dc75-11e4-88e5-038814c07c11\uff09\u3092 import \u3059\u308b\u3053\u3068\u306b\u3057\u307e\u3059\u3002\nimport \u3059\u308b\u30b3\u30de\u30f3\u30c9\u306f\u3001 imgadm import UUID\u3067\u3059\u3002\n\u3053\u306e\u30b3\u30de\u30f3\u30c9\u3092\u767a\u884c\u3059\u308b\u3068 image \u304c\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3055\u308c\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u307e\u3059\u3002\nYou can import KVM VM image by using imgadm import UUID command.This command will download VM image specified by UUID and import it into your SmartOS.\n# imgadm import c41bf236-dc75-11e4-88e5-038814c07c11\nImporting c41bf236-dc75-11e4-88e5-038814c07c11 (centos-7@20150406) from \"https://images.joyent.com\"\nGather image c41bf236-dc75-11e4-88e5-038814c07c11 ancestry\nMust download and install 1 image (490.5 MiB)\nDownload 1 image     [=======================>] 100% 490.51MB 149.52KB/s 55m59s\nDownloaded image c41bf236-dc75-11e4-88e5-038814c07c11 (490.5 MiB)\n...88e5-038814c07c11 [=======================>] 100% 490.51MB   1.52MB/s  5m23s\nImported image c41bf236-dc75-11e4-88e5-038814c07c11 (centos-7@20150406)\n\nimport \u3055\u308c\u3066\u3044\u308b image \u306f\u3001imgadm list\u3067\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\nYou can check a KVM VM image you imported by imgadm list command.\n# imgadm list\nUUID                                  NAME      VERSION   OS     PUBLISHED\nc41bf236-dc75-11e4-88e5-038814c07c11  centos-7  20150406  linux  2015-04-06T15:58:28Z\n\n\nCentOS\u306eKVM VM\u3092Provision\u3059\u308b(Provision CentOS KVM VM as a guest in SmartOS)\nKVM VM\u3092provision\u3059\u308b\u306b\u306f\u3001vmadm create\u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u3044\u307e\u3059\u3002vmadm create\u306b\u306f\u3001\u5165\u529b\u3068\u3057\u3066JSON\u5f62\u5f0f\u3067\u8a18\u8ff0\u3055\u308c\u305fVM\u306e\u5c5e\u6027\u60c5\u5831\u3092\u4e0e\u3048\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u6a19\u6e96\u5165\u529b\u304b\u3089\u306e\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3001\u3082\u3057\u304f\u306f\u3001-f\u30d1\u30e9\u30e1\u30fc\u30bf\u306b\u3088\u308a\u30d5\u30a1\u30a4\u30eb\u3067\u4e0e\u3048\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\u3053\u3053\u3067\u306f\u3001\u30d5\u30a1\u30a4\u30eb\u3092\u7528\u610f\u3059\u308b\u3053\u3068\u3068\u3057\u307e\u3059\u3002\nYou can create KVM VM by using vmadm create command. This command requires VM's attribute(spec) information which described by JSON format.You can provide this information from standard input or prepared file following with -f parameter.\n\n/var/tmp/centos7-spec.json\n{\n  \"brand\": \"kvm\",\n  \"ram\": \"512\",\n  \"vcpus\": \"1\",\n  \"nics\": [\n    {\n      \"nic_tag\": \"admin\",\n      \"ip\": \"dhcp\",\n      \"model\": \"virtio\",\n      \"primary\": true\n    }\n  ],\n  \"disks\": [\n    {\n      \"image_uuid\": \"c41bf236-dc75-11e4-88e5-038814c07c11\",\n      \"boot\": true,\n      \"model\": \"virtio\"\n    }\n  ]\n}\n\n\n\"nic_tag\"\u306f\u3001\u4f5c\u6210\u3059\u308bVM\u306e\u4eee\u60f3\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u3092\u30a2\u30bf\u30c3\u30c1\u3059\u308b\u30db\u30b9\u30c8\u5074\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u3067\u3059\u3002nictagadm \u3082\u3057\u304f\u306f sysinfo\u3067\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\nYou can check nic_tag by using nictagadm command or sysinfo command.\n\nnictagadm\n# nictagadm list\nNAME           MACADDRESS         LINK           TYPE\nadmin          00:0c:29:35:06:58  e1000g0        normal\n\n\n\nsysinfo\n# sysinfo | json \"Network Interfaces\"\n{\n  \"e1000g0\": {\n    \"MAC Address\": \"00:0c:29:35:06:58\",\n    \"ip4addr\": \"192.168.231.128\",\n    \"Link Status\": \"up\",\n    \"NIC Names\": [\n      \"admin\"\n    ]\n  }\n}\n\n\n\"ip\"\u306f\u3001\u3053\u308c\u304b\u3089\u4f5c\u6210\u3059\u308bVM\u306eIP address\u3067\u3059\u3002DHCP\u3092\u4f7f\u3046\u5834\u5408\u306f\u3001\"dhcp\"\u3068\u3057\u307e\u3059\u3002\n\u56fa\u5b9aIP\u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\u306f\u3001\u4ed6\u306b\u3082DNS\u306e resolver\u3001default gateway,netmask\u306e\u6307\u5b9a\u304c\u5fc5\u8981\u3067\u3059\u3002\u8a73\u3057\u304f\u306f\u3001\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8How to create a KVM VM ( Hypervisor virtualized machine ) in SmartOS\u3092\u3054\u53c2\u7167\u304f\u3060\u3055\u3044\u3002\u306a\u304a\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u3067\u3059\u304c VMware Player\u306eNAT\u306e\u5834\u5408\u3001\u30db\u30b9\u30c8\u5074\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u306eIP address\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u306e\u3067\u3001SmartOS\u306eGlobal Zone\u7b49\u306e\u65e2\u306bVMware Player\u3067\u52d5\u4f5c\u3057\u3066\u3044\u308b\u74b0\u5883\u3067\u3001netstat -r\u7b49\u3057\u3066\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\"ip\" means VM's IP address.If you want to use DHCP,you can specify \"ip\": \"dhcp\".\n# netstat -r\n\nRouting Table: IPv4\n  Destination           Gateway           Flags  Ref     Use     Interface\n-------------------- -------------------- ----- ----- ---------- ---------\ndefault              192.168.231.2        UG        1          0 e1000g0\nlocalhost            localhost            UH        2        102 lo0\n192.168.231.0        00-0c-29-35-06-58    U         5       1362 e1000g0\n\n\"image_uuid\"\u306f\u3001imgadm import\u3067 import \u3057\u305f KVM VM image\u306eUUID\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\u306a\u304a\u3001json\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306f\u3069\u3053\u3067\u3082\u304b\u307e\u3044\u307e\u305b\u3093\u304c\u3001\"/\",\"/root\",\"/tmp\"\u7b49\u306f ramdisk \u3067\u3059\uff08df -h\u3067\u78ba\u8a8d\u3067\u304d\u307e\u3059\uff09\u306e\u3067 reboot \u3059\u308b\u3068\u6d88\u3048\u3066\u3057\u307e\u3044\u307e\u3059\u3002\u4e00\u65b9\u3067/var\u306f\u3001SmartOS\u4f5c\u6210\u6642\u306b\u4f5c\u3089\u308c\u305f zfs \u4e0a\u306b\u3042\u308a\u307e\u3059\u306e\u3067 reboot \u5f8c\u3082\u6d88\u3048\u308b\u3053\u3068\u306f\u3042\u308a\u307e\u305b\u3093\u3002\nAlmost all file systems like \"/\",\"/root\",\"/tmp\" are not persistent.You may want to save json file in persistent file system. You can use /var and /opt since they are persistent.\n# zpool list\nNAME    SIZE  ALLOC   FREE  EXPANDSZ   FRAG    CAP  DEDUP  HEALTH  ALTROOT\nzones  19.9G  2.27G  17.6G         -     8%    11%  1.00x  ONLINE  -\n# df -h | grep zones\nzones                   19G   597K        16G     1%    /zones\nzones/archive           19G    19K        16G     1%    /zones/archive\nzones/cores             10G    19K        10G     1%    /zones/global/cores\nzones/var               19G   3.2M        16G     1%    /var\nzones/config            19G    35K        16G     1%    /etc/zones\nzones/opt               19G    19K        16G     1%    /opt\nzones/usbkey            19G   115K        16G     1%    /usbkey\n\n\u4eca\u56de\u306f\u3053\u3053\u306b\u7f6e\u304d\u307e\u3059\u3002\n# vmadm create -f /var/tmp/centos7-spec.json\nSuccessfully created VM a2764418-eee4-4dcc-8596-90dc9c16c536\n\nvmadm create\u306f\u901a\u5e38\u6570\u79d2\u3067\u5b8c\u4e86\u3057\u307e\u3059\u3002(This command will complete in about 10 seconds.)\nvmadm list\u3067KVM VM\u304c\u4f5c\u6210\u3055\u308c\u305f\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002(Confirm if KVM VM is successfully created.)\n# vmadm list\nUUID                                  TYPE  RAM      STATE             ALIAS\na2764418-eee4-4dcc-8596-90dc9c16c536  KVM   512      running           -\n\n\u65b0\u3057\u3044VM(CentOS)\u7528\u306e zfs \u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u304c\u4f5c\u6210\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\nCheck if a zfs file system for newly created VM guest is successfully created.\n# df -h | grep zones\nzones                   19G   599K       6.1G     1%    /zones\nzones/archive           19G    19K       6.1G     1%    /zones/archive\nzones/cores             10G    19K       6.1G     1%    /zones/global/cores\nzones/var               19G   3.4M       6.1G     1%    /var\nzones/config            19G    39K       6.1G     1%    /etc/zones\nzones/opt               19G    19K       6.1G     1%    /opt\nzones/usbkey            19G   115K       6.1G     1%    /usbkey\nzones/a2764418-eee4-4dcc-8596-90dc9c16c536    10G    37K       6.1G     1%    /zones/a2764418-eee4-4dcc-8596-90dc9c16c536\nzones/cores/a2764418-eee4-4dcc-8596-90dc9c16c536    10G    19K       6.1G     1%    /zones/a2764418-eee4-4dcc-8596-90dc9c16c536/cores\n\n\u5272\u308a\u5f53\u3066\u305f\u30e1\u30e2\u30ea\u304c\u5c11\u306a\u3044\u7b49\u3067\u30cf\u30f3\u30b0\u3057\u3066\u3057\u307e\u3063\u305f\u5834\u5408\u306b\u306f\u3001SmartOS\u3092Poweroff\u3057\u3066\u518d\u8d77\u52d5\u3057\u307e\u3059\u304c\u3001\u305d\u306e\u5834\u5408\u3001\u30b4\u30df\u304c\u6b8b\u3063\u3066\u3057\u307e\u3046\u3053\u3068\u304c\u3042\u308a\u307e\u3059\u3002\nSmartOS might hang when you assigned small memory to it.In such cases you should poweroff SmartOS VMware VM and reboot it.After reboot you may find garbage like the following.\n# vmadm list\nUUID                                  TYPE  RAM      STATE             ALIAS\n7e9086da-364b-4ce4-bba4-6ee501099579  KVM   512      failed            -\n# df -h | grep 7e9086da-364b-4ce4-bba4-6ee501099579\nzones/7e9086da-364b-4ce4-bba4-6ee501099579    10G    37K       6.1G     1%    /zones/7e9086da-364b-4ce4-bba4-6ee501099579\nzones/cores/7e9086da-364b-4ce4-bba4-6ee501099579    10G    19K       6.1G     1%    /zones/7e9086da-364b-4ce4-bba4-6ee501099579/cores\n\n\u3053\u306e\u3088\u3046\u306a\u5834\u5408\u306b\u306f\u3001\u4e00\u65e6\u4f5c\u308a\u304b\u3051\u306eKVM VM\u3092\u524a\u9664\u3057\u3066\u3001VMware Player\u306e\u30e1\u30e2\u30ea\u5272\u308a\u5f53\u3066\u3001\u30d7\u30ed\u30bb\u30c3\u30b5\u30b3\u30a2\u5272\u308a\u5f53\u3066\u3092\u898b\u76f4\u3057\u3066\u3084\u308a\u306a\u304a\u3057\u307e\u3059\u3002\nIn such case you can delete the failed KVM VM and increase memory and then you can retry.\n# vmadm delete 7e9086da-364b-4ce4-bba4-6ee501099579\nSuccessfully deleted VM 7e9086da-364b-4ce4-bba4-6ee501099579\n# vmadm list\nUUID                                  TYPE  RAM      STATE             ALIAS\n# df -h | grep zones\nzones                   19G   597K        16G     1%    /zones\nzones/archive           19G    19K        16G     1%    /zones/archive\nzones/cores             10G    19K        10G     1%    /zones/global/cores\nzones/var               19G   3.2M        16G     1%    /var\nzones/config            19G    35K        16G     1%    /etc/zones\nzones/opt               19G    19K        16G     1%    /opt\nzones/usbkey            19G   115K        16G     1%    /usbkey\n\n\nCentOS VM\u306b\u30b3\u30f3\u30bd\u30fc\u30eb\u63a5\u7d9a\u3059\u308b-CLI\u30b3\u30f3\u30bd\u30fc\u30eb\u7de8(Connect to CentOS VM's console - CLI console)\n\u30b3\u30f3\u30bd\u30fc\u30eb\u306b\u306f\u3001vmadm console \u30b3\u30de\u30f3\u30c9\u3067\u63a5\u7d9a\u3057\u307e\u3059\u3002\u5f15\u6570\u3068\u3057\u3066\u3001\u63a5\u7d9a\u5148VM\u306eUUID\u304c\u5fc5\u8981\u3067\u3059\u3002\nYou can connect VM console by using vmadm console command.This command takes UUID of your new VM.\n\nUUID\u3092\u78ba\u8a8d\u3059\u308b(Check UUID of your VM)\n# vmadm list\nUUID                                  TYPE  RAM      STATE             ALIAS\na2764418-eee4-4dcc-8596-90dc9c16c536  KVM   512      running           -\n\n\nvmadm console\u3067\u30b3\u30f3\u30bd\u30fc\u30eb\u3078\u63a5\u7d9a\u3059\u308b(Connect to VM's console)\n# vmadm console a2764418-eee4-4dcc-8596-90dc9c16c536\n\n   __        .                   .\n _|  |_      | .-. .  . .-. :--. |-\n|_    _|     ;|   ||  |(.-' |  | |\n  |__|   `--'  `-' `;-| `-' '  ' `-'\n                   /  ;  Instance (CentOS 7.1 (1503) 20150406)\n                   `-'   https://docs.joyent.com/images/linux/centos\n\ncentos-7 login:\n\nvmadm console UUID \u300cEnter\u300d\u3068\u3057\u3066\u3082\u3059\u3050\u306b\u4f55\u3082\u8868\u793a\u3055\u308c\u306a\u3044\u5834\u5408\u306f\u3001\u3082\u3046\u4e00\u5ea6\u300cEnter\u300d\u3092\u62bc\u3057\u307e\u3059\u3002\n\nroot \u3067\u30ed\u30b0\u30a4\u30f3\u3057\u307e\u3059(Login as root)\n\u4eca\u56de\u4f7f\u7528\u3057\u305fVM image\u3067\u306f root \u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u306f\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u307e\u305b\u3093\u3067\u3057\u305f\u3002\ncentos-7 login: root\n   __        .                   .\n _|  |_      | .-. .  . .-. :--. |-\n|_    _|     ;|   ||  |(.-' |  | |\n  |__|   `--'  `-' `;-| `-' '  ' `-'\n                   /  ;  Instance (CentOS 7.1 (1503) 20150406)\n                   `-'   https://docs.joyent.com/images/linux/centos\n\n[root@centos-7 ~]#\n\n\nCentOS\u306eVM\u3067\u3042\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b(Check if new VM is CentOS or not)\n\u672c\u5f53\u306bCentOS\u304b\u78ba\u304b\u3081\u3066\u307f\u307e\u3059\u3002\n# cat /etc/redhat-release\nCentOS Linux release 7.1.1503 (Core)\n\n\u78ba\u304b\u306b\u3001CentOS 7 (7.1.1503)\u3064\u307e\u308aRedHat Enterprise Linux 7.1\u76f8\u5f53\u3067\u3042\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\u3002\n\nIP \u30a2\u30c9\u30ec\u30b9\u3092\u78ba\u8a8d\u3059\u308b(Get IP address)\n\u4eca\u5f8c\u306e\u30ed\u30b0\u30a4\u30f3\u306e\u305f\u3081\u306bIP\u30a2\u30c9\u30ec\u30b9\u3092\u78ba\u8a8d\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n# ip a s\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n    inet6 ::1/128 scope host\n       valid_lft forever preferred_lft forever\n2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000\n    link/ether 32:13:a5:1e:5c:d8 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.231.129/24 brd 192.168.231.255 scope global dynamic eth0\n       valid_lft 1336sec preferred_lft 1336sec\n    inet6 fe80::3013:a5ff:fe1e:5cd8/64 scope link\n       valid_lft forever preferred_lft forever\n\n\nVM\u306bALIAS\u3092\u4ed8\u3051\u308b(Add alias)\nvmadm list\u3067\u898b\u308b\u3068ALIAS\u304c\"-\"\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002UUID\u3060\u3051\u3060\u3068\u8907\u6570\u306eVM\u3092\u4f5c\u6210\u3059\u308b\u3068\u308f\u304b\u308a\u306b\u304f\u304f\u306a\u308a\u307e\u3059\u306e\u3067\u3001ALIAS\u3092\u4ed8\u3051\u3066\u304a\u304d\u307e\u3059\u3002\n# vmadm update a2764418-eee4-4dcc-8596-90dc9c16c536 alias=\"CentOS7.1\"\nSuccessfully updated VM a2764418-eee4-4dcc-8596-90dc9c16c536\n# vmadm list\nUUID                                  TYPE  RAM      STATE             ALIAS\na2764418-eee4-4dcc-8596-90dc9c16c536  KVM   512      running           CentOS7.1\n\n\n\u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089\u629c\u3051\u308b(Exit console)\n\"Ctrl-]\"\u3067\u30b3\u30f3\u30bd\u30fc\u30eb\u30bb\u30c3\u30b7\u30e7\u30f3\u3092\u629c\u3051\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\nCentOS VM\u306b\u30b3\u30f3\u30bd\u30fc\u30eb\u63a5\u7d9a\u3059\u308b - \u30d3\u30c7\u30aa\u30b3\u30f3\u30bd\u30fc\u30eb\u7de8(Connect to CentOS VM console - Video console)\nvmadm info <UUID> vnc\u3067\u3001VNC\u306b\u3088\u308b\u30d3\u30c7\u30aa\u30b3\u30f3\u30bd\u30fc\u30eb\u3078\u306e\u63a5\u7d9a\u60c5\u5831\u3092\u53d6\u5f97\u3067\u304d\u307e\u3059\u3002\u307e\u305a\u3001UUID\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\nYou can get needed information to connect VNC which is provided by QEMU/KVM by using vmadm info <UUID> vnc.\n# vmadm list | grep CentOS7.1\na2764418-eee4-4dcc-8596-90dc9c16c536  KVM   512      running           CentOS7.1\n\n\u78ba\u8a8d\u3057\u305fUUID\u3092\u5143\u306bVNC\u306e\u63a5\u7d9a\u60c5\u5831\u3092\u53d6\u5f97\u3057\u307e\u3059\u3002\n# vmadm info a2764418-eee4-4dcc-8596-90dc9c16c536 vnc\n{\n  \"vnc\": {\n    \"host\": \"192.168.231.128\",\n    \"port\": 58542,\n    \"display\": 52642\n  }\n}\n\nPC\u5074\u3067VNC\u30d3\u30e5\u30fc\u30ef\u3092\u8d77\u52d5\u3057\u3066\u3001\u63a5\u7d9a\u60c5\u5831\u3092\u5165\u529b\u3057\u307e\u3059\u3002\n\u4e0b\u8a18\u306e\u4f8b\u3067\u306f\u3001UltraVNC\u3092\u4f7f\u7528\u3057\u3066\u3044\u307e\u3059\u3002\n\uff08\u79c1\u306e\u74b0\u5883\u3067\u306f\u3001display\u756a\u53f7\u3067\u306e\u63a5\u7d9a\u304c\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u3002\u30dd\u30fc\u30c8\u756a\u53f7\u3067\u63a5\u7d9a\u3057\u3066\u3044\u307e\u3059\u3002\uff09\n\n\u300cConnect\u300d\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068\u30d3\u30c7\u30aa\u30b3\u30f3\u30bd\u30fc\u30eb\u3078\u63a5\u7d9a\u3057\u307e\u3059\u3002\n\n\n\u30ad\u30fc\u30dc\u30fc\u30c9\u30de\u30c3\u30d7\u306e\u8a2d\u5b9a(Change keyboard map if necessary)\n\u3053\u306e\u307e\u307e\u3067\u3059\u3068VNC\u3067\u306f\u30ad\u30fc\u30dc\u30fc\u30c9\u306e\u30ad\u30fc\u30de\u30c3\u30d7\u304c\u304a\u304b\u3057\u304f\u82f1\u8a9e\u3067\u3082\u65e5\u672c\u8a9e\u3067\u3082\u306a\u3044\u72b6\u614b\u3067\u3057\u305f\uff08\u65e5\u672c\u8a9e\u30ad\u30fc\u30dc\u30fc\u30c9\u3067\";\"\u3092\u62bc\u3057\u3066\u3082\":\"\u3092\u62bc\u3057\u3066\u3082\";\"\u306b\u306a\u308b\u7b49\uff09\u3002\u65e5\u672c\u8a9e\u30ad\u30fc\u30dc\u30fc\u30c9\u3092\u4f7f\u3046\u305f\u3081\u306b\u4ee5\u4e0b\u306e3\u70b9\u306e\u8a2d\u5b9a\u3092\u884c\u3044\u307e\u3057\u305f(\u306a\u304a\u3001Ultra VNC\u306f\u3001Japanese Keyboard\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\u307e\u305f\u3001Tiger VNC\u3082\u8a66\u3057\u307e\u3057\u305f\u304c\u3001\u3053\u3061\u3089\u306fTigaer VNC\u5074\u3067\u306e\u30ad\u30fc\u30dc\u30fc\u30c9\u306e\u8a2d\u5b9a\u306f\u5fc5\u8981\u306a\u3044\u3088\u3046\u3067\u3059)\u3002\n\nQEMU_KVM\u306e\u30ad\u30fc\u30de\u30c3\u30d7\u306e\u5909\u66f4(Change QEMU KVM keymap)\n\u4ee5\u4e0b\u306e\u3044\u305a\u308c\u304b\u306e\u65b9\u6cd5\u3067\u8a2d\u5b9a\u3057\u307e\u3059\u3002\nYou can change QEMU KVM keymap by using the following method-1 or method-2.\n\nvmadm update \u306b\u3088\u308b\u65b9\u6cd5(Method-1)\nSmartOS\u3067\u306f\u3001vmadm update <UUID> qemu_extra_opts=\"-k ja\"\u306b\u3088\u3063\u3066\u3001qemu_kvm \u306b\"-k ja\"\u3068\u3044\u3046\u5f15\u6570\u3092\u6e21\u305b\u307e\u3059\u3002\n\nvmadm create \u6642\u306b\u6e21\u3059 json \u30d5\u30a1\u30a4\u30eb\u306b\"qemu_extra_opts\": \"-k ja\"\u3092\u8a2d\u5b9a\u3059\u308b\u65b9\u6cd5(Method-2)\nYou can provide keymap name by json file when you create VM.\n# cat centos7-spec.json\n{\n  \"brand\": \"kvm\",\n  \"ram\": \"512\",\n  \"vcpus\": \"1\",\n  \"alias\": \"CentOS 7.1(1503) KVM\",\n  \"hostname\": \"centos7-01\",\n  \"nics\": [\n    {\n      \"nic_tag\": \"admin\",\n      \"ip\": \"dhcp\",\n      \"model\": \"virtio\",\n      \"primary\": true\n    }\n  ],\n  \"disks\": [\n    {\n      \"image_uuid\": \"c41bf236-dc75-11e4-88e5-038814c07c11\",\n      \"boot\": true,\n      \"model\": \"virtio\"\n    }\n  ],\n  \"qemu_extra_opts\": \"-k ja -usbdevice tablet\"\n}\n\n\nCentOS7 \u4e0a\u3067\u3001\u30b3\u30f3\u30bd\u30fc\u30eb\u30ad\u30fc\u30de\u30c3\u30d7\u3092\u5909\u66f4(Change console keymap in CentOS Guest VM)\n# localectl set-keymap jp106\n# localectl status\n   System Locale: LANG=en_US.UTF-8\n       VC Keymap: jp106\n      X11 Layout: jp\n       X11 Model: jp106\n     X11 Options: terminate:ctrl_alt_bksp\n# cat /etc/vconsole.conf\nKEYMAP=jp106\nFONT=latarcyrheb-sun16\n\n\nCentOS7\u4e0a\u306e GRUB \u306e\u8a2d\u5b9a\u3067\u30d6\u30fc\u30c8\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u5909\u66f4(Change boot parameter in GRUB setting on CentOS Guest VM)\n/etc/default/grub\u306eGRUB_CMDLINE_LINUX\u306evconsole.keymap=us\u3092jp106\u306b\u5909\u66f4\u5f8c\u3001grub.cfg\u3092\u66f4\u65b0\n# cp /boot/grub2/grub.cfg /boot/grub2/grub.cfg.org\n# grub2-mkconfig -o /boot/grub2/grub.cfg\nGenerating grub configuration file ...\nFound linux image: /boot/vmlinuz-3.10.0-229.el7.x86_64\nFound initrd image: /boot/initramfs-3.10.0-229.el7.x86_64.img\nFound linux image: /boot/vmlinuz-3.10.0-229.1.2.el7.x86_64\nFound initrd image: /boot/initramfs-3.10.0-229.1.2.el7.x86_64.img\nFound linux image: /boot/vmlinuz-0-rescue-2b71577b5d2043428953ae1f2a63f3cc\nFound initrd image: /boot/initramfs-0-rescue-2b71577b5d2043428953ae1f2a63f3cc.img\ndone\n\n\u305d\u3057\u3066\u3001poweroff\u3057\u3066\u3001vmadm start\u3057\u3066\u518d\u8d77\u52d5\n\nCentOS7 KVM VM\u306e\u8d77\u52d5\u6642\u9593\u3092\u77ed\u7e2e\uff08\u304a\u307e\u3051\uff09(Reduce boot time)\n\u3053\u3053\u307e\u3067\u306e\u624b\u9806\u306e\u307e\u307e\u3067\u306f\u3001CentOS\u306e\u8d77\u52d5\u306b\u304b\u306a\u308a\u6642\u9593\u304c\u304b\u304b\u308a\u307e\u3059\u3002\nsystemd-analyze\u3057\u3066\u307f\u308b\u3068\n# systemd-analyze\nStartup finished in 4.109s (kernel) + 20.986s (initrd) + 2min 33.714s (userspace) = 2min 58.811s\n\n# systemd-analyze blame\n         59.051s rc-local.service\n         44.259s postfix.service\n         40.752s network.service\n         18.748s firewalld.service\n         12.622s tuned.service\n          8.111s boot.mount\n          6.131s ntpdate.service\n          5.636s systemd-udev-trigger.service\n          5.131s rhel-dmesg.service\n          4.487s systemd-logind.service\n          4.115s rsyslog.service\n          4.019s systemd-fsck-root.service\n          3.274s kmod-static-nodes.service\n          3.209s acpid.service\n          3.068s systemd-vconsole-setup.service\n          2.372s systemd-fsck@dev-disk-by\\x2duuid-01cf7647\\x2d0b01\\x2d4105\\x2d97\n          2.302s polkit.service\n          2.285s NetworkManager.service\n          2.206s systemd-tmpfiles-setup-dev.service\n          1.955s dev-disk-by\\x2duuid-81fd73a2\\x2db584\\x2d4958\\x2daecf\\x2dd8b147f\n          1.852s rhel-import-state.service\n          1.617s rhel-readonly.service\n          1.558s sys-kernel-debug.mount\nlines 1-23\n\nrc-local \u3068 postfix \u306b\u6642\u9593\u304c\u304b\u304b\u3063\u3066\u3044\u307e\u3059\u3002\n/etc/rc.local \u3092\u307f\u3066\u307f\u308b\u3068 Joyent\u306e SmartDataCenter(SDC)\u306b\u95a2\u3059\u308b\u51e6\u7406\u3092\u3057\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u306e\u3067\u3001\u3068\u308a\u3042\u3048\u305a\u6b62\u3081\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n# chmod 666 /etc/rc.local\n# ls -l /etc/rc.local\nlrwxrwxrwx. 1 root root 13 Apr  6 15:51 /etc/rc.local -> rc.d/rc.local\n# ls -l /etc/rc.d/rc.local\nlrwxrwxrwx. 1 root root 28 Apr  6 15:51 /etc/rc.d/rc.local -> /lib/smartdc/joyent_rc.local\n# ls -l /lib/smartdc/joyent_rc.local\n-rw-rw-rw-. 1 root root 3009 Apr  6 15:51 /lib/smartdc/joyent_rc.local\n\n\u3055\u3089\u306b\u3001postfix \u3082\u6b62\u3081\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n# systemctl stop postfix.service\n# systemctl disable postfix.service\nrm '/etc/systemd/system/multi-user.target.wants/postfix.service'\n\nnetwork.service\u3082\u6642\u9593\u304c\u304b\u304b\u308a\u904e\u304e\u306a\u3088\u3046\u3067\u3059\u304c\u3001\u3053\u308c\u306f\u8ffd\u53ca\u3059\u308b\u3068\u6642\u9593\u304c\u304b\u304b\u308a\u305d\u3046\u3067\u3059\u306e\u3067\u3001\u3053\u3053\u307e\u3067\u3067\u3002\n\u3055\u3066\u3001poweroff \u3057\u3066 vmadm start <UUID>\u3057\u3066\u307f\u308b\u3068\u3001\u4f53\u611f\u3067\u306f\u304b\u306a\u308a\u901f\u304f\u306a\u3063\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\n# systemd-analyze\nStartup finished in 4.203s (kernel) + 21.121s (initrd) + 1min 36.252s (userspace) = 2min 1.577s\n# systemd-analyze blame\n         40.593s network.service\n         19.895s firewalld.service\n         14.002s tuned.service\n          5.799s ntpdate.service\n          5.763s systemd-udev-trigger.service\n          5.527s rhel-dmesg.service\n          5.219s systemd-logind.service\n          4.758s rsyslog.service\n          4.020s systemd-fsck-root.service\n          3.340s acpid.service\n          3.135s systemd-vconsole-setup.service\n          3.133s kmod-static-nodes.service\n          3.001s NetworkManager.service\n          2.868s plymouth-quit.service\n          2.818s systemd-fsck@dev-disk-by\\x2duuid-01cf7647\\x2d0b01\\x2d4105\\x2d97\n          2.346s polkit.service\n          2.334s systemd-tmpfiles-setup-dev.service\n          1.960s rhel-import-state.service\n          1.897s plymouth-quit-wait.service\n          1.777s rhel-readonly.service\n          1.766s dev-disk-by\\x2duuid-81fd73a2\\x2db584\\x2d4958\\x2daecf\\x2dd8b147f\n          1.616s auditd.service\n          1.584s sys-kernel-debug.mount\nlines 1-23\n\n\u78ba\u304b\u306brc-local\u3068postfix\u304c\u306a\u304f\u306a\u3063\u3066\u901f\u304f\u306a\u3063\u3066\u3044\u307e\u3059\u3002\u5f37\u5f15\u3067\u3059\u304c\u5c11\u3057\u904a\u3076\u306b\u306f\u3053\u308c\u3067\u3002\n\n\u88dc\u8db3\nGlobal Zone(SmarOS\u305d\u306e\u3082\u306e)\u306f\u3001/usbkey\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u4ee5\u5916\u306b\u306f\u4e0d\u63ee\u767a\u6027\u306e\u30b9\u30c8\u30ec\u30fc\u30b8\u3092\u6301\u305f\u305a\u3001\u518d\u8d77\u52d5\u3059\u308b\u3068\u5909\u66f4\u304c\u5931\u308f\u308c\u3066\u3057\u307e\u3044\u307e\u3059\u3002\u305d\u306e\u305f\u3081\u3001\u30ad\u30fc\u30dc\u30fc\u30c9\u306e\u8a2d\u5b9a\u3084ssh\u516c\u958b\u9375\u306e\u767b\u9332\u306a\u3069\u306f\u3001Linux\u3084Solaris\u3068\u306f\u7570\u306a\u308b\u624b\u9806\u304c\u5fc5\u8981\u3067\u3059\u3002\u4e00\u65b9\u3067\u3001\u4eca\u56de\u4f5c\u6210\u3057\u305f KVM VM \u3084 SmartOS\u306ezones(\u30b3\u30f3\u30c6\u30ca)\u306f\u3001\u30c7\u30a3\u30b9\u30af\u4e0a\uff08zones pool\uff09\u306b\u4fdd\u5b58\u3055\u308c\u3066\u3044\u307e\u3059\u3002CentOS KVM VM\u306f\u901a\u5e38\u306eCentOS\u3068\u5168\u304f\u540c\u3058\u3088\u3046\u306b\u904b\u7528\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u306f\u305a\u3067\u3059\u3002\n\u307e\u305f\u3001KVM\u306eVM\u3067\u306f\u306a\u304f\u3001LX Branded Zone\uff08Linux\u30b3\u30f3\u30c6\u30ca\uff09\u3068\u3057\u3066Ubuntu 14.04\u3092\u52d5\u304b\u3057\u3066\u307f\u308b\u306b\u306f\u3001SmartOS\u306eLX Branded Zone\uff08Linux\u30b3\u30f3\u30c6\u30ca\uff09\u3092\u52d5\u304b\u3059\u3092\u307f\u3066\u307f\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u672a\u89e3\u6c7a\u306a\u554f\u984c\n\nreboot\u30b3\u30de\u30f3\u30c9\u3067\u30cf\u30f3\u30b0\uff08\u56de\u907f\u7b56\u306f\u3001poweroff\u30b3\u30de\u30f3\u30c9\uff09\nCentOS\u3092\u518d\u8d77\u52d5\u3059\u308b\u969b\u306b reboot \u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u3046\u3068VM\u304c\u30cf\u30f3\u30b0\u3057\u3066\u3057\u307e\u3046\uff08\u3082\u3057\u304f\u306f\u3001\u505c\u6b62\u306b\u7570\u5e38\u306b\u6642\u9593\u304c\u304b\u304b\u3066\u3044\u308b\uff09\u3002reboot\u767a\u884c\u5f8c\u3001Global Zone\u3067\u3001vmadm list\u3067\u307f\u3066\u307f\u308b\u3068\"STATE\"\u304c\"running\"\u306e\u307e\u307e\u3068\u306a\u308a\u3001vmadm console <UUID>\u3067\u3082VNC\u30b3\u30f3\u30bd\u30fc\u30eb\u3067\u3082\u63a5\u7d9a\u3067\u304d\u306a\u3044\u72b6\u614b\u3068\u306a\u308a\u307e\u3059\u3002\u3053\u306e\u5834\u5408\u3001vmadm stop <UUID>\u3067\u505c\u6b62\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u304c\u3001\u6570\u5206\u304b\u304b\u308a\u307e\u3059\u3002\n\u306a\u304a\u3001reboot\u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u308f\u305a\u3001poweroff\u30b3\u30de\u30f3\u30c9\u3067\u30b7\u30e3\u30c3\u30c8\u30c0\u30a6\u30f3\u3057\u3066\u3001vmadm start <UUID>\u3068\u3059\u308b\u3068\u554f\u984c\u306a\u304f\u518d\u8d77\u52d5\u3067\u304d\u307e\u3059\u3002\n**English translation follows Japanese paragraph**\n\n[SmartOS\u3092VMware Player\u3067\u52d5\u304b\u3059](http://qiita.com/kutsushitaneko/items/de7b1dd62be8efeac618)\u3067\u7c21\u5358\u306b\u7d39\u4ecb\u3057\u3066\u3044\u307e\u3059\u3088\u3046\u306b\u3001**SmartOS**\u306f\u3001ZFS + DTrace + Zones \u305d\u3057\u3066\u3001\u306a\u3093\u3068 Solaris\u7cfb\u306b\u3082\u304b\u304b\u308f\u3089\u305aKVM\u3084Docker\u304c\u4f7f\u3048\u308b\u30aa\u30fc\u30d7\u30f3\u30bd\u30fc\u30b9OS\u3067\u3059\u3002Sun Microsystems(\u73fe\u5728\u306eOracle)\u304c\u30aa\u30fc\u30d7\u30f3\u30bd\u30fc\u30b9\u5316\u3057\u3066\u3044\u305f Open Solaris\u304b\u3089\u6d3e\u751f\u3057\u305fillumos\u306e\u30ab\u30fc\u30cd\u30eb\u3092\u4f7f\u3063\u305fOS\u3067\u3059\uff08[SmartOS\u3067\u904a\u3093\u3058\u3083\u3046\uff1f](http://kutsushitaneko.tumblr.com/smartos)\u3067\u7c21\u5358\u306bSmartOS\u3092\u7d39\u4ecb\u3057\u3066\u3044\u307e\u3059\uff09\u3002\n\nSmartOS is an Open Source virtualizaton platform and operating system in which you can use its native container, Linux container, KVM virtual machine and Docker(with open source SmartDatacenter).SmartOS is a distribution of illumos OS which is derived from Open Solaris Sun Microsystems(now Oracle) had open-sourced.ZFS is used as a storage infrastructure underneath SmartOS's virtualization functions and you can use DTrace to investigate kernel and your application's performance and other problems.\n\nSmartOS\u306f\u4eee\u60f3\u5316\u30c6\u30af\u30ce\u30ed\u30b8\u3068\u3057\u3066\u4ee5\u4e0b\u306e\u6a5f\u80fd\u3092\u6301\u3063\u3066\u3044\u307e\u3059\u3002\n\n* SmartOS\u306b\u3088\u308bOS\u4eee\u60f3\u5316\uff08\u30b3\u30f3\u30c6\u30ca\uff09\uff1a\n    * SmartOS\u306eZone(SmartMachine)\n    * Linux\u306eZone\uff08LX Branded Zone\uff09\n* SmartOS\u7d44\u307f\u8fbc\u307f\u306e\u30cf\u30a4\u30d1\u30fc\u30d0\u30a4\u30b6\u30d9\u30fc\u30b9\u306e\u4eee\u60f3\u5316\n    * KVM\n\nSmartOS supports the following virtualization technologies.\n\n* OS Virtualizaion aka Container\n    * SmartOS's native Zone(aka SmartMachine) \n    * Linux Zone(LX Branded Zone)\n* Hardware virtualization based on Hypervior\n    * KVM\n\n\u3053\u3053\u3067\u306f\u3001**SmartOS\u306eKVM\u4e0a\u3067CentOS7(7.1.1503)**\u3092\u52d5\u304b\u3057\u3066\u307f\u307e\u3059\u3002\n\nIn this article we will explore KVM virtual machine on SmartOS and you can see how you can  deploy CentOS7(7.1.1503) on SmartOS as a KVM virtual machine.\n\nSmartOS\u306eKVM\u306f\u3001zfs\u306esnapshot(clone)\u6a5f\u80fd\u3092\u5229\u7528\u3057\u3066template\u3068\u306a\u308bVM image\u304b\u3089\u9ad8\u901f\u306b\u65b0\u3057\u3044VM\u3092\u751f\u6210\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\u4ee5\u4e0b\u306e\u4f8b\u3067\u306f\u5b9f\u969b\u306bCentOS\u306eVM\u3092\u4f5c\u308b\u30b3\u30de\u30f3\u30c9\uff08vmadm create\uff09\u306e\u5b9f\u884c\u6642\u9593\u306f\u3001\u6570\u79d2\u3067\u3057\u305f\u3002\u4f7f\u3044\u6368\u3066\u306eVM\u74b0\u5883\u3092\u983b\u7e41\u306b\u4f5c\u6210\u3059\u308b\u5834\u5408\u306b\u306f\u3001vagrant\u4ee5\u4e0a\u306b\u5f37\u529b\u306a\u89e3\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002VPS\u306e\u3088\u3046\u306a\u30b5\u30fc\u30d3\u30b9\u306b\u3082\u5411\u3044\u3066\u3044\u305d\u3046\u3067\u3059\u3002\n\nKVM VM on SmartOS can be created by `vmadm create` command.This command will create a zfs snapshot of an existing VM image and then create a zfs clone from this snapshot.ZFS snapshot and clone are just metadata operation until you change data of new VM.So this command will complete less than 10 seconds typically.\n\n#SmartOS\u306eGlobal Zone\uff08\u5927\u57df\u30be\u30fc\u30f3\uff09\u3092\u7528\u610f\u3059\u308b(Prepare SmartOS Global Zone)\n[SmartOS\u3092VMware Player\u3067\u52d5\u304b\u3059](http://qiita.com/kutsushitaneko/items/de7b1dd62be8efeac618)\u306e\u624b\u9806\u3067VMware Player\u4e0a\u306bGlobal Zone\u3092\u7528\u610f\u3057\u307e\u3059\u3002\u3082\u3061\u308d\u3093\u3001\u30d9\u30a2\u30e1\u30bf\u30eb\u4e0a\u3067\u3082OK\u3067\u3059\uff08SmartOS\u7528\u306b\u5c02\u7528\u3067\u4f7f\u3048\u308b\u30cf\u30fc\u30c9\u30c7\u30a3\u30b9\u30af\u304c\u4f59\u3063\u3066\u3044\u308c\u3070\u3001\u3080\u3057\u308d\u30d9\u30a2\u30e1\u30bf\u30eb\u306e\u65b9\u304c\u7c21\u5358\u3067\u3059\uff09\u3002\u305f\u3060\u3057\u3001Hyper-V\u3084VirtualBox\u306e\u3088\u3046\u306a Nested Virtualization\u306b\u5bfe\u5fdc\u3057\u3066\u3044\u306a\u3044\u30cf\u30a4\u30d1\u30fc\u30d0\u30a4\u30b6\u4e0a\u3067\u306f\u3001KVM\u306f\u4f7f\u7528\u3067\u304d\u307e\u305b\u3093\u3002Linux KVM\u306f\u3001Nested Virtualization\u306b\u5bfe\u5fdc\u3057\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u306e\u3067\u5927\u4e08\u592b\u305d\u3046\u3067\u3059\u304c\u8a66\u3057\u3066\u3044\u307e\u305b\u3093\uff08VMware\u306f\u3001Virtualized VM\u3068\u3044\u3046\u5f62\u3067\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u7684\u306bNested Virtualization\u306b\u5bfe\u5fdc\u3057\u3066\u3044\u307e\u3059\u3002Intel Haswell CPU\u306f\u3001VMCS shadowing\u3068\u3044\u3046Nested Virtualization\u3092\u30cf\u30fc\u30c9\u30a6\u30a7\u30a2\u3067\u652f\u63f4\u3059\u308b\u6a5f\u80fd\u3092\u6301\u3063\u3066\u3044\u307e\u3059\u306e\u3067\u3001\u5404\u30cf\u30a4\u30d1\u30fc\u30d0\u30a4\u30b6\u30fc\u304c\u65e9\u304f\u5bfe\u5fdc\u3057\u3066\u304f\u308c\u308b\u3068\u5b09\u3057\u3044\u306e\u3067\u3059\u304c\u3002\u3002\u3002\u5bfe\u5fdc\u3057\u3066\u3044\u308b\u3082\u306e\u306f\u3042\u308b\u306e\u3067\u3057\u3087\u3046\u304b\uff1f\uff09\u3002\n\nBefore deploying KVM VM,you need to prepare SmartOS itself aka Global Zone on your physical machine or virtual machine.If you have extra disk drives it is easy to setup your SmartOS.If you don't have extra drive you can use VMware Player or workstation or Fusion since VMware supports nested virtualization by software.In my [last article(Japanese)](http://qiita.com/kutsushitaneko/items/de7b1dd62be8efeac618),I used VMware Player.If you are a Mac user you can find step by step guide in the official document \"[SmartOS as a VMware Guest:VMware Fusion](https://wiki.smartos.org/display/DOC/SmartOS+as+a+VMware+Guest)\".\n\nIt seems like that KVM also support nested virtualization,so you may be able to use KVM.Virtual Box does not support netsted virtualization and AFAIK there is no plan to support it,so you can not use Virtual Box for KVM on SmartOS.Though Intel Haswell introduced VMCS shadowing which assists netsted virtualization by hardware,AFAIK there is no hypervisor which exploits this new technology yet.Though Virtual Box cannot be used for KVM VM on SmartOS setup,you can use it for OS virtualization like SmartOS Zone and Linux container(LX Braded Zone) since these technology doesn't need hardware assistance like VT-x(Oracle Solaris's new zone type \"kernel zone\" needs hardware assistance,so Oracle's VBox also cannot be used to test Oracle Solaris's kernel zone.Though \"kernel zone\" can be considered as hardware virtulization becasuse each zone have its own kernel, it supports solaris only.You can use Oracle Solaris's native zone on VBox).\n\n\u306a\u304a\u3001[SmartOS\u3092VMware Player\u3067\u52d5\u304b\u3059](http://qiita.com/kutsushitaneko/items/de7b1dd62be8efeac618)\u306e\u624b\u9806\u3067\u306f\u3001SmartOS\u306b\u306f\u30011GB\u306e\u30e1\u30e2\u30ea\u30681\u3064\u306e\u30d7\u30ed\u30bb\u30c3\u30b5\u30b3\u30a2\u3092\u5272\u308a\u5f53\u3066\u3066\u3044\u307e\u3059\u3002\u3053\u306e\u307e\u307e\u3067\u3059\u3068KVM VM\u306e\u4f5c\u6210\u4e2d\u306b SmartOS\u81ea\u4f53\u304c\u30cf\u30f3\u30b0\u3057\u307e\u3059\u3002\u30e1\u30e2\u30ea\u30922GB\u4ee5\u4e0a\u3001\u30d7\u30ed\u30bb\u30c3\u30b5\u30922\u500b\u4ee5\u4e0a\u306b\u5909\u66f4\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\nIn my [last article(Japanese)](http://qiita.com/kutsushitaneko/items/de7b1dd62be8efeac618) I assigned only 1GB memory and 1 processor to VM(SmartOS).When you try to create KVM VM with this configuration,SmartOS might be hang.So before deploying KVM VM you may want to increase memory and processor assignment for your SmartOS setup.\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/74534/72a19094-e9c8-e9ae-5044-6061c89185a1.png)\n\n\n#CentOS7\u306eKVM VM image\u3092 import \u3059\u308b(Import CentOS KVM image)\n\n##Global Zone\u306b\u30ed\u30b0\u30a4\u30f3(Login Global Zone)\nVMware Player\u306e\u30b3\u30f3\u30bd\u30fc\u30eb\u30d3\u30e5\u30fc\u3067\u3001SmartOS\uff08\u306eGlobal Zone\uff09\u3078root\u3067\u30ed\u30b0\u30a4\u30f3\u3057\u307e\u3059\u3002ssh\u3067\u5165\u308a\u305f\u3044\u5834\u5408\u306f\u3001\u30b3\u30f3\u30bd\u30fc\u30eb\u30d3\u30e5\u30fc\u3067`ifconfig -a` \u3057\u3066 ip address \u3092\u78ba\u8a8d\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\nLogin to the global zone from VMware Player's console view.In order that you can use ssh,you can check IP address by `ifconfig -a`.\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/74534/7b354547-b9df-0f4f-9fe9-45431b566019.png)\n\n##\u5229\u7528\u53ef\u80fd\u306aKVM VM image\u3092\u78ba\u8a8d\u3059\u308b(Obtain a list of available KVM VMs)\nSmartOS\u3092\u958b\u767a\u30fb\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u3057\u3066\u3044\u308b Joyent \u304c\u63d0\u4f9b\u3057\u3066\u3044\u308b KVM VM image \u3068 zone template image \u3092 `imgadm avail`\u30b3\u30de\u30f3\u30c9\u3067\u78ba\u8a8d\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\uff08\u3082\u3057\u304f\u306f\u3001[Joyent Cloud Images](https://docs.joyent.com/images)\u3067\u898b\u3064\u3051\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\uff09\u3002\n\nYou can get a list of available VM images provided by Joyent by using `imgadm avail` command in Global Zone.You can also refer to [Joyent Cloud Images](https://docs.joyent.com/images).\n\n\n```lang:\n# imgadm avail | egrep -i \"name|centos\"\nUUID                                  NAME                    VERSION     OS       PUBLISHED\ne4cd7b9e-4330-11e1-81cf-3bb50a972bda  centos-6                1.0.1       linux    2012-04-04T02:51:46Z\n8700b668-0da4-11e2-bde4-17221283a2f4  centos-6                1.3.0       linux    2012-10-03T22:14:08Z\n2539f6de-0b5a-11e2-b647-fb08c3503fb2  centos-5.7              1.3.0       linux    2012-11-21T00:14:48Z\n87c556ac-ab9d-11e2-914d-07682fcab47d  centos-6                2.4.1       linux    2013-04-24T15:48:05Z\n30e9e4c8-bbf2-11e2-ac3b-3b598ee13393  centos-6                2.4.2       linux    2013-05-13T19:42:33Z\n325dbc5e-2b90-11e3-8a3e-bfdcb1582a8d  centos-6                2.5.0       linux    2013-10-02T18:26:47Z\ndf81f45e-8f9f-11e3-a819-93fab527c81e  centos-6                2.6.0       linux    2014-02-07T02:30:56Z\n19daa264-c4c4-11e3-bec3-c30e2c0d4ec0  centos-6                2.6.1       linux    2014-04-15T17:33:47Z\n61a3035a-0864-11e4-b55b-9f87d4149e90  centos-6                20140710    linux    2014-07-10T18:59:55Z\n5e164fac-286d-11e4-9cf7-b3f73eefcd01  centos-7                20140820    linux    2014-08-20T13:24:52Z\nbf67d2fc-2ed1-11e4-a6ef-a7df3cdba7e9  centos-6                20140828    linux    2014-08-28T16:38:32Z\n26f85622-497a-11e4-ba93-3fe7b89aea1a  centos-6                20141001    linux    2014-10-01T14:49:31Z\n553da8ba-499e-11e4-8bee-5f8dadc234ce  centos-7                20141001    linux    2014-10-01T19:08:31Z\nf37b10cc-6a9f-11e4-9181-e3d137d947bf  centos-6                20141112    linux    2014-11-12T19:13:14Z\n1f061f26-6aa9-11e4-941b-ff1a9c437feb  centos-7                20141112    linux    2014-11-12T20:18:53Z\nb1df4936-7a5c-11e4-98ed-dfe1fa3a813a  centos-7                20141202    linux    2014-12-02T19:52:06Z\nb94d11d6-7a65-11e4-add0-93f38d3f5c5c  centos-6                20141202    linux    2014-12-02T20:56:44Z\n02dbab66-a70a-11e4-819b-b3dc41b361d6  centos-7                20150128    linux    2015-01-28T16:23:36Z\n5becfd74-a70d-11e4-93a6-470507be237c  centos-6                20150128    linux    2015-01-28T16:47:34Z\nf7c19252-c998-11e4-be95-3315493f3741  lx-centos-6             20150313    other    2015-03-13T15:52:35Z\neb4128ec-cf12-11e4-960d-8780cec6463f  lx-centos-6             20150320    other    2015-03-20T15:08:09Z\n7a50b1da-d22c-11e4-8ffe-071989ea571f  centos-6                20150324    linux    2015-03-24T13:48:40Z\n3269b9fa-d22e-11e4-afcc-2b4d49a11805  centos-7                20150324    linux    2015-03-24T14:00:58Z\nc41bf236-dc75-11e4-88e5-038814c07c11  centos-7                20150406    linux    2015-04-06T15:58:28Z\n```\n\n##CentOS7\u306eKVM VM image\u3092 import \u3059\u308b(Import CentOS7 VM image)\n\u4e0a\u306e imgadm avai \u306e\u51fa\u529b\u4e2d\u3067\u6700\u65b0\u306e\u3082\u306e\uff08UUID:c41bf236-dc75-11e4-88e5-038814c07c11\uff09\u3092 import \u3059\u308b\u3053\u3068\u306b\u3057\u307e\u3059\u3002\nimport \u3059\u308b\u30b3\u30de\u30f3\u30c9\u306f\u3001 `imgadm import UUID`\u3067\u3059\u3002\n\u3053\u306e\u30b3\u30de\u30f3\u30c9\u3092\u767a\u884c\u3059\u308b\u3068 image \u304c\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3055\u308c\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u307e\u3059\u3002\n\nYou can import KVM VM image by using `imgadm import UUID` command.This command will download VM image specified by UUID and import it into your SmartOS.\n\n```lang:\n# imgadm import c41bf236-dc75-11e4-88e5-038814c07c11\nImporting c41bf236-dc75-11e4-88e5-038814c07c11 (centos-7@20150406) from \"https://images.joyent.com\"\nGather image c41bf236-dc75-11e4-88e5-038814c07c11 ancestry\nMust download and install 1 image (490.5 MiB)\nDownload 1 image     [=======================>] 100% 490.51MB 149.52KB/s 55m59s\nDownloaded image c41bf236-dc75-11e4-88e5-038814c07c11 (490.5 MiB)\n...88e5-038814c07c11 [=======================>] 100% 490.51MB   1.52MB/s  5m23s\nImported image c41bf236-dc75-11e4-88e5-038814c07c11 (centos-7@20150406)\n```\nimport \u3055\u308c\u3066\u3044\u308b image \u306f\u3001`imgadm list`\u3067\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\n\nYou can check a KVM VM image you imported by `imgadm list` command.\n\n```lang:\n# imgadm list\nUUID                                  NAME      VERSION   OS     PUBLISHED\nc41bf236-dc75-11e4-88e5-038814c07c11  centos-7  20150406  linux  2015-04-06T15:58:28Z\n```\n\n##CentOS\u306eKVM VM\u3092Provision\u3059\u308b(Provision CentOS KVM VM as a guest in SmartOS)\n\nKVM VM\u3092provision\u3059\u308b\u306b\u306f\u3001**`vmadm create`**\u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u3044\u307e\u3059\u3002`vmadm create`\u306b\u306f\u3001\u5165\u529b\u3068\u3057\u3066JSON\u5f62\u5f0f\u3067\u8a18\u8ff0\u3055\u308c\u305fVM\u306e\u5c5e\u6027\u60c5\u5831\u3092\u4e0e\u3048\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u6a19\u6e96\u5165\u529b\u304b\u3089\u306e\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3001\u3082\u3057\u304f\u306f\u3001`-f`\u30d1\u30e9\u30e1\u30fc\u30bf\u306b\u3088\u308a\u30d5\u30a1\u30a4\u30eb\u3067\u4e0e\u3048\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\u3053\u3053\u3067\u306f\u3001\u30d5\u30a1\u30a4\u30eb\u3092\u7528\u610f\u3059\u308b\u3053\u3068\u3068\u3057\u307e\u3059\u3002\n\nYou can create KVM VM by using `vmadm create` command. This command requires VM's attribute(spec) information which described by JSON format.You can provide this information from standard input or prepared file following with `-f` parameter.\n\n```lang:/var/tmp/centos7-spec.json\n{\n  \"brand\": \"kvm\",\n  \"ram\": \"512\",\n  \"vcpus\": \"1\",\n  \"nics\": [\n    {\n      \"nic_tag\": \"admin\",\n      \"ip\": \"dhcp\",\n      \"model\": \"virtio\",\n      \"primary\": true\n    }\n  ],\n  \"disks\": [\n    {\n      \"image_uuid\": \"c41bf236-dc75-11e4-88e5-038814c07c11\",\n      \"boot\": true,\n      \"model\": \"virtio\"\n    }\n  ]\n}\n```\n\n\"nic_tag\"\u306f\u3001\u4f5c\u6210\u3059\u308bVM\u306e\u4eee\u60f3\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u3092\u30a2\u30bf\u30c3\u30c1\u3059\u308b\u30db\u30b9\u30c8\u5074\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u3067\u3059\u3002nictagadm \u3082\u3057\u304f\u306f sysinfo\u3067\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\n\nYou can check nic_tag by using `nictagadm` command or `sysinfo` command.\n\n```lang:nictagadm\n# nictagadm list\nNAME           MACADDRESS         LINK           TYPE\nadmin          00:0c:29:35:06:58  e1000g0        normal\n```\n\n```lang:sysinfo\n# sysinfo | json \"Network Interfaces\"\n{\n  \"e1000g0\": {\n    \"MAC Address\": \"00:0c:29:35:06:58\",\n    \"ip4addr\": \"192.168.231.128\",\n    \"Link Status\": \"up\",\n    \"NIC Names\": [\n      \"admin\"\n    ]\n  }\n}\n```\n\"ip\"\u306f\u3001\u3053\u308c\u304b\u3089\u4f5c\u6210\u3059\u308bVM\u306eIP address\u3067\u3059\u3002DHCP\u3092\u4f7f\u3046\u5834\u5408\u306f\u3001\"dhcp\"\u3068\u3057\u307e\u3059\u3002\n\u56fa\u5b9aIP\u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\u306f\u3001\u4ed6\u306b\u3082DNS\u306e resolver\u3001default gateway,netmask\u306e\u6307\u5b9a\u304c\u5fc5\u8981\u3067\u3059\u3002\u8a73\u3057\u304f\u306f\u3001\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8[How to create a KVM VM ( Hypervisor virtualized machine ) in SmartOS](https://wiki.smartos.org/display/DOC/How+to+create+a+KVM+VM+%28+Hypervisor+virtualized+machine+%29+in+SmartOS)\u3092\u3054\u53c2\u7167\u304f\u3060\u3055\u3044\u3002\u306a\u304a\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u3067\u3059\u304c VMware Player\u306eNAT\u306e\u5834\u5408\u3001\u30db\u30b9\u30c8\u5074\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u306eIP address\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u306e\u3067\u3001SmartOS\u306eGlobal Zone\u7b49\u306e\u65e2\u306bVMware Player\u3067\u52d5\u4f5c\u3057\u3066\u3044\u308b\u74b0\u5883\u3067\u3001`netstat -r`\u7b49\u3057\u3066\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\"ip\" means VM's IP address.If you want to use DHCP,you can specify `\"ip\": \"dhcp\"`.\n\n```lang:\n# netstat -r\n\nRouting Table: IPv4\n  Destination           Gateway           Flags  Ref     Use     Interface\n-------------------- -------------------- ----- ----- ---------- ---------\ndefault              192.168.231.2        UG        1          0 e1000g0\nlocalhost            localhost            UH        2        102 lo0\n192.168.231.0        00-0c-29-35-06-58    U         5       1362 e1000g0\n```\n\"image_uuid\"\u306f\u3001`imgadm import`\u3067 import \u3057\u305f KVM VM image\u306eUUID\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n\u306a\u304a\u3001json\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306f\u3069\u3053\u3067\u3082\u304b\u307e\u3044\u307e\u305b\u3093\u304c\u3001\"/\",\"/root\",\"/tmp\"\u7b49\u306f ramdisk \u3067\u3059\uff08`df -h`\u3067\u78ba\u8a8d\u3067\u304d\u307e\u3059\uff09\u306e\u3067 reboot \u3059\u308b\u3068\u6d88\u3048\u3066\u3057\u307e\u3044\u307e\u3059\u3002\u4e00\u65b9\u3067/var\u306f\u3001SmartOS\u4f5c\u6210\u6642\u306b\u4f5c\u3089\u308c\u305f zfs \u4e0a\u306b\u3042\u308a\u307e\u3059\u306e\u3067 reboot \u5f8c\u3082\u6d88\u3048\u308b\u3053\u3068\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\nAlmost all file systems like \"/\",\"/root\",\"/tmp\" are not persistent.You may want to save json file in persistent file system. You can use /var and /opt since they are persistent.\n\n```lang:\n# zpool list\nNAME    SIZE  ALLOC   FREE  EXPANDSZ   FRAG    CAP  DEDUP  HEALTH  ALTROOT\nzones  19.9G  2.27G  17.6G         -     8%    11%  1.00x  ONLINE  -\n# df -h | grep zones\nzones                   19G   597K        16G     1%    /zones\nzones/archive           19G    19K        16G     1%    /zones/archive\nzones/cores             10G    19K        10G     1%    /zones/global/cores\nzones/var               19G   3.2M        16G     1%    /var\nzones/config            19G    35K        16G     1%    /etc/zones\nzones/opt               19G    19K        16G     1%    /opt\nzones/usbkey            19G   115K        16G     1%    /usbkey\n```\n\n\u4eca\u56de\u306f\u3053\u3053\u306b\u7f6e\u304d\u307e\u3059\u3002\n\n```lang:\n# vmadm create -f /var/tmp/centos7-spec.json\nSuccessfully created VM a2764418-eee4-4dcc-8596-90dc9c16c536\n```\n`vmadm create`\u306f\u901a\u5e38\u6570\u79d2\u3067\u5b8c\u4e86\u3057\u307e\u3059\u3002(This command will complete in about 10 seconds.)\n\n`vmadm list`\u3067KVM VM\u304c\u4f5c\u6210\u3055\u308c\u305f\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002(Confirm if KVM VM is successfully created.)\n\n```lang:\n# vmadm list\nUUID                                  TYPE  RAM      STATE             ALIAS\na2764418-eee4-4dcc-8596-90dc9c16c536  KVM   512      running           -\n```\n\n\u65b0\u3057\u3044VM(CentOS)\u7528\u306e zfs \u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u304c\u4f5c\u6210\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\nCheck if a zfs file system for newly created VM guest is successfully created.\n\n```lang:\n# df -h | grep zones\nzones                   19G   599K       6.1G     1%    /zones\nzones/archive           19G    19K       6.1G     1%    /zones/archive\nzones/cores             10G    19K       6.1G     1%    /zones/global/cores\nzones/var               19G   3.4M       6.1G     1%    /var\nzones/config            19G    39K       6.1G     1%    /etc/zones\nzones/opt               19G    19K       6.1G     1%    /opt\nzones/usbkey            19G   115K       6.1G     1%    /usbkey\nzones/a2764418-eee4-4dcc-8596-90dc9c16c536    10G    37K       6.1G     1%    /zones/a2764418-eee4-4dcc-8596-90dc9c16c536\nzones/cores/a2764418-eee4-4dcc-8596-90dc9c16c536    10G    19K       6.1G     1%    /zones/a2764418-eee4-4dcc-8596-90dc9c16c536/cores\n```\n\n\u5272\u308a\u5f53\u3066\u305f\u30e1\u30e2\u30ea\u304c\u5c11\u306a\u3044\u7b49\u3067\u30cf\u30f3\u30b0\u3057\u3066\u3057\u307e\u3063\u305f\u5834\u5408\u306b\u306f\u3001SmartOS\u3092Poweroff\u3057\u3066\u518d\u8d77\u52d5\u3057\u307e\u3059\u304c\u3001\u305d\u306e\u5834\u5408\u3001\u30b4\u30df\u304c\u6b8b\u3063\u3066\u3057\u307e\u3046\u3053\u3068\u304c\u3042\u308a\u307e\u3059\u3002\n\nSmartOS might hang when you assigned small memory to it.In such cases you should poweroff SmartOS VMware VM and reboot it.After reboot you may find garbage like the following.\n\n```lang:\n# vmadm list\nUUID                                  TYPE  RAM      STATE             ALIAS\n7e9086da-364b-4ce4-bba4-6ee501099579  KVM   512      failed            -\n# df -h | grep 7e9086da-364b-4ce4-bba4-6ee501099579\nzones/7e9086da-364b-4ce4-bba4-6ee501099579    10G    37K       6.1G     1%    /zones/7e9086da-364b-4ce4-bba4-6ee501099579\nzones/cores/7e9086da-364b-4ce4-bba4-6ee501099579    10G    19K       6.1G     1%    /zones/7e9086da-364b-4ce4-bba4-6ee501099579/cores\n```\n\n\u3053\u306e\u3088\u3046\u306a\u5834\u5408\u306b\u306f\u3001\u4e00\u65e6\u4f5c\u308a\u304b\u3051\u306eKVM VM\u3092\u524a\u9664\u3057\u3066\u3001VMware Player\u306e\u30e1\u30e2\u30ea\u5272\u308a\u5f53\u3066\u3001\u30d7\u30ed\u30bb\u30c3\u30b5\u30b3\u30a2\u5272\u308a\u5f53\u3066\u3092\u898b\u76f4\u3057\u3066\u3084\u308a\u306a\u304a\u3057\u307e\u3059\u3002\n\nIn such case you can delete the failed KVM VM and increase memory and then you can retry.\n\n```lang:\n# vmadm delete 7e9086da-364b-4ce4-bba4-6ee501099579\nSuccessfully deleted VM 7e9086da-364b-4ce4-bba4-6ee501099579\n# vmadm list\nUUID                                  TYPE  RAM      STATE             ALIAS\n# df -h | grep zones\nzones                   19G   597K        16G     1%    /zones\nzones/archive           19G    19K        16G     1%    /zones/archive\nzones/cores             10G    19K        10G     1%    /zones/global/cores\nzones/var               19G   3.2M        16G     1%    /var\nzones/config            19G    35K        16G     1%    /etc/zones\nzones/opt               19G    19K        16G     1%    /opt\nzones/usbkey            19G   115K        16G     1%    /usbkey\n```\n#CentOS VM\u306b\u30b3\u30f3\u30bd\u30fc\u30eb\u63a5\u7d9a\u3059\u308b-CLI\u30b3\u30f3\u30bd\u30fc\u30eb\u7de8(Connect to CentOS VM's console - CLI console)\n\n\u30b3\u30f3\u30bd\u30fc\u30eb\u306b\u306f\u3001`vmadm console` \u30b3\u30de\u30f3\u30c9\u3067\u63a5\u7d9a\u3057\u307e\u3059\u3002\u5f15\u6570\u3068\u3057\u3066\u3001\u63a5\u7d9a\u5148VM\u306eUUID\u304c\u5fc5\u8981\u3067\u3059\u3002\n\nYou can connect VM console by using `vmadm console` command.This command takes UUID of your new VM.\n\n## UUID\u3092\u78ba\u8a8d\u3059\u308b(Check UUID of your VM)\n```lang:\n# vmadm list\nUUID                                  TYPE  RAM      STATE             ALIAS\na2764418-eee4-4dcc-8596-90dc9c16c536  KVM   512      running           -\n```\n## vmadm console\u3067\u30b3\u30f3\u30bd\u30fc\u30eb\u3078\u63a5\u7d9a\u3059\u308b(Connect to VM's console)\n\n```lang:\n# vmadm console a2764418-eee4-4dcc-8596-90dc9c16c536\n\n   __        .                   .\n _|  |_      | .-. .  . .-. :--. |-\n|_    _|     ;|   ||  |(.-' |  | |\n  |__|   `--'  `-' `;-| `-' '  ' `-'\n                   /  ;  Instance (CentOS 7.1 (1503) 20150406)\n                   `-'   https://docs.joyent.com/images/linux/centos\n\ncentos-7 login:\n```\n`vmadm console UUID` \u300cEnter\u300d\u3068\u3057\u3066\u3082\u3059\u3050\u306b\u4f55\u3082\u8868\u793a\u3055\u308c\u306a\u3044\u5834\u5408\u306f\u3001\u3082\u3046\u4e00\u5ea6\u300cEnter\u300d\u3092\u62bc\u3057\u307e\u3059\u3002\n\n## root \u3067\u30ed\u30b0\u30a4\u30f3\u3057\u307e\u3059(Login as root)\n\n\u4eca\u56de\u4f7f\u7528\u3057\u305fVM image\u3067\u306f root \u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u306f\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u307e\u305b\u3093\u3067\u3057\u305f\u3002\n\n```lang:\ncentos-7 login: root\n   __        .                   .\n _|  |_      | .-. .  . .-. :--. |-\n|_    _|     ;|   ||  |(.-' |  | |\n  |__|   `--'  `-' `;-| `-' '  ' `-'\n                   /  ;  Instance (CentOS 7.1 (1503) 20150406)\n                   `-'   https://docs.joyent.com/images/linux/centos\n\n[root@centos-7 ~]#\n```\n## CentOS\u306eVM\u3067\u3042\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b(Check if new VM is CentOS or not)\n\n\u672c\u5f53\u306bCentOS\u304b\u78ba\u304b\u3081\u3066\u307f\u307e\u3059\u3002\n\n```lang:\n# cat /etc/redhat-release\nCentOS Linux release 7.1.1503 (Core)\n```\n\n\u78ba\u304b\u306b\u3001CentOS 7 (7.1.1503)\u3064\u307e\u308aRedHat Enterprise Linux 7.1\u76f8\u5f53\u3067\u3042\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\u3002\n\n## IP \u30a2\u30c9\u30ec\u30b9\u3092\u78ba\u8a8d\u3059\u308b(Get IP address)\n\n\u4eca\u5f8c\u306e\u30ed\u30b0\u30a4\u30f3\u306e\u305f\u3081\u306bIP\u30a2\u30c9\u30ec\u30b9\u3092\u78ba\u8a8d\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n```lang:\n# ip a s\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n    inet6 ::1/128 scope host\n       valid_lft forever preferred_lft forever\n2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000\n    link/ether 32:13:a5:1e:5c:d8 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.231.129/24 brd 192.168.231.255 scope global dynamic eth0\n       valid_lft 1336sec preferred_lft 1336sec\n    inet6 fe80::3013:a5ff:fe1e:5cd8/64 scope link\n       valid_lft forever preferred_lft forever\n```\n\n##VM\u306bALIAS\u3092\u4ed8\u3051\u308b(Add alias)\n`vmadm list`\u3067\u898b\u308b\u3068ALIAS\u304c\"-\"\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002UUID\u3060\u3051\u3060\u3068\u8907\u6570\u306eVM\u3092\u4f5c\u6210\u3059\u308b\u3068\u308f\u304b\u308a\u306b\u304f\u304f\u306a\u308a\u307e\u3059\u306e\u3067\u3001ALIAS\u3092\u4ed8\u3051\u3066\u304a\u304d\u307e\u3059\u3002\n\n```lang:\n# vmadm update a2764418-eee4-4dcc-8596-90dc9c16c536 alias=\"CentOS7.1\"\nSuccessfully updated VM a2764418-eee4-4dcc-8596-90dc9c16c536\n# vmadm list\nUUID                                  TYPE  RAM      STATE             ALIAS\na2764418-eee4-4dcc-8596-90dc9c16c536  KVM   512      running           CentOS7.1\n```\n\n##\u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089\u629c\u3051\u308b(Exit console)\n\"Ctrl-]\"\u3067\u30b3\u30f3\u30bd\u30fc\u30eb\u30bb\u30c3\u30b7\u30e7\u30f3\u3092\u629c\u3051\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n#CentOS VM\u306b\u30b3\u30f3\u30bd\u30fc\u30eb\u63a5\u7d9a\u3059\u308b - \u30d3\u30c7\u30aa\u30b3\u30f3\u30bd\u30fc\u30eb\u7de8(Connect to CentOS VM console - Video console)\n\n`vmadm info <UUID> vnc`\u3067\u3001VNC\u306b\u3088\u308b\u30d3\u30c7\u30aa\u30b3\u30f3\u30bd\u30fc\u30eb\u3078\u306e\u63a5\u7d9a\u60c5\u5831\u3092\u53d6\u5f97\u3067\u304d\u307e\u3059\u3002\u307e\u305a\u3001UUID\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\nYou can get needed information to connect VNC which is provided by QEMU/KVM by using `vmadm info <UUID> vnc`.\n\n```lang:\n# vmadm list | grep CentOS7.1\na2764418-eee4-4dcc-8596-90dc9c16c536  KVM   512      running           CentOS7.1\n```\n\n\u78ba\u8a8d\u3057\u305fUUID\u3092\u5143\u306bVNC\u306e\u63a5\u7d9a\u60c5\u5831\u3092\u53d6\u5f97\u3057\u307e\u3059\u3002\n\n```lang:\n# vmadm info a2764418-eee4-4dcc-8596-90dc9c16c536 vnc\n{\n  \"vnc\": {\n    \"host\": \"192.168.231.128\",\n    \"port\": 58542,\n    \"display\": 52642\n  }\n}\n```\n\nPC\u5074\u3067VNC\u30d3\u30e5\u30fc\u30ef\u3092\u8d77\u52d5\u3057\u3066\u3001\u63a5\u7d9a\u60c5\u5831\u3092\u5165\u529b\u3057\u307e\u3059\u3002\n\u4e0b\u8a18\u306e\u4f8b\u3067\u306f\u3001UltraVNC\u3092\u4f7f\u7528\u3057\u3066\u3044\u307e\u3059\u3002\n\uff08\u79c1\u306e\u74b0\u5883\u3067\u306f\u3001display\u756a\u53f7\u3067\u306e\u63a5\u7d9a\u304c\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u3002\u30dd\u30fc\u30c8\u756a\u53f7\u3067\u63a5\u7d9a\u3057\u3066\u3044\u307e\u3059\u3002\uff09\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/74534/97ba3040-9b8a-9ae7-8242-ce112b40f615.png)\n\n\u300cConnect\u300d\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068\u30d3\u30c7\u30aa\u30b3\u30f3\u30bd\u30fc\u30eb\u3078\u63a5\u7d9a\u3057\u307e\u3059\u3002\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/74534/7cfddf93-06f3-b7cb-37d9-a60b9432145b.png)\n\n##\u30ad\u30fc\u30dc\u30fc\u30c9\u30de\u30c3\u30d7\u306e\u8a2d\u5b9a(Change keyboard map if necessary)\n\u3053\u306e\u307e\u307e\u3067\u3059\u3068VNC\u3067\u306f\u30ad\u30fc\u30dc\u30fc\u30c9\u306e\u30ad\u30fc\u30de\u30c3\u30d7\u304c\u304a\u304b\u3057\u304f\u82f1\u8a9e\u3067\u3082\u65e5\u672c\u8a9e\u3067\u3082\u306a\u3044\u72b6\u614b\u3067\u3057\u305f\uff08\u65e5\u672c\u8a9e\u30ad\u30fc\u30dc\u30fc\u30c9\u3067\";\"\u3092\u62bc\u3057\u3066\u3082\":\"\u3092\u62bc\u3057\u3066\u3082\";\"\u306b\u306a\u308b\u7b49\uff09\u3002\u65e5\u672c\u8a9e\u30ad\u30fc\u30dc\u30fc\u30c9\u3092\u4f7f\u3046\u305f\u3081\u306b\u4ee5\u4e0b\u306e3\u70b9\u306e\u8a2d\u5b9a\u3092\u884c\u3044\u307e\u3057\u305f(\u306a\u304a\u3001Ultra VNC\u306f\u3001Japanese Keyboard\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\u307e\u305f\u3001Tiger VNC\u3082\u8a66\u3057\u307e\u3057\u305f\u304c\u3001\u3053\u3061\u3089\u306fTigaer VNC\u5074\u3067\u306e\u30ad\u30fc\u30dc\u30fc\u30c9\u306e\u8a2d\u5b9a\u306f\u5fc5\u8981\u306a\u3044\u3088\u3046\u3067\u3059)\u3002\n\n### QEMU_KVM\u306e\u30ad\u30fc\u30de\u30c3\u30d7\u306e\u5909\u66f4(Change QEMU KVM keymap)\n\u4ee5\u4e0b\u306e\u3044\u305a\u308c\u304b\u306e\u65b9\u6cd5\u3067\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\nYou can change QEMU KVM keymap by using the following method-1 or method-2.\n\n#### vmadm update \u306b\u3088\u308b\u65b9\u6cd5(Method-1)\nSmartOS\u3067\u306f\u3001`vmadm update <UUID> qemu_extra_opts=\"-k ja\"`\u306b\u3088\u3063\u3066\u3001qemu_kvm \u306b\"-k ja\"\u3068\u3044\u3046\u5f15\u6570\u3092\u6e21\u305b\u307e\u3059\u3002\n#### vmadm create \u6642\u306b\u6e21\u3059 json \u30d5\u30a1\u30a4\u30eb\u306b\"qemu_extra_opts\": \"-k ja\"\u3092\u8a2d\u5b9a\u3059\u308b\u65b9\u6cd5(Method-2)\n\nYou can provide keymap name by json file when you create VM.\n\n```lang:\n# cat centos7-spec.json\n{\n  \"brand\": \"kvm\",\n  \"ram\": \"512\",\n  \"vcpus\": \"1\",\n  \"alias\": \"CentOS 7.1(1503) KVM\",\n  \"hostname\": \"centos7-01\",\n  \"nics\": [\n    {\n      \"nic_tag\": \"admin\",\n      \"ip\": \"dhcp\",\n      \"model\": \"virtio\",\n      \"primary\": true\n    }\n  ],\n  \"disks\": [\n    {\n      \"image_uuid\": \"c41bf236-dc75-11e4-88e5-038814c07c11\",\n      \"boot\": true,\n      \"model\": \"virtio\"\n    }\n  ],\n  \"qemu_extra_opts\": \"-k ja -usbdevice tablet\"\n}\n```\n### CentOS7 \u4e0a\u3067\u3001\u30b3\u30f3\u30bd\u30fc\u30eb\u30ad\u30fc\u30de\u30c3\u30d7\u3092\u5909\u66f4(Change console keymap in CentOS Guest VM)\n```lang:\n# localectl set-keymap jp106\n# localectl status\n   System Locale: LANG=en_US.UTF-8\n       VC Keymap: jp106\n      X11 Layout: jp\n       X11 Model: jp106\n     X11 Options: terminate:ctrl_alt_bksp\n# cat /etc/vconsole.conf\nKEYMAP=jp106\nFONT=latarcyrheb-sun16\n```\n\n### CentOS7\u4e0a\u306e GRUB \u306e\u8a2d\u5b9a\u3067\u30d6\u30fc\u30c8\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u5909\u66f4(Change boot parameter in GRUB setting on CentOS Guest VM)\n`/etc/default/grub`\u306e`GRUB_CMDLINE_LINUX`\u306e`vconsole.keymap=us`\u3092`jp106`\u306b\u5909\u66f4\u5f8c\u3001grub.cfg\u3092\u66f4\u65b0\n\n```lang:\n# cp /boot/grub2/grub.cfg /boot/grub2/grub.cfg.org\n# grub2-mkconfig -o /boot/grub2/grub.cfg\nGenerating grub configuration file ...\nFound linux image: /boot/vmlinuz-3.10.0-229.el7.x86_64\nFound initrd image: /boot/initramfs-3.10.0-229.el7.x86_64.img\nFound linux image: /boot/vmlinuz-3.10.0-229.1.2.el7.x86_64\nFound initrd image: /boot/initramfs-3.10.0-229.1.2.el7.x86_64.img\nFound linux image: /boot/vmlinuz-0-rescue-2b71577b5d2043428953ae1f2a63f3cc\nFound initrd image: /boot/initramfs-0-rescue-2b71577b5d2043428953ae1f2a63f3cc.img\ndone\n```\n\u305d\u3057\u3066\u3001`poweroff`\u3057\u3066\u3001vmadm start\u3057\u3066\u518d\u8d77\u52d5\n\n#CentOS7 KVM VM\u306e\u8d77\u52d5\u6642\u9593\u3092\u77ed\u7e2e\uff08\u304a\u307e\u3051\uff09(Reduce boot time)\n\u3053\u3053\u307e\u3067\u306e\u624b\u9806\u306e\u307e\u307e\u3067\u306f\u3001CentOS\u306e\u8d77\u52d5\u306b\u304b\u306a\u308a\u6642\u9593\u304c\u304b\u304b\u308a\u307e\u3059\u3002\nsystemd-analyze\u3057\u3066\u307f\u308b\u3068\n\n```lang:\n# systemd-analyze\nStartup finished in 4.109s (kernel) + 20.986s (initrd) + 2min 33.714s (userspace) = 2min 58.811s\n\n# systemd-analyze blame\n         59.051s rc-local.service\n         44.259s postfix.service\n         40.752s network.service\n         18.748s firewalld.service\n         12.622s tuned.service\n          8.111s boot.mount\n          6.131s ntpdate.service\n          5.636s systemd-udev-trigger.service\n          5.131s rhel-dmesg.service\n          4.487s systemd-logind.service\n          4.115s rsyslog.service\n          4.019s systemd-fsck-root.service\n          3.274s kmod-static-nodes.service\n          3.209s acpid.service\n          3.068s systemd-vconsole-setup.service\n          2.372s systemd-fsck@dev-disk-by\\x2duuid-01cf7647\\x2d0b01\\x2d4105\\x2d97\n          2.302s polkit.service\n          2.285s NetworkManager.service\n          2.206s systemd-tmpfiles-setup-dev.service\n          1.955s dev-disk-by\\x2duuid-81fd73a2\\x2db584\\x2d4958\\x2daecf\\x2dd8b147f\n          1.852s rhel-import-state.service\n          1.617s rhel-readonly.service\n          1.558s sys-kernel-debug.mount\nlines 1-23\n```\nrc-local \u3068 postfix \u306b\u6642\u9593\u304c\u304b\u304b\u3063\u3066\u3044\u307e\u3059\u3002\n/etc/rc.local \u3092\u307f\u3066\u307f\u308b\u3068 Joyent\u306e SmartDataCenter(SDC)\u306b\u95a2\u3059\u308b\u51e6\u7406\u3092\u3057\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u306e\u3067\u3001\u3068\u308a\u3042\u3048\u305a\u6b62\u3081\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\n```lang:\n# chmod 666 /etc/rc.local\n# ls -l /etc/rc.local\nlrwxrwxrwx. 1 root root 13 Apr  6 15:51 /etc/rc.local -> rc.d/rc.local\n# ls -l /etc/rc.d/rc.local\nlrwxrwxrwx. 1 root root 28 Apr  6 15:51 /etc/rc.d/rc.local -> /lib/smartdc/joyent_rc.local\n# ls -l /lib/smartdc/joyent_rc.local\n-rw-rw-rw-. 1 root root 3009 Apr  6 15:51 /lib/smartdc/joyent_rc.local\n```\n\u3055\u3089\u306b\u3001postfix \u3082\u6b62\u3081\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\n```lang:\n# systemctl stop postfix.service\n# systemctl disable postfix.service\nrm '/etc/systemd/system/multi-user.target.wants/postfix.service'\n```\nnetwork.service\u3082\u6642\u9593\u304c\u304b\u304b\u308a\u904e\u304e\u306a\u3088\u3046\u3067\u3059\u304c\u3001\u3053\u308c\u306f\u8ffd\u53ca\u3059\u308b\u3068\u6642\u9593\u304c\u304b\u304b\u308a\u305d\u3046\u3067\u3059\u306e\u3067\u3001\u3053\u3053\u307e\u3067\u3067\u3002\n\n\u3055\u3066\u3001`poweroff` \u3057\u3066 `vmadm start <UUID>`\u3057\u3066\u307f\u308b\u3068\u3001\u4f53\u611f\u3067\u306f\u304b\u306a\u308a\u901f\u304f\u306a\u3063\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\n\n```lang:\n# systemd-analyze\nStartup finished in 4.203s (kernel) + 21.121s (initrd) + 1min 36.252s (userspace) = 2min 1.577s\n# systemd-analyze blame\n         40.593s network.service\n         19.895s firewalld.service\n         14.002s tuned.service\n          5.799s ntpdate.service\n          5.763s systemd-udev-trigger.service\n          5.527s rhel-dmesg.service\n          5.219s systemd-logind.service\n          4.758s rsyslog.service\n          4.020s systemd-fsck-root.service\n          3.340s acpid.service\n          3.135s systemd-vconsole-setup.service\n          3.133s kmod-static-nodes.service\n          3.001s NetworkManager.service\n          2.868s plymouth-quit.service\n          2.818s systemd-fsck@dev-disk-by\\x2duuid-01cf7647\\x2d0b01\\x2d4105\\x2d97\n          2.346s polkit.service\n          2.334s systemd-tmpfiles-setup-dev.service\n          1.960s rhel-import-state.service\n          1.897s plymouth-quit-wait.service\n          1.777s rhel-readonly.service\n          1.766s dev-disk-by\\x2duuid-81fd73a2\\x2db584\\x2d4958\\x2daecf\\x2dd8b147f\n          1.616s auditd.service\n          1.584s sys-kernel-debug.mount\nlines 1-23\n```\n\u78ba\u304b\u306brc-local\u3068postfix\u304c\u306a\u304f\u306a\u3063\u3066\u901f\u304f\u306a\u3063\u3066\u3044\u307e\u3059\u3002\u5f37\u5f15\u3067\u3059\u304c\u5c11\u3057\u904a\u3076\u306b\u306f\u3053\u308c\u3067\u3002\n\n\n#\u88dc\u8db3\nGlobal Zone(SmarOS\u305d\u306e\u3082\u306e)\u306f\u3001/usbkey\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u4ee5\u5916\u306b\u306f\u4e0d\u63ee\u767a\u6027\u306e\u30b9\u30c8\u30ec\u30fc\u30b8\u3092\u6301\u305f\u305a\u3001\u518d\u8d77\u52d5\u3059\u308b\u3068\u5909\u66f4\u304c\u5931\u308f\u308c\u3066\u3057\u307e\u3044\u307e\u3059\u3002\u305d\u306e\u305f\u3081\u3001\u30ad\u30fc\u30dc\u30fc\u30c9\u306e\u8a2d\u5b9a\u3084ssh\u516c\u958b\u9375\u306e\u767b\u9332\u306a\u3069\u306f\u3001Linux\u3084Solaris\u3068\u306f\u7570\u306a\u308b\u624b\u9806\u304c\u5fc5\u8981\u3067\u3059\u3002\u4e00\u65b9\u3067\u3001\u4eca\u56de\u4f5c\u6210\u3057\u305f KVM VM \u3084 SmartOS\u306ezones(\u30b3\u30f3\u30c6\u30ca)\u306f\u3001\u30c7\u30a3\u30b9\u30af\u4e0a\uff08zones pool\uff09\u306b\u4fdd\u5b58\u3055\u308c\u3066\u3044\u307e\u3059\u3002CentOS KVM VM\u306f\u901a\u5e38\u306eCentOS\u3068\u5168\u304f\u540c\u3058\u3088\u3046\u306b\u904b\u7528\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u306f\u305a\u3067\u3059\u3002\n\n\u307e\u305f\u3001KVM\u306eVM\u3067\u306f\u306a\u304f\u3001LX Branded Zone\uff08Linux\u30b3\u30f3\u30c6\u30ca\uff09\u3068\u3057\u3066Ubuntu 14.04\u3092\u52d5\u304b\u3057\u3066\u307f\u308b\u306b\u306f\u3001[SmartOS\u306eLX Branded Zone\uff08Linux\u30b3\u30f3\u30c6\u30ca\uff09\u3092\u52d5\u304b\u3059](http://qiita.com/kutsushitaneko/items/7216237d5929e0f715db)\u3092\u307f\u3066\u307f\u3066\u304f\u3060\u3055\u3044\u3002\n\n#\u672a\u89e3\u6c7a\u306a\u554f\u984c\n\n## reboot\u30b3\u30de\u30f3\u30c9\u3067\u30cf\u30f3\u30b0\uff08\u56de\u907f\u7b56\u306f\u3001poweroff\u30b3\u30de\u30f3\u30c9\uff09\nCentOS\u3092\u518d\u8d77\u52d5\u3059\u308b\u969b\u306b `reboot` \u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u3046\u3068VM\u304c\u30cf\u30f3\u30b0\u3057\u3066\u3057\u307e\u3046\uff08\u3082\u3057\u304f\u306f\u3001\u505c\u6b62\u306b\u7570\u5e38\u306b\u6642\u9593\u304c\u304b\u304b\u3066\u3044\u308b\uff09\u3002`reboot`\u767a\u884c\u5f8c\u3001Global Zone\u3067\u3001`vmadm list`\u3067\u307f\u3066\u307f\u308b\u3068\"STATE\"\u304c\"running\"\u306e\u307e\u307e\u3068\u306a\u308a\u3001`vmadm console <UUID>`\u3067\u3082VNC\u30b3\u30f3\u30bd\u30fc\u30eb\u3067\u3082\u63a5\u7d9a\u3067\u304d\u306a\u3044\u72b6\u614b\u3068\u306a\u308a\u307e\u3059\u3002\u3053\u306e\u5834\u5408\u3001`vmadm stop <UUID>`\u3067\u505c\u6b62\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u304c\u3001\u6570\u5206\u304b\u304b\u308a\u307e\u3059\u3002\n\u306a\u304a\u3001`reboot`\u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u308f\u305a\u3001`poweroff`\u30b3\u30de\u30f3\u30c9\u3067\u30b7\u30e3\u30c3\u30c8\u30c0\u30a6\u30f3\u3057\u3066\u3001`vmadm start <UUID>`\u3068\u3059\u308b\u3068\u554f\u984c\u306a\u304f\u518d\u8d77\u52d5\u3067\u304d\u307e\u3059\u3002\n\n\n\n", "tags": ["smartos", "KVM", "CentOS", "Solaris", "Virtualization"]}