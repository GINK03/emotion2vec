{"context": " More than 1 year has passed since last update.\n\n\u306f\u3058\u3081\u306b\n\u3053\u3093\u306b\u3061\u306f\u3002\n\u524d\u56de\u306b\u5f15\u304d\u7d9a\u304d\u3001SparkInternals\u3092\u8a33\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\u524d\u56de\u3068\u540c\u3058\u304f\u4ee5\u5f8c\u306f\u4e0b\u8a18\u306e\u5224\u4f8b\u3068\u306a\u308a\u307e\u3059\u3002\nSparkInternals\u8a33\u6587\n\u30b3\u30e1\u30f3\u30c8\n\nSparkInternals\n\nShuffle Process\n\u3053\u3053\u307e\u3067\u3067Spark\u306ePhysicalPlan\u3068\u3001\u305d\u308c\u3092\u3069\u3046\u5b9f\u884c\u3059\u308b\u304b\u306e\u8a73\u7d30\u3092\u66f8\u3044\u3066\u304d\u305f\u3002\u3060\u304c\u3001ShuffleDependency\u3092\u901a\u3057\u3066\u6b21\u306eStage\u304c\u3069\u306e\u3088\u3046\u306b\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3059\u308b\u304b\u306b\u3064\u3044\u3066\u306f\u89e6\u308c\u3089\u308c\u3066\u3044\u306a\u304b\u3063\u305f\u305f\u3081\u3001\u672c\u7ae0\u3067\u3053\u308c\u3092\u8a18\u8ff0\u3059\u308b\u3002\n\nShuffle Comparison between Hadoop and Spark\nHadoop MapReduce\u3068Spark\u306eShuffle\u30d7\u30ed\u30bb\u30b9\u306b\u306f\u5171\u901a\u70b9\u3068\u76f8\u9055\u70b9\u304c\u5b58\u5728\u3059\u308b\u3002\n\u62bd\u8c61\u5316\u3057\u305f\u30ec\u30d9\u30eb\u3067\u898b\u308b\u3068\u3001\u4e21\u8005\u306f\u5171\u901a\u3057\u3066\u3044\u308b\u3002\n\u4e21\u8005\u306f\u5171\u306bMapper(Spark\u306e\u5834\u5408\u3001ShuffleMapTask)\u306e\u51fa\u529b\u3092\u5206\u5272\u3057\u3001\u5bfe\u5fdc\u3059\u308bReducer(Spark\u306e\u5834\u5408\u3001\u6b21\u306eStage\u306eShuffleMapTask\u304b\u3001ResultTask)\u306b\u9001\u4fe1\u3059\u308b\u3068\u3044\u3046\u69cb\u9020\u3092\u6301\u3063\u3066\u3044\u308b\u3002Reducer\u5074\u306f\u305d\u306e\u30c7\u30fc\u30bf\u3092\u30e1\u30e2\u30ea\u4e0a\u306b\u4fdd\u6301\u3057\u3001Shuffle&Aggregate\u3092\u884c\u3063\u305f\u3046\u3048\u3067\u5b9f\u969b\u306ereduce()\u3092\u9069\u7528\u3059\u308b\u3053\u3068\u3067\u30c7\u30fc\u30bf\u306e\u7d71\u5408\u3092\u884c\u3046\u3002\n\u3088\u308a\u5b9f\u88c5\u30ec\u30d9\u30eb\u306b\u8fd1\u3065\u3044\u305f\u8996\u70b9\u3067\u898b\u308b\u3068\u3001\u4e21\u8005\u306b\u306f\u9055\u3044\u304c\u3042\u308b\u3002\nHadoop MapReduce\u306b\u304a\u3051\u308bShuffle\u306fSort\u30d9\u30fc\u30b9\u306b\u306a\u3063\u3066\u304a\u308a\u3001combine()\u3001reduce()\u5b9f\u884c\u524d\u306b\u3042\u3089\u304b\u3058\u3081\u30bd\u30fc\u30c8\u304c\u5b8c\u4e86\u3057\u3066\u3044\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\u305d\u306e\u30bd\u30fc\u30c8\u51e6\u7406\u306f\u5916\u90e8\u30bd\u30fc\u30c8\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3067\u5b9f\u65bd\u3055\u308c\u3066\u3044\u308b\u3002\n\u5bfe\u3057\u3066\u3001\u73fe\u72b6Spark\u306eShuffle\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u52d5\u4f5c\u306fHash\u30d9\u30fc\u30b9\u3068\u306a\u3063\u3066\u3044\u308b\u3002\u901a\u5e38\u306f\u305d\u306e\u7d50\u5408\u51e6\u7406\u306fHashMap\u3092\u7528\u3044\u3066\u5b9f\u65bd\u3055\u308c\u3001\u30bd\u30fc\u30c8\u304c\u4e8b\u524d\u306b\u884c\u308f\u308c\u308b\u3068\u3044\u3046\u3053\u3068\u306f\u306a\u3044\u3002\u3082\u3057\u30c7\u30fc\u30bf\u3092\u30bd\u30fc\u30c8\u3057\u3066\u304b\u3089\u5229\u7528\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u5834\u5408\u3001\u660e\u793a\u7684\u306bsortByKey()\u3092\u5b9f\u884c\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\u305f\u3060\u3057\u3001Spark1.1\u304b\u3089Sort\u30d9\u30fc\u30b9\u306eShuffle\u30d7\u30ed\u30bb\u30b9\u3082\u5b9f\u884c\u53ef\u80fd\u306b\u306a\u3063\u3066\u304a\u308a\u3001Spark1.2\u4ee5\u964d\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u306eShuffle\u30d7\u30ed\u30bb\u30b9\u306e\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3082Sort\u30d9\u30fc\u30b9\u3068\u306a\u3063\u3066\u3044\u308b\u3002\nSpark1.2\u4ee5\u964d\u306eShuffle\u306fSort\u7248\u3068\u306a\u3063\u3066\u3044\u307e\u3059\u3002Sort\u7248Shuffle\u306e\u8a73\u7d30\u306fSpark Architecture:Shuffle\u3067\u8aac\u660e\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\u5b9f\u88c5\u9762\u3067\u898b\u305f\u5834\u5408\u3001\u540c\u69d8\u306b\u9055\u3044\u304c\u5b58\u5728\u3059\u308b\u3002\n\u65e2\u306b\u308f\u304b\u3063\u3066\u3044\u308b\u3088\u3046\u306b\u3001Hadoop MapReduce\u306b\u304a\u3044\u3066\u306f\u660e\u78ba\u306amap() > spill > merge >  shuffle > sort > reduce()\u3068\u3044\u3046\u6d41\u308c\u304c\u5b58\u5728\u3057\u3066\u304a\u308a\u3001\u5404Step\u306f\u4e8b\u524d\u5b9a\u7fa9\u3055\u308c\u3066\u304a\u308a\u3001\u624b\u7d9a\u304d\u578b\u306e\u30d7\u30ed\u30b0\u30e9\u30df\u30f3\u30b0\u3068\u76f8\u6027\u306e\u3044\u3044\u3082\u306e\u3068\u306a\u3063\u3066\u3044\u308b\u3002\n\u3057\u304b\u3057\u306a\u304c\u3089\u3001Spark\u306b\u304a\u3044\u3066\u306f\u305d\u306e\u3088\u3046\u306a\u56fa\u5b9a\u5316\u3055\u308c\u305fStep\u306f\u5b58\u5728\u305b\u305a\u3001\u4ee3\u308f\u308a\u306bStage\u7fa4\u3068\u4e00\u9023\u306eTransformation\u304c\u5b58\u5728\u3057\u3066\u3044\u308b\u3002\u305d\u306e\u305f\u3081\u3001spill\u3001merge\u3001aggregate\u3068\u3044\u3063\u305f\u51e6\u7406\u306f\u4e00\u9023\u306eTransformation\u306b\u5185\u5305\u3055\u308c\u308b\u5f62\u306b\u306a\u3063\u3066\u3044\u308b\u3002\nMapper\u5074\u306ePartition\u5206\u5272\u3001\u304a\u3088\u3073\u30c7\u30fc\u30bf\u4fdd\u6301\u30d7\u30ed\u30bb\u30b9\u3092\"Shuffle Write\"\u3001Reducer\u5074\u306e\u30c7\u30fc\u30bf\u8aad\u307f\u8fbc\u307f\u3001\u96c6\u8a08\u30d7\u30ed\u30bb\u30b9\u3092\"Shuffle Read\"\u3068\u540d\u3065\u3051\u308b\u3002\u3059\u308b\u3068\u3001Shuffle Write/Shuffle Read\u3092\u3069\u306e\u3088\u3046\u306bSpark\u306eLogicalPlan/PhysicalPlan\u3068\u7d71\u5408\u3059\u308c\u3070\u3044\u3044\u306e\u304b\u3001\u3068\u3044\u3046\u554f\u984c\u304c\u751f\u3058\u308b\u3002Shuffle Write/Shuffle Read\u3092\u52b9\u7387\u7684\u306b\u5b9f\u884c\u3059\u308b\u306b\u306f\u3069\u306e\u3088\u3046\u306b\u5b9f\u88c5\u3059\u308c\u3070\u3044\u3044\u306e\u3060\u308d\u3046\u304b\uff1f\n\nShuffle Write\nShuffle Write\u306fSort\u3055\u308c\u305f\u51fa\u529b\u304c\u5fc5\u8981\u306a\u3044\u5834\u5408\u3001\u76f8\u5bfe\u7684\u306a\u30b7\u30f3\u30d7\u30eb\u306a\u69cb\u6210\u306eTask\u3068\u306a\u308b\u3002Shuffle Write\u306f\u30c7\u30fc\u30bf\u3092\u5206\u5272\u3057\u3001\u51fa\u529b\u3059\u308b\u306e\u307f\u3068\u306a\u308b\u3002\u3053\u306e\u3088\u3046\u306a\u30c7\u30fc\u30bf\u6c38\u7d9a\u5316\u306f\u300c\u30d2\u30fc\u30d7\u9818\u57df\u4f7f\u7528\u91cf\u524a\u6e1b\u300d\u300c\u8010\u969c\u5bb3\u6027\u300d\u306e2\u500b\u306e\u5229\u70b9\u3092\u6301\u3064\u3002\n\u672c\u6a5f\u80fd\u306e\u5b9f\u88c5\u306f\u30b7\u30f3\u30d7\u30eb\u3068\u306a\u308b\u3002ShuffleMapStage(\u306eShuffleMapTask)\u306e\u6700\u5f8c\u306bShuffle Write\u3092\u884c\u3046\u30ed\u30b8\u30c3\u30af\u3092\u8ffd\u52a0\u3059\u308c\u3070\u3044\u3044\u3002\u6700\u7d42RDD\u306b\u542b\u307e\u308c\u308b\u5404\u51fa\u529b\u30ec\u30b3\u30fc\u30c9\u306f\u4e0b\u56f3\u306e\u3088\u3046\u306b\u5206\u5272\u3055\u308c\u51fa\u529b\u3055\u308c\u308b\u3002\n\n\u4e0a\u8a18\u306e\u56f3\u306b\u304a\u3044\u3066\u306f4\u500b\u306eShuffleMapTasks\u304c2\u500b\u306eCore\u3092\u4fdd\u6301\u3059\u308b\u540c\u4e00Worker\u30ce\u30fc\u30c9\u4e0a\u3067\u5b9f\u884c\u3055\u308c\u3066\u3044\u308b\u3002Task\u5b9f\u884c\u7d50\u679c(Stage\u306e\u6700\u7d42RDD\u4e2d\u306eRecord\u30ea\u30b9\u30c8)\u306f\u30ed\u30fc\u30ab\u30eb\u30c7\u30a3\u30b9\u30af\u306b\u51fa\u529b\u3055\u308c\u308b\u3002\u5404Task\u306fR\u500b(\uff1d\u6b21Stage\u306b\u5b58\u5728\u3059\u308bReducer Task\u306e\u6570)\u306e\u30d0\u30c3\u30d5\u30a1\u3092\u4fdd\u6301\u3059\u308b\u3002\u3053\u306e\u30d0\u30c3\u30d5\u30a1\u7fa4\u306fSpark\u3067\u306fbuckets\u3068\u547c\u3070\u308c\u308b\u3002\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\u5404bucket\u306e\u30b5\u30a4\u30ba\u306f32KB(Spark1.1\u4ee5\u524d\u306f100KB)\u3068\u306a\u3063\u3066\u304a\u308a\u3001\u3053\u306e\u30b5\u30a4\u30ba\u306f\u8a2d\u5b9aspark.shuffle.file.buffer.kb\u3067\u8a2d\u5b9a\u53ef\u80fd\u3068\u306a\u3063\u3066\u3044\u308b\u3002\nbucket\u306fSpark\u306b\u304a\u3051\u308bShuffleMapTask\u306e\u30c7\u30fc\u30bf\u5206\u5272\u7d50\u679c\u306e\u51fa\u529b\u5148\u3092\u793a\u3059\u5171\u901a\u7684\u306a\u6982\u5ff5\u3068\u306a\u3063\u3066\u3044\u308b\u3002\u305f\u3060\u3001\u3053\u3053\u3067\u306f\u5358\u7d14\u5316\u306e\u305f\u3081\u306bbucket\u306f\u30e1\u30e2\u30ea\u4e0a\u306e\u30d0\u30c3\u30d5\u30a1\u3068\u3057\u3066\u6271\u3046\u3002\nShuffleMapTask\u306f\u6700\u7d42RDD\u306e\u7d50\u679c\u3092\u7b97\u51fa\u3059\u308b\u305f\u3081\u306b\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\u5316\u6280\u8853\u3092\u4f7f\u7528\u3057\u3066\u3044\u308b\u3002\u5404Record\u306fpartitioner.partition(record.getKey())\u3067\u6c7a\u5b9a\u3055\u308c\u308b\u6240\u5c5ebucket\u306b\u5bfe\u3057\u3066\u9001\u4fe1\u3055\u308c\u308b\u3002\u3053\u308c\u3089\u306ebucket\u4e2d\u306e\u30c7\u30fc\u30bf\u306f\u7d99\u7d9a\u7684\u306b\u30ed\u30fc\u30ab\u30eb\u30d5\u30a1\u30a4\u30eb\u4e0a\u306bShuffleBlockFile\u3001\u307e\u305f\u306f\u7565\u3057\u3066FileSegment\u3068\u3057\u3066\u547c\u3070\u308c\u308b\u30d5\u30a1\u30a4\u30eb\u5f62\u614b\u3068\u3057\u3066\u7d99\u7d9a\u7684\u306b\u51fa\u529b\u3055\u308c\u308b\u3002Reducers\u306fShuffle Read\u30d5\u30a7\u30fc\u30ba\u306b\u304a\u3044\u3066\u3001\u3053\u308c\u3089\u306eFileSegment\u304b\u3089\u30c7\u30fc\u30bf\u3092\u8aad\u307f\u8fbc\u3080\u3002\n\u3053\u306e\u3088\u3046\u306a\u5b9f\u88c5\u306f\u975e\u5e38\u306b\u30b7\u30f3\u30d7\u30eb\u306b\u6e08\u3080\u304c\u3001\u3044\u304f\u3064\u304b\u306e\u691c\u8a0e\u4e8b\u9805\u3082\u6301\u3064\u3002\n1. \u975e\u5e38\u306b\u6570\u591a\u304f\u306eFileSegment\u3092\u51fa\u529b\u3059\u308b\u5371\u967a\u6027\u304c\u3042\u308b\u3068\u3044\u3046\u3053\u3068\u3002\u5404ShuffleMapTask\u306fR(\uff1d\u6b21Stage\u306b\u5b58\u5728\u3059\u308bReducer Task\u306e\u6570)\u500b\u306eFileSegment\u3092\u51fa\u529b\u3059\u308b\u3001\u3064\u307e\u308aM\u500b\u306eShuffleMapTask\u306fM * R\u500b\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u51fa\u529b\u3059\u308b\u3002\u5927\u304d\u306a\u30c7\u30fc\u30bf\u30bb\u30c3\u30c8\u306b\u5bfe\u3057\u3066\u51e6\u7406\u3092\u884c\u3046\u5834\u5408\u306b\u306fM\u3082R\u3082\u5de8\u5927\u306a\u5024\u3068\u306a\u308a\u3001\u305d\u308c\u3060\u3051\u5927\u91cf\u306e\u4e2d\u9593\u30c7\u30fc\u30bf\u30d5\u30a1\u30a4\u30eb\u3092\u4fdd\u6301\u3059\u308b\u3053\u3068\u306b\u306a\u3063\u3066\u3057\u307e\u3046\u3002\n2. \u3053\u308c\u3089\u306e\u30d0\u30c3\u30d5\u30a1\u306f\u5927\u91cf\u306e\u30b9\u30da\u30fc\u30b9\u3092\u78ba\u4fdd\u3059\u308b\u30b1\u30fc\u30b9\u304c\u3042\u308b\u3068\u3044\u3046\u3053\u3068\u3002Worker\u30ce\u30fc\u30c9\u306b\u304a\u3044\u3066\u3001Spark\u306b\u7528\u3044\u308b\u3053\u3068\u304c\u51fa\u6765\u308bCore\u6bce\u306bR * M\u500b\u306ebucket\u3092\u78ba\u4fdd\u3055\u308c\u308b\u8a08\u7b97\u3068\u306a\u308b\u3002Spark\u3067\u306fShuffleMapTask\u5b9f\u884c\u5f8c\u306b\u3053\u306e\u30d0\u30c3\u30d5\u30a1\u3092\u518d\u5229\u7528\u3059\u308b\u306e\u3060\u304c\u3001R * n \u500b\u306ebucket\u306f\u30e1\u30e2\u30ea\u4e0a\u306b\u6b8b\u3063\u3066\u3057\u307e\u3046\u3002\u4f8b\u3048\u30708Core\u3092\u4fdd\u6301\u3057\u30661000ReducerJob\u304c\u5b58\u5728\u3059\u308b\u30b1\u30fc\u30b9\u3092\u8003\u3048\u308b\u3068\u3001bucket\u306e\u7dcf\u5bb9\u91cf\u306f256MB\u306b\u3082\u9054\u3059\u308b\u3002(R * cores * 32KB)\n\u73fe\u5728\u306f2\u500b\u76ee\u306e\u554f\u984c\u306b\u5bfe\u3057\u3066\u3042\u307e\u308a\u3088\u308d\u3057\u304f\u306a\u3044\u89e3\u6c7a\u7b56\u304c\u9069\u7528\u3055\u308c\u3066\u3044\u308b\u3002\u3068\u306b\u304b\u304f\u30d0\u30c3\u30d5\u30a1\u306b\u66f8\u304d\u8fbc\u3080\u5fc5\u8981\u304c\u3042\u308b\u95a2\u4fc2\u4e0a\u3001\u30d0\u30c3\u30d5\u30a1\u304c\u5c0f\u3055\u3059\u304e\u308b\u5834\u5408\u3001IO\u901f\u5ea6\u306b\u5f71\u97ff\u304c\u51fa\u308b\u30021\u500b\u76ee\u306e\u554f\u984c\u306b\u5bfe\u3057\u3066\u306f\u30d5\u30a1\u30a4\u30eb\u3092\u96c6\u7d04\u3059\u308b\u65b9\u5f0f\u304c\u3059\u3067\u306b\u5b9f\u88c5\u6e08\u307f\u3068\u306a\u3063\u3066\u3044\u308b\u3002\u305d\u306e\u65b9\u5f0f\u306b\u3064\u3044\u3066\u898b\u3066\u307f\u3088\u3046\u3002\n\n\u4e0a\u8a18\u306e\u56f3\u304b\u3089\u660e\u767d\u3060\u3068\u306f\u601d\u3046\u304c\u3001ShuffleMapTasks\u304c1Core\u4e0a\u3067\u9023\u7d9a\u3057\u3066\u5b9f\u884c\u3055\u308c\u308b\u5834\u5408\u3001Shuffle\u7528\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u5171\u6709\u3059\u308b\u65b9\u5f0f\u3068\u306a\u3063\u3066\u3044\u308b\u3002\u5404Task\u306f\u51fa\u529b\u30c7\u30fc\u30bf\u3092\u524dTask\u304c\u51fa\u529b\u3057\u305fShuffleBlock i\u306b\u5bfe\u3057\u3066ShuffleBlock i'\u3068\u3057\u3066\u8ffd\u8a18\u3059\u308b\u3002\u3053\u3053\u3067ShuffleBlock\u306fFileSegment\u3068\u547c\u3070\u308c\u308b\u3002\u3053\u306e\u65b9\u5f0f\u306b\u304a\u3044\u3066\u306f\u6b21Stage\u306eReducer\u7fa4\u306f\u3053\u306e\u51fa\u529b\u3055\u308c\u305f\u30d5\u30a1\u30a4\u30eb\u3092\u4e38\u3005\u8aad\u307f\u8fbc\u3080\u3060\u3051\u3067\u3088\u304f\u3001\u5404Worker\u30ce\u30fc\u30c9\u3067\u51fa\u529b\u3055\u308c\u308b\u30d5\u30a1\u30a4\u30eb\u6570\u3092Cores * R\u307e\u3067\u524a\u6e1b\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\u30d5\u30a1\u30a4\u30eb\u96c6\u7d04\u6a5f\u80fd\u306f \u8a2d\u5b9aspark.shuffle.consolidateFiles\u306b\u3066\u6709\u52b9\u5316\u53ef\u80fd\u3002\n\nShuffle Read\n\u307e\u305a\u306fShuffleDependency\u3092\u542b\u3080reduceBykey\u306ePhysicalPlan\u3092\u898b\u3066\u307f\u3088\u3046\u3002\n\n\u76f4\u611f\u7684\u306bShuffleRDD\u3092\u69cb\u6210\u3059\u308b\u305f\u3081\u306bMapPartitionRDD\u306e\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3053\u3068\u306f\u308f\u304b\u308b\u3002\n\u305f\u3060\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306a\u554f\u984c\u304c\u3042\u308b\u3002\n\u3044\u3064\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3059\u308b\u306e\u304b\uff1f\u5404ShuffleMapTask\u304c\u5b9f\u884c\u3055\u308c\u308b\u6bce\u306b\u53d6\u5f97\u3059\u308b\u306e\u304b\uff1f\u305d\u308c\u3068\u3082\u3059\u3079\u3066\u306eShuffleMapTasks\u306e\u5b9f\u884c\u5b8c\u4e86\u5f8c\u306b\u307e\u3068\u3081\u3066\u53d6\u5f97\u3059\u308b\u306e\u304b\uff1f\n\u53d6\u5f97\u3068\u53d6\u5f97\u3057\u305f\u30ec\u30b3\u30fc\u30c9\u306e\u51e6\u7406\u306f\u540c\u6642\u306b\u5b9f\u884c\u3059\u308b\u306e\u304b\u3001\u305d\u308c\u3068\u3082\u5225\u3005\u306e\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u884c\u3046\u306e\u304b\uff1f\n\u53d6\u5f97\u3057\u305f\u30c7\u30fc\u30bf\u306f\u3069\u3053\u306b\u4fdd\u6301\u3059\u308b\u306e\u304b\uff1f\n\u6b21Stage\u306eTask\u306f\u3069\u306e\u3088\u3046\u306b\u53d6\u5f97\u3055\u308c\u305f\u30c7\u30fc\u30bf\u306e\u5834\u6240\u3092\u7279\u5b9a\u3059\u308b\u306e\u304b\uff1f\nSpark\u3067\u306e\u65b9\u5f0f\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3068\u306a\u308b\u3002\n\u3044\u3064\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3059\u308b\u306e\u304b\uff1f\n\u5168ShuffleMapTasks\u306e\u7d42\u4e86\u3092\u5f85\u3061\u3001\u305d\u306e\u5f8c\u30c7\u30fc\u30bf\u306e\u53d6\u5f97\u3092\u884c\u3046\u3002\u65e2\u306b\u308f\u304b\u3063\u3066\u3044\u308b\u3068\u304a\u308a\u3001Stage\u306f\u89aaStage\u304c\u3059\u3079\u3066\u5b9f\u884c\u3055\u308c\u305f\u5f8c\u306b\u5b9f\u884c\u3055\u308c\u308b\u3002\u305d\u306e\u305f\u3081\u3001\u30c7\u30fc\u30bf\u53d6\u5f97\u51e6\u7406\u304c\u524dStage\u306e\u5168ShuffleMapTasks\u5b9f\u884c\u5f8c\u306b\u59cb\u307e\u308b\u3053\u3068\u306f\u76f4\u611f\u7684\u306b\u308f\u304b\u308b\u3060\u308d\u3046\u3002\u53d6\u5f97\u3057\u305fFileSegments\u306f\u30e1\u30e2\u30ea\u4e0a\u306b\u4fdd\u6301\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u304c\u3001\u305d\u308c\u3060\u3051\u3060\u3068\u53d6\u5f97\u3057\u305f\u30c7\u30fc\u30bf\u3092\u30c7\u30a3\u30b9\u30af\u306b\u51fa\u529b\u3059\u308b\u524d\u306b\u5927\u91cf\u306e\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u306a\u3044\u3053\u3068\u306b\u306a\u308b\u3002Spark\u3067\u306f\u8a2d\u5b9aspark.reducer.maxMbInFlight\u306b\u3088\u3063\u3066\u3053\u306e\u53d6\u5f97\u7528\u30d0\u30c3\u30d5\u30a1\u306e\u30b5\u30a4\u30ba\u3092\u8a2d\u5b9a\u3057\u3066\u3044\u308b\u3002\u30c7\u30d5\u30a9\u30eb\u30c8\u306f48MB\u3068\u306a\u3063\u3066\u3044\u308b\u3002\u3053\u306e\u30d0\u30c3\u30d5\u30a1(SoftBuffer)\u306f\u666e\u6bb5\u306f\u8907\u6570\u306e\u53d6\u5f97\u3055\u308c\u305fFileSegments\u3092\u4fdd\u6301\u3059\u308b\u304c\u3001\u30c7\u30fc\u30bf\u30b5\u30a4\u30ba\u6b21\u7b2c\u3067\u306f1\u500b\u306eFileSegments\u3067\u5360\u6709\u3055\u308c\u3066\u3057\u307e\u3046\u30b1\u30fc\u30b9\u3082\u3042\u308b\u3002\n\u53d6\u5f97\u3068\u53d6\u5f97\u3057\u305f\u30ec\u30b3\u30fc\u30c9\u306e\u51e6\u7406\u306f\u540c\u6642\u306b\u5b9f\u884c\u3059\u308b\u306e\u304b\u3001\u305d\u308c\u3068\u3082\u5225\u3005\u306e\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u884c\u3046\u306e\u304b\uff1f\nRecord\u306e\u53d6\u5f97\u3068\u51e6\u7406\u306f\u540c\u3058\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u884c\u308f\u308c\u308b\u3002MapReduce\u306e\u5834\u5408\u3001Shuffle Stage\u306f\u30c7\u30fc\u30bf\u306e\u53d6\u5f97\u3068\u3001combine()\u30ed\u30b8\u30c3\u30af\u306e\u9069\u7528\u304c\u540c\u3058\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u884c\u308f\u308c\u308b\u3002\u3057\u304b\u3057\u3001MapReduce\u306b\u304a\u3044\u3066\u306fReducer\u306e\u5165\u529b\u30c7\u30fc\u30bf\u306f\u3042\u3089\u304b\u3058\u3081\u30bd\u30fc\u30c8\u3055\u308c\u3066\u3044\u308b\u5fc5\u8981\u304c\u3042\u308b\u305f\u3081\u3001reduce()\u30ed\u30b8\u30c3\u30af\u306fshuffle-sort\u30d7\u30ed\u30bb\u30b9\u306e\u5f8c\u306b\u9069\u7528\u3055\u308c\u308b\u3002Spark\u3067\u306fReducer\u306e\u5165\u529b\u30c7\u30fc\u30bf\u304c\u30bd\u30fc\u30c8\u3055\u308c\u3066\u3044\u308b\u5fc5\u8981\u306f\u306a\u3044\u305f\u3081\u3001\u30c7\u30fc\u30bf\u306e\u53d6\u5f97\u306e\u5b8c\u4e86\u3092\u51e6\u7406\u958b\u59cb\u307e\u3067\u5f85\u3064\u5fc5\u8981\u304c\u306a\u3044\u3002\n\u3053\u306e\u3088\u3046\u306a\u6a5f\u69cb\u3092\u5b9f\u73fe\u3059\u308b\u305f\u3081\u306b\u3001Spark\u306b\u304a\u3044\u3066\u306fshuffle\u3068\u3001\u51e6\u7406\u306e\u9069\u7528\u304c\u3069\u306e\u3088\u3046\u306b\u5b9f\u88c5\u3055\u308c\u3066\u3044\u308b\u306e\u304b\uff1f\u5b9f\u969b\u306eSpark\u306b\u304a\u3044\u3066\u306f\u3001\u30b8\u30e7\u30d6\u5b9f\u884c\u7528\u306e\u30c7\u30fc\u30bf\u69cb\u9020\u3068\u3057\u3066HashMap\u306e\u3088\u3046\u306a\u69cb\u9020\u3092\u7528\u3044\u308b\u3053\u3068\u3067\u89e3\u6c7a\u3057\u3066\u3044\u308b\u3002Shuffle\u30d7\u30ed\u30bb\u30b9\u304b\u3089\u53d6\u5f97\u3055\u308c\u305f\u5404\u306e\u30da\u30a2\u306fHashMap\u306b\u9806\u6b21\u8ffd\u52a0\u3055\u308c\u308b\u3002\u65e2\u306bKey\u306b\u5bfe\u5fdc\u3059\u308b\u30c7\u30fc\u30bf\u304c\u5b58\u5728\u3059\u308b\u5834\u5408\u3001func(hashMap.get(Key), Value)\u3092\u9069\u7528\u3057\u3001\u30c7\u30fc\u30bf\u3092\u7d71\u5408\u3057\u3066\u3044\u304f\u3002\u524d\u8ff0\u306eWordCount\u30b5\u30f3\u30d7\u30eb\u306e\u5834\u5408\u3001\u3053\u306e\u95a2\u6570\u306fhashMap.get(Key) + Value\u3067\u8868\u3059\u3053\u3068\u304c\u3067\u304d\u3001\u3053\u306e\u7d50\u679c\u304cHashMap\u306e\u5024\u3068\u3057\u3066\u66f4\u65b0\u3055\u308c\u308b\u3002\u3053\u306e\u7d71\u5408\u95a2\u6570\u306fMapReduce\u306b\u304a\u3051\u308breduce()\u3068\u4f3c\u305f\u7acb\u3061\u4f4d\u7f6e\u3060\u304c\u3001\u8a73\u7d30\u306f\u7570\u306a\u308b\u3002\u9055\u3044\u306b\u3064\u3044\u3066\u3092\u4e0b\u8a18\u306e\u30b3\u30fc\u30c9\u30b3\u30fc\u30c9\u30b9\u30cb\u30da\u30c3\u30c8\u306b\u3066\u793a\u3057\u3066\u3044\u308b\u3002\n// MapReduce\nreduce(K key, Iterable<V> values) {\n    result = process(key, values)\n    return result\n}\n\n// Spark\nreduce(K key, Iterable<V> values) {\n    result = null\n    for (V value : values)\n        result  = func(result, value)\n    return result\n}\n\nHadoop MapReduce\u306b\u304a\u3044\u3066\u306f\u3001Process\u95a2\u6570\u5185\u3067\u4efb\u610f\u306e\u30c7\u30fc\u30bf\u69cb\u9020\u3092\u5b9a\u7fa9\u3059\u308b\u3053\u3068\u304c\u53ef\u80fd\u3067\u3001\u30d1\u30e9\u30e1\u30fc\u30bf\u3068\u3057\u3066\u306fIterable\u3092\u3068\u308b\u3002\u30c7\u30fc\u30bf\u3092\u5148\u306e\u51e6\u7406\u306e\u305f\u3081\u306b\u30ad\u30e3\u30c3\u30b7\u30e5\u3059\u308b\u3053\u3068\u3082\u53ef\u80fd\u3002\nSpark\u306b\u304a\u3044\u3066\u306f\u3001\u9ad8\u968e\u95a2\u6570\u306b\u4f3c\u305f\u6a5f\u69cb\u3092Process\u95a2\u6570\u9069\u7528\u306b\u7528\u3044\u3066\u3044\u308b\u3002\n\u5dee\u306e\u4f8b\u3068\u3057\u3066\u3001Hadoop MapReduce\u306b\u304a\u3044\u3066\u306f\u5168\u4f53\u306e\u5024\u306e\u5e73\u5747\u5024\u3084\u5408\u8a08\u5024\u3001\u500b\u6570\u3092\u51fa\u3059\u3053\u3068\u304c\u975e\u5e38\u306b\u5bb9\u6613\u306b\u306a\u3063\u3066\u3044\u308b\u304c\u3001Spark\u306f\u305d\u3046\u3067\u306f\u306a\u3044\u3002\u8a73\u7d30\u306f\u5f8c\u8ff0\u3059\u308b\u3002\n\u53d6\u5f97\u3057\u305f\u30c7\u30fc\u30bf\u306f\u3069\u3053\u306b\u4fdd\u6301\u3059\u308b\u306e\u304b\uff1f\n\u53d6\u5f97\u3057\u305fFileSegments\u306fsoftBuffer\u306b\u4fdd\u6301\u3055\u308c\u308b\u3002\u30c7\u30fc\u30bf\u304c\u51e6\u7406\u3055\u308c\u305f\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u3001\u7d50\u679c\u306f\u8a2d\u5b9a\u3067\u5b9a\u7fa9\u3055\u308c\u305f\u7b87\u6240\u306b\u51fa\u529b\u3055\u308c\u308b\u3002\u3082\u3057\u8a2d\u5b9aspark.shuffle.spill\u304cfalse\u306e\u5834\u5408\u3001\u3053\u306e\u51fa\u529b\u5148\u306f\u30e1\u30e2\u30ea\u4e0a\u306e\u307f\u306b\u5236\u7d04\u3055\u308c\u308b\u3002\u30e1\u30e2\u30ea\u4e0a\u306e\u30c7\u30fc\u30bf\u4fdd\u6301\u306e\u305f\u3081\u306bAppendOnlyMap\u3068\u3044\u3046\u30c7\u30fc\u30bf\u69cb\u9020\u304c\u7528\u3044\u3089\u308c\u308b\u3002\u30e1\u30e2\u30ea\u4e0a\u306e\u307f\u3067\u306a\u3044\u4fdd\u6301\u306e\u5834\u5408\u3001\u30e1\u30e2\u30ea\u3068\u30c7\u30a3\u30b9\u30af\u4e0a\u306b\u51fa\u529b\u3055\u308c\u308b\u304c\u3001\u305d\u306e\u5834\u5408\u306fExternalAppendOnlyMap\u3068\u3044\u3046\u30c7\u30fc\u30bf\u69cb\u9020\u304c\u7528\u3044\u3089\u308c\u308b\u3002\u3053\u306e\u30c7\u30fc\u30bf\u69cb\u9020\u3092\u7528\u3044\u308b\u3053\u3068\u306b\u3088\u308a\u3001\u30e1\u30e2\u30ea\u4e0a\u306b\u53ce\u307e\u3089\u306a\u3044\u5834\u5408\u306b\u30bd\u30fc\u30c8\u3055\u308c\u305fKey\u3068Value\u306e\u30da\u30a2\u3092\u30c7\u30a3\u30b9\u30af\u4e0a\u306b\u51fa\u529b\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\u30e1\u30e2\u30ea\u3068\u30c7\u30a3\u30b9\u30af\u3092\u4e21\u65b9\u4f7f\u7528\u3059\u308b\u5834\u5408\u306e\u4e3b\u8981\u306a\u554f\u984c\u70b9\u3068\u3057\u3066\u3001\u3069\u306e\u3088\u3046\u306b\u3053\u306e\u4e21\u8005\u306e\u30d0\u30e9\u30f3\u30b9\u3092\u53d6\u308b\u304b\u3001\u304c\u3042\u308b\u3002Hadoop MapReduce\u306b\u304a\u3044\u3066\u306f\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u30e1\u30e2\u30ea\u306e70%\u304cShuffle\u7528\u306e\u9818\u57df\u3068\u3057\u3066\u78ba\u4fdd\u3055\u308c\u3066\u3044\u308b\u3002\u30e1\u30e2\u30ea\u306e\u4f7f\u7528\u91cf\u304c66%\u306b\u9054\u3057\u305f\u30bf\u30a4\u30df\u30f3\u30b0\u3067merge-combine-spill\u30d7\u30ed\u30bb\u30b9\u3092\u958b\u59cb\u3059\u308b\u3002Spark\u3067\u3082\u985e\u4f3c\u306e\u65b9\u5f0f\u3092\u3068\u3063\u3066\u3044\u308b\u304c\u3001\u8a73\u7d30\u306b\u3064\u3044\u3066\u306f\u672c\u7ae0\u306b\u3066\u5f8c\u8ff0\u3059\u308b\u3002\n\u6b21Stage\u306eTask\u306f\u3069\u306e\u3088\u3046\u306b\u53d6\u5f97\u3055\u308c\u305f\u30c7\u30fc\u30bf\u306e\u5834\u6240\u3092\u7279\u5b9a\u3059\u308b\u306e\u304b\uff1f\n\u524d\u7ae0\u306b\u3066\u3001ShuffleMapStage\u306e\u4e2d\u306e\u91cd\u8981\u306a\u30b9\u30c6\u30c3\u30d7\u3068\u3057\u3066\u3001MapOutputTrackerMaster.registerShuffle(shuffleId, rdd.partitions.size)\u3092\u5b9f\u884c\u3057\u3066\u6700\u7d42\u7684\u306aRDD\u3092\u767b\u9332\u3059\u308b\u3068\u3044\u3046\u3082\u306e\u304c\u3042\u308b\u3002\u305d\u306e\u305f\u3081\u3001Shuffle\u306e\u30d7\u30ed\u30bb\u30b9\u306b\u304a\u3044\u3066\u3001Reducer\u306f\u30c7\u30fc\u30bf\u306e\u5834\u6240\u3092Driver\u30d7\u30ed\u30bb\u30b9\u306eMapOutputTrackerMaster\u306b\u554f\u3044\u5408\u308f\u305b\u308b\u3053\u3068\u3067\u53d6\u5f97\u3057\u3066\u3044\u308b\u3002ShuffleMapTask\u304c\u7d42\u4e86\u3057\u305f\u969b\u306b\u3001FileSegment\u306e\u5834\u6240\u3092MapOutputTrackerMaster\u306b\u767b\u9332\u3057\u3066\u3044\u308b\u3002\n\u3053\u3053\u307e\u3067\u3067Shuffle Write/Shuffle Read\u3067\u7528\u3044\u3089\u308c\u308b\u30e1\u30a4\u30f3\u306e\u65b9\u5f0f\u306b\u3064\u3044\u3066\u5b9f\u88c5\u4f8b\u3092\u57fa\u306b\u8aac\u660e\u3057\u3066\u304d\u305f\u3002\u4ee5\u5f8c\u306f\u4ed6\u306e\u8208\u5473\u6df1\u3044\u4e8b\u4f8b\u306b\u3064\u3044\u3066\u8a73\u7d30\u3092\u898b\u3066\u307f\u3088\u3046\u3002\n\n\u5178\u578b\u7684\u306aTransformation\u306b\u304a\u3051\u308bShuffle Read\u8a73\u7d30\n\nreduceByKey(func)\n\u3053\u3053\u307e\u3067\u3067\u7c21\u5358\u306breduceByKey()\u306e\u30c7\u30fc\u30bf\u53d6\u5f97\u3001Reduce\u30d7\u30ed\u30bb\u30b9\u306b\u3064\u3044\u3066\u8a18\u8ff0\u3057\u3066\u304d\u305f\u3002\u3053\u3053\u3067\u6ce8\u610f\u3059\u308b\u3079\u304d\u306f\u3001\u3042\u308b\u30bf\u30a4\u30df\u30f3\u30b0\u306b\u304a\u3044\u3066\u3001RDD\u4e2d\u306e\u5168\u30c7\u30fc\u30bf\u304c\u30e1\u30e2\u30ea\u4e0a\u306b\u5b58\u5728\u3059\u308b\u308f\u3051\u3067\u306f\u306a\u3044\u3068\u3044\u3046\u3053\u3068\u3067\u3042\u308b\u3002\u3053\u306e\u30ed\u30b8\u30c3\u30af\u9069\u7528\u51e6\u7406\u306fRecord\u30d9\u30fc\u30b9\u3067\u884c\u308f\u308c\u3001\u65e2\u306b\u51e6\u7406\u304c\u5b8c\u4e86\u3057\u305f\u5143Record\u306f\u30e1\u30e2\u30ea\u4e0a\u304b\u3089\u9664\u53bb\u3055\u308c\u308b\u3002Record\u30ec\u30d9\u30eb\u306e\u8996\u70b9\u306b\u304a\u3044\u3066\u306freduce()\u306e\u51e6\u7406\u306f\u4e0b\u8a18\u306e\u56f3\u306e\u3088\u3046\u306b\u793a\u3055\u308c\u308b\u3002\n\n\u3053\u306e\u56f3\u304b\u3089\u308f\u304b\u308b\u3088\u3046\u306b\u3001\u53d6\u5f97\u3055\u308c\u305fRecord\u306fHashMap\u3092\u7528\u3044\u3066\u96c6\u8a08\u3055\u308c\u308b\u3002\u5168Record\u3092\u96c6\u8a08\u3057\u305f\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u7d50\u679c\u304c\u53d6\u5f97\u3067\u304d\u308b\u3002\u305d\u306e\u305f\u3081\u3001func\u306f\u53ef\u63db\u5f8b\u3092\u6e80\u305f\u3059\u5fc5\u8981\u304c\u3042\u308b\u3002\n\u4e0a\u8a18\u306e\u56f3\u306b\u304a\u3051\u308bMapPartitionsWithContext\u30aa\u30da\u30ec\u30fc\u30b7\u30e7\u30f3\u306fShuffledRDD\u3092MapPartitionsRDD\u306b\u5909\u63db\u3059\u308b\u305f\u3081\u306b\u7528\u3044\u3089\u308c\u308b\u3002\n\u30ce\u30fc\u30c9\u9593\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u901a\u4fe1\u3092\u524a\u6e1b\u3059\u308b\u305f\u3081\u3001Hadoop MapReduce\u306b\u304a\u3044\u3066\u306fMapSideCombine\u3092\u884c\u3046\u3053\u3068\u304c\u3067\u304d\u308b\u3002\u3053\u308c\u306fSpark\u3067\u3082\u5b9f\u884c\u53ef\u80fd\u3002\u305d\u306e\u305f\u3081\u306b\u5fc5\u8981\u306a\u3053\u3068\u306f\u3001ShuffleMapStage\u306b\u304a\u3044\u3066mapPartitionsWithContext\u3092\u5b9f\u884c\u3059\u308b\u306e\u307f\u3002reduceByKey\u306e\u4e00\u4f8b\u3068\u3057\u3066\u3001 ParallelCollectionRDD\u304b\u3089MapPartitionsRDD\u3078\u306e\u5909\u63db\u306fMapSideCombine\u3068\u540c\u7b49\u306e\u51e6\u7406\u3092\u884c\u3063\u3066\u3044\u308b\u3002\nHadoop MapReduce\u306b\u304a\u3051\u308bmap()->reduce()\u3068Spark\u306b\u304a\u3051\u308b reduceByKey\u306e\u6bd4\u8f03\nMapSide:\n\u4e21\u8005\u306b\u9055\u3044\u306f\u306a\u3044\u3002combine()\u30ed\u30b8\u30c3\u30af\u306b\u304a\u3044\u3066\u3001Hadoop MapReduce\u306f\u3042\u3089\u304b\u3058\u3081\u30c7\u30fc\u30bf\u304cSort\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u3092\u8ab2\u3057\u3066\u3044\u308b\u3002Spark\u5074\u306fHashMap\u3092\u7528\u3044\u3066combine()\u3092\u884c\u3046\u3002\nReduce side:\nHadoop MapReduce\u306eReduce\u30d7\u30ed\u30bb\u30b9\u306fShuffle\u7528\u306e\u30c7\u30fc\u30bf\u3092\u3059\u3079\u3066\u53d6\u5f97\u3057\u305f\u5f8ccombine()\u3092\u9069\u7528\u3059\u308b\u3002\u305d\u306e\u5f8c\u3001\u30c7\u30fc\u30bf\u306e\u30de\u30fc\u30b8\u30bd\u30fc\u30c8\u3092reduce()\u306e\u524d\u6e96\u5099\u3068\u3057\u3066\u5b9f\u884c\u3059\u308b\u3002\nSpark\u306b\u304a\u3044\u3066\u306f\u30c7\u30fc\u30bf\u306e\u53d6\u5f97\u3068reduce()\u306fHashMap\u3092\u7528\u3044\u3066\u540c\u6642\u306b\u5b9f\u884c\u3055\u308c\u308b\u3002\u305d\u306e\u969b\u3001reduce\u95a2\u6570\u306f\u53ef\u63db\u5f8b\u3092\u6e80\u305f\u3059\u5fc5\u8981\u304c\u3042\u308b\u3002\n\u30e1\u30e2\u30ea\u4f7f\u7528\u306b\u304a\u3051\u308b\u6bd4\u8f03\nMapSide:\nHadoop MapReduce\u306fmap()\u306e\u51fa\u529b\u30c7\u30fc\u30bf\u3092\u4fdd\u6301\u3057\u3066\u30bd\u30fc\u30c8\u3092\u884c\u3046\u305f\u3081\u306b\u5927\u91cf\u306e\u5faa\u74b0\u30d0\u30c3\u30d5\u30a1\u304c\u5fc5\u8981\u306b\u306a\u308b\u3002\u3057\u304b\u3057\u3001combine()\u306f\u8ffd\u52a0\u306e\u9818\u57df\u306f\u5fc5\u8981\u3068\u3057\u306a\u3044\u3002\nSpark\u306fcombine()\u5b9f\u884c\u306b\u306fHashMap\u3092\u5fc5\u8981\u306b\u3057\u3001Record\u3092\u30ed\u30fc\u30ab\u30eb\u30c7\u30a3\u30b9\u30af\u306b\u51fa\u529b\u3059\u308b\u305f\u3081\u306b\u30d0\u30c3\u30d5\u30a1(buckets)\u304c\u5fc5\u8981\u3068\u306a\u308b\u3002\nRereduce side:\nHadoop MapReduce\u306fShuffle\u3055\u308c\u305f\u30c7\u30fc\u30bf\u3092\u4fdd\u6301\u3059\u308b\u9818\u57df\u304c\u30e1\u30e2\u30ea\u4e0a\u306b\u5fc5\u8981\u3068\u306a\u308b\u3002combine()\u3068reduce()\u306b\u3064\u3044\u3066\u306f\u65e2\u306b\u30c7\u30fc\u30bf\u304c\u30bd\u30fc\u30c8\u3001\u30b0\u30eb\u30fc\u30d7\u5316\u6e08\u307f\u306e\u305f\u3081\u3001\u8ffd\u52a0\u306e\u9818\u57df\u306f\u5fc5\u8981\u3068\u3057\u306a\u3044\u69cb\u6210\u3068\u306a\u3063\u3066\u3044\u308b\u3002\nSpark\u306b\u304a\u3044\u3066\u306fsoftBuffer\u7528\u306e\u9818\u57df\u304c\u30c7\u30fc\u30bf\u53d6\u5f97\u306e\u305f\u3081\u306b\u5fc5\u8981\u3068\u306a\u308b\u3002HashMap\u306fcombine()\u3068reduce()\u306e\u7d50\u679c\u4fdd\u6301\u306e\u305f\u3081\u306b\u30e1\u30e2\u30ea\u306e\u307f\u4f7f\u7528\u3068\u3044\u3046\u8a2d\u5b9a\u304c\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u30e1\u30e2\u30ea\u4e0a\u306b\u78ba\u4fdd\u3055\u308c\u308b\u3002\u3057\u304b\u3057\u306a\u304c\u3089\u3001\u30c7\u30fc\u30bf\u306e\u4e00\u90e8\u306f\u8a2d\u5b9a\u3067\u30e1\u30e2\u30ea\u3068\u30c7\u30a3\u30b9\u30af\u306e\u4f7f\u7528\u304c\u6709\u52b9\u306b\u306a\u3063\u3066\u3044\u308b\u5834\u5408\u306f\u30c7\u30a3\u30b9\u30af\u4e0a\u306b\u3082\u4fdd\u6301\u3055\u308c\u308b\u69cb\u6210\u3068\u306a\u3063\u3066\u3044\u308b\u3002\n\ngroupByKey(numPartitions)\n\n\u5b9f\u884c\u904e\u7a0b\u306freduceByKey()\u3068\u4f3c\u3066\u3044\u308b\u3002\u96c6\u8a08\u306e\u305f\u3081\u306e\u95a2\u6570\u304cresult = result ++ result.value\u3068\u306a\u308a\u3001\u5404\u30ad\u30fc\u306b\u5bfe\u5fdc\u3059\u308b\u5024\u304c\u96c6\u8a08\u3055\u308c\u308b\u3053\u3068\u7121\u304f\u30b0\u30eb\u30fc\u30d7\u5316\u3055\u308c\u308b\u70b9\u304c\u9055\u3044\u3068\u306a\u3063\u3066\u3044\u308b\u3002\n\ndistinct(numPartitions)\n\n\u3053\u3061\u3089\u3082\u5b9f\u884c\u904e\u7a0b\u306freduceByKey()\u3068\u4f3c\u3066\u3044\u308b\u3002\u96c6\u8a08\u306e\u305f\u3081\u306e\u95a2\u6570\u304cresult = result == null ? record.value : result\u3068\u306a\u308aKey\u306b\u5bfe\u5fdc\u3059\u308b\u5024\u304cHashMap\u4e0a\u306b\u5b58\u5728\u3059\u308b\u304b\u3092\u30c1\u30a7\u30c3\u30af\u3059\u308b\u305f\u3081\u3060\u3051\u306e\u51e6\u7406\u3068\u306a\u3063\u3066\u3044\u308b\u3002\u3082\u3068\u3082\u3068Key\u306b\u5bfe\u5fdc\u3059\u308b\u5024\u304c\u5b58\u5728\u3059\u308b\u5834\u5408\u3001Record\u306f\u7834\u68c4\u3055\u308c\u3001\u5b58\u5728\u3057\u306a\u3044\u5834\u5408\u306fHashMap\u4e0a\u306b\u4fdd\u6301\u3055\u308c\u308b\u3002reduceByKey()\u3068\u540c\u69d8\u306b\u3001MapSideCombine\u3082\u9069\u7528\u3055\u308c\u3066\u3044\u308b\u3002\n\ncogroup(otherRDD, numPartitions)\n\ncogroup\u3092\u5b9f\u884c\u3059\u308b\u306b\u3042\u305f\u308a\u30010\u500b\u30011\u500b\u3001\u307e\u305f\u306f\u305d\u308c\u4ee5\u4e0a\u306eShuffleDependency\u306b\u3088\u308b\u95a2\u9023\u304c\u5b58\u5728\u3057\u3048\u308b\u3002\u3057\u304b\u3057\u3001Shuffle\u30d7\u30ed\u30bb\u30b9\u306b\u304a\u3044\u3066\u5404ShuffleDependency\u306b\u5bfe\u3057\u3066HashMap\u3092\u751f\u6210\u3059\u308b\u3053\u3068\u306f\u305b\u305a\u30011\u500b\u306eHashMap\u3092\u3059\u3079\u3066\u306eShuffle\u5b9f\u884c\u306b\u7528\u3044\u308b\u3002reduceByKey()\u3068\u306e\u9055\u3044\u3068\u3057\u3066\u306f\u3001HashMap\u306fmapPartitionsWithContext\u3067\u306a\u304f\u3001RDD\u306ecompute()\u5b9f\u884c\u306e\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u751f\u6210\u3055\u308c\u308b\u70b9\u304c\u3042\u308b\u3002\nRDD\u306b\u5bfe\u3059\u308bTask\u5b9f\u884c\u6642\u306bArray[ArrayBuffer]\u3092\u751f\u6210\u3059\u308b\u3002\u3053\u306eArray[ArrayBuffer]\u306f\u5165\u529bRDD\u3068\u540c\u3058\u6570\u306e\u7a7aArrayBuffer\u3092\u4fdd\u6301\u3059\u308b\u3002\u305d\u306e\u305f\u3081\u3001\u56f3\u793a\u3055\u308c\u305f\u4f8b\u306b\u304a\u3044\u3066\u306fRDD a\u3001RDD b\u4e8c\u5bfe\u5fdc\u3057\u305f2\u500b\u306eArrayBuffer\u304c\u5404Task\u306b\u5bfe\u3057\u3066\u751f\u6210\u3055\u308c\u308b\u3002RDD a\u304b\u3089\u306eKey-Value\u306e\u30da\u30a2\u304c1\u500b\u76ee\u306eArrayBuffer\u306b\u8ffd\u52a0\u3055\u308c\u3001RDD b\u304b\u3089\u306eKey-Value\u306e\u30da\u30a2\u304c2\u500b\u76ee\u306eArrayBuffer\u306b\u8ffd\u52a0\u3055\u308c\u308b\u3002\u6700\u7d42\u7684\u306bmapValues()\u30aa\u30da\u30ec\u30fc\u30b7\u30e7\u30f3\u306b\u304a\u3044\u3066Array[ArrayBuffer]\u304c(ArrayBuffer, ArrayBuffer) => (Iterable[V], Iterable[W])\u306e\u5909\u63db\u3067\u6700\u7d42\u7684\u306a\u578b\u306b\u5909\u63db\u3055\u308c\u308b\u3002\n\nintersection(otherRDD) and join(otherRDD, numPartitions)\n\n\n\u3053\u306e2\u500b\u306e\u30aa\u30da\u30ec\u30fc\u30b7\u30e7\u30f3\u306f\u5185\u90e8\u7684\u306bcogroup\u3092\u4f7f\u7528\u3057\u3066\u304a\u308a\u3001\u5185\u90e8\u306eShuffle\u30d7\u30ed\u30bb\u30b9\u306fcogroup\u3068\u540c\u4e00\u306e\u69cb\u6210\u3068\u306a\u3063\u3066\u3044\u308b\u3002\n\nsortByKey(ascending, numPartition)\n\nsortByKey()\u306e\u51e6\u7406\u30d7\u30ed\u30bb\u30b9\u306freduceByKey()\u3068\u82e5\u5e72\u7570\u306a\u308a\u3001\u53d6\u5f97\u3057\u305f\u5165\u529bRecord\u3092\u6271\u3046\u305f\u3081\u306bHashMap\u3092\u4f7f\u7528\u3057\u306a\u3044\u3002\u4ee3\u308f\u308a\u306b\u3001Key-Value\u306e\u5024\u3092Range\u30d9\u30fc\u30b9\u3067\u5206\u5272\u3059\u308b\u3002\u540c\u4e00Partition\u4e2d\u306e\u5024\u306fKey\u3067\u30bd\u30fc\u30c8\u3055\u308c\u305f\u72b6\u614b\u3067\u51fa\u529b\u3055\u308c\u308b\u3002\n\ncoalesce(numPartitions, shuffle = true)\n\ncoalesce()\u306fShuffleDependency\u3092\u751f\u6210\u3059\u308b\u304c\u3001\u5b9f\u969b\u306f\u53d6\u5f97\u3057\u305f\u30c7\u30fc\u30bf\u306e\u96c6\u8a08\u306f\u5fc5\u8981\u306a\u3044\u305f\u3081\u3001HashMap\u306e\u4f7f\u7528\u3082\u3055\u308c\u306a\u3044\u3002\n\nHashMap in Shuffle Read\n\u3053\u3053\u307e\u3067\u3067\u3067\u8ff0\u3079\u3089\u308c\u3066\u304d\u305f\u3088\u3046\u306b\u3001HashMap\u306fSpark\u306eShuffle\u30d7\u30ed\u30bb\u30b9\u306b\u304a\u3044\u3066\u3057\u3070\u3057\u3070\u4f7f\u7528\u3055\u308c\u308b\u30c7\u30fc\u30bf\u69cb\u9020\u3068\u306a\u3063\u3066\u3044\u308b\u3002Spark\u306f2\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u7279\u5225\u306aHashMap\u3092\u4fdd\u6301\u3057\u3066\u304a\u308a\u3001\u30e1\u30e2\u30ea\u4e0a\u306b\u306e\u307f\u30c7\u30fc\u30bf\u3092\u4fdd\u6301\u3059\u308b\u5834\u5408\u306fAppendOnlyMap\u304c\u3001\u30e1\u30e2\u30ea\u3068\u30c7\u30a3\u30b9\u30af\u306e\u4e21\u65b9\u3092\u7528\u3044\u3066\u30c7\u30fc\u30bf\u3092\u4fdd\u6301\u3059\u308b\u5834\u5408\u306fExternalAppendOnlyMap\u304c\u4f7f\u7528\u3055\u308c\u308b\u3002\n\u4ee5\u5f8c\u3067\u306f\u3053\u306e2\u500b\u306eHashMap\u5b9f\u88c5\u306b\u3064\u3044\u3066\u8a73\u7d30\u3092\u8ff0\u3079\u308b\u3002\n\nAppendOnlyMap\nSpark\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u304a\u3044\u3066\u3001AppendOnlyMap\u306f\u300c\u30b7\u30f3\u30d7\u30eb\u306aHashTable\u3067\u3001\u8ffd\u52a0\u5c02\u7528\u306e\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\u306b\u6700\u9069\u5316\u3055\u308c\u3066\u3044\u308b\u3002\u30ad\u30fc\u306f\u8ffd\u52a0\u3055\u308c\u305f\u5f8c\u306f\u524a\u9664\u3055\u308c\u305a\u3001\u5404\u30ad\u30fc\u306b\u5bfe\u5fdc\u3059\u308b\u5024\u306f\u66f4\u65b0\u3055\u308c\u308b\u3053\u3068\u3092\u60f3\u5b9a\u3057\u3066\u6700\u9069\u5316\u3055\u308c\u3066\u3044\u308b\u3002\u300d\u3068\u8a18\u8ff0\u3055\u308c\u3066\u3044\u308b\u3002\u5b9f\u88c5\u65b9\u5f0f\u306f\u30b7\u30f3\u30d7\u30eb\u3067\u3001\u4e0b\u56f3\u306e\u3088\u3046\u306b\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306e\u5de8\u5927\u306a\u914d\u5217\u3092\u78ba\u4fdd\u3057\u3001Key\u304c\u9752\u3044\u9818\u57df\u306b\u4fdd\u6301\u3055\u308c\u3001Value\u304c\u767d\u3044\u9818\u57df\u306b\u4fdd\u6301\u3055\u308c\u308b\u3002\n\nput(K, V)\u304c\u5b9f\u884c\u3055\u308c\u305f\u5834\u5408\u3001hash(K)\u306e\u5024\u3092\u7528\u3044\u3066\u914d\u5217\u306e\u4e2d\u306e\u30b9\u30ed\u30c3\u30c8\u3092\u5272\u308a\u5f53\u3066\u308b\u3002\u65e2\u306b\u8a72\u5f53\u306e\u5834\u6240\u304c\u4f7f\u7528\u3055\u308c\u3066\u3044\u305f\u5834\u5408\u3001\u4e8c\u6b21\u30d7\u30ed\u30fc\u30d3\u30f3\u30b0\u6280\u8853\u3092\u7528\u3044\u3066\u6b21\u306e\u30b9\u30ed\u30c3\u30c8\u3092\u898b\u3064\u3051\u308b\u3002\u56f3\u4e2d\u306b\u66f8\u304b\u308c\u305f\u8ffd\u52a0\u51e6\u7406\u3092\u4f8b\u3068\u3059\u308c\u3070\u3001Key=K6\u3001Value=V6\u306e\u5024\u3092\u8ffd\u52a0\u3059\u308b\u5834\u5408\u30013\u756a\u76ee\u306e\u30d7\u30ed\u30fc\u30d3\u30f3\u30b0\u3067\u7a7a\u304d\u30b9\u30ed\u30c3\u30c8(K4\u306e\u6b21\u306e\u30b9\u30ed\u30c3\u30c8)\u3092\u767a\u898b\u3057\u3001\u305d\u3053\u306bV6(K6\u306e\u6b21\u306e\u30b9\u30ed\u30c3\u30c8)\u3068\u5171\u306b\u4fdd\u5b58\u3059\u308b\u3002get(K6)\u5b9f\u884c\u6642\u3001\u540c\u69d8\u306e\u30d5\u30ed\u30fc\u3067\u5024\u3092\u4fdd\u6301\u3059\u308b\u30b9\u30ed\u30c3\u30c8\u3092\u767a\u898b\u3059\u308b\u3002Key\u306b\u5bfe\u5fdc\u3057\u305f\u65b0\u305f\u306a\u5024\u3092\u4fdd\u5b58\u3059\u308b\u5834\u5408\u3001V6\u3092K6\u306e\u6b21\u306e\u30b9\u30ed\u30c3\u30c8\u304b\u3089\u53d6\u5f97\u3057\u3001\u65b0\u305f\u306a\u5024\u3092\u7b97\u51fa\u3057\u305f\u4e0a\u3067\u7b97\u51fa\u7d50\u679c\u3092V6\u304c\u4fdd\u5b58\u3055\u308c\u3066\u3044\u305f\u30b9\u30ed\u30c3\u30c8\u306b\u4fdd\u5b58\u3059\u308b\u3002\nAppendOnlyMap\u3092Iterator\u3067\u8d70\u67fb\u3059\u308b\u5834\u5408\u3001\u5358\u306b\u914d\u5217\u3092\u30b9\u30ad\u30e3\u30f3\u3059\u308b\u3060\u3051\u3067\u3059\u3080\u3002\n\u3082\u3057\u5272\u308a\u632f\u3089\u308c\u305f\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u914d\u5217\u9818\u57df\u304c70%\u4f7f\u7528\u3055\u308c\u305f\u5834\u5408\u3001\u500d\u306e\u30b5\u30a4\u30ba\u306e\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u914d\u5217\u3092\u4f5c\u6210\u3057\u3001\u305d\u3053\u306b\u5143\u3005\u306e\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u914d\u5217\u4e2d\u306e\u5024\u3092\u518d\u69cb\u7bc9\u3057\u306a\u304c\u3089\u4fdd\u5b58\u3059\u308b\u3002\nAppendOnlyMap\u306b\u304a\u3044\u3066\u306fdestructiveSortedIterator()\u3068\u3044\u3046Iterator[(K, V)]\u3092\u8fd4\u3059\u30e1\u30bd\u30c3\u30c9\u304c\u5b58\u5728\u3059\u308b\u3002\u3053\u306e\u30e1\u30bd\u30c3\u30c9\u306f\u30bd\u30fc\u30c8\u3055\u308c\u305f\u72b6\u614b\u306eKey-Value\u30da\u30a2\u3092\u8fd4\u3059\u3002\u5b9f\u88c5\u65b9\u5f0f\u306f\u307e\u305a\u306f\u3058\u3081\u306b\u5168\u3066\u306eKey-Value\u30da\u30a2\u3092\u5404Key-Value\u30da\u30a2\u304c1\u30b9\u30ed\u30c3\u30c8\u306b\u4fdd\u6301\u3055\u308c\u305f\u914d\u5217\u3092\u4f5c\u6210\u3057\u3001Array.sort()\u30e1\u30bd\u30c3\u30c9\u3067\u8981\u7d20\u3092\u6574\u5217\u3057\u305f\u4e0a\u3067\u7528\u3044\u3066\u3044\u308b\u3002\u30e1\u30bd\u30c3\u30c9\u540d\u304c\u793a\u3057\u3066\u3044\u308b\u3088\u3046\u306b\u3001\u500b\u306e\u30e1\u30bd\u30c3\u30c9\u306f\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u914d\u5217\u306e\u69cb\u9020\u3092\u58ca\u3059\u653b\u52e2\u3068\u306a\u3063\u3066\u3044\u308b\u3002\n\nExternalAppendOnlyMap\n\nAppendOnlyMap\u3068\u6bd4\u3079\u3066\u3001ExternalAppendOnlyMap\u306f\u3088\u308a\u8907\u96d1\u306a\u69cb\u6210\u3068\u306a\u3063\u3066\u3044\u308b\u3002\u5b9f\u88c5\u30b3\u30f3\u30bb\u30d7\u30c8\u306fHadoop MapReduce\u306eshuffle-merge-combine-sort\u30d7\u30ed\u30bb\u30b9\u3068\u4f3c\u305f\u3082\u306e\u3068\u306a\u3063\u3066\u3044\u308b\u3002\nExternalAppendOnlyMap\u306fAppendOnlyMap\u3092\u4fdd\u6301\u3057\u3066\u304a\u308a\u3001\u8ffd\u52a0\u3055\u308c\u305fKey-Value\u30da\u30a2\u306fAppendOnlyMap\u306b\u8ffd\u52a0\u3055\u308c\u308b\u3002AppendOnlyMap\u306e\u30b5\u30a4\u30ba\u304c\u5897\u5927\u3057\u305f\u5834\u5408\u3001\u307e\u305a\u306f\u30e1\u30e2\u30ea\u4e0a\u306b\u78ba\u4fdd\u53ef\u80fd\u306a\u9818\u57df\u304c\u3042\u308b\u304b\u78ba\u8a8d\u3092\u884c\u3046\u3002\u3082\u3057\u5341\u5206\u306a\u9818\u57df\u304c\u30e1\u30e2\u30ea\u4e0a\u306b\u5b58\u5728\u3059\u308b\u5834\u5408\u3001AppendOnlyMap\u306e\u30b5\u30a4\u30ba\u30922\u500d\u306b\u3059\u308b\u3053\u3068\u3067\u5bfe\u5fdc\u3059\u308b\u3002\u305d\u3046\u3067\u306a\u3044\u5834\u5408\u3001AppendOnlyMap\u306b\u4fdd\u6301\u3055\u308c\u308b\u5168\u3066\u306eKey-Value\u30da\u30a2\u306f\u30bd\u30fc\u30c8\u3055\u308c\u305f\u4e0a\u3067\u30c7\u30a3\u30b9\u30af\u306b\u51fa\u529b\u3055\u308c\u308b\u3002(\u305d\u306e\u969b\u3001destructiveSortedIterator()\u3092\u7528\u3044\u3066\u884c\u308f\u308c\u308b) \u56f3\u4e2d\u306b\u304a\u3044\u3066\u3001\u5bfe\u8c61Map\u306e4\u56de\u306e\u30d5\u30a1\u30a4\u30eb\u51fa\u529b\u304c\u884c\u308f\u308c\u3066\u3044\u308b\u3002\u5404\u30c7\u30a3\u30b9\u30af\u51fa\u529b\u306b\u304a\u3044\u3066\u3001spillMap file\u304c\u751f\u6210\u3055\u308c\u3001\u7a7a\u306eAppendOnlyMap\u304c\u305d\u306e\u5f8c\u8ffd\u52a0\u3055\u308c\u308bKey-Value\u30da\u30a2\u306b\u5bfe\u5fdc\u3059\u308b\u305f\u3081\u306b\u521d\u671f\u5316\u3055\u308c\u308b\u3002ExternalAppendOnlyMap\u306b\u304a\u3044\u3066\u3001Key-Value\u30da\u30a2\u304c\u8ffd\u52a0\u3055\u308c\u305f\u5834\u5408\u3001\u30e1\u30e2\u30ea\u4e0a\u306b\u4fdd\u6301\u3055\u308c\u305fAppendOnlyMap\u306e\u307f\u3092\u7528\u3044\u3066\u96c6\u8a08\u304c\u884c\u308f\u308c\u308b\u3002\u305d\u306e\u305f\u3081\u3001\u6700\u7d42\u7684\u306a\u7d50\u679c\u7b97\u51fa\u30d5\u30a7\u30fc\u30ba\u306b\u304a\u3044\u3066\u3001\u30c7\u30a3\u30b9\u30af\u306b\u51fa\u529b\u3055\u308c\u305fMap\u3068\u30e1\u30e2\u30ea\u4e0a\u306b\u5b58\u5728\u3059\u308bAppendOnlyMap\u3092\u30de\u30fc\u30b8\u3059\u308bglobal merge-aggregate\u51e6\u7406\u3092\u5b9f\u884c\u3059\u308b\u5fc5\u8981\u304c\u51fa\u3066\u304f\u308b\u3002\nGlobal merge-aggregate\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u3066\u5b9f\u884c\u3055\u308c\u308b\u3002 \n\u307e\u305a\u306f\u3058\u3081\u306b\u3001\u30e1\u30e2\u30ea\u4e0a\u306b\u4fdd\u6301\u3055\u308c\u305fAppendOnlyMap\u3092\u30bd\u30fc\u30c8\u3057\u3001sortedMap\u3092\u751f\u6210\u3059\u308b\u3002\u305d\u306e\u5f8c\u3001DestructiveSortedIterator (sortedMap\u7528)\u304b\u3001\u307e\u305f\u306fDiskMapIterator (\u30c7\u30a3\u30b9\u30af\u4e0a\u306b\u51fa\u529b\u3055\u308c\u305fDisk Spill Map\u7528for on disk spillMap)\u304cKey-Value\u30da\u30a2\u306e\u4e00\u90e8\u5206\u3092StreamBuffer\u306b\u8aad\u307f\u8fbc\u3080\u305f\u3081\u306b\u5b9f\u884c\u3055\u308c\u308b\u3002StreamBuffer\u306fmergeHeap\u306b\u8ffd\u52a0\u3055\u308c\u3001\u5404StreamBuffer\u306b\u4fdd\u6301\u3055\u308c\u308bKey-Value\u30da\u30a2\u306f\u5168\u3066Key\u306b\u5bfe\u3059\u308b\u30cf\u30c3\u30b7\u30e5\u5024(hash(key))\u304c\u540c\u4e00\u306e\u5024\u3068\u306a\u3063\u3066\u3044\u308b\u3002\u56f3\u306e\u69cb\u6210\u3092\u4f8b\u306b\u6319\u3052\u308b\u3068\u3059\u308b\u3068\u3001hash(K1) == hash(K2) == hash(K3) < hash(K4) < hash(K5)\u304c\u6e80\u305f\u3055\u308c\u3066\u3044\u308b\u3002\n\u7d50\u679c\u3068\u3057\u3066\u3001\u306f\u3058\u3081\u306b\u51fa\u529b\u3055\u308c\u305f1st spill\u306e\u306f\u3058\u3081\u306e3Record\u306f\u540c\u3058StreamBuffer\u306b\u8aad\u307f\u8fbc\u307e\u308c\u308b\u3002\u30de\u30fc\u30b8\u306e\u30d7\u30ed\u30bb\u30b9\u306f\u30b7\u30f3\u30d7\u30eb\u3067\u3001\u540c\u4e00Hash\u5024\u3092\u6301\u3064\u30ad\u30fc\u3092\u4fdd\u6301\u3059\u308bStreamBuffer\u3092\u30d2\u30fc\u30d7\u4e0a\u306b\u78ba\u4fdd\u3057\u3001\u305d\u308c\u3089\u306e\u5024\u3092\u30de\u30fc\u30b8\u3059\u308b\u305f\u3081\u306bArrayBuffer\uff3bStreamBuffer\uff3d(mergedBuffers)\u306b\u8ffd\u52a0\u3059\u308b\u3002\u306f\u3058\u3081\u306b\u8ffd\u52a0\u3055\u308c\u305fStreamBuffer\u3092minBuffer\u3068\u547c\u3073\u3001minBuffer\u306b\u4fdd\u6301\u3055\u308c\u3066\u3044\u308b\u306f\u3058\u3081\u306eKey-Value\u30da\u30a2\u306eKey\u5024\u3092minKey\u3068\u547c\u3076\u3002\u3042\u308b\u30de\u30fc\u30b8\u51e6\u7406\u306fmergedBuffer\u4e2d\u306b\u4fdd\u6301\u3055\u308c\u305fminKey\u3092Key\u3068\u3057\u3066\u4fdd\u6301\u3059\u308bKey-Value\u30da\u30a2\u3092\u96c6\u8a08\u3057\u3001\u7d50\u679c\u3068\u3057\u3066\u51fa\u529b\u3059\u308b\u3053\u3068\u3092\u884c\u3046\u3002mergedBuffer\u4e2d\u306e\u30de\u30fc\u30b8\u51e6\u7406\u304c\u5b8c\u4e86\u3057\u305f\u6642\u306b\u6b8b\u3063\u3066\u3044\u308bKey-Value\u30da\u30a2\u3092mergeHeap\u306b\u8fd4\u3057\u3001\u7a7a\u306b\u306a\u3063\u305fStreamBuffer\u3092\u30e1\u30e2\u30ea\u3001\u307e\u305f\u306f\u30c7\u30a3\u30b9\u30af\u51fa\u529b\u3055\u308c\u305fMap\u304b\u3089\n\u3053\u3053\u3067\u30013\u3064\u307e\u3060\u8ff0\u3079\u3089\u308c\u3066\u3044\u306a\u3044\u70b9\u304c\u3042\u308b\u3002\n- \u30e1\u30e2\u30ea\u5229\u7528\u53ef\u80fd\u30c1\u30a7\u30c3\u30af\uff1aHadoop MapReduce\u306fReducer\u306e\u30e1\u30e2\u30ea\u9818\u57df\u306e70%\u3092Shuffle-Sort\u7528\u306b\u5272\u308a\u632f\u3063\u3066\u3044\u308b\u3002\u540c\u3058\u3088\u3046\u306b\u3001Spark\u306f\u8a2d\u5b9aspark.shuffle.memoryFraction *  spark.shuffle.safetyFraction (\u30c7\u30d5\u30a9\u30eb\u30c8\u306f0.3 * 0.8)\u3092ExternalAppendOnlyMap\u7528\u306b\u5272\u308a\u632f\u3063\u3066\u3044\u308b\u3002\u3053\u306e\u5024\u3092\u898b\u308b\u306b\u3001Spark\u306f\u3088\u308a\u4fdd\u5b88\u7684\u3068\u601d\u308f\u308c\u308b\u3002\u307e\u305f\u3001\u3053\u306e24%\u306e\u30e1\u30e2\u30ea\u9818\u57df\u306f\u540c\u4e00Executor\u3067\u5b9f\u884c\u3055\u308c\u308b\u5168\u3066\u306eReducer\u3067\u5171\u6709\u3055\u308c\u3066\u3044\u308b\u3002Executor\u306fShuffleMemoryMap: HashMap[threadId, occupiedMemory]\u3092\u4fdd\u6301\u3057\u3066\u304a\u308a\u3001\u4fdd\u6301\u3057\u3066\u3044\u308b\u5404Reducer\u4e2d\u306eExternalAppendOnlyMaps\u306e\u30e1\u30e2\u30ea\u4f7f\u7528\u91cf\u3092\u76e3\u8996\u3057\u3066\u3044\u308b\u3002AppendOnlyMap\u306e\u30b5\u30a4\u30ba\u3092\u5897\u5927\u3055\u305b\u308b\u524d\u306b\u3001\u5897\u5927\u5f8c\u306e\u7dcf\u30e1\u30e2\u30ea\u4f7f\u7528\u91cf\u3092ShuffleMemoryMap\u306e\u60c5\u5831\u3092\u57fa\u306b\u7b97\u51fa\u3057\u3001\u5341\u5206\u306a\u9818\u57df\u304c\u78ba\u4fdd\u53ef\u80fd\u304b\u3069\u3046\u304b\u306e\u78ba\u8a8d\u3092\u884c\u3063\u3066\u3044\u308b\u3002\u305f\u3060\u3057\u3001\u306f\u3058\u3081\u306e1000Record\u3092\u4fdd\u6301\u3059\u308b\u9593\u306b\u306f\u30c7\u30a3\u30b9\u30af\u51fa\u529b\u30c1\u30a7\u30c3\u30af\u304c\u884c\u308f\u308c\u306a\u3044\u3053\u3068\u306b\u7559\u610f\u3059\u308b\u3053\u3068\u3002\n- AppendOnlyMap\u306e\u30b5\u30a4\u30ba\u7b97\u51fa\uff1aAppendOnlyMap\u306e\u30b5\u30a4\u30ba\u306fAppendOnlyMap\u306e\u30b5\u30a4\u30ba\u3092\u5897\u5927\u3055\u305b\u308b\u969b\u306bAppendOnlyMap\u304b\u3089\u53c2\u7167\u3055\u308c\u3066\u3044\u308b\u5168\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306e\u30e1\u30e2\u30ea\u91cf\u3092\u8a08\u7b97\u3059\u308b\u3053\u3068\u3067\u53ef\u80fd\u3068\u306a\u308b\u3002\u3057\u304b\u3057\u3001\u305d\u308c\u306f\u8a08\u7b97\u6642\u9593\u304c\u304b\u304b\u308a\u3059\u304e\u308b\u3002Spark\u306f\u8a08\u7b97\u91cfO(1)\u3067\u5b9f\u884c\u53ef\u80fd\u306a\u30b5\u30a4\u30ba\u7b97\u51fa\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3092\u4fdd\u6301\u3057\u3066\u3044\u308b\u3002\u3053\u306e\u65b9\u5f0f\u306e\u30b3\u30f3\u30bb\u30d7\u30c8\u306fAppendOnlyMap\u306b\u5bfe\u3057\u3066\u30c7\u30fc\u30bf\u306e\u8ffd\u52a0\u3084\u4fdd\u6301\u30c7\u30fc\u30bf\u306e\u96c6\u8a08\u3092\u884c\u3046\u969b\u306bMap\u30b5\u30a4\u30ba\u306e\u5909\u52d5\u3092Record\u306e\u30c7\u30fc\u30bf\u69cb\u9020\u30b5\u30a4\u30ba\u3092\u7b97\u51fa\u3059\u308b\u3053\u3068\u3067\u884c\u3046\u3068\u3044\u3046\u3082\u306e\u3002\u8a73\u7d30\u306fSizeTrackingAppendOnlyMap\u3084SizeEstimator\u306b\u3066\u78ba\u8a8d\u53ef\u80fd\u3002\n- \u30c7\u30a3\u30b9\u30af\u51fa\u529b\u30d7\u30ed\u30bb\u30b9\uff1aShuffle Write\u30d7\u30ed\u30bb\u30b9\u306e\u3088\u3046\u306b\u3001Spark\u306fRecord\u3092\u30c7\u30a3\u30b9\u30af\u51fa\u529b\u3059\u308b\u969b\u306b\u306fBuffer\u306e\u751f\u6210\u3092\u884c\u3046\u3002Buffer\u306e\u30b5\u30a4\u30ba\u306f\u8a2d\u5b9aspark.shuffle.file.buffer.kb\u3067\u8a2d\u5b9a\u53ef\u80fd\u3067\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u306f32KB\u3068\u306a\u3063\u3066\u3044\u308b\u3002\u30b7\u30ea\u30a2\u30e9\u30a4\u30b6\u3082\u540c\u69d8\u306b\u30c7\u30a3\u30b9\u30af\u51fa\u529b\u306e\u305f\u3081\u306b\u30d0\u30c3\u30d5\u30a1\u3092\u5272\u308a\u632f\u3063\u3066\u3044\u308b\u304c\u3001\u5927\u91cf\u306eRecord\u3092\u540c\u6642\u306b\u30c7\u30a3\u30b9\u30af\u51fa\u529b\u3057\u3088\u3046\u3068\u3057\u305f\u969b\u306b\u554f\u984c\u304c\u767a\u751f\u3057\u3048\u308b\u3002\u305d\u306e\u305f\u3081\u3001Spark\u3067\u306f\u540c\u6642\u306b\u30c7\u30a3\u30b9\u30af\u51fa\u529b\u53ef\u80fd\u306aRecord\u6570\u3092\u8a2d\u5b9aspark.shuffle.spill.batchSize\u3067\u5236\u9650\u3057\u3066\u3044\u308b\u3002\u30c7\u30d5\u30a9\u30eb\u30c8\u5024\u306f10000\u3068\u306a\u3063\u3066\u3044\u308b\u3002\n\n\u307e\u3068\u3081\n\u672c\u7ae0\u306e\u3053\u3053\u307e\u3067\u3067\u3001Spark\u304cHadoop MapReduce\u306e\u56fa\u5b9a\u3055\u308c\u305fshuffle-combine-merge-reduce\u30e2\u30c7\u30eb\u3068\u6bd4\u3079\u3066\u3088\u308a\u67d4\u8edf\u306aShuffle\u30d7\u30ed\u30bb\u30b9\u3092\u6301\u3063\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u3063\u305f\u306f\u305a\u3002\u3053\u306eShuffle\u30d7\u30ed\u30bb\u30b9\u306b\u3088\u308a\u3001Spark\u306f\u5b9f\u969b\u306e\u30c7\u30fc\u30bf\u5909\u63db\u306e\u610f\u5473\u306b\u57fa\u3065\u3044\u3066\u7570\u306a\u308b\u30c7\u30fc\u30bf\u69cb\u9020\u3068\u7570\u306a\u308bShuffle\u6226\u7565\u3092\u7d44\u307f\u5408\u308f\u305b\u308b\u3053\u3068\u304c\u53ef\u80fd\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\u3053\u3053\u307e\u3067\u3067\u3001Spark\u306eShuffle\u30d7\u30ed\u30bb\u30b9\u306eSort\u3092\u884c\u308f\u306a\u3044\u30b1\u30fc\u30b9\u3092\u57fa\u306b\u3069\u306e\u3088\u3046\u306b\u5b9f\u969b\u306eRDD\u306e\u9023\u9396\u306e\u4e2d\u306b\u7d44\u307f\u8fbc\u307e\u308c\u308b\u304b\u3092\u8a18\u8ff0\u3057\u305f\u3002\u4f75\u305b\u3066\u3001\u30e1\u30e2\u30ea\u3084\u30c7\u30a3\u30b9\u30af\u306e\u4f7f\u7528\u65b9\u5f0f\u306b\u3064\u3044\u3066Hadoop MapReduce\u3068\u6bd4\u8f03\u3057\u306a\u304c\u3089\u8a18\u8ff0\u3057\u305f\u3002\u6b21\u306e\u7ae0\u3067\u306f\u30d7\u30ed\u30bb\u30b9\u9593\u901a\u4fe1\u306e\u8996\u70b9\u304b\u3089\u3001\u3069\u306e\u3088\u3046\u306b\u30b8\u30e7\u30d6\u304c\u5b9f\u884c\u3055\u308c\u308b\u304b\u3092\u8a18\u8ff0\u3059\u308b\u3002\u305d\u306e\u4e2d\u3067\u3001Shuffle\u6642\u306e\u30c7\u30fc\u30bf\u4fdd\u5b58\u5148\u306e\u554f\u984c\u306b\u3064\u3044\u3066\u3082\u89e6\u308c\u308b\u3002\n\n\u7d42\u308f\u308a\u306b\n\u3053\u306e\u7ae0\u3067Shuffle\u3092\u3069\u306e\u3088\u3046\u306b\u5b9f\u73fe\u3059\u308b\u304b\u304c\u89e6\u308c\u3089\u308c\u307e\u3057\u305f\u304c\u3001\u524d\u306eStage\u304c\u5168\u3066\u5b8c\u4e86\u3057\u306a\u3044\u3068\u6b21\u306eStage\u304c\u958b\u59cb\u3067\u304d\u305a\u3001\u30aa\u30fc\u30d0\u30fc\u30e9\u30c3\u30d7\u3057\u305f\u5b9f\u884c\u304c\u3067\u304d\u306a\u3044\u306a\u3069\u306e\u6027\u80fd\u7684\u306b\u554f\u984c\u304c\u767a\u751f\u3057\u305d\u3046\u306a\u8981\u7d20\u306b\u3064\u3044\u3066\u3082\u898b\u3048\u3066\u304d\u307e\u3057\u305f\u3002\n\u3053\u306e\u7ae0\u307e\u3067\u3067\u30c7\u30fc\u30bf\u304c\u3069\u306e\u3088\u3046\u306b\u79fb\u52d5\u3057\u3001\u51e6\u7406\u3055\u308c\u308b\u304b\u306e\u6d41\u308c\u306f\u898b\u3048\u3066\u304d\u305f\u305f\u3081\u3001\u5f8c\u306f\u305d\u306e\u6d41\u308c\u3092\u3069\u306e\u3088\u3046\u306b\u5b9f\u73fe\u3057\u3066\u3044\u308b\u304b\u3001\u304c\u4ee5\u5f8c\u306e\u7ae0\u3067\u8a9e\u3089\u308c\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\n# \u306f\u3058\u3081\u306b\n\u3053\u3093\u306b\u3061\u306f\u3002\n[\u524d\u56de](http://qiita.com/kimutansk/items/643fd543b48b611ba041)\u306b\u5f15\u304d\u7d9a\u304d\u3001[SparkInternals](https://github.com/JerryLead/SparkInternals)\u3092\u8a33\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n\u524d\u56de\u3068\u540c\u3058\u304f\u4ee5\u5f8c\u306f\u4e0b\u8a18\u306e\u5224\u4f8b\u3068\u306a\u308a\u307e\u3059\u3002\n\nSparkInternals\u8a33\u6587\n*\u30b3\u30e1\u30f3\u30c8*\n\n# SparkInternals\n## Shuffle Process\n\n\u3053\u3053\u307e\u3067\u3067Spark\u306ePhysicalPlan\u3068\u3001\u305d\u308c\u3092\u3069\u3046\u5b9f\u884c\u3059\u308b\u304b\u306e\u8a73\u7d30\u3092\u66f8\u3044\u3066\u304d\u305f\u3002\u3060\u304c\u3001ShuffleDependency\u3092\u901a\u3057\u3066\u6b21\u306eStage\u304c\u3069\u306e\u3088\u3046\u306b\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3059\u308b\u304b\u306b\u3064\u3044\u3066\u306f\u89e6\u308c\u3089\u308c\u3066\u3044\u306a\u304b\u3063\u305f\u305f\u3081\u3001\u672c\u7ae0\u3067\u3053\u308c\u3092\u8a18\u8ff0\u3059\u308b\u3002\n\n### Shuffle Comparison between Hadoop and Spark\n\nHadoop MapReduce\u3068Spark\u306eShuffle\u30d7\u30ed\u30bb\u30b9\u306b\u306f\u5171\u901a\u70b9\u3068\u76f8\u9055\u70b9\u304c\u5b58\u5728\u3059\u308b\u3002\n\n**\u62bd\u8c61\u5316\u3057\u305f\u30ec\u30d9\u30eb\u3067\u898b\u308b\u3068\u3001\u4e21\u8005\u306f\u5171\u901a\u3057\u3066\u3044\u308b\u3002**\n\u4e21\u8005\u306f\u5171\u306bMapper(Spark\u306e\u5834\u5408\u3001ShuffleMapTask)\u306e\u51fa\u529b\u3092\u5206\u5272\u3057\u3001\u5bfe\u5fdc\u3059\u308bReducer(Spark\u306e\u5834\u5408\u3001\u6b21\u306eStage\u306eShuffleMapTask\u304b\u3001ResultTask)\u306b\u9001\u4fe1\u3059\u308b\u3068\u3044\u3046\u69cb\u9020\u3092\u6301\u3063\u3066\u3044\u308b\u3002Reducer\u5074\u306f\u305d\u306e\u30c7\u30fc\u30bf\u3092\u30e1\u30e2\u30ea\u4e0a\u306b\u4fdd\u6301\u3057\u3001Shuffle&Aggregate\u3092\u884c\u3063\u305f\u3046\u3048\u3067\u5b9f\u969b\u306e`reduce()`\u3092\u9069\u7528\u3059\u308b\u3053\u3068\u3067\u30c7\u30fc\u30bf\u306e\u7d71\u5408\u3092\u884c\u3046\u3002\n\n**\u3088\u308a\u5b9f\u88c5\u30ec\u30d9\u30eb\u306b\u8fd1\u3065\u3044\u305f\u8996\u70b9\u3067\u898b\u308b\u3068\u3001\u4e21\u8005\u306b\u306f\u9055\u3044\u304c\u3042\u308b\u3002**\nHadoop MapReduce\u306b\u304a\u3051\u308bShuffle\u306fSort\u30d9\u30fc\u30b9\u306b\u306a\u3063\u3066\u304a\u308a\u3001`combine()`\u3001`reduce()`\u5b9f\u884c\u524d\u306b\u3042\u3089\u304b\u3058\u3081\u30bd\u30fc\u30c8\u304c\u5b8c\u4e86\u3057\u3066\u3044\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\u305d\u306e\u30bd\u30fc\u30c8\u51e6\u7406\u306f\u5916\u90e8\u30bd\u30fc\u30c8\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3067\u5b9f\u65bd\u3055\u308c\u3066\u3044\u308b\u3002\n\u5bfe\u3057\u3066\u3001\u73fe\u72b6Spark\u306eShuffle\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u52d5\u4f5c\u306fHash\u30d9\u30fc\u30b9\u3068\u306a\u3063\u3066\u3044\u308b\u3002\u901a\u5e38\u306f\u305d\u306e\u7d50\u5408\u51e6\u7406\u306fHashMap\u3092\u7528\u3044\u3066\u5b9f\u65bd\u3055\u308c\u3001\u30bd\u30fc\u30c8\u304c\u4e8b\u524d\u306b\u884c\u308f\u308c\u308b\u3068\u3044\u3046\u3053\u3068\u306f\u306a\u3044\u3002\u3082\u3057\u30c7\u30fc\u30bf\u3092\u30bd\u30fc\u30c8\u3057\u3066\u304b\u3089\u5229\u7528\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u5834\u5408\u3001\u660e\u793a\u7684\u306b`sortByKey()`\u3092\u5b9f\u884c\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\u305f\u3060\u3057\u3001Spark1.1\u304b\u3089Sort\u30d9\u30fc\u30b9\u306eShuffle\u30d7\u30ed\u30bb\u30b9\u3082\u5b9f\u884c\u53ef\u80fd\u306b\u306a\u3063\u3066\u304a\u308a\u3001Spark1.2\u4ee5\u964d\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u306eShuffle\u30d7\u30ed\u30bb\u30b9\u306e\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3082Sort\u30d9\u30fc\u30b9\u3068\u306a\u3063\u3066\u3044\u308b\u3002\n*Spark1.2\u4ee5\u964d\u306eShuffle\u306fSort\u7248\u3068\u306a\u3063\u3066\u3044\u307e\u3059\u3002Sort\u7248Shuffle\u306e\u8a73\u7d30\u306f[Spark Architecture:Shuffle](http://qiita.com/giwa/items/08ac5bda1eabb8c597b3)\u3067\u8aac\u660e\u3055\u308c\u3066\u3044\u307e\u3059\u3002*\n\n\u5b9f\u88c5\u9762\u3067\u898b\u305f\u5834\u5408\u3001\u540c\u69d8\u306b\u9055\u3044\u304c\u5b58\u5728\u3059\u308b\u3002\n\u65e2\u306b\u308f\u304b\u3063\u3066\u3044\u308b\u3088\u3046\u306b\u3001Hadoop MapReduce\u306b\u304a\u3044\u3066\u306f\u660e\u78ba\u306a`map() > spill > merge >  shuffle > sort > reduce()`\u3068\u3044\u3046\u6d41\u308c\u304c\u5b58\u5728\u3057\u3066\u304a\u308a\u3001\u5404Step\u306f\u4e8b\u524d\u5b9a\u7fa9\u3055\u308c\u3066\u304a\u308a\u3001\u624b\u7d9a\u304d\u578b\u306e\u30d7\u30ed\u30b0\u30e9\u30df\u30f3\u30b0\u3068\u76f8\u6027\u306e\u3044\u3044\u3082\u306e\u3068\u306a\u3063\u3066\u3044\u308b\u3002\n\u3057\u304b\u3057\u306a\u304c\u3089\u3001Spark\u306b\u304a\u3044\u3066\u306f\u305d\u306e\u3088\u3046\u306a\u56fa\u5b9a\u5316\u3055\u308c\u305fStep\u306f\u5b58\u5728\u305b\u305a\u3001\u4ee3\u308f\u308a\u306bStage\u7fa4\u3068\u4e00\u9023\u306eTransformation\u304c\u5b58\u5728\u3057\u3066\u3044\u308b\u3002\u305d\u306e\u305f\u3081\u3001spill\u3001merge\u3001aggregate\u3068\u3044\u3063\u305f\u51e6\u7406\u306f\u4e00\u9023\u306eTransformation\u306b\u5185\u5305\u3055\u308c\u308b\u5f62\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\nMapper\u5074\u306ePartition\u5206\u5272\u3001\u304a\u3088\u3073\u30c7\u30fc\u30bf\u4fdd\u6301\u30d7\u30ed\u30bb\u30b9\u3092\"Shuffle Write\"\u3001Reducer\u5074\u306e\u30c7\u30fc\u30bf\u8aad\u307f\u8fbc\u307f\u3001\u96c6\u8a08\u30d7\u30ed\u30bb\u30b9\u3092\"Shuffle Read\"\u3068\u540d\u3065\u3051\u308b\u3002\u3059\u308b\u3068\u3001Shuffle Write/Shuffle Read\u3092\u3069\u306e\u3088\u3046\u306bSpark\u306eLogicalPlan/PhysicalPlan\u3068\u7d71\u5408\u3059\u308c\u3070\u3044\u3044\u306e\u304b\u3001\u3068\u3044\u3046\u554f\u984c\u304c\u751f\u3058\u308b\u3002Shuffle Write/Shuffle Read\u3092\u52b9\u7387\u7684\u306b\u5b9f\u884c\u3059\u308b\u306b\u306f\u3069\u306e\u3088\u3046\u306b\u5b9f\u88c5\u3059\u308c\u3070\u3044\u3044\u306e\u3060\u308d\u3046\u304b\uff1f\n\n### Shuffle Write\n\nShuffle Write\u306fSort\u3055\u308c\u305f\u51fa\u529b\u304c\u5fc5\u8981\u306a\u3044\u5834\u5408\u3001\u76f8\u5bfe\u7684\u306a\u30b7\u30f3\u30d7\u30eb\u306a\u69cb\u6210\u306eTask\u3068\u306a\u308b\u3002Shuffle Write\u306f\u30c7\u30fc\u30bf\u3092\u5206\u5272\u3057\u3001\u51fa\u529b\u3059\u308b\u306e\u307f\u3068\u306a\u308b\u3002\u3053\u306e\u3088\u3046\u306a\u30c7\u30fc\u30bf\u6c38\u7d9a\u5316\u306f\u300c\u30d2\u30fc\u30d7\u9818\u57df\u4f7f\u7528\u91cf\u524a\u6e1b\u300d\u300c\u8010\u969c\u5bb3\u6027\u300d\u306e2\u500b\u306e\u5229\u70b9\u3092\u6301\u3064\u3002\n\n\u672c\u6a5f\u80fd\u306e\u5b9f\u88c5\u306f\u30b7\u30f3\u30d7\u30eb\u3068\u306a\u308b\u3002ShuffleMapStage(\u306eShuffleMapTask)\u306e\u6700\u5f8c\u306bShuffle Write\u3092\u884c\u3046\u30ed\u30b8\u30c3\u30af\u3092\u8ffd\u52a0\u3059\u308c\u3070\u3044\u3044\u3002\u6700\u7d42RDD\u306b\u542b\u307e\u308c\u308b\u5404\u51fa\u529b\u30ec\u30b3\u30fc\u30c9\u306f\u4e0b\u56f3\u306e\u3088\u3046\u306b\u5206\u5272\u3055\u308c\u51fa\u529b\u3055\u308c\u308b\u3002\n\n![shuffle-write-no-consolidation.png](https://qiita-image-store.s3.amazonaws.com/0/9616/85e3ed88-8f8f-33b6-3157-bd529eb345ae.png)\n\n\u4e0a\u8a18\u306e\u56f3\u306b\u304a\u3044\u3066\u306f4\u500b\u306eShuffleMapTasks\u304c2\u500b\u306eCore\u3092\u4fdd\u6301\u3059\u308b\u540c\u4e00Worker\u30ce\u30fc\u30c9\u4e0a\u3067\u5b9f\u884c\u3055\u308c\u3066\u3044\u308b\u3002Task\u5b9f\u884c\u7d50\u679c(Stage\u306e\u6700\u7d42RDD\u4e2d\u306eRecord\u30ea\u30b9\u30c8)\u306f\u30ed\u30fc\u30ab\u30eb\u30c7\u30a3\u30b9\u30af\u306b\u51fa\u529b\u3055\u308c\u308b\u3002\u5404Task\u306fR\u500b(\uff1d\u6b21Stage\u306b\u5b58\u5728\u3059\u308bReducer Task\u306e\u6570)\u306e\u30d0\u30c3\u30d5\u30a1\u3092\u4fdd\u6301\u3059\u308b\u3002\u3053\u306e\u30d0\u30c3\u30d5\u30a1\u7fa4\u306fSpark\u3067\u306fbuckets\u3068\u547c\u3070\u308c\u308b\u3002\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\u5404bucket\u306e\u30b5\u30a4\u30ba\u306f32KB(Spark1.1\u4ee5\u524d\u306f100KB)\u3068\u306a\u3063\u3066\u304a\u308a\u3001\u3053\u306e\u30b5\u30a4\u30ba\u306f\u8a2d\u5b9a**spark.shuffle.file.buffer.kb**\u3067\u8a2d\u5b9a\u53ef\u80fd\u3068\u306a\u3063\u3066\u3044\u308b\u3002\n\nbucket\u306fSpark\u306b\u304a\u3051\u308bShuffleMapTask\u306e\u30c7\u30fc\u30bf\u5206\u5272\u7d50\u679c\u306e\u51fa\u529b\u5148\u3092\u793a\u3059\u5171\u901a\u7684\u306a\u6982\u5ff5\u3068\u306a\u3063\u3066\u3044\u308b\u3002\u305f\u3060\u3001\u3053\u3053\u3067\u306f\u5358\u7d14\u5316\u306e\u305f\u3081\u306bbucket\u306f\u30e1\u30e2\u30ea\u4e0a\u306e\u30d0\u30c3\u30d5\u30a1\u3068\u3057\u3066\u6271\u3046\u3002\nShuffleMapTask\u306f\u6700\u7d42RDD\u306e\u7d50\u679c\u3092\u7b97\u51fa\u3059\u308b\u305f\u3081\u306b\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\u5316\u6280\u8853\u3092\u4f7f\u7528\u3057\u3066\u3044\u308b\u3002\u5404Record\u306f`partitioner.partition(record.getKey())`\u3067\u6c7a\u5b9a\u3055\u308c\u308b\u6240\u5c5ebucket\u306b\u5bfe\u3057\u3066\u9001\u4fe1\u3055\u308c\u308b\u3002\u3053\u308c\u3089\u306ebucket\u4e2d\u306e\u30c7\u30fc\u30bf\u306f\u7d99\u7d9a\u7684\u306b\u30ed\u30fc\u30ab\u30eb\u30d5\u30a1\u30a4\u30eb\u4e0a\u306bShuffleBlockFile\u3001\u307e\u305f\u306f\u7565\u3057\u3066FileSegment\u3068\u3057\u3066\u547c\u3070\u308c\u308b\u30d5\u30a1\u30a4\u30eb\u5f62\u614b\u3068\u3057\u3066\u7d99\u7d9a\u7684\u306b\u51fa\u529b\u3055\u308c\u308b\u3002Reducers\u306fShuffle Read\u30d5\u30a7\u30fc\u30ba\u306b\u304a\u3044\u3066\u3001\u3053\u308c\u3089\u306eFileSegment\u304b\u3089\u30c7\u30fc\u30bf\u3092\u8aad\u307f\u8fbc\u3080\u3002\n\n\u3053\u306e\u3088\u3046\u306a\u5b9f\u88c5\u306f\u975e\u5e38\u306b\u30b7\u30f3\u30d7\u30eb\u306b\u6e08\u3080\u304c\u3001\u3044\u304f\u3064\u304b\u306e\u691c\u8a0e\u4e8b\u9805\u3082\u6301\u3064\u3002\n1. \u975e\u5e38\u306b\u6570\u591a\u304f\u306eFileSegment\u3092\u51fa\u529b\u3059\u308b\u5371\u967a\u6027\u304c\u3042\u308b\u3068\u3044\u3046\u3053\u3068\u3002\u5404ShuffleMapTask\u306fR(\uff1d\u6b21Stage\u306b\u5b58\u5728\u3059\u308bReducer Task\u306e\u6570)\u500b\u306eFileSegment\u3092\u51fa\u529b\u3059\u308b\u3001\u3064\u307e\u308aM\u500b\u306eShuffleMapTask\u306fM * R\u500b\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u51fa\u529b\u3059\u308b\u3002\u5927\u304d\u306a\u30c7\u30fc\u30bf\u30bb\u30c3\u30c8\u306b\u5bfe\u3057\u3066\u51e6\u7406\u3092\u884c\u3046\u5834\u5408\u306b\u306fM\u3082R\u3082\u5de8\u5927\u306a\u5024\u3068\u306a\u308a\u3001\u305d\u308c\u3060\u3051\u5927\u91cf\u306e\u4e2d\u9593\u30c7\u30fc\u30bf\u30d5\u30a1\u30a4\u30eb\u3092\u4fdd\u6301\u3059\u308b\u3053\u3068\u306b\u306a\u3063\u3066\u3057\u307e\u3046\u3002\n2. \u3053\u308c\u3089\u306e\u30d0\u30c3\u30d5\u30a1\u306f\u5927\u91cf\u306e\u30b9\u30da\u30fc\u30b9\u3092\u78ba\u4fdd\u3059\u308b\u30b1\u30fc\u30b9\u304c\u3042\u308b\u3068\u3044\u3046\u3053\u3068\u3002Worker\u30ce\u30fc\u30c9\u306b\u304a\u3044\u3066\u3001Spark\u306b\u7528\u3044\u308b\u3053\u3068\u304c\u51fa\u6765\u308bCore\u6bce\u306bR * M\u500b\u306ebucket\u3092\u78ba\u4fdd\u3055\u308c\u308b\u8a08\u7b97\u3068\u306a\u308b\u3002Spark\u3067\u306fShuffleMapTask\u5b9f\u884c\u5f8c\u306b\u3053\u306e\u30d0\u30c3\u30d5\u30a1\u3092\u518d\u5229\u7528\u3059\u308b\u306e\u3060\u304c\u3001R * n \u500b\u306ebucket\u306f\u30e1\u30e2\u30ea\u4e0a\u306b\u6b8b\u3063\u3066\u3057\u307e\u3046\u3002\u4f8b\u3048\u30708Core\u3092\u4fdd\u6301\u3057\u30661000ReducerJob\u304c\u5b58\u5728\u3059\u308b\u30b1\u30fc\u30b9\u3092\u8003\u3048\u308b\u3068\u3001bucket\u306e\u7dcf\u5bb9\u91cf\u306f256MB\u306b\u3082\u9054\u3059\u308b\u3002(R * cores * 32KB)\n\n\u73fe\u5728\u306f2\u500b\u76ee\u306e\u554f\u984c\u306b\u5bfe\u3057\u3066\u3042\u307e\u308a\u3088\u308d\u3057\u304f\u306a\u3044\u89e3\u6c7a\u7b56\u304c\u9069\u7528\u3055\u308c\u3066\u3044\u308b\u3002\u3068\u306b\u304b\u304f\u30d0\u30c3\u30d5\u30a1\u306b\u66f8\u304d\u8fbc\u3080\u5fc5\u8981\u304c\u3042\u308b\u95a2\u4fc2\u4e0a\u3001\u30d0\u30c3\u30d5\u30a1\u304c\u5c0f\u3055\u3059\u304e\u308b\u5834\u5408\u3001IO\u901f\u5ea6\u306b\u5f71\u97ff\u304c\u51fa\u308b\u30021\u500b\u76ee\u306e\u554f\u984c\u306b\u5bfe\u3057\u3066\u306f\u30d5\u30a1\u30a4\u30eb\u3092\u96c6\u7d04\u3059\u308b\u65b9\u5f0f\u304c\u3059\u3067\u306b\u5b9f\u88c5\u6e08\u307f\u3068\u306a\u3063\u3066\u3044\u308b\u3002\u305d\u306e\u65b9\u5f0f\u306b\u3064\u3044\u3066\u898b\u3066\u307f\u3088\u3046\u3002\n\n![shuffle-write-consolidation.png](https://qiita-image-store.s3.amazonaws.com/0/9616/683bf9cb-a604-ddfc-dbb5-0059947295bd.png)\n\n\u4e0a\u8a18\u306e\u56f3\u304b\u3089\u660e\u767d\u3060\u3068\u306f\u601d\u3046\u304c\u3001ShuffleMapTasks\u304c1Core\u4e0a\u3067\u9023\u7d9a\u3057\u3066\u5b9f\u884c\u3055\u308c\u308b\u5834\u5408\u3001Shuffle\u7528\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u5171\u6709\u3059\u308b\u65b9\u5f0f\u3068\u306a\u3063\u3066\u3044\u308b\u3002\u5404Task\u306f\u51fa\u529b\u30c7\u30fc\u30bf\u3092\u524dTask\u304c\u51fa\u529b\u3057\u305fShuffleBlock i\u306b\u5bfe\u3057\u3066ShuffleBlock i'\u3068\u3057\u3066\u8ffd\u8a18\u3059\u308b\u3002\u3053\u3053\u3067ShuffleBlock\u306fFileSegment\u3068\u547c\u3070\u308c\u308b\u3002\u3053\u306e\u65b9\u5f0f\u306b\u304a\u3044\u3066\u306f\u6b21Stage\u306eReducer\u7fa4\u306f\u3053\u306e\u51fa\u529b\u3055\u308c\u305f\u30d5\u30a1\u30a4\u30eb\u3092\u4e38\u3005\u8aad\u307f\u8fbc\u3080\u3060\u3051\u3067\u3088\u304f\u3001\u5404Worker\u30ce\u30fc\u30c9\u3067\u51fa\u529b\u3055\u308c\u308b\u30d5\u30a1\u30a4\u30eb\u6570\u3092Cores * R\u307e\u3067\u524a\u6e1b\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\u30d5\u30a1\u30a4\u30eb\u96c6\u7d04\u6a5f\u80fd\u306f \u8a2d\u5b9a**spark.shuffle.consolidateFiles**\u306b\u3066\u6709\u52b9\u5316\u53ef\u80fd\u3002\n\n### Shuffle Read\n\n\u307e\u305a\u306fShuffleDependency\u3092\u542b\u3080reduceBykey\u306ePhysicalPlan\u3092\u898b\u3066\u307f\u3088\u3046\u3002\n\n![reduceByKeyStage.png](https://qiita-image-store.s3.amazonaws.com/0/9616/141ba864-2dea-a2af-78f5-e5f000897e51.png)\n\n\u76f4\u611f\u7684\u306bShuffleRDD\u3092\u69cb\u6210\u3059\u308b\u305f\u3081\u306bMapPartitionRDD\u306e\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3053\u3068\u306f\u308f\u304b\u308b\u3002\n\u305f\u3060\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306a\u554f\u984c\u304c\u3042\u308b\u3002\n\n\u3044\u3064\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3059\u308b\u306e\u304b\uff1f\u5404ShuffleMapTask\u304c\u5b9f\u884c\u3055\u308c\u308b\u6bce\u306b\u53d6\u5f97\u3059\u308b\u306e\u304b\uff1f\u305d\u308c\u3068\u3082\u3059\u3079\u3066\u306eShuffleMapTasks\u306e\u5b9f\u884c\u5b8c\u4e86\u5f8c\u306b\u307e\u3068\u3081\u3066\u53d6\u5f97\u3059\u308b\u306e\u304b\uff1f\n\u53d6\u5f97\u3068\u53d6\u5f97\u3057\u305f\u30ec\u30b3\u30fc\u30c9\u306e\u51e6\u7406\u306f\u540c\u6642\u306b\u5b9f\u884c\u3059\u308b\u306e\u304b\u3001\u305d\u308c\u3068\u3082\u5225\u3005\u306e\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u884c\u3046\u306e\u304b\uff1f\n\u53d6\u5f97\u3057\u305f\u30c7\u30fc\u30bf\u306f\u3069\u3053\u306b\u4fdd\u6301\u3059\u308b\u306e\u304b\uff1f\n\u6b21Stage\u306eTask\u306f\u3069\u306e\u3088\u3046\u306b\u53d6\u5f97\u3055\u308c\u305f\u30c7\u30fc\u30bf\u306e\u5834\u6240\u3092\u7279\u5b9a\u3059\u308b\u306e\u304b\uff1f\n\nSpark\u3067\u306e\u65b9\u5f0f\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3068\u306a\u308b\u3002\n\n**\u3044\u3064\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3059\u308b\u306e\u304b\uff1f**\n\u5168ShuffleMapTasks\u306e\u7d42\u4e86\u3092\u5f85\u3061\u3001\u305d\u306e\u5f8c\u30c7\u30fc\u30bf\u306e\u53d6\u5f97\u3092\u884c\u3046\u3002\u65e2\u306b\u308f\u304b\u3063\u3066\u3044\u308b\u3068\u304a\u308a\u3001Stage\u306f\u89aaStage\u304c\u3059\u3079\u3066\u5b9f\u884c\u3055\u308c\u305f\u5f8c\u306b\u5b9f\u884c\u3055\u308c\u308b\u3002\u305d\u306e\u305f\u3081\u3001\u30c7\u30fc\u30bf\u53d6\u5f97\u51e6\u7406\u304c\u524dStage\u306e\u5168ShuffleMapTasks\u5b9f\u884c\u5f8c\u306b\u59cb\u307e\u308b\u3053\u3068\u306f\u76f4\u611f\u7684\u306b\u308f\u304b\u308b\u3060\u308d\u3046\u3002\u53d6\u5f97\u3057\u305fFileSegments\u306f\u30e1\u30e2\u30ea\u4e0a\u306b\u4fdd\u6301\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u304c\u3001\u305d\u308c\u3060\u3051\u3060\u3068\u53d6\u5f97\u3057\u305f\u30c7\u30fc\u30bf\u3092\u30c7\u30a3\u30b9\u30af\u306b\u51fa\u529b\u3059\u308b\u524d\u306b\u5927\u91cf\u306e\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u306a\u3044\u3053\u3068\u306b\u306a\u308b\u3002Spark\u3067\u306f\u8a2d\u5b9a**spark.reducer.maxMbInFlight**\u306b\u3088\u3063\u3066\u3053\u306e\u53d6\u5f97\u7528\u30d0\u30c3\u30d5\u30a1\u306e\u30b5\u30a4\u30ba\u3092\u8a2d\u5b9a\u3057\u3066\u3044\u308b\u3002\u30c7\u30d5\u30a9\u30eb\u30c8\u306f48MB\u3068\u306a\u3063\u3066\u3044\u308b\u3002\u3053\u306e\u30d0\u30c3\u30d5\u30a1(SoftBuffer)\u306f\u666e\u6bb5\u306f\u8907\u6570\u306e\u53d6\u5f97\u3055\u308c\u305fFileSegments\u3092\u4fdd\u6301\u3059\u308b\u304c\u3001\u30c7\u30fc\u30bf\u30b5\u30a4\u30ba\u6b21\u7b2c\u3067\u306f1\u500b\u306eFileSegments\u3067\u5360\u6709\u3055\u308c\u3066\u3057\u307e\u3046\u30b1\u30fc\u30b9\u3082\u3042\u308b\u3002\n\n**\u53d6\u5f97\u3068\u53d6\u5f97\u3057\u305f\u30ec\u30b3\u30fc\u30c9\u306e\u51e6\u7406\u306f\u540c\u6642\u306b\u5b9f\u884c\u3059\u308b\u306e\u304b\u3001\u305d\u308c\u3068\u3082\u5225\u3005\u306e\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u884c\u3046\u306e\u304b\uff1f**\nRecord\u306e\u53d6\u5f97\u3068\u51e6\u7406\u306f\u540c\u3058\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u884c\u308f\u308c\u308b\u3002MapReduce\u306e\u5834\u5408\u3001Shuffle Stage\u306f\u30c7\u30fc\u30bf\u306e\u53d6\u5f97\u3068\u3001`combine()`\u30ed\u30b8\u30c3\u30af\u306e\u9069\u7528\u304c\u540c\u3058\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u884c\u308f\u308c\u308b\u3002\u3057\u304b\u3057\u3001MapReduce\u306b\u304a\u3044\u3066\u306fReducer\u306e\u5165\u529b\u30c7\u30fc\u30bf\u306f\u3042\u3089\u304b\u3058\u3081\u30bd\u30fc\u30c8\u3055\u308c\u3066\u3044\u308b\u5fc5\u8981\u304c\u3042\u308b\u305f\u3081\u3001`reduce()`\u30ed\u30b8\u30c3\u30af\u306fshuffle-sort\u30d7\u30ed\u30bb\u30b9\u306e\u5f8c\u306b\u9069\u7528\u3055\u308c\u308b\u3002Spark\u3067\u306fReducer\u306e\u5165\u529b\u30c7\u30fc\u30bf\u304c\u30bd\u30fc\u30c8\u3055\u308c\u3066\u3044\u308b\u5fc5\u8981\u306f\u306a\u3044\u305f\u3081\u3001\u30c7\u30fc\u30bf\u306e\u53d6\u5f97\u306e\u5b8c\u4e86\u3092\u51e6\u7406\u958b\u59cb\u307e\u3067\u5f85\u3064\u5fc5\u8981\u304c\u306a\u3044\u3002\n\n\u3053\u306e\u3088\u3046\u306a\u6a5f\u69cb\u3092\u5b9f\u73fe\u3059\u308b\u305f\u3081\u306b\u3001Spark\u306b\u304a\u3044\u3066\u306fshuffle\u3068\u3001\u51e6\u7406\u306e\u9069\u7528\u304c\u3069\u306e\u3088\u3046\u306b\u5b9f\u88c5\u3055\u308c\u3066\u3044\u308b\u306e\u304b\uff1f\u5b9f\u969b\u306eSpark\u306b\u304a\u3044\u3066\u306f\u3001\u30b8\u30e7\u30d6\u5b9f\u884c\u7528\u306e\u30c7\u30fc\u30bf\u69cb\u9020\u3068\u3057\u3066HashMap\u306e\u3088\u3046\u306a\u69cb\u9020\u3092\u7528\u3044\u308b\u3053\u3068\u3067\u89e3\u6c7a\u3057\u3066\u3044\u308b\u3002Shuffle\u30d7\u30ed\u30bb\u30b9\u304b\u3089\u53d6\u5f97\u3055\u308c\u305f\u5404<Key, Value>\u306e\u30da\u30a2\u306fHashMap\u306b\u9806\u6b21\u8ffd\u52a0\u3055\u308c\u308b\u3002\u65e2\u306bKey\u306b\u5bfe\u5fdc\u3059\u308b\u30c7\u30fc\u30bf\u304c\u5b58\u5728\u3059\u308b\u5834\u5408\u3001`func(hashMap.get(Key), Value)`\u3092\u9069\u7528\u3057\u3001\u30c7\u30fc\u30bf\u3092\u7d71\u5408\u3057\u3066\u3044\u304f\u3002\u524d\u8ff0\u306eWordCount\u30b5\u30f3\u30d7\u30eb\u306e\u5834\u5408\u3001\u3053\u306e\u95a2\u6570\u306f`hashMap.get(Key) + Value`\u3067\u8868\u3059\u3053\u3068\u304c\u3067\u304d\u3001\u3053\u306e\u7d50\u679c\u304cHashMap\u306e\u5024\u3068\u3057\u3066\u66f4\u65b0\u3055\u308c\u308b\u3002\u3053\u306e\u7d71\u5408\u95a2\u6570\u306fMapReduce\u306b\u304a\u3051\u308b`reduce()`\u3068\u4f3c\u305f\u7acb\u3061\u4f4d\u7f6e\u3060\u304c\u3001\u8a73\u7d30\u306f\u7570\u306a\u308b\u3002\u9055\u3044\u306b\u3064\u3044\u3066\u3092\u4e0b\u8a18\u306e\u30b3\u30fc\u30c9\u30b3\u30fc\u30c9\u30b9\u30cb\u30da\u30c3\u30c8\u306b\u3066\u793a\u3057\u3066\u3044\u308b\u3002\n\n```scala\n// MapReduce\nreduce(K key, Iterable<V> values) {\n    result = process(key, values)\n    return result\n}\n\n// Spark\nreduce(K key, Iterable<V> values) {\n    result = null\n    for (V value : values)\n        result  = func(result, value)\n    return result\n}\n```\n\nHadoop MapReduce\u306b\u304a\u3044\u3066\u306f\u3001Process\u95a2\u6570\u5185\u3067\u4efb\u610f\u306e\u30c7\u30fc\u30bf\u69cb\u9020\u3092\u5b9a\u7fa9\u3059\u308b\u3053\u3068\u304c\u53ef\u80fd\u3067\u3001\u30d1\u30e9\u30e1\u30fc\u30bf\u3068\u3057\u3066\u306fIterable\u3092\u3068\u308b\u3002\u30c7\u30fc\u30bf\u3092\u5148\u306e\u51e6\u7406\u306e\u305f\u3081\u306b\u30ad\u30e3\u30c3\u30b7\u30e5\u3059\u308b\u3053\u3068\u3082\u53ef\u80fd\u3002\nSpark\u306b\u304a\u3044\u3066\u306f\u3001\u9ad8\u968e\u95a2\u6570\u306b\u4f3c\u305f\u6a5f\u69cb\u3092Process\u95a2\u6570\u9069\u7528\u306b\u7528\u3044\u3066\u3044\u308b\u3002\n\u5dee\u306e\u4f8b\u3068\u3057\u3066\u3001Hadoop MapReduce\u306b\u304a\u3044\u3066\u306f\u5168\u4f53\u306e\u5024\u306e\u5e73\u5747\u5024\u3084\u5408\u8a08\u5024\u3001\u500b\u6570\u3092\u51fa\u3059\u3053\u3068\u304c\u975e\u5e38\u306b\u5bb9\u6613\u306b\u306a\u3063\u3066\u3044\u308b\u304c\u3001Spark\u306f\u305d\u3046\u3067\u306f\u306a\u3044\u3002\u8a73\u7d30\u306f\u5f8c\u8ff0\u3059\u308b\u3002\n\n**\u53d6\u5f97\u3057\u305f\u30c7\u30fc\u30bf\u306f\u3069\u3053\u306b\u4fdd\u6301\u3059\u308b\u306e\u304b\uff1f**\n\u53d6\u5f97\u3057\u305fFileSegments\u306fsoftBuffer\u306b\u4fdd\u6301\u3055\u308c\u308b\u3002\u30c7\u30fc\u30bf\u304c\u51e6\u7406\u3055\u308c\u305f\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u3001\u7d50\u679c\u306f\u8a2d\u5b9a\u3067\u5b9a\u7fa9\u3055\u308c\u305f\u7b87\u6240\u306b\u51fa\u529b\u3055\u308c\u308b\u3002\u3082\u3057\u8a2d\u5b9a**spark.shuffle.spill**\u304cfalse\u306e\u5834\u5408\u3001\u3053\u306e\u51fa\u529b\u5148\u306f\u30e1\u30e2\u30ea\u4e0a\u306e\u307f\u306b\u5236\u7d04\u3055\u308c\u308b\u3002\u30e1\u30e2\u30ea\u4e0a\u306e\u30c7\u30fc\u30bf\u4fdd\u6301\u306e\u305f\u3081\u306bAppendOnlyMap\u3068\u3044\u3046\u30c7\u30fc\u30bf\u69cb\u9020\u304c\u7528\u3044\u3089\u308c\u308b\u3002\u30e1\u30e2\u30ea\u4e0a\u306e\u307f\u3067\u306a\u3044\u4fdd\u6301\u306e\u5834\u5408\u3001\u30e1\u30e2\u30ea\u3068\u30c7\u30a3\u30b9\u30af\u4e0a\u306b\u51fa\u529b\u3055\u308c\u308b\u304c\u3001\u305d\u306e\u5834\u5408\u306fExternalAppendOnlyMap\u3068\u3044\u3046\u30c7\u30fc\u30bf\u69cb\u9020\u304c\u7528\u3044\u3089\u308c\u308b\u3002\u3053\u306e\u30c7\u30fc\u30bf\u69cb\u9020\u3092\u7528\u3044\u308b\u3053\u3068\u306b\u3088\u308a\u3001\u30e1\u30e2\u30ea\u4e0a\u306b\u53ce\u307e\u3089\u306a\u3044\u5834\u5408\u306b\u30bd\u30fc\u30c8\u3055\u308c\u305fKey\u3068Value\u306e\u30da\u30a2\u3092\u30c7\u30a3\u30b9\u30af\u4e0a\u306b\u51fa\u529b\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\u30e1\u30e2\u30ea\u3068\u30c7\u30a3\u30b9\u30af\u3092\u4e21\u65b9\u4f7f\u7528\u3059\u308b\u5834\u5408\u306e\u4e3b\u8981\u306a\u554f\u984c\u70b9\u3068\u3057\u3066\u3001\u3069\u306e\u3088\u3046\u306b\u3053\u306e\u4e21\u8005\u306e\u30d0\u30e9\u30f3\u30b9\u3092\u53d6\u308b\u304b\u3001\u304c\u3042\u308b\u3002Hadoop MapReduce\u306b\u304a\u3044\u3066\u306f\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u30e1\u30e2\u30ea\u306e70%\u304cShuffle\u7528\u306e\u9818\u57df\u3068\u3057\u3066\u78ba\u4fdd\u3055\u308c\u3066\u3044\u308b\u3002\u30e1\u30e2\u30ea\u306e\u4f7f\u7528\u91cf\u304c66%\u306b\u9054\u3057\u305f\u30bf\u30a4\u30df\u30f3\u30b0\u3067merge-combine-spill\u30d7\u30ed\u30bb\u30b9\u3092\u958b\u59cb\u3059\u308b\u3002Spark\u3067\u3082\u985e\u4f3c\u306e\u65b9\u5f0f\u3092\u3068\u3063\u3066\u3044\u308b\u304c\u3001\u8a73\u7d30\u306b\u3064\u3044\u3066\u306f\u672c\u7ae0\u306b\u3066\u5f8c\u8ff0\u3059\u308b\u3002\n\n**\u6b21Stage\u306eTask\u306f\u3069\u306e\u3088\u3046\u306b\u53d6\u5f97\u3055\u308c\u305f\u30c7\u30fc\u30bf\u306e\u5834\u6240\u3092\u7279\u5b9a\u3059\u308b\u306e\u304b\uff1f**\n\u524d\u7ae0\u306b\u3066\u3001ShuffleMapStage\u306e\u4e2d\u306e\u91cd\u8981\u306a\u30b9\u30c6\u30c3\u30d7\u3068\u3057\u3066\u3001`MapOutputTrackerMaster.registerShuffle(shuffleId, rdd.partitions.size)`\u3092\u5b9f\u884c\u3057\u3066\u6700\u7d42\u7684\u306aRDD\u3092\u767b\u9332\u3059\u308b\u3068\u3044\u3046\u3082\u306e\u304c\u3042\u308b\u3002\u305d\u306e\u305f\u3081\u3001Shuffle\u306e\u30d7\u30ed\u30bb\u30b9\u306b\u304a\u3044\u3066\u3001Reducer\u306f\u30c7\u30fc\u30bf\u306e\u5834\u6240\u3092Driver\u30d7\u30ed\u30bb\u30b9\u306eMapOutputTrackerMaster\u306b\u554f\u3044\u5408\u308f\u305b\u308b\u3053\u3068\u3067\u53d6\u5f97\u3057\u3066\u3044\u308b\u3002ShuffleMapTask\u304c\u7d42\u4e86\u3057\u305f\u969b\u306b\u3001FileSegment\u306e\u5834\u6240\u3092MapOutputTrackerMaster\u306b\u767b\u9332\u3057\u3066\u3044\u308b\u3002\n\n\u3053\u3053\u307e\u3067\u3067Shuffle Write/Shuffle Read\u3067\u7528\u3044\u3089\u308c\u308b\u30e1\u30a4\u30f3\u306e\u65b9\u5f0f\u306b\u3064\u3044\u3066\u5b9f\u88c5\u4f8b\u3092\u57fa\u306b\u8aac\u660e\u3057\u3066\u304d\u305f\u3002\u4ee5\u5f8c\u306f\u4ed6\u306e\u8208\u5473\u6df1\u3044\u4e8b\u4f8b\u306b\u3064\u3044\u3066\u8a73\u7d30\u3092\u898b\u3066\u307f\u3088\u3046\u3002\n\n### \u5178\u578b\u7684\u306aTransformation\u306b\u304a\u3051\u308bShuffle Read\u8a73\u7d30\n\n#### reduceByKey(func)\n\u3053\u3053\u307e\u3067\u3067\u7c21\u5358\u306b`reduceByKey()`\u306e\u30c7\u30fc\u30bf\u53d6\u5f97\u3001Reduce\u30d7\u30ed\u30bb\u30b9\u306b\u3064\u3044\u3066\u8a18\u8ff0\u3057\u3066\u304d\u305f\u3002\u3053\u3053\u3067\u6ce8\u610f\u3059\u308b\u3079\u304d\u306f\u3001\u3042\u308b\u30bf\u30a4\u30df\u30f3\u30b0\u306b\u304a\u3044\u3066\u3001RDD\u4e2d\u306e\u5168\u30c7\u30fc\u30bf\u304c\u30e1\u30e2\u30ea\u4e0a\u306b\u5b58\u5728\u3059\u308b\u308f\u3051\u3067\u306f\u306a\u3044\u3068\u3044\u3046\u3053\u3068\u3067\u3042\u308b\u3002\u3053\u306e\u30ed\u30b8\u30c3\u30af\u9069\u7528\u51e6\u7406\u306fRecord\u30d9\u30fc\u30b9\u3067\u884c\u308f\u308c\u3001\u65e2\u306b\u51e6\u7406\u304c\u5b8c\u4e86\u3057\u305f\u5143Record\u306f\u30e1\u30e2\u30ea\u4e0a\u304b\u3089\u9664\u53bb\u3055\u308c\u308b\u3002Record\u30ec\u30d9\u30eb\u306e\u8996\u70b9\u306b\u304a\u3044\u3066\u306f`reduce()`\u306e\u51e6\u7406\u306f\u4e0b\u8a18\u306e\u56f3\u306e\u3088\u3046\u306b\u793a\u3055\u308c\u308b\u3002\n\n![reduceByKeyRecord.png](https://qiita-image-store.s3.amazonaws.com/0/9616/81d1bbf2-ae9c-b6cc-dda4-54a7fd124efc.png)\n\n\u3053\u306e\u56f3\u304b\u3089\u308f\u304b\u308b\u3088\u3046\u306b\u3001\u53d6\u5f97\u3055\u308c\u305fRecord\u306fHashMap\u3092\u7528\u3044\u3066\u96c6\u8a08\u3055\u308c\u308b\u3002\u5168Record\u3092\u96c6\u8a08\u3057\u305f\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u7d50\u679c\u304c\u53d6\u5f97\u3067\u304d\u308b\u3002\u305d\u306e\u305f\u3081\u3001func\u306f\u53ef\u63db\u5f8b\u3092\u6e80\u305f\u3059\u5fc5\u8981\u304c\u3042\u308b\u3002\n\n\u4e0a\u8a18\u306e\u56f3\u306b\u304a\u3051\u308bMapPartitionsWithContext\u30aa\u30da\u30ec\u30fc\u30b7\u30e7\u30f3\u306fShuffledRDD\u3092MapPartitionsRDD\u306b\u5909\u63db\u3059\u308b\u305f\u3081\u306b\u7528\u3044\u3089\u308c\u308b\u3002\n\n\u30ce\u30fc\u30c9\u9593\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u901a\u4fe1\u3092\u524a\u6e1b\u3059\u308b\u305f\u3081\u3001Hadoop MapReduce\u306b\u304a\u3044\u3066\u306fMapSideCombine\u3092\u884c\u3046\u3053\u3068\u304c\u3067\u304d\u308b\u3002\u3053\u308c\u306fSpark\u3067\u3082\u5b9f\u884c\u53ef\u80fd\u3002\u305d\u306e\u305f\u3081\u306b\u5fc5\u8981\u306a\u3053\u3068\u306f\u3001ShuffleMapStage\u306b\u304a\u3044\u3066`mapPartitionsWithContext`\u3092\u5b9f\u884c\u3059\u308b\u306e\u307f\u3002reduceByKey\u306e\u4e00\u4f8b\u3068\u3057\u3066\u3001 ParallelCollectionRDD\u304b\u3089MapPartitionsRDD\u3078\u306e\u5909\u63db\u306fMapSideCombine\u3068\u540c\u7b49\u306e\u51e6\u7406\u3092\u884c\u3063\u3066\u3044\u308b\u3002\n\n**Hadoop MapReduce\u306b\u304a\u3051\u308bmap()->reduce()\u3068Spark\u306b\u304a\u3051\u308b reduceByKey\u306e\u6bd4\u8f03**\n\nMapSide:\n\u4e21\u8005\u306b\u9055\u3044\u306f\u306a\u3044\u3002`combine()`\u30ed\u30b8\u30c3\u30af\u306b\u304a\u3044\u3066\u3001Hadoop MapReduce\u306f\u3042\u3089\u304b\u3058\u3081\u30c7\u30fc\u30bf\u304cSort\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u3092\u8ab2\u3057\u3066\u3044\u308b\u3002Spark\u5074\u306fHashMap\u3092\u7528\u3044\u3066`combine()`\u3092\u884c\u3046\u3002\n\nReduce side:\nHadoop MapReduce\u306eReduce\u30d7\u30ed\u30bb\u30b9\u306fShuffle\u7528\u306e\u30c7\u30fc\u30bf\u3092\u3059\u3079\u3066\u53d6\u5f97\u3057\u305f\u5f8c`combine()`\u3092\u9069\u7528\u3059\u308b\u3002\u305d\u306e\u5f8c\u3001\u30c7\u30fc\u30bf\u306e\u30de\u30fc\u30b8\u30bd\u30fc\u30c8\u3092`reduce()`\u306e\u524d\u6e96\u5099\u3068\u3057\u3066\u5b9f\u884c\u3059\u308b\u3002\nSpark\u306b\u304a\u3044\u3066\u306f\u30c7\u30fc\u30bf\u306e\u53d6\u5f97\u3068`reduce()`\u306fHashMap\u3092\u7528\u3044\u3066\u540c\u6642\u306b\u5b9f\u884c\u3055\u308c\u308b\u3002\u305d\u306e\u969b\u3001reduce\u95a2\u6570\u306f\u53ef\u63db\u5f8b\u3092\u6e80\u305f\u3059\u5fc5\u8981\u304c\u3042\u308b\u3002\n\n**\u30e1\u30e2\u30ea\u4f7f\u7528\u306b\u304a\u3051\u308b\u6bd4\u8f03**\n\nMapSide:\nHadoop MapReduce\u306f`map()`\u306e\u51fa\u529b\u30c7\u30fc\u30bf\u3092\u4fdd\u6301\u3057\u3066\u30bd\u30fc\u30c8\u3092\u884c\u3046\u305f\u3081\u306b\u5927\u91cf\u306e\u5faa\u74b0\u30d0\u30c3\u30d5\u30a1\u304c\u5fc5\u8981\u306b\u306a\u308b\u3002\u3057\u304b\u3057\u3001`combine()`\u306f\u8ffd\u52a0\u306e\u9818\u57df\u306f\u5fc5\u8981\u3068\u3057\u306a\u3044\u3002\nSpark\u306f`combine()`\u5b9f\u884c\u306b\u306fHashMap\u3092\u5fc5\u8981\u306b\u3057\u3001Record\u3092\u30ed\u30fc\u30ab\u30eb\u30c7\u30a3\u30b9\u30af\u306b\u51fa\u529b\u3059\u308b\u305f\u3081\u306b\u30d0\u30c3\u30d5\u30a1(buckets)\u304c\u5fc5\u8981\u3068\u306a\u308b\u3002\n\nRereduce side:\nHadoop MapReduce\u306fShuffle\u3055\u308c\u305f\u30c7\u30fc\u30bf\u3092\u4fdd\u6301\u3059\u308b\u9818\u57df\u304c\u30e1\u30e2\u30ea\u4e0a\u306b\u5fc5\u8981\u3068\u306a\u308b\u3002`combine()`\u3068`reduce()`\u306b\u3064\u3044\u3066\u306f\u65e2\u306b\u30c7\u30fc\u30bf\u304c\u30bd\u30fc\u30c8\u3001\u30b0\u30eb\u30fc\u30d7\u5316\u6e08\u307f\u306e\u305f\u3081\u3001\u8ffd\u52a0\u306e\u9818\u57df\u306f\u5fc5\u8981\u3068\u3057\u306a\u3044\u69cb\u6210\u3068\u306a\u3063\u3066\u3044\u308b\u3002\nSpark\u306b\u304a\u3044\u3066\u306fsoftBuffer\u7528\u306e\u9818\u57df\u304c\u30c7\u30fc\u30bf\u53d6\u5f97\u306e\u305f\u3081\u306b\u5fc5\u8981\u3068\u306a\u308b\u3002HashMap\u306f`combine()`\u3068`reduce()`\u306e\u7d50\u679c\u4fdd\u6301\u306e\u305f\u3081\u306b\u30e1\u30e2\u30ea\u306e\u307f\u4f7f\u7528\u3068\u3044\u3046\u8a2d\u5b9a\u304c\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u30e1\u30e2\u30ea\u4e0a\u306b\u78ba\u4fdd\u3055\u308c\u308b\u3002\u3057\u304b\u3057\u306a\u304c\u3089\u3001\u30c7\u30fc\u30bf\u306e\u4e00\u90e8\u306f\u8a2d\u5b9a\u3067\u30e1\u30e2\u30ea\u3068\u30c7\u30a3\u30b9\u30af\u306e\u4f7f\u7528\u304c\u6709\u52b9\u306b\u306a\u3063\u3066\u3044\u308b\u5834\u5408\u306f\u30c7\u30a3\u30b9\u30af\u4e0a\u306b\u3082\u4fdd\u6301\u3055\u308c\u308b\u69cb\u6210\u3068\u306a\u3063\u3066\u3044\u308b\u3002\n\n#### groupByKey(numPartitions)\n\n![ShuffleGroupByKey.png](https://qiita-image-store.s3.amazonaws.com/0/9616/1e358a0f-eaad-aa6d-9822-af10ca0dca76.png)\n\n\u5b9f\u884c\u904e\u7a0b\u306f`reduceByKey()`\u3068\u4f3c\u3066\u3044\u308b\u3002\u96c6\u8a08\u306e\u305f\u3081\u306e\u95a2\u6570\u304c`result = result ++ result.value`\u3068\u306a\u308a\u3001\u5404\u30ad\u30fc\u306b\u5bfe\u5fdc\u3059\u308b\u5024\u304c\u96c6\u8a08\u3055\u308c\u308b\u3053\u3068\u7121\u304f\u30b0\u30eb\u30fc\u30d7\u5316\u3055\u308c\u308b\u70b9\u304c\u9055\u3044\u3068\u306a\u3063\u3066\u3044\u308b\u3002\n\n#### distinct(numPartitions)\n\n![ShuffleDistinct.png](https://qiita-image-store.s3.amazonaws.com/0/9616/8aa0d6fe-dada-7a32-c166-a5243c24a451.png)\n\n\u3053\u3061\u3089\u3082\u5b9f\u884c\u904e\u7a0b\u306f`reduceByKey()`\u3068\u4f3c\u3066\u3044\u308b\u3002\u96c6\u8a08\u306e\u305f\u3081\u306e\u95a2\u6570\u304c`result = result == null ? record.value : result`\u3068\u306a\u308aKey\u306b\u5bfe\u5fdc\u3059\u308b\u5024\u304cHashMap\u4e0a\u306b\u5b58\u5728\u3059\u308b\u304b\u3092\u30c1\u30a7\u30c3\u30af\u3059\u308b\u305f\u3081\u3060\u3051\u306e\u51e6\u7406\u3068\u306a\u3063\u3066\u3044\u308b\u3002\u3082\u3068\u3082\u3068Key\u306b\u5bfe\u5fdc\u3059\u308b\u5024\u304c\u5b58\u5728\u3059\u308b\u5834\u5408\u3001Record\u306f\u7834\u68c4\u3055\u308c\u3001\u5b58\u5728\u3057\u306a\u3044\u5834\u5408\u306fHashMap\u4e0a\u306b\u4fdd\u6301\u3055\u308c\u308b\u3002`reduceByKey()`\u3068\u540c\u69d8\u306b\u3001MapSideCombine\u3082\u9069\u7528\u3055\u308c\u3066\u3044\u308b\u3002\n\n#### cogroup(otherRDD, numPartitions)\n\n![ShuffleCoGroup.png](https://qiita-image-store.s3.amazonaws.com/0/9616/2057c3f5-0daa-e9de-2fab-2470f0ed2ff5.png)\n\ncogroup\u3092\u5b9f\u884c\u3059\u308b\u306b\u3042\u305f\u308a\u30010\u500b\u30011\u500b\u3001\u307e\u305f\u306f\u305d\u308c\u4ee5\u4e0a\u306eShuffleDependency\u306b\u3088\u308b\u95a2\u9023\u304c\u5b58\u5728\u3057\u3048\u308b\u3002\u3057\u304b\u3057\u3001Shuffle\u30d7\u30ed\u30bb\u30b9\u306b\u304a\u3044\u3066\u5404ShuffleDependency\u306b\u5bfe\u3057\u3066HashMap\u3092\u751f\u6210\u3059\u308b\u3053\u3068\u306f\u305b\u305a\u30011\u500b\u306eHashMap\u3092\u3059\u3079\u3066\u306eShuffle\u5b9f\u884c\u306b\u7528\u3044\u308b\u3002`reduceByKey()`\u3068\u306e\u9055\u3044\u3068\u3057\u3066\u306f\u3001HashMap\u306fmapPartitionsWithContext\u3067\u306a\u304f\u3001RDD\u306e`compute()`\u5b9f\u884c\u306e\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u751f\u6210\u3055\u308c\u308b\u70b9\u304c\u3042\u308b\u3002\n\nRDD\u306b\u5bfe\u3059\u308bTask\u5b9f\u884c\u6642\u306b`Array[ArrayBuffer]`\u3092\u751f\u6210\u3059\u308b\u3002\u3053\u306e`Array[ArrayBuffer]`\u306f\u5165\u529bRDD\u3068\u540c\u3058\u6570\u306e\u7a7aArrayBuffer\u3092\u4fdd\u6301\u3059\u308b\u3002\u305d\u306e\u305f\u3081\u3001\u56f3\u793a\u3055\u308c\u305f\u4f8b\u306b\u304a\u3044\u3066\u306fRDD a\u3001RDD b\u4e8c\u5bfe\u5fdc\u3057\u305f2\u500b\u306eArrayBuffer\u304c\u5404Task\u306b\u5bfe\u3057\u3066\u751f\u6210\u3055\u308c\u308b\u3002RDD a\u304b\u3089\u306eKey-Value\u306e\u30da\u30a2\u304c1\u500b\u76ee\u306eArrayBuffer\u306b\u8ffd\u52a0\u3055\u308c\u3001RDD b\u304b\u3089\u306eKey-Value\u306e\u30da\u30a2\u304c2\u500b\u76ee\u306eArrayBuffer\u306b\u8ffd\u52a0\u3055\u308c\u308b\u3002\u6700\u7d42\u7684\u306b`mapValues()`\u30aa\u30da\u30ec\u30fc\u30b7\u30e7\u30f3\u306b\u304a\u3044\u3066`Array[ArrayBuffer]`\u304c`(ArrayBuffer, ArrayBuffer) => (Iterable[V], Iterable[W])`\u306e\u5909\u63db\u3067\u6700\u7d42\u7684\u306a\u578b\u306b\u5909\u63db\u3055\u308c\u308b\u3002\n\n#### intersection(otherRDD) and join(otherRDD, numPartitions)\n\n![ShuffleIntersection.png](https://qiita-image-store.s3.amazonaws.com/0/9616/bcd76272-2f69-4def-29ed-66342b8dc53e.png)\n\n![ShuffleJoin.png](https://qiita-image-store.s3.amazonaws.com/0/9616/6ba76cd8-a404-fb89-6d21-99d49ed56edc.png)\n\n\u3053\u306e2\u500b\u306e\u30aa\u30da\u30ec\u30fc\u30b7\u30e7\u30f3\u306f\u5185\u90e8\u7684\u306bcogroup\u3092\u4f7f\u7528\u3057\u3066\u304a\u308a\u3001\u5185\u90e8\u306eShuffle\u30d7\u30ed\u30bb\u30b9\u306fcogroup\u3068\u540c\u4e00\u306e\u69cb\u6210\u3068\u306a\u3063\u3066\u3044\u308b\u3002\n\n#### sortByKey(ascending, numPartition)\n\n![ShuffleSortByKey.png](https://qiita-image-store.s3.amazonaws.com/0/9616/b94fbf5d-6f5e-e566-ac14-c74739f8066d.png)\n\n`sortByKey()`\u306e\u51e6\u7406\u30d7\u30ed\u30bb\u30b9\u306f`reduceByKey()`\u3068\u82e5\u5e72\u7570\u306a\u308a\u3001\u53d6\u5f97\u3057\u305f\u5165\u529bRecord\u3092\u6271\u3046\u305f\u3081\u306bHashMap\u3092\u4f7f\u7528\u3057\u306a\u3044\u3002\u4ee3\u308f\u308a\u306b\u3001Key-Value\u306e\u5024\u3092Range\u30d9\u30fc\u30b9\u3067\u5206\u5272\u3059\u308b\u3002\u540c\u4e00Partition\u4e2d\u306e\u5024\u306fKey\u3067\u30bd\u30fc\u30c8\u3055\u308c\u305f\u72b6\u614b\u3067\u51fa\u529b\u3055\u308c\u308b\u3002\n\n#### coalesce(numPartitions, shuffle = true)\n\n![ShuffleCoalesce.png](https://qiita-image-store.s3.amazonaws.com/0/9616/c09d8512-65e4-d731-202d-fcc4d9b90e4c.png)\n\n`coalesce()`\u306fShuffleDependency\u3092\u751f\u6210\u3059\u308b\u304c\u3001\u5b9f\u969b\u306f\u53d6\u5f97\u3057\u305f\u30c7\u30fc\u30bf\u306e\u96c6\u8a08\u306f\u5fc5\u8981\u306a\u3044\u305f\u3081\u3001HashMap\u306e\u4f7f\u7528\u3082\u3055\u308c\u306a\u3044\u3002\n\n### HashMap in Shuffle Read\n\n\u3053\u3053\u307e\u3067\u3067\u3067\u8ff0\u3079\u3089\u308c\u3066\u304d\u305f\u3088\u3046\u306b\u3001HashMap\u306fSpark\u306eShuffle\u30d7\u30ed\u30bb\u30b9\u306b\u304a\u3044\u3066\u3057\u3070\u3057\u3070\u4f7f\u7528\u3055\u308c\u308b\u30c7\u30fc\u30bf\u69cb\u9020\u3068\u306a\u3063\u3066\u3044\u308b\u3002Spark\u306f2\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u7279\u5225\u306aHashMap\u3092\u4fdd\u6301\u3057\u3066\u304a\u308a\u3001\u30e1\u30e2\u30ea\u4e0a\u306b\u306e\u307f\u30c7\u30fc\u30bf\u3092\u4fdd\u6301\u3059\u308b\u5834\u5408\u306fAppendOnlyMap\u304c\u3001\u30e1\u30e2\u30ea\u3068\u30c7\u30a3\u30b9\u30af\u306e\u4e21\u65b9\u3092\u7528\u3044\u3066\u30c7\u30fc\u30bf\u3092\u4fdd\u6301\u3059\u308b\u5834\u5408\u306fExternalAppendOnlyMap\u304c\u4f7f\u7528\u3055\u308c\u308b\u3002\n\u4ee5\u5f8c\u3067\u306f\u3053\u306e2\u500b\u306eHashMap\u5b9f\u88c5\u306b\u3064\u3044\u3066\u8a73\u7d30\u3092\u8ff0\u3079\u308b\u3002\n\n#### AppendOnlyMap\n\nSpark\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u304a\u3044\u3066\u3001AppendOnlyMap\u306f\u300c\u30b7\u30f3\u30d7\u30eb\u306aHashTable\u3067\u3001\u8ffd\u52a0\u5c02\u7528\u306e\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\u306b\u6700\u9069\u5316\u3055\u308c\u3066\u3044\u308b\u3002\u30ad\u30fc\u306f\u8ffd\u52a0\u3055\u308c\u305f\u5f8c\u306f\u524a\u9664\u3055\u308c\u305a\u3001\u5404\u30ad\u30fc\u306b\u5bfe\u5fdc\u3059\u308b\u5024\u306f\u66f4\u65b0\u3055\u308c\u308b\u3053\u3068\u3092\u60f3\u5b9a\u3057\u3066\u6700\u9069\u5316\u3055\u308c\u3066\u3044\u308b\u3002\u300d\u3068\u8a18\u8ff0\u3055\u308c\u3066\u3044\u308b\u3002\u5b9f\u88c5\u65b9\u5f0f\u306f\u30b7\u30f3\u30d7\u30eb\u3067\u3001\u4e0b\u56f3\u306e\u3088\u3046\u306b\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306e\u5de8\u5927\u306a\u914d\u5217\u3092\u78ba\u4fdd\u3057\u3001Key\u304c\u9752\u3044\u9818\u57df\u306b\u4fdd\u6301\u3055\u308c\u3001Value\u304c\u767d\u3044\u9818\u57df\u306b\u4fdd\u6301\u3055\u308c\u308b\u3002\n\n![appendonlymap.png](https://qiita-image-store.s3.amazonaws.com/0/9616/f8554d17-6189-eb68-2273-9ad7897d7fa0.png)\n\n`put(K, V)`\u304c\u5b9f\u884c\u3055\u308c\u305f\u5834\u5408\u3001hash(K)\u306e\u5024\u3092\u7528\u3044\u3066\u914d\u5217\u306e\u4e2d\u306e\u30b9\u30ed\u30c3\u30c8\u3092\u5272\u308a\u5f53\u3066\u308b\u3002\u65e2\u306b\u8a72\u5f53\u306e\u5834\u6240\u304c\u4f7f\u7528\u3055\u308c\u3066\u3044\u305f\u5834\u5408\u3001\u4e8c\u6b21\u30d7\u30ed\u30fc\u30d3\u30f3\u30b0\u6280\u8853\u3092\u7528\u3044\u3066\u6b21\u306e\u30b9\u30ed\u30c3\u30c8\u3092\u898b\u3064\u3051\u308b\u3002\u56f3\u4e2d\u306b\u66f8\u304b\u308c\u305f\u8ffd\u52a0\u51e6\u7406\u3092\u4f8b\u3068\u3059\u308c\u3070\u3001Key=K6\u3001Value=V6\u306e\u5024\u3092\u8ffd\u52a0\u3059\u308b\u5834\u5408\u30013\u756a\u76ee\u306e\u30d7\u30ed\u30fc\u30d3\u30f3\u30b0\u3067\u7a7a\u304d\u30b9\u30ed\u30c3\u30c8(K4\u306e\u6b21\u306e\u30b9\u30ed\u30c3\u30c8)\u3092\u767a\u898b\u3057\u3001\u305d\u3053\u306bV6(K6\u306e\u6b21\u306e\u30b9\u30ed\u30c3\u30c8)\u3068\u5171\u306b\u4fdd\u5b58\u3059\u308b\u3002`get(K6)`\u5b9f\u884c\u6642\u3001\u540c\u69d8\u306e\u30d5\u30ed\u30fc\u3067\u5024\u3092\u4fdd\u6301\u3059\u308b\u30b9\u30ed\u30c3\u30c8\u3092\u767a\u898b\u3059\u308b\u3002Key\u306b\u5bfe\u5fdc\u3057\u305f\u65b0\u305f\u306a\u5024\u3092\u4fdd\u5b58\u3059\u308b\u5834\u5408\u3001V6\u3092K6\u306e\u6b21\u306e\u30b9\u30ed\u30c3\u30c8\u304b\u3089\u53d6\u5f97\u3057\u3001\u65b0\u305f\u306a\u5024\u3092\u7b97\u51fa\u3057\u305f\u4e0a\u3067\u7b97\u51fa\u7d50\u679c\u3092V6\u304c\u4fdd\u5b58\u3055\u308c\u3066\u3044\u305f\u30b9\u30ed\u30c3\u30c8\u306b\u4fdd\u5b58\u3059\u308b\u3002\n\nAppendOnlyMap\u3092Iterator\u3067\u8d70\u67fb\u3059\u308b\u5834\u5408\u3001\u5358\u306b\u914d\u5217\u3092\u30b9\u30ad\u30e3\u30f3\u3059\u308b\u3060\u3051\u3067\u3059\u3080\u3002\n\n\u3082\u3057\u5272\u308a\u632f\u3089\u308c\u305f\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u914d\u5217\u9818\u57df\u304c70%\u4f7f\u7528\u3055\u308c\u305f\u5834\u5408\u3001\u500d\u306e\u30b5\u30a4\u30ba\u306e\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u914d\u5217\u3092\u4f5c\u6210\u3057\u3001\u305d\u3053\u306b\u5143\u3005\u306e\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u914d\u5217\u4e2d\u306e\u5024\u3092\u518d\u69cb\u7bc9\u3057\u306a\u304c\u3089\u4fdd\u5b58\u3059\u308b\u3002\n\nAppendOnlyMap\u306b\u304a\u3044\u3066\u306f`destructiveSortedIterator()`\u3068\u3044\u3046Iterator[(K, V)]\u3092\u8fd4\u3059\u30e1\u30bd\u30c3\u30c9\u304c\u5b58\u5728\u3059\u308b\u3002\u3053\u306e\u30e1\u30bd\u30c3\u30c9\u306f\u30bd\u30fc\u30c8\u3055\u308c\u305f\u72b6\u614b\u306eKey-Value\u30da\u30a2\u3092\u8fd4\u3059\u3002\u5b9f\u88c5\u65b9\u5f0f\u306f\u307e\u305a\u306f\u3058\u3081\u306b\u5168\u3066\u306eKey-Value\u30da\u30a2\u3092\u5404Key-Value\u30da\u30a2\u304c1\u30b9\u30ed\u30c3\u30c8\u306b\u4fdd\u6301\u3055\u308c\u305f\u914d\u5217\u3092\u4f5c\u6210\u3057\u3001`Array.sort()`\u30e1\u30bd\u30c3\u30c9\u3067\u8981\u7d20\u3092\u6574\u5217\u3057\u305f\u4e0a\u3067\u7528\u3044\u3066\u3044\u308b\u3002\u30e1\u30bd\u30c3\u30c9\u540d\u304c\u793a\u3057\u3066\u3044\u308b\u3088\u3046\u306b\u3001\u500b\u306e\u30e1\u30bd\u30c3\u30c9\u306f\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u914d\u5217\u306e\u69cb\u9020\u3092\u58ca\u3059\u653b\u52e2\u3068\u306a\u3063\u3066\u3044\u308b\u3002\n\n#### ExternalAppendOnlyMap\n\n![ExternalAppendOnlyMap.png](https://qiita-image-store.s3.amazonaws.com/0/9616/fbf78d0d-ece5-f80b-a19b-0f023d5c0611.png)\n\nAppendOnlyMap\u3068\u6bd4\u3079\u3066\u3001ExternalAppendOnlyMap\u306f\u3088\u308a\u8907\u96d1\u306a\u69cb\u6210\u3068\u306a\u3063\u3066\u3044\u308b\u3002\u5b9f\u88c5\u30b3\u30f3\u30bb\u30d7\u30c8\u306fHadoop MapReduce\u306eshuffle-merge-combine-sort\u30d7\u30ed\u30bb\u30b9\u3068\u4f3c\u305f\u3082\u306e\u3068\u306a\u3063\u3066\u3044\u308b\u3002\n\nExternalAppendOnlyMap\u306fAppendOnlyMap\u3092\u4fdd\u6301\u3057\u3066\u304a\u308a\u3001\u8ffd\u52a0\u3055\u308c\u305fKey-Value\u30da\u30a2\u306fAppendOnlyMap\u306b\u8ffd\u52a0\u3055\u308c\u308b\u3002AppendOnlyMap\u306e\u30b5\u30a4\u30ba\u304c\u5897\u5927\u3057\u305f\u5834\u5408\u3001\u307e\u305a\u306f\u30e1\u30e2\u30ea\u4e0a\u306b\u78ba\u4fdd\u53ef\u80fd\u306a\u9818\u57df\u304c\u3042\u308b\u304b\u78ba\u8a8d\u3092\u884c\u3046\u3002\u3082\u3057\u5341\u5206\u306a\u9818\u57df\u304c\u30e1\u30e2\u30ea\u4e0a\u306b\u5b58\u5728\u3059\u308b\u5834\u5408\u3001AppendOnlyMap\u306e\u30b5\u30a4\u30ba\u30922\u500d\u306b\u3059\u308b\u3053\u3068\u3067\u5bfe\u5fdc\u3059\u308b\u3002\u305d\u3046\u3067\u306a\u3044\u5834\u5408\u3001AppendOnlyMap\u306b\u4fdd\u6301\u3055\u308c\u308b\u5168\u3066\u306eKey-Value\u30da\u30a2\u306f\u30bd\u30fc\u30c8\u3055\u308c\u305f\u4e0a\u3067\u30c7\u30a3\u30b9\u30af\u306b\u51fa\u529b\u3055\u308c\u308b\u3002(\u305d\u306e\u969b\u3001`destructiveSortedIterator()`\u3092\u7528\u3044\u3066\u884c\u308f\u308c\u308b) \u56f3\u4e2d\u306b\u304a\u3044\u3066\u3001\u5bfe\u8c61Map\u306e4\u56de\u306e\u30d5\u30a1\u30a4\u30eb\u51fa\u529b\u304c\u884c\u308f\u308c\u3066\u3044\u308b\u3002\u5404\u30c7\u30a3\u30b9\u30af\u51fa\u529b\u306b\u304a\u3044\u3066\u3001spillMap file\u304c\u751f\u6210\u3055\u308c\u3001\u7a7a\u306eAppendOnlyMap\u304c\u305d\u306e\u5f8c\u8ffd\u52a0\u3055\u308c\u308bKey-Value\u30da\u30a2\u306b\u5bfe\u5fdc\u3059\u308b\u305f\u3081\u306b\u521d\u671f\u5316\u3055\u308c\u308b\u3002ExternalAppendOnlyMap\u306b\u304a\u3044\u3066\u3001Key-Value\u30da\u30a2\u304c\u8ffd\u52a0\u3055\u308c\u305f\u5834\u5408\u3001\u30e1\u30e2\u30ea\u4e0a\u306b\u4fdd\u6301\u3055\u308c\u305fAppendOnlyMap\u306e\u307f\u3092\u7528\u3044\u3066\u96c6\u8a08\u304c\u884c\u308f\u308c\u308b\u3002\u305d\u306e\u305f\u3081\u3001\u6700\u7d42\u7684\u306a\u7d50\u679c\u7b97\u51fa\u30d5\u30a7\u30fc\u30ba\u306b\u304a\u3044\u3066\u3001\u30c7\u30a3\u30b9\u30af\u306b\u51fa\u529b\u3055\u308c\u305fMap\u3068\u30e1\u30e2\u30ea\u4e0a\u306b\u5b58\u5728\u3059\u308bAppendOnlyMap\u3092\u30de\u30fc\u30b8\u3059\u308bglobal merge-aggregate\u51e6\u7406\u3092\u5b9f\u884c\u3059\u308b\u5fc5\u8981\u304c\u51fa\u3066\u304f\u308b\u3002\n\nGlobal merge-aggregate\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u3066\u5b9f\u884c\u3055\u308c\u308b\u3002 \n\u307e\u305a\u306f\u3058\u3081\u306b\u3001\u30e1\u30e2\u30ea\u4e0a\u306b\u4fdd\u6301\u3055\u308c\u305fAppendOnlyMap\u3092\u30bd\u30fc\u30c8\u3057\u3001sortedMap\u3092\u751f\u6210\u3059\u308b\u3002\u305d\u306e\u5f8c\u3001DestructiveSortedIterator (sortedMap\u7528)\u304b\u3001\u307e\u305f\u306fDiskMapIterator (\u30c7\u30a3\u30b9\u30af\u4e0a\u306b\u51fa\u529b\u3055\u308c\u305fDisk Spill Map\u7528for on disk spillMap)\u304cKey-Value\u30da\u30a2\u306e\u4e00\u90e8\u5206\u3092StreamBuffer\u306b\u8aad\u307f\u8fbc\u3080\u305f\u3081\u306b\u5b9f\u884c\u3055\u308c\u308b\u3002StreamBuffer\u306fmergeHeap\u306b\u8ffd\u52a0\u3055\u308c\u3001\u5404StreamBuffer\u306b\u4fdd\u6301\u3055\u308c\u308bKey-Value\u30da\u30a2\u306f\u5168\u3066Key\u306b\u5bfe\u3059\u308b\u30cf\u30c3\u30b7\u30e5\u5024(`hash(key)`)\u304c\u540c\u4e00\u306e\u5024\u3068\u306a\u3063\u3066\u3044\u308b\u3002\u56f3\u306e\u69cb\u6210\u3092\u4f8b\u306b\u6319\u3052\u308b\u3068\u3059\u308b\u3068\u3001`hash(K1) == hash(K2) == hash(K3) < hash(K4) < hash(K5)`\u304c\u6e80\u305f\u3055\u308c\u3066\u3044\u308b\u3002\n\n\u7d50\u679c\u3068\u3057\u3066\u3001\u306f\u3058\u3081\u306b\u51fa\u529b\u3055\u308c\u305f1st spill\u306e\u306f\u3058\u3081\u306e3Record\u306f\u540c\u3058StreamBuffer\u306b\u8aad\u307f\u8fbc\u307e\u308c\u308b\u3002\u30de\u30fc\u30b8\u306e\u30d7\u30ed\u30bb\u30b9\u306f\u30b7\u30f3\u30d7\u30eb\u3067\u3001\u540c\u4e00Hash\u5024\u3092\u6301\u3064\u30ad\u30fc\u3092\u4fdd\u6301\u3059\u308bStreamBuffer\u3092\u30d2\u30fc\u30d7\u4e0a\u306b\u78ba\u4fdd\u3057\u3001\u305d\u308c\u3089\u306e\u5024\u3092\u30de\u30fc\u30b8\u3059\u308b\u305f\u3081\u306bArrayBuffer\uff3bStreamBuffer\uff3d(mergedBuffers)\u306b\u8ffd\u52a0\u3059\u308b\u3002\u306f\u3058\u3081\u306b\u8ffd\u52a0\u3055\u308c\u305fStreamBuffer\u3092minBuffer\u3068\u547c\u3073\u3001minBuffer\u306b\u4fdd\u6301\u3055\u308c\u3066\u3044\u308b\u306f\u3058\u3081\u306eKey-Value\u30da\u30a2\u306eKey\u5024\u3092minKey\u3068\u547c\u3076\u3002\u3042\u308b\u30de\u30fc\u30b8\u51e6\u7406\u306fmergedBuffer\u4e2d\u306b\u4fdd\u6301\u3055\u308c\u305fminKey\u3092Key\u3068\u3057\u3066\u4fdd\u6301\u3059\u308bKey-Value\u30da\u30a2\u3092\u96c6\u8a08\u3057\u3001\u7d50\u679c\u3068\u3057\u3066\u51fa\u529b\u3059\u308b\u3053\u3068\u3092\u884c\u3046\u3002mergedBuffer\u4e2d\u306e\u30de\u30fc\u30b8\u51e6\u7406\u304c\u5b8c\u4e86\u3057\u305f\u6642\u306b\u6b8b\u3063\u3066\u3044\u308bKey-Value\u30da\u30a2\u3092mergeHeap\u306b\u8fd4\u3057\u3001\u7a7a\u306b\u306a\u3063\u305fStreamBuffer\u3092\u30e1\u30e2\u30ea\u3001\u307e\u305f\u306f\u30c7\u30a3\u30b9\u30af\u51fa\u529b\u3055\u308c\u305fMap\u304b\u3089\n\n\u3053\u3053\u3067\u30013\u3064\u307e\u3060\u8ff0\u3079\u3089\u308c\u3066\u3044\u306a\u3044\u70b9\u304c\u3042\u308b\u3002\n- \u30e1\u30e2\u30ea\u5229\u7528\u53ef\u80fd\u30c1\u30a7\u30c3\u30af\uff1aHadoop MapReduce\u306fReducer\u306e\u30e1\u30e2\u30ea\u9818\u57df\u306e70%\u3092Shuffle-Sort\u7528\u306b\u5272\u308a\u632f\u3063\u3066\u3044\u308b\u3002\u540c\u3058\u3088\u3046\u306b\u3001Spark\u306f\u8a2d\u5b9a**spark.shuffle.memoryFraction** *  **spark.shuffle.safetyFraction** (\u30c7\u30d5\u30a9\u30eb\u30c8\u306f0.3 * 0.8)\u3092ExternalAppendOnlyMap\u7528\u306b\u5272\u308a\u632f\u3063\u3066\u3044\u308b\u3002\u3053\u306e\u5024\u3092\u898b\u308b\u306b\u3001Spark\u306f\u3088\u308a\u4fdd\u5b88\u7684\u3068\u601d\u308f\u308c\u308b\u3002\u307e\u305f\u3001\u3053\u306e24%\u306e\u30e1\u30e2\u30ea\u9818\u57df\u306f\u540c\u4e00Executor\u3067\u5b9f\u884c\u3055\u308c\u308b\u5168\u3066\u306eReducer\u3067\u5171\u6709\u3055\u308c\u3066\u3044\u308b\u3002Executor\u306fShuffleMemoryMap: HashMap[threadId, occupiedMemory]\u3092\u4fdd\u6301\u3057\u3066\u304a\u308a\u3001\u4fdd\u6301\u3057\u3066\u3044\u308b\u5404Reducer\u4e2d\u306eExternalAppendOnlyMaps\u306e\u30e1\u30e2\u30ea\u4f7f\u7528\u91cf\u3092\u76e3\u8996\u3057\u3066\u3044\u308b\u3002AppendOnlyMap\u306e\u30b5\u30a4\u30ba\u3092\u5897\u5927\u3055\u305b\u308b\u524d\u306b\u3001\u5897\u5927\u5f8c\u306e\u7dcf\u30e1\u30e2\u30ea\u4f7f\u7528\u91cf\u3092ShuffleMemoryMap\u306e\u60c5\u5831\u3092\u57fa\u306b\u7b97\u51fa\u3057\u3001\u5341\u5206\u306a\u9818\u57df\u304c\u78ba\u4fdd\u53ef\u80fd\u304b\u3069\u3046\u304b\u306e\u78ba\u8a8d\u3092\u884c\u3063\u3066\u3044\u308b\u3002\u305f\u3060\u3057\u3001\u306f\u3058\u3081\u306e1000Record\u3092\u4fdd\u6301\u3059\u308b\u9593\u306b\u306f\u30c7\u30a3\u30b9\u30af\u51fa\u529b\u30c1\u30a7\u30c3\u30af\u304c\u884c\u308f\u308c\u306a\u3044\u3053\u3068\u306b\u7559\u610f\u3059\u308b\u3053\u3068\u3002\n- AppendOnlyMap\u306e\u30b5\u30a4\u30ba\u7b97\u51fa\uff1aAppendOnlyMap\u306e\u30b5\u30a4\u30ba\u306fAppendOnlyMap\u306e\u30b5\u30a4\u30ba\u3092\u5897\u5927\u3055\u305b\u308b\u969b\u306bAppendOnlyMap\u304b\u3089\u53c2\u7167\u3055\u308c\u3066\u3044\u308b\u5168\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306e\u30e1\u30e2\u30ea\u91cf\u3092\u8a08\u7b97\u3059\u308b\u3053\u3068\u3067\u53ef\u80fd\u3068\u306a\u308b\u3002\u3057\u304b\u3057\u3001\u305d\u308c\u306f\u8a08\u7b97\u6642\u9593\u304c\u304b\u304b\u308a\u3059\u304e\u308b\u3002Spark\u306f\u8a08\u7b97\u91cfO(1)\u3067\u5b9f\u884c\u53ef\u80fd\u306a\u30b5\u30a4\u30ba\u7b97\u51fa\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3092\u4fdd\u6301\u3057\u3066\u3044\u308b\u3002\u3053\u306e\u65b9\u5f0f\u306e\u30b3\u30f3\u30bb\u30d7\u30c8\u306fAppendOnlyMap\u306b\u5bfe\u3057\u3066\u30c7\u30fc\u30bf\u306e\u8ffd\u52a0\u3084\u4fdd\u6301\u30c7\u30fc\u30bf\u306e\u96c6\u8a08\u3092\u884c\u3046\u969b\u306bMap\u30b5\u30a4\u30ba\u306e\u5909\u52d5\u3092Record\u306e\u30c7\u30fc\u30bf\u69cb\u9020\u30b5\u30a4\u30ba\u3092\u7b97\u51fa\u3059\u308b\u3053\u3068\u3067\u884c\u3046\u3068\u3044\u3046\u3082\u306e\u3002\u8a73\u7d30\u306fSizeTrackingAppendOnlyMap\u3084SizeEstimator\u306b\u3066\u78ba\u8a8d\u53ef\u80fd\u3002\n- \u30c7\u30a3\u30b9\u30af\u51fa\u529b\u30d7\u30ed\u30bb\u30b9\uff1aShuffle Write\u30d7\u30ed\u30bb\u30b9\u306e\u3088\u3046\u306b\u3001Spark\u306fRecord\u3092\u30c7\u30a3\u30b9\u30af\u51fa\u529b\u3059\u308b\u969b\u306b\u306fBuffer\u306e\u751f\u6210\u3092\u884c\u3046\u3002Buffer\u306e\u30b5\u30a4\u30ba\u306f\u8a2d\u5b9a**spark.shuffle.file.buffer.kb**\u3067\u8a2d\u5b9a\u53ef\u80fd\u3067\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u306f32KB\u3068\u306a\u3063\u3066\u3044\u308b\u3002\u30b7\u30ea\u30a2\u30e9\u30a4\u30b6\u3082\u540c\u69d8\u306b\u30c7\u30a3\u30b9\u30af\u51fa\u529b\u306e\u305f\u3081\u306b\u30d0\u30c3\u30d5\u30a1\u3092\u5272\u308a\u632f\u3063\u3066\u3044\u308b\u304c\u3001\u5927\u91cf\u306eRecord\u3092\u540c\u6642\u306b\u30c7\u30a3\u30b9\u30af\u51fa\u529b\u3057\u3088\u3046\u3068\u3057\u305f\u969b\u306b\u554f\u984c\u304c\u767a\u751f\u3057\u3048\u308b\u3002\u305d\u306e\u305f\u3081\u3001Spark\u3067\u306f\u540c\u6642\u306b\u30c7\u30a3\u30b9\u30af\u51fa\u529b\u53ef\u80fd\u306aRecord\u6570\u3092\u8a2d\u5b9a*spark.shuffle.spill.batchSize*\u3067\u5236\u9650\u3057\u3066\u3044\u308b\u3002\u30c7\u30d5\u30a9\u30eb\u30c8\u5024\u306f10000\u3068\u306a\u3063\u3066\u3044\u308b\u3002\n\n### \u307e\u3068\u3081\n\n\u672c\u7ae0\u306e\u3053\u3053\u307e\u3067\u3067\u3001Spark\u304cHadoop MapReduce\u306e\u56fa\u5b9a\u3055\u308c\u305fshuffle-combine-merge-reduce\u30e2\u30c7\u30eb\u3068\u6bd4\u3079\u3066\u3088\u308a\u67d4\u8edf\u306aShuffle\u30d7\u30ed\u30bb\u30b9\u3092\u6301\u3063\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u3063\u305f\u306f\u305a\u3002\u3053\u306eShuffle\u30d7\u30ed\u30bb\u30b9\u306b\u3088\u308a\u3001Spark\u306f\u5b9f\u969b\u306e\u30c7\u30fc\u30bf\u5909\u63db\u306e\u610f\u5473\u306b\u57fa\u3065\u3044\u3066\u7570\u306a\u308b\u30c7\u30fc\u30bf\u69cb\u9020\u3068\u7570\u306a\u308bShuffle\u6226\u7565\u3092\u7d44\u307f\u5408\u308f\u305b\u308b\u3053\u3068\u304c\u53ef\u80fd\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\n\u3053\u3053\u307e\u3067\u3067\u3001Spark\u306eShuffle\u30d7\u30ed\u30bb\u30b9\u306eSort\u3092\u884c\u308f\u306a\u3044\u30b1\u30fc\u30b9\u3092\u57fa\u306b\u3069\u306e\u3088\u3046\u306b\u5b9f\u969b\u306eRDD\u306e\u9023\u9396\u306e\u4e2d\u306b\u7d44\u307f\u8fbc\u307e\u308c\u308b\u304b\u3092\u8a18\u8ff0\u3057\u305f\u3002\u4f75\u305b\u3066\u3001\u30e1\u30e2\u30ea\u3084\u30c7\u30a3\u30b9\u30af\u306e\u4f7f\u7528\u65b9\u5f0f\u306b\u3064\u3044\u3066Hadoop MapReduce\u3068\u6bd4\u8f03\u3057\u306a\u304c\u3089\u8a18\u8ff0\u3057\u305f\u3002\u6b21\u306e\u7ae0\u3067\u306f\u30d7\u30ed\u30bb\u30b9\u9593\u901a\u4fe1\u306e\u8996\u70b9\u304b\u3089\u3001\u3069\u306e\u3088\u3046\u306b\u30b8\u30e7\u30d6\u304c\u5b9f\u884c\u3055\u308c\u308b\u304b\u3092\u8a18\u8ff0\u3059\u308b\u3002\u305d\u306e\u4e2d\u3067\u3001Shuffle\u6642\u306e\u30c7\u30fc\u30bf\u4fdd\u5b58\u5148\u306e\u554f\u984c\u306b\u3064\u3044\u3066\u3082\u89e6\u308c\u308b\u3002\n\n# \u7d42\u308f\u308a\u306b\n\u3053\u306e\u7ae0\u3067Shuffle\u3092\u3069\u306e\u3088\u3046\u306b\u5b9f\u73fe\u3059\u308b\u304b\u304c\u89e6\u308c\u3089\u308c\u307e\u3057\u305f\u304c\u3001\u524d\u306eStage\u304c\u5168\u3066\u5b8c\u4e86\u3057\u306a\u3044\u3068\u6b21\u306eStage\u304c\u958b\u59cb\u3067\u304d\u305a\u3001\u30aa\u30fc\u30d0\u30fc\u30e9\u30c3\u30d7\u3057\u305f\u5b9f\u884c\u304c\u3067\u304d\u306a\u3044\u306a\u3069\u306e\u6027\u80fd\u7684\u306b\u554f\u984c\u304c\u767a\u751f\u3057\u305d\u3046\u306a\u8981\u7d20\u306b\u3064\u3044\u3066\u3082\u898b\u3048\u3066\u304d\u307e\u3057\u305f\u3002\n\n\u3053\u306e\u7ae0\u307e\u3067\u3067\u30c7\u30fc\u30bf\u304c\u3069\u306e\u3088\u3046\u306b\u79fb\u52d5\u3057\u3001\u51e6\u7406\u3055\u308c\u308b\u304b\u306e\u6d41\u308c\u306f\u898b\u3048\u3066\u304d\u305f\u305f\u3081\u3001\u5f8c\u306f\u305d\u306e\u6d41\u308c\u3092\u3069\u306e\u3088\u3046\u306b\u5b9f\u73fe\u3057\u3066\u3044\u308b\u304b\u3001\u304c\u4ee5\u5f8c\u306e\u7ae0\u3067\u8a9e\u3089\u308c\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\n\n", "tags": ["Spark"]}