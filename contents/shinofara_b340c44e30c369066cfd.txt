{"context": " More than 1 year has passed since last update.\n\n\u4eca\u56de\u4f55\u6545\u3001Elastic MapReduce + S3 + Fluentd + nginx\u3092\u8abf\u67fb\u3057\u305f\u306e\u304b\nMysql\u3068\u304b\u3001analytics\u3068\u304b\u3001\u305d\u306e\u307b\u304b\u3067\u8272\u3005\u30c7\u30fc\u30bf\u306f\u53d6\u3063\u3066\u3044\u3063\u3066\u308b\u306e\u3067\u3059\u304c\u3001\n\u66f4\u306b\u7d30\u304b\u304f\u89e3\u6790\u3059\u308b\u305f\u3081\u306b\u306f\u3001\u30ed\u30b0\u30ec\u30d9\u30eb\u3067\u306e\u89e3\u6790\u3082\u5fc5\u8981\u306b\u306a\u3063\u3066\u304f\u308b\u3068\u601d\u3044\u8abf\u67fb\u3057\u59cb\u3081\u305f\u306e\u304c\u304d\u3063\u304b\u3051\u3067\u3059\u3002\n\u8abf\u3079\u3066\u307f\u308b\u3068\u3001Redshift\u3001Big Query\u3001TreasureData\u306a\u3069\u8272\u3005\u3042\u308b\u3093\u3067\u3059\u306d\u3001\n\u3067\u3082\u4eca\u56de\u306f\u3001Facebook\u3067\u6d41\u308c\u3066\u304d\u305f\u8a18\u4e8b\u306b\u76ee\u304c\u3068\u307e\u3063\u305f\u306e\u3067\u3001\u307e\u305a\u306f\u3068Elastic MapReduce\u306e\u8abf\u67fb\u3092\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\u69cb\u6210\u3068\u3057\u3066\u306f\u3001Elastic MapReduce + S3 + Fluentd + nginx\u3067\u3084\u3063\u3066\u307f\u307e\u3059\u3002\nNginx\u3067\u66f8\u304d\u3060\u3057\u305fltsv\u5f62\u5f0f\u306e\u30ed\u30b0\u304c\u3001fluentd\u3067S3\u306b\u8ee2\u9001\u3055\u308c\u3066\u3044\u307e\u3059\n\nAWS\u4e0a\u3067\u6e96\u5099\uff08Elastic MapReduce Job Flows\u4f5c\u6210\uff09\n\n\u65b0\u3057\u3044JOB\u3092\u4f5c\u6210\u3059\u308b\n\n\nJOB\u306e\u540d\u524d\u3068\u304b\u3001version\u3068\u304b\u3001\u30b9\u30af\u30ea\u30d7\u30c8\u9078\u629e\n\n\u4eca\u56de\u306f\u3001hive\u3092\u9078\u629e\u3057\u307e\u3059\u3002\n\nhive session\u3092\u9078\u629e\nStart an Interactive Hive Session\n\n\u30de\u30b9\u30bf\u30fcinstance\u3001core instance\u306e\u53f0\u6570\u3001\u30b0\u30ec\u30fc\u30c9\u306a\u3069\u306a\u3069\u3092\u9078\u629e\n\n\u4eca\u56de\u306f\u78ba\u8a8d\u306a\u306e\u3067\u3001small\u3067\u3001\uff11\u53f0\uff11\u53f0\u306b\u3057\u307e\u3057\u305f\u3002\n\n\u30ad\u30fc\u30da\u30a2\u3001\u30ed\u30b0\u51fa\u529b\u5148\u306a\u3069\u306a\u3069\n\nssh\u3067\u30a2\u30af\u30bb\u30b9\u3059\u308b\u969b\u306e\u30ad\u30fc\u30da\u30a2\u3068\u304b\n\u30ed\u30b0\u51fa\u529b\u5148\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\nBootstarap action\nProceed with no Bootstrap Actions\n\n\u6700\u5f8c\u306f\u78ba\u8a8d\u3057\u3066\u4f5c\u6210\n\n\u3053\u308c\u3067\u3001AWS\u5074\u3067\u306e\u6e96\u5099\u306f\u5b8c\u4e86\u3067\u3059\uff01\uff01\n\n\u3067\u306f\u3001\u5b9f\u6226\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u6e96\u5099\u3084\u3001\u4eca\u56de\u306e\u8abf\u67fb\u6642\u306e\u74b0\u5883\u306b\u3064\u3044\u3066\n\u30ed\u30b0\u3092\u683c\u7d0d\u3057\u3066\u3044\u308bS3\u3067\u3059\u304c\u3001\n<\u30d0\u30b1\u30c3\u30c8\u540d>/nginx.access/XXXXXXX/2013/09/09/\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\n\u3053\u306e\u69d8\u306b\u3001\u306a\u3063\u3066\u3044\u307e\u3059\u3002\nXXXX\u306b\u306f\u3001\u30b5\u30fc\u30d0HOST\u540d\u3001\u5e74\u3001\u6708\u3001\u65e5\u3068\u3044\u3046\u611f\u3058\u3067\u3059\u3002\n\u305d\u3057\u3066\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u306f\u3001Ltsv\u3067\u51fa\u529b\u3055\u308c\u305f\u30d5\u30a1\u30a4\u30eb\u3067\u3059\u3002\nltsv\u5f62\u5f0f\u306e\u30c7\u30fc\u30bf\u306e\u4e00\u884c\u629c\u7c8b\u3059\u308b\u3068\u3053\u3093\u306a\u611f\u3058\uff08\u30c7\u30fc\u30bf\u306e\u4e00\u90e8\u3092\u5f53\u3066\u3067\u5909\u66f4\u3057\u3066\u3044\u307e\u3059\uff09\n\n2013-09-13T00:00:03+09:00   nginx.access/XXXXXXX    {\"host\":\"999.99.99.999\",\"forwardedfor\":\"999.99.99.999, 182.161.76.45\",\"method\":\"GET\",\"path\":\"/\",\"status\":\"200\",\"size\":\"20444\",\"referer\":\"-\",\"ua\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_7_5) AppleWebKit/537.36 (KHTML, like Gecko) \n\n\n\u3068\u308a\u3042\u3048\u305a\u3001\u30ed\u30b0\u30a4\u30f3\n$ ssh -i ~/KEY hadoop@ec2-99-999-999-999.ap-northeast-1.compute.amazonaws.com\n\nEC2\u3067\u4f7f\u3044\u6163\u308c\u305f\u3001\u300cec2_user\u300d\u3067\u306f\u7121\u304f\u3001\u300chadoop\u300d\u30e6\u30fc\u30b6\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\n\nhive\u3092\u8d77\u52d5\n$ hive\nhive> \n\n\nFluentd\u3067\u56de\u53ce\u3057\u305f\u30ed\u30b0\u306e\u30c7\u30fc\u30bf\u3092\u683c\u7d0d\u3059\u308bhive\u4e0a\u306etable\u3092\u3064\u304f\u308a\u307e\u3059\u3002\nCREATE EXTERNAL TABLE IF NOT EXISTS fluentLog (dt string, tag string, json string)\nPARTITIONED BY ( PT STRING )\nROW FORMAT DELIMITED FIELDS TERMINATED BY '\\t' LINES TERMINATED BY '\\n';\nOK\n\ndt string, tag string, json string\u304c\u30dd\u30a4\u30f3\u30c8\u3067\u3059\nltsv\u3092fluentd\u3067\u56de\u53ce\u3059\u308b\u3068\n\u65e5\u4ed8<\u30bf\u30d6>\u30bf\u30b0\uff1c\u30bf\u30d6\uff1eJSON\u30c7\u30fc\u30bf\u306e\u5f62\u5f0f\u3067\u3059\u306e\u3067\u3001\u305d\u308c\u3092\u683c\u7d0d\u3059\u308b\u3088\u3046\u306b\u5b9a\u7fa9\u3057\u3066\u307e\u3059\u3002\n\n\u6b21\u306f\u30c7\u30fc\u30bf\u3092\u3054\u306b\u3087\u3054\u306b\u3087\nhive>  ALTER TABLE fluentLog ADD PARTITION ( pt='2013-09-09' ) LOCATION 's3://<\u30d0\u30b1\u30c3\u30c8\u540d>/nginx.access/XXXXXXX/2013/09/09'; \nOK\nTime taken: 5.252 seconds\n\nhive>  ALTER TABLE fluentLog ADD PARTITION ( pt='2013-09-10' ) LOCATION 's3://<\u30d0\u30b1\u30c3\u30c8\u540d>/nginx.access/XXXXXXX/2013/09/10'; \nOK\nTime taken: 5.252 seconds \n\n\u65e5\u4ed8\u5358\u4f4d\u3067partition\u4f5c\u6210\u3057\u3066\u307e\u3059\u3002\n\n\u89e3\u6790\u5f8c\u306e\u30c7\u30fc\u30bf\u683c\u7d0d\u7528table\u3092\u4f5c\u308b\uff01\n\u4eca\u56de\u306f\u3001\u7c21\u5358\u306b\u30b9\u30c6\u30fc\u30bf\u30b9\u30b3\u30fc\u30c9\u304c\u4f55\u56de\u767b\u5834\u3057\u305f\u304b\u3068\u3044\u3046\u7c21\u5358\u306a\u4e8b\u3092\u3084\u3063\u3066\u307f\u307e\u3059\u3002\nhive> CREATE EXTERNAL TABLE IF NOT EXISTS archiveLog (status int, cnt int)\nROW FORMAT DELIMITED FIELDS TERMINATED BY '\\t' LINES TERMINATED BY '\\n'\nLOCATION 's3://<\u30d0\u30b1\u30c3\u30c8\u540d>/archives/${DATE}';\nOK\nTime taken: 0.197 seconds \n\n\u305d\u306e\u70ba\u3001status(int)\u3068cnt(int\uff09\u306e\u4e8c\u3064\u3092\u7528\u610f\u3057\u307e\u3057\u305f\u3002\ns3://<\u30d0\u30b1\u30c3\u30c8\u540d>/archives/${DATE}'\u306f\u7528\u610f\u3059\u308b\u5fc5\u8981\u3042\u308a\u307e\u305b\u3093\u3001\u51e6\u7406\u5b9f\u884c\u5f8c\u306b\u4f5c\u6210\u3055\u308c\u307e\u3059\u3002\n\u89e3\u6790\u5f8c\u306e\u30c7\u30fc\u30bf\u304c\u3053\u3053\u306b\u683c\u7d0d\u3055\u308c\u308b\u3088\u3046\u3067\u3059\u3002\n\n\u3064\u3044\u306b\u51e6\u7406\u3092\u5b9f\u884c\u3059\u308b\u6642\u304c.....\nINSERT OVERWRITE TABLE  archiveLog\nSELECT\n  status, count(*) as cnt\nFROM\n  fluentLog LATERAL VIEW\n    json_tuple(fluentLog.json,  'ua', 'status') j\n      AS ua,status\nWHERE pt >='2013-09-09'\nGROUP BY status;\n\n2013-09-09\u3068\u30012013-09-10\u4ee5\u4e0b\u306e\u30d5\u30a1\u30a4\u30eb\u3059\u3079\u3066\u3092\u5bfe\u8c61\u306b\u3001status\u3068\u305d\u306e\u56de\u6570\u3092\u53d6\u5f97\n\u305d\u3057\u3066\u3001\u5148\u307b\u3069\u4f5c\u6210\u3057\u305ftable\u306b\u683c\u7d0d\u3059\u308b\u3068\u3044\u3046\u51e6\u7406\u3092\u884c\u3063\u3066\u3044\u307e\u3059\u3002\n\u898b\u305f\u611f\u3058\u3001SQL\u30e9\u30a4\u30af\u306b\u639b\u3051\u308b\u3068\u3044\u3046\u306e\u304c\u3001hive\u306e\u3044\u3044\u3068\u3053\u308d\u3067\u3059\u306d\n\u4e0a\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u305f\u3089\n\nTotal MapReduce jobs = 1\nLaunching Job 1 out of 1\nNumber of reduce tasks not specified. Estimated from input data size: 1\nIn order to change the average load for a reducer (in bytes):\n...\n\n\u3069\u3093\u3069\u3093\u6587\u5b57\u304c\u51fa\u529b\u3055\u308c\u307e\u3059\n2013-09-14 06:24:57,961 Stage-1 map = 0%,  reduce = 0%\n2013-09-14 06:25:16,420 Stage-1 map = 1%,  reduce = 0%, Cumulative CPU 10.2 sec\n2013-09-14 06:25:17,433 Stage-1 map = 1%,  reduce = 0%, Cumulative CPU 10.2 sec\n2013-09-14 06:25:18,451 Stage-1 map = 1%,  reduce = 0%, Cumulative CPU 10.2 sec\n2013-09-14 06:25:19,487 Stage-1 map = 1%,  reduce = 0%, Cumulative CPU 10.68 sec\n2013-09-14 06:25:20,514 Stage-1 map = 1%,  reduce = 0%, Cumulative CPU 10.68 sec\n2013-09-14 06:25:21,529 Stage-1 map = 1%,  reduce = 0%, Cumulative CPU 10.68 sec\n2013-09-14 06:25:22,540 Stage-1 map = 2%,  reduce = 0%, Cumulative CPU 11.08 sec\n\n\u3092map\u51e6\u7406\u304c\u5c11\u3057\u305a\u3064\u59cb\u307e\u3063\u305f\u3088\u3046\u3060\n2013-09-14 06:26:10,262 Stage-1 map = 8%,  reduce = 0%, Cumulative CPU 20.52 sec\n2013-09-14 06:26:11,273 Stage-1 map = 8%,  reduce = 2%, Cumulative CPU 21.18 sec\n2013-09-14 06:26:12,284 Stage-1 map = 8%,  reduce = 2%, Cumulative CPU 21.18 sec\n2013-09-14 06:26:13,301 Stage-1 map = 8%,  reduce = 2%, Cumulative CPU 21.18 sec\n2013-09-14 06:26:14,315 Stage-1 map = 9%,  reduce = 2%, Cumulative CPU 21.91 sec\n\nReduce\u3082\u59cb\u307e\u3063\u305f\u3088\u3046\u3060\n\u30de\u30b9\u30bf\u30fc\uff11\u53f0\u3001\u30ce\u30fc\u30c9\uff11\u53f0\u3067\u78ba\u8a8d\u3057\u3066\u3044\u308b\u306e\u3067\u901f\u5ea6\u306f\u3042\u308c\u307f\u305f\u3044\n2013-09-14 06:38:31,627 Stage-1 map = 100%,  reduce = 100%, Cumulative CPU 208.05 sec\n2013-09-14 06:38:32,636 Stage-1 map = 100%,  reduce = 100%, Cumulative CPU 208.05 sec\nMapReduce Total cumulative CPU time: 3 minutes 28 seconds 50 msec\n\n\u5c11\u306a\u3081\u306e\u30c7\u30fc\u30bf\u3067\u78ba\u8a8d\u3057\u305f\u3068\u306f\u3044\u3048\u3001\uff13\u5206\u534a\u304b\u304b\u308a\u307e\u3057\u305f\u3002\u3080\u3057\u308d\uff13\u5206\u534a\u3067\u304a\u308f\u308a\u307e\u3057\u305f\uff1f\n\n\u3069\u3093\u306a\u7d50\u679c\u304b\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3059\n\u89e3\u6790\u5f8c\u306e\u30c7\u30fc\u30bf\u306f\u3001s3://<\u30d0\u30b1\u30c3\u30c8\u540d>/archives/${DATE}'\u4ee5\u4e0b\u306b\u683c\u7d0d\u3055\u308c\u307e\u3059\u3002\n\u6050\u308b\u6050\u308b\u3072\u3089\u3044\u3066\u307f\u308b\u3068\n200     116080\n302     2148\n400     44\n404     40\n500     5\n\n\u306a\u308b\u307b\u3069\u3001\u306a\u308b\u307b\u3069\n\n\u5f8c\u59cb\u672b\nDROP TABLE fluentLog;\nDROP TABLE archiveLog;\n\n\u3044\u3089\u306a\u3044\u306e\u3067\u6d88\u3057\u307e\u3057\u305f\u3002\n\n\u7c21\u5358\u306a\u8abf\u67fb\u3092\u7d42\u3048\u3066\n\n\u601d\u3063\u305f\u4e8b\nnginx\u306e\u30ed\u30b0\u89e3\u6790\u3068\u304b\u306f\u3001ltsv\u5f62\u5f0f\u3067\u51fa\u529b\u3001Fluentd\u3067\u56de\u53ce\u3057\u3066S3\u3078\u8ee2\u9001\u3059\u308b\n\u3068\u3044\u3046\u8a2d\u5b9a\u304c\u3067\u304d\u3066\u3044\u308c\u3070\u3001\u5bb9\u6613\u306b\u89e3\u6790\u51e6\u7406\u3092\u884c\u3048\u308b\u306a\u3068\u601d\u3044\u307e\u3057\u305f\uff01\nhive\u306e\u30af\u30a8\u30ea\u3092\u52c9\u5f37\u3059\u308b\u5fc5\u8981\u306f\u3042\u308a\u307e\u3059\u304c\u3002\n\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30ed\u30b0\u306b\u95a2\u3057\u3066\u306f\u3001\u307e\u3060\u307e\u3060\u8abf\u67fb\u3067\u304d\u3066\u3044\u306a\u3044\u306e\u3067\u306a\u3093\u3068\u3082\u8a00\u3048\u307e\u305b\u3093\u306e\u3067\n\u30b3\u30ec\u306b\u95a2\u3057\u3066\u306f\u3001\u8abf\u67fb\u3057\u3066\u304b\u3089\u307e\u305f\u307e\u3068\u3081\u3066\u307f\u3088\u3046\u3002\n\u305d\u3057\u3066\u3084\u3063\u3066\u3044\u3051\u305d\u3046\u306a\u3089\u3001\u672c\u756a\u3067\u3064\u304b\u3046\n\n\u6700\u5f8c\u306b\u4e00\u8a00\n\u304a\u3082\u3057\u308d\u3044\n### \u4eca\u56de\u4f55\u6545\u3001Elastic MapReduce + S3 + Fluentd + nginx\u3092\u8abf\u67fb\u3057\u305f\u306e\u304b\n\nMysql\u3068\u304b\u3001analytics\u3068\u304b\u3001\u305d\u306e\u307b\u304b\u3067\u8272\u3005\u30c7\u30fc\u30bf\u306f\u53d6\u3063\u3066\u3044\u3063\u3066\u308b\u306e\u3067\u3059\u304c\u3001\n\u66f4\u306b\u7d30\u304b\u304f\u89e3\u6790\u3059\u308b\u305f\u3081\u306b\u306f\u3001\u30ed\u30b0\u30ec\u30d9\u30eb\u3067\u306e\u89e3\u6790\u3082\u5fc5\u8981\u306b\u306a\u3063\u3066\u304f\u308b\u3068\u601d\u3044\u8abf\u67fb\u3057\u59cb\u3081\u305f\u306e\u304c\u304d\u3063\u304b\u3051\u3067\u3059\u3002\n\u8abf\u3079\u3066\u307f\u308b\u3068\u3001Redshift\u3001Big Query\u3001TreasureData\u306a\u3069\u8272\u3005\u3042\u308b\u3093\u3067\u3059\u306d\u3001<br>\n\u3067\u3082\u4eca\u56de\u306f\u3001Facebook\u3067\u6d41\u308c\u3066\u304d\u305f\u8a18\u4e8b\u306b\u76ee\u304c\u3068\u307e\u3063\u305f\u306e\u3067\u3001\u307e\u305a\u306f\u3068<b>Elastic MapReduce</b>\u306e\u8abf\u67fb\u3092\u3057\u3066\u307f\u307e\u3057\u305f\u3002<br>\n\u69cb\u6210\u3068\u3057\u3066\u306f\u3001Elastic MapReduce + S3 + Fluentd + nginx\u3067\u3084\u3063\u3066\u307f\u307e\u3059\u3002\n\nNginx\u3067\u66f8\u304d\u3060\u3057\u305fltsv\u5f62\u5f0f\u306e\u30ed\u30b0\u304c\u3001fluentd\u3067S3\u306b\u8ee2\u9001\u3055\u308c\u3066\u3044\u307e\u3059\n\n### AWS\u4e0a\u3067\u6e96\u5099\uff08Elastic MapReduce Job Flows\u4f5c\u6210\uff09\n\n#### \u65b0\u3057\u3044JOB\u3092\u4f5c\u6210\u3059\u308b\n<p><span itemscope itemtype=\"http://schema.org/Photograph\"><img src=\"http://cdn-ak.f.st-hatena.com/images/fotolife/s/shinofara/20130914/20130914235100.png\" alt=\"f:id:shinofara:20130914235100p:plain\" title=\"f:id:shinofara:20130914235100p:plain\" class=\"hatena-fotolife\" itemprop=\"image\"></span></p>\n\n#### JOB\u306e\u540d\u524d\u3068\u304b\u3001version\u3068\u304b\u3001\u30b9\u30af\u30ea\u30d7\u30c8\u9078\u629e\n\n<p><span itemscope itemtype=\"http://schema.org/Photograph\"><img src=\"http://cdn-ak.f.st-hatena.com/images/fotolife/s/shinofara/20130914/20130914235104.png\" alt=\"f:id:shinofara:20130914235104p:plain\" title=\"f:id:shinofara:20130914235104p:plain\" class=\"hatena-fotolife\" itemprop=\"image\"></span></p>\n\n\u4eca\u56de\u306f\u3001hive\u3092\u9078\u629e\u3057\u307e\u3059\u3002\n\n#### hive session\u3092\u9078\u629e\nStart an Interactive Hive Session\n\n#### \u30de\u30b9\u30bf\u30fcinstance\u3001core instance\u306e\u53f0\u6570\u3001\u30b0\u30ec\u30fc\u30c9\u306a\u3069\u306a\u3069\u3092\u9078\u629e\n<p><span itemscope itemtype=\"http://schema.org/Photograph\"><img src=\"http://cdn-ak.f.st-hatena.com/images/fotolife/s/shinofara/20130914/20130914235106.png\" alt=\"f:id:shinofara:20130914235106p:plain\" title=\"f:id:shinofara:20130914235106p:plain\" class=\"hatena-fotolife\" itemprop=\"image\"></span></p>\n\n\u4eca\u56de\u306f\u78ba\u8a8d\u306a\u306e\u3067\u3001small\u3067\u3001\uff11\u53f0\uff11\u53f0\u306b\u3057\u307e\u3057\u305f\u3002\n\n#### \u30ad\u30fc\u30da\u30a2\u3001\u30ed\u30b0\u51fa\u529b\u5148\u306a\u3069\u306a\u3069\n\n<p><span itemscope itemtype=\"http://schema.org/Photograph\"><img src=\"http://cdn-ak.f.st-hatena.com/images/fotolife/s/shinofara/20130914/20130914235109.png\" alt=\"f:id:shinofara:20130914235109p:plain\" title=\"f:id:shinofara:20130914235109p:plain\" class=\"hatena-fotolife\" itemprop=\"image\"></span></p>\n\nssh\u3067\u30a2\u30af\u30bb\u30b9\u3059\u308b\u969b\u306e\u30ad\u30fc\u30da\u30a2\u3068\u304b\n\u30ed\u30b0\u51fa\u529b\u5148\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n#### Bootstarap action\nProceed with no Bootstrap Actions\n\n#### \u6700\u5f8c\u306f\u78ba\u8a8d\u3057\u3066\u4f5c\u6210\n\n<p><span itemscope itemtype=\"http://schema.org/Photograph\"><img src=\"http://cdn-ak.f.st-hatena.com/images/fotolife/s/shinofara/20130914/20130914235112.png\" alt=\"f:id:shinofara:20130914235112p:plain\" title=\"f:id:shinofara:20130914235112p:plain\" class=\"hatena-fotolife\" itemprop=\"image\"></span></p>\n\n\u3053\u308c\u3067\u3001AWS\u5074\u3067\u306e\u6e96\u5099\u306f\u5b8c\u4e86\u3067\u3059\uff01\uff01\n\n### \u3067\u306f\u3001\u5b9f\u6226\u3057\u3066\u307f\u307e\u3059\u3002\n\n#### \u6e96\u5099\u3084\u3001\u4eca\u56de\u306e\u8abf\u67fb\u6642\u306e\u74b0\u5883\u306b\u3064\u3044\u3066\n\n\u30ed\u30b0\u3092\u683c\u7d0d\u3057\u3066\u3044\u308bS3\u3067\u3059\u304c\u3001\n<\u30d0\u30b1\u30c3\u30c8\u540d>/nginx.access/XXXXXXX/2013/09/09/\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\n\u3053\u306e\u69d8\u306b\u3001\u306a\u3063\u3066\u3044\u307e\u3059\u3002\nXXXX\u306b\u306f\u3001\u30b5\u30fc\u30d0HOST\u540d\u3001\u5e74\u3001\u6708\u3001\u65e5\u3068\u3044\u3046\u611f\u3058\u3067\u3059\u3002\n\n\u305d\u3057\u3066\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u306f\u3001Ltsv\u3067\u51fa\u529b\u3055\u308c\u305f\u30d5\u30a1\u30a4\u30eb\u3067\u3059\u3002\nltsv\u5f62\u5f0f\u306e\u30c7\u30fc\u30bf\u306e\u4e00\u884c\u629c\u7c8b\u3059\u308b\u3068\u3053\u3093\u306a\u611f\u3058\uff08\u30c7\u30fc\u30bf\u306e\u4e00\u90e8\u3092\u5f53\u3066\u3067\u5909\u66f4\u3057\u3066\u3044\u307e\u3059\uff09\n```\n2013-09-13T00:00:03+09:00\tnginx.access/XXXXXXX\t{\"host\":\"999.99.99.999\",\"forwardedfor\":\"999.99.99.999, 182.161.76.45\",\"method\":\"GET\",\"path\":\"/\",\"status\":\"200\",\"size\":\"20444\",\"referer\":\"-\",\"ua\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_7_5) AppleWebKit/537.36 (KHTML, like Gecko) \n```\n\n#### \u3068\u308a\u3042\u3048\u305a\u3001\u30ed\u30b0\u30a4\u30f3\n```\n$ ssh -i ~/KEY hadoop@ec2-99-999-999-999.ap-northeast-1.compute.amazonaws.com\n```\nEC2\u3067\u4f7f\u3044\u6163\u308c\u305f\u3001\u300cec2_user\u300d\u3067\u306f\u7121\u304f\u3001\u300chadoop\u300d\u30e6\u30fc\u30b6\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\n\n#### hive\u3092\u8d77\u52d5\n\n```bash\n$ hive\nhive> \n```\n\n#### Fluentd\u3067\u56de\u53ce\u3057\u305f\u30ed\u30b0\u306e\u30c7\u30fc\u30bf\u3092\u683c\u7d0d\u3059\u308bhive\u4e0a\u306etable\u3092\u3064\u304f\u308a\u307e\u3059\u3002\n\n```\nCREATE EXTERNAL TABLE IF NOT EXISTS fluentLog (dt string, tag string, json string)\nPARTITIONED BY ( PT STRING )\nROW FORMAT DELIMITED FIELDS TERMINATED BY '\\t' LINES TERMINATED BY '\\n';\nOK\n```\n<span style=\"color: #f13135\">dt string, tag string, json string</span>\u304c\u30dd\u30a4\u30f3\u30c8\u3067\u3059<br>\nltsv\u3092fluentd\u3067\u56de\u53ce\u3059\u308b\u3068<br>\n\u65e5\u4ed8<\u30bf\u30d6>\u30bf\u30b0\uff1c\u30bf\u30d6\uff1eJSON\u30c7\u30fc\u30bf\u306e\u5f62\u5f0f\u3067\u3059\u306e\u3067\u3001\u305d\u308c\u3092\u683c\u7d0d\u3059\u308b\u3088\u3046\u306b\u5b9a\u7fa9\u3057\u3066\u307e\u3059\u3002\n\n#### \u6b21\u306f\u30c7\u30fc\u30bf\u3092\u3054\u306b\u3087\u3054\u306b\u3087\n\n```\nhive>  ALTER TABLE fluentLog ADD PARTITION ( pt='2013-09-09' ) LOCATION 's3://<\u30d0\u30b1\u30c3\u30c8\u540d>/nginx.access/XXXXXXX/2013/09/09'; \nOK\nTime taken: 5.252 seconds\n \nhive>  ALTER TABLE fluentLog ADD PARTITION ( pt='2013-09-10' ) LOCATION 's3://<\u30d0\u30b1\u30c3\u30c8\u540d>/nginx.access/XXXXXXX/2013/09/10'; \nOK\nTime taken: 5.252 seconds \n```\n\u65e5\u4ed8\u5358\u4f4d\u3067partition\u4f5c\u6210\u3057\u3066\u307e\u3059\u3002\n\n#### \u89e3\u6790\u5f8c\u306e\u30c7\u30fc\u30bf\u683c\u7d0d\u7528table\u3092\u4f5c\u308b\uff01\n\n\u4eca\u56de\u306f\u3001\u7c21\u5358\u306b\u30b9\u30c6\u30fc\u30bf\u30b9\u30b3\u30fc\u30c9\u304c\u4f55\u56de\u767b\u5834\u3057\u305f\u304b\u3068\u3044\u3046\u7c21\u5358\u306a\u4e8b\u3092\u3084\u3063\u3066\u307f\u307e\u3059\u3002\n\n```bash\nhive> CREATE EXTERNAL TABLE IF NOT EXISTS archiveLog (status int, cnt int)\nROW FORMAT DELIMITED FIELDS TERMINATED BY '\\t' LINES TERMINATED BY '\\n'\nLOCATION 's3://<\u30d0\u30b1\u30c3\u30c8\u540d>/archives/${DATE}';\nOK\nTime taken: 0.197 seconds \n```\n\u305d\u306e\u70ba\u3001status(int)\u3068cnt(int\uff09\u306e\u4e8c\u3064\u3092\u7528\u610f\u3057\u307e\u3057\u305f\u3002\ns3://<\u30d0\u30b1\u30c3\u30c8\u540d>/archives/${DATE}'\u306f\u7528\u610f\u3059\u308b\u5fc5\u8981\u3042\u308a\u307e\u305b\u3093\u3001\u51e6\u7406\u5b9f\u884c\u5f8c\u306b\u4f5c\u6210\u3055\u308c\u307e\u3059\u3002\n\u89e3\u6790\u5f8c\u306e\u30c7\u30fc\u30bf\u304c\u3053\u3053\u306b\u683c\u7d0d\u3055\u308c\u308b\u3088\u3046\u3067\u3059\u3002\n\n#### \u3064\u3044\u306b\u51e6\u7406\u3092\u5b9f\u884c\u3059\u308b\u6642\u304c.....\n\n```\nINSERT OVERWRITE TABLE  archiveLog\nSELECT\n  status, count(*) as cnt\nFROM\n  fluentLog LATERAL VIEW\n    json_tuple(fluentLog.json,  'ua', 'status') j\n      AS ua,status\nWHERE pt >='2013-09-09'\nGROUP BY status;\n```\n2013-09-09\u3068\u30012013-09-10\u4ee5\u4e0b\u306e\u30d5\u30a1\u30a4\u30eb\u3059\u3079\u3066\u3092\u5bfe\u8c61\u306b\u3001status\u3068\u305d\u306e\u56de\u6570\u3092\u53d6\u5f97\n\u305d\u3057\u3066\u3001\u5148\u307b\u3069\u4f5c\u6210\u3057\u305ftable\u306b\u683c\u7d0d\u3059\u308b\u3068\u3044\u3046\u51e6\u7406\u3092\u884c\u3063\u3066\u3044\u307e\u3059\u3002\n\n\u898b\u305f\u611f\u3058\u3001SQL\u30e9\u30a4\u30af\u306b\u639b\u3051\u308b\u3068\u3044\u3046\u306e\u304c\u3001hive\u306e\u3044\u3044\u3068\u3053\u308d\u3067\u3059\u306d\n\n\u4e0a\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u305f\u3089\n```\nTotal MapReduce jobs = 1\nLaunching Job 1 out of 1\nNumber of reduce tasks not specified. Estimated from input data size: 1\nIn order to change the average load for a reducer (in bytes):\n...\n```\n\n\u3069\u3093\u3069\u3093\u6587\u5b57\u304c\u51fa\u529b\u3055\u308c\u307e\u3059\n\n```\n2013-09-14 06:24:57,961 Stage-1 map = 0%,  reduce = 0%\n2013-09-14 06:25:16,420 Stage-1 map = 1%,  reduce = 0%, Cumulative CPU 10.2 sec\n2013-09-14 06:25:17,433 Stage-1 map = 1%,  reduce = 0%, Cumulative CPU 10.2 sec\n2013-09-14 06:25:18,451 Stage-1 map = 1%,  reduce = 0%, Cumulative CPU 10.2 sec\n2013-09-14 06:25:19,487 Stage-1 map = 1%,  reduce = 0%, Cumulative CPU 10.68 sec\n2013-09-14 06:25:20,514 Stage-1 map = 1%,  reduce = 0%, Cumulative CPU 10.68 sec\n2013-09-14 06:25:21,529 Stage-1 map = 1%,  reduce = 0%, Cumulative CPU 10.68 sec\n2013-09-14 06:25:22,540 Stage-1 map = 2%,  reduce = 0%, Cumulative CPU 11.08 sec\n```\n\u3092map\u51e6\u7406\u304c\u5c11\u3057\u305a\u3064\u59cb\u307e\u3063\u305f\u3088\u3046\u3060\n\n```\n2013-09-14 06:26:10,262 Stage-1 map = 8%,  reduce = 0%, Cumulative CPU 20.52 sec\n2013-09-14 06:26:11,273 Stage-1 map = 8%,  reduce = 2%, Cumulative CPU 21.18 sec\n2013-09-14 06:26:12,284 Stage-1 map = 8%,  reduce = 2%, Cumulative CPU 21.18 sec\n2013-09-14 06:26:13,301 Stage-1 map = 8%,  reduce = 2%, Cumulative CPU 21.18 sec\n2013-09-14 06:26:14,315 Stage-1 map = 9%,  reduce = 2%, Cumulative CPU 21.91 sec\n```\nReduce\u3082\u59cb\u307e\u3063\u305f\u3088\u3046\u3060\n\n\u30de\u30b9\u30bf\u30fc\uff11\u53f0\u3001\u30ce\u30fc\u30c9\uff11\u53f0\u3067\u78ba\u8a8d\u3057\u3066\u3044\u308b\u306e\u3067\u901f\u5ea6\u306f\u3042\u308c\u307f\u305f\u3044\n\n```\n2013-09-14 06:38:31,627 Stage-1 map = 100%,  reduce = 100%, Cumulative CPU 208.05 sec\n2013-09-14 06:38:32,636 Stage-1 map = 100%,  reduce = 100%, Cumulative CPU 208.05 sec\nMapReduce Total cumulative CPU time: 3 minutes 28 seconds 50 msec\n```\n\n\u5c11\u306a\u3081\u306e\u30c7\u30fc\u30bf\u3067\u78ba\u8a8d\u3057\u305f\u3068\u306f\u3044\u3048\u3001\uff13\u5206\u534a\u304b\u304b\u308a\u307e\u3057\u305f\u3002\u3080\u3057\u308d\uff13\u5206\u534a\u3067\u304a\u308f\u308a\u307e\u3057\u305f\uff1f\n\n#### \u3069\u3093\u306a\u7d50\u679c\u304b\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3059\n\n\u89e3\u6790\u5f8c\u306e\u30c7\u30fc\u30bf\u306f\u3001s3://<\u30d0\u30b1\u30c3\u30c8\u540d>/archives/${DATE}'\u4ee5\u4e0b\u306b\u683c\u7d0d\u3055\u308c\u307e\u3059\u3002\n\u6050\u308b\u6050\u308b\u3072\u3089\u3044\u3066\u307f\u308b\u3068\n\n```\n200     116080\n302     2148\n400     44\n404     40\n500     5\n```\n\n\u306a\u308b\u307b\u3069\u3001\u306a\u308b\u307b\u3069\n\n#### \u5f8c\u59cb\u672b\n\n```\nDROP TABLE fluentLog;\nDROP TABLE archiveLog;\n```\n\n\u3044\u3089\u306a\u3044\u306e\u3067\u6d88\u3057\u307e\u3057\u305f\u3002\n\n### \u7c21\u5358\u306a\u8abf\u67fb\u3092\u7d42\u3048\u3066\n\n#### \u601d\u3063\u305f\u4e8b\nnginx\u306e\u30ed\u30b0\u89e3\u6790\u3068\u304b\u306f\u3001ltsv\u5f62\u5f0f\u3067\u51fa\u529b\u3001Fluentd\u3067\u56de\u53ce\u3057\u3066S3\u3078\u8ee2\u9001\u3059\u308b\n\u3068\u3044\u3046\u8a2d\u5b9a\u304c\u3067\u304d\u3066\u3044\u308c\u3070\u3001\u5bb9\u6613\u306b\u89e3\u6790\u51e6\u7406\u3092\u884c\u3048\u308b\u306a\u3068\u601d\u3044\u307e\u3057\u305f\uff01\nhive\u306e\u30af\u30a8\u30ea\u3092\u52c9\u5f37\u3059\u308b\u5fc5\u8981\u306f\u3042\u308a\u307e\u3059\u304c\u3002\n\n\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30ed\u30b0\u306b\u95a2\u3057\u3066\u306f\u3001\u307e\u3060\u307e\u3060\u8abf\u67fb\u3067\u304d\u3066\u3044\u306a\u3044\u306e\u3067\u306a\u3093\u3068\u3082\u8a00\u3048\u307e\u305b\u3093\u306e\u3067\n\u30b3\u30ec\u306b\u95a2\u3057\u3066\u306f\u3001\u8abf\u67fb\u3057\u3066\u304b\u3089\u307e\u305f\u307e\u3068\u3081\u3066\u307f\u3088\u3046\u3002\n\u305d\u3057\u3066\u3084\u3063\u3066\u3044\u3051\u305d\u3046\u306a\u3089\u3001\u672c\u756a\u3067\u3064\u304b\u3046\n\n#### \u6700\u5f8c\u306b\u4e00\u8a00\n\n\u304a\u3082\u3057\u308d\u3044", "tags": ["fluentd", "S3", "ElasticMapReduce"]}