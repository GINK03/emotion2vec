{"context": " More than 1 year has passed since last update.http://aws.typepad.com/aws_japan/2014/01/amazon-sqs-new-dead-letter-queue.html\n\n\u6700\u5927\u53d7\u4fe1\u6570\u3092\u8a2d\u5b9a\u3057\u3001\u305d\u308c\u3092\u8d85\u3048\u308b\u5834\u5408\u306f\u5c02\u7528\u306e\u30ad\u30e5\u30fc\u306b\u79fb\u52d5\u3059\u308b\u6a5f\u80fd\u3002\n\u30e1\u30c3\u30bb\u30fc\u30b8\u3084\u30b8\u30e7\u30d6\u306b\u554f\u984c\u304c\u3042\u308a\u30a8\u30e9\u30fc\u3067\u5b8c\u4e86\u3067\u304d\u306a\u3044\u5834\u5408\u3084\u3001\u6642\u9593\u304c\u304b\u304b\u308a\u904e\u304e\u3066\u53ef\u8996\u6027\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3059\u308b\u5834\u5408\u306b\u3001\u540c\u3058\u30b8\u30e7\u30d6\u304c\u969b\u9650\u306a\u304f\u7e70\u308a\u8fd4\u3055\u308c\u3066\u3057\u307e\u3046\u554f\u984c\u3092\u56de\u907f\u3001\u304a\u3088\u3073\u554f\u984c\u3092\u8abf\u67fb\u3067\u304d\u308b\u3002\n\n\n\u7d50\u8ad6\n\n\u6700\u5927\u53d7\u4fe1\u6570\uff08maxReceiveCount\uff09\u3092\u8d85\u3048\u308b\u53d6\u5f97\u306e\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u3001Dead Letter Queue\u3078\u79fb\u52d5\u3059\u308b\n\n\n\u6700\u5927\u53d7\u4fe1\u6570\u304c\u300c1\u300d\u306a\u30892\u5ea6\u76ee\u306e\u53d6\u5f97\u306e\u969b\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092Dead Letter Queue\u306b\u5165\u308c\u3001\u8fd4\u3055\u306a\u3044\n\n\nDead Letter Queue\u306b\u79fb\u52d5\u3055\u308c\u305f\u5f8c\u3082\u3001\u51e6\u7406\u4e2d\u306e\u30b8\u30e7\u30d6\u306f\u7d99\u7d9a\u53ef\u80fd\u3060\u304c\u3001\u5b8c\u4e86\u5f8c\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u524a\u9664\u3057\u3066\u3082\u3001Dead Letter Queue\u306b\u5165\u3063\u305f\u30e1\u30c3\u30bb\u30fc\u30b8\u306f\u6d88\u3048\u306a\u3044\nDead Letter Queue\u306b\u79fb\u52d5\u3055\u308c\u305f\u30e1\u30c3\u30bb\u30fc\u30b8\u306f\u3082\u3068\u3068\u540c\u3058\u30e1\u30c3\u30bb\u30fc\u30b8ID\u3092\u3082\u3064\n\n\n\u78ba\u8a8d\u30ed\u30b0\n\n\u53d7\u4fe11\u56de\u3060\u3051\n/home/vagrant/.rbenv/versions/2.2.4/bin/ruby -e '$stdout.sync=true;$stderr.sync=true;load($0=ARGV.shift)' /shared/sqs_jikken/dead_letter_queue_example.rb\nDelete all messages from queues.\n[A] Send(d6917813-e4f2-4116-a663-9df24c92c9fc)\n[A] Received.(1)\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] Start\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] Visibility Timeout!\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:1  NotVisible: 0)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:1  NotVisible: 0)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:1  NotVisible: 0)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:1  NotVisible: 0)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:1  NotVisible: 0)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:1  NotVisible: 0)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:1  NotVisible: 0)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:1  NotVisible: 0)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] Stop\n[A] Deleted\n[A] 1 messages found. (Visible:1  NotVisible: 0)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:1  NotVisible: 0)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 0 messages found. (Visible:0  NotVisible: 0)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 0 messages found. (Visible:0  NotVisible: 0)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[D] Message not found.\n\nProcess finished with exit code 0\n\n\n\u53d7\u4fe1\u7e70\u308a\u8fd4\u3057\u305f\u3068\u304d\n/home/vagrant/.rbenv/versions/2.2.4/bin/ruby -e '$stdout.sync=true;$stderr.sync=true;load($0=ARGV.shift)' /shared/sqs_jikken/dead_letter_queue_example.rb\nDelete all messages from queues.\n[A] Send(c699230d-2ea2-483f-b4e3-00f899cb4bc0)\n[A] Received.(1)\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] Start\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] Visibility Timeout!\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 1 messages found. (Visible:1  NotVisible: 0)\n\n[A] 0 messages found. (Visible:0  NotVisible: 0)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 1 messages found. (Visible:1  NotVisible: 0)\n\n[A] 0 messages found. (Visible:0  NotVisible: 0)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 0 messages found. (Visible:0  NotVisible: 0)\n[D] 1 messages found. (Visible:1  NotVisible: 0)\n\n[A] 0 messages found. (Visible:0  NotVisible: 0)\n[D] 1 messages found. (Visible:1  NotVisible: 0)\n\n[A] 0 messages found. (Visible:0  NotVisible: 0)\n[D] 1 messages found. (Visible:1  NotVisible: 0)\n\n[A] 0 messages found. (Visible:0  NotVisible: 0)\n[D] 1 messages found. (Visible:1  NotVisible: 0)\n\n[A] Stop\n[A] Deleted\n[A] 0 messages found. (Visible:0  NotVisible: 0)\n[D] 1 messages found. (Visible:1  NotVisible: 0)\n\n[A] 0 messages found. (Visible:0  NotVisible: 0)\n[D] 1 messages found. (Visible:1  NotVisible: 0)\n\n[A] 0 messages found. (Visible:0  NotVisible: 0)\n[D] 1 messages found. (Visible:1  NotVisible: 0)\n\n[A] 0 messages found. (Visible:0  NotVisible: 0)\n[D] 1 messages found. (Visible:1  NotVisible: 0)\n\n[A] 0 messages found. (Visible:0  NotVisible: 0)\n[D] 1 messages found. (Visible:1  NotVisible: 0)\n\n[D] Message found.\n\nProcess finished with exit code 0\n\n\n\n\u78ba\u8a8d\u306b\u4f7f\u3063\u305f\u3084\u3063\u3064\u3051\u30b9\u30af\u30ea\u30d7\u30c8\nrequire 'aws-sdk'\nrequire 'pp'\n\nACTIVE_QUEUE_URL = 'https://sqs.ap-northeast-1.amazonaws.com/xxxxxxxxxxxxx/active_queue'\nDEAD_LETTER_QUEUE_URL = 'https://sqs.ap-northeast-1.amazonaws.com/xxxxxxxxxxxxx/dead_letter_queue'\nCONTINUE_RECEIVING = false\n\nregion = ENV['AWS_REGION'] || 'ap-northeast-1'\nsqs = Aws::SQS::Client.new(region: region)\n\nsqs.purge_queue(queue_url: ACTIVE_QUEUE_URL)\nsqs.purge_queue(queue_url: DEAD_LETTER_QUEUE_URL)\nputs 'Delete all messages from queues.'\n\nresp = sqs.get_queue_attributes(\n    queue_url: ACTIVE_QUEUE_URL,\n    attribute_names: %w(VisibilityTimeout)\n)\nvisibility_timeout = resp.attributes['VisibilityTimeout'].to_i\n\n# 1\u500b\u5165\u308c\u308b\nmessage_id = sqs.send_message(\n    queue_url: ACTIVE_QUEUE_URL,\n    message_body: 'BODY'\n).message_id\nputs \"[A] Send(#{message_id})\"\n\nclass Status\n  def initialize\n    @complete = false\n  end\n\n  def complete?\n    @complete\n  end\n\n  def incomplete?\n    ! complete?\n  end\n\n  def complete!\n    @complete = true\n  end\nend\nstatus = Status.new\n\nthreads = []\n\n# \u53d6\u308a\u51fa\u3059\nmessage = nil\n\nthreads << Thread.new(sqs) do |sqs|\n  Thread.pass\n  count = 0\n  while status.incomplete? do\n    resp = sqs.receive_message(\n        queue_url: ACTIVE_QUEUE_URL,\n        max_number_of_messages: 1\n  )\n    if resp.messages[0]\n      puts \"[A] Received.(#{count = count.succ})\"\n      if resp.messages[0].message_id == message_id\n        message ||= resp.messages[0]\n        break unless CONTINUE_RECEIVING\n      end\n    end\n    sleep 1\n  end\nend\n\nthreads << Thread.new(sqs) do |sqs|\n  Thread.pass\n  until message do\n    sleep 1\n  end\n\n  puts '[A] Start'\n\n  # \u975e\u53ef\u8996\u6642\u9593+\u03b1\u5f85\u6a5f\n  sleep visibility_timeout\n  puts '[A] Visibility Timeout!'\n  sleep 10\n  puts '[A] Stop'\n  # \u524a\u9664\n  sqs.delete_message(\n      queue_url: ACTIVE_QUEUE_URL,\n      receipt_handle: message.receipt_handle\n  )\n  puts '[A] Deleted'\n  sleep 5\n\n  status.complete!\nend\n\n# \u30e1\u30c3\u30bb\u30fc\u30b8\u6570\u3092\u76e3\u8996\nthreads << Thread.new(sqs) do |sqs|\n  Thread.pass\n  while status.incomplete? do\n    attributes = sqs.get_queue_attributes(\n        queue_url: ACTIVE_QUEUE_URL,\n        attribute_names: %w(ApproximateNumberOfMessages ApproximateNumberOfMessagesNotVisible)\n    ).attributes\n    puts \"[A] #{attributes['ApproximateNumberOfMessages'].to_i + attributes['ApproximateNumberOfMessagesNotVisible'].to_i} messages found. (Visible:#{attributes['ApproximateNumberOfMessages']}  NotVisible: #{attributes['ApproximateNumberOfMessagesNotVisible']})\"\n\n    attributes = sqs.get_queue_attributes(\n        queue_url: DEAD_LETTER_QUEUE_URL,\n        attribute_names: %w(ApproximateNumberOfMessages ApproximateNumberOfMessagesNotVisible)\n    ).attributes\n    puts \"[D] #{attributes['ApproximateNumberOfMessages'].to_i + attributes['ApproximateNumberOfMessagesNotVisible'].to_i} messages found. (Visible:#{attributes['ApproximateNumberOfMessages']}  NotVisible: #{attributes['ApproximateNumberOfMessagesNotVisible']})\"\n    puts ''\n    sleep 1\n  end\nend\n\nthreads.each(&:join)\n\n# D\u306b\u79fb\u52d5\u3057\u3066\u3044\u308b\u304b\u78ba\u8a8d\u3059\u308b\nresp = sqs.receive_message(\n    queue_url: DEAD_LETTER_QUEUE_URL,\n    max_number_of_messages: 1\n)\nmessage_ids = resp.messages.map(&:message_id)\nif message_ids.include?(message_id)\n  puts '[D] Message found.'\nelse\n  puts '[D] Message not found.'\nend\n\n\n\nhttp://aws.typepad.com/aws_japan/2014/01/amazon-sqs-new-dead-letter-queue.html\n\n- \u6700\u5927\u53d7\u4fe1\u6570\u3092\u8a2d\u5b9a\u3057\u3001\u305d\u308c\u3092\u8d85\u3048\u308b\u5834\u5408\u306f\u5c02\u7528\u306e\u30ad\u30e5\u30fc\u306b\u79fb\u52d5\u3059\u308b\u6a5f\u80fd\u3002\n- \u30e1\u30c3\u30bb\u30fc\u30b8\u3084\u30b8\u30e7\u30d6\u306b\u554f\u984c\u304c\u3042\u308a\u30a8\u30e9\u30fc\u3067\u5b8c\u4e86\u3067\u304d\u306a\u3044\u5834\u5408\u3084\u3001\u6642\u9593\u304c\u304b\u304b\u308a\u904e\u304e\u3066\u53ef\u8996\u6027\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3059\u308b\u5834\u5408\u306b\u3001\u540c\u3058\u30b8\u30e7\u30d6\u304c\u969b\u9650\u306a\u304f\u7e70\u308a\u8fd4\u3055\u308c\u3066\u3057\u307e\u3046\u554f\u984c\u3092\u56de\u907f\u3001\u304a\u3088\u3073\u554f\u984c\u3092\u8abf\u67fb\u3067\u304d\u308b\u3002\n\n\n## \u7d50\u8ad6\n\n- \u6700\u5927\u53d7\u4fe1\u6570\uff08maxReceiveCount\uff09\u3092\u8d85\u3048\u308b\u53d6\u5f97\u306e\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u3001Dead Letter Queue\u3078\u79fb\u52d5\u3059\u308b\n  - \u6700\u5927\u53d7\u4fe1\u6570\u304c\u300c1\u300d\u306a\u30892\u5ea6\u76ee\u306e\u53d6\u5f97\u306e\u969b\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092Dead Letter Queue\u306b\u5165\u308c\u3001\u8fd4\u3055\u306a\u3044\n- Dead Letter Queue\u306b\u79fb\u52d5\u3055\u308c\u305f\u5f8c\u3082\u3001\u51e6\u7406\u4e2d\u306e\u30b8\u30e7\u30d6\u306f\u7d99\u7d9a\u53ef\u80fd\u3060\u304c\u3001\u5b8c\u4e86\u5f8c\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u524a\u9664\u3057\u3066\u3082\u3001Dead Letter Queue\u306b\u5165\u3063\u305f\u30e1\u30c3\u30bb\u30fc\u30b8\u306f\u6d88\u3048\u306a\u3044\n- Dead Letter Queue\u306b\u79fb\u52d5\u3055\u308c\u305f\u30e1\u30c3\u30bb\u30fc\u30b8\u306f\u3082\u3068\u3068\u540c\u3058\u30e1\u30c3\u30bb\u30fc\u30b8ID\u3092\u3082\u3064\n\n## \u78ba\u8a8d\u30ed\u30b0\n\n### \u53d7\u4fe11\u56de\u3060\u3051\n\n```rb\n/home/vagrant/.rbenv/versions/2.2.4/bin/ruby -e '$stdout.sync=true;$stderr.sync=true;load($0=ARGV.shift)' /shared/sqs_jikken/dead_letter_queue_example.rb\nDelete all messages from queues.\n[A] Send(d6917813-e4f2-4116-a663-9df24c92c9fc)\n[A] Received.(1)\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] Start\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] Visibility Timeout!\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:1  NotVisible: 0)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:1  NotVisible: 0)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:1  NotVisible: 0)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:1  NotVisible: 0)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:1  NotVisible: 0)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:1  NotVisible: 0)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:1  NotVisible: 0)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:1  NotVisible: 0)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] Stop\n[A] Deleted\n[A] 1 messages found. (Visible:1  NotVisible: 0)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:1  NotVisible: 0)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 0 messages found. (Visible:0  NotVisible: 0)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 0 messages found. (Visible:0  NotVisible: 0)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[D] Message not found.\n\nProcess finished with exit code 0\n```\n\n### \u53d7\u4fe1\u7e70\u308a\u8fd4\u3057\u305f\u3068\u304d\n\n```rb\n/home/vagrant/.rbenv/versions/2.2.4/bin/ruby -e '$stdout.sync=true;$stderr.sync=true;load($0=ARGV.shift)' /shared/sqs_jikken/dead_letter_queue_example.rb\nDelete all messages from queues.\n[A] Send(c699230d-2ea2-483f-b4e3-00f899cb4bc0)\n[A] Received.(1)\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] Start\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] Visibility Timeout!\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 1 messages found. (Visible:1  NotVisible: 0)\n\n[A] 0 messages found. (Visible:0  NotVisible: 0)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 1 messages found. (Visible:0  NotVisible: 1)\n[D] 1 messages found. (Visible:1  NotVisible: 0)\n\n[A] 0 messages found. (Visible:0  NotVisible: 0)\n[D] 0 messages found. (Visible:0  NotVisible: 0)\n\n[A] 0 messages found. (Visible:0  NotVisible: 0)\n[D] 1 messages found. (Visible:1  NotVisible: 0)\n\n[A] 0 messages found. (Visible:0  NotVisible: 0)\n[D] 1 messages found. (Visible:1  NotVisible: 0)\n\n[A] 0 messages found. (Visible:0  NotVisible: 0)\n[D] 1 messages found. (Visible:1  NotVisible: 0)\n\n[A] 0 messages found. (Visible:0  NotVisible: 0)\n[D] 1 messages found. (Visible:1  NotVisible: 0)\n\n[A] Stop\n[A] Deleted\n[A] 0 messages found. (Visible:0  NotVisible: 0)\n[D] 1 messages found. (Visible:1  NotVisible: 0)\n\n[A] 0 messages found. (Visible:0  NotVisible: 0)\n[D] 1 messages found. (Visible:1  NotVisible: 0)\n\n[A] 0 messages found. (Visible:0  NotVisible: 0)\n[D] 1 messages found. (Visible:1  NotVisible: 0)\n\n[A] 0 messages found. (Visible:0  NotVisible: 0)\n[D] 1 messages found. (Visible:1  NotVisible: 0)\n\n[A] 0 messages found. (Visible:0  NotVisible: 0)\n[D] 1 messages found. (Visible:1  NotVisible: 0)\n\n[D] Message found.\n\nProcess finished with exit code 0\n\n```\n\n## \u78ba\u8a8d\u306b\u4f7f\u3063\u305f\u3084\u3063\u3064\u3051\u30b9\u30af\u30ea\u30d7\u30c8\n\n```rb\nrequire 'aws-sdk'\nrequire 'pp'\n\nACTIVE_QUEUE_URL = 'https://sqs.ap-northeast-1.amazonaws.com/xxxxxxxxxxxxx/active_queue'\nDEAD_LETTER_QUEUE_URL = 'https://sqs.ap-northeast-1.amazonaws.com/xxxxxxxxxxxxx/dead_letter_queue'\nCONTINUE_RECEIVING = false\n\nregion = ENV['AWS_REGION'] || 'ap-northeast-1'\nsqs = Aws::SQS::Client.new(region: region)\n\nsqs.purge_queue(queue_url: ACTIVE_QUEUE_URL)\nsqs.purge_queue(queue_url: DEAD_LETTER_QUEUE_URL)\nputs 'Delete all messages from queues.'\n\nresp = sqs.get_queue_attributes(\n    queue_url: ACTIVE_QUEUE_URL,\n    attribute_names: %w(VisibilityTimeout)\n)\nvisibility_timeout = resp.attributes['VisibilityTimeout'].to_i\n\n# 1\u500b\u5165\u308c\u308b\nmessage_id = sqs.send_message(\n    queue_url: ACTIVE_QUEUE_URL,\n    message_body: 'BODY'\n).message_id\nputs \"[A] Send(#{message_id})\"\n\nclass Status\n  def initialize\n    @complete = false\n  end\n\n  def complete?\n    @complete\n  end\n\n  def incomplete?\n    ! complete?\n  end\n\n  def complete!\n    @complete = true\n  end\nend\nstatus = Status.new\n\nthreads = []\n\n# \u53d6\u308a\u51fa\u3059\nmessage = nil\n\nthreads << Thread.new(sqs) do |sqs|\n  Thread.pass\n  count = 0\n  while status.incomplete? do\n    resp = sqs.receive_message(\n        queue_url: ACTIVE_QUEUE_URL,\n        max_number_of_messages: 1\n  )\n    if resp.messages[0]\n      puts \"[A] Received.(#{count = count.succ})\"\n      if resp.messages[0].message_id == message_id\n        message ||= resp.messages[0]\n        break unless CONTINUE_RECEIVING\n      end\n    end\n    sleep 1\n  end\nend\n\nthreads << Thread.new(sqs) do |sqs|\n  Thread.pass\n  until message do\n    sleep 1\n  end\n\n  puts '[A] Start'\n\n  # \u975e\u53ef\u8996\u6642\u9593+\u03b1\u5f85\u6a5f\n  sleep visibility_timeout\n  puts '[A] Visibility Timeout!'\n  sleep 10\n  puts '[A] Stop'\n  # \u524a\u9664\n  sqs.delete_message(\n      queue_url: ACTIVE_QUEUE_URL,\n      receipt_handle: message.receipt_handle\n  )\n  puts '[A] Deleted'\n  sleep 5\n\n  status.complete!\nend\n\n# \u30e1\u30c3\u30bb\u30fc\u30b8\u6570\u3092\u76e3\u8996\nthreads << Thread.new(sqs) do |sqs|\n  Thread.pass\n  while status.incomplete? do\n    attributes = sqs.get_queue_attributes(\n        queue_url: ACTIVE_QUEUE_URL,\n        attribute_names: %w(ApproximateNumberOfMessages ApproximateNumberOfMessagesNotVisible)\n    ).attributes\n    puts \"[A] #{attributes['ApproximateNumberOfMessages'].to_i + attributes['ApproximateNumberOfMessagesNotVisible'].to_i} messages found. (Visible:#{attributes['ApproximateNumberOfMessages']}  NotVisible: #{attributes['ApproximateNumberOfMessagesNotVisible']})\"\n\n    attributes = sqs.get_queue_attributes(\n        queue_url: DEAD_LETTER_QUEUE_URL,\n        attribute_names: %w(ApproximateNumberOfMessages ApproximateNumberOfMessagesNotVisible)\n    ).attributes\n    puts \"[D] #{attributes['ApproximateNumberOfMessages'].to_i + attributes['ApproximateNumberOfMessagesNotVisible'].to_i} messages found. (Visible:#{attributes['ApproximateNumberOfMessages']}  NotVisible: #{attributes['ApproximateNumberOfMessagesNotVisible']})\"\n    puts ''\n    sleep 1\n  end\nend\n\nthreads.each(&:join)\n\n# D\u306b\u79fb\u52d5\u3057\u3066\u3044\u308b\u304b\u78ba\u8a8d\u3059\u308b\nresp = sqs.receive_message(\n    queue_url: DEAD_LETTER_QUEUE_URL,\n    max_number_of_messages: 1\n)\nmessage_ids = resp.messages.map(&:message_id)\nif message_ids.include?(message_id)\n  puts '[D] Message found.'\nelse\n  puts '[D] Message not found.'\nend\n\n```\n\n", "tags": ["Ruby", "aws-sdk", "sqs"]}