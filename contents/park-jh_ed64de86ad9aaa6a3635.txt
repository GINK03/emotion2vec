{"context": "\n\n\u95a2\u9023\u8a18\u4e8b\n\n\u52c9\u5f37\u4f1aBDD\uff1c\uff11\uff1eRSpec\u3068Capybara\u30fc\u30b9\u30bf\u30fc\u30c8\n\u52c9\u5f37\u4f1aBDD\uff1c\uff12\uff1eRSpec\u3068Capybara\u30fc\u30e2\u30c7\u30eb\n\u52c9\u5f37\u4f1aBDD\uff1c\uff13\uff1eRSpec\u3068Capybara\u30fc\u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\n\u52c9\u5f37\u4f1aBDD\uff1c\uff14\uff1eRSpec\u3068Capybara\u30fc\u30dd\u30a4\u30f3\u30c8\u30b7\u30b9\u30c6\u30e0\n\n\n\u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u306e\u30c6\u30b9\u30c8\uff08\uff11\uff09\ncustomer_spec\u3092\u4fee\u6b63\u3059\u308b\u3002\u8a73\u7d30\u5185\u5bb9\u306f\u6b21\u306e\u30ea\u30f3\u30af\u3092\u3054\u53c2\u8003\u306b\u3057\u3066\u3044\u305f\u3060\u304d\u305f\u3044\u3002\n\nhttp://www.oiax.jp/rails/rspec_capybara_primer/signing_in1.html\n\n\n\u5bbf\u984c\ndiff --git a/spec/models/customer_spec.rb b/spec/models/customer_spec.rb\nindex 9c35634..91556e5 100644\n--- a/spec/models/customer_spec.rb\n+++ b/spec/models/customer_spec.rb\n@@ -19,6 +19,12 @@ RSpec.describe Customer, type: :model do\n       expect(customer).not_to be_valid\n       expect(customer.errors[column_name]).to be_present\n     end\n+\n+    example \"#{column_name}\u306b\u542b\u307e\u308c\u308b\u534a\u89d2\u30ab\u30ca\u306f\u5168\u89d2\u30ab\u30ca\u306b\u4ea4\u63db\u3057\u3066\u53d7\u3051\u5165\u308c\u308b\" do\n+      customer[column_name] = '\uff71\uff72\uff73'\n+      expect(customer).to be_valid\n+      expect(customer[column_name]).to eq('\u30a2\u30a4\u30a6')\n+    end\n   end\n\n   %w{family_name given_name}.each do |column_name|\n@@ -28,7 +34,7 @@ RSpec.describe Customer, type: :model do\n     end\n\n     example \"#{column_name}\u306f\u6f22\u5b57\u3001\u3072\u3089\u304c\u306a\u3001\u30ab\u30bf\u30ab\u30ca\u4ee5\u5916\u306e\u6587\u5b57\u3092\u542b\u307e\u306a\u3044\" do\n-      ['A', '1', '@'].each do |value|\n+      %w(A 1 @).each do |value|\n         customer[column_name] = value\n         expect(customer).not_to be_valid\n         expect(customer[column_name]).to be_present\n@@ -37,6 +43,19 @@ RSpec.describe Customer, type: :model do\n   end\n\n   %w(family_name_kana given_name_kana).each do |column_name|\n+    example \"#{column_name}\u306f\u30ab\u30bf\u30ab\u30ca\u3092\u542b\u3093\u3067\u3082\u826f\u3044\" do\n+      customer[column_name] = '\u30a2\u30a4\u30a6'\n+      expect(customer).to be_valid\n+    end\n+\n+    example \"#{column_name}\u306f\u30ab\u30bf\u30ab\u30ca\u4ee5\u5916\u306e\u6587\u5b57\u3092\u542b\u307e\u306a\u3044\" do\n+      %w(\u4e9c A 1 @).each do |value|\n+        customer[column_name] = value\n+        expect(customer).not_to be_valid\n+        expect(customer.errors[column_name]).to be_present\n+      end\n+    end\n+\n     example \"#{column_name}\u306b\u542b\u307e\u308c\u308b\u3072\u3089\u304c\u306a\u306f\u30ab\u30bf\u30ab\u30ca\u306b\u4ea4\u63db\u3057\u3066\u53d7\u3051\u5165\u308c\u308b\" do\n       customer[column_name] = '\u3042\u3044\u3046'\n       expect(customer).to be_valid\n\ndiff --git a/app/models/customer.rb b/app/models/customer.rb\nindex f83df81..ffd50be 100644\n--- a/app/models/customer.rb\n+++ b/app/models/customer.rb\n@@ -5,10 +5,14 @@ class Customer < ActiveRecord::Base\n             format: {with: /\\A[\\p{Han}\\p{Hiragana}\\p{Katakana}\\u30fc]+\\z/, allow_blank: true}\n   validates :given_name, presence: true, length: {maximum: 40},\n             format: {with: /\\A[\\p{Han}\\p{Hiragana}\\p{Katakana}\\u30fc]+\\z/, allow_blank: true}\n-  validates :family_name_kana, presence: true, length: {maximum: 40}\n-  validates :given_name_kana, presence: true, length: {maximum: 40}\n+  validates :family_name_kana, presence: true, length: {maximum: 40},\n+            format: {with: /\\A\\p{Katakana}+\\z/, allow_blank: true}\n+  validates :given_name_kana, presence: true, length: {maximum: 40},\n+            format: {with: /\\A\\p{Katakana}+\\z/, allow_blank: true}\n\n   before_validation do\n+    self.family_name = NKF.nkf('-w', family_name) if family_name\n+    self.given_name = NKF.nkf('-w', given_name) if given_name\n     self.family_name_kana = NKF.nkf('-wh2', family_name_kana) if family_name_kana\n     self.given_name_kana = NKF.nkf('-wh2', given_name_kana) if given_name_kana\n   end\n\n\n\u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6a5f\u80fd\u306e\u4ed5\u69d8\n\n\u30ed\u30b0\u30a4\u30f3\u524d\u306e\u30e6\u30fc\u30b6\u30fc\u304c\u30c8\u30c3\u30d7\u30da\u30fc\u30b8\u306eURL\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001\u901a\u5e38\u306e\u30c8\u30c3\u30d7\u30da\u30fc\u30b8\u306e\u4ee3\u308f\u308a\u306b\u30ed\u30b0\u30a4\u30f3\u30d5\u30a9\u30fc\u30e0\u304c\u8868\u793a\u3055\u308c\u308b\u3002\n\u30e6\u30fc\u30b6\u30fc\u304c\u30ed\u30b0\u30a4\u30f3\u30d5\u30a9\u30fc\u30e0\u306b\u6b63\u3057\u3044\u30e6\u30fc\u30b6\u30fc\u540d\uff08username\uff09\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\uff08password\uff09\u3092\u5165\u529b\u3057\u3066\u300c\u30ed\u30b0\u30a4\u30f3\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068\u3001\u901a\u5e38\u306e\u30c8\u30c3\u30d7\u30da\u30fc\u30b8\u304c\u8868\u793a\u3055\u308c\u308b\u3002\n\u30ed\u30b0\u30a4\u30f3\u306b\u5931\u6557\u3057\u305f\u5834\u5408\u306f\u3001\u300c\u30e6\u30fc\u30b6\u30fc\u540d\u307e\u305f\u306f\u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u6b63\u3057\u304f\u3042\u308a\u307e\u305b\u3093\u3002\u300d\u3068\u3044\u3046\u30e1\u30c3\u30bb\u30fc\u30b8\u3068\u30ed\u30b0\u30a4\u30f3\u30d5\u30a9\u30fc\u30e0\u304c\u8868\u793a\u3055\u308c\u308b\u3002\n\u30e6\u30fc\u30b6\u30fc\u304c\u30c8\u30c3\u30d7\u30da\u30fc\u30b8\u306e\u300c\u30ed\u30b0\u30a2\u30a6\u30c8\u300d\u30ea\u30f3\u30af\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068\u3001\u300c\u672c\u5f53\u306b\u30ed\u30b0\u30a2\u30a6\u30c8\u3057\u307e\u3059\u304b\uff1f\u300d\u3068\u3044\u3046\u8b66\u544a\u30c0\u30a4\u30a2\u30ed\u30b0\u304c\u8868\u793a\u3055\u308c\u3001\u300cOK\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068\u3001\u300c\u30ed\u30b0\u30a2\u30a6\u30c8\u3057\u307e\u3057\u305f\u300d\u3068\u3044\u3046\u30e1\u30c3\u30bb\u30fc\u30b8\u3068\u30ed\u30b0\u30a4\u30f3\u30d5\u30a9\u30fc\u30e0\u304c\u8868\u793a\u3055\u308c\u308b\u3002\n\u30e6\u30fc\u30b6\u30fc\u304c\u30ed\u30b0\u30a4\u30f3\u306b\u6210\u529f\u3059\u308b\u3068\u3001\u300c\u30ed\u30b0\u30a4\u30f3\u30dd\u30a4\u30f3\u30c8\u300d\u3068\u3057\u3066\u30e6\u30fc\u30b6\u30fc\u306b\uff11\u30dd\u30a4\u30f3\u30c8\u304c\u4e0e\u3048\u3089\u308c\u308b\u3002\n\u305f\u3060\u3057\u3001\u300c\u30ed\u30b0\u30a4\u30f3\u30dd\u30a4\u30f3\u30c8\u300d\u306f\u30e6\u30fc\u30b6\u30fc\u3054\u3068\u306b\uff11\u65e5\uff11\u56de\u3057\u304b\u4e0e\u3048\u3089\u308c\u306a\u3044\u3002\u65e5\u306e\u533a\u5207\u308a\u306f\u65e5\u672c\u6642\u9593\u5348\u524d\uff15\u6642\u3068\u3059\u308b\u3002\n\u307e\u305f\u3001\u571f\u66dc\u65e5\u306b\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u3068\u3001\u901a\u5e38\u306e\u300c\u30ed\u30b0\u30a4\u30f3\u30dd\u30a4\u30f3\u30c8\u300d\u306e\u4ed6\u306b\u300c\u571f\u66dc\u30ed\u30b0\u30a4\u30f3\u30dc\u30fc\u30ca\u30b9\u300d\u3068\u3057\u3066\uff12\u30dd\u30a4\u30f3\u30c8\u304c\u4e0e\u3048\u3089\u308c\u308b\u3002\n\n\nOutside-In\n\n\u30d3\u30d8\u30a4\u30d3\u30a2\u99c6\u52d5\u958b\u767a\u306e\u539f\u5247\u306e1\u3064\n\u5916\u5074\uff08\u30e6\u30fc\u30b6\u30fc\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u306a\u3069\uff09\u304b\u3089\u5185\u5074\uff08\u30d3\u30b8\u30cd\u30b9\u30ed\u30b8\u30c3\u30af\u3084\u30c7\u30fc\u30bf\u69cb\u9020\uff09\u306b\u5411\u304b\u3063\u3066\u5b9f\u88c5\u3092\u9032\u3081\u308b\u3002\n\n\n\u30ed\u30b0\u30a4\u30f3\u6a5f\u80fd\u306e\u30c6\u30b9\u30c8\n# spec/features/login_and_logout_spec.rb\n\nrequire 'rails_helper'\n\ndescribe '\u30ed\u30b0\u30a4\u30f3' do\n  example '\u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f' do\n    visit root_path\n    within('form#new_session') do\n      fill_in 'username', with: 'taro'\n      fill_in 'password', with: 'correct_password'\n      click_button '\u30ed\u30b0\u30a4\u30f3'\n    end\n    expect(page).not_to have_css('form#new_session')\n  end\n\n  example '\u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557' do\n    visit root_path\n    within('form#new_session') do\n      fill_in 'username', with: 'taro'\n      fill_in 'password', with: 'wrong_password'\n      click_button '\u30ed\u30b0\u30a4\u30f3'\n    end\n    expect(page).to have_css('p.alert', text: '\u30e6\u30fc\u30b6\u30fc\u540d\u307e\u305f\u306f\u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u6b63\u3057\u304f\u3042\u308a\u307e\u305b\u3093\u3002')\n    expect(page).to have_css('form#new_session')\n  end\nend \n\n\n\u30c6\u30b9\u30c8\u7d50\u679c\n  1 || /home/vagrant/study/oiax/db/schema.rb doesn't exist yet. Run `rake db:migrate` to create it, then try again. If you do not intend to use a database, you\n  2 ||\n  3 || \u30ed\u30b0\u30a4\u30f3\n  4 ||   \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f (FAILED - 1)\n  5 ||   \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557 (FAILED - 2)\n  6 ||\n  7 || Failures:\n  8 ||\n  9 spec/features/login_and_logout_spec.rb|5 error|  Failure/Error: visit root_path NameError: undefined local variable or method `root_path' for #<RSpec::Examp\n 10 ||\n 11 spec/features/login_and_logout_spec.rb|15 error|  Failure/Error: visit root_path NameError: undefined local variable or method `root_path' for #<RSpec::Exam\n 12 ||\n 13 || Finished in 0.02823 seconds (files took 5.27 seconds to load)\n 14 || 2 examples, 2 failures\n 15 ||\n 16 || Failed examples:\n 17 ||\n 18 || rspec ./spec/features/login_and_logout_spec.rb:4 # \u30ed\u30b0\u30a4\u30f3 \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f\n 19 || rspec ./spec/features/login_and_logout_spec.rb:14 # \u30ed\u30b0\u30a4\u30f3 \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557\n\n\n\u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u306e\u30c6\u30b9\u30c8\uff08\uff12\uff09--\u30a2\u30af\u30b7\u30e7\u30f3\u306e\u4eee\u5b9f\u88c5\n\nhttp://www.oiax.jp/rails/rspec_capybara_primer/signing_in2.html\n\n\n\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3001\u305d\u3057\u3066\u30a2\u30af\u30b7\u30e7\u30f3\u306e\u4eee\u5b9f\u88c5\n\n\u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u3092\u884c\u3046\u30a2\u30af\u30b7\u30e7\u30f3\u3001URL\u3001HTTP\u30e1\u30bd\u30c3\u30c9\u306e\u7a2e\u985e\u3092\u6c7a\u3081\u308b\u3002\n\nsessions#create POST /login\n\n\n\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u4fee\u6b63\n\n# config/routes.rb\npost 'login' => 'sessions#create', as: :login\n\n\ncontroller\u306e\u4f5c\u6210\n\n# app/controllers/sessions_controller.rb\nclass SessionsController < ApplicationController\n  def create\n    redirect_to :root\n  end\nend\n\n\nview\u306e\u4f5c\u6210\n\n# app/views/top/_login_form.html.erb\n<%= form_tag :login, id: 'new_session' do %>\n  <div>\n    <%= label_tag 'username', '\u30e6\u30fc\u30b6\u30fc\u540d' %>\n    <%= text_field_tag 'username' %>\n  </div>\n  <div>\n    <%= label_tag 'password', '\u30d1\u30b9\u30ef\u30fc\u30c9' %>\n    <%= password_field_tag 'password' %>\n  </div>\n  <div>\n    <%= submit_tag '\u30ed\u30b0\u30a4\u30f3' %>\n  </div>\n<% end %>\n\n# bin/erb2slim \u30b3\u30de\u30f3\u30c9\u3067\u81ea\u52d5\u5909\u63db\u53ef\u80fd\n# usage: bin/erb2slim -d app/views\n# erb\u3068slim\u304c\u4e00\u7dd2\u306b\u5b58\u5728\u3059\u308b\u5834\u5408\u3001slim\u3088\u308aerb\u3092\u512a\u5148\u3059\u308b\u3002\n# -d\u30aa\u30d7\u30b7\u30e7\u30f3\u306ferb\u30d5\u30a1\u30a4\u30eb\u3092slim\u306b\u5909\u63db\u3057\u305f\u5f8c\u3001erb\u30d5\u30a1\u30a4\u30eb\u3092\u6d88\u3059\u3002\n# app/views/top/_login_form.html.slim\n= form_tag :login, id: 'new_session' do\n  div\n    = label_tag 'username', '\u30e6\u30fc\u30b6\u30fc\u540d'\n    = text_field_tag 'username'\n  div\n    = label_tag 'password', '\u30d1\u30b9\u30ef\u30fc\u30c9'\n    = password_field_tag 'password'\n  div\n    = submit_tag '\u30ed\u30b0\u30a4\u30f3'\n\n\n\u30c6\u30b9\u30c8\u7d50\u679c\n\nrake db:migrate\u3092\u3057\u306a\u3044\u3068schema.rb\u30d5\u30a1\u30a4\u30eb\u304c\u751f\u6210\u3055\u308c\u306a\u3044\u307f\u305f\u3044\u3002\nmigration\u30d5\u30a1\u30a4\u30eb\u304c\u5b58\u5728\u3057\u306a\u304f\u3066\u3082RSpec\u3092\u5b9f\u884c\u3059\u308b\u305f\u3073\u306b\u3053\u3093\u306a\u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u8868\u793a\u3055\u308c\u308b\u306e\u306f\u3088\u304f\u306a\u3044\u306e\u3067\u3001\nrake db:migrate\u3092\u5b9f\u884c\u3002\n\n  1 || /home/vagrant/study/oiax/db/schema.rb doesn't exist yet. Run `rake db:migrate` to create it, then try again. If you do not intend to use a database, you\n  2 ||\n  3 || \u30ed\u30b0\u30a4\u30f3\n  4 ||   \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f (FAILED - 1)\n  5 ||   \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557 (FAILED - 2)\n  6 ||\n  7 || Failures:\n  8 ||\n  9 spec/features/login_and_logout_spec.rb|11 error|  Failure/Error: expect(page).not_to have_css('form#new_session') expected not to find css \"form#new_session\n 10 ||\n 11 spec/features/login_and_logout_spec.rb|21 error|  Failure/Error: expect(page).to have_css('p.alert', text: '\u30e6\u30fc\u30b6\u30fc\u540d\u307e\u305f\u306f\u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u6b63\u3057\u304f\u3042\u308a\u307e\u305b\u3093\u3002')\n 12 ||\n 13 || Finished in 0.52518 seconds (files took 5.73 seconds to load)\n 14 || 2 examples, 2 failures\n 15 ||\n 16 || Failed examples:\n 17 ||\n 18 || rspec ./spec/features/login_and_logout_spec.rb:4 # \u30ed\u30b0\u30a4\u30f3 \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f\n 19 || rspec ./spec/features/login_and_logout_spec.rb:14 # \u30ed\u30b0\u30a4\u30f3 \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557\n\n\n\u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557\u30b7\u30ca\u30ea\u30aa\u306e\u5b9f\u88c5\n\ncontroller\u306e\u4fee\u6b63\n\n# app/controllers/sessions_controller.rb\nclass SessionsController < ApplicationController\n  def create\n    if false\n      # \u672a\u5b9f\u88c5\n    else\n      flash.alert = '\u30e6\u30fc\u30b6\u30fc\u540d\u307e\u305f\u306f\u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u6b63\u3057\u304f\u3042\u308a\u307e\u305b\u3093\u3002'\n    end\n    redirect_to :root\n  end\nend\n\n\nlayout\u306e\u4fee\u6b63\n\n\nflash\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u8868\u793a\u3059\u308b\u90e8\u5206\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u4f5c\u6210\u3059\u308b\u3002\n\n\n\n# app/views/layouts/application.html.slim\ndoctype html\nhtml\n  head\n    title\n      | Oiax\n    = stylesheet_link_tag    'application', media: 'all', 'data-turbolinks-track' => true\n    = javascript_include_tag 'application', 'data-turbolinks-track' => true\n    = csrf_meta_tags\n  body\n    = render 'layouts/flashes'\n    = yield\n\n# app/views/layouts/_flashes.html.slim\n- if flash.alert.present?\n  p.alert\n    = flash.alert\n- if flash.notice.present?\n  p.notice\n    = flash.notice\n\n\n\u30c6\u30b9\u30c8\u7d50\u679c\n\n\n\u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557\u306e\u30c6\u30b9\u30c8\u306f\u901a\u904e\u3057\u305f\u3002\n\n\n\n  1 ||\n  2 || \u30ed\u30b0\u30a4\u30f3\n  3 ||   \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f (FAILED - 1)\n  4 ||   \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557\n  5 ||\n  6 || Failures:\n  7 ||\n  8 spec/features/login_and_logout_spec.rb|11 error|  Failure/Error: expect(page).not_to have_css('form#new_session') expected not to find css \"form#new_session\n  9 ||\n 10 || Finished in 0.40297 seconds (files took 5.27 seconds to load)\n 11 || 2 examples, 1 failure\n 12 ||\n 13 || Failed examples:\n 14 ||\n 15 || rspec ./spec/features/login_and_logout_spec.rb:4 # \u30ed\u30b0\u30a4\u30f3 \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f\n\n\n\u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u306e\u30c6\u30b9\u30c8\uff08\uff13\uff09--\u30b9\u30bf\u30d6\u306e\u6d3b\u7528\n\nhttp://www.oiax.jp/rails/rspec_capybara_primer/signing_in3.html\n\n\n\u30a2\u30af\u30b7\u30e7\u30f3\u306e\u4eee\u5b9f\u88c5\n\ncontroller\u306e\u4fee\u6b63\n\n  def create\n    if customer = Customer.authenticate(params[:username], params[:password])\n      session[:customer_id] = customer.id\n    else\n      flash.alert = '\u30e6\u30fc\u30b6\u30fc\u540d\u307e\u305f\u306f\u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u6b63\u3057\u304f\u3042\u308a\u307e\u305b\u3093\u3002'\n    end\n    redirect_to :root\n  end\n\n\nview\u306e\u4fee\u6b63\n\nh1 Top#index\np Find me in app/views/top/index.html.slim\np Hello World!\n= render 'login_form' unless session[:customer_id]\n\n\n\u30c6\u30b9\u30c8\u7d50\u679c\n\n  1 ||\n  2 || \u30ed\u30b0\u30a4\u30f3\n  3 ||   \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f (FAILED - 1)\n  4 ||   \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557 (FAILED - 2)\n  5 ||\n  6 || Failures:\n  7 ||\n  8 app/controllers/sessions_controller.rb|3 error|  Failure/Error: click_button '\u30ed\u30b0\u30a4\u30f3' NoMethodError: undefined method `authenticate' for #<Class:0x007fea3\n  9 ||      # ./spec/features/login_and_logout_spec.rb:9:in `block (3 levels) in <top (required)>'\n 10 ||      # ./spec/features/login_and_logout_spec.rb:6:in `block (2 levels) in <top (required)>'\n 11 ||\n 12 app/controllers/sessions_controller.rb|3 error|  Failure/Error: click_button '\u30ed\u30b0\u30a4\u30f3' NoMethodError: undefined method `authenticate' for #<Class:0x007fea3\n 13 ||      # ./spec/features/login_and_logout_spec.rb:19:in `block (3 levels) in <top (required)>'\n 14 ||      # ./spec/features/login_and_logout_spec.rb:16:in `block (2 levels) in <top (required)>'\n 15 ||\n 16 || Finished in 2.37 seconds (files took 4.28 seconds to load)\n 17 || 2 examples, 2 failures\n 18 ||\n 19 || Failed examples:\n 20 ||\n 21 || rspec ./spec/features/login_and_logout_spec.rb:4 # \u30ed\u30b0\u30a4\u30f3 \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f\n 22 || rspec ./spec/features/login_and_logout_spec.rb:14 # \u30ed\u30b0\u30a4\u30f3 \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557\n\n\n\u30e1\u30bd\u30c3\u30c9\u30b9\u30bf\u30d6\u3001\u3042\u308b\u3044\u306f\u30b9\u30bf\u30d6\n\n\u30b9\u30bf\u30d6\u3068\u306f\uff1f\n\n\n\u672c\u7269\u306e\u30e1\u30bd\u30c3\u30c9\u306e\u4ee3\u308f\u308a\u306b\u4e00\u6642\u7684\u306b\uff08\u30c6\u30b9\u30c8\u306e\u9593\u3060\u3051\uff09\u5b9a\u7fa9\u3055\u308c\u305f\u30e1\u30bd\u30c3\u30c9\u3002\n\u3042\u308b\u30e1\u30bd\u30c3\u30c9\u306e\u5b9f\u88c5\u3092\u5f8c\u56de\u3057\u306b\u3057\u305f\u3044\u3001\u3057\u304b\u3057\u305d\u306e\u30e1\u30bd\u30c3\u30c9\u304c\u5b58\u5728\u3057\u306a\u3044\u3068\u30c6\u30b9\u30c8\u304c\u901a\u3089\u306a\u3044\u3068\u304d\u4f7f\u3046\n\n\nspec\u306e\u4fee\u6b63\n\n\nstub\u3092\u8ffd\u52a0\u3059\u308b\u3002\n\n\n\ndiff --git a/spec/features/login_and_logout_spec.rb b/spec/features/login_and_logout_spec.rb\nindex 40db3b0..0762945 100644\n--- a/spec/features/login_and_logout_spec.rb\n+++ b/spec/features/login_and_logout_spec.rb\n@@ -2,6 +2,7 @@ require 'rails_helper'\n\n describe '\u30ed\u30b0\u30a4\u30f3' do\n   example '\u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f' do\n+    Customer.stub(:authenticate)\n     visit root_path\n     within('form#new_session') do\n       fill_in 'username', with: 'taro'\n@@ -12,6 +13,7 @@ describe '\u30ed\u30b0\u30a4\u30f3' do\n   end\n\n   example '\u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557' do\n+    Customer.stub(:authenticate)\n     visit root_path\n     within('form#new_session') do\n       fill_in 'username', with: 'taro'\n\n\n\u30c6\u30b9\u30c8\u7d50\u679c\n\n  1 ||\n  2 || \u30ed\u30b0\u30a4\u30f3\n  3 ||   \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f (FAILED - 1)\n  4 ||   \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557 (FAILED - 2)\n  5 ||\n  6 || Failures:\n  7 ||\n  8 spec/features/login_and_logout_spec.rb|5 error|  Failure/Error: Customer.stub(:authenticate) Customer(id: integer, family_name: string, given_name: string,\n  9 ||\n 10 spec/features/login_and_logout_spec.rb|16 error|  Failure/Error: Customer.stub(:authenticate) Customer(id: integer, family_name: string, given_name: string,\n 11 ||\n 12 || Deprecation Warnings:\n 13 ||\n 14 || Using `stub` from rspec-mocks' old `:should` syntax without explicitly enabling the syntax is deprecated. Use the new `:expect` syntax or explicitly enab\n 15 ||\n 16 ||\n 17 || If you need more of the backtrace for any of these deprecations to\n 18 || identify where to make the necessary changes, you can configure\n 19 || `config.raise_errors_for_deprecations!`, and it will turn the\n 20 || deprecation warnings into errors, giving you the full backtrace.\n 21 ||\n 22 || 1 deprecation warning total\n 23 ||\n 24 || Finished in 0.0601 seconds (files took 3.08 seconds to load)\n 25 || 2 examples, 2 failures\n 26 ||\n 27 || Failed examples:\n 28 ||\n 29 || rspec ./spec/features/login_and_logout_spec.rb:4 # \u30ed\u30b0\u30a4\u30f3 \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f\n 30 || rspec ./spec/features/login_and_logout_spec.rb:15 # \u30ed\u30b0\u30a4\u30f3 \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557\n\n\n\u30b9\u30bf\u30d6\u306e\u623b\u308a\u5024\u3092\u6307\u5b9a\u3059\u308b\u3002\n\n\u30e2\u30c3\u30af\u3068\u30b9\u30bf\u30d6\u306e\u5fa9\u7fd2\n\n\n\u30e2\u30c3\u30af\n\u672c\u7269\u306e\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306e\u3075\u308a\u3092\u3059\u308b\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3002\n\u30c6\u30b9\u30c8\u30c0\u30d6\u30eb\uff08test doubles\uff09\u3068\u547c\u3070\u308c\u308b\u3002\nFactoryGirl.build_stubbed()\n\u30b9\u30bf\u30d6\n\u672c\u7269\u306e\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3057\u3001\u4e8b\u524d\u306b\u6c7a\u3081\u3089\u308c\u305f\u5024\u3092\u8fd4\u3059\u3002\nallow(Customer).to receive(:authenticate).with(username, password).and_return(customer)\n\n\nCustomer.authenticate\u306fCustomer\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u8fd4\u3059\u3002\n\nCustomer.stub(:authenticate).and_return(Customer.new)\n\n\n\u30c6\u30b9\u30c8\u7d50\u679c\n\n\n\u624b\u9806\u901a\u308a\u3084\u3063\u3066\u3044\u305f\u304c\u3001\u307e\u305f\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3059\u308b\u3002\u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u3082\u3046\u4e00\u5ea6\u78ba\u8a8d\u3002\nauthenticate\u30e1\u30bd\u30c3\u30c9\u304c\u5177\u73fe\u3055\u308c\u3066\u306a\u3044\u3068\u66f8\u304b\u308c\u3066\u3044\u308b\u3002\nstub\u3092\u5229\u7528\u3059\u308b\u3053\u3068\u306b\u306a\u3063\u3066\u3082\u30e1\u30bd\u30c3\u30c9\u306f\u5fc5\u8981\u3089\u3057\u3044\u3002\n\n\n\n[devnote@hooni:~/documents/study/oiax] % bin/rspec spec/features/login_and_logout_spec.rb\n\n\u30ed\u30b0\u30a4\u30f3\n  \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f (FAILED - 1)\n  \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557 (FAILED - 2)\n\nFailures:\n\n  1) \u30ed\u30b0\u30a4\u30f3 \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f\n     Failure/Error: Customer.stub(:authenticate).and_return(FactoryGirl.create(:customer))\n       Customer(id: integer, family_name: string, given_name: string, family_name_kana: string, given_name_kana: string, created_at: datetime, updated_at: datetime) does not implement: authenticate\n     # ./spec/features/login_and_logout_spec.rb:5:in `block (2 levels) in <top (required)>'\n\n  2) \u30ed\u30b0\u30a4\u30f3 \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557\n     Failure/Error: Customer.stub(:authenticate)\n       Customer(id: integer, family_name: string, given_name: string, family_name_kana: string, given_name_kana: string, created_at: datetime, updated_at: datetime) does not implement: authenticate\n     # ./spec/features/login_and_logout_spec.rb:16:in `block (2 levels) in <top (required)>'\n\nDeprecation Warnings:\n\nUsing `stub` from rspec-mocks' old `:should` syntax without explicitly enabling the syntax is deprecated. Use the new `:expect` syntax or explicitly enable `:should` instead. Called from /Users/devnote/Documents/study/oiax/spec/features/login_and_logout_spec.rb:5:in `block (2 levels) in <top (required)>'.\n\nIf you need more of the backtrace for any of these deprecations to\nidentify where to make the necessary changes, you can configure\n`config.raise_errors_for_deprecations!`, and it will turn the\ndeprecation warnings into errors, giving you the full backtrace.\n\n1 deprecation warning total\n\nFinished in 0.026 seconds (files took 2.79 seconds to load)\n2 examples, 2 failures\n\nFailed examples:\n\nrspec ./spec/features/login_and_logout_spec.rb:4 # \u30ed\u30b0\u30a4\u30f3 \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f\nrspec ./spec/features/login_and_logout_spec.rb:15 # \u30ed\u30b0\u30a4\u30f3 \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557\n\n\n\u30c7\u30d0\u30c3\u30b0\n\n\n5\u884c\u306816\u884c\u304b\u3089\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u3066\u3044\u308b\u306e\u3067\u30015\u884c\u306e\u524d\u306bbinding.pry\u3092\u5165\u308c\u3066\u78ba\u8a8d\u3059\u308b\u3002\nauthenticate\u30e1\u30bd\u30c3\u30c9\u3092\u5165\u308c\u3066continue\u3067\u7d9a\u884c\u3059\u308b\u3068\u3001\u4eca\u5ea6\u306f\u30c6\u30b9\u30c8\u3092\u901a\u3063\u305f\u3002\n\n\n\nbinding.pry\nCutomer.stub(:authenticate).and_return(FactoryGirl.create(:customer))\n\n# pry\nFrom: /Users/devnote/Documents/study/oiax/spec/features/login_and_logout_spec.rb @ line 6 :\n\n     1: require 'rails_helper'\n     2:\n     3: describe '\u30ed\u30b0\u30a4\u30f3' do\n     4:   example '\u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f' do\n     5:     binding.pry\n =>  6:     Customer.stub(:authenticate).and_return(FactoryGirl.create(:customer))\n     7:     visit root_path\n     8:     within('form#new_session') do\n     9:       fill_in 'username', with: 'taro'\n    10:       fill_in 'password', with: 'correct_password'\n    11:       click_button '\u30ed\u30b0\u30a4\u30f3'\n\n[1] pry(#<RSpec::ExampleGroups::Nested>)> Customer.stub(:authenticate).and_return(FactoryGirl.create(:customer))\nRSpec::Mocks::MockExpectationError: Customer(id: integer, family_name: string, given_name: string, family_name_kana: string, given_name_kana: string, created_at: datetime, updated_at: datetime) does not implement: authenticate\nfrom /Users/devnote/Documents/study/oiax/vendor/bundle/ruby/2.2.0/gems/rspec-support-3.3.0/lib/rspec/support.rb:86:in `block in <module:Support>'\n[2] pry(#<RSpec::ExampleGroups::Nested>)> Customer.methods.grep /auth*/\n=> [:reflect_on_all_autosave_associations, :autoload, :autoload?]\n[3] pry(#<RSpec::ExampleGroups::Nested>)> Customer.class_eval do\n[3] pry(#<RSpec::ExampleGroups::Nested>)*   def self.authenticate(username, password); 'test'; end\n[3] pry(#<RSpec::ExampleGroups::Nested>)*   end\n=> :authenticate\n[4] pry(#<RSpec::ExampleGroups::Nested>)> Customer.methods.grep /auth*/\n=> [:authenticate, :reflect_on_all_autosave_associations, :autoload, :autoload?]\n[4] pry(#<RSpec::ExampleGroups::Nested>)> continue\n\n\n\n\u30c7\u30d0\u30c3\u30b0\u3067\u5206\u304b\u3063\u305f\u3053\u3068\n\nstub\u3092\u4f7f\u3063\u3066\u3082\u30c6\u30b9\u30c8\u5bfe\u8c61\uff08\u3053\u3053\u3067\u306fcustomer\u30e2\u30c7\u30eb\uff09\u306b\u4eee\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u5b9f\u88c5\u3057\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u3002\n\n\n\n\u30e2\u30c7\u30eb\u306e\u4fee\u6b63\n\n\u30c6\u30b9\u30c8\u3092\u901a\u3089\u305b\u308b\u305f\u3081\u306e\u4eee\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u5b9f\u88c5\u3059\u308b\u3002\n\n\n\ndiff --git a/app/models/customer.rb b/app/models/customer.rbindex ffd50be..903eae1 100644\n--- a/app/models/customer.rb\n+++ b/app/models/customer.rb\n@@ -16,4 +16,8 @@ class Customer < ActiveRecord::Base\n   self.family_name_kana = NKF.nkf('-wh2', family_name_kana) if family_name_kana\n   self.given_name_kana = NKF.nkf('-wh2', given_name_kana) if given_name_kana\n end\n+\n+  def self.authenticate(username, password)\n+    'test'\n+  end\n\n\n\u30b9\u30da\u30c3\u30af\u306e\u4fee\u6b63\n\n\ndeprecated\u3055\u308c\u3066\u3044\u308bstub\u306e\u4ee3\u308f\u308a\u306ballow\u301creceive\u3092\u4f7f\u3046\u3088\u3046\u306b\u4fee\u6b63\u3059\u308b\u3002\n\n\n\ndiff --git a/spec/features/login_and_logout_spec.rb b/spec/features/login_and_logout_spec.rb\nindex 0762945..4bf0558 100644\n--- a/spec/features/login_and_logout_spec.rb\n+++ b/spec/features/login_and_logout_spec.rb\n@@ -2,7 +2,7 @@ require 'rails_helper'\n\n describe '\u30ed\u30b0\u30a4\u30f3' do\n   example '\u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f' do\n-    Customer.stub(:authenticate).and_return(FactoryGirl.create(:customer))\n+    allow(Customer).to receive(:authenticate).and_return(FactoryGirl.create(:customer))\n     visit root_path\n     within('form#new_session') do\n       fill_in 'username', with: 'taro'\n@@ -13,7 +13,7 @@ describe '\u30ed\u30b0\u30a4\u30f3' do\n   end\n\n   example '\u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557' do\n-    Customer.stub(:authenticate)\n+    allow(Customer).to receive(:authenticate)\n     visit root_path\n     within('form#new_session') do\n     fill_in 'username', with: 'taro'\n\n\n\u30e2\u30c3\u30af\n\n\u30b9\u30bf\u30d6\u3092\u6301\u3064\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\nmock\uff1a\u6a21\u9020\u54c1\u3001\u507d\u7269\nmock-up\uff1a\u6a21\u578b\ndouble\uff1apure mock\u3001\u3069\u306e\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3067\u3042\u308b\u3068\u3082\u6307\u5b9a\u305b\u305a\u306b\u30e2\u30c3\u30af\u3092\u4f5c\u308a\u305f\u3044\u5834\u5408\u306b\u4f7f\u7528\u3002\n\n\n\u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u306e\u30c6\u30b9\u30c8\uff08\uff14\uff09-- YAGNI\n\nhttp://www.oiax.jp/rails/rspec_capybara_primer/signing_in4.html\n\n\nFactoryGirl::Syntax::Methods\n\nspec/rails_helper.rb\u3078\u8a2d\u5b9a\u3059\u308b\u3060\u3051\u3067\u6bce\u5ea6FactoryGirl.\u3092\u4f7f\u3046\u5fc5\u8981\u304c\u306a\u304f\u306a\u308b\u3002\n\n\nFactoryGirl.create \u2192 create\nFactoryGirl.build  \u2192 build\n\n\n\n\nexample\u306e\u30b0\u30eb\u30fc\u30d7\u5316\n\nCustomer.authenticate\u306e\u30c6\u30b9\u30c8\n\nspec\u306e\u4fee\u6b63\n\ndescribe Customer, '.authenticate' do\n  let(:customer) {create(:customer, username: 'taro', password: 'correct_password')}\n\n  example '\u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059' do\n    result = Customer.authenticate(customer.username, 'correct_password')\n    expect(result).to eq(customer)\n  end\nend\n\n\n\u30c6\u30b9\u30c8\u7d50\u679c\n\n\nusername\u304c\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u306a\u3044\u3068\u3044\u3046\u30a8\u30e9\u30fc\u304c\u8868\u793a\u3055\u308c\u308b\u3002\n\n\n\n# , + n : cursor\u304c\u3042\u308b\u3068\u3053\u308d\u306eexample\u3060\u3051\u3092\u5b9f\u884c\u3059\u308b\u3002\n  1 || Run options: include {:locations=>{\"./spec/models/customer_spec.rb\"=>[67]}}\n  2 ||\n  3 || Customer.authenticate\n  4 ||   \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059 (FAILED - 1)\n  5 ||\n  6 || Failures:\n  7 ||\n  8 spec/models/customer_spec.rb|68 error|  Failure/Error: let(:customer) {create(:customer, username: 'taro', password: 'correct_password')} NoMethodError: und\n  9 ||      # ./spec/models/customer_spec.rb:71:in `block (2 levels) in <top (required)>'\n 10 ||\n 11 || Finished in 0.02003 seconds (files took 2.87 seconds to load)\n 12 || 1 example, 1 failure\n 13 ||\n 14 || Failed examples:\n 15 ||\n 16 || rspec ./spec/models/customer_spec.rb:70 # Customer.authenticate \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059\n\n\nusername\u30ab\u30e9\u30e0\u306e\u8ffd\u52a0\n\n\u65e2\u5b58\u306e\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u30d5\u30a1\u30a4\u30eb\u3092\u4fee\u6b63\n\ndiff --git a/db/migrate/20150914060814_create_customers.rb b/db/migrate/20150914060814_create_customers.rb\nindex 4d2d6a9..ab8853b 100644\n--- a/db/migrate/20150914060814_create_customers.rb\n+++ b/db/migrate/20150914060814_create_customers.rb\n@@ -1,6 +1,7 @@\n class CreateCustomers < ActiveRecord::Migration\n   def change\n     create_table :customers do |t|\n+      t.string :username, null: false\n       t.string :family_name, null: false\n       t.string :given_name, null: false\n       t.string :family_name_kana, null: false\n\n\n\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u5b9f\u65bd\n\n\n\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u30d5\u30a1\u30a4\u30eb\u3092\u4fee\u6b63\u3057\u305f\u3089\u5f53\u305f\u308a\u524d\u306e\u624b\u9806\u306a\u306e\u3067\u899a\u3048\u3066\u304a\u304f\u3002\n\n\n\nbin/rake db:migrate:reset\nbin/rake db:test:prepare\n\n\n\u30c6\u30b9\u30c8\u7d50\u679c\n\n\npassword\u304c\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u306a\u3044\u3002\n\n\n\n[devnote@hooni:~/documents/study/oiax] % bin/rspec spec/models/customer_spec.rb:67\nRun options: include {:locations=>{\"./spec/models/customer_spec.rb\"=>[67]}}\n\nCustomer.authenticate\n  \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059 (FAILED - 1)\n\nFailures:\n\n  1) Customer.authenticate \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059\n     Failure/Error: let(:customer) {create(:customer, username: 'taro', password: 'correct_password')}\n     NoMethodError:\n       undefined method `password=' for #<Customer:0x007ff650ba1cf8>\n     # ./spec/models/customer_spec.rb:68:in `block (2 levels) in <top (required)>'\n     # ./spec/models/customer_spec.rb:71:in `block (2 levels) in <top (required)>'\n\nFinished in 0.0231 seconds (files took 2.86 seconds to load)\n1 example, 1 failure\n\nFailed examples:\n\nrspec ./spec/models/customer_spec.rb:70 # Customer.authenticate \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059\n\n\npassword\u5c5e\u6027\u306e\u5b9a\u7fa9\n\nmodel\u306e\u4fee\u6b63\n\n\n\u30c6\u30b9\u30c8\u3092\u901a\u3089\u305b\u308b\u305f\u3081\u306e\u30a2\u30af\u30bb\u30c3\u30b5\u3092\u5165\u308c\u3066\u30c6\u30b9\u30c8\u3092\u5b9f\u884c\n\n\n\ndiff --git a/app/models/customer.rb b/app/models/customer.rb\nindex 903eae1..606d1f4 100644\n--- a/app/models/customer.rb\n+++ b/app/models/customer.rb\n@@ -1,6 +1,8 @@\n require 'nkf'\n\n class Customer < ActiveRecord::Base\n+  # attr_accessor :password\n+\n   validates :family_name, presence: true, length: {maximum: 40},\n             format: {with: /\\A[\\p{Han}\\p{Hiragana}\\p{Katakana}\\u30fc]+\\z/, allow_blank: true}\n   validates :given_name, presence: true, length: {maximum: 40},\n\n\n\u30c6\u30b9\u30c8\u7d50\u679c\n\n\n\u671f\u5f85\u3057\u305f\u306e\u306fcustomer\u306e\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3060\u3063\u305f\u306e\u306b\u3001\u5b9f\u969b\u306b\u306f'test'\u3068\u3044\u3046\u6587\u5b57\u5217\u3092\u8fd4\u3057\u305f\u3002\n\n\n\n[devnote@hooni:~/documents/study/oiax] % bin/rspec spec/models/customer_spec.rb:67\nRun options: include {:locations=>{\"./spec/models/customer_spec.rb\"=>[67]}}\n\nCustomer.authenticate\n  \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059 (FAILED - 1)\n\nFailures:\n\n  1) Customer.authenticate \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059\n     Failure/Error: expect(result).to eq(customer)\n\n       expected: #<Customer id: 2, username: \"taro\", family_name: \"\u5c71\u7530\", given_name: \"\u592a\u90ce\", family_name_kana: \"\u30e4\u30de\u30c0\", given_name_kana: \"\u30bf\u30ed\u30a6\", created_at: \"2015-09-23 05:36:45\", updated_at: \"2015-09-23 05:36:45\">\n            got: \"test\"\n\n       (compared using ==)\n\n       Diff:\n       @@ -1,10 +1,2 @@\n       -#<Customer:0x007f99eb6b7880\n       - id: 2,\n       - username: \"taro\",\n       - family_name: \"\u5c71\u7530\",\n       - given_name: \"\u592a\u90ce\",\n       - family_name_kana: \"\u30e4\u30de\u30c0\",\n       - given_name_kana: \"\u30bf\u30ed\u30a6\",\n       - created_at: Wed, 23 Sep 2015 14:36:45 JST +09:00,\n       - updated_at: Wed, 23 Sep 2015 14:36:45 JST +09:00>\n       +\"test\"\n\n     # ./spec/models/customer_spec.rb:72:in `block (2 levels) in <top (required)>'\n\nFinished in 0.0577 seconds (files took 2.83 seconds to load)\n1 example, 1 failure\n\nFailed examples:\n\nrspec ./spec/models/customer_spec.rb:70 # Customer.authenticate \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059\n\n\nCustomer.authenticate\u306e\u4eee\u5b9f\u88c5\n\nmodel\u306e\u4fee\u6b63\n\ndiff --git a/app/models/customer.rb b/app/models/customer.rb\nindex 903eae1..bc677c0 100644\n--- a/app/models/customer.rb\n+++ b/app/models/customer.rb\n@@ -1,6 +1,8 @@\n require 'nkf'\n\n class Customer < ActiveRecord::Base\n+  attr_accessor :password\n+\n   validates :family_name, presence: true, length: {maximum: 40},\n             format: {with: /\\A[\\p{Han}\\p{Hiragana}\\p{Katakana}\\u30fc]+\\z/, allow_blank: true}\n   validates :given_name, presence: true, length: {maximum: 40},\n@@ -18,6 +20,6 @@ class Customer < ActiveRecord::Base\n   end\n\n   def self.authenticate(username, password)\n-    'test'\n+    find_by_username(username)\n   end\n end\n\n\n\u30c6\u30b9\u30c8\u7d50\u679c\n\n[devnote@hooni:~/documents/study/oiax] % bin/rspec spec/models/customer_spec.rb:67\nRun options: include {:locations=>{\"./spec/models/customer_spec.rb\"=>[67]}}\n\nCustomer.authenticate\n  \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059\n\nFinished in 0.03701 seconds (files took 2.82 seconds to load)\n1 example, 0 failures\n\n\nFactoryGirl\u306e\u4fee\u6b63\n\ncustomer\u30e2\u30c7\u30eb\u306e\u5168\u4f53\u30c6\u30b9\u30c8\u3092\u3059\u308b\u3068\u5931\u6557\u3057\u3066\u3057\u307e\u3046\u3002\n\u3053\u3053\u3067\u5fd8\u308c\u306a\u3044\u3088\u3046\u306b\u3082\u3046\u4e00\u5ea6\u8aac\u660e\u3059\u308b\u3002\n\n\nspec\u30d5\u30a1\u30a4\u30eb\u304b\u3089rspec\u3092\u5b9f\u884c\u3059\u308b\u3068\u304d\u3001vim\u3067\u30de\u30c3\u30d4\u30f3\u30b0\u3055\u308c\u3066\u3044\u308b\u30ad\u30fc\u3092\u4f7f\u3046\u3002\n,n \u2192 vim\u4e0a\u3067\u30ab\u30fc\u30bd\u30eb\u304c\u4f4d\u7f6e\u3055\u308c\u3066\u3044\u308bexample\u307e\u305f\u306fdescribe\u3060\u3051\u3092rspec\u3067\u5b9f\u884c\u3059\u308b\u3002\n,c \u2192 vim\u4e0a\u3067\u958b\u3044\u3066\u3044\u308b\u30d5\u30a1\u30a4\u30eb\u306e\u3059\u3079\u3066\u306eexample\u3092\u5b9f\u884c\u3059\u308b\u3002\n\u3053\u306e\u52c9\u5f37\u4f1a\u3067\u306f\u5b9f\u7fd2\u74b0\u5883\u3092\u69cb\u7bc9\u3057\u3066\u305d\u306e\u4e0a\u3067\u884c\u3063\u3066\u3044\u308b\u306e\u3067\u3001\u5b9f\u7fd2\u74b0\u5883\u304c\u69cb\u7bc9\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u306f\u81ea\u52d5\u3067\u3067\u304d\u308b\u306f\u305a\u3002\n\u5b9f\u7fd2\u74b0\u5883\u306e\u69cb\u7bc9\u306b\u3064\u3044\u3066\u306f\u300c\u52c9\u5f37\u4f1aBDD\uff1c\uff11\uff1e\u300d\u3092\u53c2\u8003\u3002\n\n\n\nFailures:\n\n  1) \u30ed\u30b0\u30a4\u30f3 \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f\n     Failure/Error: allow(Customer).to receive(:authenticate).and_return(FactoryGirl.create(:customer))\n     ActiveRecord::StatementInvalid:\n       PG::NotNullViolation: ERROR:  null value in column \"username\" violates not-null constraint\n       DETAIL:  Failing row contains (7, null, \u5c71\u7530, \u592a\u90ce, \u30e4\u30de\u30c0, \u30bf\u30ed\u30a6, 2015-09-23 14:51:06.164856, 2015-09-23 14:51:06.164856).\n       : INSERT INTO \"customers\" (\"family_name\", \"given_name\", \"family_name_kana\", \"given_name_kana\", \"created_at\", \"updated_at\") VALUES ($1, $2, $3, $4, $5, $6) RETURNING \"id\"\n     # ./spec/features/login_and_logout_spec.rb:5:in `block (2 levels) in <top (required)>'\n\n\n\u30b9\u30ad\u30fc\u30de\u306e\u5909\u66f4\u3055\u308c\u305f\u306e\u3067\u3001FactoryGirl\u306e\u4fee\u6b63\u3082\u5fc5\u8981\u3060\u3063\u305f\u3002\nspec\u306e\u4fee\u6b63\n\ndiff --git a/spec/factories/customers.rb b/spec/factories/customers.rb\nindex 3119d6b..eaddcd3 100644\n--- a/spec/factories/customers.rb\n+++ b/spec/factories/customers.rb\n@@ -1,5 +1,6 @@\n FactoryGirl.define do\n   factory :customer do\n+    username 'taro'\n     family_name '\u5c71\u7530'\n     given_name '\u592a\u90ce'\n     family_name_kana '\u30e4\u30de\u30c0'\n\n\nYAGNI\n\n\u30c6\u30b9\u30c8\u3092\u66f8\u304d\u3001\u30c6\u30b9\u30c8\u3092\u901a\u3059\u305f\u3081\u306e\u6700\u5c0f\u9650\u306e\u30b3\u30fc\u30c9\u3092\u5b9f\u88c5\u3059\u308b\u3002\n\u3053\u306e\u77ed\u3044\u30b5\u30a4\u30af\u30eb\u3092\u7e70\u308a\u8fd4\u3059\u3002\nYAGNI\uff1aYou ain't gonna need it.\uff08\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u958b\u767a\u3067\u306f\u3042\u3068\u3067\u4f7f\u3046\u3060\u308d\u3046\u3068\u601d\u3063\u3066\u4f5c\u3063\u305f\u7269\u306e\u5927\u534a\u306f\u7121\u99c4\u306b\u306a\u308b\u3002\uff09\n\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3092\u4e71\u96d1\u3057\u3001\u4fdd\u5b88\u6027\u3092\u4f4e\u4e0b\u3055\u305b\u308b\u3002\n\u30c6\u30b9\u30c8\u99c6\u52d5\u306e\u77ed\u3044\u958b\u767a\u30b5\u30a4\u30af\u30eb\u3092\u7e70\u308a\u8fd4\u3059\u3053\u3068\u3067\u3001\u4f5c\u308a\u3059\u304e\u306e\u5f0a\u5bb3\u3092\u907f\u3051\u3089\u308c\u308b\u3002\n\n\n\u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u306e\u30c6\u30b9\u30c8\uff08\uff15\uff09-- \u30d1\u30b9\u30ef\u30fc\u30c9\u60c5\u5831\u306e\u4fdd\u5b58\n\nhttp://www.oiax.jp/rails/rspec_capybara_primer/signing_in5.html\n\n\nexample\u306e\u8ffd\u52a0\n\nspec\u306e\u4fee\u6b63\n\ndiff --git a/spec/models/customer_spec.rb b/spec/models/customer_spec.rb\nindex 0304f20..cfb2687 100644\n--- a/spec/models/customer_spec.rb\n+++ b/spec/models/customer_spec.rb\n@@ -71,4 +71,14 @@ describe Customer, '.authenticate' do\n     result = Customer.authenticate(customer.username, 'correct_password')\n     expect(result).to eq(customer)\n   end\n+\n+  example '\u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u4e00\u81f4\u3057\u306a\u3044\u5834\u5408nil\u3092\u8fd4\u3059' do\n+    result = Customer.authenticate(customer.username, 'wrong_password')\n+    expect(result).to be_nil\n+  end\n+\n+  example '\u8a72\u5f53\u3059\u308b\u30e6\u30fc\u30b6\u30fc\u540d\u304c\u5b58\u5728\u3057\u306a\u3044\u5834\u5408\u306fnil\u3092\u8fd4\u3059' do\n+    result = Customer.authenticate('hanako', 'any_string')\n+    expect(result).to be_nil\n+  end\nend\n\n\n\u30c6\u30b9\u30c8\u7d50\u679c\n\n\n\u4fdd\u5b58\u5f62\u5f0f\u306e\u8a73\u7d30\u306f\u6c7a\u3081\u305a\u306b\u3001\u30c6\u30b9\u30c8\u3092\u901a\u3059\u3054\u3068\u3060\u3051\u3092\u76ee\u6307\u3057\u3066\u5b9f\u88c5\u3057\u305f\u306e\u3067\u3001\u5931\u6557\u3057\u305f\u3002\n\n\n\n  1 || Run options: include {:locations=>{\"./spec/models/customer_spec.rb\"=>[67]}}\n  2 ||\n  3 || Customer.authenticate\n  4 ||   \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059\n  5 ||   \u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u4e00\u81f4\u3057\u306a\u3044\u5834\u5408nil\u3092\u8fd4\u3059 (FAILED - 1)\n  6 ||   \u8a72\u5f53\u3059\u308b\u30e6\u30fc\u30b6\u30fc\u540d\u304c\u5b58\u5728\u3057\u306a\u3044\u5834\u5408\u306fnil\u3092\u8fd4\u3059\n  7 ||\n  8 || Failures:\n  9 ||\n 10 spec/models/customer_spec.rb|77 error|  Failure/Error: expect(result).to be_nil expected: nil got: #<Customer id: 12, username: \"taro\", family_name: \"\u5c71\u7530\",\n 11 ||\n 12 || Finished in 0.07173 seconds (files took 2.94 seconds to load)\n 13 || 3 examples, 1 failure\n 14 ||\n 15 || Failed examples:\n 16 ||\n 17 || rspec ./spec/models/customer_spec.rb:75 # Customer.authenticate \u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u4e00\u81f4\u3057\u306a\u3044\u5834\u5408nil\u3092\u8fd4\u3059\n\n\n\u30d1\u30b9\u30ef\u30fc\u30c9\u60c5\u5831\u3092\u4fdd\u5b58\u3059\u308b\u305f\u3081\u306e\u30ab\u30e9\u30e0\u3092\u8ffd\u52a0\n\nmodel\u306e\u4fee\u6b63\n\ndiff --git a/app/models/customer.rb b/app/models/customer.rb\nindex bc677c0..ab08f8b 100644\n--- a/app/models/customer.rb\n+++ b/app/models/customer.rb\n@@ -19,7 +19,16 @@ class Customer < ActiveRecord::Base\n     self.given_name_kana = NKF.nkf('-wh2', given_name_kana) if given_name_kana\n   end\n\n+  before_save do\n+    self.password_digest = password\n+  end\n+\n   def self.authenticate(username, password)\n-    find_by_username(username)\n+    customer = find_by_username(username)\n+    if customer && password == customer.password_digest\n+      customer\n+    else\n+      nil\n+    end\n   end\n end\n\n\n\u30c6\u30b9\u30c8\u7d50\u679c\n\n[devnote@hooni:~/documents/study/oiax] % bin/rspec spec/models/customer_spec.rb:83\nRun options: include {:locations=>{\"./spec/models/customer_spec.rb\"=>[83]}}\n\nCustomer.authenticate\n  \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059\n  \u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u4e00\u81f4\u3057\u306a\u3044\u5834\u5408nil\u3092\u8fd4\u3059\n  \u8a72\u5f53\u3059\u308b\u30e6\u30fc\u30b6\u30fc\u540d\u304c\u5b58\u5728\u3057\u306a\u3044\u5834\u5408\u306fnil\u3092\u8fd4\u3059\n\nFinished in 0.04363 seconds (files took 2.78 seconds to load)\n3 examples, 0 failures\n\n\n\u30d1\u30b9\u30ef\u30fc\u30c9\u60c5\u5831\u306e\u4fdd\u5b58\u306b\u95a2\u3059\u308bexample\u3092\u8ffd\u52a0\n\nspec\u306e\u4fee\u6b63\n\ndiff --git a/spec/models/customer_spec.rb b/spec/models/customer_spec.rb\nindex cfb2687..8192210 100644\n--- a/spec/models/customer_spec.rb\n+++ b/spec/models/customer_spec.rb\n@@ -64,6 +64,22 @@ describe Customer, '\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3' do\n   end\n end\n\n+describe Customer, 'password=' do\n+  let(:customer) {build(:customer, username: 'taro')}\n+\n+  example '\u751f\u6210\u3055\u308c\u305fpassword_digest\u306f60\u6587\u5b57' do\n+    customer.password = 'any_string'\n+    customer.save!\n+    expect(customer.password_digest).not_to be_nil\n+  end\n+\n+  example '\u7a7a\u6587\u5b57\u3092\u4e0e\u3048\u308b\u3068password_digest\u306fnil' do\n+    customer.password = ''\n+    customer.save!\n+    expect(customer.password_digest).to be_nil\n+  end\n+end\n+\n describe Customer, '.authenticate' do\n   let(:customer) {create(:customer, username: 'taro', password: 'correct_password')}\n\n\n\u30c6\u30b9\u30c8\u7d50\u679c\n\n\nnil\u3092\u671f\u5f85\u3057\u3066\u3044\u305f\u306e\u306b\u3001\"\"\u3092\u8fd4\u3057\u305f\u3002\n\n\n\n  1 || Run options: include {:locations=>{\"./spec/models/customer_spec.rb\"=>[67]}}\n  2 ||\n  3 || Customer password=\n  4 ||   \u751f\u6210\u3055\u308c\u305fpassword_digest\u306f60\u6587\u5b57\n  5 ||   \u7a7a\u6587\u5b57\u3092\u4e0e\u3048\u308b\u3068password_digest\u306fnil (FAILED - 1)\n  6 ||\n  7 || Failures:\n  8 ||\n  9 spec/models/customer_spec.rb|79 error|  Failure/Error: expect(customer.password_digest).to be_nil expected: nil got: \"\"\n 10 ||\n 11 || Finished in 0.04693 seconds (files took 2.74 seconds to load)\n 12 || 2 examples, 1 failure\n 13 ||\n 14 || Failed examples:\n 15 ||\n 16 || rspec ./spec/models/customer_spec.rb:76 # Customer password= \u7a7a\u6587\u5b57\u3092\u4e0e\u3048\u308b\u3068password_digest\u306fnil\n\n\nbcrypt\u306b\u3064\u3044\u3066\n\n\u3053\u3053\u3067\u306f\u30d1\u30b9\u30ef\u30fc\u30c9\u60c5\u5831\u3092\u4fdd\u6301\u3059\u308b\u305f\u3081\u306bbcrypt\u3092\u4f7f\u3046\u3002\n\nbcrypt\u3068\u306f\n\n\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u6697\u53f7\u5316\u3057\u3066\u4fdd\u6301\u3057\u3066\u304f\u308c\u308b\u3002\npassword\u3068password_confirmation\u3068\u3044\u3046\u30a2\u30c8\u30ea\u30d3\u30e5\u30fc\u30c8\u304c\u8ffd\u52a0\u3055\u308c\u3066validation\u3067\u4f7f\u3046\u3002\n\n\n\nbcrypt\u3068\u4f7f\u3046\u305f\u3081\u306b\u306f\n\npassword_digest\u3068\u3044\u3046\u30ab\u30e9\u30e0\u3092\u8ffd\u52a0\u3059\u308b\u3002\nbcrypt-ruby\u3068\u3044\u3046gem\u3092\u8ffd\u52a0\u3059\u308b\u3002\n\n\n\n\n\u30c6\u30b9\u30c8\u3092\u901a\u3059\n\ngem\u306e\u8ffd\u52a0\n\ndiff --git a/Gemfile b/Gemfile\nindex 0e5b1c6..ee310a2 100644\n--- a/Gemfile\n+++ b/Gemfile\n@@ -8,6 +8,7 @@ gem 'jquery-rails'\n gem 'turbolinks'\n gem 'jbuilder', '~> 2.0'\n gem 'sdoc', '~> 0.4.0', group: :doc\n+gem 'bcrypt-ruby'\n\n # Memcached Client\n gem 'dalli'\n\n\nmodel\u306e\u4fee\u6b63\n\ndiff --git a/app/models/customer.rb b/app/models/customer.rb\nindex bc677c0..9c7a21c 100644\n--- a/app/models/customer.rb\n+++ b/app/models/customer.rb\n@@ -1,4 +1,5 @@\n require 'nkf'\n+require 'bcrypt'\n\n class Customer < ActiveRecord::Base\n   attr_accessor :password\n@@ -19,7 +20,16 @@ class Customer < ActiveRecord::Base\n     self.given_name_kana = NKF.nkf('-wh2', given_name_kana) if given_name_kana\n   end\n\n+  before_save do\n+    self.password_digest = password if password.present?\n+  end\n+\n   def self.authenticate(username, password)\n-    find_by_username(username)\n+    customer = find_by_username(username)\n+    if customer && BCrypt::Password.new(customer.password_digest) == customer.password\n+      customer\n+    else\n+      nil\n+    end\n   end\n\n\n\u30c6\u30b9\u30c8\u7d50\u679c\n\n[devnote@hooni:~/documents/study/oiax] % bin/rspec spec/models/customer_spec.rb:67\nRun options: include {:locations=>{\"./spec/models/customer_spec.rb\"=>[67]}}\n\nCustomer password=\n  \u751f\u6210\u3055\u308c\u305fpassword_digest\u306f60\u6587\u5b57\n  \u7a7a\u6587\u5b57\u3092\u4e0e\u3048\u308b\u3068password_digest\u306fnil\n\nFinished in 0.0356 seconds (files took 3.06 seconds to load)\n2 examples, 0 failures\n\n\n\u88dc\u8db3\n\n\nBCrypt::Password.new(customer.password_digest) == customer.password\n\u4e00\u898b\u3059\u308b\u3068\u6697\u53f7\u5316\u3055\u308c\u3066\u3044\u308b\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u5fa9\u53f7\u5316\u3057\u3066\u5e73\u6587\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u3068\u6bd4\u8f03\u3057\u3066\u3044\u308b\u3002\n\u5e73\u6587\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u6697\u53f7\u5316\u3057\u3066DB\u4e0a\u306e\u6697\u53f7\u5316\u3055\u308c\u3066\u3044\u308b\u30d1\u30b9\u30ef\u30fc\u30c9\u3068\u4e00\u81f4\u3059\u308b\u306e\u304b\u78ba\u8a8d\u3059\u308b\u306e\u304c\u4e00\u822c\u7684\u3060\u3002\n\u305d\u308c\u306a\u306e\u306b\u306a\u305c\u305d\u3046\u3060\u308d\u3046\u304b\uff1f\nbefore_save\u306epassword\u306f\u3059\u3067\u306bbcrypt\u306b\u3088\u3063\u3066\u6697\u53f7\u5316\u3055\u308c\u305f\u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u4fdd\u6301\u3055\u308c\u3066\u3044\u308b\u3002\nbcrypt\u306e\u4e2d\u3092\u8997\u3044\u3066\u307f\u308b\u3068==(\u5f15\u6570)\u304c\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3055\u308c\u3066\u3044\u3066\u5f15\u6570\u3092\u6697\u53f7\u5316\u3057\u6bd4\u8f03\u3057\u3066\u3044\u308b\u3002\n\u52c9\u5f37\u4f1a\u3067\u3053\u3093\u306a\u8cea\u554f\u304c\u3042\u3063\u305f\u306e\u3067\u88dc\u8db3\u3067\u8ffd\u8a18\u3059\u308b\u3002\n\n\n\n\n\u30c6\u30b9\u30c8\u306e\u7a74\u3092\u57cb\u3081\u308b\u3002\n\nspec\u306e\u4fee\u6b63\n\ndiff --git a/spec/models/customer_spec.rb b/spec/models/customer_spec.rb\nindex 8192210..7297bf7 100644\n--- a/spec/models/customer_spec.rb\n+++ b/spec/models/customer_spec.rb\n@@ -97,4 +97,10 @@ describe Customer, '.authenticate' do\n     result = Customer.authenticate('hanako', 'any_string')\n     expect(result).to be_nil\n   end\n+\n+  example '\u30d1\u30b9\u30ef\u30fc\u30c9\u672a\u8a2d\u5b9a\u306e\u30e6\u30fc\u30b6\u30fc\u3092\u62d2\u7d76\u3059\u308b' do\n+    customer.update_column(:password_digest, nil)\n+    result = Customer.authenticate(customer.username, '')\n+    expect(result).to be_nil\n+  end\nend\n\n\n\u30c6\u30b9\u30c8\u306e\u7d50\u679c\n\n[devnote@hooni:~/documents/study/oiax] % bin/rspec spec/models/customer_spec.rb:83\nRun options: include {:locations=>{\"./spec/models/customer_spec.rb\"=>[83]}}\n\nCustomer.authenticate\n  \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059 (FAILED - 1)\n  \u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u4e00\u81f4\u3057\u306a\u3044\u5834\u5408nil\u3092\u8fd4\u3059 (FAILED - 2)\n  \u8a72\u5f53\u3059\u308b\u30e6\u30fc\u30b6\u30fc\u540d\u304c\u5b58\u5728\u3057\u306a\u3044\u5834\u5408\u306fnil\u3092\u8fd4\u3059\n  \u30d1\u30b9\u30ef\u30fc\u30c9\u672a\u8a2d\u5b9a\u306e\u30e6\u30fc\u30b6\u30fc\u3092\u62d2\u7d76\u3059\u308b (FAILED - 3)\n\nFailures:\n\n  1) Customer.authenticate \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059\n     Failure/Error: result = Customer.authenticate(customer.username, 'correct_password')\n     BCrypt::Errors::InvalidHash:\n       invalid hash\n     # ./app/models/customer.rb:29:in `new'\n     # ./app/models/customer.rb:29:in `authenticate'\n     # ./spec/models/customer_spec.rb:87:in `block (2 levels) in <top (required)>'\n\n  2) Customer.authenticate \u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u4e00\u81f4\u3057\u306a\u3044\u5834\u5408nil\u3092\u8fd4\u3059\n     Failure/Error: result = Customer.authenticate(customer.username, 'wrong_password')\n     BCrypt::Errors::InvalidHash:\n       invalid hash\n     # ./app/models/customer.rb:29:in `new'\n     # ./app/models/customer.rb:29:in `authenticate'\n     # ./spec/models/customer_spec.rb:92:in `block (2 levels) in <top (required)>'\n\n  3) Customer.authenticate \u30d1\u30b9\u30ef\u30fc\u30c9\u672a\u8a2d\u5b9a\u306e\u30e6\u30fc\u30b6\u30fc\u3092\u62d2\u7d76\u3059\u308b\n     Failure/Error: result = Customer.authenticate(customer.username, '')\n     BCrypt::Errors::InvalidHash:\n       invalid hash\n     # ./app/models/customer.rb:29:in `new'\n     # ./app/models/customer.rb:29:in `authenticate'\n     # ./spec/models/customer_spec.rb:103:in `block (2 levels) in <top (required)>'\n\nFinished in 0.0581 seconds (files took 2.91 seconds to load)\n4 examples, 3 failures\n\nFailed examples:\n\nrspec ./spec/models/customer_spec.rb:86 # Customer.authenticate \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059\nrspec ./spec/models/customer_spec.rb:91 # Customer.authenticate \u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u4e00\u81f4\u3057\u306a\u3044\u5834\u5408nil\u3092\u8fd4\u3059\nrspec ./spec/models/customer_spec.rb:101 # Customer.authenticate \u30d1\u30b9\u30ef\u30fc\u30c9\u672a\u8a2d\u5b9a\u306e\u30e6\u30fc\u30b6\u30fc\u3092\u62d2\u7d76\u3059\u308b\n\n\n\u30c6\u30b9\u30c8\u3092\u901a\u3059\n\nmodel\u306e\u4fee\u6b63\n\ndiff --git a/app/models/customer.rb b/app/models/customer.rb\nindex 9c7a21c..415f442 100644\n--- a/app/models/customer.rb\n+++ b/app/models/customer.rb\n@@ -26,7 +26,7 @@ class Customer < ActiveRecord::Base\n\n   def self.authenticate(username, password)\n     customer = find_by_username(username)\n-    if customer && BCrypt::Password.new(customer.password_digest) == customer.password\n+    if customer.try(:password_digest) && BCrypt::Password.new(customer.password_digest) == password\n       customer\n     else\n       nil\n\n\n\u30c6\u30b9\u30c8\u7d50\u679c\n\n\n\u624b\u9806\u901a\u308a\u306b\u3084\u3063\u3066\u3082\u30c6\u30b9\u30c8\u304c\u901a\u3089\u306a\u3044\u3002\n\n\n\n[devnote@hooni:~/documents/study/oiax] % bin/rspec spec/models/customer_spec.rb:83\nRun options: include {:locations=>{\"./spec/models/customer_spec.rb\"=>[83]}}\n\nCustomer.authenticate\n\u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059 (FAILED - 1)\n\u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u4e00\u81f4\u3057\u306a\u3044\u5834\u5408nil\u3092\u8fd4\u3059 (FAILED - 2)\n\u8a72\u5f53\u3059\u308b\u30e6\u30fc\u30b6\u30fc\u540d\u304c\u5b58\u5728\u3057\u306a\u3044\u5834\u5408\u306fnil\u3092\u8fd4\u3059\n\u30d1\u30b9\u30ef\u30fc\u30c9\u672a\u8a2d\u5b9a\u306e\u30e6\u30fc\u30b6\u30fc\u3092\u62d2\u7d76\u3059\u308b\n\nFailures:\n\n1) Customer.authenticate \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059\n   Failure/Error: result = Customer.authenticate(customer.username, 'correct_password')\n   BCrypt::Errors::InvalidHash:\n     invalid hash\n   # ./app/models/customer.rb:29:in `new'\n   # ./app/models/customer.rb:29:in `authenticate'\n   # ./spec/models/customer_spec.rb:88:in `block (2 levels) in <top (required)>'\n\n2) Customer.authenticate \u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u4e00\u81f4\u3057\u306a\u3044\u5834\u5408nil\u3092\u8fd4\u3059\n   Failure/Error: result = Customer.authenticate(customer.username, 'wrong_password')\n   BCrypt::Errors::InvalidHash:\n     invalid hash\n   # ./app/models/customer.rb:29:in `new'\n   # ./app/models/customer.rb:29:in `authenticate'\n   # ./spec/models/customer_spec.rb:93:in `block (2 levels) in <top (required)>'\n\nFinished in 0.05406 seconds (files took 3 seconds to load)\n4 examples, 2 failures\n\nFailed examples:\n\nrspec ./spec/models/customer_spec.rb:87 # Customer.authenticate \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059\nrspec ./spec/models/customer_spec.rb:92 # Customer.authenticate \u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u4e00\u81f4\u3057\u306a\u3044\u5834\u5408nil\u3092\u8fd4\u3059\n\n\nspec\u306e\u4fee\u6b63\n\n\n\u30c6\u30b9\u30c8\u30b3\u30fc\u30c9\u306b\u4e0d\u5177\u5408\u304c\u3042\u3063\u305f\u306e\u3067\u3001\u4fee\u6b63\u3059\u308b\u3002\n\n\n\ndiff --git a/spec/models/customer_spec.rb b/spec/models/customer_spec.rb\nindex 8192210..ab59045 100644\n--- a/spec/models/customer_spec.rb\n+++ b/spec/models/customer_spec.rb\n@@ -81,7 +81,7 @@ describe Customer, 'password=' do\n end\n\n describe Customer, '.authenticate' do\n-  let(:customer) {create(:customer, username: 'taro', password: 'correct_password')}\n+  let(:customer) {create(:customer, username: 'taro', password: BCrypt::Password.create('correct_password'))}\n\n\n\u518d\u30c6\u30b9\u30c8\u7d50\u679c\n\n[devnote@hooni:~/documents/study/oiax] % bin/rspec spec/models/customer_spec.rb:83\nRun options: include {:locations=>{\"./spec/models/customer_spec.rb\"=>[83]}}\n\nCustomer.authenticate\n  \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059\n  \u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u4e00\u81f4\u3057\u306a\u3044\u5834\u5408nil\u3092\u8fd4\u3059\n  \u8a72\u5f53\u3059\u308b\u30e6\u30fc\u30b6\u30fc\u540d\u304c\u5b58\u5728\u3057\u306a\u3044\u5834\u5408\u306fnil\u3092\u8fd4\u3059\n  \u30d1\u30b9\u30ef\u30fc\u30c9\u672a\u8a2d\u5b9a\u306e\u30e6\u30fc\u30b6\u30fc\u3092\u62d2\u7d76\u3059\u308b\n\nFinished in 0.56011 seconds (files took 2.8 seconds to load)\n4 examples, 0 failures\n\n\n\u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u306e\u30c6\u30b9\u30c8\uff08\uff16\uff09-- \u30b9\u30bf\u30d6\u3092\u5916\u3059\n\nhttp://www.oiax.jp/rails/rspec_capybara_primer/signing_in6.html\n\n\n\u30b9\u30bf\u30d6\u3092\u5916\u3059\n\nspec\u306e\u4fee\u6b63\n\ndiff --git a/spec/features/login_and_logout_spec.rb b/spec/features/login_and_logout_spec.rb\nindex 4bf0558..096dedd 100644\n--- a/spec/features/login_and_logout_spec.rb\n+++ b/spec/features/login_and_logout_spec.rb\n@@ -1,8 +1,9 @@\n require 'rails_helper'\n\n describe '\u30ed\u30b0\u30a4\u30f3' do\n+  before { create(:customer, username: 'taro', password: BCrypt::Password.create('correct_password')) }\n   example '\u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f' do\n-    allow(Customer).to receive(:authenticate).and_return(FactoryGirl.create(:customer))\n+    # allow(Customer).to receive(:authenticate).and_return(FactoryGirl.create(:customer))\n     visit root_path\n     within('form#new_session') do\n       fill_in 'username', with: 'taro'\n@@ -13,7 +14,7 @@ describe '\u30ed\u30b0\u30a4\u30f3' do\n   end\n\n   example '\u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557' do\n-    allow(Customer).to receive(:authenticate)\n+    # allow(Customer).to receive(:authenticate)\n     visit root_path\n     within('form#new_session') do\n       fill_in 'username', with: 'taro'\n\n\n\u30c6\u30b9\u30c8\u7d50\u679c\n\n[devnote@hooni:~/documents/study/oiax] % bin/rspec spec/features/login_and_logout_spec.rb\n\n\u30ed\u30b0\u30a4\u30f3\n  \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f\n  \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557\n\nFinished in 0.70919 seconds (files took 2.88 seconds to load)\n2 examples, 0 failures\n\n\n\u8981\u70b9\n\n\u30c6\u30b9\u30c8\u3092\u901a\u3059\u306e\u306b\u5fc5\u8981\u6700\u5c0f\u9650\u306e\u30b3\u30fc\u30c9\u3092\u66f8\u304f\u3002\nexample\u306e\u8ffd\u52a0\u3068\u30e1\u30bd\u30c3\u30c9\u306e\u4eee\u5b9f\u88c5\u53ca\u3073\u30b9\u30bf\u30d6\u5316\u3092\u7e70\u308a\u8fd4\u3059\u3002\n\u6700\u7d42\u7684\u306b\u306f\u8907\u96d1\u306a\u6a5f\u80fd\u3092\u6301\u3064\u30af\u30e9\u30b9\u3068\u30e1\u30bd\u30c3\u30c9\u3092\u5b8c\u6210\u3059\u308b\u3002\n\n\n\u30b5\u30f3\u30d7\u30eb\u306e\u624b\u9806\uff08\u5916\u5074 -> \u5185\u5074 -> \u5916\u5074\uff09\n\n\u5916\u5074\u306e\u30e6\u30fc\u30b6\u30fc\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u304b\u3089\u5b9f\u88c5\u3092\u59cb\u3081\u308b\u3002\uff08view\uff09\n\u5fc5\u8981\u306a\u6a5f\u80fd\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u5b9f\u88c5\u3059\u308b\u3002\uff08controller\uff09\n\u60c5\u5831\u306e\u4fdd\u5b58\u3044\u3046\u6700\u3082\u5185\u5074\u306e\u6a5f\u80fd\u3092\u5b9f\u88c5\u3059\u308b\u3002\uff08model\uff09\n\u9006\u9806\u3067\u9061\u308b\u3002\u5fc5\u8981\u306a\u6a5f\u80fd\u306e\u30e1\u30bd\u30c3\u30c9\u306e\u4ed5\u4e0a\u3052\u3092\u3059\u308b\u3002\n\u30e6\u30fc\u30b6\u30fc\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u306e\u30c6\u30b9\u30c8\u304b\u3089\u30b9\u30bf\u30d6\u3092\u5916\u3059\u3002\n\n\n## \u95a2\u9023\u8a18\u4e8b\n\n* [\u52c9\u5f37\u4f1aBDD\uff1c\uff11\uff1eRSpec\u3068Capybara\u30fc\u30b9\u30bf\u30fc\u30c8](http://qiita.com/park-jh/items/a6327a96e771857bc78c)\n* [\u52c9\u5f37\u4f1aBDD\uff1c\uff12\uff1eRSpec\u3068Capybara\u30fc\u30e2\u30c7\u30eb](http://qiita.com/park-jh/items/07a9367f0bd94abc528b)\n* \u52c9\u5f37\u4f1aBDD\uff1c\uff13\uff1eRSpec\u3068Capybara\u30fc\u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\n* [\u52c9\u5f37\u4f1aBDD\uff1c\uff14\uff1eRSpec\u3068Capybara\u30fc\u30dd\u30a4\u30f3\u30c8\u30b7\u30b9\u30c6\u30e0](http://qiita.com/park-jh/items/7726820d950f03f8b061)\n\n## \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u306e\u30c6\u30b9\u30c8\uff08\uff11\uff09\n\ncustomer_spec\u3092\u4fee\u6b63\u3059\u308b\u3002\u8a73\u7d30\u5185\u5bb9\u306f\u6b21\u306e\u30ea\u30f3\u30af\u3092\u3054\u53c2\u8003\u306b\u3057\u3066\u3044\u305f\u3060\u304d\u305f\u3044\u3002\n\n* http://www.oiax.jp/rails/rspec_capybara_primer/signing_in1.html\n\n### \u5bbf\u984c\n\n```diff\ndiff --git a/spec/models/customer_spec.rb b/spec/models/customer_spec.rb\nindex 9c35634..91556e5 100644\n--- a/spec/models/customer_spec.rb\n+++ b/spec/models/customer_spec.rb\n@@ -19,6 +19,12 @@ RSpec.describe Customer, type: :model do\n       expect(customer).not_to be_valid\n       expect(customer.errors[column_name]).to be_present\n     end\n+\n+    example \"#{column_name}\u306b\u542b\u307e\u308c\u308b\u534a\u89d2\u30ab\u30ca\u306f\u5168\u89d2\u30ab\u30ca\u306b\u4ea4\u63db\u3057\u3066\u53d7\u3051\u5165\u308c\u308b\" do\n+      customer[column_name] = '\uff71\uff72\uff73'\n+      expect(customer).to be_valid\n+      expect(customer[column_name]).to eq('\u30a2\u30a4\u30a6')\n+    end\n   end\n\n   %w{family_name given_name}.each do |column_name|\n@@ -28,7 +34,7 @@ RSpec.describe Customer, type: :model do\n     end\n\n     example \"#{column_name}\u306f\u6f22\u5b57\u3001\u3072\u3089\u304c\u306a\u3001\u30ab\u30bf\u30ab\u30ca\u4ee5\u5916\u306e\u6587\u5b57\u3092\u542b\u307e\u306a\u3044\" do\n-      ['A', '1', '@'].each do |value|\n+      %w(A 1 @).each do |value|\n         customer[column_name] = value\n         expect(customer).not_to be_valid\n         expect(customer[column_name]).to be_present\n@@ -37,6 +43,19 @@ RSpec.describe Customer, type: :model do\n   end\n\n   %w(family_name_kana given_name_kana).each do |column_name|\n+    example \"#{column_name}\u306f\u30ab\u30bf\u30ab\u30ca\u3092\u542b\u3093\u3067\u3082\u826f\u3044\" do\n+      customer[column_name] = '\u30a2\u30a4\u30a6'\n+      expect(customer).to be_valid\n+    end\n+\n+    example \"#{column_name}\u306f\u30ab\u30bf\u30ab\u30ca\u4ee5\u5916\u306e\u6587\u5b57\u3092\u542b\u307e\u306a\u3044\" do\n+      %w(\u4e9c A 1 @).each do |value|\n+        customer[column_name] = value\n+        expect(customer).not_to be_valid\n+        expect(customer.errors[column_name]).to be_present\n+      end\n+    end\n+\n     example \"#{column_name}\u306b\u542b\u307e\u308c\u308b\u3072\u3089\u304c\u306a\u306f\u30ab\u30bf\u30ab\u30ca\u306b\u4ea4\u63db\u3057\u3066\u53d7\u3051\u5165\u308c\u308b\" do\n       customer[column_name] = '\u3042\u3044\u3046'\n       expect(customer).to be_valid\n\ndiff --git a/app/models/customer.rb b/app/models/customer.rb\nindex f83df81..ffd50be 100644\n--- a/app/models/customer.rb\n+++ b/app/models/customer.rb\n@@ -5,10 +5,14 @@ class Customer < ActiveRecord::Base\n             format: {with: /\\A[\\p{Han}\\p{Hiragana}\\p{Katakana}\\u30fc]+\\z/, allow_blank: true}\n   validates :given_name, presence: true, length: {maximum: 40},\n             format: {with: /\\A[\\p{Han}\\p{Hiragana}\\p{Katakana}\\u30fc]+\\z/, allow_blank: true}\n-  validates :family_name_kana, presence: true, length: {maximum: 40}\n-  validates :given_name_kana, presence: true, length: {maximum: 40}\n+  validates :family_name_kana, presence: true, length: {maximum: 40},\n+            format: {with: /\\A\\p{Katakana}+\\z/, allow_blank: true}\n+  validates :given_name_kana, presence: true, length: {maximum: 40},\n+            format: {with: /\\A\\p{Katakana}+\\z/, allow_blank: true}\n\n   before_validation do\n+    self.family_name = NKF.nkf('-w', family_name) if family_name\n+    self.given_name = NKF.nkf('-w', given_name) if given_name\n     self.family_name_kana = NKF.nkf('-wh2', family_name_kana) if family_name_kana\n     self.given_name_kana = NKF.nkf('-wh2', given_name_kana) if given_name_kana\n   end\n```\n\n### \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6a5f\u80fd\u306e\u4ed5\u69d8\n\n* \u30ed\u30b0\u30a4\u30f3\u524d\u306e\u30e6\u30fc\u30b6\u30fc\u304c\u30c8\u30c3\u30d7\u30da\u30fc\u30b8\u306eURL\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001\u901a\u5e38\u306e\u30c8\u30c3\u30d7\u30da\u30fc\u30b8\u306e\u4ee3\u308f\u308a\u306b\u30ed\u30b0\u30a4\u30f3\u30d5\u30a9\u30fc\u30e0\u304c\u8868\u793a\u3055\u308c\u308b\u3002\n* \u30e6\u30fc\u30b6\u30fc\u304c\u30ed\u30b0\u30a4\u30f3\u30d5\u30a9\u30fc\u30e0\u306b\u6b63\u3057\u3044\u30e6\u30fc\u30b6\u30fc\u540d\uff08username\uff09\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\uff08password\uff09\u3092\u5165\u529b\u3057\u3066\u300c\u30ed\u30b0\u30a4\u30f3\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068\u3001\u901a\u5e38\u306e\u30c8\u30c3\u30d7\u30da\u30fc\u30b8\u304c\u8868\u793a\u3055\u308c\u308b\u3002\n* \u30ed\u30b0\u30a4\u30f3\u306b\u5931\u6557\u3057\u305f\u5834\u5408\u306f\u3001\u300c\u30e6\u30fc\u30b6\u30fc\u540d\u307e\u305f\u306f\u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u6b63\u3057\u304f\u3042\u308a\u307e\u305b\u3093\u3002\u300d\u3068\u3044\u3046\u30e1\u30c3\u30bb\u30fc\u30b8\u3068\u30ed\u30b0\u30a4\u30f3\u30d5\u30a9\u30fc\u30e0\u304c\u8868\u793a\u3055\u308c\u308b\u3002\n* \u30e6\u30fc\u30b6\u30fc\u304c\u30c8\u30c3\u30d7\u30da\u30fc\u30b8\u306e\u300c\u30ed\u30b0\u30a2\u30a6\u30c8\u300d\u30ea\u30f3\u30af\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068\u3001\u300c\u672c\u5f53\u306b\u30ed\u30b0\u30a2\u30a6\u30c8\u3057\u307e\u3059\u304b\uff1f\u300d\u3068\u3044\u3046\u8b66\u544a\u30c0\u30a4\u30a2\u30ed\u30b0\u304c\u8868\u793a\u3055\u308c\u3001\u300cOK\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068\u3001\u300c\u30ed\u30b0\u30a2\u30a6\u30c8\u3057\u307e\u3057\u305f\u300d\u3068\u3044\u3046\u30e1\u30c3\u30bb\u30fc\u30b8\u3068\u30ed\u30b0\u30a4\u30f3\u30d5\u30a9\u30fc\u30e0\u304c\u8868\u793a\u3055\u308c\u308b\u3002\n* \u30e6\u30fc\u30b6\u30fc\u304c\u30ed\u30b0\u30a4\u30f3\u306b\u6210\u529f\u3059\u308b\u3068\u3001\u300c\u30ed\u30b0\u30a4\u30f3\u30dd\u30a4\u30f3\u30c8\u300d\u3068\u3057\u3066\u30e6\u30fc\u30b6\u30fc\u306b\uff11\u30dd\u30a4\u30f3\u30c8\u304c\u4e0e\u3048\u3089\u308c\u308b\u3002\n* \u305f\u3060\u3057\u3001\u300c\u30ed\u30b0\u30a4\u30f3\u30dd\u30a4\u30f3\u30c8\u300d\u306f\u30e6\u30fc\u30b6\u30fc\u3054\u3068\u306b\uff11\u65e5\uff11\u56de\u3057\u304b\u4e0e\u3048\u3089\u308c\u306a\u3044\u3002\u65e5\u306e\u533a\u5207\u308a\u306f\u65e5\u672c\u6642\u9593\u5348\u524d\uff15\u6642\u3068\u3059\u308b\u3002\n* \u307e\u305f\u3001\u571f\u66dc\u65e5\u306b\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u3068\u3001\u901a\u5e38\u306e\u300c\u30ed\u30b0\u30a4\u30f3\u30dd\u30a4\u30f3\u30c8\u300d\u306e\u4ed6\u306b\u300c\u571f\u66dc\u30ed\u30b0\u30a4\u30f3\u30dc\u30fc\u30ca\u30b9\u300d\u3068\u3057\u3066\uff12\u30dd\u30a4\u30f3\u30c8\u304c\u4e0e\u3048\u3089\u308c\u308b\u3002\n\n### Outside-In\n\n* \u30d3\u30d8\u30a4\u30d3\u30a2\u99c6\u52d5\u958b\u767a\u306e\u539f\u5247\u306e1\u3064\n* \u5916\u5074\uff08\u30e6\u30fc\u30b6\u30fc\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u306a\u3069\uff09\u304b\u3089\u5185\u5074\uff08\u30d3\u30b8\u30cd\u30b9\u30ed\u30b8\u30c3\u30af\u3084\u30c7\u30fc\u30bf\u69cb\u9020\uff09\u306b\u5411\u304b\u3063\u3066\u5b9f\u88c5\u3092\u9032\u3081\u308b\u3002\n\n### \u30ed\u30b0\u30a4\u30f3\u6a5f\u80fd\u306e\u30c6\u30b9\u30c8\n\n```ruby\n# spec/features/login_and_logout_spec.rb\n\nrequire 'rails_helper'\n\ndescribe '\u30ed\u30b0\u30a4\u30f3' do\n  example '\u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f' do\n    visit root_path\n    within('form#new_session') do\n      fill_in 'username', with: 'taro'\n      fill_in 'password', with: 'correct_password'\n      click_button '\u30ed\u30b0\u30a4\u30f3'\n    end\n    expect(page).not_to have_css('form#new_session')\n  end\n\n  example '\u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557' do\n    visit root_path\n    within('form#new_session') do\n      fill_in 'username', with: 'taro'\n      fill_in 'password', with: 'wrong_password'\n      click_button '\u30ed\u30b0\u30a4\u30f3'\n    end\n    expect(page).to have_css('p.alert', text: '\u30e6\u30fc\u30b6\u30fc\u540d\u307e\u305f\u306f\u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u6b63\u3057\u304f\u3042\u308a\u307e\u305b\u3093\u3002')\n    expect(page).to have_css('form#new_session')\n  end\nend \n```\n\n### \u30c6\u30b9\u30c8\u7d50\u679c\n\n```\n  1 || /home/vagrant/study/oiax/db/schema.rb doesn't exist yet. Run `rake db:migrate` to create it, then try again. If you do not intend to use a database, you\n  2 ||\n  3 || \u30ed\u30b0\u30a4\u30f3\n  4 ||   \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f (FAILED - 1)\n  5 ||   \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557 (FAILED - 2)\n  6 ||\n  7 || Failures:\n  8 ||\n  9 spec/features/login_and_logout_spec.rb|5 error|  Failure/Error: visit root_path NameError: undefined local variable or method `root_path' for #<RSpec::Examp\n 10 ||\n 11 spec/features/login_and_logout_spec.rb|15 error|  Failure/Error: visit root_path NameError: undefined local variable or method `root_path' for #<RSpec::Exam\n 12 ||\n 13 || Finished in 0.02823 seconds (files took 5.27 seconds to load)\n 14 || 2 examples, 2 failures\n 15 ||\n 16 || Failed examples:\n 17 ||\n 18 || rspec ./spec/features/login_and_logout_spec.rb:4 # \u30ed\u30b0\u30a4\u30f3 \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f\n 19 || rspec ./spec/features/login_and_logout_spec.rb:14 # \u30ed\u30b0\u30a4\u30f3 \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557\n```\n\n## \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u306e\u30c6\u30b9\u30c8\uff08\uff12\uff09--\u30a2\u30af\u30b7\u30e7\u30f3\u306e\u4eee\u5b9f\u88c5\n\n* http://www.oiax.jp/rails/rspec_capybara_primer/signing_in2.html\n\n### \u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3001\u305d\u3057\u3066\u30a2\u30af\u30b7\u30e7\u30f3\u306e\u4eee\u5b9f\u88c5\n\n* \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u3092\u884c\u3046\u30a2\u30af\u30b7\u30e7\u30f3\u3001URL\u3001HTTP\u30e1\u30bd\u30c3\u30c9\u306e\u7a2e\u985e\u3092\u6c7a\u3081\u308b\u3002\n\n```\nsessions#create POST /login\n```\n\n* \u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u4fee\u6b63\n\n```ruby\n# config/routes.rb\npost 'login' => 'sessions#create', as: :login\n```\n\n* controller\u306e\u4f5c\u6210\n\n```ruby\n# app/controllers/sessions_controller.rb\nclass SessionsController < ApplicationController\n  def create\n    redirect_to :root\n  end\nend\n```\n\n* view\u306e\u4f5c\u6210\n\n```ruby\n# app/views/top/_login_form.html.erb\n<%= form_tag :login, id: 'new_session' do %>\n  <div>\n    <%= label_tag 'username', '\u30e6\u30fc\u30b6\u30fc\u540d' %>\n    <%= text_field_tag 'username' %>\n  </div>\n  <div>\n    <%= label_tag 'password', '\u30d1\u30b9\u30ef\u30fc\u30c9' %>\n    <%= password_field_tag 'password' %>\n  </div>\n  <div>\n    <%= submit_tag '\u30ed\u30b0\u30a4\u30f3' %>\n  </div>\n<% end %>\n\n# bin/erb2slim \u30b3\u30de\u30f3\u30c9\u3067\u81ea\u52d5\u5909\u63db\u53ef\u80fd\n# usage: bin/erb2slim -d app/views\n# erb\u3068slim\u304c\u4e00\u7dd2\u306b\u5b58\u5728\u3059\u308b\u5834\u5408\u3001slim\u3088\u308aerb\u3092\u512a\u5148\u3059\u308b\u3002\n# -d\u30aa\u30d7\u30b7\u30e7\u30f3\u306ferb\u30d5\u30a1\u30a4\u30eb\u3092slim\u306b\u5909\u63db\u3057\u305f\u5f8c\u3001erb\u30d5\u30a1\u30a4\u30eb\u3092\u6d88\u3059\u3002\n# app/views/top/_login_form.html.slim\n= form_tag :login, id: 'new_session' do\n  div\n    = label_tag 'username', '\u30e6\u30fc\u30b6\u30fc\u540d'\n    = text_field_tag 'username'\n  div\n    = label_tag 'password', '\u30d1\u30b9\u30ef\u30fc\u30c9'\n    = password_field_tag 'password'\n  div\n    = submit_tag '\u30ed\u30b0\u30a4\u30f3'\n```\n\n### \u30c6\u30b9\u30c8\u7d50\u679c\n\n* rake db:migrate\u3092\u3057\u306a\u3044\u3068schema.rb\u30d5\u30a1\u30a4\u30eb\u304c\u751f\u6210\u3055\u308c\u306a\u3044\u307f\u305f\u3044\u3002\n* migration\u30d5\u30a1\u30a4\u30eb\u304c\u5b58\u5728\u3057\u306a\u304f\u3066\u3082RSpec\u3092\u5b9f\u884c\u3059\u308b\u305f\u3073\u306b\u3053\u3093\u306a\u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u8868\u793a\u3055\u308c\u308b\u306e\u306f\u3088\u304f\u306a\u3044\u306e\u3067\u3001\n* rake db:migrate\u3092\u5b9f\u884c\u3002\n\n```\n  1 || /home/vagrant/study/oiax/db/schema.rb doesn't exist yet. Run `rake db:migrate` to create it, then try again. If you do not intend to use a database, you\n  2 ||\n  3 || \u30ed\u30b0\u30a4\u30f3\n  4 ||   \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f (FAILED - 1)\n  5 ||   \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557 (FAILED - 2)\n  6 ||\n  7 || Failures:\n  8 ||\n  9 spec/features/login_and_logout_spec.rb|11 error|  Failure/Error: expect(page).not_to have_css('form#new_session') expected not to find css \"form#new_session\n 10 ||\n 11 spec/features/login_and_logout_spec.rb|21 error|  Failure/Error: expect(page).to have_css('p.alert', text: '\u30e6\u30fc\u30b6\u30fc\u540d\u307e\u305f\u306f\u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u6b63\u3057\u304f\u3042\u308a\u307e\u305b\u3093\u3002')\n 12 ||\n 13 || Finished in 0.52518 seconds (files took 5.73 seconds to load)\n 14 || 2 examples, 2 failures\n 15 ||\n 16 || Failed examples:\n 17 ||\n 18 || rspec ./spec/features/login_and_logout_spec.rb:4 # \u30ed\u30b0\u30a4\u30f3 \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f\n 19 || rspec ./spec/features/login_and_logout_spec.rb:14 # \u30ed\u30b0\u30a4\u30f3 \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557\n```\n\n### \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557\u30b7\u30ca\u30ea\u30aa\u306e\u5b9f\u88c5\n\n* controller\u306e\u4fee\u6b63\n\n```ruby\n# app/controllers/sessions_controller.rb\nclass SessionsController < ApplicationController\n  def create\n    if false\n      # \u672a\u5b9f\u88c5\n    else\n      flash.alert = '\u30e6\u30fc\u30b6\u30fc\u540d\u307e\u305f\u306f\u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u6b63\u3057\u304f\u3042\u308a\u307e\u305b\u3093\u3002'\n    end\n    redirect_to :root\n  end\nend\n```\n\n* layout\u306e\u4fee\u6b63\n  - flash\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u8868\u793a\u3059\u308b\u90e8\u5206\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u4f5c\u6210\u3059\u308b\u3002\n\n```ruby\n# app/views/layouts/application.html.slim\ndoctype html\nhtml\n  head\n    title\n      | Oiax\n    = stylesheet_link_tag    'application', media: 'all', 'data-turbolinks-track' => true\n    = javascript_include_tag 'application', 'data-turbolinks-track' => true\n    = csrf_meta_tags\n  body\n    = render 'layouts/flashes'\n    = yield\n\n# app/views/layouts/_flashes.html.slim\n- if flash.alert.present?\n  p.alert\n    = flash.alert\n- if flash.notice.present?\n  p.notice\n    = flash.notice\n```\n\n* \u30c6\u30b9\u30c8\u7d50\u679c\n  - \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557\u306e\u30c6\u30b9\u30c8\u306f\u901a\u904e\u3057\u305f\u3002\n\n```\n  1 ||\n  2 || \u30ed\u30b0\u30a4\u30f3\n  3 ||   \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f (FAILED - 1)\n  4 ||   \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557\n  5 ||\n  6 || Failures:\n  7 ||\n  8 spec/features/login_and_logout_spec.rb|11 error|  Failure/Error: expect(page).not_to have_css('form#new_session') expected not to find css \"form#new_session\n  9 ||\n 10 || Finished in 0.40297 seconds (files took 5.27 seconds to load)\n 11 || 2 examples, 1 failure\n 12 ||\n 13 || Failed examples:\n 14 ||\n 15 || rspec ./spec/features/login_and_logout_spec.rb:4 # \u30ed\u30b0\u30a4\u30f3 \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f\n```\n\n## \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u306e\u30c6\u30b9\u30c8\uff08\uff13\uff09--\u30b9\u30bf\u30d6\u306e\u6d3b\u7528\n\n* http://www.oiax.jp/rails/rspec_capybara_primer/signing_in3.html\n\n### \u30a2\u30af\u30b7\u30e7\u30f3\u306e\u4eee\u5b9f\u88c5\n\n* controller\u306e\u4fee\u6b63\n\n```ruby\n  def create\n    if customer = Customer.authenticate(params[:username], params[:password])\n      session[:customer_id] = customer.id\n    else\n      flash.alert = '\u30e6\u30fc\u30b6\u30fc\u540d\u307e\u305f\u306f\u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u6b63\u3057\u304f\u3042\u308a\u307e\u305b\u3093\u3002'\n    end\n    redirect_to :root\n  end\n```\n\n* view\u306e\u4fee\u6b63\n\n```\nh1 Top#index\np Find me in app/views/top/index.html.slim\np Hello World!\n= render 'login_form' unless session[:customer_id]\n```\n\n* \u30c6\u30b9\u30c8\u7d50\u679c\n\n```\n  1 ||\n  2 || \u30ed\u30b0\u30a4\u30f3\n  3 ||   \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f (FAILED - 1)\n  4 ||   \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557 (FAILED - 2)\n  5 ||\n  6 || Failures:\n  7 ||\n  8 app/controllers/sessions_controller.rb|3 error|  Failure/Error: click_button '\u30ed\u30b0\u30a4\u30f3' NoMethodError: undefined method `authenticate' for #<Class:0x007fea3\n  9 ||      # ./spec/features/login_and_logout_spec.rb:9:in `block (3 levels) in <top (required)>'\n 10 ||      # ./spec/features/login_and_logout_spec.rb:6:in `block (2 levels) in <top (required)>'\n 11 ||\n 12 app/controllers/sessions_controller.rb|3 error|  Failure/Error: click_button '\u30ed\u30b0\u30a4\u30f3' NoMethodError: undefined method `authenticate' for #<Class:0x007fea3\n 13 ||      # ./spec/features/login_and_logout_spec.rb:19:in `block (3 levels) in <top (required)>'\n 14 ||      # ./spec/features/login_and_logout_spec.rb:16:in `block (2 levels) in <top (required)>'\n 15 ||\n 16 || Finished in 2.37 seconds (files took 4.28 seconds to load)\n 17 || 2 examples, 2 failures\n 18 ||\n 19 || Failed examples:\n 20 ||\n 21 || rspec ./spec/features/login_and_logout_spec.rb:4 # \u30ed\u30b0\u30a4\u30f3 \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f\n 22 || rspec ./spec/features/login_and_logout_spec.rb:14 # \u30ed\u30b0\u30a4\u30f3 \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557\n```\n\n### \u30e1\u30bd\u30c3\u30c9\u30b9\u30bf\u30d6\u3001\u3042\u308b\u3044\u306f\u30b9\u30bf\u30d6\n\n* \u30b9\u30bf\u30d6\u3068\u306f\uff1f\n  - \u672c\u7269\u306e\u30e1\u30bd\u30c3\u30c9\u306e\u4ee3\u308f\u308a\u306b\u4e00\u6642\u7684\u306b\uff08\u30c6\u30b9\u30c8\u306e\u9593\u3060\u3051\uff09\u5b9a\u7fa9\u3055\u308c\u305f\u30e1\u30bd\u30c3\u30c9\u3002\n  - \u3042\u308b\u30e1\u30bd\u30c3\u30c9\u306e\u5b9f\u88c5\u3092\u5f8c\u56de\u3057\u306b\u3057\u305f\u3044\u3001\u3057\u304b\u3057\u305d\u306e\u30e1\u30bd\u30c3\u30c9\u304c\u5b58\u5728\u3057\u306a\u3044\u3068\u30c6\u30b9\u30c8\u304c\u901a\u3089\u306a\u3044\u3068\u304d\u4f7f\u3046\n* spec\u306e\u4fee\u6b63\n  - stub\u3092\u8ffd\u52a0\u3059\u308b\u3002\n\n```diff\ndiff --git a/spec/features/login_and_logout_spec.rb b/spec/features/login_and_logout_spec.rb\nindex 40db3b0..0762945 100644\n--- a/spec/features/login_and_logout_spec.rb\n+++ b/spec/features/login_and_logout_spec.rb\n@@ -2,6 +2,7 @@ require 'rails_helper'\n\n describe '\u30ed\u30b0\u30a4\u30f3' do\n   example '\u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f' do\n+    Customer.stub(:authenticate)\n     visit root_path\n     within('form#new_session') do\n       fill_in 'username', with: 'taro'\n@@ -12,6 +13,7 @@ describe '\u30ed\u30b0\u30a4\u30f3' do\n   end\n\n   example '\u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557' do\n+    Customer.stub(:authenticate)\n     visit root_path\n     within('form#new_session') do\n       fill_in 'username', with: 'taro'\n```\n\n* \u30c6\u30b9\u30c8\u7d50\u679c\n\n```\n  1 ||\n  2 || \u30ed\u30b0\u30a4\u30f3\n  3 ||   \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f (FAILED - 1)\n  4 ||   \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557 (FAILED - 2)\n  5 ||\n  6 || Failures:\n  7 ||\n  8 spec/features/login_and_logout_spec.rb|5 error|  Failure/Error: Customer.stub(:authenticate) Customer(id: integer, family_name: string, given_name: string,\n  9 ||\n 10 spec/features/login_and_logout_spec.rb|16 error|  Failure/Error: Customer.stub(:authenticate) Customer(id: integer, family_name: string, given_name: string,\n 11 ||\n 12 || Deprecation Warnings:\n 13 ||\n 14 || Using `stub` from rspec-mocks' old `:should` syntax without explicitly enabling the syntax is deprecated. Use the new `:expect` syntax or explicitly enab\n 15 ||\n 16 ||\n 17 || If you need more of the backtrace for any of these deprecations to\n 18 || identify where to make the necessary changes, you can configure\n 19 || `config.raise_errors_for_deprecations!`, and it will turn the\n 20 || deprecation warnings into errors, giving you the full backtrace.\n 21 ||\n 22 || 1 deprecation warning total\n 23 ||\n 24 || Finished in 0.0601 seconds (files took 3.08 seconds to load)\n 25 || 2 examples, 2 failures\n 26 ||\n 27 || Failed examples:\n 28 ||\n 29 || rspec ./spec/features/login_and_logout_spec.rb:4 # \u30ed\u30b0\u30a4\u30f3 \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f\n 30 || rspec ./spec/features/login_and_logout_spec.rb:15 # \u30ed\u30b0\u30a4\u30f3 \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557\n```\n\n### \u30b9\u30bf\u30d6\u306e\u623b\u308a\u5024\u3092\u6307\u5b9a\u3059\u308b\u3002\n\n* \u30e2\u30c3\u30af\u3068\u30b9\u30bf\u30d6\u306e\u5fa9\u7fd2\n  + \u30e2\u30c3\u30af\n    - \u672c\u7269\u306e\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306e\u3075\u308a\u3092\u3059\u308b\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3002\n    - \u30c6\u30b9\u30c8\u30c0\u30d6\u30eb\uff08test doubles\uff09\u3068\u547c\u3070\u308c\u308b\u3002\n    - FactoryGirl.build_stubbed()\n  + \u30b9\u30bf\u30d6\n    - \u672c\u7269\u306e\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3057\u3001\u4e8b\u524d\u306b\u6c7a\u3081\u3089\u308c\u305f\u5024\u3092\u8fd4\u3059\u3002\n    - allow(Customer).to receive(:authenticate).with(username, password).and_return(customer)\n* Customer.authenticate\u306fCustomer\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u8fd4\u3059\u3002\n\n```ruby\nCustomer.stub(:authenticate).and_return(Customer.new)\n```\n\n* \u30c6\u30b9\u30c8\u7d50\u679c\n  + \u624b\u9806\u901a\u308a\u3084\u3063\u3066\u3044\u305f\u304c\u3001\u307e\u305f\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3059\u308b\u3002\u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u3082\u3046\u4e00\u5ea6\u78ba\u8a8d\u3002\n  + authenticate\u30e1\u30bd\u30c3\u30c9\u304c\u5177\u73fe\u3055\u308c\u3066\u306a\u3044\u3068\u66f8\u304b\u308c\u3066\u3044\u308b\u3002\n  + stub\u3092\u5229\u7528\u3059\u308b\u3053\u3068\u306b\u306a\u3063\u3066\u3082\u30e1\u30bd\u30c3\u30c9\u306f\u5fc5\u8981\u3089\u3057\u3044\u3002\n\n```sh\n[devnote@hooni:~/documents/study/oiax] % bin/rspec spec/features/login_and_logout_spec.rb\n\n\u30ed\u30b0\u30a4\u30f3\n  \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f (FAILED - 1)\n  \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557 (FAILED - 2)\n\nFailures:\n\n  1) \u30ed\u30b0\u30a4\u30f3 \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f\n     Failure/Error: Customer.stub(:authenticate).and_return(FactoryGirl.create(:customer))\n       Customer(id: integer, family_name: string, given_name: string, family_name_kana: string, given_name_kana: string, created_at: datetime, updated_at: datetime) does not implement: authenticate\n     # ./spec/features/login_and_logout_spec.rb:5:in `block (2 levels) in <top (required)>'\n\n  2) \u30ed\u30b0\u30a4\u30f3 \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557\n     Failure/Error: Customer.stub(:authenticate)\n       Customer(id: integer, family_name: string, given_name: string, family_name_kana: string, given_name_kana: string, created_at: datetime, updated_at: datetime) does not implement: authenticate\n     # ./spec/features/login_and_logout_spec.rb:16:in `block (2 levels) in <top (required)>'\n\nDeprecation Warnings:\n\nUsing `stub` from rspec-mocks' old `:should` syntax without explicitly enabling the syntax is deprecated. Use the new `:expect` syntax or explicitly enable `:should` instead. Called from /Users/devnote/Documents/study/oiax/spec/features/login_and_logout_spec.rb:5:in `block (2 levels) in <top (required)>'.\n\nIf you need more of the backtrace for any of these deprecations to\nidentify where to make the necessary changes, you can configure\n`config.raise_errors_for_deprecations!`, and it will turn the\ndeprecation warnings into errors, giving you the full backtrace.\n\n1 deprecation warning total\n\nFinished in 0.026 seconds (files took 2.79 seconds to load)\n2 examples, 2 failures\n\nFailed examples:\n\nrspec ./spec/features/login_and_logout_spec.rb:4 # \u30ed\u30b0\u30a4\u30f3 \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f\nrspec ./spec/features/login_and_logout_spec.rb:15 # \u30ed\u30b0\u30a4\u30f3 \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557\n```\n\n* \u30c7\u30d0\u30c3\u30b0\n  - 5\u884c\u306816\u884c\u304b\u3089\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u3066\u3044\u308b\u306e\u3067\u30015\u884c\u306e\u524d\u306bbinding.pry\u3092\u5165\u308c\u3066\u78ba\u8a8d\u3059\u308b\u3002\n  - authenticate\u30e1\u30bd\u30c3\u30c9\u3092\u5165\u308c\u3066continue\u3067\u7d9a\u884c\u3059\u308b\u3068\u3001\u4eca\u5ea6\u306f\u30c6\u30b9\u30c8\u3092\u901a\u3063\u305f\u3002\n\n```ruby\nbinding.pry\nCutomer.stub(:authenticate).and_return(FactoryGirl.create(:customer))\n\n# pry\nFrom: /Users/devnote/Documents/study/oiax/spec/features/login_and_logout_spec.rb @ line 6 :\n\n     1: require 'rails_helper'\n     2:\n     3: describe '\u30ed\u30b0\u30a4\u30f3' do\n     4:   example '\u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f' do\n     5:     binding.pry\n =>  6:     Customer.stub(:authenticate).and_return(FactoryGirl.create(:customer))\n     7:     visit root_path\n     8:     within('form#new_session') do\n     9:       fill_in 'username', with: 'taro'\n    10:       fill_in 'password', with: 'correct_password'\n    11:       click_button '\u30ed\u30b0\u30a4\u30f3'\n\n[1] pry(#<RSpec::ExampleGroups::Nested>)> Customer.stub(:authenticate).and_return(FactoryGirl.create(:customer))\nRSpec::Mocks::MockExpectationError: Customer(id: integer, family_name: string, given_name: string, family_name_kana: string, given_name_kana: string, created_at: datetime, updated_at: datetime) does not implement: authenticate\nfrom /Users/devnote/Documents/study/oiax/vendor/bundle/ruby/2.2.0/gems/rspec-support-3.3.0/lib/rspec/support.rb:86:in `block in <module:Support>'\n[2] pry(#<RSpec::ExampleGroups::Nested>)> Customer.methods.grep /auth*/\n=> [:reflect_on_all_autosave_associations, :autoload, :autoload?]\n[3] pry(#<RSpec::ExampleGroups::Nested>)> Customer.class_eval do\n[3] pry(#<RSpec::ExampleGroups::Nested>)*   def self.authenticate(username, password); 'test'; end\n[3] pry(#<RSpec::ExampleGroups::Nested>)*   end\n=> :authenticate\n[4] pry(#<RSpec::ExampleGroups::Nested>)> Customer.methods.grep /auth*/\n=> [:authenticate, :reflect_on_all_autosave_associations, :autoload, :autoload?]\n[4] pry(#<RSpec::ExampleGroups::Nested>)> continue\n```\n\n* \u30c7\u30d0\u30c3\u30b0\u3067\u5206\u304b\u3063\u305f\u3053\u3068\n  - stub\u3092\u4f7f\u3063\u3066\u3082\u30c6\u30b9\u30c8\u5bfe\u8c61\uff08\u3053\u3053\u3067\u306fcustomer\u30e2\u30c7\u30eb\uff09\u306b\u4eee\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u5b9f\u88c5\u3057\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u3002\n\n* \u30e2\u30c7\u30eb\u306e\u4fee\u6b63\n  - \u30c6\u30b9\u30c8\u3092\u901a\u3089\u305b\u308b\u305f\u3081\u306e\u4eee\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u5b9f\u88c5\u3059\u308b\u3002\n\n```diff\ndiff --git a/app/models/customer.rb b/app/models/customer.rbindex ffd50be..903eae1 100644\n--- a/app/models/customer.rb\n+++ b/app/models/customer.rb\n@@ -16,4 +16,8 @@ class Customer < ActiveRecord::Base\n   self.family_name_kana = NKF.nkf('-wh2', family_name_kana) if family_name_kana\n   self.given_name_kana = NKF.nkf('-wh2', given_name_kana) if given_name_kana\n end\n+\n+  def self.authenticate(username, password)\n+    'test'\n+  end\n```\n\n* \u30b9\u30da\u30c3\u30af\u306e\u4fee\u6b63\n  + deprecated\u3055\u308c\u3066\u3044\u308bstub\u306e\u4ee3\u308f\u308a\u306ballow\u301creceive\u3092\u4f7f\u3046\u3088\u3046\u306b\u4fee\u6b63\u3059\u308b\u3002\n\n```diff\ndiff --git a/spec/features/login_and_logout_spec.rb b/spec/features/login_and_logout_spec.rb\nindex 0762945..4bf0558 100644\n--- a/spec/features/login_and_logout_spec.rb\n+++ b/spec/features/login_and_logout_spec.rb\n@@ -2,7 +2,7 @@ require 'rails_helper'\n\n describe '\u30ed\u30b0\u30a4\u30f3' do\n   example '\u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f' do\n-    Customer.stub(:authenticate).and_return(FactoryGirl.create(:customer))\n+    allow(Customer).to receive(:authenticate).and_return(FactoryGirl.create(:customer))\n     visit root_path\n     within('form#new_session') do\n       fill_in 'username', with: 'taro'\n@@ -13,7 +13,7 @@ describe '\u30ed\u30b0\u30a4\u30f3' do\n   end\n\n   example '\u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557' do\n-    Customer.stub(:authenticate)\n+    allow(Customer).to receive(:authenticate)\n     visit root_path\n     within('form#new_session') do\n     fill_in 'username', with: 'taro'\n```\n\n### \u30e2\u30c3\u30af\n\n* \u30b9\u30bf\u30d6\u3092\u6301\u3064\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\n* mock\uff1a\u6a21\u9020\u54c1\u3001\u507d\u7269\n* mock-up\uff1a\u6a21\u578b\n* double\uff1apure mock\u3001\u3069\u306e\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3067\u3042\u308b\u3068\u3082\u6307\u5b9a\u305b\u305a\u306b\u30e2\u30c3\u30af\u3092\u4f5c\u308a\u305f\u3044\u5834\u5408\u306b\u4f7f\u7528\u3002\n\n## \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u306e\u30c6\u30b9\u30c8\uff08\uff14\uff09-- YAGNI\n\n* http://www.oiax.jp/rails/rspec_capybara_primer/signing_in4.html\n\n### FactoryGirl::Syntax::Methods\n\n* spec/rails_helper.rb\u3078\u8a2d\u5b9a\u3059\u308b\u3060\u3051\u3067\u6bce\u5ea6FactoryGirl.\u3092\u4f7f\u3046\u5fc5\u8981\u304c\u306a\u304f\u306a\u308b\u3002\n  - FactoryGirl.create \u2192 create\n  - FactoryGirl.build  \u2192 build\n\n### example\u306e\u30b0\u30eb\u30fc\u30d7\u5316\n\n### Customer.authenticate\u306e\u30c6\u30b9\u30c8\n\n* spec\u306e\u4fee\u6b63\n\n```ruby\ndescribe Customer, '.authenticate' do\n  let(:customer) {create(:customer, username: 'taro', password: 'correct_password')}\n\n  example '\u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059' do\n    result = Customer.authenticate(customer.username, 'correct_password')\n    expect(result).to eq(customer)\n  end\nend\n```\n\n* \u30c6\u30b9\u30c8\u7d50\u679c\n  - username\u304c\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u306a\u3044\u3068\u3044\u3046\u30a8\u30e9\u30fc\u304c\u8868\u793a\u3055\u308c\u308b\u3002\n\n```\n# , + n : cursor\u304c\u3042\u308b\u3068\u3053\u308d\u306eexample\u3060\u3051\u3092\u5b9f\u884c\u3059\u308b\u3002\n  1 || Run options: include {:locations=>{\"./spec/models/customer_spec.rb\"=>[67]}}\n  2 ||\n  3 || Customer.authenticate\n  4 ||   \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059 (FAILED - 1)\n  5 ||\n  6 || Failures:\n  7 ||\n  8 spec/models/customer_spec.rb|68 error|  Failure/Error: let(:customer) {create(:customer, username: 'taro', password: 'correct_password')} NoMethodError: und\n  9 ||      # ./spec/models/customer_spec.rb:71:in `block (2 levels) in <top (required)>'\n 10 ||\n 11 || Finished in 0.02003 seconds (files took 2.87 seconds to load)\n 12 || 1 example, 1 failure\n 13 ||\n 14 || Failed examples:\n 15 ||\n 16 || rspec ./spec/models/customer_spec.rb:70 # Customer.authenticate \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059\n```\n\n### username\u30ab\u30e9\u30e0\u306e\u8ffd\u52a0\n\n* \u65e2\u5b58\u306e\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u30d5\u30a1\u30a4\u30eb\u3092\u4fee\u6b63\n\n```diff\ndiff --git a/db/migrate/20150914060814_create_customers.rb b/db/migrate/20150914060814_create_customers.rb\nindex 4d2d6a9..ab8853b 100644\n--- a/db/migrate/20150914060814_create_customers.rb\n+++ b/db/migrate/20150914060814_create_customers.rb\n@@ -1,6 +1,7 @@\n class CreateCustomers < ActiveRecord::Migration\n   def change\n     create_table :customers do |t|\n+      t.string :username, null: false\n       t.string :family_name, null: false\n       t.string :given_name, null: false\n       t.string :family_name_kana, null: false\n```\n\n* \u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u5b9f\u65bd\n  - \u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u30d5\u30a1\u30a4\u30eb\u3092\u4fee\u6b63\u3057\u305f\u3089\u5f53\u305f\u308a\u524d\u306e\u624b\u9806\u306a\u306e\u3067\u899a\u3048\u3066\u304a\u304f\u3002\n\n```\nbin/rake db:migrate:reset\nbin/rake db:test:prepare\n```\n\n* \u30c6\u30b9\u30c8\u7d50\u679c\n  - password\u304c\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u306a\u3044\u3002\n\n```\n[devnote@hooni:~/documents/study/oiax] % bin/rspec spec/models/customer_spec.rb:67\nRun options: include {:locations=>{\"./spec/models/customer_spec.rb\"=>[67]}}\n\nCustomer.authenticate\n  \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059 (FAILED - 1)\n\nFailures:\n\n  1) Customer.authenticate \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059\n     Failure/Error: let(:customer) {create(:customer, username: 'taro', password: 'correct_password')}\n     NoMethodError:\n       undefined method `password=' for #<Customer:0x007ff650ba1cf8>\n     # ./spec/models/customer_spec.rb:68:in `block (2 levels) in <top (required)>'\n     # ./spec/models/customer_spec.rb:71:in `block (2 levels) in <top (required)>'\n\nFinished in 0.0231 seconds (files took 2.86 seconds to load)\n1 example, 1 failure\n\nFailed examples:\n\nrspec ./spec/models/customer_spec.rb:70 # Customer.authenticate \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059\n```\n\n### password\u5c5e\u6027\u306e\u5b9a\u7fa9\n\n* model\u306e\u4fee\u6b63\n  - \u30c6\u30b9\u30c8\u3092\u901a\u3089\u305b\u308b\u305f\u3081\u306e\u30a2\u30af\u30bb\u30c3\u30b5\u3092\u5165\u308c\u3066\u30c6\u30b9\u30c8\u3092\u5b9f\u884c\n\n```diff\ndiff --git a/app/models/customer.rb b/app/models/customer.rb\nindex 903eae1..606d1f4 100644\n--- a/app/models/customer.rb\n+++ b/app/models/customer.rb\n@@ -1,6 +1,8 @@\n require 'nkf'\n\n class Customer < ActiveRecord::Base\n+  # attr_accessor :password\n+\n   validates :family_name, presence: true, length: {maximum: 40},\n             format: {with: /\\A[\\p{Han}\\p{Hiragana}\\p{Katakana}\\u30fc]+\\z/, allow_blank: true}\n   validates :given_name, presence: true, length: {maximum: 40},\n```\n\n* \u30c6\u30b9\u30c8\u7d50\u679c\n  - \u671f\u5f85\u3057\u305f\u306e\u306fcustomer\u306e\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3060\u3063\u305f\u306e\u306b\u3001\u5b9f\u969b\u306b\u306f'test'\u3068\u3044\u3046\u6587\u5b57\u5217\u3092\u8fd4\u3057\u305f\u3002\n\n```\n[devnote@hooni:~/documents/study/oiax] % bin/rspec spec/models/customer_spec.rb:67\nRun options: include {:locations=>{\"./spec/models/customer_spec.rb\"=>[67]}}\n\nCustomer.authenticate\n  \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059 (FAILED - 1)\n\nFailures:\n\n  1) Customer.authenticate \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059\n     Failure/Error: expect(result).to eq(customer)\n\n       expected: #<Customer id: 2, username: \"taro\", family_name: \"\u5c71\u7530\", given_name: \"\u592a\u90ce\", family_name_kana: \"\u30e4\u30de\u30c0\", given_name_kana: \"\u30bf\u30ed\u30a6\", created_at: \"2015-09-23 05:36:45\", updated_at: \"2015-09-23 05:36:45\">\n            got: \"test\"\n\n       (compared using ==)\n\n       Diff:\n       @@ -1,10 +1,2 @@\n       -#<Customer:0x007f99eb6b7880\n       - id: 2,\n       - username: \"taro\",\n       - family_name: \"\u5c71\u7530\",\n       - given_name: \"\u592a\u90ce\",\n       - family_name_kana: \"\u30e4\u30de\u30c0\",\n       - given_name_kana: \"\u30bf\u30ed\u30a6\",\n       - created_at: Wed, 23 Sep 2015 14:36:45 JST +09:00,\n       - updated_at: Wed, 23 Sep 2015 14:36:45 JST +09:00>\n       +\"test\"\n\n     # ./spec/models/customer_spec.rb:72:in `block (2 levels) in <top (required)>'\n\nFinished in 0.0577 seconds (files took 2.83 seconds to load)\n1 example, 1 failure\n\nFailed examples:\n\nrspec ./spec/models/customer_spec.rb:70 # Customer.authenticate \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059\n```\n\n### Customer.authenticate\u306e\u4eee\u5b9f\u88c5\n\n* model\u306e\u4fee\u6b63\n\n```diff\ndiff --git a/app/models/customer.rb b/app/models/customer.rb\nindex 903eae1..bc677c0 100644\n--- a/app/models/customer.rb\n+++ b/app/models/customer.rb\n@@ -1,6 +1,8 @@\n require 'nkf'\n\n class Customer < ActiveRecord::Base\n+  attr_accessor :password\n+\n   validates :family_name, presence: true, length: {maximum: 40},\n             format: {with: /\\A[\\p{Han}\\p{Hiragana}\\p{Katakana}\\u30fc]+\\z/, allow_blank: true}\n   validates :given_name, presence: true, length: {maximum: 40},\n@@ -18,6 +20,6 @@ class Customer < ActiveRecord::Base\n   end\n\n   def self.authenticate(username, password)\n-    'test'\n+    find_by_username(username)\n   end\n end\n```\n\n* \u30c6\u30b9\u30c8\u7d50\u679c\n\n```\n[devnote@hooni:~/documents/study/oiax] % bin/rspec spec/models/customer_spec.rb:67\nRun options: include {:locations=>{\"./spec/models/customer_spec.rb\"=>[67]}}\n\nCustomer.authenticate\n  \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059\n\nFinished in 0.03701 seconds (files took 2.82 seconds to load)\n1 example, 0 failures\n```\n\n### FactoryGirl\u306e\u4fee\u6b63\n\n* customer\u30e2\u30c7\u30eb\u306e\u5168\u4f53\u30c6\u30b9\u30c8\u3092\u3059\u308b\u3068\u5931\u6557\u3057\u3066\u3057\u307e\u3046\u3002\n* \u3053\u3053\u3067\u5fd8\u308c\u306a\u3044\u3088\u3046\u306b\u3082\u3046\u4e00\u5ea6\u8aac\u660e\u3059\u308b\u3002\n  - spec\u30d5\u30a1\u30a4\u30eb\u304b\u3089rspec\u3092\u5b9f\u884c\u3059\u308b\u3068\u304d\u3001vim\u3067\u30de\u30c3\u30d4\u30f3\u30b0\u3055\u308c\u3066\u3044\u308b\u30ad\u30fc\u3092\u4f7f\u3046\u3002\n  - ,n \u2192 vim\u4e0a\u3067\u30ab\u30fc\u30bd\u30eb\u304c\u4f4d\u7f6e\u3055\u308c\u3066\u3044\u308bexample\u307e\u305f\u306fdescribe\u3060\u3051\u3092rspec\u3067\u5b9f\u884c\u3059\u308b\u3002\n  - ,c \u2192 vim\u4e0a\u3067\u958b\u3044\u3066\u3044\u308b\u30d5\u30a1\u30a4\u30eb\u306e\u3059\u3079\u3066\u306eexample\u3092\u5b9f\u884c\u3059\u308b\u3002\n  - \u3053\u306e\u52c9\u5f37\u4f1a\u3067\u306f\u5b9f\u7fd2\u74b0\u5883\u3092\u69cb\u7bc9\u3057\u3066\u305d\u306e\u4e0a\u3067\u884c\u3063\u3066\u3044\u308b\u306e\u3067\u3001\u5b9f\u7fd2\u74b0\u5883\u304c\u69cb\u7bc9\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u306f\u81ea\u52d5\u3067\u3067\u304d\u308b\u306f\u305a\u3002\n  - \u5b9f\u7fd2\u74b0\u5883\u306e\u69cb\u7bc9\u306b\u3064\u3044\u3066\u306f\u300c\u52c9\u5f37\u4f1aBDD\uff1c\uff11\uff1e\u300d\u3092\u53c2\u8003\u3002\n\n```\nFailures:\n\n  1) \u30ed\u30b0\u30a4\u30f3 \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f\n     Failure/Error: allow(Customer).to receive(:authenticate).and_return(FactoryGirl.create(:customer))\n     ActiveRecord::StatementInvalid:\n       PG::NotNullViolation: ERROR:  null value in column \"username\" violates not-null constraint\n       DETAIL:  Failing row contains (7, null, \u5c71\u7530, \u592a\u90ce, \u30e4\u30de\u30c0, \u30bf\u30ed\u30a6, 2015-09-23 14:51:06.164856, 2015-09-23 14:51:06.164856).\n       : INSERT INTO \"customers\" (\"family_name\", \"given_name\", \"family_name_kana\", \"given_name_kana\", \"created_at\", \"updated_at\") VALUES ($1, $2, $3, $4, $5, $6) RETURNING \"id\"\n     # ./spec/features/login_and_logout_spec.rb:5:in `block (2 levels) in <top (required)>'\n```\n\n* \u30b9\u30ad\u30fc\u30de\u306e\u5909\u66f4\u3055\u308c\u305f\u306e\u3067\u3001FactoryGirl\u306e\u4fee\u6b63\u3082\u5fc5\u8981\u3060\u3063\u305f\u3002\n* spec\u306e\u4fee\u6b63\n\n```ruby\ndiff --git a/spec/factories/customers.rb b/spec/factories/customers.rb\nindex 3119d6b..eaddcd3 100644\n--- a/spec/factories/customers.rb\n+++ b/spec/factories/customers.rb\n@@ -1,5 +1,6 @@\n FactoryGirl.define do\n   factory :customer do\n+    username 'taro'\n     family_name '\u5c71\u7530'\n     given_name '\u592a\u90ce'\n     family_name_kana '\u30e4\u30de\u30c0'\n```\n\n### YAGNI\n\n* \u30c6\u30b9\u30c8\u3092\u66f8\u304d\u3001\u30c6\u30b9\u30c8\u3092\u901a\u3059\u305f\u3081\u306e\u6700\u5c0f\u9650\u306e\u30b3\u30fc\u30c9\u3092\u5b9f\u88c5\u3059\u308b\u3002\n* \u3053\u306e\u77ed\u3044\u30b5\u30a4\u30af\u30eb\u3092\u7e70\u308a\u8fd4\u3059\u3002\n* YAGNI\uff1aYou ain't gonna need it.\uff08\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u958b\u767a\u3067\u306f\u3042\u3068\u3067\u4f7f\u3046\u3060\u308d\u3046\u3068\u601d\u3063\u3066\u4f5c\u3063\u305f\u7269\u306e\u5927\u534a\u306f\u7121\u99c4\u306b\u306a\u308b\u3002\uff09\n* \u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3092\u4e71\u96d1\u3057\u3001\u4fdd\u5b88\u6027\u3092\u4f4e\u4e0b\u3055\u305b\u308b\u3002\n* \u30c6\u30b9\u30c8\u99c6\u52d5\u306e\u77ed\u3044\u958b\u767a\u30b5\u30a4\u30af\u30eb\u3092\u7e70\u308a\u8fd4\u3059\u3053\u3068\u3067\u3001\u4f5c\u308a\u3059\u304e\u306e\u5f0a\u5bb3\u3092\u907f\u3051\u3089\u308c\u308b\u3002\n\n## \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u306e\u30c6\u30b9\u30c8\uff08\uff15\uff09-- \u30d1\u30b9\u30ef\u30fc\u30c9\u60c5\u5831\u306e\u4fdd\u5b58\n\n* http://www.oiax.jp/rails/rspec_capybara_primer/signing_in5.html\n\n### example\u306e\u8ffd\u52a0\n\n* spec\u306e\u4fee\u6b63\n\n```diff\ndiff --git a/spec/models/customer_spec.rb b/spec/models/customer_spec.rb\nindex 0304f20..cfb2687 100644\n--- a/spec/models/customer_spec.rb\n+++ b/spec/models/customer_spec.rb\n@@ -71,4 +71,14 @@ describe Customer, '.authenticate' do\n     result = Customer.authenticate(customer.username, 'correct_password')\n     expect(result).to eq(customer)\n   end\n+\n+  example '\u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u4e00\u81f4\u3057\u306a\u3044\u5834\u5408nil\u3092\u8fd4\u3059' do\n+    result = Customer.authenticate(customer.username, 'wrong_password')\n+    expect(result).to be_nil\n+  end\n+\n+  example '\u8a72\u5f53\u3059\u308b\u30e6\u30fc\u30b6\u30fc\u540d\u304c\u5b58\u5728\u3057\u306a\u3044\u5834\u5408\u306fnil\u3092\u8fd4\u3059' do\n+    result = Customer.authenticate('hanako', 'any_string')\n+    expect(result).to be_nil\n+  end\nend\n```\n\n* \u30c6\u30b9\u30c8\u7d50\u679c\n  + \u4fdd\u5b58\u5f62\u5f0f\u306e\u8a73\u7d30\u306f\u6c7a\u3081\u305a\u306b\u3001\u30c6\u30b9\u30c8\u3092\u901a\u3059\u3054\u3068\u3060\u3051\u3092\u76ee\u6307\u3057\u3066\u5b9f\u88c5\u3057\u305f\u306e\u3067\u3001\u5931\u6557\u3057\u305f\u3002\n\n```\n  1 || Run options: include {:locations=>{\"./spec/models/customer_spec.rb\"=>[67]}}\n  2 ||\n  3 || Customer.authenticate\n  4 ||   \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059\n  5 ||   \u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u4e00\u81f4\u3057\u306a\u3044\u5834\u5408nil\u3092\u8fd4\u3059 (FAILED - 1)\n  6 ||   \u8a72\u5f53\u3059\u308b\u30e6\u30fc\u30b6\u30fc\u540d\u304c\u5b58\u5728\u3057\u306a\u3044\u5834\u5408\u306fnil\u3092\u8fd4\u3059\n  7 ||\n  8 || Failures:\n  9 ||\n 10 spec/models/customer_spec.rb|77 error|  Failure/Error: expect(result).to be_nil expected: nil got: #<Customer id: 12, username: \"taro\", family_name: \"\u5c71\u7530\",\n 11 ||\n 12 || Finished in 0.07173 seconds (files took 2.94 seconds to load)\n 13 || 3 examples, 1 failure\n 14 ||\n 15 || Failed examples:\n 16 ||\n 17 || rspec ./spec/models/customer_spec.rb:75 # Customer.authenticate \u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u4e00\u81f4\u3057\u306a\u3044\u5834\u5408nil\u3092\u8fd4\u3059\n```\n\n### \u30d1\u30b9\u30ef\u30fc\u30c9\u60c5\u5831\u3092\u4fdd\u5b58\u3059\u308b\u305f\u3081\u306e\u30ab\u30e9\u30e0\u3092\u8ffd\u52a0\n\n* model\u306e\u4fee\u6b63\n\n```diff\ndiff --git a/app/models/customer.rb b/app/models/customer.rb\nindex bc677c0..ab08f8b 100644\n--- a/app/models/customer.rb\n+++ b/app/models/customer.rb\n@@ -19,7 +19,16 @@ class Customer < ActiveRecord::Base\n     self.given_name_kana = NKF.nkf('-wh2', given_name_kana) if given_name_kana\n   end\n\n+  before_save do\n+    self.password_digest = password\n+  end\n+\n   def self.authenticate(username, password)\n-    find_by_username(username)\n+    customer = find_by_username(username)\n+    if customer && password == customer.password_digest\n+      customer\n+    else\n+      nil\n+    end\n   end\n end\n```\n\n* \u30c6\u30b9\u30c8\u7d50\u679c\n\n```sh\n[devnote@hooni:~/documents/study/oiax] % bin/rspec spec/models/customer_spec.rb:83\nRun options: include {:locations=>{\"./spec/models/customer_spec.rb\"=>[83]}}\n\nCustomer.authenticate\n  \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059\n  \u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u4e00\u81f4\u3057\u306a\u3044\u5834\u5408nil\u3092\u8fd4\u3059\n  \u8a72\u5f53\u3059\u308b\u30e6\u30fc\u30b6\u30fc\u540d\u304c\u5b58\u5728\u3057\u306a\u3044\u5834\u5408\u306fnil\u3092\u8fd4\u3059\n\nFinished in 0.04363 seconds (files took 2.78 seconds to load)\n3 examples, 0 failures\n```\n\n### \u30d1\u30b9\u30ef\u30fc\u30c9\u60c5\u5831\u306e\u4fdd\u5b58\u306b\u95a2\u3059\u308bexample\u3092\u8ffd\u52a0\n\n* spec\u306e\u4fee\u6b63\n\n```diff\ndiff --git a/spec/models/customer_spec.rb b/spec/models/customer_spec.rb\nindex cfb2687..8192210 100644\n--- a/spec/models/customer_spec.rb\n+++ b/spec/models/customer_spec.rb\n@@ -64,6 +64,22 @@ describe Customer, '\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3' do\n   end\n end\n\n+describe Customer, 'password=' do\n+  let(:customer) {build(:customer, username: 'taro')}\n+\n+  example '\u751f\u6210\u3055\u308c\u305fpassword_digest\u306f60\u6587\u5b57' do\n+    customer.password = 'any_string'\n+    customer.save!\n+    expect(customer.password_digest).not_to be_nil\n+  end\n+\n+  example '\u7a7a\u6587\u5b57\u3092\u4e0e\u3048\u308b\u3068password_digest\u306fnil' do\n+    customer.password = ''\n+    customer.save!\n+    expect(customer.password_digest).to be_nil\n+  end\n+end\n+\n describe Customer, '.authenticate' do\n   let(:customer) {create(:customer, username: 'taro', password: 'correct_password')}\n```\n\n* \u30c6\u30b9\u30c8\u7d50\u679c\n  - nil\u3092\u671f\u5f85\u3057\u3066\u3044\u305f\u306e\u306b\u3001\"\"\u3092\u8fd4\u3057\u305f\u3002\n\n```\n  1 || Run options: include {:locations=>{\"./spec/models/customer_spec.rb\"=>[67]}}\n  2 ||\n  3 || Customer password=\n  4 ||   \u751f\u6210\u3055\u308c\u305fpassword_digest\u306f60\u6587\u5b57\n  5 ||   \u7a7a\u6587\u5b57\u3092\u4e0e\u3048\u308b\u3068password_digest\u306fnil (FAILED - 1)\n  6 ||\n  7 || Failures:\n  8 ||\n  9 spec/models/customer_spec.rb|79 error|  Failure/Error: expect(customer.password_digest).to be_nil expected: nil got: \"\"\n 10 ||\n 11 || Finished in 0.04693 seconds (files took 2.74 seconds to load)\n 12 || 2 examples, 1 failure\n 13 ||\n 14 || Failed examples:\n 15 ||\n 16 || rspec ./spec/models/customer_spec.rb:76 # Customer password= \u7a7a\u6587\u5b57\u3092\u4e0e\u3048\u308b\u3068password_digest\u306fnil\n```\n\n### bcrypt\u306b\u3064\u3044\u3066\n\n* \u3053\u3053\u3067\u306f\u30d1\u30b9\u30ef\u30fc\u30c9\u60c5\u5831\u3092\u4fdd\u6301\u3059\u308b\u305f\u3081\u306bbcrypt\u3092\u4f7f\u3046\u3002\n\n* bcrypt\u3068\u306f\n  - \u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u6697\u53f7\u5316\u3057\u3066\u4fdd\u6301\u3057\u3066\u304f\u308c\u308b\u3002\n  - password\u3068password_confirmation\u3068\u3044\u3046\u30a2\u30c8\u30ea\u30d3\u30e5\u30fc\u30c8\u304c\u8ffd\u52a0\u3055\u308c\u3066validation\u3067\u4f7f\u3046\u3002\n\n* bcrypt\u3068\u4f7f\u3046\u305f\u3081\u306b\u306f\n  - password_digest\u3068\u3044\u3046\u30ab\u30e9\u30e0\u3092\u8ffd\u52a0\u3059\u308b\u3002\n  - bcrypt-ruby\u3068\u3044\u3046gem\u3092\u8ffd\u52a0\u3059\u308b\u3002\n\n### \u30c6\u30b9\u30c8\u3092\u901a\u3059\n\n* gem\u306e\u8ffd\u52a0\n\n```diff\ndiff --git a/Gemfile b/Gemfile\nindex 0e5b1c6..ee310a2 100644\n--- a/Gemfile\n+++ b/Gemfile\n@@ -8,6 +8,7 @@ gem 'jquery-rails'\n gem 'turbolinks'\n gem 'jbuilder', '~> 2.0'\n gem 'sdoc', '~> 0.4.0', group: :doc\n+gem 'bcrypt-ruby'\n\n # Memcached Client\n gem 'dalli'\n```\n\n* model\u306e\u4fee\u6b63\n\n```diff\ndiff --git a/app/models/customer.rb b/app/models/customer.rb\nindex bc677c0..9c7a21c 100644\n--- a/app/models/customer.rb\n+++ b/app/models/customer.rb\n@@ -1,4 +1,5 @@\n require 'nkf'\n+require 'bcrypt'\n\n class Customer < ActiveRecord::Base\n   attr_accessor :password\n@@ -19,7 +20,16 @@ class Customer < ActiveRecord::Base\n     self.given_name_kana = NKF.nkf('-wh2', given_name_kana) if given_name_kana\n   end\n\n+  before_save do\n+    self.password_digest = password if password.present?\n+  end\n+\n   def self.authenticate(username, password)\n-    find_by_username(username)\n+    customer = find_by_username(username)\n+    if customer && BCrypt::Password.new(customer.password_digest) == customer.password\n+      customer\n+    else\n+      nil\n+    end\n   end\n```\n\n* \u30c6\u30b9\u30c8\u7d50\u679c\n\n```sh\n[devnote@hooni:~/documents/study/oiax] % bin/rspec spec/models/customer_spec.rb:67\nRun options: include {:locations=>{\"./spec/models/customer_spec.rb\"=>[67]}}\n\nCustomer password=\n  \u751f\u6210\u3055\u308c\u305fpassword_digest\u306f60\u6587\u5b57\n  \u7a7a\u6587\u5b57\u3092\u4e0e\u3048\u308b\u3068password_digest\u306fnil\n\nFinished in 0.0356 seconds (files took 3.06 seconds to load)\n2 examples, 0 failures\n```\n\n* \u88dc\u8db3\n  - BCrypt::Password.new(customer.password_digest) == customer.password\n  - \u4e00\u898b\u3059\u308b\u3068\u6697\u53f7\u5316\u3055\u308c\u3066\u3044\u308b\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u5fa9\u53f7\u5316\u3057\u3066\u5e73\u6587\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u3068\u6bd4\u8f03\u3057\u3066\u3044\u308b\u3002\n  - \u5e73\u6587\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u6697\u53f7\u5316\u3057\u3066DB\u4e0a\u306e\u6697\u53f7\u5316\u3055\u308c\u3066\u3044\u308b\u30d1\u30b9\u30ef\u30fc\u30c9\u3068\u4e00\u81f4\u3059\u308b\u306e\u304b\u78ba\u8a8d\u3059\u308b\u306e\u304c\u4e00\u822c\u7684\u3060\u3002\n  - \u305d\u308c\u306a\u306e\u306b\u306a\u305c\u305d\u3046\u3060\u308d\u3046\u304b\uff1f\n  - before_save\u306epassword\u306f\u3059\u3067\u306bbcrypt\u306b\u3088\u3063\u3066\u6697\u53f7\u5316\u3055\u308c\u305f\u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u4fdd\u6301\u3055\u308c\u3066\u3044\u308b\u3002\n  - bcrypt\u306e\u4e2d\u3092\u8997\u3044\u3066\u307f\u308b\u3068==(\u5f15\u6570)\u304c\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3055\u308c\u3066\u3044\u3066\u5f15\u6570\u3092\u6697\u53f7\u5316\u3057\u6bd4\u8f03\u3057\u3066\u3044\u308b\u3002\n  - \u52c9\u5f37\u4f1a\u3067\u3053\u3093\u306a\u8cea\u554f\u304c\u3042\u3063\u305f\u306e\u3067\u88dc\u8db3\u3067\u8ffd\u8a18\u3059\u308b\u3002\n\n### \u30c6\u30b9\u30c8\u306e\u7a74\u3092\u57cb\u3081\u308b\u3002\n\n* spec\u306e\u4fee\u6b63\n\n```diff\ndiff --git a/spec/models/customer_spec.rb b/spec/models/customer_spec.rb\nindex 8192210..7297bf7 100644\n--- a/spec/models/customer_spec.rb\n+++ b/spec/models/customer_spec.rb\n@@ -97,4 +97,10 @@ describe Customer, '.authenticate' do\n     result = Customer.authenticate('hanako', 'any_string')\n     expect(result).to be_nil\n   end\n+\n+  example '\u30d1\u30b9\u30ef\u30fc\u30c9\u672a\u8a2d\u5b9a\u306e\u30e6\u30fc\u30b6\u30fc\u3092\u62d2\u7d76\u3059\u308b' do\n+    customer.update_column(:password_digest, nil)\n+    result = Customer.authenticate(customer.username, '')\n+    expect(result).to be_nil\n+  end\nend\n```\n\n* \u30c6\u30b9\u30c8\u306e\u7d50\u679c\n\n```sh\n[devnote@hooni:~/documents/study/oiax] % bin/rspec spec/models/customer_spec.rb:83\nRun options: include {:locations=>{\"./spec/models/customer_spec.rb\"=>[83]}}\n\nCustomer.authenticate\n  \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059 (FAILED - 1)\n  \u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u4e00\u81f4\u3057\u306a\u3044\u5834\u5408nil\u3092\u8fd4\u3059 (FAILED - 2)\n  \u8a72\u5f53\u3059\u308b\u30e6\u30fc\u30b6\u30fc\u540d\u304c\u5b58\u5728\u3057\u306a\u3044\u5834\u5408\u306fnil\u3092\u8fd4\u3059\n  \u30d1\u30b9\u30ef\u30fc\u30c9\u672a\u8a2d\u5b9a\u306e\u30e6\u30fc\u30b6\u30fc\u3092\u62d2\u7d76\u3059\u308b (FAILED - 3)\n\nFailures:\n\n  1) Customer.authenticate \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059\n     Failure/Error: result = Customer.authenticate(customer.username, 'correct_password')\n     BCrypt::Errors::InvalidHash:\n       invalid hash\n     # ./app/models/customer.rb:29:in `new'\n     # ./app/models/customer.rb:29:in `authenticate'\n     # ./spec/models/customer_spec.rb:87:in `block (2 levels) in <top (required)>'\n\n  2) Customer.authenticate \u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u4e00\u81f4\u3057\u306a\u3044\u5834\u5408nil\u3092\u8fd4\u3059\n     Failure/Error: result = Customer.authenticate(customer.username, 'wrong_password')\n     BCrypt::Errors::InvalidHash:\n       invalid hash\n     # ./app/models/customer.rb:29:in `new'\n     # ./app/models/customer.rb:29:in `authenticate'\n     # ./spec/models/customer_spec.rb:92:in `block (2 levels) in <top (required)>'\n\n  3) Customer.authenticate \u30d1\u30b9\u30ef\u30fc\u30c9\u672a\u8a2d\u5b9a\u306e\u30e6\u30fc\u30b6\u30fc\u3092\u62d2\u7d76\u3059\u308b\n     Failure/Error: result = Customer.authenticate(customer.username, '')\n     BCrypt::Errors::InvalidHash:\n       invalid hash\n     # ./app/models/customer.rb:29:in `new'\n     # ./app/models/customer.rb:29:in `authenticate'\n     # ./spec/models/customer_spec.rb:103:in `block (2 levels) in <top (required)>'\n\nFinished in 0.0581 seconds (files took 2.91 seconds to load)\n4 examples, 3 failures\n\nFailed examples:\n\nrspec ./spec/models/customer_spec.rb:86 # Customer.authenticate \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059\nrspec ./spec/models/customer_spec.rb:91 # Customer.authenticate \u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u4e00\u81f4\u3057\u306a\u3044\u5834\u5408nil\u3092\u8fd4\u3059\nrspec ./spec/models/customer_spec.rb:101 # Customer.authenticate \u30d1\u30b9\u30ef\u30fc\u30c9\u672a\u8a2d\u5b9a\u306e\u30e6\u30fc\u30b6\u30fc\u3092\u62d2\u7d76\u3059\u308b\n```\n\n### \u30c6\u30b9\u30c8\u3092\u901a\u3059\n\n* model\u306e\u4fee\u6b63\n\n```diff\ndiff --git a/app/models/customer.rb b/app/models/customer.rb\nindex 9c7a21c..415f442 100644\n--- a/app/models/customer.rb\n+++ b/app/models/customer.rb\n@@ -26,7 +26,7 @@ class Customer < ActiveRecord::Base\n\n   def self.authenticate(username, password)\n     customer = find_by_username(username)\n-    if customer && BCrypt::Password.new(customer.password_digest) == customer.password\n+    if customer.try(:password_digest) && BCrypt::Password.new(customer.password_digest) == password\n       customer\n     else\n       nil\n```\n\n* \u30c6\u30b9\u30c8\u7d50\u679c\n  + \u624b\u9806\u901a\u308a\u306b\u3084\u3063\u3066\u3082\u30c6\u30b9\u30c8\u304c\u901a\u3089\u306a\u3044\u3002\n\n```sh\n[devnote@hooni:~/documents/study/oiax] % bin/rspec spec/models/customer_spec.rb:83\nRun options: include {:locations=>{\"./spec/models/customer_spec.rb\"=>[83]}}\n\nCustomer.authenticate\n\u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059 (FAILED - 1)\n\u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u4e00\u81f4\u3057\u306a\u3044\u5834\u5408nil\u3092\u8fd4\u3059 (FAILED - 2)\n\u8a72\u5f53\u3059\u308b\u30e6\u30fc\u30b6\u30fc\u540d\u304c\u5b58\u5728\u3057\u306a\u3044\u5834\u5408\u306fnil\u3092\u8fd4\u3059\n\u30d1\u30b9\u30ef\u30fc\u30c9\u672a\u8a2d\u5b9a\u306e\u30e6\u30fc\u30b6\u30fc\u3092\u62d2\u7d76\u3059\u308b\n\nFailures:\n\n1) Customer.authenticate \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059\n   Failure/Error: result = Customer.authenticate(customer.username, 'correct_password')\n   BCrypt::Errors::InvalidHash:\n     invalid hash\n   # ./app/models/customer.rb:29:in `new'\n   # ./app/models/customer.rb:29:in `authenticate'\n   # ./spec/models/customer_spec.rb:88:in `block (2 levels) in <top (required)>'\n\n2) Customer.authenticate \u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u4e00\u81f4\u3057\u306a\u3044\u5834\u5408nil\u3092\u8fd4\u3059\n   Failure/Error: result = Customer.authenticate(customer.username, 'wrong_password')\n   BCrypt::Errors::InvalidHash:\n     invalid hash\n   # ./app/models/customer.rb:29:in `new'\n   # ./app/models/customer.rb:29:in `authenticate'\n   # ./spec/models/customer_spec.rb:93:in `block (2 levels) in <top (required)>'\n\nFinished in 0.05406 seconds (files took 3 seconds to load)\n4 examples, 2 failures\n\nFailed examples:\n\nrspec ./spec/models/customer_spec.rb:87 # Customer.authenticate \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059\nrspec ./spec/models/customer_spec.rb:92 # Customer.authenticate \u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u4e00\u81f4\u3057\u306a\u3044\u5834\u5408nil\u3092\u8fd4\u3059\n```\n\n* spec\u306e\u4fee\u6b63\n  + \u30c6\u30b9\u30c8\u30b3\u30fc\u30c9\u306b\u4e0d\u5177\u5408\u304c\u3042\u3063\u305f\u306e\u3067\u3001\u4fee\u6b63\u3059\u308b\u3002\n\n```diff\ndiff --git a/spec/models/customer_spec.rb b/spec/models/customer_spec.rb\nindex 8192210..ab59045 100644\n--- a/spec/models/customer_spec.rb\n+++ b/spec/models/customer_spec.rb\n@@ -81,7 +81,7 @@ describe Customer, 'password=' do\n end\n\n describe Customer, '.authenticate' do\n-  let(:customer) {create(:customer, username: 'taro', password: 'correct_password')}\n+  let(:customer) {create(:customer, username: 'taro', password: BCrypt::Password.create('correct_password'))}\n```\n\n* \u518d\u30c6\u30b9\u30c8\u7d50\u679c\n\n```sh\n[devnote@hooni:~/documents/study/oiax] % bin/rspec spec/models/customer_spec.rb:83\nRun options: include {:locations=>{\"./spec/models/customer_spec.rb\"=>[83]}}\n\nCustomer.authenticate\n  \u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a72\u5f53\u3059\u308bCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u8fd4\u3059\n  \u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u4e00\u81f4\u3057\u306a\u3044\u5834\u5408nil\u3092\u8fd4\u3059\n  \u8a72\u5f53\u3059\u308b\u30e6\u30fc\u30b6\u30fc\u540d\u304c\u5b58\u5728\u3057\u306a\u3044\u5834\u5408\u306fnil\u3092\u8fd4\u3059\n  \u30d1\u30b9\u30ef\u30fc\u30c9\u672a\u8a2d\u5b9a\u306e\u30e6\u30fc\u30b6\u30fc\u3092\u62d2\u7d76\u3059\u308b\n\nFinished in 0.56011 seconds (files took 2.8 seconds to load)\n4 examples, 0 failures\n```\n\n## \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u306e\u30c6\u30b9\u30c8\uff08\uff16\uff09-- \u30b9\u30bf\u30d6\u3092\u5916\u3059\n\n* http://www.oiax.jp/rails/rspec_capybara_primer/signing_in6.html\n\n### \u30b9\u30bf\u30d6\u3092\u5916\u3059\n\n* spec\u306e\u4fee\u6b63\n\n```diff\ndiff --git a/spec/features/login_and_logout_spec.rb b/spec/features/login_and_logout_spec.rb\nindex 4bf0558..096dedd 100644\n--- a/spec/features/login_and_logout_spec.rb\n+++ b/spec/features/login_and_logout_spec.rb\n@@ -1,8 +1,9 @@\n require 'rails_helper'\n\n describe '\u30ed\u30b0\u30a4\u30f3' do\n+  before { create(:customer, username: 'taro', password: BCrypt::Password.create('correct_password')) }\n   example '\u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f' do\n-    allow(Customer).to receive(:authenticate).and_return(FactoryGirl.create(:customer))\n+    # allow(Customer).to receive(:authenticate).and_return(FactoryGirl.create(:customer))\n     visit root_path\n     within('form#new_session') do\n       fill_in 'username', with: 'taro'\n@@ -13,7 +14,7 @@ describe '\u30ed\u30b0\u30a4\u30f3' do\n   end\n\n   example '\u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557' do\n-    allow(Customer).to receive(:authenticate)\n+    # allow(Customer).to receive(:authenticate)\n     visit root_path\n     within('form#new_session') do\n       fill_in 'username', with: 'taro'\n```\n\n* \u30c6\u30b9\u30c8\u7d50\u679c\n\n```sh\n[devnote@hooni:~/documents/study/oiax] % bin/rspec spec/features/login_and_logout_spec.rb\n\n\u30ed\u30b0\u30a4\u30f3\n  \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u6210\u529f\n  \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\u5931\u6557\n\nFinished in 0.70919 seconds (files took 2.88 seconds to load)\n2 examples, 0 failures\n```\n\n### \u8981\u70b9\n\n* \u30c6\u30b9\u30c8\u3092\u901a\u3059\u306e\u306b\u5fc5\u8981\u6700\u5c0f\u9650\u306e\u30b3\u30fc\u30c9\u3092\u66f8\u304f\u3002\n* example\u306e\u8ffd\u52a0\u3068\u30e1\u30bd\u30c3\u30c9\u306e\u4eee\u5b9f\u88c5\u53ca\u3073\u30b9\u30bf\u30d6\u5316\u3092\u7e70\u308a\u8fd4\u3059\u3002\n* \u6700\u7d42\u7684\u306b\u306f\u8907\u96d1\u306a\u6a5f\u80fd\u3092\u6301\u3064\u30af\u30e9\u30b9\u3068\u30e1\u30bd\u30c3\u30c9\u3092\u5b8c\u6210\u3059\u308b\u3002\n\n### \u30b5\u30f3\u30d7\u30eb\u306e\u624b\u9806\uff08\u5916\u5074 -> \u5185\u5074 -> \u5916\u5074\uff09\n\n* \u5916\u5074\u306e\u30e6\u30fc\u30b6\u30fc\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u304b\u3089\u5b9f\u88c5\u3092\u59cb\u3081\u308b\u3002\uff08view\uff09\n* \u5fc5\u8981\u306a\u6a5f\u80fd\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u5b9f\u88c5\u3059\u308b\u3002\uff08controller\uff09\n* \u60c5\u5831\u306e\u4fdd\u5b58\u3044\u3046\u6700\u3082\u5185\u5074\u306e\u6a5f\u80fd\u3092\u5b9f\u88c5\u3059\u308b\u3002\uff08model\uff09\n* \u9006\u9806\u3067\u9061\u308b\u3002\u5fc5\u8981\u306a\u6a5f\u80fd\u306e\u30e1\u30bd\u30c3\u30c9\u306e\u4ed5\u4e0a\u3052\u3092\u3059\u308b\u3002\n* \u30e6\u30fc\u30b6\u30fc\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u306e\u30c6\u30b9\u30c8\u304b\u3089\u30b9\u30bf\u30d6\u3092\u5916\u3059\u3002\n", "tags": ["RSpec", "Capybara", "Rails", "bdd"]}