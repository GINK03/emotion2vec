{"tags": ["Varnish", "C"], "context": " More than 1 year has passed since last update.\n\n\u6982\u8981\nVarnish-Cache\u306e\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306fC\u3067\u66f8\u304b\u308c\u3066\u3044\u307e\u3059\u304c\u3001\u9ad8\u5ea6\u306a\u30de\u30af\u30ed\u304c\u4f7f\u7528\u3055\u308c\u3066\u3044\u308b\u305f\u3081\u95a2\u6570\u540d\u3067grep\u3057\u3066\u3082\u547c\u3073\u51fa\u3057\u3066\u3044\u308b\u7b87\u6240\u304c\u898b\u3064\u304b\u3089\u306a\u3044\u3053\u3068\u304c\u3042\u308a\u307e\u3057\u305f\u3002\n\u305d\u3053\u3067\u30de\u30af\u30ed\u3092\u5c55\u958b\u3057\u305f\u3082\u306e\u3092hnakamur/Varnish-Cache\u306emacros-expanded\u30d6\u30e9\u30f3\u30c1\u306b\u7f6e\u304d\u307e\u3057\u305f\u3002\n\n\u95a2\u6570\u540d\u3067grep\u3057\u3066\u3082\u547c\u3073\u51fa\u3057\u3066\u3044\u308b\u7b87\u6240\u304c\u898b\u3064\u304b\u3089\u306a\u3044\u4f8b\n\u8aac\u660e\u4e0a\u306fgrep\u3068\u66f8\u3044\u3066\u307e\u3059\u304c\u3001\u5b9f\u969b\u306fmonochromegane/the_platinum_searcher\u3092\u4f7f\u7528\u3057\u3066\u3044\u307e\u3059\u3002\u3044\u3064\u3082\u3042\u308a\u304c\u3068\u3046\u3054\u3056\u3044\u307e\u3059\uff01\n\u4f8b\u3048\u3070varnish/Varnish-Cache at 37d738e\u3067 vbf_stp_fetch \u3092\u691c\u7d22\u3059\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n$ pt vbf_stp_fetch\ndoc/graphviz/cache_fetch.dot:\n55:             v_b_r:non_304:s -> vbf_stp_fetch\n59:             vbf_stp_fetch [\n63:                            label=\"{vbf_stp_fetch:|setup VFPs|<fetch>fetch|{fetch_fail?|error?|<ok>ok?}}\"\n65:             vbf_stp_fetch:ok:s -> FETCH_DONE\n\nbin/varnishd/cache/cache_fetch.c:\n538:vbf_stp_fetch(struct worker *wrk, struct busyobj *bo)\n\n\nbin/varnishd/cache/cache_fetch.c \u306b\u3042\u308b vbf_stp_fetch \u306e\u95a2\u6570\u5b9a\u7fa9\u304c\u30d2\u30c3\u30c8\u3057\u3066\u307e\u3059\u304c\u3001\u547c\u3073\u51fa\u3057\u3066\u3044\u308b\u7b87\u6240\u304c\u30d2\u30c3\u30c8\u3057\u3066\u3044\u307e\u305b\u3093\u3002\n\n\u30de\u30af\u30ed\u5c55\u958b\u3057\u305f\u30bd\u30fc\u30b9\u3067\u691c\u7d22\nhnakamur/Varnish-Cache at f055446\u3067\u540c\u3058\u691c\u7d22\u3092\u3059\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n$ pt vbf_stp_fetch\ndoc/graphviz/cache_fetch.dot:\n55:             v_b_r:non_304:s -> vbf_stp_fetch\n59:             vbf_stp_fetch [\n63:                            label=\"{vbf_stp_fetch:|setup VFPs|<fetch>fetch|{fetch_fail?|error?|<ok>ok?}}\"\n65:             vbf_stp_fetch:ok:s -> FETCH_DONE\n\nbin/varnishd/cache/cache_fetch.c:\n10178:vbf_stp_fetch(struct worker *wrk, struct busyobj *bo)\n10558:case F_STP_FETCH: stp = vbf_stp_fetch (wrk, bo); break;\n\n\nbin/varnishd/cache/cache_fetch.c \u5185\u3067 vbf_stp_fetch \u3092\u547c\u3073\u51fa\u3059\u7b87\u6240\u3082\u30d2\u30c3\u30c8\u3057\u3066\u3044\u307e\u3059\u3002\n\u547c\u3073\u51fa\u3057\u7b87\u6240\u306e\u524d\u5f8c\u306e\u30b3\u30fc\u30c9\u306f\u3053\u3093\u306a\u611f\u3058\u3067\u3059\u3002\nbin/varnishd/cache/cache_fetch.c#L10547-L10567\n  switch(stp) {\n\n\n\n\n# 1 \"../../include/tbl/steps.h\" 1\n# 59 \"../../include/tbl/steps.h\"\ncase F_STP_MKBEREQ: stp = vbf_stp_mkbereq (wrk, bo); break;\ncase F_STP_RETRY: stp = vbf_stp_retry (wrk, bo); break;\ncase F_STP_STARTFETCH: stp = vbf_stp_startfetch (wrk, bo); break;\ncase F_STP_CONDFETCH: stp = vbf_stp_condfetch (wrk, bo); break;\ncase F_STP_FETCH: stp = vbf_stp_fetch (wrk, bo); break;\ncase F_STP_ERROR: stp = vbf_stp_error (wrk, bo); break;\ncase F_STP_FAIL: stp = vbf_stp_fail (wrk, bo); break;\ncase F_STP_DONE: stp = vbf_stp_done (); break;\n# 930 \"cache/cache_fetch.c\" 2\n\n  default:\n   do { VAS_Fail(__func__, \"cache/cache_fetch.c\", 932, \"Illegal fetch_step\", VAS_WRONG); } while (0);\n  }\n }\n\n\u3053\u308c\u306f\u5143\u306e\u30bd\u30fc\u30b9\u3067\u306f\u4ee5\u4e0b\u306e\u90e8\u5206\u306b\u5bfe\u5fdc\u3057\u307e\u3059\u3002\nbin/varnishd/cache/cache_fetch.c#L924-L933\n        switch(stp) {\n#define FETCH_STEP(l, U, arg)                       \\\n        case F_STP_##U:                     \\\n            stp = vbf_stp_##l arg;              \\\n            break;\n#include \"tbl/steps.h\"\n#undef FETCH_STEP\n        default:\n            WRONG(\"Illegal fetch_step\");\n        }\n\ninclude\u3057\u3066\u3044\u308b\"tbl/steps.h\"\u306e\u3046\u3061\u4e0a\u8a18\u306e\u30b3\u30fc\u30c9\u306b\u95a2\u308f\u308b\u90e8\u5206\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\ninclude/tbl/steps.h#L58-L67\n#ifdef FETCH_STEP\nFETCH_STEP(mkbereq, MKBEREQ,    (wrk, bo))\nFETCH_STEP(retry,   RETRY,      (wrk, bo))\nFETCH_STEP(startfetch,  STARTFETCH, (wrk, bo))\nFETCH_STEP(condfetch,   CONDFETCH,  (wrk, bo))\nFETCH_STEP(fetch,   FETCH,      (wrk, bo))\nFETCH_STEP(error,   ERROR,      (wrk, bo))\nFETCH_STEP(fail,    FAIL,       (wrk, bo))\nFETCH_STEP(done,    DONE,       ())\n#endif\n\n\n\u30de\u30af\u30ed\u5c55\u958b\u306b\u4f7f\u7528\u3057\u305f\u30b9\u30af\u30ea\u30d7\u30c8\n\u30de\u30af\u30ed\u5c55\u958b\u306b\u4f7f\u7528\u3057\u305f\u30b9\u30af\u30ea\u30d7\u30c8\u306fhnakamur/Varnish-Cache/expand-macros.sh at f055446\u306b\u7f6e\u3044\u3066\u3044\u307e\u3059\u3002\n\u57fa\u672c\u7684\u306b\u306f Makefile \u306e .c \u304b\u3089 .o \u3092\u4f5c\u308b\u30eb\u30fc\u30eb\u306e\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u306e gcc -c \u3092 gcc -E \u306b\u66f8\u304d\u63db\u3048\u3066 Makefile.expand-macros \u3092\u4f5c\u308a\u3001\u305d\u308c\u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\u3002\n.c \u304b\u3089 .o \u306e\u500b\u3005\u306e\u30d5\u30a1\u30a4\u30eb\u306e\u30eb\u30fc\u30eb\u304c\u6709\u308b\u5834\u5408\u3068\u7121\u3044\u5834\u5408\u306e\u6271\u3044\u304c\u96d1\u3067\u8b66\u544a\u304c\u51fa\u308b\u306e\u3067\u3059\u304c\u3001\u66f8\u6368\u3066\u30b9\u30af\u30ea\u30d7\u30c8\u306a\u306e\u3067\u76ee\u7684\u304c\u9054\u6210\u3067\u304d\u3066\u3044\u308c\u3070\u826f\u3057\u3068\u3044\u3046\u3053\u3068\u3067\u3002\n\n\u304a\u308f\u308a\u306b\n\u3053\u308c\u3067Varnish\u306e\u30b3\u30fc\u30c9\u5185\u306e\u691c\u7d22\u304c\u5feb\u9069\u306b\u306a\u308a\u307e\u3057\u305f\u3002\u30b3\u30fc\u30c9\u30ea\u30fc\u30c7\u30a3\u30f3\u30b0\u304c\u306f\u304b\u3069\u308a\u307e\u3059\u306d\uff01\n## \u6982\u8981\n[Varnish-Cache\u306e\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9](https://github.com/varnish/Varnish-Cache)\u306fC\u3067\u66f8\u304b\u308c\u3066\u3044\u307e\u3059\u304c\u3001\u9ad8\u5ea6\u306a\u30de\u30af\u30ed\u304c\u4f7f\u7528\u3055\u308c\u3066\u3044\u308b\u305f\u3081\u95a2\u6570\u540d\u3067grep\u3057\u3066\u3082\u547c\u3073\u51fa\u3057\u3066\u3044\u308b\u7b87\u6240\u304c\u898b\u3064\u304b\u3089\u306a\u3044\u3053\u3068\u304c\u3042\u308a\u307e\u3057\u305f\u3002\n\n\u305d\u3053\u3067\u30de\u30af\u30ed\u3092\u5c55\u958b\u3057\u305f\u3082\u306e\u3092[hnakamur/Varnish-Cache\u306emacros-expanded\u30d6\u30e9\u30f3\u30c1](https://github.com/hnakamur/Varnish-Cache/tree/macros-expanded)\u306b\u7f6e\u304d\u307e\u3057\u305f\u3002\n\n## \u95a2\u6570\u540d\u3067grep\u3057\u3066\u3082\u547c\u3073\u51fa\u3057\u3066\u3044\u308b\u7b87\u6240\u304c\u898b\u3064\u304b\u3089\u306a\u3044\u4f8b\n\n\u8aac\u660e\u4e0a\u306fgrep\u3068\u66f8\u3044\u3066\u307e\u3059\u304c\u3001\u5b9f\u969b\u306f[monochromegane/the_platinum_searcher](https://github.com/monochromegane/the_platinum_searcher)\u3092\u4f7f\u7528\u3057\u3066\u3044\u307e\u3059\u3002\u3044\u3064\u3082\u3042\u308a\u304c\u3068\u3046\u3054\u3056\u3044\u307e\u3059\uff01\n\n\u4f8b\u3048\u3070[varnish/Varnish-Cache at 37d738e](https://github.com/varnish/Varnish-Cache/tree/37d738ea4c04629766e510daf3d440ac621d8156)\u3067 `vbf_stp_fetch` \u3092\u691c\u7d22\u3059\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n```shell-session\n$ pt vbf_stp_fetch\ndoc/graphviz/cache_fetch.dot:\n55:             v_b_r:non_304:s -> vbf_stp_fetch\n59:             vbf_stp_fetch [\n63:                            label=\"{vbf_stp_fetch:|setup VFPs|<fetch>fetch|{fetch_fail?|error?|<ok>ok?}}\"\n65:             vbf_stp_fetch:ok:s -> FETCH_DONE\n\nbin/varnishd/cache/cache_fetch.c:\n538:vbf_stp_fetch(struct worker *wrk, struct busyobj *bo)\n\n```\n\n`bin/varnishd/cache/cache_fetch.c` \u306b\u3042\u308b `vbf_stp_fetch` \u306e\u95a2\u6570\u5b9a\u7fa9\u304c\u30d2\u30c3\u30c8\u3057\u3066\u307e\u3059\u304c\u3001\u547c\u3073\u51fa\u3057\u3066\u3044\u308b\u7b87\u6240\u304c\u30d2\u30c3\u30c8\u3057\u3066\u3044\u307e\u305b\u3093\u3002\n\n## \u30de\u30af\u30ed\u5c55\u958b\u3057\u305f\u30bd\u30fc\u30b9\u3067\u691c\u7d22\n\n[hnakamur/Varnish-Cache at f055446](https://github.com/hnakamur/Varnish-Cache/tree/f055446623a943230e8ad63ca5e2b9582c9f4b64)\u3067\u540c\u3058\u691c\u7d22\u3092\u3059\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n```shell-session\n$ pt vbf_stp_fetch\ndoc/graphviz/cache_fetch.dot:\n55:             v_b_r:non_304:s -> vbf_stp_fetch\n59:             vbf_stp_fetch [\n63:                            label=\"{vbf_stp_fetch:|setup VFPs|<fetch>fetch|{fetch_fail?|error?|<ok>ok?}}\"\n65:             vbf_stp_fetch:ok:s -> FETCH_DONE\n\nbin/varnishd/cache/cache_fetch.c:\n10178:vbf_stp_fetch(struct worker *wrk, struct busyobj *bo)\n10558:case F_STP_FETCH: stp = vbf_stp_fetch (wrk, bo); break;\n\n```\n\n`bin/varnishd/cache/cache_fetch.c` \u5185\u3067 `vbf_stp_fetch` \u3092\u547c\u3073\u51fa\u3059\u7b87\u6240\u3082\u30d2\u30c3\u30c8\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u547c\u3073\u51fa\u3057\u7b87\u6240\u306e\u524d\u5f8c\u306e\u30b3\u30fc\u30c9\u306f\u3053\u3093\u306a\u611f\u3058\u3067\u3059\u3002\n\n[bin/varnishd/cache/cache_fetch.c#L10547-L10567](https://github.com/hnakamur/Varnish-Cache/blob/f055446623a943230e8ad63ca5e2b9582c9f4b64/bin/varnishd/cache/cache_fetch.c#L10547-L10567)\n\n```c\n  switch(stp) {\n\n\n\n\n# 1 \"../../include/tbl/steps.h\" 1\n# 59 \"../../include/tbl/steps.h\"\ncase F_STP_MKBEREQ: stp = vbf_stp_mkbereq (wrk, bo); break;\ncase F_STP_RETRY: stp = vbf_stp_retry (wrk, bo); break;\ncase F_STP_STARTFETCH: stp = vbf_stp_startfetch (wrk, bo); break;\ncase F_STP_CONDFETCH: stp = vbf_stp_condfetch (wrk, bo); break;\ncase F_STP_FETCH: stp = vbf_stp_fetch (wrk, bo); break;\ncase F_STP_ERROR: stp = vbf_stp_error (wrk, bo); break;\ncase F_STP_FAIL: stp = vbf_stp_fail (wrk, bo); break;\ncase F_STP_DONE: stp = vbf_stp_done (); break;\n# 930 \"cache/cache_fetch.c\" 2\n\n  default:\n   do { VAS_Fail(__func__, \"cache/cache_fetch.c\", 932, \"Illegal fetch_step\", VAS_WRONG); } while (0);\n  }\n }\n```\n\n\u3053\u308c\u306f\u5143\u306e\u30bd\u30fc\u30b9\u3067\u306f\u4ee5\u4e0b\u306e\u90e8\u5206\u306b\u5bfe\u5fdc\u3057\u307e\u3059\u3002\n\n[bin/varnishd/cache/cache_fetch.c#L924-L933](https://github.com/varnish/Varnish-Cache/blob/37d738ea4c04629766e510daf3d440ac621d8156/bin/varnishd/cache/cache_fetch.c#L924-L933)\n\n```c\n\t\tswitch(stp) {\n#define FETCH_STEP(l, U, arg)\t\t\t\t\t\t\\\n\t\tcase F_STP_##U:\t\t\t\t\t\t\\\n\t\t\tstp = vbf_stp_##l arg;\t\t\t\t\\\n\t\t\tbreak;\n#include \"tbl/steps.h\"\n#undef FETCH_STEP\n\t\tdefault:\n\t\t\tWRONG(\"Illegal fetch_step\");\n\t\t}\n```\n\ninclude\u3057\u3066\u3044\u308b\"tbl/steps.h\"\u306e\u3046\u3061\u4e0a\u8a18\u306e\u30b3\u30fc\u30c9\u306b\u95a2\u308f\u308b\u90e8\u5206\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\n\n[include/tbl/steps.h#L58-L67](https://github.com/varnish/Varnish-Cache/blob/37d738ea4c04629766e510daf3d440ac621d8156/include/tbl/steps.h#L58-L67)\n\n```c\n#ifdef FETCH_STEP\nFETCH_STEP(mkbereq,\tMKBEREQ,\t(wrk, bo))\nFETCH_STEP(retry,\tRETRY,\t\t(wrk, bo))\nFETCH_STEP(startfetch,\tSTARTFETCH,\t(wrk, bo))\nFETCH_STEP(condfetch,\tCONDFETCH,\t(wrk, bo))\nFETCH_STEP(fetch,\tFETCH,\t\t(wrk, bo))\nFETCH_STEP(error,\tERROR,\t\t(wrk, bo))\nFETCH_STEP(fail,\tFAIL,\t\t(wrk, bo))\nFETCH_STEP(done,\tDONE,\t\t())\n#endif\n```\n\n## \u30de\u30af\u30ed\u5c55\u958b\u306b\u4f7f\u7528\u3057\u305f\u30b9\u30af\u30ea\u30d7\u30c8\n\n\u30de\u30af\u30ed\u5c55\u958b\u306b\u4f7f\u7528\u3057\u305f\u30b9\u30af\u30ea\u30d7\u30c8\u306f[hnakamur/Varnish-Cache/expand-macros.sh at f055446](https://github.com/hnakamur/Varnish-Cache/blob/f055446623a943230e8ad63ca5e2b9582c9f4b64/expand-macros.sh)\u306b\u7f6e\u3044\u3066\u3044\u307e\u3059\u3002\n\n\u57fa\u672c\u7684\u306b\u306f `Makefile` \u306e `.c` \u304b\u3089 `.o` \u3092\u4f5c\u308b\u30eb\u30fc\u30eb\u306e\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u306e `gcc -c` \u3092 `gcc -E` \u306b\u66f8\u304d\u63db\u3048\u3066 `Makefile.expand-macros` \u3092\u4f5c\u308a\u3001\u305d\u308c\u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\u3002\n\n`.c` \u304b\u3089 `.o` \u306e\u500b\u3005\u306e\u30d5\u30a1\u30a4\u30eb\u306e\u30eb\u30fc\u30eb\u304c\u6709\u308b\u5834\u5408\u3068\u7121\u3044\u5834\u5408\u306e\u6271\u3044\u304c\u96d1\u3067\u8b66\u544a\u304c\u51fa\u308b\u306e\u3067\u3059\u304c\u3001\u66f8\u6368\u3066\u30b9\u30af\u30ea\u30d7\u30c8\u306a\u306e\u3067\u76ee\u7684\u304c\u9054\u6210\u3067\u304d\u3066\u3044\u308c\u3070\u826f\u3057\u3068\u3044\u3046\u3053\u3068\u3067\u3002\n\n## \u304a\u308f\u308a\u306b\n\u3053\u308c\u3067Varnish\u306e\u30b3\u30fc\u30c9\u5185\u306e\u691c\u7d22\u304c\u5feb\u9069\u306b\u306a\u308a\u307e\u3057\u305f\u3002\u30b3\u30fc\u30c9\u30ea\u30fc\u30c7\u30a3\u30f3\u30b0\u304c\u306f\u304b\u3069\u308a\u307e\u3059\u306d\uff01\n"}