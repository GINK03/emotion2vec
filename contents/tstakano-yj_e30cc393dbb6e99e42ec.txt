{"context": "GYAO\u306ets\u3067\u3059\u3002\n\u6211\u3005\u306e\u30c1\u30fc\u30e0\u306f\u3001\u30aa\u30fc\u30eb\u30d1\u30d6\u30ea\u30c3\u30af\u30af\u30e9\u30a6\u30c9\u3067\u3001Microservice Architecture\u3092\u63a1\u7528\u3057\u305f\u6b21\u671f\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3092\u8a2d\u8a08\u4e2d\u3067\u3059\u3002\n\n\u7d4c\u7def\n\u524d\u56de\u306e\u6295\u7a3f\u3067\u3001DataFlow\u306e\u524d\u63d0\u77e5\u8b58\u3092\u3044\u304f\u3064\u304b\u307e\u3068\u3081\u305f\u306e\u3067\u3001\u65e9\u901f\u30cf\u30f3\u30ba\u30aa\u30f3\u3057\u3066\u307f\u308b\u3002\n\n\u4eca\u56de\u306e\u76ee\u6307\u3059\u3068\u3053\u308d\n\u4eca\u56de\u3082\u30c1\u30fc\u30e0\u5185\u306e\u30e1\u30f3\u30d0\u30fc\u5168\u54e1\u3067\u30a4\u30d9\u30f3\u30c8\u30c1\u30c3\u30af\u306b\u69cb\u7bc9\u3057\u3066\u307f\u308b\u3002\n\u3084\u308a\u305f\u3044\u3053\u3068\u306f\u4ee5\u4e0b\u3002\n\npubsub\u306brest\u5f62\u5f0f\u3067\u30e1\u30c3\u30bb\u30fc\u30b8\u3092publish\ndataflow\u306estream mode\u3067\u51e6\u7406\u3092\u884c\u3046\n\n\n\u30e1\u30c3\u30bb\u30fc\u30b8\u3092subscribe\n\u30e9\u30f3\u30c0\u30e0\u306a\u6587\u5b57\u5217\u3092\u767a\u884c\n\u767a\u884c\u3057\u305f\u6587\u5b57\u5217\u3092\u30ad\u30fc\u306bCloudDataStore\u306b\u767b\u9332\u3002\n\n\n\npubsub\u306brest\u5f62\u5f0f\u3067\u30e1\u30c3\u30bb\u30fc\u30b8\u3092publish\u3059\u308b\u524d\u306b\u3001Apigee\u3092\u7f6e\u3044\u3066\u9023\u643a\u3057\u305f\u3044\u304c\u3001\u305d\u308c\u306f\u5f8c\u307b\u3069\u3002\n\n\u6e96\u5099\n\nCloud Storage\nCloud Storage\u306b\u8ee2\u9001\u2192\u540c\u6642\u306bGCE\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u8d77\u52d5\u2192deploy\u306e\u3088\u3046\u306a\u5f62\u306b\u306a\u3063\u3066\u3044\u308b\u3088\u3046\u306a\u306e\u3067\u3001\u8ee2\u9001\u5148\u306e\u30d0\u30b1\u30c3\u30c8\u3092\u4f5c\u6210\u3059\u308b\u3002\uff08Eclipse\u304b\u3089\u3082\u4f5c\u6210\u53ef\u80fd\u3002\uff09\n\n\u2193\n\n\u2193\n\nflow-staging\u3068\u3044\u3046\u540d\u524d\u3067\u4f5c\u6210\u3002\n\nCloud Pub/Sub\nCloud Pub/Sub\u304b\u3089Stream\u30c7\u30fc\u30bf\u3092\u8cfc\u8aad\u3057\u3066\u305d\u306e\u5185\u5bb9\u3092store\u3059\u308b\u306e\u3067\u3001topic\u3092\u4f5c\u6210\u3059\u308b\u3002\n\n\u2193\n\n\u2193\n\n\u30c6\u30b9\u30c8\u30c8\u30d4\u30c3\u30af\u3092\u4f5c\u6210\u3002\n\nCloud DataStore\n\u7279\u306b\u6e96\u5099\u306e\u5fc5\u8981\u306f\u306a\u3057\u3002\n\nsetup\n\u3053\u3053\u304b\u3089\u306f\u30aa\u30d5\u30a3\u30b7\u30e3\u30eb\u306b\u6cbf\u3063\u3066\u3059\u3059\u3081\u308b\u3002\n\nCloud SDK\n\nSource: https://cloud.google.com/dataflow/docs/quickstarts/quickstart-java-eclipse\n\n1~3\u306f\u666e\u901a\u306b\u4f5c\u6210\u3001\u6709\u52b9\u306b\u3059\u308b\u3002\n4\u3000Eclipse\u3067\u958b\u767a\u3059\u308b\u30de\u30b7\u30f3\u306bCloudSDK\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3002 \n\n\ninstall\u5f8c\u3001\u4e0b\u8a18\u3092\u5b9f\u884c\u3002\n\n\ngcloud beta auth application-default login\neclipse\u304b\u3089\u306eauth\u306e\u8a2d\u5b9a \u3053\u3061\u3089\u306e\u30aa\u30d5\u30a3\u30b7\u30e3\u30eb\u3092\u53c2\u7167\u3002\n\n\n\n\n5\u30016\u3082\u305d\u306e\u901a\u308a\u306bEclipse Luna\u4ee5\u4e0a\u3001JDK1.7\u4ee5\u4e0a\u306e\u69cb\u6210\u3067\u3002 \n\n\nEclipse\n\u4eca\u56de\u306fEclipse neon\u3092\u4f7f\u7528\u3002\njdk1.8\nEclipse\u306b\u306f\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u30b5\u30a4\u30c8https://dl.google.com/dataflow/eclipse/ \u304b\u3089\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u304a\u304f\u3002\n\nPipeline\u4f5c\u6210\nEclipse\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u304a\u9670\u3067\u7c21\u5358\u306b\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u304c\u4f5c\u6210\u3067\u304d\u308b\u3002\uff08Maven\u3067\u3082\u69cb\u7bc9\u53ef\u80fd\uff09\n\n\n\u3059\u3059\u3081\u308b\u3068ProjectID\u3068Location\u3092\u306e\u5165\u529b\u753b\u9762\u304c\u3042\u308b\u306e\u3067\u3001\u5165\u529b\u3059\u308b\u3002\n\n\n\n\u9805\u76ee\n\u6982\u8981\n\n\n\n\nProjectID\n\u81ea\u5206\u306e\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306eID\n\n\nLocation\n\u5148\u7a0b\u4f5c\u6210\u3057\u305fCloudStorage\u306eLocation\u3002\u3053\u306e\u5834\u5408\u306fgs://flow-staging\u3000\u30d7\u30eb\u30c0\u30a6\u30f3\u3067\u51fa\u3066\u304d\u307e\u3059\u3002\n\n\n\n\nCoding\nPipeline\u306f\u6307\u5b9a\u3055\u308c\u305f\u30af\u30e9\u30b9\u306emain\u30e1\u30bd\u30c3\u30c9\u306e\u4e2d\u3067\u69cb\u7bc9\u3059\u308b\u3002Google\u63d0\u4f9b\u306e\u30b5\u30f3\u30d7\u30eb\u3092\u5c11\u3057\u3044\u3058\u3063\u3066\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u3066\u307f\u305f\u3002\n\nStoreJob.java\n\n    public static void main(String[] args) throws IOException {\n\n        Options options = PipelineOptionsFactory.fromArgs(args).withValidation().as(Options.class);\n        options.setDataset(\"xxxxxx\"); //ProjectId\n        options.setKind(\"data\"); //Datastore\u306ekind\n        options.setNamespace(\"default\"); //Datastore\u306enamespace\n        options.setJobName(\"store-job\"); //Deploy\u3055\u308c\u305f\u3042\u3068\u3001\u4e00\u89a7\u306b\u51fa\u308bJob\u306e\u540d\u524d\u3002\n        options.setStreaming(true); //streaming\u30e2\u30fc\u30c9\u306e\u6709\u52b9\u5316\n        Pipeline pipeline = Pipeline.create(options); //\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\u4f5c\u6210\n\n        PCollection<String> input;\n        LOG.info(\"Reading from PubSub.\");\n        input = pipeline.apply(PubsubIO.Read.named(\"subscriber\").topic(\"projects/xxxxxxxxx/topics/test\")) //Pub/Sub\u306e\u8cfc\u8aad\u3092apply\n                        .apply(Window.<String>into(SlidingWindows.of(Duration.standardMinutes(1)).every(Duration.standardSeconds(10)))); //pubsub\u306einput\u306funbounded\u306a\u306e\u3067\u3001bounded\u306e\u51e6\u7406\u3092\u884c\u3046\u305f\u3081\u306bwindow\u3092\u4f7f\u7528\uff081\u5206\u9593\u9593\u9694\u306ewindow\u300210\u79d2\u6bce\u306b\u65b0\u3057\u3044window\u3092\u751f\u6210\uff09\n        input.apply(ParDo.of(new CreateEntityFn(options.getNamespace(), options.getKind()))) //\n                .apply(DatastoreIO.v1().write().withProjectId(options.getDataset()));\n        pipeline.run();\n    }\n\n\nCreateEntityFn\u306f\u4e0b\u8a18\u306e\u901a\u308a\n\nCreateEntityFn.java\n    static class CreateEntityFn extends DoFn<String, Entity> {\n\n        private final String namespace;\n        private final String kind;\n        private final com.google.datastore.v1.Key ancestorKey;\n\n        CreateEntityFn(String namespace, String kind) {\n            this.namespace = namespace;\n            this.kind = kind;\n            ancestorKey = makeAncestorKey(namespace, kind);\n        }\n\n        public Entity makeEntity(String content) {\n            Entity.Builder entityBuilder = Entity.newBuilder();\n            Key.Builder keyBuilder = makeKey(ancestorKey, kind, UUID.randomUUID().toString());\n            if (namespace != null) {\n                keyBuilder.getPartitionIdBuilder().setNamespaceId(namespace);\n            }\n            else {\n                //do nothing.\n            }\n            entityBuilder.setKey(keyBuilder.build());\n            entityBuilder.getMutableProperties().put(\"content\", makeValue(content).build());\n            LOG.info(\"create Entity included content : \" + content);\n            return entityBuilder.build();\n        }\n\n        @Override\n        public void processElement(ProcessContext c) {\n            c.output(makeEntity(c.element()));\n        }\n    }\n\n\n\nDeploy\nEclipse\u306eRun\u2192Run Configurations\u3067\u4e0b\u8a18\u3092\u4f5c\u6210\n\nMainClass\u3092\u6307\u5b9a\u3002\n\nprojectId\u3068\nstaging Location\u3092\u6307\u5b9a\u3002\nDataflowPipelineRunner\u3092\u4f7f\u7528\u3059\u308b\u3002PipelineRunner\u306b\u95a2\u3057\u3066\u306f\u524d\u56de\u306e\u6295\u7a3f\u3092\u53c2\u7167\nRun\u3002\u4ee5\u4e0a\u3002\n\nCloudStorage\u306e\u6307\u5b9a\u30d0\u30b1\u30c3\u30c8\u306bStaging\u3068\u3057\u3066\u4fdd\u5b58\u3055\u308c\u308b\u3002\n\nDataflow\u306e\u30b3\u30f3\u30bd\u30fc\u30eb\u3067job\u3092\u78ba\u8a8d\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\n\n\u5b9f\u884c\n\npubsub\u306etopic\u3092\u898b\u308b\u3068\u3001subscription\u304c\u767b\u9332\u3055\u308c\u3066\u3044\u308b\u306e\u304c\u308f\u304b\u308b\u3002\n\u305d\u308c\u3067\u306f\u5b9f\u969b\u306bpubsub\u306bpush\u3057\u3066\u307f\u308b\u3002\n\n\u516c\u958b\u30dc\u30bf\u30f3\u304b\u3089\n\n\u9069\u5f53\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u30f3\u30b0\n\nDataflow\u306e\u753b\u9762\u3067\u306f\u8981\u7d20\u6570\u304c\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u30671\u306b\u304b\u308f\u308b\u3002\n\nLogs\u2192\u30ef\u30fc\u30ab\u30fc\u30ed\u30b0\u3067\u30ed\u30b0\u3092\u898b\u3066\u307f\u308b\u3068\u3001Entity\u304c\u4f5c\u6210\u3055\u308c\u305f\u306e\u304c\u308f\u304b\u308b\u3002\n\n\u30c7\u30fc\u30bf\u30b9\u30c8\u30a2\u306edefault\u540d\u524d\u7a7a\u9593\u3092\u898b\u3066\u307f\u308b\u3068\u3001data kind\u306b\n\n\u4fdd\u5b58\u3092\u78ba\u8a8d\u3002\n\n\u6b21\u56de\n\u524d\u56de\u306e\u6295\u7a3f\u3067\u3001Cloud Pub/Sub\u3067\u9806\u5e8f\u6027\u304c\u4fdd\u8a3c\u3055\u308c\u306a\u3044\u3053\u3068\u306b\u6c17\u4ed8\u3044\u305f\u306e\u3067\u3001\u8a2d\u8a08\u3092\u5c11\u3057\u5909\u3048\u3088\u3046\u304b\u3068\u3002\nGYAO\u306ets\u3067\u3059\u3002\n\u6211\u3005\u306e\u30c1\u30fc\u30e0\u306f\u3001\u30aa\u30fc\u30eb\u30d1\u30d6\u30ea\u30c3\u30af\u30af\u30e9\u30a6\u30c9\u3067\u3001[Microservice Architecture](http://microservices.io/patterns/microservices.html)\u3092\u63a1\u7528\u3057\u305f\u6b21\u671f\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3092\u8a2d\u8a08\u4e2d\u3067\u3059\u3002\n\n# \u7d4c\u7def\n[\u524d\u56de\u306e\u6295\u7a3f](http://qiita.com/tstakano-yj/items/0ccbbde10cf177cad03b)\u3067\u3001DataFlow\u306e\u524d\u63d0\u77e5\u8b58\u3092\u3044\u304f\u3064\u304b\u307e\u3068\u3081\u305f\u306e\u3067\u3001\u65e9\u901f\u30cf\u30f3\u30ba\u30aa\u30f3\u3057\u3066\u307f\u308b\u3002\n\n# \u4eca\u56de\u306e\u76ee\u6307\u3059\u3068\u3053\u308d\n\u4eca\u56de\u3082\u30c1\u30fc\u30e0\u5185\u306e\u30e1\u30f3\u30d0\u30fc\u5168\u54e1\u3067\u30a4\u30d9\u30f3\u30c8\u30c1\u30c3\u30af\u306b\u69cb\u7bc9\u3057\u3066\u307f\u308b\u3002\n\u3084\u308a\u305f\u3044\u3053\u3068\u306f\u4ee5\u4e0b\u3002\n\n 1. pubsub\u306brest\u5f62\u5f0f\u3067\u30e1\u30c3\u30bb\u30fc\u30b8\u3092publish\n 1. dataflow\u306estream mode\u3067\u51e6\u7406\u3092\u884c\u3046\n    1. \u30e1\u30c3\u30bb\u30fc\u30b8\u3092subscribe\n    1. \u30e9\u30f3\u30c0\u30e0\u306a\u6587\u5b57\u5217\u3092\u767a\u884c\n    1. \u767a\u884c\u3057\u305f\u6587\u5b57\u5217\u3092\u30ad\u30fc\u306bCloudDataStore\u306b\u767b\u9332\u3002\n \npubsub\u306brest\u5f62\u5f0f\u3067\u30e1\u30c3\u30bb\u30fc\u30b8\u3092publish\u3059\u308b\u524d\u306b\u3001[Apigee](http://qiita.com/tstakano-yj/items/2a6c672990333795fcda)\u3092\u7f6e\u3044\u3066\u9023\u643a\u3057\u305f\u3044\u304c\u3001\u305d\u308c\u306f\u5f8c\u307b\u3069\u3002\n\n# \u6e96\u5099\n## Cloud Storage \nCloud Storage\u306b\u8ee2\u9001\u2192\u540c\u6642\u306bGCE\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u8d77\u52d5\u2192deploy\u306e\u3088\u3046\u306a\u5f62\u306b\u306a\u3063\u3066\u3044\u308b\u3088\u3046\u306a\u306e\u3067\u3001\u8ee2\u9001\u5148\u306e\u30d0\u30b1\u30c3\u30c8\u3092\u4f5c\u6210\u3059\u308b\u3002\uff08Eclipse\u304b\u3089\u3082\u4f5c\u6210\u53ef\u80fd\u3002\uff09\n<img width=\"266\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-10-29 23.06.16.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/114329/f2809da2-66c1-6411-514c-10714c897c2b.png\">\n\u2193\n<img width=\"304\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-10-29 23.10.43.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/114329/94d97074-3996-b392-034a-d7458bca7ea2.png\">\n\u2193\n<img width=\"524\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-10-29 23.16.15.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/114329/b5d45a2d-4aa5-ff4b-ba74-a68c5ed701e7.png\">\nflow-staging\u3068\u3044\u3046\u540d\u524d\u3067\u4f5c\u6210\u3002\n\n## Cloud Pub/Sub\nCloud Pub/Sub\u304b\u3089Stream\u30c7\u30fc\u30bf\u3092\u8cfc\u8aad\u3057\u3066\u305d\u306e\u5185\u5bb9\u3092store\u3059\u308b\u306e\u3067\u3001topic\u3092\u4f5c\u6210\u3059\u308b\u3002\n<img width=\"301\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-10-29 23.19.26.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/114329/0a16e177-2ecc-445b-df9b-2aa27f7c650c.png\">\n\u2193\n<img width=\"423\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-10-29 23.22.26.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/114329/f3293f78-2179-6962-5190-00d1de236887.png\">\n\u2193\n<img width=\"551\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-10-29 23.24.33.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/114329/932f2ad1-ab1b-bee0-07e0-11572091d057.png\">\n\u30c6\u30b9\u30c8\u30c8\u30d4\u30c3\u30af\u3092\u4f5c\u6210\u3002\n\n## Cloud DataStore\n\u7279\u306b\u6e96\u5099\u306e\u5fc5\u8981\u306f\u306a\u3057\u3002\n\n# setup\n\u3053\u3053\u304b\u3089\u306f[\u30aa\u30d5\u30a3\u30b7\u30e3\u30eb](https://cloud.google.com/dataflow/docs/quickstarts/quickstart-java-eclipse)\u306b\u6cbf\u3063\u3066\u3059\u3059\u3081\u308b\u3002\n## Cloud SDK \n<img width=\"783\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-10-30 0.07.40.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/114329/66e3733b-4d2b-ee17-b816-7a0bbb6f9ca4.png\">\nSource: https://cloud.google.com/dataflow/docs/quickstarts/quickstart-java-eclipse\n\n - 1~3\u306f\u666e\u901a\u306b\u4f5c\u6210\u3001\u6709\u52b9\u306b\u3059\u308b\u3002\n - 4\u3000Eclipse\u3067\u958b\u767a\u3059\u308b\u30de\u30b7\u30f3\u306bCloudSDK\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3002 \n    - install\u5f8c\u3001\u4e0b\u8a18\u3092\u5b9f\u884c\u3002\n        - `gcloud beta auth application-default login`\n        - eclipse\u304b\u3089\u306eauth\u306e\u8a2d\u5b9a [\u3053\u3061\u3089\u306e\u30aa\u30d5\u30a3\u30b7\u30e3\u30eb](https://cloud.google.com/sdk/gcloud/reference/beta/auth/application-default/login)\u3092\u53c2\u7167\u3002\n - 5\u30016\u3082\u305d\u306e\u901a\u308a\u306bEclipse Luna\u4ee5\u4e0a\u3001JDK1.7\u4ee5\u4e0a\u306e\u69cb\u6210\u3067\u3002 \n\n## Eclipse \n\u4eca\u56de\u306fEclipse neon\u3092\u4f7f\u7528\u3002\njdk1.8\nEclipse\u306b\u306f\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u30b5\u30a4\u30c8https://dl.google.com/dataflow/eclipse/ \u304b\u3089\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u304a\u304f\u3002\n\n## Pipeline\u4f5c\u6210\nEclipse\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u304a\u9670\u3067\u7c21\u5358\u306b\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u304c\u4f5c\u6210\u3067\u304d\u308b\u3002\uff08[Maven\u3067\u3082\u69cb\u7bc9\u53ef\u80fd](https://cloud.google.com/dataflow/docs/quickstarts/quickstart-java-maven)\uff09\n<img width=\"527\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-10-30 0.29.13.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/114329/f14a2750-12cc-6132-8d6c-dc5173957541.png\">\n<img width=\"468\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-10-30 0.33.36.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/114329/985e393b-493a-332c-f30d-d8de80997d7e.png\">\n\u3059\u3059\u3081\u308b\u3068ProjectID\u3068Location\u3092\u306e\u5165\u529b\u753b\u9762\u304c\u3042\u308b\u306e\u3067\u3001\u5165\u529b\u3059\u308b\u3002\n\n| \u9805\u76ee | \u6982\u8981 |\n|:-----|:-----|\n| ProjectID  |  \u81ea\u5206\u306e\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306eID |\n| Location  |  \u5148\u7a0b\u4f5c\u6210\u3057\u305fCloudStorage\u306eLocation\u3002\u3053\u306e\u5834\u5408\u306fgs://flow-staging\u3000\u30d7\u30eb\u30c0\u30a6\u30f3\u3067\u51fa\u3066\u304d\u307e\u3059\u3002 |\n\n### Coding\nPipeline\u306f\u6307\u5b9a\u3055\u308c\u305f\u30af\u30e9\u30b9\u306emain\u30e1\u30bd\u30c3\u30c9\u306e\u4e2d\u3067\u69cb\u7bc9\u3059\u308b\u3002Google\u63d0\u4f9b\u306e\u30b5\u30f3\u30d7\u30eb\u3092\u5c11\u3057\u3044\u3058\u3063\u3066\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u3066\u307f\u305f\u3002\n\n```java:StoreJob.java\n\n\tpublic static void main(String[] args) throws IOException {\n\n\t\tOptions options = PipelineOptionsFactory.fromArgs(args).withValidation().as(Options.class);\n\t\toptions.setDataset(\"xxxxxx\"); //ProjectId\n\t\toptions.setKind(\"data\"); //Datastore\u306ekind\n\t\toptions.setNamespace(\"default\"); //Datastore\u306enamespace\n\t\toptions.setJobName(\"store-job\"); //Deploy\u3055\u308c\u305f\u3042\u3068\u3001\u4e00\u89a7\u306b\u51fa\u308bJob\u306e\u540d\u524d\u3002\n\t\toptions.setStreaming(true); //streaming\u30e2\u30fc\u30c9\u306e\u6709\u52b9\u5316\n\t\tPipeline pipeline = Pipeline.create(options); //\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\u4f5c\u6210\n\n\t\tPCollection<String> input;\n\t\tLOG.info(\"Reading from PubSub.\");\n\t\tinput = pipeline.apply(PubsubIO.Read.named(\"subscriber\").topic(\"projects/xxxxxxxxx/topics/test\")) //Pub/Sub\u306e\u8cfc\u8aad\u3092apply\n\t\t\t\t\t\t.apply(Window.<String>into(SlidingWindows.of(Duration.standardMinutes(1)).every(Duration.standardSeconds(10)))); //pubsub\u306einput\u306funbounded\u306a\u306e\u3067\u3001bounded\u306e\u51e6\u7406\u3092\u884c\u3046\u305f\u3081\u306bwindow\u3092\u4f7f\u7528\uff081\u5206\u9593\u9593\u9694\u306ewindow\u300210\u79d2\u6bce\u306b\u65b0\u3057\u3044window\u3092\u751f\u6210\uff09\n\t\tinput.apply(ParDo.of(new CreateEntityFn(options.getNamespace(), options.getKind()))) //\n\t\t\t\t.apply(DatastoreIO.v1().write().withProjectId(options.getDataset()));\n\t\tpipeline.run();\n\t}\n```\nCreateEntityFn\u306f\u4e0b\u8a18\u306e\u901a\u308a\n\n```java:CreateEntityFn.java\n\tstatic class CreateEntityFn extends DoFn<String, Entity> {\n\n\t\tprivate final String namespace;\n\t\tprivate final String kind;\n\t\tprivate final com.google.datastore.v1.Key ancestorKey;\n\n\t\tCreateEntityFn(String namespace, String kind) {\n\t\t\tthis.namespace = namespace;\n\t\t\tthis.kind = kind;\n\t\t\tancestorKey = makeAncestorKey(namespace, kind);\n\t\t}\n\n\t\tpublic Entity makeEntity(String content) {\n\t\t\tEntity.Builder entityBuilder = Entity.newBuilder();\n\t\t\tKey.Builder keyBuilder = makeKey(ancestorKey, kind, UUID.randomUUID().toString());\n\t\t\tif (namespace != null) {\n\t\t\t\tkeyBuilder.getPartitionIdBuilder().setNamespaceId(namespace);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t//do nothing.\n\t\t\t}\n\t\t\tentityBuilder.setKey(keyBuilder.build());\n\t\t\tentityBuilder.getMutableProperties().put(\"content\", makeValue(content).build());\n\t\t\tLOG.info(\"create Entity included content : \" + content);\n\t\t\treturn entityBuilder.build();\n\t\t}\n\n\t\t@Override\n\t\tpublic void processElement(ProcessContext c) {\n\t\t\tc.output(makeEntity(c.element()));\n\t\t}\n\t}\n```\n\n# Deploy\nEclipse\u306eRun\u2192Run Configurations\u3067\u4e0b\u8a18\u3092\u4f5c\u6210\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-10-31 15.01.19.png](https://qiita-image-store.s3.amazonaws.com/0/114329/1f8e49de-9135-1f0f-a8bb-e52e5a7a57c6.png)\nMainClass\u3092\u6307\u5b9a\u3002\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-10-31 15.04.05.png](https://qiita-image-store.s3.amazonaws.com/0/114329/386399ba-f81d-bd6a-1e1f-3648c76ac4fa.png)\nprojectId\u3068\nstaging Location\u3092\u6307\u5b9a\u3002\nDataflowPipelineRunner\u3092\u4f7f\u7528\u3059\u308b\u3002PipelineRunner\u306b\u95a2\u3057\u3066\u306f[\u524d\u56de\u306e\u6295\u7a3f](http://qiita.com/tstakano-yj/items/0ccbbde10cf177cad03b)\u3092\u53c2\u7167\nRun\u3002\u4ee5\u4e0a\u3002\n<img width=\"1138\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-10-31 15.18.03.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/114329/283eda2d-6fe0-b273-5dbf-3f248a42cc48.png\">\nCloudStorage\u306e\u6307\u5b9a\u30d0\u30b1\u30c3\u30c8\u306bStaging\u3068\u3057\u3066\u4fdd\u5b58\u3055\u308c\u308b\u3002\n<img width=\"369\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-10-31 15.19.45.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/114329/412503c7-b47b-1d12-749c-c2fcfa567064.png\">\nDataflow\u306e\u30b3\u30f3\u30bd\u30fc\u30eb\u3067job\u3092\u78ba\u8a8d\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n<img width=\"424\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-10-31 15.21.07.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/114329/5869674c-5fb3-a3ab-9ee4-af79c93764a8.png\">\n\n# \u5b9f\u884c\n<img width=\"575\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-10-31 15.22.16.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/114329/d97acf94-3945-b4f9-0aaf-d14784ff7a7b.png\">\n\npubsub\u306etopic\u3092\u898b\u308b\u3068\u3001subscription\u304c\u767b\u9332\u3055\u308c\u3066\u3044\u308b\u306e\u304c\u308f\u304b\u308b\u3002\n\u305d\u308c\u3067\u306f\u5b9f\u969b\u306bpubsub\u306bpush\u3057\u3066\u307f\u308b\u3002\n\n\n<img width=\"1110\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-10-31 15.23.33.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/114329/c2e8f095-37a5-c297-f2ae-633b6392e394.png\">\n\u516c\u958b\u30dc\u30bf\u30f3\u304b\u3089\n\n\n\n<img width=\"454\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-10-31 15.25.13.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/114329/1e6cdaca-77eb-f1b3-e21e-a2b136a089c4.png\">\n\u9069\u5f53\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u30f3\u30b0\n\n\n\n<img width=\"1011\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-10-31 15.26.05.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/114329/61d006bf-bd7c-1a8d-8d1e-3c7aee01d864.png\">\nDataflow\u306e\u753b\u9762\u3067\u306f\u8981\u7d20\u6570\u304c\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u30671\u306b\u304b\u308f\u308b\u3002\n\n\n\n<img width=\"397\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-10-31 15.28.26.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/114329/3bb4b25c-75d2-02d8-f41c-aad0776812d2.png\">\nLogs\u2192\u30ef\u30fc\u30ab\u30fc\u30ed\u30b0\u3067\u30ed\u30b0\u3092\u898b\u3066\u307f\u308b\u3068\u3001Entity\u304c\u4f5c\u6210\u3055\u308c\u305f\u306e\u304c\u308f\u304b\u308b\u3002\n\n\n\n<img width=\"535\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-10-31 15.30.09.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/114329/2cb0acf7-9a89-2828-885b-c03bb2a6ca9f.png\">\n\u30c7\u30fc\u30bf\u30b9\u30c8\u30a2\u306edefault\u540d\u524d\u7a7a\u9593\u3092\u898b\u3066\u307f\u308b\u3068\u3001data kind\u306b\n\n\n\n<img width=\"727\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-10-31 15.32.16.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/114329/91248c23-9087-94cd-2abb-6cf719e2c2e5.png\">\n\u4fdd\u5b58\u3092\u78ba\u8a8d\u3002\n\n# \u6b21\u56de\n[\u524d\u56de\u306e\u6295\u7a3f](http://qiita.com/tstakano-yj/items/0ccbbde10cf177cad03b)\u3067\u3001Cloud Pub/Sub\u3067\u9806\u5e8f\u6027\u304c\u4fdd\u8a3c\u3055\u308c\u306a\u3044\u3053\u3068\u306b\u6c17\u4ed8\u3044\u305f\u306e\u3067\u3001\u8a2d\u8a08\u3092\u5c11\u3057\u5909\u3048\u3088\u3046\u304b\u3068\u3002\n", "tags": ["GoogleCloudPlatform", "GoogleCloudStorage", "GoogleCloudDataflow", "GoogleCloudPubSub", "Java"]}