{"context": " More than 1 year has passed since last update.iptables\u3092\u6539\u3081\u3066\u52c9\u5f37\u3057\u306a\u304a\u3057\u307e\u3057\u305f\u3002\u30c4\u30c3\u30b3\u30df\u6b53\u8fce\u3067\u3059^-^\nGitHub: https://github.com/suin/iptables/blob/master/iptables.sh\n\niptables.sh\n#!/bin/bash\n\n###########################################################\n# \u3053\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u7279\u5fb4\n#\n# \u53d7\u4fe1\u30fb\u901a\u904e\u306b\u3064\u3044\u3066\u306f\u57fa\u672c\u7684\u306b\u7834\u68c4\u3057\u3001\u30db\u30ef\u30a4\u30c8\u30ea\u30b9\u30c8\u3067\u8a31\u53ef\u3059\u308b\u3082\u306e\u3092\u6307\u5b9a\u3059\u308b\u3002\n# \u9001\u4fe1\u306b\u3064\u3044\u3066\u306f\u57fa\u672c\u7684\u306b\u8a31\u53ef\u3059\u308b\u3002\u305f\u3060\u3057\u3001\u30b5\u30fc\u30d0\u304c\u8e0f\u307f\u53f0\u306b\u306a\u308a\u5916\u90e8\u306e\u30b5\u30fc\u30d0\u306b\u8ff7\u60d1\u3092\u304b\u3051\u308b\u53ef\u80fd\u6027\u304c\u3042\u308b\u306e\u3067\u3001\n# \u5fc3\u914d\u306a\u5834\u5408\u306f\u3001\u9001\u4fe1\u3082\u53d7\u4fe1\u540c\u69d8\u306b\u57fa\u672c\u7834\u68c4\u30fb\u30db\u30ef\u30a4\u30c8\u30ea\u30b9\u30c8\u3067\u8a31\u53ef\u3059\u308b\u3088\u3046\u306b\u66f8\u304d\u63db\u3048\u308b\u3068\u826f\u3044\u3002\n###########################################################\n\n###########################################################\n# \u7528\u8a9e\u306e\u7d71\u4e00\n# \u308f\u304b\u308a\u3084\u3059\u3055\u306e\u305f\u3081\u30eb\u30fc\u30eb\u3068\u30b3\u30e1\u30f3\u30c8\u306e\u7528\u8a9e\u3092\u4ee5\u4e0b\u306b\u7d71\u4e00\u3059\u308b\n# ACCEPT : \u8a31\u53ef\n# DROP   : \u7834\u68c4\n# REJECT : \u62d2\u5426\n###########################################################\n\n###########################################################\n# \u30c1\u30fc\u30c8\u30b7\u30fc\u30c8\n#\n# -A, --append       \u6307\u5b9a\u30c1\u30a7\u30a4\u30f3\u306b1\u3064\u4ee5\u4e0a\u306e\u65b0\u3057\u3044\u30eb\u30fc\u30eb\u3092\u8ffd\u52a0\n# -D, --delete       \u6307\u5b9a\u30c1\u30a7\u30a4\u30f3\u304b\u30891\u3064\u4ee5\u4e0a\u306e\u30eb\u30fc\u30eb\u3092\u524a\u9664\n# -P, --policy       \u6307\u5b9a\u30c1\u30a7\u30a4\u30f3\u306e\u30dd\u30ea\u30b7\u30fc\u3092\u6307\u5b9a\u3057\u305f\u30bf\u30fc\u30b2\u30c3\u30c8\u306b\u8a2d\u5b9a\n# -N, --new-chain    \u65b0\u3057\u3044\u30e6\u30fc\u30b6\u30fc\u5b9a\u7fa9\u30c1\u30a7\u30a4\u30f3\u3092\u4f5c\u6210\n# -X, --delete-chain \u6307\u5b9a\u30e6\u30fc\u30b6\u30fc\u5b9a\u7fa9\u30c1\u30a7\u30a4\u30f3\u3092\u524a\u9664\n# -F                 \u30c6\u30fc\u30d6\u30eb\u521d\u671f\u5316\n#\n# -p, --protocol      \u30d7\u30ed\u30b3\u30c8\u30eb         \u30d7\u30ed\u30c8\u30b3\u30eb(tcp\u3001udp\u3001icmp\u3001all)\u3092\u6307\u5b9a\n# -s, --source        IP\u30a2\u30c9\u30ec\u30b9[/mask]  \u9001\u4fe1\u5143\u306e\u30a2\u30c9\u30ec\u30b9\u3002IP\u30a2\u30c9\u30ec\u30b9or\u30db\u30b9\u30c8\u540d\u3092\u8a18\u8ff0\n# -d, --destination   IP\u30a2\u30c9\u30ec\u30b9[/mask]  \u9001\u4fe1\u5148\u306e\u30a2\u30c9\u30ec\u30b9\u3002IP\u30a2\u30c9\u30ec\u30b9or\u30db\u30b9\u30c8\u540d\u3092\u8a18\u8ff0\n# -i, --in-interface  \u30c7\u30d0\u30a4\u30b9           \u30d1\u30b1\u30c3\u30c8\u304c\u5165\u3063\u3066\u304f\u308b\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30a4\u30b9\u3092\u6307\u5b9a\n# -o, --out-interface \u30c7\u30d0\u30a4\u30b9           \u30d1\u30b1\u30c3\u30c8\u304c\u51fa\u3066\u3044\u304f\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30a4\u30b9\u3092\u6307\u5b9a\n# -j, --jump          \u30bf\u30fc\u30b2\u30c3\u30c8         \u6761\u4ef6\u306b\u5408\u3063\u305f\u3068\u304d\u306e\u30a2\u30af\u30b7\u30e7\u30f3\u3092\u6307\u5b9a\n# -t, --table         \u30c6\u30fc\u30d6\u30eb           \u30c6\u30fc\u30d6\u30eb\u3092\u6307\u5b9a\n# -m state --state    \u72b6\u614b              \u30d1\u30b1\u30c3\u30c8\u306e\u72b6\u614b\u3092\u6761\u4ef6\u3068\u3057\u3066\u6307\u5b9a\n#                                       state\u306f\u3001 NEW\u3001ESTABLISHED\u3001RELATED\u3001INVALID\u304c\u6307\u5b9a\u3067\u304d\u308b\n# !                   \u6761\u4ef6\u3092\u53cd\u8ee2\uff08\uff5e\u4ee5\u5916\u3068\u306a\u308b\uff09\n###########################################################\n\n# \u30d1\u30b9\nPATH=/sbin:/usr/sbin:/bin:/usr/bin\n\n###########################################################\n# IP\u306e\u5b9a\u7fa9\n# \u5fc5\u8981\u306b\u5fdc\u3058\u3066\u5b9a\u7fa9\u3059\u308b\u3002\u5b9a\u7fa9\u3057\u306a\u304f\u3066\u3082\u52d5\u4f5c\u3059\u308b\u3002\n###########################################################\n\n# \u5185\u90e8\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3068\u3057\u3066\u8a31\u53ef\u3059\u308b\u7bc4\u56f2\n# LOCAL_NET=\"xxx.xxx.xxx.xxx/xx\"\n\n# \u5185\u90e8\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3068\u3057\u3066\u4e00\u90e8\u5236\u9650\u4ed8\u304d\u3067\u8a31\u53ef\u3059\u308b\u7bc4\u56f2\n# LIMITED_LOCAL_NET=\"xxx.xxx.xxx.xxx/xx\"\n\n# Zabbix\u30b5\u30fc\u30d0\u30fcIP\n# ZABBIX_IP=\"xxx.xxx.xxx.xxx\"\n\n# \u5168\u3066\u306eIP\u3092\u8868\u3059\u8a2d\u5b9a\u3092\u5b9a\u7fa9\n# ANY=\"0.0.0.0/0\"\n\n# \u4fe1\u983c\u53ef\u80fd\u30db\u30b9\u30c8(\u914d\u5217)\n# ALLOW_HOSTS=(\n#   \"xxx.xxx.xxx.xxx\"\n#   \"xxx.xxx.xxx.xxx\"\n#   \"xxx.xxx.xxx.xxx\"\n# )\n\n# \u7121\u6761\u4ef6\u7834\u68c4\u3059\u308b\u30ea\u30b9\u30c8(\u914d\u5217)\n# DENY_HOSTS=(\n#   \"xxx.xxx.xxx.xxx\"\n#   \"xxx.xxx.xxx.xxx\"\n#   \"xxx.xxx.xxx.xxx\"\n# )\n\n###########################################################\n# \u30dd\u30fc\u30c8\u5b9a\u7fa9\n###########################################################\n\nSSH=22\nFTP=20,21\nDNS=53\nSMTP=25,465,587\nPOP3=110,995\nIMAP=143,993\nHTTP=80,443\nIDENT=113\nNTP=123\nMYSQL=3306\nNET_BIOS=135,137,138,139,445\nDHCP=67,68\n\n###########################################################\n# \u95a2\u6570\n###########################################################\n\n# iptables\u306e\u521d\u671f\u5316, \u3059\u3079\u3066\u306e\u30eb\u30fc\u30eb\u3092\u524a\u9664\ninitialize() \n{\n    iptables -F # \u30c6\u30fc\u30d6\u30eb\u521d\u671f\u5316\n    iptables -X # \u30c1\u30a7\u30fc\u30f3\u3092\u524a\u9664\n    iptables -Z # \u30d1\u30b1\u30c3\u30c8\u30ab\u30a6\u30f3\u30bf\u30fb\u30d0\u30a4\u30c8\u30ab\u30a6\u30f3\u30bf\u3092\u30af\u30ea\u30a2\n    iptables -P INPUT   ACCEPT\n    iptables -P OUTPUT  ACCEPT\n    iptables -P FORWARD ACCEPT\n}\n\n# \u30eb\u30fc\u30eb\u9069\u7528\u5f8c\u306e\u51e6\u7406\nfinailize()\n{\n    /etc/init.d/iptables save && # \u8a2d\u5b9a\u306e\u4fdd\u5b58\n    /etc/init.d/iptables restart && # \u4fdd\u5b58\u3057\u305f\u3082\u306e\u3067\u518d\u8d77\u52d5\u3057\u3066\u307f\u308b\n    return 0\n    return 1\n}\n\n# \u958b\u767a\u7528\nif [ \"$1\" == \"dev\" ]\nthen\n    iptables() { echo \"iptables $@\"; }\n    finailize() { echo \"finailize\"; }\nfi\n\n###########################################################\n# iptables\u306e\u521d\u671f\u5316\n###########################################################\ninitialize\n\n###########################################################\n# \u30dd\u30ea\u30b7\u30fc\u306e\u6c7a\u5b9a\n###########################################################\niptables -P INPUT   DROP # \u3059\u3079\u3066DROP\u3002\u3059\u3079\u3066\u306e\u7a74\u3092\u3075\u3055\u3044\u3067\u304b\u3089\u5fc5\u8981\u306a\u30dd\u30fc\u30c8\u3092\u7a7a\u3051\u3066\u3044\u304f\u306e\u304c\u826f\u3044\u3002\niptables -P OUTPUT  ACCEPT\niptables -P FORWARD DROP\n\n###########################################################\n# \u4fe1\u983c\u53ef\u80fd\u306a\u30db\u30b9\u30c8\u306f\u8a31\u53ef\n###########################################################\n\n# \u30ed\u30fc\u30ab\u30eb\u30db\u30b9\u30c8\n# lo \u306f\u30ed\u30fc\u30ab\u30eb\u30eb\u30fc\u30d7\u30d0\u30c3\u30af\u306e\u3053\u3068\u3067\u81ea\u5206\u81ea\u8eab\u306e\u30db\u30b9\u30c8\u3092\u6307\u3059\niptables -A INPUT -i lo -j ACCEPT # SELF -> SELF\n\n# \u30ed\u30fc\u30ab\u30eb\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\n# $LOCAL_NET \u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308c\u3070 LAN\u4e0a\u306e\u4ed6\u306e\u30b5\u30fc\u30d0\u3068\u306e\u3084\u308a\u53d6\u308a\u3092\u8a31\u53ef\u3059\u308b\nif [ \"$LOCAL_NET\" ]\nthen\n    iptables -A INPUT -p tcp -s $LOCAL_NET -j ACCEPT # LOCAL_NET -> SELF\nfi\n\n# \u4fe1\u983c\u53ef\u80fd\u30db\u30b9\u30c8\n# $ALLOW_HOSTS \u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308c\u3070 \u305d\u306e\u30db\u30b9\u30c8\u3068\u306e\u3084\u308a\u53d6\u308a\u3092\u8a31\u53ef\u3059\u308b\nif [ \"${ALLOW_HOSTS[@]}\" ]\nthen\n    for allow_host in ${ALLOW_HOSTS[@]}\n    do\n        iptables -A INPUT -p tcp -s $allow_host -j ACCEPT # allow_host -> SELF\n    done\nfi\n\n###########################################################\n# $DENY_HOSTS\u304b\u3089\u306e\u30a2\u30af\u30bb\u30b9\u306f\u7834\u68c4\n###########################################################\nif [ \"${DENY_HOSTS[@]}\" ]\nthen\n    for host in ${DENY_HOSTS[@]}\n    do\n        iptables -A INPUT -s $ip -m limit --limit 1/s -j LOG --log-prefix \"deny_host: \"\n        iptables -A INPUT -s $ip -j DROP\n    done\nfi\n\n###########################################################\n# \u30bb\u30c3\u30b7\u30e7\u30f3\u78ba\u7acb\u5f8c\u306e\u30d1\u30b1\u30c3\u30c8\u758e\u901a\u306f\u8a31\u53ef\n###########################################################\niptables -A INPUT  -p tcp -m state --state ESTABLISHED,RELATED -j ACCEPT\n\n###########################################################\n# \u653b\u6483\u5bfe\u7b56: Stealth Scan\n###########################################################\niptables -N STEALTH_SCAN # \"STEALTH_SCAN\" \u3068\u3044\u3046\u540d\u524d\u3067\u30c1\u30a7\u30fc\u30f3\u3092\u4f5c\u308b\niptables -A STEALTH_SCAN -j LOG --log-prefix \"stealth_scan_attack: \"\niptables -A STEALTH_SCAN -j DROP\n\n# \u30b9\u30c6\u30eb\u30b9\u30b9\u30ad\u30e3\u30f3\u3089\u3057\u304d\u30d1\u30b1\u30c3\u30c8\u306f \"STEALTH_SCAN\" \u30c1\u30a7\u30fc\u30f3\u3078\u30b8\u30e3\u30f3\u30d7\u3059\u308b\niptables -A INPUT -p tcp --tcp-flags SYN,ACK SYN,ACK -m state --state NEW -j STEALTH_SCAN\niptables -A INPUT -p tcp --tcp-flags ALL NONE -j STEALTH_SCAN\n\niptables -A INPUT -p tcp --tcp-flags SYN,FIN SYN,FIN         -j STEALTH_SCAN\niptables -A INPUT -p tcp --tcp-flags SYN,RST SYN,RST         -j STEALTH_SCAN\niptables -A INPUT -p tcp --tcp-flags ALL SYN,RST,ACK,FIN,URG -j STEALTH_SCAN\n\niptables -A INPUT -p tcp --tcp-flags FIN,RST FIN,RST -j STEALTH_SCAN\niptables -A INPUT -p tcp --tcp-flags ACK,FIN FIN     -j STEALTH_SCAN\niptables -A INPUT -p tcp --tcp-flags ACK,PSH PSH     -j STEALTH_SCAN\niptables -A INPUT -p tcp --tcp-flags ACK,URG URG     -j STEALTH_SCAN\n\n###########################################################\n# \u653b\u6483\u5bfe\u7b56: \u30d5\u30e9\u30b0\u30e1\u30f3\u30c8\u30d1\u30b1\u30c3\u30c8\u306b\u3088\u308b\u30dd\u30fc\u30c8\u30b9\u30ad\u30e3\u30f3,DOS\u653b\u6483\n# namap -v -sF \u306a\u3069\u306e\u5bfe\u7b56\n###########################################################\niptables -A INPUT -f -j LOG --log-prefix 'fragment_packet:'\niptables -A INPUT -f -j DROP\n\n###########################################################\n# \u653b\u6483\u5bfe\u7b56: Ping of Death\n###########################################################\n# \u6bce\u79d21\u56de\u3092\u8d85\u3048\u308bping\u304c10\u56de\u7d9a\u3044\u305f\u3089\u7834\u68c4\niptables -N PING_OF_DEATH # \"PING_OF_DEATH\" \u3068\u3044\u3046\u540d\u524d\u3067\u30c1\u30a7\u30fc\u30f3\u3092\u4f5c\u308b\niptables -A PING_OF_DEATH -p icmp --icmp-type echo-request \\\n         -m hashlimit \\\n         --hashlimit 1/s \\\n         --hashlimit-burst 10 \\\n         --hashlimit-htable-expire 300000 \\\n         --hashlimit-mode srcip \\\n         --hashlimit-name t_PING_OF_DEATH \\\n         -j RETURN\n\n# \u5236\u9650\u3092\u8d85\u3048\u305fICMP\u3092\u7834\u68c4\niptables -A PING_OF_DEATH -j LOG --log-prefix \"ping_of_death_attack: \"\niptables -A PING_OF_DEATH -j DROP\n\n# ICMP \u306f \"PING_OF_DEATH\" \u30c1\u30a7\u30fc\u30f3\u3078\u30b8\u30e3\u30f3\u30d7\niptables -A INPUT -p icmp --icmp-type echo-request -j PING_OF_DEATH\n\n###########################################################\n# \u653b\u6483\u5bfe\u7b56: SYN Flood Attack\n# \u3053\u306e\u5bfe\u7b56\u306b\u52a0\u3048\u3066 Syn Cookie \u3092\u6709\u52b9\u306b\u3059\u3079\u3057\u3002\n###########################################################\niptables -N SYN_FLOOD # \"SYN_FLOOD\" \u3068\u3044\u3046\u540d\u524d\u3067\u30c1\u30a7\u30fc\u30f3\u3092\u4f5c\u308b\niptables -A SYN_FLOOD -p tcp --syn \\\n         -m hashlimit \\\n         --hashlimit 200/s \\\n         --hashlimit-burst 3 \\\n         --hashlimit-htable-expire 300000 \\\n         --hashlimit-mode srcip \\\n         --hashlimit-name t_SYN_FLOOD \\\n         -j RETURN\n\n# \u89e3\u8aac\n# -m hashlimit                       \u30db\u30b9\u30c8\u3054\u3068\u306b\u5236\u9650\u3059\u308b\u305f\u3081 limit \u3067\u306f\u306a\u304f hashlimit \u3092\u5229\u7528\u3059\u308b\n# --hashlimit 200/s                  \u79d2\u9593\u306b200\u63a5\u7d9a\u3092\u4e0a\u9650\u306b\u3059\u308b\n# --hashlimit-burst 3                \u4e0a\u8a18\u306e\u4e0a\u9650\u3092\u8d85\u3048\u305f\u63a5\u7d9a\u304c3\u56de\u9023\u7d9a\u3067\u3042\u308c\u3070\u5236\u9650\u304c\u304b\u304b\u308b\n# --hashlimit-htable-expire 300000   \u7ba1\u7406\u30c6\u30fc\u30d6\u30eb\u4e2d\u306e\u30ec\u30b3\u30fc\u30c9\u306e\u6709\u52b9\u671f\u9593\uff08\u5358\u4f4d\uff1ams\n# --hashlimit-mode srcip             \u9001\u4fe1\u5143\u30a2\u30c9\u30ec\u30b9\u3067\u30ea\u30af\u30a8\u30b9\u30c8\u6570\u3092\u7ba1\u7406\u3059\u308b\n# --hashlimit-name t_SYN_FLOOD       /proc/net/ipt_hashlimit \u306b\u4fdd\u5b58\u3055\u308c\u308b\u30cf\u30c3\u30b7\u30e5\u30c6\u30fc\u30d6\u30eb\u540d\n# -j RETURN                          \u5236\u9650\u4ee5\u5185\u3067\u3042\u308c\u3070\u3001\u89aa\u30c1\u30a7\u30fc\u30f3\u306b\u623b\u308b\n\n# \u5236\u9650\u3092\u8d85\u3048\u305fSYN\u30d1\u30b1\u30c3\u30c8\u3092\u7834\u68c4\niptables -A SYN_FLOOD -j LOG --log-prefix \"syn_flood_attack: \"\niptables -A SYN_FLOOD -j DROP\n\n# SYN\u30d1\u30b1\u30c3\u30c8\u306f \"SYN_FLOOD\" \u30c1\u30a7\u30fc\u30f3\u3078\u30b8\u30e3\u30f3\u30d7\niptables -A INPUT -p tcp --syn -j SYN_FLOOD\n\n###########################################################\n# \u653b\u6483\u5bfe\u7b56: HTTP DoS/DDoS Attack\n###########################################################\niptables -N HTTP_DOS # \"HTTP_DOS\" \u3068\u3044\u3046\u540d\u524d\u3067\u30c1\u30a7\u30fc\u30f3\u3092\u4f5c\u308b\niptables -A HTTP_DOS -p tcp -m multiport --dports $HTTP \\\n         -m hashlimit \\\n         --hashlimit 1/s \\\n         --hashlimit-burst 100 \\\n         --hashlimit-htable-expire 300000 \\\n         --hashlimit-mode srcip \\\n         --hashlimit-name t_HTTP_DOS \\\n         -j RETURN\n\n# \u89e3\u8aac\n# -m hashlimit                       \u30db\u30b9\u30c8\u3054\u3068\u306b\u5236\u9650\u3059\u308b\u305f\u3081 limit \u3067\u306f\u306a\u304f hashlimit \u3092\u5229\u7528\u3059\u308b\n# --hashlimit 1/s                    \u79d2\u95931\u63a5\u7d9a\u3092\u4e0a\u9650\u3068\u3059\u308b\n# --hashlimit-burst 100              \u4e0a\u8a18\u306e\u4e0a\u9650\u3092100\u56de\u9023\u7d9a\u3067\u8d85\u3048\u308b\u3068\u5236\u9650\u304c\u304b\u304b\u308b\n# --hashlimit-htable-expire 300000   \u7ba1\u7406\u30c6\u30fc\u30d6\u30eb\u4e2d\u306e\u30ec\u30b3\u30fc\u30c9\u306e\u6709\u52b9\u671f\u9593\uff08\u5358\u4f4d\uff1ams\n# --hashlimit-mode srcip             \u9001\u4fe1\u5143\u30a2\u30c9\u30ec\u30b9\u3067\u30ea\u30af\u30a8\u30b9\u30c8\u6570\u3092\u7ba1\u7406\u3059\u308b\n# --hashlimit-name t_HTTP_DOS        /proc/net/ipt_hashlimit \u306b\u4fdd\u5b58\u3055\u308c\u308b\u30cf\u30c3\u30b7\u30e5\u30c6\u30fc\u30d6\u30eb\u540d\n# -j RETURN                          \u5236\u9650\u4ee5\u5185\u3067\u3042\u308c\u3070\u3001\u89aa\u30c1\u30a7\u30fc\u30f3\u306b\u623b\u308b\n\n# \u5236\u9650\u3092\u8d85\u3048\u305f\u63a5\u7d9a\u3092\u7834\u68c4\niptables -A HTTP_DOS -j LOG --log-prefix \"http_dos_attack: \"\niptables -A HTTP_DOS -j DROP\n\n# HTTP\u3078\u306e\u30d1\u30b1\u30c3\u30c8\u306f \"HTTP_DOS\" \u30c1\u30a7\u30fc\u30f3\u3078\u30b8\u30e3\u30f3\u30d7\niptables -A INPUT -p tcp -m multiport --dports $HTTP -j HTTP_DOS\n\n###########################################################\n# \u653b\u6483\u5bfe\u7b56: IDENT port probe\n# ident\u3092\u5229\u7528\u3057\u653b\u6483\u8005\u304c\u5c06\u6765\u306e\u653b\u6483\u306b\u5099\u3048\u308b\u305f\u3081\u3001\u3042\u308b\u3044\u306f\u30e6\u30fc\u30b6\u30fc\u306e\n# \u30b7\u30b9\u30c6\u30e0\u304c\u653b\u6483\u3057\u3084\u3059\u3044\u304b\u3069\u3046\u304b\u3092\u78ba\u8a8d\u3059\u308b\u305f\u3081\u306b\u3001\u30dd\u30fc\u30c8\u8abf\u67fb\u3092\u5b9f\u884c\n# \u3059\u308b\u53ef\u80fd\u6027\u304c\u3042\u308a\u307e\u3059\u3002\n# DROP \u3067\u306f\u30e1\u30fc\u30eb\u30b5\u30fc\u30d0\u7b49\u306e\u30ec\u30b9\u30dd\u30f3\u30b9\u4f4e\u4e0b\u306b\u306a\u308b\u305f\u3081 REJECT\u3059\u308b\n###########################################################\niptables -A INPUT -p tcp -m multiport --dports $IDENT -j REJECT --reject-with tcp-reset\n\n###########################################################\n# \u653b\u6483\u5bfe\u7b56: SSH Brute Force\n# SSH\u306f\u30d1\u30b9\u30ef\u30fc\u30c9\u8a8d\u8a3c\u3092\u5229\u7528\u3057\u3066\u3044\u308b\u30b5\u30fc\u30d0\u306e\u5834\u5408\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u7dcf\u5f53\u308a\u653b\u6483\u306b\u5099\u3048\u308b\u3002\n# 1\u5206\u9593\u306b5\u56de\u3057\u304b\u63a5\u7d9a\u30c8\u30e9\u30a4\u3092\u3067\u304d\u306a\u3044\u3088\u3046\u306b\u3059\u308b\u3002\n# SSH\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u304c\u518d\u63a5\u7d9a\u3092\u7e70\u308a\u8fd4\u3059\u306e\u3092\u9632\u3050\u305f\u3081DROP\u3067\u306f\u306a\u304fREJECT\u306b\u3059\u308b\u3002\n# SSH\u30b5\u30fc\u30d0\u304c\u30d1\u30b9\u30ef\u30fc\u30c9\u8a8d\u8a3cON\u306e\u5834\u5408\u3001\u4ee5\u4e0b\u3092\u30a2\u30f3\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3059\u308b\n###########################################################\n# iptables -A INPUT -p tcp --syn -m multiport --dports $SSH -m recent --name ssh_attack --set\n# iptables -A INPUT -p tcp --syn -m multiport --dports $SSH -m recent --name ssh_attack --rcheck --seconds 60 --hitcount 5 -j LOG --log-prefix \"ssh_brute_force: \"\n# iptables -A INPUT -p tcp --syn -m multiport --dports $SSH -m recent --name ssh_attack --rcheck --seconds 60 --hitcount 5 -j REJECT --reject-with tcp-reset\n\n###########################################################\n# \u653b\u6483\u5bfe\u7b56: FTP Brute Force\n# FTP\u306f\u30d1\u30b9\u30ef\u30fc\u30c9\u8a8d\u8a3c\u306e\u305f\u3081\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u7dcf\u5f53\u308a\u653b\u6483\u306b\u5099\u3048\u308b\u3002\n# 1\u5206\u9593\u306b5\u56de\u3057\u304b\u63a5\u7d9a\u30c8\u30e9\u30a4\u3092\u3067\u304d\u306a\u3044\u3088\u3046\u306b\u3059\u308b\u3002\n# FTP\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u304c\u518d\u63a5\u7d9a\u3092\u7e70\u308a\u8fd4\u3059\u306e\u3092\u9632\u3050\u305f\u3081DROP\u3067\u306f\u306a\u304fREJECT\u306b\u3059\u308b\u3002\n# FTP\u30b5\u30fc\u30d0\u3092\u7acb\u3061\u4e0a\u3052\u3066\u3044\u308b\u5834\u5408\u3001\u4ee5\u4e0b\u3092\u30a2\u30f3\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3059\u308b\n###########################################################\n# iptables -A INPUT -p tcp --syn -m multiport --dports $FTP -m recent --name ftp_attack --set\n# iptables -A INPUT -p tcp --syn -m multiport --dports $FTP -m recent --name ftp_attack --rcheck --seconds 60 --hitcount 5 -j LOG --log-prefix \"ftp_brute_force: \"\n# iptables -A INPUT -p tcp --syn -m multiport --dports $FTP -m recent --name ftp_attack --rcheck --seconds 60 --hitcount 5 -j REJECT --reject-with tcp-reset\n\n###########################################################\n# \u5168\u30db\u30b9\u30c8(\u30d6\u30ed\u30fc\u30c9\u30ad\u30e3\u30b9\u30c8\u30a2\u30c9\u30ec\u30b9\u3001\u30de\u30eb\u30c1\u30ad\u30e3\u30b9\u30c8\u30a2\u30c9\u30ec\u30b9)\u5b9b\u30d1\u30b1\u30c3\u30c8\u306f\u7834\u68c4\n###########################################################\niptables -A INPUT -d 192.168.1.255   -j LOG --log-prefix \"drop_broadcast: \"\niptables -A INPUT -d 192.168.1.255   -j DROP\niptables -A INPUT -d 255.255.255.255 -j LOG --log-prefix \"drop_broadcast: \"\niptables -A INPUT -d 255.255.255.255 -j DROP\niptables -A INPUT -d 224.0.0.1       -j LOG --log-prefix \"drop_broadcast: \"\niptables -A INPUT -d 224.0.0.1       -j DROP\n\n###########################################################\n# \u5168\u30db\u30b9\u30c8(ANY)\u304b\u3089\u306e\u5165\u529b\u8a31\u53ef\n###########################################################\n\n# ICMP: ping \u306b\u5fdc\u7b54\u3059\u308b\u8a2d\u5b9a\niptables -A INPUT -p icmp -j ACCEPT # ANY -> SELF\n\n# HTTP, HTTPS\niptables -A INPUT -p tcp -m multiport --dports $HTTP -j ACCEPT # ANY -> SELF\n\n# SSH: \u30db\u30b9\u30c8\u3092\u5236\u9650\u3059\u308b\u5834\u5408\u306f TRUST_HOSTS \u306b\u4fe1\u983c\u30db\u30b9\u30c8\u3092\u66f8\u304d\u4e0b\u8a18\u3092\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3059\u308b\niptables -A INPUT -p tcp -m multiport --dports $SSH -j ACCEPT # ANY -> SEL\n\n# FTP\n# iptables -A INPUT -p tcp -m multiport --dports $FTP -j ACCEPT # ANY -> SELF\n\n# DNS\n# iptables -A INPUT -p tcp -m multiport --sports $DNS -j ACCEPT # ANY -> SELF\n# iptables -A INPUT -p udp -m multiport --sports $DNS -j ACCEPT # ANY -> SELF\n\n# SMTP\n# iptables -A INPUT -p tcp -m multiport --sports $SMTP -j ACCEPT # ANY -> SELF\n\n# POP3\n# iptables -A INPUT -p tcp -m multiport --sports $POP3 -j ACCEPT # ANY -> SELF\n\n# IMAP\n# iptables -A INPUT -p tcp -m multiport --sports $IMAP -j ACCEPT # ANY -> SELF\n\n###########################################################\n# \u30ed\u30fc\u30ab\u30eb\u30cd\u30c3\u30c8\u30ef\u30fc\u30af(\u5236\u9650\u4ed8\u304d)\u304b\u3089\u306e\u5165\u529b\u8a31\u53ef\n###########################################################\n\nif [ \"$LIMITED_LOCAL_NET\" ]\nthen\n    # SSH\n    iptables -A INPUT -p tcp -s $LIMITED_LOCAL_NET -m multiport --dports $SSH -j ACCEPT # LIMITED_LOCAL_NET -> SELF\n\n    # FTP\n    iptables -A INPUT -p tcp -s $LIMITED_LOCAL_NET -m multiport --dports $FTP -j ACCEPT # LIMITED_LOCAL_NET -> SELF\n\n    # MySQL\n    iptables -A INPUT -p tcp -s $LIMITED_LOCAL_NET -m multiport --dports $MYSQL -j ACCEPT # LIMITED_LOCAL_NET -> SELF\nfi\n\n###########################################################\n# \u7279\u5b9a\u30db\u30b9\u30c8\u304b\u3089\u306e\u5165\u529b\u8a31\u53ef\n###########################################################\n\nif [ \"$ZABBIX_IP\" ]\nthen\n    # Zabbix\u95a2\u9023\u3092\u8a31\u53ef\n    iptables -A INPUT -p tcp -s $ZABBIX_IP --dport 10050 -j ACCEPT # Zabbix -> SELF\nfi\n\n###########################################################\n# \u305d\u308c\u4ee5\u5916\n# \u4e0a\u8a18\u306e\u30eb\u30fc\u30eb\u306b\u3082\u5f53\u3066\u306f\u307e\u3089\u306a\u304b\u3063\u305f\u3082\u306e\u306f\u30ed\u30ae\u30f3\u30b0\u3057\u3066\u7834\u68c4\n###########################################################\niptables -A INPUT  -j LOG --log-prefix \"drop: \"\niptables -A INPUT  -j DROP\n\n###########################################################\n# SSH \u7de0\u3081\u51fa\u3057\u56de\u907f\u7b56\n# 30\u79d2\u9593\u30b9\u30ea\u30fc\u30d7\u3057\u3066\u305d\u306e\u5f8c iptables \u3092\u30ea\u30bb\u30c3\u30c8\u3059\u308b\u3002\n# SSH \u304c\u7de0\u3081\u51fa\u3055\u308c\u3066\u3044\u306a\u3051\u308c\u3070\u3001 Ctrl-C \u3092\u62bc\u305b\u308b\u306f\u305a\u3002\n###########################################################\ntrap 'finailize && exit 0' 2 # Ctrl-C \u3092\u30c8\u30e9\u30c3\u30d7\u3059\u308b\necho \"In 30 seconds iptables will be automatically reset.\"\necho \"Don't forget to test new SSH connection!\"\necho \"If there is no problem then press Ctrl-C to finish.\"\nsleep 30\necho \"rollback...\"\ninitialize\n\n\n\u30c4\u30c3\u30b3\u30df\u3092\u3046\u3051\u3066\u306e\u5909\u66f4:\n$ git log-graph \n* 65e8249 2012-08-23 Hidehito Nozawa aka Suin fix: -m multiport --dport\"s\"\n\n\niptables\u3092\u6539\u3081\u3066\u52c9\u5f37\u3057\u306a\u304a\u3057\u307e\u3057\u305f\u3002\u30c4\u30c3\u30b3\u30df\u6b53\u8fce\u3067\u3059^-^\n\nGitHub: https://github.com/suin/iptables/blob/master/iptables.sh\n\n```sh:iptables.sh\n#!/bin/bash\n\n###########################################################\n# \u3053\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u7279\u5fb4\n#\n# \u53d7\u4fe1\u30fb\u901a\u904e\u306b\u3064\u3044\u3066\u306f\u57fa\u672c\u7684\u306b\u7834\u68c4\u3057\u3001\u30db\u30ef\u30a4\u30c8\u30ea\u30b9\u30c8\u3067\u8a31\u53ef\u3059\u308b\u3082\u306e\u3092\u6307\u5b9a\u3059\u308b\u3002\n# \u9001\u4fe1\u306b\u3064\u3044\u3066\u306f\u57fa\u672c\u7684\u306b\u8a31\u53ef\u3059\u308b\u3002\u305f\u3060\u3057\u3001\u30b5\u30fc\u30d0\u304c\u8e0f\u307f\u53f0\u306b\u306a\u308a\u5916\u90e8\u306e\u30b5\u30fc\u30d0\u306b\u8ff7\u60d1\u3092\u304b\u3051\u308b\u53ef\u80fd\u6027\u304c\u3042\u308b\u306e\u3067\u3001\n# \u5fc3\u914d\u306a\u5834\u5408\u306f\u3001\u9001\u4fe1\u3082\u53d7\u4fe1\u540c\u69d8\u306b\u57fa\u672c\u7834\u68c4\u30fb\u30db\u30ef\u30a4\u30c8\u30ea\u30b9\u30c8\u3067\u8a31\u53ef\u3059\u308b\u3088\u3046\u306b\u66f8\u304d\u63db\u3048\u308b\u3068\u826f\u3044\u3002\n###########################################################\n\n###########################################################\n# \u7528\u8a9e\u306e\u7d71\u4e00\n# \u308f\u304b\u308a\u3084\u3059\u3055\u306e\u305f\u3081\u30eb\u30fc\u30eb\u3068\u30b3\u30e1\u30f3\u30c8\u306e\u7528\u8a9e\u3092\u4ee5\u4e0b\u306b\u7d71\u4e00\u3059\u308b\n# ACCEPT : \u8a31\u53ef\n# DROP   : \u7834\u68c4\n# REJECT : \u62d2\u5426\n###########################################################\n\n###########################################################\n# \u30c1\u30fc\u30c8\u30b7\u30fc\u30c8\n#\n# -A, --append       \u6307\u5b9a\u30c1\u30a7\u30a4\u30f3\u306b1\u3064\u4ee5\u4e0a\u306e\u65b0\u3057\u3044\u30eb\u30fc\u30eb\u3092\u8ffd\u52a0\n# -D, --delete       \u6307\u5b9a\u30c1\u30a7\u30a4\u30f3\u304b\u30891\u3064\u4ee5\u4e0a\u306e\u30eb\u30fc\u30eb\u3092\u524a\u9664\n# -P, --policy       \u6307\u5b9a\u30c1\u30a7\u30a4\u30f3\u306e\u30dd\u30ea\u30b7\u30fc\u3092\u6307\u5b9a\u3057\u305f\u30bf\u30fc\u30b2\u30c3\u30c8\u306b\u8a2d\u5b9a\n# -N, --new-chain    \u65b0\u3057\u3044\u30e6\u30fc\u30b6\u30fc\u5b9a\u7fa9\u30c1\u30a7\u30a4\u30f3\u3092\u4f5c\u6210\n# -X, --delete-chain \u6307\u5b9a\u30e6\u30fc\u30b6\u30fc\u5b9a\u7fa9\u30c1\u30a7\u30a4\u30f3\u3092\u524a\u9664\n# -F                 \u30c6\u30fc\u30d6\u30eb\u521d\u671f\u5316\n#\n# -p, --protocol      \u30d7\u30ed\u30b3\u30c8\u30eb         \u30d7\u30ed\u30c8\u30b3\u30eb(tcp\u3001udp\u3001icmp\u3001all)\u3092\u6307\u5b9a\n# -s, --source        IP\u30a2\u30c9\u30ec\u30b9[/mask]  \u9001\u4fe1\u5143\u306e\u30a2\u30c9\u30ec\u30b9\u3002IP\u30a2\u30c9\u30ec\u30b9or\u30db\u30b9\u30c8\u540d\u3092\u8a18\u8ff0\n# -d, --destination   IP\u30a2\u30c9\u30ec\u30b9[/mask]  \u9001\u4fe1\u5148\u306e\u30a2\u30c9\u30ec\u30b9\u3002IP\u30a2\u30c9\u30ec\u30b9or\u30db\u30b9\u30c8\u540d\u3092\u8a18\u8ff0\n# -i, --in-interface  \u30c7\u30d0\u30a4\u30b9           \u30d1\u30b1\u30c3\u30c8\u304c\u5165\u3063\u3066\u304f\u308b\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30a4\u30b9\u3092\u6307\u5b9a\n# -o, --out-interface \u30c7\u30d0\u30a4\u30b9           \u30d1\u30b1\u30c3\u30c8\u304c\u51fa\u3066\u3044\u304f\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30a4\u30b9\u3092\u6307\u5b9a\n# -j, --jump          \u30bf\u30fc\u30b2\u30c3\u30c8         \u6761\u4ef6\u306b\u5408\u3063\u305f\u3068\u304d\u306e\u30a2\u30af\u30b7\u30e7\u30f3\u3092\u6307\u5b9a\n# -t, --table         \u30c6\u30fc\u30d6\u30eb           \u30c6\u30fc\u30d6\u30eb\u3092\u6307\u5b9a\n# -m state --state    \u72b6\u614b              \u30d1\u30b1\u30c3\u30c8\u306e\u72b6\u614b\u3092\u6761\u4ef6\u3068\u3057\u3066\u6307\u5b9a\n#                                       state\u306f\u3001 NEW\u3001ESTABLISHED\u3001RELATED\u3001INVALID\u304c\u6307\u5b9a\u3067\u304d\u308b\n# !                   \u6761\u4ef6\u3092\u53cd\u8ee2\uff08\uff5e\u4ee5\u5916\u3068\u306a\u308b\uff09\n###########################################################\n\n# \u30d1\u30b9\nPATH=/sbin:/usr/sbin:/bin:/usr/bin\n\n###########################################################\n# IP\u306e\u5b9a\u7fa9\n# \u5fc5\u8981\u306b\u5fdc\u3058\u3066\u5b9a\u7fa9\u3059\u308b\u3002\u5b9a\u7fa9\u3057\u306a\u304f\u3066\u3082\u52d5\u4f5c\u3059\u308b\u3002\n###########################################################\n\n# \u5185\u90e8\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3068\u3057\u3066\u8a31\u53ef\u3059\u308b\u7bc4\u56f2\n# LOCAL_NET=\"xxx.xxx.xxx.xxx/xx\"\n\n# \u5185\u90e8\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3068\u3057\u3066\u4e00\u90e8\u5236\u9650\u4ed8\u304d\u3067\u8a31\u53ef\u3059\u308b\u7bc4\u56f2\n# LIMITED_LOCAL_NET=\"xxx.xxx.xxx.xxx/xx\"\n\n# Zabbix\u30b5\u30fc\u30d0\u30fcIP\n# ZABBIX_IP=\"xxx.xxx.xxx.xxx\"\n\n# \u5168\u3066\u306eIP\u3092\u8868\u3059\u8a2d\u5b9a\u3092\u5b9a\u7fa9\n# ANY=\"0.0.0.0/0\"\n\n# \u4fe1\u983c\u53ef\u80fd\u30db\u30b9\u30c8(\u914d\u5217)\n# ALLOW_HOSTS=(\n# \t\"xxx.xxx.xxx.xxx\"\n# \t\"xxx.xxx.xxx.xxx\"\n# \t\"xxx.xxx.xxx.xxx\"\n# )\n\n# \u7121\u6761\u4ef6\u7834\u68c4\u3059\u308b\u30ea\u30b9\u30c8(\u914d\u5217)\n# DENY_HOSTS=(\n# \t\"xxx.xxx.xxx.xxx\"\n# \t\"xxx.xxx.xxx.xxx\"\n# \t\"xxx.xxx.xxx.xxx\"\n# )\n\n###########################################################\n# \u30dd\u30fc\u30c8\u5b9a\u7fa9\n###########################################################\n\nSSH=22\nFTP=20,21\nDNS=53\nSMTP=25,465,587\nPOP3=110,995\nIMAP=143,993\nHTTP=80,443\nIDENT=113\nNTP=123\nMYSQL=3306\nNET_BIOS=135,137,138,139,445\nDHCP=67,68\n\n###########################################################\n# \u95a2\u6570\n###########################################################\n\n# iptables\u306e\u521d\u671f\u5316, \u3059\u3079\u3066\u306e\u30eb\u30fc\u30eb\u3092\u524a\u9664\ninitialize() \n{\n\tiptables -F # \u30c6\u30fc\u30d6\u30eb\u521d\u671f\u5316\n\tiptables -X # \u30c1\u30a7\u30fc\u30f3\u3092\u524a\u9664\n\tiptables -Z # \u30d1\u30b1\u30c3\u30c8\u30ab\u30a6\u30f3\u30bf\u30fb\u30d0\u30a4\u30c8\u30ab\u30a6\u30f3\u30bf\u3092\u30af\u30ea\u30a2\n\tiptables -P INPUT   ACCEPT\n\tiptables -P OUTPUT  ACCEPT\n\tiptables -P FORWARD ACCEPT\n}\n\n# \u30eb\u30fc\u30eb\u9069\u7528\u5f8c\u306e\u51e6\u7406\nfinailize()\n{\n\t/etc/init.d/iptables save && # \u8a2d\u5b9a\u306e\u4fdd\u5b58\n\t/etc/init.d/iptables restart && # \u4fdd\u5b58\u3057\u305f\u3082\u306e\u3067\u518d\u8d77\u52d5\u3057\u3066\u307f\u308b\n\treturn 0\n\treturn 1\n}\n\n# \u958b\u767a\u7528\nif [ \"$1\" == \"dev\" ]\nthen\n\tiptables() { echo \"iptables $@\"; }\n\tfinailize() { echo \"finailize\"; }\nfi\n\n###########################################################\n# iptables\u306e\u521d\u671f\u5316\n###########################################################\ninitialize\n\n###########################################################\n# \u30dd\u30ea\u30b7\u30fc\u306e\u6c7a\u5b9a\n###########################################################\niptables -P INPUT   DROP # \u3059\u3079\u3066DROP\u3002\u3059\u3079\u3066\u306e\u7a74\u3092\u3075\u3055\u3044\u3067\u304b\u3089\u5fc5\u8981\u306a\u30dd\u30fc\u30c8\u3092\u7a7a\u3051\u3066\u3044\u304f\u306e\u304c\u826f\u3044\u3002\niptables -P OUTPUT  ACCEPT\niptables -P FORWARD DROP\n\n###########################################################\n# \u4fe1\u983c\u53ef\u80fd\u306a\u30db\u30b9\u30c8\u306f\u8a31\u53ef\n###########################################################\n\n# \u30ed\u30fc\u30ab\u30eb\u30db\u30b9\u30c8\n# lo \u306f\u30ed\u30fc\u30ab\u30eb\u30eb\u30fc\u30d7\u30d0\u30c3\u30af\u306e\u3053\u3068\u3067\u81ea\u5206\u81ea\u8eab\u306e\u30db\u30b9\u30c8\u3092\u6307\u3059\niptables -A INPUT -i lo -j ACCEPT # SELF -> SELF\n\n# \u30ed\u30fc\u30ab\u30eb\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\n# $LOCAL_NET \u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308c\u3070 LAN\u4e0a\u306e\u4ed6\u306e\u30b5\u30fc\u30d0\u3068\u306e\u3084\u308a\u53d6\u308a\u3092\u8a31\u53ef\u3059\u308b\nif [ \"$LOCAL_NET\" ]\nthen\n\tiptables -A INPUT -p tcp -s $LOCAL_NET -j ACCEPT # LOCAL_NET -> SELF\nfi\n\n# \u4fe1\u983c\u53ef\u80fd\u30db\u30b9\u30c8\n# $ALLOW_HOSTS \u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308c\u3070 \u305d\u306e\u30db\u30b9\u30c8\u3068\u306e\u3084\u308a\u53d6\u308a\u3092\u8a31\u53ef\u3059\u308b\nif [ \"${ALLOW_HOSTS[@]}\" ]\nthen\n\tfor allow_host in ${ALLOW_HOSTS[@]}\n\tdo\n\t\tiptables -A INPUT -p tcp -s $allow_host -j ACCEPT # allow_host -> SELF\n\tdone\nfi\n\n###########################################################\n# $DENY_HOSTS\u304b\u3089\u306e\u30a2\u30af\u30bb\u30b9\u306f\u7834\u68c4\n###########################################################\nif [ \"${DENY_HOSTS[@]}\" ]\nthen\n\tfor host in ${DENY_HOSTS[@]}\n\tdo\n\t\tiptables -A INPUT -s $ip -m limit --limit 1/s -j LOG --log-prefix \"deny_host: \"\n\t\tiptables -A INPUT -s $ip -j DROP\n\tdone\nfi\n\n###########################################################\n# \u30bb\u30c3\u30b7\u30e7\u30f3\u78ba\u7acb\u5f8c\u306e\u30d1\u30b1\u30c3\u30c8\u758e\u901a\u306f\u8a31\u53ef\n###########################################################\niptables -A INPUT  -p tcp -m state --state ESTABLISHED,RELATED -j ACCEPT\n\n###########################################################\n# \u653b\u6483\u5bfe\u7b56: Stealth Scan\n###########################################################\niptables -N STEALTH_SCAN # \"STEALTH_SCAN\" \u3068\u3044\u3046\u540d\u524d\u3067\u30c1\u30a7\u30fc\u30f3\u3092\u4f5c\u308b\niptables -A STEALTH_SCAN -j LOG --log-prefix \"stealth_scan_attack: \"\niptables -A STEALTH_SCAN -j DROP\n\n# \u30b9\u30c6\u30eb\u30b9\u30b9\u30ad\u30e3\u30f3\u3089\u3057\u304d\u30d1\u30b1\u30c3\u30c8\u306f \"STEALTH_SCAN\" \u30c1\u30a7\u30fc\u30f3\u3078\u30b8\u30e3\u30f3\u30d7\u3059\u308b\niptables -A INPUT -p tcp --tcp-flags SYN,ACK SYN,ACK -m state --state NEW -j STEALTH_SCAN\niptables -A INPUT -p tcp --tcp-flags ALL NONE -j STEALTH_SCAN\n\niptables -A INPUT -p tcp --tcp-flags SYN,FIN SYN,FIN         -j STEALTH_SCAN\niptables -A INPUT -p tcp --tcp-flags SYN,RST SYN,RST         -j STEALTH_SCAN\niptables -A INPUT -p tcp --tcp-flags ALL SYN,RST,ACK,FIN,URG -j STEALTH_SCAN\n\niptables -A INPUT -p tcp --tcp-flags FIN,RST FIN,RST -j STEALTH_SCAN\niptables -A INPUT -p tcp --tcp-flags ACK,FIN FIN     -j STEALTH_SCAN\niptables -A INPUT -p tcp --tcp-flags ACK,PSH PSH     -j STEALTH_SCAN\niptables -A INPUT -p tcp --tcp-flags ACK,URG URG     -j STEALTH_SCAN\n\n###########################################################\n# \u653b\u6483\u5bfe\u7b56: \u30d5\u30e9\u30b0\u30e1\u30f3\u30c8\u30d1\u30b1\u30c3\u30c8\u306b\u3088\u308b\u30dd\u30fc\u30c8\u30b9\u30ad\u30e3\u30f3,DOS\u653b\u6483\n# namap -v -sF \u306a\u3069\u306e\u5bfe\u7b56\n###########################################################\niptables -A INPUT -f -j LOG --log-prefix 'fragment_packet:'\niptables -A INPUT -f -j DROP\n \n###########################################################\n# \u653b\u6483\u5bfe\u7b56: Ping of Death\n###########################################################\n# \u6bce\u79d21\u56de\u3092\u8d85\u3048\u308bping\u304c10\u56de\u7d9a\u3044\u305f\u3089\u7834\u68c4\niptables -N PING_OF_DEATH # \"PING_OF_DEATH\" \u3068\u3044\u3046\u540d\u524d\u3067\u30c1\u30a7\u30fc\u30f3\u3092\u4f5c\u308b\niptables -A PING_OF_DEATH -p icmp --icmp-type echo-request \\\n         -m hashlimit \\\n         --hashlimit 1/s \\\n         --hashlimit-burst 10 \\\n         --hashlimit-htable-expire 300000 \\\n         --hashlimit-mode srcip \\\n         --hashlimit-name t_PING_OF_DEATH \\\n         -j RETURN\n\n# \u5236\u9650\u3092\u8d85\u3048\u305fICMP\u3092\u7834\u68c4\niptables -A PING_OF_DEATH -j LOG --log-prefix \"ping_of_death_attack: \"\niptables -A PING_OF_DEATH -j DROP\n\n# ICMP \u306f \"PING_OF_DEATH\" \u30c1\u30a7\u30fc\u30f3\u3078\u30b8\u30e3\u30f3\u30d7\niptables -A INPUT -p icmp --icmp-type echo-request -j PING_OF_DEATH\n\n###########################################################\n# \u653b\u6483\u5bfe\u7b56: SYN Flood Attack\n# \u3053\u306e\u5bfe\u7b56\u306b\u52a0\u3048\u3066 Syn Cookie \u3092\u6709\u52b9\u306b\u3059\u3079\u3057\u3002\n###########################################################\niptables -N SYN_FLOOD # \"SYN_FLOOD\" \u3068\u3044\u3046\u540d\u524d\u3067\u30c1\u30a7\u30fc\u30f3\u3092\u4f5c\u308b\niptables -A SYN_FLOOD -p tcp --syn \\\n         -m hashlimit \\\n         --hashlimit 200/s \\\n         --hashlimit-burst 3 \\\n         --hashlimit-htable-expire 300000 \\\n         --hashlimit-mode srcip \\\n         --hashlimit-name t_SYN_FLOOD \\\n         -j RETURN\n\n# \u89e3\u8aac\n# -m hashlimit                       \u30db\u30b9\u30c8\u3054\u3068\u306b\u5236\u9650\u3059\u308b\u305f\u3081 limit \u3067\u306f\u306a\u304f hashlimit \u3092\u5229\u7528\u3059\u308b\n# --hashlimit 200/s                  \u79d2\u9593\u306b200\u63a5\u7d9a\u3092\u4e0a\u9650\u306b\u3059\u308b\n# --hashlimit-burst 3                \u4e0a\u8a18\u306e\u4e0a\u9650\u3092\u8d85\u3048\u305f\u63a5\u7d9a\u304c3\u56de\u9023\u7d9a\u3067\u3042\u308c\u3070\u5236\u9650\u304c\u304b\u304b\u308b\n# --hashlimit-htable-expire 300000   \u7ba1\u7406\u30c6\u30fc\u30d6\u30eb\u4e2d\u306e\u30ec\u30b3\u30fc\u30c9\u306e\u6709\u52b9\u671f\u9593\uff08\u5358\u4f4d\uff1ams\n# --hashlimit-mode srcip             \u9001\u4fe1\u5143\u30a2\u30c9\u30ec\u30b9\u3067\u30ea\u30af\u30a8\u30b9\u30c8\u6570\u3092\u7ba1\u7406\u3059\u308b\n# --hashlimit-name t_SYN_FLOOD       /proc/net/ipt_hashlimit \u306b\u4fdd\u5b58\u3055\u308c\u308b\u30cf\u30c3\u30b7\u30e5\u30c6\u30fc\u30d6\u30eb\u540d\n# -j RETURN                          \u5236\u9650\u4ee5\u5185\u3067\u3042\u308c\u3070\u3001\u89aa\u30c1\u30a7\u30fc\u30f3\u306b\u623b\u308b\n\n# \u5236\u9650\u3092\u8d85\u3048\u305fSYN\u30d1\u30b1\u30c3\u30c8\u3092\u7834\u68c4\niptables -A SYN_FLOOD -j LOG --log-prefix \"syn_flood_attack: \"\niptables -A SYN_FLOOD -j DROP\n\n# SYN\u30d1\u30b1\u30c3\u30c8\u306f \"SYN_FLOOD\" \u30c1\u30a7\u30fc\u30f3\u3078\u30b8\u30e3\u30f3\u30d7\niptables -A INPUT -p tcp --syn -j SYN_FLOOD\n\n###########################################################\n# \u653b\u6483\u5bfe\u7b56: HTTP DoS/DDoS Attack\n###########################################################\niptables -N HTTP_DOS # \"HTTP_DOS\" \u3068\u3044\u3046\u540d\u524d\u3067\u30c1\u30a7\u30fc\u30f3\u3092\u4f5c\u308b\niptables -A HTTP_DOS -p tcp -m multiport --dports $HTTP \\\n         -m hashlimit \\\n         --hashlimit 1/s \\\n         --hashlimit-burst 100 \\\n         --hashlimit-htable-expire 300000 \\\n         --hashlimit-mode srcip \\\n         --hashlimit-name t_HTTP_DOS \\\n         -j RETURN\n\n# \u89e3\u8aac\n# -m hashlimit                       \u30db\u30b9\u30c8\u3054\u3068\u306b\u5236\u9650\u3059\u308b\u305f\u3081 limit \u3067\u306f\u306a\u304f hashlimit \u3092\u5229\u7528\u3059\u308b\n# --hashlimit 1/s                    \u79d2\u95931\u63a5\u7d9a\u3092\u4e0a\u9650\u3068\u3059\u308b\n# --hashlimit-burst 100              \u4e0a\u8a18\u306e\u4e0a\u9650\u3092100\u56de\u9023\u7d9a\u3067\u8d85\u3048\u308b\u3068\u5236\u9650\u304c\u304b\u304b\u308b\n# --hashlimit-htable-expire 300000   \u7ba1\u7406\u30c6\u30fc\u30d6\u30eb\u4e2d\u306e\u30ec\u30b3\u30fc\u30c9\u306e\u6709\u52b9\u671f\u9593\uff08\u5358\u4f4d\uff1ams\n# --hashlimit-mode srcip             \u9001\u4fe1\u5143\u30a2\u30c9\u30ec\u30b9\u3067\u30ea\u30af\u30a8\u30b9\u30c8\u6570\u3092\u7ba1\u7406\u3059\u308b\n# --hashlimit-name t_HTTP_DOS        /proc/net/ipt_hashlimit \u306b\u4fdd\u5b58\u3055\u308c\u308b\u30cf\u30c3\u30b7\u30e5\u30c6\u30fc\u30d6\u30eb\u540d\n# -j RETURN                          \u5236\u9650\u4ee5\u5185\u3067\u3042\u308c\u3070\u3001\u89aa\u30c1\u30a7\u30fc\u30f3\u306b\u623b\u308b\n\n# \u5236\u9650\u3092\u8d85\u3048\u305f\u63a5\u7d9a\u3092\u7834\u68c4\niptables -A HTTP_DOS -j LOG --log-prefix \"http_dos_attack: \"\niptables -A HTTP_DOS -j DROP\n\n# HTTP\u3078\u306e\u30d1\u30b1\u30c3\u30c8\u306f \"HTTP_DOS\" \u30c1\u30a7\u30fc\u30f3\u3078\u30b8\u30e3\u30f3\u30d7\niptables -A INPUT -p tcp -m multiport --dports $HTTP -j HTTP_DOS\n\n###########################################################\n# \u653b\u6483\u5bfe\u7b56: IDENT port probe\n# ident\u3092\u5229\u7528\u3057\u653b\u6483\u8005\u304c\u5c06\u6765\u306e\u653b\u6483\u306b\u5099\u3048\u308b\u305f\u3081\u3001\u3042\u308b\u3044\u306f\u30e6\u30fc\u30b6\u30fc\u306e\n# \u30b7\u30b9\u30c6\u30e0\u304c\u653b\u6483\u3057\u3084\u3059\u3044\u304b\u3069\u3046\u304b\u3092\u78ba\u8a8d\u3059\u308b\u305f\u3081\u306b\u3001\u30dd\u30fc\u30c8\u8abf\u67fb\u3092\u5b9f\u884c\n# \u3059\u308b\u53ef\u80fd\u6027\u304c\u3042\u308a\u307e\u3059\u3002\n# DROP \u3067\u306f\u30e1\u30fc\u30eb\u30b5\u30fc\u30d0\u7b49\u306e\u30ec\u30b9\u30dd\u30f3\u30b9\u4f4e\u4e0b\u306b\u306a\u308b\u305f\u3081 REJECT\u3059\u308b\n###########################################################\niptables -A INPUT -p tcp -m multiport --dports $IDENT -j REJECT --reject-with tcp-reset\n\n###########################################################\n# \u653b\u6483\u5bfe\u7b56: SSH Brute Force\n# SSH\u306f\u30d1\u30b9\u30ef\u30fc\u30c9\u8a8d\u8a3c\u3092\u5229\u7528\u3057\u3066\u3044\u308b\u30b5\u30fc\u30d0\u306e\u5834\u5408\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u7dcf\u5f53\u308a\u653b\u6483\u306b\u5099\u3048\u308b\u3002\n# 1\u5206\u9593\u306b5\u56de\u3057\u304b\u63a5\u7d9a\u30c8\u30e9\u30a4\u3092\u3067\u304d\u306a\u3044\u3088\u3046\u306b\u3059\u308b\u3002\n# SSH\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u304c\u518d\u63a5\u7d9a\u3092\u7e70\u308a\u8fd4\u3059\u306e\u3092\u9632\u3050\u305f\u3081DROP\u3067\u306f\u306a\u304fREJECT\u306b\u3059\u308b\u3002\n# SSH\u30b5\u30fc\u30d0\u304c\u30d1\u30b9\u30ef\u30fc\u30c9\u8a8d\u8a3cON\u306e\u5834\u5408\u3001\u4ee5\u4e0b\u3092\u30a2\u30f3\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3059\u308b\n###########################################################\n# iptables -A INPUT -p tcp --syn -m multiport --dports $SSH -m recent --name ssh_attack --set\n# iptables -A INPUT -p tcp --syn -m multiport --dports $SSH -m recent --name ssh_attack --rcheck --seconds 60 --hitcount 5 -j LOG --log-prefix \"ssh_brute_force: \"\n# iptables -A INPUT -p tcp --syn -m multiport --dports $SSH -m recent --name ssh_attack --rcheck --seconds 60 --hitcount 5 -j REJECT --reject-with tcp-reset\n\n###########################################################\n# \u653b\u6483\u5bfe\u7b56: FTP Brute Force\n# FTP\u306f\u30d1\u30b9\u30ef\u30fc\u30c9\u8a8d\u8a3c\u306e\u305f\u3081\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u7dcf\u5f53\u308a\u653b\u6483\u306b\u5099\u3048\u308b\u3002\n# 1\u5206\u9593\u306b5\u56de\u3057\u304b\u63a5\u7d9a\u30c8\u30e9\u30a4\u3092\u3067\u304d\u306a\u3044\u3088\u3046\u306b\u3059\u308b\u3002\n# FTP\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u304c\u518d\u63a5\u7d9a\u3092\u7e70\u308a\u8fd4\u3059\u306e\u3092\u9632\u3050\u305f\u3081DROP\u3067\u306f\u306a\u304fREJECT\u306b\u3059\u308b\u3002\n# FTP\u30b5\u30fc\u30d0\u3092\u7acb\u3061\u4e0a\u3052\u3066\u3044\u308b\u5834\u5408\u3001\u4ee5\u4e0b\u3092\u30a2\u30f3\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3059\u308b\n###########################################################\n# iptables -A INPUT -p tcp --syn -m multiport --dports $FTP -m recent --name ftp_attack --set\n# iptables -A INPUT -p tcp --syn -m multiport --dports $FTP -m recent --name ftp_attack --rcheck --seconds 60 --hitcount 5 -j LOG --log-prefix \"ftp_brute_force: \"\n# iptables -A INPUT -p tcp --syn -m multiport --dports $FTP -m recent --name ftp_attack --rcheck --seconds 60 --hitcount 5 -j REJECT --reject-with tcp-reset\n\n###########################################################\n# \u5168\u30db\u30b9\u30c8(\u30d6\u30ed\u30fc\u30c9\u30ad\u30e3\u30b9\u30c8\u30a2\u30c9\u30ec\u30b9\u3001\u30de\u30eb\u30c1\u30ad\u30e3\u30b9\u30c8\u30a2\u30c9\u30ec\u30b9)\u5b9b\u30d1\u30b1\u30c3\u30c8\u306f\u7834\u68c4\n###########################################################\niptables -A INPUT -d 192.168.1.255   -j LOG --log-prefix \"drop_broadcast: \"\niptables -A INPUT -d 192.168.1.255   -j DROP\niptables -A INPUT -d 255.255.255.255 -j LOG --log-prefix \"drop_broadcast: \"\niptables -A INPUT -d 255.255.255.255 -j DROP\niptables -A INPUT -d 224.0.0.1       -j LOG --log-prefix \"drop_broadcast: \"\niptables -A INPUT -d 224.0.0.1       -j DROP\n\n###########################################################\n# \u5168\u30db\u30b9\u30c8(ANY)\u304b\u3089\u306e\u5165\u529b\u8a31\u53ef\n###########################################################\n\n# ICMP: ping \u306b\u5fdc\u7b54\u3059\u308b\u8a2d\u5b9a\niptables -A INPUT -p icmp -j ACCEPT # ANY -> SELF\n\n# HTTP, HTTPS\niptables -A INPUT -p tcp -m multiport --dports $HTTP -j ACCEPT # ANY -> SELF\n\n# SSH: \u30db\u30b9\u30c8\u3092\u5236\u9650\u3059\u308b\u5834\u5408\u306f TRUST_HOSTS \u306b\u4fe1\u983c\u30db\u30b9\u30c8\u3092\u66f8\u304d\u4e0b\u8a18\u3092\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3059\u308b\niptables -A INPUT -p tcp -m multiport --dports $SSH -j ACCEPT # ANY -> SEL\n\n# FTP\n# iptables -A INPUT -p tcp -m multiport --dports $FTP -j ACCEPT # ANY -> SELF\n\n# DNS\n# iptables -A INPUT -p tcp -m multiport --sports $DNS -j ACCEPT # ANY -> SELF\n# iptables -A INPUT -p udp -m multiport --sports $DNS -j ACCEPT # ANY -> SELF\n\n# SMTP\n# iptables -A INPUT -p tcp -m multiport --sports $SMTP -j ACCEPT # ANY -> SELF\n\n# POP3\n# iptables -A INPUT -p tcp -m multiport --sports $POP3 -j ACCEPT # ANY -> SELF\n\n# IMAP\n# iptables -A INPUT -p tcp -m multiport --sports $IMAP -j ACCEPT # ANY -> SELF\n\n###########################################################\n# \u30ed\u30fc\u30ab\u30eb\u30cd\u30c3\u30c8\u30ef\u30fc\u30af(\u5236\u9650\u4ed8\u304d)\u304b\u3089\u306e\u5165\u529b\u8a31\u53ef\n###########################################################\n\nif [ \"$LIMITED_LOCAL_NET\" ]\nthen\n\t# SSH\n\tiptables -A INPUT -p tcp -s $LIMITED_LOCAL_NET -m multiport --dports $SSH -j ACCEPT # LIMITED_LOCAL_NET -> SELF\n\n\t# FTP\n\tiptables -A INPUT -p tcp -s $LIMITED_LOCAL_NET -m multiport --dports $FTP -j ACCEPT # LIMITED_LOCAL_NET -> SELF\n\n\t# MySQL\n\tiptables -A INPUT -p tcp -s $LIMITED_LOCAL_NET -m multiport --dports $MYSQL -j ACCEPT # LIMITED_LOCAL_NET -> SELF\nfi\n\n###########################################################\n# \u7279\u5b9a\u30db\u30b9\u30c8\u304b\u3089\u306e\u5165\u529b\u8a31\u53ef\n###########################################################\n\nif [ \"$ZABBIX_IP\" ]\nthen\n\t# Zabbix\u95a2\u9023\u3092\u8a31\u53ef\n\tiptables -A INPUT -p tcp -s $ZABBIX_IP --dport 10050 -j ACCEPT # Zabbix -> SELF\nfi\n\n###########################################################\n# \u305d\u308c\u4ee5\u5916\n# \u4e0a\u8a18\u306e\u30eb\u30fc\u30eb\u306b\u3082\u5f53\u3066\u306f\u307e\u3089\u306a\u304b\u3063\u305f\u3082\u306e\u306f\u30ed\u30ae\u30f3\u30b0\u3057\u3066\u7834\u68c4\n###########################################################\niptables -A INPUT  -j LOG --log-prefix \"drop: \"\niptables -A INPUT  -j DROP\n\n###########################################################\n# SSH \u7de0\u3081\u51fa\u3057\u56de\u907f\u7b56\n# 30\u79d2\u9593\u30b9\u30ea\u30fc\u30d7\u3057\u3066\u305d\u306e\u5f8c iptables \u3092\u30ea\u30bb\u30c3\u30c8\u3059\u308b\u3002\n# SSH \u304c\u7de0\u3081\u51fa\u3055\u308c\u3066\u3044\u306a\u3051\u308c\u3070\u3001 Ctrl-C \u3092\u62bc\u305b\u308b\u306f\u305a\u3002\n###########################################################\ntrap 'finailize && exit 0' 2 # Ctrl-C \u3092\u30c8\u30e9\u30c3\u30d7\u3059\u308b\necho \"In 30 seconds iptables will be automatically reset.\"\necho \"Don't forget to test new SSH connection!\"\necho \"If there is no problem then press Ctrl-C to finish.\"\nsleep 30\necho \"rollback...\"\ninitialize\n```\n\n\u30c4\u30c3\u30b3\u30df\u3092\u3046\u3051\u3066\u306e\u5909\u66f4:\n\n```\n$ git log-graph \n* 65e8249 2012-08-23 Hidehito Nozawa aka Suin fix: -m multiport --dport\"s\"\n```", "tags": ["iptables", "Ubuntu", "CentOS", "Linux"]}