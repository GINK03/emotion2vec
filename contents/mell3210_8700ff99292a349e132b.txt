{"tags": ["iptables", "Bash", "Linux"], "context": " More than 1 year has passed since last update.\n\n\u306f\u3058\u3081\u306b\nVPN\u3092\u69cb\u7bc9\u3057\u3066\u6570\u65e5\u3002\n\u30ed\u30b0\u3092\u78ba\u8a8d\u3057\u3066\u307f\u308b\u3068\u3001109.188.127.144\u304b\u3089BruteForceAttack\u7684\u306a\u30a2\u30af\u30bb\u30b9\u304c\u3002\u3002\u3002\n\u30ed\u30b7\u30a2\u306e\u300cYota Clients\u300d\u3063\u3066\u6240\u3089\u3057\u304f\u3001\u65e5\u672c\u3067\u8a00\u3046\u3068\u3053\u308d\u306e\u30c9\u30b3\u30e2\u3068\u304bau\u307f\u305f\u3044\u306a\u4f01\u696d\u3063\u307d\u3044\uff1f\n\u305d\u306e\u4ed6\u306b\u3082\u5358\u767a\u3067\u30c1\u30e9\u30db\u30e9\u3068\u3001\u6d77\u5916\u304b\u3089\u3064\u3064\u304b\u308c\u3066\u308b\u3088\u3046\u3067\u3057\u305f\u3002\n\u3088\u304f\u5206\u304b\u3089\u3093\u3051\u3069\u3001\u6d77\u5916\u304b\u3089\u306e\u30a2\u30af\u30bb\u30b9\u306f\u906e\u65ad\u3057\u3066\u3057\u307e\u3046\u306e\u304c\u624b\u3063\u53d6\u308a\u65e9\u305d\u3046\u3002\u3002\u3002\n\u3068\u3044\u3046\u3053\u3068\u3067\u3001iptables\u3092\u8a2d\u5b9a\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\u305d\u306e\u6642\u306b\u3084\u3063\u305f\u4e8b\u306e\u30e1\u30e2\u3067\u3059\u3002\n\n\u3084\u308a\u305f\u3044\u4e8b\n\n\u56fd\u5916\u304b\u3089\u306e\u30a2\u30af\u30bb\u30b9\u306f\u4e00\u5f8b\u30d6\u30ed\u30c3\u30af\n\u56fd\u5185\u304b\u3089\u306e\u30a2\u30af\u30bb\u30b9\u306f\u7279\u5b9a\u306e\u30dd\u30fc\u30c8\u3092\u8a31\u53ef\uff08VPN\u95a2\u9023\uff09\n\u30ed\u30fc\u30ab\u30eb\u30a8\u30ea\u30a2\u304b\u3089\u306e\u30a2\u30af\u30bb\u30b9\u306f\u3001\u7279\u5b9a\u306e\u30dd\u30fc\u30c8\u3092\u8a31\u53ef\uff08SSH\u7b49\uff09\nipsec\u306e\u8a8d\u8a3c\u51e6\u7406\uff08\u30dd\u30fc\u30c8:500\uff09\u306b\u9023\u7d9a\u3057\u3066\u30a2\u30af\u30bb\u30b9\u3057\u3066\u304d\u305f\u63a5\u7d9a\u5143\u306f\u30d6\u30ed\u30c3\u30af\n\n\n\u63a5\u7d9a\u5143\u306e\u5224\u5b9a\u306b\u3064\u3044\u3066\n\u3053\u3053\u3092\u53c2\u8003\u306b\u3057\u307e\u3057\u305f\u3002\n\u56fd\u5185\u304b\u3089\u306e\u63a5\u7d9a\u306e\u307f\u8a31\u53ef\u3057\u3066\u6d77\u5916\u304b\u3089\u306e\u63a5\u7d9a\u3092\u906e\u65ad\u3059\u308b\n\ncrontab\nPATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin\n0 5 * * * /root/tool/iptables/iptablesSetup.sh\n\n\n\u203bPATH\u306f\u3001cron\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\u300c/usr/bin:/bin\u300d\u3060\u3051\u306a\u306e\u3067\u8ffd\u52a0\u3057\u3066\u307e\u3059\u3002\n\niptablesSetup.sh\n# WHITE_LIST \u3068\u3044\u3046\u540d\u524d\u3067\u30e6\u30fc\u30b6\u5b9a\u7fa9\u30c1\u30a7\u30fc\u30f3\u3092\u4f5c\u6210\niptables -N WHITE_LIST\n\nfunction loadWhiteList() {\n    WhiteList=\"/root/tool/iptables/cidr.txt\"\n    # cidr.txt.gz \u3092\u53d6\u5f97\u51fa\u6765\u305f\u3089\u3001WhiteList\u3092\u66f4\u65b0\n    wget -q -N http://nami.jp/ipv4bycc/cidr.txt.gz\n\n    # cidr.txt.gz \u3092\u53d6\u5f97\u51fa\u6765\u305f\u3089\u3001WhiteList\u3092\u66f4\u65b0\n    # \u305f\u3060\u3057\u3001\u30d5\u30a1\u30a4\u30eb\u30b5\u30a4\u30ba\u304c0byte\u306e\u5834\u5408\u306f\u4e0d\u6b63\u30d5\u30a1\u30a4\u30eb\u3068\u5224\u65ad\u3057\u3066\u66f4\u65b0\u30b9\u30ad\u30c3\u30d7\n    if [ -f cidr.txt.gz -a `ls -l cidr.txt.gz | awk '{print $5;}'` != \"0\" ]; then\n        gzip -dc cidr.txt.gz | sed -n 's/^JP\\t//p' > ${WhiteList}\n        rm -f cidr.txt.gz\n    fi\n\n    # WhiteList\u3092iptables\u306b\u30ed\u30fc\u30c9\n    if [ -f ${WhiteList} -a `ls -l ${WhiteList} | awk '{print $5;}'` != \"0\" ]; then\n        #\u4e0a\u8a18\u3067\u62bd\u51fa\u3055\u308c\u305f\u65e5\u672c\u306eIP\u30ea\u30b9\u30c8\u3092\uff11\u884c\u3065\u3064\u8aad\u307f\u8fbc\u307f\n        cat ${WhiteList} | while read address; do\n            #INPUT\u30c1\u30a7\u30fc\u30f3\uff08\u5165\u529b\u30d1\u30b1\u30c3\u30c8\u304c\u51e6\u7406\u3055\u308c\u308b\u30c7\u30d5\u30a9\u30eb\u30c8\u30c1\u30a7\u30fc\u30f3\uff09\u306b\u3066\n            #\u9001\u4fe1\u5143\u306eIP\u304c\u56fd\u5185\u306e\u7269\u304b\u30c1\u30a7\u30c3\u30af\u3002\n            #\u56fd\u5185\u306e\u7269\u3067\u3042\u308b\u5834\u5408\u306fWHITE_LIST\u30c1\u30a7\u30fc\u30f3\u3078\u98db\u3070\u3059\n            iptables -A INPUT -s $address -j WHITE_LIST\n        done\n    fi\n}\n\n\n\n\u9023\u7d9a\u3057\u3066\u30a2\u30af\u30bb\u30b9\u3057\u3066\u304d\u305f\u63a5\u7d9a\u5143\u306e\u30d6\u30ed\u30c3\u30af\n\u3053\u3053\u3092\u53c2\u8003\u306b\u3057\u307e\u3057\u305f\u3002\niptables \u306e ipt_recent \u3067 ssh \u306e brute force attack \u5bfe\u7b56\n\niptablesSetup.sh\n# \u524d\u8ff0\u306e\u5224\u5b9a\u3067\u3001\u56fd\u5185\u304b\u3089\u306e\u63a5\u7d9a\u3068\u5224\u5b9a\u3055\u308c\u305f\u30d1\u30b1\u30c3\u30c8\u306e\u307f\u304c\u3053\u3053\u306e\u51e6\u7406\u306b\u5165\u3063\u3066\u304f\u308b\n# WHITE_LIST\u30c1\u30a7\u30fc\u30f3\u3067\u306f\u3001udp\u306e500\u756a\u5b9b\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u306fIPSEC\u30c1\u30a7\u30fc\u30f3\u3078\u98db\u3070\u3059\niptables -A WHITE_LIST -p udp -m udp --dport 500 -j IPSEC\n\n#ipsecbadcon\u30ea\u30b9\u30c8\u306b\u767b\u9332\u3055\u308c\u305fIP\u306f\u554f\u7b54\u7121\u7528\u3067\u7834\u68c4\niptables -A IPSEC -m recent --rcheck --name ipsecbadcon --rsource -j DROP\n#ipseccon\u30ea\u30b9\u30c8\u3092\u30c1\u30a7\u30c3\u30af\u3057\u306610\u5206\u9593\u306b10\u56de\u30a2\u30af\u30bb\u30b9\u3057\u3066\u304d\u305f\u8f29\u306fIPSECATTACK\u30c1\u30a7\u30fc\u30f3\u3078\u98db\u3070\u3059\niptables -A IPSEC -m recent --rcheck --seconds 600 --hitcount 10 --name ipseccon --rsource -j IPSECATTACK\n#\u63a5\u7d9a\u56de\u6570\u304c\u95be\u5024\u306b\u9054\u3057\u3066\u3044\u306a\u3044\u30a2\u30af\u30bb\u30b9\u306fipseccon\u30ea\u30b9\u30c8\u306b\u767b\u9332\u3057\u3064\u3064\u63a5\u7d9a\u8a31\u53ef\niptables -A IPSEC -m recent --set --name ipseccon --rsource\niptables -A IPSEC -j ACCEPT\n\n#IPSECATTACK\u30c1\u30a7\u30fc\u30f3\u3067\u306fipsecbadcon\u30ea\u30b9\u30c8\u306b\u767b\u9332&syslog\u306b\u8a18\u9332\u3057\u3066\u7834\u68c4\niptables -A IPSECATTACK -m recent --set --name ipsecbadcon --rsource\niptables -A IPSECATTACK -j LOG --log-prefix \"IPTABLES:SET_IPSEC_BAD_CON \" --log-level 6\niptables -A IPSECATTACK -j DROP\n\n\n\n\u30ed\u30fc\u30ab\u30eb\u30a8\u30ea\u30a2\u63a5\u7d9a\u306e\u8a2d\u5b9a\n\niptablesSetup.sh\niptables -A INPUT -s 192.168.0.0/16 -j LOCAL_AREA\n\niptables -A LOCAL_AREA -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT\n# DHCP NetBIOS\niptables -A LOCAL_AREA -p udp -m multiport --dport 67,137,138 -j ACCEPT\n# DNS response\niptables -A LOCAL_AREA -p udp -m multiport --sport 53 -j ACCEPT\n#\u4e0a\u8a18\u4ee5\u5916\u306e\u30d1\u30b1\u30c3\u30c8\u306f\u8a18\u9332\u3057\u3064\u3064\u7834\u68c4\niptables -A LOCAL_AREA -j LOG --log-prefix \"IPTABLES:LOCAL_AREA_DROP \" --log-level 6\niptables -A LOCAL_AREA -j DROP\n\n\n\n\u5b8c\u6210\u7cfb\n\u3068\u3044\u3046\u3053\u3068\u3067\u3001\u5b8c\u6210\u7cfb\u3092\u6652\u3059\u3068\u3053\u3093\u306a\u611f\u3058\u3067\u3059\u3002\n\niptablesSetup.sh\nfunction main() {\n    #\u8a2d\u5b9a\u521d\u671f\u5316\n    iptables -F\n    #\u30ab\u30a6\u30f3\u30bf\u306e\u30ea\u30bb\u30c3\u30c8\n    iptables -Z\n    #\u30e6\u30fc\u30b6\u5b9a\u7fa9\u30c1\u30a7\u30a4\u30f3\u3092\u521d\u671f\u5316\n    iptables -X\n    iptables -P INPUT DROP\n    iptables -P OUTPUT ACCEPT\n    iptables -P FORWARD DROP\n\n    iptables -N LOCAL_AREA\n    iptables -N IPSEC\n    iptables -N IPSECATTACK\n    iptables -N WHITE_LIST\n\n    iptables -A INPUT -i lo -j ACCEPT\n    iptables -A INPUT -p icmp -j ACCEPT\n    iptables -A INPUT -p tcp -m state --state RELATED,ESTABLISHED -j ACCEPT\n    blockBroadCast\n    iptables -A INPUT -s 192.168.0.0/16 -j LOCAL_AREA\n\n    iptables -A LOCAL_AREA -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT\n    # DHCP NetBIOS\n    iptables -A LOCAL_AREA -p udp -m multiport --dport 67,137,138 -j ACCEPT\n    # DNS response\n    iptables -A LOCAL_AREA -p udp -m multiport --sport 53 -j ACCEPT\n    iptables -A LOCAL_AREA -j LOG --log-prefix \"IPTABLES:LOCAL_AREA_DROP \" --log-level 6\n    iptables -A LOCAL_AREA -j DROP\n\n    loadWhiteList\n    iptables -A INPUT -j LOG --log-prefix \"IPTABLES:NOT_IN_WHITE_LIST \" --log-level 6\n    iptables -A INPUT -j DROP\n\n    iptables -A WHITE_LIST -p udp -m udp --dport 500 -j IPSEC\n    iptables -A WHITE_LIST -p udp -m udp --dport 1701 -j ACCEPT\n    iptables -A WHITE_LIST -p udp -m udp --dport 4500 -j ACCEPT\n\n    iptables -A FORWARD -i ppp+ -j ACCEPT\n    iptables -A FORWARD -o ppp+ -j ACCEPT\n    iptables -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT\n\n    iptables -A IPSEC -m recent --rcheck --name ipsecbadcon --rsource -j DROP\n    iptables -A IPSEC -m recent --rcheck --seconds 600 --hitcount 10 --name ipseccon --rsource -j IPSECATTACK\n    iptables -A IPSEC -m recent --set --name ipseccon --rsource\n    iptables -A IPSEC -j ACCEPT\n\n    iptables -A IPSECATTACK -m recent --set --name ipsecbadcon --rsource\n    iptables -A IPSECATTACK -j LOG --log-prefix \"IPTABLES:SET_IPSEC_BAD_CON \" --log-level 6\n    iptables -A IPSECATTACK -j DROP\n\n    iptables -t nat -F\n    iptables -t nat -Z\n    iptables -t nat -X\n    iptables -t nat -P PREROUTING ACCEPT\n    iptables -t nat -P POSTROUTING ACCEPT\n    iptables -t nat -P OUTPUT ACCEPT\n\n    iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -j MASQUERADE\n\n    service iptables save\n}\n\nfunction loadWhiteList() {\n    WhiteList=\"/root/tool/iptables/cidr.txt\"\n    # cidr.txt.gz \u3092\u53d6\u5f97\u51fa\u6765\u305f\u3089\u3001WhiteList\u3092\u66f4\u65b0\n    wget -q -N http://nami.jp/ipv4bycc/cidr.txt.gz\n    if [ -f cidr.txt.gz -a `ls -l cidr.txt.gz | awk '{print $5;}'` != \"0\" ]; then\n        gzip -dc cidr.txt.gz | sed -n 's/^JP\\t//p' > ${WhiteList}\n        rm -f cidr.txt.gz\n    fi\n\n    # WhiteList\u3092iptables\u306b\u30ed\u30fc\u30c9\n    if [ -f ${WhiteList} -a `ls -l ${WhiteList} | awk '{print $5;}'` != \"0\" ]; then\n        cat ${WhiteList} | while read address; do\n            iptables -A INPUT -s $address -j WHITE_LIST\n        done\n    fi\n}\n\nfunction blockBroadCast() {\n    iptables -A INPUT -d 255.255.255.255 -j DROP\n    ip a | grep inet | grep brd | perl -pe \"s/^.*brd ([^ ]+).*$/\\1/\" | while read address; do\n        iptables -A INPUT -d ${address} -j DROP\n    done\n}\nmain\n\n\n\n\u305d\u306e\u4ed6\u306e\u53c2\u8003\u30da\u30fc\u30b8\niptables\u306e\u5404\u7a2e\u30c1\u30a7\u30fc\u30f3\u306e\u52d5\u304d\u3092\u7406\u89e3\u3059\u308b\u306e\u306b\u5f79\u7acb\u3063\u305f\u30da\u30fc\u30b8\nLinux\u3067\u4f5c\u308b\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\nnat\u30c6\u30fc\u30d6\u30eb\u3092\u5229\u7528\u3057\u305fLinux\u30eb\u30fc\u30bf\u306e\u4f5c\u6210\n\n\u305d\u306e\u4ed6\n\u3053\u306e\u8a2d\u5b9a\u3092\u5165\u308c\u3066\u304b\u3089\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306alog\u304c\u8a18\u9332\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n/var/log/kern.log\nSRC=192.168.1.2 DST=192.168.1.199 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=55530 DF PROTO=TCP SPT=1420 DPT=21 \nSRC=192.168.1.2 DST=192.168.1.199 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=55531 DF PROTO=TCP SPT=1420 DPT=21 \nSRC=192.168.1.2 DST=192.168.1.199 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=692 DF PROTO=TCP SPT=3264 DPT=80 \nSRC=192.168.1.2 DST=192.168.1.199 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=693 DF PROTO=TCP SPT=3264 DPT=80 \nSRC=192.168.1.2 DST=192.168.1.199 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=39646 DF PROTO=TCP SPT=3196 DPT=8000 \nSRC=192.168.1.2 DST=192.168.1.199 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=39647 DF PROTO=TCP SPT=3196 DPT=8000 \nSRC=192.168.1.2 DST=192.168.1.199 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=15443 DF PROTO=TCP SPT=3911 DPT=8080 \nSRC=192.168.1.2 DST=192.168.1.199 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=15444 DF PROTO=TCP SPT=3911 DPT=8080 \nSRC=192.168.1.2 DST=192.168.1.199 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=14704 DF PROTO=TCP SPT=3896 DPT=3389\n\n\n21\u3068\u304b80\u3068\u304b8080\u3068\u304b\u306b\u5bfe\u3057\u3066\u30ed\u30fc\u30ab\u30eb\u30a8\u30ea\u30a2\u5185\u304b\u3089\u30dd\u30fc\u30c8\u30b9\u30ad\u30e3\u30f3?!\n\u4f55\u4e8b\u304b\u3068\u601d\u3063\u305f\u3089\u3053\u3046\u3044\u3046\u4e8b\u3067\u3057\u305f\u3002\u3002\nBUFFALO \u304a\u5ba2\u69d8\u30b5\u30dd\u30fc\u30c8\n\u624b\u9806\u901a\u308a\u306b\u30eb\u30fc\u30bf\u306e\u8a2d\u5b9a\u3092\u89e3\u9664\u3057\u307e\u3057\u305f\u3002\n#\u306f\u3058\u3081\u306b\nVPN\u3092\u69cb\u7bc9\u3057\u3066\u6570\u65e5\u3002\n\u30ed\u30b0\u3092\u78ba\u8a8d\u3057\u3066\u307f\u308b\u3068\u3001109.188.127.144\u304b\u3089BruteForceAttack\u7684\u306a\u30a2\u30af\u30bb\u30b9\u304c\u3002\u3002\u3002\n\n\u30ed\u30b7\u30a2\u306e\u300cYota Clients\u300d\u3063\u3066\u6240\u3089\u3057\u304f\u3001\u65e5\u672c\u3067\u8a00\u3046\u3068\u3053\u308d\u306e\u30c9\u30b3\u30e2\u3068\u304bau\u307f\u305f\u3044\u306a\u4f01\u696d\u3063\u307d\u3044\uff1f\n\u305d\u306e\u4ed6\u306b\u3082\u5358\u767a\u3067\u30c1\u30e9\u30db\u30e9\u3068\u3001\u6d77\u5916\u304b\u3089\u3064\u3064\u304b\u308c\u3066\u308b\u3088\u3046\u3067\u3057\u305f\u3002\n\u3088\u304f\u5206\u304b\u3089\u3093\u3051\u3069\u3001\u6d77\u5916\u304b\u3089\u306e\u30a2\u30af\u30bb\u30b9\u306f\u906e\u65ad\u3057\u3066\u3057\u307e\u3046\u306e\u304c\u624b\u3063\u53d6\u308a\u65e9\u305d\u3046\u3002\u3002\u3002\n\u3068\u3044\u3046\u3053\u3068\u3067\u3001iptables\u3092\u8a2d\u5b9a\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\u305d\u306e\u6642\u306b\u3084\u3063\u305f\u4e8b\u306e\u30e1\u30e2\u3067\u3059\u3002\n\n#\u3084\u308a\u305f\u3044\u4e8b\n1. \u56fd\u5916\u304b\u3089\u306e\u30a2\u30af\u30bb\u30b9\u306f\u4e00\u5f8b\u30d6\u30ed\u30c3\u30af\n2. \u56fd\u5185\u304b\u3089\u306e\u30a2\u30af\u30bb\u30b9\u306f\u7279\u5b9a\u306e\u30dd\u30fc\u30c8\u3092\u8a31\u53ef\uff08VPN\u95a2\u9023\uff09\n3. \u30ed\u30fc\u30ab\u30eb\u30a8\u30ea\u30a2\u304b\u3089\u306e\u30a2\u30af\u30bb\u30b9\u306f\u3001\u7279\u5b9a\u306e\u30dd\u30fc\u30c8\u3092\u8a31\u53ef\uff08SSH\u7b49\uff09\n4. ipsec\u306e\u8a8d\u8a3c\u51e6\u7406\uff08\u30dd\u30fc\u30c8:500\uff09\u306b\u9023\u7d9a\u3057\u3066\u30a2\u30af\u30bb\u30b9\u3057\u3066\u304d\u305f\u63a5\u7d9a\u5143\u306f\u30d6\u30ed\u30c3\u30af\n\n#\u63a5\u7d9a\u5143\u306e\u5224\u5b9a\u306b\u3064\u3044\u3066\n\u3053\u3053\u3092\u53c2\u8003\u306b\u3057\u307e\u3057\u305f\u3002\n[\u56fd\u5185\u304b\u3089\u306e\u63a5\u7d9a\u306e\u307f\u8a31\u53ef\u3057\u3066\u6d77\u5916\u304b\u3089\u306e\u63a5\u7d9a\u3092\u906e\u65ad\u3059\u308b](http://vogel.at.webry.info/201306/article_2.html)\n\n\n```cron:crontab\nPATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin\n0 5 * * * /root/tool/iptables/iptablesSetup.sh\n```\n\n\u203bPATH\u306f\u3001cron\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\u300c/usr/bin:/bin\u300d\u3060\u3051\u306a\u306e\u3067\u8ffd\u52a0\u3057\u3066\u307e\u3059\u3002\n\n```Bash:iptablesSetup.sh\n# WHITE_LIST \u3068\u3044\u3046\u540d\u524d\u3067\u30e6\u30fc\u30b6\u5b9a\u7fa9\u30c1\u30a7\u30fc\u30f3\u3092\u4f5c\u6210\niptables -N WHITE_LIST\n\nfunction loadWhiteList() {\n    WhiteList=\"/root/tool/iptables/cidr.txt\"\n    # cidr.txt.gz \u3092\u53d6\u5f97\u51fa\u6765\u305f\u3089\u3001WhiteList\u3092\u66f4\u65b0\n    wget -q -N http://nami.jp/ipv4bycc/cidr.txt.gz\n    \n    # cidr.txt.gz \u3092\u53d6\u5f97\u51fa\u6765\u305f\u3089\u3001WhiteList\u3092\u66f4\u65b0\n    # \u305f\u3060\u3057\u3001\u30d5\u30a1\u30a4\u30eb\u30b5\u30a4\u30ba\u304c0byte\u306e\u5834\u5408\u306f\u4e0d\u6b63\u30d5\u30a1\u30a4\u30eb\u3068\u5224\u65ad\u3057\u3066\u66f4\u65b0\u30b9\u30ad\u30c3\u30d7\n    if [ -f cidr.txt.gz -a `ls -l cidr.txt.gz | awk '{print $5;}'` != \"0\" ]; then\n        gzip -dc cidr.txt.gz | sed -n 's/^JP\\t//p' > ${WhiteList}\n        rm -f cidr.txt.gz\n    fi\n\n    # WhiteList\u3092iptables\u306b\u30ed\u30fc\u30c9\n    if [ -f ${WhiteList} -a `ls -l ${WhiteList} | awk '{print $5;}'` != \"0\" ]; then\n        #\u4e0a\u8a18\u3067\u62bd\u51fa\u3055\u308c\u305f\u65e5\u672c\u306eIP\u30ea\u30b9\u30c8\u3092\uff11\u884c\u3065\u3064\u8aad\u307f\u8fbc\u307f\n        cat ${WhiteList} | while read address; do\n            #INPUT\u30c1\u30a7\u30fc\u30f3\uff08\u5165\u529b\u30d1\u30b1\u30c3\u30c8\u304c\u51e6\u7406\u3055\u308c\u308b\u30c7\u30d5\u30a9\u30eb\u30c8\u30c1\u30a7\u30fc\u30f3\uff09\u306b\u3066\n            #\u9001\u4fe1\u5143\u306eIP\u304c\u56fd\u5185\u306e\u7269\u304b\u30c1\u30a7\u30c3\u30af\u3002\n            #\u56fd\u5185\u306e\u7269\u3067\u3042\u308b\u5834\u5408\u306fWHITE_LIST\u30c1\u30a7\u30fc\u30f3\u3078\u98db\u3070\u3059\n            iptables -A INPUT -s $address -j WHITE_LIST\n        done\n    fi\n}\n```\n\n#\u9023\u7d9a\u3057\u3066\u30a2\u30af\u30bb\u30b9\u3057\u3066\u304d\u305f\u63a5\u7d9a\u5143\u306e\u30d6\u30ed\u30c3\u30af\n\n\u3053\u3053\u3092\u53c2\u8003\u306b\u3057\u307e\u3057\u305f\u3002\n[iptables \u306e ipt_recent \u3067 ssh \u306e brute force attack \u5bfe\u7b56](http://www2s.biglobe.ne.jp/~nuts/labo/inti/ipt_recent.html)\n\n\n```Bash:iptablesSetup.sh\n# \u524d\u8ff0\u306e\u5224\u5b9a\u3067\u3001\u56fd\u5185\u304b\u3089\u306e\u63a5\u7d9a\u3068\u5224\u5b9a\u3055\u308c\u305f\u30d1\u30b1\u30c3\u30c8\u306e\u307f\u304c\u3053\u3053\u306e\u51e6\u7406\u306b\u5165\u3063\u3066\u304f\u308b\n# WHITE_LIST\u30c1\u30a7\u30fc\u30f3\u3067\u306f\u3001udp\u306e500\u756a\u5b9b\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u306fIPSEC\u30c1\u30a7\u30fc\u30f3\u3078\u98db\u3070\u3059\niptables -A WHITE_LIST -p udp -m udp --dport 500 -j IPSEC\n\n#ipsecbadcon\u30ea\u30b9\u30c8\u306b\u767b\u9332\u3055\u308c\u305fIP\u306f\u554f\u7b54\u7121\u7528\u3067\u7834\u68c4\niptables -A IPSEC -m recent --rcheck --name ipsecbadcon --rsource -j DROP\n#ipseccon\u30ea\u30b9\u30c8\u3092\u30c1\u30a7\u30c3\u30af\u3057\u306610\u5206\u9593\u306b10\u56de\u30a2\u30af\u30bb\u30b9\u3057\u3066\u304d\u305f\u8f29\u306fIPSECATTACK\u30c1\u30a7\u30fc\u30f3\u3078\u98db\u3070\u3059\niptables -A IPSEC -m recent --rcheck --seconds 600 --hitcount 10 --name ipseccon --rsource -j IPSECATTACK\n#\u63a5\u7d9a\u56de\u6570\u304c\u95be\u5024\u306b\u9054\u3057\u3066\u3044\u306a\u3044\u30a2\u30af\u30bb\u30b9\u306fipseccon\u30ea\u30b9\u30c8\u306b\u767b\u9332\u3057\u3064\u3064\u63a5\u7d9a\u8a31\u53ef\niptables -A IPSEC -m recent --set --name ipseccon --rsource\niptables -A IPSEC -j ACCEPT\n\n#IPSECATTACK\u30c1\u30a7\u30fc\u30f3\u3067\u306fipsecbadcon\u30ea\u30b9\u30c8\u306b\u767b\u9332&syslog\u306b\u8a18\u9332\u3057\u3066\u7834\u68c4\niptables -A IPSECATTACK -m recent --set --name ipsecbadcon --rsource\niptables -A IPSECATTACK -j LOG --log-prefix \"IPTABLES:SET_IPSEC_BAD_CON \" --log-level 6\niptables -A IPSECATTACK -j DROP\n```\n\n#\u30ed\u30fc\u30ab\u30eb\u30a8\u30ea\u30a2\u63a5\u7d9a\u306e\u8a2d\u5b9a\n```Bash:iptablesSetup.sh\niptables -A INPUT -s 192.168.0.0/16 -j LOCAL_AREA\n\niptables -A LOCAL_AREA -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT\n# DHCP NetBIOS\niptables -A LOCAL_AREA -p udp -m multiport --dport 67,137,138 -j ACCEPT\n# DNS response\niptables -A LOCAL_AREA -p udp -m multiport --sport 53 -j ACCEPT\n#\u4e0a\u8a18\u4ee5\u5916\u306e\u30d1\u30b1\u30c3\u30c8\u306f\u8a18\u9332\u3057\u3064\u3064\u7834\u68c4\niptables -A LOCAL_AREA -j LOG --log-prefix \"IPTABLES:LOCAL_AREA_DROP \" --log-level 6\niptables -A LOCAL_AREA -j DROP\n```\n\n#\u5b8c\u6210\u7cfb\n\n\u3068\u3044\u3046\u3053\u3068\u3067\u3001\u5b8c\u6210\u7cfb\u3092\u6652\u3059\u3068\u3053\u3093\u306a\u611f\u3058\u3067\u3059\u3002\n\n```Bash:iptablesSetup.sh\nfunction main() {\n    #\u8a2d\u5b9a\u521d\u671f\u5316\n    iptables -F\n    #\u30ab\u30a6\u30f3\u30bf\u306e\u30ea\u30bb\u30c3\u30c8\n    iptables -Z\n    #\u30e6\u30fc\u30b6\u5b9a\u7fa9\u30c1\u30a7\u30a4\u30f3\u3092\u521d\u671f\u5316\n    iptables -X\n    iptables -P INPUT DROP\n    iptables -P OUTPUT ACCEPT\n    iptables -P FORWARD DROP\n\n    iptables -N LOCAL_AREA\n    iptables -N IPSEC\n    iptables -N IPSECATTACK\n    iptables -N WHITE_LIST\n\n    iptables -A INPUT -i lo -j ACCEPT\n    iptables -A INPUT -p icmp -j ACCEPT\n    iptables -A INPUT -p tcp -m state --state RELATED,ESTABLISHED -j ACCEPT\n    blockBroadCast\n    iptables -A INPUT -s 192.168.0.0/16 -j LOCAL_AREA\n\n    iptables -A LOCAL_AREA -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT\n    # DHCP NetBIOS\n    iptables -A LOCAL_AREA -p udp -m multiport --dport 67,137,138 -j ACCEPT\n    # DNS response\n    iptables -A LOCAL_AREA -p udp -m multiport --sport 53 -j ACCEPT\n    iptables -A LOCAL_AREA -j LOG --log-prefix \"IPTABLES:LOCAL_AREA_DROP \" --log-level 6\n    iptables -A LOCAL_AREA -j DROP\n\n    loadWhiteList\n    iptables -A INPUT -j LOG --log-prefix \"IPTABLES:NOT_IN_WHITE_LIST \" --log-level 6\n    iptables -A INPUT -j DROP\n\n    iptables -A WHITE_LIST -p udp -m udp --dport 500 -j IPSEC\n    iptables -A WHITE_LIST -p udp -m udp --dport 1701 -j ACCEPT\n    iptables -A WHITE_LIST -p udp -m udp --dport 4500 -j ACCEPT\n\n    iptables -A FORWARD -i ppp+ -j ACCEPT\n    iptables -A FORWARD -o ppp+ -j ACCEPT\n    iptables -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT\n\n    iptables -A IPSEC -m recent --rcheck --name ipsecbadcon --rsource -j DROP\n    iptables -A IPSEC -m recent --rcheck --seconds 600 --hitcount 10 --name ipseccon --rsource -j IPSECATTACK\n    iptables -A IPSEC -m recent --set --name ipseccon --rsource\n    iptables -A IPSEC -j ACCEPT\n\n    iptables -A IPSECATTACK -m recent --set --name ipsecbadcon --rsource\n    iptables -A IPSECATTACK -j LOG --log-prefix \"IPTABLES:SET_IPSEC_BAD_CON \" --log-level 6\n    iptables -A IPSECATTACK -j DROP\n\n    iptables -t nat -F\n    iptables -t nat -Z\n    iptables -t nat -X\n    iptables -t nat -P PREROUTING ACCEPT\n    iptables -t nat -P POSTROUTING ACCEPT\n    iptables -t nat -P OUTPUT ACCEPT\n\n    iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -j MASQUERADE\n\n    service iptables save\n}\n\nfunction loadWhiteList() {\n    WhiteList=\"/root/tool/iptables/cidr.txt\"\n    # cidr.txt.gz \u3092\u53d6\u5f97\u51fa\u6765\u305f\u3089\u3001WhiteList\u3092\u66f4\u65b0\n    wget -q -N http://nami.jp/ipv4bycc/cidr.txt.gz\n    if [ -f cidr.txt.gz -a `ls -l cidr.txt.gz | awk '{print $5;}'` != \"0\" ]; then\n        gzip -dc cidr.txt.gz | sed -n 's/^JP\\t//p' > ${WhiteList}\n        rm -f cidr.txt.gz\n    fi\n\n    # WhiteList\u3092iptables\u306b\u30ed\u30fc\u30c9\n    if [ -f ${WhiteList} -a `ls -l ${WhiteList} | awk '{print $5;}'` != \"0\" ]; then\n        cat ${WhiteList} | while read address; do\n            iptables -A INPUT -s $address -j WHITE_LIST\n        done\n    fi\n}\n\nfunction blockBroadCast() {\n    iptables -A INPUT -d 255.255.255.255 -j DROP\n    ip a | grep inet | grep brd | perl -pe \"s/^.*brd ([^ ]+).*$/\\1/\" | while read address; do\n        iptables -A INPUT -d ${address} -j DROP\n    done\n}\nmain\n```\n\n#\u305d\u306e\u4ed6\u306e\u53c2\u8003\u30da\u30fc\u30b8\niptables\u306e\u5404\u7a2e\u30c1\u30a7\u30fc\u30f3\u306e\u52d5\u304d\u3092\u7406\u89e3\u3059\u308b\u306e\u306b\u5f79\u7acb\u3063\u305f\u30da\u30fc\u30b8\n[Linux\u3067\u4f5c\u308b\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb](http://www.atmarkit.co.jp/ait/articles/0112/18/news002.html)\n[nat\u30c6\u30fc\u30d6\u30eb\u3092\u5229\u7528\u3057\u305fLinux\u30eb\u30fc\u30bf\u306e\u4f5c\u6210](http://www.atmarkit.co.jp/ait/articles/0505/17/news131.html)\n\n#\u305d\u306e\u4ed6\n\n\u3053\u306e\u8a2d\u5b9a\u3092\u5165\u308c\u3066\u304b\u3089\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306alog\u304c\u8a18\u9332\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n```log:/var/log/kern.log\nSRC=192.168.1.2 DST=192.168.1.199 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=55530 DF PROTO=TCP SPT=1420 DPT=21 \nSRC=192.168.1.2 DST=192.168.1.199 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=55531 DF PROTO=TCP SPT=1420 DPT=21 \nSRC=192.168.1.2 DST=192.168.1.199 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=692 DF PROTO=TCP SPT=3264 DPT=80 \nSRC=192.168.1.2 DST=192.168.1.199 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=693 DF PROTO=TCP SPT=3264 DPT=80 \nSRC=192.168.1.2 DST=192.168.1.199 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=39646 DF PROTO=TCP SPT=3196 DPT=8000 \nSRC=192.168.1.2 DST=192.168.1.199 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=39647 DF PROTO=TCP SPT=3196 DPT=8000 \nSRC=192.168.1.2 DST=192.168.1.199 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=15443 DF PROTO=TCP SPT=3911 DPT=8080 \nSRC=192.168.1.2 DST=192.168.1.199 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=15444 DF PROTO=TCP SPT=3911 DPT=8080 \nSRC=192.168.1.2 DST=192.168.1.199 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=14704 DF PROTO=TCP SPT=3896 DPT=3389\n```\n\n21\u3068\u304b80\u3068\u304b8080\u3068\u304b\u306b\u5bfe\u3057\u3066\u30ed\u30fc\u30ab\u30eb\u30a8\u30ea\u30a2\u5185\u304b\u3089\u30dd\u30fc\u30c8\u30b9\u30ad\u30e3\u30f3?!\n\u4f55\u4e8b\u304b\u3068\u601d\u3063\u305f\u3089\u3053\u3046\u3044\u3046\u4e8b\u3067\u3057\u305f\u3002\u3002\n\n[BUFFALO \u304a\u5ba2\u69d8\u30b5\u30dd\u30fc\u30c8](http://faq.buffalo.jp/app/answers/detail/a_id/11807/kw/DOS\u653b\u6483)\n\n\u624b\u9806\u901a\u308a\u306b\u30eb\u30fc\u30bf\u306e\u8a2d\u5b9a\u3092\u89e3\u9664\u3057\u307e\u3057\u305f\u3002\n"}