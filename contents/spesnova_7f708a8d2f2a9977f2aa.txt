{"context": " More than 1 year has passed since last update.\n\n\u6982\u8981\n\u30aa\u30d5\u30a3\u30b7\u30e3\u30eb\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u4f7f\u3063\u3066 etcd \u3092 go \u304b\u3089\u89e6\u308b\u3068\u3044\u3046\u8a71\u3002\n\n\u6e96\u5099\n\u307e\u305a etcd \u3092\u7528\u610f\u3059\u308b\u3002 Virtualbox \u3068 Vagrant \u304c\u3042\u308c\u3070\u3001coreos-vagrant \u3092\u4f7f\u3063\u3066\u30ed\u30fc\u30ab\u30eb\u306b CoreOS \u30de\u30b7\u30f3\u3092\u7acb\u3066\u308b\u3053\u3068\u3067\u3001http://172.17.8.101:4001 \u306b etcd \u306e\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u304c\u3067\u304d\u308b\u3002\nVagrant(Virtualbox) \u4e0a\u3067 CoreOS \u3092\u52d5\u304b\u3059 \u3092\u53c2\u7167\u3002\n\u6b21 go-etcd \u3068\u3063\u3066\u304f\u308b\n$ go get coreos/go-etcd\n\n\ngo \u304b\u3089 etcd \u3092\u89e6\u308b\npackage main\n\nimport (\n    \"fmt\"\n    \"github.com/coreos/go-etcd/etcd\"\n)\n\n// list of etcd endpoint\nvar machines = []string{\n    \"http://172.17.8.101:4001\",\n}\n\nfunc main() {\n    // Create etcd client\n    client := etcd.NewClient(machines)\n\n    // SET \"japan\" to /country/jp\n    if _, err := client.Set(\"/country/jp\", \"japan\", 0); err == nil {\n        fmt.Println(\"Set /country/jp\") \n    } else {\n        fmt.Println(\"error\")\n    }\n\n    // SET \"United States of Amarica\" to /country/us\n    if _, err := client.Set(\"/country/us\", \"United States of Amarica\", 0); err == nil {\n        fmt.Println(\"Set /country/us\")\n    } else {\n        fmt.Println(\"error\")\n    }\n\n    // GET /country/jp\n    if res, err := client.Get(\"/country/jp\", true, false); err == nil {\n        fmt.Println(\"key:\", res.Node.Key) // => key: /country/jp\n        fmt.Println(\"value:\", res.Node.Value) // => value: japan\n    } else {\n        fmt.Println(\"error\")\n    }\n\n    // GET /country as raw data\n    if res, err := client.RawGet(\"/country/jp\", true, false); err == nil {\n        fmt.Println(res.StatusCode) // => 200\n        fmt.Println(string(res.Body)) // => {\"action\":\"get\",\"node\":{\"key\":\"/country/jp\",\"value\":\"japan\",\"modifiedIndex\":5935,\"createdIndex\":5935}}\n    } else {\n        fmt.Println(\"error\")\n    }\n\n    // GET /country as raw data\n    if res, err := client.RawGet(\"/country\", true, false); err == nil {\n        fmt.Println(res.StatusCode) // => 200\n        fmt.Println(string(res.Body)) // => {\"action\":\"get\",\"node\":{\"key\":\"/country\",\"dir\":true,\"nodes\":[{\"key\":\"/country/jp\",\"value\":\"japan\",\"modifiedIndex\":5935,\"createdIndex\":5935},{\"key\":\"/country/us\",\"value\":\"United States of Amarica\",\"modifiedIndex\":5936,\"createdIndex\":5936}],\"modifiedIndex\":4817,\"createdIndex\":4817}}\n    } else {\n        fmt.Println(\"error\")\n    }\n}\n\n\n\u518d\u8d77\u7684\u306b\u53d6\u5f97\n\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30b5\u30fc\u30d3\u30b9\u30c7\u30a3\u30b9\u30ab\u30d0\u30ea\u60c5\u5831\u304c /services \u4ee5\u4e0b\u306b\u3042\u308b\u3068\u304d\u3001\n\uff08\u3061\u306a\u307f\u306b\u3053\u306e /services \u306f CoreOS \u4e0a\u306e Docker \u30b3\u30f3\u30c6\u30ca\u306e\u30b5\u30fc\u30d3\u30b9\u60c5\u5831\u3092 registrator \u3092\u4f7f\u3063\u3066 etcd \u3078\u81ea\u52d5\u767b\u9332\u3059\u308b \u3067\u30bb\u30c3\u30c8\u3055\u308c\u3066\u308b\u3082\u306e\uff09\ncore@core-01 ~ $ etcdctl ls --recursive /services\n/services/logspout\n/services/logspout/core-01:logspout:8000\n/services/logspout/core-02:logspout:8000\n/services/logspout/core-03:logspout:8000\n/services/registry\n/services/registry/core-01:registry:5000\n/services/registry/core-02:registry:5000\n/services/registry/core-03:registry:5000\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3001RawGet \u306e 3 \u3064\u76ee\u306e\u5f15\u6570\uff08recursive \u30aa\u30d7\u30b7\u30e7\u30f3) \u306b true \u3092\u6e21\u3059\u3053\u3068\u3067\n    // GET /services as raw data\n    if res, err := client.RawGet(\"/services\", true, true); err == nil {\n        fmt.Println(res.StatusCode)\n        fmt.Println(string(res.Body))\n    } else {\n        fmt.Println(\"error\")\n    }\n\n/services \u4ee5\u4e0b\u306e\u30c7\u30fc\u30bf\u304c\u5168\u3066\u53d6\u5f97\u3067\u304d\u308b\n{\n  \"node\": {\n    \"createdIndex\": 268,\n    \"modifiedIndex\": 268,\n    \"nodes\": [\n      {\n        \"createdIndex\": 313,\n        \"modifiedIndex\": 313,\n        \"nodes\": [\n          {\n            \"createdIndex\": 4760,\n            \"modifiedIndex\": 4760,\n            \"value\": \"172.17.8.101:8000\",\n            \"key\": \"/services/logspout/core-01:logspout:8000\"\n          },\n          {\n            \"createdIndex\": 4552,\n            \"modifiedIndex\": 4552,\n            \"value\": \"172.17.8.102:8000\",\n            \"key\": \"/services/logspout/core-02:logspout:8000\"\n          },\n          {\n            \"createdIndex\": 4579,\n            \"modifiedIndex\": 4579,\n            \"value\": \"172.17.8.103:8000\",\n            \"key\": \"/services/logspout/core-03:logspout:8000\"\n          }\n        ],\n        \"dir\": true,\n        \"key\": \"/services/logspout\"\n      },\n      {\n        \"createdIndex\": 268,\n        \"modifiedIndex\": 268,\n        \"nodes\": [\n          {\n            \"createdIndex\": 4761,\n            \"modifiedIndex\": 4761,\n            \"value\": \"172.17.8.101:5000\",\n            \"key\": \"/services/registry/core-01:registry:5000\"\n          },\n          {\n            \"createdIndex\": 4554,\n            \"modifiedIndex\": 4554,\n            \"value\": \"172.17.8.102:5000\",\n            \"key\": \"/services/registry/core-02:registry:5000\"\n          },\n          {\n            \"createdIndex\": 4581,\n            \"modifiedIndex\": 4581,\n            \"value\": \"172.17.8.103:5000\",\n            \"key\": \"/services/registry/core-03:registry:5000\"\n          }\n        ],\n        \"dir\": true,\n        \"key\": \"/services/registry\"\n      }\n    ],\n    \"dir\": true,\n    \"key\": \"/services\"\n  },\n  \"action\": \"get\"\n}\n\n\n\u30e1\u30e2\u3068\u611f\u60f3\n\n\u4ed6\u306b\u3067\u304d\u308b\u3053\u3068\n\nTLC \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3092\u4f5c\u6210\u3059\u308b NewTLSClient\n\netcd \u306e\u5909\u66f4\u3092 long polling \u3067\u76e3\u8996\u3059\u308b Watch\n\netcd \u30af\u30e9\u30b9\u30bf\u60c5\u5831\u306e\u53d6\u5f97\u3059\u308b GetCluster\n\n\n\u306a\u3069\u306a\u3069\u3002\n\u8a73\u7d30\u306f go-etcd - GoDoc \u3092\u53c2\u7167\u3002\n\nREF\n\ncoreos/go-etcd\ncoreos/etcd\netcd API\ncoreos/coreos-vagrant\n\n\n## \u6982\u8981\n\u30aa\u30d5\u30a3\u30b7\u30e3\u30eb\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u4f7f\u3063\u3066 etcd \u3092 go \u304b\u3089\u89e6\u308b\u3068\u3044\u3046\u8a71\u3002\n\n## \u6e96\u5099\n\u307e\u305a etcd \u3092\u7528\u610f\u3059\u308b\u3002 Virtualbox \u3068 Vagrant \u304c\u3042\u308c\u3070\u3001[coreos-vagrant](https://github.com/coreos/coreos-vagrant/) \u3092\u4f7f\u3063\u3066\u30ed\u30fc\u30ab\u30eb\u306b CoreOS \u30de\u30b7\u30f3\u3092\u7acb\u3066\u308b\u3053\u3068\u3067\u3001`http://172.17.8.101:4001` \u306b etcd \u306e\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u304c\u3067\u304d\u308b\u3002\n\n[Vagrant(Virtualbox) \u4e0a\u3067 CoreOS \u3092\u52d5\u304b\u3059](http://qiita.com/spesnova/items/17c3702b22f332352c9c) \u3092\u53c2\u7167\u3002\n\n\u6b21 go-etcd \u3068\u3063\u3066\u304f\u308b\n\n```bash\n$ go get coreos/go-etcd\n```\n\n## go \u304b\u3089 etcd \u3092\u89e6\u308b\n\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\t\"github.com/coreos/go-etcd/etcd\"\n)\n\n// list of etcd endpoint\nvar machines = []string{\n\t\"http://172.17.8.101:4001\",\n}\n\nfunc main() {\n\t// Create etcd client\n\tclient := etcd.NewClient(machines)\n\n\t// SET \"japan\" to /country/jp\n\tif _, err := client.Set(\"/country/jp\", \"japan\", 0); err == nil {\n\t\tfmt.Println(\"Set /country/jp\") \n\t} else {\n\t\tfmt.Println(\"error\")\n\t}\n\n\t// SET \"United States of Amarica\" to /country/us\n\tif _, err := client.Set(\"/country/us\", \"United States of Amarica\", 0); err == nil {\n\t\tfmt.Println(\"Set /country/us\")\n\t} else {\n\t\tfmt.Println(\"error\")\n\t}\n\n\t// GET /country/jp\n\tif res, err := client.Get(\"/country/jp\", true, false); err == nil {\n\t\tfmt.Println(\"key:\", res.Node.Key) // => key: /country/jp\n\t\tfmt.Println(\"value:\", res.Node.Value) // => value: japan\n\t} else {\n\t\tfmt.Println(\"error\")\n\t}\n\n\t// GET /country as raw data\n\tif res, err := client.RawGet(\"/country/jp\", true, false); err == nil {\n\t\tfmt.Println(res.StatusCode) // => 200\n\t\tfmt.Println(string(res.Body)) // => {\"action\":\"get\",\"node\":{\"key\":\"/country/jp\",\"value\":\"japan\",\"modifiedIndex\":5935,\"createdIndex\":5935}}\n\t} else {\n\t\tfmt.Println(\"error\")\n\t}\n\n\t// GET /country as raw data\n\tif res, err := client.RawGet(\"/country\", true, false); err == nil {\n\t\tfmt.Println(res.StatusCode) // => 200\n\t\tfmt.Println(string(res.Body)) // => {\"action\":\"get\",\"node\":{\"key\":\"/country\",\"dir\":true,\"nodes\":[{\"key\":\"/country/jp\",\"value\":\"japan\",\"modifiedIndex\":5935,\"createdIndex\":5935},{\"key\":\"/country/us\",\"value\":\"United States of Amarica\",\"modifiedIndex\":5936,\"createdIndex\":5936}],\"modifiedIndex\":4817,\"createdIndex\":4817}}\n\t} else {\n\t\tfmt.Println(\"error\")\n\t}\n}\n```\n\n### \u518d\u8d77\u7684\u306b\u53d6\u5f97\n\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30b5\u30fc\u30d3\u30b9\u30c7\u30a3\u30b9\u30ab\u30d0\u30ea\u60c5\u5831\u304c `/services` \u4ee5\u4e0b\u306b\u3042\u308b\u3068\u304d\u3001\n\uff08\u3061\u306a\u307f\u306b\u3053\u306e `/services` \u306f [CoreOS \u4e0a\u306e Docker \u30b3\u30f3\u30c6\u30ca\u306e\u30b5\u30fc\u30d3\u30b9\u60c5\u5831\u3092 registrator \u3092\u4f7f\u3063\u3066 etcd \u3078\u81ea\u52d5\u767b\u9332\u3059\u308b](http://qiita.com/spesnova/items/ab1c5ccc996f8d681839) \u3067\u30bb\u30c3\u30c8\u3055\u308c\u3066\u308b\u3082\u306e\uff09\n\n```bash\ncore@core-01 ~ $ etcdctl ls --recursive /services\n/services/logspout\n/services/logspout/core-01:logspout:8000\n/services/logspout/core-02:logspout:8000\n/services/logspout/core-03:logspout:8000\n/services/registry\n/services/registry/core-01:registry:5000\n/services/registry/core-02:registry:5000\n/services/registry/core-03:registry:5000\n```\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3001`RawGet` \u306e 3 \u3064\u76ee\u306e\u5f15\u6570\uff08`recursive` \u30aa\u30d7\u30b7\u30e7\u30f3) \u306b `true` \u3092\u6e21\u3059\u3053\u3068\u3067\n\n```go\n\t// GET /services as raw data\n\tif res, err := client.RawGet(\"/services\", true, true); err == nil {\n\t\tfmt.Println(res.StatusCode)\n\t\tfmt.Println(string(res.Body))\n\t} else {\n\t\tfmt.Println(\"error\")\n\t}\n```\n\n`/services` \u4ee5\u4e0b\u306e\u30c7\u30fc\u30bf\u304c\u5168\u3066\u53d6\u5f97\u3067\u304d\u308b\n\n```json\n{\n  \"node\": {\n    \"createdIndex\": 268,\n    \"modifiedIndex\": 268,\n    \"nodes\": [\n      {\n        \"createdIndex\": 313,\n        \"modifiedIndex\": 313,\n        \"nodes\": [\n          {\n            \"createdIndex\": 4760,\n            \"modifiedIndex\": 4760,\n            \"value\": \"172.17.8.101:8000\",\n            \"key\": \"/services/logspout/core-01:logspout:8000\"\n          },\n          {\n            \"createdIndex\": 4552,\n            \"modifiedIndex\": 4552,\n            \"value\": \"172.17.8.102:8000\",\n            \"key\": \"/services/logspout/core-02:logspout:8000\"\n          },\n          {\n            \"createdIndex\": 4579,\n            \"modifiedIndex\": 4579,\n            \"value\": \"172.17.8.103:8000\",\n            \"key\": \"/services/logspout/core-03:logspout:8000\"\n          }\n        ],\n        \"dir\": true,\n        \"key\": \"/services/logspout\"\n      },\n      {\n        \"createdIndex\": 268,\n        \"modifiedIndex\": 268,\n        \"nodes\": [\n          {\n            \"createdIndex\": 4761,\n            \"modifiedIndex\": 4761,\n            \"value\": \"172.17.8.101:5000\",\n            \"key\": \"/services/registry/core-01:registry:5000\"\n          },\n          {\n            \"createdIndex\": 4554,\n            \"modifiedIndex\": 4554,\n            \"value\": \"172.17.8.102:5000\",\n            \"key\": \"/services/registry/core-02:registry:5000\"\n          },\n          {\n            \"createdIndex\": 4581,\n            \"modifiedIndex\": 4581,\n            \"value\": \"172.17.8.103:5000\",\n            \"key\": \"/services/registry/core-03:registry:5000\"\n          }\n        ],\n        \"dir\": true,\n        \"key\": \"/services/registry\"\n      }\n    ],\n    \"dir\": true,\n    \"key\": \"/services\"\n  },\n  \"action\": \"get\"\n}\n```\n\n## \u30e1\u30e2\u3068\u611f\u60f3\n### \u4ed6\u306b\u3067\u304d\u308b\u3053\u3068\n\n* TLC \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3092\u4f5c\u6210\u3059\u308b `NewTLSClient`\n* etcd \u306e\u5909\u66f4\u3092 long polling \u3067\u76e3\u8996\u3059\u308b `Watch`\n* etcd \u30af\u30e9\u30b9\u30bf\u60c5\u5831\u306e\u53d6\u5f97\u3059\u308b `GetCluster`\n\n\u306a\u3069\u306a\u3069\u3002\n\n\u8a73\u7d30\u306f [go-etcd - GoDoc](https://godoc.org/github.com/coreos/go-etcd/etcd) \u3092\u53c2\u7167\u3002\n\n\n## REF\n\n* [coreos/go-etcd](https://github.com/coreos/go-etcd)\n* [coreos/etcd](https://github.com/coreos/etcd)\n* [etcd API](https://coreos.com/docs/distributed-configuration/etcd-api/)\n* [coreos/coreos-vagrant](https://github.com/coreos/coreos-vagrant/)\n", "tags": ["CoreOS", "etcd", "Go"]}