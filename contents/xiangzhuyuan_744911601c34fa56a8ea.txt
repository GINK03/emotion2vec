{"tags": ["Rails", "ActiveRecord"], "context": "\n\u5bf9\u4e8e migration \u6765\u8bf4,\u5b83\u5c31\u662f Active record \u7f16\u5199\u7684\u4e00\u5957 DSL \u7528\u6765\u4fee\u6539\u6570\u636e\u5e93\u8868\u7684 schema. \u4e0d\u540c\u4e8e\u76f4\u63a5\u901a\u8fc7 SQL \u6765\u5b9e\u73b0, \u5b83\u80fd\u591f\u66f4\u52a0\u5bb9\u6613\u7684\u901a\u8fc7 ruby \u7684\u4ee3\u7801\u6765\u5b9e\u73b0.\n\u672c\u6587\u4e3b\u8981\u6709\u4e0b\u9762\u51e0\u4e2a\u65b9\u9762:\n\n\u901a\u8fc7\u4f7f\u7528\u751f\u6210\u5668\u6765\u5b8c\u6210\u521b\u5efa\nactive record \u63d0\u4f9b\u7684\u6240\u6709\u7528\u6765\u7ef4\u62a4\u6570\u636e\u7684\u65b9\u6cd5\n\u901a\u8fc7 rails \u7684\u5185\u7f6e task \u65b9\u6cd5\u6765\u5b8c\u6210migration\nmigration\u548cschema.rb \u4e4b\u95f4\u7684\u5173\u8054\n\n\nmigration \u7684\u6982\u89c8\n\n\u521b\u5efamigration\n\n\u521b\u5efa\u72ec\u7acb\u7684 migration\nmigration\u4f5c\u4e3a\u5355\u72ec\u7684\u6587\u4ef6\u5b58\u653e\u5728db/migration \u6587\u4ef6\u5939\u4e0b\u9762, \u6bcf\u4e00\u4e2a\u90fd\u662f\u72ec\u7acb\u7684 migration \u7c7b. \u8fd9\u4e2a\u6587\u4ef6\u540d\u6709\u4e00\u5b9a\u7684\u89c4\u5219\u5c31\u662f\u65f6\u95f4\u6233\u52a0\u52a8\u4f5c, \u5982YYYYMMDDHHMMSS_create_products.rb, \u610f\u601d\u5f88\u660e\u4e86. \u5c31\u662f\u5728\u67d0\u4e2a\u65f6\u95f4\u70b9,\u4e0b\u5212\u7ebf\u52a0\u4e0a migration \u7684\u540d\u79f0.\u800c\u5bf9\u4e8e migration \u7684\u7c7b\u540d, \u4e5f\u5b8c\u5168\u662f\u6839\u636e\u6587\u4ef6\u540d\u7684\u79fb\u5f62\u540d\u5b57\u6765\u7684,\u53ea\u662f\u628a\u5b83\u53d8\u6210\u4e86\u9a7c\u5cf0\u547d\u540d. \u5982\u8fd9\u4e2a\u79fb\u5f62\u6587\u4ef620080906120000_create_products.rb \u5b9e\u9645\u5bf9\u5e94\u5c31\u4f1a\u751f\u6210\u4e00\u4e2aCreateProducts\u7c7b, \u800c20080906120001_add_details_to_products.rb \u540c\u6837\u5c31\u662fAddDetailsToProducts. \u800c\u8fd9\u91cc\u6587\u4ef6\u540d\u91cc\u7684\u65f6\u95f4\u6233\u5c31\u662f\u7528\u6765\u544a\u8bc9 rails \u5982\u4f55\u6309\u65f6\u95f4\u987a\u5e8f\u6765\u5b8c\u6210\u6240\u6709\u7684\u79fb\u5f62. \u6240\u4ee5\u6709\u65f6\u5019\u4f60\u56fe\u65b9\u4fbf\u76f4\u63a5\u62f7\u8d1d\u4e86\u4e00\u4e2a\u79fb\u5f62\u6587\u4ef6, \u8fd9\u4e2a\u65f6\u5019\u5c31\u8981\u6ce8\u610f\u65f6\u95f4\u6233\u4e86, \u5982\u679c\u4e8c\u8005\u76f8\u4e92\u6ca1\u6709\u4f9d\u8d56\u53ef\u80fd\u4e5f\u4e0d\u4f1a\u51fa\u73b0\u95ee\u9898.\n\u5f53\u7136\u8fd9\u91cc\u5982\u679c\u6211\u4eec\u6bcf\u6b21\u624b\u52a8\u53bb\u62ff\u4e00\u4e2a\u65f6\u95f4\u6233\u7136\u540e\u521b\u5efa\u4e00\u4e2a\u79fb\u5f62\u6587\u4ef6\u5c31\u65e0\u8da3\u4e86, rails \u5f53\u7136\u4f1a\u63d0\u4f9b\u65b9\u6cd5\u7684\u751f\u6210\u5668\u6765\u5b8c\u6210\u8fd9\u4e2a\u52a8\u4f5c. \u5982\u4e0b\u9762\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u79fb\u5f62:\n\n$ bin/rails generate migration AddPartNumberToProducts\n\n\u5c06\u4f1a\u751f\u6210\u4e0b\u9762\u8fd9\u6837\u4e00\u4e2a\u6587\u4ef6:\nclass AddPartNumberToProducts < ActiveRecord::Migration[5.0]\n  def change\n  end\nend\n\n\n\u8fd9\u91cc, \u5982\u679c\u5728\u521b\u5efa\u8fd9\u4e2a\u79fb\u5f62\u6587\u4ef6\u7684\u65f6\u5019, \u6587\u4ef6\u540d\u5982\u679c\u9075\u5faa\u4e86\u5982AddXXXToYYY \u6216\u8005RemoveXXXFromYYY, active record \u5c31\u4f1a\u5f88\u8d34\u5fc3\u7684\u76f4\u63a5\u5728\u79fb\u5f62\u7c7b\u91cc\u6dfb\u52a0\u5bf9\u5e94\u76f8\u4f3c\u7684\u65b9\u6cd5.\n$ bin/rails generate migration AddPartNumberToProducts part_number:string\n\nclass AddPartNumberToProducts < ActiveRecord::Migration[5.0]\n  def change\n    add_column :products, :part_number, :string\n  end\nend\n\n\u6211\u4eec\u8fd8\u53ef\u4ee5\u76f4\u63a5\u7ed9\u67d0\u4e2a\u5b57\u6bb5\u6dfb\u52a0\u7d22\u5f15\n$ bin/rails generate migration AddPartNumberToProducts part_number:string:index\nwill generate\n\nclass AddPartNumberToProducts < ActiveRecord::Migration[5.0]\n  def change\n    add_column :products, :part_number, :string\n    add_index :products, :part_number\n  end\nend\n\n\u5f53\u7136\u79fb\u9664\u67d0\u4e2a\u5b57\u6bb5\u4e5f\u4e0d\u662f\u95ee\u9898\n$ bin/rails generate migration RemovePartNumberFromProducts part_number:string\ngenerates\n\nclass RemovePartNumberFromProducts < ActiveRecord::Migration[5.0]\n  def change\n    remove_column :products, :part_number, :string\n  end\nend\n\n\u5f53\u7136\u4e00\u6b21\u6dfb\u52a0\u591a\u4e2a\u4e5f\u6ca1\u6709\u95ee\u9898:\n$ bin/rails generate migration AddDetailsToProducts part_number:string price:decimal\ngenerates\n\nclass AddDetailsToProducts < ActiveRecord::Migration[5.0]\n  def change\n    add_column :products, :part_number, :string\n    add_column :products, :price, :decimal\n  end\nend\n\n\u5f53\u7136\u4f60\u53ef\u4ee5\u5199\u6210\u53ea\u662f\u521b\u5efa\u67d0\u4e2a\u5bf9\u8c61CreateXXX, \u7136\u540e\u8ddf\u591a\u4e2a\u5b57\u6bb5\u7684\u5f62\u5f0f,  \u5b8c\u5168\u6ca1\u6709\u95ee\u9898(\u6211\u8bf4, \u8fd9\u6837\u597d\u5417 \u6709\u5fc5\u8981\u5417?)\n\n$ bin/rails generate migration CreateProducts name:string part_number:string\ngenerates\n\nclass CreateProducts < ActiveRecord::Migration[5.0]\n  def change\n    create_table :products do |t|\n      t.string :name\n      t.string :part_number\n    end\n  end\nend\n\n\n\u5176\u5b9e, \u4e0a\u9762\u5404\u79cd\u5404\u6837\u7684\u73a9\u6cd5\u4e5f\u662f\u4e00\u4e2a\u5f00\u59cb, \u5f88\u591a\u65f6\u5019\u4f60\u5927\u53ef\u5b8c\u5168\u76f4\u63a5\u53bb\u7f16\u8f91db/migrate \u76ee\u5f55\u4e0b\u7684\u5982YYYYMMDDHHMMSS_add_details_to_products.rb\u6587\u4ef6\u6765\u5f97\u5feb.\n\u8bf4\u5230\u8fd9\u91ccmigrate \u540c\u6837\u652f\u6301\u5173\u8054\u805a\u5408\u5173\u7cfb\u7684\u521b\u5efa.( belongs_to)\n\n$ bin/rails generate migration AddUserRefToProducts user:references\ngenerates\n\nclass AddUserRefToProducts < ActiveRecord::Migration[5.0]\n  def change\n    add_reference :products, :user, index: true, foreign_key: true\n  end\nend\n\n\u8fd9\u4e2a migrate \u5c06\u4f1a\u521b\u5efa\u4e00\u4e2auser_id \u7684\u5916\u952e,\u987a\u4fbf\u7ed9\u5b83\u7d22\u5f15. \u5173\u4e8eadd_reference \u8fd8\u6709\u5f88\u591a\u7684\u9009\u9879\u53ef\u4ee5\u770b\u770b API \u6587\u6863.\n\u5f53\u7136\u5982\u679c\u5728 migration \u7684\u6587\u4ef6\u540d\u6dfb\u52a0\u4e86JoinTable\u7684\u8bdd, \u53ef\u4ee5\u76f4\u63a5\u521b\u5efa\u751f\u6210jointable \u7684\u547d\u4ee4.\n$ bin/rails g migration CreateJoinTableCustomerProduct customer product\nwill produce the following migration:\n\nclass CreateJoinTableCustomerProduct < ActiveRecord::Migration[5.0]\n  def change\n    create_join_table :customers, :products do |t|\n      # t.index [:customer_id, :product_id]\n      # t.index [:product_id, :customer_id]\n    end\n  end\nend\n\n\n\u5bf9\u8c61\u751f\u6210\u5668\n\u5bf9\u4e8e\u5bf9\u8c61\u751f\u6210\u5668\u6216\u8005\u9aa8\u67b6\u751f\u6210\u5668\u4ed6\u4eec\u6765\u8bf4, \u5728\u4f7f\u7528\u4ed6\u4eec\u7684\u65f6\u5019\u540c\u65f6\u5df2\u7ecf\u4e3a\u4f60\u751f\u6210\u4e86\u5bf9\u8c61\u7684 migration, \u8fd9\u4e2a migration \u5df2\u7ecf\u5305\u542b\u4e86\u521b\u5efa\u76f8\u5173\u8868, \u5982\u679c\u4f60\u544a\u8bc9 Rails \u6dfb\u52a0\u4ec0\u4e48\u5b57\u6bb5\u4e0a\u9762\u7684\u90fd\u4f1a\u4e3a\u4e86\u4e00\u6c14\u641e\u5b9a. \u770b\u770b\u4e0b\u9762\u7684\u4f8b\u5b50:\n\n$ bin/rails generate model Product name:string description:text\n\n\u5bf9\u4e8e\u4e0a\u9762\u7684\u5bf9\u8c61\u751f\u6210\u5668\u7684\u6267\u884c\u7ed3\u679c\u5c31\u662f\u4f1a\u751f\u6210\u4e0b\u9762\u7684 migration:\nclass CreateProducts < ActiveRecord::Migration[5.0]\n  def change\n    create_table :products do |t|\n      t.string :name\n      t.text :description\n\n      t.timestamps\n    end\n  end\nend\n\n\n\u8fd9\u91cc\u4f60\u53ef\u4ee5\u6dfb\u52a0\u4efb\u610f\u591a\u7684\u5b57\u6bb5\u58f0\u660e\n\n\n\u4f7f\u7528\u7c7b\u578b\u5b9a\u4e49\n\u6211\u4eec\u53ef\u4ee5\u5728\u4f7f\u7528\u751f\u6210\u5668\u7684\u65f6\u5019\u76f4\u63a5\u7ed9\u5b57\u6bb5\u5b9a\u4e49\u7c7b\u578b\u5b9a\u4e49\u58f0\u660e, \u901a\u8fc7\u4f7f\u7528\u5927\u62ec\u53f7\u7684\u65b9\u5f0f\u7ed9\u5b83\u4e00\u4e2a\u7c7b\u578b:\n$ bin/rails generate migration AddDetailsToProducts 'price:decimal{5,2}' supplier:references{polymorphic}\n\n\u5c06\u4f1a\u751f\u6210\u8fd9\u6837\u7684\u5b9a\u4e49:\nclass AddDetailsToProducts < ActiveRecord::Migration[5.0]\n  def change\n    add_column :products, :price, :decimal, precision: 5, scale: 2\n    add_reference :products, :supplier, polymorphic: true, index: true\n  end\nend\n\n\u6709\u5f88\u591a\u73a9\u6cd5\u4e86, \u770b\u770b API \u6587\u6863\u597d\u4e86.\n\n\u600e\u4e48\u5199\u4e00\u4e2amigration\n\u5f53\u6211\u4eec\u901a\u8fc7\u751f\u6210\u5668\u751f\u6210\u4e86 migration \u4e4b\u540e,\u624d\u521a\u5f00\u59cb.\n\n\u521b\u5efa\u8868\n\u901a\u8fc7create_table \u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u8868,\u7b97\u662f\u6700\u57fa\u672c\u7684\u51fd\u6570\u4e86. \u4f46\u662f\u901a\u5e38\u6211\u4eec\u901a\u8fc7\u5927\u90e8\u5206\u7684\u751f\u6210\u5668\u5c31\u53ef\u4ee5\u5b8c\u6210\u8fd9\u4e2a\u6b65\u9aa4, \u770b\u4e0a\u53bb\u5c31\u50cf\u4e0b\u9762\u8fd9\u6837\u7684:\n\ncreate_table :products do |t|\n  t.string :name\nend\n\n\u8fd9\u4e2a\u5c06\u4f1a\u521b\u5efa\u4e00\u4e2aproducts \u7684\u8868, \u7136\u540e\u4e00\u4e2aname\u7684\u5b57\u6bb5.(\u540c\u65f6\u8fd8\u6709\u4e00\u4e2aid \u7684\u5b57\u6bb5). \u9ed8\u8ba4\u5f97create_table \u547d\u4ee4\u5c06\u4f1a\u521b\u5efa\u4e00\u4e2aid \u7684\u4e3b\u952e. \u4f60\u53ef\u4ee5\u901a\u8fc7:primary_key \u7684\u9009\u9879\u6765\u4fee\u6539\u8fd9\u4e2a\u9ed8\u8ba4\u503c, \u4f46\u662f\u8fd9\u4e2a\u60c5\u51b5\u4e0b\u5c31\u9700\u8981\u4fee\u6539\u5bf9\u5e94\u7684 model. \u5f53\u7136\u4f60\u53ef\u4ee5\u4e0d\u8981\u8fd9\u4e2a\u4e3b\u952e, \u53ea\u8981\u7ed9id:false \u7684\u53c2\u6570\u5c31 ok. \u5982\u679c\u4f60\u9700\u8981\u8bbe\u7f6e\u6570\u636e\u5e93\u7279\u5b9a\u7684\u53c2\u6570\u7684\u65f6\u5019\u76f4\u63a5\u5728option\u7684\u53c2\u6570\u91cc\u6307\u5b9a\u5c31\u53ef\u4ee5. \u5982\u4e0b\u9762\u7684\u4f8b\u5b50:\n\ncreate_table :products, options: \"ENGINE=BLACKHOLE\" do |t|\n  t.string :name, null: false\nend\n\n\u8fd9\u4e2a\u5b57\u7b26\u4e32\u4f1a\u8ffd\u52a0\u5230\u521b\u5efa\u6570\u636e\u5e93\u8868\u7684SQL \u8bed\u53e5\u540e,(\u5728\u4f7f\u7528MySQL\u6216\u8005MariaDB\u7684\u65f6\u5019, \u9ed8\u8ba4\u7684\u5f15\u64ce\u662fInnoDB)\n\n\u540c\u65f6\u4f60\u4e5f\u5b8c\u5168\u53ef\u4ee5\u901a\u8fc7: comment \u7684\u9009\u9879\u7ed9\u6570\u636e\u5e93\u8868\u6dfb\u52a0\u4efb\u4f55\u7684\u6ce8\u91ca.\u8fd9\u4e2a\u52a8\u4f5c\u4e5f\u5c31\u662f\u901a\u8fc7\u8ffd\u52a0\u9009\u9879\u6ce8\u91ca\u5230\u5b9e\u9645\u7684 SQL \u6587\u5b9e\u73b0.\n\n\n\u521b\u5efa Join \u8868\nmigration \u901a\u8fc7create_join_table \u6765\u521b\u5efaHABTM \u7684\u5173\u8054\u8868, \u901a\u5e38\u662f\u8fd9\u6837\u7684:\ncreate_Join_table :products, :categories\n\n\u8fd9\u4e2a\u5c06\u4f1a\u521b\u5efa\u4e00\u4e2acategories_products \u8868, \u6709\u4e24\u4e2a\u5b57\u6bb5category_id \u8fd8\u6709product_id, \u8fd9\u4e9b\u5b57\u6bb5\u90fd\u88ab\u8bbe\u7f6e\u7684: null \u7684\u9009\u9879,\u9ed8\u8ba4\u4e3afalse.\n\ncreate_join_table :products, :categories, column_options: { null: true }\n\n\u9ed8\u8ba4\u6700\u540e\u8fd9\u4e2a\u5173\u8054\u8868\u7684\u540d\u5b57\u5c06\u662f\u6765\u81ea\u4e8e\u521b\u5efa migration \u7684\u65f6\u5019\u7ed9\u76842\u4e2a\u8868\u660e\u901a\u8fc7\u5b57\u6bcd\u6392\u5e8f\u5f97\u5230\u7684. \u540c\u65f6\u53ef\u4ee5\u901a\u8fc7: table_name \u7684\u53c2\u6570\u6765\u6307\u5b9a\u8868\u540d.\n\ncreate_join_table :products, :categories, table_name: :categorization\n\n\u5b83\u5c06\u4f1a\u521b\u5efa\u4e00\u4e2acategorization\u7684\u8868.\ncreate_join_table \u8fd8\u53ef\u4ee5\u63a5\u53d7\u4ee3\u7801\u5757,\u8fd9\u6837\u5c31\u53ef\u4ee5\u6dfb\u52a0\u4efb\u610f\u7684\u8bbe\u7f6e.\u6216\u8005\u989d\u5916\u7684\u5b57\u6bb5.\ncreate_join_table :products, :categories do |t|\n  t.index :product_id\n  t.index :category_id\nend\n\n\n\n\u4fee\u6539\u8868\ncreate_table \u7684\u8868\u5144\u5c31\u662fchange_table \u4e86. \u7528\u6765\u4fee\u6539\u73b0\u6709\u7684\u8868\u7ed3\u6784,\u901a\u5e38\u5b83\u548c\u521b\u5efa\u8868\u7684\u6784\u6210\u4e00\u6837.\u4f46\u662f\u4ee3\u7801\u5757\u91ccyeild \u51fa\u6765\u7684\u5bf9\u8c61\u6709\u66f4\u591a\u795e\u5947\u7684\u7528\u6cd5.\n\nchange_table :products do |t|\n  t.remove :description, :name\n  t.string :part_number\n  t.index :part_number\n  t.rename :upccode, :upc_code\nend\n\n\u4e0a\u9762\u7684\u5b9a\u4e49\u662f\u5206\u522b\u79fb\u9664\u4e86description \u548cname\u5b57\u6bb5,\u6dfb\u52a0\u4e86part_time \u7684\u5b57\u6bb5\u5e76\u4e14\u7ed9\u5b83\u6dfb\u52a0\u4e86\u7d22\u5f15, \u8fd8\u6709\u5c06upccode\u91cd\u547d\u540d\u4e3aupc_code.\n\n\u4fee\u6539\u5b57\u6bb5\n\u8fd8\u6709\u548cremove_column\u4e0eadd_column \u547d\u4ee4\u76f8\u4f3c\u7684change_column,\n\nchange_column :products, :part_number, :text\n\n\u8fd9\u4e2a\u52a8\u4f5c\u5c31\u662f\u5c06products \u8868\u91cc\u7684part_number \u8bbe\u7f6e\u4e3a: text \u7c7b\u578b, \u6ce8\u610f \u8fd9\u91cc\u7684\u64cd\u4f5c\u662f\u4e0d\u53ef\u9006\u7684.\n\u53e6\u5916\u8fd8\u6709change_column_null \u548cchange_column_default \u65b9\u6cd5, \u4ed6\u4eec\u7528\u6765\u4fee\u6539\u7279\u5b9a\u5b57\u6bb5\u7684\u7ea6\u675f\u548c\u9ed8\u8ba4\u503c.\n\nchange_column_null :products, :name, false\nchange_column_default :products, :approved, from: true, to: false\n\n\n\u4e0a\u9762\u7684\u52a8\u4f5c\u5c31\u662f\u5c06: name \u5b57\u6bb5\u6dfb\u52a0\u4e0d\u53ef\u7a7a\u7684\u7ea6\u675f,\u7136\u540e\u7ed9approved \u7684\u9ed8\u8ba4\u503c\u662ffalse.\n\n\u6ce8\u610f\u4e0a\u9762\u8fd9\u4e2a\u52a8\u4f5c\u53ef\u4ee5\u901a\u8fc7change_column \u6765\u5b8c\u6210, \u4f46\u662f\u90a3\u6837\u5c31\u53d8\u6210\u4e86\u4e0d\u53ef\u9006\u7684\u64cd\u4f5c\n\n\n\u5b57\u6bb5\u4fee\u9970\u7b26\n\u5b57\u6bb5\u7684\u7c7b\u578b\u5b9a\u4e49\u53ef\u4ee5\u5728\u521b\u5efa\u6216\u8005\u4fee\u6539\u7684\u65f6\u5019\u8bbe\u7f6e.\n\n\nlimit \u53ef\u4ee5\u7ed9string/text/binary/integer\u7c7b\u578b\u7684\u5b57\u6bb5\u8bbe\u7f6e\u6700\u5927\u503c.\n\nprecision \u5b9a\u4e49\u4e86decimal \u5b57\u6bb5\u7684precision, \u4e5f\u5c31\u662f\u591a\u5927.\n\nscale,\u5b9a\u4e49\u4e86 decimal \u5b57\u6bb5\u7684\u7cbe\u5ea6, \u4e5f\u5c31\u662f\u5c0f\u6570\u70b9\u540e\u9762\u7684\u4f4d\u6570.\n\npolymorphic \u7ed9\u5b57\u6bb5\u6dfb\u52a0belong_to \u7684\u5173\u8054.\n\nnull, \u5b57\u6bb5\u662f\u5426\u53ef\u4e3a\u7a7a\n\ndefault \u7ed9\u5b57\u6bb5\u6dfb\u52a0\u9ed8\u8ba4\u503c, \u6ce8\u610f \u5982\u679c\u4f60\u4f7f\u7528\u52a8\u6001\u503c(\u5982\u65e5\u671f)\u9ed8\u8ba4\u503c\u5c06\u4f1a\u5728\u7b2c\u4e00\u6b21\u4f7f\u7528\u7684\u65f6\u5019\u6307\u5b9a.\n\nindex \u5c31\u662f\u7ed9\u67d0\u4e2a\u5b57\u6bb5\u6dfb\u52a0\u7d22\u5f15\n\ncomment \u5c31\u662f\u7ed9\u5b57\u6bb5\u6dfb\u52a0\u6ce8\u91ca\n\n\u6709\u4e9b\u7279\u5b9a\u7684\u9002\u914d\u5668\u53ef\u80fd\u4f1a\u9488\u5bf9\u7279\u5b9a\u7684\u6570\u636e\u5e93\u6709\u7279\u5b9a\u7684\u9009\u9879\u53ef\u4ee5\u4f7f\u7528. \u67e5\u9605 API.\n\n\u5916\u952e\n\u867d\u7136\u4e0d\u662f\u8981\u6c42\u7684, \u4f46\u662f\u4f60\u53ef\u80fd\u4f1a\u901a\u8fc7\u6dfb\u52a0\u5916\u952e\u7ea6\u675f\u6765 \u786e\u4fdd\u5f15\u7528\u4e00\u81f4\u6027.\n\nadd_foreign_key :articles, :authors\n\n\u8fd9\u4e2a\u52a8\u4f5c\u7684\u7ed3\u679c\u5c31\u662f\u4f1a\u7ed9articles \u8fd9\u4e2a\u8868\u6dfb\u52a0\u4e00\u4e2a\u5916\u952eauthor_id, \u5b83\u5c31\u662f\u6765\u81eaauthor \u8868\u7684\u4e3b\u952eid, \u5982\u679c\u4ec5\u662f\u901a\u8fc7\u4e0a\u9762\u7684\u547d\u4ee4\u800c\u4e0d\u80fd\u591f\u5f97\u5230\u5916\u952e\u540d,\u53ef\u4ee5\u901a\u8fc7:column \u548c: primary_key \u9009\u9879\u6765\u6307\u5b9a.\nRails \u901a\u5e38\u4f1a\u901a\u8fc7from_table \u548ccolumn \u4e24\u4e2a\u53d8\u91cf\u6765\u7ed9\u6bcf\u4e00\u4e2a\u5916\u952e\u751f\u6210\u4e00\u4e2a\u4ee5fk_rails_\u5f00\u5934\u768410\u5b57\u7b26\u540d\u5b57.\u540c\u65f6\u4e5f\u53ef\u4ee5\u901a\u8fc7: name \u9009\u9879\u6765\u6307\u5b9a\u4e00\u4e2a\u4e0d\u540c\u7684\u540d\u5b57.\n\nActive record\u53ea\u652f\u6301\u5355\u5916\u952e, execute and structure.sql are required to use composite foreign keys. See Schema Dumping and You.\n\n\u79fb\u9664\u5916\u952e\u4e5f\u662f\u5f88\u8f7b\u677e\u7684:\n# let Active Record figure out the column name\nremove_foreign_key :accounts, :branches\n\n# remove foreign key for a specific column\nremove_foreign_key :accounts, column: :owner_id\n\n# remove foreign key by name\nremove_foreign_key :accounts, name: :special_fk_name\n\n\n\u5f53\u5e2e\u52a9\u65b9\u6cd5\u4e0d\u591f\u7528\u7684\u60c5\u51b5\n\u5982\u679c\u53d1\u73b0active record \u63d0\u4f9b\u7684\u5e2e\u52a9\u65b9\u6cd5\u4e0d\u591f\u7528\u7684\u65f6\u5019\u53ef\u4ee5\u76f4\u63a5\u6267\u884cSQL \u6765\u5b9e\u73b0.\nProduct.connection.execute(\"UPDATE products SET price = 'free' WHERE 1=1\")\n\n\u66f4\u591a\u8be6\u60c5\u548c\u5355\u72ec\u7684\u65b9\u6cd5, \u53ef\u4ee5\u901a\u8fc7\u786e\u8ba4 API \u6587\u6863\u6765\u5b66\u4e60\u4e86\u89e3, \u8fd9\u91cc\u63d0\u4f9b\u4e86 change up \u548c down \u7684\u65b9\u6cd5, \u521b\u5efa\u8868\u7684\u66f4\u591a, \u8fd8\u6709\u4fee\u6539\u8868.\n\n\u4fee\u6539\u8868\n\u4f7f\u7528 migration \u7684\u65f6\u5019,\u66f4\u591a\u7684\u5c31\u662f\u901a\u8fc7change \u65b9\u6cd5. \u8fd9\u4e2a\u4f1a\u5bf9\u4e8e\u5927\u591a\u6570 case \u7ba1\u7528. \u56e0\u4e3a active record \u90fd\u53ef\u4ee5\u8f7b\u677e hold \u4f4f,\u5f53\u524d\u652f\u6301\u8fd9\u4e9b\u65b9\u6cd5:\nadd_column\nadd_foreign_key\nadd_index\nadd_reference\nadd_timestamps\nchange_column_default (must supply a :from and :to option)\nchange_column_null\ncreate_join_table\ncreate_table\ndisable_extension\ndrop_join_table\ndrop_table (must supply a block)\nenable_extension\nremove_column (must supply a type)\nremove_foreign_key (must supply a second table)\nremove_index\nremove_reference\nremove_timestamps\nrename_column\nrename_index\nrename_table\nchange_table \u53ea\u8981\u4e0d\u5728\u4ee3\u7801\u5757\u91cc\u4f7f\u7528change, \u6216\u8005chagne_default\u6216\u8005remove \u65b9\u6cd5. \u90fd\u662f\u53ef\u4ee5\u56de\u6eda\u64a4\u9500\u7684. remove_column \u4e5f\u662f\u53ef\u4ee5\u56de\u6eda\u7684, \u53ea\u8981\u5728\u6267\u884c\u79fb\u9664\u7684\u65f6\u5019\u544a\u8bc9 rails \u5f53\u524d\u8981\u79fb\u9664\u7684\u5b57\u6bb5\u7684\u7c7b\u578b\u5c31\u53ef\u4ee5\u56de\u6eda.\nremove_column :posts, :slug, :string, null: false, default: '', index: true\n\n\u5f53\u7136\u4f60\u5728\u4f7f\u7528\u5176\u4ed6\u65b9\u6cd5\u7684\u65f6\u5019,\u53ef\u4ee5\u901a\u8fc7reversible \u65b9\u6cd5\u548c\u5199up \u548cdown \u65b9\u6cd5\u6765\u66ff\u6362\u4f7f\u7528change \u65b9\u6cd5.\n\n\u4f7f\u7528reversible\n\n\u590d\u6742\u7684 migration \u53ef\u80fdActive Record\u5e76\u4e0d\u77e5\u9053\u5982\u4f55\u6765\u56de\u6eda\u64cd\u4f5c,\u4f46\u662f\u53ef\u4ee5\u901a\u8fc7reversible\u65b9\u6cd5 \u6765\u8868\u660e\u5f53\u4f60\u60f3\u8981 migration \u6216\u8005\u56de\u6eda\u7684\u65f6\u5019\u600e\u4e48\u529e.\nclass ExampleMigration < ActiveRecord::Migration[5.0]\n  def change\n    create_table :distributors do |t|\n      t.string :zipcode\n    end\n\n    reversible do |dir|\n      dir.up do\n        # add a CHECK constraint\n        execute <<-SQL\n          ALTER TABLE distributors\n            ADD CONSTRAINT zipchk\n              CHECK (char_length(zipcode) = 5) NO INHERIT;\n        SQL\n      end\n      dir.down do\n        execute <<-SQL\n          ALTER TABLE distributors\n            DROP CONSTRAINT zipchk\n        SQL\n      end\n    end\n\n    add_column :users, :home_page_url, :string\n    rename_column :users, :email, :email_address\n  end\nend\n\n\u901a\u8fc7\u4f7f\u7528reversible \u53ef\u4ee5\u6765\u786e\u4fdd\u6b63\u786e\u7684 SQL \u6267\u884c\u987a\u5e8f,\u6b63\u5982\u4e0a\u9762\u7684\u4f8b\u5b50\u91cc\u7684\u76ee\u7684, \u5982\u679c example \u88ab\u56de\u6eda\u4e86, \u8fd9\u4e2adown \u5757\u5c31\u4f1a\u88ab\u6267\u884c, \u7ed3\u679c\u5c31\u662f\u79fb\u9664home_page_url, \u7136\u540edrop \u6389distrubutors \u8868.\n\u5f53\u65f6\u901a\u5e38\u5462, migration \u662f\u4f1a\u505a\u4e00\u70b9\u4e0d\u53ef\u6062\u590d\u7684\u4e8b\u60c5, \u4f8b\u5982\u5f80\u5f80\u4f1a\u5220\u9664\u6389\u4e00\u4e9b\u6570\u636e\u7684. \u8fd9\u6837\u7684\u60c5\u51b5\u4e0b,\u5c06\u4f1a\u5728 down \u7684\u65b9\u6cd5\u91cc\u62a5ActiveRecord::IrreversibleMigration \u7684\u9519\u8bef.\n\n\u4f7f\u7528up/down \u65b9\u6cd5\n\u4f60\u53ef\u4ee5\u4f7f\u7528\u8001\u7684\u65b9\u5f0fup\u548cdown \u6765\u4ee3\u66ffchange \u65b9\u6cd5.\u4e5f\u5c31\u662f\u8bf4up \u65b9\u6cd5\u4f1a\u63cf\u8ff0\u5982\u4f55\u8f6c\u6362\u5f53\u524d\u7684 schema, \u8fd8\u6709down \u65b9\u6cd5\u4f1a\u5c06up \u65b9\u6cd5\u7684\u4e00\u5207\u64a4\u9500. \u6362\u53e5\u8bdd\u8bf4, \u6570\u636e\u5e93\u7684 schema \u4f1a\u5728 up \u548c down \u4e4b\u540e\u4ec0\u4e48\u90fd\u6ca1\u6709\u53d1\u751f\u4e00\u6837. \u4e3e\u4e2a\u4f8b\u5b50, \u5728 up \u65b9\u6cd5\u91cc\u521b\u5efa\u4e86\u4e00\u5f20\u8868, \u800c\u5728 down \u7684\u65b9\u6cd5\u91cc\u5c31\u8981 drop \u6389\u8fd9\u4e2a\u8868.\u5e94\u8be5\u5f88\u660e\u786e\u7684\u8868\u8fbe\u56de\u6eda\u7684\u987a\u5e8f. \u4e0b\u9762\u7684\u5199\u6cd5\u548c reversible\u7684\u5199\u6cd5\u662f\u7b49\u6548\u7684:\nclass ExampleMigration < ActiveRecord::Migration[5.0]\n  def up\n    create_table :distributors do |t|\n      t.string :zipcode\n    end\n\n    # add a CHECK constraint\n    execute <<-SQL\n      ALTER TABLE distributors\n        ADD CONSTRAINT zipchk\n        CHECK (char_length(zipcode) = 5);\n    SQL\n\n    add_column :users, :home_page_url, :string\n    rename_column :users, :email, :email_address\n  end\n\n  def down\n    rename_column :users, :email_address, :email\n    remove_column :users, :home_page_url\n\n    execute <<-SQL\n      ALTER TABLE distributors\n        DROP CONSTRAINT zipchk\n    SQL\n\n    drop_table :distributors\n  end\nend\n\n\u5982\u679c\u64cd\u4f5c\u662f\u4e0d\u53ef\u9006\u7684,\u5e94\u8be5\u62a5ActiveRecord::IrreversibleMigration\u8fd9\u4e2a\u9519\u8bef\u5f02\u5e38, \u5982\u679c\u67d0\u4eba\u5c1d\u8bd5\u56de\u6eda\u64cd\u4f5c,\u9700\u8981\u63d0\u793a\u5f02\u5e38.\n\n\u56de\u6eda\n\u901a\u8fc7\u4f7f\u7528revert \u65b9\u6cd5\u53ef\u4ee5\u8ba9 active record \u56de\u6eda\u64cd\u4f5c.\nrequire_relative '20121212123456_example_migration'\n\nclass FixupExampleMigration < ActiveRecord::Migration[5.0]\n  def change\n    revert ExampleMigration\n\n    create_table(:apples) do |t|\n      t.string :variety\n    end\n  end\nend\n\n\u8fd9\u4e2arevert \u65b9\u6cd5\u53ef\u4ee5\u901a\u8fc7\u5757\u6765\u6307\u5b9a\u5230\u5e95\u600e\u4e48\u5982\u4f55\u56de\u6eda,\u8fd9\u4e2a\u65b9\u5f0f\u53ef\u4ee5\u6765\u56de\u6eda\u7279\u5b9a\u90e8\u5206\u7684\u64cd\u4f5c,\u4f8b\u5982,\u5df2\u7ecf\u63d0\u4ea4\u4e86ExampleMigration \u7136\u540e\u5374\u60f3\u8981\u901a\u8fc7\u4f7f\u7528 active record \u7684\u6821\u9a8c\u6765\u4ee3\u66ffCHECK \u7684\u7ea6\u675f, \u6765\u8fbe\u5230\u6821\u9a8czipcode.\nclass DontUseConstraintForZipcodeValidationMigration < ActiveRecord::Migration[5.0]\n  def change\n    revert do\n      # copy-pasted code from ExampleMigration\n      reversible do |dir|\n        dir.up do\n          # add a CHECK constraint\n          execute <<-SQL\n            ALTER TABLE distributors\n              ADD CONSTRAINT zipchk\n                CHECK (char_length(zipcode) = 5);\n          SQL\n        end\n        dir.down do\n          execute <<-SQL\n            ALTER TABLE distributors\n              DROP CONSTRAINT zipchk\n          SQL\n        end\n      end\n\n      # The rest of the migration was ok\n    end\n  end\nend\n\n\n\u6267\u884c migration\n\n\u56de\u6eda\n\n\u8bbe\u7f6e db\n\n\u91cd\u7f6e db\n\n\u6267\u884c\u7279\u5b9a\u7684 migration\n\n\u901a\u8fc7RAILS_ENV \u6765\u5728\u4e0d\u540c\u7684\u73af\u5883\u91cc\u6267\u884c migration\n\n\u4fee\u6539 migration \u7684\u8f93\u51fa\u683c\u5f0f\n\n\u4fee\u6539\u73b0\u6709\u7684 migration\n\n\u5bfc\u51fa db schema\n\nschema \u6587\u4ef6\u662f\u4ec0\u4e48\n\n\u4e0d\u540c\u7684\u5bfc\u51fa\n\nschema \u5bfc\u51fa\u548c\u6570\u636e\u6e90\u63a7\u5236\n\nactive record \u7684\u4e00\u81f4\u6027\n\nmigration \u548c\u79cd\u5b50\u6570\u636e\n\n[](http://guides.rubyonrails.org/active_record_migrations.html)\n\n\u5bf9\u4e8e migration \u6765\u8bf4,\u5b83\u5c31\u662f Active record \u7f16\u5199\u7684\u4e00\u5957 DSL \u7528\u6765\u4fee\u6539\u6570\u636e\u5e93\u8868\u7684 schema. \u4e0d\u540c\u4e8e\u76f4\u63a5\u901a\u8fc7 SQL \u6765\u5b9e\u73b0, \u5b83\u80fd\u591f\u66f4\u52a0\u5bb9\u6613\u7684\u901a\u8fc7 ruby \u7684\u4ee3\u7801\u6765\u5b9e\u73b0.\n\n\u672c\u6587\u4e3b\u8981\u6709\u4e0b\u9762\u51e0\u4e2a\u65b9\u9762:\n\n- \u901a\u8fc7\u4f7f\u7528\u751f\u6210\u5668\u6765\u5b8c\u6210\u521b\u5efa\n- active record \u63d0\u4f9b\u7684\u6240\u6709\u7528\u6765\u7ef4\u62a4\u6570\u636e\u7684\u65b9\u6cd5\n- \u901a\u8fc7 rails \u7684\u5185\u7f6e task \u65b9\u6cd5\u6765\u5b8c\u6210migration\n- migration\u548c` schema.rb` \u4e4b\u95f4\u7684\u5173\u8054\n\n### migration \u7684\u6982\u89c8\n\n\n### \u521b\u5efamigration\n\n#### \u521b\u5efa\u72ec\u7acb\u7684 migration\n\nmigration\u4f5c\u4e3a\u5355\u72ec\u7684\u6587\u4ef6\u5b58\u653e\u5728` db/migration` \u6587\u4ef6\u5939\u4e0b\u9762, \u6bcf\u4e00\u4e2a\u90fd\u662f\u72ec\u7acb\u7684 migration \u7c7b. \u8fd9\u4e2a\u6587\u4ef6\u540d\u6709\u4e00\u5b9a\u7684\u89c4\u5219\u5c31\u662f`\u65f6\u95f4\u6233\u52a0\u52a8\u4f5c`, \u5982`YYYYMMDDHHMMSS_create_products.rb`, \u610f\u601d\u5f88\u660e\u4e86. \u5c31\u662f\u5728\u67d0\u4e2a\u65f6\u95f4\u70b9,\u4e0b\u5212\u7ebf\u52a0\u4e0a migration \u7684\u540d\u79f0.\u800c\u5bf9\u4e8e migration \u7684\u7c7b\u540d, \u4e5f\u5b8c\u5168\u662f\u6839\u636e\u6587\u4ef6\u540d\u7684\u79fb\u5f62\u540d\u5b57\u6765\u7684,\u53ea\u662f\u628a\u5b83\u53d8\u6210\u4e86\u9a7c\u5cf0\u547d\u540d. \u5982\u8fd9\u4e2a\u79fb\u5f62\u6587\u4ef6`20080906120000_create_products.rb` \u5b9e\u9645\u5bf9\u5e94\u5c31\u4f1a\u751f\u6210\u4e00\u4e2a`CreateProducts`\u7c7b, \u800c`20080906120001_add_details_to_products.rb` \u540c\u6837\u5c31\u662f`AddDetailsToProducts`. \u800c\u8fd9\u91cc\u6587\u4ef6\u540d\u91cc\u7684\u65f6\u95f4\u6233\u5c31\u662f\u7528\u6765\u544a\u8bc9 rails \u5982\u4f55\u6309\u65f6\u95f4\u987a\u5e8f\u6765\u5b8c\u6210\u6240\u6709\u7684\u79fb\u5f62. \u6240\u4ee5\u6709\u65f6\u5019\u4f60\u56fe\u65b9\u4fbf\u76f4\u63a5\u62f7\u8d1d\u4e86\u4e00\u4e2a\u79fb\u5f62\u6587\u4ef6, \u8fd9\u4e2a\u65f6\u5019\u5c31\u8981\u6ce8\u610f\u65f6\u95f4\u6233\u4e86, \u5982\u679c\u4e8c\u8005\u76f8\u4e92\u6ca1\u6709\u4f9d\u8d56\u53ef\u80fd\u4e5f\u4e0d\u4f1a\u51fa\u73b0\u95ee\u9898.\n\n\u5f53\u7136\u8fd9\u91cc\u5982\u679c\u6211\u4eec\u6bcf\u6b21\u624b\u52a8\u53bb\u62ff\u4e00\u4e2a\u65f6\u95f4\u6233\u7136\u540e\u521b\u5efa\u4e00\u4e2a\u79fb\u5f62\u6587\u4ef6\u5c31\u65e0\u8da3\u4e86, rails \u5f53\u7136\u4f1a\u63d0\u4f9b\u65b9\u6cd5\u7684\u751f\u6210\u5668\u6765\u5b8c\u6210\u8fd9\u4e2a\u52a8\u4f5c. \u5982\u4e0b\u9762\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u79fb\u5f62:\n\n```\n\n$ bin/rails generate migration AddPartNumberToProducts\n```\n\u5c06\u4f1a\u751f\u6210\u4e0b\u9762\u8fd9\u6837\u4e00\u4e2a\u6587\u4ef6:\n\n```\nclass AddPartNumberToProducts < ActiveRecord::Migration[5.0]\n  def change\n  end\nend\n\n```\n\n\u8fd9\u91cc, \u5982\u679c\u5728\u521b\u5efa\u8fd9\u4e2a\u79fb\u5f62\u6587\u4ef6\u7684\u65f6\u5019, \u6587\u4ef6\u540d\u5982\u679c\u9075\u5faa\u4e86\u5982` AddXXXToYYY` \u6216\u8005` RemoveXXXFromYYY`, active record \u5c31\u4f1a\u5f88\u8d34\u5fc3\u7684\u76f4\u63a5\u5728\u79fb\u5f62\u7c7b\u91cc\u6dfb\u52a0\u5bf9\u5e94\u76f8\u4f3c\u7684\u65b9\u6cd5.\n\n\n```\n$ bin/rails generate migration AddPartNumberToProducts part_number:string\n```\n\n```\nclass AddPartNumberToProducts < ActiveRecord::Migration[5.0]\n  def change\n    add_column :products, :part_number, :string\n  end\nend\n```\n\n\u6211\u4eec\u8fd8\u53ef\u4ee5\u76f4\u63a5\u7ed9\u67d0\u4e2a\u5b57\u6bb5\u6dfb\u52a0\u7d22\u5f15\n\n```\n$ bin/rails generate migration AddPartNumberToProducts part_number:string:index\nwill generate\n\nclass AddPartNumberToProducts < ActiveRecord::Migration[5.0]\n  def change\n    add_column :products, :part_number, :string\n    add_index :products, :part_number\n  end\nend\n```\n\n\u5f53\u7136\u79fb\u9664\u67d0\u4e2a\u5b57\u6bb5\u4e5f\u4e0d\u662f\u95ee\u9898\n\n```\n$ bin/rails generate migration RemovePartNumberFromProducts part_number:string\ngenerates\n\nclass RemovePartNumberFromProducts < ActiveRecord::Migration[5.0]\n  def change\n    remove_column :products, :part_number, :string\n  end\nend\n```\n\n\u5f53\u7136\u4e00\u6b21\u6dfb\u52a0\u591a\u4e2a\u4e5f\u6ca1\u6709\u95ee\u9898:\n\n```\n$ bin/rails generate migration AddDetailsToProducts part_number:string price:decimal\ngenerates\n\nclass AddDetailsToProducts < ActiveRecord::Migration[5.0]\n  def change\n    add_column :products, :part_number, :string\n    add_column :products, :price, :decimal\n  end\nend\n```\n\u5f53\u7136\u4f60\u53ef\u4ee5\u5199\u6210\u53ea\u662f\u521b\u5efa\u67d0\u4e2a\u5bf9\u8c61` CreateXXX`, \u7136\u540e\u8ddf\u591a\u4e2a\u5b57\u6bb5\u7684\u5f62\u5f0f,  \u5b8c\u5168\u6ca1\u6709\u95ee\u9898(\u6211\u8bf4, \u8fd9\u6837\u597d\u5417 \u6709\u5fc5\u8981\u5417?)\n\n\n```\n\n$ bin/rails generate migration CreateProducts name:string part_number:string\ngenerates\n\nclass CreateProducts < ActiveRecord::Migration[5.0]\n  def change\n    create_table :products do |t|\n      t.string :name\n      t.string :part_number\n    end\n  end\nend\n\n```\n\n\u5176\u5b9e, \u4e0a\u9762\u5404\u79cd\u5404\u6837\u7684\u73a9\u6cd5\u4e5f\u662f\u4e00\u4e2a\u5f00\u59cb, \u5f88\u591a\u65f6\u5019\u4f60\u5927\u53ef\u5b8c\u5168\u76f4\u63a5\u53bb\u7f16\u8f91` db/migrate` \u76ee\u5f55\u4e0b\u7684\u5982`YYYYMMDDHHMMSS_add_details_to_products.rb`\u6587\u4ef6\u6765\u5f97\u5feb.\n\u8bf4\u5230\u8fd9\u91cc` migrate` \u540c\u6837\u652f\u6301\u5173\u8054\u805a\u5408\u5173\u7cfb\u7684\u521b\u5efa.( belongs_to)\n\n```\n\n$ bin/rails generate migration AddUserRefToProducts user:references\ngenerates\n\nclass AddUserRefToProducts < ActiveRecord::Migration[5.0]\n  def change\n    add_reference :products, :user, index: true, foreign_key: true\n  end\nend\n```\n\u8fd9\u4e2a migrate \u5c06\u4f1a\u521b\u5efa\u4e00\u4e2a` user_id` \u7684\u5916\u952e,\u987a\u4fbf\u7ed9\u5b83\u7d22\u5f15. \u5173\u4e8e` add_reference` \u8fd8\u6709\u5f88\u591a\u7684\u9009\u9879\u53ef\u4ee5\u770b\u770b API \u6587\u6863.\n\u5f53\u7136\u5982\u679c\u5728 migration \u7684\u6587\u4ef6\u540d\u6dfb\u52a0\u4e86` JoinTable `\u7684\u8bdd, \u53ef\u4ee5\u76f4\u63a5\u521b\u5efa\u751f\u6210` jointable` \u7684\u547d\u4ee4.\n\n```\n$ bin/rails g migration CreateJoinTableCustomerProduct customer product\nwill produce the following migration:\n\nclass CreateJoinTableCustomerProduct < ActiveRecord::Migration[5.0]\n  def change\n    create_join_table :customers, :products do |t|\n      # t.index [:customer_id, :product_id]\n      # t.index [:product_id, :customer_id]\n    end\n  end\nend\n```\n\n\n#### \u5bf9\u8c61\u751f\u6210\u5668\n\n\u5bf9\u4e8e`\u5bf9\u8c61\u751f\u6210\u5668`\u6216\u8005`\u9aa8\u67b6\u751f\u6210\u5668`\u4ed6\u4eec\u6765\u8bf4, \u5728\u4f7f\u7528\u4ed6\u4eec\u7684\u65f6\u5019\u540c\u65f6\u5df2\u7ecf\u4e3a\u4f60\u751f\u6210\u4e86\u5bf9\u8c61\u7684 migration, \u8fd9\u4e2a migration \u5df2\u7ecf\u5305\u542b\u4e86\u521b\u5efa\u76f8\u5173\u8868, \u5982\u679c\u4f60\u544a\u8bc9 Rails \u6dfb\u52a0\u4ec0\u4e48\u5b57\u6bb5\u4e0a\u9762\u7684\u90fd\u4f1a\u4e3a\u4e86\u4e00\u6c14\u641e\u5b9a. \u770b\u770b\u4e0b\u9762\u7684\u4f8b\u5b50:\n\n```\n\n$ bin/rails generate model Product name:string description:text\n```\n\n\u5bf9\u4e8e\u4e0a\u9762\u7684\u5bf9\u8c61\u751f\u6210\u5668\u7684\u6267\u884c\u7ed3\u679c\u5c31\u662f\u4f1a\u751f\u6210\u4e0b\u9762\u7684 migration:\n\n```\nclass CreateProducts < ActiveRecord::Migration[5.0]\n  def change\n    create_table :products do |t|\n      t.string :name\n      t.text :description\n \n      t.timestamps\n    end\n  end\nend\n```\n>\u8fd9\u91cc\u4f60\u53ef\u4ee5\u6dfb\u52a0\u4efb\u610f\u591a\u7684\u5b57\u6bb5\u58f0\u660e\n\n#### \u4f7f\u7528\u7c7b\u578b\u5b9a\u4e49\n\n\u6211\u4eec\u53ef\u4ee5\u5728\u4f7f\u7528\u751f\u6210\u5668\u7684\u65f6\u5019\u76f4\u63a5\u7ed9\u5b57\u6bb5\u5b9a\u4e49\u7c7b\u578b\u5b9a\u4e49\u58f0\u660e, \u901a\u8fc7\u4f7f\u7528\u5927\u62ec\u53f7\u7684\u65b9\u5f0f\u7ed9\u5b83\u4e00\u4e2a\u7c7b\u578b:\n\n```\n$ bin/rails generate migration AddDetailsToProducts 'price:decimal{5,2}' supplier:references{polymorphic}\n```\n\u5c06\u4f1a\u751f\u6210\u8fd9\u6837\u7684\u5b9a\u4e49:\n\n```\nclass AddDetailsToProducts < ActiveRecord::Migration[5.0]\n  def change\n    add_column :products, :price, :decimal, precision: 5, scale: 2\n    add_reference :products, :supplier, polymorphic: true, index: true\n  end\nend\n```\n\n\u6709\u5f88\u591a\u73a9\u6cd5\u4e86, \u770b\u770b API \u6587\u6863\u597d\u4e86.\n\n### \u600e\u4e48\u5199\u4e00\u4e2amigration\n\n\u5f53\u6211\u4eec\u901a\u8fc7\u751f\u6210\u5668\u751f\u6210\u4e86 migration \u4e4b\u540e,\u624d\u521a\u5f00\u59cb.\n\n#### \u521b\u5efa\u8868\n\n\u901a\u8fc7` create_table` \u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u8868,\u7b97\u662f\u6700\u57fa\u672c\u7684\u51fd\u6570\u4e86. \u4f46\u662f\u901a\u5e38\u6211\u4eec\u901a\u8fc7\u5927\u90e8\u5206\u7684\u751f\u6210\u5668\u5c31\u53ef\u4ee5\u5b8c\u6210\u8fd9\u4e2a\u6b65\u9aa4, \u770b\u4e0a\u53bb\u5c31\u50cf\u4e0b\u9762\u8fd9\u6837\u7684:\n\n```\n\ncreate_table :products do |t|\n  t.string :name\nend\n```\n\u8fd9\u4e2a\u5c06\u4f1a\u521b\u5efa\u4e00\u4e2a` products` \u7684\u8868, \u7136\u540e\u4e00\u4e2a`name`\u7684\u5b57\u6bb5.(\u540c\u65f6\u8fd8\u6709\u4e00\u4e2a` id` \u7684\u5b57\u6bb5). \u9ed8\u8ba4\u5f97` create_table` \u547d\u4ee4\u5c06\u4f1a\u521b\u5efa\u4e00\u4e2a` id` \u7684\u4e3b\u952e. \u4f60\u53ef\u4ee5\u901a\u8fc7`:primary_key` \u7684\u9009\u9879\u6765\u4fee\u6539\u8fd9\u4e2a\u9ed8\u8ba4\u503c, \u4f46\u662f\u8fd9\u4e2a\u60c5\u51b5\u4e0b\u5c31\u9700\u8981\u4fee\u6539\u5bf9\u5e94\u7684 model. \u5f53\u7136\u4f60\u53ef\u4ee5\u4e0d\u8981\u8fd9\u4e2a\u4e3b\u952e, \u53ea\u8981\u7ed9` id:false` \u7684\u53c2\u6570\u5c31 ok. \u5982\u679c\u4f60\u9700\u8981\u8bbe\u7f6e\u6570\u636e\u5e93\u7279\u5b9a\u7684\u53c2\u6570\u7684\u65f6\u5019\u76f4\u63a5\u5728` option`\u7684\u53c2\u6570\u91cc\u6307\u5b9a\u5c31\u53ef\u4ee5. \u5982\u4e0b\u9762\u7684\u4f8b\u5b50:\n\n```\n\ncreate_table :products, options: \"ENGINE=BLACKHOLE\" do |t|\n  t.string :name, null: false\nend\n```\n\n\u8fd9\u4e2a\u5b57\u7b26\u4e32\u4f1a\u8ffd\u52a0\u5230\u521b\u5efa\u6570\u636e\u5e93\u8868\u7684` SQL` \u8bed\u53e5\u540e,(\u5728\u4f7f\u7528` MySQL`\u6216\u8005` MariaDB`\u7684\u65f6\u5019, \u9ed8\u8ba4\u7684\u5f15\u64ce\u662f` InnoDB`)\n\n> \u540c\u65f6\u4f60\u4e5f\u5b8c\u5168\u53ef\u4ee5\u901a\u8fc7`: comment` \u7684\u9009\u9879\u7ed9\u6570\u636e\u5e93\u8868\u6dfb\u52a0\u4efb\u4f55\u7684\u6ce8\u91ca.\u8fd9\u4e2a\u52a8\u4f5c\u4e5f\u5c31\u662f\u901a\u8fc7\u8ffd\u52a0\u9009\u9879\u6ce8\u91ca\u5230\u5b9e\u9645\u7684 SQL \u6587\u5b9e\u73b0.\n\n#### \u521b\u5efa Join \u8868\n\nmigration \u901a\u8fc7` create_join_table` \u6765\u521b\u5efa` HABTM` \u7684\u5173\u8054\u8868, \u901a\u5e38\u662f\u8fd9\u6837\u7684:\n\n```\ncreate_Join_table :products, :categories\n```\n\u8fd9\u4e2a\u5c06\u4f1a\u521b\u5efa\u4e00\u4e2a` categories_products` \u8868, \u6709\u4e24\u4e2a\u5b57\u6bb5` category_id` \u8fd8\u6709` product_id`, \u8fd9\u4e9b\u5b57\u6bb5\u90fd\u88ab\u8bbe\u7f6e\u7684`: null` \u7684\u9009\u9879,\u9ed8\u8ba4\u4e3a` false`.\n\n```\n\ncreate_join_table :products, :categories, column_options: { null: true }\n```\n\u9ed8\u8ba4\u6700\u540e\u8fd9\u4e2a\u5173\u8054\u8868\u7684\u540d\u5b57\u5c06\u662f\u6765\u81ea\u4e8e\u521b\u5efa migration \u7684\u65f6\u5019\u7ed9\u76842\u4e2a\u8868\u660e\u901a\u8fc7\u5b57\u6bcd\u6392\u5e8f\u5f97\u5230\u7684. \u540c\u65f6\u53ef\u4ee5\u901a\u8fc7`: table_name` \u7684\u53c2\u6570\u6765\u6307\u5b9a\u8868\u540d.\n\n```\n\ncreate_join_table :products, :categories, table_name: :categorization\n```\n\n\u5b83\u5c06\u4f1a\u521b\u5efa\u4e00\u4e2a`categorization`\u7684\u8868.\n\n`create_join_table` \u8fd8\u53ef\u4ee5\u63a5\u53d7\u4ee3\u7801\u5757,\u8fd9\u6837\u5c31\u53ef\u4ee5\u6dfb\u52a0\u4efb\u610f\u7684\u8bbe\u7f6e.\u6216\u8005\u989d\u5916\u7684\u5b57\u6bb5.\n\n```\ncreate_join_table :products, :categories do |t|\n  t.index :product_id\n  t.index :category_id\nend\n\n```\n#### \u4fee\u6539\u8868\n\n`create_table` \u7684\u8868\u5144\u5c31\u662f` change_table` \u4e86. \u7528\u6765\u4fee\u6539\u73b0\u6709\u7684\u8868\u7ed3\u6784,\u901a\u5e38\u5b83\u548c\u521b\u5efa\u8868\u7684\u6784\u6210\u4e00\u6837.\u4f46\u662f\u4ee3\u7801\u5757\u91cc` yeild` \u51fa\u6765\u7684\u5bf9\u8c61\u6709\u66f4\u591a\u795e\u5947\u7684\u7528\u6cd5.\n\n```\n\nchange_table :products do |t|\n  t.remove :description, :name\n  t.string :part_number\n  t.index :part_number\n  t.rename :upccode, :upc_code\nend\n```\n\n\u4e0a\u9762\u7684\u5b9a\u4e49\u662f\u5206\u522b\u79fb\u9664\u4e86`description` \u548c` name`\u5b57\u6bb5,\u6dfb\u52a0\u4e86` part_time` \u7684\u5b57\u6bb5\u5e76\u4e14\u7ed9\u5b83\u6dfb\u52a0\u4e86\u7d22\u5f15, \u8fd8\u6709\u5c06` upccode`\u91cd\u547d\u540d\u4e3a` upc_code`.\n\n#### \u4fee\u6539\u5b57\u6bb5\n\n\u8fd8\u6709\u548c` remove_column`\u4e0e` add_column` \u547d\u4ee4\u76f8\u4f3c\u7684` change_column`,\n\n```\n\nchange_column :products, :part_number, :text\n```\n\n\u8fd9\u4e2a\u52a8\u4f5c\u5c31\u662f\u5c06` products` \u8868\u91cc\u7684` part_number` \u8bbe\u7f6e\u4e3a`: text` \u7c7b\u578b, *\u6ce8\u610f* \u8fd9\u91cc\u7684\u64cd\u4f5c\u662f\u4e0d\u53ef\u9006\u7684.\n\u53e6\u5916\u8fd8\u6709` change_column_null` \u548c` change_column_default` \u65b9\u6cd5, \u4ed6\u4eec\u7528\u6765\u4fee\u6539\u7279\u5b9a\u5b57\u6bb5\u7684\u7ea6\u675f\u548c\u9ed8\u8ba4\u503c.\n\n```\n\nchange_column_null :products, :name, false\nchange_column_default :products, :approved, from: true, to: false\n\n```\n\n\u4e0a\u9762\u7684\u52a8\u4f5c\u5c31\u662f\u5c06`: name` \u5b57\u6bb5\u6dfb\u52a0\u4e0d\u53ef\u7a7a\u7684\u7ea6\u675f,\u7136\u540e\u7ed9` approved` \u7684\u9ed8\u8ba4\u503c\u662f` false`.\n\n> \u6ce8\u610f\u4e0a\u9762\u8fd9\u4e2a\u52a8\u4f5c\u53ef\u4ee5\u901a\u8fc7` change_column` \u6765\u5b8c\u6210, \u4f46\u662f\u90a3\u6837\u5c31\u53d8\u6210\u4e86\u4e0d\u53ef\u9006\u7684\u64cd\u4f5c\n\n#### \u5b57\u6bb5\u4fee\u9970\u7b26\n\n\u5b57\u6bb5\u7684\u7c7b\u578b\u5b9a\u4e49\u53ef\u4ee5\u5728\u521b\u5efa\u6216\u8005\u4fee\u6539\u7684\u65f6\u5019\u8bbe\u7f6e.\n\n- `limit` \u53ef\u4ee5\u7ed9`string/text/binary/integer`\u7c7b\u578b\u7684\u5b57\u6bb5\u8bbe\u7f6e\u6700\u5927\u503c.\n- `precision` \u5b9a\u4e49\u4e86` decimal` \u5b57\u6bb5\u7684` precision`, \u4e5f\u5c31\u662f\u591a\u5927.\n- `scale`,\u5b9a\u4e49\u4e86 decimal \u5b57\u6bb5\u7684\u7cbe\u5ea6, \u4e5f\u5c31\u662f\u5c0f\u6570\u70b9\u540e\u9762\u7684\u4f4d\u6570.\n- `polymorphic` \u7ed9\u5b57\u6bb5\u6dfb\u52a0` belong_to` \u7684\u5173\u8054.\n- `null`, \u5b57\u6bb5\u662f\u5426\u53ef\u4e3a\u7a7a\n- `default` \u7ed9\u5b57\u6bb5\u6dfb\u52a0\u9ed8\u8ba4\u503c, **\u6ce8\u610f** \u5982\u679c\u4f60\u4f7f\u7528\u52a8\u6001\u503c(\u5982\u65e5\u671f)\u9ed8\u8ba4\u503c\u5c06\u4f1a\u5728\u7b2c\u4e00\u6b21\u4f7f\u7528\u7684\u65f6\u5019\u6307\u5b9a.\n- `index` \u5c31\u662f\u7ed9\u67d0\u4e2a\u5b57\u6bb5\u6dfb\u52a0\u7d22\u5f15\n- `comment` \u5c31\u662f\u7ed9\u5b57\u6bb5\u6dfb\u52a0\u6ce8\u91ca\n\n\n\u6709\u4e9b\u7279\u5b9a\u7684\u9002\u914d\u5668\u53ef\u80fd\u4f1a\u9488\u5bf9\u7279\u5b9a\u7684\u6570\u636e\u5e93\u6709\u7279\u5b9a\u7684\u9009\u9879\u53ef\u4ee5\u4f7f\u7528. \u67e5\u9605 API.\n\n\n#### \u5916\u952e\n\n\u867d\u7136\u4e0d\u662f\u8981\u6c42\u7684, \u4f46\u662f\u4f60\u53ef\u80fd\u4f1a\u901a\u8fc7\u6dfb\u52a0\u5916\u952e\u7ea6\u675f\u6765 **\u786e\u4fdd\u5f15\u7528\u4e00\u81f4\u6027**.\n\n```\n\nadd_foreign_key :articles, :authors\n```\n\n\u8fd9\u4e2a\u52a8\u4f5c\u7684\u7ed3\u679c\u5c31\u662f\u4f1a\u7ed9` articles` \u8fd9\u4e2a\u8868\u6dfb\u52a0\u4e00\u4e2a\u5916\u952e` author_id`, \u5b83\u5c31\u662f\u6765\u81ea` author` \u8868\u7684\u4e3b\u952e` id`, \u5982\u679c\u4ec5\u662f\u901a\u8fc7\u4e0a\u9762\u7684\u547d\u4ee4\u800c\u4e0d\u80fd\u591f\u5f97\u5230\u5916\u952e\u540d,\u53ef\u4ee5\u901a\u8fc7`:column` \u548c`: primary_key` \u9009\u9879\u6765\u6307\u5b9a.\n\nRails \u901a\u5e38\u4f1a\u901a\u8fc7` from_table` \u548c` column` \u4e24\u4e2a\u53d8\u91cf\u6765\u7ed9\u6bcf\u4e00\u4e2a\u5916\u952e\u751f\u6210\u4e00\u4e2a\u4ee5` fk_rails_`\u5f00\u5934\u768410\u5b57\u7b26\u540d\u5b57.\u540c\u65f6\u4e5f\u53ef\u4ee5\u901a\u8fc7`: name` \u9009\u9879\u6765\u6307\u5b9a\u4e00\u4e2a\u4e0d\u540c\u7684\u540d\u5b57.\n\n>Active record\u53ea\u652f\u6301\u5355\u5916\u952e,[ execute and structure.sql are required to use composite foreign keys. See Schema Dumping and You.](http://guides.rubyonrails.org/active_record_migrations.html#schema-dumping-and-you)\n\n\n\u79fb\u9664\u5916\u952e\u4e5f\u662f\u5f88\u8f7b\u677e\u7684:\n\n```\n# let Active Record figure out the column name\nremove_foreign_key :accounts, :branches\n \n# remove foreign key for a specific column\nremove_foreign_key :accounts, column: :owner_id\n \n# remove foreign key by name\nremove_foreign_key :accounts, name: :special_fk_name\n```\n\n#### \u5f53\u5e2e\u52a9\u65b9\u6cd5\u4e0d\u591f\u7528\u7684\u60c5\u51b5\n\n\u5982\u679c\u53d1\u73b0` active record` \u63d0\u4f9b\u7684\u5e2e\u52a9\u65b9\u6cd5\u4e0d\u591f\u7528\u7684\u65f6\u5019\u53ef\u4ee5\u76f4\u63a5\u6267\u884c` SQL` \u6765\u5b9e\u73b0.\n\n```\nProduct.connection.execute(\"UPDATE products SET price = 'free' WHERE 1=1\")\n```\n\n\u66f4\u591a\u8be6\u60c5\u548c\u5355\u72ec\u7684\u65b9\u6cd5, \u53ef\u4ee5\u901a\u8fc7\u786e\u8ba4 API \u6587\u6863\u6765\u5b66\u4e60\u4e86\u89e3, [\u8fd9\u91cc\u63d0\u4f9b\u4e86 change up \u548c down \u7684\u65b9\u6cd5](http://api.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html), [\u521b\u5efa\u8868\u7684\u66f4\u591a](http://api.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/TableDefinition.html), [\u8fd8\u6709\u4fee\u6539\u8868](http://api.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/Table.html).\n\n#### \u4fee\u6539\u8868\n\n\u4f7f\u7528 migration \u7684\u65f6\u5019,\u66f4\u591a\u7684\u5c31\u662f\u901a\u8fc7` change` \u65b9\u6cd5. \u8fd9\u4e2a\u4f1a\u5bf9\u4e8e\u5927\u591a\u6570 case \u7ba1\u7528. \u56e0\u4e3a active record \u90fd\u53ef\u4ee5\u8f7b\u677e hold \u4f4f,\u5f53\u524d\u652f\u6301\u8fd9\u4e9b\u65b9\u6cd5:\n\nadd_column\nadd_foreign_key\nadd_index\nadd_reference\nadd_timestamps\nchange_column_default (must supply a :from and :to option)\nchange_column_null\ncreate_join_table\ncreate_table\ndisable_extension\ndrop_join_table\ndrop_table (must supply a block)\nenable_extension\nremove_column (must supply a type)\nremove_foreign_key (must supply a second table)\nremove_index\nremove_reference\nremove_timestamps\nrename_column\nrename_index\nrename_table\n\n`change_table` \u53ea\u8981\u4e0d\u5728\u4ee3\u7801\u5757\u91cc\u4f7f\u7528` change`, \u6216\u8005` chagne_default`\u6216\u8005` remove` \u65b9\u6cd5. \u90fd\u662f\u53ef\u4ee5\u56de\u6eda\u64a4\u9500\u7684. `remove_column` \u4e5f\u662f\u53ef\u4ee5\u56de\u6eda\u7684, \u53ea\u8981\u5728\u6267\u884c\u79fb\u9664\u7684\u65f6\u5019\u544a\u8bc9 rails \u5f53\u524d\u8981\u79fb\u9664\u7684\u5b57\u6bb5\u7684\u7c7b\u578b\u5c31\u53ef\u4ee5\u56de\u6eda.\n\n```\nremove_column :posts, :slug, :string, null: false, default: '', index: true\n```\n\n\u5f53\u7136\u4f60\u5728\u4f7f\u7528\u5176\u4ed6\u65b9\u6cd5\u7684\u65f6\u5019,\u53ef\u4ee5\u901a\u8fc7` reversible` \u65b9\u6cd5\u548c\u5199` up` \u548c` down` \u65b9\u6cd5\u6765\u66ff\u6362\u4f7f\u7528` change` \u65b9\u6cd5.\n\n#### \u4f7f\u7528` reversible`\n\n\u590d\u6742\u7684 migration \u53ef\u80fd`Active Record`\u5e76\u4e0d\u77e5\u9053\u5982\u4f55\u6765\u56de\u6eda\u64cd\u4f5c,\u4f46\u662f\u53ef\u4ee5\u901a\u8fc7` reversible`\u65b9\u6cd5 \u6765\u8868\u660e\u5f53\u4f60\u60f3\u8981 migration \u6216\u8005\u56de\u6eda\u7684\u65f6\u5019\u600e\u4e48\u529e.\n\n```\nclass ExampleMigration < ActiveRecord::Migration[5.0]\n  def change\n    create_table :distributors do |t|\n      t.string :zipcode\n    end\n \n    reversible do |dir|\n      dir.up do\n        # add a CHECK constraint\n        execute <<-SQL\n          ALTER TABLE distributors\n            ADD CONSTRAINT zipchk\n              CHECK (char_length(zipcode) = 5) NO INHERIT;\n        SQL\n      end\n      dir.down do\n        execute <<-SQL\n          ALTER TABLE distributors\n            DROP CONSTRAINT zipchk\n        SQL\n      end\n    end\n \n    add_column :users, :home_page_url, :string\n    rename_column :users, :email, :email_address\n  end\nend\n```\n\n\u901a\u8fc7\u4f7f\u7528` reversible` \u53ef\u4ee5\u6765\u786e\u4fdd\u6b63\u786e\u7684 SQL \u6267\u884c\u987a\u5e8f,\u6b63\u5982\u4e0a\u9762\u7684\u4f8b\u5b50\u91cc\u7684\u76ee\u7684, \u5982\u679c example \u88ab\u56de\u6eda\u4e86, \u8fd9\u4e2a` down` \u5757\u5c31\u4f1a\u88ab\u6267\u884c, \u7ed3\u679c\u5c31\u662f\u79fb\u9664` home_page_url`, \u7136\u540edrop \u6389` distrubutors` \u8868.\n\n\u5f53\u65f6\u901a\u5e38\u5462, migration \u662f\u4f1a\u505a\u4e00\u70b9\u4e0d\u53ef\u6062\u590d\u7684\u4e8b\u60c5, \u4f8b\u5982\u5f80\u5f80\u4f1a\u5220\u9664\u6389\u4e00\u4e9b\u6570\u636e\u7684. \u8fd9\u6837\u7684\u60c5\u51b5\u4e0b,\u5c06\u4f1a\u5728 down \u7684\u65b9\u6cd5\u91cc\u62a5` ActiveRecord::IrreversibleMigration` \u7684\u9519\u8bef.\n\n#### \u4f7f\u7528` up/down` \u65b9\u6cd5\n\n\u4f60\u53ef\u4ee5\u4f7f\u7528\u8001\u7684\u65b9\u5f0f`up`\u548c` down` \u6765\u4ee3\u66ff` change` \u65b9\u6cd5.\u4e5f\u5c31\u662f\u8bf4`up` \u65b9\u6cd5\u4f1a\u63cf\u8ff0\u5982\u4f55\u8f6c\u6362\u5f53\u524d\u7684 schema, \u8fd8\u6709` down` \u65b9\u6cd5\u4f1a\u5c06` up` \u65b9\u6cd5\u7684\u4e00\u5207\u64a4\u9500. \u6362\u53e5\u8bdd\u8bf4, \u6570\u636e\u5e93\u7684 schema \u4f1a\u5728 up \u548c down \u4e4b\u540e\u4ec0\u4e48\u90fd\u6ca1\u6709\u53d1\u751f\u4e00\u6837. \u4e3e\u4e2a\u4f8b\u5b50, \u5728 up \u65b9\u6cd5\u91cc\u521b\u5efa\u4e86\u4e00\u5f20\u8868, \u800c\u5728 down \u7684\u65b9\u6cd5\u91cc\u5c31\u8981 drop \u6389\u8fd9\u4e2a\u8868.\u5e94\u8be5\u5f88\u660e\u786e\u7684\u8868\u8fbe\u56de\u6eda\u7684\u987a\u5e8f. \u4e0b\u9762\u7684\u5199\u6cd5\u548c `reversible`\u7684\u5199\u6cd5\u662f\u7b49\u6548\u7684:\n\n```\nclass ExampleMigration < ActiveRecord::Migration[5.0]\n  def up\n    create_table :distributors do |t|\n      t.string :zipcode\n    end\n \n    # add a CHECK constraint\n    execute <<-SQL\n      ALTER TABLE distributors\n        ADD CONSTRAINT zipchk\n        CHECK (char_length(zipcode) = 5);\n    SQL\n \n    add_column :users, :home_page_url, :string\n    rename_column :users, :email, :email_address\n  end\n \n  def down\n    rename_column :users, :email_address, :email\n    remove_column :users, :home_page_url\n \n    execute <<-SQL\n      ALTER TABLE distributors\n        DROP CONSTRAINT zipchk\n    SQL\n \n    drop_table :distributors\n  end\nend\n```\n\u5982\u679c\u64cd\u4f5c\u662f\u4e0d\u53ef\u9006\u7684,\u5e94\u8be5\u62a5` ActiveRecord::IrreversibleMigration`\u8fd9\u4e2a\u9519\u8bef\u5f02\u5e38, \u5982\u679c\u67d0\u4eba\u5c1d\u8bd5\u56de\u6eda\u64cd\u4f5c,\u9700\u8981\u63d0\u793a\u5f02\u5e38.\n\n#### \u56de\u6eda\n\n\u901a\u8fc7\u4f7f\u7528` revert` \u65b9\u6cd5\u53ef\u4ee5\u8ba9 active record \u56de\u6eda\u64cd\u4f5c.\n\n```\nrequire_relative '20121212123456_example_migration'\n \nclass FixupExampleMigration < ActiveRecord::Migration[5.0]\n  def change\n    revert ExampleMigration\n \n    create_table(:apples) do |t|\n      t.string :variety\n    end\n  end\nend\n```\n\n\u8fd9\u4e2a` revert` \u65b9\u6cd5\u53ef\u4ee5\u901a\u8fc7\u5757\u6765\u6307\u5b9a\u5230\u5e95\u600e\u4e48\u5982\u4f55\u56de\u6eda,\u8fd9\u4e2a\u65b9\u5f0f\u53ef\u4ee5\u6765\u56de\u6eda\u7279\u5b9a\u90e8\u5206\u7684\u64cd\u4f5c,\u4f8b\u5982,\u5df2\u7ecf\u63d0\u4ea4\u4e86` ExampleMigration` \u7136\u540e\u5374\u60f3\u8981\u901a\u8fc7\u4f7f\u7528 active record \u7684\u6821\u9a8c\u6765\u4ee3\u66ff` CHECK` \u7684\u7ea6\u675f, \u6765\u8fbe\u5230\u6821\u9a8c` zipcode`.\n\n```\nclass DontUseConstraintForZipcodeValidationMigration < ActiveRecord::Migration[5.0]\n  def change\n    revert do\n      # copy-pasted code from ExampleMigration\n      reversible do |dir|\n        dir.up do\n          # add a CHECK constraint\n          execute <<-SQL\n            ALTER TABLE distributors\n              ADD CONSTRAINT zipchk\n                CHECK (char_length(zipcode) = 5);\n          SQL\n        end\n        dir.down do\n          execute <<-SQL\n            ALTER TABLE distributors\n              DROP CONSTRAINT zipchk\n          SQL\n        end\n      end\n \n      # The rest of the migration was ok\n    end\n  end\nend\n```\n\n### \u6267\u884c migration\n\n#### \u56de\u6eda\n#### \u8bbe\u7f6e db\n#### \u91cd\u7f6e db\n#### \u6267\u884c\u7279\u5b9a\u7684 migration\n#### \u901a\u8fc7` RAILS_ENV` \u6765\u5728\u4e0d\u540c\u7684\u73af\u5883\u91cc\u6267\u884c migration\n#### \u4fee\u6539 migration \u7684\u8f93\u51fa\u683c\u5f0f\n\n### \u4fee\u6539\u73b0\u6709\u7684 migration\n\n### \u5bfc\u51fa db schema\n#### schema \u6587\u4ef6\u662f\u4ec0\u4e48\n#### \u4e0d\u540c\u7684\u5bfc\u51fa\n#### schema \u5bfc\u51fa\u548c\u6570\u636e\u6e90\u63a7\u5236\n\n### active record \u7684\u4e00\u81f4\u6027\n\n### migration \u548c\u79cd\u5b50\u6570\u636e\n"}