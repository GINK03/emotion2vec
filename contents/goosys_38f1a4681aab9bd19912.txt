{"context": " More than 1 year has passed since last update.FuelPHP Advent Calendar 2015 \u306e19\u65e5\u76ee\u3092\u62c5\u5f53\u3055\u305b\u3066\u3044\u305f\u3060\u304d\u307e\u3059\u3002\n\u3088\u308d\u3057\u304f\u304a\u9858\u3044\u3057\u307e\u3059\u3002\n\u4f55\u3092\u66f8\u3053\u3046\u304b\u8ff7\u3044\u307e\u3057\u305f\u304c\u3001Wordpress\u3068\u304b\u3067\u3088\u304f\u3042\u308b\u30ab\u30b9\u30bf\u30e0\u30d5\u30a3\u30fc\u30eb\u30c9\u3063\u307d\u3044\u3082\u306e\u3092\u5b9f\u88c5\u3059\u308b\u65b9\u6cd5\u3092\u66f8\u3044\u3066\u307f\u3088\u3046\u304b\u3068\u601d\u3044\u307e\u3059\u3002\n\nEAV\u30b3\u30f3\u30c6\u30ca\u3068\u306f\nEAV\u30b3\u30f3\u30c6\u30ca / FuelPHP 1.7 Documentation\n\n\u300c\u30a8\u30f3\u30c6\u30a3\u30c6\u30a3-\u30a2\u30c8\u30ea\u30d3\u30e5\u30fc\u30c8-\u30d0\u30ea\u30e5\u30fc (Entity-attribute-value) \u30e2\u30c7\u30eb (EAV) \u306f\u3001\u6f5c\u5728\u7684\u306b\u306f\u5927\u5909\u306b\u591a\u304f\u306e\u5c5e\u6027(\u30d7\u30ed\u30d1\u30c6\u30a3\u3084\u30d1\u30e9\u30e1\u30fc\u30bf)\u3092\u8a18\u8ff0\u3067\u304d\u308b\u3053\u3068\u304c\u5fc5\u8981\u3060\u304c\u3001 \u901a\u5e38\u306f\u7279\u5b9a\u306e\u30a8\u30f3\u30c6\u30a3\u30c6\u30a3\u306b\u9069\u7528\u3055\u308c\u308b\u6570\u306f\u3055\u307b\u3069\u591a\u304f\u306a\u3044\u5834\u5408\u306b\u9069\u3057\u305f\u30c7\u30fc\u30bf\u30e2\u30c7\u30eb\u3067\u3059\u3002 \u6570\u5b66\u3067\u306f\u3053\u306e\u30e2\u30c7\u30eb\u306f\u758e\u884c\u5217\u3068\u3057\u3066\u77e5\u3089\u308c\u3066\u3044\u307e\u3059\u3002 EAV\u306f\u307e\u305f\u3001\u30aa\u30d6\u30b8\u30a7\u30af\u30c8-\u5c5e\u6027-\u5024\u30e2\u30c7\u30eb\u3001\u5782\u76f4\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30e2\u30c7\u30eb\u3001\u30aa\u30fc\u30d7\u30f3\u30b9\u30ad\u30fc\u30de\u306a\u3069\u3068\u547c\u3070\u308c\u308b\u3053\u3068\u3082\u3042\u308a\u307e\u3059\u3002\u300d\n\u51fa\u5c55: \u30a6\u30a3\u30ad\u30da\u30c7\u30a3\u30a2(\u82f1\u8a9e).\n\n\u3068\u306e\u3053\u3068\u3067\u3059\u3002\u3088\u304f\u5206\u304b\u308a\u307e\u305b\u3093\u306d\u3002\n\u8981\u306f\u3001\u53ef\u5909\u3059\u308b\u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u3044\u3061\u3044\u3061DB\u5b9a\u7fa9\u3059\u308b\u306e\u306f\u9762\u5012\u3060\u304b\u3089\u3001key-value\u578b\u3063\u307d\u304f\u4fdd\u5b58\u3057\u3066\u3057\u307e\u304a\u3046\u3068\u3044\u3046\u3053\u3068\u3060\u3068\u601d\u3044\u307e\u3059\u3002\nWordpress\u3084MT\u306e\u30ab\u30b9\u30bf\u30e0\u30d5\u30a3\u30fc\u30eb\u30c9\u3082\u3053\u3093\u306a\u5f62\u3067\u5b9f\u88c5\u3055\u308c\u3066\u3044\u305f\u304b\u3068\u601d\u3044\u307e\u3059\u3002\u4f7f\u3044\u6240\u3092\u9593\u9055\u308f\u306a\u3051\u308c\u3070\u975e\u5e38\u306b\u4fbf\u5229\u3067\u3059\u3002\n\n\u5b9f\u88c5\n\u305d\u308c\u3067\u306f\u3001\u65e9\u901f\u5b9f\u88c5\u3057\u3066\u307f\u305f\u3044\u3068\u601d\u3046\u306e\u3067\u3059\u304c\u3001\u5b9f\u88c5\u65b9\u6cd5\u306f\u672c\u5bb6\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u4e01\u5be7\u306b\u66f8\u3044\u3066\u3044\u307e\u3059\u306e\u3067\u3001\u4eca\u56de\u306f\u3082\u3046\u5c11\u3057\u5b9f\u7528\u3063\u307d\u3044\u611f\u3058\u3067\u4f5c\u3063\u3066\u3044\u3053\u3046\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u8907\u6570\u30e2\u30c7\u30eb\u306b\u5bfe\u5fdc\u3059\u308b\n\u3072\u3068\u3064\u306eTable\u3067\u8907\u6570\u306eEAV\u30e2\u30c7\u30eb\u3092\u4e00\u7dd2\u306b\u7ba1\u7406\u3057\u3066\u307f\u307e\u3059\u3002\uff08\u5b9f\u7528\u7684\u304b\u3069\u3046\u304b\u306e\u5224\u65ad\u306f\u30fb\u30fb\u30fb\u304a\u4efb\u305b\u3057\u307e\u3059\uff09\n\u69cb\u6210\u306f\u3053\u3093\u306a\u611f\u3058\u3067\u3059\u3002\nclasses\n  |- model\n    |- entry.php\n    |- eav.php <-- EAV\n    |- entry\n      |- meta.php <-- EAV\u3092\u7d99\u627f\n      |- geometry.php <-- EAV\u3092\u7d99\u627f\n\n\u8a18\u4e8b(Model_Entry)\u306b\u8907\u6570\u306e\u30e1\u30bf\u60c5\u5831(Model_Entry_Meta)\u3068\u8907\u6570\u306e\u4f4d\u7f6e\u60c5\u5831(Model_Entry_Geometry)\u304c\u3076\u3089\u4e0b\u304c\u3063\u3066\u3044\u308b\u611f\u3058\u3067\u3059\u3002\nModel_Entry_Meta\u3068Model_Entry_Geometry\u306fModel_Env\u3092\u7d99\u627f\u3057\u3066\u3044\u307e\u3059\u3002\n\nMigration\n\nfuel/app/migrations/001_create_eavs.php\nnamespace Fuel\\Migrations;\n\nclass Create_eavs\n{\n    public function up()\n    {\n        \\DBUtil::create_table('eavs', array(\n            'id'           => array('constraint' =>  11, 'type' => 'int', 'auto_increment' => true, 'unsigned' => true),\n            'object_class' => array('constraint' => 255, 'type' => 'varchar'),\n            'object_id'    => array('constraint' => 255, 'type' => 'varchar'),\n            'key'          => array('constraint' => 255, 'type' => 'varchar'),\n            'value'        => array('constraint' => 255, 'type' => 'varchar', 'null' => true),\n\n        ), array('id'));\n    }\n\n    public function down()\n    {\n        \\DBUtil::drop_table('eavs');\n    }\n}\n\n\n\nModel\n\nfuel/app/classes/model/eav.php\nclass Model_Eav extends \\Orm\\Model\n{\n    protected static $_properties = array(\n        'id',\n        'object_class' => array('default'=>''),\n        'object_id',\n        'key',\n        'value',\n    );\n\n    protected static $_observers = array(\n    );\n\n    protected static $_table_name = 'eavs';\n\n\n    /**\n    * Overrides the query method to allow soft delete items to be filtered out.\n    */\n    public static function query($options = array())\n    {\n        $query = \\Orm\\Query::forge(get_called_class(), static::connection(), $options);\n\n        $query->where( array( 'object_class' => static::$_properties['object_class']['default'] ) );\n\n        return $query;\n    }\n}\n\n\n\nfuel/app/classes/model/entry/meta.php\nclass Model_Entry_Meta extends Model_Eav\n{\n    protected static $_properties = array(\n        'id',\n        'object_class' => array('default' => 'entry_meta'),\n        'object_id',\n        'key',\n        'value',\n    );\n\n    public static function validate_relation($val,$id)\n    {\n        $val->add_field('meta.'.$id.'.key', __('model.entry_meta.value'), 'required');\n        return $val;\n    }\n\n}\n\n\n\nfuel/app/classes/model/entry/geometry.php\nclass Model_Entry_Geometry extends Model_Eav\n{\n    protected static $_properties = array(\n        'id',\n        'object_class' => array('default' => 'entry_geometry'),\n        'object_id',\n        'key',\n        'value',\n    );\n\n    public static function validate_relation($val,$id)\n    {\n        $val->add_field('geometry.'.$id.'.key', __('model.entry_geometry.value'), 'required');\n        return $val;\n    }\n\n}\n\n\n\n\u30ea\u30ec\u30fc\u30b7\u30e7\u30f3\n\nfuel/app/classes/model/entry.php\nclass Model_Entry extends Model\n{\n    protected static $_properties = array(\n        'id',\n    );\n\n    protected static $_belongs_to = array(\n    );\n\n    protected static $_has_many= array(\n        'metas' => array(\n            'model_to' => 'Model_Entry_Meta',\n            'key_from' => 'id',\n            'key_to'   => 'object_id',\n            'cascade_save'   => true,\n            'cascade_delete' => true,\n            'conditions' => array(\n                'where' => array(\n                    'object_class' => 'entry_meta',\n                )\n            )\n        ),\n        'geometries' => array(\n            'model_to' => 'Model_Entry_Geometry',\n            'key_from' => 'id',\n            'key_to'   => 'object_id',\n            'cascade_save'   => true,\n            'cascade_delete' => true,\n            'conditions' => array(\n                'where' => array(\n                    'object_class' => 'entry_geometry',\n                )\n            )\n        ),\n    );\n\n    public static function validate($factory)\n    {\n        $val = Validation::forge($factory);\n\n        if( Input::post('meta') ){\n            foreach( Input::post('meta') as $id => $p ){\n                $val = Model_Entry_Meta::validate_relation($val,$id);\n            }\n        }\n        if( Input::post('geometry') ){\n            foreach( Input::post('geometry') as $id => $p ){\n                $val = Model_Entry_Geometry::validate_relation($val,$id);\n            }\n        }\n\n        return $val;\n    }\n\n\n\n\u78ba\u8a8d\n$e = Model_Entry::forge()\n$e->metas\n$e->geometries\n\n\n\u691c\u7d22\n\u691c\u7d22\u6642\u306f\u3001\n\nfuel/app/classes/controller/entry.php\npublic function action_index()\n{\n    $options = array( 'where' => array() );\n    if( $p = Input::param('meta',false) ){\n        $options = \\Arr::merge($options,array(\n            'related' => array(\n                'metas' => array(\n                    'where' => array(\n                        array('key'  ,'keywords'),\n                        array('value','LIKE',\"%$p%\"),\n    ))));}\n\n    $entries = Model_Entry::find($options);\n}\n\n\n\u3068\u3057\u305f\u308a\u3001OR\u3068\u304bAND\u3068\u304b\u99c6\u4f7f\u3057\u3066\u3044\u3051\u3070\u306a\u3093\u3068\u306a\u304f\u52d5\u304f\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u53c2\u7167\nEAV\u30b3\u30f3\u30c6\u30ca\u306f\u672c\u5f53\u306f\u672c\u5bb6\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u3082\u3042\u308b\u3088\u3046\u306b\u3001\u3053\u3093\u306a\u611f\u3058\u3067key\u3092\u76f4\u63a5\u6307\u5b9a\u3057\u3066\u5024\u3092\u53c2\u7167\u3067\u304d\u308b\u306e\u304c\u3088\u3044\u3068\u3053\u308d\u306a\u306e\u3067\u3001\u3053\u3046\u3057\u3066\u4f7f\u3063\u3066\u3082\u3088\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n    // EAV \u30b3\u30f3\u30c6\u30ca\u306f\u3053\u306e\u3088\u3046\u306b\u5b9a\u7fa9\u3057\u307e\u3059\n    protected static $_eav = array(\n        'statistics' => array(      // we use the statistics relation to store the EAV data\n            'attribute' => 'key',   // the key column in the related table contains the attribute\n            'value' => 'value',     // the value column in the related table contains the value\n        )\n    );\n// \u3053\u308c\u3067\u5c5e\u6027\u3092\u76f4\u63a5\u5f97\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\necho $mr->Temperature;      // '38.4'\necho $mr->Headache;     // 'yes'\n\n\u305d\u308c\u305e\u308c\u9055\u3046\u30c6\u30fc\u30d6\u30eb\u306b\u30ea\u30f3\u30af\u3059\u308b\u8907\u6570\u306e EAV \u3092\u5b9a\u7fa9\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002 \u305d\u306e\u5834\u5408\u3001\u5c5e\u6027\u304c\u4e00\u81f4\u3059\u308b\u3082\u306e\u304c\u898b\u3064\u304b\u308b\u307e\u3067\u3001\u5b9a\u7fa9\u3055\u308c\u305f\u9806\u5e8f\u3067\u3059\u3079\u3066\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u691c\u7d22\u3057\u307e\u3059\u3002 \u3082\u3057\u30d7\u30ed\u30d1\u30c6\u30a3\u304c\u3069\u3053\u306b\u3082\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u306a\u3044\u5834\u5408\u306f\u3001 \u30e2\u30c7\u30eb\u306b\u5bfe\u3059\u308b\u901a\u5e38\u306e\u30d7\u30ed\u30d1\u30c6\u30a3\u3068\u540c\u69d8\u306a\u51e6\u7406\u3092\u3057\u307e\u3059\u3002\u3064\u307e\u308a\u4f8b\u5916\u304c\u6295\u3052\u3089\u308c\u308b\u3068\u3044\u3046\u3053\u3068\u3067\u3059\u3002\n\n\u305f\u3060\u3001\u4eca\u56de\u306e\u5834\u5408\u3001\necho $entry->keywords; //'blog,food,bar' <-- Model_Entry_Meta\u3092\u53c2\u7167\necho $entry->shop; //'43.00...,131.00..' <-- Model_Entry_Geometry\u3092\u53c2\u7167\n\n\u3068\u306a\u3063\u3066\u898b\u901a\u3057\u304c\u3042\u307e\u308a\u3088\u304f\u306a\u3044\u306e\u3067\u3001\u3053\u3053\u306f\u5c11\u3057\u8003\u3048\u3082\u306e\u3067\u3059\u3002\u3002\n\n\u65b0\u898f\u4f5c\u6210\u30fb\u66f4\u65b0\n\n\u73fe\u6642\u70b9\u3067\u306f\u3001\u95a2\u9023\u30c6\u30fc\u30d6\u30eb\u306eEAV\u30b3\u30f3\u30c6\u30ca\u306b\u65b0\u3057\u3044\u5c5e\u6027\u3092\u8ffd\u52a0\u3059\u308b\u6642\u306b\u3053\u306e\u30a2\u30af\u30bb\u30b9\u30e1\u30bd\u30c3\u30c9\u306f\u4f7f\u3048\u307e\u305b\u3093\u3002 \u305d\u306e\u5834\u5408\u306f\u53e4\u3044\u3084\u308a\u65b9\u3092\u4f7f\u3063\u3066\u4e0b\u3055\u3044\u3002 \u3064\u307e\u308a\u3053\u306e\u3088\u3046\u306b\u3057\u307e\u3059\u3002 \n$mr->statistics[] = Statistics::forge($newdata);\n\n\u3068\u306e\u3053\u3068\u306a\u306e\u3067\u3001\u3053\u3053\u306f\u305d\u306e\u307e\u307e\u3001\n$entry->metas[] = Model_Entry_Meta::forge($options);\n$entry->geometries[] = Model_Entry_Geometry::forge($options);\n\n\u3068\u3059\u308c\u3070\u3044\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u4f55\u306b\u4f7f\u3046\u304b\n\u554f\u984c\u306f\u305d\u308c\u3067\u3059\u306d\u3002\n\u57fa\u672c\u7684\u306b\u306f\u3001\u300c\u4f55\u306b\u3067\u3082\u4f7f\u3048\u308b\u306e\u3067\u3068\u308a\u3042\u3048\u305a001_\u3067migration\u3057\u3068\u3051\u3070\u3044\u3044\u300d\u304f\u3089\u3044\u306e\u611f\u3058\u3067\u3059\u3002\n\u3068\u304f\u306b\u3001WEB\u30b5\u30a4\u30c8\u306e\u5834\u5408\u3001\u30b5\u30a4\u30c8\u306e\u30e1\u30bf\u60c5\u5831\u3068\u304b\u306f\u591a\u7a2e\u591a\u69d8\u3067\u3001\u5f8c\u304b\u3089\u5f8c\u304b\u3089\u8981\u671b\u304c\u51fa\u3066\u6765\u308b\u3082\u306e\u3060\u3068\u601d\u3044\u307e\u3059\u3002\n\u305d\u306e\u5ea6\u306b\u3044\u3061\u3044\u3061\u30d5\u30a3\u30fc\u30eb\u30c9\u8ffd\u52a0\u3059\u308b\u3088\u308a\u3082\u3001\u3053\u3093\u306a\u611f\u3058\u3067\u60c5\u5831\u3092\u6301\u3063\u3066\u304a\u3051\u308c\u3070\u4fbf\u5229\u306b\u4f7f\u3048\u307e\u3059\u3002\n\u307e\u305f\u3001\u3084\u308d\u3046\u3068\u601d\u3048\u3070\u3067\u3059\u304c\u3001Wordpress\u306e\u30ab\u30b9\u30bf\u30e0\u30d5\u30a3\u30fc\u30eb\u30c9\u306e\u3088\u3046\u306bEAV\u3067\u8907\u96d1\u306a\u691c\u7d22\u3092\u3055\u305b\u308b\u3053\u3068\u3082\u3067\u304d\u308b\u3068\u601d\u3046\u306e\u3067\u3001CMS\u7684\u306a\u7528\u9014\u306b\u3082\u4f7f\u3048\u308b\u304b\u3068\u601d\u3044\u307e\u3059\u3002\n\n[FuelPHP Advent Calendar 2015](http://qiita.com/advent-calendar/2015/fuelphp) \u306e19\u65e5\u76ee\u3092\u62c5\u5f53\u3055\u305b\u3066\u3044\u305f\u3060\u304d\u307e\u3059\u3002\n\u3088\u308d\u3057\u304f\u304a\u9858\u3044\u3057\u307e\u3059\u3002\n\n\u4f55\u3092\u66f8\u3053\u3046\u304b\u8ff7\u3044\u307e\u3057\u305f\u304c\u3001Wordpress\u3068\u304b\u3067\u3088\u304f\u3042\u308b\u30ab\u30b9\u30bf\u30e0\u30d5\u30a3\u30fc\u30eb\u30c9\u3063\u307d\u3044\u3082\u306e\u3092\u5b9f\u88c5\u3059\u308b\u65b9\u6cd5\u3092\u66f8\u3044\u3066\u307f\u3088\u3046\u304b\u3068\u601d\u3044\u307e\u3059\u3002\n\n# EAV\u30b3\u30f3\u30c6\u30ca\u3068\u306f\n\n[EAV\u30b3\u30f3\u30c6\u30ca / FuelPHP 1.7 Documentation](http://fuelphp.jp/docs/1.7/packages/orm/eav.html)\n\n>\n\u300c\u30a8\u30f3\u30c6\u30a3\u30c6\u30a3-\u30a2\u30c8\u30ea\u30d3\u30e5\u30fc\u30c8-\u30d0\u30ea\u30e5\u30fc (Entity-attribute-value) \u30e2\u30c7\u30eb (EAV) \u306f\u3001\u6f5c\u5728\u7684\u306b\u306f\u5927\u5909\u306b\u591a\u304f\u306e\u5c5e\u6027(\u30d7\u30ed\u30d1\u30c6\u30a3\u3084\u30d1\u30e9\u30e1\u30fc\u30bf)\u3092\u8a18\u8ff0\u3067\u304d\u308b\u3053\u3068\u304c\u5fc5\u8981\u3060\u304c\u3001 \u901a\u5e38\u306f\u7279\u5b9a\u306e\u30a8\u30f3\u30c6\u30a3\u30c6\u30a3\u306b\u9069\u7528\u3055\u308c\u308b\u6570\u306f\u3055\u307b\u3069\u591a\u304f\u306a\u3044\u5834\u5408\u306b\u9069\u3057\u305f\u30c7\u30fc\u30bf\u30e2\u30c7\u30eb\u3067\u3059\u3002 \u6570\u5b66\u3067\u306f\u3053\u306e\u30e2\u30c7\u30eb\u306f\u758e\u884c\u5217\u3068\u3057\u3066\u77e5\u3089\u308c\u3066\u3044\u307e\u3059\u3002 EAV\u306f\u307e\u305f\u3001\u30aa\u30d6\u30b8\u30a7\u30af\u30c8-\u5c5e\u6027-\u5024\u30e2\u30c7\u30eb\u3001\u5782\u76f4\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30e2\u30c7\u30eb\u3001\u30aa\u30fc\u30d7\u30f3\u30b9\u30ad\u30fc\u30de\u306a\u3069\u3068\u547c\u3070\u308c\u308b\u3053\u3068\u3082\u3042\u308a\u307e\u3059\u3002\u300d\n\u51fa\u5c55: \u30a6\u30a3\u30ad\u30da\u30c7\u30a3\u30a2(\u82f1\u8a9e).\n\n\u3068\u306e\u3053\u3068\u3067\u3059\u3002\u3088\u304f\u5206\u304b\u308a\u307e\u305b\u3093\u306d\u3002\n\u8981\u306f\u3001\u53ef\u5909\u3059\u308b\u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u3044\u3061\u3044\u3061DB\u5b9a\u7fa9\u3059\u308b\u306e\u306f\u9762\u5012\u3060\u304b\u3089\u3001key-value\u578b\u3063\u307d\u304f\u4fdd\u5b58\u3057\u3066\u3057\u307e\u304a\u3046\u3068\u3044\u3046\u3053\u3068\u3060\u3068\u601d\u3044\u307e\u3059\u3002\nWordpress\u3084MT\u306e\u30ab\u30b9\u30bf\u30e0\u30d5\u30a3\u30fc\u30eb\u30c9\u3082\u3053\u3093\u306a\u5f62\u3067\u5b9f\u88c5\u3055\u308c\u3066\u3044\u305f\u304b\u3068\u601d\u3044\u307e\u3059\u3002\u4f7f\u3044\u6240\u3092\u9593\u9055\u308f\u306a\u3051\u308c\u3070\u975e\u5e38\u306b\u4fbf\u5229\u3067\u3059\u3002\n\n# \u5b9f\u88c5\n\n\u305d\u308c\u3067\u306f\u3001\u65e9\u901f\u5b9f\u88c5\u3057\u3066\u307f\u305f\u3044\u3068\u601d\u3046\u306e\u3067\u3059\u304c\u3001\u5b9f\u88c5\u65b9\u6cd5\u306f\u672c\u5bb6\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u4e01\u5be7\u306b\u66f8\u3044\u3066\u3044\u307e\u3059\u306e\u3067\u3001\u4eca\u56de\u306f\u3082\u3046\u5c11\u3057\u5b9f\u7528\u3063\u307d\u3044\u611f\u3058\u3067\u4f5c\u3063\u3066\u3044\u3053\u3046\u3068\u601d\u3044\u307e\u3059\u3002\n\n## \u8907\u6570\u30e2\u30c7\u30eb\u306b\u5bfe\u5fdc\u3059\u308b\n\n\u3072\u3068\u3064\u306eTable\u3067\u8907\u6570\u306eEAV\u30e2\u30c7\u30eb\u3092\u4e00\u7dd2\u306b\u7ba1\u7406\u3057\u3066\u307f\u307e\u3059\u3002\uff08\u5b9f\u7528\u7684\u304b\u3069\u3046\u304b\u306e\u5224\u65ad\u306f\u30fb\u30fb\u30fb\u304a\u4efb\u305b\u3057\u307e\u3059\uff09\n\u69cb\u6210\u306f\u3053\u3093\u306a\u611f\u3058\u3067\u3059\u3002\n\n```\nclasses\n  |- model\n    |- entry.php\n    |- eav.php <-- EAV\n    |- entry\n      |- meta.php <-- EAV\u3092\u7d99\u627f\n      |- geometry.php <-- EAV\u3092\u7d99\u627f\n```\n\n\u8a18\u4e8b(`Model_Entry`)\u306b\u8907\u6570\u306e\u30e1\u30bf\u60c5\u5831(`Model_Entry_Meta`)\u3068\u8907\u6570\u306e\u4f4d\u7f6e\u60c5\u5831(`Model_Entry_Geometry`)\u304c\u3076\u3089\u4e0b\u304c\u3063\u3066\u3044\u308b\u611f\u3058\u3067\u3059\u3002\n`Model_Entry_Meta`\u3068`Model_Entry_Geometry`\u306f`Model_Env`\u3092\u7d99\u627f\u3057\u3066\u3044\u307e\u3059\u3002\n\n### Migration\n\n```php:fuel/app/migrations/001_create_eavs.php\nnamespace Fuel\\Migrations;\n\nclass Create_eavs\n{\n\tpublic function up()\n\t{\n\t\t\\DBUtil::create_table('eavs', array(\n\t\t\t'id'           => array('constraint' =>  11, 'type' => 'int', 'auto_increment' => true, 'unsigned' => true),\n\t\t\t'object_class' => array('constraint' => 255, 'type' => 'varchar'),\n\t\t\t'object_id'    => array('constraint' => 255, 'type' => 'varchar'),\n\t\t\t'key'          => array('constraint' => 255, 'type' => 'varchar'),\n\t\t\t'value'        => array('constraint' => 255, 'type' => 'varchar', 'null' => true),\n\n\t\t), array('id'));\n\t}\n\n\tpublic function down()\n\t{\n\t\t\\DBUtil::drop_table('eavs');\n\t}\n}\n```\n\n### Model\n\n```php:fuel/app/classes/model/eav.php\nclass Model_Eav extends \\Orm\\Model\n{\n\tprotected static $_properties = array(\n\t\t'id',\n\t\t'object_class' => array('default'=>''),\n\t\t'object_id',\n\t\t'key',\n\t\t'value',\n\t);\n\n\tprotected static $_observers = array(\n\t);\n\n\tprotected static $_table_name = 'eavs';\n\n\t\n\t/**\n\t* Overrides the query method to allow soft delete items to be filtered out.\n\t*/\n\tpublic static function query($options = array())\n\t{\n\t\t$query = \\Orm\\Query::forge(get_called_class(), static::connection(), $options);\n\n\t\t$query->where( array( 'object_class' => static::$_properties['object_class']['default'] ) );\n\n\t\treturn $query;\n\t}\n}\n```\n\n```php:fuel/app/classes/model/entry/meta.php\nclass Model_Entry_Meta extends Model_Eav\n{\n\tprotected static $_properties = array(\n\t\t'id',\n\t\t'object_class' => array('default' => 'entry_meta'),\n\t\t'object_id',\n\t\t'key',\n\t\t'value',\n\t);\n\n\tpublic static function validate_relation($val,$id)\n\t{\n\t\t$val->add_field('meta.'.$id.'.key', __('model.entry_meta.value'), 'required');\n\t\treturn $val;\n\t}\n\n}\n```\n\n```php:fuel/app/classes/model/entry/geometry.php\nclass Model_Entry_Geometry extends Model_Eav\n{\n\tprotected static $_properties = array(\n\t\t'id',\n\t\t'object_class' => array('default' => 'entry_geometry'),\n\t\t'object_id',\n\t\t'key',\n\t\t'value',\n\t);\n\n\tpublic static function validate_relation($val,$id)\n\t{\n\t\t$val->add_field('geometry.'.$id.'.key', __('model.entry_geometry.value'), 'required');\n\t\treturn $val;\n\t}\n\n}\n```\n\n## \u30ea\u30ec\u30fc\u30b7\u30e7\u30f3\n\n```php:fuel/app/classes/model/entry.php\nclass Model_Entry extends Model\n{\n\tprotected static $_properties = array(\n\t\t'id',\n\t);\n\t\n\tprotected static $_belongs_to = array(\n\t);\n\t\n\tprotected static $_has_many= array(\n\t\t'metas' => array(\n\t\t\t'model_to' => 'Model_Entry_Meta',\n\t\t\t'key_from' => 'id',\n\t\t\t'key_to'   => 'object_id',\n\t\t\t'cascade_save'   => true,\n\t\t\t'cascade_delete' => true,\n\t\t\t'conditions' => array(\n\t\t\t\t'where' => array(\n\t\t\t\t\t'object_class' => 'entry_meta',\n\t\t\t\t)\n\t\t\t)\n\t\t),\n\t\t'geometries' => array(\n\t\t\t'model_to' => 'Model_Entry_Geometry',\n\t\t\t'key_from' => 'id',\n\t\t\t'key_to'   => 'object_id',\n\t\t\t'cascade_save'   => true,\n\t\t\t'cascade_delete' => true,\n\t\t\t'conditions' => array(\n\t\t\t\t'where' => array(\n\t\t\t\t\t'object_class' => 'entry_geometry',\n\t\t\t\t)\n\t\t\t)\n\t\t),\n\t);\n\n\tpublic static function validate($factory)\n\t{\n\t\t$val = Validation::forge($factory);\n\n\t\tif( Input::post('meta') ){\n\t\t\tforeach( Input::post('meta') as $id => $p ){\n\t\t\t\t$val = Model_Entry_Meta::validate_relation($val,$id);\n\t\t\t}\n\t\t}\n\t\tif( Input::post('geometry') ){\n\t\t\tforeach( Input::post('geometry') as $id => $p ){\n\t\t\t\t$val = Model_Entry_Geometry::validate_relation($val,$id);\n\t\t\t}\n\t\t}\n\n\t\treturn $val;\n\t}\n```\n\n## \u78ba\u8a8d\n\n```php\n$e = Model_Entry::forge()\n$e->metas\n$e->geometries\n```\n\n## \u691c\u7d22\n\n\u691c\u7d22\u6642\u306f\u3001\n\n```php:fuel/app/classes/controller/entry.php\npublic function action_index()\n{\n\t$options = array( 'where' => array() );\n\tif( $p = Input::param('meta',false) ){\n\t\t$options = \\Arr::merge($options,array(\n\t\t\t'related' => array(\n\t\t\t\t'metas' => array(\n\t\t\t\t\t'where' => array(\n\t\t\t\t\t\tarray('key'  ,'keywords'),\n\t\t\t\t\t\tarray('value','LIKE',\"%$p%\"),\n\t))));}\n\t\n\t$entries = Model_Entry::find($options);\n}\n```\n\n\u3068\u3057\u305f\u308a\u3001OR\u3068\u304bAND\u3068\u304b\u99c6\u4f7f\u3057\u3066\u3044\u3051\u3070\u306a\u3093\u3068\u306a\u304f\u52d5\u304f\u3068\u601d\u3044\u307e\u3059\u3002\n\n## \u53c2\u7167\n\nEAV\u30b3\u30f3\u30c6\u30ca\u306f\u672c\u5f53\u306f\u672c\u5bb6\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u3082\u3042\u308b\u3088\u3046\u306b\u3001\u3053\u3093\u306a\u611f\u3058\u3067key\u3092\u76f4\u63a5\u6307\u5b9a\u3057\u3066\u5024\u3092\u53c2\u7167\u3067\u304d\u308b\u306e\u304c\u3088\u3044\u3068\u3053\u308d\u306a\u306e\u3067\u3001\u3053\u3046\u3057\u3066\u4f7f\u3063\u3066\u3082\u3088\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n>\n```php\n    // EAV \u30b3\u30f3\u30c6\u30ca\u306f\u3053\u306e\u3088\u3046\u306b\u5b9a\u7fa9\u3057\u307e\u3059\n    protected static $_eav = array(\n        'statistics' => array(\t\t// we use the statistics relation to store the EAV data\n            'attribute' => 'key',\t// the key column in the related table contains the attribute\n            'value' => 'value',\t\t// the value column in the related table contains the value\n        )\n    );\n// \u3053\u308c\u3067\u5c5e\u6027\u3092\u76f4\u63a5\u5f97\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\necho $mr->Temperature;\t\t// '38.4'\necho $mr->Headache;\t\t// 'yes'\n```\n\n>\n\u305d\u308c\u305e\u308c\u9055\u3046\u30c6\u30fc\u30d6\u30eb\u306b\u30ea\u30f3\u30af\u3059\u308b\u8907\u6570\u306e EAV \u3092\u5b9a\u7fa9\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002 \u305d\u306e\u5834\u5408\u3001\u5c5e\u6027\u304c\u4e00\u81f4\u3059\u308b\u3082\u306e\u304c\u898b\u3064\u304b\u308b\u307e\u3067\u3001\u5b9a\u7fa9\u3055\u308c\u305f\u9806\u5e8f\u3067\u3059\u3079\u3066\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u691c\u7d22\u3057\u307e\u3059\u3002 \u3082\u3057\u30d7\u30ed\u30d1\u30c6\u30a3\u304c\u3069\u3053\u306b\u3082\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u306a\u3044\u5834\u5408\u306f\u3001 \u30e2\u30c7\u30eb\u306b\u5bfe\u3059\u308b\u901a\u5e38\u306e\u30d7\u30ed\u30d1\u30c6\u30a3\u3068\u540c\u69d8\u306a\u51e6\u7406\u3092\u3057\u307e\u3059\u3002\u3064\u307e\u308a\u4f8b\u5916\u304c\u6295\u3052\u3089\u308c\u308b\u3068\u3044\u3046\u3053\u3068\u3067\u3059\u3002\n\n\u305f\u3060\u3001\u4eca\u56de\u306e\u5834\u5408\u3001\n\n```php\necho $entry->keywords; //'blog,food,bar' <-- Model_Entry_Meta\u3092\u53c2\u7167\necho $entry->shop; //'43.00...,131.00..' <-- Model_Entry_Geometry\u3092\u53c2\u7167\n```\n\n\u3068\u306a\u3063\u3066\u898b\u901a\u3057\u304c\u3042\u307e\u308a\u3088\u304f\u306a\u3044\u306e\u3067\u3001\u3053\u3053\u306f\u5c11\u3057\u8003\u3048\u3082\u306e\u3067\u3059\u3002\u3002\n\n## \u65b0\u898f\u4f5c\u6210\u30fb\u66f4\u65b0\n\n>\n\u73fe\u6642\u70b9\u3067\u306f\u3001\u95a2\u9023\u30c6\u30fc\u30d6\u30eb\u306eEAV\u30b3\u30f3\u30c6\u30ca\u306b\u65b0\u3057\u3044\u5c5e\u6027\u3092\u8ffd\u52a0\u3059\u308b\u6642\u306b\u3053\u306e\u30a2\u30af\u30bb\u30b9\u30e1\u30bd\u30c3\u30c9\u306f\u4f7f\u3048\u307e\u305b\u3093\u3002 \u305d\u306e\u5834\u5408\u306f\u53e4\u3044\u3084\u308a\u65b9\u3092\u4f7f\u3063\u3066\u4e0b\u3055\u3044\u3002 \u3064\u307e\u308a\u3053\u306e\u3088\u3046\u306b\u3057\u307e\u3059\u3002 \n```$mr->statistics[] = Statistics::forge($newdata);```\n\n\u3068\u306e\u3053\u3068\u306a\u306e\u3067\u3001\u3053\u3053\u306f\u305d\u306e\u307e\u307e\u3001\n\n```php\n$entry->metas[] = Model_Entry_Meta::forge($options);\n$entry->geometries[] = Model_Entry_Geometry::forge($options);\n```\n\n\u3068\u3059\u308c\u3070\u3044\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n#\u4f55\u306b\u4f7f\u3046\u304b\n\n\u554f\u984c\u306f\u305d\u308c\u3067\u3059\u306d\u3002\n\n\u57fa\u672c\u7684\u306b\u306f\u3001<strong>\u300c\u4f55\u306b\u3067\u3082\u4f7f\u3048\u308b\u306e\u3067\u3068\u308a\u3042\u3048\u305a001_\u3067migration\u3057\u3068\u3051\u3070\u3044\u3044\u300d</strong>\u304f\u3089\u3044\u306e\u611f\u3058\u3067\u3059\u3002\n\u3068\u304f\u306b\u3001WEB\u30b5\u30a4\u30c8\u306e\u5834\u5408\u3001\u30b5\u30a4\u30c8\u306e\u30e1\u30bf\u60c5\u5831\u3068\u304b\u306f\u591a\u7a2e\u591a\u69d8\u3067\u3001\u5f8c\u304b\u3089\u5f8c\u304b\u3089\u8981\u671b\u304c\u51fa\u3066\u6765\u308b\u3082\u306e\u3060\u3068\u601d\u3044\u307e\u3059\u3002\n\u305d\u306e\u5ea6\u306b\u3044\u3061\u3044\u3061\u30d5\u30a3\u30fc\u30eb\u30c9\u8ffd\u52a0\u3059\u308b\u3088\u308a\u3082\u3001\u3053\u3093\u306a\u611f\u3058\u3067\u60c5\u5831\u3092\u6301\u3063\u3066\u304a\u3051\u308c\u3070\u4fbf\u5229\u306b\u4f7f\u3048\u307e\u3059\u3002\n\n\u307e\u305f\u3001\u3084\u308d\u3046\u3068\u601d\u3048\u3070\u3067\u3059\u304c\u3001Wordpress\u306e\u30ab\u30b9\u30bf\u30e0\u30d5\u30a3\u30fc\u30eb\u30c9\u306e\u3088\u3046\u306bEAV\u3067\u8907\u96d1\u306a\u691c\u7d22\u3092\u3055\u305b\u308b\u3053\u3068\u3082\u3067\u304d\u308b\u3068\u601d\u3046\u306e\u3067\u3001CMS\u7684\u306a\u7528\u9014\u306b\u3082\u4f7f\u3048\u308b\u304b\u3068\u601d\u3044\u307e\u3059\u3002\n", "tags": ["FuelPHP"]}