{"context": "\n\n\u306f\u3058\u3081\u306b\n\u524d\u56de\u306fAWS\u306bStackStorm\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u306e\u3067\u3001\u4eca\u56de\u306f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u76e3\u8996\u30c4\u30fc\u30eb\u3067\u3042\u308bNew Relic\u3068\u9023\u643a\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\nStackStorm\u306b\u306f\u3001Pack\u3068\u547c\u3070\u308c\u308b\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u30b3\u30f3\u30dd\u30fc\u30cd\u30f3\u30c8\u306e\u8ffd\u52a0\u6a5f\u80fd\u304c\u3042\u308a\u3001New Relic\u306ePack\u3082\u7528\u610f\u3055\u308c\u3066\u3044\u307e\u3059\u3002\u4eca\u56de\u306fPack\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304b\u3089\u4f7f\u3044\u65b9\u307e\u3067\u7d39\u4ecb\u3057\u307e\u3059\u3002\nNew Relic\u306b\u95a2\u3057\u3066\u306f\u3001\u4e0b\u8a18\u8a18\u4e8b\u3092\u53c2\u8003\u306b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\nNew Relic\u306eAPM\u3068INFRASTRUCTURE\u3092\u4f7f\u3063\u3066\u76e3\u8996\u3057\u3066\u307f\u307e\u3057\u305f\uff08\u524d\u534a\uff09\nNew Relic\u306eAPM\u3068INFRASTRUCTURE\u3092\u4f7f\u3063\u3066\u76e3\u8996\u3057\u3066\u307f\u307e\u3057\u305f\uff08\u5f8c\u534a\uff09\n\nStackStom\u306e\u8a2d\u5b9a\n\nNew Relic Pack\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u4e0b\u8a18st2\u30b3\u30de\u30f3\u30c9\u3067NewRelic\u306ePack\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002status\u304csucceeded\u306b\u306a\u3063\u3066\u3044\u305f\u3089\u6210\u529f\u3067\u3059\u3002\n$ st2 run packs.install packs=newrelic\n......................\nid: 586df3da897d4405b3b07f36\naction.ref: packs.install\nparameters:\n  packs:\n  - newrelic\nstatus: succeeded\nstart_timestamp: 2017-01-05T07:20:58.022719Z\nend_timestamp: 2017-01-05T07:23:13.100056Z\n+--------------------------+-------------------------+--------------------------+-------------------------+------------------------------+\n| id                       | status                  | task                     | action                  | start_timestamp              |\n+--------------------------+-------------------------+--------------------------+-------------------------+------------------------------+\n| 586df3da897d440342b8b6ba | succeeded (7s elapsed)  | download                 | packs.download          | Thu, 05 Jan 2017 07:20:58    |\n|                          |                         |                          |                         | UTC                          |\n| 586df3e2897d440342b8b6bd | succeeded (3s elapsed)  | virtualenv_prerun        | packs.virtualenv_prerun | Thu, 05 Jan 2017 07:21:06    |\n|                          |                         |                          |                         | UTC                          |\n| 586df3e5897d440342b8b6c0 | succeeded (56s elapsed) | setup_virtualenv         | packs.setup_virtualenv  | Thu, 05 Jan 2017 07:21:09    |\n|                          |                         |                          |                         | UTC                          |\n| 586df41e897d440342b8b6c4 | succeeded (63s elapsed) | reload                   | packs.load              | Thu, 05 Jan 2017 07:22:06    |\n|                          |                         |                          |                         | UTC                          |\n| 586df45e897d440342b8b6c8 | succeeded (2s elapsed)  | restart-sensor-container | packs.restart_component | Thu, 05 Jan 2017 07:23:10    |\n|                          |                         |                          |                         | UTC                          |\n+--------------------------+-------------------------+--------------------------+-------------------------+------------------------------+\n\n\nNew Relic Pack\u306e\u78ba\u8a8d\n1) \u30bb\u30f3\u30b5\u30fc\u78ba\u8a8d\n$ st2 sensor list\n+---------------------------------+----------+---------------------------------+---------+\n| ref                             | pack     | description                     | enabled |\n+---------------------------------+----------+---------------------------------+---------+\n| newrelic.NewRelicHookSensor     | newrelic | Sensor which watches for alerts | True    |\n|                                 |          | from NewRelic API.              |         |\n| newrelic.LegacyNewRelicHookSens | newrelic | Sensor which watches for alerts | False   |\n| or                              |          | from the NewRelic legacy API.   |         |\n+---------------------------------+----------+---------------------------------+---------+\n\n2)\u30c8\u30ea\u30ac\u30fc\u78ba\u8a8d\n$ st2 trigger list\n+--------------------------------------+----------+-------------------------------------------+\n| ref                                  | pack     | description                               |\n+--------------------------------------+----------+-------------------------------------------+\n| newrelic.WebAppAlertTrigger          | newrelic |                                           |\n| newrelic.WebAppNormalTrigger         | newrelic |                                           |\n| newrelic.ServerAlertTrigger          | newrelic |                                           |\n| newrelic.ServerNormalTrigger         | newrelic |                                           |\n+--------------------------------------+----------+-------------------------------------------+\n\n3)\u30a2\u30af\u30b7\u30e7\u30f3\u78ba\u8a8d\n$ st2 action list | grep new\n+---------------------------------+----------+-------------------------------------------+\n| ref                             | pack     | description                               |\n+---------------------------------+----------+-------------------------------------------+\n| newrelic.get_alerts             | newrelic | Get alerts for app.                       |\n| newrelic.get_metric_data        | newrelic | Get metric data for metric.               |\n\n\nNew Relic Pack\u306e\u8a2d\u5b9a\n1) \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u30b3\u30d4\u30fc\nNew Relic\u306ePack\u306f\u3001\u4e0b\u8a18\u30d5\u30a9\u30eb\u30c0\u30fc\u306b\u4fdd\u5b58\u3055\u308c\u308b\u306e\u3067\u3001\n/opt/stackstorm/packs/newrelic/\n\u30b5\u30f3\u30d7\u30eb\u30d5\u30a1\u30a4\u30eb\u304b\u3089\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\ncd /opt/stackstorm/configs\ncp /opt/stackstorm/packs/newrelic/newrelic.yaml.example ./newrelic.yaml\n\n2) \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u7de8\u96c6\n\u30c7\u30d5\u30a9\u30eb\u30c8\u3060\u3068Base URL\u304c\u3001http://x.x.x.x:10001/st2/nrhook/\u306b\u306a\u308a\u307e\u3059\n$vim ./newrelic.yaml\n---\napi_url: \"https://api.newrelic.com/v2/\"\napi_key: \"<New Relic\u306eAPI\u30ad\u30fc\u3092\u5165\u529b\u3057\u307e\u3059>\"\nsensor_config:\n    host: \"0.0.0.0\"\n    port: 10001\n    url: \"/st2/nrhook/\"\n    normal_report_delay: 300\n\n3) st2 \u518d\u8d77\u52d5\n\u8a2d\u5b9a\u3092\u6709\u52b9\u306b\u3059\u308b\u305f\u3081\u306bStackStorm\u3092\u518d\u8d77\u52d5\u3057\u307e\u3059\n$ st2ctl reload\n4) TCP\u30dd\u30fc\u30c8\u8d77\u52d5\u78ba\u8a8d\nNew Relic\u306eSenser\u304c\u8d77\u52d5\u3059\u308b\u3068\u3001TCP\u306e10001\u756a\u3067Listen\u3057\u307e\u3059\n$ netstat -ln | grep 10001\ntcp        0      0 0.0.0.0:10001           0.0.0.0:*               LISTEN\n\n\n\u30eb\u30fc\u30eb\u4f5c\u6210\nNew Relic\u304b\u3089\u9001\u4fe1\u3055\u308c\u305f\u30a2\u30e9\u30fc\u30c8\u5185\u5bb9\u3092\u3001\u30d5\u30a1\u30a4\u30eb(st2.newrelic.out)\u306b\u51fa\u529b\u3059\u308b\u30eb\u30fc\u30eb\u3092\u4f5c\u6210\n1) APM\u30a2\u30e9\u30fc\u30c8\u7528\u30eb\u30fc\u30eb\u4f5c\u6210\n$ cd /opt/stackstorm/packs/newrelic/rules/\n$ vim webapp_notify.yaml\n---\nname: \"webapp.notify\"\npack: \"newrelic\"\ndescription: \"WebAppAlertTrigger Sample rule for newrelic.\"\nenabled: true\n\ntrigger:\n    type: \"newrelic.WebAppAlertTrigger\"\n\ncriteria: {}\n\naction:\n    ref: \"core.local\"\n    parameters:\n        cmd: \"echo {{ trigger.alert }} >> ~/st2.newrelic.out\"\n\n2) Servers\u30a2\u30e9\u30fc\u30c8\u7528\u30eb\u30fc\u30eb\u4f5c\u6210\n$ vim server_notify.yaml\n---\nname: \"server.notify\"\npack: \"newrelic\"\ndescription: \"ServerAlertTrigger Sample rule for newrelic.\"\nenabled: true\n\ntrigger:\n    type: \"newrelic.ServerAlertTrigger\"\n\ncriteria: {}\n\naction:\n    ref: \"core.local\"\n    parameters:\n        cmd: \"echo {{ trigger.alert }} >> ~/st2.newrelic.out\"\n\n3)st2\u30eb\u30fc\u30eb\u4f5c\u6210\nst2 rule create /opt/stackstorm/packs/newrelic/rules/webapp_notify.yaml\nst2 rule create /opt/stackstorm/packs/newrelic/rules/server_notify.yaml\n\n4)st2\u30eb\u30fc\u30eb\u78ba\u8a8d\n$ st2 rule list\n+------------------------+----------+-----------------------------------------+---------+\n| ref                    | pack     | description                             | enabled |\n+------------------------+----------+-----------------------------------------+---------+\n| newrelic.server.notify | newrelic | ServerAlertTrigger Sample rule for      | True    |\n|                        |          | newrelic.                               |         |\n| newrelic.webapp.notify | newrelic | WebAppAlertTrigger Sample rule for      | True    |\n|                        |          | newrelic.                               |         |\n+------------------------+----------+-----------------------------------------+---------+\n\n\n\n\u52d5\u4f5c\u78ba\u8a8d\nStackStom\u304b\u3089\u81ea\u5206\u5b9b(127.0.0.1)\u306b\u30c6\u30b9\u30c8\u7528\u306e\u30a2\u30e9\u30fc\u30c8\u3092\u9001\u4fe1\u3057\u3066\u78ba\u8a8d\u3057\u307e\u3059\u3002\n1) APM\u30a2\u30e9\u30fc\u30c8\u78ba\u8a8d\u7528\ncurl -X POST \\\n    -H 'Content-Type:application/json; charset=UTF-8' \\\n    -d '{ \n    \"current_state\":\"open\",\n    \"details\":\"Apdex < .50 for at least 10 min\",\n    \"severity\":\"CRITICAL\",\n    \"event_type\":\"INCIDENT\",\n    \"targets\":[{\n        \"product\": \"APM\", \n        \"name\": \"TEST APM\",\n        \"labels\": {}, \n        \"type\": \"Application\", \n        \"id\": \"123456789\"\n        }]\n    }' \\\nhttp://127.0.0.1:10001/st2/nrhook/\n\n2) Servers\u30a2\u30e9\u30fc\u30c8\u78ba\u8a8d\u7528\ncurl -X POST \\\n    -H 'Content-Type:application/json; charset=UTF-8' \\\n    -d '{ \n    \"current_state\":\"open\",\n    \"details\":\"System load > 0.1 for at least 5 minutes\",\n    \"severity\":\"CRITICAL\",\n    \"event_type\":\"INCIDENT\",\n    \"targets\":[{\n        \"product\": \"SERVERS\", \n        \"name\": \"TEST Servers\",\n        \"labels\": {}, \n        \"type\": \"Server\", \n        \"id\": \"123456789\"\n        }]\n    }' \\\nhttp://127.0.0.1:10001/st2/nrhook/\n\n3) \u30a2\u30e9\u30fc\u30c8\u5185\u5bb9\u306e\u78ba\u8a8d\n$ tail /home/stanley/st2.newrelic.out\n{uevent_type: uINCIDENT, udetails: uApdex < .50 for at least 10 min, ucurrent_state: uopen, utargets: [{uproduct: uAPM, ulabels: {}, utype: uApplication, uname: uTEST APM, uid: u123456789}], useverity: uCRITICAL}\n{uevent_type: uINCIDENT, udetails: uSystem load > 0.1 for at least 5 minutes, ucurrent_state: uopen, utargets: [{uproduct: uSERVERS, ulabels: {}, utype: uServer, uname: uTEST Servers, uid: u123456789}], useverity: uCRITICAL}\n\n\nAWS\u306e\u8a2d\u5b9a\n\uff11\uff09\u30bb\u30ad\u30e5\u30ea\u30c6\u30a4\u2015\u30b0\u30eb\u30fc\u30d7\u306e\u8ffd\u52a0\n\u5916\u90e8(New Relic)\u304b\u3089TCP:10001\u306e\u63a5\u7d9a\u304c\u3067\u304d\u308b\u3088\u3046\u30bb\u30ad\u30e5\u30ea\u30c6\u30a4\u2015\u30b0\u30eb\u30fc\u30d7\u3092\u5909\u66f4\nNew Relic Document\u306eWebhook alerts\u9805\u76ee\u306b\u30a2\u30e9\u30fc\u30c8\u306e\u9001\u4fe1\u5143IP\u304c\u8a18\u8f09\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u5fc5\u8981\u3067\u3042\u308c\u3070\u9001\u4fe1\u5143\u3092\u5236\u9650\u3057\u307e\u3059\u3002\nWebhook alerts\nNew Relic-generated webhooks for alert policies will be sent from an IP address in the 50.31.164.0/24 or 162.247.240.0/22 network block.\n\n\nNew Relic Alerts\u306e\u8a2d\u5b9a\n\uff11\uff09Alerts\u306eNotification Channel\u306e\u8ffd\u52a0\n\n\uff12\uff09Channel\u306e\u8a2d\u5b9a\nStackStom\u306e\u5f85\u3061\u53d7\u3051\u30dd\u30fc\u30c8(10001/tcp)\u306b\u5bfe\u3057\u3066Webhook\u306e\u8a2d\u5b9a\u3092\u3057\u307e\u3059\u3002\n\n\uff13\uff09Alert Policy\u306e\u4f5c\u6210\n\n\uff14\uff09Alerts Condition\u306e\u4f5c\u6210\n\u30a2\u30e9\u30fc\u30c8\u6761\u4ef6\u3092\u8a2d\u5b9a\u3057\u307e\u3059\n\n\uff15\uff09Channel\u306e\u9078\u629e\n\u5148\u307b\u3069\u4f5c\u6210\u3057\u305fStackStom\u306eWebhook\u306eChannel\u3092\u9078\u629e\u3057\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\n\u3053\u308c\u3067New Relic\u304b\u3089\u306eAlerts\u3092\u30c8\u30ea\u30ac\u30fc\u306bStackStorm\u3067\u9023\u643a\u3059\u308b\u4e8b\u304c\u3067\u304d\u307e\u3057\u305f\u3002\n![image](https://qiita-image-store.s3.amazonaws.com/0/150422/8ac681f4-ca81-9e0b-7df2-29c7893cc12f.png)\n#\u306f\u3058\u3081\u306b\n\u524d\u56de\u306f[AWS\u306bStackStorm\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb](http://qiita.com/KUROPON/items/eaa0090e2be3e7e7d412)\u3057\u305f\u306e\u3067\u3001\u4eca\u56de\u306f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u76e3\u8996\u30c4\u30fc\u30eb\u3067\u3042\u308bNew Relic\u3068\u9023\u643a\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\nStackStorm\u306b\u306f\u3001Pack\u3068\u547c\u3070\u308c\u308b\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u30b3\u30f3\u30dd\u30fc\u30cd\u30f3\u30c8\u306e\u8ffd\u52a0\u6a5f\u80fd\u304c\u3042\u308a\u3001[New Relic\u306ePack](https://github.com/StackStorm/st2contrib/tree/master/packs/newrelic)\u3082\u7528\u610f\u3055\u308c\u3066\u3044\u307e\u3059\u3002\u4eca\u56de\u306fPack\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304b\u3089\u4f7f\u3044\u65b9\u307e\u3067\u7d39\u4ecb\u3057\u307e\u3059\u3002\n\nNew Relic\u306b\u95a2\u3057\u3066\u306f\u3001\u4e0b\u8a18\u8a18\u4e8b\u3092\u53c2\u8003\u306b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n[New Relic\u306eAPM\u3068INFRASTRUCTURE\u3092\u4f7f\u3063\u3066\u76e3\u8996\u3057\u3066\u307f\u307e\u3057\u305f\uff08\u524d\u534a\uff09](http://qiita.com/KUROPON/items/d62b7bba04e421860dda)\n[New Relic\u306eAPM\u3068INFRASTRUCTURE\u3092\u4f7f\u3063\u3066\u76e3\u8996\u3057\u3066\u307f\u307e\u3057\u305f\uff08\u5f8c\u534a\uff09](http://qiita.com/KUROPON/items/c5a6e0aff2fd8b850da0)\n\n# StackStom\u306e\u8a2d\u5b9a\n## New Relic Pack\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u4e0b\u8a18st2\u30b3\u30de\u30f3\u30c9\u3067NewRelic\u306ePack\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002status\u304csucceeded\u306b\u306a\u3063\u3066\u3044\u305f\u3089\u6210\u529f\u3067\u3059\u3002\n\n```\n$ st2 run packs.install packs=newrelic\n......................\nid: 586df3da897d4405b3b07f36\naction.ref: packs.install\nparameters:\n  packs:\n  - newrelic\nstatus: succeeded\nstart_timestamp: 2017-01-05T07:20:58.022719Z\nend_timestamp: 2017-01-05T07:23:13.100056Z\n+--------------------------+-------------------------+--------------------------+-------------------------+------------------------------+\n| id                       | status                  | task                     | action                  | start_timestamp              |\n+--------------------------+-------------------------+--------------------------+-------------------------+------------------------------+\n| 586df3da897d440342b8b6ba | succeeded (7s elapsed)  | download                 | packs.download          | Thu, 05 Jan 2017 07:20:58    |\n|                          |                         |                          |                         | UTC                          |\n| 586df3e2897d440342b8b6bd | succeeded (3s elapsed)  | virtualenv_prerun        | packs.virtualenv_prerun | Thu, 05 Jan 2017 07:21:06    |\n|                          |                         |                          |                         | UTC                          |\n| 586df3e5897d440342b8b6c0 | succeeded (56s elapsed) | setup_virtualenv         | packs.setup_virtualenv  | Thu, 05 Jan 2017 07:21:09    |\n|                          |                         |                          |                         | UTC                          |\n| 586df41e897d440342b8b6c4 | succeeded (63s elapsed) | reload                   | packs.load              | Thu, 05 Jan 2017 07:22:06    |\n|                          |                         |                          |                         | UTC                          |\n| 586df45e897d440342b8b6c8 | succeeded (2s elapsed)  | restart-sensor-container | packs.restart_component | Thu, 05 Jan 2017 07:23:10    |\n|                          |                         |                          |                         | UTC                          |\n+--------------------------+-------------------------+--------------------------+-------------------------+------------------------------+\n```\n\n## New Relic Pack\u306e\u78ba\u8a8d\n\n1) \u30bb\u30f3\u30b5\u30fc\u78ba\u8a8d\n\n```\n$ st2 sensor list\n+---------------------------------+----------+---------------------------------+---------+\n| ref                             | pack     | description                     | enabled |\n+---------------------------------+----------+---------------------------------+---------+\n| newrelic.NewRelicHookSensor     | newrelic | Sensor which watches for alerts | True    |\n|                                 |          | from NewRelic API.              |         |\n| newrelic.LegacyNewRelicHookSens | newrelic | Sensor which watches for alerts | False   |\n| or                              |          | from the NewRelic legacy API.   |         |\n+---------------------------------+----------+---------------------------------+---------+\n```\n\n2)\u30c8\u30ea\u30ac\u30fc\u78ba\u8a8d\n\n```\n$ st2 trigger list\n+--------------------------------------+----------+-------------------------------------------+\n| ref                                  | pack     | description                               |\n+--------------------------------------+----------+-------------------------------------------+\n| newrelic.WebAppAlertTrigger          | newrelic |                                           |\n| newrelic.WebAppNormalTrigger         | newrelic |                                           |\n| newrelic.ServerAlertTrigger          | newrelic |                                           |\n| newrelic.ServerNormalTrigger         | newrelic |                                           |\n+--------------------------------------+----------+-------------------------------------------+\n```\n\n3)\u30a2\u30af\u30b7\u30e7\u30f3\u78ba\u8a8d\n\n```\n$ st2 action list | grep new\n+---------------------------------+----------+-------------------------------------------+\n| ref                             | pack     | description                               |\n+---------------------------------+----------+-------------------------------------------+\n| newrelic.get_alerts             | newrelic | Get alerts for app.                       |\n| newrelic.get_metric_data        | newrelic | Get metric data for metric.               |\n```\n\n\n## New Relic Pack\u306e\u8a2d\u5b9a\n1) \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u30b3\u30d4\u30fc\nNew Relic\u306ePack\u306f\u3001\u4e0b\u8a18\u30d5\u30a9\u30eb\u30c0\u30fc\u306b\u4fdd\u5b58\u3055\u308c\u308b\u306e\u3067\u3001\n\n`/opt/stackstorm/packs/newrelic/`\n\n\u30b5\u30f3\u30d7\u30eb\u30d5\u30a1\u30a4\u30eb\u304b\u3089\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\n\n```\ncd /opt/stackstorm/configs\ncp /opt/stackstorm/packs/newrelic/newrelic.yaml.example ./newrelic.yaml\n```\n\n2) \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u7de8\u96c6\n\u30c7\u30d5\u30a9\u30eb\u30c8\u3060\u3068Base URL\u304c\u3001http://x.x.x.x:10001/st2/nrhook/\u306b\u306a\u308a\u307e\u3059\n\n```\n$vim ./newrelic.yaml\n---\napi_url: \"https://api.newrelic.com/v2/\"\napi_key: \"<New Relic\u306eAPI\u30ad\u30fc\u3092\u5165\u529b\u3057\u307e\u3059>\"\nsensor_config:\n    host: \"0.0.0.0\"\n    port: 10001\n    url: \"/st2/nrhook/\"\n    normal_report_delay: 300\n```\n\n3) st2 \u518d\u8d77\u52d5\n\u8a2d\u5b9a\u3092\u6709\u52b9\u306b\u3059\u308b\u305f\u3081\u306bStackStorm\u3092\u518d\u8d77\u52d5\u3057\u307e\u3059\n\n`$ st2ctl reload`\n\n4) TCP\u30dd\u30fc\u30c8\u8d77\u52d5\u78ba\u8a8d\nNew Relic\u306eSenser\u304c\u8d77\u52d5\u3059\u308b\u3068\u3001TCP\u306e10001\u756a\u3067Listen\u3057\u307e\u3059\n\n```\n$ netstat -ln | grep 10001\ntcp        0      0 0.0.0.0:10001           0.0.0.0:*               LISTEN\n```\n## \u30eb\u30fc\u30eb\u4f5c\u6210\nNew Relic\u304b\u3089\u9001\u4fe1\u3055\u308c\u305f\u30a2\u30e9\u30fc\u30c8\u5185\u5bb9\u3092\u3001\u30d5\u30a1\u30a4\u30eb(st2.newrelic.out)\u306b\u51fa\u529b\u3059\u308b\u30eb\u30fc\u30eb\u3092\u4f5c\u6210\n\n1) APM\u30a2\u30e9\u30fc\u30c8\u7528\u30eb\u30fc\u30eb\u4f5c\u6210\n\n```\n$ cd /opt/stackstorm/packs/newrelic/rules/\n$ vim webapp_notify.yaml\n---\nname: \"webapp.notify\"\npack: \"newrelic\"\ndescription: \"WebAppAlertTrigger Sample rule for newrelic.\"\nenabled: true\n\ntrigger:\n    type: \"newrelic.WebAppAlertTrigger\"\n\ncriteria: {}\n\naction:\n    ref: \"core.local\"\n    parameters:\n        cmd: \"echo {{ trigger.alert }} >> ~/st2.newrelic.out\"\n```\n\n2) Servers\u30a2\u30e9\u30fc\u30c8\u7528\u30eb\u30fc\u30eb\u4f5c\u6210\n\n```\n$ vim server_notify.yaml\n---\nname: \"server.notify\"\npack: \"newrelic\"\ndescription: \"ServerAlertTrigger Sample rule for newrelic.\"\nenabled: true\n\ntrigger:\n    type: \"newrelic.ServerAlertTrigger\"\n\ncriteria: {}\n\naction:\n    ref: \"core.local\"\n    parameters:\n        cmd: \"echo {{ trigger.alert }} >> ~/st2.newrelic.out\"\n```\n\n3)st2\u30eb\u30fc\u30eb\u4f5c\u6210\n\n```\nst2 rule create /opt/stackstorm/packs/newrelic/rules/webapp_notify.yaml\nst2 rule create /opt/stackstorm/packs/newrelic/rules/server_notify.yaml\n```\n\n4)st2\u30eb\u30fc\u30eb\u78ba\u8a8d\n\n```\n$ st2 rule list\n+------------------------+----------+-----------------------------------------+---------+\n| ref                    | pack     | description                             | enabled |\n+------------------------+----------+-----------------------------------------+---------+\n| newrelic.server.notify | newrelic | ServerAlertTrigger Sample rule for      | True    |\n|                        |          | newrelic.                               |         |\n| newrelic.webapp.notify | newrelic | WebAppAlertTrigger Sample rule for      | True    |\n|                        |          | newrelic.                               |         |\n+------------------------+----------+-----------------------------------------+---------+\n\n```\n\n## \u52d5\u4f5c\u78ba\u8a8d\nStackStom\u304b\u3089\u81ea\u5206\u5b9b(127.0.0.1)\u306b\u30c6\u30b9\u30c8\u7528\u306e\u30a2\u30e9\u30fc\u30c8\u3092\u9001\u4fe1\u3057\u3066\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n1) APM\u30a2\u30e9\u30fc\u30c8\u78ba\u8a8d\u7528\n\n```\ncurl -X POST \\\n    -H 'Content-Type:application/json; charset=UTF-8' \\\n    -d '{ \n    \"current_state\":\"open\",\n    \"details\":\"Apdex < .50 for at least 10 min\",\n    \"severity\":\"CRITICAL\",\n    \"event_type\":\"INCIDENT\",\n    \"targets\":[{\n        \"product\": \"APM\", \n        \"name\": \"TEST APM\",\n        \"labels\": {}, \n        \"type\": \"Application\", \n        \"id\": \"123456789\"\n        }]\n    }' \\\nhttp://127.0.0.1:10001/st2/nrhook/\n```\n\n2) Servers\u30a2\u30e9\u30fc\u30c8\u78ba\u8a8d\u7528\n\n```\ncurl -X POST \\\n    -H 'Content-Type:application/json; charset=UTF-8' \\\n    -d '{ \n    \"current_state\":\"open\",\n    \"details\":\"System load > 0.1 for at least 5 minutes\",\n    \"severity\":\"CRITICAL\",\n    \"event_type\":\"INCIDENT\",\n    \"targets\":[{\n        \"product\": \"SERVERS\", \n        \"name\": \"TEST Servers\",\n        \"labels\": {}, \n        \"type\": \"Server\", \n        \"id\": \"123456789\"\n        }]\n    }' \\\nhttp://127.0.0.1:10001/st2/nrhook/\n```\n3) \u30a2\u30e9\u30fc\u30c8\u5185\u5bb9\u306e\u78ba\u8a8d\n\n```\n$ tail /home/stanley/st2.newrelic.out\n{uevent_type: uINCIDENT, udetails: uApdex < .50 for at least 10 min, ucurrent_state: uopen, utargets: [{uproduct: uAPM, ulabels: {}, utype: uApplication, uname: uTEST APM, uid: u123456789}], useverity: uCRITICAL}\n{uevent_type: uINCIDENT, udetails: uSystem load > 0.1 for at least 5 minutes, ucurrent_state: uopen, utargets: [{uproduct: uSERVERS, ulabels: {}, utype: uServer, uname: uTEST Servers, uid: u123456789}], useverity: uCRITICAL}\n```\n\n# AWS\u306e\u8a2d\u5b9a\n\n\uff11\uff09\u30bb\u30ad\u30e5\u30ea\u30c6\u30a4\u2015\u30b0\u30eb\u30fc\u30d7\u306e\u8ffd\u52a0\n\u5916\u90e8(New Relic)\u304b\u3089TCP:10001\u306e\u63a5\u7d9a\u304c\u3067\u304d\u308b\u3088\u3046\u30bb\u30ad\u30e5\u30ea\u30c6\u30a4\u2015\u30b0\u30eb\u30fc\u30d7\u3092\u5909\u66f4\n[New Relic Document](https://docs.newrelic.com/docs/apm/new-relic-apm/getting-started/networks)\u306eWebhook alerts\u9805\u76ee\u306b\u30a2\u30e9\u30fc\u30c8\u306e\u9001\u4fe1\u5143IP\u304c\u8a18\u8f09\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u5fc5\u8981\u3067\u3042\u308c\u3070\u9001\u4fe1\u5143\u3092\u5236\u9650\u3057\u307e\u3059\u3002\n\n```\nWebhook alerts\nNew Relic-generated webhooks for alert policies will be sent from an IP address in the 50.31.164.0/24 or 162.247.240.0/22 network block.\n```\n\n# New Relic Alerts\u306e\u8a2d\u5b9a\n\n\uff11\uff09Alerts\u306eNotification Channel\u306e\u8ffd\u52a0\n![image](https://qiita-image-store.s3.amazonaws.com/0/150422/f552d11f-3aea-8b4d-1091-3fb02f3ca5e1.png)\n\n\uff12\uff09Channel\u306e\u8a2d\u5b9a\nStackStom\u306e\u5f85\u3061\u53d7\u3051\u30dd\u30fc\u30c8(10001/tcp)\u306b\u5bfe\u3057\u3066Webhook\u306e\u8a2d\u5b9a\u3092\u3057\u307e\u3059\u3002\n![image](https://qiita-image-store.s3.amazonaws.com/0/150422/1b63c34b-4167-9203-46eb-b7c33d169cee.png)\n\n\uff13\uff09Alert Policy\u306e\u4f5c\u6210\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/150422/e32d8bba-0613-9a65-9175-fff2a2fc9f7b.png)\n\n\uff14\uff09Alerts Condition\u306e\u4f5c\u6210\n\u30a2\u30e9\u30fc\u30c8\u6761\u4ef6\u3092\u8a2d\u5b9a\u3057\u307e\u3059\n![image](https://qiita-image-store.s3.amazonaws.com/0/150422/9c13b91d-d77d-2186-f3d5-6c113dd2d220.png)\n\n\uff15\uff09Channel\u306e\u9078\u629e\n\u5148\u307b\u3069\u4f5c\u6210\u3057\u305fStackStom\u306eWebhook\u306eChannel\u3092\u9078\u629e\u3057\u8ffd\u52a0\u3057\u307e\u3059\u3002\n![image](https://qiita-image-store.s3.amazonaws.com/0/150422/6a34829f-c46f-066c-9d4d-c8164158fd7c.png)\n\n\u3053\u308c\u3067New Relic\u304b\u3089\u306eAlerts\u3092\u30c8\u30ea\u30ac\u30fc\u306bStackStorm\u3067\u9023\u643a\u3059\u308b\u4e8b\u304c\u3067\u304d\u307e\u3057\u305f\u3002\n\n", "tags": ["stackstorm", "newrelic", "AWS"]}