{"tags": ["Rails", "CSV", "Ruby", "RSpec"], "context": " More than 1 year has passed since last update.\n\n\u7d4c\u7def\n\n.ruby template handler\u3092\u4f7f\u7528\u3059\u308b\u3068CSV\u95a2\u9023\u306e\u30ed\u30b8\u30c3\u30af\u3092\u7dba\u9e97\u306b\u30e2\u30c7\u30eb\u304b\u3089\u5206\u96e2\u3067\u304d\u308b\u3068\u77e5\u308a\u8abf\u67fb\u3002\n\u4eca\u5f8c\u306e\u305f\u3081\u306b\u30e1\u30e2\u3002\n\n\n\u3084\u308a\u305f\u3044\u3053\u3068\n\nUsers\u30c6\u30fc\u30d6\u30eb\u306e\u30c7\u30fc\u30bf\u3092CSV\u3068\u3057\u3066\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u3057\u305f\u3044\u3002\n\u30d3\u30e5\u30fc\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306b\u5b9f\u88c5\u3057\u305f\u3044\u3002\n\n\n\u3053\u306e\u65b9\u6cd5\u306e\u9577\u6240\n\n\u30d3\u30e5\u30fc\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306b\u5b9f\u88c5\u3059\u308b\u3068\u3001\uff08\u4f55\u3082\u3057\u306a\u304f\u3066\u3082\uff09\u30d3\u30e5\u30fc\u30d8\u30eb\u30d1\u30fc\u30e1\u30bd\u30c3\u30c9\u306b\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\u3002\n\u30e2\u30c7\u30eb\u306b\u5b9f\u88c5\u3057\u306a\u3044\u306e\u3067\u3001\u30e2\u30c7\u30eb\u3092\u30b3\u30f3\u30d1\u30af\u30c8\u306b\u3067\u304d\u308b\u3002\n\n\u4f8b\uff1arailscasts/379-template-handlers\nresponse.headers[\"Content-Disposition\"] = 'attachment; filename=\"products.csv\"'\n\nCSV.generate do |csv|\n  csv << [\"Name\", \"Price\", \"URL\"]\n  @products.each do |product|\n    csv << [\n      product.name,\n      number_to_currency(product.price),\n      product_url(product)\n    ]\n  end\nend\n\n\n\u74b0\u5883\n\nRuby 2.2.1\nRails 4.2.3\n\n\n\u624b\u9806\n\n/config/application.rb\u3067CSV\u30e2\u30b8\u30e5\u30fc\u30eb\u3092require\n\n\n/config/application.rb\nrequire File.expand_path('../boot', __FILE__)\n\nrequire 'csv'\nrequire 'rails/all'\n\n# ...\n\n\n\n\u30d8\u30c3\u30c0\u30fc\u3092\u8a2d\u5b9a\u3059\u308b\u305f\u3081\u306e\u30e1\u30bd\u30c3\u30c9\n\n\nActionController::Streaming::send_file_headers!\u3092\u53c2\u8003\u306b\u3057\u305f\u3002\n\u7d30\u304b\u3044\u8a18\u8ff0\u65b9\u6cd5\u3092\u6c17\u306b\u3057\u306a\u304f\u3066\u3088\u304f\u306a\u308b\u3002\n\u5fc5\u8981\u306a\u30c7\u30fc\u30bf\u306e\u6e21\u3057\u5fd8\u308c\u3092\u9632\u3052\u308b\u3002\n\n\n/app/helpers/csv_helper.rb\nmodule CsvHelper\n\n  def set_file_headers(options)\n\n    [:filename, :disposition].each do |arg|\n      raise ArgumentError, \":#{arg} option required\" if options[arg].nil?\n    end\n\n    disposition = options[:disposition]\n    disposition += %(; filename=\"#{options[:filename]}\") if options[:filename]\n\n    headers.merge!(\n      'Content-Disposition'       => disposition,\n      'Content-Transfer-Encoding' => 'binary'\n    )\n  end\nend\n\n\n\n\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u3057\u305f\u3044\u30c7\u30fc\u30bf\u3092\u30af\u30a8\u30ea\n\n/app/controllers/users_controller.rb\nclass UsersController < ApplicationController\n  include CsvHelper\n  # ...\n\n  def index\n    @users = User.all\n  end\n\n  # ...\nend\n\n\n\n*.csv.ruby\u30d5\u30a1\u30a4\u30eb\u3092\u65b0\u898f\u4f5c\u6210\u3057\u3001CSV\u51e6\u7406\u3092\u30d3\u30e5\u30fc\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3068\u3057\u3066\u5b9f\u88c5\n\n/app/views/users/index.csv.ruby\n# ==> 1. Set response headers\n# http://api.rubyonrails.org/classes/ActionDispatch/Request.html#method-i-headers\nset_file_headers filename:    \"users-#{Date.today}.csv\",\n                 disposition: \"attachment\"\n\n# ==> 2. Set options if you want (e.g. :col_sep, :headers, etc)\n# http://ruby-doc.org/stdlib-2.0.0/libdoc/csv/rdoc/CSV.html#DEFAULT_OPTIONS\noptions = { headers: true }\n\n# ==> 3. Generate csv that is to be downloaded\n\nattributes = %w(id username sign_in_count created_at confirmed_at updated_at)\n\nCSV.generate(options) do |csv|\n  # Column names in a first row\n  csv << attributes\n\n  # Write each record as an array of strings\n  @users.unscoped.each do |user|\n    csv << attributes.map{ |attr| user.send(attr) }\n  end\nend\n\n\n\nusers_path(format: \"csv\")\u3078\u306e\u30ea\u30f3\u30af\u3092\u597d\u304d\u306a\u3068\u3053\u308d\u306b\u8a2d\u7f6e\n\n/app/views/users/index.html.haml\n= link_to \"CSV\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\", users_path(format: \"csv\"), class: \"btn btn-warning\"\n\n\n\n\u5b9f\u969b\u306b\u51fa\u529b\u3055\u308c\u305f\u30c7\u30fc\u30bf\n\"<pre class=\\\"debug_dump\\\"><kbd style=\\\"color:brown\\\">&quot;id,username,sign_in_count,created_at,confirmed_at,updated_at\\\\n1,Masa Nishiguchi,2,2015-07-30 20:30:25 UTC,2015-07-30 20:30:24 UTC,2015-08-02 22:07:55 UTC\\\\n2,Elton Gottlieb,0,2015-07-30 20:30:25 UTC,2015-07-30 20:30:25 UTC,2015-07-30 20:30:25 UTC\\\\n3, (...\u4e2d\u7565...) ,Elroy Howe,1,2015-07-30 20:30:25 UTC,2015-07-30 20:30:25 UTC,2015-07-31 13:40:07 UTC\\\\n&quot;</kbd></pre>\"\n\n\n\n\u30c6\u30b9\u30c8\nRSpec\u306e\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30b9\u30da\u30c3\u30af\u306f\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u72b6\u614b\u3067\u306fresponse.body\u304c\u7a7a\u306b\u306a\u3063\u3066\u304a\u308aresponse.body\u306b\u3088\u308bCSV\u5185\u5bb9\u78ba\u8a8d\u306f\u4e0d\u53ef\u80fd\u3002\nrender_views\u3092\u7528\u3044\u3066\u5f37\u5236\u7684\u306brspec\u306b\u30d3\u30e5\u30fc\u3092\u751f\u6210\u3055\u305b\u308b\u3053\u3068\u304c\u53ef\u80fd\u3068\u3044\u3046\u3053\u3068\u3092\u77e5\u308a\u3001\u4e0b\u8a18\u306e\u30c6\u30b9\u30c8\u3092\u4f5c\u6210\u3002\n\uff08@hidakatsuya\u3055\u3093\u3001\u60c5\u5831\u3042\u308a\u304c\u3068\u3046\u3054\u3056\u3044\u307e\u3057\u305f\u3002\uff09\n\n/spec/controllers/users_controller_spec.rb\nRSpec.describe UsersController, type: :controller do\n  # ...\n\n  describe \"admin user\" do\n    before { log_in_as FactoryGirl.create(:admin), no_capybara: :true }\n\n    describe 'GET #index' do\n\n      before(:all) { 10.times { FactoryGirl.create(:user) } }\n\n      it \"renders the index page\" do\n        get :index\n        expect(response).to render_template :index\n      end\n\n      describe \"CSV format\" do\n        render_views  #<== \u5f37\u5236\u7684\u306brspec\u306b\u30d3\u30e5\u30fc\u3092\u751f\u6210\u3055\u305b\u308b\n\n        before { get :index, format: \"csv\" }\n\n        let(:user) { User.first}\n\n        it { expect(response).to render_template :index }\n        it { expect(response.headers[\"Content-Type\"]).to include \"text/csv\" }\n\n        attributes = %w(id username sign_in_count created_at confirmed_at updated_at)\n\n        attributes.each do |field|\n          it \"has column name - #{field}\" do\n            expect(response.body).to include field\n          end\n        end\n\n        attributes.each do |field|\n          it \"has correct value for #{field}\" do\n            expect(response.body).to include user[field].to_s\n          end\n        end\n\n        it \"has correct number of rows\" do\n          num_of_rows = 1 + User.all.count\n          expect(response.body.split(/\\n/).size).to eq num_of_rows\n        end\n      end\n    end\n\n    # ...\n  end\nend\n\n\n\n\u30b7\u30f3\u30d7\u30eb\u306a\u30c6\u30b9\u30c8\u306e\u4f8b\n\nblue_csv/test/blue_csv_test.rb\n\n\n\u8cc7\u6599\nRuby CSV library\n\nRuby CSV\nA Guide to the Ruby CSV Library, Part I\n\nCSV export\n\nRailscasts #362 Exporting Csv And Excel\nRailscasts #362 Exporting Csv And Excel - YouTube\nGoRails #45 Exporting Records To CSV\n\nTemplate Handlers\n\nRailscasts PRO #379 Template Handlers (pro)\nRailscasts PRO #379 Template Handlers (pro) - YouTube\n\nRails\n\nrails/actionview/lib/action_view/template/handlers.rb\nrails/ActionController/Streaming/DEFAULT_SEND_FILE_OPTIONS\nrails/ActionController/Streaming/send_file\nrails/ActionController/Streaming/send_file_headers!\n\n.rb template handler\u304c.ruby\u306b\u5909\u66f4\u3055\u308c\u305f\u7d4c\u7def\n\nRename .rb template handler to .ruby to avoid conflicts with mustache\u2026\n\nRSpec\n\nrender_views\n\n![Screenshot 2015-08-03 16.24.10.png](https://qiita-image-store.s3.amazonaws.com/0/82804/0e9d65ee-b8d7-61c0-1ab4-e77041553573.png)\n\n#\u7d4c\u7def\n- .ruby template handler\u3092\u4f7f\u7528\u3059\u308b\u3068CSV\u95a2\u9023\u306e\u30ed\u30b8\u30c3\u30af\u3092\u7dba\u9e97\u306b\u30e2\u30c7\u30eb\u304b\u3089\u5206\u96e2\u3067\u304d\u308b\u3068\u77e5\u308a\u8abf\u67fb\u3002\n- \u4eca\u5f8c\u306e\u305f\u3081\u306b\u30e1\u30e2\u3002\n\n#\u3084\u308a\u305f\u3044\u3053\u3068\n- Users\u30c6\u30fc\u30d6\u30eb\u306e\u30c7\u30fc\u30bf\u3092CSV\u3068\u3057\u3066\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u3057\u305f\u3044\u3002\n- \u30d3\u30e5\u30fc\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306b\u5b9f\u88c5\u3057\u305f\u3044\u3002\n\n#\u3053\u306e\u65b9\u6cd5\u306e\u9577\u6240\n\n- \u30d3\u30e5\u30fc\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306b\u5b9f\u88c5\u3059\u308b\u3068\u3001\uff08\u4f55\u3082\u3057\u306a\u304f\u3066\u3082\uff09[\u30d3\u30e5\u30fc\u30d8\u30eb\u30d1\u30fc\u30e1\u30bd\u30c3\u30c9](http://api.rubyonrails.org/classes/ActionView/Helpers.html)\u306b\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\u3002\n- \u30e2\u30c7\u30eb\u306b\u5b9f\u88c5\u3057\u306a\u3044\u306e\u3067\u3001\u30e2\u30c7\u30eb\u3092\u30b3\u30f3\u30d1\u30af\u30c8\u306b\u3067\u304d\u308b\u3002\n\n\u4f8b\uff1a[railscasts/379-template-handlers](https://github.com/railscasts/379-template-handlers/blob/master/store-after/app/views/products/index.csv.rb)\n\n```rb\nresponse.headers[\"Content-Disposition\"] = 'attachment; filename=\"products.csv\"'\n\nCSV.generate do |csv|\n  csv << [\"Name\", \"Price\", \"URL\"]\n  @products.each do |product|\n    csv << [\n      product.name,\n      number_to_currency(product.price),\n      product_url(product)\n    ]\n  end\nend\n```\n\n\n#\u74b0\u5883\n- Ruby 2.2.1\n- Rails 4.2.3\n\n#\u624b\u9806\n\n###`/config/application.rb`\u3067CSV\u30e2\u30b8\u30e5\u30fc\u30eb\u3092`require`\n\n```rb:/config/application.rb\nrequire File.expand_path('../boot', __FILE__)\n\nrequire 'csv'\nrequire 'rails/all'\n\n# ...\n```\n\n# \u30d8\u30c3\u30c0\u30fc\u3092\u8a2d\u5b9a\u3059\u308b\u305f\u3081\u306e\u30e1\u30bd\u30c3\u30c9\n\n- [ActionController::Streaming::send_file_headers!](http://apidock.com/rails/ActionController/Streaming/send_file_headers!)\u3092\u53c2\u8003\u306b\u3057\u305f\u3002\n- \u7d30\u304b\u3044\u8a18\u8ff0\u65b9\u6cd5\u3092\u6c17\u306b\u3057\u306a\u304f\u3066\u3088\u304f\u306a\u308b\u3002\n- \u5fc5\u8981\u306a\u30c7\u30fc\u30bf\u306e\u6e21\u3057\u5fd8\u308c\u3092\u9632\u3052\u308b\u3002\n\n```rb:/app/helpers/csv_helper.rb\nmodule CsvHelper\n\n  def set_file_headers(options)\n\n    [:filename, :disposition].each do |arg|\n      raise ArgumentError, \":#{arg} option required\" if options[arg].nil?\n    end\n\n    disposition = options[:disposition]\n    disposition += %(; filename=\"#{options[:filename]}\") if options[:filename]\n\n    headers.merge!(\n      'Content-Disposition'       => disposition,\n      'Content-Transfer-Encoding' => 'binary'\n    )\n  end\nend\n```\n\n###\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u3057\u305f\u3044\u30c7\u30fc\u30bf\u3092\u30af\u30a8\u30ea\n\n```rb:/app/controllers/users_controller.rb\nclass UsersController < ApplicationController\n  include CsvHelper\n  # ...\n\n  def index\n    @users = User.all\n  end\n\n  # ...\nend\n```\n\n###`*.csv.ruby`\u30d5\u30a1\u30a4\u30eb\u3092\u65b0\u898f\u4f5c\u6210\u3057\u3001CSV\u51e6\u7406\u3092\u30d3\u30e5\u30fc\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3068\u3057\u3066\u5b9f\u88c5\n\n```rb:/app/views/users/index.csv.ruby\n# ==> 1. Set response headers\n# http://api.rubyonrails.org/classes/ActionDispatch/Request.html#method-i-headers\nset_file_headers filename:    \"users-#{Date.today}.csv\",\n                 disposition: \"attachment\"\n\n# ==> 2. Set options if you want (e.g. :col_sep, :headers, etc)\n# http://ruby-doc.org/stdlib-2.0.0/libdoc/csv/rdoc/CSV.html#DEFAULT_OPTIONS\noptions = { headers: true }\n\n# ==> 3. Generate csv that is to be downloaded\n\nattributes = %w(id username sign_in_count created_at confirmed_at updated_at)\n\nCSV.generate(options) do |csv|\n  # Column names in a first row\n  csv << attributes\n\n  # Write each record as an array of strings\n  @users.unscoped.each do |user|\n    csv << attributes.map{ |attr| user.send(attr) }\n  end\nend\n```\n\n###`users_path(format: \"csv\")`\u3078\u306e\u30ea\u30f3\u30af\u3092\u597d\u304d\u306a\u3068\u3053\u308d\u306b\u8a2d\u7f6e\n\n```rb:/app/views/users/index.html.haml\n= link_to \"CSV\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\", users_path(format: \"csv\"), class: \"btn btn-warning\"\n```\n\n###\u5b9f\u969b\u306b\u51fa\u529b\u3055\u308c\u305f\u30c7\u30fc\u30bf\n```rb\n\"<pre class=\\\"debug_dump\\\"><kbd style=\\\"color:brown\\\">&quot;id,username,sign_in_count,created_at,confirmed_at,updated_at\\\\n1,Masa Nishiguchi,2,2015-07-30 20:30:25 UTC,2015-07-30 20:30:24 UTC,2015-08-02 22:07:55 UTC\\\\n2,Elton Gottlieb,0,2015-07-30 20:30:25 UTC,2015-07-30 20:30:25 UTC,2015-07-30 20:30:25 UTC\\\\n3, (...\u4e2d\u7565...) ,Elroy Howe,1,2015-07-30 20:30:25 UTC,2015-07-30 20:30:25 UTC,2015-07-31 13:40:07 UTC\\\\n&quot;</kbd></pre>\"\n```\n\n![Screenshot 2015-08-03 16.32.49.png](https://qiita-image-store.s3.amazonaws.com/0/82804/42a149db-0ae6-ac5d-1405-000dc22ffb82.png)\n\n#\u30c6\u30b9\u30c8\n\nRSpec\u306e\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30b9\u30da\u30c3\u30af\u306f\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u72b6\u614b\u3067\u306fresponse.body\u304c\u7a7a\u306b\u306a\u3063\u3066\u304a\u308aresponse.body\u306b\u3088\u308bCSV\u5185\u5bb9\u78ba\u8a8d\u306f\u4e0d\u53ef\u80fd\u3002\n\n[render_views](https://www.relishapp.com/rspec/rspec-rails/docs/controller-specs/render-views)\u3092\u7528\u3044\u3066\u5f37\u5236\u7684\u306brspec\u306b\u30d3\u30e5\u30fc\u3092\u751f\u6210\u3055\u305b\u308b\u3053\u3068\u304c\u53ef\u80fd\u3068\u3044\u3046\u3053\u3068\u3092\u77e5\u308a\u3001\u4e0b\u8a18\u306e\u30c6\u30b9\u30c8\u3092\u4f5c\u6210\u3002\n\uff08@hidakatsuya\u3055\u3093\u3001\u60c5\u5831\u3042\u308a\u304c\u3068\u3046\u3054\u3056\u3044\u307e\u3057\u305f\u3002\uff09\n\n```rb:/spec/controllers/users_controller_spec.rb\nRSpec.describe UsersController, type: :controller do\n  # ...\n\n  describe \"admin user\" do\n    before { log_in_as FactoryGirl.create(:admin), no_capybara: :true }\n\n    describe 'GET #index' do\n\n      before(:all) { 10.times { FactoryGirl.create(:user) } }\n\n      it \"renders the index page\" do\n        get :index\n        expect(response).to render_template :index\n      end\n\n      describe \"CSV format\" do\n        render_views  #<== \u5f37\u5236\u7684\u306brspec\u306b\u30d3\u30e5\u30fc\u3092\u751f\u6210\u3055\u305b\u308b\n\n        before { get :index, format: \"csv\" }\n\n        let(:user) { User.first}\n\n        it { expect(response).to render_template :index }\n        it { expect(response.headers[\"Content-Type\"]).to include \"text/csv\" }\n\n        attributes = %w(id username sign_in_count created_at confirmed_at updated_at)\n\n        attributes.each do |field|\n          it \"has column name - #{field}\" do\n            expect(response.body).to include field\n          end\n        end\n\n        attributes.each do |field|\n          it \"has correct value for #{field}\" do\n            expect(response.body).to include user[field].to_s\n          end\n        end\n\n        it \"has correct number of rows\" do\n          num_of_rows = 1 + User.all.count\n          expect(response.body.split(/\\n/).size).to eq num_of_rows\n        end\n      end\n    end\n\n    # ...\n  end\nend\n```\n\n![Screenshot 2015-08-04 10.09.25.png](https://qiita-image-store.s3.amazonaws.com/0/82804/c8f40354-2440-1445-de69-1ac81bf01abb.png)\n\n\u30b7\u30f3\u30d7\u30eb\u306a\u30c6\u30b9\u30c8\u306e\u4f8b\n\n- [blue_csv/test/blue_csv_test.rb](https://github.com/rtsinani/blue_csv/blob/master/test/blue_csv_test.rb)\n\n#\u8cc7\u6599\n\nRuby CSV library\n\n- [Ruby CSV](http://ruby-doc.org/stdlib-2.0.0/libdoc/csv/rdoc/CSV.html)\n- [A Guide to the Ruby CSV Library, Part I](http://www.sitepoint.com/guide-ruby-csv-library-part/)\n\nCSV export\n\n- [Railscasts #362 Exporting Csv And Excel](http://railscasts.com/episodes/362-exporting-csv-and-excel)\n- [Railscasts #362 Exporting Csv And Excel - YouTube](https://www.youtube.com/watch?v=SelheZSdZj8)\n- [GoRails #45 Exporting Records To CSV](https://gorails.com/episodes/export-to-csv?autoplay=1)\n\n\nTemplate Handlers\n\n- [Railscasts PRO #379 Template Handlers (pro)](http://railscasts.com/episodes/379-template-handlers)\n- [Railscasts PRO #379 Template Handlers (pro) - YouTube] (https://www.youtube.com/watch?v=lEnw14mjhLk)\n\nRails\n\n- [rails/actionview/lib/action_view/template/handlers.rb](https://github.com/rails/rails/blob/master/actionview/lib/action_view/template/handlers.rb)\n- [rails/ActionController/Streaming/DEFAULT_SEND_FILE_OPTIONS](https://www.omniref.com/github/rails/docrails/1.1.0.RC1/symbols/ActionController::Streaming::DEFAULT_SEND_FILE_OPTIONS#line=9)\n- [rails/ActionController/Streaming/send_file]( http://apidock.com/rails/ActionController/Streaming/send_file)\n- [rails/ActionController/Streaming/send_file_headers!](http://apidock.com/rails/ActionController/Streaming/send_file_headers!)\n\n.rb template handler\u304c.ruby\u306b\u5909\u66f4\u3055\u308c\u305f\u7d4c\u7def\n\n- [Rename .rb template handler to .ruby to avoid conflicts with mustache\u2026](https://github.com/rails/rails/commit/de1060f4e02925c12004f2)\n\nRSpec\n\n- [render_views](https://www.relishapp.com/rspec/rspec-rails/docs/controller-specs/render-views)\n"}