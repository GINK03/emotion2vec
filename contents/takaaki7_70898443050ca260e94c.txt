{"tags": ["http2", "Node.js"], "context": " \u3053\u306e\u8a18\u4e8b\u306f\u6700\u7d42\u66f4\u65b0\u65e5\u304b\u30891\u5e74\u4ee5\u4e0a\u304c\u7d4c\u904e\u3057\u3066\u3044\u307e\u3059\u3002\u3053\u306e\u8a18\u4e8b\u306f\u3001http2 Advent Calendar 2015 \u306e21\u65e5\u76ee\u306e\u8a18\u4e8b\u3067\u3059\u3002\n\n\u306f\u3058\u3081\u306b\nHTTP/2\u306eNode.js\u3067\u306e\u5b9f\u88c5node-http2\u3092\u8aad\u3093\u3060\u306e\u3067\u3001\u30dd\u30a4\u30f3\u30c8\u3060\u3068\u601d\u3046\u3068\u3053\u308d\u306b\u3064\u3044\u3066\u5927\u307e\u304b\u306b\u66f8\u304d\u307e\u3059\u3002\n\nnode-http2\u3063\u3066\u3069\u3093\u306a\u611f\u3058\u306a\u306e\nHTTP/2\u306f\u3069\u3046\u3044\u3046\u98a8\u306b\u5b9f\u88c5\u3067\u304d\u308b\u306e\nNode.js\u306eStream API\u306e\u826f\u3044\u4f7f\u7528\u4f8b\u306a\u3044\u304b\u306a\n\n\u307f\u305f\u3044\u306a\u3053\u3068\u3092\u77e5\u308a\u305f\u3044\u4eba\u306e\u624b\u52a9\u3051\u306b\u306a\u308c\u3070\u3068\u601d\u3044\u307e\u3059\u3002\n\u6271\u3046node-http2\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u306f3.2\u3067\u3059\u3002\n\nStream API\nnode-http2\u3067\u306fNode.js\u306e\u4e3b\u8981\u306aAPI\u3067\u3042\u308bStream API\u304c\u3088\u304f\u4f7f\u308f\u308c\u3066\u3044\u307e\u3059\u3002\n\u5168\u304f\u77e5\u3089\u306a\u3044\u4eba\u306e\u305f\u3081\u306b\u6982\u8981\u3060\u3051\u307e\u3068\u3081\u307e\u3057\u305f\u3002\nHTTP/2\u306e\u91cd\u8981\u306a\u6982\u5ff5\u3068\u3057\u3066Stream\u304c\u3042\u308a\u307e\u3059\u304c\u305d\u308c\u3068Stream API\u306f\u5225\u306e\u3082\u306e\u3067\u3059\u3002\n\u4eca\u56de\u306f\u5358\u306bStream\u3068\u66f8\u3044\u305f\u5834\u5408\u306fHTTP/2\u3068\u3057\u3066\u306eStream\u3084\u305d\u306e\u5b9f\u88c5\u306eStream\u30af\u30e9\u30b9\u30fb\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u6307\u3057\u3001Stream API\u3001ReadableStream\u3001Readable\u306a\u3069\u3068\u66f8\u3044\u305f\u5834\u5408\u306fNode.js\u306eStream API\u3092\u6307\u3059\u3053\u3068\u306b\u3057\u307e\u3059\u3002\n\nnode-http2\n\u6d41\u308c\u3068\u3057\u3066\u91cd\u8981\u3060\u3068\u601d\u3063\u305f\u7b87\u6240\u3092\u30b6\u30c3\u30af\u30ea\u8aac\u660e\u3057\u307e\u3059\u3002\u8f09\u305b\u3066\u308b\u30b3\u30fc\u30c9\u306f\u6d41\u308c\u3092\u308f\u304b\u308a\u3084\u3059\u304f\u3059\u308b\u305f\u3081\u306b\u30e1\u30bd\u30c3\u30c9\u3084\u5909\u6570\u3092\u5c55\u958b\u3057\u305f\u308a\u8aac\u660e\u306b\u4e0d\u8981\u306a\u90e8\u5206\u306f\u7701\u7565\u3057\u305f\u308a\u3057\u305f\u306e\u3067\u5b9f\u969b\u306e\u3082\u306e\u3068\u306f\u5c11\u3057\u7570\u306a\u308a\u307e\u3059\u3002\n\u4e3b\u306b\u30b5\u30fc\u30d0\u5074\u306e\u51e6\u7406\u306a\u3069\u3092\u4f8b\u306b\u3057\u3066\u8aac\u660e\u3057\u307e\u3059\u3002\n\n\u968e\u5c64\nindex.js\nhttp.js\nprotocol/\n  index.js\n  endpoint.js\n  connection.js\n  stream.js\n  compressor.js\n  flow.js\n  framer.js\n\nindex\u306f\u4e3b\u306b\u30e2\u30b8\u30e5\u30fc\u30eb\u7ba1\u7406\u306e\u305f\u3081\u306e\u30d5\u30a1\u30a4\u30eb\u306a\u306e\u3067\u7279\u306b\u5927\u4e8b\u306a\u5b9f\u88c5\u306f\u3042\u308a\u307e\u305b\u3093\u3002\nprotocol/\u5185\u304cHTTP/2\u306e\u5b9f\u88c5\u3067\u3001http.js\u304c\u3053\u308c\u3092\u5229\u7528\u3057\u305f\u6c4e\u7528\u7684\u306aAPI\u3068\u3044\u3046\u611f\u3058\u3067\u3059\u3002\n\u4e3b\u306bhttp, endpoint, connection, stream, flow\u306b\u3064\u3044\u3066\u8aac\u660e\u3057\u307e\u3059\u3002\n\u8a73\u7d30\u306f\u7701\u304d\u307e\u3059\u304c\u3001compressor, framer\u306f\u305d\u308c\u305e\u308c\u5727\u7e2e\u30fb\u975e\u5727\u7e2e\u3068\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u30fb\u30c7\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u306e\u51e6\u7406\u3092\u3057\u307e\u3059\u3002\n\n\u30d5\u30a1\u30a4\u30eb\u3054\u3068\u306e\u8aac\u660e\n\n1 http\n\n1.1 API\u3068\u3057\u3066\u306e\u4f7f\u3044\u65b9\n\u30e6\u30fc\u30b6\uff08node-http2\u3092\u5229\u7528\u3059\u308b\u958b\u767a\u8005)\u5411\u3051\u306eAPI\u306e\u90e8\u5206\u3067\u3001Server, Agent\uff08\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\uff09, IncomingRequest, OutgoingResponse\u306a\u3069\u306e\u30af\u30e9\u30b9\u3084request(options,callback)\u306a\u3069\u306e\u30e1\u30bd\u30c3\u30c9\u304c\u516c\u958b\u3055\u308c\u3066\u3044\u307e\u3059\u3002\u4f7f\u3044\u65b9\u3068\u3057\u3066\u306f\u3001\u4f8b\u3048\u3070\u30b5\u30fc\u30d0\u5074\u306a\u3089\u6b21\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002(TLS\u3067\u306a\u304fTCP\u306e\u30d1\u30bf\u30fc\u30f3\u3092\u4f8b\u306b\u3057\u307e\u3059)\nserver = http2.createServer({\n    plain: true //TLS\u3067\u306f\u306a\u304fTCP\u3092\u6307\u5b9a\n  }, function onRequest(request, response) {\n    if(request.url === \"/first.js\"){\n      var push = response.push('/second.js');\n      push.writeHead(200);\n      fs.createReadStream(path.join(__dirname, '/second.js')).pipe(push);\n      fs.createReadStream(path.join(__dirname, '/first.js')).pipe(response);\n    }\n  });\n});\n\n\u8981\u6c42\u304c\u6765\u305f\u3068\u304donRequest\u306bWritableStream\u578b\u306eresponse\u304c\u6e21\u3055\u308c\u3066\u304d\u307e\u3059\u3002\n\u300cfirst.js\u304c\u8981\u6c42\u3055\u308c\u305f\u3068\u3044\u3046\u3053\u3068\u306fsecond.js\u3082\u5fc5\u8981\u304b\u3082\u3057\u308c\u306a\u3044\u300d\u3068\u3044\u3046\u306e\u304c\u308f\u304b\u308b\u5834\u5408\u306f\u4e0a\u306e\u3088\u3046\u306bpush('/second.js')\u3067push\u306eStream\u3092\u4f5c\u308a\u3001\u30c7\u30fc\u30bf\u3092\u66f8\u304d\u8fbc\u3093\u3067\u9001\u4fe1\u3059\u308c\u3070\u3044\u3044\u308f\u3051\u3067\u3059\u3002\n\n1.2 Server\u306e\u5b9f\u88c5\nServer\u30af\u30e9\u30b9\u306e\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u5185\u3067\u6b21\u306e\u3088\u3046\u306a\u51e6\u7406\u304c\u3042\u308a\u307e\u3059\u3002\nif (options.plain) {\n  this._mode = 'plain';\n\n  //TCP\u306e\u30b5\u30fc\u30d0\u3092\u7acb\u3061\u4e0a\u3052\u308b. TCP\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u304c\u78ba\u7acb\u3055\u308c\u305f\u6642 _start()\u304c\u547c\u3070\u308c\u308b\n  this._server = net.createServer(function _start(socket) {\n    var endpoint = new Endpoint(this._log, 'SERVER', this._settings);\n\n    endpoint.pipe(socket).pipe(endpoint); //(1)\n\n    var self = this;\n    endpoint.on('stream', function _onStream(stream) {  //(2)\n      var response = new OutgoingResponse(stream);\n      var request = new IncomingRequest(stream);\n      request.socket = socket;\n      request.once('ready', self.emit.bind(self, 'request', request, response));\n    });\n\n    this.emit('connection', socket, endpoint);\n  };);\n}\n\n(1)\u306eendpoint.pipe(socket).pipe(endpoint)\u3067socket\u3068endpoint\uff08\u5f8c\u8ff0\uff09\u306e\u30b9\u30c8\u30ea\u30fc\u30e0\u3092\u3064\u306a\u304e\u5408\u308f\u305b\u307e\u3059\u3002\nendpoint, socket\u306f\u5171\u306bDuplex(Readable\u3067Writable)\u3067\u3059\u3002Readable.pipe(Writable)\u306f\u53d7\u3051\u53d6\u3063\u305f\u5f15\u6570\u3092\u305d\u306e\u307e\u307e\u8fd4\u3059\u306e\u3067\u3001\u4e8c\u3064\u76ee\u306epipe\u306fsocket.pipe(endpoint)\u3068\u3044\u3046\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\nendpoint\u304b\u3089\u6d41\u308c\u3066\u304f\u308b\u30c7\u30fc\u30bf\u306fsocket\u306b\u6e21\u3057\u3066\u9001\u4fe1\u3057\u3001socket\u304c\u53d7\u4fe1\u3057\u305f\u30c7\u30fc\u30bf\u306fendpoint\u306b\u6d41\u3059\u3068\u3044\u3046\u3053\u3068\u3067\u3059\u3002\n(2)\u306e'stream'\u30a4\u30d9\u30f3\u30c8\u306f\u65b0\u3057\u3044Stream(\u5f8c\u8ff0)\u304c\u3067\u304d\u305f\u3068\u304d\u306b\u767a\u884c\u3055\u308c\u307e\u3059\u3002\u3053\u306eStream\u3092\u5143\u306b\u4f5c\u3063\u305frequest\u3068response\u304c\u3001\u30e6\u30fc\u30b6\u5074\u306ehttp2.createServer(function onRequest(req, res){...})\u306b\u6e21\u3055\u308c\u307e\u3059\u3002response:OutgoingResponse\u306fWritable\u3001request:IncomingRequest\u306fReadable\u3067\u3001\u3053\u308c\u3089\u306f\u57fa\u672c\u7684\u306b\u306f\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u3067\u6e21\u3055\u308c\u305fstream\u306b\u305d\u306e\u307e\u307e\u30c7\u30fc\u30bf\u306e\u8aad\u307f\u66f8\u304d\u3092\u3057\u307e\u3059\u3002\u4f8b\u3048\u3070response.write(data)\u3092\u547c\u3079\u3070\u7279\u5b9a\u306e\u6761\u4ef6\u3092\u9664\u304dthis.stream.write(data)\u304c\u5b9f\u884c\u3055\u308c\u307e\u3059\u3002\n\n2 endpoint.js\nEndpoint\u306fDuplex\u3067\u3001TCP, TLS\u5c64\u3068HTTP\u5c64\u3068\u306e\u3064\u306a\u304e\u76ee\u306b\u306a\u308a\u307e\u3059\u3002\u307e\u305f\u3001HTTP/2\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u306e\u521d\u671f\u8a2d\u5b9a\u306e\u78ba\u7acb\u306e\u305f\u3081\u306b\u3057\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u3084\u308a\u53d6\u308a(\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u30d7\u30ea\u30d5\u30a7\u30a4\u30b9'PRI * HTTP/2.0\\r\\n\\r\\nSM\\r\\n\\r\\n'\u306e\u9001\u53d7\u4fe1\u306a\u3069)\u3082\u62c5\u5f53\u3057\u3066\u304a\u308a\u3001\u4ed5\u69d8\u901a\u308a\u3053\u308c\u304c\u5b8c\u4e86\u3059\u308b\u524d\u306b\u30c7\u30fc\u30bf\u3092\u53d7\u3051\u53d6\u3063\u305f\u5834\u5408\u306a\u3069\u306fPROTOCOL_ERROR\u3092\u51fa\u3057\u307e\u3059\u3002\n\u5727\u7e2e\u3001\u30d5\u30ed\u30fc\u5236\u5fa1\u3001StreamID\u306e\u7ba1\u7406\u306a\u3069\u306f\u5404\u30e2\u30b8\u30e5\u30fc\u30eb\u304c\u62c5\u5f53\u3057\u3066\u3044\u308b\u306e\u3067\u3001\u521d\u671f\u5316\u30e1\u30bd\u30c3\u30c9\u5185\u3067\u6b21\u306e\u3088\u3046\u306b\u305d\u308c\u305e\u308c\u306e\u51e6\u7406\u3092\u62c5\u3046Duplex\u305f\u3061\u3092\u4f5c\u308a\u3064\u306a\u304e\u5408\u308f\u305b\u307e\u3059\u3002\n  this._serializer   = new Serializer(this._log);\n  this._deserializer = new Deserializer(this._log);\n  this._compressor   = new Compressor(this._log, compressorRole);\n  this._decompressor = new Decompressor(this._log, decompressorRole);\n  this._connection   = new Connection(this._log, firstStreamId, settings);\n\n  this._deserializer.pipe(this._decompressor).pipe(this._connection)\n\n  this._connection.pipe(this._compressor).pipe(this._serializer)\n\n\n2.1 Writable\u3068\u3057\u3066\u306e\u5f79\u5272\nTCP\u30fbTLS\u30bd\u30b1\u30c3\u30c8\u304b\u3089\u53d7\u3051\u53d6\u3063\u305f\u30c7\u30fc\u30bf\u3092 \u30c7\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba->\u975e\u5727\u7e2e->\u30d5\u30ed\u30fc\u5236\u5fa1 \u306a\u3069\u3092\u3057\u3066(a)\u65b0\u3057\u3044\u30b9\u30c8\u30ea\u30fc\u30e0\u3067\u306e\u30d5\u30ec\u30fc\u30e0\u3067\u3042\u308c\u3070'stream'\u30a4\u30d9\u30f3\u30c8\u3092\u767a\u884c\u3059\u308b(b)\u65e2\u5b58\u306e\u30b9\u30c8\u30ea\u30fc\u30e0\u306e\u30d5\u30ec\u30fc\u30e0\u3042\u308c\u3070\u305d\u306e\u30b9\u30c8\u30ea\u30fc\u30e0\u306b\u30c7\u30fc\u30bf\u3092\u9001\u308a\u307e\u3059\u3002\nTCP\u5c64\u304b\u3089\u6765\u305f\u30c7\u30fc\u30bf\u3092\u6b21\u306e\u3088\u3046\u306bTransform\u3067\u3042\u308b_deserializer\u306b\u66f8\u304d\u8fbc\u3080\u3053\u3068\u3067\u3001\u4e0a\u8a18\u306e\u3088\u3046\u306bpipe\u3067\u6307\u5b9a\u3057\u305f\u901a\u308a_deserializer->_decompressor->_connection(\u5f8c\u8ff0)\u3068\u30c7\u30fc\u30bf\u304c\u6d41\u308c\u3066\u3044\u304d\u307e\u3059\u3002\nEndpoint.prototype._write = function _write(chunk, encoding, done) {\n  this._deserializer.write(chunk, encoding, done);\n};\n\n\n2.2 Readable\u3068\u3057\u3066\u306e\u5f79\u5272\n\u76f8\u624b\u306b\u9001\u4fe1\u3057\u305f\u3044\u30c7\u30fc\u30bf\u3092\u512a\u5148\u5ea6\u7ba1\u7406->\u30d5\u30ed\u30fc\u5236\u5fa1->\u5727\u7e2e->\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u3092\u3057\u3066TCP, TLS\u306e\u30bd\u30b1\u30c3\u30c8\u306b\u9001\u308a\u307e\u3059\u3002\n\u6b21\u306e\u3088\u3046\u306b_serializer\u304b\u3089\u30c7\u30fc\u30bf\u3092\u8aad\u307f\u8fbc\u3093\u3067push\u3092\u3059\u308b\u306e\u3067\u3001\u30e6\u30fc\u30b6\u304cresponse.write(data)\u3067\u6e21\u3057\u305f\u30c7\u30fc\u30bf\u306a\u3069\u3082stream\u304b\u3089_connection->_compressor->_serializer->socket\u3068\u30c7\u30fc\u30bf\u304c\u6e21\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\nEndpoint.prototype._read = function _read() {\n  this._readableState.sync = true;\n  var moreNeeded = noread, chunk;\n  while (moreNeeded && (chunk = this._serializer.read())) {\n    moreNeeded = this.push(chunk);\n  }\n  if (moreNeeded === noread) {\n    this._serializer.once('readable', this._read.bind(this));\n  }\n  this._readableState.sync = false;\n};\n\n\n3 flow.js\n\u30d5\u30ed\u30fc\u5236\u5fa1\u3092\u3057\u307e\u3059\u3002Connection\u306e\u89aa\u30af\u30e9\u30b9\u3067\u3001Stream\u306fFlow\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u30d7\u30ed\u30d1\u30c6\u30a3upstream\u3068\u3057\u3066\u6301\u3061\u307e\u3059\u3002\nReadableStream\u306f\u5185\u90e8\u306b\u30ad\u30e5\u30fc\u3092\u6301\u3061\u30c7\u30fc\u30bf\u3092\u7ba1\u7406\u3057\u307e\u3059\u304c\u3001Flow\u3067\u306f\u3053\u308c\u3092output queue\u3068\u547c\u3073window\u30b5\u30a4\u30ba\u3092\u898b\u3066\u9001\u4fe1\u3059\u308b\u3053\u3068\u304c\u6c7a\u307e\u3063\u305f\u30c7\u30fc\u30bf\u306e\u30ad\u30e5\u30fc\u3068\u3057\u3066\u6271\u3044\u307e\u3059\u3002\u307e\u305f\u3001\u81ea\u8eab\u306e\u30d7\u30ed\u30d1\u30c6\u30a3\u3067\u3082flow control queue\u3068\u3057\u3066\u5225\u306bthis._queue\u3092\u6301\u3061\u3001window\u30b5\u30a4\u30ba\u304c\u7a7a\u304f\u306e\u3092\u5f85\u3063\u3066\u3044\u305f\u308aoutput queue\u306b\u307e\u3060\u5165\u308a\u5207\u3063\u3066\u3044\u306a\u3044\u30d5\u30ec\u30fc\u30e0\u3092\u4fdd\u6301\u3057\u307e\u3059\u3002\n\u4f8b\u3048\u3070\u30c7\u30fc\u30bf\u306e\u9001\u4fe1\u6642\u306b_read\u306a\u3069\u306e\u5225\u30e1\u30bd\u30c3\u30c9\u304b\u3089\u547c\u3070\u308c\u308bpush()\u3068_push()\u306f\u6b21\u306e\u901a\u308a\u3067\u3059\u3002\nFlow.prototype.push = function push(frame) {\n  var moreNeeded = null;\n  if (this._queue.length === 0) {\n    moreNeeded = this._push(frame); // output queue\u306b\u30d7\u30c3\u30b7\u30e5\n  }\n\n  if (moreNeeded === null) {\n    this._queue.push(frame); // flow control queue\u306b\u30d7\u30c3\u30b7\u30e5\n  }\n\n  return moreNeeded;\n};\n\n// \u30d5\u30ec\u30fc\u30e0\u306e\u4e2d\u8eab\u5168\u90e8\u3092output queue\u306b\u30d7\u30c3\u30b7\u30e5\u3067\u304d\u306a\u304b\u3063\u305f\u3089null\u3092\u8fd4\u3059\nFlow.prototype._push = function _push(frame) {\n  var data = frame && (frame.type === 'DATA') && frame.data;\n\n  // (DATA\u30d5\u30ec\u30fc\u30e0\u4ee5\u5916 || window\u30b5\u30a4\u30ba\u306b\u5165\u308a\u304d\u308b)\u5834\u5408\u306f_parentPush\u3067output queue\u306b\u30d7\u30c3\u30b7\u30e5\n  if (!data || (data.length <= this._window)) {\n    return this._parentPush(frame);\n  } else if (this._window <= 0) {\n    return null;\n  } else {\n\n    frame.data = data.slice(this._window);//window\u30b5\u30a4\u30ba\u304b\u3089\u306f\u307f\u51fa\u305f\u5206\u3092frame.data\u306b\u6b8b\u3059\n    this._parentPush({\n      type: 'DATA',\n      flags: {},\n      stream: frame.stream,\n      data: data.slice(0, this._window)//window\u30b5\u30a4\u30ba\u306e\u5206\u3060\u3051\u5207\u308a\u53d6\u3063\u3066\u9001\u308b\n    });\n    return null;\n  }\n};\n\n_parentPush()\u3067\u9001\u4fe1\u3059\u308b\u3068\u304d\u3084\u76f8\u624b\u304b\u3089'WINDOW_UPDATE'\u3092\u53d7\u3051\u53d6\u3063\u305f\u6642\u306b_window\u306e\u5897\u6e1b\u3092\u3057\u307e\u3059\u3002\n\u307e\u305f\u3001_read(),_write()\u304c\u547c\u3070\u308c\u305f\u3068\u304d\u306b\u4eee\u60f3\u95a2\u6570\u306e_send(),_receive()\u3092\u547c\u3076\u306e\u3067\u3001\u5b50\u30af\u30e9\u30b9\u3067\u3042\u308bConnection\u306f_read(), _write()\u3067\u306f\u306a\u304f_send(), _receive()\u3092\u5b9f\u88c5\u3057\u307e\u3059\u3002\n\n4 connection.js\nConnection\u306f\u30b5\u30fc\u30d0\u3068\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u9593\u3067\uff11\u3064\u3060\u3051\u5b58\u5728\u3057\u3001\u8907\u6570\u306e\u30b9\u30c8\u30ea\u30fc\u30e0\u3092\u7ba1\u7406\u3057\u307e\u3059\u3002stream\u306e\u7ba1\u7406\u3084\u512a\u5148\u5ea6\u306e\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3092\u5b9f\u88c5\u3057\u3066\u3044\u307e\u3059\u3002\nStream\u3092\u4e8c\u3064\u306e\u914d\u5217(map)\u3067\u4fdd\u6301\u3057\u307e\u3059\u3002\u8907\u6570\u306e\u30b9\u30c8\u30ea\u30fc\u30e0\u304c\u540c\u4e00\u306e\u512a\u5148\u5ea6\u306e\u5834\u5408\u3082\u3042\u308b\u306e\u3067\u3001_streamPriorities\u306fpriority\u306b\u5bfe\u3057\u3066\u30b9\u30c8\u30ea\u30fc\u30e0\u306e\u914d\u5217\u3092\u6301\u3061\u307e\u3059\u3002\n  this._streamIds = []; // (id -> stream) \u53d7\u4fe1\u7528\u306e\u30b9\u30c8\u30ea\u30fc\u30e0\n  this._streamPriorities = []; // (priority -> [stream]) \u9001\u4fe1\u7528\u306e\u30b9\u30c8\u30ea\u30fc\u30e0\n\n\u65b0\u3057\u304f\u30ea\u30bd\u30fc\u30b9\u3092\u9001\u4fe1\u3059\u308b\u3068\u304d\u30fb\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u6700\u521d\u306e\u30d5\u30ec\u30fc\u30e0\u304c\u6765\u305f\u3068\u304d\u30fbPUSH_PROMISE\u306e\u30d5\u30ec\u30fc\u30e0\u3092\u9001\u308b\u3068\u304d\u306a\u3069\u3001Stream\u3092\u4f5c\u6210\u3057\u3066\u5404map\u306b\u8ffd\u52a0\u3057\u3001_allocateId()\u3067id\u3092\u30bb\u30c3\u30c8\u3057\u307e\u3059\u3002\n\u4ed5\u69d8\u901a\u308a\u3001ID\u304c0\u306e\u30b9\u30c8\u30ea\u30fc\u30e0_streamIds[0]\u306fSETTINGS\u30d5\u30ec\u30fc\u30e0\u3092\u9001\u53d7\u4fe1\u3059\u308b\u305f\u3081\u306e\u7279\u5225\u306a\u30b9\u30c8\u30ea\u30fc\u30e0\u3068\u3057\u3066\u4f5c\u6210\u3055\u308c\u307e\u3059\u3002\n\u5f8c\u8ff0\u3059\u308b\u901a\u308a\u3001\u5404stream\u306f\u30d7\u30ed\u30d1\u30c6\u30a3\u306bFlow\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9upstream\u3092\u6301\u3063\u3066\u304a\u308a\u3001Connection\u304b\u3089stream\u306e\u30c7\u30fc\u30bf\u3092\u8aad\u307f\u66f8\u304d\u3059\u308b\u5834\u5408\u306fstream.upstream.write()\u306e\u3088\u3046\u306bupstream\u3092\u4ecb\u3057\u3066\u884c\u3044\u307e\u3059\u3002(upstream\u306fstream\u306b_send(),_receive()\u51e6\u7406\u3092\u59d4\u8b72\u3057\u3066\u3044\u308b)\n\u4f8b\u3048\u3070\u9001\u4fe1\u3059\u308b\u30c7\u30fc\u30bf\u3092\u8981\u6c42\u3055\u308c\u308b\u3068\u304d\u306b\u547c\u3070\u308c\u308b_send()\u3067\u306f\u4fdd\u6301\u3059\u308b\u30b9\u30c8\u30ea\u30fc\u30e0\u306b\u5bfe\u3057\u512a\u5148\u5ea6\u9806\u306bread()\u3057\u3066\u30d5\u30ec\u30fc\u30e0\u3092\u8aad\u307f\u8fbc\u307f\u3001\u81ea\u8eab(Flow)\u306eoutput queue\u3068flow control queue\u304c\u3044\u3063\u3071\u3044\u306b\u306a\u308b\u307e\u3067\u30d7\u30c3\u30b7\u30e5\u3057\u307e\u3059\u3002\u9577\u3044\u3067\u3059\u304c\u6b21\u306e\u901a\u308a\u3067\u3059\u3002\nConnection.prototype._send = function _send(immediate) {\n    ...\npriority_loop:\n  // \u512a\u5148\u5ea6\u9806\u306b\u30b9\u30c8\u30ea\u30fc\u30e0\u3092\u51e6\u7406\u3057\u3066\u3044\u304f\n  for (var priority in this._streamPriorities) {\n    var bucket = this._streamPriorities[priority];\n    var nextBucket = [];\n\n    while (bucket.length > 0) {\n      for (var index = 0; index < bucket.length; index++) {\n        var stream = bucket[index];\n        var frame = stream.upstream.read((this._window > 0) ? this._window : -1);\n\n        if (!frame) {\n          continue;\n        } else if (frame.count_change > this._streamSlotsFree) {\n          //frame.count_change\u306f\u3053\u306e\u30d5\u30ec\u30fc\u30e0\u306e\u9001\u53d7\u4fe1\u306b\u3088\u3063\u3066\u5897\u6e1b\u3059\u308b\u30b9\u30c8\u30ea\u30fc\u30e0\u306e\u6570(-1\u304b0\u304b1)\n          //IDLE->OPEN\u306b\u3059\u308b\u30d5\u30ec\u30fc\u30e0\u306a\u3089+1\u3060\u3057, HALF_CLOSED->CLOSED\u306b\u3059\u308b\u30d5\u30ec\u30fc\u30e0\u306a\u3089-1\n          //_streamSlotsFree\u306f(SETTINGS_MAX_CONCURRENT_STREAMS - \u4f7f\u7528\u4e2d\u306e\u30b9\u30c8\u30ea\u30fc\u30e0\u6570)\n          stream.upstream.unshift(frame); //\u3053\u306e\u30d5\u30ec\u30fc\u30e0\u3092\u51e6\u7406\u3059\u308b\u3068SETTINGS_MAX_CONCURRENT_STREAMS\u3092\u8d85\u3048\u3066\u3057\u307e\u3046\u306e\u3067stream\u306b\u623b\u3057\u3066\u30b9\u30ad\u30c3\u30d7\u3059\u308b\n          continue;\n        }\n\n        nextBucket.push(stream);\n\n        if (frame.stream === undefined) {\n          frame.stream = stream.id || this._allocateId(stream);\n        }\n\n        if (frame.type === 'PUSH_PROMISE') {\n          this._allocatePriority(frame.promised_stream);\n          frame.promised_stream = this._allocateId(frame.promised_stream);\n        }\n\n        var moreNeeded = this.push(frame);//output queue\u304bflow control queue\u306b\u30d7\u30c3\u30b7\u30e5\n        this._changeStreamCount(frame.count_change);\n\n        if (moreNeeded === false) {\n          break priority_loop;\n        }\n      }\n\n      bucket = nextBucket;\n      nextBucket = [];\n    }\n  }\n\n  // \u30d5\u30ec\u30fc\u30e0\u3092\u9001\u4fe1\u3067\u304d\u306a\u304b\u3063\u305f\u3089window update\u306a\u3069queue\u304c\u7a7a\u304f\u30bf\u30a4\u30df\u30f3\u30b0\u3092\u5f85\u3064\n  if (moreNeeded === undefined) {\n    this.once('wakeup', this._send.bind(this));\n  }\n};\n\n\nstream.js\n\uff11\u7d44\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3068\u30ec\u30b9\u30dd\u30f3\u30b9\u306e\u4ea4\u63db\u306b\u4f7f\u308f\u308c\u308b\u30b9\u30c8\u30ea\u30fc\u30e0\u3067\u3059\u3002idle, closed\u306a\u3069\u306e\u72b6\u614b\u7ba1\u7406\u306e\u51e6\u7406\u3084promise(),headers()\u306a\u3069\u30e6\u30fc\u30b6\u5074\u304b\u3089\u547c\u3070\u308c\u308b\u30e1\u30bd\u30c3\u30c9\u304c\u3042\u308a\u307e\u3059\u3002\n\u30e6\u30fc\u30b6\u5074\u304b\u3089write()\u3067\u6e21\u3057\u305f\u30c7\u30fc\u30bf\u306fconnection\u304b\u3089\u306fstream.upstream.read()\u3067\u53d6\u5f97\u3057\u3001connection\u304b\u3089stream.upstream.write()\u3067\u6e21\u3057\u305f\u30c7\u30fc\u30bf\u306f\u30e6\u30fc\u30b6\u5074\u304b\u3089\u306fread()\u3067\u53d6\u5f97\u3067\u304d\u307e\u3059\u3002\n_read()\u3068_write()\u306f\u30e6\u30fc\u30b6\u5074\u3068\u306e\u3084\u308a\u3068\u308a\u3067\u3001_receive()\u3068_send()\u306fconnection\u3001\u3064\u307e\u308aupstream\u5074\u3068\u306e\u3084\u308a\u3068\u308a\u3067\u547c\u3070\u308c\u308b\u30e1\u30bd\u30c3\u30c9\u3067\u3059\u3002_write()\u3084_receive()\u306f\u5f15\u6570\u306b\u95a2\u6570ready\u304c\u6e21\u3055\u308c\u308b\u306e\u3067\u3001\u6b21\u306e\u30c7\u30fc\u30bf\u3092\u53d7\u3051\u53d6\u308c\u308b\u72b6\u614b\u306b\u306a\u3063\u305f\u3068\u304d\u306b\u3053\u308c\u3092\u547c\u3076\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n_read(), _write(), _receive(), _send()\u306f\u6b21\u306e\u901a\u308a\u3067\u3059\u3002\nStream.prototype._initializeDataFlow = function _initializeDataFlow() {\n  // \u521d\u671f\u5316\n  this.upstream = new Flow();\n  this.upstream._send = this._send.bind(this);\n  this.upstream._receive = this._receive.bind(this);\n};\n\n// \u30c7\u30fc\u30bf\u3092\u53d7\u4fe1\u3057\u305f\u3068\u304d\u547c\u3070\u308c\u308b\nStream.prototype._receive = function _receive(frame, ready) {\n  // \u6b21\u306e\u30c7\u30fc\u30bf\u3092\u53d7\u3051\u53d6\u308c\u308b\u72b6\u614b\u306b\u306a\u3063\u305f\u3068\u304d\u306bready()\u3092\u547c\u3076\n\n  if (!this._ended && (frame.type === 'DATA')) {\n    var moreNeeded = this.push(frame.data);\n    if (!moreNeeded) {\n      this._receiveMore = ready; // queue\u304c\u3044\u3063\u3071\u3044\u306a\u306e\u3067ready\u306f\u5225\u306e\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u547c\u3076\n    }\n  }\n\n  if (!this._ended && (frame.flags.END_STREAM || (frame.type === 'RST_STREAM'))) {\n    this.push(null);\n    this._ended = true;\n  }\n\n  if (this._receiveMore !== ready) {\n    ready();\n  }\n};\n\n// \u30e6\u30fc\u30b6\u5074\u304c\u30c7\u30fc\u30bf\u3092\u8aad\u307f\u8fbc\u307f\u305f\u3044\u3068\u304d\u306b\u547c\u3070\u308c\u308b\nStream.prototype._read = function _read() {\n  if (this._receiveMore) {\n    var receiveMore = this._receiveMore;\n    delete this._receiveMore;\n    receiveMore(); // \u4e0a\u8ff0\u306eready\u3092\u547c\u3093\u3060\u306e\u3067\u6b21\u306e\u30c7\u30fc\u30bf\u304c\u307e\u305f_receive\u306b\u6d41\u308c\u3066\u304f\u308b\n  }\n};\n\n// \u30e6\u30fc\u30b6\u5074\u304b\u3089\u66f8\u304d\u8fbc\u307e\u308c\u305f\u3068\u304d\u306b\u547c\u3070\u308c\u308b\nStream.prototype._write = function _write(buffer, encoding, ready) {\n  var moreNeeded = this._pushUpstream({\n    type: 'DATA',\n    flags: {},\n    stream: this.id,\n    data: buffer\n  });\n\n  if (moreNeeded) {\n    ready(); \n  } else {\n    this._sendMore = ready; // ready()\u306f\u307e\u3060\u547c\u3070\u305a\u3001queue\u304c\u7a7a\u3044\u3066\u9001\u4fe1\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u3068\u304d\u306b\u547c\u3076\n  }\n};\n\n// \u6b21\u306e\u30c7\u30fc\u30bf\u3092\u9001\u4fe1\u3057\u305f\u3044\u3068\u304d\u306b\u4e0a\u6d41\u304b\u3089\u547c\u3070\u308c\u308b\nStream.prototype._send = function _send() {\n  if (this._sendMore) {\n    var sendMore = this._sendMore;\n    delete this._sendMore;\n    sendMore(); \n  }\n};\n\nStream.prototype._pushUpstream = function _pushUpstream(frame) {\n  this.upstream.push(frame);\n  this._transition(true, frame); // \u72b6\u614b\u9077\u79fb\n};\n\n\n\u307e\u3068\u3081\u3068\u611f\u60f3\nHTTP/2\u306f\u30b9\u30c6\u30fc\u30c8\u30d5\u30eb\u3067\u5b9f\u88c5\u304c\u8907\u96d1\u306b\u306a\u308a\u3059\u304e\u308b\u3068\u3044\u3046\u6279\u5224\u304c\u3042\u308a\u307e\u3057\u305f\u304c\u78ba\u304b\u306b\u5c11\u3057\u96e3\u3057\u3044\u611f\u3058\u304c\u3057\u307e\u3059\u3002stream\u306e\u591a\u91cd\u5316(ID\u7ba1\u7406)\u3001\u72b6\u614b\u7ba1\u7406\u3001\u512a\u5148\u5ea6\u3001\u30d5\u30ed\u30fc\u5236\u5fa1\u306a\u3069\u6a5f\u80fd\u304c\u591a\u304f\u3001\u4fdd\u6301\u3059\u308b\u60c5\u5831\u30fb\u5909\u6570\u3082\u591a\u304f\u306a\u308b\u306e\u3067\u30b4\u30c1\u30e3\u30b4\u30c1\u30e3\u306b\u306a\u3089\u306a\u3044\u3088\u3046\u3057\u3063\u304b\u308a\u5207\u308a\u5206\u3051\u3066\u5b9f\u88c5\u3059\u308b\u306e\u304c\u5927\u4e8b\u3060\u3068\u601d\u3044\u307e\u3057\u305f\u3002\nStream API\u306f\u304b\u306a\u308a\u4fbf\u5229\u3067\u3088\u3057\u306a\u306b\u30d0\u30c3\u30d5\u30a1\u30ea\u30f3\u30b0\u3092\u3057\u3066\u304f\u308c\u308b\u3053\u3068\u306f\u3082\u3061\u308d\u3093\u3001push()\u3001pipe()\u3084'data'\u30a4\u30d9\u30f3\u30c8\u306a\u3069\u7c21\u5358\u306a\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u3067\u30c7\u30fc\u30bf\u306e\u5165\u529b\u5143\u3001\u51fa\u529b\u5148\u306e\u5b9f\u88c5\u3084\u5229\u7528\u304c\u3067\u304d\u308b\u306e\u3082\u3044\u3044\u70b9\u3060\u3068\u601d\u3044\u307e\u3059\u3002\n\u3053\u306e\u8a18\u4e8b\u306f\u3001http2 Advent Calendar 2015 \u306e21\u65e5\u76ee\u306e\u8a18\u4e8b\u3067\u3059\u3002\n# \u306f\u3058\u3081\u306b\nHTTP/2\u306eNode.js\u3067\u306e\u5b9f\u88c5[node-http2](https://github.com/molnarg/node-http2)\u3092\u8aad\u3093\u3060\u306e\u3067\u3001\u30dd\u30a4\u30f3\u30c8\u3060\u3068\u601d\u3046\u3068\u3053\u308d\u306b\u3064\u3044\u3066\u5927\u307e\u304b\u306b\u66f8\u304d\u307e\u3059\u3002\n\n * node-http2\u3063\u3066\u3069\u3093\u306a\u611f\u3058\u306a\u306e\n * HTTP/2\u306f\u3069\u3046\u3044\u3046\u98a8\u306b\u5b9f\u88c5\u3067\u304d\u308b\u306e\n * Node.js\u306eStream API\u306e\u826f\u3044\u4f7f\u7528\u4f8b\u306a\u3044\u304b\u306a\n\n\u307f\u305f\u3044\u306a\u3053\u3068\u3092\u77e5\u308a\u305f\u3044\u4eba\u306e\u624b\u52a9\u3051\u306b\u306a\u308c\u3070\u3068\u601d\u3044\u307e\u3059\u3002\n\u6271\u3046node-http2\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u306f3.2\u3067\u3059\u3002\n### Stream API\nnode-http2\u3067\u306fNode.js\u306e\u4e3b\u8981\u306aAPI\u3067\u3042\u308bStream API\u304c\u3088\u304f\u4f7f\u308f\u308c\u3066\u3044\u307e\u3059\u3002\n\u5168\u304f\u77e5\u3089\u306a\u3044\u4eba\u306e\u305f\u3081\u306b[\u6982\u8981\u3060\u3051\u307e\u3068\u3081\u307e\u3057\u305f](http://qiita.com/takaaki7/items/fbc33dff1e17fe6a3d38)\u3002\n\nHTTP/2\u306e\u91cd\u8981\u306a\u6982\u5ff5\u3068\u3057\u3066Stream\u304c\u3042\u308a\u307e\u3059\u304c\u305d\u308c\u3068Stream API\u306f\u5225\u306e\u3082\u306e\u3067\u3059\u3002\n\u4eca\u56de\u306f\u5358\u306bStream\u3068\u66f8\u3044\u305f\u5834\u5408\u306fHTTP/2\u3068\u3057\u3066\u306eStream\u3084\u305d\u306e\u5b9f\u88c5\u306eStream\u30af\u30e9\u30b9\u30fb\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u6307\u3057\u3001Stream API\u3001ReadableStream\u3001Readable\u306a\u3069\u3068\u66f8\u3044\u305f\u5834\u5408\u306fNode.js\u306eStream API\u3092\u6307\u3059\u3053\u3068\u306b\u3057\u307e\u3059\u3002\n\n# node-http2\n\u6d41\u308c\u3068\u3057\u3066\u91cd\u8981\u3060\u3068\u601d\u3063\u305f\u7b87\u6240\u3092\u30b6\u30c3\u30af\u30ea\u8aac\u660e\u3057\u307e\u3059\u3002\u8f09\u305b\u3066\u308b\u30b3\u30fc\u30c9\u306f\u6d41\u308c\u3092\u308f\u304b\u308a\u3084\u3059\u304f\u3059\u308b\u305f\u3081\u306b\u30e1\u30bd\u30c3\u30c9\u3084\u5909\u6570\u3092\u5c55\u958b\u3057\u305f\u308a\u8aac\u660e\u306b\u4e0d\u8981\u306a\u90e8\u5206\u306f\u7701\u7565\u3057\u305f\u308a\u3057\u305f\u306e\u3067\u5b9f\u969b\u306e\u3082\u306e\u3068\u306f\u5c11\u3057\u7570\u306a\u308a\u307e\u3059\u3002\n\u4e3b\u306b\u30b5\u30fc\u30d0\u5074\u306e\u51e6\u7406\u306a\u3069\u3092\u4f8b\u306b\u3057\u3066\u8aac\u660e\u3057\u307e\u3059\u3002\n### \u968e\u5c64\n    \n    index.js\n    http.js\n    protocol/\n      index.js\n      endpoint.js\n      connection.js\n      stream.js\n      compressor.js\n      flow.js\n      framer.js\n\nindex\u306f\u4e3b\u306b\u30e2\u30b8\u30e5\u30fc\u30eb\u7ba1\u7406\u306e\u305f\u3081\u306e\u30d5\u30a1\u30a4\u30eb\u306a\u306e\u3067\u7279\u306b\u5927\u4e8b\u306a\u5b9f\u88c5\u306f\u3042\u308a\u307e\u305b\u3093\u3002\nprotocol/\u5185\u304cHTTP/2\u306e\u5b9f\u88c5\u3067\u3001http.js\u304c\u3053\u308c\u3092\u5229\u7528\u3057\u305f\u6c4e\u7528\u7684\u306aAPI\u3068\u3044\u3046\u611f\u3058\u3067\u3059\u3002\n\u4e3b\u306bhttp, endpoint, connection, stream, flow\u306b\u3064\u3044\u3066\u8aac\u660e\u3057\u307e\u3059\u3002\n\u8a73\u7d30\u306f\u7701\u304d\u307e\u3059\u304c\u3001compressor, framer\u306f\u305d\u308c\u305e\u308c\u5727\u7e2e\u30fb\u975e\u5727\u7e2e\u3068\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u30fb\u30c7\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u306e\u51e6\u7406\u3092\u3057\u307e\u3059\u3002\n##\u30d5\u30a1\u30a4\u30eb\u3054\u3068\u306e\u8aac\u660e\n### 1 http\n#####1.1 API\u3068\u3057\u3066\u306e\u4f7f\u3044\u65b9\n\u30e6\u30fc\u30b6\uff08node-http2\u3092\u5229\u7528\u3059\u308b\u958b\u767a\u8005)\u5411\u3051\u306eAPI\u306e\u90e8\u5206\u3067\u3001Server, Agent\uff08\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\uff09, IncomingRequest, OutgoingResponse\u306a\u3069\u306e\u30af\u30e9\u30b9\u3084request(options,callback)\u306a\u3069\u306e\u30e1\u30bd\u30c3\u30c9\u304c\u516c\u958b\u3055\u308c\u3066\u3044\u307e\u3059\u3002\u4f7f\u3044\u65b9\u3068\u3057\u3066\u306f\u3001\u4f8b\u3048\u3070\u30b5\u30fc\u30d0\u5074\u306a\u3089\u6b21\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002(TLS\u3067\u306a\u304fTCP\u306e\u30d1\u30bf\u30fc\u30f3\u3092\u4f8b\u306b\u3057\u307e\u3059)\n\n```\nserver = http2.createServer({\n    plain: true //TLS\u3067\u306f\u306a\u304fTCP\u3092\u6307\u5b9a\n  }, function onRequest(request, response) {\n    if(request.url === \"/first.js\"){\n      var push = response.push('/second.js');\n      push.writeHead(200);\n      fs.createReadStream(path.join(__dirname, '/second.js')).pipe(push);\n      fs.createReadStream(path.join(__dirname, '/first.js')).pipe(response);\n    }\n  });\n});\n```\n\u8981\u6c42\u304c\u6765\u305f\u3068\u304d`onRequest`\u306bWritableStream\u578b\u306e`response`\u304c\u6e21\u3055\u308c\u3066\u304d\u307e\u3059\u3002\n\u300cfirst.js\u304c\u8981\u6c42\u3055\u308c\u305f\u3068\u3044\u3046\u3053\u3068\u306fsecond.js\u3082\u5fc5\u8981\u304b\u3082\u3057\u308c\u306a\u3044\u300d\u3068\u3044\u3046\u306e\u304c\u308f\u304b\u308b\u5834\u5408\u306f\u4e0a\u306e\u3088\u3046\u306b`push('/second.js')`\u3067push\u306eStream\u3092\u4f5c\u308a\u3001\u30c7\u30fc\u30bf\u3092\u66f8\u304d\u8fbc\u3093\u3067\u9001\u4fe1\u3059\u308c\u3070\u3044\u3044\u308f\u3051\u3067\u3059\u3002\n\n#####1.2 Server\u306e\u5b9f\u88c5\nServer\u30af\u30e9\u30b9\u306e\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u5185\u3067\u6b21\u306e\u3088\u3046\u306a\u51e6\u7406\u304c\u3042\u308a\u307e\u3059\u3002\n\n```\nif (options.plain) {\n  this._mode = 'plain';\n  \n  //TCP\u306e\u30b5\u30fc\u30d0\u3092\u7acb\u3061\u4e0a\u3052\u308b. TCP\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u304c\u78ba\u7acb\u3055\u308c\u305f\u6642 _start()\u304c\u547c\u3070\u308c\u308b\n  this._server = net.createServer(function _start(socket) {\n    var endpoint = new Endpoint(this._log, 'SERVER', this._settings);\n\n    endpoint.pipe(socket).pipe(endpoint); //(1)\n \n    var self = this;\n    endpoint.on('stream', function _onStream(stream) {  //(2)\n      var response = new OutgoingResponse(stream);\n      var request = new IncomingRequest(stream);\n      request.socket = socket;\n      request.once('ready', self.emit.bind(self, 'request', request, response));\n    });\n\n    this.emit('connection', socket, endpoint);\n  };);\n}\n```\n\n(1)\u306e`endpoint.pipe(socket).pipe(endpoint)`\u3067`socket`\u3068`endpoint`\uff08\u5f8c\u8ff0\uff09\u306e\u30b9\u30c8\u30ea\u30fc\u30e0\u3092\u3064\u306a\u304e\u5408\u308f\u305b\u307e\u3059\u3002\n`endpoint`, `socket`\u306f\u5171\u306bDuplex(Readable\u3067Writable)\u3067\u3059\u3002`Readable.pipe(Writable)`\u306f\u53d7\u3051\u53d6\u3063\u305f\u5f15\u6570\u3092\u305d\u306e\u307e\u307e\u8fd4\u3059\u306e\u3067\u3001\u4e8c\u3064\u76ee\u306epipe\u306f`socket.pipe(endpoint)`\u3068\u3044\u3046\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n`endpoint`\u304b\u3089\u6d41\u308c\u3066\u304f\u308b\u30c7\u30fc\u30bf\u306f`socket`\u306b\u6e21\u3057\u3066\u9001\u4fe1\u3057\u3001`socket`\u304c\u53d7\u4fe1\u3057\u305f\u30c7\u30fc\u30bf\u306f`endpoint`\u306b\u6d41\u3059\u3068\u3044\u3046\u3053\u3068\u3067\u3059\u3002\n\n(2)\u306e`'stream'`\u30a4\u30d9\u30f3\u30c8\u306f\u65b0\u3057\u3044Stream(\u5f8c\u8ff0)\u304c\u3067\u304d\u305f\u3068\u304d\u306b\u767a\u884c\u3055\u308c\u307e\u3059\u3002\u3053\u306eStream\u3092\u5143\u306b\u4f5c\u3063\u305f`request`\u3068`response`\u304c\u3001\u30e6\u30fc\u30b6\u5074\u306e`http2.createServer(function onRequest(req, res){...})`\u306b\u6e21\u3055\u308c\u307e\u3059\u3002response:OutgoingResponse\u306fWritable\u3001request:IncomingRequest\u306fReadable\u3067\u3001\u3053\u308c\u3089\u306f\u57fa\u672c\u7684\u306b\u306f\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u3067\u6e21\u3055\u308c\u305fstream\u306b\u305d\u306e\u307e\u307e\u30c7\u30fc\u30bf\u306e\u8aad\u307f\u66f8\u304d\u3092\u3057\u307e\u3059\u3002\u4f8b\u3048\u3070`response.write(data)`\u3092\u547c\u3079\u3070\u7279\u5b9a\u306e\u6761\u4ef6\u3092\u9664\u304d`this.stream.write(data)`\u304c\u5b9f\u884c\u3055\u308c\u307e\u3059\u3002\n### 2 endpoint.js\nEndpoint\u306fDuplex\u3067\u3001TCP, TLS\u5c64\u3068HTTP\u5c64\u3068\u306e\u3064\u306a\u304e\u76ee\u306b\u306a\u308a\u307e\u3059\u3002\u307e\u305f\u3001HTTP/2\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u306e\u521d\u671f\u8a2d\u5b9a\u306e\u78ba\u7acb\u306e\u305f\u3081\u306b\u3057\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u3084\u308a\u53d6\u308a(\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u30d7\u30ea\u30d5\u30a7\u30a4\u30b9`'PRI * HTTP/2.0\\r\\n\\r\\nSM\\r\\n\\r\\n'`\u306e\u9001\u53d7\u4fe1\u306a\u3069)\u3082\u62c5\u5f53\u3057\u3066\u304a\u308a\u3001\u4ed5\u69d8\u901a\u308a\u3053\u308c\u304c\u5b8c\u4e86\u3059\u308b\u524d\u306b\u30c7\u30fc\u30bf\u3092\u53d7\u3051\u53d6\u3063\u305f\u5834\u5408\u306a\u3069\u306fPROTOCOL_ERROR\u3092\u51fa\u3057\u307e\u3059\u3002\n\n\u5727\u7e2e\u3001\u30d5\u30ed\u30fc\u5236\u5fa1\u3001StreamID\u306e\u7ba1\u7406\u306a\u3069\u306f\u5404\u30e2\u30b8\u30e5\u30fc\u30eb\u304c\u62c5\u5f53\u3057\u3066\u3044\u308b\u306e\u3067\u3001\u521d\u671f\u5316\u30e1\u30bd\u30c3\u30c9\u5185\u3067\u6b21\u306e\u3088\u3046\u306b\u305d\u308c\u305e\u308c\u306e\u51e6\u7406\u3092\u62c5\u3046Duplex\u305f\u3061\u3092\u4f5c\u308a\u3064\u306a\u304e\u5408\u308f\u305b\u307e\u3059\u3002\n\n```\n  this._serializer   = new Serializer(this._log);\n  this._deserializer = new Deserializer(this._log);\n  this._compressor   = new Compressor(this._log, compressorRole);\n  this._decompressor = new Decompressor(this._log, decompressorRole);\n  this._connection   = new Connection(this._log, firstStreamId, settings);\n\n  this._deserializer.pipe(this._decompressor).pipe(this._connection)\n\n  this._connection.pipe(this._compressor).pipe(this._serializer)\n```\n###### 2.1 Writable\u3068\u3057\u3066\u306e\u5f79\u5272\nTCP\u30fbTLS\u30bd\u30b1\u30c3\u30c8\u304b\u3089\u53d7\u3051\u53d6\u3063\u305f\u30c7\u30fc\u30bf\u3092 \u30c7\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba->\u975e\u5727\u7e2e->\u30d5\u30ed\u30fc\u5236\u5fa1 \u306a\u3069\u3092\u3057\u3066(a)\u65b0\u3057\u3044\u30b9\u30c8\u30ea\u30fc\u30e0\u3067\u306e\u30d5\u30ec\u30fc\u30e0\u3067\u3042\u308c\u3070`'stream'`\u30a4\u30d9\u30f3\u30c8\u3092\u767a\u884c\u3059\u308b(b)\u65e2\u5b58\u306e\u30b9\u30c8\u30ea\u30fc\u30e0\u306e\u30d5\u30ec\u30fc\u30e0\u3042\u308c\u3070\u305d\u306e\u30b9\u30c8\u30ea\u30fc\u30e0\u306b\u30c7\u30fc\u30bf\u3092\u9001\u308a\u307e\u3059\u3002\n\nTCP\u5c64\u304b\u3089\u6765\u305f\u30c7\u30fc\u30bf\u3092\u6b21\u306e\u3088\u3046\u306bTransform\u3067\u3042\u308b`_deserializer`\u306b\u66f8\u304d\u8fbc\u3080\u3053\u3068\u3067\u3001\u4e0a\u8a18\u306e\u3088\u3046\u306bpipe\u3067\u6307\u5b9a\u3057\u305f\u901a\u308a`_deserializer`->`_decompressor`->`_connection`(\u5f8c\u8ff0)\u3068\u30c7\u30fc\u30bf\u304c\u6d41\u308c\u3066\u3044\u304d\u307e\u3059\u3002\n\n```\nEndpoint.prototype._write = function _write(chunk, encoding, done) {\n  this._deserializer.write(chunk, encoding, done);\n};\n```\n###### 2.2 Readable\u3068\u3057\u3066\u306e\u5f79\u5272\n\u76f8\u624b\u306b\u9001\u4fe1\u3057\u305f\u3044\u30c7\u30fc\u30bf\u3092\u512a\u5148\u5ea6\u7ba1\u7406->\u30d5\u30ed\u30fc\u5236\u5fa1->\u5727\u7e2e->\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u3092\u3057\u3066TCP, TLS\u306e\u30bd\u30b1\u30c3\u30c8\u306b\u9001\u308a\u307e\u3059\u3002\n\u6b21\u306e\u3088\u3046\u306b`_serializer`\u304b\u3089\u30c7\u30fc\u30bf\u3092\u8aad\u307f\u8fbc\u3093\u3067`push`\u3092\u3059\u308b\u306e\u3067\u3001\u30e6\u30fc\u30b6\u304c`response.write(data)`\u3067\u6e21\u3057\u305f\u30c7\u30fc\u30bf\u306a\u3069\u3082stream\u304b\u3089`_connection`->`_compressor`->`_serializer`->`socket`\u3068\u30c7\u30fc\u30bf\u304c\u6e21\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n```\n\nEndpoint.prototype._read = function _read() {\n  this._readableState.sync = true;\n  var moreNeeded = noread, chunk;\n  while (moreNeeded && (chunk = this._serializer.read())) {\n    moreNeeded = this.push(chunk);\n  }\n  if (moreNeeded === noread) {\n    this._serializer.once('readable', this._read.bind(this));\n  }\n  this._readableState.sync = false;\n};\n```\n\n### 3 flow.js\n\u30d5\u30ed\u30fc\u5236\u5fa1\u3092\u3057\u307e\u3059\u3002Connection\u306e\u89aa\u30af\u30e9\u30b9\u3067\u3001Stream\u306fFlow\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u30d7\u30ed\u30d1\u30c6\u30a3`upstream`\u3068\u3057\u3066\u6301\u3061\u307e\u3059\u3002\n\nReadableStream\u306f\u5185\u90e8\u306b\u30ad\u30e5\u30fc\u3092\u6301\u3061\u30c7\u30fc\u30bf\u3092\u7ba1\u7406\u3057\u307e\u3059\u304c\u3001Flow\u3067\u306f\u3053\u308c\u3092output queue\u3068\u547c\u3073window\u30b5\u30a4\u30ba\u3092\u898b\u3066\u9001\u4fe1\u3059\u308b\u3053\u3068\u304c\u6c7a\u307e\u3063\u305f\u30c7\u30fc\u30bf\u306e\u30ad\u30e5\u30fc\u3068\u3057\u3066\u6271\u3044\u307e\u3059\u3002\u307e\u305f\u3001\u81ea\u8eab\u306e\u30d7\u30ed\u30d1\u30c6\u30a3\u3067\u3082flow control queue\u3068\u3057\u3066\u5225\u306b`this._queue`\u3092\u6301\u3061\u3001window\u30b5\u30a4\u30ba\u304c\u7a7a\u304f\u306e\u3092\u5f85\u3063\u3066\u3044\u305f\u308aoutput queue\u306b\u307e\u3060\u5165\u308a\u5207\u3063\u3066\u3044\u306a\u3044\u30d5\u30ec\u30fc\u30e0\u3092\u4fdd\u6301\u3057\u307e\u3059\u3002\n\u4f8b\u3048\u3070\u30c7\u30fc\u30bf\u306e\u9001\u4fe1\u6642\u306b`_read`\u306a\u3069\u306e\u5225\u30e1\u30bd\u30c3\u30c9\u304b\u3089\u547c\u3070\u308c\u308b`push()`\u3068`_push()`\u306f\u6b21\u306e\u901a\u308a\u3067\u3059\u3002\n\n```\nFlow.prototype.push = function push(frame) {\n  var moreNeeded = null;\n  if (this._queue.length === 0) {\n    moreNeeded = this._push(frame); // output queue\u306b\u30d7\u30c3\u30b7\u30e5\n  }\n\n  if (moreNeeded === null) {\n    this._queue.push(frame); // flow control queue\u306b\u30d7\u30c3\u30b7\u30e5\n  }\n\n  return moreNeeded;\n};\n\n// \u30d5\u30ec\u30fc\u30e0\u306e\u4e2d\u8eab\u5168\u90e8\u3092output queue\u306b\u30d7\u30c3\u30b7\u30e5\u3067\u304d\u306a\u304b\u3063\u305f\u3089null\u3092\u8fd4\u3059\nFlow.prototype._push = function _push(frame) {\n  var data = frame && (frame.type === 'DATA') && frame.data;\n\n  // (DATA\u30d5\u30ec\u30fc\u30e0\u4ee5\u5916 || window\u30b5\u30a4\u30ba\u306b\u5165\u308a\u304d\u308b)\u5834\u5408\u306f_parentPush\u3067output queue\u306b\u30d7\u30c3\u30b7\u30e5\n  if (!data || (data.length <= this._window)) {\n    return this._parentPush(frame);\n  } else if (this._window <= 0) {\n    return null;\n  } else {\n  \n    frame.data = data.slice(this._window);//window\u30b5\u30a4\u30ba\u304b\u3089\u306f\u307f\u51fa\u305f\u5206\u3092frame.data\u306b\u6b8b\u3059\n    this._parentPush({\n      type: 'DATA',\n      flags: {},\n      stream: frame.stream,\n      data: data.slice(0, this._window)//window\u30b5\u30a4\u30ba\u306e\u5206\u3060\u3051\u5207\u308a\u53d6\u3063\u3066\u9001\u308b\n    });\n    return null;\n  }\n};\n```\n\n`_parentPush()`\u3067\u9001\u4fe1\u3059\u308b\u3068\u304d\u3084\u76f8\u624b\u304b\u3089`'WINDOW_UPDATE'`\u3092\u53d7\u3051\u53d6\u3063\u305f\u6642\u306b`_window`\u306e\u5897\u6e1b\u3092\u3057\u307e\u3059\u3002\n\n\u307e\u305f\u3001`_read()`,`_write()`\u304c\u547c\u3070\u308c\u305f\u3068\u304d\u306b\u4eee\u60f3\u95a2\u6570\u306e`_send()`,`_receive()`\u3092\u547c\u3076\u306e\u3067\u3001\u5b50\u30af\u30e9\u30b9\u3067\u3042\u308bConnection\u306f`_read()`, `_write()`\u3067\u306f\u306a\u304f`_send()`, `_receive()`\u3092\u5b9f\u88c5\u3057\u307e\u3059\u3002\n### 4 connection.js\nConnection\u306f\u30b5\u30fc\u30d0\u3068\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u9593\u3067\uff11\u3064\u3060\u3051\u5b58\u5728\u3057\u3001\u8907\u6570\u306e\u30b9\u30c8\u30ea\u30fc\u30e0\u3092\u7ba1\u7406\u3057\u307e\u3059\u3002`stream`\u306e\u7ba1\u7406\u3084\u512a\u5148\u5ea6\u306e\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3092\u5b9f\u88c5\u3057\u3066\u3044\u307e\u3059\u3002\n\nStream\u3092\u4e8c\u3064\u306e\u914d\u5217(map)\u3067\u4fdd\u6301\u3057\u307e\u3059\u3002\u8907\u6570\u306e\u30b9\u30c8\u30ea\u30fc\u30e0\u304c\u540c\u4e00\u306e\u512a\u5148\u5ea6\u306e\u5834\u5408\u3082\u3042\u308b\u306e\u3067\u3001`_streamPriorities`\u306fpriority\u306b\u5bfe\u3057\u3066\u30b9\u30c8\u30ea\u30fc\u30e0\u306e\u914d\u5217\u3092\u6301\u3061\u307e\u3059\u3002\n\n```\n  this._streamIds = []; // (id -> stream) \u53d7\u4fe1\u7528\u306e\u30b9\u30c8\u30ea\u30fc\u30e0\n  this._streamPriorities = []; // (priority -> [stream]) \u9001\u4fe1\u7528\u306e\u30b9\u30c8\u30ea\u30fc\u30e0\n```\n\u65b0\u3057\u304f\u30ea\u30bd\u30fc\u30b9\u3092\u9001\u4fe1\u3059\u308b\u3068\u304d\u30fb\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u6700\u521d\u306e\u30d5\u30ec\u30fc\u30e0\u304c\u6765\u305f\u3068\u304d\u30fbPUSH_PROMISE\u306e\u30d5\u30ec\u30fc\u30e0\u3092\u9001\u308b\u3068\u304d\u306a\u3069\u3001`Stream`\u3092\u4f5c\u6210\u3057\u3066\u5404map\u306b\u8ffd\u52a0\u3057\u3001`_allocateId()`\u3067id\u3092\u30bb\u30c3\u30c8\u3057\u307e\u3059\u3002\n\u4ed5\u69d8\u901a\u308a\u3001ID\u304c0\u306e\u30b9\u30c8\u30ea\u30fc\u30e0`_streamIds[0]`\u306f`SETTINGS`\u30d5\u30ec\u30fc\u30e0\u3092\u9001\u53d7\u4fe1\u3059\u308b\u305f\u3081\u306e\u7279\u5225\u306a\u30b9\u30c8\u30ea\u30fc\u30e0\u3068\u3057\u3066\u4f5c\u6210\u3055\u308c\u307e\u3059\u3002\n\n\u5f8c\u8ff0\u3059\u308b\u901a\u308a\u3001\u5404`stream`\u306f\u30d7\u30ed\u30d1\u30c6\u30a3\u306b`Flow`\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9`upstream`\u3092\u6301\u3063\u3066\u304a\u308a\u3001Connection\u304b\u3089`stream`\u306e\u30c7\u30fc\u30bf\u3092\u8aad\u307f\u66f8\u304d\u3059\u308b\u5834\u5408\u306f`stream.upstream.write()`\u306e\u3088\u3046\u306b`upstream`\u3092\u4ecb\u3057\u3066\u884c\u3044\u307e\u3059\u3002(`upstream`\u306f`stream`\u306b`_send()`,`_receive()`\u51e6\u7406\u3092\u59d4\u8b72\u3057\u3066\u3044\u308b)\n\n\u4f8b\u3048\u3070\u9001\u4fe1\u3059\u308b\u30c7\u30fc\u30bf\u3092\u8981\u6c42\u3055\u308c\u308b\u3068\u304d\u306b\u547c\u3070\u308c\u308b`_send()`\u3067\u306f\u4fdd\u6301\u3059\u308b\u30b9\u30c8\u30ea\u30fc\u30e0\u306b\u5bfe\u3057\u512a\u5148\u5ea6\u9806\u306b`read()`\u3057\u3066\u30d5\u30ec\u30fc\u30e0\u3092\u8aad\u307f\u8fbc\u307f\u3001\u81ea\u8eab(Flow)\u306eoutput queue\u3068flow control queue\u304c\u3044\u3063\u3071\u3044\u306b\u306a\u308b\u307e\u3067\u30d7\u30c3\u30b7\u30e5\u3057\u307e\u3059\u3002\u9577\u3044\u3067\u3059\u304c\u6b21\u306e\u901a\u308a\u3067\u3059\u3002\n\n```\nConnection.prototype._send = function _send(immediate) {\n    ...\npriority_loop:\n  // \u512a\u5148\u5ea6\u9806\u306b\u30b9\u30c8\u30ea\u30fc\u30e0\u3092\u51e6\u7406\u3057\u3066\u3044\u304f\n  for (var priority in this._streamPriorities) {\n    var bucket = this._streamPriorities[priority];\n    var nextBucket = [];\n\n    while (bucket.length > 0) {\n      for (var index = 0; index < bucket.length; index++) {\n        var stream = bucket[index];\n        var frame = stream.upstream.read((this._window > 0) ? this._window : -1);\n\n        if (!frame) {\n          continue;\n        } else if (frame.count_change > this._streamSlotsFree) {\n          //frame.count_change\u306f\u3053\u306e\u30d5\u30ec\u30fc\u30e0\u306e\u9001\u53d7\u4fe1\u306b\u3088\u3063\u3066\u5897\u6e1b\u3059\u308b\u30b9\u30c8\u30ea\u30fc\u30e0\u306e\u6570(-1\u304b0\u304b1)\n          //IDLE->OPEN\u306b\u3059\u308b\u30d5\u30ec\u30fc\u30e0\u306a\u3089+1\u3060\u3057, HALF_CLOSED->CLOSED\u306b\u3059\u308b\u30d5\u30ec\u30fc\u30e0\u306a\u3089-1\n          //_streamSlotsFree\u306f(SETTINGS_MAX_CONCURRENT_STREAMS - \u4f7f\u7528\u4e2d\u306e\u30b9\u30c8\u30ea\u30fc\u30e0\u6570)\n          stream.upstream.unshift(frame); //\u3053\u306e\u30d5\u30ec\u30fc\u30e0\u3092\u51e6\u7406\u3059\u308b\u3068SETTINGS_MAX_CONCURRENT_STREAMS\u3092\u8d85\u3048\u3066\u3057\u307e\u3046\u306e\u3067stream\u306b\u623b\u3057\u3066\u30b9\u30ad\u30c3\u30d7\u3059\u308b\n          continue;\n        }\n\n        nextBucket.push(stream);\n\n        if (frame.stream === undefined) {\n          frame.stream = stream.id || this._allocateId(stream);\n        }\n\n        if (frame.type === 'PUSH_PROMISE') {\n          this._allocatePriority(frame.promised_stream);\n          frame.promised_stream = this._allocateId(frame.promised_stream);\n        }\n\n        var moreNeeded = this.push(frame);//output queue\u304bflow control queue\u306b\u30d7\u30c3\u30b7\u30e5\n        this._changeStreamCount(frame.count_change);\n\n        if (moreNeeded === false) {\n          break priority_loop;\n        }\n      }\n\n      bucket = nextBucket;\n      nextBucket = [];\n    }\n  }\n\n  // \u30d5\u30ec\u30fc\u30e0\u3092\u9001\u4fe1\u3067\u304d\u306a\u304b\u3063\u305f\u3089window update\u306a\u3069queue\u304c\u7a7a\u304f\u30bf\u30a4\u30df\u30f3\u30b0\u3092\u5f85\u3064\n  if (moreNeeded === undefined) {\n    this.once('wakeup', this._send.bind(this));\n  }\n};\n```\n\n### stream.js\n\uff11\u7d44\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3068\u30ec\u30b9\u30dd\u30f3\u30b9\u306e\u4ea4\u63db\u306b\u4f7f\u308f\u308c\u308b\u30b9\u30c8\u30ea\u30fc\u30e0\u3067\u3059\u3002idle, closed\u306a\u3069\u306e\u72b6\u614b\u7ba1\u7406\u306e\u51e6\u7406\u3084`promise()`,`headers()`\u306a\u3069\u30e6\u30fc\u30b6\u5074\u304b\u3089\u547c\u3070\u308c\u308b\u30e1\u30bd\u30c3\u30c9\u304c\u3042\u308a\u307e\u3059\u3002\n\n\u30e6\u30fc\u30b6\u5074\u304b\u3089`write()`\u3067\u6e21\u3057\u305f\u30c7\u30fc\u30bf\u306fconnection\u304b\u3089\u306f`stream.upstream.read()`\u3067\u53d6\u5f97\u3057\u3001connection\u304b\u3089`stream.upstream.write()`\u3067\u6e21\u3057\u305f\u30c7\u30fc\u30bf\u306f\u30e6\u30fc\u30b6\u5074\u304b\u3089\u306f`read()`\u3067\u53d6\u5f97\u3067\u304d\u307e\u3059\u3002\n\n`_read()`\u3068`_write()`\u306f\u30e6\u30fc\u30b6\u5074\u3068\u306e\u3084\u308a\u3068\u308a\u3067\u3001`_receive()`\u3068`_send()`\u306fconnection\u3001\u3064\u307e\u308aupstream\u5074\u3068\u306e\u3084\u308a\u3068\u308a\u3067\u547c\u3070\u308c\u308b\u30e1\u30bd\u30c3\u30c9\u3067\u3059\u3002`_write()`\u3084`_receive()`\u306f\u5f15\u6570\u306b\u95a2\u6570`ready`\u304c\u6e21\u3055\u308c\u308b\u306e\u3067\u3001\u6b21\u306e\u30c7\u30fc\u30bf\u3092\u53d7\u3051\u53d6\u308c\u308b\u72b6\u614b\u306b\u306a\u3063\u305f\u3068\u304d\u306b\u3053\u308c\u3092\u547c\u3076\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n`_read()`, `_write()`, `_receive()`, `_send()`\u306f\u6b21\u306e\u901a\u308a\u3067\u3059\u3002\n\n```\nStream.prototype._initializeDataFlow = function _initializeDataFlow() {\n  // \u521d\u671f\u5316\n  this.upstream = new Flow();\n  this.upstream._send = this._send.bind(this);\n  this.upstream._receive = this._receive.bind(this);\n};\n\n// \u30c7\u30fc\u30bf\u3092\u53d7\u4fe1\u3057\u305f\u3068\u304d\u547c\u3070\u308c\u308b\nStream.prototype._receive = function _receive(frame, ready) {\n  // \u6b21\u306e\u30c7\u30fc\u30bf\u3092\u53d7\u3051\u53d6\u308c\u308b\u72b6\u614b\u306b\u306a\u3063\u305f\u3068\u304d\u306bready()\u3092\u547c\u3076\n  \n  if (!this._ended && (frame.type === 'DATA')) {\n    var moreNeeded = this.push(frame.data);\n    if (!moreNeeded) {\n      this._receiveMore = ready; // queue\u304c\u3044\u3063\u3071\u3044\u306a\u306e\u3067ready\u306f\u5225\u306e\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u547c\u3076\n    }\n  }\n  \n  if (!this._ended && (frame.flags.END_STREAM || (frame.type === 'RST_STREAM'))) {\n    this.push(null);\n    this._ended = true;\n  }\n\n  if (this._receiveMore !== ready) {\n    ready();\n  }\n};\n\n// \u30e6\u30fc\u30b6\u5074\u304c\u30c7\u30fc\u30bf\u3092\u8aad\u307f\u8fbc\u307f\u305f\u3044\u3068\u304d\u306b\u547c\u3070\u308c\u308b\nStream.prototype._read = function _read() {\n  if (this._receiveMore) {\n    var receiveMore = this._receiveMore;\n    delete this._receiveMore;\n    receiveMore(); // \u4e0a\u8ff0\u306eready\u3092\u547c\u3093\u3060\u306e\u3067\u6b21\u306e\u30c7\u30fc\u30bf\u304c\u307e\u305f_receive\u306b\u6d41\u308c\u3066\u304f\u308b\n  }\n};\n\n// \u30e6\u30fc\u30b6\u5074\u304b\u3089\u66f8\u304d\u8fbc\u307e\u308c\u305f\u3068\u304d\u306b\u547c\u3070\u308c\u308b\nStream.prototype._write = function _write(buffer, encoding, ready) {\n  var moreNeeded = this._pushUpstream({\n    type: 'DATA',\n    flags: {},\n    stream: this.id,\n    data: buffer\n  });\n\n  if (moreNeeded) {\n    ready(); \n  } else {\n    this._sendMore = ready; // ready()\u306f\u307e\u3060\u547c\u3070\u305a\u3001queue\u304c\u7a7a\u3044\u3066\u9001\u4fe1\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u3068\u304d\u306b\u547c\u3076\n  }\n};\n\n// \u6b21\u306e\u30c7\u30fc\u30bf\u3092\u9001\u4fe1\u3057\u305f\u3044\u3068\u304d\u306b\u4e0a\u6d41\u304b\u3089\u547c\u3070\u308c\u308b\nStream.prototype._send = function _send() {\n  if (this._sendMore) {\n    var sendMore = this._sendMore;\n    delete this._sendMore;\n    sendMore(); \n  }\n};\n\nStream.prototype._pushUpstream = function _pushUpstream(frame) {\n  this.upstream.push(frame);\n  this._transition(true, frame); // \u72b6\u614b\u9077\u79fb\n};\n```\n#\u307e\u3068\u3081\u3068\u611f\u60f3\nHTTP/2\u306f\u30b9\u30c6\u30fc\u30c8\u30d5\u30eb\u3067\u5b9f\u88c5\u304c\u8907\u96d1\u306b\u306a\u308a\u3059\u304e\u308b\u3068\u3044\u3046\u6279\u5224\u304c\u3042\u308a\u307e\u3057\u305f\u304c\u78ba\u304b\u306b\u5c11\u3057\u96e3\u3057\u3044\u611f\u3058\u304c\u3057\u307e\u3059\u3002stream\u306e\u591a\u91cd\u5316(ID\u7ba1\u7406)\u3001\u72b6\u614b\u7ba1\u7406\u3001\u512a\u5148\u5ea6\u3001\u30d5\u30ed\u30fc\u5236\u5fa1\u306a\u3069\u6a5f\u80fd\u304c\u591a\u304f\u3001\u4fdd\u6301\u3059\u308b\u60c5\u5831\u30fb\u5909\u6570\u3082\u591a\u304f\u306a\u308b\u306e\u3067\u30b4\u30c1\u30e3\u30b4\u30c1\u30e3\u306b\u306a\u3089\u306a\u3044\u3088\u3046\u3057\u3063\u304b\u308a\u5207\u308a\u5206\u3051\u3066\u5b9f\u88c5\u3059\u308b\u306e\u304c\u5927\u4e8b\u3060\u3068\u601d\u3044\u307e\u3057\u305f\u3002\n\nStream API\u306f\u304b\u306a\u308a\u4fbf\u5229\u3067\u3088\u3057\u306a\u306b\u30d0\u30c3\u30d5\u30a1\u30ea\u30f3\u30b0\u3092\u3057\u3066\u304f\u308c\u308b\u3053\u3068\u306f\u3082\u3061\u308d\u3093\u3001`push()`\u3001`pipe()`\u3084`'data'`\u30a4\u30d9\u30f3\u30c8\u306a\u3069\u7c21\u5358\u306a\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u3067\u30c7\u30fc\u30bf\u306e\u5165\u529b\u5143\u3001\u51fa\u529b\u5148\u306e\u5b9f\u88c5\u3084\u5229\u7528\u304c\u3067\u304d\u308b\u306e\u3082\u3044\u3044\u70b9\u3060\u3068\u601d\u3044\u307e\u3059\u3002\n\n\n"}