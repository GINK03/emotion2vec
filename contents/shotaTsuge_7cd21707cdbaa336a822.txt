{"context": " More than 1 year has passed since last update.\u534a\u5e74\u9593\u3001MySQL\u3092\u57fa\u790e\u304b\u3089\u3084\u308a\u76f4\u3059\u3053\u3068\u306b\u3057\u305f\u306e\u3067\u3001\u305d\u306e\u9593\u306b\u52c9\u5f37\u3057\u305f\u3053\u3068\u3092Qiita\u306b\u6295\u7a3f\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\nMySQL-MHA\u3092\u5c0e\u5165\u3057\u3066\u307f\u308b\n\nMHA\u69cb\u6210\n# Server\nmysql-dbm01\uff1a(mysqldb-master)\nmysql-dbs01\uff1a(mysqldb-slave)\nmysql-dbctl01\uff1a(mysql-mha-manager)\n\nOS\uff1aCentOS6.5\nMySQL\uff1a5.5.38\n\nMySQL\u306f\u65e2\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6e08\u307f\u3068\u3044\u3046\u524d\u63d0\u3067\u9032\u3081\u308b\u306e\u3067\u3001\u3082\u3057\u307e\u3060\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u306a\u3044\u5834\u5408\u306f\n\u4e0b\u8a18\u624b\u9806\u3092\u53c2\u8003\u306b\u6e96\u5099\u3057\u3066\u304a\u3044\u3066\u4e0b\u3055\u3044\nCentOS6.5\u306bMySQL5.5.38\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u624b\u9806\nMySQL\u3067\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u7d44\u3093\u3067\u307f\u308b\nMySQL\u306emaster\u3068slave\u306e\u624b\u52d5\u5207\u308a\u66ff\u3048\n\nMHA\u69cb\u6210\u306b\u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nMySQL\u30b5\u30fc\u30d0\u3078MHA\u30ce\u30fc\u30c9(mha4mysql-node)\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ cd /usr/local/src\n$ wget https://72003f4c60f5cc941cd1c7d448fc3c99e0aebaa8.googledrive.com/host/0B1lu97m8-haWeHdGWXp0YVVUSlk/mha4mysql-node-0.56-0.el6.noarch.rpm\n$ yum localinstall mha4mysql-node-0.56-0.el6.noarch.rpm\n\n$ rpm -ql mha4mysql-node\n\n\nMHA\u30de\u30cd\u30fc\u30b8\u30e3(mha4mysql-manager)\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ cd /usr/local/src\n$ wget https://72003f4c60f5cc941cd1c7d448fc3c99e0aebaa8.googledrive.com/host/0B1lu97m8-haWeHdGWXp0YVVUSlk/mha4mysql-node-0.56-0.el6.noarch.rpm\n$ wget https://72003f4c60f5cc941cd1c7d448fc3c99e0aebaa8.googledrive.com/host/0B1lu97m8-haWeHdGWXp0YVVUSlk/mha4mysql-manager-0.56-0.el6.noarch.rpm\n$ yum localinstall mha4mysql-node-0.56-0.el6.noarch.rpm\n$ yum localinstall mha4mysql-manager-0.56-0.el6.noarch.rpm\n$ rpm -ql mha4mysql-manager\n\n\nMHA\u69cb\u7bc9\u524d\u306e\u4e8b\u524d\u6e96\u5099\n\nssh\u30ed\u30b0\u30a4\u30f3\u51fa\u6765\u308b\u7528\u306b\u8a2d\u5b9a\u3059\u308b\n# mysql-dbctl01\uff1a(mysql-mha-manager)\u3067\u9375\u3092\u4f5c\u6210\u3057\u3001\u4ed6\u306e\u30b5\u30fc\u30d0\u3078\u3082\u5c55\u958b\u3059\u308b\n$ su - mysql\n$ ssh-keygen -t rsa\n$ cd /var/lib/mysql/.ssh\n$ mv id_rsa.pub authorized_keys\n$ chmod 600 authorized_keys\n\n# myql\u30b5\u30fc\u30d0(master:slave)\u306b\u3082scp\u30b3\u30de\u30f3\u30c9\u3067\u914d\u5e03\u3059\u308b\n$ scp id_rsa {user_name}@XXX.XXX.XXX.XXX:/var/lib/mysql/.ssh\n$ scp authorized_keys {user_name}@XXX.XXX.XXX.XXX:/var/lib/mysql/.ssh\n\n# \u6a29\u9650\u5468\u308a\u3092mysql\u30e6\u30fc\u30b6\u306e600\u3067\u8a2d\u5b9a\u3057\u3066\u304a\u304f\uff08mysql-dbm01, mysql-dbs01\uff09\n$ chown mysql:mysql /var/lib/mysql/.ssh/id_rsa\n$ chown mysql:mysql /var/lib/mysql/.ssh/authorized_keys\n$ chmod 600 /var/lib/mysql/.ssh/id_rsa\n$ chmod 600 /var/lib/mysql/.ssh/authorized_keys\n\n\nmysql\u5074\u306bmha\u7528\u306e\u30e6\u30fc\u30b6\u3092\u4f5c\u6210\u3057\u3066\u304a\u304f\nmysql> GRANT ALL ON *.* TO 'mha'@'XXX.XXX.XXX.XXX' IDENTIFIED BY 'mha';\nmysql> select user, host from mysql.user where user = 'mha';\n+------+-----------------+\n| user | host            |\n+------+-----------------+\n| mha  | XXX.XXX.XXX.XXX |\n+------+-----------------+\n1 row in set (0.00 sec)\n\n\n\u30ed\u30b0\u30fb\u4f5c\u696d\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u6e96\u5099\n# \u4eca\u56de\u306f\u3001manager_workdir\u30fbremote_workdir\u3082\u540c\u3058\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u69cb\u6210\u306b\u3057\u305f\u306e\u3067\n# mysql-mha-manager, mysqldb(master-slave)\u5171\u306b\u540c\u3058\u3088\u3046\u306b\u7528\u610f\u3057\u307e\u3059\n$ sudo mkdir /var/lib/mha\n$ chown mysql:mysql /var/lib/mha\n$ chmod 755 /var/lib/mha\n\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n$ vim /etc/mha.cnf\n\n[server default]\n# mha\u7528\u306b\u4f5c\u6210\u3057\u305fmysql\u30e6\u30fc\u30b6\u60c5\u5831\nuser=mha\npassword=mha\n\n# mysql\u306e\u30ec\u30d7\u30ea\u7528\u30e6\u30fc\u30b6\nrepl_user=repli\nrepl_password=repli\n\n# \u30ed\u30b0\u30fb\u4f5c\u696d\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u30d1\u30b9\u60c5\u5831\n# mysql-mha-manager\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u30d1\u30b9\nmanager_workdir=/var/lib/mha\nmanager_log=/var/log/mha/mha.log\n\n# mysqldb(master-slave)\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u30d1\u30b9\nremote_workdir=/var/lib/mha\n\n# \u30d0\u30a4\u30ca\u30ea\u30ed\u30b0\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u30d1\u30b9\nmaster_binlog_dir=/var/lib/mysql\n\n# ssh\u63a5\u7d9a\u30e6\u30fc\u30b6\nssh_user=mysql\n[server1]\nhostname=XXX.XXX.XXX.XXX\n[server2]\nhostname=XXX.XXX.XXX.XXX\n\n\nMHA\u63a5\u7d9a\u6700\u7d42\u78ba\u8a8d\n\nMHA\u69cb\u6210\u306e\u30b5\u30fc\u30d0\u540c\u58eb\u3067SSH\u63a5\u7d9a\u3067\u304d\u308b\u304b\u3092\u78ba\u8a8d\u3059\u308b\n$ su - mysql\n$ masterha_check_ssh --conf=/etc/mha.cnf\nMon Nov 30 16:33:45 2015 - [info] Reading default configuration from /etc/masterha_default.cnf..\nMon Nov 30 16:33:45 2015 - [info] Reading application default configuration from /etc/mha.cnf..\nMon Nov 30 16:33:45 2015 - [info] Reading server configuration from /etc/mha.cnf..\nMon Nov 30 16:33:45 2015 - [info] Starting SSH connection tests..\nMon Nov 30 16:33:49 2015 - [debug]\nMon Nov 30 16:33:45 2015 - [debug]  Connecting via SSH from mysql@10.34.74.182(10.34.74.182:22) to mysql@XXX.XXX.XXX.XXX(XXX.XXX.XXX.XXX:22)..\nMon Nov 30 16:33:49 2015 - [debug]   ok.\nMon Nov 30 16:33:50 2015 - [debug]\nMon Nov 30 16:33:45 2015 - [debug]  Connecting via SSH from mysql@10.34.74.255(10.34.74.255:22) to mysql@XXX.XXX.XXX.XXX(XXX.XXX.XXX.XXX:22)..\nMon Nov 30 16:33:50 2015 - [debug]   ok.\nMon Nov 30 16:33:50 2015 - [info] All SSH connection tests passed successfully.\n\n\n\u3053\u3093\u306aWARNING\u304c\u51fa\u305f\u6642\u306e\u5bfe\u5fdc\nMon Nov 30 12:13:37 2015 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.\n\n\u30a8\u30e9\u30fc\u306e\u7406\u7531\u3068\u3057\u3066\u306f\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u5171\u901a\u8a2d\u5b9a\u7528\u306e/etc/masterha_default.cnf\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\n\u8aad\u307f\u306b\u3044\u304f\u304c\u30d5\u30a1\u30a4\u30eb\u304c\u306a\u3044\u306e\u3067\u51fa\u308b\u8b66\u544a\u3067\u3059\n\u307e\u3041\u30fc\u7121\u8996\u3057\u3066\u3082\u3044\u3044\u306e\u3067\u3059\u304c\u3001WARNING\u3092\u51fa\u3057\u305f\u304f\u306a\u3044\u5834\u5408\u306f\u3001\u7a7a\u30d5\u30a1\u30a4\u30eb\u3067\u3082\u3044\u3044\u306e\u3067\u3001\n\u3068\u308a\u3042\u3048\u305amasterha_default.cnf\u3092\u4f5c\u6210\u3057\u3066\u304a\u304f\u3068\u3088\u3044\u3067\u3059\u3002\n$ touch /etc/masterha_default.cnf\n\n\nMHA\u69cb\u6210\u5185\u306eDB\u30b5\u30fc\u30d0\u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u78ba\u8a8d\n$ masterha_check_repl --conf=/etc/mha.cnf\n\n\n\u3061\u306a\u307f\u306b\u3001MySQL\u30e6\u30fc\u30b6\u6a29\u9650\u5468\u308a\u304c\u8db3\u308a\u306a\u3044\u3068\u3053\u3093\u306a\u30a8\u30e9\u30fc\u51fa\u307e\u3059\n# masterha_check_repl --conf=/etc/mha.cnf\u5b9f\u884c\u3057\u305f\u3089\u3001\u3053\u3093\u306a\u30a8\u30e9\u30fc\u304c\u51fa\u305f\nmysql command failed with rc 1:0!\n at /usr/bin/apply_diff_relay_logs line 375\n    main::check() called at /usr/bin/apply_diff_relay_logs line 497\n    eval {...} called at /usr/bin/apply_diff_relay_logs line 475\n    main::main() called at /usr/bin/apply_diff_relay_logs line 120\nMon Nov 30 18:26:55 2015 - [error][/usr/share/perl5/vendor_perl/MHA/MasterMonitor.pm, ln205] Slaves settings check failed!\nMon Nov 30 18:26:55 2015 - [error][/usr/share/perl5/vendor_perl/MHA/MasterMonitor.pm, ln413] Slave configuration failed.\nMon Nov 30 18:26:55 2015 - [error][/usr/share/perl5/vendor_perl/MHA/MasterMonitor.pm, ln424] Error happened on checking configurations.  at /usr/bin/masterha_check_repl line 48\nMon Nov 30 18:26:55 2015 - [error][/usr/share/perl5/vendor_perl/MHA/MasterMonitor.pm, ln523] Error happened on monitoring servers.\nMon Nov 30 18:26:55 2015 - [info] Got exit code 1 (Not master dead).\n\nMySQL Replication Health is NOT OK!\n\n\n\u89e3\u6c7a\u7b56\n#myql\u30b5\u30fc\u30d0(master:slave)\u306bmha\u30e6\u30fc\u30b6\u306e\u6a29\u9650\u3092\u4ed8\u4e0e\u3057\u305f\uff08IP\u306f\u3001mysqldb\u3092\u3044\u308c\u308b\uff09\nmysql> GRANT ALL ON *.* TO 'mha'@'XXX.XXX.XXX.XXX' IDENTIFIED BY 'mha';\n\n#\u518d\u5ea6\u5b9f\u884c\nMySQL Replication Health is OK.\n\n\nMHA\u30d7\u30ed\u30bb\u30b9\u8d77\u52d5\u30fb\u78ba\u8a8d\u30fb\u505c\u6b62\n# MHA\u30d7\u30ed\u30bb\u30b9\u8d77\u52d5\n$ masterha_manager --conf=/etc/mha.cnf\n\n# \u5225\u306e\u30bf\u30fc\u30df\u30ca\u30eb\u3067mysql-dbctl01\uff1a(mysql-mha-manager)\u3078\u30a2\u30af\u30bb\u30b9\u3057\u3066\u78ba\u8a8d\n# MHA\u30d7\u30ed\u30bb\u30b9\u78ba\u8a8d\n$ masterha_check_status --conf=/etc/mha.cnf\nmha (pid:2659) is running(0:PING_OK), master:XXX.XXX.XXX.XXX\n\n# MHA\u30d7\u30ed\u30bb\u30b9\u505c\u6b62\n$ masterha_stop --conf=/etc/mha.cnf\nStopped mha successfully.\n\n\nMHA\u30d7\u30ed\u30bb\u30b9\u3092\u30d0\u30c3\u30af\u30b0\u30e9\u30a6\u30f3\u30c9\u3067\u5b9f\u884c\u3059\u308b\n# MHA\u30d7\u30ed\u30bb\u30b9\u958b\u59cb\n$ nohup masterha_manager --conf=/etc/mha.cnf < /dev/null > /var/log/mha/mha.log 2>&1 &\n[1] 3180\n\n# MHA\u30d7\u30ed\u30bb\u30b9\u78ba\u8a8d\n$ masterha_check_status --conf=/etc/mha.cnf\nmha (pid:3180) is running(0:PING_OK), master:XXX.XXX.XXX.XXX\n\n# MHA\u30d7\u30ed\u30bb\u30b9\u505c\u6b62\n$ masterha_stop --conf=/etc/mha.cnf\nStopped mha successfully.\n[1]+  Exit 1                  nohup masterha_manager --conf=/etc/mha.cnf < /dev/null > /var/log/mha/mha.log 2>&1\n\n\u6b21\u56de\u306f\u3001mha4mysql-manager\u306emaster_ip_failover\u4f7f\u3063\u3066\u30d5\u30a7\u30a4\u30eb\u30aa\u30fc\u30d0\u8a66\u3059\u4e88\u5b9a\u3067\u3059\u3002\n*\u534a\u5e74\u9593\u3001MySQL\u3092\u57fa\u790e\u304b\u3089\u3084\u308a\u76f4\u3059\u3053\u3068\u306b\u3057\u305f\u306e\u3067\u3001\u305d\u306e\u9593\u306b\u52c9\u5f37\u3057\u305f\u3053\u3068\u3092Qiita\u306b\u6295\u7a3f\u3057\u3066\u3044\u304d\u307e\u3059\u3002*\n\n#MySQL-MHA\u3092\u5c0e\u5165\u3057\u3066\u307f\u308b\n## MHA\u69cb\u6210\n```\n# Server\nmysql-dbm01\uff1a(mysqldb-master)\nmysql-dbs01\uff1a(mysqldb-slave)\nmysql-dbctl01\uff1a(mysql-mha-manager)\n\nOS\uff1aCentOS6.5\nMySQL\uff1a5.5.38\n```\n\nMySQL\u306f\u65e2\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6e08\u307f\u3068\u3044\u3046\u524d\u63d0\u3067\u9032\u3081\u308b\u306e\u3067\u3001\u3082\u3057\u307e\u3060\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u306a\u3044\u5834\u5408\u306f\n\u4e0b\u8a18\u624b\u9806\u3092\u53c2\u8003\u306b\u6e96\u5099\u3057\u3066\u304a\u3044\u3066\u4e0b\u3055\u3044\n[CentOS6.5\u306bMySQL5.5.38\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u624b\u9806](http://qiita.com/shotaTsuge/items/7f02fb684233188c51e1)\n[MySQL\u3067\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u7d44\u3093\u3067\u307f\u308b](http://qiita.com/shotaTsuge/items/87e872e6522e6cd8cea9)\n[MySQL\u306emaster\u3068slave\u306e\u624b\u52d5\u5207\u308a\u66ff\u3048](http://qiita.com/shotaTsuge/items/83e4387d6c8488677e17)\n\n\n## MHA\u69cb\u6210\u306b\u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n### MySQL\u30b5\u30fc\u30d0\u3078MHA\u30ce\u30fc\u30c9(mha4mysql-node)\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```\n$ cd /usr/local/src\n$ wget https://72003f4c60f5cc941cd1c7d448fc3c99e0aebaa8.googledrive.com/host/0B1lu97m8-haWeHdGWXp0YVVUSlk/mha4mysql-node-0.56-0.el6.noarch.rpm\n$ yum localinstall mha4mysql-node-0.56-0.el6.noarch.rpm\n\n$ rpm -ql mha4mysql-node\n```\n\n### MHA\u30de\u30cd\u30fc\u30b8\u30e3(mha4mysql-manager)\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n```\n$ cd /usr/local/src\n$ wget https://72003f4c60f5cc941cd1c7d448fc3c99e0aebaa8.googledrive.com/host/0B1lu97m8-haWeHdGWXp0YVVUSlk/mha4mysql-node-0.56-0.el6.noarch.rpm\n$ wget https://72003f4c60f5cc941cd1c7d448fc3c99e0aebaa8.googledrive.com/host/0B1lu97m8-haWeHdGWXp0YVVUSlk/mha4mysql-manager-0.56-0.el6.noarch.rpm\n$ yum localinstall mha4mysql-node-0.56-0.el6.noarch.rpm\n$ yum localinstall mha4mysql-manager-0.56-0.el6.noarch.rpm\n$ rpm -ql mha4mysql-manager\n```\n\n## MHA\u69cb\u7bc9\u524d\u306e\u4e8b\u524d\u6e96\u5099\n### ssh\u30ed\u30b0\u30a4\u30f3\u51fa\u6765\u308b\u7528\u306b\u8a2d\u5b9a\u3059\u308b\n```\n# mysql-dbctl01\uff1a(mysql-mha-manager)\u3067\u9375\u3092\u4f5c\u6210\u3057\u3001\u4ed6\u306e\u30b5\u30fc\u30d0\u3078\u3082\u5c55\u958b\u3059\u308b\n$ su - mysql\n$ ssh-keygen -t rsa\n$ cd /var/lib/mysql/.ssh\n$ mv id_rsa.pub authorized_keys\n$ chmod 600 authorized_keys\n\n# myql\u30b5\u30fc\u30d0(master:slave)\u306b\u3082scp\u30b3\u30de\u30f3\u30c9\u3067\u914d\u5e03\u3059\u308b\n$ scp id_rsa {user_name}@XXX.XXX.XXX.XXX:/var/lib/mysql/.ssh\n$ scp authorized_keys {user_name}@XXX.XXX.XXX.XXX:/var/lib/mysql/.ssh\n\n# \u6a29\u9650\u5468\u308a\u3092mysql\u30e6\u30fc\u30b6\u306e600\u3067\u8a2d\u5b9a\u3057\u3066\u304a\u304f\uff08mysql-dbm01, mysql-dbs01\uff09\n$ chown mysql:mysql /var/lib/mysql/.ssh/id_rsa\n$ chown mysql:mysql /var/lib/mysql/.ssh/authorized_keys\n$ chmod 600 /var/lib/mysql/.ssh/id_rsa\n$ chmod 600 /var/lib/mysql/.ssh/authorized_keys\n```\n\n### mysql\u5074\u306bmha\u7528\u306e\u30e6\u30fc\u30b6\u3092\u4f5c\u6210\u3057\u3066\u304a\u304f\n```\nmysql> GRANT ALL ON *.* TO 'mha'@'XXX.XXX.XXX.XXX' IDENTIFIED BY 'mha';\nmysql> select user, host from mysql.user where user = 'mha';\n+------+-----------------+\n| user | host            |\n+------+-----------------+\n| mha  | XXX.XXX.XXX.XXX |\n+------+-----------------+\n1 row in set (0.00 sec)\n```\n\n### \u30ed\u30b0\u30fb\u4f5c\u696d\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u6e96\u5099\n\n```\n# \u4eca\u56de\u306f\u3001manager_workdir\u30fbremote_workdir\u3082\u540c\u3058\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u69cb\u6210\u306b\u3057\u305f\u306e\u3067\n# mysql-mha-manager, mysqldb(master-slave)\u5171\u306b\u540c\u3058\u3088\u3046\u306b\u7528\u610f\u3057\u307e\u3059\n$ sudo mkdir /var/lib/mha\n$ chown mysql:mysql /var/lib/mha\n$ chmod 755 /var/lib/mha\n```\n\n### \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n```\n$ vim /etc/mha.cnf\n\n[server default]\n# mha\u7528\u306b\u4f5c\u6210\u3057\u305fmysql\u30e6\u30fc\u30b6\u60c5\u5831\nuser=mha\npassword=mha\n\n# mysql\u306e\u30ec\u30d7\u30ea\u7528\u30e6\u30fc\u30b6\nrepl_user=repli\nrepl_password=repli\n\n# \u30ed\u30b0\u30fb\u4f5c\u696d\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u30d1\u30b9\u60c5\u5831\n# mysql-mha-manager\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u30d1\u30b9\nmanager_workdir=/var/lib/mha\nmanager_log=/var/log/mha/mha.log\n\n# mysqldb(master-slave)\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u30d1\u30b9\nremote_workdir=/var/lib/mha\n\n# \u30d0\u30a4\u30ca\u30ea\u30ed\u30b0\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u30d1\u30b9\nmaster_binlog_dir=/var/lib/mysql\n\n# ssh\u63a5\u7d9a\u30e6\u30fc\u30b6\nssh_user=mysql\n[server1]\nhostname=XXX.XXX.XXX.XXX\n[server2]\nhostname=XXX.XXX.XXX.XXX\n```\n\n## MHA\u63a5\u7d9a\u6700\u7d42\u78ba\u8a8d\n###MHA\u69cb\u6210\u306e\u30b5\u30fc\u30d0\u540c\u58eb\u3067SSH\u63a5\u7d9a\u3067\u304d\u308b\u304b\u3092\u78ba\u8a8d\u3059\u308b\n```\n$ su - mysql\n$ masterha_check_ssh --conf=/etc/mha.cnf\nMon Nov 30 16:33:45 2015 - [info] Reading default configuration from /etc/masterha_default.cnf..\nMon Nov 30 16:33:45 2015 - [info] Reading application default configuration from /etc/mha.cnf..\nMon Nov 30 16:33:45 2015 - [info] Reading server configuration from /etc/mha.cnf..\nMon Nov 30 16:33:45 2015 - [info] Starting SSH connection tests..\nMon Nov 30 16:33:49 2015 - [debug]\nMon Nov 30 16:33:45 2015 - [debug]  Connecting via SSH from mysql@10.34.74.182(10.34.74.182:22) to mysql@XXX.XXX.XXX.XXX(XXX.XXX.XXX.XXX:22)..\nMon Nov 30 16:33:49 2015 - [debug]   ok.\nMon Nov 30 16:33:50 2015 - [debug]\nMon Nov 30 16:33:45 2015 - [debug]  Connecting via SSH from mysql@10.34.74.255(10.34.74.255:22) to mysql@XXX.XXX.XXX.XXX(XXX.XXX.XXX.XXX:22)..\nMon Nov 30 16:33:50 2015 - [debug]   ok.\nMon Nov 30 16:33:50 2015 - [info] All SSH connection tests passed successfully.\n```\n\n### \u3053\u3093\u306aWARNING\u304c\u51fa\u305f\u6642\u306e\u5bfe\u5fdc\n\n```\nMon Nov 30 12:13:37 2015 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.\n```\n\n\u30a8\u30e9\u30fc\u306e\u7406\u7531\u3068\u3057\u3066\u306f\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u5171\u901a\u8a2d\u5b9a\u7528\u306e/etc/masterha_default.cnf\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\n\u8aad\u307f\u306b\u3044\u304f\u304c\u30d5\u30a1\u30a4\u30eb\u304c\u306a\u3044\u306e\u3067\u51fa\u308b\u8b66\u544a\u3067\u3059\n\n\u307e\u3041\u30fc\u7121\u8996\u3057\u3066\u3082\u3044\u3044\u306e\u3067\u3059\u304c\u3001WARNING\u3092\u51fa\u3057\u305f\u304f\u306a\u3044\u5834\u5408\u306f\u3001\u7a7a\u30d5\u30a1\u30a4\u30eb\u3067\u3082\u3044\u3044\u306e\u3067\u3001\n\u3068\u308a\u3042\u3048\u305amasterha_default.cnf\u3092\u4f5c\u6210\u3057\u3066\u304a\u304f\u3068\u3088\u3044\u3067\u3059\u3002\n\n```\n$ touch /etc/masterha_default.cnf\n```\n\n### MHA\u69cb\u6210\u5185\u306eDB\u30b5\u30fc\u30d0\u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u78ba\u8a8d\n```\n$ masterha_check_repl --conf=/etc/mha.cnf\n```\n\n### \u3061\u306a\u307f\u306b\u3001MySQL\u30e6\u30fc\u30b6\u6a29\u9650\u5468\u308a\u304c\u8db3\u308a\u306a\u3044\u3068\u3053\u3093\u306a\u30a8\u30e9\u30fc\u51fa\u307e\u3059\n```\n# masterha_check_repl --conf=/etc/mha.cnf\u5b9f\u884c\u3057\u305f\u3089\u3001\u3053\u3093\u306a\u30a8\u30e9\u30fc\u304c\u51fa\u305f\nmysql command failed with rc 1:0!\n at /usr/bin/apply_diff_relay_logs line 375\n\tmain::check() called at /usr/bin/apply_diff_relay_logs line 497\n\teval {...} called at /usr/bin/apply_diff_relay_logs line 475\n\tmain::main() called at /usr/bin/apply_diff_relay_logs line 120\nMon Nov 30 18:26:55 2015 - [error][/usr/share/perl5/vendor_perl/MHA/MasterMonitor.pm, ln205] Slaves settings check failed!\nMon Nov 30 18:26:55 2015 - [error][/usr/share/perl5/vendor_perl/MHA/MasterMonitor.pm, ln413] Slave configuration failed.\nMon Nov 30 18:26:55 2015 - [error][/usr/share/perl5/vendor_perl/MHA/MasterMonitor.pm, ln424] Error happened on checking configurations.  at /usr/bin/masterha_check_repl line 48\nMon Nov 30 18:26:55 2015 - [error][/usr/share/perl5/vendor_perl/MHA/MasterMonitor.pm, ln523] Error happened on monitoring servers.\nMon Nov 30 18:26:55 2015 - [info] Got exit code 1 (Not master dead).\n\nMySQL Replication Health is NOT OK!\n```\n#### \u89e3\u6c7a\u7b56\n```\n#myql\u30b5\u30fc\u30d0(master:slave)\u306bmha\u30e6\u30fc\u30b6\u306e\u6a29\u9650\u3092\u4ed8\u4e0e\u3057\u305f\uff08IP\u306f\u3001mysqldb\u3092\u3044\u308c\u308b\uff09\nmysql> GRANT ALL ON *.* TO 'mha'@'XXX.XXX.XXX.XXX' IDENTIFIED BY 'mha';\n\n#\u518d\u5ea6\u5b9f\u884c\nMySQL Replication Health is OK.\n```\n\n##MHA\u30d7\u30ed\u30bb\u30b9\u8d77\u52d5\u30fb\u78ba\u8a8d\u30fb\u505c\u6b62\n\n```\n# MHA\u30d7\u30ed\u30bb\u30b9\u8d77\u52d5\n$ masterha_manager --conf=/etc/mha.cnf\n\n# \u5225\u306e\u30bf\u30fc\u30df\u30ca\u30eb\u3067mysql-dbctl01\uff1a(mysql-mha-manager)\u3078\u30a2\u30af\u30bb\u30b9\u3057\u3066\u78ba\u8a8d\n# MHA\u30d7\u30ed\u30bb\u30b9\u78ba\u8a8d\n$ masterha_check_status --conf=/etc/mha.cnf\nmha (pid:2659) is running(0:PING_OK), master:XXX.XXX.XXX.XXX\n\n# MHA\u30d7\u30ed\u30bb\u30b9\u505c\u6b62\n$ masterha_stop --conf=/etc/mha.cnf\nStopped mha successfully.\n```\n\n##MHA\u30d7\u30ed\u30bb\u30b9\u3092\u30d0\u30c3\u30af\u30b0\u30e9\u30a6\u30f3\u30c9\u3067\u5b9f\u884c\u3059\u308b\n```\n# MHA\u30d7\u30ed\u30bb\u30b9\u958b\u59cb\n$ nohup masterha_manager --conf=/etc/mha.cnf < /dev/null > /var/log/mha/mha.log 2>&1 &\n[1] 3180\n\n# MHA\u30d7\u30ed\u30bb\u30b9\u78ba\u8a8d\n$ masterha_check_status --conf=/etc/mha.cnf\nmha (pid:3180) is running(0:PING_OK), master:XXX.XXX.XXX.XXX\n\n# MHA\u30d7\u30ed\u30bb\u30b9\u505c\u6b62\n$ masterha_stop --conf=/etc/mha.cnf\nStopped mha successfully.\n[1]+  Exit 1                  nohup masterha_manager --conf=/etc/mha.cnf < /dev/null > /var/log/mha/mha.log 2>&1\n```\n\n\u6b21\u56de\u306f\u3001[mha4mysql-manager](https://github.com/yoshinorim/mha4mysql-manager)\u306emaster_ip_failover\u4f7f\u3063\u3066\u30d5\u30a7\u30a4\u30eb\u30aa\u30fc\u30d0\u8a66\u3059\u4e88\u5b9a\u3067\u3059\u3002\n", "tags": ["MySQL", "MHA", "\u57fa\u790e", "\u521d\u5fc3\u8005"]}