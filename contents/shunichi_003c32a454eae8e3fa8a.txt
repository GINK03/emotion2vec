{"tags": ["Rails", "poltergeist", "Capybara"], "context": "\u3053\u3093\u306a\u611f\u3058\u306e rspec \u304c\u6210\u529f\u3057\u305f\u308a\u5931\u6557\u3057\u305f\u308a\u3057\u3066\u3044\u307e\u3057\u305f\u3002\nclick_link '\u7530\u4e2d \u82b1\u5b50' # \u30e2\u30fc\u30c0\u30eb\u3092\u547c\u3073\u51fa\u3059\nclick_link '\u30ad\u30e3\u30f3\u30bb\u30eb' # \u30e2\u30fc\u30c0\u30eb\u5185\u306e\u30ea\u30f3\u30af\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u306f\u305a\uff08\u304c\u3067\u304d\u306a\u3044\u3053\u3068\u304c\u3042\u308b\uff09\nexpect(page).to have_css '.is-canceled' # \u30af\u30ea\u30c3\u30af\u3067\u304d\u3066\u306a\u3051\u308c\u3070\u5931\u6557\u3059\u308b\n\n\n\u554f\u984c\u306e\u539f\u56e0\nBootstrap3 \u306e\u30e2\u30fc\u30c0\u30eb\u304c\u30b9\u30af\u30ed\u30fc\u30eb\u3057\u3066\u3044\u308b\u6700\u4e2d\u306b\u30e2\u30fc\u30c0\u30eb\u5185\u306e\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068\u3001\u30af\u30ea\u30c3\u30af\u3057\u305f\u3068\u304d\u306b\u306f\u305d\u306e\u4f4d\u7f6e\u306b\u3059\u3067\u306b\u30dc\u30bf\u30f3\u304c\u306a\u3044\u3053\u3068\u304c\u3042\u308b\u3088\u3046\u3067\u3059\u3002\npoltergeist\u306e\u30bd\u30fc\u30b9\u3092\u898b\u308b\u3068\u3001\u3053\u306e\u3078\u3093\u3067\u554f\u984c\u304c\u8d77\u304d\u3066\u3044\u305d\u3046\u3067\u3057\u305f\u3002\n  mouseEvent: (name) ->\n    if area_image = @_getAreaImage()\n      area_image.scrollIntoView()\n    else\n      @scrollIntoView()\n    # \u30af\u30ea\u30c3\u30af\u3057\u305f\u3044DOM\u30ce\u30fc\u30c9\u306e\u4f4d\u7f6e\u3092\u53d6\u5f97\n    pos = this.mouseEventPosition() \n    # \u305d\u306e\u4f4d\u7f6e\u3067\u30ce\u30fc\u30c9\u304c\u30af\u30ea\u30c3\u30af\u3067\u304d\u308b\u304b\u30c1\u30a7\u30c3\u30af\uff08\u3053\u3053\u3067\u3082\u5931\u6557\u3059\u308b\u53ef\u80fd\u6027\u306f\u3042\u308a\u305d\u3046\u3060\u3051\u3069\u3001\u4eca\u56de\u306f\u3053\u3053\u3067\u306f\u306a\u3044\uff09\n    test = this.mouseEventTest(pos.x, pos.y) \n    if test.status == 'success'\n      if name == 'rightclick'\n        @page.mouseEvent('click', pos.x, pos.y, 'right')\n        this.trigger('contextmenu')\n      else\n        # \u5b9f\u969b\u306e\u30af\u30ea\u30c3\u30af\u306f\u5ea7\u6a19\u3060\u3051\u3067\u6307\u5b9a\uff08\u30af\u30ea\u30c3\u30af\u3059\u308b\u30ce\u30fc\u30c9\u3092\u6307\u5b9a\u3057\u3066\u3044\u308b\u308f\u3051\u3067\u306f\u306a\u3044\u306e\u3067\u3001\u3059\u3067\u306b\u305d\u3053\u306b\u30ce\u30fc\u30c9\u304c\u306a\u304f\u3066\u3082\u30a8\u30e9\u30fc\u306b\u306a\u3089\u305a\u306b\u30b9\u30eb\u30fc\u3055\u308c\u308b\uff09\n        @page.mouseEvent(name, pos.x, pos.y) \n      pos\n    else\n      throw new Poltergeist.MouseEventFailed(name, test.selector, pos)\n\n\n\u4fee\u6b63\u65b9\u6cd5 \u305d\u306e\uff11\n\u30e2\u30fc\u30c0\u30eb\u304c\u51fa\u73fe\u3059\u308b\u307e\u3067\u306e\u6642\u9593 sleep \u3057\u307e\u3059\u3002\nclick_link '\u7530\u4e2d \u82b1\u5b50' # \u30e2\u30fc\u30c0\u30eb\u3092\u547c\u3073\u51fa\u3059\nsleep 1 # \u30e2\u30fc\u30c0\u30eb\u304c\u30b9\u30af\u30ed\u30fc\u30eb\u5b8c\u4e86\u3059\u308b\u306e\u3092\u5f85\u3064(bootstrap \u306e\u30e2\u30fc\u30c0\u30eb\u306e\u30b9\u30af\u30ed\u30fc\u30eb\u306f 0.3s)\nclick_link '\u30ad\u30e3\u30f3\u30bb\u30eb' # \u30e2\u30fc\u30c0\u30eb\u5185\u306e\u30ea\u30f3\u30af\u3092\u30af\u30ea\u30c3\u30af\nexpect(page).to have_css '.is-canceled'\n\n\n\u4fee\u6b63\u65b9\u6cd5 \u305d\u306e\uff12\nsleep \u306a\u3093\u3066\u4e0d\u78ba\u5b9f\u306a\u65b9\u6cd5\u306f\u5acc\u3068\u3044\u3046\u5834\u5408\u3001\u3053\u3093\u306a\u611f\u3058\u306e\u30d8\u30eb\u30d1\u30fc\u3092\u7528\u610f\u3057\u307e\u3059\u3002\n  def wait_for_bs_modal\n    script = <<~EOS\n      window._capybaraModalWait = 1;\n      jQuery(document).one(\"shown.bs.modal\", function(){window._capybaraModalWait = 0;});\n    EOS\n    page.execute_script(script)\n    yield\n    Timeout.timeout(Capybara.default_max_wait_time) do\n      loop until page.evaluate_script('window._capybaraModalWait').zero?\n    end\n  end\n\n\u3067\u3001\u3053\u3046\u66f8\u304d\u307e\u3059\u3002\n# \u30e2\u30fc\u30c0\u30eb\u304c\u51fa\u73fe\u3059\u308b\u307e\u3067\u5f85\u3064\nwait_for_bs_modal do\n  click_link '\u7530\u4e2d \u82b1\u5b50' # \u30e2\u30fc\u30c0\u30eb\u3092\u547c\u3073\u51fa\u3059\nend\nclick_link '\u30ad\u30e3\u30f3\u30bb\u30eb' # \u30e2\u30fc\u30c0\u30eb\u5185\u306e\u30ea\u30f3\u30af\u3092\u30af\u30ea\u30c3\u30af\nexpect(page).to have_css '.is-canceled'\n\n\u3053\u3093\u306a\u611f\u3058\u306e rspec \u304c\u6210\u529f\u3057\u305f\u308a\u5931\u6557\u3057\u305f\u308a\u3057\u3066\u3044\u307e\u3057\u305f\u3002\n\n```ruby\nclick_link '\u7530\u4e2d \u82b1\u5b50' # \u30e2\u30fc\u30c0\u30eb\u3092\u547c\u3073\u51fa\u3059\nclick_link '\u30ad\u30e3\u30f3\u30bb\u30eb' # \u30e2\u30fc\u30c0\u30eb\u5185\u306e\u30ea\u30f3\u30af\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u306f\u305a\uff08\u304c\u3067\u304d\u306a\u3044\u3053\u3068\u304c\u3042\u308b\uff09\nexpect(page).to have_css '.is-canceled' # \u30af\u30ea\u30c3\u30af\u3067\u304d\u3066\u306a\u3051\u308c\u3070\u5931\u6557\u3059\u308b\n```\n\n## \u554f\u984c\u306e\u539f\u56e0\nBootstrap3 \u306e\u30e2\u30fc\u30c0\u30eb\u304c\u30b9\u30af\u30ed\u30fc\u30eb\u3057\u3066\u3044\u308b\u6700\u4e2d\u306b\u30e2\u30fc\u30c0\u30eb\u5185\u306e\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068\u3001\u30af\u30ea\u30c3\u30af\u3057\u305f\u3068\u304d\u306b\u306f\u305d\u306e\u4f4d\u7f6e\u306b\u3059\u3067\u306b\u30dc\u30bf\u30f3\u304c\u306a\u3044\u3053\u3068\u304c\u3042\u308b\u3088\u3046\u3067\u3059\u3002\n\n[poltergeist\u306e\u30bd\u30fc\u30b9](https://goo.gl/FKvSnQ)\u3092\u898b\u308b\u3068\u3001\u3053\u306e\u3078\u3093\u3067\u554f\u984c\u304c\u8d77\u304d\u3066\u3044\u305d\u3046\u3067\u3057\u305f\u3002\n\n```coffeescript\n  mouseEvent: (name) ->\n    if area_image = @_getAreaImage()\n      area_image.scrollIntoView()\n    else\n      @scrollIntoView()\n    # \u30af\u30ea\u30c3\u30af\u3057\u305f\u3044DOM\u30ce\u30fc\u30c9\u306e\u4f4d\u7f6e\u3092\u53d6\u5f97\n    pos = this.mouseEventPosition() \n    # \u305d\u306e\u4f4d\u7f6e\u3067\u30ce\u30fc\u30c9\u304c\u30af\u30ea\u30c3\u30af\u3067\u304d\u308b\u304b\u30c1\u30a7\u30c3\u30af\uff08\u3053\u3053\u3067\u3082\u5931\u6557\u3059\u308b\u53ef\u80fd\u6027\u306f\u3042\u308a\u305d\u3046\u3060\u3051\u3069\u3001\u4eca\u56de\u306f\u3053\u3053\u3067\u306f\u306a\u3044\uff09\n    test = this.mouseEventTest(pos.x, pos.y) \n    if test.status == 'success'\n      if name == 'rightclick'\n        @page.mouseEvent('click', pos.x, pos.y, 'right')\n        this.trigger('contextmenu')\n      else\n        # \u5b9f\u969b\u306e\u30af\u30ea\u30c3\u30af\u306f\u5ea7\u6a19\u3060\u3051\u3067\u6307\u5b9a\uff08\u30af\u30ea\u30c3\u30af\u3059\u308b\u30ce\u30fc\u30c9\u3092\u6307\u5b9a\u3057\u3066\u3044\u308b\u308f\u3051\u3067\u306f\u306a\u3044\u306e\u3067\u3001\u3059\u3067\u306b\u305d\u3053\u306b\u30ce\u30fc\u30c9\u304c\u306a\u304f\u3066\u3082\u30a8\u30e9\u30fc\u306b\u306a\u3089\u305a\u306b\u30b9\u30eb\u30fc\u3055\u308c\u308b\uff09\n        @page.mouseEvent(name, pos.x, pos.y) \n      pos\n    else\n      throw new Poltergeist.MouseEventFailed(name, test.selector, pos)\n```      \n\n## \u4fee\u6b63\u65b9\u6cd5 \u305d\u306e\uff11\n\u30e2\u30fc\u30c0\u30eb\u304c\u51fa\u73fe\u3059\u308b\u307e\u3067\u306e\u6642\u9593 sleep \u3057\u307e\u3059\u3002\n\n```ruby\nclick_link '\u7530\u4e2d \u82b1\u5b50' # \u30e2\u30fc\u30c0\u30eb\u3092\u547c\u3073\u51fa\u3059\nsleep 1 # \u30e2\u30fc\u30c0\u30eb\u304c\u30b9\u30af\u30ed\u30fc\u30eb\u5b8c\u4e86\u3059\u308b\u306e\u3092\u5f85\u3064(bootstrap \u306e\u30e2\u30fc\u30c0\u30eb\u306e\u30b9\u30af\u30ed\u30fc\u30eb\u306f 0.3s)\nclick_link '\u30ad\u30e3\u30f3\u30bb\u30eb' # \u30e2\u30fc\u30c0\u30eb\u5185\u306e\u30ea\u30f3\u30af\u3092\u30af\u30ea\u30c3\u30af\nexpect(page).to have_css '.is-canceled'\n```\n\n## \u4fee\u6b63\u65b9\u6cd5 \u305d\u306e\uff12\n\nsleep \u306a\u3093\u3066\u4e0d\u78ba\u5b9f\u306a\u65b9\u6cd5\u306f\u5acc\u3068\u3044\u3046\u5834\u5408\u3001\u3053\u3093\u306a\u611f\u3058\u306e\u30d8\u30eb\u30d1\u30fc\u3092\u7528\u610f\u3057\u307e\u3059\u3002\n\n```ruby\n  def wait_for_bs_modal\n    script = <<~EOS\n      window._capybaraModalWait = 1;\n      jQuery(document).one(\"shown.bs.modal\", function(){window._capybaraModalWait = 0;});\n    EOS\n    page.execute_script(script)\n    yield\n    Timeout.timeout(Capybara.default_max_wait_time) do\n      loop until page.evaluate_script('window._capybaraModalWait').zero?\n    end\n  end\n```\n\n\u3067\u3001\u3053\u3046\u66f8\u304d\u307e\u3059\u3002\n\n```ruby\n# \u30e2\u30fc\u30c0\u30eb\u304c\u51fa\u73fe\u3059\u308b\u307e\u3067\u5f85\u3064\nwait_for_bs_modal do\n  click_link '\u7530\u4e2d \u82b1\u5b50' # \u30e2\u30fc\u30c0\u30eb\u3092\u547c\u3073\u51fa\u3059\nend\nclick_link '\u30ad\u30e3\u30f3\u30bb\u30eb' # \u30e2\u30fc\u30c0\u30eb\u5185\u306e\u30ea\u30f3\u30af\u3092\u30af\u30ea\u30c3\u30af\nexpect(page).to have_css '.is-canceled'\n```\n"}