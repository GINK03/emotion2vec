{"tags": ["RabbitMQ", "Ruby"], "context": "\n\n\u512a\u5148\u5ea6\u30ad\u30e5\u30fc\uff08Priority Queue\uff09\u3068\u306f\uff1f\n\nRabbitMQ3.5.0\u304b\u3089\u5b9f\u88c5\u3055\u308c\u305f\u6a5f\u80fd\n\u901a\u5e38MQ\u3067\u306f\u30e1\u30c3\u30bb\u30fc\u30b8\u306f\u5165\u308c\u305f\u9806\u756a\u3067\u3057\u304b\u53d6\u5f97\u3067\u304d\u306a\u3044\uff08\u5148\u5165\u308c\u5148\u51fa\u3057\uff09\u3002\u3057\u304b\u3057\u3001\u512a\u5148\u5ea6\u30ad\u30e5\u30fc\u3092\u4f7f\u3044\u3001\u30e1\u30c3\u30bb\u30fc\u30b8\u306b\u512a\u5148\u5ea6\u3092\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u3067\u3001\u512a\u5148\u5ea6\u306e\u9ad8\u3044\u9806\u306b\u53d6\u5f97\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\n\n\u74b0\u5883\n\nAmazon Linux AMI 2016.03.3\nRabbitMQ 3.5.4\nErlang R14B04\nbunny 2.4.0\n\n\n\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n\nRabbitMQ\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nsudo rpm --import http://www.rabbitmq.com/rabbitmq-signing-key-public.asc\nsudo yum -y install http://www.rabbitmq.com/releases/rabbitmq-server/v3.5.4/rabbitmq-server-3.5.4-1.noarch.rpm\n\nRabbitMQ\u3068\u4e00\u7dd2\u306berlang\u3082\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u308b\n\nRabbitMQ\u8d77\u52d5\nsudo service rabbitmq-server start\n#=>\n#Starting rabbitmq-server: SUCCESS\n#rabbitmq-server.\n\n\nbunny\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\ngem install bunny\n\n\n\u512a\u5148\u5ea6\u30ad\u30e5\u30fc\u3092\u4f5c\u6210\u3057\u3066\u3001\u30ad\u30e5\u30fc\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u767b\u9332\u3059\u308b\n\nqueue\u4f5c\u6210\u6642\u306b\u3001x-max-priority\u3092\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u3067\u3001\u512a\u5148\u5ea6\u30ad\u30e5\u30fc\u306b\u306a\u308b\n\n\npublish_with_priority.rb\n# -*- coding: utf-8 -*-\nrequire \"bunny\"\n\n# RabbitMQ\u306b\u63a5\u7d9a\nconn = Bunny.new(:host => \"localhost\", :vhost => \"/\", :user => \"guest\", :pass => \"guest\")\nconn.start\n\n# channel\u3092\u4f5c\u6210\nch = conn.create_channel\n\n# queue1\u3068\u3044\u3046\u30ad\u30e5\u30fc\u3092\u4f5c\u6210\n# \u512a\u5148\u5ea6\u30ad\u30e5\u30fc\u3092\u8a2d\u5b9a\nq  = ch.queue(\"queue1\", :durable => true, :arguments => {\"x-max-priority\" => 10 })\n\n# \u512a\u5148\u5ea6\u3092\u8a2d\u5b9a\u3057\u3066\u3001queue1\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u8ffd\u52a0\nq.publish(\"priority 5\" , { :priority => 5} )\nq.publish(\"priority 1\" , { :priority => 1} )\nq.publish(\"priority 3\" , { :priority => 3} )\nq.publish(\"priority 9\" , { :priority => 9} )\nq.publish(\"priority 10\", { :priority => 10} )\nq.publish(\"priority none\" )   # \u512a\u5148\u5ea6\u8a2d\u5b9a\u7121\u3057\n\n# close\nconn.stop\n\n\n\n\u512a\u5148\u5ea6\u30ad\u30e5\u30fc\u304b\u3089\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u53d6\u5f97\u3059\u308b\n\nsubscribe_with_priority.rb\n# -*- coding: utf-8 -*-\nrequire \"bunny\"\n\n# RabbitMQ\u306b\u63a5\u7d9a\nconn = Bunny.new(:host => \"localhost\", :vhost => \"/\", :user => \"guest\", :pass => \"guest\")\nconn.start\n\n# channel\u3092\u4f5c\u6210\nch = conn.create_channel\n\n# queue1\u30ad\u30e5\u30fc\u53d6\u5f97\nq  = ch.queue(\"queue1\", :durable => true, :arguments => {\"x-max-priority\" => 10 })\n\n# \u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u53d6\u5f97\n# \u53d6\u5f97\u3059\u308b\u3068\u30ad\u30e5\u30fc\u304b\u3089\u30e1\u30c3\u30bb\u30fc\u30b8\u306f\u524a\u9664\u3055\u308c\u308b\nq.subscribe do |delivery_info, properties, msg|\n  p \"queue  = #{q.name}, msg = #{msg}\"\nend\n\n# close\nconn.stop\n\n\n\n\u5b9f\u884c\u7d50\u679c\nruby subscribe_with_priority.rb\n#=>\n#\"queue  = queue1, msg = priority 10\"\n#\"queue  = queue1, msg = priority 9\"\n#\"queue  = queue1, msg = priority 5\"\n#\"queue  = queue1, msg = priority 3\"\n#\"queue  = queue1, msg = priority 1\"\n#\"queue  = queue1, msg = priority none\"\n\n\n\npriority\u304c\u9ad8\u3044\u9806\u306b\u53d6\u5f97\u3057\u305f\uff08priority\u3092\u8a2d\u5b9a\u3057\u3066\u3044\u306a\u3044\u5834\u5408\u306f0(\u6700\u4f4e)\u3068\u306a\u308b\uff09\n\n\n\u8272\u3005\u8a2d\u5b9a\u3057\u3066\u307f\u308b\n\n\u65e2\u306b\u3042\u308b\u30ad\u30e5\u30fc\u306ex-max-priority\u3092\u5909\u66f4\u3057\u305f\u5834\u5408\n# \"x-max-priority\" => 10\u3067\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u30ad\u30e5\u30fc\u306b\u5bfe\u3057\u306620\u3092\u8a2d\u5b9a\nq  = ch.queue(\"queue1\", :durable => true, :arguments => {\"x-max-priority\" => 20 })\n\n\n\u30a8\u30e9\u30fc\u306b\u306a\u3063\u305f\n\n/home/ec2-user/.gem/ruby/2.0/gems/bunny-2.4.0/lib/bunny/channel.rb:1927:in `raise_if_continuation_resulted_in_a_channel_error!':\n PRECONDITION_FAILED - inequivalent arg 'x-max-priority' for queue 'queue1' in vhost '/': received '20' but current is '10' (Bunny::PreconditionFailed)\n\n\nx-max-priority\u3092\u8d85\u3048\u305f\u5024\u3092\u8a2d\u5b9a\u3057\u305f\u5834\u5408\nq  = ch.queue(\"queue1\", :durable => true, :arguments => {\"x-max-priority\" => 10 })\n\nq.publish(\"priority 10\" , { :priority => 10} )\nq.publish(\"priority 30\" , { :priority => 30} )\nq.publish(\"priority 20\" , { :priority => 20} )\nq.publish(\"priority 100\", { :priority => 100} )\n\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u305f\n\n\"queue  = queue1, msg = priority 10\"\n\"queue  = queue1, msg = priority 20\"\n\"queue  = queue1, msg = priority 30\"\n\"queue  = queue1, msg = priority 100\"\n\n\n\u540c\u3058priority\u3092\u8a2d\u5b9a\u3057\u305f\u5834\u5408\nq.publish(\"priority 1-1\", { :priority => 1} )\nq.publish(\"priority 1-2\", { :priority => 1} )\nq.publish(\"priority 1-3\", { :priority => 1} )\nq.publish(\"priority 2-1\", { :priority => 2} )\nq.publish(\"priority 2-2\", { :priority => 2} )\nq.publish(\"priority 2-3\", { :priority => 2} )\n\n\n\u5148\u306b\u5165\u308c\u305f\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u53d6\u5f97\u3057\u305f\n\n\"queue  = queue1, msg = priority 2-1\"\n\"queue  = queue1, msg = priority 2-2\"\n\"queue  = queue1, msg = priority 2-3\"\n\"queue  = queue1, msg = priority 1-1\"\n\"queue  = queue1, msg = priority 1-2\"\n\"queue  = queue1, msg = priority 1-3\"\n\n\n\u30de\u30a4\u30ca\u30b9\u30fb\u5c0f\u6570\u5024\u3092\u8a2d\u5b9a\u3057\u305f\u5834\u5408\nq.publish(\"priority 10\" , { :priority => 10} )\nq.publish(\"priority -1\" , { :priority => -1} )\nq.publish(\"priority 9.5\", { :priority => 9.5} )\nq.publish(\"priority 1\"  , { :priority => 1} )\n\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u305f\n\n\"queue  = queue1, msg = priority 10\"\n\"queue  = queue1, msg = priority -1\"\n\"queue  = queue1, msg = priority 9.5\"\n\"queue  = queue1, msg = priority 1\"\n\n\n## \u512a\u5148\u5ea6\u30ad\u30e5\u30fc\uff08Priority Queue\uff09\u3068\u306f\uff1f\n* RabbitMQ3.5.0\u304b\u3089\u5b9f\u88c5\u3055\u308c\u305f\u6a5f\u80fd\n* \u901a\u5e38MQ\u3067\u306f\u30e1\u30c3\u30bb\u30fc\u30b8\u306f\u5165\u308c\u305f\u9806\u756a\u3067\u3057\u304b\u53d6\u5f97\u3067\u304d\u306a\u3044\uff08\u5148\u5165\u308c\u5148\u51fa\u3057\uff09\u3002\u3057\u304b\u3057\u3001\u512a\u5148\u5ea6\u30ad\u30e5\u30fc\u3092\u4f7f\u3044\u3001\u30e1\u30c3\u30bb\u30fc\u30b8\u306b\u512a\u5148\u5ea6\u3092\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u3067\u3001\u512a\u5148\u5ea6\u306e\u9ad8\u3044\u9806\u306b\u53d6\u5f97\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\n## \u74b0\u5883\n* Amazon Linux AMI 2016.03.3\n* RabbitMQ 3.5.4\n* Erlang R14B04\n* bunny 2.4.0\n\n## \u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n### RabbitMQ\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n```\nsudo rpm --import http://www.rabbitmq.com/rabbitmq-signing-key-public.asc\nsudo yum -y install http://www.rabbitmq.com/releases/rabbitmq-server/v3.5.4/rabbitmq-server-3.5.4-1.noarch.rpm\n```\nRabbitMQ\u3068\u4e00\u7dd2\u306berlang\u3082\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u308b\n\n### RabbitMQ\u8d77\u52d5\n```bash\nsudo service rabbitmq-server start\n#=>\n#Starting rabbitmq-server: SUCCESS\n#rabbitmq-server.\n```\n\n### bunny\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n```\ngem install bunny\n```\n\n## \u512a\u5148\u5ea6\u30ad\u30e5\u30fc\u3092\u4f5c\u6210\u3057\u3066\u3001\u30ad\u30e5\u30fc\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u767b\u9332\u3059\u308b\n* queue\u4f5c\u6210\u6642\u306b\u3001`x-max-priority`\u3092\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u3067\u3001\u512a\u5148\u5ea6\u30ad\u30e5\u30fc\u306b\u306a\u308b\n\n```rb:publish_with_priority.rb\n# -*- coding: utf-8 -*-\nrequire \"bunny\"\n\n# RabbitMQ\u306b\u63a5\u7d9a\nconn = Bunny.new(:host => \"localhost\", :vhost => \"/\", :user => \"guest\", :pass => \"guest\")\nconn.start\n\n# channel\u3092\u4f5c\u6210\nch = conn.create_channel\n\n# queue1\u3068\u3044\u3046\u30ad\u30e5\u30fc\u3092\u4f5c\u6210\n# \u512a\u5148\u5ea6\u30ad\u30e5\u30fc\u3092\u8a2d\u5b9a\nq  = ch.queue(\"queue1\", :durable => true, :arguments => {\"x-max-priority\" => 10 })\n\n# \u512a\u5148\u5ea6\u3092\u8a2d\u5b9a\u3057\u3066\u3001queue1\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u8ffd\u52a0\nq.publish(\"priority 5\" , { :priority => 5} )\nq.publish(\"priority 1\" , { :priority => 1} )\nq.publish(\"priority 3\" , { :priority => 3} )\nq.publish(\"priority 9\" , { :priority => 9} )\nq.publish(\"priority 10\", { :priority => 10} )\nq.publish(\"priority none\" )   # \u512a\u5148\u5ea6\u8a2d\u5b9a\u7121\u3057\n\n# close\nconn.stop\n```\n\n## \u512a\u5148\u5ea6\u30ad\u30e5\u30fc\u304b\u3089\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u53d6\u5f97\u3059\u308b\n```rb:subscribe_with_priority.rb\n# -*- coding: utf-8 -*-\nrequire \"bunny\"\n\n# RabbitMQ\u306b\u63a5\u7d9a\nconn = Bunny.new(:host => \"localhost\", :vhost => \"/\", :user => \"guest\", :pass => \"guest\")\nconn.start\n\n# channel\u3092\u4f5c\u6210\nch = conn.create_channel\n\n# queue1\u30ad\u30e5\u30fc\u53d6\u5f97\nq  = ch.queue(\"queue1\", :durable => true, :arguments => {\"x-max-priority\" => 10 })\n\n# \u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u53d6\u5f97\n# \u53d6\u5f97\u3059\u308b\u3068\u30ad\u30e5\u30fc\u304b\u3089\u30e1\u30c3\u30bb\u30fc\u30b8\u306f\u524a\u9664\u3055\u308c\u308b\nq.subscribe do |delivery_info, properties, msg|\n  p \"queue  = #{q.name}, msg = #{msg}\"\nend\n\n# close\nconn.stop\n```\n\n```bash:\u5b9f\u884c\u7d50\u679c\nruby subscribe_with_priority.rb\n#=>\n#\"queue  = queue1, msg = priority 10\"\n#\"queue  = queue1, msg = priority 9\"\n#\"queue  = queue1, msg = priority 5\"\n#\"queue  = queue1, msg = priority 3\"\n#\"queue  = queue1, msg = priority 1\"\n#\"queue  = queue1, msg = priority none\"\n```\n* priority\u304c\u9ad8\u3044\u9806\u306b\u53d6\u5f97\u3057\u305f\uff08priority\u3092\u8a2d\u5b9a\u3057\u3066\u3044\u306a\u3044\u5834\u5408\u306f0(\u6700\u4f4e)\u3068\u306a\u308b\uff09\n\n## \u8272\u3005\u8a2d\u5b9a\u3057\u3066\u307f\u308b\n### \u65e2\u306b\u3042\u308b\u30ad\u30e5\u30fc\u306ex-max-priority\u3092\u5909\u66f4\u3057\u305f\u5834\u5408\n```rb\n# \"x-max-priority\" => 10\u3067\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u30ad\u30e5\u30fc\u306b\u5bfe\u3057\u306620\u3092\u8a2d\u5b9a\nq  = ch.queue(\"queue1\", :durable => true, :arguments => {\"x-max-priority\" => 20 })\n```\n\n* \u30a8\u30e9\u30fc\u306b\u306a\u3063\u305f\n\n```\n/home/ec2-user/.gem/ruby/2.0/gems/bunny-2.4.0/lib/bunny/channel.rb:1927:in `raise_if_continuation_resulted_in_a_channel_error!':\n PRECONDITION_FAILED - inequivalent arg 'x-max-priority' for queue 'queue1' in vhost '/': received '20' but current is '10' (Bunny::PreconditionFailed)\n```\n\n### x-max-priority\u3092\u8d85\u3048\u305f\u5024\u3092\u8a2d\u5b9a\u3057\u305f\u5834\u5408\n```rb\nq  = ch.queue(\"queue1\", :durable => true, :arguments => {\"x-max-priority\" => 10 })\n\nq.publish(\"priority 10\" , { :priority => 10} )\nq.publish(\"priority 30\" , { :priority => 30} )\nq.publish(\"priority 20\" , { :priority => 20} )\nq.publish(\"priority 100\", { :priority => 100} )\n```\n\n* \u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u305f\n\n```\n\"queue  = queue1, msg = priority 10\"\n\"queue  = queue1, msg = priority 20\"\n\"queue  = queue1, msg = priority 30\"\n\"queue  = queue1, msg = priority 100\"\n```\n\n### \u540c\u3058priority\u3092\u8a2d\u5b9a\u3057\u305f\u5834\u5408\n```rb\nq.publish(\"priority 1-1\", { :priority => 1} )\nq.publish(\"priority 1-2\", { :priority => 1} )\nq.publish(\"priority 1-3\", { :priority => 1} )\nq.publish(\"priority 2-1\", { :priority => 2} )\nq.publish(\"priority 2-2\", { :priority => 2} )\nq.publish(\"priority 2-3\", { :priority => 2} )\n```\n\n* \u5148\u306b\u5165\u308c\u305f\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u53d6\u5f97\u3057\u305f\n\n```\n\"queue  = queue1, msg = priority 2-1\"\n\"queue  = queue1, msg = priority 2-2\"\n\"queue  = queue1, msg = priority 2-3\"\n\"queue  = queue1, msg = priority 1-1\"\n\"queue  = queue1, msg = priority 1-2\"\n\"queue  = queue1, msg = priority 1-3\"\n```\n\n### \u30de\u30a4\u30ca\u30b9\u30fb\u5c0f\u6570\u5024\u3092\u8a2d\u5b9a\u3057\u305f\u5834\u5408\n```rb\nq.publish(\"priority 10\" , { :priority => 10} )\nq.publish(\"priority -1\" , { :priority => -1} )\nq.publish(\"priority 9.5\", { :priority => 9.5} )\nq.publish(\"priority 1\"  , { :priority => 1} )\n```\n\n* \u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u305f\n\n```\n\"queue  = queue1, msg = priority 10\"\n\"queue  = queue1, msg = priority -1\"\n\"queue  = queue1, msg = priority 9.5\"\n\"queue  = queue1, msg = priority 1\"\n```\n"}