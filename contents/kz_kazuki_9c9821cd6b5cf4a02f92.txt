{"tags": ["ElasticBeanstalk", "passenger", "nginx", "AWS"], "context": "standalone\u306apassenger\u306e\u8a2d\u5b9a\u304c\u3042\u307e\u308a\u898b\u3064\u304b\u3089\u305a\u306b\u82e6\u52b4\u3057\u305f\u306e\u3067\u30e1\u30e2\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n\u524d\u63d0\n\nelastic beanstalk\u3067\u8ca0\u8377\u5206\u6563\u306a\u74b0\u5883\nthe internet -> elb -> ec2\uff08passenger standalone\uff09\u306a\u30a4\u30e1\u30fc\u30b8\nhttp\u3067\u6765\u305f\u901a\u4fe1\u306fhttps\u3078301\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u305b\u308b\n\u305f\u3060\u3057\u3001Elastic Load Balancer\u304b\u3089\u306fhttp\u306b\u3066healthcheck\u304c\u6765\u308b\u306e\u3067\u3053\u308c\u306f\u53d7\u3051\u308b\n\n\n\u8a2d\u5b9a\n/etc/init.d/passenger\n\u3092\u898b\u308b\u3068\u3001--nginx-config-template \u3057\u3066\u3044\u308b\u90e8\u5206\u304c\u3042\u308b\u306e\u3067\u3001\u3053\u306e\u8aad\u307f\u8fbc\u3080\u30d5\u30a1\u30a4\u30eb\u3092ebextensions\u306efiles\u547d\u4ee4\u3067\u66f8\u304d\u63db\u3048\u3066\u3042\u3052\u308c\u3070\u3088\u3044\u3002\n\nnginx-config-template\n\u8981\u306fX-Forwarded-Proto\u304chttp\u304b\u3064\u3001ELB\u304b\u3089\u306ehealth\u30c1\u30a7\u30c3\u30af\u4ee5\u5916\u306f301\u3059\u308c\u3070\u3088\u3044\u3002\n\u305f\u3060\u3057\u3001nginx\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3067\u306f\u3001if\u6587\u306f\u4f7f\u3048\u308b\u304c\u3001if A \u304b\u3064 B \u3068\u3044\u3046\u69cb\u6587\u306f\u4f7f\u3048\u306a\u3044\u306e\u3067\u82e6\u8089\u306e\u7b56\u3068\u3057\u3066\u3001\u5909\u6570\u3092\u7f6e\u304d\u3001\u6587\u5b57\u5217\u7d50\u5408\u3057\u3066\u5224\u5b9a\u3057\u3066\u3044\u308b\u3002\nset $redirect ''; # \u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u5224\u5b9a\u7528\u6587\u5b57\u5217\n\nif ($http_x_forwarded_proto != https) {\n    set $redirect 1;\n}\n\nif ($http_user_agent !~* ELB-HealthChecker) {\n    set $redirect \"${$redirect}1\";\n}\n\nif ($redirect = 11) {\n    rewrite ^ https://$host$request_uri? permanent;\n}\n\n\n\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u3059\u308b\u30d1\u30b9\u304c\u6c7a\u307e\u3063\u3066\u3044\u308b\u5834\u5408\u306f\u3001location\u30c7\u30a3\u30ec\u30af\u30c6\u30a3\u30d6\u3067\u5224\u5b9a\u3057\u3066\u3042\u3052\u3066\u3082\u826f\u3044\u304b\u3082\u3057\u308c\u306a\u3044\u3002\n\nstandalone\u306apassenger\u306e\u8a2d\u5b9a\u304c\u3042\u307e\u308a\u898b\u3064\u304b\u3089\u305a\u306b\u82e6\u52b4\u3057\u305f\u306e\u3067\u30e1\u30e2\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n# \u524d\u63d0\n\n- elastic beanstalk\u3067\u8ca0\u8377\u5206\u6563\u306a\u74b0\u5883\n- the internet -> elb -> ec2\uff08passenger standalone\uff09\u306a\u30a4\u30e1\u30fc\u30b8\n- http\u3067\u6765\u305f\u901a\u4fe1\u306fhttps\u3078301\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u305b\u308b\n- \u305f\u3060\u3057\u3001Elastic Load Balancer\u304b\u3089\u306fhttp\u306b\u3066healthcheck\u304c\u6765\u308b\u306e\u3067\u3053\u308c\u306f\u53d7\u3051\u308b\n\n# \u8a2d\u5b9a\n\n/etc/init.d/passenger\n\u3092\u898b\u308b\u3068\u3001--nginx-config-template \u3057\u3066\u3044\u308b\u90e8\u5206\u304c\u3042\u308b\u306e\u3067\u3001\u3053\u306e\u8aad\u307f\u8fbc\u3080\u30d5\u30a1\u30a4\u30eb\u3092ebextensions\u306efiles\u547d\u4ee4\u3067\u66f8\u304d\u63db\u3048\u3066\u3042\u3052\u308c\u3070\u3088\u3044\u3002\n\n### nginx-config-template\n\n\u8981\u306fX-Forwarded-Proto\u304chttp\u304b\u3064\u3001ELB\u304b\u3089\u306ehealth\u30c1\u30a7\u30c3\u30af\u4ee5\u5916\u306f301\u3059\u308c\u3070\u3088\u3044\u3002\n\n\u305f\u3060\u3057\u3001nginx\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3067\u306f\u3001if\u6587\u306f\u4f7f\u3048\u308b\u304c\u3001if A \u304b\u3064 B \u3068\u3044\u3046\u69cb\u6587\u306f\u4f7f\u3048\u306a\u3044\u306e\u3067\u82e6\u8089\u306e\u7b56\u3068\u3057\u3066\u3001\u5909\u6570\u3092\u7f6e\u304d\u3001\u6587\u5b57\u5217\u7d50\u5408\u3057\u3066\u5224\u5b9a\u3057\u3066\u3044\u308b\u3002\n\n```\nset $redirect ''; # \u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u5224\u5b9a\u7528\u6587\u5b57\u5217\n\nif ($http_x_forwarded_proto != https) {\n    set $redirect 1;\n}\n\nif ($http_user_agent !~* ELB-HealthChecker) {\n    set $redirect \"${$redirect}1\";\n}\n\nif ($redirect = 11) {\n    rewrite ^ https://$host$request_uri? permanent;\n}\n\n```\n\n\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u3059\u308b\u30d1\u30b9\u304c\u6c7a\u307e\u3063\u3066\u3044\u308b\u5834\u5408\u306f\u3001location\u30c7\u30a3\u30ec\u30af\u30c6\u30a3\u30d6\u3067\u5224\u5b9a\u3057\u3066\u3042\u3052\u3066\u3082\u826f\u3044\u304b\u3082\u3057\u308c\u306a\u3044\u3002\n\n"}