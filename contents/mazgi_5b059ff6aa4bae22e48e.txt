{"context": " More than 1 year has passed since last update.\n\n\u6982\u8981\n\nVMWare\u306evmx\u30d5\u30a1\u30a4\u30eb\u3092\u3044\u3058\u3063\u3066UEFI\u8d77\u52d5\n\n\n\u53c2\u8003\u2192Mac\u4e0a\u306eVMware Fusion\u3084VirtualBox\u3067UEFI 2.0\u3092\u8a66\u3059 - \u304b\u30fc\u306d\u308b\u30fb\u3046\u309b\u3044\u3048\u3080\u306b\u3063\u304d\n\n\n\n\u8d77\u52d5\u30e1\u30c7\u30a3\u30a2\u306b\u306fSytemRescueCD\u3092\u4f7f\u3046\n\n\nSystemRescueCD\u306a\u3089\u6700\u521d\u304b\u3089tmux\u5165\u3063\u3066\u3066\u5e78\u305b\n\n\n\n\n\nCreate VMWare VM and boot from SystemRescueCD\n[mazgi@Ardbeg] $ grep 'efi' /Volumes/Macintosh\\ HD\\ Data/Documents/Virtual\\ Machines.localized/Gentoo\\ EFI.vmwarevm/Gentoo\\ EFI.vmx\nfirmware = \"efi\"\n\n\nboot from UEFI\n\nUEFI\u304b\u3089\u8d77\u52d5\u3059\u308b\u3068\u3053\u3093\u306a\u8868\u793a\u306b\u306a\u308a\u307e\u3059\u3002\n\n\nboot from BIOS\n\n\u3053\u3061\u3089\u306fBIOS\u304b\u3089\u8d77\u52d5\u3057\u305f\u5834\u5408\u306e\u8868\u793a\u3002\n\n\nConfigure network (optional)\n\u3055\u3063\u3055\u3068ssh\u3067\u30ed\u30b0\u30a4\u30f3\u3057\u305f\u3044\u306e\u3067\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306e\u8a2d\u5b9a\u3092\u884c\u3046\u3002\nroot@sysresccd /root % ip addr add 0.0.0.0/24 broadcast 0.0.0.255 dev eth0\nroot@sysresccd /root % ip route add default via 0.0.0.1 dev eth0\n\n\nCreate GPT partition and FileSystems\nroot@sysresccd /root % gdisk -l /dev/sda\nGPT fdisk (gdisk) version 0.8.8\n\nPartition table scan:\n  MBR: protective\n  BSD: not present\n  APM: not present\n  GPT: present\n\nFound valid GPT with protective MBR; using GPT.\nDisk /dev/sda: 41943040 sectors, 20.0 GiB\nLogical sector size: 512 bytes\nDisk identifier (GUID): 03971A2E-1840-4748-B2CC-E93346F2ACF0\nPartition table holds up to 128 entries\nFirst usable sector is 34, last usable sector is 41943006\nPartitions will be aligned on 2048-sector boundaries\nTotal free space is 2014 sectors (1007.0 KiB)\n\nNumber  Start (sector)    End (sector)  Size       Code  Name\n   1            2048         1050623   512.0 MiB   EF00  EFI System\n   2         1050624         3147775   1024.0 MiB  8200  Linux swap\n   3         3147776        41943006   18.5 GiB    8300  Linux filesystem\n\n\u3061\u306a\u307f\u306bBIOS+GPT\u306e\u5834\u5408\u306f\u3053\u3093\u306a\u611f\u3058\u306b\u3059\u308b\nroot@sysresccd /root % gdisk -l /dev/sda\nGPT fdisk (gdisk) version 0.8.10\n\nPartition table scan:\n  MBR: protective\n  BSD: not present\n  APM: not present\n  GPT: present\n\nFound valid GPT with protective MBR; using GPT.\nDisk /dev/sda: 167772160 sectors, 80.0 GiB\nLogical sector size: 512 bytes\nDisk identifier (GUID): 9CC8E12D-DAD9-4A1D-BC2F-7E613E99DC45\nPartition table holds up to 128 entries\nFirst usable sector is 34, last usable sector is 167772126\nPartitions will be aligned on 2048-sector boundaries\nTotal free space is 2014 sectors (1007.0 KiB)\n\nNumber  Start (sector)    End (sector)  Size       Code  Name\n   1            2048           10239   4.0 MiB     EF02  BIOS boot partition\n   2           10240         4204543   2.0 GiB     8200  Linux swap\n   3         4204544       167772126   78.0 GiB    8300  Linux filesystem\n\nroot@sysresccd /root % mkfs.vfat -F32 /dev/sda1 \nmkfs.fat 3.0.22 (2013-07-19)\nroot@sysresccd /root % mkswap /dev/sda2 \nSetting up swapspace version 1, size = 1048572 KiB\nno label, UUID=341beae9-111d-4cc0-8104-4cb343099b89\nroot@sysresccd /root % mkfs.btrfs /dev/sda3 \n\nWARNING! - Btrfs v3.12 IS EXPERIMENTAL\nWARNING! - see http://btrfs.wiki.kernel.org before using\n\nTurning ON incompat feature 'extref': increased hardlink limit per file to 65536\nfs created label (null) on /dev/sda3\n    nodesize 16384 leafsize 16384 sectorsize 4096 size 18.50GiB\nBtrfs v3.12\n\nroot@sysresccd /root % mkdir -p /mnt/btrfs\nroot@sysresccd /root % mount /dev/sda3 /mnt/btrfs \nroot@sysresccd /root % cd /mnt/btrfs \nroot@sysresccd /mnt/btrfs % btrfs subvolume create gentoo\nCreate subvolume './gentoo'\nroot@sysresccd /mnt/btrfs % btrfs subvolume create usr-portage\nCreate subvolume './usr-portage'\nroot@sysresccd /mnt/btrfs % btrfs subvolume create var-log    \nCreate subvolume './var-log'\n\nroot@sysresccd /mnt/btrfs % mount -odefaults,subvol=gentoo,compress=lzo,autodefrag /dev/sda3 /mnt/gentoo\nroot@sysresccd /mnt/btrfs % cd /mnt/gentoo \nroot@sysresccd /mnt/gentoo % mkdir -p usr/portage var/log\nroot@sysresccd /mnt/gentoo % mount -odefaults,subvol=usr-portage,compress=lzo,autodefrag /dev/sda3 usr/portage\nroot@sysresccd /mnt/gentoo % mount -odefaults,subvol=var-log,compress=gzip,autodefrag /dev/sda3 var/log\n\n\nDownload and extract stage3\n\u30df\u30e9\u30fc\u30b5\u30a4\u30c8\u4e00\u89a7\u306b\u3042\u308b\u30df\u30e9\u30fc\u30b5\u30a4\u30c8\u304b\u3089stage3\u3068portage\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\nroot@sysresccd /mnt/gentoo % pwd\n/mnt/gentoo\nroot@sysresccd /mnt/gentoo % curl -LO 'ftp://ftp.iij.ad.jp/pub/linux/gentoo/snapshots/portage-latest.tar.xz'\nroot@sysresccd /mnt/gentoo % curl -LO 'ftp://ftp.iij.ad.jp/pub/linux/gentoo/releases/amd64/autobuilds/current-stage3-amd64/stage3-amd64-20150924.tar.bz2'\n\nstage3\u3068portage\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u3092\u5c55\u958b\u3059\u308b\u3002\nstage3\u306f\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u3092\u4fdd\u6301\u3059\u308b(-p)\u3001portage\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u306fusr/\u306b\u5c55\u958b\u3059\u308b\u3053\u3068\u306b\u6ce8\u610f\u3002\nroot@sysresccd /mnt/gentoo % tar xfp stage3-amd64-20150924.tar.bz2\nroot@sysresccd /mnt/gentoo % tar xf portage-latest.tar.xz -C usr/\n\n\nChroot\nroot@sysresccd /mnt/gentoo % mount --rbind /dev dev/\nroot@sysresccd /mnt/gentoo % mount --rbind /sys sys/\nroot@sysresccd /mnt/gentoo % mount -t proc none proc/\n\nchroot\u524d\u306b /etc/resolv.conf \u3092\u30b3\u30d4\u30fc\u3057\u3066\u304a\u304b\u306a\u3044\u3068chroot\u5f8c\u306e\u74b0\u5883\u3067\u540d\u524d\u89e3\u6c7a\u304c\u3067\u304d\u306a\u3044\u3002\nroot@sysresccd /mnt/gentoo % cp /etc/resolv.conf etc/\ncp: overwrite 'etc/resolv.conf'? y\n\nchroot\u3059\u308b\u3002\nroot@sysresccd /mnt/gentoo % chroot /mnt/gentoo /bin/bash\nsysresccd / # env-update\n>>> Regenerating /etc/ld.so.cache...\nsysresccd / # source /etc/profile\nsysresccd / # export PS1=\"(chroot)$PS1\"\n\nSystemRescueCd\u306b\u306ftmux\u304c\u5165\u3063\u3066\u3044\u308b\u306e\u3067\u3053\u3053\u304b\u3089\u5148\u306ftmux\u3092\u8d77\u52d5\u3057\u3066chroot\u74b0\u5883\u3068chroot\u3057\u3066\u3044\u306a\u3044\u74b0\u5883\u3092\u4f7f\u3044\u5206\u3051\u308b\u3068\u697d\u3002\n\n\ninstall packages && build kernel\n(chroot)sysresccd / # emerge --sync -q\n(chroot)sysresccd / # emerge -uvq @world\n(chroot)sysresccd / # genkernel --menuconfig --makeopts=-j$(nproc) all\n\n\nInstall boot loader\n(chroot)sysresccd / # grub2-install --target=x86_64-efi\n(chroot)sysresccd / # grub2-mkconfig -o /boot/grub/grub.cfg\n\nBIOS+GPT\u306e\u5834\u5408\u306f\u3053\u3093\u306a\u611f\u3058\u306b\u3059\u308b\n(chroot)sysresccd / # grub2-install /dev/sda\n(chroot)sysresccd / # grub2-mkconfig -o /boot/grub/grub.cfg\n\n\nReboot\n\u30d1\u30b9\u30ef\u30fc\u30c9\u8a2d\u5b9a\u3057\u3066/etc/fstab\u3092\u66f8\u3044\u3066\u304a\u304f\u3002\n\u3084\u3089\u306a\u3044\u3068\u304b\u306a\u308a\u5f8c\u6094\u3059\u308b\u3053\u3068\u306b\u306a\u308b\u3002\nroot@sysresccd /mnt/btrfs/gentoo % grep -vE '^\\s*(#|$)' etc/fstab\n/dev/vda3   /       btrfs   defaults,subvol=gentoo,compress=lzo,ssd,discard,space_cache,autodefrag,inode_cache  1 2\n/dev/vda3   /var/log    btrfs   defaults,subvol=var-log,compress=gzip,ssd,discard,space_cache,autodefrag,inode_cache    1 2\n/dev/vda3   /usr/portage    btrfs   defaults,subvol=usr-portage,compress=lzo,ssd,discard,space_cache,autodefrag,inode_cache 1 2\n/dev/vda2   none        swap    sw  0 0\n\n\nreboot\n\n## \u6982\u8981\n\n* VMWare\u306evmx\u30d5\u30a1\u30a4\u30eb\u3092\u3044\u3058\u3063\u3066UEFI\u8d77\u52d5\n    * \u53c2\u8003\u2192[Mac\u4e0a\u306eVMware Fusion\u3084VirtualBox\u3067UEFI 2.0\u3092\u8a66\u3059 - \u304b\u30fc\u306d\u308b\u30fb\u3046\u309b\u3044\u3048\u3080\u306b\u3063\u304d](http://d.hatena.ne.jp/syuu1228/20130101/1357054251)\n* \u8d77\u52d5\u30e1\u30c7\u30a3\u30a2\u306b\u306fSytemRescueCD\u3092\u4f7f\u3046\n  * SystemRescueCD\u306a\u3089\u6700\u521d\u304b\u3089tmux\u5165\u3063\u3066\u3066\u5e78\u305b\n\n----\n\n## Create VMWare VM and boot from SystemRescueCD\n\n```shell-session\n[mazgi@Ardbeg] $ grep 'efi' /Volumes/Macintosh\\ HD\\ Data/Documents/Virtual\\ Machines.localized/Gentoo\\ EFI.vmwarevm/Gentoo\\ EFI.vmx\nfirmware = \"efi\"\n```\n\n* boot from UEFI\n\nUEFI\u304b\u3089\u8d77\u52d5\u3059\u308b\u3068\u3053\u3093\u306a\u8868\u793a\u306b\u306a\u308a\u307e\u3059\u3002\n\n![Screen Shot 2014-06-07 at 12.57.31 PM.png](https://qiita-image-store.s3.amazonaws.com/0/9676/ca283618-9fd2-4418-e5c2-68890fdffca3.png)\n\n* boot from BIOS\n\n\u3053\u3061\u3089\u306fBIOS\u304b\u3089\u8d77\u52d5\u3057\u305f\u5834\u5408\u306e\u8868\u793a\u3002\n\n![Screen Shot 2014-06-07 at 12.58.46 PM.png](https://qiita-image-store.s3.amazonaws.com/0/9676/881896ec-f9f2-87ea-fcd3-68fd33ca5cf1.png)\n\n## Configure network (optional)\n\n\u3055\u3063\u3055\u3068ssh\u3067\u30ed\u30b0\u30a4\u30f3\u3057\u305f\u3044\u306e\u3067\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306e\u8a2d\u5b9a\u3092\u884c\u3046\u3002\n\n```shell-session\nroot@sysresccd /root % ip addr add 0.0.0.0/24 broadcast 0.0.0.255 dev eth0\nroot@sysresccd /root % ip route add default via 0.0.0.1 dev eth0\n```\n\n## Create GPT partition and FileSystems\n\n```shell-session\nroot@sysresccd /root % gdisk -l /dev/sda\nGPT fdisk (gdisk) version 0.8.8\n\nPartition table scan:\n  MBR: protective\n  BSD: not present\n  APM: not present\n  GPT: present\n\nFound valid GPT with protective MBR; using GPT.\nDisk /dev/sda: 41943040 sectors, 20.0 GiB\nLogical sector size: 512 bytes\nDisk identifier (GUID): 03971A2E-1840-4748-B2CC-E93346F2ACF0\nPartition table holds up to 128 entries\nFirst usable sector is 34, last usable sector is 41943006\nPartitions will be aligned on 2048-sector boundaries\nTotal free space is 2014 sectors (1007.0 KiB)\n\nNumber  Start (sector)    End (sector)  Size       Code  Name\n   1            2048         1050623   512.0 MiB   EF00  EFI System\n   2         1050624         3147775   1024.0 MiB  8200  Linux swap\n   3         3147776        41943006   18.5 GiB    8300  Linux filesystem\n```\n\n**\u3061\u306a\u307f\u306bBIOS+GPT\u306e\u5834\u5408\u306f\u3053\u3093\u306a\u611f\u3058\u306b\u3059\u308b**\n\n```shell-session\nroot@sysresccd /root % gdisk -l /dev/sda\nGPT fdisk (gdisk) version 0.8.10\n\nPartition table scan:\n  MBR: protective\n  BSD: not present\n  APM: not present\n  GPT: present\n\nFound valid GPT with protective MBR; using GPT.\nDisk /dev/sda: 167772160 sectors, 80.0 GiB\nLogical sector size: 512 bytes\nDisk identifier (GUID): 9CC8E12D-DAD9-4A1D-BC2F-7E613E99DC45\nPartition table holds up to 128 entries\nFirst usable sector is 34, last usable sector is 167772126\nPartitions will be aligned on 2048-sector boundaries\nTotal free space is 2014 sectors (1007.0 KiB)\n\nNumber  Start (sector)    End (sector)  Size       Code  Name\n   1            2048           10239   4.0 MiB     EF02  BIOS boot partition\n   2           10240         4204543   2.0 GiB     8200  Linux swap\n   3         4204544       167772126   78.0 GiB    8300  Linux filesystem\n```\n\n```shell-session\nroot@sysresccd /root % mkfs.vfat -F32 /dev/sda1 \nmkfs.fat 3.0.22 (2013-07-19)\nroot@sysresccd /root % mkswap /dev/sda2 \nSetting up swapspace version 1, size = 1048572 KiB\nno label, UUID=341beae9-111d-4cc0-8104-4cb343099b89\nroot@sysresccd /root % mkfs.btrfs /dev/sda3 \n\nWARNING! - Btrfs v3.12 IS EXPERIMENTAL\nWARNING! - see http://btrfs.wiki.kernel.org before using\n\nTurning ON incompat feature 'extref': increased hardlink limit per file to 65536\nfs created label (null) on /dev/sda3\n\tnodesize 16384 leafsize 16384 sectorsize 4096 size 18.50GiB\nBtrfs v3.12\n```\n\n```shell-session\nroot@sysresccd /root % mkdir -p /mnt/btrfs\nroot@sysresccd /root % mount /dev/sda3 /mnt/btrfs \nroot@sysresccd /root % cd /mnt/btrfs \nroot@sysresccd /mnt/btrfs % btrfs subvolume create gentoo\nCreate subvolume './gentoo'\nroot@sysresccd /mnt/btrfs % btrfs subvolume create usr-portage\nCreate subvolume './usr-portage'\nroot@sysresccd /mnt/btrfs % btrfs subvolume create var-log    \nCreate subvolume './var-log'\n```\n\n```shell-session\nroot@sysresccd /mnt/btrfs % mount -odefaults,subvol=gentoo,compress=lzo,autodefrag /dev/sda3 /mnt/gentoo\nroot@sysresccd /mnt/btrfs % cd /mnt/gentoo \nroot@sysresccd /mnt/gentoo % mkdir -p usr/portage var/log\nroot@sysresccd /mnt/gentoo % mount -odefaults,subvol=usr-portage,compress=lzo,autodefrag /dev/sda3 usr/portage\nroot@sysresccd /mnt/gentoo % mount -odefaults,subvol=var-log,compress=gzip,autodefrag /dev/sda3 var/log\n```\n\n## Download and extract stage3\n\n[\u30df\u30e9\u30fc\u30b5\u30a4\u30c8\u4e00\u89a7](https://www.gentoo.org/downloads/mirrors/#JP)\u306b\u3042\u308b\u30df\u30e9\u30fc\u30b5\u30a4\u30c8\u304b\u3089stage3\u3068portage\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\n\n```shell-session\nroot@sysresccd /mnt/gentoo % pwd\n/mnt/gentoo\nroot@sysresccd /mnt/gentoo % curl -LO 'ftp://ftp.iij.ad.jp/pub/linux/gentoo/snapshots/portage-latest.tar.xz'\nroot@sysresccd /mnt/gentoo % curl -LO 'ftp://ftp.iij.ad.jp/pub/linux/gentoo/releases/amd64/autobuilds/current-stage3-amd64/stage3-amd64-20150924.tar.bz2'\n```\n\nstage3\u3068portage\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u3092\u5c55\u958b\u3059\u308b\u3002  \nstage3\u306f\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u3092\u4fdd\u6301\u3059\u308b(`-p`)\u3001portage\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u306f`usr/`\u306b\u5c55\u958b\u3059\u308b\u3053\u3068\u306b\u6ce8\u610f\u3002\n\n```shell-session\nroot@sysresccd /mnt/gentoo % tar xfp stage3-amd64-20150924.tar.bz2\nroot@sysresccd /mnt/gentoo % tar xf portage-latest.tar.xz -C usr/\n```\n\n## Chroot\n\n```shell-session\nroot@sysresccd /mnt/gentoo % mount --rbind /dev dev/\nroot@sysresccd /mnt/gentoo % mount --rbind /sys sys/\nroot@sysresccd /mnt/gentoo % mount -t proc none proc/\n```\n\nchroot\u524d\u306b `/etc/resolv.conf` \u3092\u30b3\u30d4\u30fc\u3057\u3066\u304a\u304b\u306a\u3044\u3068chroot\u5f8c\u306e\u74b0\u5883\u3067\u540d\u524d\u89e3\u6c7a\u304c\u3067\u304d\u306a\u3044\u3002\n\n```shell-session\nroot@sysresccd /mnt/gentoo % cp /etc/resolv.conf etc/\ncp: overwrite 'etc/resolv.conf'? y\n```\n\nchroot\u3059\u308b\u3002\n\n```shell-session\nroot@sysresccd /mnt/gentoo % chroot /mnt/gentoo /bin/bash\nsysresccd / # env-update\n>>> Regenerating /etc/ld.so.cache...\nsysresccd / # source /etc/profile\nsysresccd / # export PS1=\"(chroot)$PS1\"\n```\n\nSystemRescueCd\u306b\u306ftmux\u304c\u5165\u3063\u3066\u3044\u308b\u306e\u3067\u3053\u3053\u304b\u3089\u5148\u306ftmux\u3092\u8d77\u52d5\u3057\u3066chroot\u74b0\u5883\u3068chroot\u3057\u3066\u3044\u306a\u3044\u74b0\u5883\u3092\u4f7f\u3044\u5206\u3051\u308b\u3068\u697d\u3002\n\n![Screen Shot 2015-09-29 at 11.27.31 AM.png](https://qiita-image-store.s3.amazonaws.com/0/9676/13c93742-b129-c15b-b1cf-17d41c8f2a29.png)\n\n## install packages && build kernel\n\n```shell-session\n(chroot)sysresccd / # emerge --sync -q\n(chroot)sysresccd / # emerge -uvq @world\n(chroot)sysresccd / # genkernel --menuconfig --makeopts=-j$(nproc) all\n```\n\n## Install boot loader\n\n```shell-session\n(chroot)sysresccd / # grub2-install --target=x86_64-efi\n(chroot)sysresccd / # grub2-mkconfig -o /boot/grub/grub.cfg\n```\n\n**BIOS+GPT\u306e\u5834\u5408\u306f\u3053\u3093\u306a\u611f\u3058\u306b\u3059\u308b**\n\n```shell-session\n(chroot)sysresccd / # grub2-install /dev/sda\n(chroot)sysresccd / # grub2-mkconfig -o /boot/grub/grub.cfg\n```\n\n## Reboot\n\n\u30d1\u30b9\u30ef\u30fc\u30c9\u8a2d\u5b9a\u3057\u3066`/etc/fstab`\u3092\u66f8\u3044\u3066\u304a\u304f\u3002  \n\u3084\u3089\u306a\u3044\u3068\u304b\u306a\u308a\u5f8c\u6094\u3059\u308b\u3053\u3068\u306b\u306a\u308b\u3002\n\n```shell-session\nroot@sysresccd /mnt/btrfs/gentoo % grep -vE '^\\s*(#|$)' etc/fstab\n/dev/vda3   /       btrfs   defaults,subvol=gentoo,compress=lzo,ssd,discard,space_cache,autodefrag,inode_cache  1 2\n/dev/vda3   /var/log    btrfs   defaults,subvol=var-log,compress=gzip,ssd,discard,space_cache,autodefrag,inode_cache    1 2\n/dev/vda3   /usr/portage    btrfs   defaults,subvol=usr-portage,compress=lzo,ssd,discard,space_cache,autodefrag,inode_cache 1 2\n/dev/vda2   none        swap    sw  0 0\n```\n\n* reboot\n", "tags": ["Gentoo", "UEFI2", "grub2", "btrfs"]}