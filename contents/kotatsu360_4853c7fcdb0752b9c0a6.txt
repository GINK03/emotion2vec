{"context": " More than 1 year has passed since last update.\u3053\u306e\u8a18\u4e8b\u306fCircleCI Advent Calendar 2015\u306e7\u65e5\u76ee\u306e\u70ba\u306b\u8003\u3048\u3066\u3044\u305f\u8a18\u4e8b\u3067\u3059\u3002\n\u3042\u307e\u308a\u306b\u6642\u9593\u304c\u7acb\u3063\u3066\u3057\u307e\u3063\u305f\u306e\u3067\u3001\u5143\u8a18\u4e8b\u304b\u3089\u5207\u308a\u96e2\u3057\u3066\u518d\u6295\u7a3f\u3002\n\n\u3084\u308a\u305f\u3044\u3053\u3068\n\n\nAWS VPC\u4e0a\u306b\u7d44\u3093\u3060\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30b5\u30d6\u30cd\u30c3\u30c8\u4e0a\u306b\nCircleCI\u304b\u3089Vagrant\u3067\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u751f\u6210\u3057\u3066\nGitHub\u306e\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30ea\u30dd\u30b8\u30c8\u30ea\u3092\u30af\u30ed\u30fc\u30f3\u3059\u308b\n\n\u56f3\u306b\u3059\u308b\u3068\u3053\u3046\u3002\n\n\n\u52d5\u6a5f\n\u30a4\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8\u3080\u304d\u51fa\u3057\u3058\u3083\u306a\u3044\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u5bfe\u3057\u3066\u3001SSH\u306e\u9375\u3092\u3070\u3089\u6492\u304b\u305a\u306b\u30c7\u30d7\u30ed\u30a4\u3057\u305f\u3044\n\n\u524d\u63d0\u77e5\u8b58\n\n\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30b5\u30d6\u30cd\u30c3\u30c8\u69cb\u6210\n\u4ee5\u4e0b\u306e\u56f3\u306e\u3088\u3046\u306b\u3001\u30e6\u30fc\u30b6\u304b\u3089\u306e\u30a2\u30af\u30bb\u30b9\u3092ELB\u7d4c\u7531\u306b\u9650\u5b9a\u3057\u3066\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d0\u81ea\u4f53\u306f\u76f4\u63a5\u30a4\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8\u306b\u63a5\u7d9a\u3067\u304d\u306a\u3044\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30b5\u30d6\u30cd\u30c3\u30c8\u306b\u7f6e\u304f\u69cb\u6210\u3002\n\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d0\u3092\u76f4\u63a5\u30a4\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8\u306b\u6652\u3057\u305f\u304f\u306a\u3044\u4eba\u5411\u3051\u3002\n\u305f\u3060\u3001\u5168\u3066\u306e\u901a\u4fe1\u3092\u906e\u65ad\u3057\u3066\u3057\u307e\u3046\u3068\u3001\u30ea\u30ea\u30fc\u30b9\u3082\u3067\u304d\u306a\u3044\u3002\u6642\u523b\u540c\u671f\u3082\u3067\u304d\u306a\u3044\u3002\u3068\u306a\u3063\u3066\u3057\u307e\u3046\u306e\u3067\u3001\u305d\u3046\u3044\u3063\u305f\u7ba1\u7406\u4e0a\u5fc5\u8981\u306a\u901a\u4fe1\u306f\u5225\u9014\u7528\u610f\u3059\u308bNAT\u30b5\u30fc\u30d0\u7d4c\u7531\u3067\u884c\u3046\u3002\n\n\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30b5\u30d6\u30cd\u30c3\u30c8\u306b\u7f6e\u304b\u308c\u305f\u30b5\u30fc\u30d0\u304b\u3089\u306e\u901a\u4fe1\u306f\u5168\u3066NAT\u7d4c\u7531\u306b\u306a\u308b\u306e\u3067\u3001\n\u4e00\u679a\u76ee\u306e\u753b\u50cf\u306b\u3064\u3044\u3066\u3082\u6b63\u3057\u304f\u306f\u3053\u3046\u3044\u3046\u306a\u308b\u3002\n\n\u53c2\u8003\uff1aclassmethod - Amazon VPC\u3067ELB\u3068NAT\u3092\u4f7f\u3063\u3066\u3088\u308a\u30bb\u30ad\u30e5\u30a2\u306a\u74b0\u5883\u3092\u4f5c\u308b\u30105\u65e5\u76ee\u3011\n2015\u5e74\u306e\u5e74\u672b\u306b\u30de\u30cd\u30fc\u30b8\u30c9NAT\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u304c\u65b0\u6a5f\u80fd\u3068\u3057\u3066\u30ea\u30ea\u30fc\u30b9\u3055\u308c\u305f\u306e\u3067\u3001\u4eca\u5f8cNAT\u30b5\u30fc\u30d0\u3092\u5225\u306b\u7acb\u3066\u308b\u5fc5\u8981\u306f\u306a\u3044\u306e\u304b\u3082\u3002\n\n\u672c\u984c\n\u3053\u3061\u3089\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u306b\u307e\u3068\u3081\u307e\u3057\u305f\u3002\u5185\u5bb9\u305d\u306e\u307e\u307e\u3067\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30ea\u30dd\u30b8\u30c8\u30ea\u306b\u5909\u66f4\u3057\u3066CircleCI\u3067\u30d3\u30eb\u30c9\u3059\u308b\u3068\u52d5\u304f\u3068\u601d\u3044\u307e\u3059\u3002\nhttps://github.com/kotatsu360/private-repo-deploy-sample\n\u30b5\u30f3\u30d7\u30eb\u3067\u306f\u3001Vagrant\u3068Chef\u3092\u4f7f\u3063\u3066\u3044\u307e\u3059\u3002\n\n\u305d\u306e1\uff1a\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30b5\u30d6\u30cd\u30c3\u30c8\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3078\u30a2\u30af\u30bb\u30b9\u3059\u308b\u305f\u3081\u306e\u8a18\u8ff0\n\u307e\u305a\u3001\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30b5\u30d6\u30cd\u30c3\u30c8\u306b\u8e0f\u307f\u53f0\uff08NAT\u30b5\u30fc\u30d0\uff09\u7d4c\u7531\u3067\u30a2\u30af\u30bb\u30b9\u3057\u3066\u3084\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u91cd\u8981\u306a\u306e\u306f2\u7b87\u6240\u3067\u3059\u3002\n\npre.sh\necho \"Host nat\" >> ~/.ssh/config\necho \"  Hostname ${AWS_NAT_SERVER_IP_ADDRESS}\" >> ~/.ssh/config\necho \"  User ec2-user\" >> ~/.ssh/config\n\n\n\nVagrantfile\n    override.ssh.username = \"ubuntu\"\n    override.ssh.proxy_command = \"ssh -A nat -W %h:%p\"\n\n\n\u3053\u3053\u3067\u306f\u3001NAT\u30b5\u30fc\u30d0\u304cAmazonLinux, \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d0\u304cUbuntu\u306e\u60f3\u5b9a\u3067\u3059\u3002\n\u307e\u305apre.sh\u306e\u4e2d\u3067CircleCI\u306e.ssh/config\u306bNAT\u306e\u60c5\u5831\u3092\u66f8\u304d\u8fbc\u3093\u3067\u3084\u308a\u307e\u3059\u3002\nVagrant\u3067\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u304d\u306f\u3001\u305d\u306eHost\u3092\u4f7f\u3063\u3066\u30d7\u30ed\u30ad\u30b7\u3057\u307e\u3059\u3002\n\u307e\u305f\u3001\u3053\u306e\u8a18\u4e8b\u306e\u7bc4\u56f2\u304b\u3089\u306f\u5916\u308c\u307e\u3059\u304c\u3001pre.sh\u306f\u30c7\u30d7\u30ed\u30a4\u524d\u5f8c\u3067\u81ea\u5206\u81ea\u8eab\u304b\u3089\u306eSSH\u3092\u8a31\u53ef\u3057\u3066\u3001\u307e\u305f\u9589\u3058\u3066\u3044\u307e\u3059\u3002\u3053\u308c\u306f\u300c\u666e\u6bb5\u306fSSH\u3092\u4e0d\u8a31\u53ef\u3001\u30c7\u30d7\u30ed\u30a4\u6642\u306e\u307f\u8a31\u53ef\u300d\u3068\u3044\u3046\u904b\u7528\u3092\u3057\u305f\u3044\u305f\u3081\u3067\u3059\u3002\n\u203b\u74b0\u5883\u5909\u6570\u306f\u6700\u5f8c\u306b\u8a2d\u5b9a\u3057\u307e\u3059\n\n\n\u305d\u306e2\uff1a\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30ea\u30dd\u30b8\u30c8\u30ea\u306b\u3078\u30a2\u30af\u30bb\u30b9\u3059\u308b\u305f\u3081\u306e\u8a18\u8ff0\n\nVagrantfile\n  config.ssh.forward_agent = true\n  # ...\n\n    override.ssh.private_key_path = [ENV['GITHUB_CLONE_SSH_KEY_PATH'], ENV['AWS_LOGIN_SSH_KEY_PATH']]\n\n\n\n\ndefault.rb\nfile \"/etc/sudoers.d/root_ssh_agent\" do\n  mode 0440\n  owner 'root'\n  group 'root'\n  content \"Defaults env_keep += \\\"SSH_AUTH_SOCK\\\"\\n\"\nend\n\nbash \"add ssh_setting to .ssh/config\" do\n  not_if %!grep Host github.com /root/.ssh/config!\n\n  code <<-EOC\n    echo -e \"Host github.com\\n StrictHostKeyChecking no\\n\" >> /root/.ssh/config\n  EOC\nend\n\n\n\noverride.ssh.private_key_path\nVagrant\u3067SSH\u306eAgentForward\u3092\u6709\u52b9\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\u307e\u305f\u3001\n\nGitHub\u3078\u30a2\u30af\u30bb\u30b9\u3059\u308b\u305f\u3081\u306e\u9375\nChef\u304c\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3078\u30a2\u30af\u30bb\u30b9\u3059\u308b\u305f\u3081\u306e\u9375\n\n\u3092\u6307\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\u3053\u3053\u3067\u6307\u5b9a\u3057\u305f\u9375\u304cAgent Forward\u3067\u8ee2\u9001\u3055\u308c\u307e\u3059\u3002\n\ncontent \"Defaults env_keep += \\\"SSH_AUTH_SOCK\\\"\\n\"\nEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3078SSH\u3057\u3066\u3044\u308b\u30e6\u30fc\u30b6\u306fubuntu\u3002\nChef\u306froot\u3067\u52d5\u4f5c\u3059\u308b\u3002\u3053\u3053\u3067\u306froot\u3078\u5f15\u304d\u7d99\u3050\u74b0\u5883\u5909\u6570\u306bssh-agent\u3092\u8ffd\u52a0\n\necho -e \"Host github.com\\n StrictHostKeyChecking no\\n\" >> /root/.ssh/config\nGitHub\u304b\u3089\u306fssh\u3067git clone\u3059\u308b\u3002git clone\u3059\u308b\u3068\u304d\u306bfingerprint\u306e\u78ba\u8a8d\u3067\u6b62\u307e\u308b\u306e\u3092\u9632\u3050\u305f\u3081\u306bStrictHostKeyChecking no\u3092\u8ffd\u52a0\n\n\u305d\u306e3\uff1aCircleCI\n\u6700\u5f8c\u306bCircleCI\u306e\u300cEnvironment variables\u300d\u3067\u74b0\u5883\u5909\u6570\u3092\u8a2d\u5b9a\u3057\u3066\u3084\u308a\u307e\u3059\u3002\nAWS_ACCESS_KEY_ID\nAWS_SECRET_ACCESS_KEY\n\u306b\u3064\u3044\u3066\u306fCircleCI\u306e\u300cAWS Permission\u300d\u304b\u3089\u8a2d\u5b9a\u3057\u3066\u3082\u3044\u3044\u304b\u3082\u3002\n\n\n\n\n\u5909\u6570\u540d\n\u6982\u8981\n\u30b5\u30f3\u30d7\u30eb\n\n\n\n\nAWS_ACCESS_KEY_ID\nAWS\u306e\u30a2\u30af\u30bb\u30b9\u30ad\u30fc\nxxxxCIBA\n\n\nAWS_DEFAULT_REGION\nAWS EC2\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u30ea\u30fc\u30b8\u30e7\u30f3\nxxxxst-2\n\n\nAWS_DEPLOY_MACHINE_SECURITY_GROUP\nEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u5272\u308a\u5f53\u3066\u308b\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\nxxxx228c\n\n\nAWS_DEPLOY_SUBNET\nEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u7acb\u3066\u308b\u30b5\u30d6\u30cd\u30c3\u30c8\nxxxxbc2c\n\n\nAWS_KEYPAIR\nAWS\u3067\u4f5c\u6210\u3059\u308bEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306bSSH\u3059\u308b\u6642\u7528keypair\u540d\nxxxxpair\n\n\nAWS_LOGIN_SSH_KEY_PATH\n\u203b1\n\n\n\nAWS_NAT_SECURITY_GROUP\n\u30c7\u30d7\u30ed\u30a4\u306b\u4f7f\u3046NAT\u306e\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\nxxxx11db\n\n\nAWS_NAT_SERVER_IP_ADDRESS\n\u30c7\u30d7\u30ed\u30a4\u306b\u4f7f\u3046NAT\u306eEIP\nxxxx9.71\n\n\nAWS_SECRET_ACCESS_KEY\nAWS\u306e\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u30a2\u30af\u30bb\u30b9\u30ad\u30fc\nxxxx1muU\n\n\nGITHUB_CLONE_SSH_KEY_PATH\n\u203b2\n\n\n\n\n\nAWS_LOGIN_SSH_KEY_PATH\nAWS_KEYPAIR\u3067\u8a2d\u5b9a\u3057\u305fkeypair\u306e\u79d8\u5bc6\u9375\u3092CircleCI\u306e\u300cSSH Permission\u300d\u304b\u3089Hostname\u3092\u7a7a\u306b\u3057\u3066\u767b\u9332\u3059\u308b\u3002\n\n\nHostname\u304c\u7a7a\u306e\u5834\u5408\u3001CircleCI\u306ffingerprint\u306b\u5f93\u3063\u3066\u9375\u3092\u4f5c\u6210\u3059\u308b\u306e\u3067\u3001\u305d\u306e\u30d1\u30b9\u3092\u6307\u5b9a\u3059\u308b\u3002\n~/.ssh/id_xxxxxxxxxxxx3044\n\n\nGITHUB_CLONE_SSH_KEY_PATH\nCircleCI\u306b\u4e00\u5ea6SSH\u3059\u308b\u3002~/.ssh/id_github.com\u3068\u3044\u3046\u9375\uff08CircleCI\u304c\u30ea\u30dd\u30b8\u30c8\u30ea\u3092Checkout\u3059\u308b\u305f\u3081\u306e\u9375, GitHub\u3067\u3044\u3046DeployKey\uff09\u304c\u3042\u308b\u306e\u3067\u3053\u308c\u306e\u4e2d\u8eab\u3092\u300cSSH Permission\u300d\u306bHostname=github.com\u3067\u767b\u9332\u3059\u308b\u3002\n\n\nHostname\u304c\u7a7a\u3067\u306a\u3044\u5834\u5408\u3001CircleCI\u306fHostname\u306b\u5f93\u3063\u3066\u9375\u3092\u4f5c\u6210\u3059\u308b\u306e\u3067\u3001\u305d\u306e\u30d1\u30b9\u3092\u6307\u5b9a\u3059\u308b\u3002\n~/.ssh/id_github.com\n\n\n\u5236\u7d04\nhttps://github.com/kotatsu360/private-repo-deploy-sample\n\u3053\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u306e\u3084\u308a\u65b9\u3060\u3068\u3001\u6bce\u56deVagrant\u3067\u65b0\u3057\u3044\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u7acb\u3066\u3066\u3057\u307e\u3046\u306e\u3067\n\u53e4\u3044\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306f\u524a\u9664\u3055\u308c\u308b\u3088\u3046\u306bdeploy.sh\u3067\u8a2d\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\nEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u4e2d\u306b\u30c7\u30fc\u30bf\u3092\u5165\u308c\u3066\u304a\u304f\u3068\u6f0f\u308c\u7121\u304f\u6d88\u3048\u307e\u3059\u3002\n\n\u632f\u308a\u8fd4\u3063\u3066\u307f\u3066\n\u300cGitHub\u304b\u3089\u30af\u30ed\u30fc\u30f3\u3057\u305f\u3044\u30ea\u30dd\u30b8\u30c8\u30ea\u300d = \u300cCircleCI\u3067\u30c6\u30b9\u30c8\u3057\u3066\u3044\u308b\u30ea\u30dd\u30b8\u30c8\u30ea\u300d\u306e\u5834\u5408\u3001\u30b7\u30f3\u30d7\u30eb\u306bSCP\u3067\u9001\u308b\u3068\u3044\u3046\u624b\u6bb5\u3082\u3042\u3063\u305f\u3088\u3046\u306a\u3002\u3002\n\n\u53c2\u8003\n\u6020\u3051\u8005\u306e\u305f\u3081\u306eVagrant+Chef\u5165\u9580 - Qiita\nCircleCI\u304b\u3089\u30b5\u30fc\u30d0\u3078\u306eSSH\u63a5\u7d9a\u78ba\u7acb\u6642\u9593\u3092\u9ad8\u901f\u5316\u3059\u308b\n\u3053\u306e\u8a18\u4e8b\u306f[CircleCI Advent Calendar 2015](http://qiita.com/advent-calendar/2015/circleci)\u306e7\u65e5\u76ee\u306e\u70ba\u306b\u8003\u3048\u3066\u3044\u305f\u8a18\u4e8b\u3067\u3059\u3002\n\n\u3042\u307e\u308a\u306b\u6642\u9593\u304c\u7acb\u3063\u3066\u3057\u307e\u3063\u305f\u306e\u3067\u3001[\u5143\u8a18\u4e8b][original]\u304b\u3089\u5207\u308a\u96e2\u3057\u3066\u518d\u6295\u7a3f\u3002\n\n[original]: http://qiita.com/kotatsu360/items/149dd1b3a31e1550a2cb\n\n# \u3084\u308a\u305f\u3044\u3053\u3068\n\n1. **AWS VPC**\u4e0a\u306b\u7d44\u3093\u3060**\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30b5\u30d6\u30cd\u30c3\u30c8**\u4e0a\u306b\n2. CircleCI\u304b\u3089**Vagrant**\u3067\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u751f\u6210\u3057\u3066\n3. GitHub\u306e**\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30ea\u30dd\u30b8\u30c8\u30ea**\u3092\u30af\u30ed\u30fc\u30f3\u3059\u308b\n\n\u56f3\u306b\u3059\u308b\u3068\u3053\u3046\u3002\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/62601/719f3def-c531-880a-0f5b-c365d258eeee.png)\n\n# \u52d5\u6a5f\n\u30a4\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8\u3080\u304d\u51fa\u3057\u3058\u3083\u306a\u3044\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u5bfe\u3057\u3066\u3001SSH\u306e\u9375\u3092\u3070\u3089\u6492\u304b\u305a\u306b\u30c7\u30d7\u30ed\u30a4\u3057\u305f\u3044\n\n# \u524d\u63d0\u77e5\u8b58\n## \u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30b5\u30d6\u30cd\u30c3\u30c8\u69cb\u6210\n\n\u4ee5\u4e0b\u306e\u56f3\u306e\u3088\u3046\u306b\u3001\u30e6\u30fc\u30b6\u304b\u3089\u306e\u30a2\u30af\u30bb\u30b9\u3092ELB\u7d4c\u7531\u306b\u9650\u5b9a\u3057\u3066\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d0\u81ea\u4f53\u306f\u76f4\u63a5\u30a4\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8\u306b\u63a5\u7d9a\u3067\u304d\u306a\u3044**\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30b5\u30d6\u30cd\u30c3\u30c8**\u306b\u7f6e\u304f\u69cb\u6210\u3002\n\n\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d0\u3092\u76f4\u63a5\u30a4\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8\u306b\u6652\u3057\u305f\u304f\u306a\u3044\u4eba\u5411\u3051\u3002\n\n\u305f\u3060\u3001\u5168\u3066\u306e\u901a\u4fe1\u3092\u906e\u65ad\u3057\u3066\u3057\u307e\u3046\u3068\u3001\u30ea\u30ea\u30fc\u30b9\u3082\u3067\u304d\u306a\u3044\u3002\u6642\u523b\u540c\u671f\u3082\u3067\u304d\u306a\u3044\u3002\u3068\u306a\u3063\u3066\u3057\u307e\u3046\u306e\u3067\u3001\u305d\u3046\u3044\u3063\u305f\u7ba1\u7406\u4e0a\u5fc5\u8981\u306a\u901a\u4fe1\u306f\u5225\u9014\u7528\u610f\u3059\u308bNAT\u30b5\u30fc\u30d0\u7d4c\u7531\u3067\u884c\u3046\u3002\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/62601/a35912a3-ae87-775f-4e94-ef8c72ceabf4.png)\n\n\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30b5\u30d6\u30cd\u30c3\u30c8\u306b\u7f6e\u304b\u308c\u305f\u30b5\u30fc\u30d0\u304b\u3089\u306e\u901a\u4fe1\u306f\u5168\u3066NAT\u7d4c\u7531\u306b\u306a\u308b\u306e\u3067\u3001\n\u4e00\u679a\u76ee\u306e\u753b\u50cf\u306b\u3064\u3044\u3066\u3082\u6b63\u3057\u304f\u306f\u3053\u3046\u3044\u3046\u306a\u308b\u3002\n![image](https://qiita-image-store.s3.amazonaws.com/0/62601/eaecdcfb-bbff-d3a8-f6c2-3511489434a8.png)\n\n\n[\u53c2\u8003\uff1aclassmethod - Amazon VPC\u3067ELB\u3068NAT\u3092\u4f7f\u3063\u3066\u3088\u308a\u30bb\u30ad\u30e5\u30a2\u306a\u74b0\u5883\u3092\u4f5c\u308b\u30105\u65e5\u76ee\u3011](http://dev.classmethod.jp/cloud/amazon-vpc-elb-nat/)\n\n2015\u5e74\u306e\u5e74\u672b\u306b[\u30de\u30cd\u30fc\u30b8\u30c9NAT\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4](http://aws.typepad.com/aws_japan/2015/12/managednat.html)\u304c\u65b0\u6a5f\u80fd\u3068\u3057\u3066\u30ea\u30ea\u30fc\u30b9\u3055\u308c\u305f\u306e\u3067\u3001\u4eca\u5f8cNAT\u30b5\u30fc\u30d0\u3092\u5225\u306b\u7acb\u3066\u308b\u5fc5\u8981\u306f\u306a\u3044\u306e\u304b\u3082\u3002\n\n# \u672c\u984c\n\n\u3053\u3061\u3089\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u306b\u307e\u3068\u3081\u307e\u3057\u305f\u3002\u5185\u5bb9\u305d\u306e\u307e\u307e\u3067\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30ea\u30dd\u30b8\u30c8\u30ea\u306b\u5909\u66f4\u3057\u3066CircleCI\u3067\u30d3\u30eb\u30c9\u3059\u308b\u3068\u52d5\u304f\u3068\u601d\u3044\u307e\u3059\u3002\nhttps://github.com/kotatsu360/private-repo-deploy-sample\n\n\u30b5\u30f3\u30d7\u30eb\u3067\u306f\u3001Vagrant\u3068Chef\u3092\u4f7f\u3063\u3066\u3044\u307e\u3059\u3002\n\n## \u305d\u306e1\uff1a\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30b5\u30d6\u30cd\u30c3\u30c8\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3078\u30a2\u30af\u30bb\u30b9\u3059\u308b\u305f\u3081\u306e\u8a18\u8ff0\n\u307e\u305a\u3001\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30b5\u30d6\u30cd\u30c3\u30c8\u306b\u8e0f\u307f\u53f0\uff08NAT\u30b5\u30fc\u30d0\uff09\u7d4c\u7531\u3067\u30a2\u30af\u30bb\u30b9\u3057\u3066\u3084\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u91cd\u8981\u306a\u306e\u306f2\u7b87\u6240\u3067\u3059\u3002\n\n```bash:pre.sh\necho \"Host nat\" >> ~/.ssh/config\necho \"  Hostname ${AWS_NAT_SERVER_IP_ADDRESS}\" >> ~/.ssh/config\necho \"  User ec2-user\" >> ~/.ssh/config\n```\n\n```ruby:Vagrantfile\n    override.ssh.username = \"ubuntu\"\n    override.ssh.proxy_command = \"ssh -A nat -W %h:%p\"\n```\n\n\u3053\u3053\u3067\u306f\u3001NAT\u30b5\u30fc\u30d0\u304cAmazonLinux, \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d0\u304cUbuntu\u306e\u60f3\u5b9a\u3067\u3059\u3002\n\u307e\u305apre.sh\u306e\u4e2d\u3067CircleCI\u306e.ssh/config\u306bNAT\u306e\u60c5\u5831\u3092\u66f8\u304d\u8fbc\u3093\u3067\u3084\u308a\u307e\u3059\u3002\n\nVagrant\u3067\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u304d\u306f\u3001\u305d\u306eHost\u3092\u4f7f\u3063\u3066\u30d7\u30ed\u30ad\u30b7\u3057\u307e\u3059\u3002\n\n\n\u307e\u305f\u3001\u3053\u306e\u8a18\u4e8b\u306e\u7bc4\u56f2\u304b\u3089\u306f\u5916\u308c\u307e\u3059\u304c\u3001pre.sh\u306f\u30c7\u30d7\u30ed\u30a4\u524d\u5f8c\u3067\u81ea\u5206\u81ea\u8eab\u304b\u3089\u306eSSH\u3092\u8a31\u53ef\u3057\u3066\u3001\u307e\u305f\u9589\u3058\u3066\u3044\u307e\u3059\u3002\u3053\u308c\u306f\u300c\u666e\u6bb5\u306fSSH\u3092\u4e0d\u8a31\u53ef\u3001\u30c7\u30d7\u30ed\u30a4\u6642\u306e\u307f\u8a31\u53ef\u300d\u3068\u3044\u3046\u904b\u7528\u3092\u3057\u305f\u3044\u305f\u3081\u3067\u3059\u3002\n\n```\n\u203b\u74b0\u5883\u5909\u6570\u306f\u6700\u5f8c\u306b\u8a2d\u5b9a\u3057\u307e\u3059\n```\n\n\n## \u305d\u306e2\uff1a\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30ea\u30dd\u30b8\u30c8\u30ea\u306b\u3078\u30a2\u30af\u30bb\u30b9\u3059\u308b\u305f\u3081\u306e\u8a18\u8ff0\n\n```ruby:Vagrantfile\n  config.ssh.forward_agent = true\n  # ...\n\n    override.ssh.private_key_path = [ENV['GITHUB_CLONE_SSH_KEY_PATH'], ENV['AWS_LOGIN_SSH_KEY_PATH']]\n\n```\n\n```ruby:default.rb\nfile \"/etc/sudoers.d/root_ssh_agent\" do\n  mode 0440\n  owner 'root'\n  group 'root'\n  content \"Defaults env_keep += \\\"SSH_AUTH_SOCK\\\"\\n\"\nend\n\nbash \"add ssh_setting to .ssh/config\" do\n  not_if %!grep Host github.com /root/.ssh/config!\n\n  code <<-EOC\n    echo -e \"Host github.com\\n StrictHostKeyChecking no\\n\" >> /root/.ssh/config\n  EOC\nend\n```\n\n### override.ssh.private_key_path\nVagrant\u3067SSH\u306eAgentForward\u3092\u6709\u52b9\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\u307e\u305f\u3001\n\n* GitHub\u3078\u30a2\u30af\u30bb\u30b9\u3059\u308b\u305f\u3081\u306e\u9375\n* Chef\u304c\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3078\u30a2\u30af\u30bb\u30b9\u3059\u308b\u305f\u3081\u306e\u9375\n\n\u3092\u6307\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\u3053\u3053\u3067\u6307\u5b9a\u3057\u305f\u9375\u304cAgent Forward\u3067\u8ee2\u9001\u3055\u308c\u307e\u3059\u3002\n\n###   content \"Defaults env_keep += \\\"SSH_AUTH_SOCK\\\"\\n\"\nEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3078SSH\u3057\u3066\u3044\u308b\u30e6\u30fc\u30b6\u306f`ubuntu`\u3002\nChef\u306f`root`\u3067\u52d5\u4f5c\u3059\u308b\u3002\u3053\u3053\u3067\u306f`root`\u3078\u5f15\u304d\u7d99\u3050\u74b0\u5883\u5909\u6570\u306bssh-agent\u3092\u8ffd\u52a0\n\n### echo -e \"Host github.com\\n StrictHostKeyChecking no\\n\" >> /root/.ssh/config\nGitHub\u304b\u3089\u306fssh\u3067`git clone`\u3059\u308b\u3002`git clone`\u3059\u308b\u3068\u304d\u306bfingerprint\u306e\u78ba\u8a8d\u3067\u6b62\u307e\u308b\u306e\u3092\u9632\u3050\u305f\u3081\u306b`StrictHostKeyChecking no`\u3092\u8ffd\u52a0\n\n## \u305d\u306e3\uff1aCircleCI\n\u6700\u5f8c\u306bCircleCI\u306e\u300cEnvironment variables\u300d\u3067\u74b0\u5883\u5909\u6570\u3092\u8a2d\u5b9a\u3057\u3066\u3084\u308a\u307e\u3059\u3002\n\n```\nAWS_ACCESS_KEY_ID\nAWS_SECRET_ACCESS_KEY\n\u306b\u3064\u3044\u3066\u306fCircleCI\u306e\u300cAWS Permission\u300d\u304b\u3089\u8a2d\u5b9a\u3057\u3066\u3082\u3044\u3044\u304b\u3082\u3002\n```\n\n| \u5909\u6570\u540d | \u6982\u8981 | \u30b5\u30f3\u30d7\u30eb |\n| --- | --- | --- |\n| AWS_ACCESS_KEY_ID | AWS\u306e\u30a2\u30af\u30bb\u30b9\u30ad\u30fc | xxxxCIBA\t\n| AWS_DEFAULT_REGION | AWS EC2\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u30ea\u30fc\u30b8\u30e7\u30f3| \txxxxst-2\t\n| AWS_DEPLOY_MACHINE_SECURITY_GROUP | EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u5272\u308a\u5f53\u3066\u308b\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7 | \txxxx228c\t\n| AWS_DEPLOY_SUBNET | EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u7acb\u3066\u308b\u30b5\u30d6\u30cd\u30c3\u30c8 | \txxxxbc2c\t\n| AWS_KEYPAIR | AWS\u3067\u4f5c\u6210\u3059\u308bEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306bSSH\u3059\u308b\u6642\u7528keypair\u540d | \txxxxpair\t\n| AWS_LOGIN_SSH_KEY_PATH | \u203b1 | \t\n| AWS_NAT_SECURITY_GROUP | \u30c7\u30d7\u30ed\u30a4\u306b\u4f7f\u3046NAT\u306e\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7 | \txxxx11db\t\n| AWS_NAT_SERVER_IP_ADDRESS | \u30c7\u30d7\u30ed\u30a4\u306b\u4f7f\u3046NAT\u306eEIP | \txxxx9.71\t\n| AWS_SECRET_ACCESS_KEY | AWS\u306e\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u30a2\u30af\u30bb\u30b9\u30ad\u30fc | \txxxx1muU\t\n| GITHUB_CLONE_SSH_KEY_PATH | \u203b2 | \n\n### AWS_LOGIN_SSH_KEY_PATH\nAWS_KEYPAIR\u3067\u8a2d\u5b9a\u3057\u305fkeypair\u306e\u79d8\u5bc6\u9375\u3092CircleCI\u306e\u300cSSH Permission\u300d\u304b\u3089Hostname\u3092\u7a7a\u306b\u3057\u3066\u767b\u9332\u3059\u308b\u3002\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-01-30 15.56.27.png](https://qiita-image-store.s3.amazonaws.com/0/62601/ebc45a2c-69a7-84c4-3153-551c1ac55fbe.png)\n\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-01-30 15.56.54.png](https://qiita-image-store.s3.amazonaws.com/0/62601/377cce31-9917-9edc-3e20-6ba05cff2e5a.png)\n\nHostname\u304c\u7a7a\u306e\u5834\u5408\u3001CircleCI\u306ffingerprint\u306b\u5f93\u3063\u3066\u9375\u3092\u4f5c\u6210\u3059\u308b\u306e\u3067\u3001\u305d\u306e\u30d1\u30b9\u3092\u6307\u5b9a\u3059\u308b\u3002\n\n```\n~/.ssh/id_xxxxxxxxxxxx3044\n```\n\n### GITHUB_CLONE_SSH_KEY_PATH\nCircleCI\u306b\u4e00\u5ea6SSH\u3059\u308b\u3002`~/.ssh/id_github.com`\u3068\u3044\u3046\u9375\uff08CircleCI\u304c\u30ea\u30dd\u30b8\u30c8\u30ea\u3092Checkout\u3059\u308b\u305f\u3081\u306e\u9375, GitHub\u3067\u3044\u3046DeployKey\uff09\u304c\u3042\u308b\u306e\u3067\u3053\u308c\u306e\u4e2d\u8eab\u3092\u300cSSH Permission\u300d\u306bHostname=github.com\u3067\u767b\u9332\u3059\u308b\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-01-30 16.14.15.png](https://qiita-image-store.s3.amazonaws.com/0/62601/0cdb25c4-a0e1-e104-c1a0-4a5620573536.png)\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-01-30 16.14.59.png](https://qiita-image-store.s3.amazonaws.com/0/62601/8e56e29c-d456-980b-b26f-6d41518715cd.png)\n\nHostname\u304c\u7a7a\u3067\u306a\u3044\u5834\u5408\u3001CircleCI\u306fHostname\u306b\u5f93\u3063\u3066\u9375\u3092\u4f5c\u6210\u3059\u308b\u306e\u3067\u3001\u305d\u306e\u30d1\u30b9\u3092\u6307\u5b9a\u3059\u308b\u3002\n\n```\n~/.ssh/id_github.com\n```\n\n# \u5236\u7d04\nhttps://github.com/kotatsu360/private-repo-deploy-sample\n\u3053\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u306e\u3084\u308a\u65b9\u3060\u3068\u3001\u6bce\u56deVagrant\u3067\u65b0\u3057\u3044\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u7acb\u3066\u3066\u3057\u307e\u3046\u306e\u3067\n\u53e4\u3044\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306f\u524a\u9664\u3055\u308c\u308b\u3088\u3046\u306bdeploy.sh\u3067\u8a2d\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\n\n**EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u4e2d\u306b\u30c7\u30fc\u30bf\u3092\u5165\u308c\u3066\u304a\u304f\u3068\u6f0f\u308c\u7121\u304f\u6d88\u3048\u307e\u3059\u3002**\n\n# \u632f\u308a\u8fd4\u3063\u3066\u307f\u3066\n\u300cGitHub\u304b\u3089\u30af\u30ed\u30fc\u30f3\u3057\u305f\u3044\u30ea\u30dd\u30b8\u30c8\u30ea\u300d = \u300cCircleCI\u3067\u30c6\u30b9\u30c8\u3057\u3066\u3044\u308b\u30ea\u30dd\u30b8\u30c8\u30ea\u300d\u306e\u5834\u5408\u3001\u30b7\u30f3\u30d7\u30eb\u306bSCP\u3067\u9001\u308b\u3068\u3044\u3046\u624b\u6bb5\u3082\u3042\u3063\u305f\u3088\u3046\u306a\u3002\u3002\n\n# \u53c2\u8003\n[\u6020\u3051\u8005\u306e\u305f\u3081\u306eVagrant+Chef\u5165\u9580 - Qiita](http://qiita.com/aKunihiroIshiguro/items/b3b4e87e9302e6e0aa33)\n[CircleCI\u304b\u3089\u30b5\u30fc\u30d0\u3078\u306eSSH\u63a5\u7d9a\u78ba\u7acb\u6642\u9593\u3092\u9ad8\u901f\u5316\u3059\u308b](http://stormcat.hatenablog.com/entry/2015/02/18/005045)\n", "tags": ["CircleCI", "AWS", "GitHub", "vagrant", "chef"]}