{"context": "\n\u3053\u306e\u8a18\u4e8b\u306fVASILY DEVELOPERS BLOG\u306b\u3082\u540c\u3058\u5185\u5bb9\u3067\u6295\u7a3f\u3057\u3066\u3044\u307e\u3059\u3002\u3088\u308d\u3057\u3051\u308c\u3070\u4ed6\u306e\u8a18\u4e8b\u3082\u3054\u89a7\u304f\u3060\u3055\u3044\u3002\n\n\nQiita\u8ffd\u8a18\n2016.07.21\u306bUbuntu16.04.1\u304c\u516c\u958b\u3055\u308c\u307e\u3057\u305f\u3002\u5404\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u306e\u30d9\u30fc\u30b9\u30a4\u30e1\u30fc\u30b8\u306b\u3082\u7528\u610f\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\u672c\u6587\u4e2d\u3067\u53c2\u7167\u3057\u3066\u3044\u308b\u30a4\u30e1\u30fc\u30b8\u306eOS\u306fUbuntu16.04\u3068\u5c11\u3057\u53e4\u3044\u305f\u3081\u3001\u9069\u5b9cID\u3092\u66f4\u65b0\u3057\u3066\u4e0b\u3055\u3044\u3002\n\u672c\u6587\u306ejson\u3092\u305d\u306e\u307e\u307e\u4f7f\u3063\u3066\u30a8\u30e9\u30fc\u304c\u51fa\u305f\u5834\u5408\u306f\u3001\u30d9\u30fc\u30b9\u3068\u306a\u308bVM\u30a4\u30e1\u30fc\u30b8\u304c\u5404\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u306b\u5b58\u5728\u3057\u3066\u3044\u308b\u304b\u3054\u78ba\u8a8d\u4e0b\u3055\u3044\u3002\n\n\u672c\u6587\n\u958b\u767a\u3092\u3057\u3066\u3044\u308b\u3068\u672c\u756a\u30b5\u30fc\u30d0\u3068\u958b\u767a\u30b5\u30fc\u30d0\u306e\u4e56\u96e2\u304c\u554f\u984c\u306b\u306a\u308b\u3068\u601d\u3044\u307e\u3059\u3002\u3053\u308c\u306b\u3064\u3044\u3066\u3001\u5148\u65e5\u884c\u308f\u308c\u305fUZABASE Meetup#4 \u301c\u5927\u898f\u6a21\u30b5\u30fc\u30d3\u30b9\u3092\u652f\u3048\u308b\u30a4\u30f3\u30d5\u30e9\u301c\u306b\u3066\u300c1\u30b3\u30de\u30f3\u30c9\u3067\u672c\u756a\u30b5\u30fc\u30d0\u3068\u958b\u767a\u30b5\u30fc\u30d0 (\u306eVM\u30a4\u30e1\u30fc\u30b8)\u3092\u4f5c\u308b\u8a71\u300d\u3068\u3044\u3046\u767a\u8868\u3092\u3055\u305b\u3066\u3044\u305f\u3060\u304d\u307e\u3057\u305f\u3002\n\u3053\u306e\u8a18\u4e8b\u3067\u306f\u3001\u6642\u9593\u3068\u30b9\u30e9\u30a4\u30c9\u306e\u90fd\u5408\u4e0a\u3001\u7701\u7565\u3057\u305fbase.json\u306b\u3064\u3044\u3066\u3054\u7d39\u4ecb\u3044\u305f\u3057\u307e\u3059\u3002\n\npacker build base.json\n\u767a\u8868\u8cc7\u6599\u306f\u3053\u3061\u3089\uff08speederdeck\uff09\npacker\u3067\u8aad\u307f\u8fbc\u3080json\u306f\u6b21\u306e4\u30d1\u30fc\u30c8\u306b\u5206\u304b\u308c\u3066\u3044\u307e\u3059\u3002\n  \"variables\":{\n  // \u5909\u6570\n  }, \n  \"builders\":[\n  // \u4f5c\u6210\u3057\u305f\u3044\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u3054\u3068\u306e\u8a2d\u5b9a\n  ],\n  \"provisioners\": [\n  // \u30de\u30b7\u30f3\u30a4\u30e1\u30fc\u30b8\u3078\u306e\u521d\u671f\u8a2d\u5b9a chef, shell script, ansible ...\n  ],\n  \"post-processors\": [\n  // \u4f5c\u6210\u3057\u305f\u30de\u30b7\u30f3\u30a4\u30e1\u30fc\u30b8\u3078\u306e\u5f8c\u51e6\u7406\n  ]\n\n\u975e\u5e38\u306b\u30b7\u30f3\u30d7\u30eb\u306a\u306e\u3067\u3059\u304c\u3001\u5b9f\u969b\u306b\u8a2d\u5b9a\u3057\u3066\u3044\u304f\u3068\u7d30\u304b\u306a\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u8a2d\u5b9a\u3067\u60a9\u307f\u307e\u3059\u3002\u3068\u3044\u3046\u3053\u3068\u3067\u5b9f\u969b\u306b\u4f7f\u3063\u3066\u3044\u308bjson\u30d5\u30a1\u30a4\u30eb\u5168\u6587\u3092\u3053\u3061\u3089\u306b\u3054\u7528\u610f\u3057\u307e\u3057\u305f\uff01\npacker/base.json\n{\n  \"variables\":{\n    \"version\":  \"1.0.2\",\n    \"role\": \"base\",\n    \"ami\": \"ami-5d38d93c\",\n    \"aws_access\": \"{{ env `AWS_ACCESS_KEY_ID`}}\",\n    \"aws_secret\": \"{{ env `AWS_SECRET_ACCESS_KEY`}}\",\n    \"gce_source_image\": \"ubuntu-1604-xenial-v20160627\",\n    \"gce_secret\": \"{{ env `GCE_ACCOUNT_FILE`}}\",\n    \"s3_bucket\": \"{{ env `AWS_INFRA_S3_BUCKET`}}\",\n    \"gce_project_id\": \"{{ env `GCE_PROJECT_ID`}}\"\n  },\n  \"builders\":[\n    {\n      \"type\": \"virtualbox-ovf\",\n      \"headless\": \"true\",\n      \"shutdown_command\": \"echo 'ubuntu' | sudo -S shutdown -P now\",\n      \"source_path\": \"box-source/ubuntu-16.04.ova\",\n      \"ssh_password\": \"ubuntu\",\n      \"ssh_username\": \"ubuntu\",\n      \"ssh_wait_timeout\": \"20m\",\n      \"vboxmanage\": [\n        [\"modifyvm\", \"{{ .Name }}\", \"--memory\", \"4096\"],\n        [\"modifyvm\", \"{{ .Name }}\", \"--cpus\", \"2\"]\n      ],\n      \"virtualbox_version_file\": \".vbox_version\",\n      \"vm_name\": \"{{user `role`}}\",\n      \"guest_additions_mode\": \"disable\",\n      \"format\": \"ova\",\n      \"output_directory\": \"output-{{build_name}}-{{user `role`}}\"\n    },\n    {\n      \"type\": \"amazon-ebs\",\n      \"access_key\": \"{{user `aws_access`}}\",\n      \"secret_key\": \"{{user `aws_secret`}}\",\n      \"source_ami\": \"{{user `ami`}}\",\n      \"instance_type\": \"c3.xlarge\",\n      \"region\": \"ap-northeast-1\",\n      \"ssh_username\": \"ubuntu\",\n\n      \"ami_name\": \"packer-ubuntu1604-ruby231-{{timestamp}}\",\n      \"ami_regions\": [\n        \"ap-northeast-1\"\n      ],\n      \"ami_description\" : \"iQON AMI {{user `role`}} Image\",\n      \"tags\": {\n        \"OS\": \"Ubuntu16.04\",\n        \"Ruby\": \"2.3.1\",\n        \"Role\": \"{{user `role`}}\",\n        \"OriginalAMI\": \"ami-5d38d93c\"\n      }\n    },\n    {\n      \"type\": \"googlecompute\",\n      \"account_file\": \"{{user `gce_secret`}}\",\n      \"project_id\": \"{{user `gce_project_id`}}\",\n      \"source_image\": \"{{user `gce_source_image`}}\",\n      \"zone\": \"asia-east1-a\",\n      \"machine_type\": \"n1-highcpu-4\",\n      \"ssh_username\": \"ubuntu\",\n      \"instance_name\": \"packer-{{timestamp}}\",\n      \"image_name\": \"packer-ubuntu1604-ruby231-{{timestamp}}\",\n      \"image_description\" : \"iQON AMI {{user `Role`}} Image\"\n\n    }\n  ],\n  \"provisioners\": [\n    {\n      \"type\": \"file\",\n      \"source\": \"{{pwd}}/../chef-repo\",\n      \"destination\": \"/tmp/packer-chef-client/\"\n    },\n    {\n      \"type\": \"shell\",\n      \"inline\": [\n        \"sudo apt-get update\",\n        \"sudo apt-get upgrade -y\",\n        \"sudo apt-get install -y language-pack-ja curl\",\n        \"sudo update-locale LANG=ja_JP.UTF-8 && true\",\n        \"sudo ln -sf /bin/bash /bin/sh\"\n      ]\n    },\n    {\n      \"type\": \"chef-client\",\n      \"server_url\": \"http://localhost:8889\",\n      \"config_template\": \"../chef-repo/client.rb\",\n      \"install_command\": \"curl -L https://www.chef.io/chef/install.sh | sudo bash  -s -- -v 12.8.1\",\n      \"execute_command\": \"sudo chef-client -z -c /tmp/packer-chef-client/client.rb -j /tmp/packer-chef-client/nodes/packer-{{user `role`}}.json\",\n      \"guest_os_type\": \"unix\",\n      \"skip_clean_node\": true,\n      \"skip_clean_client\": true\n    },\n    {\n      \"type\": \"shell\",\n      \"only\": [\"virtualbox-ovf\"],\n      \"inline\": [\n        \"sudo systemctl disable apt-daily.service\",\n        \"sudo systemctl disable apt-daily.timer\"\n      ]\n    }\n  ],\n  \"post-processors\": [\n    {\n      \"type\": \"shell-local\",\n      \"only\": [\"virtualbox-ovf\"],\n      \"inline\": [\n        \"rsync --checksum -av output-virtualbox-ovf-{{user `role`}}/ box-source/{{user `role`}}\",\n        \"aws s3 sync box-source s3://{{user `s3_bucket`}}/vagrant/box-source\"\n      ]\n    },\n    [\n      {\n        \"type\": \"vagrant\",\n        \"only\": [\"virtualbox-ovf\"],\n        \"keep_input_artifact\": false,\n        \"output\": \"packer-output/{{user `role`}}/{{user `role`}}.box\",\n        \"override\": {\n          \"virtualbox\": {\n            \"compression_level\": 0\n          }\n        }\n      },\n      {\n        \"type\": \"vagrant-s3\",\n        \"only\": [\"virtualbox-ovf\"],\n        \"region\": \"ap-northeast-1\",\n        \"bucket\":   \"{{user `s3_bucket`}}\",\n        \"manifest\": \"vagrant/json/{{user `role`}}.json\",\n        \"box_name\": \"{{user `role`}}\",\n        \"box_dir\":  \"vagrant/boxes\",\n        \"version\":  \"{{ user `version` }}\",\n        \"acl\": \"private\",\n        \"access_key_id\": \"{{user `aws_access`}}\",\n        \"secret_key\": \"{{user `aws_secret`}}\"\n      }\n    ]\n  ]\n}\n\n\n\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u3084\u7d44\u7e54\u56fa\u6709\u306e\u90e8\u5206\u306b\u3064\u3044\u3066\u306f\u74b0\u5883\u5909\u6570\u3092\u8aad\u307f\u8fbc\u3080\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\u307e\u305f\u5b9f\u884c\u6642\u306b\u5f15\u6570\u3068\u3057\u3066\u6e21\u3059\u4e8b\u3082\u53ef\u80fd\u3067\u3059\u3002\nUser Variables in Templates - Packer by HashiCorp\n\nbase.json\u306e\u4e2d\u8eab\npacker\u306finspect\u3068\u3044\u3046\u30b5\u30d6\u30b3\u30de\u30f3\u30c9\u3067\u305d\u306eJSON\u3067\u4f55\u304c\u5b9f\u884c\u3055\u308c\u308b\u306e\u304b\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002base.json\u3092\u898b\u3066\u307f\u307e\u3059\u3002\n$ packer inspect base.json\nOptional variables and their defaults:\n\n  ami              = ami-5d38d93c\n  aws_access       = {{ env `AWS_ACCESS_KEY_ID`}}\n  aws_secret       = {{ env `AWS_SECRET_ACCESS_KEY`}}\n  gce_project_id   = {{ env `GCE_PROJECT_ID`}}\n  gce_secret       = {{ env `GCE_ACCOUNT_FILE`}}\n  gce_source_image = ubuntu-1604-xenial-v20160627\n  role             = base\n  s3_bucket        = {{ env `AWS_INFRA_S3_BUCKET`}}\n  version          = 1.0.2\n\nBuilders:\n\n  amazon-ebs    \n  googlecompute \n  virtualbox-ovf\n\nProvisioners:\n\n  file\n  shell\n  chef-client\n  shell\n\n\u3053\u306ebase.json\u3067\u306f\u30019\u500b\u306e\u30e6\u30fc\u30b6\u5b9a\u7fa9\u5909\u6570\u3067\u52d5\u4f5c\u304c\u5236\u5fa1\u3055\u308c\u3066\u304a\u308a\u3001\n\nami (EBS-attached)\ngoogle compute engine image\nvirtualbox ovf (vagrant box\u7528\uff09\n\n\u304c\u4f5c\u3089\u308c\u3001\u305d\u308c\u305e\u308c\u30d7\u30ed\u30d3\u30b8\u30e7\u30f3\u306f\n\nfile copy\nremote shell\u306e\u5b9f\u884c\nchef client\nremote shell\u306e\u5b9f\u884c\n\n\u3068\u3044\u3046\u9806\u756a\u3067\u884c\u308f\u308c\u308b\u3002\u3068\u3044\u3046\u3053\u3068\u304c\u5206\u304b\u308a\u307e\u3059\u3002\u3082\u3046\u5c11\u3057\u5206\u89e3\u3057\u3066\u898b\u3066\u3044\u304d\u307e\u3059\u3002\n\nvariables\nAWS\u306e\u30c8\u30fc\u30af\u30f3\u3084\u30aa\u30ea\u30b8\u30ca\u30ebAMI (\u3053\u3053\u3067\u306fUbuntu16.04) \u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\u8907\u6570\u56de\u767b\u5834\u3059\u308b\u8981\u7d20\u306fvariables\u3067\u5b9a\u7fa9\u3057\u3066\u304a\u3044\u305f\u65b9\u304c\u898b\u901a\u3057\u304c\u826f\u304f\u306a\u308a\u307e\u3059\u3002\n\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u3092\u30d5\u30a1\u30a4\u30eb\u306b\u542b\u3081\u306a\u304f\u3066\u6e08\u3080\u306e\u3067GitHub\u306b\u30b3\u30df\u30c3\u30c8\u3059\u308b\u3068\u304d\u3082\u5b89\u5168\u3067\u3059\u3002\n  \"variables\":{\n    \"aws_access\": \"{{ env `AWS_ACCESS_KEY_ID`}}\",\n    \"aws_secret\": \"{{ env `AWS_SECRET_ACCESS_KEY`}}\"\n  },\n\n\nbuilders\nVagrant box\u306e\u5143\u3068\u306a\u308bVirtualBox\u3068\u672c\u756a\u3067\u4f7f\u3046AMI/GCE Image\u3092\u4f5c\u3063\u3066\u3044\u307e\u3059\u3002\n  \"builders\":[\n    {\n      \"type\": \"virtualbox-ovf\",\n      \"source_path\": \"box-source/ubuntu-16.04.ova\",\n      ...\n    },\n    {\n      \"type\": \"amazon-ebs\",\n      ...\n    },\n    {\n      \"type\": \"googlecompute\",\n      ...\n  ]\n\nAMI/GCE Image\u306b\u3064\u3044\u3066\u306f\u898b\u305f\u307e\u307e\u3067\u3059\u3002\u5404\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u304c\u516c\u5f0f\u3067\u63d0\u4f9b\u3057\u3066\u3044\u308bUbuntu16.04\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u4f7f\u3063\u3066\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u7acb\u3066\u3001\u5f8c\u8ff0\u306e\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u3092\u884c\u3044\u3001\u30de\u30b7\u30f3\u30a4\u30e1\u30fc\u30b8\u3092\u4fdd\u5b58\u3057\u3066\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u524a\u9664\u3057\u3066\u304f\u308c\u307e\u3059\u3002\n\u4e00\u65b9\u3001VirtualBox\u306b\u3064\u3044\u3066\u306f\u4e00\u624b\u9593\u304b\u3051\u3066\u3044\u307e\u3059\u3002source_path\u3067\u6307\u5b9a\u3057\u3066\u3044\u308bova\u306fCanonical\u304c\u63d0\u4f9b\u3057\u3066\u3044\u308biso\u3092\u4e00\u5ea6VirtualBox\u306b\u5165\u308c\u3066\u3001OVF2.0\u3067\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u3057\u305f\u3082\u306e\u3067\u3059\u3002\nUbuntu14.04\u3060\u3068Canonical\u516c\u5f0f\u306ebox\u3092tar\u3067\u89e3\u51cd\u3057\u305f\u3068\u304d\u306b\u51fa\u3066\u304f\u308bova\u3092packer\u3067\u8aad\u307f\u8fbc\u3081\u305f\u306e\u3067\u3059\u304c\u3001Ubuntu16.04\u306ebox\u304b\u3089\u540c\u69d8\u306b\u4f5c\u6210\u3057\u305fova\u306f\u8aad\u307f\u8fbc\u307f\u30a8\u30e9\u30fc\u306b\u306a\u3063\u305f\u305f\u3081\u81ea\u5206\u3067\u4f5c\u6210\u3057\u307e\u3057\u305f\u3002\n\nprovisioners\n  \"provisioners\": [\n    {\n      \"type\": \"file\",\n      \"source\": \"{{pwd}}/../chef-repo\",\n      \"destination\": \"/tmp/packer-chef-client/\"\n    },\n    {\n      \"type\": \"shell\",\n      \"inline\": [\n        \"sudo apt-get update\",\n        \"sudo apt-get upgrade -y\",\n        \"sudo apt-get install -y language-pack-ja curl\",\n        \"sudo update-locale LANG=ja_JP.UTF-8 && true\",\n        \"sudo ln -sf /bin/bash /bin/sh\"\n      ]\n    },\n    {\n      \"type\": \"chef-client\",\n      \"config_template\": \"../chef-repo/client.rb\",\n      \"execute_command\": \"sudo chef-client -z -c /tmp/packer-chef-client/client.rb -j /tmp/packer-chef-client/nodes/packer-{{user `role`}}.json\",\n    },\n    {\n      \"type\": \"shell\",\n      \"only\": [\"virtualbox-ovf\"],\n      \"inline\": [\n        \"sudo systemctl disable apt-daily.service\",\n        \"sudo systemctl disable apt-daily.timer\"\n      ]\n    }\n  ],\n\npacker\u3067\u4e00\u756a\u30cf\u30de\u3063\u305f\u306e\u304c\u3053\u306eprovisiners\u3067\u3059\u3002\u5927\u304d\u306a\u6d41\u308c\u306f\u3001\n\nchef\u3067\u4f7f\u3046\u30d5\u30a1\u30a4\u30eb\u3092\u30ed\u30fc\u30ab\u30eb\u304b\u3089VM\u306b\u30b3\u30d4\u30fc\n\u8a2d\u5b9a\u3092\u3057\u3066\u304a\u304b\u306a\u3044\u3068\u305d\u3082\u305d\u3082chef\u304c\u5b9f\u884c\u3067\u304d\u306a\u3044\u51e6\u7406\u3092remote shell\u3067\u5b9f\u884c\nchef client\u3092local mode\u3067\u5b9f\u884c\n\nvirtualbox-ovf\u9650\u5b9a\u3067\u3001\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u8d77\u52d5\u6642\u306eapt-get update\u3092\u505c\u6b62\n\n\u3068\u3044\u3046\u3053\u3068\u3092\u3084\u3063\u3066\u3044\u307e\u3059\u30024\u756a\u76ee\u306f\u767a\u8868\u8cc7\u6599\u306e23\u30da\u30fc\u30b8\u76ee\u3067\u89e6\u308c\u3066\u3044\u308bapt-get\u304cchef\u3068\u885d\u7a81\u3059\u308b\u306e\u3092\u907f\u3051\u308b\u305f\u3081\u3067\u3059\u3002\n\n\u3061\u306a\u307f\u306b\u30013\u3067\u53c2\u7167\u3057\u3066\u3044\u308bclient.rb\u306e\u4e2d\u8eab\u306f\u3053\u3046\u306a\u3063\u3066\u3044\u307e\u3059\u30021\u3067\u30b3\u30d4\u30fc\u3057\u305fchef-repo\u306e\u69cb\u9020\u3092\u6307\u793a\u3057\u3066\u3044\u307e\u3059\u3002\n# coding: utf-8\nchef_repo_path \"/tmp/packer-chef-client\"\ncookbook_path [\n  \"/tmp/packer-chef-client/site-cookbooks\",\n  \"/tmp/packer-chef-client/cookbooks\"\n]\nlog_location \"/var/log/chef-client.log\"\nlog_level :info\n\n\npost-processors\n  \"post-processors\": [\n    {\n      \"type\": \"shell-local\",\n      \"only\": [\"virtualbox-ovf\"],\n      \"inline\": [\n        \"rsync --checksum -av output-virtualbox-ovf-{{user `role`}}/ box-source/{{user `role`}}\",\n        \"aws s3 sync box-source s3://{{user `s3_bucket`}}/vagrant/box-source\"\n      ]\n    },\n    [\n      {\n        \"type\": \"vagrant\",\n        \"only\": [\"virtualbox-ovf\"],\n        ...\n      },\n      {\n        \"type\": \"vagrant-s3\",\n        \"only\": [\"virtualbox-ovf\"],\n        \"manifest\": \"vagrant/json/{{user `role`}}.json\",\n        ...\n      }\n    ]\n  ]\n\npost-processors\u306fbuilders\u3067\u4f5c\u6210\u3057\u305fVM\u30a4\u30e1\u30fc\u30b8\u306b\u5bfe\u3057\u3066\u5f8c\u51e6\u7406\u3092\u884c\u3046\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\u3053\u3053\u3067\u306f\u3001virtualbox-ovf\u306e\u7d50\u679c\u3092\u4f7f\u3063\u3066\u3001vagrant box\u3092\u4f5c\u6210\u3057\u3066\u3044\u307e\u3059\u3002\n\u3067\u304d\u305f\u3082\u306e\u306fS3\u306b\u4fdd\u5b58\u3057\u3001\u30c1\u30fc\u30e0\u5168\u54e1\u3067\u5171\u901a\u306ebox\u3092\u4f7f\u3048\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\u3053\u306e\u7ba1\u7406\u65b9\u6cd5\u306b\u3064\u3044\u3066\u306f\u3053\u3061\u3089\u306e\u6295\u7a3f\u3092\u53c2\u8003\u306b\u3055\u305b\u3066\u3044\u305f\u3060\u304d\u307e\u3057\u305f\u3002\nPacker \u3067\u958b\u767a\u74b0\u5883\u306e Vagrant Box \u3092\u81ea\u4f5c\u3057\u3066\u3001post-processors \u51e6\u7406\u3092\u901a\u3057\u3066 S3 \u306b\u4fdd\u5b58\u30fb\u30d0\u30fc\u30b8\u30e7\u30f3\u7ba1\u7406\u30fb\u30db\u30b9\u30c6\u30a3\u30f3\u30b0\u3059\u308b - Qiita\n\n\u305d\u306e\u4ed6\u88dc\u8db3\n\n\u30c8\u30fc\u30af\u30f3\u306e\u6a29\u9650\u306b\u3064\u3044\u3066\nAWS/GCE\u306e\u30c8\u30fc\u30af\u30f3\u306b\u5fc5\u8981\u306a\u6a29\u9650\u306b\u3064\u3044\u3066\u306f\u3001\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3067\u4e01\u5be7\u306b\u7d39\u4ecb\u3055\u308c\u3066\u3044\u307e\u3059\u306e\u3067\u4e0a\u3067\u306f\u8aac\u660e\u3092\u7701\u7565\u3057\u3066\u3044\u307e\u3059\u3002\n[https://www.packer.io/docs/builders/amazon.html:title]\n[https://www.packer.io/docs/builders/googlecompute.html:title]\n\n\u30d3\u30eb\u30c9\u5bfe\u8c61\u306b\u3064\u3044\u3066\npacker build base.json\n\n\u3068\u5b9f\u884c\u3059\u308b\u30683\u3064\u306e\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u3067\u30d3\u30eb\u30c9\u304c\u59cb\u307e\u308a\u307e\u3059\u304c\u3001\u5bfe\u8c61\u3092\u7d5e\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\npacker build -only='amazon-ebs' base.json\n\n\u3053\u306e\u5834\u5408\u3001AMI\u3060\u3051\u30d3\u30eb\u30c9\u304c\u59cb\u307e\u308a\u307e\u3059\u3002\n[https://www.packer.io/docs/command-line/build.html:title]\n\nAWS\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30bf\u30a4\u30d7\u306b\u3064\u3044\u3066\npacker\u3068\u3044\u3046\u3088\u308a\u3082AWS\u306e\u8a71\u984c\u306b\u306a\u308a\u307e\u3059\u304c\u3001\u691c\u8a3c\u4e2dUbuntu16.04 + {m,c,r}3.large\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u5834\u5408\u306b\u30ab\u30fc\u30cd\u30eb\u30d1\u30cb\u30c3\u30af\u304c\u767a\u751f\u3057\u6b63\u5e38\u306b\u8d77\u52d5\u3057\u306a\u3044\u3068\u3044\u3046\u554f\u984c\u304c\u3042\u308a\u307e\u3057\u305f\u3002\n\u3053\u3061\u3089\u306eissue\u306b\u8fd1\u3044\u306e\u3067\u3059\u304c\u8a73\u7d30\u304c\u78ba\u8a8d\u3067\u304d\u305a\u3001large\u3092\u4f7f\u308f\u306a\u3044\u3068\u3044\u3046\u5bfe\u5fdc\u7b56\u3092\u53d6\u3063\u3066\u3044\u307e\u3059\u3002\n[https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1573231:title]\n\u3082\u3046\u76f4\u3063\u3066\u3044\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u304c\u304a\u6c17\u3092\u3064\u3051\u4e0b\u3055\u3044\u3002\n\n\u73fe\u72b6\u306e\u5236\u7d04\n\u3053\u306ebase.json\u3092\u4f7f\u3046\u969b\u30012\u3064\u89e3\u6c7a\u3067\u304d\u3066\u306a\u3044\u554f\u984c\u304c\u3042\u308a\u307e\u3059\u3002\n\n\u4e00\u3064\u76ee\uff1avirtualbox-ovf\u306e\u4e00\u6642\u30d5\u30a1\u30a4\u30eb\npacker\u306f\u4e00\u6642\u30d5\u30a1\u30a4\u30eb\u304c\u6b8b\u3063\u3066\u3044\u308b\u3068\u5b9f\u884c\u6642\u306b\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3059\u3002\n\u57fa\u672c\u52d5\u4f5c\u3068\u3057\u3066\u306f\u6d88\u3048\u308b\u306f\u305a\u306a\u306e\u3067\u3059\u304c\u3001post-provisioners\u306e\u66f8\u304d\u65b9\u304c\u60aa\u3044\u306e\u304b\u3001\u3042\u308b\u6642\u304b\u3089\u6d88\u3048\u306a\u304f\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u3002\n# 2\u56de\u76ee\u306e\u5b9f\u884c\n$ packer build base.json\nvirtualbox-ovf output will be in this color.\n\nBuild 'virtualbox-ovf' errored: Output directory exists: output-virtualbox-ovf-base\n\nUse the force flag to delete it prior to building.\n\n\u624b\u52d5\u3067\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u6d88\u3059\u304b\u3001-force\u3092\u4ed8\u3051\u3066build\u3092\u5b9f\u884c\u3057\u3066\u4e0b\u3055\u3044\u3002\npacker build -force base.json\n\n\n\u4e8c\u3064\u76ee\uff1a\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u624b\u52d5\u5909\u66f4\nvagrant box\u306e\u7ba1\u7406\u3067manifest.json\u3092\u5185\u90e8\u3067\u751f\u6210\u3057\u3066\u304a\u308a\u3001\u65e2\u306b\u5b58\u5728\u3059\u308b\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u5834\u5408\u306f\u6700\u5f8c\u306evagrant-s3\u304c\u5931\u6557\u3057\u307e\u3059\u3002\n  \"variables\":{\n    \"version\":  \"1.0.2\",\n\nvagrant\u306e\u4ed5\u69d8\u4e0a\u3001x.x.x\u306e\u5f62\u5f0f\u306b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u3001\u30bf\u30a4\u30e0\u30b9\u30bf\u30f3\u30d7\u3068\u3044\u3046\u308f\u3051\u306b\u3082\u3044\u304d\u307e\u305b\u3093\u3002\u4eba\u9593\u30a4\u30f3\u30af\u30ea\u30e1\u30f3\u30c8\u306a\u306e\u3067\u306a\u3093\u3068\u304b\u3057\u305f\u3044\u3068\u601d\u3063\u3066\u3044\u307e\u3059\u3002\n\n\u4eca\u5f8c\u3084\u308a\u305f\u3044\u3053\u3068\n\u307e\u3060\u307e\u3060\u3053\u306a\u308c\u3066\u304a\u3089\u305a\u3001\u65e5\u3005json\u3092\u66f4\u65b0\u3057\u3066\u3044\u307e\u3059\u3002\n\u4f8b\u3048\u3070\u3001EC2\u306b\u95a2\u3057\u3066\u306f\u30b9\u30dd\u30c3\u30c8\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u4f7f\u3046\u3088\u3046\u4fee\u6b63\u3092\u3057\u3066\u3044\u308b\u3068\u3053\u308d\u3067\u3059\u3002\n\u30cf\u30a4\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u624b\u9803\u306a\u5024\u6bb5\u3067\u4f7f\u3048\u308b\u305f\u3081\u3001\u3088\u308a\u5feb\u9069\u306a\u30a4\u30e1\u30fc\u30b8\u66f4\u65b0\u4f5c\u696d\u304c\u3067\u304d\u308b\u3068\u601d\u3063\u3066\u3044\u307e\u3059\u3002\n\n\u307e\u3068\u3081\n\u304b\u306a\u308a\u99c6\u3051\u8db3\u3067\u306f\u3042\u308a\u307e\u3057\u305f\u304c\u3001\u5b9f\u969b\u306b\u904b\u7528\u3057\u3066\u3044\u308bpacker\u7528\u306eJSON\u30d5\u30a1\u30a4\u30eb\u306b\u3064\u3044\u3066\u3054\u7d39\u4ecb\u3044\u305f\u3057\u307e\u3057\u305f\u3002\npacker\u306f\u7c21\u5358\u306b\u59cb\u3081\u3089\u308c\u307e\u3059\u304c\u3001\u3061\u3087\u3063\u3068\u51dd\u3063\u305f\u3053\u3068\u3092\u3057\u3088\u3046\u3068\u601d\u3046\u3068\u3084\u306f\u308a\u30aa\u30d7\u30b7\u30e7\u30f3\u306e\u8abf\u6574\u304c\u907f\u3051\u3089\u308c\u307e\u305b\u3093\u3002\n\u3053\u306e\u8a18\u4e8b\u304c\u4f55\u304b\u3057\u3089\u53c2\u8003\u306b\u306a\u308c\u3070\u5e78\u3044\u3067\u3059\u3002\n\u9006\u306b\u300c\u304a\u524d\u306epacker\u8853\u306f\u9593\u9055\u3063\u3066\u3044\u308b\u300d\u3068\u3044\u3046\u90e8\u5206\u304c\u3042\u308a\u307e\u3057\u305f\u3089\u3001\u30b3\u30e1\u30f3\u30c8\u3067\u3054\u6307\u6458\u4e0b\u3055\u3044\u3002\u5c0f\u8e8d\u308a\u3057\u3066\u559c\u3073\u307e\u3059\u3002\n> \u3053\u306e\u8a18\u4e8b\u306f[VASILY DEVELOPERS BLOG](http://tech.vasily.jp/entry/create-prod-and-dev-vm-image-atst-by-packer)\u306b\u3082\u540c\u3058\u5185\u5bb9\u3067\u6295\u7a3f\u3057\u3066\u3044\u307e\u3059\u3002\u3088\u308d\u3057\u3051\u308c\u3070\u4ed6\u306e\u8a18\u4e8b\u3082\u3054\u89a7\u304f\u3060\u3055\u3044\u3002\n> \n\n# Qiita\u8ffd\u8a18\n2016.07.21\u306b**Ubuntu16.04.1**\u304c\u516c\u958b\u3055\u308c\u307e\u3057\u305f\u3002\u5404\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u306e\u30d9\u30fc\u30b9\u30a4\u30e1\u30fc\u30b8\u306b\u3082\u7528\u610f\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\u672c\u6587\u4e2d\u3067\u53c2\u7167\u3057\u3066\u3044\u308b\u30a4\u30e1\u30fc\u30b8\u306eOS\u306f**Ubuntu16.04**\u3068\u5c11\u3057\u53e4\u3044\u305f\u3081\u3001\u9069\u5b9cID\u3092\u66f4\u65b0\u3057\u3066\u4e0b\u3055\u3044\u3002\n\n\u672c\u6587\u306ejson\u3092\u305d\u306e\u307e\u307e\u4f7f\u3063\u3066\u30a8\u30e9\u30fc\u304c\u51fa\u305f\u5834\u5408\u306f\u3001\u30d9\u30fc\u30b9\u3068\u306a\u308bVM\u30a4\u30e1\u30fc\u30b8\u304c\u5404\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u306b\u5b58\u5728\u3057\u3066\u3044\u308b\u304b\u3054\u78ba\u8a8d\u4e0b\u3055\u3044\u3002\n\n# \u672c\u6587\n\n\u958b\u767a\u3092\u3057\u3066\u3044\u308b\u3068\u672c\u756a\u30b5\u30fc\u30d0\u3068\u958b\u767a\u30b5\u30fc\u30d0\u306e\u4e56\u96e2\u304c\u554f\u984c\u306b\u306a\u308b\u3068\u601d\u3044\u307e\u3059\u3002\u3053\u308c\u306b\u3064\u3044\u3066\u3001\u5148\u65e5\u884c\u308f\u308c\u305f[UZABASE Meetup#4 \u301c\u5927\u898f\u6a21\u30b5\u30fc\u30d3\u30b9\u3092\u652f\u3048\u308b\u30a4\u30f3\u30d5\u30e9\u301c](http://uzabase-meetup.connpass.com/event/33709/)\u306b\u3066\u300c1\u30b3\u30de\u30f3\u30c9\u3067\u672c\u756a\u30b5\u30fc\u30d0\u3068\u958b\u767a\u30b5\u30fc\u30d0 (\u306eVM\u30a4\u30e1\u30fc\u30b8)\u3092\u4f5c\u308b\u8a71\u300d\u3068\u3044\u3046\u767a\u8868\u3092\u3055\u305b\u3066\u3044\u305f\u3060\u304d\u307e\u3057\u305f\u3002\n\n<script async class=\"speakerdeck-embed\" data-id=\"3f0048e00cb2495ab5920b139bd6547a\" data-ratio=\"1.77777777777778\" src=\"//speakerdeck.com/assets/embed.js\"></script>\n\n\u3053\u306e\u8a18\u4e8b\u3067\u306f\u3001\u6642\u9593\u3068\u30b9\u30e9\u30a4\u30c9\u306e\u90fd\u5408\u4e0a\u3001\u7701\u7565\u3057\u305fbase.json\u306b\u3064\u3044\u3066\u3054\u7d39\u4ecb\u3044\u305f\u3057\u307e\u3059\u3002\n\n<!-- more -->\n\n# packer build base.json\n[\u767a\u8868\u8cc7\u6599\u306f\u3053\u3061\u3089\uff08speederdeck\uff09](https://speakerdeck.com/kotatsu360/create-prod-and-dev-vm-image-atst-by-packer)\n\npacker\u3067\u8aad\u307f\u8fbc\u3080json\u306f\u6b21\u306e4\u30d1\u30fc\u30c8\u306b\u5206\u304b\u308c\u3066\u3044\u307e\u3059\u3002\n\n```json\n  \"variables\":{\n  // \u5909\u6570\n  }, \n  \"builders\":[\n  // \u4f5c\u6210\u3057\u305f\u3044\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u3054\u3068\u306e\u8a2d\u5b9a\n  ],\n  \"provisioners\": [\n  // \u30de\u30b7\u30f3\u30a4\u30e1\u30fc\u30b8\u3078\u306e\u521d\u671f\u8a2d\u5b9a chef, shell script, ansible ...\n  ],\n  \"post-processors\": [\n  // \u4f5c\u6210\u3057\u305f\u30de\u30b7\u30f3\u30a4\u30e1\u30fc\u30b8\u3078\u306e\u5f8c\u51e6\u7406\n  ]\n```\n\n\u975e\u5e38\u306b\u30b7\u30f3\u30d7\u30eb\u306a\u306e\u3067\u3059\u304c\u3001\u5b9f\u969b\u306b\u8a2d\u5b9a\u3057\u3066\u3044\u304f\u3068\u7d30\u304b\u306a\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u8a2d\u5b9a\u3067\u60a9\u307f\u307e\u3059\u3002\u3068\u3044\u3046\u3053\u3068\u3067\u5b9f\u969b\u306b\u4f7f\u3063\u3066\u3044\u308bjson\u30d5\u30a1\u30a4\u30eb\u5168\u6587\u3092\u3053\u3061\u3089\u306b\u3054\u7528\u610f\u3057\u307e\u3057\u305f\uff01\n\npacker/base.json\n\n```json\n{\n  \"variables\":{\n    \"version\":  \"1.0.2\",\n    \"role\": \"base\",\n    \"ami\": \"ami-5d38d93c\",\n    \"aws_access\": \"{{ env `AWS_ACCESS_KEY_ID`}}\",\n    \"aws_secret\": \"{{ env `AWS_SECRET_ACCESS_KEY`}}\",\n    \"gce_source_image\": \"ubuntu-1604-xenial-v20160627\",\n    \"gce_secret\": \"{{ env `GCE_ACCOUNT_FILE`}}\",\n    \"s3_bucket\": \"{{ env `AWS_INFRA_S3_BUCKET`}}\",\n    \"gce_project_id\": \"{{ env `GCE_PROJECT_ID`}}\"\n  },\n  \"builders\":[\n    {\n      \"type\": \"virtualbox-ovf\",\n      \"headless\": \"true\",\n      \"shutdown_command\": \"echo 'ubuntu' | sudo -S shutdown -P now\",\n      \"source_path\": \"box-source/ubuntu-16.04.ova\",\n      \"ssh_password\": \"ubuntu\",\n      \"ssh_username\": \"ubuntu\",\n      \"ssh_wait_timeout\": \"20m\",\n      \"vboxmanage\": [\n        [\"modifyvm\", \"{{ .Name }}\", \"--memory\", \"4096\"],\n        [\"modifyvm\", \"{{ .Name }}\", \"--cpus\", \"2\"]\n      ],\n      \"virtualbox_version_file\": \".vbox_version\",\n      \"vm_name\": \"{{user `role`}}\",\n      \"guest_additions_mode\": \"disable\",\n      \"format\": \"ova\",\n      \"output_directory\": \"output-{{build_name}}-{{user `role`}}\"\n    },\n    {\n      \"type\": \"amazon-ebs\",\n      \"access_key\": \"{{user `aws_access`}}\",\n      \"secret_key\": \"{{user `aws_secret`}}\",\n      \"source_ami\": \"{{user `ami`}}\",\n      \"instance_type\": \"c3.xlarge\",\n      \"region\": \"ap-northeast-1\",\n      \"ssh_username\": \"ubuntu\",\n\n      \"ami_name\": \"packer-ubuntu1604-ruby231-{{timestamp}}\",\n      \"ami_regions\": [\n        \"ap-northeast-1\"\n      ],\n      \"ami_description\" : \"iQON AMI {{user `role`}} Image\",\n      \"tags\": {\n        \"OS\": \"Ubuntu16.04\",\n        \"Ruby\": \"2.3.1\",\n        \"Role\": \"{{user `role`}}\",\n        \"OriginalAMI\": \"ami-5d38d93c\"\n      }\n    },\n    {\n      \"type\": \"googlecompute\",\n      \"account_file\": \"{{user `gce_secret`}}\",\n      \"project_id\": \"{{user `gce_project_id`}}\",\n      \"source_image\": \"{{user `gce_source_image`}}\",\n      \"zone\": \"asia-east1-a\",\n      \"machine_type\": \"n1-highcpu-4\",\n      \"ssh_username\": \"ubuntu\",\n      \"instance_name\": \"packer-{{timestamp}}\",\n      \"image_name\": \"packer-ubuntu1604-ruby231-{{timestamp}}\",\n      \"image_description\" : \"iQON AMI {{user `Role`}} Image\"\n\n    }\n  ],\n  \"provisioners\": [\n    {\n      \"type\": \"file\",\n      \"source\": \"{{pwd}}/../chef-repo\",\n      \"destination\": \"/tmp/packer-chef-client/\"\n    },\n    {\n      \"type\": \"shell\",\n      \"inline\": [\n        \"sudo apt-get update\",\n        \"sudo apt-get upgrade -y\",\n        \"sudo apt-get install -y language-pack-ja curl\",\n        \"sudo update-locale LANG=ja_JP.UTF-8 && true\",\n        \"sudo ln -sf /bin/bash /bin/sh\"\n      ]\n    },\n    {\n      \"type\": \"chef-client\",\n      \"server_url\": \"http://localhost:8889\",\n      \"config_template\": \"../chef-repo/client.rb\",\n      \"install_command\": \"curl -L https://www.chef.io/chef/install.sh | sudo bash  -s -- -v 12.8.1\",\n      \"execute_command\": \"sudo chef-client -z -c /tmp/packer-chef-client/client.rb -j /tmp/packer-chef-client/nodes/packer-{{user `role`}}.json\",\n      \"guest_os_type\": \"unix\",\n      \"skip_clean_node\": true,\n      \"skip_clean_client\": true\n    },\n    {\n      \"type\": \"shell\",\n      \"only\": [\"virtualbox-ovf\"],\n      \"inline\": [\n        \"sudo systemctl disable apt-daily.service\",\n        \"sudo systemctl disable apt-daily.timer\"\n      ]\n    }\n  ],\n  \"post-processors\": [\n    {\n      \"type\": \"shell-local\",\n      \"only\": [\"virtualbox-ovf\"],\n      \"inline\": [\n        \"rsync --checksum -av output-virtualbox-ovf-{{user `role`}}/ box-source/{{user `role`}}\",\n        \"aws s3 sync box-source s3://{{user `s3_bucket`}}/vagrant/box-source\"\n      ]\n    },\n    [\n      {\n        \"type\": \"vagrant\",\n        \"only\": [\"virtualbox-ovf\"],\n        \"keep_input_artifact\": false,\n        \"output\": \"packer-output/{{user `role`}}/{{user `role`}}.box\",\n        \"override\": {\n          \"virtualbox\": {\n            \"compression_level\": 0\n          }\n        }\n      },\n      {\n        \"type\": \"vagrant-s3\",\n        \"only\": [\"virtualbox-ovf\"],\n        \"region\": \"ap-northeast-1\",\n        \"bucket\":   \"{{user `s3_bucket`}}\",\n        \"manifest\": \"vagrant/json/{{user `role`}}.json\",\n        \"box_name\": \"{{user `role`}}\",\n        \"box_dir\":  \"vagrant/boxes\",\n        \"version\":  \"{{ user `version` }}\",\n        \"acl\": \"private\",\n        \"access_key_id\": \"{{user `aws_access`}}\",\n        \"secret_key\": \"{{user `aws_secret`}}\"\n      }\n    ]\n  ]\n}\n\n```\n\n\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u3084\u7d44\u7e54\u56fa\u6709\u306e\u90e8\u5206\u306b\u3064\u3044\u3066\u306f\u74b0\u5883\u5909\u6570\u3092\u8aad\u307f\u8fbc\u3080\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\u307e\u305f\u5b9f\u884c\u6642\u306b\u5f15\u6570\u3068\u3057\u3066\u6e21\u3059\u4e8b\u3082\u53ef\u80fd\u3067\u3059\u3002\n\n[User Variables in Templates - Packer by HashiCorp](https://www.packer.io/docs/templates/user-variables.html)\n\n# base.json\u306e\u4e2d\u8eab\n\npacker\u306finspect\u3068\u3044\u3046\u30b5\u30d6\u30b3\u30de\u30f3\u30c9\u3067\u305d\u306eJSON\u3067\u4f55\u304c\u5b9f\u884c\u3055\u308c\u308b\u306e\u304b\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002base.json\u3092\u898b\u3066\u307f\u307e\u3059\u3002\n\n```bash\n$ packer inspect base.json\nOptional variables and their defaults:\n\n  ami              = ami-5d38d93c\n  aws_access       = {{ env `AWS_ACCESS_KEY_ID`}}\n  aws_secret       = {{ env `AWS_SECRET_ACCESS_KEY`}}\n  gce_project_id   = {{ env `GCE_PROJECT_ID`}}\n  gce_secret       = {{ env `GCE_ACCOUNT_FILE`}}\n  gce_source_image = ubuntu-1604-xenial-v20160627\n  role             = base\n  s3_bucket        = {{ env `AWS_INFRA_S3_BUCKET`}}\n  version          = 1.0.2\n\nBuilders:\n\n  amazon-ebs    \n  googlecompute \n  virtualbox-ovf\n\nProvisioners:\n\n  file\n  shell\n  chef-client\n  shell\n```\n\n\u3053\u306ebase.json\u3067\u306f\u30019\u500b\u306e\u30e6\u30fc\u30b6\u5b9a\u7fa9\u5909\u6570\u3067\u52d5\u4f5c\u304c\u5236\u5fa1\u3055\u308c\u3066\u304a\u308a\u3001\n\n* ami (EBS-attached)\n* google compute engine image\n* virtualbox ovf (vagrant box\u7528\uff09\n\n\u304c\u4f5c\u3089\u308c\u3001\u305d\u308c\u305e\u308c\u30d7\u30ed\u30d3\u30b8\u30e7\u30f3\u306f\n\n1. file copy\n2. remote shell\u306e\u5b9f\u884c\n3. chef client\n4. remote shell\u306e\u5b9f\u884c\n\n\u3068\u3044\u3046\u9806\u756a\u3067\u884c\u308f\u308c\u308b\u3002\u3068\u3044\u3046\u3053\u3068\u304c\u5206\u304b\u308a\u307e\u3059\u3002\u3082\u3046\u5c11\u3057\u5206\u89e3\u3057\u3066\u898b\u3066\u3044\u304d\u307e\u3059\u3002\n\n## variables\nAWS\u306e\u30c8\u30fc\u30af\u30f3\u3084\u30aa\u30ea\u30b8\u30ca\u30ebAMI (\u3053\u3053\u3067\u306fUbuntu16.04) \u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\u8907\u6570\u56de\u767b\u5834\u3059\u308b\u8981\u7d20\u306fvariables\u3067\u5b9a\u7fa9\u3057\u3066\u304a\u3044\u305f\u65b9\u304c\u898b\u901a\u3057\u304c\u826f\u304f\u306a\u308a\u307e\u3059\u3002\n\n\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u3092\u30d5\u30a1\u30a4\u30eb\u306b\u542b\u3081\u306a\u304f\u3066\u6e08\u3080\u306e\u3067GitHub\u306b\u30b3\u30df\u30c3\u30c8\u3059\u308b\u3068\u304d\u3082\u5b89\u5168\u3067\u3059\u3002\n\n```json\n  \"variables\":{\n    \"aws_access\": \"{{ env `AWS_ACCESS_KEY_ID`}}\",\n    \"aws_secret\": \"{{ env `AWS_SECRET_ACCESS_KEY`}}\"\n  },\n```\n\n## builders\nVagrant box\u306e\u5143\u3068\u306a\u308bVirtualBox\u3068\u672c\u756a\u3067\u4f7f\u3046AMI/GCE Image\u3092\u4f5c\u3063\u3066\u3044\u307e\u3059\u3002\n\n```json\n  \"builders\":[\n    {\n      \"type\": \"virtualbox-ovf\",\n      \"source_path\": \"box-source/ubuntu-16.04.ova\",\n      ...\n    },\n    {\n      \"type\": \"amazon-ebs\",\n      ...\n    },\n    {\n      \"type\": \"googlecompute\",\n      ...\n  ]\n```\n\nAMI/GCE Image\u306b\u3064\u3044\u3066\u306f\u898b\u305f\u307e\u307e\u3067\u3059\u3002\u5404\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u304c\u516c\u5f0f\u3067\u63d0\u4f9b\u3057\u3066\u3044\u308bUbuntu16.04\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u4f7f\u3063\u3066\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u7acb\u3066\u3001\u5f8c\u8ff0\u306e\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u3092\u884c\u3044\u3001\u30de\u30b7\u30f3\u30a4\u30e1\u30fc\u30b8\u3092\u4fdd\u5b58\u3057\u3066\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u524a\u9664\u3057\u3066\u304f\u308c\u307e\u3059\u3002\n\n\u4e00\u65b9\u3001VirtualBox\u306b\u3064\u3044\u3066\u306f\u4e00\u624b\u9593\u304b\u3051\u3066\u3044\u307e\u3059\u3002`source_path`\u3067\u6307\u5b9a\u3057\u3066\u3044\u308bova\u306f[Canonical\u304c\u63d0\u4f9b\u3057\u3066\u3044\u308biso](http://releases.ubuntu.com/16.04/)\u3092\u4e00\u5ea6VirtualBox\u306b\u5165\u308c\u3066\u3001OVF2.0\u3067\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u3057\u305f\u3082\u306e\u3067\u3059\u3002\n\nUbuntu14.04\u3060\u3068[Canonical\u516c\u5f0f\u306ebox](https://cloud-images.ubuntu.com/vagrant/trusty/current/)\u3092tar\u3067\u89e3\u51cd\u3057\u305f\u3068\u304d\u306b\u51fa\u3066\u304f\u308bova\u3092packer\u3067\u8aad\u307f\u8fbc\u3081\u305f\u306e\u3067\u3059\u304c\u3001[Ubuntu16.04\u306ebox](https://cloud-images.ubuntu.com/xenial/current/)\u304b\u3089\u540c\u69d8\u306b\u4f5c\u6210\u3057\u305fova\u306f\u8aad\u307f\u8fbc\u307f\u30a8\u30e9\u30fc\u306b\u306a\u3063\u305f\u305f\u3081\u81ea\u5206\u3067\u4f5c\u6210\u3057\u307e\u3057\u305f\u3002\n\n\n## provisioners\n```json\n  \"provisioners\": [\n    {\n      \"type\": \"file\",\n      \"source\": \"{{pwd}}/../chef-repo\",\n      \"destination\": \"/tmp/packer-chef-client/\"\n    },\n    {\n      \"type\": \"shell\",\n      \"inline\": [\n        \"sudo apt-get update\",\n        \"sudo apt-get upgrade -y\",\n        \"sudo apt-get install -y language-pack-ja curl\",\n        \"sudo update-locale LANG=ja_JP.UTF-8 && true\",\n        \"sudo ln -sf /bin/bash /bin/sh\"\n      ]\n    },\n    {\n      \"type\": \"chef-client\",\n      \"config_template\": \"../chef-repo/client.rb\",\n      \"execute_command\": \"sudo chef-client -z -c /tmp/packer-chef-client/client.rb -j /tmp/packer-chef-client/nodes/packer-{{user `role`}}.json\",\n    },\n    {\n      \"type\": \"shell\",\n      \"only\": [\"virtualbox-ovf\"],\n      \"inline\": [\n        \"sudo systemctl disable apt-daily.service\",\n        \"sudo systemctl disable apt-daily.timer\"\n      ]\n    }\n  ],\n```\n\npacker\u3067\u4e00\u756a\u30cf\u30de\u3063\u305f\u306e\u304c\u3053\u306eprovisiners\u3067\u3059\u3002\u5927\u304d\u306a\u6d41\u308c\u306f\u3001\n\n1. chef\u3067\u4f7f\u3046\u30d5\u30a1\u30a4\u30eb\u3092\u30ed\u30fc\u30ab\u30eb\u304b\u3089VM\u306b\u30b3\u30d4\u30fc\n2. \u8a2d\u5b9a\u3092\u3057\u3066\u304a\u304b\u306a\u3044\u3068\u305d\u3082\u305d\u3082chef\u304c\u5b9f\u884c\u3067\u304d\u306a\u3044\u51e6\u7406\u3092remote shell\u3067\u5b9f\u884c\n3. chef client\u3092local mode\u3067\u5b9f\u884c\n4. `virtualbox-ovf`\u9650\u5b9a\u3067\u3001\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u8d77\u52d5\u6642\u306eapt-get update\u3092\u505c\u6b62\n\n\u3068\u3044\u3046\u3053\u3068\u3092\u3084\u3063\u3066\u3044\u307e\u3059\u30024\u756a\u76ee\u306f\u767a\u8868\u8cc7\u6599\u306e23\u30da\u30fc\u30b8\u76ee\u3067\u89e6\u308c\u3066\u3044\u308bapt-get\u304cchef\u3068\u885d\u7a81\u3059\u308b\u306e\u3092\u907f\u3051\u308b\u305f\u3081\u3067\u3059\u3002\n<script async class=\"speakerdeck-embed\" data-slide=\"23\" data-id=\"3f0048e00cb2495ab5920b139bd6547a\" data-ratio=\"1.77777777777778\" src=\"//speakerdeck.com/assets/embed.js\"></script>\n\n\u3061\u306a\u307f\u306b\u30013\u3067\u53c2\u7167\u3057\u3066\u3044\u308bclient.rb\u306e\u4e2d\u8eab\u306f\u3053\u3046\u306a\u3063\u3066\u3044\u307e\u3059\u30021\u3067\u30b3\u30d4\u30fc\u3057\u305fchef-repo\u306e\u69cb\u9020\u3092\u6307\u793a\u3057\u3066\u3044\u307e\u3059\u3002\n\n```ruby\n# coding: utf-8\nchef_repo_path \"/tmp/packer-chef-client\"\ncookbook_path [\n  \"/tmp/packer-chef-client/site-cookbooks\",\n  \"/tmp/packer-chef-client/cookbooks\"\n]\nlog_location \"/var/log/chef-client.log\"\nlog_level :info\n```\n\n## post-processors\n```json\n  \"post-processors\": [\n    {\n      \"type\": \"shell-local\",\n      \"only\": [\"virtualbox-ovf\"],\n      \"inline\": [\n        \"rsync --checksum -av output-virtualbox-ovf-{{user `role`}}/ box-source/{{user `role`}}\",\n        \"aws s3 sync box-source s3://{{user `s3_bucket`}}/vagrant/box-source\"\n      ]\n    },\n    [\n      {\n        \"type\": \"vagrant\",\n        \"only\": [\"virtualbox-ovf\"],\n        ...\n      },\n      {\n        \"type\": \"vagrant-s3\",\n        \"only\": [\"virtualbox-ovf\"],\n        \"manifest\": \"vagrant/json/{{user `role`}}.json\",\n        ...\n      }\n    ]\n  ]\n```\n\npost-processors\u306fbuilders\u3067\u4f5c\u6210\u3057\u305fVM\u30a4\u30e1\u30fc\u30b8\u306b\u5bfe\u3057\u3066\u5f8c\u51e6\u7406\u3092\u884c\u3046\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\u3053\u3053\u3067\u306f\u3001`virtualbox-ovf`\u306e\u7d50\u679c\u3092\u4f7f\u3063\u3066\u3001vagrant box\u3092\u4f5c\u6210\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u3067\u304d\u305f\u3082\u306e\u306fS3\u306b\u4fdd\u5b58\u3057\u3001\u30c1\u30fc\u30e0\u5168\u54e1\u3067\u5171\u901a\u306ebox\u3092\u4f7f\u3048\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\u3053\u306e\u7ba1\u7406\u65b9\u6cd5\u306b\u3064\u3044\u3066\u306f\u3053\u3061\u3089\u306e\u6295\u7a3f\u3092\u53c2\u8003\u306b\u3055\u305b\u3066\u3044\u305f\u3060\u304d\u307e\u3057\u305f\u3002\n\n[Packer \u3067\u958b\u767a\u74b0\u5883\u306e Vagrant Box \u3092\u81ea\u4f5c\u3057\u3066\u3001post-processors \u51e6\u7406\u3092\u901a\u3057\u3066 S3 \u306b\u4fdd\u5b58\u30fb\u30d0\u30fc\u30b8\u30e7\u30f3\u7ba1\u7406\u30fb\u30db\u30b9\u30c6\u30a3\u30f3\u30b0\u3059\u308b - Qiita](http://qiita.com/yoheimuta/items/fa4c7051940fee09c08e)\n\n# \u305d\u306e\u4ed6\u88dc\u8db3\n## \u30c8\u30fc\u30af\u30f3\u306e\u6a29\u9650\u306b\u3064\u3044\u3066\nAWS/GCE\u306e\u30c8\u30fc\u30af\u30f3\u306b\u5fc5\u8981\u306a\u6a29\u9650\u306b\u3064\u3044\u3066\u306f\u3001\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3067\u4e01\u5be7\u306b\u7d39\u4ecb\u3055\u308c\u3066\u3044\u307e\u3059\u306e\u3067\u4e0a\u3067\u306f\u8aac\u660e\u3092\u7701\u7565\u3057\u3066\u3044\u307e\u3059\u3002\n\n[https://www.packer.io/docs/builders/amazon.html:title]\n\n[https://www.packer.io/docs/builders/googlecompute.html:title]\n\n## \u30d3\u30eb\u30c9\u5bfe\u8c61\u306b\u3064\u3044\u3066\n```bash\npacker build base.json\n```\n\u3068\u5b9f\u884c\u3059\u308b\u30683\u3064\u306e\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u3067\u30d3\u30eb\u30c9\u304c\u59cb\u307e\u308a\u307e\u3059\u304c\u3001\u5bfe\u8c61\u3092\u7d5e\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n\n```bash\npacker build -only='amazon-ebs' base.json\n```\n\u3053\u306e\u5834\u5408\u3001AMI\u3060\u3051\u30d3\u30eb\u30c9\u304c\u59cb\u307e\u308a\u307e\u3059\u3002\n\n[https://www.packer.io/docs/command-line/build.html:title]\n\n## AWS\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30bf\u30a4\u30d7\u306b\u3064\u3044\u3066\npacker\u3068\u3044\u3046\u3088\u308a\u3082AWS\u306e\u8a71\u984c\u306b\u306a\u308a\u307e\u3059\u304c\u3001\u691c\u8a3c\u4e2dUbuntu16.04 + {m,c,r}3.large\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u5834\u5408\u306b\u30ab\u30fc\u30cd\u30eb\u30d1\u30cb\u30c3\u30af\u304c\u767a\u751f\u3057\u6b63\u5e38\u306b\u8d77\u52d5\u3057\u306a\u3044\u3068\u3044\u3046\u554f\u984c\u304c\u3042\u308a\u307e\u3057\u305f\u3002\n\n\u3053\u3061\u3089\u306eissue\u306b\u8fd1\u3044\u306e\u3067\u3059\u304c\u8a73\u7d30\u304c\u78ba\u8a8d\u3067\u304d\u305a\u3001large\u3092\u4f7f\u308f\u306a\u3044\u3068\u3044\u3046\u5bfe\u5fdc\u7b56\u3092\u53d6\u3063\u3066\u3044\u307e\u3059\u3002\n\n[https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1573231:title]\n\n\u3082\u3046\u76f4\u3063\u3066\u3044\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u304c\u304a\u6c17\u3092\u3064\u3051\u4e0b\u3055\u3044\u3002\n\n# \u73fe\u72b6\u306e\u5236\u7d04\n\u3053\u306ebase.json\u3092\u4f7f\u3046\u969b\u30012\u3064\u89e3\u6c7a\u3067\u304d\u3066\u306a\u3044\u554f\u984c\u304c\u3042\u308a\u307e\u3059\u3002\n\n## \u4e00\u3064\u76ee\uff1a`virtualbox-ovf`\u306e\u4e00\u6642\u30d5\u30a1\u30a4\u30eb\npacker\u306f\u4e00\u6642\u30d5\u30a1\u30a4\u30eb\u304c\u6b8b\u3063\u3066\u3044\u308b\u3068\u5b9f\u884c\u6642\u306b\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3059\u3002\n\u57fa\u672c\u52d5\u4f5c\u3068\u3057\u3066\u306f\u6d88\u3048\u308b\u306f\u305a\u306a\u306e\u3067\u3059\u304c\u3001post-provisioners\u306e\u66f8\u304d\u65b9\u304c\u60aa\u3044\u306e\u304b\u3001\u3042\u308b\u6642\u304b\u3089\u6d88\u3048\u306a\u304f\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u3002\n\n```bash\n# 2\u56de\u76ee\u306e\u5b9f\u884c\n$ packer build base.json\nvirtualbox-ovf output will be in this color.\n\nBuild 'virtualbox-ovf' errored: Output directory exists: output-virtualbox-ovf-base\n\nUse the force flag to delete it prior to building.\n```\n\n\u624b\u52d5\u3067\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u6d88\u3059\u304b\u3001`-force`\u3092\u4ed8\u3051\u3066build\u3092\u5b9f\u884c\u3057\u3066\u4e0b\u3055\u3044\u3002\n\n```bash\npacker build -force base.json\n```\n\n## \u4e8c\u3064\u76ee\uff1a\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u624b\u52d5\u5909\u66f4\nvagrant box\u306e\u7ba1\u7406\u3067manifest.json\u3092\u5185\u90e8\u3067\u751f\u6210\u3057\u3066\u304a\u308a\u3001\u65e2\u306b\u5b58\u5728\u3059\u308b\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u5834\u5408\u306f\u6700\u5f8c\u306e`vagrant-s3`\u304c\u5931\u6557\u3057\u307e\u3059\u3002\n\n```json\n  \"variables\":{\n    \"version\":  \"1.0.2\",\n```\n\nvagrant\u306e\u4ed5\u69d8\u4e0a\u3001`x.x.x`\u306e\u5f62\u5f0f\u306b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u3001\u30bf\u30a4\u30e0\u30b9\u30bf\u30f3\u30d7\u3068\u3044\u3046\u308f\u3051\u306b\u3082\u3044\u304d\u307e\u305b\u3093\u3002\u4eba\u9593\u30a4\u30f3\u30af\u30ea\u30e1\u30f3\u30c8\u306a\u306e\u3067\u306a\u3093\u3068\u304b\u3057\u305f\u3044\u3068\u601d\u3063\u3066\u3044\u307e\u3059\u3002\n\n## \u4eca\u5f8c\u3084\u308a\u305f\u3044\u3053\u3068\n\u307e\u3060\u307e\u3060\u3053\u306a\u308c\u3066\u304a\u3089\u305a\u3001\u65e5\u3005json\u3092\u66f4\u65b0\u3057\u3066\u3044\u307e\u3059\u3002\n\u4f8b\u3048\u3070\u3001EC2\u306b\u95a2\u3057\u3066\u306f\u30b9\u30dd\u30c3\u30c8\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u4f7f\u3046\u3088\u3046\u4fee\u6b63\u3092\u3057\u3066\u3044\u308b\u3068\u3053\u308d\u3067\u3059\u3002\n\u30cf\u30a4\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u624b\u9803\u306a\u5024\u6bb5\u3067\u4f7f\u3048\u308b\u305f\u3081\u3001\u3088\u308a\u5feb\u9069\u306a\u30a4\u30e1\u30fc\u30b8\u66f4\u65b0\u4f5c\u696d\u304c\u3067\u304d\u308b\u3068\u601d\u3063\u3066\u3044\u307e\u3059\u3002\n\n# \u307e\u3068\u3081\n\u304b\u306a\u308a\u99c6\u3051\u8db3\u3067\u306f\u3042\u308a\u307e\u3057\u305f\u304c\u3001\u5b9f\u969b\u306b\u904b\u7528\u3057\u3066\u3044\u308bpacker\u7528\u306eJSON\u30d5\u30a1\u30a4\u30eb\u306b\u3064\u3044\u3066\u3054\u7d39\u4ecb\u3044\u305f\u3057\u307e\u3057\u305f\u3002\npacker\u306f\u7c21\u5358\u306b\u59cb\u3081\u3089\u308c\u307e\u3059\u304c\u3001\u3061\u3087\u3063\u3068\u51dd\u3063\u305f\u3053\u3068\u3092\u3057\u3088\u3046\u3068\u601d\u3046\u3068\u3084\u306f\u308a\u30aa\u30d7\u30b7\u30e7\u30f3\u306e\u8abf\u6574\u304c\u907f\u3051\u3089\u308c\u307e\u305b\u3093\u3002\n\n\u3053\u306e\u8a18\u4e8b\u304c\u4f55\u304b\u3057\u3089\u53c2\u8003\u306b\u306a\u308c\u3070\u5e78\u3044\u3067\u3059\u3002\n\n\u9006\u306b\u300c\u304a\u524d\u306epacker\u8853\u306f\u9593\u9055\u3063\u3066\u3044\u308b\u300d\u3068\u3044\u3046\u90e8\u5206\u304c\u3042\u308a\u307e\u3057\u305f\u3089\u3001\u30b3\u30e1\u30f3\u30c8\u3067\u3054\u6307\u6458\u4e0b\u3055\u3044\u3002\u5c0f\u8e8d\u308a\u3057\u3066\u559c\u3073\u307e\u3059\u3002\n", "tags": ["packer", "AWS", "gce", "vagrant"]}