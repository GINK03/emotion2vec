{"tags": ["Vault", "consul", "CentOS", "haproxy"], "context": " \u3053\u306e\u8a18\u4e8b\u306f\u6700\u7d42\u66f4\u65b0\u65e5\u304b\u30891\u5e74\u4ee5\u4e0a\u304c\u7d4c\u904e\u3057\u3066\u3044\u307e\u3059\u3002\n\nVault\u3063\u3066\u4f55\uff1f\nVault\u306fHashicorp\u304c\u767a\u8868\u3057\u305f\u6a5f\u5bc6\u60c5\u5831\u7ba1\u7406\u30c4\u30fc\u30eb\u3067\u3042\u308b\u3002\n\u8a73\u7d30\u306f\u3044\u304f\u3089\u304b\u65e5\u672c\u8a9e\u60c5\u5831\u304c\u3042\u308b\u306e\u3067\u305d\u3061\u3089\u3092\u53c2\u7167\u306e\u3053\u3068\u3002\n\nhttp://pocketstudio.jp/log3/2015/04/29/vault/\nhttp://kiririmode.hatenablog.jp/entry/20150429/1430279218\n\n\n\u4eca\u56de\u3084\u308b\u3053\u3068\nVault\u306fConsul\u3092storage backend\u306b\u3059\u308b\u3053\u3068\u306b\u3088\u308aHA\u69cb\u6210\u3092\u53d6\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3001\u3068\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u66f8\u3044\u3066\u3042\u3063\u305f\u306e\u3067\u8a66\u3057\u3066\u307f\u308b\u3053\u3068\u306b\u3057\u305f\u3002\n\u4eca\u56de\u3001Vault\u30b5\u30fc\u30d0\u3068\u306a\u308b\u30b3\u30f3\u30d4\u30e5\u30fc\u30bf\u306fConsul\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3067\u3082\u3042\u308b\u3053\u3068\u3068\u3059\u308b\u3002\n\u3053\u308c\u306f\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3067Consul\u306e\u30a2\u30c9\u30ec\u30b9\u3092\u6307\u5b9a\u3059\u308b\u7b87\u6240\u3060\u3051\u306b\u5f71\u97ff\u3059\u308b\u3002\nVault\u30b5\u30fc\u30d0\u306f2\u53f0\u7acb\u3066\u308b\u3053\u3068\u306b\u3059\u308b\u3002\n10.0.2.167(hostname: cc6)\u306fCentOS 6\u300110.0.2.170(hostname: cc7)\u306fCentOS 7\u3067\u3042\u308b\u3002\n\u307e\u305f\u3053\u3061\u3089\u306e\u74b0\u5883\u3067\u4eca\u7acb\u3066\u3089\u308c\u308b\u53f0\u6570\u306e\u90fd\u5408\u3067\u30b5\u30fc\u30d0\u306b\u306a\u3063\u305f\u30b3\u30f3\u30d4\u30e5\u30fc\u30bf\u306b\u306f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3082\u517c\u306d\u3066\u3082\u3089\u3046\u3053\u3068\u306b\u3057\u305f\u304c\u3001\u5225\u3005\u306b\u3057\u3066\u3082\u554f\u984c\u306a\u3044\uff08\u306f\u305a\uff09\u3002\nstorage backend\u306f\u3053\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u66f8\u304b\u308c\u3066\u3044\u308b\u7528\u8a9e\u3060\u304c\u3001\u540c\u3058\u3082\u306e\u3092\u6307\u3059\u8a00\u8449\u3068\u3057\u3066physical backend\u3068\u3044\u3046\u8868\u73fe\u3082\u898b\u305f\u3053\u3068\u304c\u3042\u308b\u3002\n\u307e\u305fConsul\u306fstorage backend\u4ee5\u5916\u306b\u3082secret backend\u306b\u3082\u306a\u308b\u3002\nsecret backend\u3068\u3059\u308b\u65b9\u6cd5\u306f\u3044\u3044\u52a0\u6e1b\u9577\u304f\u306a\u308b\u306e\u3067\u5225\u8a18\u4e8b\u306b\u3057\u305f\u3002\n\u3053\u306e\u8a18\u4e8b\u306fVault\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u306f0.1.0\u3001Consul\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u306f0.5.0\u306e\u6642\u70b9\u3067\u66f8\u304d\u59cb\u3081\u305f\u304c\u3001Vault 0.1.2\u306b\u5bfe\u5fdc\u3059\u308b\u3088\u3046\u66f8\u304d\u76f4\u3057\u3066\u3044\u308b\u3002\n\nVault\u30b5\u30fc\u30d0\u3092\u8d77\u52d5\u3059\u308b\nVault\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3002\n# wget https://dl.bintray.com/mitchellh/vault/vault_0.1.2_linux_amd64.zip\n# unzip vault_0.1.2_linux_amd64.zip -d /usr/local/sbin\n\nVault\u304c\u4f7f\u30468200/tcp\u306e\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u3092\u958b\u3051\u3066\u304a\u304f\u3002\nCentOS 6\u3067iptables\u3092\u4f7f\u3063\u3066\u3044\u308b\u5834\u5408\u3060\u3068\u3001\n# iptables -I INPUT 5 -m state --state NEW -p tcp --dport 8200 -j ACCEPT\n# service iptables save\n\nCentOS 7\u3067firewalld\u3092\u4f7f\u3063\u3066\u3044\u308b\u5834\u5408\u3060\u3068\u3001\n# firewall-cmd --add-port=8200/tcp\n# firewall-cmd --add-port=8200/tcp --permanent\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u7f6e\u304f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u308a\u3001\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb /etc/vault.d/server.hcl \u3092\u4f5c\u6210\u3059\u308b\u3002\n\u6b21\u306fHTTP\u63a5\u7d9a\u3068\u3059\u308b\u5834\u5408\u3067\u3042\u308b\u3002HTTPS\u63a5\u7d9a\u3068\u3059\u308b\u5834\u5408\u306b\u3064\u3044\u3066\u306f\u5f8c\u8ff0\u3059\u308b\u3002\n# mkdir /etc/vault.d\n\n\n/etc/vault.d/server.hcl\nbackend \"consul\" {\n  advertise_addr = \"http://10.0.2.167:8200\"\n}\n\nlistener \"tcp\" {\n  address = \"0.0.0.0:8200\"\n  tls_disable = 1\n}\n\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u4e2d\u8eab\u3092\u8efd\u304f\u8aac\u660e\u3059\u308b\u3068\u3001backend \"consul\" {}\u306e\u4e2d\u306b\u3064\u3044\u3066\u306f\u3001\n\nadvertise_addr\u306f\u4ed6\u306eVault\u304b\u3089\u30a2\u30af\u30bb\u30b9\u3059\u308b\u969b\u306e\u81ea\u5206\u306e\u30a2\u30c9\u30ec\u30b9\u3002\nConsul\u3092\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306b\u3059\u308b\u5834\u5408\uff08\u3064\u307e\u308a\u3001HA\u69cb\u6210\u306b\u3059\u308b\u5834\u5408\uff09\u306b\u306f\u5fc5\u9808\u3002v0.1.0\u3067\u306f\u3053\u306e\u9805\u76ee\u306b\u306f\u30db\u30b9\u30c8\u540d\u304bIP\u30a2\u30c9\u30ec\u30b9\u3060\u3051\u3092\u8a18\u8ff0\u3057\u3066\u3044\u305f\u304c\u3001v0.1.1\u304b\u3089Vault\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304c\u81ea\u52d5\u3067\u63a5\u7d9a\u5148\u3092\u5207\u308a\u66ff\u3048\u308b\u969b\u306e\u30a2\u30c9\u30ec\u30b9\u3068\u3057\u3066\u53c2\u7167\u3055\u308c\u308b\u305f\u3081\u3001http://10.0.2.167:8200\u306e\u3088\u3046\u306a\u8a18\u8ff0\u3092\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\naddress\u3067Consul\u306e\u30a2\u30c9\u30ec\u30b9\u3068\u30dd\u30fc\u30c8\u3092\u6307\u5b9a\u3067\u304d\u308b\u306e\u3060\u304c\u3001\u7701\u7565\u6642\u306flocalhost:8500\u3067\u3042\u308b\u3002\n\u3064\u307e\u308a\u81ea\u5206\u304cConsul\u306e\u30b5\u30fc\u30d0\u304b\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u306a\u3063\u3066\u304a\u308a\u3001\u308f\u3056\u308f\u3056\u30dd\u30fc\u30c8\u756a\u53f7\u3092\u5909\u3048\u3066\u3044\u306a\u3051\u308c\u3070\u7701\u7565\u3067\u304d\u308b\u3002\n\nlistener \"tcp\" {}\u306e\u4e2d\u306b\u3064\u3044\u3066\u306f\u3001\n\naddress\u306fVault\u306e\u5f85\u3061\u53d7\u3051\u30a2\u30c9\u30ec\u30b9\u3068\u30dd\u30fc\u30c8\u3002\ntls_disable\u306f\u5024\u304c\u7a7a\u3067\u306a\u3044\u5834\u5408\u3001HTTP\u63a5\u7d9a\u306b\u3059\u308b\u3002\n\n\u3053\u306e\u524dConsul\u306eCentOS 6\u3067\u52d5\u4f5c\u78ba\u8a8d\u3057\u305finit\u30b9\u30af\u30ea\u30d7\u30c8\u3068CentOS 7\u3067\u52d5\u4f5c\u78ba\u8a8d\u3057\u305fsystemd\u30e6\u30cb\u30c3\u30c8\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u305f\u306e\u3067\u3001\u4f3c\u305f\u3088\u3046\u306a\u611f\u3058\u3067Vault\u306e\u3082\u306e\u3082\u4f5c\u3063\u3066\u307f\u305f\u3002\nCentOS 6\u7528\u306einit\u30b9\u30af\u30ea\u30d7\u30c8\u306f /etc/init.d/vault \u306b\u914d\u7f6e\u3057\u3066\u3001\n# chmod 755 /etc/init.d/vault\n# chkconfig --add vault\n# service vault start\n\nCentOS 7\u7528\u306esystemd\u30e6\u30cb\u30c3\u30c8\u30d5\u30a1\u30a4\u30eb\u306f /etc/systemd/system/vault.service \u306b\u914d\u7f6e\u3057\u3066\u3001\n# systemctl daemon-reload\n# systemctl enable vault.service\n# systemctl start vault.service\n\n\u3053\u308c\u3067Vault\u30b5\u30fc\u30d0\u304c\u8d77\u52d5\u3057\u305f\u3002\n\u305f\u3060\u3057\u5f8c\u8ff0\u3059\u308b\u304c\u30012\u53f0\u76ee\u4ee5\u964d\u3092\u8d77\u52d5\u3059\u308b\u306e\u306fvault init\u3092\u5b9f\u884c\u3057\u305f\u5f8c\u3067\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u3002\n\nHTTPS\u63a5\u7d9a\u306b\u3059\u308b\u5834\u5408\nVault 0.1.0\u3060\u3068HTTPS\u63a5\u7d9a\u304c\u4e0a\u624b\u304f\u884c\u304b\u306a\u304b\u3063\u305f\u304c\u30010.1.1\u3067\u306f\u307b\u307c\u554f\u984c\u306a\u304f\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u3002\n\uff08CentOS 6\u3067vault read\u304c\u4e0a\u624b\u304f\u884c\u304b\u306a\u3044\u3053\u3068\u304c\u3042\u3063\u305f\u3002\u4f55\u304c\u30c8\u30ea\u30ac\u30fc\u306b\u306a\u3063\u3066\u89e3\u6c7a\u3057\u305f\u306e\u304b\u306f\u5b9f\u969b\u306b\u306f\u308f\u304b\u3089\u306a\u3044\u304c\u3001\u79c1\u306e\u74b0\u5883\u3067\u306fOS\u518d\u8d77\u52d5\u5f8c\u306b\u554f\u984c\u304c\u89e3\u6d88\u3057\u305f\uff09\n\u306a\u304aHTTPS\u63a5\u7d9a\u306b\u3059\u308b\u3068\u3001\u30ed\u30b0\u306bTLS handshake error\u306a\u3093\u3066\u30a8\u30e9\u30fc\u304c5\u79d2\u3054\u3068\u306b(\u30b5\u30fc\u30d0\u53f0\u6570+1)\u3060\u3051\u51fa\u529b\u3055\u308c\u308b\u306e\u306f\u6c17\u306b\u306a\u308b\u3002\u5b9f\u30d5\u30a1\u30a4\u30eb\u306b\u66f8\u304d\u51fa\u3057\u3066\u3044\u308b\u306a\u3089\u30ed\u30b0\u30ed\u30fc\u30c6\u30fc\u30c8\u304c\u5fc5\u8981\u306b\u306a\u308b\u7a0b\u5ea6\u306b\u306f\u306a\u308b\u3002\nHTTPS\u63a5\u7d9a\u306b\u3059\u308b\u5834\u5408\u3001\u8ffd\u52a0\u4f5c\u696d\u304c\u3044\u304f\u3089\u304b\u5fc5\u8981\u306b\u306a\u308b\u3002\nVault\u30b5\u30fc\u30d0\u3001Vault\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3068\u3082\u306bConsul\u30b5\u30fc\u30d0\u304b\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3067\u3042\u308b\u3082\u306e\u3068\u3059\u308b\u3002\n\u307e\u305a\u8a3c\u660e\u66f8\u306e\u30b3\u30e2\u30f3\u30cd\u30fc\u30e0\u306b\u30db\u30b9\u30c8\u540d\u304c\u4f7f\u3048\u308b\u3088\u3046\u3001Vault\u30b5\u30fc\u30d0\u3001Vault\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304cConsul\u304c\u63d0\u4f9b\u3059\u308bDNS\u30b5\u30fc\u30d0\u306b\u554f\u3044\u5408\u308f\u305b\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u3002\nConsul\u306f8600/udp\u3067DNS\u30b5\u30fc\u30d0\u3092\u63d0\u4f9b\u3057\u3066\u3044\u308b\u306e\u3067\u3001localhost\u306e53/udp\u3078\u306e\u63a5\u7d9a\u30928600/udp\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3059\u308b\u3088\u3046\u306b\u3059\u308b\u3002\nCentOS 6\u3060\u3068\u6b21\u306e\u901a\u308a\u3002\n# iptables -t nat -A OUTPUT -p udp -o lo --dport 53 -j REDIRECT --to-ports 8600\n# service iptables save\n\nCentOS 7\u3060\u3068\u6b21\u306e\u901a\u308a\u3002\n# firewall-cmd --direct --add-rule ipv4 nat OUTPUT 1 -p udp -o lo --dport 53 -j REDIRECT --to-ports 8600\n# firewall-cmd --permanent --direct --add-rule ipv4 nat OUTPUT 1 -p udp -o lo --dport 53 -j REDIRECT --to-ports 8600\n\nCentOS 6\u3060\u3068 /etc/sysconfig/network-scripts/ifcfg-eth0 \u306b\u6b21\u3092\u8ffd\u52a0\u3057\u3066\u304b\u3089 /etc/resolv.conf \u306e\u65e2\u5b58\u306enameserver\u306e\u4e0a\u306bnameserver 127.0.0.1\u3092\u8ffd\u52a0\u3059\u308b\u3002\nDNS1=127.0.0.1\nDNS2=<\u65e2\u5b58\u306eDNS\u30b5\u30fc\u30d0>\nPEERDNS=no\n\nCentOS 7\u3060\u3068 /etc/resolv.conf \u3092\u76f4\u63a5\u89e6\u3089\u305a\u306b\u6b21\u3092\u5b9f\u884c\u3059\u308b\u306e\u304c\u826f\u3044\u304b\u306a\u3002\n# nmcli connection modify enp0s3 ipv4.ignore-auto-dns yes ipv4.dns \"127.0.0.1 <\u65e2\u5b58\u306eDNS\u30b5\u30fc\u30d0>\"\n# systemctl restart NetworkManager.service\n\nifcfg-eth0(CentOS 6)\u3084enp0s3(CentOS 7)\u306f\u5404\u81ea\u306e\u74b0\u5883\u306b\u5408\u308f\u305b\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\u8a3c\u660e\u66f8\u306a\u3093\u3066\u306a\u3044\u3001\u3068\u3044\u3046\u5834\u5408\u306f\u81ea\u5df1\u7f72\u540d\u8a3c\u660e\u66f8\u3092\u4f5c\u308b\u3002\n\u79c1\u304c\u81ea\u5df1\u7f72\u540d\u8a3c\u660e\u66f8\u3092\u4f5c\u308b\u5834\u5408\u3001\u6b21\u306e\u3088\u3046\u306a\u624b\u9806\u3067\u4f5c\u3063\u3066\u3044\u308b\u3002\n# mkdir /etc/pki/tls/self\n# cd /etc/pki/tls/self\n# cp /etc/pki/tls/openssl.cnf ./openssl.node.cnf\n\n\n/etc/pki/tls/self/openssl.node.cnf\n# \u30a8\u30c7\u30a3\u30bf\u306a\u3069\u3067\u4ee5\u4e0b\u3092\u4fee\u6b63\u3059\u308b\n\n[ CA_default ]\n# \u8a3c\u660e\u66f8\u306e\u5bff\u547d\u3092365\u65e5\u304b\u30893650\u65e5\u306b\u5909\u66f4\ndefault_days = 3650\n\n[ req ]\n# attributes\u884c\u3092\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3057\u3066prompt = no\u3092\u8ffd\u52a0\n#attributes = req_attributes\nprompt = no\n\n[ req_distinguished_name ]\n# req_distinguished_name\u306e\u4e2d\u306f\u5168\u90e8\u6d88\u3057\u3066\u304b\u3089\u4ee5\u4e0b\u3092\u8ffd\u52a0\nC = JP\nST = Tokyo\nL = Tokyo\nO = consul\nOU = admin\nCN = *.node.consul\n\n\n# sha512sum /proc/vmstat | awk '{ print $1 }' > sha512.dat\n# openssl genrsa -rand sha512.dat -out node.key -passout pass:$(cat sha512.dat) -aes256 2048\n# openssl rsa -in node.key -passin pass:$(cat sha512.dat) -out node.key\n# openssl req -new -config openssl.node.cnf -key node.key -out node.csr\n# openssl x509 -in node.csr -days 3650 -req -signkey node.key -out node.crt\n# rm -f sha512.dat node.csr\n\n\u4f5c\u6210\u3055\u308c\u305f\u79d8\u5bc6\u9375node.key\u3068\u30b5\u30fc\u30d0\u8a3c\u660e\u66f8node.crt\u306f\u3059\u3079\u3066\u306eVault\u30b5\u30fc\u30d0\u306b\u914d\u7f6e\u3059\u308b\u3002\nnode.crt\u306f\u3059\u3079\u3066\u306eVault\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u3082\u914d\u7f6e\u3059\u308b\u3002\nVault\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb /etc/vault.d/server.hcl \u306f\u6b21\u306e\u3088\u3046\u306b\u306a\u308b\u3002\n\n/etc/vault.d/server.hcl\nbackend \"consul\" {\n  advertise_addr = \"https://cc6.node.consul:8200\"\n}\n\nlistener \"tcp\" {\n  address = \"0.0.0.0:8200\"\n  tls_cert_file = \"/etc/pki/tls/self/node.crt\"\n  tls_key_file = \"/etc/pki/tls/self/node.key\"\n}\n\n\nConsul\u3092DNS\u30b5\u30fc\u30d0\u3068\u3057\u3066\u53c2\u7167\u3059\u308b\u3053\u3068\u306b\u3088\u308a\u3001<\u30db\u30b9\u30c8\u540d>.node.consul\u3067\u81ea\u5206\u306b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u3067\u3001advertise_addr\u306b\u306f\u3053\u306e\u540d\u524d\u3092\u4f7f\u3063\u3066\u8a2d\u5b9a\u3059\u308b\u3002\u8a3c\u660e\u66f8\u306e\u30b3\u30e2\u30f3\u30cd\u30fc\u30e0(CN)\u306b*.node.consul\u3092\u8a2d\u5b9a\u3057\u305f\u306e\u306f\u3053\u306e\u305f\u3081\u3067\u3042\u308b\u3002\ntls_cert_file\u306b\u306f\u30b5\u30fc\u30d0\u8a3c\u660e\u66f8\u3078\u306e\u30d1\u30b9\u3001tls_key_file\u306b\u306f\u79d8\u5bc6\u9375\u3078\u306e\u30d1\u30b9\u3092\u8a2d\u5b9a\u3059\u308b\u3002\n\u4ed6\u306e\u4f5c\u696d\u306fHTTP\u63a5\u7d9a\u306e\u5834\u5408\u3068\u5909\u308f\u3089\u306a\u3044\u3002\n\nVault\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u306e\u64cd\u4f5c\n\u4eca\u56deVault\u306f\u30b5\u30fc\u30d0\u3068\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3092\u517c\u306d\u3066\u3044\u308b\u306e\u3067\u3001HTTP\u63a5\u7d9a\u306e\u5834\u5408\u306f2\u53f0\u3068\u3082\u74b0\u5883\u5909\u6570VAULT_ADDR\u306bhttp\u3067\u30eb\u30fc\u30d7\u30d0\u30c3\u30af\u30a2\u30c9\u30ec\u30b9\u3092\u6307\u5b9a\u3057\u3066\u304a\u304f\u3002\n\u30b5\u30fc\u30d0\u3068\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304c\u9055\u3046\u30b3\u30f3\u30d4\u30e5\u30fc\u30bf\u306a\u3089\u3070Vault\u30b5\u30fc\u30d0\u306e\u30a2\u30c9\u30ec\u30b9\u3092\u6307\u5b9a\u3059\u308c\u3070\u826f\u3044\u3002\n# export VAULT_ADDR='http://127.0.0.1:8200'\n\nHTTPS\u63a5\u7d9a\u306e\u5834\u5408\u306fhttps://<\u81ea\u5206\u306e\u30de\u30b7\u30f3\u540d>.node.consul:8200\u3092\u6307\u5b9a\u3059\u308b\u3002\n# export VAULT_ADDR='https://cc6.node.consul:8200'\n\n\u307e\u305fHTTPS\u63a5\u7d9a\u306e\u5834\u5408\u3001\u4ee5\u964d\u306evault\u30b3\u30de\u30f3\u30c9\u3067\u306f\u30b5\u30fc\u30d0\u8a3c\u660e\u66f8\u3078\u306e\u30d1\u30b9\u3092\u6307\u5b9a\u3059\u308b\u30aa\u30d7\u30b7\u30e7\u30f3-ca-cert /etc/pki/tls/self/node.crt\u3092\u6307\u5b9a\u3059\u308b\uff08\u4f8b\uff1avault read -ca-cert /etc/pki/tls/self/node.crt secret/test\uff09\u3002\n\u3042\u308b\u3044\u306f\u4f5c\u6210\u3057\u305f\u30b5\u30fc\u30d0\u8a3c\u660e\u66f8\u3092\u4fe1\u983c\u3059\u308b\u8a3c\u660e\u66f8\u306b\u52a0\u3048\u308b\u3002\n# update-ca-trust enable # CentOS 7\u3067\u306f\u521d\u671f\u72b6\u614b\u3067enable\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u3067\u5b9f\u884c\u4e0d\u8981\n# ln -s /etc/pki/tls/self/node.crt /etc/pki/ca-trust/source/anchors/\n# update-ca-trust extract\n\n\u307e\u305a\u306fVault\u306e\u521d\u671f\u5316\u3002\n\u3053\u308c\u3092\u5b9f\u884c\u3059\u308b\u30685\u3064\u306eKey\u3001\u304a\u3088\u3073Initial Root Token\u304c\u8868\u793a\u3055\u308c\u308b\u3002\n\u3053\u308c\u3089\u3092\u306a\u304f\u3059\u3068\u30a2\u30af\u30bb\u30b9\u3067\u304d\u306a\u304f\u306a\u308b\u306e\u3067\u6ce8\u610f\u3002\n\u767a\u884c\u3055\u308c\u308bKey\u306e\u6570\u306f-key-shares\u30aa\u30d7\u30b7\u30e7\u30f3\u3067\u5909\u66f4\u3067\u304d\u308b\u3002\n\u3053\u306e\u4f5c\u696d\u306fVault\u306eHA\u69cb\u6210\u30af\u30e9\u30b9\u30bf\u306e\u4e2d\u30671\u56de\u3060\u3051\u884c\u3048\u3070\u826f\u3044\u3002\n# vault init\n\n\u306a\u304a\u3001Vault\u3092HA\u69cb\u6210\u306b\u3059\u308b\u5834\u5408\u306f\u300c1\u53f0\u76ee\u306e\u8d77\u52d5\u2192vault init\u21922\u53f0\u76ee\u4ee5\u964d\u306e\u8d77\u52d5\u300d\u306e\u9806\u3067\u884c\u3046\u3002\n\u5171\u6709\u30c7\u30fc\u30bf\u306fvault init\u306e\u969b\u306b\u4f5c\u6210\u3055\u308c\u308b\u306e\u3067\u3001\u305d\u306e\u524d\u306b2\u53f0\u76ee\u4ee5\u964d\u3092\u8d77\u52d5\u3057\u3066\u3082HA\u69cb\u6210\u306b\u306a\u3089\u306a\u3044\u304b\u3089\u3067\u3042\u308b\u3002\nVault\u30b5\u30fc\u30d0\u3092\u53d7\u3051\u4ed8\u3051\u53ef\u80fd\u306a\u72b6\u614b\u306b\u3059\u308b\u306b\u306funseal\u3068\u3044\u3046\u4f5c\u696d\u3092\u884c\u3046\u3002\n\u6b21\u306e\u901a\u308a3\u56de\u5b9f\u884c\u3057\u3001vault init\u3067\u5f97\u305fKey\u306e\u3046\u30613\u3064\u3092\u5165\u529b\u3059\u308b\u3068\u53d7\u3051\u4ed8\u3051\u53ef\u80fd\u72b6\u614b\u306b\u306a\u308b\u3002\n\u3053\u306e\u56de\u6570\u306fvault init\u6642\u306e-key-threshold\u30aa\u30d7\u30b7\u30e7\u30f3\u3067\u5909\u66f4\u3067\u304d\u308b\u3002\n\u3053\u306e\u4f5c\u696d\u306fVault\u30b5\u30fc\u30d01\u53f0\u3054\u3068\u306b\u5b9f\u884c\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u3001\u307e\u305fVault\u30b5\u30fc\u30d0\u304c\u4e00\u65e6\u505c\u6b62\u3057\u3066\u518d\u8d77\u52d5\u3057\u305f\u5834\u5408\u306b\u3082\u5b9f\u884c\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n# vault unseal\n# vault unseal\n# vault unseal\n\nvault unseal\u306f\u5f15\u6570\u306a\u3057\u3067\u5b9f\u884c\u3059\u308b\u3068Key\u3092\u5bfe\u8a71\u5f0f\u3067\u5165\u529b\u3059\u308b\u3053\u3068\u306b\u306a\u308b\u3002\nKey\u3092\u5f15\u6570\u306b\u3057\u3066\u5b9f\u884c\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u308b\u306e\u3067\u30b9\u30af\u30ea\u30d7\u30c8\u5185\u3067\u5b9f\u884c\u3059\u308b\u5834\u5408\u306a\u3069\u306f\u305d\u3046\u3059\u308b\u3068\u826f\u3044\u3002\nVault\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306e\u8a8d\u8a3c\u306fvault init\u3067\u5f97\u305fInitial Root Token\u3092\u4f7f\u3063\u3066\u884c\u3046\u3002\n\u3053\u308c\u306f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3054\u3068\u306b\u884c\u3046\u3002\n\u671f\u9650\u3068\u304b\u3042\u308a\u305d\u3046\u3060\u3051\u3069\u307e\u3060\u8abf\u3079\u3066\u3044\u306a\u3044\u3002\n# vault auth 8c535adc-f7c7-32d7-09ae-14c32da1e6b6\n\nvault auth\u306e\u5b9f\u884c\u6642\u306b\u30db\u30fc\u30e0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e .vault-token \u3068\u3044\u3046\u30d5\u30a1\u30a4\u30eb\u306bToken\u304c\u66f8\u304d\u8fbc\u307e\u308c\u3066\u3001\u4ee5\u964d\u306evault\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5b9f\u884c\u6642\u306b\u3053\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u53c2\u7167\u3059\u308b\u3053\u3068\u3067\u6bce\u56de\u306eToken\u306e\u5165\u529b\u3092\u4e0d\u8981\u306b\u3059\u308b\u4ed5\u7d44\u307f\u306e\u3088\u3046\u3060\u3002\n\uff08\u203b \u3053\u3053\u304b\u3089v0.1.0\u306e\u6642\u306e\u8a18\u8ff0\u3067\u3042\u308b\u3002v0.1.1\u3067\u306f\u63a5\u7d9a\u5148\u306evault\u30b5\u30fc\u30d0\u304cunseal\u3055\u308c\u3066\u3044\u308c\u3070vault\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304c\u81ea\u52d5\u3067active\u306e\u65b9\u3078\u7e4b\u304e\u306b\u884c\u304f\u3088\u3046\u306b\u306a\u3063\u305f\u306e\u3067\u4ee5\u4e0b\u306b\u8a18\u8ff0\u3059\u308b\u3088\u3046\u306a\u3053\u3068\u306f\u8d77\u3053\u3089\u306a\u3044\u3002\u3082\u3057standby\u5074\u306b\u7e4b\u3052\u3089\u308c\u308c\u3070\u540c\u3058\u3053\u3068\u304c\u8d77\u3053\u308b\u3068\u63a8\u6e2c\u3055\u308c\u308b\u306e\u3067\u53c2\u8003\u307e\u3067\u306b\u6b8b\u3057\u3066\u304a\u304f\u3002\u8981\u7d04\u3059\u308c\u3070HA\u69cb\u6210\u306e\u6642\u306f1\u53f0\u3060\u3051active\u3067\u4ed6\u306fstandby\u306b\u306a\u308b\u3001\u3068\u3044\u3046\u3053\u3068\u3067\u3042\u308b\uff09\n\u3057\u304b\u30572\u53f0\u76ee(10.0.2.170)\u3067vault auth\u3092\u5b9f\u884c\u3059\u308b\u3068Error validating token: Get https:///v1/auth/token/lookup-self: http: no Host in request URL\u3068\u3044\u3046\u30a8\u30e9\u30fc\u306b\u306a\u308b\u3002\n2\u53f0\u76ee\u3067vault status\u3092\u5b9f\u884c\u3057\u3066\u307f\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8868\u793a\u3055\u308c\u308b\u3002\n# vault status\nSealed: false\nKey Shares: 5\nKey Threshold: 3\nUnseal Progress: 0\n\nHigh-Availability Enabled: true\n        Mode: standby\n        Leader: 10.0.2.167\n\n\u3042\u3042\u3001\u3064\u307e\u308a2\u53f0\u76ee\u306fstandby\u3068\u3044\u3046\u3053\u3068\u304b\u3002\n\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u3082active\u306a\u306e\u306f1\u53f0\u3060\u3051\u3001\u3068\u66f8\u3044\u3066\u3042\u308b\u306e\u306f\u5f8c\u3067\u6c17\u4ed8\u3044\u305f\u3002\n1\u53f0\u76ee\u3067\u306fvault status\u3067\u6b21\u306e\u3088\u3046\u306b\u8868\u793a\u3055\u308c\u308b\u3002\n# vault status\nSealed: false\nKey Shares: 5\nKey Threshold: 3\nUnseal Progress: 0\n\nHigh-Availability Enabled: true\n        Mode: active\n        Leader: 10.0.2.167\n\n\u3068\u3044\u3046\u308f\u3051\u30671\u53f0\u76ee\u3067Vault\u306b\u66f8\u304d\u8fbc\u3093\u3067\u304b\u3089\u843d\u3068\u3057\u3066\u307f\u308b\u3002\n# vault write secret/test aaa=bbb\n# service vault stop\n\n40\u79d2\u7a0b\u5ea6\u7d4c\u3063\u3066\u304b\u30892\u53f0\u76ee\u306b\u5207\u308a\u66ff\u308f\u3063\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u305f\u3002\n# vault status\nSealed: false\nKey Shares: 5\nKey Threshold: 3\nUnseal Progress: 0\n\nHigh-Availability Enabled: true\n        Mode: active\n        Leader: 10.0.2.170\n\n2\u53f0\u76ee\u3067vault auth\u3082\u901a\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u3057\u3001\u5148\u7a0bVault\u306b\u4fdd\u5b58\u3057\u305f\u60c5\u5831\u3082\u8aad\u3081\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n# vault auth 8c535adc-f7c7-32d7-09ae-14c32da1e6b6\nSuccessfully authenticated! The policies that are associated\nwith this token are listed below:\n\nroot\n\n# vault read secret/test\nKey             Value\nlease_id        secret/test/71574acd-0ccf-238f-5c64-f3ad8d39becb\nlease_duration  2592000\naaa             bbb\n\n\uff08\u203b v0.1.0\u306e\u6642\u306e\u8a18\u8ff0\u3053\u3053\u307e\u3067\uff09\nVault\u306fConsul\u306b\u5207\u308a\u66ff\u3048\u306e\u305f\u3081\u306e\u554f\u3044\u5408\u308f\u305b\u3092\u3057\u3066\u3044\u308b\u3088\u3046\u3067\u30018200/tcp\u306b\u3064\u3044\u3066\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u304c2\u53f0\u9593\u3067\u958b\u3044\u3066\u306a\u304f\u3066\u3082\u5207\u308a\u66ff\u3048\u306f\u53ef\u80fd\u3067\u3042\u3063\u305f\u3002\n\n\u30c7\u30fc\u30bf\u306fConsul\u306e\u3069\u3053\u306b\u4fdd\u5b58\u3055\u308c\u3066\u3044\u308b\u306e\u304b\nConsul\u306e\u30ad\u30fc\u30d0\u30ea\u30e5\u30fc\u30b9\u30c8\u30a2\u306evault\u3068\u3044\u3046\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u4fdd\u5b58\u3055\u308c\u3066\u3044\u308b\u3002\n\u3053\u306evault\u3068\u3044\u3046\u540d\u524d\u306f\u8a2d\u5b9a\u3067\u5909\u66f4\u53ef\u80fd\u3067\u3042\u308b\uff08backend \"consul\"\u306epath\u30aa\u30d7\u30b7\u30e7\u30f3\uff09\u3002\nv0.1.1\u307e\u3067\u306fcore/lock\u3068\u3044\u3046\u30ad\u30fc\u3082\u3067\u304d\u3066\u3044\u305f\u304c\u30d0\u30b0\u3060\u3063\u305f\u3088\u3046\u3067\u3001v0.1.2\u304b\u3089vault\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u5185\u306b\u66f8\u304b\u308c\u308b\u3088\u3046\u306b\u306a\u3063\u305f(vault/core/lock)\u3002\n\nVault\u30b5\u30fc\u30d0\u306eactive\u5074\u3078\u306e\u81ea\u52d5\u5207\u308a\u66ff\u3048\n\u4ee5\u4e0b\u3067\u306fHAProxy\u3092\u4f7f\u3046\u65b9\u6cd5\u3068Consul\u3092\u4f7f\u3046\u65b9\u6cd5\u3092\u8a18\u8ff0\u3059\u308b\u3002\n\u73fe\u5728\u306f\uff08\u5f8c\u304b\u3089\u6c17\u4ed8\u3044\u305f\uff09Consul\u3092\u4f7f\u3046\u65b9\u6cd5\u3092\u4f7f\u7528\u3057\u3066\u3044\u308b\u3002\n\nHAProxy\u306b\u3088\u308b\u81ea\u52d5\u5207\u308a\u66ff\u3048\n\uff08\u203b \u3053\u306e\u7ae0\u306e\u8a18\u8ff0\u306fHTTPS\u63a5\u7d9a\u306e\u7b87\u6240\u3092\u9664\u304dv0.1.0\u5f53\u6642\u306e\u3082\u306e\u305d\u306e\u307e\u307e\u306a\u306e\u3067\u3001\u73fe\u5728\u3068\u306f\u4e00\u90e8\u51fa\u529b\u5185\u5bb9\u304c\u7570\u306a\u308b\u7b87\u6240\u304c\u3042\u308b\uff09\nVault\u304cHA\u69cb\u6210\u3092\u53d6\u308b\u3068active/standby\u306b\u306a\u308b\u3053\u3068\u304c\u308f\u304b\u3063\u305f\u3002\n\u305d\u306e\u305f\u3081\u3001Vault\u30b5\u30fc\u30d0\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u305f\u3081\u306b\u306f\u3001\u5e38\u306bactive\u5074\u306b\u30a2\u30af\u30bb\u30b9\u3055\u305b\u308b\u4ed5\u7d44\u307f\u304c\u5225\u9014\u5fc5\u8981\u306b\u306a\u308b\u3002\n\uff08v0.1.1\u3067\u306f\u63a5\u7d9a\u5148\u306eVault\u30b5\u30fc\u30d0\u304cstandby\u3067\u3082\u81ea\u52d5\u3067active\u5074\u306b\u63a5\u7d9a\u3057\u76f4\u3057\u3066\u304f\u308c\u308b\u304c\u3001\u8d77\u52d5\u3057\u3066\u3044\u306a\u304b\u3063\u305f\u308aseal\u3055\u308c\u3066\u3044\u305f\u308a\u3059\u308b\u3068\u305d\u3046\u306f\u3044\u304b\u306a\u3044\uff09\n\u305d\u3053\u3067HAProxy\u3092\u4f7f\u3046\u3053\u3068\u306b\u3059\u308b\u3002\n\nHAProxy\u306e\u6e96\u5099\nHAProxy\u3092Vault\u30b5\u30fc\u30d0\u5074\u306b\u5165\u308c\u308b\u3068HAProxy\u306e\u5197\u9577\u5316\u3068\u304b\u8003\u3048\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u306e\u3067\u3001\u3053\u3053\u3067\u306f\u305d\u308c\u3092\u7701\u7565\u3059\u3079\u304fVault\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u306b\u5165\u308c\u308b\u3053\u3068\u3068\u3059\u308b\u3002\n\uff08\u307e\u3042\u5b9f\u969b\u306b\u306f\u3001\u3053\u306e\u8cc7\u6599\u3067\u306fVault\u30b5\u30fc\u30d0\u3068Vault\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306f\u540c\u3058\u30b3\u30f3\u30d4\u30e5\u30fc\u30bf\u306b\u306a\u3063\u3066\u308b\u3051\u3069\u3001\u5225\u3005\u306b\u3057\u3066\u3044\u308b\u3068\u307f\u306a\u3059\u3082\u306e\u3068\u3057\u3066\uff09\nHAProxy\u3068socat\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3002\nCentOS 6\u3060\u3068socat\u306fEPEL\u306b\u3042\u308b\u306e\u3067\u3001\u6b21\u3088\u308a\u5148\u306byum install epel-release\u3092\u5b9f\u884c\u3059\u308b\u3002\n# yum install haproxy socat\n\nCentOS 7\u3067SELinux\u304c\u6709\u52b9\u3060\u3068HAProxy\u304c\u30dd\u30fc\u30c8\u3092bind\u3067\u304d\u306a\u3044\uff08systemctl status haproxy.service -l\u3067cannot bind socket\u3068\u3044\u3046\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u51fa\u529b\u3055\u308c\u3066\u3044\u308b\u306e\u304c\u308f\u304b\u308b\uff09\u306e\u3067HAProxy\u8d77\u52d5\u524d\u306b\u6b21\u3092\u5b9f\u884c\u3059\u308b\u3002\n# setsebool -P haproxy_connect_any on\n\nHAProxy\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb /etc/haproxy/haproxy.cfg \u3092\u6b21\u306e\u3088\u3046\u306a\u5185\u5bb9\u3067\u4f5c\u308b\u3002\n\u6b21\u306fHTTP\u63a5\u7d9a\u3068\u3059\u308b\u5834\u5408\u3067\u3042\u308b\u3002HTTPS\u63a5\u7d9a\u3068\u3059\u308b\u5834\u5408\u306b\u3064\u3044\u3066\u306f\u5f8c\u8ff0\u3059\u308b\u3002\n\u306a\u304a\u3001global\u5185\u3068defaults\u5185\u306f\u521d\u671f\u306e /etc/haproxy/haproxy.cfg \u3068\u540c\u3058\u8a2d\u5b9a\u5185\u5bb9\u3067\u3042\u308a\u3001\u65b0\u3057\u304f\u8ffd\u52a0\u3057\u305f\u306e\u306flisten\u306e\u7b87\u6240\u3060\u3051\u3067\u3042\u308b\u3002\n\n/etc/haproxy/haproxy.cfg\nglobal\n    log         127.0.0.1 local2\n    chroot      /var/lib/haproxy\n    pidfile     /var/run/haproxy.pid\n    maxconn     4000\n    user        haproxy\n    group       haproxy\n    daemon\n    stats socket /var/lib/haproxy/stats\n\ndefaults\n    mode                    http\n    log                     global\n    option                  httplog\n    option                  dontlognull\n    option http-server-close\n    option forwardfor       except 127.0.0.0/8\n    option                  redispatch\n    retries                 3\n    timeout http-request    10s\n    timeout queue           1m\n    timeout connect         10s\n    timeout client          1m\n    timeout server          1m\n    timeout http-keep-alive 10s\n    timeout check           10s\n    maxconn                 3000\n\nlisten vault\n    bind 0.0.0.0:8210\n    option httpchk GET /v1/sys/health HTTP/1.1\n    server cc6 10.0.2.167:8200 check inter 5s fall 2 rise 1\n    server cc7 10.0.2.170:8200 check inter 5s fall 2 rise 1\n\n\nbind\u3059\u308b\u30dd\u30fc\u30c8\u306f\u3001\u3053\u306e\u74b0\u5883\u3067\u306fVault\u30b5\u30fc\u30d0\u3068\u540c\u5c45\u3057\u3066\u3044\u308b\u306e\u30678200\u304c\u4f7f\u3048\u306a\u3044\u305f\u30818210\u3068\u3057\u3066\u307f\u305f\u3002\u4f7f\u3048\u308b\u756a\u53f7\u306a\u3089\u4f55\u3067\u3082\u826f\u3044\u3060\u308d\u3046\u3002\n\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u5bfe\u8c61\u306eURL\u306f/v1/sys/health\u304c\u826f\u3055\u305d\u3046\u3060\u3063\u305f\u306e\u3067\u3053\u308c\u3092\u9078\u3093\u3060\u3002\n\u3053\u308c\u306factive\u306a\u3089\u30b9\u30c6\u30fc\u30bf\u30b9\u30b3\u30fc\u30c9200\u3092\u3001standby\u306a\u3089429\u3092\u3001seal\u306a\u3089500\u3092\u8fd4\u3059\u3002\n\uff08seal\u72b6\u614b\u306eVault\u30b5\u30fc\u30d0\u306factive\u306b\u3082standby\u306b\u3082\u306a\u308c\u306a\u3044\uff09\n\u306a\u3093\u3067standby\u306f429(Too Many Requests)\u306a\u3093\u3060\u308d\u3046\uff1f \u3068\u3044\u3046\u306e\u306f\u3042\u308b\u304c\u3002\nCentOS 6\u3060\u3068\u6b21\u3067HAProxy\u3092\u8d77\u52d5\u3002\n# chkconfig haproxy on\n# service haproxy start\n\nCentOS 7\u3060\u3068\u6b21\u3067HAProxy\u3092\u8d77\u52d5\u3002\n# systemctl enable haproxy.service\n# systemctl start haproxy.service\n\n\u74b0\u5883\u5909\u6570VAULT_ADDR\u3092\u5909\u66f4\u3057\u3066\u63a5\u7d9a\u5148\u3092HAProxy\u304c\u958b\u3051\u3066\u3044\u308b\u30dd\u30fc\u30c8\u306b\u5909\u3048\u308b\u3002\n# export VAULT_ADDR='http://127.0.0.1:8210'\n\nvault write\u3068vault read\u3092\u3084\u3063\u3066\u307f\u308b\u3002\n\u554f\u984c\u306a\u3044\u3002\n# vault write secret/test2 k1=v1\nSuccess! Data written to: secret/test2\n\n# vault read secret/test2\nKey             Value\nlease_id        secret/test2/cd7fd737-2d2c-1ca6-739f-4c54c8e7649b\nlease_duration  2592000\nk1              v1\n\nsocat\u3067HAProxy\u306estat\u3092\u78ba\u8a8d\u3059\u308b\u3002\n\uff081\u3064\u76ee\u306e#\u306f\u30d7\u30ed\u30f3\u30d7\u30c8\u3060\u3051\u3069\u30012\u3064\u76ee\u306e#\u306f\u305f\u3060\u306e\u51fa\u529b\u3002socat\u306estat\u306b\u3064\u3044\u3066\u4ee5\u4e0b\u540c\u3058\uff09\n# echo \"show stat\" | socat stdio /var/lib/haproxy/stats\n# pxname,svname,qcur,qmax,scur,smax,slim,stot,bin,bout,dreq,dresp,ereq,econ,eresp,wretr,wredis,status,weight,act,bck,chkfail,chkdown,lastchg,downtime,qlimit,pid,iid,sid,throttle,lbtot,tracked,type,rate,rate_lim,rate_max,check_status,check_code,check_duration,hrsp_1xx,hrsp_2xx,hrsp_3xx,hrsp_4xx,hrsp_5xx,hrsp_other,hanafail,req_rate,req_rate_max,req_tot,cli_abrt,srv_abrt,comp_in,comp_out,comp_byp,comp_rsp,lastsess,last_chk,last_agt,qtime,ctime,rtime,ttime,\nvault,FRONTEND,,,0,1,3000,3,520,650,0,0,0,,,,,OPEN,,,,,,,,,1,2,0,,,,0,0,0,1,,,,0,3,0,0,0,0,,0,1,3,,,0,0,0,0,,,,,,,,\nvault,cc6,0,0,0,0,,0,0,0,,0,,0,0,0,0,DOWN,1,1,0,2,1,447,447,,1,2,1,,0,,2,0,,0,L7STS,429,0,0,0,0,0,0,0,0,,,,0,0,,,,,-1,Too Many Requests,,0,0,0,0,\nvault,cc7,0,0,0,1,,3,520,650,,0,,0,0,0,0,UP,1,1,0,1,1,409,1311,,1,2,2,,3,,2,0,,1,L7OK,200,0,0,3,0,0,0,0,0,,,,0,0,,,,,134,OK,,0,0,1,1,\nvault,BACKEND,0,0,0,1,300,3,520,650,0,0,,0,0,0,0,UP,1,1,0,,1,409,38,,1,2,0,,3,,1,0,,1,,,,0,3,0,0,0,0,,,,,0,0,0,0,0,0,134,,,0,0,1,1,\n\n1\u53f0\u76ee(cc6)\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u30b3\u30fc\u30c9\u304c429\u30012\u53f0\u76ee(cc7)\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u30b3\u30fc\u30c9\u304c200\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u30671\u53f0\u76ee\u304cstandby\u30012\u53f0\u76ee\u304cactive\u3067\u3042\u308b\u3002\nvault status\u3067\u30822\u53f0\u76ee\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n# vault status\nSealed: false\nKey Shares: 5\nKey Threshold: 3\nUnseal Progress: 0\n\nHigh-Availability Enabled: true\n        Mode: active\n        Leader: 10.0.2.170\n\n\n\u5207\u308a\u66ff\u3048\u30c6\u30b9\u30c8\n\u305d\u308c\u3067\u306f2\u53f0\u76ee\u306eVault\u30b5\u30fc\u30d0\u3092\u843d\u3068\u3057\u3066\u307f\u308b\u3002\n# systemctl stop vault.service\n\n\u5148\u306bVault\u30b5\u30fc\u30d0\u306e\u5207\u308a\u66ff\u3048\u306b\u306f40\u79d2\u307b\u3069\u639b\u304b\u308b\u3068\u66f8\u3044\u305f\u3002\n\u3059\u3050\u306bvault read\u3057\u3066\u307f\u3066\u3082\u30a2\u30af\u30bb\u30b9\u3067\u304d\u306a\u3044\u3002\n# vault read secret/test2\nError reading secret/test: Error making API request.\n\nURL: GET http://127.0.0.1:8210/v1/secret/test2\nCode: 503. Raw Message:\n\n<html><body><h1>503 Service Unavailable</h1>\nNo server is available to handle this request.\n</body></html>\n\n\u3053\u306e\u6642\u70b9\u3067socat\u3067HAProxy\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u3092\u898b\u308b\u30681\u53f0\u76ee\u30012\u53f0\u76ee\u3068\u3082\u306bDOWN\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n# echo \"show stat\" | socat stdio /var/lib/haproxy/stats\n# pxname,svname,qcur,qmax,scur,smax,slim,stot,bin,bout,dreq,dresp,ereq,econ,eresp,wretr,wredis,status,weight,act,bck,chkfail,chkdown,lastchg,downtime,qlimit,pid,iid,sid,throttle,lbtot,tracked,type,rate,rate_lim,rate_max,check_status,check_code,check_duration,hrsp_1xx,hrsp_2xx,hrsp_3xx,hrsp_4xx,hrsp_5xx,hrsp_other,hanafail,req_rate,req_rate_max,req_tot,cli_abrt,srv_abrt,comp_in,comp_out,comp_byp,comp_rsp,lastsess,last_chk,last_agt,qtime,ctime,rtime,ttime,\nvault,FRONTEND,,,0,1,3000,2,324,480,0,0,0,,,,,OPEN,,,,,,,,,1,2,0,,,,0,0,0,1,,,,0,1,0,0,1,0,,0,1,2,,,0,0,0,0,,,,,,,,\nvault,cc6,0,0,0,0,,0,0,0,,0,,0,0,0,0,DOWN,1,1,0,2,1,665,665,,1,2,1,,0,,2,0,,0,L7STS,429,0,0,0,0,0,0,0,0,,,,0,0,,,,,-1,Too Many Requests,,0,0,0,0,\nvault,cc7,0,0,0,1,,5,324,480,,0,,1,0,3,0,DOWN,1,1,0,3,2,2,808,,1,2,2,,2,,2,0,,1,L4CON,,0,0,1,0,0,0,0,0,,,,0,0,,,,,4,Connection refused,,0,0,1,1,\nvault,BACKEND,0,0,0,1,300,2,324,480,0,0,,1,0,3,0,DOWN,0,0,0,,2,2,40,,1,2,0,,2,,1,0,,1,,,,0,1,0,0,1,0,,,,,0,0,0,0,0,0,4,,,0,0,1,1,\n\n\u3057\u3070\u3089\u304f\u3057\u3066\u304b\u3089\u3082\u3046\u4e00\u5ea6socat\u3067HAProxy\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u3092\u898b\u308b\u30681\u53f0\u76ee\u306e\u65b9\u304cUP\u306b\u306a\u3063\u3066\u3044\u308b\u3002\nVault\u30b5\u30fc\u30d0\u5074\u306e\u5207\u308a\u66ff\u3048\u304c\u7d42\u308f\u3063\u305f\u3088\u3046\u3060\u3002\n# echo \"show stat\" | socat stdio /var/lib/haproxy/stats\n# pxname,svname,qcur,qmax,scur,smax,slim,stot,bin,bout,dreq,dresp,ereq,econ,eresp,wretr,wredis,status,weight,act,bck,chkfail,chkdown,lastchg,downtime,qlimit,pid,iid,sid,throttle,lbtot,tracked,type,rate,rate_lim,rate_max,check_status,check_code,check_duration,hrsp_1xx,hrsp_2xx,hrsp_3xx,hrsp_4xx,hrsp_5xx,hrsp_other,hanafail,req_rate,req_rate_max,req_tot,cli_abrt,srv_abrt,comp_in,comp_out,comp_byp,comp_rsp,lastsess,last_chk,last_agt,qtime,ctime,rtime,ttime,\nvault,FRONTEND,,,0,1,3000,3,487,747,0,0,0,,,,,OPEN,,,,,,,,,1,2,0,,,,0,0,0,1,,,,0,2,0,0,1,0,,0,1,3,,,0,0,0,0,,,,,,,,\nvault,cc6,0,0,0,1,,1,163,267,,0,,0,0,0,0,UP,1,1,0,2,1,147,695,,1,2,1,,1,,2,0,,1,L7OK,200,0,0,1,0,0,0,0,0,,,,0,0,,,,,107,OK,,0,0,1,1,\nvault,cc7,0,0,0,1,,5,324,480,,0,,1,0,3,0,DOWN,1,1,0,3,2,179,985,,1,2,2,,2,,2,0,,1,L4CON,,0,0,1,0,0,0,0,0,,,,0,0,,,,,181,Connection refused,,0,0,1,1,\nvault,BACKEND,0,0,0,1,300,3,487,747,0,0,,1,0,3,0,UP,1,1,0,,2,147,70,,1,2,0,,3,,1,0,,1,,,,0,2,0,0,1,0,,,,,0,0,0,0,0,0,107,,,0,0,1,1,\n\n\u3053\u3046\u306a\u308c\u3070vault read\u304c\u901a\u308b\u3002\n# vault read secret/test2\nKey             Value\nlease_id        secret/test2/75a4687d-3fe0-e8f2-2108-d34b28bd67a7\nlease_duration  2592000\nk1              v1\n\n2\u53f0\u76ee\u306e\u65b9\u306eVault\u30b5\u30fc\u30d0\u3092\u3082\u3046\u4e00\u5ea6\u8d77\u52d5\u3059\u308b\u3002\n# systemctl start vault.service\n\n2\u53f0\u76ee\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u30b3\u30fc\u30c9\u304c500\u306a\u306e\u3067seal\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n# echo \"show stat\" | socat stdio /var/lib/haproxy/stats\n# pxname,svname,qcur,qmax,scur,smax,slim,stot,bin,bout,dreq,dresp,ereq,econ,eresp,wretr,wredis,status,weight,act,bck,chkfail,chkdown,lastchg,downtime,qlimit,pid,iid,sid,throttle,lbtot,tracked,type,rate,rate_lim,rate_max,check_status,check_code,check_duration,hrsp_1xx,hrsp_2xx,hrsp_3xx,hrsp_4xx,hrsp_5xx,hrsp_other,hanafail,req_rate,req_rate_max,req_tot,cli_abrt,srv_abrt,comp_in,comp_out,comp_byp,comp_rsp,lastsess,last_chk,last_agt,qtime,ctime,rtime,ttime,\nvault,FRONTEND,,,0,1,3000,4,650,1014,0,0,0,,,,,OPEN,,,,,,,,,1,2,0,,,,0,0,0,1,,,,0,3,0,0,1,0,,0,1,4,,,0,0,0,0,,,,,,,,\nvault,cc6,0,0,0,1,,2,326,534,,0,,0,0,0,0,UP,1,1,0,2,1,355,695,,1,2,1,,2,,2,0,,1,L7OK,200,0,0,2,0,0,0,0,0,,,,0,0,,,,,126,OK,,0,0,1,1,\nvault,cc7,0,0,0,1,,5,324,480,,0,,1,0,3,0,DOWN,1,1,0,3,2,387,1193,,1,2,2,,2,,2,0,,1,L7STS,500,0,0,1,0,0,0,0,0,,,,0,0,,,,,389,Internal Server Error,,0,0,1,1,\nvault,BACKEND,0,0,0,1,300,4,650,1014,0,0,,1,0,3,0,UP,1,1,0,,2,355,70,,1,2,0,,4,,1,0,,1,,,,0,3,0,0,1,0,,,,,0,0,0,0,0,0,126,,,0,0,1,1,\n\n2\u53f0\u76ee\u306fvault unseal\u3059\u308b\u3068\u518d\u5ea6\u4f7f\u7528\u53ef\u80fd\u306a\u72b6\u614b\u306b\u306a\u308b\u3002\n# vault unseal -address http://10.0.2.170:8200\n# vault unseal -address http://10.0.2.170:8200\n# vault unseal -address http://10.0.2.170:8200\n\n2\u53f0\u76ee\u306e\u30b9\u30bf\u30fc\u30bf\u30b9\u30b3\u30fc\u30c9\u304c429\u306b\u5909\u5316\u3057\u305f\u306e\u3067standby\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n# echo \"show stat\" | socat stdio /var/lib/haproxy/stats\n# pxname,svname,qcur,qmax,scur,smax,slim,stot,bin,bout,dreq,dresp,ereq,econ,eresp,wretr,wredis,status,weight,act,bck,chkfail,chkdown,lastchg,downtime,qlimit,pid,iid,sid,throttle,lbtot,tracked,type,rate,rate_lim,rate_max,check_status,check_code,check_duration,hrsp_1xx,hrsp_2xx,hrsp_3xx,hrsp_4xx,hrsp_5xx,hrsp_other,hanafail,req_rate,req_rate_max,req_tot,cli_abrt,srv_abrt,comp_in,comp_out,comp_byp,comp_rsp,lastsess,last_chk,last_agt,qtime,ctime,rtime,ttime,\nvault,FRONTEND,,,0,1,3000,3,520,650,0,0,0,,,,,OPEN,,,,,,,,,1,2,0,,,,0,0,0,1,,,,0,3,0,0,0,0,,0,1,3,,,0,0,0,0,,,,,,,,\nvault,cc6,0,0,0,0,,0,0,0,,0,,0,0,0,0,UP,1,1,0,2,1,477,696,,1,2,1,,0,,2,0,,0,L7OK,200,0,0,0,0,0,0,0,0,,,,0,0,,,,,-1,OK,,0,0,0,0,\nvault,cc7,0,0,0,1,,3,520,650,,0,,0,0,0,0,DOWN,1,1,0,3,2,515,1826,,1,2,2,,3,,2,0,,1,L7STS,429,0,0,3,0,0,0,0,0,,,,0,0,,,,,860,Too Many Requests,,0,0,1,1,\nvault,BACKEND,0,0,0,1,300,3,520,650,0,0,,0,0,0,0,UP,1,1,0,,2,477,76,,1,2,0,,3,,1,0,,1,,,,0,3,0,0,0,0,,,,,0,0,0,0,0,0,860,,,0,0,1,1,\n\nvault status\u30671\u53f0\u76ee\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u305f\u3002\n# vault status\nSealed: false\nKey Shares: 5\nKey Threshold: 3\nUnseal Progress: 0\n\nHigh-Availability Enabled: true\n        Mode: active\n        Leader: 10.0.2.167\n\n\nHTTPS\u63a5\u7d9a\u306b\u3059\u308b\u5834\u5408\nHTTPS\u63a5\u7d9a\u3060\u3068HAProxy\u306e\u8a2d\u5b9a\u306e\u3046\u3061mode http\u3092mode tcp\u306b\u5909\u66f4\u3057\u306a\u3051\u308c\u3070\u306a\u3089\u305a\u3001\u305d\u308c\u306b\u4f34\u3044option httpchk\u304c\u4f7f\u7528\u3067\u304d\u306a\u3044\u306e\u3067\u7279\u5b9a\u306eURL\u306b\u5bfe\u3057\u3066\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u3092\u639b\u3051\u308b\u3053\u3068\u304c\u3067\u304d\u306a\u3044\uff08\u3068\u3001\u601d\u3046\u3002\u4ee3\u308f\u308a\u306b\u306a\u308b\u3082\u306e\u3092\u898b\u3064\u3051\u3089\u308c\u3066\u3044\u306a\u3044\u3060\u3051\u304b\u3082\u3057\u308c\u306a\u3044\uff09\u3002\n\u5f93\u3063\u3066Vault\u30b5\u30fc\u30d0\u304c\u8d77\u52d5\u3057\u3066\u3044\u308b\u304b\u3057\u3066\u3044\u306a\u3044\u304b\u306e\u30c1\u30a7\u30c3\u30af\u306f\u3067\u304d\u3066\u3082\u3001active/standby/seal\u306e\u3046\u3061\u3069\u306e\u72b6\u614b\u306b\u306a\u3063\u3066\u3044\u308b\u304b\u306e\u30c1\u30a7\u30c3\u30af\u304c\u3067\u304d\u306a\u3044\u3002\n\u3068\u306f\u3044\u3048active\u304bstandby\u306a\u3089\u81ea\u52d5\u63a5\u7d9a\u5207\u308a\u66ff\u3048\u304c\u50cd\u304f\u306e\u3067\u3001\u3053\u308c\u3089\u3092\u533a\u5225\u3059\u308b\u5fc5\u8981\u306f\u7279\u306b\u306a\u3044\u3002\u554f\u984c\u306fseal\u306e\u5834\u5408\u306b\u3069\u3046\u3059\u308c\u3070\u826f\u3044\u304b\u3067\u3042\u308b\u3002\n\u3068\u308a\u3042\u3048\u305a\u30b5\u30fc\u30d3\u30b9\u8d77\u52d5\u6642\u306bunseal\u307e\u3067\u884c\u3046\u3088\u3046\u306binit\u30b9\u30af\u30ea\u30d7\u30c8/systemd\u30e6\u30cb\u30c3\u30c8\u30d5\u30a1\u30a4\u30eb\u3092\u6539\u826f\u3057\u3066\u3001seal\u72b6\u614b\u306e\u671f\u9593\u3092\u306a\u304f\u3059\u65b9\u5411\u3067\u56de\u907f\u3057\u3066\u307f\u308b\u3002\ninit\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u4f7f\u3046\u5834\u5408\u306f /etc/sysconfig/vault \u306b\u6b21\u306e\u3088\u3046\u306b\u8a18\u8ff0\u3059\u308b\u3002\nVAULT_ADDR\u306fHAProxy\u304c\u958b\u3051\u3066\u3044\u308b\u30dd\u30fc\u30c8\u3067\u306f\u306a\u304f\u3001Vault\u30b5\u30fc\u30d0\u81ea\u4f53\u304c\u958b\u3051\u3066\u3044\u308b\u30dd\u30fc\u30c8\u306b\u3059\u308b\u3002\nKEYS\u306f\u30b9\u30da\u30fc\u30b9\u533a\u5207\u308a\u3067\u3002\nexport VAULT_ADDR='https://cc6.node.consul:8200'\nexport KEYS=\"52d78d93109a47356a169e8cf2ee4868dc40de7fdd9b1c1d0c68255a8f691c0501 514f788ab44d9805577a074ce7f457891d59880a6a05b38b0acadaacdc330dbb02 b26ceda206536f317e375ae55fff849b0d3c9758f74b920d3d512122211f518b03\"\nexport CERT='-ca-cert /etc/pki/tls/self/node.crt'\n\nsystemd\u30e6\u30cb\u30c3\u30c8\u30d5\u30a1\u30a4\u30eb\u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\u306fexport\u306f\u66f8\u304b\u306a\u3044\u3002\nVAULT_ADDR='https://cc7.node.consul:8200'\nKEYS=\"52d78d93109a47356a169e8cf2ee4868dc40de7fdd9b1c1d0c68255a8f691c0501 514f788ab44d9805577a074ce7f457891d59880a6a05b38b0acadaacdc330dbb02 b26ceda206536f317e375ae55fff849b0d3c9758f74b920d3d512122211f518b03\"\nCERT='-ca-cert /etc/pki/tls/self/node.crt'\n\nHAProxy\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb /etc/haproxy/haproxy.cfg \u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3059\u308b\u3002\n\n/etc/haproxy/haproxy.cfg\nglobal\n    log         127.0.0.1 local2\n    chroot      /var/lib/haproxy\n    pidfile     /var/run/haproxy.pid\n    maxconn     4000\n    user        haproxy\n    group       haproxy\n    daemon\n    stats socket /var/lib/haproxy/stats\n\ndefaults\n    mode                    http\n    log                     global\n    option                  httplog\n    option                  dontlognull\n    option http-server-close\n    option forwardfor       except 127.0.0.0/8\n    option                  redispatch\n    retries                 3\n    timeout http-request    10s\n    timeout queue           1m\n    timeout connect         10s\n    timeout client          1m\n    timeout server          1m\n    timeout http-keep-alive 10s\n    timeout check           10s\n    maxconn                 3000\n\nlisten vault\n    mode tcp\n    bind 0.0.0.0:8210\n    option ssl-hello-chk\n    server cc6 10.0.2.167:8200 check inter 5s fall 2 rise 1\n    server cc7 10.0.2.170:8200 check inter 5s fall 2 rise 1\n\n\n\u74b0\u5883\u5909\u6570VAULT_ADDR\u3092\u5909\u66f4\u3057\u3066\u63a5\u7d9a\u5148\u3092HAProxy\u304c\u958b\u3051\u3066\u3044\u308b\u30dd\u30fc\u30c8\u306b\u5909\u3048\u308b\u3002\n# export VAULT_ADDR='https://cc6.node.consul:8210'\n\n\u4ed6\u306e\u4f5c\u696d\u306fHTTP\u63a5\u7d9a\u306e\u5834\u5408\u3068\u5909\u308f\u3089\u306a\u3044\u3002\n\nConsul\u306b\u3088\u308b\u81ea\u52d5\u5207\u308a\u66ff\u3048\n\u3088\u304f\u3088\u304f\u8abf\u3079\u3066\u307f\u308c\u3070HAProxy\u3092\u4f7f\u308f\u306a\u304f\u3066\u3082Consul\u3067\u81ea\u52d5\u5207\u308a\u66ff\u3048\u304c\u53ef\u80fd\u3067\u3042\u308b\u3002\nHTTPS\u63a5\u7d9a\u3067\u81ea\u5df1\u7f72\u540d\u8a3c\u660e\u66f8\u304c\u5fc5\u8981\u306a\u3089\u30b3\u30e2\u30f3\u30cd\u30fc\u30e0\u304c\u300c*.service.consul\u300d\u306e\u8a3c\u660e\u66f8\u3092\u4f5c\u6210\u3059\u308b\u3002\n# mkdir /etc/pki/tls/self\n# cd /etc/pki/tls/self\n# cp /etc/pki/tls/openssl.cnf ./openssl.service.cnf\n\n\n/etc/pki/tls/self/openssl.service.cnf\n# \u30a8\u30c7\u30a3\u30bf\u306a\u3069\u3067\u4ee5\u4e0b\u3092\u4fee\u6b63\u3059\u308b\n\n[ CA_default ]\n# \u8a3c\u660e\u66f8\u306e\u5bff\u547d\u3092365\u65e5\u304b\u30893650\u65e5\u306b\u5909\u66f4\ndefault_days = 3650\n\n[ req ]\n# attributes\u884c\u3092\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3057\u3066prompt = no\u3092\u8ffd\u52a0\n#attributes = req_attributes\nprompt = no\n\n[ req_distinguished_name ]\n# req_distinguished_name\u306e\u4e2d\u306f\u5168\u90e8\u6d88\u3057\u3066\u304b\u3089\u4ee5\u4e0b\u3092\u8ffd\u52a0\nC = JP\nST = Tokyo\nL = Tokyo\nO = consul\nOU = admin\nCN = *.service.consul\n\n\n# sha512sum /proc/vmstat | awk '{ print $1 }' > sha512.dat\n# openssl genrsa -rand sha512.dat -out service.key -passout pass:$(cat sha512.dat) -aes256 2048\n# openssl rsa -in service.key -passin pass:$(cat sha512.dat) -out service.key\n# openssl req -new -config openssl.service.cnf -key service.key -out service.csr\n# openssl x509 -in service.csr -days 3650 -req -signkey service.key -out service.crt\n# rm -f sha512.dat service.csr\n\n\u4f5c\u6210\u3055\u308c\u305f\u79d8\u5bc6\u9375service.key\u3068\u30b5\u30fc\u30d0\u8a3c\u660e\u66f8service.crt\u306f\u3059\u3079\u3066\u306eVault\u30b5\u30fc\u30d0\u306b\u914d\u7f6e\u3059\u308b\u3002\nservice.crt\u306f\u3059\u3079\u3066\u306eVault\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u3082\u914d\u7f6e\u3059\u308b\u3002\n\u3059\u3079\u3066\u306eVault\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3067\u4f5c\u6210\u3057\u305f\u30b5\u30fc\u30d0\u8a3c\u660e\u66f8\u3092\u4fe1\u983c\u3059\u308b\u8a3c\u660e\u66f8\u306b\u52a0\u3048\u308b\u3002\n# update-ca-trust enable # CentOS 7\u3067\u306f\u521d\u671f\u72b6\u614b\u3067enable\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u3067\u5b9f\u884c\u4e0d\u8981\n# ln -s /etc/pki/tls/self/service.crt /etc/pki/ca-trust/source/anchors/\n# update-ca-trust extract\n\nConsul\u5074\u3067\u81ea\u5206\u81ea\u8eab\u3057\u304b\u6307\u3055\u306a\u3044\u9069\u5f53\u306a\u30b5\u30fc\u30d3\u30b9\u3068\u3001Vault\u3068\u3044\u3046\u30b5\u30fc\u30d3\u30b9\u3092\u5b9a\u7fa9\u3059\u308b\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb /etc/consul.d/services.json \u3092\u4f5c\u3063\u3066\u3001Consul\u3092\u3053\u308c\u3092\u8aad\u307f\u8fbc\u3080\u3088\u3046\u306b\u3057\u3066\u8d77\u52d5\u3057\u76f4\u3059\u3002\n\u300c\u81ea\u5206\u81ea\u8eab\u3057\u304b\u6307\u3055\u306a\u3044\u9069\u5f53\u306a\u30b5\u30fc\u30d3\u30b9\u300d\u306fHTTPS\u63a5\u7d9a\u6642\u306b\u8a3c\u660e\u66f8\u306e\u30b3\u30e2\u30f3\u30cd\u30fc\u30e0\u300c*.service.consul\u300d\u306b\u4e00\u81f4\u3059\u308b\u3001\u81ea\u5206\u81ea\u8eab\u3060\u3051\u3092\u6307\u3059\u30db\u30b9\u30c8\u540d\u3092\u4f5c\u308b\u305f\u3081\u306b\u5fc5\u8981\u3067\u3042\u308b\u3002\u6b21\u306e\u4f8b\u3060\u3068\u300ccc6.service.consul\u300d\u3067\u81ea\u5206\u81ea\u8eab\u3092\u6307\u3059\u3053\u3068\u306b\u306a\u308b\u3002\u5404Vault\u30b5\u30fc\u30d0\u3067name\u3092\u305d\u308c\u305e\u308c\u9055\u3046\u5024\u306b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\u300cVault\u3068\u3044\u3046\u30b5\u30fc\u30d3\u30b9\u300d\u3067\u306fchecks\u306ehttp\u3092https://<\u30db\u30b9\u30c8\u540d>:8200/v1/sys/health\u3068\u3059\u308b\u304c\u3001\u30db\u30b9\u30c8\u540d\u306f\u3053\u306e\u81ea\u5206\u81ea\u8eab\u3060\u3051\u3092\u6307\u3059\u30db\u30b9\u30c8\u540d\u306b\u3059\u308b\u3002HTTP\u63a5\u7d9a\u306a\u3089https://\u3067\u306a\u304fhttp://\u306b\u3059\u308b\u3002\n\n/etc/consul.d/services.json\n{\n  \"services\": [\n    {\n      \"name\": \"cc6\"\n    },\n    {\n      \"name\": \"vault\",\n      \"port\": 8200,\n      \"checks\": [\n        {\n          \"http\": \"https://cc6.service.consul:8200/v1/sys/health\",\n          \"interval\": \"5s\"\n        }\n      ]\n    }\n  ]\n}\n\n\nVault\u30b5\u30fc\u30d0\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb /etc/vault.d/server.hcl \u306f\u6b21\u306e\u3088\u3046\u306b\u306a\u308b\u3002\nadvertise_addr\u3082\u540c\u3058\u3088\u3046\u306b\u305d\u306e\u81ea\u5206\u81ea\u8eab\u3060\u3051\u3092\u6307\u3059\u30db\u30b9\u30c8\u540d\u3092\u4f7f\u3063\u3066\u6307\u5b9a\u3059\u308b\u3002\nHTTP\u63a5\u7d9a\u306a\u3089advertise_addr\u306fhttps://\u3067\u306a\u304fhttp://\u306b\u3057\u3001tls_cert_file\u3084tls_key_file\u306f\u6307\u5b9a\u305b\u305atls_disable = 1\u3068\u3059\u308b\u3002\n\n/etc/vault.d/server.hcl\nbackend \"consul\" {\n  advertise_addr = \"https://cc6.service.consul:8200\"\n}\n\nlistener \"tcp\" {\n  address = \"0.0.0.0:8200\"\n  tls_cert_file = \"/etc/pki/tls/self/service.crt\"\n  tls_key_file = \"/etc/pki/tls/self/service.key\"\n}\n\n\n\u3053\u306e\u65b9\u6cd5\u3060\u3068acitve\u304bstandby\u304bseal\u304b\u306e\u533a\u5225\u304c\u3064\u304f\u305f\u3081\u30b5\u30fc\u30d3\u30b9\u8d77\u52d5\u6642\u306b\u81ea\u52d5\u7684\u306bunseal\u3059\u308b\u5fc5\u8981\u306f\u306a\u3044\u304c\u3001\u624b\u52d5\u3067unseal\u3059\u308b\u306e\u304c\u9762\u5012\u306a\u3089 /etc/sysconfig/vault \u3092\u6b21\u306e\u3088\u3046\u306b\u4f5c\u6210\u3057\u3001init\u30b9\u30af\u30ea\u30d7\u30c8\u3084systemd\u30e6\u30cb\u30c3\u30c8\u30d5\u30a1\u30a4\u30eb\u3092\u5229\u7528\u3057\u3066Vault\u30b5\u30fc\u30d0\u3092\u8d77\u52d5\u3059\u308b\u3002\ninit\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u4f7f\u3046\u5834\u5408\u3002\nexport VAULT_ADDR='https://cc6.service.consul:8200'\nexport KEYS=\"52d78d93109a47356a169e8cf2ee4868dc40de7fdd9b1c1d0c68255a8f691c0501 514f788ab44d9805577a074ce7f457891d59880a6a05b38b0acadaacdc330dbb02 b26ceda206536f317e375ae55fff849b0d3c9758f74b920d3d512122211f518b03\"\nexport CERT='-ca-cert /etc/pki/tls/self/service.crt'\n\nsystemd\u30e6\u30cb\u30c3\u30c8\u30d5\u30a1\u30a4\u30eb\u3092\u4f7f\u3046\u5834\u5408\u3002export\u304c\u4e0d\u8981\u3002\nVAULT_ADDR='https://cc7.service.consul:8200'\nKEYS=\"52d78d93109a47356a169e8cf2ee4868dc40de7fdd9b1c1d0c68255a8f691c0501 514f788ab44d9805577a074ce7f457891d59880a6a05b38b0acadaacdc330dbb02 b26ceda206536f317e375ae55fff849b0d3c9758f74b920d3d512122211f518b03\"\nCERT='-ca-cert /etc/pki/tls/self/service.crt'\n\nVault\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3067\u306f\u74b0\u5883\u5909\u6570VAULT_ADDR\u306bhttp(s)://vault.service.consul:8200\u3092\u6307\u5b9a\u3059\u308b\u3002\nvault.service.consul\u306factive\u304bstandby\u306eVault\u30b5\u30fc\u30d0\u3060\u3051\u3067\u306e\u30e9\u30a6\u30f3\u30c9\u30ed\u30d3\u30f3\u3068\u306a\u308a\u3001seal\u3084\u8d77\u52d5\u3057\u3066\u3044\u306a\u3044\u72b6\u614b\u3060\u3068\u30e9\u30a6\u30f3\u30c9\u30ed\u30d3\u30f3\u304b\u3089\u81ea\u52d5\u7684\u306b\u5916\u308c\u308b\u306e\u3067\u3001\u5b8c\u5168\u306b\u671f\u5f85\u901a\u308a\u306e\u52d5\u304d\u3092\u3057\u3066\u304f\u308c\u308b\u3002\n# export VAULT_ADDR='https://vault.service.consul:8200'\n\n\n\u76e3\u67fb\u30ed\u30b0\u306e\u51fa\u529b\nvault audit-enable\u3067\u76e3\u67fb\u30ed\u30b0\u3092\u66f8\u304d\u51fa\u3059\u3088\u3046\u306b\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\u4eca\u306e\u3068\u3053\u308d\u51fa\u529b\u5148\u306f\u30d5\u30a1\u30a4\u30eb\u304bsyslog\u306b\u306a\u308b\u3002\nVault\u304cHA\u69cb\u6210\u306b\u306a\u3063\u3066\u3044\u308b\u5834\u5408\u3001vault audit-enable\u306f\u30af\u30e9\u30b9\u30bf\u306e\u4e2d\u30671\u56de\u3060\u3051\u884c\u3048\u3070active\u306b\u306a\u3063\u3066\u3044\u308b\u30ce\u30fc\u30c9\u306e\u51fa\u529b\u5148\u306b\u66f8\u304d\u51fa\u3055\u308c\u308b\u3002\n\n\u30d5\u30a1\u30a4\u30eb\u3078\u306e\u51fa\u529b\nVault 0.1.1\u307e\u3067\u306fVault\u5074\u3067\u306f\u76e3\u67fb\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u80fd\u529b\u304c\u306a\u304f\u3001\u5148\u306b\u305d\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u3063\u3066\u304b\u3089vault audit-enable\u3057\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u304b\u3063\u305f\u3002\nVault 0.1.2\u304b\u3089\u3001\u66f8\u304d\u8fbc\u307f\u6642\u306b\u30d5\u30a1\u30a4\u30eb\u304c\u306a\u3051\u308c\u3070\u4f5c\u3063\u3066\u304f\u308c\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u3002\n# vault audit-enable file path=/var/log/vault_audit.log\n\nvault write secret/test a=b\u3068vault read secret/test\u3092\u5b9f\u884c\u3057\u305f\u3068\u3053\u308d\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u76e3\u67fb\u30ed\u30b0\u304c\u51fa\u529b\u3055\u308c\u305f\uff08v0.1.1\u6642\u306e\u3082\u306e\uff09\u3002\n\n/var/log/vault_audit.log\n{\"type\":\"request\",\"auth\":{\"policies\":[\"root\"],\"metadata\":null},\"request\":{\"operation\":\"write\",\"path\":\"secret/test\",\"data\":{\"a\":\"sha1:e9d71f5ee7c92d6dc9e92ffdad17b8bd49418f98\"}}}\n{\"type\":\"response\",\"error\":\"\",\"auth\":{\"policies\":[\"root\"],\"metadata\":null},\"request\":{\"operation\":\"write\",\"path\":\"secret/test\",\"data\":{\"a\":\"sha1:e9d71f5ee7c92d6dc9e92ffdad17b8bd49418f98\"}},\"response\":{\"auth\":{\"policies\":null,\"metadata\":null},\"secret\":{\"lease_id\":\"\"},\"data\":null,\"redirect\":\"\"}}\n{\"type\":\"request\",\"auth\":{\"policies\":[\"root\"],\"metadata\":null},\"request\":{\"operation\":\"read\",\"path\":\"secret/test\",\"data\":null}}\n{\"type\":\"response\",\"error\":\"\",\"auth\":{\"policies\":[\"root\"],\"metadata\":null},\"request\":{\"operation\":\"read\",\"path\":\"secret/test\",\"data\":null},\"response\":{\"auth\":{\"policies\":null,\"metadata\":null},\"secret\":{\"lease_id\":\"secret/test/b0f8048a-336c-d326-5b19-d7f5997d500f\"},\"data\":{\"a\":\"sha1:e9d71f5ee7c92d6dc9e92ffdad17b8bd49418f98\"},\"redirect\":\"\"}}\n\n\n\u30d5\u30a1\u30a4\u30eb\u3078\u306e\u66f8\u304d\u8fbc\u307f\u3092\u7d42\u4e86\u3059\u308b\u306b\u306f\u6b21\u3092\u5b9f\u884c\u3059\u308b\u3002\n# vault audit-disable file\n\nfile\u306f\u66f8\u304d\u8fbc\u307f\u5148\u304c\u30d5\u30a1\u30a4\u30eb\u3067\u3001vault audit-enable\u306eid\u30aa\u30d7\u30b7\u30e7\u30f3\u3067ID\u3092\u6307\u5b9a\u3057\u306a\u304b\u3063\u305f\u5834\u5408\u306e\u30c7\u30d5\u30a9\u30eb\u30c8ID\u3067\u3042\u308b\uff08/var/log/vault_audit.log\u306b\u7f6e\u304d\u63db\u3048\u308b\u3068\u304b\u305d\u3046\u3044\u3046\u306e\u3067\u306f\u306a\u3044\uff09\u3002\n\nsyslog\u3078\u306e\u51fa\u529b\nsyslog\u3092\u51fa\u529b\u5148\u306b\u4f7f\u7528\u3059\u308b\u5834\u5408\u306f\u3001Vault\u306f\u30aa\u30d7\u30b7\u30e7\u30f3\u306e\u6307\u5b9a\u304c\u306a\u3051\u308c\u3070\u30d5\u30a1\u30b7\u30ea\u30c6\u30a3AUTH\u3001\u30bf\u30b0vault\u306b\u66f8\u304d\u51fa\u3059\u306e\u3067 /etc/rsyslog.d/vault.conf \u3092\u6b21\u306e\u3088\u3046\u306b\u4f5c\u6210\u3057\u3001rsyslog\u3092\u518d\u8d77\u52d5\u3059\u308b\u3002\n/var/log/vault_audit.log \u306frsyslog\u3092\u518d\u8d77\u52d5\u3057\u305f\u6642\u70b9\u3067\u4f5c\u6210\u3055\u308c\u308b\u304c\u3001\u305d\u306e\u5f8c\u306b\u524a\u9664\u3055\u308c\u308b\u3068rsyslog\u3092\u3082\u3046\u4e00\u5ea6\u518d\u8d77\u52d5\u3059\u308b\u307e\u3067\u51fa\u529b\u306f\u884c\u308f\u308c\u306a\u3044\u3002\n\n/etc/rsyslog.d/vault.conf\n:syslogtag, contains, \"vault\" /var/log/vault_audit.log\n\n\n# service rsyslog restart\n\nVault\u304b\u3089syslog\u3078\u306e\u76e3\u67fb\u30ed\u30b0\u66f8\u304d\u51fa\u3057\u3092\u6709\u52b9\u5316\u3059\u308b\u3002\n# vault audit-enable syslog\n\n\u540c\u3058\u3088\u3046\u306bvault write secret/test a=b\u3068vault read secret/test\u3092\u5b9f\u884c\u3057\u305f\u3068\u3053\u308d\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u76e3\u67fb\u30ed\u30b0\u304c\u51fa\u529b\u3055\u308c\u305f\uff08v0.1.1\u6642\u306e\u3082\u306e\uff09\u3002\n\n/var/log/vault_audit.log\nMay  3 13:48:26 cc7 vault[9090]: {\"type\":\"request\",\"auth\":{\"policies\":[\"root\"],\"metadata\":null},\"request\":{\"operation\":\"write\",\"path\":\"secret/test\",\"data\":{\"a\":\"sha1:e9d71f5ee7c92d6dc9e92ffdad17b8bd49418f98\"}}}\nMay  3 13:48:26 cc7 vault[9090]: {\"type\":\"response\",\"error\":\"\",\"auth\":{\"policies\":[\"root\"],\"metadata\":null},\"request\":{\"operation\":\"write\",\"path\":\"secret/test\",\"data\":{\"a\":\"sha1:e9d71f5ee7c92d6dc9e92ffdad17b8bd49418f98\"}},\"response\":{\"auth\":{\"policies\":null,\"metadata\":null},\"secret\":{\"lease_id\":\"\"},\"data\":null,\"redirect\":\"\"}}\nMay  3 13:48:35 cc7 vault[9090]: {\"type\":\"request\",\"auth\":{\"policies\":[\"root\"],\"metadata\":null},\"request\":{\"operation\":\"read\",\"path\":\"secret/test\",\"data\":null}}\nMay  3 13:48:35 cc7 vault[9090]: {\"type\":\"response\",\"error\":\"\",\"auth\":{\"policies\":[\"root\"],\"metadata\":null},\"request\":{\"operation\":\"read\",\"path\":\"secret/test\",\"data\":null},\"response\":{\"auth\":{\"policies\":null,\"metadata\":null},\"secret\":{\"lease_id\":\"secret/test/421e8b4d-11da-2e11-d15e-85cb1bd30cab\"},\"data\":{\"a\":\"sha1:e9d71f5ee7c92d6dc9e92ffdad17b8bd49418f98\"},\"redirect\":\"\"}}\n\n\nsyslog\u3078\u306e\u66f8\u304d\u8fbc\u307f\u3092\u7d42\u4e86\u3059\u308b\u306b\u306f\u6b21\u3092\u5b9f\u884c\u3059\u308b\u3002\n# vault audit-disable syslog\n\nsyslog\u306f\u66f8\u304d\u8fbc\u307f\u5148\u304csyslog\u3067\u3001vault audit-enable\u306eid\u30aa\u30d7\u30b7\u30e7\u30f3\u3067ID\u3092\u6307\u5b9a\u3057\u306a\u304b\u3063\u305f\u5834\u5408\u306e\u30c7\u30d5\u30a9\u30eb\u30c8ID\u3067\u3042\u308b\u3002\n\n\u3042\u3084\u3057\u3044\u52d5\u4f5c\uff1f\n\nvault revoke\u3067\u63a5\u7d9a\u5148\u306e\u81ea\u52d5\u5207\u308a\u66ff\u3048\u304c\u8d77\u3053\u3089\u306a\u3044\u3002vault mounts\u3067\u3082\u540c\u69d8\u306e\u73fe\u8c61\u304c\u767a\u751f\u3057\u305f\u3002(-v0.1.2)\n\n\n\u53c2\u8003\uff1aCentOS 6\u3067libcurl.so\u3092\u5dee\u3057\u66ff\u3048\u308b\n\u4e0a\u8a18\u306eCentOS 6\u3067vault read\u304c\u4e0a\u624b\u304f\u884c\u304b\u306a\u3044\u3053\u3068\u304c\u3042\u3063\u305f\u969b\u306blibcurl.so\u306e\u5dee\u3057\u66ff\u3048\u3067\u89e3\u6c7a\u3057\u305f\u3053\u3068\u304c\u3042\u3063\u305f\u3002\n\u3057\u304b\u3057libcurl.so\u3092\u5dee\u3057\u66ff\u3048\u305a\u3068\u3082OS\u518d\u8d77\u52d5\u3067\u89e3\u6c7a\u3057\u3066\u3057\u307e\u3063\u305f\u306e\u3067\u3001\u73fe\u5728\u3053\u306e\u65b9\u6cd5\u306f\u63a1\u3063\u3066\u3044\u306a\u3044\u3002\n\u305f\u3060\u3057\u3001\u307e\u30601\u5ea6\u3057\u304b\u89e3\u6c7a\u306f\u884c\u308f\u308c\u3066\u3044\u306a\u3044\u306e\u3067\u3001\u3053\u306e\u5f8c\u3082\u540c\u3058\u3088\u3046\u306bOS\u518d\u8d77\u52d5\u3001\u3042\u308b\u3044\u306f\u5225\u306e\u3082\u3063\u3068\u7c21\u4fbf\u306a\u65b9\u6cd5\u3067\u89e3\u6c7a\u3059\u308b\u304b\u306f\u79c1\u306e\u74b0\u5883\u3067\u3082\u4e0d\u660e\u3067\u3042\u308b\u3002\nCentOS 6\u3067HTTPS\u63a5\u7d9a\u6642\u306bvault read\u304c\u30a8\u30e9\u30fc\u306b\u306a\u3063\u305f\u305f\u3081\u30bd\u30fc\u30b9\u304b\u3089\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u305f\u3002\n\u305f\u3060\u3057\u3001\u3053\u306e\u65b9\u6cd5\u3067\u306f\u4eca\u5ea6\u306fyum\u304c\u4f7f\u3048\u306a\u304f\u306a\u3063\u305f\u306e\u3067\u30b3\u30f3\u30d1\u30a4\u30eb\u30aa\u30d7\u30b7\u30e7\u30f3\u306e\u5909\u66f4\u3067\u5bfe\u5fdc\u3067\u304d\u308b\u304b\u8abf\u67fb\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n# mkdir /tmp/curl\n# cd /tmp/curl\n# wget http://curl.haxx.se/download/curl-7.42.1.tar.gz\n# tar xvf curl-7.42.1.tar.gz\n# cd curl-7.42.1/\n# yum install gcc\n# ./configure\n# make\n# make install\n# cp /usr/local/lib/libcurl.so.4.3.0 /usr/lib64\n# ln -sf /usr/lib64/libcurl.so.4.3.0 /usr/lib64/libcurl.so.4\n\n# Vault\u3063\u3066\u4f55\uff1f\n\n[Vault](https://www.vaultproject.io/)\u306fHashicorp\u304c\u767a\u8868\u3057\u305f\u6a5f\u5bc6\u60c5\u5831\u7ba1\u7406\u30c4\u30fc\u30eb\u3067\u3042\u308b\u3002\n\u8a73\u7d30\u306f\u3044\u304f\u3089\u304b\u65e5\u672c\u8a9e\u60c5\u5831\u304c\u3042\u308b\u306e\u3067\u305d\u3061\u3089\u3092\u53c2\u7167\u306e\u3053\u3068\u3002\n\n* http://pocketstudio.jp/log3/2015/04/29/vault/\n* http://kiririmode.hatenablog.jp/entry/20150429/1430279218\n\n# \u4eca\u56de\u3084\u308b\u3053\u3068\n\nVault\u306fConsul\u3092storage backend\u306b\u3059\u308b\u3053\u3068\u306b\u3088\u308aHA\u69cb\u6210\u3092\u53d6\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3001\u3068[\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](http://vaultproject.io/docs/config/index.html)\u306b\u66f8\u3044\u3066\u3042\u3063\u305f\u306e\u3067\u8a66\u3057\u3066\u307f\u308b\u3053\u3068\u306b\u3057\u305f\u3002\n\n\u4eca\u56de\u3001Vault\u30b5\u30fc\u30d0\u3068\u306a\u308b\u30b3\u30f3\u30d4\u30e5\u30fc\u30bf\u306fConsul\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3067\u3082\u3042\u308b\u3053\u3068\u3068\u3059\u308b\u3002\n\u3053\u308c\u306f\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3067Consul\u306e\u30a2\u30c9\u30ec\u30b9\u3092\u6307\u5b9a\u3059\u308b\u7b87\u6240\u3060\u3051\u306b\u5f71\u97ff\u3059\u308b\u3002\n\nVault\u30b5\u30fc\u30d0\u306f2\u53f0\u7acb\u3066\u308b\u3053\u3068\u306b\u3059\u308b\u3002\n10.0.2.167(hostname: cc6)\u306fCentOS 6\u300110.0.2.170(hostname: cc7)\u306fCentOS 7\u3067\u3042\u308b\u3002\n\u307e\u305f\u3053\u3061\u3089\u306e\u74b0\u5883\u3067\u4eca\u7acb\u3066\u3089\u308c\u308b\u53f0\u6570\u306e\u90fd\u5408\u3067\u30b5\u30fc\u30d0\u306b\u306a\u3063\u305f\u30b3\u30f3\u30d4\u30e5\u30fc\u30bf\u306b\u306f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3082\u517c\u306d\u3066\u3082\u3089\u3046\u3053\u3068\u306b\u3057\u305f\u304c\u3001\u5225\u3005\u306b\u3057\u3066\u3082\u554f\u984c\u306a\u3044\uff08\u306f\u305a\uff09\u3002\n\nstorage backend\u306f[\u3053\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](http://vaultproject.io/docs/internals/architecture.html)\u306b\u66f8\u304b\u308c\u3066\u3044\u308b\u7528\u8a9e\u3060\u304c\u3001\u540c\u3058\u3082\u306e\u3092\u6307\u3059\u8a00\u8449\u3068\u3057\u3066[physical backend\u3068\u3044\u3046\u8868\u73fe\u3082\u898b\u305f\u3053\u3068\u304c\u3042\u308b](https://twitter.com/mitchellh/status/597833528173142016)\u3002\n\n\u307e\u305fConsul\u306fstorage backend\u4ee5\u5916\u306b\u3082secret backend\u306b\u3082\u306a\u308b\u3002\nsecret backend\u3068\u3059\u308b\u65b9\u6cd5\u306f\u3044\u3044\u52a0\u6e1b\u9577\u304f\u306a\u308b\u306e\u3067[\u5225\u8a18\u4e8b](http://qiita.com/yunano/items/931448a590c7f346ed01)\u306b\u3057\u305f\u3002\n\n\u3053\u306e\u8a18\u4e8b\u306fVault\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u306f0.1.0\u3001Consul\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u306f0.5.0\u306e\u6642\u70b9\u3067\u66f8\u304d\u59cb\u3081\u305f\u304c\u3001Vault 0.1.2\u306b\u5bfe\u5fdc\u3059\u308b\u3088\u3046\u66f8\u304d\u76f4\u3057\u3066\u3044\u308b\u3002\n\n# Vault\u30b5\u30fc\u30d0\u3092\u8d77\u52d5\u3059\u308b\n\nVault\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3002\n\n```\n# wget https://dl.bintray.com/mitchellh/vault/vault_0.1.2_linux_amd64.zip\n# unzip vault_0.1.2_linux_amd64.zip -d /usr/local/sbin\n```\n\nVault\u304c\u4f7f\u30468200/tcp\u306e\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u3092\u958b\u3051\u3066\u304a\u304f\u3002\nCentOS 6\u3067iptables\u3092\u4f7f\u3063\u3066\u3044\u308b\u5834\u5408\u3060\u3068\u3001\n\n```\n# iptables -I INPUT 5 -m state --state NEW -p tcp --dport 8200 -j ACCEPT\n# service iptables save\n```\n\nCentOS 7\u3067firewalld\u3092\u4f7f\u3063\u3066\u3044\u308b\u5834\u5408\u3060\u3068\u3001\n\n```\n# firewall-cmd --add-port=8200/tcp\n# firewall-cmd --add-port=8200/tcp --permanent\n```\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u7f6e\u304f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u308a\u3001\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb /etc/vault.d/server.hcl \u3092\u4f5c\u6210\u3059\u308b\u3002\n\u6b21\u306fHTTP\u63a5\u7d9a\u3068\u3059\u308b\u5834\u5408\u3067\u3042\u308b\u3002HTTPS\u63a5\u7d9a\u3068\u3059\u308b\u5834\u5408\u306b\u3064\u3044\u3066\u306f\u5f8c\u8ff0\u3059\u308b\u3002\n\n```\n# mkdir /etc/vault.d\n```\n\n```/etc/vault.d/server.hcl\nbackend \"consul\" {\n  advertise_addr = \"http://10.0.2.167:8200\"\n}\n\nlistener \"tcp\" {\n  address = \"0.0.0.0:8200\"\n  tls_disable = 1\n}\n```\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u4e2d\u8eab\u3092\u8efd\u304f\u8aac\u660e\u3059\u308b\u3068\u3001backend \"consul\" {}\u306e\u4e2d\u306b\u3064\u3044\u3066\u306f\u3001\n\n* advertise_addr\u306f\u4ed6\u306eVault\u304b\u3089\u30a2\u30af\u30bb\u30b9\u3059\u308b\u969b\u306e\u81ea\u5206\u306e\u30a2\u30c9\u30ec\u30b9\u3002\nConsul\u3092\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306b\u3059\u308b\u5834\u5408\uff08\u3064\u307e\u308a\u3001HA\u69cb\u6210\u306b\u3059\u308b\u5834\u5408\uff09\u306b\u306f\u5fc5\u9808\u3002v0.1.0\u3067\u306f\u3053\u306e\u9805\u76ee\u306b\u306f\u30db\u30b9\u30c8\u540d\u304bIP\u30a2\u30c9\u30ec\u30b9\u3060\u3051\u3092\u8a18\u8ff0\u3057\u3066\u3044\u305f\u304c\u3001v0.1.1\u304b\u3089Vault\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304c\u81ea\u52d5\u3067\u63a5\u7d9a\u5148\u3092\u5207\u308a\u66ff\u3048\u308b\u969b\u306e\u30a2\u30c9\u30ec\u30b9\u3068\u3057\u3066\u53c2\u7167\u3055\u308c\u308b\u305f\u3081\u3001`http://10.0.2.167:8200`\u306e\u3088\u3046\u306a\u8a18\u8ff0\u3092\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n* address\u3067Consul\u306e\u30a2\u30c9\u30ec\u30b9\u3068\u30dd\u30fc\u30c8\u3092\u6307\u5b9a\u3067\u304d\u308b\u306e\u3060\u304c\u3001\u7701\u7565\u6642\u306flocalhost:8500\u3067\u3042\u308b\u3002\n\u3064\u307e\u308a\u81ea\u5206\u304cConsul\u306e\u30b5\u30fc\u30d0\u304b\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u306a\u3063\u3066\u304a\u308a\u3001\u308f\u3056\u308f\u3056\u30dd\u30fc\u30c8\u756a\u53f7\u3092\u5909\u3048\u3066\u3044\u306a\u3051\u308c\u3070\u7701\u7565\u3067\u304d\u308b\u3002\n\nlistener \"tcp\" {}\u306e\u4e2d\u306b\u3064\u3044\u3066\u306f\u3001\n\n* address\u306fVault\u306e\u5f85\u3061\u53d7\u3051\u30a2\u30c9\u30ec\u30b9\u3068\u30dd\u30fc\u30c8\u3002\n* tls_disable\u306f\u5024\u304c\u7a7a\u3067\u306a\u3044\u5834\u5408\u3001HTTP\u63a5\u7d9a\u306b\u3059\u308b\u3002\n\n\u3053\u306e\u524d[Consul\u306eCentOS 6\u3067\u52d5\u4f5c\u78ba\u8a8d\u3057\u305finit\u30b9\u30af\u30ea\u30d7\u30c8\u3068CentOS 7\u3067\u52d5\u4f5c\u78ba\u8a8d\u3057\u305fsystemd\u30e6\u30cb\u30c3\u30c8\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u305f](http://qiita.com/yunano/items/7ef5fa5670721de55627)\u306e\u3067\u3001\u4f3c\u305f\u3088\u3046\u306a\u611f\u3058\u3067Vault\u306e\u3082\u306e\u3082\u4f5c\u3063\u3066\u307f\u305f\u3002\n\n[CentOS 6\u7528\u306einit\u30b9\u30af\u30ea\u30d7\u30c8](https://gist.github.com/yunano/c4e641bad3fb9f78d6cf)\u306f /etc/init.d/vault \u306b\u914d\u7f6e\u3057\u3066\u3001\n\n```\n# chmod 755 /etc/init.d/vault\n# chkconfig --add vault\n# service vault start\n```\n\n[CentOS 7\u7528\u306esystemd\u30e6\u30cb\u30c3\u30c8\u30d5\u30a1\u30a4\u30eb](https://gist.github.com/yunano/66caf8c5ed993bb2f4e3)\u306f /etc/systemd/system/vault.service \u306b\u914d\u7f6e\u3057\u3066\u3001\n\n```\n# systemctl daemon-reload\n# systemctl enable vault.service\n# systemctl start vault.service\n```\n\n\u3053\u308c\u3067Vault\u30b5\u30fc\u30d0\u304c\u8d77\u52d5\u3057\u305f\u3002\n\u305f\u3060\u3057\u5f8c\u8ff0\u3059\u308b\u304c\u30012\u53f0\u76ee\u4ee5\u964d\u3092\u8d77\u52d5\u3059\u308b\u306e\u306f`vault init`\u3092\u5b9f\u884c\u3057\u305f\u5f8c\u3067\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u3002\n\n## HTTPS\u63a5\u7d9a\u306b\u3059\u308b\u5834\u5408\n\nVault 0.1.0\u3060\u3068HTTPS\u63a5\u7d9a\u304c\u4e0a\u624b\u304f\u884c\u304b\u306a\u304b\u3063\u305f\u304c\u30010.1.1\u3067\u306f\u307b\u307c\u554f\u984c\u306a\u304f\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u3002\n\uff08CentOS 6\u3067`vault read`\u304c\u4e0a\u624b\u304f\u884c\u304b\u306a\u3044\u3053\u3068\u304c\u3042\u3063\u305f\u3002\u4f55\u304c\u30c8\u30ea\u30ac\u30fc\u306b\u306a\u3063\u3066\u89e3\u6c7a\u3057\u305f\u306e\u304b\u306f\u5b9f\u969b\u306b\u306f\u308f\u304b\u3089\u306a\u3044\u304c\u3001\u79c1\u306e\u74b0\u5883\u3067\u306fOS\u518d\u8d77\u52d5\u5f8c\u306b\u554f\u984c\u304c\u89e3\u6d88\u3057\u305f\uff09\n\u306a\u304aHTTPS\u63a5\u7d9a\u306b\u3059\u308b\u3068\u3001\u30ed\u30b0\u306bTLS handshake error\u306a\u3093\u3066\u30a8\u30e9\u30fc\u304c5\u79d2\u3054\u3068\u306b(\u30b5\u30fc\u30d0\u53f0\u6570+1)\u3060\u3051\u51fa\u529b\u3055\u308c\u308b\u306e\u306f\u6c17\u306b\u306a\u308b\u3002\u5b9f\u30d5\u30a1\u30a4\u30eb\u306b\u66f8\u304d\u51fa\u3057\u3066\u3044\u308b\u306a\u3089\u30ed\u30b0\u30ed\u30fc\u30c6\u30fc\u30c8\u304c\u5fc5\u8981\u306b\u306a\u308b\u7a0b\u5ea6\u306b\u306f\u306a\u308b\u3002\n\nHTTPS\u63a5\u7d9a\u306b\u3059\u308b\u5834\u5408\u3001\u8ffd\u52a0\u4f5c\u696d\u304c\u3044\u304f\u3089\u304b\u5fc5\u8981\u306b\u306a\u308b\u3002\nVault\u30b5\u30fc\u30d0\u3001Vault\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3068\u3082\u306bConsul\u30b5\u30fc\u30d0\u304b\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3067\u3042\u308b\u3082\u306e\u3068\u3059\u308b\u3002\n\n\u307e\u305a\u8a3c\u660e\u66f8\u306e\u30b3\u30e2\u30f3\u30cd\u30fc\u30e0\u306b\u30db\u30b9\u30c8\u540d\u304c\u4f7f\u3048\u308b\u3088\u3046\u3001Vault\u30b5\u30fc\u30d0\u3001Vault\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304cConsul\u304c\u63d0\u4f9b\u3059\u308bDNS\u30b5\u30fc\u30d0\u306b\u554f\u3044\u5408\u308f\u305b\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u3002\n\nConsul\u306f8600/udp\u3067DNS\u30b5\u30fc\u30d0\u3092\u63d0\u4f9b\u3057\u3066\u3044\u308b\u306e\u3067\u3001localhost\u306e53/udp\u3078\u306e\u63a5\u7d9a\u30928600/udp\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3059\u308b\u3088\u3046\u306b\u3059\u308b\u3002\n\nCentOS 6\u3060\u3068\u6b21\u306e\u901a\u308a\u3002\n\n```\n# iptables -t nat -A OUTPUT -p udp -o lo --dport 53 -j REDIRECT --to-ports 8600\n# service iptables save\n```\n\nCentOS 7\u3060\u3068\u6b21\u306e\u901a\u308a\u3002\n\n```\n# firewall-cmd --direct --add-rule ipv4 nat OUTPUT 1 -p udp -o lo --dport 53 -j REDIRECT --to-ports 8600\n# firewall-cmd --permanent --direct --add-rule ipv4 nat OUTPUT 1 -p udp -o lo --dport 53 -j REDIRECT --to-ports 8600\n```\n\nCentOS 6\u3060\u3068 /etc/sysconfig/network-scripts/ifcfg-eth0 \u306b\u6b21\u3092\u8ffd\u52a0\u3057\u3066\u304b\u3089 /etc/resolv.conf \u306e\u65e2\u5b58\u306enameserver\u306e\u4e0a\u306b`nameserver 127.0.0.1`\u3092\u8ffd\u52a0\u3059\u308b\u3002\n\n```\nDNS1=127.0.0.1\nDNS2=<\u65e2\u5b58\u306eDNS\u30b5\u30fc\u30d0>\nPEERDNS=no\n```\n\nCentOS 7\u3060\u3068 /etc/resolv.conf \u3092\u76f4\u63a5\u89e6\u3089\u305a\u306b\u6b21\u3092\u5b9f\u884c\u3059\u308b\u306e\u304c\u826f\u3044\u304b\u306a\u3002\n\n```\n# nmcli connection modify enp0s3 ipv4.ignore-auto-dns yes ipv4.dns \"127.0.0.1 <\u65e2\u5b58\u306eDNS\u30b5\u30fc\u30d0>\"\n# systemctl restart NetworkManager.service\n```\n\nifcfg-eth0(CentOS 6)\u3084enp0s3(CentOS 7)\u306f\u5404\u81ea\u306e\u74b0\u5883\u306b\u5408\u308f\u305b\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\n\u8a3c\u660e\u66f8\u306a\u3093\u3066\u306a\u3044\u3001\u3068\u3044\u3046\u5834\u5408\u306f\u81ea\u5df1\u7f72\u540d\u8a3c\u660e\u66f8\u3092\u4f5c\u308b\u3002\n\u79c1\u304c\u81ea\u5df1\u7f72\u540d\u8a3c\u660e\u66f8\u3092\u4f5c\u308b\u5834\u5408\u3001\u6b21\u306e\u3088\u3046\u306a\u624b\u9806\u3067\u4f5c\u3063\u3066\u3044\u308b\u3002\n\n```\n# mkdir /etc/pki/tls/self\n# cd /etc/pki/tls/self\n# cp /etc/pki/tls/openssl.cnf ./openssl.node.cnf\n```\n\n```/etc/pki/tls/self/openssl.node.cnf\n# \u30a8\u30c7\u30a3\u30bf\u306a\u3069\u3067\u4ee5\u4e0b\u3092\u4fee\u6b63\u3059\u308b\n\n[ CA_default ]\n# \u8a3c\u660e\u66f8\u306e\u5bff\u547d\u3092365\u65e5\u304b\u30893650\u65e5\u306b\u5909\u66f4\ndefault_days = 3650\n\n[ req ]\n# attributes\u884c\u3092\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3057\u3066prompt = no\u3092\u8ffd\u52a0\n#attributes = req_attributes\nprompt = no\n\n[ req_distinguished_name ]\n# req_distinguished_name\u306e\u4e2d\u306f\u5168\u90e8\u6d88\u3057\u3066\u304b\u3089\u4ee5\u4e0b\u3092\u8ffd\u52a0\nC = JP\nST = Tokyo\nL = Tokyo\nO = consul\nOU = admin\nCN = *.node.consul\n```\n\n```\n# sha512sum /proc/vmstat | awk '{ print $1 }' > sha512.dat\n# openssl genrsa -rand sha512.dat -out node.key -passout pass:$(cat sha512.dat) -aes256 2048\n# openssl rsa -in node.key -passin pass:$(cat sha512.dat) -out node.key\n# openssl req -new -config openssl.node.cnf -key node.key -out node.csr\n# openssl x509 -in node.csr -days 3650 -req -signkey node.key -out node.crt\n# rm -f sha512.dat node.csr\n```\n\n\u4f5c\u6210\u3055\u308c\u305f\u79d8\u5bc6\u9375node.key\u3068\u30b5\u30fc\u30d0\u8a3c\u660e\u66f8node.crt\u306f\u3059\u3079\u3066\u306eVault\u30b5\u30fc\u30d0\u306b\u914d\u7f6e\u3059\u308b\u3002\nnode.crt\u306f\u3059\u3079\u3066\u306eVault\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u3082\u914d\u7f6e\u3059\u308b\u3002\n\nVault\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb /etc/vault.d/server.hcl \u306f\u6b21\u306e\u3088\u3046\u306b\u306a\u308b\u3002\n\n```/etc/vault.d/server.hcl\nbackend \"consul\" {\n  advertise_addr = \"https://cc6.node.consul:8200\"\n}\n\nlistener \"tcp\" {\n  address = \"0.0.0.0:8200\"\n  tls_cert_file = \"/etc/pki/tls/self/node.crt\"\n  tls_key_file = \"/etc/pki/tls/self/node.key\"\n}\n```\n\nConsul\u3092DNS\u30b5\u30fc\u30d0\u3068\u3057\u3066\u53c2\u7167\u3059\u308b\u3053\u3068\u306b\u3088\u308a\u3001`<\u30db\u30b9\u30c8\u540d>.node.consul`\u3067\u81ea\u5206\u306b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u3067\u3001advertise_addr\u306b\u306f\u3053\u306e\u540d\u524d\u3092\u4f7f\u3063\u3066\u8a2d\u5b9a\u3059\u308b\u3002\u8a3c\u660e\u66f8\u306e\u30b3\u30e2\u30f3\u30cd\u30fc\u30e0(CN)\u306b`*.node.consul`\u3092\u8a2d\u5b9a\u3057\u305f\u306e\u306f\u3053\u306e\u305f\u3081\u3067\u3042\u308b\u3002\ntls_cert_file\u306b\u306f\u30b5\u30fc\u30d0\u8a3c\u660e\u66f8\u3078\u306e\u30d1\u30b9\u3001tls_key_file\u306b\u306f\u79d8\u5bc6\u9375\u3078\u306e\u30d1\u30b9\u3092\u8a2d\u5b9a\u3059\u308b\u3002\n\n\u4ed6\u306e\u4f5c\u696d\u306fHTTP\u63a5\u7d9a\u306e\u5834\u5408\u3068\u5909\u308f\u3089\u306a\u3044\u3002\n\n# Vault\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u306e\u64cd\u4f5c\n\n\u4eca\u56deVault\u306f\u30b5\u30fc\u30d0\u3068\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3092\u517c\u306d\u3066\u3044\u308b\u306e\u3067\u3001HTTP\u63a5\u7d9a\u306e\u5834\u5408\u306f2\u53f0\u3068\u3082\u74b0\u5883\u5909\u6570VAULT_ADDR\u306bhttp\u3067\u30eb\u30fc\u30d7\u30d0\u30c3\u30af\u30a2\u30c9\u30ec\u30b9\u3092\u6307\u5b9a\u3057\u3066\u304a\u304f\u3002\n\u30b5\u30fc\u30d0\u3068\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304c\u9055\u3046\u30b3\u30f3\u30d4\u30e5\u30fc\u30bf\u306a\u3089\u3070Vault\u30b5\u30fc\u30d0\u306e\u30a2\u30c9\u30ec\u30b9\u3092\u6307\u5b9a\u3059\u308c\u3070\u826f\u3044\u3002\n\n```\n# export VAULT_ADDR='http://127.0.0.1:8200'\n```\n\nHTTPS\u63a5\u7d9a\u306e\u5834\u5408\u306f`https://<\u81ea\u5206\u306e\u30de\u30b7\u30f3\u540d>.node.consul:8200`\u3092\u6307\u5b9a\u3059\u308b\u3002\n\n```\n# export VAULT_ADDR='https://cc6.node.consul:8200'\n```\n\n\u307e\u305fHTTPS\u63a5\u7d9a\u306e\u5834\u5408\u3001\u4ee5\u964d\u306evault\u30b3\u30de\u30f3\u30c9\u3067\u306f\u30b5\u30fc\u30d0\u8a3c\u660e\u66f8\u3078\u306e\u30d1\u30b9\u3092\u6307\u5b9a\u3059\u308b\u30aa\u30d7\u30b7\u30e7\u30f3`-ca-cert /etc/pki/tls/self/node.crt`\u3092\u6307\u5b9a\u3059\u308b\uff08\u4f8b\uff1a`vault read -ca-cert /etc/pki/tls/self/node.crt secret/test`\uff09\u3002\n\n\u3042\u308b\u3044\u306f\u4f5c\u6210\u3057\u305f\u30b5\u30fc\u30d0\u8a3c\u660e\u66f8\u3092\u4fe1\u983c\u3059\u308b\u8a3c\u660e\u66f8\u306b\u52a0\u3048\u308b\u3002\n\n```\n# update-ca-trust enable # CentOS 7\u3067\u306f\u521d\u671f\u72b6\u614b\u3067enable\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u3067\u5b9f\u884c\u4e0d\u8981\n# ln -s /etc/pki/tls/self/node.crt /etc/pki/ca-trust/source/anchors/\n# update-ca-trust extract\n```\n\n\u307e\u305a\u306fVault\u306e\u521d\u671f\u5316\u3002\n\u3053\u308c\u3092\u5b9f\u884c\u3059\u308b\u30685\u3064\u306eKey\u3001\u304a\u3088\u3073Initial Root Token\u304c\u8868\u793a\u3055\u308c\u308b\u3002\n\u3053\u308c\u3089\u3092\u306a\u304f\u3059\u3068\u30a2\u30af\u30bb\u30b9\u3067\u304d\u306a\u304f\u306a\u308b\u306e\u3067\u6ce8\u610f\u3002\n\u767a\u884c\u3055\u308c\u308bKey\u306e\u6570\u306f-key-shares\u30aa\u30d7\u30b7\u30e7\u30f3\u3067\u5909\u66f4\u3067\u304d\u308b\u3002\n\u3053\u306e\u4f5c\u696d\u306fVault\u306eHA\u69cb\u6210\u30af\u30e9\u30b9\u30bf\u306e\u4e2d\u30671\u56de\u3060\u3051\u884c\u3048\u3070\u826f\u3044\u3002\n\n```\n# vault init\n```\n\n\u306a\u304a\u3001Vault\u3092HA\u69cb\u6210\u306b\u3059\u308b\u5834\u5408\u306f\u300c1\u53f0\u76ee\u306e\u8d77\u52d5\u2192vault init\u21922\u53f0\u76ee\u4ee5\u964d\u306e\u8d77\u52d5\u300d\u306e\u9806\u3067\u884c\u3046\u3002\n\u5171\u6709\u30c7\u30fc\u30bf\u306f`vault init`\u306e\u969b\u306b\u4f5c\u6210\u3055\u308c\u308b\u306e\u3067\u3001\u305d\u306e\u524d\u306b2\u53f0\u76ee\u4ee5\u964d\u3092\u8d77\u52d5\u3057\u3066\u3082HA\u69cb\u6210\u306b\u306a\u3089\u306a\u3044\u304b\u3089\u3067\u3042\u308b\u3002\n\nVault\u30b5\u30fc\u30d0\u3092\u53d7\u3051\u4ed8\u3051\u53ef\u80fd\u306a\u72b6\u614b\u306b\u3059\u308b\u306b\u306funseal\u3068\u3044\u3046\u4f5c\u696d\u3092\u884c\u3046\u3002\n\u6b21\u306e\u901a\u308a3\u56de\u5b9f\u884c\u3057\u3001vault init\u3067\u5f97\u305fKey\u306e\u3046\u30613\u3064\u3092\u5165\u529b\u3059\u308b\u3068\u53d7\u3051\u4ed8\u3051\u53ef\u80fd\u72b6\u614b\u306b\u306a\u308b\u3002\n\u3053\u306e\u56de\u6570\u306fvault init\u6642\u306e-key-threshold\u30aa\u30d7\u30b7\u30e7\u30f3\u3067\u5909\u66f4\u3067\u304d\u308b\u3002\n\u3053\u306e\u4f5c\u696d\u306fVault\u30b5\u30fc\u30d01\u53f0\u3054\u3068\u306b\u5b9f\u884c\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u3001\u307e\u305fVault\u30b5\u30fc\u30d0\u304c\u4e00\u65e6\u505c\u6b62\u3057\u3066\u518d\u8d77\u52d5\u3057\u305f\u5834\u5408\u306b\u3082\u5b9f\u884c\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\n```\n# vault unseal\n# vault unseal\n# vault unseal\n```\n\nvault unseal\u306f\u5f15\u6570\u306a\u3057\u3067\u5b9f\u884c\u3059\u308b\u3068Key\u3092\u5bfe\u8a71\u5f0f\u3067\u5165\u529b\u3059\u308b\u3053\u3068\u306b\u306a\u308b\u3002\nKey\u3092\u5f15\u6570\u306b\u3057\u3066\u5b9f\u884c\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u308b\u306e\u3067\u30b9\u30af\u30ea\u30d7\u30c8\u5185\u3067\u5b9f\u884c\u3059\u308b\u5834\u5408\u306a\u3069\u306f\u305d\u3046\u3059\u308b\u3068\u826f\u3044\u3002\n\nVault\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306e\u8a8d\u8a3c\u306fvault init\u3067\u5f97\u305fInitial Root Token\u3092\u4f7f\u3063\u3066\u884c\u3046\u3002\n\u3053\u308c\u306f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3054\u3068\u306b\u884c\u3046\u3002\n\u671f\u9650\u3068\u304b\u3042\u308a\u305d\u3046\u3060\u3051\u3069\u307e\u3060\u8abf\u3079\u3066\u3044\u306a\u3044\u3002\n\n```\n# vault auth 8c535adc-f7c7-32d7-09ae-14c32da1e6b6\n```\n\nvault auth\u306e\u5b9f\u884c\u6642\u306b\u30db\u30fc\u30e0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e .vault-token \u3068\u3044\u3046\u30d5\u30a1\u30a4\u30eb\u306bToken\u304c\u66f8\u304d\u8fbc\u307e\u308c\u3066\u3001\u4ee5\u964d\u306evault\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5b9f\u884c\u6642\u306b\u3053\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u53c2\u7167\u3059\u308b\u3053\u3068\u3067\u6bce\u56de\u306eToken\u306e\u5165\u529b\u3092\u4e0d\u8981\u306b\u3059\u308b\u4ed5\u7d44\u307f\u306e\u3088\u3046\u3060\u3002\n\n\uff08\u203b \u3053\u3053\u304b\u3089v0.1.0\u306e\u6642\u306e\u8a18\u8ff0\u3067\u3042\u308b\u3002v0.1.1\u3067\u306f\u63a5\u7d9a\u5148\u306evault\u30b5\u30fc\u30d0\u304cunseal\u3055\u308c\u3066\u3044\u308c\u3070vault\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304c\u81ea\u52d5\u3067active\u306e\u65b9\u3078\u7e4b\u304e\u306b\u884c\u304f\u3088\u3046\u306b\u306a\u3063\u305f\u306e\u3067\u4ee5\u4e0b\u306b\u8a18\u8ff0\u3059\u308b\u3088\u3046\u306a\u3053\u3068\u306f\u8d77\u3053\u3089\u306a\u3044\u3002\u3082\u3057standby\u5074\u306b\u7e4b\u3052\u3089\u308c\u308c\u3070\u540c\u3058\u3053\u3068\u304c\u8d77\u3053\u308b\u3068\u63a8\u6e2c\u3055\u308c\u308b\u306e\u3067\u53c2\u8003\u307e\u3067\u306b\u6b8b\u3057\u3066\u304a\u304f\u3002\u8981\u7d04\u3059\u308c\u3070HA\u69cb\u6210\u306e\u6642\u306f1\u53f0\u3060\u3051active\u3067\u4ed6\u306fstandby\u306b\u306a\u308b\u3001\u3068\u3044\u3046\u3053\u3068\u3067\u3042\u308b\uff09\n\n\u3057\u304b\u30572\u53f0\u76ee(10.0.2.170)\u3067vault auth\u3092\u5b9f\u884c\u3059\u308b\u3068`Error validating token: Get https:///v1/auth/token/lookup-self: http: no Host in request URL`\u3068\u3044\u3046\u30a8\u30e9\u30fc\u306b\u306a\u308b\u3002\n\n2\u53f0\u76ee\u3067vault status\u3092\u5b9f\u884c\u3057\u3066\u307f\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8868\u793a\u3055\u308c\u308b\u3002\n\n```\n# vault status\nSealed: false\nKey Shares: 5\nKey Threshold: 3\nUnseal Progress: 0\n\nHigh-Availability Enabled: true\n        Mode: standby\n        Leader: 10.0.2.167\n```\n\n\u3042\u3042\u3001\u3064\u307e\u308a2\u53f0\u76ee\u306fstandby\u3068\u3044\u3046\u3053\u3068\u304b\u3002\n[\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](http://vaultproject.io/docs/internals/high-availability.html)\u306b\u3082active\u306a\u306e\u306f1\u53f0\u3060\u3051\u3001\u3068\u66f8\u3044\u3066\u3042\u308b\u306e\u306f\u5f8c\u3067\u6c17\u4ed8\u3044\u305f\u3002\n1\u53f0\u76ee\u3067\u306fvault status\u3067\u6b21\u306e\u3088\u3046\u306b\u8868\u793a\u3055\u308c\u308b\u3002\n\n```\n# vault status\nSealed: false\nKey Shares: 5\nKey Threshold: 3\nUnseal Progress: 0\n\nHigh-Availability Enabled: true\n        Mode: active\n        Leader: 10.0.2.167\n```\n\n\u3068\u3044\u3046\u308f\u3051\u30671\u53f0\u76ee\u3067Vault\u306b\u66f8\u304d\u8fbc\u3093\u3067\u304b\u3089\u843d\u3068\u3057\u3066\u307f\u308b\u3002\n\n```\n# vault write secret/test aaa=bbb\n# service vault stop\n```\n\n40\u79d2\u7a0b\u5ea6\u7d4c\u3063\u3066\u304b\u30892\u53f0\u76ee\u306b\u5207\u308a\u66ff\u308f\u3063\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u305f\u3002\n\n```\n# vault status\nSealed: false\nKey Shares: 5\nKey Threshold: 3\nUnseal Progress: 0\n\nHigh-Availability Enabled: true\n        Mode: active\n        Leader: 10.0.2.170\n```\n\n2\u53f0\u76ee\u3067vault auth\u3082\u901a\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u3057\u3001\u5148\u7a0bVault\u306b\u4fdd\u5b58\u3057\u305f\u60c5\u5831\u3082\u8aad\u3081\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\n```\n# vault auth 8c535adc-f7c7-32d7-09ae-14c32da1e6b6\nSuccessfully authenticated! The policies that are associated\nwith this token are listed below:\n\nroot\n```\n\n```\n# vault read secret/test\nKey             Value\nlease_id        secret/test/71574acd-0ccf-238f-5c64-f3ad8d39becb\nlease_duration  2592000\naaa             bbb\n```\n\n\uff08\u203b v0.1.0\u306e\u6642\u306e\u8a18\u8ff0\u3053\u3053\u307e\u3067\uff09\n\nVault\u306fConsul\u306b\u5207\u308a\u66ff\u3048\u306e\u305f\u3081\u306e\u554f\u3044\u5408\u308f\u305b\u3092\u3057\u3066\u3044\u308b\u3088\u3046\u3067\u30018200/tcp\u306b\u3064\u3044\u3066\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u304c2\u53f0\u9593\u3067\u958b\u3044\u3066\u306a\u304f\u3066\u3082\u5207\u308a\u66ff\u3048\u306f\u53ef\u80fd\u3067\u3042\u3063\u305f\u3002\n\n# \u30c7\u30fc\u30bf\u306fConsul\u306e\u3069\u3053\u306b\u4fdd\u5b58\u3055\u308c\u3066\u3044\u308b\u306e\u304b\n\nConsul\u306e\u30ad\u30fc\u30d0\u30ea\u30e5\u30fc\u30b9\u30c8\u30a2\u306evault\u3068\u3044\u3046\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u4fdd\u5b58\u3055\u308c\u3066\u3044\u308b\u3002\n\u3053\u306evault\u3068\u3044\u3046\u540d\u524d\u306f\u8a2d\u5b9a\u3067\u5909\u66f4\u53ef\u80fd\u3067\u3042\u308b\uff08backend \"consul\"\u306epath\u30aa\u30d7\u30b7\u30e7\u30f3\uff09\u3002\n\nv0.1.1\u307e\u3067\u306fcore/lock\u3068\u3044\u3046\u30ad\u30fc\u3082\u3067\u304d\u3066\u3044\u305f\u304c\u30d0\u30b0\u3060\u3063\u305f\u3088\u3046\u3067\u3001v0.1.2\u304b\u3089vault\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u5185\u306b\u66f8\u304b\u308c\u308b\u3088\u3046\u306b\u306a\u3063\u305f(vault/core/lock)\u3002\n\n# Vault\u30b5\u30fc\u30d0\u306eactive\u5074\u3078\u306e\u81ea\u52d5\u5207\u308a\u66ff\u3048\n\n\u4ee5\u4e0b\u3067\u306fHAProxy\u3092\u4f7f\u3046\u65b9\u6cd5\u3068Consul\u3092\u4f7f\u3046\u65b9\u6cd5\u3092\u8a18\u8ff0\u3059\u308b\u3002\n\u73fe\u5728\u306f\uff08\u5f8c\u304b\u3089\u6c17\u4ed8\u3044\u305f\uff09Consul\u3092\u4f7f\u3046\u65b9\u6cd5\u3092\u4f7f\u7528\u3057\u3066\u3044\u308b\u3002\n\n## HAProxy\u306b\u3088\u308b\u81ea\u52d5\u5207\u308a\u66ff\u3048\n\n\uff08\u203b \u3053\u306e\u7ae0\u306e\u8a18\u8ff0\u306fHTTPS\u63a5\u7d9a\u306e\u7b87\u6240\u3092\u9664\u304dv0.1.0\u5f53\u6642\u306e\u3082\u306e\u305d\u306e\u307e\u307e\u306a\u306e\u3067\u3001\u73fe\u5728\u3068\u306f\u4e00\u90e8\u51fa\u529b\u5185\u5bb9\u304c\u7570\u306a\u308b\u7b87\u6240\u304c\u3042\u308b\uff09\n\nVault\u304cHA\u69cb\u6210\u3092\u53d6\u308b\u3068active/standby\u306b\u306a\u308b\u3053\u3068\u304c\u308f\u304b\u3063\u305f\u3002\n\u305d\u306e\u305f\u3081\u3001Vault\u30b5\u30fc\u30d0\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u305f\u3081\u306b\u306f\u3001\u5e38\u306bactive\u5074\u306b\u30a2\u30af\u30bb\u30b9\u3055\u305b\u308b\u4ed5\u7d44\u307f\u304c\u5225\u9014\u5fc5\u8981\u306b\u306a\u308b\u3002\n\uff08v0.1.1\u3067\u306f\u63a5\u7d9a\u5148\u306eVault\u30b5\u30fc\u30d0\u304cstandby\u3067\u3082\u81ea\u52d5\u3067active\u5074\u306b\u63a5\u7d9a\u3057\u76f4\u3057\u3066\u304f\u308c\u308b\u304c\u3001\u8d77\u52d5\u3057\u3066\u3044\u306a\u304b\u3063\u305f\u308aseal\u3055\u308c\u3066\u3044\u305f\u308a\u3059\u308b\u3068\u305d\u3046\u306f\u3044\u304b\u306a\u3044\uff09\n\u305d\u3053\u3067HAProxy\u3092\u4f7f\u3046\u3053\u3068\u306b\u3059\u308b\u3002\n\n### HAProxy\u306e\u6e96\u5099\n\nHAProxy\u3092Vault\u30b5\u30fc\u30d0\u5074\u306b\u5165\u308c\u308b\u3068HAProxy\u306e\u5197\u9577\u5316\u3068\u304b\u8003\u3048\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u306e\u3067\u3001\u3053\u3053\u3067\u306f\u305d\u308c\u3092\u7701\u7565\u3059\u3079\u304fVault\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u306b\u5165\u308c\u308b\u3053\u3068\u3068\u3059\u308b\u3002\n\uff08\u307e\u3042\u5b9f\u969b\u306b\u306f\u3001\u3053\u306e\u8cc7\u6599\u3067\u306fVault\u30b5\u30fc\u30d0\u3068Vault\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306f\u540c\u3058\u30b3\u30f3\u30d4\u30e5\u30fc\u30bf\u306b\u306a\u3063\u3066\u308b\u3051\u3069\u3001\u5225\u3005\u306b\u3057\u3066\u3044\u308b\u3068\u307f\u306a\u3059\u3082\u306e\u3068\u3057\u3066\uff09\n\nHAProxy\u3068socat\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3002\nCentOS 6\u3060\u3068socat\u306fEPEL\u306b\u3042\u308b\u306e\u3067\u3001\u6b21\u3088\u308a\u5148\u306b`yum install epel-release`\u3092\u5b9f\u884c\u3059\u308b\u3002\n\n```\n# yum install haproxy socat\n```\n\nCentOS 7\u3067SELinux\u304c\u6709\u52b9\u3060\u3068HAProxy\u304c\u30dd\u30fc\u30c8\u3092bind\u3067\u304d\u306a\u3044\uff08`systemctl status haproxy.service -l`\u3067`cannot bind socket`\u3068\u3044\u3046\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u51fa\u529b\u3055\u308c\u3066\u3044\u308b\u306e\u304c\u308f\u304b\u308b\uff09\u306e\u3067HAProxy\u8d77\u52d5\u524d\u306b\u6b21\u3092\u5b9f\u884c\u3059\u308b\u3002\n\n```\n# setsebool -P haproxy_connect_any on\n```\n\nHAProxy\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb /etc/haproxy/haproxy.cfg \u3092\u6b21\u306e\u3088\u3046\u306a\u5185\u5bb9\u3067\u4f5c\u308b\u3002\n\u6b21\u306fHTTP\u63a5\u7d9a\u3068\u3059\u308b\u5834\u5408\u3067\u3042\u308b\u3002HTTPS\u63a5\u7d9a\u3068\u3059\u308b\u5834\u5408\u306b\u3064\u3044\u3066\u306f\u5f8c\u8ff0\u3059\u308b\u3002\n\u306a\u304a\u3001global\u5185\u3068defaults\u5185\u306f\u521d\u671f\u306e /etc/haproxy/haproxy.cfg \u3068\u540c\u3058\u8a2d\u5b9a\u5185\u5bb9\u3067\u3042\u308a\u3001\u65b0\u3057\u304f\u8ffd\u52a0\u3057\u305f\u306e\u306flisten\u306e\u7b87\u6240\u3060\u3051\u3067\u3042\u308b\u3002\n\n```txt:/etc/haproxy/haproxy.cfg\nglobal\n    log         127.0.0.1 local2\n    chroot      /var/lib/haproxy\n    pidfile     /var/run/haproxy.pid\n    maxconn     4000\n    user        haproxy\n    group       haproxy\n    daemon\n    stats socket /var/lib/haproxy/stats\n\ndefaults\n    mode                    http\n    log                     global\n    option                  httplog\n    option                  dontlognull\n    option http-server-close\n    option forwardfor       except 127.0.0.0/8\n    option                  redispatch\n    retries                 3\n    timeout http-request    10s\n    timeout queue           1m\n    timeout connect         10s\n    timeout client          1m\n    timeout server          1m\n    timeout http-keep-alive 10s\n    timeout check           10s\n    maxconn                 3000\n\nlisten vault\n    bind 0.0.0.0:8210\n    option httpchk GET /v1/sys/health HTTP/1.1\n    server cc6 10.0.2.167:8200 check inter 5s fall 2 rise 1\n    server cc7 10.0.2.170:8200 check inter 5s fall 2 rise 1\n```\n\nbind\u3059\u308b\u30dd\u30fc\u30c8\u306f\u3001\u3053\u306e\u74b0\u5883\u3067\u306fVault\u30b5\u30fc\u30d0\u3068\u540c\u5c45\u3057\u3066\u3044\u308b\u306e\u30678200\u304c\u4f7f\u3048\u306a\u3044\u305f\u30818210\u3068\u3057\u3066\u307f\u305f\u3002\u4f7f\u3048\u308b\u756a\u53f7\u306a\u3089\u4f55\u3067\u3082\u826f\u3044\u3060\u308d\u3046\u3002\n\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u5bfe\u8c61\u306eURL\u306f[/v1/sys/health](http://vaultproject.io/docs/http/sys-health.html)\u304c\u826f\u3055\u305d\u3046\u3060\u3063\u305f\u306e\u3067\u3053\u308c\u3092\u9078\u3093\u3060\u3002\n\u3053\u308c\u306factive\u306a\u3089\u30b9\u30c6\u30fc\u30bf\u30b9\u30b3\u30fc\u30c9200\u3092\u3001standby\u306a\u3089429\u3092\u3001seal\u306a\u3089500\u3092\u8fd4\u3059\u3002\n\uff08seal\u72b6\u614b\u306eVault\u30b5\u30fc\u30d0\u306factive\u306b\u3082standby\u306b\u3082\u306a\u308c\u306a\u3044\uff09\n\u306a\u3093\u3067standby\u306f429(Too Many Requests)\u306a\u3093\u3060\u308d\u3046\uff1f \u3068\u3044\u3046\u306e\u306f\u3042\u308b\u304c\u3002\n\nCentOS 6\u3060\u3068\u6b21\u3067HAProxy\u3092\u8d77\u52d5\u3002\n\n```\n# chkconfig haproxy on\n# service haproxy start\n```\n\nCentOS 7\u3060\u3068\u6b21\u3067HAProxy\u3092\u8d77\u52d5\u3002\n\n```\n# systemctl enable haproxy.service\n# systemctl start haproxy.service\n```\n\n\u74b0\u5883\u5909\u6570VAULT_ADDR\u3092\u5909\u66f4\u3057\u3066\u63a5\u7d9a\u5148\u3092HAProxy\u304c\u958b\u3051\u3066\u3044\u308b\u30dd\u30fc\u30c8\u306b\u5909\u3048\u308b\u3002\n\n```\n# export VAULT_ADDR='http://127.0.0.1:8210'\n```\n\nvault write\u3068vault read\u3092\u3084\u3063\u3066\u307f\u308b\u3002\n\u554f\u984c\u306a\u3044\u3002\n\n```\n# vault write secret/test2 k1=v1\nSuccess! Data written to: secret/test2\n\n# vault read secret/test2\nKey             Value\nlease_id        secret/test2/cd7fd737-2d2c-1ca6-739f-4c54c8e7649b\nlease_duration  2592000\nk1              v1\n```\n\nsocat\u3067HAProxy\u306estat\u3092\u78ba\u8a8d\u3059\u308b\u3002\n\uff081\u3064\u76ee\u306e#\u306f\u30d7\u30ed\u30f3\u30d7\u30c8\u3060\u3051\u3069\u30012\u3064\u76ee\u306e#\u306f\u305f\u3060\u306e\u51fa\u529b\u3002socat\u306estat\u306b\u3064\u3044\u3066\u4ee5\u4e0b\u540c\u3058\uff09\n\n```\n# echo \"show stat\" | socat stdio /var/lib/haproxy/stats\n# pxname,svname,qcur,qmax,scur,smax,slim,stot,bin,bout,dreq,dresp,ereq,econ,eresp,wretr,wredis,status,weight,act,bck,chkfail,chkdown,lastchg,downtime,qlimit,pid,iid,sid,throttle,lbtot,tracked,type,rate,rate_lim,rate_max,check_status,check_code,check_duration,hrsp_1xx,hrsp_2xx,hrsp_3xx,hrsp_4xx,hrsp_5xx,hrsp_other,hanafail,req_rate,req_rate_max,req_tot,cli_abrt,srv_abrt,comp_in,comp_out,comp_byp,comp_rsp,lastsess,last_chk,last_agt,qtime,ctime,rtime,ttime,\nvault,FRONTEND,,,0,1,3000,3,520,650,0,0,0,,,,,OPEN,,,,,,,,,1,2,0,,,,0,0,0,1,,,,0,3,0,0,0,0,,0,1,3,,,0,0,0,0,,,,,,,,\nvault,cc6,0,0,0,0,,0,0,0,,0,,0,0,0,0,DOWN,1,1,0,2,1,447,447,,1,2,1,,0,,2,0,,0,L7STS,429,0,0,0,0,0,0,0,0,,,,0,0,,,,,-1,Too Many Requests,,0,0,0,0,\nvault,cc7,0,0,0,1,,3,520,650,,0,,0,0,0,0,UP,1,1,0,1,1,409,1311,,1,2,2,,3,,2,0,,1,L7OK,200,0,0,3,0,0,0,0,0,,,,0,0,,,,,134,OK,,0,0,1,1,\nvault,BACKEND,0,0,0,1,300,3,520,650,0,0,,0,0,0,0,UP,1,1,0,,1,409,38,,1,2,0,,3,,1,0,,1,,,,0,3,0,0,0,0,,,,,0,0,0,0,0,0,134,,,0,0,1,1,\n```\n\n1\u53f0\u76ee(cc6)\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u30b3\u30fc\u30c9\u304c429\u30012\u53f0\u76ee(cc7)\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u30b3\u30fc\u30c9\u304c200\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u30671\u53f0\u76ee\u304cstandby\u30012\u53f0\u76ee\u304cactive\u3067\u3042\u308b\u3002\n\nvault status\u3067\u30822\u53f0\u76ee\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n\n```\n# vault status\nSealed: false\nKey Shares: 5\nKey Threshold: 3\nUnseal Progress: 0\n\nHigh-Availability Enabled: true\n        Mode: active\n        Leader: 10.0.2.170\n```\n\n### \u5207\u308a\u66ff\u3048\u30c6\u30b9\u30c8\n\n\u305d\u308c\u3067\u306f2\u53f0\u76ee\u306eVault\u30b5\u30fc\u30d0\u3092\u843d\u3068\u3057\u3066\u307f\u308b\u3002\n\n```\n# systemctl stop vault.service\n```\n\n\u5148\u306bVault\u30b5\u30fc\u30d0\u306e\u5207\u308a\u66ff\u3048\u306b\u306f40\u79d2\u307b\u3069\u639b\u304b\u308b\u3068\u66f8\u3044\u305f\u3002\n\u3059\u3050\u306bvault read\u3057\u3066\u307f\u3066\u3082\u30a2\u30af\u30bb\u30b9\u3067\u304d\u306a\u3044\u3002\n\n```\n# vault read secret/test2\nError reading secret/test: Error making API request.\n\nURL: GET http://127.0.0.1:8210/v1/secret/test2\nCode: 503. Raw Message:\n\n<html><body><h1>503 Service Unavailable</h1>\nNo server is available to handle this request.\n</body></html>\n```\n\n\u3053\u306e\u6642\u70b9\u3067socat\u3067HAProxy\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u3092\u898b\u308b\u30681\u53f0\u76ee\u30012\u53f0\u76ee\u3068\u3082\u306bDOWN\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\n```\n# echo \"show stat\" | socat stdio /var/lib/haproxy/stats\n# pxname,svname,qcur,qmax,scur,smax,slim,stot,bin,bout,dreq,dresp,ereq,econ,eresp,wretr,wredis,status,weight,act,bck,chkfail,chkdown,lastchg,downtime,qlimit,pid,iid,sid,throttle,lbtot,tracked,type,rate,rate_lim,rate_max,check_status,check_code,check_duration,hrsp_1xx,hrsp_2xx,hrsp_3xx,hrsp_4xx,hrsp_5xx,hrsp_other,hanafail,req_rate,req_rate_max,req_tot,cli_abrt,srv_abrt,comp_in,comp_out,comp_byp,comp_rsp,lastsess,last_chk,last_agt,qtime,ctime,rtime,ttime,\nvault,FRONTEND,,,0,1,3000,2,324,480,0,0,0,,,,,OPEN,,,,,,,,,1,2,0,,,,0,0,0,1,,,,0,1,0,0,1,0,,0,1,2,,,0,0,0,0,,,,,,,,\nvault,cc6,0,0,0,0,,0,0,0,,0,,0,0,0,0,DOWN,1,1,0,2,1,665,665,,1,2,1,,0,,2,0,,0,L7STS,429,0,0,0,0,0,0,0,0,,,,0,0,,,,,-1,Too Many Requests,,0,0,0,0,\nvault,cc7,0,0,0,1,,5,324,480,,0,,1,0,3,0,DOWN,1,1,0,3,2,2,808,,1,2,2,,2,,2,0,,1,L4CON,,0,0,1,0,0,0,0,0,,,,0,0,,,,,4,Connection refused,,0,0,1,1,\nvault,BACKEND,0,0,0,1,300,2,324,480,0,0,,1,0,3,0,DOWN,0,0,0,,2,2,40,,1,2,0,,2,,1,0,,1,,,,0,1,0,0,1,0,,,,,0,0,0,0,0,0,4,,,0,0,1,1,\n```\n\n\u3057\u3070\u3089\u304f\u3057\u3066\u304b\u3089\u3082\u3046\u4e00\u5ea6socat\u3067HAProxy\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u3092\u898b\u308b\u30681\u53f0\u76ee\u306e\u65b9\u304cUP\u306b\u306a\u3063\u3066\u3044\u308b\u3002\nVault\u30b5\u30fc\u30d0\u5074\u306e\u5207\u308a\u66ff\u3048\u304c\u7d42\u308f\u3063\u305f\u3088\u3046\u3060\u3002\n\n```\n# echo \"show stat\" | socat stdio /var/lib/haproxy/stats\n# pxname,svname,qcur,qmax,scur,smax,slim,stot,bin,bout,dreq,dresp,ereq,econ,eresp,wretr,wredis,status,weight,act,bck,chkfail,chkdown,lastchg,downtime,qlimit,pid,iid,sid,throttle,lbtot,tracked,type,rate,rate_lim,rate_max,check_status,check_code,check_duration,hrsp_1xx,hrsp_2xx,hrsp_3xx,hrsp_4xx,hrsp_5xx,hrsp_other,hanafail,req_rate,req_rate_max,req_tot,cli_abrt,srv_abrt,comp_in,comp_out,comp_byp,comp_rsp,lastsess,last_chk,last_agt,qtime,ctime,rtime,ttime,\nvault,FRONTEND,,,0,1,3000,3,487,747,0,0,0,,,,,OPEN,,,,,,,,,1,2,0,,,,0,0,0,1,,,,0,2,0,0,1,0,,0,1,3,,,0,0,0,0,,,,,,,,\nvault,cc6,0,0,0,1,,1,163,267,,0,,0,0,0,0,UP,1,1,0,2,1,147,695,,1,2,1,,1,,2,0,,1,L7OK,200,0,0,1,0,0,0,0,0,,,,0,0,,,,,107,OK,,0,0,1,1,\nvault,cc7,0,0,0,1,,5,324,480,,0,,1,0,3,0,DOWN,1,1,0,3,2,179,985,,1,2,2,,2,,2,0,,1,L4CON,,0,0,1,0,0,0,0,0,,,,0,0,,,,,181,Connection refused,,0,0,1,1,\nvault,BACKEND,0,0,0,1,300,3,487,747,0,0,,1,0,3,0,UP,1,1,0,,2,147,70,,1,2,0,,3,,1,0,,1,,,,0,2,0,0,1,0,,,,,0,0,0,0,0,0,107,,,0,0,1,1,\n```\n\n\u3053\u3046\u306a\u308c\u3070vault read\u304c\u901a\u308b\u3002\n\n```\n# vault read secret/test2\nKey             Value\nlease_id        secret/test2/75a4687d-3fe0-e8f2-2108-d34b28bd67a7\nlease_duration  2592000\nk1              v1\n```\n\n2\u53f0\u76ee\u306e\u65b9\u306eVault\u30b5\u30fc\u30d0\u3092\u3082\u3046\u4e00\u5ea6\u8d77\u52d5\u3059\u308b\u3002\n\n```\n# systemctl start vault.service\n```\n\n2\u53f0\u76ee\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u30b3\u30fc\u30c9\u304c500\u306a\u306e\u3067seal\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n\n```\n# echo \"show stat\" | socat stdio /var/lib/haproxy/stats\n# pxname,svname,qcur,qmax,scur,smax,slim,stot,bin,bout,dreq,dresp,ereq,econ,eresp,wretr,wredis,status,weight,act,bck,chkfail,chkdown,lastchg,downtime,qlimit,pid,iid,sid,throttle,lbtot,tracked,type,rate,rate_lim,rate_max,check_status,check_code,check_duration,hrsp_1xx,hrsp_2xx,hrsp_3xx,hrsp_4xx,hrsp_5xx,hrsp_other,hanafail,req_rate,req_rate_max,req_tot,cli_abrt,srv_abrt,comp_in,comp_out,comp_byp,comp_rsp,lastsess,last_chk,last_agt,qtime,ctime,rtime,ttime,\nvault,FRONTEND,,,0,1,3000,4,650,1014,0,0,0,,,,,OPEN,,,,,,,,,1,2,0,,,,0,0,0,1,,,,0,3,0,0,1,0,,0,1,4,,,0,0,0,0,,,,,,,,\nvault,cc6,0,0,0,1,,2,326,534,,0,,0,0,0,0,UP,1,1,0,2,1,355,695,,1,2,1,,2,,2,0,,1,L7OK,200,0,0,2,0,0,0,0,0,,,,0,0,,,,,126,OK,,0,0,1,1,\nvault,cc7,0,0,0,1,,5,324,480,,0,,1,0,3,0,DOWN,1,1,0,3,2,387,1193,,1,2,2,,2,,2,0,,1,L7STS,500,0,0,1,0,0,0,0,0,,,,0,0,,,,,389,Internal Server Error,,0,0,1,1,\nvault,BACKEND,0,0,0,1,300,4,650,1014,0,0,,1,0,3,0,UP,1,1,0,,2,355,70,,1,2,0,,4,,1,0,,1,,,,0,3,0,0,1,0,,,,,0,0,0,0,0,0,126,,,0,0,1,1,\n```\n\n2\u53f0\u76ee\u306fvault unseal\u3059\u308b\u3068\u518d\u5ea6\u4f7f\u7528\u53ef\u80fd\u306a\u72b6\u614b\u306b\u306a\u308b\u3002\n\n```\n# vault unseal -address http://10.0.2.170:8200\n# vault unseal -address http://10.0.2.170:8200\n# vault unseal -address http://10.0.2.170:8200\n```\n\n2\u53f0\u76ee\u306e\u30b9\u30bf\u30fc\u30bf\u30b9\u30b3\u30fc\u30c9\u304c429\u306b\u5909\u5316\u3057\u305f\u306e\u3067standby\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n\n```\n# echo \"show stat\" | socat stdio /var/lib/haproxy/stats\n# pxname,svname,qcur,qmax,scur,smax,slim,stot,bin,bout,dreq,dresp,ereq,econ,eresp,wretr,wredis,status,weight,act,bck,chkfail,chkdown,lastchg,downtime,qlimit,pid,iid,sid,throttle,lbtot,tracked,type,rate,rate_lim,rate_max,check_status,check_code,check_duration,hrsp_1xx,hrsp_2xx,hrsp_3xx,hrsp_4xx,hrsp_5xx,hrsp_other,hanafail,req_rate,req_rate_max,req_tot,cli_abrt,srv_abrt,comp_in,comp_out,comp_byp,comp_rsp,lastsess,last_chk,last_agt,qtime,ctime,rtime,ttime,\nvault,FRONTEND,,,0,1,3000,3,520,650,0,0,0,,,,,OPEN,,,,,,,,,1,2,0,,,,0,0,0,1,,,,0,3,0,0,0,0,,0,1,3,,,0,0,0,0,,,,,,,,\nvault,cc6,0,0,0,0,,0,0,0,,0,,0,0,0,0,UP,1,1,0,2,1,477,696,,1,2,1,,0,,2,0,,0,L7OK,200,0,0,0,0,0,0,0,0,,,,0,0,,,,,-1,OK,,0,0,0,0,\nvault,cc7,0,0,0,1,,3,520,650,,0,,0,0,0,0,DOWN,1,1,0,3,2,515,1826,,1,2,2,,3,,2,0,,1,L7STS,429,0,0,3,0,0,0,0,0,,,,0,0,,,,,860,Too Many Requests,,0,0,1,1,\nvault,BACKEND,0,0,0,1,300,3,520,650,0,0,,0,0,0,0,UP,1,1,0,,2,477,76,,1,2,0,,3,,1,0,,1,,,,0,3,0,0,0,0,,,,,0,0,0,0,0,0,860,,,0,0,1,1,\n```\n\nvault status\u30671\u53f0\u76ee\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u305f\u3002\n\n```\n# vault status\nSealed: false\nKey Shares: 5\nKey Threshold: 3\nUnseal Progress: 0\n\nHigh-Availability Enabled: true\n        Mode: active\n        Leader: 10.0.2.167\n```\n\n### HTTPS\u63a5\u7d9a\u306b\u3059\u308b\u5834\u5408\n\nHTTPS\u63a5\u7d9a\u3060\u3068HAProxy\u306e\u8a2d\u5b9a\u306e\u3046\u3061`mode http`\u3092`mode tcp`\u306b\u5909\u66f4\u3057\u306a\u3051\u308c\u3070\u306a\u3089\u305a\u3001\u305d\u308c\u306b\u4f34\u3044`option httpchk`\u304c\u4f7f\u7528\u3067\u304d\u306a\u3044\u306e\u3067\u7279\u5b9a\u306eURL\u306b\u5bfe\u3057\u3066\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u3092\u639b\u3051\u308b\u3053\u3068\u304c\u3067\u304d\u306a\u3044\uff08\u3068\u3001\u601d\u3046\u3002\u4ee3\u308f\u308a\u306b\u306a\u308b\u3082\u306e\u3092\u898b\u3064\u3051\u3089\u308c\u3066\u3044\u306a\u3044\u3060\u3051\u304b\u3082\u3057\u308c\u306a\u3044\uff09\u3002\n\u5f93\u3063\u3066Vault\u30b5\u30fc\u30d0\u304c\u8d77\u52d5\u3057\u3066\u3044\u308b\u304b\u3057\u3066\u3044\u306a\u3044\u304b\u306e\u30c1\u30a7\u30c3\u30af\u306f\u3067\u304d\u3066\u3082\u3001active/standby/seal\u306e\u3046\u3061\u3069\u306e\u72b6\u614b\u306b\u306a\u3063\u3066\u3044\u308b\u304b\u306e\u30c1\u30a7\u30c3\u30af\u304c\u3067\u304d\u306a\u3044\u3002\n\u3068\u306f\u3044\u3048active\u304bstandby\u306a\u3089\u81ea\u52d5\u63a5\u7d9a\u5207\u308a\u66ff\u3048\u304c\u50cd\u304f\u306e\u3067\u3001\u3053\u308c\u3089\u3092\u533a\u5225\u3059\u308b\u5fc5\u8981\u306f\u7279\u306b\u306a\u3044\u3002\u554f\u984c\u306fseal\u306e\u5834\u5408\u306b\u3069\u3046\u3059\u308c\u3070\u826f\u3044\u304b\u3067\u3042\u308b\u3002\n\n\u3068\u308a\u3042\u3048\u305a\u30b5\u30fc\u30d3\u30b9\u8d77\u52d5\u6642\u306bunseal\u307e\u3067\u884c\u3046\u3088\u3046\u306b[init\u30b9\u30af\u30ea\u30d7\u30c8](https://gist.github.com/yunano/c4e641bad3fb9f78d6cf)/[systemd\u30e6\u30cb\u30c3\u30c8\u30d5\u30a1\u30a4\u30eb](https://gist.github.com/yunano/66caf8c5ed993bb2f4e3)\u3092\u6539\u826f\u3057\u3066\u3001seal\u72b6\u614b\u306e\u671f\u9593\u3092\u306a\u304f\u3059\u65b9\u5411\u3067\u56de\u907f\u3057\u3066\u307f\u308b\u3002\n\ninit\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u4f7f\u3046\u5834\u5408\u306f /etc/sysconfig/vault \u306b\u6b21\u306e\u3088\u3046\u306b\u8a18\u8ff0\u3059\u308b\u3002\nVAULT_ADDR\u306fHAProxy\u304c\u958b\u3051\u3066\u3044\u308b\u30dd\u30fc\u30c8\u3067\u306f\u306a\u304f\u3001Vault\u30b5\u30fc\u30d0\u81ea\u4f53\u304c\u958b\u3051\u3066\u3044\u308b\u30dd\u30fc\u30c8\u306b\u3059\u308b\u3002\nKEYS\u306f\u30b9\u30da\u30fc\u30b9\u533a\u5207\u308a\u3067\u3002\n\n```/etc/sysconfig/vault\nexport VAULT_ADDR='https://cc6.node.consul:8200'\nexport KEYS=\"52d78d93109a47356a169e8cf2ee4868dc40de7fdd9b1c1d0c68255a8f691c0501 514f788ab44d9805577a074ce7f457891d59880a6a05b38b0acadaacdc330dbb02 b26ceda206536f317e375ae55fff849b0d3c9758f74b920d3d512122211f518b03\"\nexport CERT='-ca-cert /etc/pki/tls/self/node.crt'\n```\n\nsystemd\u30e6\u30cb\u30c3\u30c8\u30d5\u30a1\u30a4\u30eb\u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\u306fexport\u306f\u66f8\u304b\u306a\u3044\u3002\n\n```/etc/sysconfig/vault\nVAULT_ADDR='https://cc7.node.consul:8200'\nKEYS=\"52d78d93109a47356a169e8cf2ee4868dc40de7fdd9b1c1d0c68255a8f691c0501 514f788ab44d9805577a074ce7f457891d59880a6a05b38b0acadaacdc330dbb02 b26ceda206536f317e375ae55fff849b0d3c9758f74b920d3d512122211f518b03\"\nCERT='-ca-cert /etc/pki/tls/self/node.crt'\n```\n\nHAProxy\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb /etc/haproxy/haproxy.cfg \u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3059\u308b\u3002\n\n```txt:/etc/haproxy/haproxy.cfg\nglobal\n    log         127.0.0.1 local2\n    chroot      /var/lib/haproxy\n    pidfile     /var/run/haproxy.pid\n    maxconn     4000\n    user        haproxy\n    group       haproxy\n    daemon\n    stats socket /var/lib/haproxy/stats\n\ndefaults\n    mode                    http\n    log                     global\n    option                  httplog\n    option                  dontlognull\n    option http-server-close\n    option forwardfor       except 127.0.0.0/8\n    option                  redispatch\n    retries                 3\n    timeout http-request    10s\n    timeout queue           1m\n    timeout connect         10s\n    timeout client          1m\n    timeout server          1m\n    timeout http-keep-alive 10s\n    timeout check           10s\n    maxconn                 3000\n\nlisten vault\n    mode tcp\n    bind 0.0.0.0:8210\n    option ssl-hello-chk\n    server cc6 10.0.2.167:8200 check inter 5s fall 2 rise 1\n    server cc7 10.0.2.170:8200 check inter 5s fall 2 rise 1\n```\n\n\u74b0\u5883\u5909\u6570VAULT_ADDR\u3092\u5909\u66f4\u3057\u3066\u63a5\u7d9a\u5148\u3092HAProxy\u304c\u958b\u3051\u3066\u3044\u308b\u30dd\u30fc\u30c8\u306b\u5909\u3048\u308b\u3002\n\n```\n# export VAULT_ADDR='https://cc6.node.consul:8210'\n```\n\n\u4ed6\u306e\u4f5c\u696d\u306fHTTP\u63a5\u7d9a\u306e\u5834\u5408\u3068\u5909\u308f\u3089\u306a\u3044\u3002\n\n## Consul\u306b\u3088\u308b\u81ea\u52d5\u5207\u308a\u66ff\u3048\n\n\u3088\u304f\u3088\u304f\u8abf\u3079\u3066\u307f\u308c\u3070HAProxy\u3092\u4f7f\u308f\u306a\u304f\u3066\u3082Consul\u3067\u81ea\u52d5\u5207\u308a\u66ff\u3048\u304c\u53ef\u80fd\u3067\u3042\u308b\u3002\n\nHTTPS\u63a5\u7d9a\u3067\u81ea\u5df1\u7f72\u540d\u8a3c\u660e\u66f8\u304c\u5fc5\u8981\u306a\u3089\u30b3\u30e2\u30f3\u30cd\u30fc\u30e0\u304c\u300c*.service.consul\u300d\u306e\u8a3c\u660e\u66f8\u3092\u4f5c\u6210\u3059\u308b\u3002\n\n```\n# mkdir /etc/pki/tls/self\n# cd /etc/pki/tls/self\n# cp /etc/pki/tls/openssl.cnf ./openssl.service.cnf\n```\n\n```/etc/pki/tls/self/openssl.service.cnf\n# \u30a8\u30c7\u30a3\u30bf\u306a\u3069\u3067\u4ee5\u4e0b\u3092\u4fee\u6b63\u3059\u308b\n\n[ CA_default ]\n# \u8a3c\u660e\u66f8\u306e\u5bff\u547d\u3092365\u65e5\u304b\u30893650\u65e5\u306b\u5909\u66f4\ndefault_days = 3650\n\n[ req ]\n# attributes\u884c\u3092\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3057\u3066prompt = no\u3092\u8ffd\u52a0\n#attributes = req_attributes\nprompt = no\n\n[ req_distinguished_name ]\n# req_distinguished_name\u306e\u4e2d\u306f\u5168\u90e8\u6d88\u3057\u3066\u304b\u3089\u4ee5\u4e0b\u3092\u8ffd\u52a0\nC = JP\nST = Tokyo\nL = Tokyo\nO = consul\nOU = admin\nCN = *.service.consul\n```\n\n```\n# sha512sum /proc/vmstat | awk '{ print $1 }' > sha512.dat\n# openssl genrsa -rand sha512.dat -out service.key -passout pass:$(cat sha512.dat) -aes256 2048\n# openssl rsa -in service.key -passin pass:$(cat sha512.dat) -out service.key\n# openssl req -new -config openssl.service.cnf -key service.key -out service.csr\n# openssl x509 -in service.csr -days 3650 -req -signkey service.key -out service.crt\n# rm -f sha512.dat service.csr\n```\n\n\u4f5c\u6210\u3055\u308c\u305f\u79d8\u5bc6\u9375service.key\u3068\u30b5\u30fc\u30d0\u8a3c\u660e\u66f8service.crt\u306f\u3059\u3079\u3066\u306eVault\u30b5\u30fc\u30d0\u306b\u914d\u7f6e\u3059\u308b\u3002\nservice.crt\u306f\u3059\u3079\u3066\u306eVault\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u3082\u914d\u7f6e\u3059\u308b\u3002\n\n\u3059\u3079\u3066\u306eVault\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3067\u4f5c\u6210\u3057\u305f\u30b5\u30fc\u30d0\u8a3c\u660e\u66f8\u3092\u4fe1\u983c\u3059\u308b\u8a3c\u660e\u66f8\u306b\u52a0\u3048\u308b\u3002\n\n```\n# update-ca-trust enable # CentOS 7\u3067\u306f\u521d\u671f\u72b6\u614b\u3067enable\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u3067\u5b9f\u884c\u4e0d\u8981\n# ln -s /etc/pki/tls/self/service.crt /etc/pki/ca-trust/source/anchors/\n# update-ca-trust extract\n```\n\nConsul\u5074\u3067\u81ea\u5206\u81ea\u8eab\u3057\u304b\u6307\u3055\u306a\u3044\u9069\u5f53\u306a\u30b5\u30fc\u30d3\u30b9\u3068\u3001Vault\u3068\u3044\u3046\u30b5\u30fc\u30d3\u30b9\u3092\u5b9a\u7fa9\u3059\u308b\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb /etc/consul.d/services.json \u3092\u4f5c\u3063\u3066\u3001Consul\u3092\u3053\u308c\u3092\u8aad\u307f\u8fbc\u3080\u3088\u3046\u306b\u3057\u3066\u8d77\u52d5\u3057\u76f4\u3059\u3002\n\n\u300c\u81ea\u5206\u81ea\u8eab\u3057\u304b\u6307\u3055\u306a\u3044\u9069\u5f53\u306a\u30b5\u30fc\u30d3\u30b9\u300d\u306fHTTPS\u63a5\u7d9a\u6642\u306b\u8a3c\u660e\u66f8\u306e\u30b3\u30e2\u30f3\u30cd\u30fc\u30e0\u300c*.service.consul\u300d\u306b\u4e00\u81f4\u3059\u308b\u3001\u81ea\u5206\u81ea\u8eab\u3060\u3051\u3092\u6307\u3059\u30db\u30b9\u30c8\u540d\u3092\u4f5c\u308b\u305f\u3081\u306b\u5fc5\u8981\u3067\u3042\u308b\u3002\u6b21\u306e\u4f8b\u3060\u3068\u300ccc6.service.consul\u300d\u3067\u81ea\u5206\u81ea\u8eab\u3092\u6307\u3059\u3053\u3068\u306b\u306a\u308b\u3002\u5404Vault\u30b5\u30fc\u30d0\u3067name\u3092\u305d\u308c\u305e\u308c\u9055\u3046\u5024\u306b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\n\u300cVault\u3068\u3044\u3046\u30b5\u30fc\u30d3\u30b9\u300d\u3067\u306fchecks\u306ehttp\u3092`https://<\u30db\u30b9\u30c8\u540d>:8200/v1/sys/health`\u3068\u3059\u308b\u304c\u3001\u30db\u30b9\u30c8\u540d\u306f\u3053\u306e\u81ea\u5206\u81ea\u8eab\u3060\u3051\u3092\u6307\u3059\u30db\u30b9\u30c8\u540d\u306b\u3059\u308b\u3002HTTP\u63a5\u7d9a\u306a\u3089https://\u3067\u306a\u304fhttp://\u306b\u3059\u308b\u3002\n\n```/etc/consul.d/services.json\n{\n  \"services\": [\n    {\n      \"name\": \"cc6\"\n    },\n    {\n      \"name\": \"vault\",\n      \"port\": 8200,\n      \"checks\": [\n        {\n          \"http\": \"https://cc6.service.consul:8200/v1/sys/health\",\n          \"interval\": \"5s\"\n        }\n      ]\n    }\n  ]\n}\n```\n\nVault\u30b5\u30fc\u30d0\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb /etc/vault.d/server.hcl \u306f\u6b21\u306e\u3088\u3046\u306b\u306a\u308b\u3002\nadvertise_addr\u3082\u540c\u3058\u3088\u3046\u306b\u305d\u306e\u81ea\u5206\u81ea\u8eab\u3060\u3051\u3092\u6307\u3059\u30db\u30b9\u30c8\u540d\u3092\u4f7f\u3063\u3066\u6307\u5b9a\u3059\u308b\u3002\nHTTP\u63a5\u7d9a\u306a\u3089advertise_addr\u306fhttps://\u3067\u306a\u304fhttp://\u306b\u3057\u3001tls_cert_file\u3084tls_key_file\u306f\u6307\u5b9a\u305b\u305a`tls_disable = 1`\u3068\u3059\u308b\u3002\n\n```/etc/vault.d/server.hcl\nbackend \"consul\" {\n  advertise_addr = \"https://cc6.service.consul:8200\"\n}\n\nlistener \"tcp\" {\n  address = \"0.0.0.0:8200\"\n  tls_cert_file = \"/etc/pki/tls/self/service.crt\"\n  tls_key_file = \"/etc/pki/tls/self/service.key\"\n}\n```\n\n\u3053\u306e\u65b9\u6cd5\u3060\u3068acitve\u304bstandby\u304bseal\u304b\u306e\u533a\u5225\u304c\u3064\u304f\u305f\u3081\u30b5\u30fc\u30d3\u30b9\u8d77\u52d5\u6642\u306b\u81ea\u52d5\u7684\u306bunseal\u3059\u308b\u5fc5\u8981\u306f\u306a\u3044\u304c\u3001\u624b\u52d5\u3067unseal\u3059\u308b\u306e\u304c\u9762\u5012\u306a\u3089 /etc/sysconfig/vault \u3092\u6b21\u306e\u3088\u3046\u306b\u4f5c\u6210\u3057\u3001[init\u30b9\u30af\u30ea\u30d7\u30c8](https://gist.github.com/yunano/c4e641bad3fb9f78d6cf)\u3084[systemd\u30e6\u30cb\u30c3\u30c8\u30d5\u30a1\u30a4\u30eb](https://gist.github.com/yunano/66caf8c5ed993bb2f4e3)\u3092\u5229\u7528\u3057\u3066Vault\u30b5\u30fc\u30d0\u3092\u8d77\u52d5\u3059\u308b\u3002\n\ninit\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u4f7f\u3046\u5834\u5408\u3002\n\n```/etc/sysconfig/vault\nexport VAULT_ADDR='https://cc6.service.consul:8200'\nexport KEYS=\"52d78d93109a47356a169e8cf2ee4868dc40de7fdd9b1c1d0c68255a8f691c0501 514f788ab44d9805577a074ce7f457891d59880a6a05b38b0acadaacdc330dbb02 b26ceda206536f317e375ae55fff849b0d3c9758f74b920d3d512122211f518b03\"\nexport CERT='-ca-cert /etc/pki/tls/self/service.crt'\n```\n\nsystemd\u30e6\u30cb\u30c3\u30c8\u30d5\u30a1\u30a4\u30eb\u3092\u4f7f\u3046\u5834\u5408\u3002export\u304c\u4e0d\u8981\u3002\n\n```/etc/sysconfig/vault\nVAULT_ADDR='https://cc7.service.consul:8200'\nKEYS=\"52d78d93109a47356a169e8cf2ee4868dc40de7fdd9b1c1d0c68255a8f691c0501 514f788ab44d9805577a074ce7f457891d59880a6a05b38b0acadaacdc330dbb02 b26ceda206536f317e375ae55fff849b0d3c9758f74b920d3d512122211f518b03\"\nCERT='-ca-cert /etc/pki/tls/self/service.crt'\n```\n\nVault\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3067\u306f\u74b0\u5883\u5909\u6570VAULT_ADDR\u306b`http(s)://vault.service.consul:8200`\u3092\u6307\u5b9a\u3059\u308b\u3002\nvault.service.consul\u306factive\u304bstandby\u306eVault\u30b5\u30fc\u30d0\u3060\u3051\u3067\u306e\u30e9\u30a6\u30f3\u30c9\u30ed\u30d3\u30f3\u3068\u306a\u308a\u3001seal\u3084\u8d77\u52d5\u3057\u3066\u3044\u306a\u3044\u72b6\u614b\u3060\u3068\u30e9\u30a6\u30f3\u30c9\u30ed\u30d3\u30f3\u304b\u3089\u81ea\u52d5\u7684\u306b\u5916\u308c\u308b\u306e\u3067\u3001\u5b8c\u5168\u306b\u671f\u5f85\u901a\u308a\u306e\u52d5\u304d\u3092\u3057\u3066\u304f\u308c\u308b\u3002\n\n```\n# export VAULT_ADDR='https://vault.service.consul:8200'\n```\n\n# \u76e3\u67fb\u30ed\u30b0\u306e\u51fa\u529b\n\nvault audit-enable\u3067\u76e3\u67fb\u30ed\u30b0\u3092\u66f8\u304d\u51fa\u3059\u3088\u3046\u306b\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\u4eca\u306e\u3068\u3053\u308d\u51fa\u529b\u5148\u306f\u30d5\u30a1\u30a4\u30eb\u304bsyslog\u306b\u306a\u308b\u3002\n\nVault\u304cHA\u69cb\u6210\u306b\u306a\u3063\u3066\u3044\u308b\u5834\u5408\u3001vault audit-enable\u306f\u30af\u30e9\u30b9\u30bf\u306e\u4e2d\u30671\u56de\u3060\u3051\u884c\u3048\u3070active\u306b\u306a\u3063\u3066\u3044\u308b\u30ce\u30fc\u30c9\u306e\u51fa\u529b\u5148\u306b\u66f8\u304d\u51fa\u3055\u308c\u308b\u3002\n\n## \u30d5\u30a1\u30a4\u30eb\u3078\u306e\u51fa\u529b\n\nVault 0.1.1\u307e\u3067\u306fVault\u5074\u3067\u306f\u76e3\u67fb\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u80fd\u529b\u304c\u306a\u304f\u3001\u5148\u306b\u305d\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u3063\u3066\u304b\u3089vault audit-enable\u3057\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u304b\u3063\u305f\u3002\nVault 0.1.2\u304b\u3089\u3001\u66f8\u304d\u8fbc\u307f\u6642\u306b\u30d5\u30a1\u30a4\u30eb\u304c\u306a\u3051\u308c\u3070\u4f5c\u3063\u3066\u304f\u308c\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u3002\n\n```\n# vault audit-enable file path=/var/log/vault_audit.log\n```\n\n`vault write secret/test a=b`\u3068`vault read secret/test`\u3092\u5b9f\u884c\u3057\u305f\u3068\u3053\u308d\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u76e3\u67fb\u30ed\u30b0\u304c\u51fa\u529b\u3055\u308c\u305f\uff08v0.1.1\u6642\u306e\u3082\u306e\uff09\u3002\n\n```/var/log/vault_audit.log\n{\"type\":\"request\",\"auth\":{\"policies\":[\"root\"],\"metadata\":null},\"request\":{\"operation\":\"write\",\"path\":\"secret/test\",\"data\":{\"a\":\"sha1:e9d71f5ee7c92d6dc9e92ffdad17b8bd49418f98\"}}}\n{\"type\":\"response\",\"error\":\"\",\"auth\":{\"policies\":[\"root\"],\"metadata\":null},\"request\":{\"operation\":\"write\",\"path\":\"secret/test\",\"data\":{\"a\":\"sha1:e9d71f5ee7c92d6dc9e92ffdad17b8bd49418f98\"}},\"response\":{\"auth\":{\"policies\":null,\"metadata\":null},\"secret\":{\"lease_id\":\"\"},\"data\":null,\"redirect\":\"\"}}\n{\"type\":\"request\",\"auth\":{\"policies\":[\"root\"],\"metadata\":null},\"request\":{\"operation\":\"read\",\"path\":\"secret/test\",\"data\":null}}\n{\"type\":\"response\",\"error\":\"\",\"auth\":{\"policies\":[\"root\"],\"metadata\":null},\"request\":{\"operation\":\"read\",\"path\":\"secret/test\",\"data\":null},\"response\":{\"auth\":{\"policies\":null,\"metadata\":null},\"secret\":{\"lease_id\":\"secret/test/b0f8048a-336c-d326-5b19-d7f5997d500f\"},\"data\":{\"a\":\"sha1:e9d71f5ee7c92d6dc9e92ffdad17b8bd49418f98\"},\"redirect\":\"\"}}\n```\n\n\u30d5\u30a1\u30a4\u30eb\u3078\u306e\u66f8\u304d\u8fbc\u307f\u3092\u7d42\u4e86\u3059\u308b\u306b\u306f\u6b21\u3092\u5b9f\u884c\u3059\u308b\u3002\n\n```\n# vault audit-disable file\n```\n\n`file`\u306f\u66f8\u304d\u8fbc\u307f\u5148\u304c\u30d5\u30a1\u30a4\u30eb\u3067\u3001vault audit-enable\u306eid\u30aa\u30d7\u30b7\u30e7\u30f3\u3067ID\u3092\u6307\u5b9a\u3057\u306a\u304b\u3063\u305f\u5834\u5408\u306e\u30c7\u30d5\u30a9\u30eb\u30c8ID\u3067\u3042\u308b\uff08`/var/log/vault_audit.log`\u306b\u7f6e\u304d\u63db\u3048\u308b\u3068\u304b\u305d\u3046\u3044\u3046\u306e\u3067\u306f\u306a\u3044\uff09\u3002\n\n## syslog\u3078\u306e\u51fa\u529b\n\nsyslog\u3092\u51fa\u529b\u5148\u306b\u4f7f\u7528\u3059\u308b\u5834\u5408\u306f\u3001Vault\u306f\u30aa\u30d7\u30b7\u30e7\u30f3\u306e\u6307\u5b9a\u304c\u306a\u3051\u308c\u3070\u30d5\u30a1\u30b7\u30ea\u30c6\u30a3AUTH\u3001\u30bf\u30b0vault\u306b\u66f8\u304d\u51fa\u3059\u306e\u3067 /etc/rsyslog.d/vault.conf \u3092\u6b21\u306e\u3088\u3046\u306b\u4f5c\u6210\u3057\u3001rsyslog\u3092\u518d\u8d77\u52d5\u3059\u308b\u3002\n/var/log/vault_audit.log \u306frsyslog\u3092\u518d\u8d77\u52d5\u3057\u305f\u6642\u70b9\u3067\u4f5c\u6210\u3055\u308c\u308b\u304c\u3001\u305d\u306e\u5f8c\u306b\u524a\u9664\u3055\u308c\u308b\u3068rsyslog\u3092\u3082\u3046\u4e00\u5ea6\u518d\u8d77\u52d5\u3059\u308b\u307e\u3067\u51fa\u529b\u306f\u884c\u308f\u308c\u306a\u3044\u3002\n\n```/etc/rsyslog.d/vault.conf\n:syslogtag, contains, \"vault\" /var/log/vault_audit.log\n```\n\n```\n# service rsyslog restart\n```\n\nVault\u304b\u3089syslog\u3078\u306e\u76e3\u67fb\u30ed\u30b0\u66f8\u304d\u51fa\u3057\u3092\u6709\u52b9\u5316\u3059\u308b\u3002\n\n```\n# vault audit-enable syslog\n```\n\n\u540c\u3058\u3088\u3046\u306b`vault write secret/test a=b`\u3068`vault read secret/test`\u3092\u5b9f\u884c\u3057\u305f\u3068\u3053\u308d\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u76e3\u67fb\u30ed\u30b0\u304c\u51fa\u529b\u3055\u308c\u305f\uff08v0.1.1\u6642\u306e\u3082\u306e\uff09\u3002\n\n```/var/log/vault_audit.log\nMay  3 13:48:26 cc7 vault[9090]: {\"type\":\"request\",\"auth\":{\"policies\":[\"root\"],\"metadata\":null},\"request\":{\"operation\":\"write\",\"path\":\"secret/test\",\"data\":{\"a\":\"sha1:e9d71f5ee7c92d6dc9e92ffdad17b8bd49418f98\"}}}\nMay  3 13:48:26 cc7 vault[9090]: {\"type\":\"response\",\"error\":\"\",\"auth\":{\"policies\":[\"root\"],\"metadata\":null},\"request\":{\"operation\":\"write\",\"path\":\"secret/test\",\"data\":{\"a\":\"sha1:e9d71f5ee7c92d6dc9e92ffdad17b8bd49418f98\"}},\"response\":{\"auth\":{\"policies\":null,\"metadata\":null},\"secret\":{\"lease_id\":\"\"},\"data\":null,\"redirect\":\"\"}}\nMay  3 13:48:35 cc7 vault[9090]: {\"type\":\"request\",\"auth\":{\"policies\":[\"root\"],\"metadata\":null},\"request\":{\"operation\":\"read\",\"path\":\"secret/test\",\"data\":null}}\nMay  3 13:48:35 cc7 vault[9090]: {\"type\":\"response\",\"error\":\"\",\"auth\":{\"policies\":[\"root\"],\"metadata\":null},\"request\":{\"operation\":\"read\",\"path\":\"secret/test\",\"data\":null},\"response\":{\"auth\":{\"policies\":null,\"metadata\":null},\"secret\":{\"lease_id\":\"secret/test/421e8b4d-11da-2e11-d15e-85cb1bd30cab\"},\"data\":{\"a\":\"sha1:e9d71f5ee7c92d6dc9e92ffdad17b8bd49418f98\"},\"redirect\":\"\"}}\n```\n\nsyslog\u3078\u306e\u66f8\u304d\u8fbc\u307f\u3092\u7d42\u4e86\u3059\u308b\u306b\u306f\u6b21\u3092\u5b9f\u884c\u3059\u308b\u3002\n\n```\n# vault audit-disable syslog\n```\n\n`syslog`\u306f\u66f8\u304d\u8fbc\u307f\u5148\u304csyslog\u3067\u3001vault audit-enable\u306eid\u30aa\u30d7\u30b7\u30e7\u30f3\u3067ID\u3092\u6307\u5b9a\u3057\u306a\u304b\u3063\u305f\u5834\u5408\u306e\u30c7\u30d5\u30a9\u30eb\u30c8ID\u3067\u3042\u308b\u3002\n\n# \u3042\u3084\u3057\u3044\u52d5\u4f5c\uff1f\n\n* vault revoke\u3067\u63a5\u7d9a\u5148\u306e\u81ea\u52d5\u5207\u308a\u66ff\u3048\u304c\u8d77\u3053\u3089\u306a\u3044\u3002vault mounts\u3067\u3082\u540c\u69d8\u306e\u73fe\u8c61\u304c\u767a\u751f\u3057\u305f\u3002(-v0.1.2)\n\n# \u53c2\u8003\uff1aCentOS 6\u3067libcurl.so\u3092\u5dee\u3057\u66ff\u3048\u308b\n\n\u4e0a\u8a18\u306eCentOS 6\u3067`vault read`\u304c\u4e0a\u624b\u304f\u884c\u304b\u306a\u3044\u3053\u3068\u304c\u3042\u3063\u305f\u969b\u306blibcurl.so\u306e\u5dee\u3057\u66ff\u3048\u3067\u89e3\u6c7a\u3057\u305f\u3053\u3068\u304c\u3042\u3063\u305f\u3002\n\n**\u3057\u304b\u3057libcurl.so\u3092\u5dee\u3057\u66ff\u3048\u305a\u3068\u3082OS\u518d\u8d77\u52d5\u3067\u89e3\u6c7a\u3057\u3066\u3057\u307e\u3063\u305f\u306e\u3067\u3001\u73fe\u5728\u3053\u306e\u65b9\u6cd5\u306f\u63a1\u3063\u3066\u3044\u306a\u3044\u3002**\n\u305f\u3060\u3057\u3001\u307e\u30601\u5ea6\u3057\u304b\u89e3\u6c7a\u306f\u884c\u308f\u308c\u3066\u3044\u306a\u3044\u306e\u3067\u3001\u3053\u306e\u5f8c\u3082\u540c\u3058\u3088\u3046\u306bOS\u518d\u8d77\u52d5\u3001\u3042\u308b\u3044\u306f\u5225\u306e\u3082\u3063\u3068\u7c21\u4fbf\u306a\u65b9\u6cd5\u3067\u89e3\u6c7a\u3059\u308b\u304b\u306f\u79c1\u306e\u74b0\u5883\u3067\u3082\u4e0d\u660e\u3067\u3042\u308b\u3002\n\nCentOS 6\u3067HTTPS\u63a5\u7d9a\u6642\u306bvault read\u304c\u30a8\u30e9\u30fc\u306b\u306a\u3063\u305f\u305f\u3081\u30bd\u30fc\u30b9\u304b\u3089\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u305f\u3002\n**\u305f\u3060\u3057\u3001\u3053\u306e\u65b9\u6cd5\u3067\u306f\u4eca\u5ea6\u306fyum\u304c\u4f7f\u3048\u306a\u304f\u306a\u3063\u305f\u306e\u3067\u30b3\u30f3\u30d1\u30a4\u30eb\u30aa\u30d7\u30b7\u30e7\u30f3\u306e\u5909\u66f4\u3067\u5bfe\u5fdc\u3067\u304d\u308b\u304b\u8abf\u67fb\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002**\n\n```\n# mkdir /tmp/curl\n# cd /tmp/curl\n# wget http://curl.haxx.se/download/curl-7.42.1.tar.gz\n# tar xvf curl-7.42.1.tar.gz\n# cd curl-7.42.1/\n# yum install gcc\n# ./configure\n# make\n# make install\n# cp /usr/local/lib/libcurl.so.4.3.0 /usr/lib64\n# ln -sf /usr/lib64/libcurl.so.4.3.0 /usr/lib64/libcurl.so.4\n```\n\n"}