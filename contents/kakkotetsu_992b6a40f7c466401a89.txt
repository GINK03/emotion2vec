{"tags": ["VyOS1.1.1", "Arista", "junos", "juniper", "vxlan"], "context": " More than 1 year has passed since last update.\u307e\u305f Arista \u3067\u3059\u304b\uff1f\n\u3044\u3048\u3001\u3053\u308c\u306f VyOS Advent Calendar 2014 \u306e\u8a18\u4e8b\u3067\u3059\u3002\n\n\u6982\u8981\n\n\u672c\u9805\u3067\u3084\u308b\u3053\u3068\nVyOS \u3068 Arista \u3067 VXLAN \u76f8\u4e92\u63a5\u7d9a\u3057\u307e\u3059\u3002\n\u3068\u306f\u3044\u3048\u3001interoperability \u3067\u8272\u3005\u75db\u3044\u76ee\u306b\u3042\u3063\u3066\u304d\u305f\u4eba\u304c\u601d\u3046\u3088\u3046\u306a\u82e6\u96e3\u306f\u5168\u304f\u7121\u3044\u3067\u3059\u3002\nArista \u3068 VyOS \u3067\u306f VXLAN \u3067\u4f7f\u304a\u3046\u3068\u3059\u308b dstPort \u756a\u53f7\u304c\u7570\u306a\u308b\u306e\u3067\u3059\u304c\u3001VyOS \u306e\u8a18\u4e8b\u306a\u306e\u3067\u6562\u3048\u3066 VyOS \u5074\u3067\u3053\u308c\u3092\u5909\u3048\u307e\u3059\u3002\n# \u30c7\u30d5\u30a1\u30af\u30c8\u30b9\u30bf\u30f3\u30c0\u30fc\u30c9\u306a openvswitch \u3067\u306f\u306a\u304f\u3001\u4f55\u3067\u30cb\u30c3\u30c1\u306a\u30a2\u30ec\u540c\u58eb\u3067\u2026\u3068\u3044\u3046\u30c4\u30c3\u30b3\u30df\u306f\u4e0d\u53ef\u3002\n\n\u524d\u6bb5\n\nVXLAN \u3068\u306f?\n\nhttps://tools.ietf.org/html/rfc7348\n\n\nVXLAN \u76f8\u4e92\u63a5\u7d9a\u3067\u6c17\u306b\u3059\u3079\u304d\u70b9\n\u4e8b\u524d\u306e\u9375\u4ea4\u63db phase \u3084\u3089\u306e\u9762\u5012\u3054\u3068\u304c\u7121\u3044\u30b7\u30f3\u30d7\u30eb\u306a\u30d7\u30ed\u30c8\u30b3\u30eb\u306a\u306e\u3067\u30012 \u53f0\u3067\u76f8\u4e92\u63a5\u7d9a\u3059\u308b\u5206\u306b\u306f\u5de6\u7a0b\u6c17\u3092\u3064\u3051\u308b\u70b9\u306f\u7121\u3044\u3067\u3059\u3002\n\u4eca\u5e74\u306e Shownet \u3067\u306f\u3001\u5404\u30e1\u30fc\u30ab\u306e\u7bb1\u30e2\u30ce\u3067\u76f8\u4e92\u63a5\u7d9a\u5b9f\u9a13\u3068\u304b\u3084\u3063\u3066\u3044\u3066\u3001(\u4ee5\u4e0b\u306e\u30b9\u30e9\u30a4\u30c9 68-75)\n\nShowNet 2014\u6d3b\u52d5\u30ec\u30dd\u30fc\u30c8 Vol.1 (PDF)\n\n\u3053\u308c\u3092\u898b\u3066\u3082\u6c17\u306b\u3059\u308b\u70b9\u306f\u4ee5\u4e0b\u304f\u3089\u3044\u3060\u3068\u5206\u304b\u308a\u307e\u3059\u3002\n\nBUM \u30c8\u30e9\u30d5\u30a3\u30c3\u30af\u8ee2\u9001\u65b9\u6cd5 (Unicast or Multicast)\nUDP dstport \u756a\u53f7 (4789 or 8472)\nVXLAN \u30ab\u30d7\u30bb\u30ea\u30f3\u30b0\u6642\u306e 802.1q tag \u53d6\u6271\u3044 (\u9664\u53bb or \u305d\u306e\u307e\u307e)\n\n1 \u3064\u76ee\u306f\u88fd\u54c1\u306b\u3088\u3063\u3066\u30de\u30c1\u30de\u30c1\u3067\u3059\u3002RFC \u3067\u306f Multicast \u5b9f\u88c5\u304c\u793a\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n2 \u3064\u76ee\u306f\u3001\u672c\u9805\u3067\u3082\u6c17\u306b\u3057\u3066\u3044\u307e\u3059\u3002draft \u3067\u300cIANA \u304b\u3089 UDP \u30dd\u30fc\u30c8\u756a\u53f7\u5272\u308a\u5f53\u3066\u3066\u3082\u3089\u308f\u306a\u3044\u3068\uff5e\u300d\u3068\u8a00\u3063\u3066\u3044\u308b\u6642\u4ee3\u304c\u9577\u304b\u3063\u305f\u304b\u3089\u306a\u306e\u304b\u3001Linux VXLAN \u3067\u306f 8472 \u304c\u4eca\u3082\u4f7f\u308f\u308c\u3066\u3044\u307e\u3059\u3002\u305d\u306e\u5185\u3069\u3046\u306b\u304b\u3057\u306a\u3044\u3068\u3001\u3063\u3066\u30b9\u30bf\u30f3\u30b9\u3067\u306f\u3042\u308b\u3088\u3046\u3067\u3059\u3002( Linux/drivers/net/vxlan.c \u53c2\u7167)\n\u73fe\u5728\u306f IANA \u304b\u3089 4789 \u3092\u5272\u308a\u5f53\u3066\u3089\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u6700\u8fd1\u306f\u305d\u308c\u3092\u4f7f\u3063\u3066\u3044\u308b\u30fb\u904e\u53bb\u306e\u7d4c\u7def\u3092\u8003\u616e\u3057\u3066 dstport \u5909\u66f4\u53ef\u80fd\u306a\u88fd\u54c1\u304c\u591a\u3044\u3067\u3059\u3002\n3 \u3064\u76ee\u306f RFC \u3067\u53d6\u308a\u9664\u3051\u3068\u8a00\u3063\u3066\u307e\u3059\u2193\u3002\u672c\u9805\u3067\u306f\u3001access VLAN \u3057\u304b\u4f7f\u3063\u3066\u3044\u306a\u3044\u306e\u3067\u3001\u898b\u3066\u3044\u307e\u305b\u3093\u3002\n\na VTEP SHOULD NOT include an inner VLAN tag on tunnel packets\n\n\n\u672c\u9805\u3067\u53d6\u308a\u6271\u3046 VTEP \u5b9f\u88c5\n\nVyOS\nVyOS \u306a\u306e\u3067\u57fa\u672c\u7684\u306b Linux \u30d9\u30fc\u30b9\u3067\u3059\u3002\nVyOS \u306b VXLAN \u53d6\u308a\u8fbc\u3093\u3060\u3088\u3001\u3063\u3066\u8a71\u306f\u4f5c\u8005\u306e\u4ee5\u4e0b\u8cc7\u6599\u3092\u53c2\u7167\u3057\u3066\u4e0b\u3055\u3044\u3002\n\nVyOS Users Meeting #2, VyOS\u306eVXLAN\u306e\u8a71\n\nVXLAN \u306e dstport \u306b\u95a2\u3057\u3066(\u306e\u60a9\u307f\u3069\u3053\u308d)\u306f\u30b9\u30e9\u30a4\u30c9 23 \u306b\u66f8\u304b\u308c\u3066\u3044\u307e\u3059\u3002\nVyOS 1.1.1 \u73fe\u5728\u306f\u666e\u901a\u306b\u52d5\u304b\u3059\u3068\u3001dstport 8472 \u3067\u52d5\u304d\u307e\u3059\u3002\n\nArista\nVXLAN \u304c\u52d5\u304b\u306a\u3044\u6a5f\u5668\u7fa4\u3092\u53ce\u5bb9\u3057\u3066\u3001\u81ea\u5206\u304c VTEP \u3092\u3084\u308b Hardware VTEP \u3067\u3059\u3002(\u672c\u9805\u3067\u4f7f\u3046\u306e\u306f Software \u7248\u3067\u3059\u304c\u2026)\n\u30c7\u30d5\u30a9\u30eb\u30c8\u306e dstport \u306f 4789 \u3067\u3059\u304c\u3001\u8a2d\u5b9a\u3067\u5909\u66f4\u3057\u3066\u65e2\u5b58\u306e 8472 \u306b\u6b69\u307f\u5bc4\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\u672c\u9805\u3067\u306f\u3084\u308a\u307e\u305b\u3093\u304c\u3002\n\u3068\u308a\u3042\u3048\u305a\u3001\u30e1\u30fc\u30ab\u304c\u51fa\u3057\u3066\u3044\u308b\u5206\u304b\u308a\u6613\u3044\u8cc7\u6599\u306f\u4ee5\u4e0b\u3067\u3059\u3002\n\nOpenStack\u3068VXLAN - OpenStack Days Tokyo 2014\n\n\n\u74b0\u5883\u60c5\u5831\u306a\u3069\n\n\u69cb\u6210\u56f3/\u74b0\u5883\n\u4ee5\u4e0b\u306e\u69cb\u6210\u3067\u3084\u308a\u307e\u3059\u3002\u5168\u3066\u7bb1\u5ead\u306e\u4eee\u60f3\u74b0\u5883\u3067\u3059\u3002\n\u8d64\u3044\u30c6\u30ca\u30f3\u30c8\u3068\u9752\u3044\u30c6\u30ca\u30f3\u30c8\u3092 Isolation \u3057\u307e\u3059\u3001\u7684\u306a\u3002\n\n\u30eb\u30fc\u30bf\u306f multicast routing \u51fa\u6765\u308c\u3070\u3001\u4f55\u3067\u3082\u826f\u3044\u3067\u3059(VyOS 1.1.1 \u3067\u306f\u4e0d\u53ef\u3060\u3051\u3069\u5b9f\u88c5\u4e88\u5b9a\u306b\u306f\u5165\u3063\u3066\u3044\u308b\u307f\u305f\u3044)\u3002\n\u30ce\u30fc\u30c9\u306f\u4f55\u3067\u3082\u826f\u3044\u3067\u3059\u3002\n\u30db\u30b9\u30c8\u74b0\u5883\n\n\u30db\u30b9\u30c8\uff1aWindows7 + VirtualBox 4.3.18\n\nVyOS \u74b0\u5883 (VTEP)\n\nOS\uff1aVyOS 1.1.1\nCPU\uff1a1Core\nMemory\uff1a256MB\n\nArista \u74b0\u5883 (VTEP)\n\nAboot-veos\uff1aAboot-veos-2.1.0\nOS\uff1avEOS-4.14.2F\nCPU\uff1a1core\nMemory\uff1a1024MB\n\nFirefly \u74b0\u5883 (\u30eb\u30fc\u30bf)\n\nOS\uff1a12.1X47-D10.4\nCPU\uff1a2core\nMemory\uff1a2048MB\n\n\u30ce\u30fc\u30c9\u74b0\u5883 (4\u53f0\u5171)\n\nOS\uff1aUbuntu-14.04.01-server-amd64\n\n\n\u4e8b\u524d\u6e96\u5099\n\nVyOS \u306e\u30c7\u30d7\u30ed\u30a4\n\u4ee5\u4e0b\u3092\u53c2\u8003\u306b\u4f5c\u3063\u3066\u304a\u304d\u307e\u3059\u30022014/12/24 \u73fe\u5728\u306e\u6700\u65b0\u7248\u3067\u3042\u308b 1.1.1 \u3092\u4f7f\u3044\u307e\u3059\u3002\n\nUser Guide - Installation | \u516c\u5f0f\nVyOS \u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3068\u30a2\u30c3\u30d7\u30b0\u30ec\u30fc\u30c9 | higeblog\n\n\nArista(vEOS) \u306e\u30c7\u30d7\u30ed\u30a4\n\u4ee5\u4e0b\u30ea\u30f3\u30af\u3092\u53c2\u8003\u306b\u4f5c\u3063\u3066\u304a\u304d\u307e\u3059\u3002\u516c\u5f0f\u306b\u3001\u5404\u7a2e\u30cf\u30a4\u30d1\u30fc\u30d0\u30a4\u30b6\u3054\u3068\u306e\u5c0e\u5165\u624b\u9806\u8a73\u7d30\u3068\u304b\u3082\u3042\u308a\u307e\u3059\u3002\n\nvEOS \u2013 Running EOS in a VM | \u516c\u5f0f\nVirtualBox\u3067Arista\u306evEOS\u3092\u4f7f\u3048\u308b\u3088\u3046\u306b\u3059\u308b | pelican@ainoniwa.net\n\n\nFirefly \u306e\u30c7\u30d7\u30ed\u30a4\uff5e\u30eb\u30fc\u30bf\u30e2\u30fc\u30c9\u306b\u5909\u66f4\n\u4ee5\u4e0b\u30ea\u30f3\u30af\u3092\u53c2\u8003\u306b\u4f5c\u3063\u3066\u304a\u304d\u307e\u3059\u3002(\u3053\u308c\u306f VMPlayer \u7248\u3067\u3059\u304c\u3001\u5404\u7a2e\u30cf\u30a4\u30d1\u30fc\u30d0\u30a4\u30b6\u4f7f\u3048\u307e\u3059\u3002)\n\nVMware Player\u3067\u306f\u3058\u3081\u308bFirefly Perimeter - Firefly\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb | \u516c\u5f0f (PDF)\n\n\u3042\u3068\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u3060\u3068 firewall \u7684\u306a\u52d5\u4f5c\u3092\u3057\u3066\u9b31\u9676\u3057\u3044\u306e\u3067\u3001\u4ee5\u4e0b\u3092\u53c2\u8003\u306b\u30eb\u30fc\u30bf\u30e2\u30fc\u30c9(\u4fd7\u79f0)\u306b\u5207\u308a\u66ff\u3048\u3066\u304a\u304d\u307e\u3059\u3002\n\nVMware Player\u3067\u306f\u3058\u3081\u308bFirefly Perimeter - \u30e6\u30fc\u30b9\u30b1\u30fc\u30b92 :JUNOS Router  | \u516c\u5f0f (PDF)\n\n\nUbuntu \u306e\u30c7\u30d7\u30ed\u30a4\u3068\u8a2d\u5b9a\n\u30ce\u30fc\u30c9\u306e OS \u306f\u5225\u306b\u554f\u308f\u306a\u3044\u306e\u3067\u3001\u597d\u304d\u306b\u4f5c\u3063\u3066 IP \u30a2\u30c9\u30ec\u30b9\u8a2d\u5b9a\u3060\u3051\u3059\u308c\u3070 OK \u3067\u3059\u3002\nVLAN tag \u3068\u304b\u3082\u98df\u3044\u307e\u305b\u3093\u3002\n\n\u8a2d\u5b9a\n\nVyOS \u306e VXLAN \u8a2d\u5b9a\n\nmodprobe vxlan \u306b udp_port \u30aa\u30d7\u30b7\u30e7\u30f3\u8ffd\u8a18\n\u4e8b\u524d\u306b Linux Kernel \u3068 VyOS \u30d0\u30fc\u30b8\u30e7\u30f3\u78ba\u8a8d\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\nversion\u78ba\u8a8d\nkotetsu@vtep-vyos01:~$ uname -r\n3.13.11-1-amd64-vyos\n\nkotetsu@vtep-vyos01:~$ show version\nVersion:      VyOS 1.1.1\nDescription:  VyOS 1.1.1 (helium)\nCopyright:    2014 VyOS maintainers and contributors\nBuilt by:     maintainers@vyos.net\nBuilt on:     Sun Dec  7 21:41:28 UTC 2014\nBuild ID:     1412072141-129950d\nSystem type:  x86 64-bit\nBoot via:     disk\nHypervisor:   VirtualBox\nHW model:     VirtualBox\nHW S/N:       0\nHW UUID:      EF4B6725-D02A-47D3-8194-BFADF71F9987\nUptime:       23:17:43 up 22:39,  1 user,  load average: 0.01, 0.02, 0.05\n\n\nVXLAN \u306e Kernel module \u3092 modprobe \u3059\u308b\u6642\u70b9\u3067 dstport \u3092\u30c7\u30d5\u30a9\u30eb\u30c8\u306e 8472 \u304b\u3089 4789 \u306b\u5909\u66f4\u3055\u308c\u308b\u3088\u3046\u306b\u3001\u4ee5\u4e0b\u30d5\u30a1\u30a4\u30eb\u3092\u66f8\u304d\u63db\u3048\u307e\u3059\u3002\n\n/opt/vyatta/share/vyatta-cfg/templates/interfaces/vxlan/node.def\u7de8\u96c6\nkotetsu@vyos# ls -alh /opt/vyatta/share/vyatta-cfg/templates/interfaces/vxlan\ntotal 20K\ndrwxr-xr-x  3 root root 4.0K Dec 23 00:53 .\ndrwxr-xr-x 16 root root 4.0K Dec  8 06:44 ..\n-rw-r--r--  1 root root 1.1K Dec 23 00:53 node.def\n-rw-r--r--  1 root root 1.1K Oct 30 17:43 node.def.orig\ndrwxr-xr-x 13 root root 4.0K Dec  8 06:44 node.tag\n\nkotetsu@vyos:~$ sudo diff /opt/vyatta/share/vyatta-cfg/templates/interfaces/vxlan/node.def /opt/vyatta/share/vyatta-cfg/templates/interfaces/vxlan/node.def.orig\n14c14\n<   [ -d /sys/module/vxlan ] || sudo modprobe vxlan udp_port=4789\n---\n>   [ -d /sys/module/vxlan ] || sudo modprobe vxlan\n\n\n\nCLI \u3067\u8a2d\u5b9a\n\u3067\u306f\u69cb\u6210\u56f3\u306e\u3088\u3046\u306b\u9806\u6b21\u8a2d\u5b9a\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\nbridge\u3068\u7269\u7406IF\u8a2d\u5b9a\nset interfaces ethernet eth2 address '172.16.2.1/24'\n\nset interfaces bridge 'br100'\nset interfaces bridge 'br200'\n\nset interfaces ethernet eth3 bridge-group bridge 'br100'\nset interfaces ethernet eth4 bridge-group bridge 'br200'\n\n\n\nVXLAN\u8a2d\u5b9a\nset interfaces vxlan vxlan0 bridge-group bridge 'br100'\nset interfaces vxlan vxlan0 group '239.0.0.1'\nset interfaces vxlan vxlan0 link 'eth2'\nset interfaces vxlan vxlan0 vni '10'\n\nset interfaces vxlan vxlan1 bridge-group bridge 'br200'\nset interfaces vxlan vxlan1 group '239.0.0.1'\nset interfaces vxlan vxlan1 link 'eth2'\nset interfaces vxlan vxlan1 vni '20'\n\n\nVyOS \u304c\u8a8d\u8b58\u3057\u306a\u3044\u3068\u3044\u3051\u306a\u3044 Arista \u5074\u306e VTEP IP \u30a2\u30c9\u30ec\u30b9\u306f\u3001Arista \u306e Loopback \u30a2\u30c9\u30ec\u30b9\u306b\u306a\u308b\u306e\u3067\u3001StaticRoute \u3092\u8ffd\u52a0\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n#\u3053\u308c\u3060\u3068\u62e1\u5f35\u304c\u9762\u5012\u306a\u306e\u3067\u3001\u5b9f\u74b0\u5883\u3067\u306f DefaultRoute \u304b\u52d5\u7684\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3092\u4f7f\u3046\u3053\u3068\u304c\u591a\u3044\u6c17\u304c\u3057\u307e\u3059\u3002\n\nVXLAN\u8a2d\u5b9a\nset protocols static route 172.16.3.1/32 next-hop '172.16.2.254'\n\n\ncommit \uff5e save \u3057\u3066\u8a2d\u5b9a\u78ba\u8a8d\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n\u8a2d\u5b9a\u78ba\u8a8d\n\n\u8a2d\u5b9a\u78ba\u8a8d(bridge)\nkotetsu@vtep-vyos01:~$ show bridge\nbridge name     bridge id               STP enabled     interfaces\nbr100           0000.0800272ede56       no              eth3\n                                                        vxlan0\nbr200           0000.0800276532b1       no              eth4\n                                                        vxlan1\n\n\n\n\u8a2d\u5b9a\u78ba\u8a8d(VXLAN)\nkotetsu@vtep-vyos01:~$ show interfaces vxlan\nCodes: S - State, L - Link, u - Up, D - Down, A - Admin Down\nInterface        IP Address                        S/L  Description\n---------        ----------                        ---  -----------\nvxlan0           -                                 u/u\nvxlan1           -                                 u/u\n\nkotetsu@vtep-vyos01:~$ ip -d link show vxlan0\n10: vxlan0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue master br100 state UNKNOWN mode DEFAULT group default\n    link/ether 96:3e:2b:62:6a:57 brd ff:ff:ff:ff:ff:ff promiscuity 1\n    vxlan id 10 group 239.0.0.1 dev eth2 port 32768 61000 ttl 16 ageing 300\n\nkotetsu@vtep-vyos01:~$ ip -d link show vxlan1\n15: vxlan1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue master br200 state UNKNOWN mode DEFAULT group default\n    link/ether 8e:02:68:1e:d2:69 brd ff:ff:ff:ff:ff:ff promiscuity 1\n    vxlan id 20 group 239.0.0.1 dev eth2 port 32768 61000 ttl 16 ageing 300\n\n\n\n\n\nArista(vEOS) \u306e VXLAN \u8a2d\u5b9a\n\n\u8a2d\u5b9a\n\nVLAN/\u7269\u7406IF\u8a2d\u5b9a\nvlan 100,200\n\ninterface Ethernet1\n   description DEV=fw01 IF=ge-0/0/2\n   no switchport\n   ip address 172.16.1.1/24\n!\ninterface Ethernet2\n   description DEV=node001 IF=eth2\n   switchport access vlan 100\n!\ninterface Ethernet3\n   description DEV=node101 IF=eth2\n   switchport access vlan 200\n\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b VXLAN \u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u306e source-interface \u306b\u306f\u3001Loopback Interface \u3057\u304b\u9069\u7528\u3067\u304d\u307e\u305b\u3093\u3002VyOS \u306a\u3069\u306e dev \u3068\u540c\u3058\u30ce\u30ea\u3067\u7269\u7406IF\u3092\u6307\u5b9a\u3067\u304d\u308b\u304b\u3068\u601d\u3044\u304d\u3084\u2026\u3002\n\nVXLAN\u8a2d\u5b9a\ninterface Loopback0\n   ip address 172.16.3.1/32\n!\ninterface Vxlan1\n   vxlan multicast-group 239.0.0.1\n   vxlan source-interface Loopback0\n   vxlan udp-port 4789\n   vxlan vlan 100 vni 10\n   vxlan vlan 200 vni 20\n\n\n\u3053\u306e\u307e\u307e\u3060\u3068 VTEP \u306f 239.0.0.1 \u5b9b\u306e\u901a\u4fe1\u3092\u3069\u3053\u306b\u6295\u3052\u308c\u3070\u3044\u3044\u306e\u304b\u5206\u304b\u3089\u306a\u3044\u306e\u3067\u3001Multicast Routing \u306e\u8a2d\u5b9a\u3092\u3057\u307e\u3059\u3002\n\nStaticRoute&MulticastRouting\u8a2d\u5b9a\nip routing\nip multicast-routing\n\ninterface Ethernet1\n   ip pim sparse-mode\n\nip pim rp-address 172.16.1.254\n\nip route 172.16.2.0/24 172.16.1.254\n\n\n\n\u8a2d\u5b9a\u78ba\u8a8d\n\n\u8a2d\u5b9a\u78ba\u8a8d(VXLAN)\nvtep-arista01#show interfaces vxlan 1\nVxlan1 is up, line protocol is up (connected)\n  Hardware is Vxlan\n  Source interface is Loopback0 and is active with 172.16.3.1\n  Replication/Flood Mode is multicast\n  Static vlan to vni mapping is\n    [100, 10]         [200, 20]\n  Multicast group address is 239.0.0.1\n\n\nvtep-arista01#show vxlan vtep\nRemote vteps for Vxlan1:\nTotal number of remote vteps:  0\n\n\nvtep-arista01#show vxlan counters software\nRx bytes for encapsulation                      :  0\nRx pkts for encapsulation                       :  0\nEncaped bytes                                   :  0\nEncaped packets                                 :  0\nTx bytes after encapsulation                    :  0\nTx pkts after encapsulation                     :  0\nRx dot1Q Tunnel pkts for encapsulation          :  0\nRx bytes after decapsulation                    :  0\nRx pkts after decapsulation                     :  0\nDecaped bytes                                   :  0\nDecaped packets                                 :  0\nARP bytes                                       :  0\nARP packets                                     :  0\n\nRead error for pkts coming in for encapsulation :  0\nDiscarded runt pkts ( encap side )              :  0\nDiscard vlan range ( encap eide )               :  0\nDiscard vlan map ( encap side )                 :  0\nDiscard mlag peer link ( encap side )           :  0\nDiscarded pkts due to empty flood list          :  0\nEncap send error                                :  0\nEncap timeout                                   :  0\nDiscarded runt pkts ( decap side )              :  0\nDiscard pkts not for vtep ( decap side )        :  0\nDiscard bytes not for vtep ( decap side )       :  0\nDiscard pkts with invalid vxlan header          :  0\nDiscard vlan map ( decap side )                 :  0\nDiscard VNI range ( decap side )                :  0\nDecap timeout                                   :  0\nDecap socket error                              :  0\nARP send error                                  :  0\n\n\nvtep-arista01#show vxlan address-table\n          Vxlan Mac Address Table\n----------------------------------------------------------------------\n\nVlan  Mac Address     Type     Prt  Vtep             Moves   Last Move\n----  -----------     ----     ---  ----             -----   ---------\nTotal Remote Mac Addresses for this criterion: 0\n\nvtep-arista01#show vxlan counters varp\narp cache installed:                    0\nvxlan encapsulated arps:                0\narp reply to vArp mac and vArp vtep:    0\narp reply RX:                           0\narp reply head-end-replicated:          0\narp reply TX:                           0\narp request decaped and sent:           0\n\narp cache install err                   0\narp request decap and send TX err:      0\nunknown cpu port id:                    0\npacket too short:                       0\nunexpected ether type:                  0\nunexpected non IP packet                0\nunexpected IP prot                      0\nunexpected UPD port                     0\nunexpected inner packet                 0\nunexpected arp reply                    0\ninvalid IP checksum                     0\ninvalid Vxlan header                    0\ninvalid arp packet                      0\nunknown vlan to vni mapping             0\nunknown source IP                       0\nno BUM flood list TX err                0\narp reply to Arp agent TX err           0\n\n\n\nFirefly \u306e multicast routing \u8a2d\u5b9a\n\n\u8a2d\u5b9a\nVXLAN \u306e RFC \u306b\u306f dense \u3088\u308a bidirectional PIM \u304c\u52b9\u679c\u7684\u304b\u3082\u306d\u3001\u3068\u66f8\u3044\u3066\u3042\u308a\u307e\u3059\u3002\n\u30ac\u30f3\u7121\u8996\u3057\u3066\u3001\u3053\u3053\u306f\u7c21\u5358\u306a dense \u8a2d\u5b9a\u3067\u3044\u304d\u307e\u3059\u3002\n\n\u8a2d\u5b9a\u78ba\u8a8d(\u7269\u7406IF\u3001StaticRoute\u3001MulticastRouting)\nset interfaces ge-0/0/2 unit 0 family inet address 172.16.1.254/24\nset interfaces ge-0/0/3 unit 0 family inet address 172.16.2.254/24\n\nset routing-options static route 172.16.3.1/32 next-hop 172.16.1.1\n\nset protocols pim interface ge-0/0/2.0 mode dense\nset protocols pim interface ge-0/0/3.0 mode dense\n\n\n\n\u52d5\u4f5c\u78ba\u8a8d\n\n\u758e\u901a\n\u8d64 node \u540c\u58eb\u3001\u9752 node \u540c\u58eb\u304c\u758e\u901a\u53ef\u80fd\u306a\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\u3053\u306e\u6642\u3001VyOS \u3084 Arista \u3067 tcpdump \u304b\u3051\u3066\u304a\u304d\u5f8c\u3067\u78ba\u8a8d\u3057\u307e\u3059\u3002\n# \u758e\u901a\u3057\u305f\u306f\u826f\u3044\u304c\u3001\u7570\u69d8\u306b RTT \u304c\u3067\u304b\u3044\u2026\u3002firefly \u3068 Arista \u9593\u3082\u305d\u3093\u306a\u611f\u3058\u3067\u3001\u30b7\u30e7\u30dc\u3044\u30de\u30b7\u30f3\u3067Arista \u52d5\u304b\u3057\u3066\u3044\u308b\u6240\u70ba\u304b\u3082\u3002\n\nnode001\n$ ping 10.0.0.2\nPING 10.0.0.2 (10.0.0.2) 56(84) bytes of data.\n64 bytes from 10.0.0.2: icmp_seq=1 ttl=64 time=72.9 ms\n64 bytes from 10.0.0.2: icmp_seq=2 ttl=64 time=67.2 ms\n64 bytes from 10.0.0.2: icmp_seq=3 ttl=64 time=63.2 ms\n64 bytes from 10.0.0.2: icmp_seq=4 ttl=64 time=163 ms\n64 bytes from 10.0.0.2: icmp_seq=5 ttl=64 time=75.7 ms\n64 bytes from 10.0.0.2: icmp_seq=6 ttl=64 time=67.2 ms\n64 bytes from 10.0.0.2: icmp_seq=7 ttl=64 time=68.8 ms\n64 bytes from 10.0.0.2: icmp_seq=8 ttl=64 time=73.7 ms\n64 bytes from 10.0.0.2: icmp_seq=9 ttl=64 time=55.3 ms\n64 bytes from 10.0.0.2: icmp_seq=10 ttl=64 time=102 ms\n64 bytes from 10.0.0.2: icmp_seq=11 ttl=64 time=38.5 ms\n64 bytes from 10.0.0.2: icmp_seq=12 ttl=64 time=33.0 ms\n64 bytes from 10.0.0.2: icmp_seq=13 ttl=64 time=35.1 ms\n64 bytes from 10.0.0.2: icmp_seq=14 ttl=64 time=31.7 ms\n\n\n\nnode101\n~$ ping 10.0.0.2\nPING 10.0.0.2 (10.0.0.2) 56(84) bytes of data.\n64 bytes from 10.0.0.2: icmp_seq=1 ttl=64 time=70.6 ms\n64 bytes from 10.0.0.2: icmp_seq=2 ttl=64 time=62.5 ms\n64 bytes from 10.0.0.2: icmp_seq=3 ttl=64 time=100 ms\n64 bytes from 10.0.0.2: icmp_seq=4 ttl=64 time=38.6 ms\n64 bytes from 10.0.0.2: icmp_seq=5 ttl=64 time=35.3 ms\n64 bytes from 10.0.0.2: icmp_seq=6 ttl=64 time=30.0 ms\n64 bytes from 10.0.0.2: icmp_seq=7 ttl=64 time=34.4 ms\n64 bytes from 10.0.0.2: icmp_seq=8 ttl=64 time=26.1 ms\n64 bytes from 10.0.0.2: icmp_seq=9 ttl=64 time=29.9 ms\n64 bytes from 10.0.0.2: icmp_seq=10 ttl=64 time=28.7 ms\n64 bytes from 10.0.0.2: icmp_seq=11 ttl=64 time=25.9 ms\n64 bytes from 10.0.0.2: icmp_seq=12 ttl=64 time=24.8 ms\n64 bytes from 10.0.0.2: icmp_seq=13 ttl=64 time=24.4 ms\n\n\n\nnode002\n$ ping 10.0.0.1\nPING 10.0.0.1 (10.0.0.1) 56(84) bytes of data.\n64 bytes from 10.0.0.1: icmp_seq=1 ttl=64 time=24.3 ms\n64 bytes from 10.0.0.1: icmp_seq=2 ttl=64 time=25.9 ms\n64 bytes from 10.0.0.1: icmp_seq=3 ttl=64 time=28.5 ms\n64 bytes from 10.0.0.1: icmp_seq=4 ttl=64 time=24.7 ms\n64 bytes from 10.0.0.1: icmp_seq=5 ttl=64 time=26.2 ms\n64 bytes from 10.0.0.1: icmp_seq=6 ttl=64 time=59.4 ms\n64 bytes from 10.0.0.1: icmp_seq=7 ttl=64 time=29.0 ms\n64 bytes from 10.0.0.1: icmp_seq=8 ttl=64 time=26.9 ms\n64 bytes from 10.0.0.1: icmp_seq=9 ttl=64 time=72.5 ms\n64 bytes from 10.0.0.1: icmp_seq=10 ttl=64 time=55.1 ms\n64 bytes from 10.0.0.1: icmp_seq=11 ttl=64 time=49.7 ms\n64 bytes from 10.0.0.1: icmp_seq=12 ttl=64 time=92.5 ms\n64 bytes from 10.0.0.1: icmp_seq=13 ttl=64 time=45.3 ms\n64 bytes from 10.0.0.1: icmp_seq=14 ttl=64 time=41.3 ms\n64 bytes from 10.0.0.1: icmp_seq=15 ttl=64 time=37.7 ms\n64 bytes from 10.0.0.1: icmp_seq=16 ttl=64 time=36.7 ms\n64 bytes from 10.0.0.1: icmp_seq=17 ttl=64 time=35.3 ms\n\n\n\nnode102\n$ ping 10.0.0.1\nPING 10.0.0.1 (10.0.0.1) 56(84) bytes of data.\n64 bytes from 10.0.0.1: icmp_seq=1 ttl=64 time=26.2 ms\n64 bytes from 10.0.0.1: icmp_seq=2 ttl=64 time=23.4 ms\n64 bytes from 10.0.0.1: icmp_seq=3 ttl=64 time=28.3 ms\n64 bytes from 10.0.0.1: icmp_seq=4 ttl=64 time=73.0 ms\n64 bytes from 10.0.0.1: icmp_seq=5 ttl=64 time=65.0 ms\n64 bytes from 10.0.0.1: icmp_seq=6 ttl=64 time=62.3 ms\n64 bytes from 10.0.0.1: icmp_seq=7 ttl=64 time=112 ms\n64 bytes from 10.0.0.1: icmp_seq=8 ttl=64 time=45.6 ms\n64 bytes from 10.0.0.1: icmp_seq=9 ttl=64 time=38.3 ms\n64 bytes from 10.0.0.1: icmp_seq=10 ttl=64 time=35.6 ms\n64 bytes from 10.0.0.1: icmp_seq=11 ttl=64 time=34.9 ms\n64 bytes from 10.0.0.1: icmp_seq=12 ttl=64 time=40.1 ms\n64 bytes from 10.0.0.1: icmp_seq=13 ttl=64 time=38.3 ms\n\n\n\nVTEP\u72b6\u614b\u78ba\u8a8d\n\nvtep-vyos01\nkotetsu@vtep-vyos01:~$ show interfaces vxlan detail\nvxlan0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue master br100 state UNKNOWN group default\n    link/ether fe:61:bc:ca:cd:1d brd ff:ff:ff:ff:ff:ff\n    inet6 fe80::fc61:bcff:feca:cd1d/64 scope link\n       valid_lft forever preferred_lft forever\n\n    RX:  bytes    packets     errors    dropped    overrun      mcast\n        117556       1480          0          0          0          0\n    TX:  bytes    packets     errors    dropped    carrier collisions\n        383710       4382          0          0          0          0\nvxlan1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue master br200 state UNKNOWN group default\n    link/ether b2:02:ef:4e:26:d4 brd ff:ff:ff:ff:ff:ff\n    inet6 fe80::b002:efff:fe4e:26d4/64 scope link\n       valid_lft forever preferred_lft forever\n\n    RX:  bytes    packets     errors    dropped    overrun      mcast\n        232330       3109          0          0          0          0\n    TX:  bytes    packets     errors    dropped    carrier collisions\n        490658       5270          0          0          0          0\n\n\n\nvtep-arista01\nvtep-arista01#show vxlan vtep\nRemote vteps for Vxlan1:\n172.16.2.1\nTotal number of remote vteps:  1\n\n\n\nvtep-arista01#show mac address-table\n          Mac Address Table\n------------------------------------------------------------------\n\nVlan    Mac Address       Type        Ports      Moves   Last Move\n----    -----------       ----        -----      -----   ---------\n 100    0800.272d.daa2    DYNAMIC     Vx1        1       0:14:19 ago\n 100    0800.27a6.f13d    DYNAMIC     Et2        1       0:14:22 ago\n 200    0800.272c.080f    DYNAMIC     Et3        1       0:11:05 ago\n 200    0800.27a9.6b58    DYNAMIC     Vx1        1       0:10:33 ago\nTotal Mac Addresses for this criterion: 4\n\n          Multicast Mac Address Table\n------------------------------------------------------------------\n\nVlan    Mac Address       Type        Ports\n----    -----------       ----        -----\nTotal Mac Addresses for this criterion: 0\n\n\nvtep-arista01#show vxlan address-table\n          Vxlan Mac Address Table\n----------------------------------------------------------------------\n\nVlan  Mac Address     Type     Prt  Vtep             Moves   Last Move\n----  -----------     ----     ---  ----             -----   ---------\n 100  0800.272d.daa2  DYNAMIC  Vx1  172.16.2.1       1       0:14:15 ago\n 200  0800.27a9.6b58  DYNAMIC  Vx1  172.16.2.1       1       0:10:28 ago\nTotal Remote Mac Addresses for this criterion: 2\n\nvtep-arista01#show vxlan counters software\nRx bytes for encapsulation                      :  249372\nRx pkts for encapsulation                       :  2390\nEncaped bytes                                   :  249372\nEncaped packets                                 :  2390\nTx bytes after encapsulation                    :  306732\nTx pkts after encapsulation                     :  2390\nRx dot1Q Tunnel pkts for encapsulation          :  0\nRx bytes after decapsulation                    :  79320\nRx pkts after decapsulation                     :  733\nDecaped bytes                                   :  23664\nDecaped packets                                 :  348\nARP bytes                                       :  0\nARP packets                                     :  0\n\nRead error for pkts coming in for encapsulation :  0\nDiscarded runt pkts ( encap side )              :  0\nDiscard vlan range ( encap eide )               :  0\nDiscard vlan map ( encap side )                 :  0\nDiscard mlag peer link ( encap side )           :  0\nDiscarded pkts due to empty flood list          :  0\nEncap send error                                :  0\nEncap timeout                                   :  0\nDiscarded runt pkts ( decap side )              :  1\nDiscard pkts not for vtep ( decap side )        :  384\nDiscard bytes not for vtep ( decap side )       :  40980\nDiscard pkts with invalid vxlan header          :  0\nDiscard vlan map ( decap side )                 :  0\nDiscard VNI range ( decap side )                :  0\nDecap timeout                                   :  0\nDecap socket error                              :  0\nARP send error                                  :  0\nvtep-arista01#\n\n\nvtep-arista01#show vxlan counters varp\narp cache installed:                    0\nvxlan encapsulated arps:                2\narp reply to vArp mac and vArp vtep:    0\narp reply RX:                           0\narp reply head-end-replicated:          0\narp reply TX:                           0\narp request decaped and sent:           2\n\narp cache install err                   0\narp request decap and send TX err:      0\nunknown cpu port id:                    0\npacket too short:                       0\nunexpected ether type:                  0\nunexpected non IP packet                0\nunexpected IP prot                      0\nunexpected UPD port                     0\nunexpected inner packet                 0\nunexpected arp reply                    0\ninvalid IP checksum                     0\ninvalid Vxlan header                    0\ninvalid arp packet                      0\nunknown vlan to vni mapping             0\nunknown source IP                       0\nno BUM flood list TX err                0\narp reply to Arp agent TX err           0\n\n\n\n\n\u30d1\u30b1\u30c3\u30c8\u30ad\u30e3\u30d7\u30c1\u30e3\n\u7279\u5fb4\u7684\u306a\u3082\u306e\u3092\u3044\u304f\u3064\u304b\u753b\u9762\u30ad\u30e3\u30d7\u30c1\u30e3\u3067\u8cbc\u3063\u3066\u3044\u304d\u307e\u3059\u3002\n\u2193 node \u304b\u3089\u306e BUM \u30c8\u30e9\u30d5\u30a3\u30c3\u30af(ping \u5b9f\u884c\u6642\u6700\u521d\u306e ARP)\u306f\u3001\u8a2d\u5b9a\u3057\u305f\u30de\u30eb\u30c1\u30ad\u30e3\u30b9\u30c8\u30a2\u30c9\u30ec\u30b9\u3067\u3002\n\n\u2193 VNI10 \u5074\u3002VTEP \u9593\u306e\u30e6\u30cb\u30ad\u30e3\u30b9\u30c8\u306b\u30ab\u30d7\u30bb\u30ea\u30f3\u30b0\u3055\u308c\u3066\u3044\u308b\u306e\u304c\u3088\u304f\u5206\u304b\u308b\u3002\u307e\u305f\u3001\u6307\u5b9a\u3069\u304a\u308a UDP dstport 4789 \u3067\u52d5\u4f5c\u3057\u3066\u3044\u308b\u3002\n\n\n\u2193VNI20 \u5074\u3082\u4e00\u7dd2\u3002\n\n\n\u304a\u3057\u307e\u3044\n\n\u96d1\u611f\n\n\u3053\u306e\u3088\u3046\u306b\u5229\u7528\u3059\u308b UDP dstport \u304c\u7570\u306a\u308b\u3088\u3046\u306a VTEP \u9593\u3067\u3082\u3001\u305d\u308c\u3055\u3048\u63c3\u3048\u3066\u3057\u307e\u3048\u3070\u76f8\u4e92\u63a5\u7d9a\u3082\u30c1\u30e7\u30ed\u3044\u3082\u306e\u3067\u3059\u3002\n\u307e\u3042\u3001\u666e\u901a\u306f\u8a2d\u5b9a\u4e00\u767a\u3067 UDP dstport \u3092\u5909\u66f4\u3067\u304d\u308b\u3084\u3064(\u4eca\u56de\u306e\u30b1\u30fc\u30b9\u3067\u3044\u3046\u3068 Arista \u5074)\u3067\u5909\u66f4\u3059\u308b\u3068\u601d\u3044\u307e\u3059\u3002\u4eca\u56de VyOS \u3067\u3084\u3063\u305f\u306e\u306f\u305f\u3060\u306e\u8208\u5473\u672c\u4f4d\u3067\u3059\u3002\nVyOS \u3092 VTEP \u3068\u3057\u3066\u4f7f\u3046\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\u304c\u307e\u3060\u898b\u3048\u3066\u304d\u307e\u305b\u3093\u3002\u30cf\u30a4\u30d1\u30fc\u30d0\u30a4\u30b61\u53f0\u306b1\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30d0\u30e9\u307e\u304f\u3068\u304b\uff1f\n\u30de\u30eb\u30c1\u30ad\u30e3\u30b9\u30c8\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3092\u52c9\u5f37\u3057\u3088\u3046\u3002\n\n\u307e\u305f Arista \u3067\u3059\u304b\uff1f\n\u3044\u3048\u3001\u3053\u308c\u306f [VyOS Advent Calendar 2014](http://qiita.com/advent-calendar/2014/vyos) \u306e\u8a18\u4e8b\u3067\u3059\u3002\n\n# \u6982\u8981\n\n## \u672c\u9805\u3067\u3084\u308b\u3053\u3068\n\nVyOS \u3068 Arista \u3067 VXLAN \u76f8\u4e92\u63a5\u7d9a\u3057\u307e\u3059\u3002\n\u3068\u306f\u3044\u3048\u3001interoperability \u3067\u8272\u3005\u75db\u3044\u76ee\u306b\u3042\u3063\u3066\u304d\u305f\u4eba\u304c\u601d\u3046\u3088\u3046\u306a\u82e6\u96e3\u306f\u5168\u304f\u7121\u3044\u3067\u3059\u3002\nArista \u3068 VyOS \u3067\u306f VXLAN \u3067\u4f7f\u304a\u3046\u3068\u3059\u308b dstPort \u756a\u53f7\u304c\u7570\u306a\u308b\u306e\u3067\u3059\u304c\u3001VyOS \u306e\u8a18\u4e8b\u306a\u306e\u3067\u6562\u3048\u3066 VyOS \u5074\u3067\u3053\u308c\u3092\u5909\u3048\u307e\u3059\u3002\n\\# \u30c7\u30d5\u30a1\u30af\u30c8\u30b9\u30bf\u30f3\u30c0\u30fc\u30c9\u306a openvswitch \u3067\u306f\u306a\u304f\u3001\u4f55\u3067\u30cb\u30c3\u30c1\u306a\u30a2\u30ec\u540c\u58eb\u3067\u2026\u3068\u3044\u3046\u30c4\u30c3\u30b3\u30df\u306f\u4e0d\u53ef\u3002\n\n\n# \u524d\u6bb5\n\n## VXLAN \u3068\u306f?\n\n* [https://tools.ietf.org/html/rfc7348](https://tools.ietf.org/html/rfc7348)\n\n## VXLAN \u76f8\u4e92\u63a5\u7d9a\u3067\u6c17\u306b\u3059\u3079\u304d\u70b9\n\n\u4e8b\u524d\u306e\u9375\u4ea4\u63db phase \u3084\u3089\u306e\u9762\u5012\u3054\u3068\u304c\u7121\u3044\u30b7\u30f3\u30d7\u30eb\u306a\u30d7\u30ed\u30c8\u30b3\u30eb\u306a\u306e\u3067\u30012 \u53f0\u3067\u76f8\u4e92\u63a5\u7d9a\u3059\u308b\u5206\u306b\u306f\u5de6\u7a0b\u6c17\u3092\u3064\u3051\u308b\u70b9\u306f\u7121\u3044\u3067\u3059\u3002\n\n\u4eca\u5e74\u306e Shownet \u3067\u306f\u3001\u5404\u30e1\u30fc\u30ab\u306e\u7bb1\u30e2\u30ce\u3067\u76f8\u4e92\u63a5\u7d9a\u5b9f\u9a13\u3068\u304b\u3084\u3063\u3066\u3044\u3066\u3001(\u4ee5\u4e0b\u306e\u30b9\u30e9\u30a4\u30c9 68-75)\n\n* [ShowNet 2014\u6d3b\u52d5\u30ec\u30dd\u30fc\u30c8 Vol.1 (PDF)](http://www.f2ff.jp/interop/2014/ShowNet2014_Report_Vol1.pdf)\n\n\u3053\u308c\u3092\u898b\u3066\u3082\u6c17\u306b\u3059\u308b\u70b9\u306f\u4ee5\u4e0b\u304f\u3089\u3044\u3060\u3068\u5206\u304b\u308a\u307e\u3059\u3002\n\n* BUM \u30c8\u30e9\u30d5\u30a3\u30c3\u30af\u8ee2\u9001\u65b9\u6cd5 (Unicast or Multicast)\n* UDP dstport \u756a\u53f7 (4789 or 8472)\n* VXLAN \u30ab\u30d7\u30bb\u30ea\u30f3\u30b0\u6642\u306e 802.1q tag \u53d6\u6271\u3044 (\u9664\u53bb or \u305d\u306e\u307e\u307e)\n\n1 \u3064\u76ee\u306f\u88fd\u54c1\u306b\u3088\u3063\u3066\u30de\u30c1\u30de\u30c1\u3067\u3059\u3002RFC \u3067\u306f Multicast \u5b9f\u88c5\u304c\u793a\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n2 \u3064\u76ee\u306f\u3001\u672c\u9805\u3067\u3082\u6c17\u306b\u3057\u3066\u3044\u307e\u3059\u3002draft \u3067\u300cIANA \u304b\u3089 UDP \u30dd\u30fc\u30c8\u756a\u53f7\u5272\u308a\u5f53\u3066\u3066\u3082\u3089\u308f\u306a\u3044\u3068\uff5e\u300d\u3068\u8a00\u3063\u3066\u3044\u308b\u6642\u4ee3\u304c\u9577\u304b\u3063\u305f\u304b\u3089\u306a\u306e\u304b\u3001Linux VXLAN \u3067\u306f 8472 \u304c\u4eca\u3082\u4f7f\u308f\u308c\u3066\u3044\u307e\u3059\u3002\u305d\u306e\u5185\u3069\u3046\u306b\u304b\u3057\u306a\u3044\u3068\u3001\u3063\u3066\u30b9\u30bf\u30f3\u30b9\u3067\u306f\u3042\u308b\u3088\u3046\u3067\u3059\u3002( [Linux/drivers/net/vxlan.c](http://lxr.free-electrons.com/source/drivers/net/vxlan.c?v=3.13#L73) \u53c2\u7167)\n\u73fe\u5728\u306f IANA \u304b\u3089 4789 \u3092\u5272\u308a\u5f53\u3066\u3089\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u6700\u8fd1\u306f\u305d\u308c\u3092\u4f7f\u3063\u3066\u3044\u308b\u30fb\u904e\u53bb\u306e\u7d4c\u7def\u3092\u8003\u616e\u3057\u3066 dstport \u5909\u66f4\u53ef\u80fd\u306a\u88fd\u54c1\u304c\u591a\u3044\u3067\u3059\u3002\n\n3 \u3064\u76ee\u306f [RFC](https://tools.ietf.org/html/rfc7348#section-6.1) \u3067\u53d6\u308a\u9664\u3051\u3068\u8a00\u3063\u3066\u307e\u3059\u2193\u3002\u672c\u9805\u3067\u306f\u3001access VLAN \u3057\u304b\u4f7f\u3063\u3066\u3044\u306a\u3044\u306e\u3067\u3001\u898b\u3066\u3044\u307e\u305b\u3093\u3002\n> a VTEP SHOULD NOT include an inner VLAN tag on tunnel packets\n\n## \u672c\u9805\u3067\u53d6\u308a\u6271\u3046 VTEP \u5b9f\u88c5\n\n### VyOS\n\nVyOS \u306a\u306e\u3067\u57fa\u672c\u7684\u306b Linux \u30d9\u30fc\u30b9\u3067\u3059\u3002\nVyOS \u306b VXLAN \u53d6\u308a\u8fbc\u3093\u3060\u3088\u3001\u3063\u3066\u8a71\u306f\u4f5c\u8005\u306e\u4ee5\u4e0b\u8cc7\u6599\u3092\u53c2\u7167\u3057\u3066\u4e0b\u3055\u3044\u3002\n\n* [VyOS Users Meeting #2, VyOS\u306eVXLAN\u306e\u8a71](http://www.slideshare.net/upaa/vyos-users-meeting-2-vyosvxlan)\n\nVXLAN \u306e dstport \u306b\u95a2\u3057\u3066(\u306e\u60a9\u307f\u3069\u3053\u308d)\u306f\u30b9\u30e9\u30a4\u30c9 23 \u306b\u66f8\u304b\u308c\u3066\u3044\u307e\u3059\u3002\nVyOS 1.1.1 \u73fe\u5728\u306f\u666e\u901a\u306b\u52d5\u304b\u3059\u3068\u3001dstport 8472 \u3067\u52d5\u304d\u307e\u3059\u3002\n\n### Arista\n\nVXLAN \u304c\u52d5\u304b\u306a\u3044\u6a5f\u5668\u7fa4\u3092\u53ce\u5bb9\u3057\u3066\u3001\u81ea\u5206\u304c VTEP \u3092\u3084\u308b Hardware VTEP \u3067\u3059\u3002(\u672c\u9805\u3067\u4f7f\u3046\u306e\u306f Software \u7248\u3067\u3059\u304c\u2026)\n\u30c7\u30d5\u30a9\u30eb\u30c8\u306e dstport \u306f 4789 \u3067\u3059\u304c\u3001\u8a2d\u5b9a\u3067\u5909\u66f4\u3057\u3066\u65e2\u5b58\u306e 8472 \u306b\u6b69\u307f\u5bc4\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\u672c\u9805\u3067\u306f\u3084\u308a\u307e\u305b\u3093\u304c\u3002\n\u3068\u308a\u3042\u3048\u305a\u3001\u30e1\u30fc\u30ab\u304c\u51fa\u3057\u3066\u3044\u308b\u5206\u304b\u308a\u6613\u3044\u8cc7\u6599\u306f\u4ee5\u4e0b\u3067\u3059\u3002\n\n* [OpenStack\u3068VXLAN - OpenStack Days Tokyo 2014](http://openstackdays.com/files/A1_Arista2014.pdf)\n\n\n# \u74b0\u5883\u60c5\u5831\u306a\u3069\n\n## \u69cb\u6210\u56f3/\u74b0\u5883\n\n\u4ee5\u4e0b\u306e\u69cb\u6210\u3067\u3084\u308a\u307e\u3059\u3002\u5168\u3066\u7bb1\u5ead\u306e\u4eee\u60f3\u74b0\u5883\u3067\u3059\u3002\n\u8d64\u3044\u30c6\u30ca\u30f3\u30c8\u3068\u9752\u3044\u30c6\u30ca\u30f3\u30c8\u3092 Isolation \u3057\u307e\u3059\u3001\u7684\u306a\u3002\n\n![arista6.jpg](https://qiita-image-store.s3.amazonaws.com/0/60456/da9fd3cc-dba4-36e0-05fa-a9b01d85886b.jpeg)\n\n\u30eb\u30fc\u30bf\u306f multicast routing \u51fa\u6765\u308c\u3070\u3001\u4f55\u3067\u3082\u826f\u3044\u3067\u3059(VyOS 1.1.1 \u3067\u306f\u4e0d\u53ef\u3060\u3051\u3069\u5b9f\u88c5\u4e88\u5b9a\u306b\u306f\u5165\u3063\u3066\u3044\u308b\u307f\u305f\u3044)\u3002\n\u30ce\u30fc\u30c9\u306f\u4f55\u3067\u3082\u826f\u3044\u3067\u3059\u3002\n\n\n\u30db\u30b9\u30c8\u74b0\u5883\n\n* \u30db\u30b9\u30c8\uff1aWindows7 + VirtualBox 4.3.18\n\nVyOS \u74b0\u5883 (VTEP)\n\n* OS\uff1aVyOS 1.1.1\n* CPU\uff1a1Core\n* Memory\uff1a256MB\n\nArista \u74b0\u5883 (VTEP)\n\n* Aboot-veos\uff1aAboot-veos-2.1.0\n* OS\uff1avEOS-4.14.2F\n* CPU\uff1a1core\n* Memory\uff1a1024MB\n\nFirefly \u74b0\u5883 (\u30eb\u30fc\u30bf)\n\n* OS\uff1a12.1X47-D10.4\n* CPU\uff1a2core\n* Memory\uff1a2048MB\n\n\u30ce\u30fc\u30c9\u74b0\u5883 (4\u53f0\u5171)\n\n* OS\uff1aUbuntu-14.04.01-server-amd64\n\n\n# \u4e8b\u524d\u6e96\u5099\n\n## VyOS \u306e\u30c7\u30d7\u30ed\u30a4\n\n\u4ee5\u4e0b\u3092\u53c2\u8003\u306b\u4f5c\u3063\u3066\u304a\u304d\u307e\u3059\u30022014/12/24 \u73fe\u5728\u306e\u6700\u65b0\u7248\u3067\u3042\u308b 1.1.1 \u3092\u4f7f\u3044\u307e\u3059\u3002\n\n* [User Guide - Installation | \u516c\u5f0f](http://vyos.net/wiki/User_Guide#Installation)\n* [VyOS \u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3068\u30a2\u30c3\u30d7\u30b0\u30ec\u30fc\u30c9 | higeblog](www.higebu.com/blog/2014/12/02/how-to-install-and-upgrade-vyos/)\n\n## Arista(vEOS) \u306e\u30c7\u30d7\u30ed\u30a4\n\n\u4ee5\u4e0b\u30ea\u30f3\u30af\u3092\u53c2\u8003\u306b\u4f5c\u3063\u3066\u304a\u304d\u307e\u3059\u3002\u516c\u5f0f\u306b\u3001\u5404\u7a2e\u30cf\u30a4\u30d1\u30fc\u30d0\u30a4\u30b6\u3054\u3068\u306e\u5c0e\u5165\u624b\u9806\u8a73\u7d30\u3068\u304b\u3082\u3042\u308a\u307e\u3059\u3002\n\n* [vEOS \u2013 Running EOS in a VM | \u516c\u5f0f](https://eos.arista.com/veos-running-eos-in-a-vm/)\n* [VirtualBox\u3067Arista\u306evEOS\u3092\u4f7f\u3048\u308b\u3088\u3046\u306b\u3059\u308b | pelican@ainoniwa.net](http://www.ainoniwa.net/pelican/2014/0906a.html)\n\n## Firefly \u306e\u30c7\u30d7\u30ed\u30a4\uff5e\u30eb\u30fc\u30bf\u30e2\u30fc\u30c9\u306b\u5909\u66f4\n\n\u4ee5\u4e0b\u30ea\u30f3\u30af\u3092\u53c2\u8003\u306b\u4f5c\u3063\u3066\u304a\u304d\u307e\u3059\u3002(\u3053\u308c\u306f VMPlayer \u7248\u3067\u3059\u304c\u3001\u5404\u7a2e\u30cf\u30a4\u30d1\u30fc\u30d0\u30a4\u30b6\u4f7f\u3048\u307e\u3059\u3002)\n\n* [VMware Player\u3067\u306f\u3058\u3081\u308bFirefly Perimeter - Firefly\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb | \u516c\u5f0f (PDF)](http://www.juniper.net/jp/jp/local/pdf/others/install_firefly.pdf)\n\n\u3042\u3068\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u3060\u3068 firewall \u7684\u306a\u52d5\u4f5c\u3092\u3057\u3066\u9b31\u9676\u3057\u3044\u306e\u3067\u3001\u4ee5\u4e0b\u3092\u53c2\u8003\u306b\u30eb\u30fc\u30bf\u30e2\u30fc\u30c9(\u4fd7\u79f0)\u306b\u5207\u308a\u66ff\u3048\u3066\u304a\u304d\u307e\u3059\u3002\n\n* [VMware Player\u3067\u306f\u3058\u3081\u308bFirefly Perimeter - \u30e6\u30fc\u30b9\u30b1\u30fc\u30b92 :JUNOS Router <Static/Dynamic Routing> | \u516c\u5f0f (PDF)](http://www.juniper.net/jp/jp/local/pdf/others/usecase_firefly_router.pdf)\n\n## Ubuntu \u306e\u30c7\u30d7\u30ed\u30a4\u3068\u8a2d\u5b9a\n\n\u30ce\u30fc\u30c9\u306e OS \u306f\u5225\u306b\u554f\u308f\u306a\u3044\u306e\u3067\u3001\u597d\u304d\u306b\u4f5c\u3063\u3066 IP \u30a2\u30c9\u30ec\u30b9\u8a2d\u5b9a\u3060\u3051\u3059\u308c\u3070 OK \u3067\u3059\u3002\nVLAN tag \u3068\u304b\u3082\u98df\u3044\u307e\u305b\u3093\u3002\n\n\n# \u8a2d\u5b9a\n\n## VyOS \u306e VXLAN \u8a2d\u5b9a\n\n### modprobe vxlan \u306b udp_port \u30aa\u30d7\u30b7\u30e7\u30f3\u8ffd\u8a18\n\n\u4e8b\u524d\u306b Linux Kernel \u3068 VyOS \u30d0\u30fc\u30b8\u30e7\u30f3\u78ba\u8a8d\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n```bash:version\u78ba\u8a8d\nkotetsu@vtep-vyos01:~$ uname -r\n3.13.11-1-amd64-vyos\n\nkotetsu@vtep-vyos01:~$ show version\nVersion:      VyOS 1.1.1\nDescription:  VyOS 1.1.1 (helium)\nCopyright:    2014 VyOS maintainers and contributors\nBuilt by:     maintainers@vyos.net\nBuilt on:     Sun Dec  7 21:41:28 UTC 2014\nBuild ID:     1412072141-129950d\nSystem type:  x86 64-bit\nBoot via:     disk\nHypervisor:   VirtualBox\nHW model:     VirtualBox\nHW S/N:       0\nHW UUID:      EF4B6725-D02A-47D3-8194-BFADF71F9987\nUptime:       23:17:43 up 22:39,  1 user,  load average: 0.01, 0.02, 0.05\n```\n\nVXLAN \u306e Kernel module \u3092 modprobe \u3059\u308b\u6642\u70b9\u3067 dstport \u3092\u30c7\u30d5\u30a9\u30eb\u30c8\u306e 8472 \u304b\u3089 4789 \u306b\u5909\u66f4\u3055\u308c\u308b\u3088\u3046\u306b\u3001\u4ee5\u4e0b\u30d5\u30a1\u30a4\u30eb\u3092\u66f8\u304d\u63db\u3048\u307e\u3059\u3002\n\n```bash:/opt/vyatta/share/vyatta-cfg/templates/interfaces/vxlan/node.def\u7de8\u96c6\nkotetsu@vyos# ls -alh /opt/vyatta/share/vyatta-cfg/templates/interfaces/vxlan\ntotal 20K\ndrwxr-xr-x  3 root root 4.0K Dec 23 00:53 .\ndrwxr-xr-x 16 root root 4.0K Dec  8 06:44 ..\n-rw-r--r--  1 root root 1.1K Dec 23 00:53 node.def\n-rw-r--r--  1 root root 1.1K Oct 30 17:43 node.def.orig\ndrwxr-xr-x 13 root root 4.0K Dec  8 06:44 node.tag\n\nkotetsu@vyos:~$ sudo diff /opt/vyatta/share/vyatta-cfg/templates/interfaces/vxlan/node.def /opt/vyatta/share/vyatta-cfg/templates/interfaces/vxlan/node.def.orig\n14c14\n<   [ -d /sys/module/vxlan ] || sudo modprobe vxlan udp_port=4789\n---\n>   [ -d /sys/module/vxlan ] || sudo modprobe vxlan\n```\n\n\n### CLI \u3067\u8a2d\u5b9a\n\n\u3067\u306f\u69cb\u6210\u56f3\u306e\u3088\u3046\u306b\u9806\u6b21\u8a2d\u5b9a\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n```bash:bridge\u3068\u7269\u7406IF\u8a2d\u5b9a\nset interfaces ethernet eth2 address '172.16.2.1/24'\n\nset interfaces bridge 'br100'\nset interfaces bridge 'br200'\n\nset interfaces ethernet eth3 bridge-group bridge 'br100'\nset interfaces ethernet eth4 bridge-group bridge 'br200'\n```\n\n```bash:VXLAN\u8a2d\u5b9a\nset interfaces vxlan vxlan0 bridge-group bridge 'br100'\nset interfaces vxlan vxlan0 group '239.0.0.1'\nset interfaces vxlan vxlan0 link 'eth2'\nset interfaces vxlan vxlan0 vni '10'\n\nset interfaces vxlan vxlan1 bridge-group bridge 'br200'\nset interfaces vxlan vxlan1 group '239.0.0.1'\nset interfaces vxlan vxlan1 link 'eth2'\nset interfaces vxlan vxlan1 vni '20'\n```\n\nVyOS \u304c\u8a8d\u8b58\u3057\u306a\u3044\u3068\u3044\u3051\u306a\u3044 Arista \u5074\u306e VTEP IP \u30a2\u30c9\u30ec\u30b9\u306f\u3001Arista \u306e Loopback \u30a2\u30c9\u30ec\u30b9\u306b\u306a\u308b\u306e\u3067\u3001StaticRoute \u3092\u8ffd\u52a0\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\\#\u3053\u308c\u3060\u3068\u62e1\u5f35\u304c\u9762\u5012\u306a\u306e\u3067\u3001\u5b9f\u74b0\u5883\u3067\u306f DefaultRoute \u304b\u52d5\u7684\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3092\u4f7f\u3046\u3053\u3068\u304c\u591a\u3044\u6c17\u304c\u3057\u307e\u3059\u3002\n\n```bash:VXLAN\u8a2d\u5b9a\nset protocols static route 172.16.3.1/32 next-hop '172.16.2.254'\n```\n\n`commit` \uff5e `save` \u3057\u3066\u8a2d\u5b9a\u78ba\u8a8d\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n### \u8a2d\u5b9a\u78ba\u8a8d\n\n```bash:\u8a2d\u5b9a\u78ba\u8a8d(bridge)\nkotetsu@vtep-vyos01:~$ show bridge\nbridge name     bridge id               STP enabled     interfaces\nbr100           0000.0800272ede56       no              eth3\n                                                        vxlan0\nbr200           0000.0800276532b1       no              eth4\n                                                        vxlan1\n```\n\n```bash:\u8a2d\u5b9a\u78ba\u8a8d(VXLAN)\nkotetsu@vtep-vyos01:~$ show interfaces vxlan\nCodes: S - State, L - Link, u - Up, D - Down, A - Admin Down\nInterface        IP Address                        S/L  Description\n---------        ----------                        ---  -----------\nvxlan0           -                                 u/u\nvxlan1           -                                 u/u\n\nkotetsu@vtep-vyos01:~$ ip -d link show vxlan0\n10: vxlan0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue master br100 state UNKNOWN mode DEFAULT group default\n    link/ether 96:3e:2b:62:6a:57 brd ff:ff:ff:ff:ff:ff promiscuity 1\n    vxlan id 10 group 239.0.0.1 dev eth2 port 32768 61000 ttl 16 ageing 300\n\nkotetsu@vtep-vyos01:~$ ip -d link show vxlan1\n15: vxlan1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue master br200 state UNKNOWN mode DEFAULT group default\n    link/ether 8e:02:68:1e:d2:69 brd ff:ff:ff:ff:ff:ff promiscuity 1\n    vxlan id 20 group 239.0.0.1 dev eth2 port 32768 61000 ttl 16 ageing 300\n\n\n```\n\n## Arista(vEOS) \u306e VXLAN \u8a2d\u5b9a\n\n### \u8a2d\u5b9a\n\n```bash:VLAN/\u7269\u7406IF\u8a2d\u5b9a\nvlan 100,200\n\ninterface Ethernet1\n   description DEV=fw01 IF=ge-0/0/2\n   no switchport\n   ip address 172.16.1.1/24\n!\ninterface Ethernet2\n   description DEV=node001 IF=eth2\n   switchport access vlan 100\n!\ninterface Ethernet3\n   description DEV=node101 IF=eth2\n   switchport access vlan 200\n```\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b VXLAN \u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u306e source-interface \u306b\u306f\u3001Loopback Interface \u3057\u304b\u9069\u7528\u3067\u304d\u307e\u305b\u3093\u3002VyOS \u306a\u3069\u306e dev \u3068\u540c\u3058\u30ce\u30ea\u3067\u7269\u7406IF\u3092\u6307\u5b9a\u3067\u304d\u308b\u304b\u3068\u601d\u3044\u304d\u3084\u2026\u3002\n\n```bash:VXLAN\u8a2d\u5b9a\ninterface Loopback0\n   ip address 172.16.3.1/32\n!\ninterface Vxlan1\n   vxlan multicast-group 239.0.0.1\n   vxlan source-interface Loopback0\n   vxlan udp-port 4789\n   vxlan vlan 100 vni 10\n   vxlan vlan 200 vni 20\n```\n\n\u3053\u306e\u307e\u307e\u3060\u3068 VTEP \u306f 239.0.0.1 \u5b9b\u306e\u901a\u4fe1\u3092\u3069\u3053\u306b\u6295\u3052\u308c\u3070\u3044\u3044\u306e\u304b\u5206\u304b\u3089\u306a\u3044\u306e\u3067\u3001Multicast Routing \u306e\u8a2d\u5b9a\u3092\u3057\u307e\u3059\u3002\n\n```bash:StaticRoute&MulticastRouting\u8a2d\u5b9a\nip routing\nip multicast-routing\n\ninterface Ethernet1\n   ip pim sparse-mode\n\nip pim rp-address 172.16.1.254\n\nip route 172.16.2.0/24 172.16.1.254\n```\n### \u8a2d\u5b9a\u78ba\u8a8d\n\n```bash:\u8a2d\u5b9a\u78ba\u8a8d(VXLAN)\nvtep-arista01#show interfaces vxlan 1\nVxlan1 is up, line protocol is up (connected)\n  Hardware is Vxlan\n  Source interface is Loopback0 and is active with 172.16.3.1\n  Replication/Flood Mode is multicast\n  Static vlan to vni mapping is\n    [100, 10]         [200, 20]\n  Multicast group address is 239.0.0.1\n\n\nvtep-arista01#show vxlan vtep\nRemote vteps for Vxlan1:\nTotal number of remote vteps:  0\n\n\nvtep-arista01#show vxlan counters software\nRx bytes for encapsulation                      :  0\nRx pkts for encapsulation                       :  0\nEncaped bytes                                   :  0\nEncaped packets                                 :  0\nTx bytes after encapsulation                    :  0\nTx pkts after encapsulation                     :  0\nRx dot1Q Tunnel pkts for encapsulation          :  0\nRx bytes after decapsulation                    :  0\nRx pkts after decapsulation                     :  0\nDecaped bytes                                   :  0\nDecaped packets                                 :  0\nARP bytes                                       :  0\nARP packets                                     :  0\n\nRead error for pkts coming in for encapsulation :  0\nDiscarded runt pkts ( encap side )              :  0\nDiscard vlan range ( encap eide )               :  0\nDiscard vlan map ( encap side )                 :  0\nDiscard mlag peer link ( encap side )           :  0\nDiscarded pkts due to empty flood list          :  0\nEncap send error                                :  0\nEncap timeout                                   :  0\nDiscarded runt pkts ( decap side )              :  0\nDiscard pkts not for vtep ( decap side )        :  0\nDiscard bytes not for vtep ( decap side )       :  0\nDiscard pkts with invalid vxlan header          :  0\nDiscard vlan map ( decap side )                 :  0\nDiscard VNI range ( decap side )                :  0\nDecap timeout                                   :  0\nDecap socket error                              :  0\nARP send error                                  :  0\n\n\nvtep-arista01#show vxlan address-table\n          Vxlan Mac Address Table\n----------------------------------------------------------------------\n\nVlan  Mac Address     Type     Prt  Vtep             Moves   Last Move\n----  -----------     ----     ---  ----             -----   ---------\nTotal Remote Mac Addresses for this criterion: 0\n\nvtep-arista01#show vxlan counters varp\narp cache installed:                    0\nvxlan encapsulated arps:                0\narp reply to vArp mac and vArp vtep:    0\narp reply RX:                           0\narp reply head-end-replicated:          0\narp reply TX:                           0\narp request decaped and sent:           0\n\narp cache install err                   0\narp request decap and send TX err:      0\nunknown cpu port id:                    0\npacket too short:                       0\nunexpected ether type:                  0\nunexpected non IP packet                0\nunexpected IP prot                      0\nunexpected UPD port                     0\nunexpected inner packet                 0\nunexpected arp reply                    0\ninvalid IP checksum                     0\ninvalid Vxlan header                    0\ninvalid arp packet                      0\nunknown vlan to vni mapping             0\nunknown source IP                       0\nno BUM flood list TX err                0\narp reply to Arp agent TX err           0\n```\n\n## Firefly \u306e multicast routing \u8a2d\u5b9a\n\n### \u8a2d\u5b9a\n\nVXLAN \u306e RFC \u306b\u306f dense \u3088\u308a bidirectional PIM \u304c\u52b9\u679c\u7684\u304b\u3082\u306d\u3001\u3068\u66f8\u3044\u3066\u3042\u308a\u307e\u3059\u3002\n\u30ac\u30f3\u7121\u8996\u3057\u3066\u3001\u3053\u3053\u306f\u7c21\u5358\u306a dense \u8a2d\u5b9a\u3067\u3044\u304d\u307e\u3059\u3002\n\n```bash:\u8a2d\u5b9a\u78ba\u8a8d(\u7269\u7406IF\u3001StaticRoute\u3001MulticastRouting)\nset interfaces ge-0/0/2 unit 0 family inet address 172.16.1.254/24\nset interfaces ge-0/0/3 unit 0 family inet address 172.16.2.254/24\n\nset routing-options static route 172.16.3.1/32 next-hop 172.16.1.1\n\nset protocols pim interface ge-0/0/2.0 mode dense\nset protocols pim interface ge-0/0/3.0 mode dense\n```\n\n# \u52d5\u4f5c\u78ba\u8a8d\n\n## \u758e\u901a\n\n\u8d64 node \u540c\u58eb\u3001\u9752 node \u540c\u58eb\u304c\u758e\u901a\u53ef\u80fd\u306a\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\u3053\u306e\u6642\u3001VyOS \u3084 Arista \u3067 `tcpdump` \u304b\u3051\u3066\u304a\u304d\u5f8c\u3067\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\\# \u758e\u901a\u3057\u305f\u306f\u826f\u3044\u304c\u3001\u7570\u69d8\u306b RTT \u304c\u3067\u304b\u3044\u2026\u3002firefly \u3068 Arista \u9593\u3082\u305d\u3093\u306a\u611f\u3058\u3067\u3001\u30b7\u30e7\u30dc\u3044\u30de\u30b7\u30f3\u3067Arista \u52d5\u304b\u3057\u3066\u3044\u308b\u6240\u70ba\u304b\u3082\u3002\n\n```bash:node001\n$ ping 10.0.0.2\nPING 10.0.0.2 (10.0.0.2) 56(84) bytes of data.\n64 bytes from 10.0.0.2: icmp_seq=1 ttl=64 time=72.9 ms\n64 bytes from 10.0.0.2: icmp_seq=2 ttl=64 time=67.2 ms\n64 bytes from 10.0.0.2: icmp_seq=3 ttl=64 time=63.2 ms\n64 bytes from 10.0.0.2: icmp_seq=4 ttl=64 time=163 ms\n64 bytes from 10.0.0.2: icmp_seq=5 ttl=64 time=75.7 ms\n64 bytes from 10.0.0.2: icmp_seq=6 ttl=64 time=67.2 ms\n64 bytes from 10.0.0.2: icmp_seq=7 ttl=64 time=68.8 ms\n64 bytes from 10.0.0.2: icmp_seq=8 ttl=64 time=73.7 ms\n64 bytes from 10.0.0.2: icmp_seq=9 ttl=64 time=55.3 ms\n64 bytes from 10.0.0.2: icmp_seq=10 ttl=64 time=102 ms\n64 bytes from 10.0.0.2: icmp_seq=11 ttl=64 time=38.5 ms\n64 bytes from 10.0.0.2: icmp_seq=12 ttl=64 time=33.0 ms\n64 bytes from 10.0.0.2: icmp_seq=13 ttl=64 time=35.1 ms\n64 bytes from 10.0.0.2: icmp_seq=14 ttl=64 time=31.7 ms\n```\n\n```bash:node101\n~$ ping 10.0.0.2\nPING 10.0.0.2 (10.0.0.2) 56(84) bytes of data.\n64 bytes from 10.0.0.2: icmp_seq=1 ttl=64 time=70.6 ms\n64 bytes from 10.0.0.2: icmp_seq=2 ttl=64 time=62.5 ms\n64 bytes from 10.0.0.2: icmp_seq=3 ttl=64 time=100 ms\n64 bytes from 10.0.0.2: icmp_seq=4 ttl=64 time=38.6 ms\n64 bytes from 10.0.0.2: icmp_seq=5 ttl=64 time=35.3 ms\n64 bytes from 10.0.0.2: icmp_seq=6 ttl=64 time=30.0 ms\n64 bytes from 10.0.0.2: icmp_seq=7 ttl=64 time=34.4 ms\n64 bytes from 10.0.0.2: icmp_seq=8 ttl=64 time=26.1 ms\n64 bytes from 10.0.0.2: icmp_seq=9 ttl=64 time=29.9 ms\n64 bytes from 10.0.0.2: icmp_seq=10 ttl=64 time=28.7 ms\n64 bytes from 10.0.0.2: icmp_seq=11 ttl=64 time=25.9 ms\n64 bytes from 10.0.0.2: icmp_seq=12 ttl=64 time=24.8 ms\n64 bytes from 10.0.0.2: icmp_seq=13 ttl=64 time=24.4 ms\n```\n\n```bash:node002\n$ ping 10.0.0.1\nPING 10.0.0.1 (10.0.0.1) 56(84) bytes of data.\n64 bytes from 10.0.0.1: icmp_seq=1 ttl=64 time=24.3 ms\n64 bytes from 10.0.0.1: icmp_seq=2 ttl=64 time=25.9 ms\n64 bytes from 10.0.0.1: icmp_seq=3 ttl=64 time=28.5 ms\n64 bytes from 10.0.0.1: icmp_seq=4 ttl=64 time=24.7 ms\n64 bytes from 10.0.0.1: icmp_seq=5 ttl=64 time=26.2 ms\n64 bytes from 10.0.0.1: icmp_seq=6 ttl=64 time=59.4 ms\n64 bytes from 10.0.0.1: icmp_seq=7 ttl=64 time=29.0 ms\n64 bytes from 10.0.0.1: icmp_seq=8 ttl=64 time=26.9 ms\n64 bytes from 10.0.0.1: icmp_seq=9 ttl=64 time=72.5 ms\n64 bytes from 10.0.0.1: icmp_seq=10 ttl=64 time=55.1 ms\n64 bytes from 10.0.0.1: icmp_seq=11 ttl=64 time=49.7 ms\n64 bytes from 10.0.0.1: icmp_seq=12 ttl=64 time=92.5 ms\n64 bytes from 10.0.0.1: icmp_seq=13 ttl=64 time=45.3 ms\n64 bytes from 10.0.0.1: icmp_seq=14 ttl=64 time=41.3 ms\n64 bytes from 10.0.0.1: icmp_seq=15 ttl=64 time=37.7 ms\n64 bytes from 10.0.0.1: icmp_seq=16 ttl=64 time=36.7 ms\n64 bytes from 10.0.0.1: icmp_seq=17 ttl=64 time=35.3 ms\n```\n\n```bash:node102\n$ ping 10.0.0.1\nPING 10.0.0.1 (10.0.0.1) 56(84) bytes of data.\n64 bytes from 10.0.0.1: icmp_seq=1 ttl=64 time=26.2 ms\n64 bytes from 10.0.0.1: icmp_seq=2 ttl=64 time=23.4 ms\n64 bytes from 10.0.0.1: icmp_seq=3 ttl=64 time=28.3 ms\n64 bytes from 10.0.0.1: icmp_seq=4 ttl=64 time=73.0 ms\n64 bytes from 10.0.0.1: icmp_seq=5 ttl=64 time=65.0 ms\n64 bytes from 10.0.0.1: icmp_seq=6 ttl=64 time=62.3 ms\n64 bytes from 10.0.0.1: icmp_seq=7 ttl=64 time=112 ms\n64 bytes from 10.0.0.1: icmp_seq=8 ttl=64 time=45.6 ms\n64 bytes from 10.0.0.1: icmp_seq=9 ttl=64 time=38.3 ms\n64 bytes from 10.0.0.1: icmp_seq=10 ttl=64 time=35.6 ms\n64 bytes from 10.0.0.1: icmp_seq=11 ttl=64 time=34.9 ms\n64 bytes from 10.0.0.1: icmp_seq=12 ttl=64 time=40.1 ms\n64 bytes from 10.0.0.1: icmp_seq=13 ttl=64 time=38.3 ms\n```\n\n## VTEP\u72b6\u614b\u78ba\u8a8d\n\n```bash:vtep-vyos01\nkotetsu@vtep-vyos01:~$ show interfaces vxlan detail\nvxlan0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue master br100 state UNKNOWN group default\n    link/ether fe:61:bc:ca:cd:1d brd ff:ff:ff:ff:ff:ff\n    inet6 fe80::fc61:bcff:feca:cd1d/64 scope link\n       valid_lft forever preferred_lft forever\n\n    RX:  bytes    packets     errors    dropped    overrun      mcast\n        117556       1480          0          0          0          0\n    TX:  bytes    packets     errors    dropped    carrier collisions\n        383710       4382          0          0          0          0\nvxlan1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue master br200 state UNKNOWN group default\n    link/ether b2:02:ef:4e:26:d4 brd ff:ff:ff:ff:ff:ff\n    inet6 fe80::b002:efff:fe4e:26d4/64 scope link\n       valid_lft forever preferred_lft forever\n\n    RX:  bytes    packets     errors    dropped    overrun      mcast\n        232330       3109          0          0          0          0\n    TX:  bytes    packets     errors    dropped    carrier collisions\n        490658       5270          0          0          0          0\n```\n\n```bash:vtep-arista01\nvtep-arista01#show vxlan vtep\nRemote vteps for Vxlan1:\n172.16.2.1\nTotal number of remote vteps:  1\n\n\n\nvtep-arista01#show mac address-table\n          Mac Address Table\n------------------------------------------------------------------\n\nVlan    Mac Address       Type        Ports      Moves   Last Move\n----    -----------       ----        -----      -----   ---------\n 100    0800.272d.daa2    DYNAMIC     Vx1        1       0:14:19 ago\n 100    0800.27a6.f13d    DYNAMIC     Et2        1       0:14:22 ago\n 200    0800.272c.080f    DYNAMIC     Et3        1       0:11:05 ago\n 200    0800.27a9.6b58    DYNAMIC     Vx1        1       0:10:33 ago\nTotal Mac Addresses for this criterion: 4\n\n          Multicast Mac Address Table\n------------------------------------------------------------------\n\nVlan    Mac Address       Type        Ports\n----    -----------       ----        -----\nTotal Mac Addresses for this criterion: 0\n\n\nvtep-arista01#show vxlan address-table\n          Vxlan Mac Address Table\n----------------------------------------------------------------------\n\nVlan  Mac Address     Type     Prt  Vtep             Moves   Last Move\n----  -----------     ----     ---  ----             -----   ---------\n 100  0800.272d.daa2  DYNAMIC  Vx1  172.16.2.1       1       0:14:15 ago\n 200  0800.27a9.6b58  DYNAMIC  Vx1  172.16.2.1       1       0:10:28 ago\nTotal Remote Mac Addresses for this criterion: 2\n\nvtep-arista01#show vxlan counters software\nRx bytes for encapsulation                      :  249372\nRx pkts for encapsulation                       :  2390\nEncaped bytes                                   :  249372\nEncaped packets                                 :  2390\nTx bytes after encapsulation                    :  306732\nTx pkts after encapsulation                     :  2390\nRx dot1Q Tunnel pkts for encapsulation          :  0\nRx bytes after decapsulation                    :  79320\nRx pkts after decapsulation                     :  733\nDecaped bytes                                   :  23664\nDecaped packets                                 :  348\nARP bytes                                       :  0\nARP packets                                     :  0\n\nRead error for pkts coming in for encapsulation :  0\nDiscarded runt pkts ( encap side )              :  0\nDiscard vlan range ( encap eide )               :  0\nDiscard vlan map ( encap side )                 :  0\nDiscard mlag peer link ( encap side )           :  0\nDiscarded pkts due to empty flood list          :  0\nEncap send error                                :  0\nEncap timeout                                   :  0\nDiscarded runt pkts ( decap side )              :  1\nDiscard pkts not for vtep ( decap side )        :  384\nDiscard bytes not for vtep ( decap side )       :  40980\nDiscard pkts with invalid vxlan header          :  0\nDiscard vlan map ( decap side )                 :  0\nDiscard VNI range ( decap side )                :  0\nDecap timeout                                   :  0\nDecap socket error                              :  0\nARP send error                                  :  0\nvtep-arista01#\n\n\nvtep-arista01#show vxlan counters varp\narp cache installed:                    0\nvxlan encapsulated arps:                2\narp reply to vArp mac and vArp vtep:    0\narp reply RX:                           0\narp reply head-end-replicated:          0\narp reply TX:                           0\narp request decaped and sent:           2\n\narp cache install err                   0\narp request decap and send TX err:      0\nunknown cpu port id:                    0\npacket too short:                       0\nunexpected ether type:                  0\nunexpected non IP packet                0\nunexpected IP prot                      0\nunexpected UPD port                     0\nunexpected inner packet                 0\nunexpected arp reply                    0\ninvalid IP checksum                     0\ninvalid Vxlan header                    0\ninvalid arp packet                      0\nunknown vlan to vni mapping             0\nunknown source IP                       0\nno BUM flood list TX err                0\narp reply to Arp agent TX err           0\n\n```\n\n## \u30d1\u30b1\u30c3\u30c8\u30ad\u30e3\u30d7\u30c1\u30e3\n\n\u7279\u5fb4\u7684\u306a\u3082\u306e\u3092\u3044\u304f\u3064\u304b\u753b\u9762\u30ad\u30e3\u30d7\u30c1\u30e3\u3067\u8cbc\u3063\u3066\u3044\u304d\u307e\u3059\u3002\n\n\u2193 node \u304b\u3089\u306e BUM \u30c8\u30e9\u30d5\u30a3\u30c3\u30af(ping \u5b9f\u884c\u6642\u6700\u521d\u306e ARP)\u306f\u3001\u8a2d\u5b9a\u3057\u305f\u30de\u30eb\u30c1\u30ad\u30e3\u30b9\u30c8\u30a2\u30c9\u30ec\u30b9\u3067\u3002\n\n![WS000019.JPG](https://qiita-image-store.s3.amazonaws.com/0/60456/72f80e60-537e-780f-a1b2-0ac8887f1d9e.jpeg)\n\n\u2193 VNI10 \u5074\u3002VTEP \u9593\u306e\u30e6\u30cb\u30ad\u30e3\u30b9\u30c8\u306b\u30ab\u30d7\u30bb\u30ea\u30f3\u30b0\u3055\u308c\u3066\u3044\u308b\u306e\u304c\u3088\u304f\u5206\u304b\u308b\u3002\u307e\u305f\u3001\u6307\u5b9a\u3069\u304a\u308a UDP dstport 4789 \u3067\u52d5\u4f5c\u3057\u3066\u3044\u308b\u3002\n\n![WS000020.JPG](https://qiita-image-store.s3.amazonaws.com/0/60456/0d8491f4-8f03-99b3-07c0-b917854739db.jpeg)\n\n![WS000021.JPG](https://qiita-image-store.s3.amazonaws.com/0/60456/8d5b6134-ee4b-bc6c-b6af-0b1a94f57c80.jpeg)\n\n\u2193VNI20 \u5074\u3082\u4e00\u7dd2\u3002\n\n![WS000022.JPG](https://qiita-image-store.s3.amazonaws.com/0/60456/1d15bd36-3a65-6f13-499d-b036d0863a25.jpeg)\n\n\n# \u304a\u3057\u307e\u3044\n\n## \u96d1\u611f\n\n* \u3053\u306e\u3088\u3046\u306b\u5229\u7528\u3059\u308b UDP dstport \u304c\u7570\u306a\u308b\u3088\u3046\u306a VTEP \u9593\u3067\u3082\u3001\u305d\u308c\u3055\u3048\u63c3\u3048\u3066\u3057\u307e\u3048\u3070\u76f8\u4e92\u63a5\u7d9a\u3082\u30c1\u30e7\u30ed\u3044\u3082\u306e\u3067\u3059\u3002\n* \u307e\u3042\u3001\u666e\u901a\u306f\u8a2d\u5b9a\u4e00\u767a\u3067 UDP dstport \u3092\u5909\u66f4\u3067\u304d\u308b\u3084\u3064(\u4eca\u56de\u306e\u30b1\u30fc\u30b9\u3067\u3044\u3046\u3068 Arista \u5074)\u3067\u5909\u66f4\u3059\u308b\u3068\u601d\u3044\u307e\u3059\u3002\u4eca\u56de VyOS \u3067\u3084\u3063\u305f\u306e\u306f\u305f\u3060\u306e\u8208\u5473\u672c\u4f4d\u3067\u3059\u3002\n* VyOS \u3092 VTEP \u3068\u3057\u3066\u4f7f\u3046\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\u304c\u307e\u3060\u898b\u3048\u3066\u304d\u307e\u305b\u3093\u3002\u30cf\u30a4\u30d1\u30fc\u30d0\u30a4\u30b61\u53f0\u306b1\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30d0\u30e9\u307e\u304f\u3068\u304b\uff1f\n* \u30de\u30eb\u30c1\u30ad\u30e3\u30b9\u30c8\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3092\u52c9\u5f37\u3057\u3088\u3046\u3002\n"}