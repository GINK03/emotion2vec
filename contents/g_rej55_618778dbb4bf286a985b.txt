{"tags": ["matlab", "KalmanFilter"], "context": " \u3053\u306e\u8a18\u4e8b\u306f\u6700\u7d42\u66f4\u65b0\u65e5\u304b\u30891\u5e74\u4ee5\u4e0a\u304c\u7d4c\u904e\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u975e\u7dda\u5f62\u30b7\u30b9\u30c6\u30e0\u306e\u63a8\u5b9a\n\u4e16\u306e\u4e2d\u306e\u591a\u304f\u306e\u52d5\u7684\u306a\u73fe\u8c61\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8868\u73fe\u3055\u308c\u307e\u3059.\n\\frac{d}{dt}x(t) = f(x, t), \\quad x(0) = x_0\n\n\u3053\u306e\u3088\u3046\u306a\u73fe\u8c61\u306b\u304a\u3044\u3066, \u4e00\u822c\u306b\u30bb\u30f3\u30b5\u3067\u6e2c\u308b\u306a\u3069\u3057\u3066\u5f97\u3089\u308c\u308b\u51fa\u529b\u306f$x$\u306e\u4e00\u90e8\u3067\u3042\u308a, \u3057\u304b\u3082\u30bb\u30f3\u30b5\u30ce\u30a4\u30ba\u7b49\u304c\u542b\u307e\u308c\u308b\u5834\u5408\u304c\u591a\u3044\u3067\u3059.\n\u3053\u306e\u5834\u5408, \u3088\u304f\u4f7f\u308f\u308c\u308b\u30aa\u30f3\u30e9\u30a4\u30f3\u63a8\u5b9a\u624b\u6cd5\u3068\u3057\u3066\u30ab\u30eb\u30de\u30f3\u30d5\u30a3\u30eb\u30bf\u304c\u7528\u3044\u3089\u308c\u307e\u3059\u304c, \u4e00\u822c\u306e\u30ab\u30eb\u30de\u30f3\u30d5\u30a3\u30eb\u30bf\u306f\u7dda\u5f62\u30b7\u30b9\u30c6\u30e0\u306b\u3057\u304b\u9069\u7528\u3067\u304d\u305a, \u975e\u7dda\u5f62\u30b7\u30b9\u30c6\u30e0\u306b\u5bfe\u3057\u3066\u306f\u975e\u7dda\u5f62\u30ab\u30eb\u30de\u30f3\u30d5\u30a3\u30eb\u30bf\u3068\u547c\u3070\u308c\u308b\u3082\u306e\u3092\u9069\u7528\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059.\n\n\u975e\u7dda\u5f62Kalman Filter\n\u975e\u7dda\u5f62Kalman Filter\u306b\u306f\u5927\u304d\u304f\u308f\u3051\u30664\u7a2e\u985e(\u53b3\u5bc6\u306b\u306f3\u7a2e\u985e?)\u3042\u308a\u307e\u3059.\n\n\u62e1\u5f35\u30ab\u30eb\u30de\u30f3\u30d5\u30a3\u30eb\u30bf(Extended Kalman Filter)\n\u6bce\u6642\u523b, \u63a8\u5b9a\u5024\u5468\u308a\u3067\u7dda\u5f62\u8fd1\u4f3c\u3092\u884c\u3046\u3053\u3068\u3067\u7dda\u5f62\u30ab\u30eb\u30de\u30f3\u30d5\u30a3\u30eb\u30bf\u306e\u624b\u6cd5\u3092\u9069\u7528\u3057\u307e\u3059. \u7dda\u5f62\u8fd1\u4f3c\u3092\u884c\u3063\u3066\u3044\u308b\u305f\u3081, \u975e\u7dda\u5f62\u6027\u304c\u5f37\u3044\u3068\u3059\u3050\u767a\u6563\u3057\u3066\u3057\u307e\u3044\u307e\u3059.\n\n\u7121\u9999\u6599\u30ab\u30eb\u30de\u30f3\u30d5\u30a3\u30eb\u30bf(Unscented Kalman Filter)\n\u72b6\u614b\u7a7a\u9593\u4e0a\u306b\u5206\u5e03\u3059\u308b\u78ba\u7387\u5206\u5e03\u306e\u3046\u3061, \u4ee3\u8868\u7684\u306a\u70b9\u3092\u9078\u3093\u3067\u304d\u3066, \u305d\u306e\u70b9\u306e\u72b6\u614b\u9077\u79fb\u3092\u6c42\u3081\u308b\u3053\u3068\u3067\u4e88\u6e2c\u3057, \u51fa\u529b\u30d5\u30a3\u30fc\u30c9\u30d0\u30c3\u30af\u306b\u3088\u308a\u66f4\u65b0\u3059\u308b\u30ab\u30eb\u30de\u30f3\u30d5\u30a3\u30eb\u30bf\u3067\u3059. \u62e1\u5f35\u30ab\u30eb\u30de\u30f3\u30d5\u30a3\u30eb\u30bf\u306b\u6bd4\u3079\u3066\u7cbe\u5ea6\u304c\u3088\u304f, \u72b6\u614b\u30d9\u30af\u30c8\u30eb\u306e\u6b21\u5143\u304c$n$\u306e\u5834\u5408\u306f\u4ee3\u8868\u70b9\u3068\u3057\u3066$2n+1$\u500b\u306e\u70b9\u3060\u3051\u3067\u6e08\u3080\u306e\u3067, \u8a08\u7b97\u30b3\u30b9\u30c8\u7684\u306b\u3082\u6709\u5229\u3067\u3059.\n\n\u30d1\u30fc\u30c6\u30a3\u30af\u30eb\u30d5\u30a3\u30eb\u30bf(Particle Filter)\n\u72b6\u614b\u7a7a\u9593\u4e0a\u306b\u30d1\u30fc\u30c6\u30a3\u30af\u30eb\u3092\u6492\u304d, \u305d\u306e\u30d1\u30fc\u30c6\u30a3\u30af\u30eb\u306e\u72b6\u614b\u9077\u79fb\u3092\u8a08\u7b97\u3059\u308b\u3053\u3068\u3067\u4e88\u6e2c\u3092\u884c\u3044\u307e\u3059. \u305d\u306e\u5f8c, \u73fe\u5b9f\u306e\u51fa\u529b\u3092\u30d5\u30a3\u30fc\u30c9\u30d0\u30c3\u30af\u3057\u3066\u5c24\u5ea6\u3092\u8a08\u7b97\u3057, \u5c24\u5ea6\u306e\u4f4e\u3044\u30d1\u30fc\u30c6\u30a3\u30af\u30eb\u3092\u5c24\u5ea6\u306e\u9ad8\u3044\u30d1\u30fc\u30c6\u30a3\u30af\u30eb\u306e\u4f4d\u7f6e\u306b\u6492\u304d\u76f4\u3057(\u30ea\u30b5\u30f3\u30d7\u30ea\u30f3\u30b0)\u3092\u3059\u308b\u3053\u3068\u3067\u63a8\u5b9a\u3092\u884c\u3044\u307e\u3059. \u4e00\u822c\u306b\u306f\u30d1\u30fc\u30c6\u30a3\u30af\u30eb\u306e\u5e73\u5747\u5024\u3092\u63a8\u5b9a\u5024\u3068\u3057\u3066, \u5b9f\u969b\u306b\u5024\u3068\u3057\u3066\u7528\u3044\u308b\u5834\u5408\u304c\u591a\u3044\u3067\u3059. \u4e0a\u8a182\u3064\u306e\u624b\u6cd5\u306f\u78ba\u7387\u5206\u5e03\u3092\u30ac\u30a6\u30b9\u5206\u5e03\u306b\u8fd1\u4f3c\u3057\u3066\u3044\u308b\u306e\u3067, \u3053\u306e\u624b\u6cd5\u306f\u975e\u5e38\u306b\u7cbe\u5ea6\u304c\u9ad8\u3044\u3053\u3068\u304c\u5229\u70b9\u3067\u3059\u304c, \u30d1\u30fc\u30c6\u30a3\u30af\u30eb\u306e\u6570\u304c\u975e\u5e38\u306b\u591a\u304f\u5fc5\u8981\u3067\u3042\u308a, \u8a08\u7b97\u30b3\u30b9\u30c8\u306f\u975e\u5e38\u306b\u5927\u304d\u304f\u306a\u308a\u307e\u3059.\n\n\u30a2\u30f3\u30b5\u30f3\u30d6\u30eb\u30ab\u30eb\u30de\u30f3\u30d5\u30a3\u30eb\u30bf(Ensemble Kalman Filter)\n\u624b\u6cd5\u306f\u30d1\u30fc\u30c6\u30a3\u30af\u30eb\u30d5\u30a3\u30eb\u30bf\u3068\u4f3c\u3066\u3044\u3066, \u72b6\u614b\u7a7a\u9593\u4e0a\u306b\u3044\u304f\u3064\u304b\u306e\u30b5\u30f3\u30d7\u30eb\u72b6\u614b\u3092\u7528\u610f\u3057, \u72b6\u614b\u30a2\u30f3\u30b5\u30f3\u30d6\u30eb(\u30d1\u30fc\u30c6\u30a3\u30af\u30eb\u306e\u96c6\u307e\u308a\u3068\u540c\u3058\u610f\u5473)\u3092\u305d\u308c\u305e\u308c\u72b6\u614b\u9077\u79fb\u3055\u305b\u3066\u4e88\u6e2c\u3057\u307e\u3059. \u3053\u3053\u307e\u3067\u306f\u30d1\u30fc\u30c6\u30a3\u30af\u30eb\u30d5\u30a3\u30eb\u30bf\u3068\u540c\u3058\u3067\u3059\u304c, \u73fe\u5b9f\u306e\u51fa\u529b\u3092\u30d5\u30a3\u30fc\u30c9\u30d0\u30c3\u30af\u3057\u305f\u969b\u306b, \u72b6\u614b\u30a2\u30f3\u30b5\u30f3\u30d6\u30eb\u3092\u3088\u308a\u5c24\u5ea6\u306e\u9ad8\u3044\u65b9\u3078\u304b\u304d\u96c6\u3081\u308b\u3088\u3046\u306a\u66f4\u65b0\u3092\u884c\u3044\u307e\u3059. \u3053\u3061\u3089\u3082\u30d1\u30fc\u30c6\u30a3\u30af\u30eb\u30d5\u30a3\u30eb\u30bf\u3068\u4f3c\u305f\u3088\u3046\u306a\u5229\u70b9\u3068\u6b20\u70b9\u3092\u6301\u3061\u307e\u3059\u304c, \u30d1\u30fc\u30c6\u30a3\u30af\u30eb\u30d5\u30a3\u30eb\u30bf\u307b\u3069\u7cbe\u5ea6\u306f\u9ad8\u304f\u306a\u3044\u3082\u306e\u306e, \u30b5\u30f3\u30d7\u30eb\u6570\u306f\u6bd4\u8f03\u7684\u5c11\u306a\u3081\u3067\u6e08\u3080\u306e\u3067, \u8a08\u7b97\u30b3\u30b9\u30c8\u7684\u306b\u306f\u30d1\u30fc\u30c6\u30a3\u30af\u30eb\u30d5\u30a3\u30eb\u30bf\u3088\u308a\u3082\u512a\u308c\u3066\u3044\u307e\u3059. \u7279\u306b\u5927\u898f\u6a21\u7cfb\u306e\u63a8\u5b9a\u3067\u306f\u5a01\u529b\u3092\u767a\u63ee\u3057, \u5b9f\u969b\u6c17\u8c61\u7cfb\u3067\u306f\u7528\u3044\u3089\u308c\u308b\u3053\u3068\u304c\u591a\u3044\u3067\u3059(\u3068\u3044\u3046\u304b, \u3082\u3068\u3082\u3068\u6c17\u8c61\u7cfb\u3067\u4f7f\u3046\u305f\u3081\u306b\u51fa\u3066\u304d\u305f\u306f\u305a\u3060\u3063\u305f\u3068\u601d\u3044\u307e\u3059).\n\nEnsemble Kalman Filter\n\u30d1\u30fc\u30c6\u30a3\u30af\u30eb\u30d5\u30a3\u30eb\u30bf\u7b49\u306f\u6bd4\u8f03\u7684\u6587\u732e\u3092\u898b\u304b\u3051\u307e\u3059\u304c, \u30a2\u30f3\u30b5\u30f3\u30d6\u30eb\u30ab\u30eb\u30de\u30f3\u30d5\u30a3\u30eb\u30bf\u306f\u307b\u3068\u3093\u3069\u898b\u304b\u3051\u306a\u3044\u306e\u3067, \u3053\u3053\u3067\u306f\u30a2\u30f3\u30b5\u30f3\u30d6\u30eb\u30ab\u30eb\u30de\u30f3\u30d5\u30a3\u30eb\u30bf\u3092\u53d6\u308a\u4e0a\u3052\u305f\u3044\u3068\u601d\u3044\u307e\u3059.\n\n\u63a8\u5b9a\u5bfe\u8c61\n\u3053\u3053\u3067\u306f, \u4ee5\u4e0b\u306e\u96e2\u6563\u6642\u9593\u975e\u7dda\u5f62\u30b7\u30b9\u30c6\u30e0\u306e\u63a8\u5b9a\u3092\u8003\u3048\u307e\u3059.\nx_{k+1} = f(x_k, k) + w_k \\\\\ny_k = Cx_k + v_k\n\n\u307e\u305f, \u72b6\u614b\u7a7a\u9593\u4e0a\u306e\u30b5\u30f3\u30d7\u30eb\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8868\u73fe\u3057\u307e\u3059.\nx^{(i)}_{k+1} = f(x^{(i)}_k, k) + w^{(i)}_k\\\\\ny^{(i)}_k = Cx^{(i)}_k + v^{(i)}_k\n\n\u305f\u3060\u3057, $i \\in \\{ 1, \\ldots, M \\}$\u3068\u3057, $M$\u304c\u7dcf\u30b5\u30f3\u30d7\u30eb\u6570\u3068\u306a\u308a\u307e\u3059.\n\u4ee5\u4e0b\u3067\u306f, $\\bar{x}$\u3092\u4e88\u6e2c\u5024, $\\hat{x}$\u3092\u66f4\u65b0\u5024, $\\tilde{x}$\u3092\u8aa4\u5dee\u3068\u3057\u307e\u3059.\n\n\u66f4\u65b0\u30b9\u30c6\u30c3\u30d7\n1.\u4e88\u6e2c\u5e73\u5747\u5024\u3068\u306e\u8aa4\u5dee\u30a2\u30f3\u30b5\u30f3\u30d6\u30eb\u884c\u5217\u3092\u4f5c\u6210\n\u4e88\u6e2c\u5024\u306e\u5e73\u5747\u5024\u3068\u306e\u8aa4\u5dee\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u6c42\u3081\u307e\u3059.\n\\tilde{x}^{(i)}_k = \\bar{x}^{(i)}_k - \\frac{1}{M}\\sum_{i=1}^{M}\\bar{x}^{(i)}_k\n\n\u3053\u306e\u3068\u304d, \u8aa4\u5dee\u30a2\u30f3\u30b5\u30f3\u30d6\u30eb\u884c\u5217\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u4f5c\u308a\u307e\u3059.\n\\tilde{X}_k = \\begin{bmatrix}\\tilde{x}^{(1)}_k & \\cdots & \\tilde{x}^{(M)}_k \\end{bmatrix}\n\n2.\u4e88\u6e2c\u51fa\u529b\u3082\u8aa4\u5dee\u30a2\u30f3\u30b5\u30f3\u30d6\u30eb\u884c\u5217\u3092\u4f5c\u6210\n\u4e88\u6e2c\u51fa\u529b\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a08\u7b97\u3057\u307e\u3059.\n\\bar{y}^{(i)}_k = C\\bar{x}^{(i)}_k + v^{(i)}_k\n\n\u4e88\u6e2c\u51fa\u529b\u3082\u540c\u69d8\u306b\u8aa4\u5dee\u30a2\u30f3\u30b5\u30f3\u30d6\u30eb\u884c\u5217\u3092\u4f5c\u308a\u307e\u3059.\n\\tilde{y}^{(i)}_k = \\bar{y}^{(i)}_k - \\frac{1}{M}\\sum_{i=1}^{M}\\bar{y}^{(i)}_k \\\\\n\\tilde{Y}_k = \\begin{bmatrix}\\tilde{y}^{(1)}_k & \\cdots & \\tilde{y}^{(M)}_k \\end{bmatrix}\n\n3.\u5171\u5206\u6563\u884c\u5217\u3092\u8a08\u7b97\n\u5171\u5206\u6563\u884c\u5217\u3092\u305d\u308c\u305e\u308c\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a08\u7b97\u3057\u307e\u3059.\nU_k = \\frac{1}{M-1} \\tilde{X}_k \\tilde{X}^{\\sf T}_k\\\\\nV_k = \\frac{1}{M-1} \\tilde{Y}_k \\tilde{Y}^{\\sf T}_k\n\n4.\u30ab\u30eb\u30de\u30f3\u30b2\u30a4\u30f3\u3092\u8a08\u7b97\n\u30ab\u30eb\u30de\u30f3\u30b2\u30a4\u30f3$H_k$\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a08\u7b97\u3057\u307e\u3059.\nH_k = U_k(V_k)^{-1}\n\n\u3053\u3053\u3067, \u30ab\u30eb\u30de\u30f3\u30b2\u30a4\u30f3\u306e\u8a08\u7b97\u306b\u9006\u884c\u5217\u304c\u5165\u3063\u3066\u3044\u307e\u3059\u304c, $V_k$\u306e\u30b5\u30a4\u30ba\u304c(\u51fa\u529b\u306e\u30b5\u30a4\u30ba)\u00d7(\u51fa\u529b\u306e\u30b5\u30a4\u30ba)\u3067\u3042\u308b\u3053\u3068\u306b\u6ce8\u610f\u3059\u308b\u3068, \u6bd4\u8f03\u7684\u4f4e\u30b3\u30b9\u30c8\u306a\u9006\u884c\u5217\u8a08\u7b97\u3067\u3042\u308b\u3053\u3068\u306b\u6ce8\u610f\u3057\u3066\u304a\u304d\u307e\u3059.\n5.\u30ab\u30eb\u30de\u30f3\u30b2\u30a4\u30f3\u3092\u7528\u3044\u3066\u66f4\u65b0\n\u5148\u307b\u3069\u8a08\u7b97\u3057\u305f\u30ab\u30eb\u30de\u30f3\u30b2\u30a4\u30f3\u3092\u7528\u3044\u3066\u4e88\u6e2c\u5024\u3092\u66f4\u65b0\u3057\u307e\u3059.\n\\hat{x}^{(i)}_k = \\bar{x}^{(i)}_k + H_k\\left(y_k - \\bar{y}^{(i)}_k \\right)\n\n6.\u63a8\u5b9a\u5024\u3092\u30a2\u30f3\u30b5\u30f3\u30d6\u30eb\u5e73\u5747\u3068\u3059\u308b\n\u63a8\u5b9a\u5024\u3092\u5229\u7528\u3059\u308b\u5834\u5408\u306f, \u30a2\u30f3\u30b5\u30f3\u30d6\u30eb\u306e\u5e73\u5747\u5024\u3092\u7528\u3044\u3066\u63a8\u5b9a\u5024\u3068\u3057\u307e\u3059.\n\\hat{x}_k = \\frac{1}{M}\\sum_{i=1}^{M}\\hat{x}^{(i)}_k\n\n\n\u4e88\u6e2c\u30b9\u30c6\u30c3\u30d7\n\u72b6\u614b\u306e\u4e88\u6e2c\u5024\u306f, \u30b7\u30b9\u30c6\u30e0\u306e\u72b6\u614b\u9077\u79fb\u95a2\u6570\u3092\u7528\u3044\u3066\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a08\u7b97\u3057\u307e\u3059.\n\\bar{x}^{(i)}_{k+1} = f(\\hat{x}^{(i)}_k, k) + w^{(i)}_k\n\n\n\u6570\u5024\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\n\u3053\u3053\u3067\u306f, Lorenz\u65b9\u7a0b\u5f0f\u3068\u547c\u3070\u308c\u308b\u975e\u7dda\u5f62\u30c0\u30a4\u30ca\u30df\u30af\u30b9\u3092\u5229\u7528\u3057\u3066\u63a8\u5b9a\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u884c\u3044\u307e\u3059.\n\nLorenz\u65b9\u7a0b\u5f0f\nLorenz\u65b9\u7a0b\u5f0f\u306f\u4ee5\u4e0b\u306e\u69d8\u306a\u5f62\u3067\u8868\u3055\u308c\u307e\u3059.\n\\dot{x} = \\sigma(y-x)\\\\\n\\dot{y} = rx -y-z\\\\\n\\dot{z} = -bz + xy\n\n\u305f\u3060\u3057, $\\sigma = 10, r = 28, b = \\frac{8}{3}$\u3068\u3057\u307e\u3059.\nLorenz\u65b9\u7a0b\u5f0f\u3092\u8868\u3059\u95a2\u6570\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059.\n\nlorenz.m\nfunction dx = lorenz(x, t)\n    s = 10;\n    R = 28;\n    b= 8/3;\n\n    dx = [-s*(x(1)-x(2))  R*x(1)-x(2)-x(1)*x(3)  x(1)*x(2) - b*x(3)];   \nend\n\n\n\u306a\u304a, \u3053\u3053\u3067\u306f\u51fa\u529b\u5024\u3082\u597d\u307f\u306b\u5909\u66f4\u3067\u304d\u308b\u3088\u3046\u95a2\u6570\u5316\u3057\u307e\u3057\u305f.\n\nmyoutput.m\nfunction y = myoutput(x,t)\n    y = x';\nend\n\n\n\nEnsemble Kalman Filter\u306e\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\n\u30b5\u30f3\u30d7\u30eb\u6570\u3092100\u3068\u3057\u3066, \u4ee5\u4e0b\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u306b\u3088\u308a\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u884c\u3044\u307e\u3057\u305f.\n\u4eca\u56de\u306f4\u6b21\u306e\u30eb\u30f3\u30b2\u30af\u30c3\u30bf\u6cd5\u306b\u3088\u308a\u96e2\u6563\u5316\u3092\u884c\u3063\u3066\u3044\u307e\u3059.\n\nenkfsim.m\nclear\nclose\nclc\n\n%% \u5206\u6563\u306e\u521d\u671f\u8a2d\u5b9a\nRtr = 0.3;\nR = diag([0.5, 0.2, 0.1]);\nQ = diag([2, 4, 3]);\ndt = 0.01;\n\n%% \u771f\u5024\u306e\u8a08\u7b97\nt = [0:dt:30]; %\u6642\u9593\nxtr0(1,:) = [5 3 3]; %\u771f\u5024\u306e\u521d\u671f\u5024\nytr(:,1) = myoutput(xtr0(1,:),t(1)); %\u771f\u5024\u306e\u51fa\u529b\nw(:,1) =  Q*randn(length(xtr0(1,:)),1);\nxtr(1,:) = xtr0;\nfor i = 2:length(t)\n    k1 = lorenz(xtr(i-1,:), t(i-1));\n    k2 = lorenz(xtr(i-1,:)+dt*k1/2 ,t(i-1)+dt/2);\n    k3 = lorenz(xtr(i-1,:)+dt*k2/2 ,t(i-1)+dt/2);\n    k4 = lorenz(xtr(i-1,:)+dt*k3 ,t(i-1)+dt);\n    w(:,i) =  Q*randn(length(xtr(1,:)),1);\n    xtr(i,:) = xtr(i-1,:) + dt* (k1+2*k2+2*k3+k4)/6 + w(:,i-1)'*dt;\n    ytr(:,i) = myoutput(xtr(i,:),t(i));\nend\n\n%% \u89b3\u6e2c\u5024\u306e\u8a08\u7b97\n[len_y, len_x] = size(ytr);\nfor i = 1:length(t)\n    yt(:,i) = ytr(:,i) + R*randn(len_y,1);\nend\n\n%%  EnKF\u306e\u521d\u671f\u8a2d\u5b9a\nM = 100; %\u30b5\u30f3\u30d7\u30eb\u306e\u6570\nbarx0 = [2;10;1]; %\u72b6\u614b\u306e\u521d\u671f\u5024\nP0 = diag([1,3, 3]); %\u5171\u5206\u6563\u884c\u5217\u306e\u521d\u671f\u5024\nfor j = 1:M\n    x0(:,j) = barx0 + Q*randn(length(xtr(1,:)),1); %\u5404\u30b5\u30f3\u30d7\u30eb\u306e\u521d\u671f\u5024\nend\nfor j = 1:M\n    y0(:,j) = myoutput(x0(:,j)',t(1)) + R*randn(len_y,1); %\u5404\u30b5\u30f3\u30d7\u30eb\u306e\u4e88\u6e2c\u5024\u8a08\u7b97\nend\n\n%% Ensemble Kalman Filter\u306e\u8a08\u7b97\nfor i = 1:length(t)-1\n    %%%%  EnKF: \u89b3\u6e2c\u66f4\u65b0\u30b9\u30c6\u30c3\u30d7  %%%%\n    xhat = sum(x0(:,:)')'/M; %\u30a2\u30f3\u30b5\u30f3\u30d6\u30eb\u5e73\u5747\u306e\u8a08\u7b97\n    yhat = sum(y0(:,:)')'/M; %\u4e88\u6e2c\u5024\u306e\u5e73\u5747\u5024\n    yest(:,i) = yhat;\n    Pxy = ((kron(eye(1,100),xhat)) - x0)*((kron(eye(1,100),yhat)) - y0)'/(M-1);\n    Pyy = ((kron(eye(1,100),yhat))-y0)*((kron(eye(1,100),yhat))-y0)'/(M-1);\n    K = Pxy*inv(Pyy); %\u30ab\u30eb\u30de\u30f3\u30b2\u30a4\u30f3\u306e\u8a08\u7b97\n    %%%%  EnKF: \u4e88\u6e2c\u66f4\u65b0\u30b9\u30c6\u30c3\u30d7  %%%%\n    for j = 1:M\n        x(:,j) = x0(:,j) + K*(yt(:, i) - y0(:,j));\n        x0(:,j) = x(:,j) + lorenz(x(:,j),t(i))'.*dt + Q*randn(length(xtr(1,:)),1).*dt;\n        y0(:,j) = myoutput(x0(:,j)',t(i+1)) + R*randn(len_y,1);\n    end\nend\n\n%% \u4ee5\u4e0b, \u8868\u793a\u306b\u95a2\u3059\u308b\u51e6\u7406\nyest(:,length(t)) = sum(y0(:,:)')'/M;\n\nfigure(1);\nsubplot(2,2,1);\ngraph1 = plot(t,ytr(1,:),'r', t, yest(1,:));\nhold on\ngrid on\nlegend('True', 'Estimate');\ntitle('Ensemble Kalman Filter Simulation');\nset(graph1, 'linewidth', 1.5);\nxlabel('Time [s]');\nylabel('x');\n\nsubplot(2,2,2);\ngraph2 = plot(t,ytr(2,:),'r', t, yest(2,:));\nhold on\ngrid on\nlegend('True', 'Estimate');\ntitle('Ensemble Kalman Filter Simulation');\nset(graph2, 'linewidth', 1.5);\nxlabel('Time [s]');\nylabel('y');\n\nsubplot(2,2,3);\ngraph3 = plot(t,ytr(3,:),'r', t, yest(3,:));\nhold on\ngrid on\nlegend('True', 'Estimate');\ntitle('Ensemble Kalman Filter Simulation');\nset(graph3, 'linewidth', 1.5);\nxlabel('Time [s]');\nylabel('z');\n\nsubplot(2,2,4);\ngg = plot3(yest(1,:), yest(2,:), yest(3,:), 'b', ytr(1,:), ytr(2,:), ytr(3,:),'r');\nhold on\ng2 = plot3(yest(1,1), yest(2,1), yest(3,1), 'b.', ytr(1,1), ytr(2,1), ytr(3,1),'r');\ntitle('EnKF Simulation (Lorenz)');\ngrid on\nset(gg, 'linewidth', 2);\nset(g2, 'markersize', 10);\nlegend('Estimatin', 'True');\n\n\n\n\n\u7d50\u679c\n\n\u9752\u304c\u63a8\u5b9a\u5024, \u8d64\u304c\u771f\u5024\u3067\u3059.\n\u6bd4\u8f03\u7684\u3044\u3044\u611f\u3058\u306b\u63a8\u5b9a\u3067\u304d\u3066\u308b\u3068\u601d\u3044\u307e\u3059.\n\n\u7d50\u8ad6\n\u975e\u7dda\u5f62\u30ab\u30eb\u30de\u30f3\u30d5\u30a3\u30eb\u30bf\u306e\u3072\u3068\u3064\u3067\u3042\u308bEnsemble Kalman Filter\u306e\u7d39\u4ecb\u3068\u6570\u5024\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u884c\u3044\u307e\u3057\u305f.\n\u6570\u5024\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u3067\u306f\u72b6\u614b\u7a7a\u9593\u306f3\u6b21\u5143\u3067\u3059\u304c, Ensemble Kalman Filter\u304c\u5a01\u529b\u3092\u767a\u63ee\u3059\u308b\u306e\u306f\u72b6\u614b\u7a7a\u9593\u304c\u9ad8\u6b21\u5143\u306b\u306a\u3063\u305f\u3068\u304d\u3067\u3059.\n\u3053\u306e\u3088\u3046\u306a\u5834\u5408\u306fParticle Filter\u3067\u3082\u5341\u5206\u306a\u8a08\u7b97\u901f\u5ea6\u3067\u9ad8\u7cbe\u5ea6\u306a\u63a8\u5b9a\u3092\u884c\u3048\u308b\u3068\u601d\u3044\u307e\u3059.\n\u3057\u304b\u3057, Ensemble Kalman Filter\u3067\u306f100\u30b5\u30f3\u30d7\u30eb\u3067\u3082\u5341\u5206\u306b\u63a8\u5b9a\u3067\u304d\u308b\u3068\u3053\u308d\u304c\u5229\u70b9\u3068\u8a00\u3048\u308b\u3067\u3057\u3087\u3046.\n##\u975e\u7dda\u5f62\u30b7\u30b9\u30c6\u30e0\u306e\u63a8\u5b9a\n\u4e16\u306e\u4e2d\u306e\u591a\u304f\u306e\u52d5\u7684\u306a\u73fe\u8c61\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8868\u73fe\u3055\u308c\u307e\u3059.\n\n```math\n\\frac{d}{dt}x(t) = f(x, t), \\quad x(0) = x_0\n```\n\n\u3053\u306e\u3088\u3046\u306a\u73fe\u8c61\u306b\u304a\u3044\u3066, \u4e00\u822c\u306b\u30bb\u30f3\u30b5\u3067\u6e2c\u308b\u306a\u3069\u3057\u3066\u5f97\u3089\u308c\u308b\u51fa\u529b\u306f$x$\u306e\u4e00\u90e8\u3067\u3042\u308a, \u3057\u304b\u3082\u30bb\u30f3\u30b5\u30ce\u30a4\u30ba\u7b49\u304c\u542b\u307e\u308c\u308b\u5834\u5408\u304c\u591a\u3044\u3067\u3059.\n\u3053\u306e\u5834\u5408, \u3088\u304f\u4f7f\u308f\u308c\u308b\u30aa\u30f3\u30e9\u30a4\u30f3\u63a8\u5b9a\u624b\u6cd5\u3068\u3057\u3066\u30ab\u30eb\u30de\u30f3\u30d5\u30a3\u30eb\u30bf\u304c\u7528\u3044\u3089\u308c\u307e\u3059\u304c, \u4e00\u822c\u306e\u30ab\u30eb\u30de\u30f3\u30d5\u30a3\u30eb\u30bf\u306f\u7dda\u5f62\u30b7\u30b9\u30c6\u30e0\u306b\u3057\u304b\u9069\u7528\u3067\u304d\u305a, \u975e\u7dda\u5f62\u30b7\u30b9\u30c6\u30e0\u306b\u5bfe\u3057\u3066\u306f\u975e\u7dda\u5f62\u30ab\u30eb\u30de\u30f3\u30d5\u30a3\u30eb\u30bf\u3068\u547c\u3070\u308c\u308b\u3082\u306e\u3092\u9069\u7528\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059.\n\n##\u975e\u7dda\u5f62Kalman Filter\n\u975e\u7dda\u5f62Kalman Filter\u306b\u306f\u5927\u304d\u304f\u308f\u3051\u30664\u7a2e\u985e(\u53b3\u5bc6\u306b\u306f3\u7a2e\u985e?)\u3042\u308a\u307e\u3059.\n\n### \u62e1\u5f35\u30ab\u30eb\u30de\u30f3\u30d5\u30a3\u30eb\u30bf(Extended Kalman Filter)\n\u6bce\u6642\u523b, \u63a8\u5b9a\u5024\u5468\u308a\u3067\u7dda\u5f62\u8fd1\u4f3c\u3092\u884c\u3046\u3053\u3068\u3067\u7dda\u5f62\u30ab\u30eb\u30de\u30f3\u30d5\u30a3\u30eb\u30bf\u306e\u624b\u6cd5\u3092\u9069\u7528\u3057\u307e\u3059. \u7dda\u5f62\u8fd1\u4f3c\u3092\u884c\u3063\u3066\u3044\u308b\u305f\u3081, \u975e\u7dda\u5f62\u6027\u304c\u5f37\u3044\u3068\u3059\u3050\u767a\u6563\u3057\u3066\u3057\u307e\u3044\u307e\u3059.\n\n### \u7121\u9999\u6599\u30ab\u30eb\u30de\u30f3\u30d5\u30a3\u30eb\u30bf(Unscented Kalman Filter)\n\u72b6\u614b\u7a7a\u9593\u4e0a\u306b\u5206\u5e03\u3059\u308b\u78ba\u7387\u5206\u5e03\u306e\u3046\u3061, \u4ee3\u8868\u7684\u306a\u70b9\u3092\u9078\u3093\u3067\u304d\u3066, \u305d\u306e\u70b9\u306e\u72b6\u614b\u9077\u79fb\u3092\u6c42\u3081\u308b\u3053\u3068\u3067\u4e88\u6e2c\u3057, \u51fa\u529b\u30d5\u30a3\u30fc\u30c9\u30d0\u30c3\u30af\u306b\u3088\u308a\u66f4\u65b0\u3059\u308b\u30ab\u30eb\u30de\u30f3\u30d5\u30a3\u30eb\u30bf\u3067\u3059. \u62e1\u5f35\u30ab\u30eb\u30de\u30f3\u30d5\u30a3\u30eb\u30bf\u306b\u6bd4\u3079\u3066\u7cbe\u5ea6\u304c\u3088\u304f, \u72b6\u614b\u30d9\u30af\u30c8\u30eb\u306e\u6b21\u5143\u304c$n$\u306e\u5834\u5408\u306f\u4ee3\u8868\u70b9\u3068\u3057\u3066$2n+1$\u500b\u306e\u70b9\u3060\u3051\u3067\u6e08\u3080\u306e\u3067, \u8a08\u7b97\u30b3\u30b9\u30c8\u7684\u306b\u3082\u6709\u5229\u3067\u3059.\n\n### \u30d1\u30fc\u30c6\u30a3\u30af\u30eb\u30d5\u30a3\u30eb\u30bf(Particle Filter)\n\u72b6\u614b\u7a7a\u9593\u4e0a\u306b\u30d1\u30fc\u30c6\u30a3\u30af\u30eb\u3092\u6492\u304d, \u305d\u306e\u30d1\u30fc\u30c6\u30a3\u30af\u30eb\u306e\u72b6\u614b\u9077\u79fb\u3092\u8a08\u7b97\u3059\u308b\u3053\u3068\u3067\u4e88\u6e2c\u3092\u884c\u3044\u307e\u3059. \u305d\u306e\u5f8c, \u73fe\u5b9f\u306e\u51fa\u529b\u3092\u30d5\u30a3\u30fc\u30c9\u30d0\u30c3\u30af\u3057\u3066\u5c24\u5ea6\u3092\u8a08\u7b97\u3057, \u5c24\u5ea6\u306e\u4f4e\u3044\u30d1\u30fc\u30c6\u30a3\u30af\u30eb\u3092\u5c24\u5ea6\u306e\u9ad8\u3044\u30d1\u30fc\u30c6\u30a3\u30af\u30eb\u306e\u4f4d\u7f6e\u306b\u6492\u304d\u76f4\u3057(\u30ea\u30b5\u30f3\u30d7\u30ea\u30f3\u30b0)\u3092\u3059\u308b\u3053\u3068\u3067\u63a8\u5b9a\u3092\u884c\u3044\u307e\u3059. \u4e00\u822c\u306b\u306f\u30d1\u30fc\u30c6\u30a3\u30af\u30eb\u306e\u5e73\u5747\u5024\u3092\u63a8\u5b9a\u5024\u3068\u3057\u3066, \u5b9f\u969b\u306b\u5024\u3068\u3057\u3066\u7528\u3044\u308b\u5834\u5408\u304c\u591a\u3044\u3067\u3059. \u4e0a\u8a182\u3064\u306e\u624b\u6cd5\u306f\u78ba\u7387\u5206\u5e03\u3092\u30ac\u30a6\u30b9\u5206\u5e03\u306b\u8fd1\u4f3c\u3057\u3066\u3044\u308b\u306e\u3067, \u3053\u306e\u624b\u6cd5\u306f\u975e\u5e38\u306b\u7cbe\u5ea6\u304c\u9ad8\u3044\u3053\u3068\u304c\u5229\u70b9\u3067\u3059\u304c, \u30d1\u30fc\u30c6\u30a3\u30af\u30eb\u306e\u6570\u304c\u975e\u5e38\u306b\u591a\u304f\u5fc5\u8981\u3067\u3042\u308a, \u8a08\u7b97\u30b3\u30b9\u30c8\u306f\u975e\u5e38\u306b\u5927\u304d\u304f\u306a\u308a\u307e\u3059.\n\n### \u30a2\u30f3\u30b5\u30f3\u30d6\u30eb\u30ab\u30eb\u30de\u30f3\u30d5\u30a3\u30eb\u30bf(Ensemble Kalman Filter)\n\u624b\u6cd5\u306f\u30d1\u30fc\u30c6\u30a3\u30af\u30eb\u30d5\u30a3\u30eb\u30bf\u3068\u4f3c\u3066\u3044\u3066, \u72b6\u614b\u7a7a\u9593\u4e0a\u306b\u3044\u304f\u3064\u304b\u306e\u30b5\u30f3\u30d7\u30eb\u72b6\u614b\u3092\u7528\u610f\u3057, \u72b6\u614b\u30a2\u30f3\u30b5\u30f3\u30d6\u30eb(\u30d1\u30fc\u30c6\u30a3\u30af\u30eb\u306e\u96c6\u307e\u308a\u3068\u540c\u3058\u610f\u5473)\u3092\u305d\u308c\u305e\u308c\u72b6\u614b\u9077\u79fb\u3055\u305b\u3066\u4e88\u6e2c\u3057\u307e\u3059. \u3053\u3053\u307e\u3067\u306f\u30d1\u30fc\u30c6\u30a3\u30af\u30eb\u30d5\u30a3\u30eb\u30bf\u3068\u540c\u3058\u3067\u3059\u304c, \u73fe\u5b9f\u306e\u51fa\u529b\u3092\u30d5\u30a3\u30fc\u30c9\u30d0\u30c3\u30af\u3057\u305f\u969b\u306b, \u72b6\u614b\u30a2\u30f3\u30b5\u30f3\u30d6\u30eb\u3092\u3088\u308a\u5c24\u5ea6\u306e\u9ad8\u3044\u65b9\u3078\u304b\u304d\u96c6\u3081\u308b\u3088\u3046\u306a\u66f4\u65b0\u3092\u884c\u3044\u307e\u3059. \u3053\u3061\u3089\u3082\u30d1\u30fc\u30c6\u30a3\u30af\u30eb\u30d5\u30a3\u30eb\u30bf\u3068\u4f3c\u305f\u3088\u3046\u306a\u5229\u70b9\u3068\u6b20\u70b9\u3092\u6301\u3061\u307e\u3059\u304c, \u30d1\u30fc\u30c6\u30a3\u30af\u30eb\u30d5\u30a3\u30eb\u30bf\u307b\u3069\u7cbe\u5ea6\u306f\u9ad8\u304f\u306a\u3044\u3082\u306e\u306e, \u30b5\u30f3\u30d7\u30eb\u6570\u306f\u6bd4\u8f03\u7684\u5c11\u306a\u3081\u3067\u6e08\u3080\u306e\u3067, \u8a08\u7b97\u30b3\u30b9\u30c8\u7684\u306b\u306f\u30d1\u30fc\u30c6\u30a3\u30af\u30eb\u30d5\u30a3\u30eb\u30bf\u3088\u308a\u3082\u512a\u308c\u3066\u3044\u307e\u3059. \u7279\u306b\u5927\u898f\u6a21\u7cfb\u306e\u63a8\u5b9a\u3067\u306f\u5a01\u529b\u3092\u767a\u63ee\u3057, \u5b9f\u969b\u6c17\u8c61\u7cfb\u3067\u306f\u7528\u3044\u3089\u308c\u308b\u3053\u3068\u304c\u591a\u3044\u3067\u3059(\u3068\u3044\u3046\u304b, \u3082\u3068\u3082\u3068\u6c17\u8c61\u7cfb\u3067\u4f7f\u3046\u305f\u3081\u306b\u51fa\u3066\u304d\u305f\u306f\u305a\u3060\u3063\u305f\u3068\u601d\u3044\u307e\u3059).\n\n#Ensemble Kalman Filter\n\u30d1\u30fc\u30c6\u30a3\u30af\u30eb\u30d5\u30a3\u30eb\u30bf\u7b49\u306f\u6bd4\u8f03\u7684\u6587\u732e\u3092\u898b\u304b\u3051\u307e\u3059\u304c, \u30a2\u30f3\u30b5\u30f3\u30d6\u30eb\u30ab\u30eb\u30de\u30f3\u30d5\u30a3\u30eb\u30bf\u306f\u307b\u3068\u3093\u3069\u898b\u304b\u3051\u306a\u3044\u306e\u3067, \u3053\u3053\u3067\u306f\u30a2\u30f3\u30b5\u30f3\u30d6\u30eb\u30ab\u30eb\u30de\u30f3\u30d5\u30a3\u30eb\u30bf\u3092\u53d6\u308a\u4e0a\u3052\u305f\u3044\u3068\u601d\u3044\u307e\u3059.\n\n## \u63a8\u5b9a\u5bfe\u8c61\n\u3053\u3053\u3067\u306f, \u4ee5\u4e0b\u306e\u96e2\u6563\u6642\u9593\u975e\u7dda\u5f62\u30b7\u30b9\u30c6\u30e0\u306e\u63a8\u5b9a\u3092\u8003\u3048\u307e\u3059.\n\n```math\nx_{k+1} = f(x_k, k) + w_k \\\\\ny_k = Cx_k + v_k\n```\n\n\u307e\u305f, \u72b6\u614b\u7a7a\u9593\u4e0a\u306e\u30b5\u30f3\u30d7\u30eb\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8868\u73fe\u3057\u307e\u3059.\n\n```math\nx^{(i)}_{k+1} = f(x^{(i)}_k, k) + w^{(i)}_k\\\\\ny^{(i)}_k = Cx^{(i)}_k + v^{(i)}_k\n```\n\u305f\u3060\u3057, $i \\in \\\\{ 1, \\ldots, M \\\\}$\u3068\u3057, $M$\u304c\u7dcf\u30b5\u30f3\u30d7\u30eb\u6570\u3068\u306a\u308a\u307e\u3059.\n\u4ee5\u4e0b\u3067\u306f, $\\bar{x}$\u3092\u4e88\u6e2c\u5024, $\\hat{x}$\u3092\u66f4\u65b0\u5024, $\\tilde{x}$\u3092\u8aa4\u5dee\u3068\u3057\u307e\u3059.\n\n##\u66f4\u65b0\u30b9\u30c6\u30c3\u30d7\n\n**1.\u4e88\u6e2c\u5e73\u5747\u5024\u3068\u306e\u8aa4\u5dee\u30a2\u30f3\u30b5\u30f3\u30d6\u30eb\u884c\u5217\u3092\u4f5c\u6210**\n\u4e88\u6e2c\u5024\u306e\u5e73\u5747\u5024\u3068\u306e\u8aa4\u5dee\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u6c42\u3081\u307e\u3059.\n\n```math\n\\tilde{x}^{(i)}_k = \\bar{x}^{(i)}_k - \\frac{1}{M}\\sum_{i=1}^{M}\\bar{x}^{(i)}_k\n```\n\n\u3053\u306e\u3068\u304d, \u8aa4\u5dee\u30a2\u30f3\u30b5\u30f3\u30d6\u30eb\u884c\u5217\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u4f5c\u308a\u307e\u3059.\n\n```math\n\\tilde{X}_k = \\begin{bmatrix}\\tilde{x}^{(1)}_k & \\cdots & \\tilde{x}^{(M)}_k \\end{bmatrix}\n```\n\n**2.\u4e88\u6e2c\u51fa\u529b\u3082\u8aa4\u5dee\u30a2\u30f3\u30b5\u30f3\u30d6\u30eb\u884c\u5217\u3092\u4f5c\u6210**\n\u4e88\u6e2c\u51fa\u529b\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a08\u7b97\u3057\u307e\u3059.\n\n```math\n\\bar{y}^{(i)}_k = C\\bar{x}^{(i)}_k + v^{(i)}_k\n```\n\n\u4e88\u6e2c\u51fa\u529b\u3082\u540c\u69d8\u306b\u8aa4\u5dee\u30a2\u30f3\u30b5\u30f3\u30d6\u30eb\u884c\u5217\u3092\u4f5c\u308a\u307e\u3059.\n\n```math\n\\tilde{y}^{(i)}_k = \\bar{y}^{(i)}_k - \\frac{1}{M}\\sum_{i=1}^{M}\\bar{y}^{(i)}_k \\\\\n\\tilde{Y}_k = \\begin{bmatrix}\\tilde{y}^{(1)}_k & \\cdots & \\tilde{y}^{(M)}_k \\end{bmatrix}\n```\n\n**3.\u5171\u5206\u6563\u884c\u5217\u3092\u8a08\u7b97**\n\u5171\u5206\u6563\u884c\u5217\u3092\u305d\u308c\u305e\u308c\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a08\u7b97\u3057\u307e\u3059.\n\n```math\nU_k = \\frac{1}{M-1} \\tilde{X}_k \\tilde{X}^{\\sf T}_k\\\\\nV_k = \\frac{1}{M-1} \\tilde{Y}_k \\tilde{Y}^{\\sf T}_k\n```\n\n**4.\u30ab\u30eb\u30de\u30f3\u30b2\u30a4\u30f3\u3092\u8a08\u7b97**\n\u30ab\u30eb\u30de\u30f3\u30b2\u30a4\u30f3$H_k$\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a08\u7b97\u3057\u307e\u3059.\n\n```math\nH_k = U_k(V_k)^{-1}\n```\n\n\u3053\u3053\u3067, \u30ab\u30eb\u30de\u30f3\u30b2\u30a4\u30f3\u306e\u8a08\u7b97\u306b\u9006\u884c\u5217\u304c\u5165\u3063\u3066\u3044\u307e\u3059\u304c, $V_k$\u306e\u30b5\u30a4\u30ba\u304c(\u51fa\u529b\u306e\u30b5\u30a4\u30ba)\u00d7(\u51fa\u529b\u306e\u30b5\u30a4\u30ba)\u3067\u3042\u308b\u3053\u3068\u306b\u6ce8\u610f\u3059\u308b\u3068, \u6bd4\u8f03\u7684\u4f4e\u30b3\u30b9\u30c8\u306a\u9006\u884c\u5217\u8a08\u7b97\u3067\u3042\u308b\u3053\u3068\u306b\u6ce8\u610f\u3057\u3066\u304a\u304d\u307e\u3059.\n\n**5.\u30ab\u30eb\u30de\u30f3\u30b2\u30a4\u30f3\u3092\u7528\u3044\u3066\u66f4\u65b0**\n\u5148\u307b\u3069\u8a08\u7b97\u3057\u305f\u30ab\u30eb\u30de\u30f3\u30b2\u30a4\u30f3\u3092\u7528\u3044\u3066\u4e88\u6e2c\u5024\u3092\u66f4\u65b0\u3057\u307e\u3059.\n\n```math\n\\hat{x}^{(i)}_k = \\bar{x}^{(i)}_k + H_k\\left(y_k - \\bar{y}^{(i)}_k \\right)\n```\n\n**6.\u63a8\u5b9a\u5024\u3092\u30a2\u30f3\u30b5\u30f3\u30d6\u30eb\u5e73\u5747\u3068\u3059\u308b**\n\u63a8\u5b9a\u5024\u3092\u5229\u7528\u3059\u308b\u5834\u5408\u306f, \u30a2\u30f3\u30b5\u30f3\u30d6\u30eb\u306e\u5e73\u5747\u5024\u3092\u7528\u3044\u3066\u63a8\u5b9a\u5024\u3068\u3057\u307e\u3059.\n\n```math\n\\hat{x}_k = \\frac{1}{M}\\sum_{i=1}^{M}\\hat{x}^{(i)}_k\n```\n\n##\u4e88\u6e2c\u30b9\u30c6\u30c3\u30d7\n\u72b6\u614b\u306e\u4e88\u6e2c\u5024\u306f, \u30b7\u30b9\u30c6\u30e0\u306e\u72b6\u614b\u9077\u79fb\u95a2\u6570\u3092\u7528\u3044\u3066\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a08\u7b97\u3057\u307e\u3059.\n\n```math\n\\bar{x}^{(i)}_{k+1} = f(\\hat{x}^{(i)}_k, k) + w^{(i)}_k\n```\n\n#\u6570\u5024\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\n\u3053\u3053\u3067\u306f, Lorenz\u65b9\u7a0b\u5f0f\u3068\u547c\u3070\u308c\u308b\u975e\u7dda\u5f62\u30c0\u30a4\u30ca\u30df\u30af\u30b9\u3092\u5229\u7528\u3057\u3066\u63a8\u5b9a\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u884c\u3044\u307e\u3059.\n##Lorenz\u65b9\u7a0b\u5f0f\nLorenz\u65b9\u7a0b\u5f0f\u306f\u4ee5\u4e0b\u306e\u69d8\u306a\u5f62\u3067\u8868\u3055\u308c\u307e\u3059.\n\n```math\n\\dot{x} = \\sigma(y-x)\\\\\n\\dot{y} = rx -y-z\\\\\n\\dot{z} = -bz + xy\n```\n\u305f\u3060\u3057, $\\sigma = 10, r = 28, b = \\frac{8}{3}$\u3068\u3057\u307e\u3059.\n\nLorenz\u65b9\u7a0b\u5f0f\u3092\u8868\u3059\u95a2\u6570\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059.\n\n```matlab:lorenz.m\nfunction dx = lorenz(x, t)\n\ts = 10;\n\tR = 28;\n\tb= 8/3;\n\t\n\tdx = [-s*(x(1)-x(2))  R*x(1)-x(2)-x(1)*x(3)  x(1)*x(2) - b*x(3)];\t\nend\n```\n\n\u306a\u304a, \u3053\u3053\u3067\u306f\u51fa\u529b\u5024\u3082\u597d\u307f\u306b\u5909\u66f4\u3067\u304d\u308b\u3088\u3046\u95a2\u6570\u5316\u3057\u307e\u3057\u305f.\n\n```matlab:myoutput.m\nfunction y = myoutput(x,t)\n\ty = x';\nend\n```\n\n##Ensemble Kalman Filter\u306e\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\n\u30b5\u30f3\u30d7\u30eb\u6570\u3092100\u3068\u3057\u3066, \u4ee5\u4e0b\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u306b\u3088\u308a\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u884c\u3044\u307e\u3057\u305f.\n\u4eca\u56de\u306f4\u6b21\u306e\u30eb\u30f3\u30b2\u30af\u30c3\u30bf\u6cd5\u306b\u3088\u308a\u96e2\u6563\u5316\u3092\u884c\u3063\u3066\u3044\u307e\u3059.\n\n```matlab:enkfsim.m\nclear\nclose\nclc\n\n%% \u5206\u6563\u306e\u521d\u671f\u8a2d\u5b9a\nRtr = 0.3;\nR = diag([0.5, 0.2, 0.1]);\nQ = diag([2, 4, 3]);\ndt = 0.01;\n\n%% \u771f\u5024\u306e\u8a08\u7b97\nt = [0:dt:30]; %\u6642\u9593\nxtr0(1,:) = [5 3 3]; %\u771f\u5024\u306e\u521d\u671f\u5024\nytr(:,1) = myoutput(xtr0(1,:),t(1)); %\u771f\u5024\u306e\u51fa\u529b\nw(:,1) =  Q*randn(length(xtr0(1,:)),1);\nxtr(1,:) = xtr0;\nfor i = 2:length(t)\n\tk1 = lorenz(xtr(i-1,:), t(i-1));\n\tk2 = lorenz(xtr(i-1,:)+dt*k1/2 ,t(i-1)+dt/2);\n\tk3 = lorenz(xtr(i-1,:)+dt*k2/2 ,t(i-1)+dt/2);\n\tk4 = lorenz(xtr(i-1,:)+dt*k3 ,t(i-1)+dt);\n\tw(:,i) =  Q*randn(length(xtr(1,:)),1);\n\txtr(i,:) = xtr(i-1,:) + dt* (k1+2*k2+2*k3+k4)/6 + w(:,i-1)'*dt;\n\tytr(:,i) = myoutput(xtr(i,:),t(i));\nend\n\n%% \u89b3\u6e2c\u5024\u306e\u8a08\u7b97\n[len_y, len_x] = size(ytr);\nfor i = 1:length(t)\n\tyt(:,i) = ytr(:,i) + R*randn(len_y,1);\nend\n\n%%  EnKF\u306e\u521d\u671f\u8a2d\u5b9a\nM = 100; %\u30b5\u30f3\u30d7\u30eb\u306e\u6570\nbarx0 = [2;10;1]; %\u72b6\u614b\u306e\u521d\u671f\u5024\nP0 = diag([1,3, 3]); %\u5171\u5206\u6563\u884c\u5217\u306e\u521d\u671f\u5024\nfor j = 1:M\n\tx0(:,j) = barx0 + Q*randn(length(xtr(1,:)),1); %\u5404\u30b5\u30f3\u30d7\u30eb\u306e\u521d\u671f\u5024\nend\nfor j = 1:M\n\ty0(:,j) = myoutput(x0(:,j)',t(1)) + R*randn(len_y,1); %\u5404\u30b5\u30f3\u30d7\u30eb\u306e\u4e88\u6e2c\u5024\u8a08\u7b97\nend\n\n%% Ensemble Kalman Filter\u306e\u8a08\u7b97\nfor i = 1:length(t)-1\n\t%%%%  EnKF: \u89b3\u6e2c\u66f4\u65b0\u30b9\u30c6\u30c3\u30d7  %%%%\n\txhat = sum(x0(:,:)')'/M; %\u30a2\u30f3\u30b5\u30f3\u30d6\u30eb\u5e73\u5747\u306e\u8a08\u7b97\n\tyhat = sum(y0(:,:)')'/M; %\u4e88\u6e2c\u5024\u306e\u5e73\u5747\u5024\n\tyest(:,i) = yhat;\n\tPxy = ((kron(eye(1,100),xhat)) - x0)*((kron(eye(1,100),yhat)) - y0)'/(M-1);\n\tPyy = ((kron(eye(1,100),yhat))-y0)*((kron(eye(1,100),yhat))-y0)'/(M-1);\n\tK = Pxy*inv(Pyy); %\u30ab\u30eb\u30de\u30f3\u30b2\u30a4\u30f3\u306e\u8a08\u7b97\n\t%%%%  EnKF: \u4e88\u6e2c\u66f4\u65b0\u30b9\u30c6\u30c3\u30d7  %%%%\n\tfor j = 1:M\n\t\tx(:,j) = x0(:,j) + K*(yt(:, i) - y0(:,j));\n\t\tx0(:,j) = x(:,j) + lorenz(x(:,j),t(i))'.*dt + Q*randn(length(xtr(1,:)),1).*dt;\n\t\ty0(:,j) = myoutput(x0(:,j)',t(i+1)) + R*randn(len_y,1);\n\tend\nend\n\n%% \u4ee5\u4e0b, \u8868\u793a\u306b\u95a2\u3059\u308b\u51e6\u7406\nyest(:,length(t)) = sum(y0(:,:)')'/M;\n\nfigure(1);\nsubplot(2,2,1);\ngraph1 = plot(t,ytr(1,:),'r', t, yest(1,:));\nhold on\ngrid on\nlegend('True', 'Estimate');\ntitle('Ensemble Kalman Filter Simulation');\nset(graph1, 'linewidth', 1.5);\nxlabel('Time [s]');\nylabel('x');\n\nsubplot(2,2,2);\ngraph2 = plot(t,ytr(2,:),'r', t, yest(2,:));\nhold on\ngrid on\nlegend('True', 'Estimate');\ntitle('Ensemble Kalman Filter Simulation');\nset(graph2, 'linewidth', 1.5);\nxlabel('Time [s]');\nylabel('y');\n\nsubplot(2,2,3);\ngraph3 = plot(t,ytr(3,:),'r', t, yest(3,:));\nhold on\ngrid on\nlegend('True', 'Estimate');\ntitle('Ensemble Kalman Filter Simulation');\nset(graph3, 'linewidth', 1.5);\nxlabel('Time [s]');\nylabel('z');\n\nsubplot(2,2,4);\ngg = plot3(yest(1,:), yest(2,:), yest(3,:), 'b', ytr(1,:), ytr(2,:), ytr(3,:),'r');\nhold on\ng2 = plot3(yest(1,1), yest(2,1), yest(3,1), 'b.', ytr(1,1), ytr(2,1), ytr(3,1),'r');\ntitle('EnKF Simulation (Lorenz)');\ngrid on\nset(gg, 'linewidth', 2);\nset(g2, 'markersize', 10);\nlegend('Estimatin', 'True');\n\n```\n\n##\u7d50\u679c\n![enkf.png](https://qiita-image-store.s3.amazonaws.com/0/85827/139d2d94-8c5b-14ff-0a7a-beb0daadaf90.png)\n\u9752\u304c\u63a8\u5b9a\u5024, \u8d64\u304c\u771f\u5024\u3067\u3059.\n\u6bd4\u8f03\u7684\u3044\u3044\u611f\u3058\u306b\u63a8\u5b9a\u3067\u304d\u3066\u308b\u3068\u601d\u3044\u307e\u3059.\n\n#\u7d50\u8ad6\n\u975e\u7dda\u5f62\u30ab\u30eb\u30de\u30f3\u30d5\u30a3\u30eb\u30bf\u306e\u3072\u3068\u3064\u3067\u3042\u308bEnsemble Kalman Filter\u306e\u7d39\u4ecb\u3068\u6570\u5024\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u884c\u3044\u307e\u3057\u305f.\n\u6570\u5024\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u3067\u306f\u72b6\u614b\u7a7a\u9593\u306f3\u6b21\u5143\u3067\u3059\u304c, Ensemble Kalman Filter\u304c\u5a01\u529b\u3092\u767a\u63ee\u3059\u308b\u306e\u306f\u72b6\u614b\u7a7a\u9593\u304c\u9ad8\u6b21\u5143\u306b\u306a\u3063\u305f\u3068\u304d\u3067\u3059.\n\u3053\u306e\u3088\u3046\u306a\u5834\u5408\u306fParticle Filter\u3067\u3082\u5341\u5206\u306a\u8a08\u7b97\u901f\u5ea6\u3067\u9ad8\u7cbe\u5ea6\u306a\u63a8\u5b9a\u3092\u884c\u3048\u308b\u3068\u601d\u3044\u307e\u3059.\n\u3057\u304b\u3057, Ensemble Kalman Filter\u3067\u306f100\u30b5\u30f3\u30d7\u30eb\u3067\u3082\u5341\u5206\u306b\u63a8\u5b9a\u3067\u304d\u308b\u3068\u3053\u308d\u304c\u5229\u70b9\u3068\u8a00\u3048\u308b\u3067\u3057\u3087\u3046.\n"}