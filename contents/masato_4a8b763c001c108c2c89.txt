{"tags": ["Node.js0.10.38", "Hapi.js8.6.1", "swagger"], "context": " More than 1 year has passed since last update.MongoDB\u3078\u306eCRUD\u64cd\u4f5c\u3068Swagger UI\u304b\u3089API\u3092\u30c6\u30b9\u30c8\u3059\u308b\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092Hapi.js\u3067\u4f5c\u6210\u3057\u307e\u3057\u305f\u3002app.js\u306eRoute\u306e\u51e6\u7406\u304c\u9577\u304f\u306a\u3063\u305f\u306e\u3067\u3001\u5225\u30d5\u30a1\u30a4\u30eb\u306b\u79fb\u52d5\u3057\u3088\u3046\u3068\u601d\u3044\u307e\u3059\u3002Hapi.js\u3067\u306fPlugins\u306e\u4ed5\u7d44\u307f\u3067\u6a5f\u80fd\u62e1\u5f35\u304c\u3067\u304d\u307e\u3059\u3002Swagger\u306e\u30a4\u30f3\u30bf\u30d5\u30a7\u30fc\u30b9\u3092\u63d0\u4f9b\u3059\u308bhapi-swagger\u306fnpm\u304b\u3089\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3057\u305f\u304c\u3001\u30d7\u30e9\u30b0\u30a4\u30f3\u306f\u30a2\u30d7\u30ea\u5185\u306b\u3082\u7c21\u5358\u306b\u4f5c\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u306e\u3067Route\u51e6\u7406\u3092\u30d7\u30e9\u30b0\u30a4\u30f3\u306b\u30ea\u30d5\u30a1\u30af\u30bf\u30ea\u30f3\u30b0\u3057\u307e\u3059\u3002\n\u516c\u958b\u3055\u308c\u3066\u3044\u308b\u30d7\u30e9\u30b0\u30a4\u30f3\u306f\u3053\u3061\u3089\u306e\u30da\u30fc\u30b8\u306b\u7528\u9014\u5225\u306b\u307e\u3068\u307e\u3063\u3066\u3044\u307e\u3059\u3002\n\n\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\nRoute\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u4f5c\u6210\u3057\u305f\u30ea\u30dd\u30b8\u30c8\u30ea\u306f\u3053\u3061\u3089\u3067\u3059\u3002\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n$ cd ~/node_apps/docker-hapi\n$ tree -L 2\n.\n\u251c\u2500\u2500 Dockerfile\n\u251c\u2500\u2500 app.js\n\u251c\u2500\u2500 docker-compose.yml\n\u251c\u2500\u2500 models\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 job.js\n\u251c\u2500\u2500 mongo\n\u251c\u2500\u2500 node_modules -> /dist/node_modules\n\u251c\u2500\u2500 npm-debug.log\n\u251c\u2500\u2500 package.json\n\u2514\u2500\u2500 routes\n    \u2514\u2500\u2500 jobs.js\n\n\u4eca\u307e\u3067\u3068\u540c\u69d8\u306bDocker Compose\u3092\u4f7f\u3044MongoDB\u3068link\u3057\u3066\u3044\u307e\u3059\u3002\n\n/node_apps/docker-hapi/docker-compose.yml\nhapi:\n  build: .\n  ports:\n    - 3000:3000\n  volumes:\n    - .:/app\n  links:\n    - mongo\nmongo:\n  image: mongo\n  volumes:\n    - ./mongo:/data/db\n\n\n\nroutes/jobs.js\nroutes/jobs.js\u304c\u4f5c\u6210\u3057\u305f\u30d7\u30e9\u30b0\u30a4\u30f3\u3067\u3059\u3002\u9577\u304f\u306a\u308b\u306e\u3067POST\u4ee5\u5916\u306f\u7701\u7565\u3057\u307e\u3059\u3002\u4eca\u307e\u3067app.js\u306b\u5b9a\u7fa9\u3057\u3066\u3044\u305fRoute\u306e\u51e6\u7406\u3092exports.register\u306e\u95a2\u6570\u5185\u306b\u79fb\u52d5\u3057\u307e\u3057\u305f\u3002\n\n~/node_apps/docker-hapi/routes/jobs.js\n'use strict';\nvar Joi = require('joi');\nvar JobModel = require('../models/job');\n\nexports.register = function(server, options, next) {\n\n    server.route({\n        method: 'POST',\n        path: '/api/jobs',\n        config: {\n            tags: ['api'],\n            description: 'Save job data',\n            notes: 'Save job data',\n            validate: {\n                payload: {\n                    name: Joi.string().required(),\n                    query: Joi.string().required()\n                }\n            }\n        },\n        handler: function(request, reply) {\n            var job = new JobModel(request.payload);\n            job.save(function(error) {\n                if(error) {\n                    reply({\n                        statusCode: 503,\n                        message: error\n                    });\n                } else {\n                    reply({\n                        statusCode: 201,\n                        message: 'Job Saved Successfully'\n                    });\n                }\n            });\n        }\n    });\n...\n    // callback to complete\n    next();\n}\n\nexports.register.attributes = {\n    name: 'jobs-route'\n}\n\n\n\u91cd\u8981\u306a\u306e\u306f\u95a2\u6570\u306e\u6700\u5f8c\u306b\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u306enext()\u3092\u5b9f\u884c\u3057\u3066\u3053\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u3067\u306e\u51e6\u7406\u306e\u7d42\u4e86\u3092\u4f1d\u3048\u308b\u3053\u3068\u3067\u3059\u3002\u307e\u305fexports.register.attributes\u306b\u3053\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u540d\u524d\u3092\u5b9a\u7fa9\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\napp.js\nRoute\u306e\u51e6\u7406\u3092\u5225\u30d5\u30a1\u30a4\u30eb\u306b\u30d7\u30e9\u30b0\u30a4\u30f3\u3068\u3057\u3066\u79fb\u52d5\u3057\u305f\u306e\u3067app.js\u306e\u69cb\u6210\u306f\u3059\u3063\u304d\u308a\u3068\u77ed\u304f\u306a\u308a\u307e\u3057\u305f\u3002\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u767b\u9332\u306fserver.register\u3092\u5b9f\u884c\u3057\u3066\u884c\u3044\u307e\u3059\u3002Swagger\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u3068\u52a0\u3048\u30662\u3064\u306b\u306a\u3063\u305f\u306e\u3067plugins\u914d\u5217\u306b\u683c\u7d0d\u3057\u307e\u3059\u3002\n\n~/node_apps/docker-hapi/routes/app.js\n'use strict';\n\nvar Hapi = require('hapi'),\n    server = new Hapi.Server(),\n    mongoose = require('mongoose');\n\nmongoose.connect('mongodb://'+process.env.MONGO_PORT_27017_TCP_ADDR+':'\n              +process.env.MONGO_PORT_27017_TCP_PORT+'/jobdb');\nserver.connection({port: 3000});\n\nvar plugins = [\n    { register: require('hapi-swagger'),\n      options: {\n          apiVersion: \"0.0.1\"\n      }\n    },\n    { register: require('./routes/jobs')}\n];\n\nserver.register(plugins, function(err){\n    if (err) throw err;\n    server.start(function (){\n        console.log('Server running at:', server.info.uri);\n    });\n});\n\n\n\n\u30d7\u30ed\u30b0\u30e9\u30e0\u306e\u5b9f\u884c\nDocker Compose\u304b\u3089hapi\u30b5\u30fc\u30d3\u30b9\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\n$ docker-compose up hapi\nRecreating dockerhapi_mongo_1...\nRecreating dockerhapi_hapi_1...\nAttaching to dockerhapi_hapi_1\nhapi_1 |\nhapi_1 | > docker-hapi@0.0.1 start /app\nhapi_1 | > node app.js\nhapi_1 |\nhapi_1 | Server running at: http://803cef3ac3ca:3000\n\nRoute\u3092\u30d7\u30e9\u30b0\u30a4\u30f3\u5316\u3057\u3066\u3082SwaggerUI\u304b\u3089MongoDB\u3078\u306eCRUD\u51e6\u7406\u306f\u3067\u304d\u308b\u306e\u3067\u30ea\u30d5\u30a1\u30af\u30bf\u30ea\u30f3\u30b0\u306f\u6210\u529f\u3067\u3059\u3002\n\nMongoDB\u3078\u306eCRUD\u64cd\u4f5c\u3068Swagger UI\u304b\u3089API\u3092\u30c6\u30b9\u30c8\u3059\u308b[\u30d7\u30ed\u30b8\u30a7\u30af\u30c8](http://qiita.com/masato/items/b9960d7f1744fb8ccae7)\u3092[Hapi.js](http://hapijs.com/)\u3067\u4f5c\u6210\u3057\u307e\u3057\u305f\u3002app.js\u306eRoute\u306e\u51e6\u7406\u304c\u9577\u304f\u306a\u3063\u305f\u306e\u3067\u3001\u5225\u30d5\u30a1\u30a4\u30eb\u306b\u79fb\u52d5\u3057\u3088\u3046\u3068\u601d\u3044\u307e\u3059\u3002Hapi.js\u3067\u306f[Plugins](http://hapijs.com/tutorials/plugins)\u306e\u4ed5\u7d44\u307f\u3067\u6a5f\u80fd\u62e1\u5f35\u304c\u3067\u304d\u307e\u3059\u3002[Swagger](http://swagger.io/)\u306e\u30a4\u30f3\u30bf\u30d5\u30a7\u30fc\u30b9\u3092\u63d0\u4f9b\u3059\u308b[hapi-swagger](https://www.npmjs.com/package/hapi-swagger)\u306fnpm\u304b\u3089\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3057\u305f\u304c\u3001\u30d7\u30e9\u30b0\u30a4\u30f3\u306f\u30a2\u30d7\u30ea\u5185\u306b\u3082\u7c21\u5358\u306b\u4f5c\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u306e\u3067Route\u51e6\u7406\u3092\u30d7\u30e9\u30b0\u30a4\u30f3\u306b\u30ea\u30d5\u30a1\u30af\u30bf\u30ea\u30f3\u30b0\u3057\u307e\u3059\u3002\n\n\n\u516c\u958b\u3055\u308c\u3066\u3044\u308b\u30d7\u30e9\u30b0\u30a4\u30f3\u306f\u3053\u3061\u3089\u306e[\u30da\u30fc\u30b8](http://hapijs.com/plugins)\u306b\u7528\u9014\u5225\u306b\u307e\u3068\u307e\u3063\u3066\u3044\u307e\u3059\u3002\n\n## \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\n\nRoute\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u4f5c\u6210\u3057\u305f\u30ea\u30dd\u30b8\u30c8\u30ea\u306f[\u3053\u3061\u3089](https://github.com/masato/docker-swagger/tree/plugin)\u3067\u3059\u3002\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n```bash\n$ cd ~/node_apps/docker-hapi\n$ tree -L 2\n.\n\u251c\u2500\u2500 Dockerfile\n\u251c\u2500\u2500 app.js\n\u251c\u2500\u2500 docker-compose.yml\n\u251c\u2500\u2500 models\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 job.js\n\u251c\u2500\u2500 mongo\n\u251c\u2500\u2500 node_modules -> /dist/node_modules\n\u251c\u2500\u2500 npm-debug.log\n\u251c\u2500\u2500 package.json\n\u2514\u2500\u2500 routes\n    \u2514\u2500\u2500 jobs.js\n```\n\n\u4eca\u307e\u3067\u3068\u540c\u69d8\u306bDocker Compose\u3092\u4f7f\u3044MongoDB\u3068link\u3057\u3066\u3044\u307e\u3059\u3002\n\n```yaml:/node_apps/docker-hapi/docker-compose.yml\nhapi:\n  build: .\n  ports:\n    - 3000:3000\n  volumes:\n    - .:/app\n  links:\n    - mongo\nmongo:\n  image: mongo\n  volumes:\n    - ./mongo:/data/db\n```\n\n## routes/jobs.js\n\n`routes/jobs.js`\u304c\u4f5c\u6210\u3057\u305f\u30d7\u30e9\u30b0\u30a4\u30f3\u3067\u3059\u3002\u9577\u304f\u306a\u308b\u306e\u3067POST\u4ee5\u5916\u306f\u7701\u7565\u3057\u307e\u3059\u3002\u4eca\u307e\u3067app.js\u306b\u5b9a\u7fa9\u3057\u3066\u3044\u305fRoute\u306e\u51e6\u7406\u3092`exports.register`\u306e\u95a2\u6570\u5185\u306b\u79fb\u52d5\u3057\u307e\u3057\u305f\u3002\n\n```js:~/node_apps/docker-hapi/routes/jobs.js\n'use strict';\nvar Joi = require('joi');\nvar JobModel = require('../models/job');\n\nexports.register = function(server, options, next) {\n\n    server.route({\n        method: 'POST',\n        path: '/api/jobs',\n        config: {\n            tags: ['api'],\n            description: 'Save job data',\n            notes: 'Save job data',\n            validate: {\n                payload: {\n                    name: Joi.string().required(),\n                    query: Joi.string().required()\n                }\n            }\n        },\n        handler: function(request, reply) {\n            var job = new JobModel(request.payload);\n            job.save(function(error) {\n                if(error) {\n                    reply({\n                        statusCode: 503,\n                        message: error\n                    });\n                } else {\n                    reply({\n                        statusCode: 201,\n                        message: 'Job Saved Successfully'\n                    });\n                }\n            });\n        }\n    });\n...\n    // callback to complete\n    next();\n}\n\nexports.register.attributes = {\n    name: 'jobs-route'\n}\n```\n\n\u91cd\u8981\u306a\u306e\u306f\u95a2\u6570\u306e\u6700\u5f8c\u306b\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u306e`next()`\u3092\u5b9f\u884c\u3057\u3066\u3053\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u3067\u306e\u51e6\u7406\u306e\u7d42\u4e86\u3092\u4f1d\u3048\u308b\u3053\u3068\u3067\u3059\u3002\u307e\u305f`exports.register.attributes`\u306b\u3053\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u540d\u524d\u3092\u5b9a\u7fa9\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n## app.js\n\nRoute\u306e\u51e6\u7406\u3092\u5225\u30d5\u30a1\u30a4\u30eb\u306b\u30d7\u30e9\u30b0\u30a4\u30f3\u3068\u3057\u3066\u79fb\u52d5\u3057\u305f\u306e\u3067app.js\u306e\u69cb\u6210\u306f\u3059\u3063\u304d\u308a\u3068\u77ed\u304f\u306a\u308a\u307e\u3057\u305f\u3002\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u767b\u9332\u306f`server.register`\u3092\u5b9f\u884c\u3057\u3066\u884c\u3044\u307e\u3059\u3002Swagger\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u3068\u52a0\u3048\u30662\u3064\u306b\u306a\u3063\u305f\u306e\u3067`plugins`\u914d\u5217\u306b\u683c\u7d0d\u3057\u307e\u3059\u3002\n\n```js:~/node_apps/docker-hapi/routes/app.js\n'use strict';\n\nvar Hapi = require('hapi'),\n    server = new Hapi.Server(),\n    mongoose = require('mongoose');\n\nmongoose.connect('mongodb://'+process.env.MONGO_PORT_27017_TCP_ADDR+':'\n              +process.env.MONGO_PORT_27017_TCP_PORT+'/jobdb');\nserver.connection({port: 3000});\n\nvar plugins = [\n    { register: require('hapi-swagger'),\n      options: {\n          apiVersion: \"0.0.1\"\n      }\n    },\n    { register: require('./routes/jobs')}\n];\n\nserver.register(plugins, function(err){\n    if (err) throw err;\n    server.start(function (){\n        console.log('Server running at:', server.info.uri);\n    });\n});\n```\n\n## \u30d7\u30ed\u30b0\u30e9\u30e0\u306e\u5b9f\u884c\n\nDocker Compose\u304b\u3089hapi\u30b5\u30fc\u30d3\u30b9\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\n\n``` bash\n$ docker-compose up hapi\nRecreating dockerhapi_mongo_1...\nRecreating dockerhapi_hapi_1...\nAttaching to dockerhapi_hapi_1\nhapi_1 |\nhapi_1 | > docker-hapi@0.0.1 start /app\nhapi_1 | > node app.js\nhapi_1 |\nhapi_1 | Server running at: http://803cef3ac3ca:3000\n```\n\nRoute\u3092\u30d7\u30e9\u30b0\u30a4\u30f3\u5316\u3057\u3066\u3082SwaggerUI\u304b\u3089MongoDB\u3078\u306eCRUD\u51e6\u7406\u306f\u3067\u304d\u308b\u306e\u3067\u30ea\u30d5\u30a1\u30af\u30bf\u30ea\u30f3\u30b0\u306f\u6210\u529f\u3067\u3059\u3002\n\n![hapi-plugin.png](https://qiita-image-store.s3.amazonaws.com/0/43745/8752c4bb-24ec-02d2-d7be-dbe7eab2f161.png)\n"}