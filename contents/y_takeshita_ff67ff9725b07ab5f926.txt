{"context": "\n\n\u300a\u8ab2\u984c\u300b\n\n\u3084\u308a\u305f\u3044\u3053\u3068\n\nSFTP\u30e6\u30fc\u30b6\u6bce\u306b\u63a5\u7d9a\u3067\u304d\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u5236\u9650\n\u516c\u958b\u9375\u8a8d\u8a3c\nchroot\u3067\u5fc5\u8981\u4ee5\u4e0a\u306b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306f\u898b\u305b\u306a\u3044\n\u5171\u6709\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u306f755\u3001\u30d5\u30a1\u30a4\u30eb\u306e\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u306f644\n\nsftp\u30b0\u30eb\u30fc\u30d7\u306b\u6240\u5c5e\u3059\u308b\u30e6\u30fc\u30b6\n/var/www/vhosts/\u4ee5\u4e0b\u306f\u3059\u3079\u3066\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\nsftp-limit\u30b0\u30eb\u30fc\u30d7\u306b\u6240\u5c5e\u3059\u308b\u30e6\u30fc\u30b6\n\u6307\u5b9a\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4ee5\u4e0b\u306e\u307f\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\n\u203b\u305f\u3060\u3057/etc/ssh/sshd_config\u306f\u521d\u671f\u306e\u8a2d\u5b9a\u5f8c\u306f\u5909\u66f4\u3092\u3057\u306a\u3044\n\n\u4eca\u56de\u306e\u8a2d\u5b9a\n\n\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u69cb\u6210\u3068\u30a2\u30af\u30bb\u30b9\u6a29\n\n/var/www/vhosts/           : 755 root root      \u2190 sftp\u306f\u4ee5\u4e0b\u306b\u30a2\u30af\u30bb\u30b9\u53ef\n`-- example.com            : 755 sftp_user sftp\n    `-- html               : 755 sftp_user sftp\n        |-- index.html     : 644 sftp_user sftp\n        `-- limit          : 755 sftp_user sftp \u2190 sftp-limit\u306f\u4ee5\u4e0b\u306b\u30a2\u30af\u30bb\u30b9\u53ef\n            `-- index.html : 644 sftp_user sftp\n\n\n/var/www/vhosts/\u3092\u30eb\u30fc\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\n\n\n\u300a\u524d\u63d0\u6761\u4ef6\u300b\n\u4eca\u56de\u306fAWS\u3067Amazon Linux\u74b0\u5883\u3067\u69cb\u7bc9\n# cat /etc/system-release\nAmazon Linux AMI release 2016.03\n\n# ssh -V\nOpenSSH_6.6.1p1, OpenSSL 1.0.1k-fips 8 Jan 2015\n\n\n\u300a\u624b\u9806\u300b\n\n\u25bcOpenSSH\u306e\u521d\u671f\u8a2d\u5b9a\u306e\u78ba\u8a8d\n# vi /etc/ssh/sshd_config\n\n\n/etc/ssh/sshd_config\n\ufe19\n\n#Port 22\n\n\ufe19\n\n#PubkeyAuthentication yes\n\n\ufe19\n\nAuthorizedKeysFile .ssh/authorized_keys\n\n\ufe19\n\nPasswordAuthentication no\n\n\ufe19\n\n\n#Port 22\n\u30dd\u30fc\u30c8\u306f22\u756a\n#PubkeyAuthentication yes\n\u516c\u958b\u9375\u8a8d\u8a3c\u306e\u8a31\u53ef\nAuthorizedKeysFile .ssh/authorized_keys\n\u516c\u958b\u9375\u30d1\u30b9\uff08\u30db\u30fc\u30e0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4ee5\u4e0b\u306e\u30d1\u30b9\uff09\nPasswordAuthentication no\n\u30d1\u30b9\u30ef\u30fc\u30c9\u8a8d\u8a3c\u306f\u4e0d\u53ef\n\u203b\u3082\u3068\u3082\u3068#\u3067\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3057\u3066\u3044\u308b\u3082\u306e\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u5024\n\n\u25bcsftp\u30b0\u30eb\u30fc\u30d7\u306e\u8a2d\u5b9a\n\n\u30b0\u30eb\u30fc\u30d7\u306e\u4f5c\u6210\u3068OpenSSH\u306e\u8a2d\u5b9a\n\n\n1. \u30b0\u30eb\u30fc\u30d7\u306e\u8ffd\u52a0\n# groupadd sftp\n\n\n2. OpenSSH\u306e\u8a2d\u5b9a\n# vi /etc/ssh/sshd_config\n\n\n/etc/ssh/sshd_config\n\ufe19\n\nMatch group sftp\n       ChrootDirectory /var/www/vhosts\n       ForceCommand internal-sftp\n\n\nMatch group sftp\nsftp\u30b0\u30eb\u30fc\u30d7\u306b\u6240\u5c5e\u3059\u308b\u30e6\u30fc\u30b6\u306e\u307f\u6709\u52b9\u306e\u8a2d\u5b9a\nChrootDirectory /var/www/vhosts\n\u63a5\u7d9a\u3057\u305f\u3068\u304d\u306b\"/var/www/vhosts\"\u3092\u30eb\u30fc\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u3059\u308b\n\uff08/var/www/vhosts\u3088\u308a\u4e0a\u306f\u30a2\u30af\u30bb\u30b9\u3067\u304d\u306a\u3044\uff09\n\u203b\u6307\u5b9a\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306f\u6240\u6709\u8005root:root\u3001\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3755\u306b\u3059\u308b\nForceCommand internal-sftp\nsftp\u30b3\u30de\u30f3\u30c9\u306e\u307f\u306b\u5236\u9650\n\n3. OpenSSH\u306e\u8a2d\u5b9a\u66f4\u65b0\n# sshd -t\n# service sshd reload\nReloading sshd:                                            [  OK  ]\n\n# sshd -t`\n\u69cb\u6587\u30c1\u30a7\u30c3\u30af\u3002\u4f55\u3082\u8868\u793a\u3055\u308c\u306a\u3051\u308c\u3070OK\n\n\n\u30e6\u30fc\u30b6\u306e\u8ffd\u52a0\n\n\n1. \u30e6\u30fc\u30b6\u8ffd\u52a0\n# useradd -g sftp sftp_user\n\n\u4eca\u56de\u306f\u5171\u6709\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u3001\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u6240\u6709\u8005\u306fsftp_user\u3068\u3059\u308b\n-g \u30b0\u30eb\u30fc\u30d7\u540d\n\u30d7\u30e9\u30a4\u30de\u30ea\u30b0\u30eb\u30fc\u30d7\u3092\u6307\u5b9a\n\n2. \u516c\u958b\u9375\u306e\u767b\u9332\n\n(1) \u4f5c\u6210\u3057\u305f\u30e6\u30fc\u30b6\u306b\u5207\u308a\u66ff\u3048\n# su - sftp_user\n\n\n(2) .ssh\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u4f5c\u6210\n$ cd ~\n$ mkdir -m 700 .ssh\n\n\n(3) authorized_keys\u306b\u516c\u958b\u9375\u3092\u767b\u9332\n$ vi .ssh/authorized_keys\n\n\n.ssh/authorized_keys\n\u516c\u958b\u9375\u306e\u5185\u5bb9\n\n\n$ chmod 600 .ssh/authorized_keys\n\n\u203b\u30ad\u30fc\u30da\u30a2\u306fssh-keygen\u30b3\u30de\u30f3\u30c9\u306a\u3069\u3067\u4f5c\u6210\n\n(4) \u5143\u306e\u30e6\u30fc\u30b6\u306b\u623b\u308b\n$ exit\n\n\n\u203b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3001\u30d5\u30a1\u30a4\u30eb\u306e\u6240\u6709\u8005\u3001\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u306b\u3064\u3044\u3066\n\nChrootDirectory\n/var/www/vhosts             : 755 root root\n\n\n\n\u9375\u8a8d\u8a3c\n/home/\n`-- sftp_user               : 700 sftp_user sftp\n    `-- .ssh                : 700 sftp_user sftp\n        `-- authorized_keys : 600 sftp_user sftp\n\n\n\n\n\u63a5\u7d9a\u306e\u78ba\u8a8d\n\n\n\u30fb\u5225\u306e\u7aef\u672b\u304b\u3089sftp\u30b3\u30de\u30f3\u30c9\u3067\u63a5\u7d9a\n$ sftp -i \u79d8\u5bc6\u9375 \u30e6\u30fc\u30b6\u540d@\u30db\u30b9\u30c8\u540d\nsftp>\n\n\u203b\u79d8\u5bc6\u9375\u306e\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u306f600\n\n\u30fb\u30ea\u30e2\u30fc\u30c8\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3068\u30d5\u30a1\u30a4\u30eb\u3092\u78ba\u8a8d\nsftp> pwd\nRemote working directory: /\nsftp> ls\nexample.com\n\n/var/www/vhosts\u3068\u540c\u3058\u3082\u306e\u304c\u8868\u793a\u3055\u308c\u3066\u3044\u308b\nsftp> cd /example.com/html/\nsftp> ls\nindex.html   limit\n\n/example.com/html/\u306eindex.html\u306f\u898b\u3048\u3066\u3044\u308b\nsftp> cd /example.com/html/limit/\nsftp> ls\nindex.html\n\n/example.com/html/limit/\u306eindex.html\u306f\u898b\u3048\u3066\u3044\u308b\n\n\u30fbsftp\u30b3\u30de\u30f3\u30c9\u306e\u7d42\u4e86\nsftp> quit\n\n\n\n\u30fb\u5225\u306e\u7aef\u672b\u304b\u3089ssh\u30b3\u30de\u30f3\u30c9\u3067\u63a5\u7d9a\n# ssh -i \u79d8\u5bc6\u9375 \u30e6\u30fc\u30b6\u540d@\u30db\u30b9\u30c8\u540d\nCould not chdir to home directory /home/sftp_user: No such file or directory\nThis service allows sftp connections only.\nConnection to xxx.xxx.xxx.xxx closed.\n\n\u63a5\u7d9a\u3067\u304d\u306a\u3044\n\n\n\u25bcsftp-limit\u30b0\u30eb\u30fc\u30d7\u306e\u8a2d\u5b9a\n\n\u30b0\u30eb\u30fc\u30d7\u306e\u4f5c\u6210\u3068OpenSSH\u306e\u8a2d\u5b9a\n\n\n1. \u30b0\u30eb\u30fc\u30d7\u306e\u8ffd\u52a0\n# groupadd sftp-limit\n\n\n2. OpenSSH\u306e\u8a2d\u5b9a\n# vi /etc/ssh/sshd_config\n\n\n/etc/ssh/sshd_config\n\ufe19\n\nMatch group sftp-limit\n       ChrootDirectory %h/www/vhosts\n       ForceCommand internal-sftp\n\nMatch group sftp\n       ChrootDirectory /var/www/vhosts\n       ForceCommand internal-sftp\n\n\n\u203bsftp\u30b0\u30eb\u30fc\u30d7\u306e\u8a2d\u5b9a\u3088\u308a\u4e0a\u306b\u66f8\u304f\nMatch group sftp-limit\nsftp-limit\u30b0\u30eb\u30fc\u30d7\u306b\u6240\u5c5e\u3059\u308b\u30e6\u30fc\u30b6\u306e\u307f\u6709\u52b9\u306e\u8a2d\u5b9a\nChrootDirectory %h/www/vhosts\n\u63a5\u7d9a\u3057\u305f\u3068\u304d\u306b\"\u30db\u30fc\u30e0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea/www/vhosts\"\u3092\u30eb\u30fc\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u3059\u308b\n\u203b\u6307\u5b9a\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306f\u6240\u6709\u8005root:root\u3001\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3755\u306b\u3059\u308b\nForceCommand internal-sftp\nsftp\u30b3\u30de\u30f3\u30c9\u306e\u307f\u306b\u5236\u9650\n\n3. OpenSSH\u306e\u8a2d\u5b9a\u66f4\u65b0\n# sshd -t\n# service sshd reload\nReloading sshd:                                            [  OK  ]\n\n# sshd -t`\n\u69cb\u6587\u30c1\u30a7\u30c3\u30af\u3002\u4f55\u3082\u8868\u793a\u3055\u308c\u306a\u3051\u308c\u3070OK\n\n\n\u30e6\u30fc\u30b6\u306e\u8ffd\u52a0\n\n\n1. sftp_user\u30e6\u30fc\u30b6\u306e\u60c5\u5831\u3092\u78ba\u8a8d\n# id sftp_user\nuid=501(sftp_user) gid=501(sftp) groups=501(sftp)\n\n\n2. \u30e6\u30fc\u30b6\u8ffd\u52a0\n# useradd -o -u 501 -g sftp -G sftp-limit sftp_user_limit\n\nsftp_user\u3068\u540c\u3058uid\u3092\u3082\u3063\u305f\u30e6\u30fc\u30b6\u3068\u3057\u3066\u4f5c\u6210\u3059\u308b\u3053\u3068\u3067\u3001\u5171\u6709\u3055\u308c\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3001\u30d5\u30a1\u30a4\u30eb\u306b\u30b0\u30eb\u30fc\u30d7\u306e\u3067\u66f8\u304d\u8fbc\u307f\u6a29\u9650\u3092\u4e0e\u3048\u306a\u304f\u3066\u3082\u3044\u3044\u3088\u3046\u306b\u3059\u308b\n-o\n\u4ed6\u30e6\u30fc\u30b6\u3068\u540c\u4e00uid\u3092\u6301\u3063\u305f\u30e6\u30fc\u30b6\u306e\u4f5c\u6210\n-u 501\nuid\u306e\u6307\u5b9a\uff08sftp_user\u3068\u540c\u3058\u3082\u306e\uff09\n-g \u30b0\u30eb\u30fc\u30d7\u540d\n\u30d7\u30e9\u30a4\u30de\u30ea\u30b0\u30eb\u30fc\u30d7\u3092\u6307\u5b9a\n-G \u30b0\u30eb\u30fc\u30d7\u540d\n\u30bb\u30ab\u30f3\u30c0\u30ea\u30b0\u30eb\u30fc\u30d7\u3092\u6307\u5b9a\n\n3. \u516c\u958b\u9375\u306e\u767b\u9332\n\n(1) \u4f5c\u6210\u3057\u305f\u30e6\u30fc\u30b6\u306b\u5207\u308a\u66ff\u3048\n# su - sftp_user_limit\n\n\n(2) .ssh\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u4f5c\u6210\n$ cd ~\n$ mkdir -m 700 .ssh\n\n\n(3) authorized_keys\u306b\u516c\u958b\u9375\u3092\u767b\u9332\n$ vi .ssh/authorized_keys\n\n\n.ssh/authorized_keys\n\u516c\u958b\u9375\u306e\u5185\u5bb9\n\n\n$ chmod 600 .ssh/authorized_keys\n\n\u203b\u30ad\u30fc\u30da\u30a2\u306fssh-keygen\u30b3\u30de\u30f3\u30c9\u306a\u3069\u3067\u4f5c\u6210\n\n(4) \u5143\u306e\u30e6\u30fc\u30b6\u306b\u623b\u308b\n$ exit\n\n\n4. \u5171\u6709\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u8a2d\u5b9a\n\n(1) \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\n# cd /home/sftp_user_limit\n# mkdir -p www/vhosts/example.com/html/limit\n\n\n(2) \u5171\u6709\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u30de\u30a6\u30f3\u30c8\n\n\u4e00\u6642\u7684\u306a\u30de\u30a6\u30f3\u30c8\n\n# mount --bind /var/www/vhosts/example.com/html/limit/ /home/sftp_user_limit/www/vhosts/example.com/html/limit/\n\n\n\u6052\u4e45\u7684\u306a\u30de\u30a6\u30f3\u30c8\n\n# vi /etc/fstab\n\n\n/etc/fstab\n\ufe19\n/var/www/vhosts/example.com/html/limit/ /home/sftp_user_limit/www/vhosts/example.com/html/limit/ none bind 0 0\n\n\n\n(3) \u6240\u6709\u8005\u3068\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u306e\u8abf\u6574\n# chown root:root /home/sftp_user_limit\n# chmod 701 /home/sftp_user_limit\n\n\u203bChrootDirectory\u306f\u6307\u5b9a\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u307e\u3067\u306e\u6240\u6709\u8005\u304c\u5168\u90e8root\u306e\u5fc5\u8981\u304c\u3042\u308b\u306e\u3067\u306e\u3067\u3001\u30db\u30fc\u30e0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092root\u306b\u5909\u66f4\u3059\u308b\u3002\u30db\u30fc\u30e0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092root\u306b\u5909\u66f4\u3059\u308b\u3068\u6b21\u306f\u9375\u8a8d\u8a3c\u304c\u3067\u304d\u306a\u304f\u306a\u308b\u306e\u3067\u3001\u30d1\u30fc\u30df\u30b7\u30e7\u30f3\u3092701\u306b\u5909\u66f4\u3053\u3068\u3067\u9375\u8a8d\u8a3c\u3092\u53ef\u80fd\u306b\u3059\u308b\u3002\n\n\u203b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3001\u30d5\u30a1\u30a4\u30eb\u306e\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u306b\u3064\u3044\u3066\n\nChrootDirectory\n/home/\n`-- sftp_user_limit         : 701 root root\n    |-- .ssh                : 700 sftp_user sftp\n    |   `-- authorized_keys : 600 sftp_user sftp\n    `-- www                 : 705 root root\n        `-- vhosts          : 705 root root\n\n\n\n\n\u63a5\u7d9a\u306e\u78ba\u8a8d\n\n\n\u30fb\u5225\u306e\u7aef\u672b\u304b\u3089sftp\u30b3\u30de\u30f3\u30c9\u3067\u63a5\u7d9a\n$ sftp -i \u79d8\u5bc6\u9375 \u30e6\u30fc\u30b6\u540d@\u30db\u30b9\u30c8\u540d\nsftp>\n\n\u203b\u79d8\u5bc6\u9375\u306e\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u306f600\n\n\u30fb\u30ea\u30e2\u30fc\u30c8\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3068\u30d5\u30a1\u30a4\u30eb\u3092\u78ba\u8a8d\nsftp> pwd\nRemote working directory: /\nsftp> ls\nexample.com\n\n/var/www/vhosts\u3068\u540c\u3058\u3082\u306e\u304c\u8868\u793a\u3055\u308c\u3066\u3044\u308b\nsftp> cd /example.com/html/\nsftp> ls\nlimit\n\n/example.com/html/\u306eindex.html\u306f\u898b\u3048\u306a\u3044\nsftp> cd /example.com/html/limit/\nsftp> ls\nindex.html\n\n/example.com/html/limit/\u306eindex.html\u306f\u898b\u3048\u3066\u3044\u308b\n\n\u30fbsftp\u30b3\u30de\u30f3\u30c9\u306e\u7d42\u4e86\nsftp> quit\n\n\n\n\u30fb\u5225\u306e\u7aef\u672b\u304b\u3089ssh\u30b3\u30de\u30f3\u30c9\u3067\u63a5\u7d9a\n# ssh -i \u79d8\u5bc6\u9375 \u30e6\u30fc\u30b6\u540d@\u30db\u30b9\u30c8\u540d\nCould not chdir to home directory /home/sftp_user_limit: No such file or directory\nThis service allows sftp connections only.\nConnection to xxx.xxx.xxx.xxx closed.\n\n\u63a5\u7d9a\u3067\u304d\u306a\u3044\n\n#\u300a\u8ab2\u984c\u300b\n## \u3084\u308a\u305f\u3044\u3053\u3068\n* SFTP\u30e6\u30fc\u30b6\u6bce\u306b\u63a5\u7d9a\u3067\u304d\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u5236\u9650\n* \u516c\u958b\u9375\u8a8d\u8a3c\n* chroot\u3067\u5fc5\u8981\u4ee5\u4e0a\u306b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306f\u898b\u305b\u306a\u3044\n* \u5171\u6709\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u306f755\u3001\u30d5\u30a1\u30a4\u30eb\u306e\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u306f644\n\n**sftp\u30b0\u30eb\u30fc\u30d7\u306b\u6240\u5c5e\u3059\u308b\u30e6\u30fc\u30b6**\n/var/www/vhosts/\u4ee5\u4e0b\u306f\u3059\u3079\u3066\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\n\n**sftp-limit\u30b0\u30eb\u30fc\u30d7\u306b\u6240\u5c5e\u3059\u308b\u30e6\u30fc\u30b6**\n\u6307\u5b9a\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4ee5\u4e0b\u306e\u307f\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\n\u203b\u305f\u3060\u3057/etc/ssh/sshd_config\u306f\u521d\u671f\u306e\u8a2d\u5b9a\u5f8c\u306f\u5909\u66f4\u3092\u3057\u306a\u3044\n\n## \u4eca\u56de\u306e\u8a2d\u5b9a\n* \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u69cb\u6210\u3068\u30a2\u30af\u30bb\u30b9\u6a29\n\n```bash:\n/var/www/vhosts/           : 755 root root      \u2190 sftp\u306f\u4ee5\u4e0b\u306b\u30a2\u30af\u30bb\u30b9\u53ef\n`-- example.com            : 755 sftp_user sftp\n    `-- html               : 755 sftp_user sftp\n        |-- index.html     : 644 sftp_user sftp\n        `-- limit          : 755 sftp_user sftp \u2190 sftp-limit\u306f\u4ee5\u4e0b\u306b\u30a2\u30af\u30bb\u30b9\u53ef\n            `-- index.html : 644 sftp_user sftp\n```\n* /var/www/vhosts/\u3092\u30eb\u30fc\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\n\n#\u300a\u524d\u63d0\u6761\u4ef6\u300b\n\u4eca\u56de\u306fAWS\u3067Amazon Linux\u74b0\u5883\u3067\u69cb\u7bc9\n\n```\n# cat /etc/system-release\nAmazon Linux AMI release 2016.03\n\n# ssh -V\nOpenSSH_6.6.1p1, OpenSSL 1.0.1k-fips 8 Jan 2015\n```\n\n#\u300a\u624b\u9806\u300b\n##\u25bcOpenSSH\u306e\u521d\u671f\u8a2d\u5b9a\u306e\u78ba\u8a8d\n```\n# vi /etc/ssh/sshd_config\n```\n```bash:/etc/ssh/sshd_config\n\ufe19\n\n#Port 22\n\n\ufe19\n\n#PubkeyAuthentication yes\n\n\ufe19\n\nAuthorizedKeysFile .ssh/authorized_keys\n\n\ufe19\n\nPasswordAuthentication no\n\n\ufe19\n```\n\n```#Port 22```\n\u30dd\u30fc\u30c8\u306f22\u756a\n\n```#PubkeyAuthentication yes```\n\u516c\u958b\u9375\u8a8d\u8a3c\u306e\u8a31\u53ef\n\n```AuthorizedKeysFile .ssh/authorized_keys```\n\u516c\u958b\u9375\u30d1\u30b9\uff08\u30db\u30fc\u30e0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4ee5\u4e0b\u306e\u30d1\u30b9\uff09\n\n```PasswordAuthentication no```\n\u30d1\u30b9\u30ef\u30fc\u30c9\u8a8d\u8a3c\u306f\u4e0d\u53ef\n\n\u203b\u3082\u3068\u3082\u3068\\#\u3067\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3057\u3066\u3044\u308b\u3082\u306e\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u5024\n\n## \u25bcsftp\u30b0\u30eb\u30fc\u30d7\u306e\u8a2d\u5b9a\n### \u30b0\u30eb\u30fc\u30d7\u306e\u4f5c\u6210\u3068OpenSSH\u306e\u8a2d\u5b9a\n>#### 1. \u30b0\u30eb\u30fc\u30d7\u306e\u8ffd\u52a0\n```\n# groupadd sftp\n```\n#### 2. OpenSSH\u306e\u8a2d\u5b9a\n```\n# vi /etc/ssh/sshd_config\n```\n```bash:/etc/ssh/sshd_config\n\ufe19\n>\nMatch group sftp\n       ChrootDirectory /var/www/vhosts\n       ForceCommand internal-sftp\n```\n>\n```Match group sftp```\nsftp\u30b0\u30eb\u30fc\u30d7\u306b\u6240\u5c5e\u3059\u308b\u30e6\u30fc\u30b6\u306e\u307f\u6709\u52b9\u306e\u8a2d\u5b9a\n```ChrootDirectory /var/www/vhosts```\n\u63a5\u7d9a\u3057\u305f\u3068\u304d\u306b\"/var/www/vhosts\"\u3092\u30eb\u30fc\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u3059\u308b\n\uff08/var/www/vhosts\u3088\u308a\u4e0a\u306f\u30a2\u30af\u30bb\u30b9\u3067\u304d\u306a\u3044\uff09\n\u203b\u6307\u5b9a\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306f\u6240\u6709\u8005root:root\u3001\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3755\u306b\u3059\u308b\n```ForceCommand internal-sftp```\nsftp\u30b3\u30de\u30f3\u30c9\u306e\u307f\u306b\u5236\u9650\n>\n#### 3. OpenSSH\u306e\u8a2d\u5b9a\u66f4\u65b0\n```\n# sshd -t\n# service sshd reload\nReloading sshd:                                            [  OK  ]\n```\n```# sshd -t````\n\u69cb\u6587\u30c1\u30a7\u30c3\u30af\u3002\u4f55\u3082\u8868\u793a\u3055\u308c\u306a\u3051\u308c\u3070OK\n\n### \u30e6\u30fc\u30b6\u306e\u8ffd\u52a0\n> #### 1. \u30e6\u30fc\u30b6\u8ffd\u52a0\n```\n# useradd -g sftp sftp_user\n```\n\u4eca\u56de\u306f\u5171\u6709\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u3001\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u6240\u6709\u8005\u306fsftp_user\u3068\u3059\u308b\n>\n```-g \u30b0\u30eb\u30fc\u30d7\u540d```\n\u30d7\u30e9\u30a4\u30de\u30ea\u30b0\u30eb\u30fc\u30d7\u3092\u6307\u5b9a\n>\n#### 2. \u516c\u958b\u9375\u306e\u767b\u9332\n##### (1) \u4f5c\u6210\u3057\u305f\u30e6\u30fc\u30b6\u306b\u5207\u308a\u66ff\u3048\n```\n# su - sftp_user\n```\n##### (2) .ssh\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u4f5c\u6210\n```\n$ cd ~\n$ mkdir -m 700 .ssh\n```\n##### (3) authorized_keys\u306b\u516c\u958b\u9375\u3092\u767b\u9332\n```\n$ vi .ssh/authorized_keys\n```\n```bash:.ssh/authorized_keys\n\u516c\u958b\u9375\u306e\u5185\u5bb9\n```\n```\n$ chmod 600 .ssh/authorized_keys\n```\n>\n\u203b\u30ad\u30fc\u30da\u30a2\u306fssh-keygen\u30b3\u30de\u30f3\u30c9\u306a\u3069\u3067\u4f5c\u6210\n\n>\n##### (4) \u5143\u306e\u30e6\u30fc\u30b6\u306b\u623b\u308b\n```\n$ exit\n```\n\n>\n##### \u203b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3001\u30d5\u30a1\u30a4\u30eb\u306e\u6240\u6709\u8005\u3001\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u306b\u3064\u3044\u3066\n>```bash:ChrootDirectory\n/var/www/vhosts             : 755 root root\n```\n```bash:\u9375\u8a8d\u8a3c\n/home/\n`-- sftp_user               : 700 sftp_user sftp\n    `-- .ssh                : 700 sftp_user sftp\n        `-- authorized_keys : 600 sftp_user sftp\n```\n\n\n### \u63a5\u7d9a\u306e\u78ba\u8a8d\n>#### \u30fb\u5225\u306e\u7aef\u672b\u304b\u3089sftp\u30b3\u30de\u30f3\u30c9\u3067\u63a5\u7d9a\n>\n```\n$ sftp -i \u79d8\u5bc6\u9375 \u30e6\u30fc\u30b6\u540d@\u30db\u30b9\u30c8\u540d\nsftp>\n```\n>\u203b\u79d8\u5bc6\u9375\u306e\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u306f600\n#### \u30fb\u30ea\u30e2\u30fc\u30c8\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3068\u30d5\u30a1\u30a4\u30eb\u3092\u78ba\u8a8d\n>\n```\nsftp> pwd\nRemote working directory: /\nsftp> ls\nexample.com\n```\n/var/www/vhosts\u3068\u540c\u3058\u3082\u306e\u304c\u8868\u793a\u3055\u308c\u3066\u3044\u308b\n>\n```\nsftp> cd /example.com/html/\nsftp> ls\nindex.html   limit\n```\n/example.com/html/\u306eindex.html\u306f\u898b\u3048\u3066\u3044\u308b\n>\n```\nsftp> cd /example.com/html/limit/\nsftp> ls\nindex.html\n```\n/example.com/html/limit/\u306eindex.html\u306f\u898b\u3048\u3066\u3044\u308b\n>\n#### \u30fbsftp\u30b3\u30de\u30f3\u30c9\u306e\u7d42\u4e86\n```\nsftp> quit\n```\n---\n>#### \u30fb\u5225\u306e\u7aef\u672b\u304b\u3089ssh\u30b3\u30de\u30f3\u30c9\u3067\u63a5\u7d9a\n>\n```\n# ssh -i \u79d8\u5bc6\u9375 \u30e6\u30fc\u30b6\u540d@\u30db\u30b9\u30c8\u540d\nCould not chdir to home directory /home/sftp_user: No such file or directory\nThis service allows sftp connections only.\nConnection to xxx.xxx.xxx.xxx closed.\n```\n\u63a5\u7d9a\u3067\u304d\u306a\u3044\n\n## \u25bcsftp-limit\u30b0\u30eb\u30fc\u30d7\u306e\u8a2d\u5b9a\n### \u30b0\u30eb\u30fc\u30d7\u306e\u4f5c\u6210\u3068OpenSSH\u306e\u8a2d\u5b9a\n>#### 1. \u30b0\u30eb\u30fc\u30d7\u306e\u8ffd\u52a0\n```\n# groupadd sftp-limit\n```\n#### 2. OpenSSH\u306e\u8a2d\u5b9a\n```\n# vi /etc/ssh/sshd_config\n```\n```bash:/etc/ssh/sshd_config\n\ufe19\n>\nMatch group sftp-limit\n       ChrootDirectory %h/www/vhosts\n       ForceCommand internal-sftp\n>\nMatch group sftp\n       ChrootDirectory /var/www/vhosts\n       ForceCommand internal-sftp\n```\n\u203bsftp\u30b0\u30eb\u30fc\u30d7\u306e\u8a2d\u5b9a\u3088\u308a\u4e0a\u306b\u66f8\u304f\n\n>\n```Match group sftp-limit```\nsftp-limit\u30b0\u30eb\u30fc\u30d7\u306b\u6240\u5c5e\u3059\u308b\u30e6\u30fc\u30b6\u306e\u307f\u6709\u52b9\u306e\u8a2d\u5b9a\n```ChrootDirectory %h/www/vhosts```\n\u63a5\u7d9a\u3057\u305f\u3068\u304d\u306b\"\u30db\u30fc\u30e0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea/www/vhosts\"\u3092\u30eb\u30fc\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u3059\u308b\n\u203b\u6307\u5b9a\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306f\u6240\u6709\u8005root:root\u3001\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3755\u306b\u3059\u308b\n```ForceCommand internal-sftp```\nsftp\u30b3\u30de\u30f3\u30c9\u306e\u307f\u306b\u5236\u9650\n>\n#### 3. OpenSSH\u306e\u8a2d\u5b9a\u66f4\u65b0\n```\n# sshd -t\n# service sshd reload\nReloading sshd:                                            [  OK  ]\n```\n```# sshd -t````\n\u69cb\u6587\u30c1\u30a7\u30c3\u30af\u3002\u4f55\u3082\u8868\u793a\u3055\u308c\u306a\u3051\u308c\u3070OK\n\n### \u30e6\u30fc\u30b6\u306e\u8ffd\u52a0\n> #### 1. sftp_user\u30e6\u30fc\u30b6\u306e\u60c5\u5831\u3092\u78ba\u8a8d\n```\n# id sftp_user\nuid=501(sftp_user) gid=501(sftp) groups=501(sftp)\n```\n\n> #### 2. \u30e6\u30fc\u30b6\u8ffd\u52a0\n```\n# useradd -o -u 501 -g sftp -G sftp-limit sftp_user_limit\n```\n>sftp_user\u3068\u540c\u3058uid\u3092\u3082\u3063\u305f\u30e6\u30fc\u30b6\u3068\u3057\u3066\u4f5c\u6210\u3059\u308b\u3053\u3068\u3067\u3001\u5171\u6709\u3055\u308c\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3001\u30d5\u30a1\u30a4\u30eb\u306b\u30b0\u30eb\u30fc\u30d7\u306e\u3067\u66f8\u304d\u8fbc\u307f\u6a29\u9650\u3092\u4e0e\u3048\u306a\u304f\u3066\u3082\u3044\u3044\u3088\u3046\u306b\u3059\u308b\n``` -o ```\n\u4ed6\u30e6\u30fc\u30b6\u3068\u540c\u4e00uid\u3092\u6301\u3063\u305f\u30e6\u30fc\u30b6\u306e\u4f5c\u6210\n```-u 501```\nuid\u306e\u6307\u5b9a\uff08sftp_user\u3068\u540c\u3058\u3082\u306e\uff09\n```-g \u30b0\u30eb\u30fc\u30d7\u540d```\n\u30d7\u30e9\u30a4\u30de\u30ea\u30b0\u30eb\u30fc\u30d7\u3092\u6307\u5b9a\n```-G \u30b0\u30eb\u30fc\u30d7\u540d```\n\u30bb\u30ab\u30f3\u30c0\u30ea\u30b0\u30eb\u30fc\u30d7\u3092\u6307\u5b9a\n\n\n\n>\n#### 3. \u516c\u958b\u9375\u306e\u767b\u9332\n##### (1) \u4f5c\u6210\u3057\u305f\u30e6\u30fc\u30b6\u306b\u5207\u308a\u66ff\u3048\n```\n# su - sftp_user_limit\n```\n##### (2) .ssh\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u4f5c\u6210\n```\n$ cd ~\n$ mkdir -m 700 .ssh\n```\n##### (3) authorized_keys\u306b\u516c\u958b\u9375\u3092\u767b\u9332\n```\n$ vi .ssh/authorized_keys\n```\n```bash:.ssh/authorized_keys\n\u516c\u958b\u9375\u306e\u5185\u5bb9\n```\n```\n$ chmod 600 .ssh/authorized_keys\n```\n>\n\u203b\u30ad\u30fc\u30da\u30a2\u306fssh-keygen\u30b3\u30de\u30f3\u30c9\u306a\u3069\u3067\u4f5c\u6210\n\n>\n##### (4) \u5143\u306e\u30e6\u30fc\u30b6\u306b\u623b\u308b\n```\n$ exit\n```\n\n>\n#### 4. \u5171\u6709\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u8a2d\u5b9a\n##### (1) \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\n```\n# cd /home/sftp_user_limit\n# mkdir -p www/vhosts/example.com/html/limit\n```\n\n>\n##### (2) \u5171\u6709\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u30de\u30a6\u30f3\u30c8\n* \u4e00\u6642\u7684\u306a\u30de\u30a6\u30f3\u30c8\n>\n```\n# mount --bind /var/www/vhosts/example.com/html/limit/ /home/sftp_user_limit/www/vhosts/example.com/html/limit/\n```\n\n>* \u6052\u4e45\u7684\u306a\u30de\u30a6\u30f3\u30c8\n>\n```\n# vi /etc/fstab\n```\n```bash:/etc/fstab\n\ufe19\n/var/www/vhosts/example.com/html/limit/ /home/sftp_user_limit/www/vhosts/example.com/html/limit/ none bind 0 0\n```\n\n>\n##### (3) \u6240\u6709\u8005\u3068\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u306e\u8abf\u6574\n```\n# chown root:root /home/sftp_user_limit\n# chmod 701 /home/sftp_user_limit\n```\n\u203bChrootDirectory\u306f\u6307\u5b9a\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u307e\u3067\u306e\u6240\u6709\u8005\u304c\u5168\u90e8root\u306e\u5fc5\u8981\u304c\u3042\u308b\u306e\u3067\u306e\u3067\u3001\u30db\u30fc\u30e0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092root\u306b\u5909\u66f4\u3059\u308b\u3002\u30db\u30fc\u30e0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092root\u306b\u5909\u66f4\u3059\u308b\u3068\u6b21\u306f\u9375\u8a8d\u8a3c\u304c\u3067\u304d\u306a\u304f\u306a\u308b\u306e\u3067\u3001\u30d1\u30fc\u30df\u30b7\u30e7\u30f3\u3092701\u306b\u5909\u66f4\u3053\u3068\u3067\u9375\u8a8d\u8a3c\u3092\u53ef\u80fd\u306b\u3059\u308b\u3002\n\n>\n##### \u203b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3001\u30d5\u30a1\u30a4\u30eb\u306e\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u306b\u3064\u3044\u3066\n>```\u9375\u8a8d\u8a3c\u3001bash:ChrootDirectory\n/home/\n`-- sftp_user_limit         : 701 root root\n    |-- .ssh                : 700 sftp_user sftp\n    |   `-- authorized_keys : 600 sftp_user sftp\n    `-- www                 : 705 root root\n        `-- vhosts          : 705 root root\n```\n\n\n### \u63a5\u7d9a\u306e\u78ba\u8a8d\n>#### \u30fb\u5225\u306e\u7aef\u672b\u304b\u3089sftp\u30b3\u30de\u30f3\u30c9\u3067\u63a5\u7d9a\n>\n```\n$ sftp -i \u79d8\u5bc6\u9375 \u30e6\u30fc\u30b6\u540d@\u30db\u30b9\u30c8\u540d\nsftp>\n```\n>\u203b\u79d8\u5bc6\u9375\u306e\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u306f600\n#### \u30fb\u30ea\u30e2\u30fc\u30c8\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3068\u30d5\u30a1\u30a4\u30eb\u3092\u78ba\u8a8d\n>\n```\nsftp> pwd\nRemote working directory: /\nsftp> ls\nexample.com\n```\n/var/www/vhosts\u3068\u540c\u3058\u3082\u306e\u304c\u8868\u793a\u3055\u308c\u3066\u3044\u308b\n>\n```\nsftp> cd /example.com/html/\nsftp> ls\nlimit\n```\n/example.com/html/\u306eindex.html\u306f\u898b\u3048\u306a\u3044\n>\n```\nsftp> cd /example.com/html/limit/\nsftp> ls\nindex.html\n```\n/example.com/html/limit/\u306eindex.html\u306f\u898b\u3048\u3066\u3044\u308b\n>\n#### \u30fbsftp\u30b3\u30de\u30f3\u30c9\u306e\u7d42\u4e86\n```\nsftp> quit\n```\n---\n>#### \u30fb\u5225\u306e\u7aef\u672b\u304b\u3089ssh\u30b3\u30de\u30f3\u30c9\u3067\u63a5\u7d9a\n>\n```\n# ssh -i \u79d8\u5bc6\u9375 \u30e6\u30fc\u30b6\u540d@\u30db\u30b9\u30c8\u540d\nCould not chdir to home directory /home/sftp_user_limit: No such file or directory\nThis service allows sftp connections only.\nConnection to xxx.xxx.xxx.xxx closed.\n```\n\u63a5\u7d9a\u3067\u304d\u306a\u3044\n\n", "tags": ["OpenSSH"]}