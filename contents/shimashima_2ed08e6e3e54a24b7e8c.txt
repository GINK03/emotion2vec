{"context": "Ruby on Rails \u3092 Capistrano \u3067\u81ea\u52d5\u30c7\u30d7\u30ed\u30a4\u3067\u304d\u308b\u3088\u3046\u306b Ubuntu \u3092\u8a2d\u5b9a\u3059\u308b\u6a5f\u4f1a\u304c\u3042\u3063\u305f\u306e\u3067\u3001\u4f5c\u696d\u5185\u5bb9\u3092\u5fd8\u308c\u306a\u3044\u3088\u3046\u306b\u30e1\u30e2\u3002 Rails\u3001nginx\u3001MySQL\u3001Unicorn \u306e\u69cb\u6210\u3002\u30b4\u30fc\u30eb\u306f Ubunut 14.04 \u306bCapistrano \u3067 Rails \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u30c7\u30d7\u30ed\u30a4\u3067\u304d\u308b \u3053\u3068\u3002 \n\u8ffd\u8a18: \u4ee5\u4e0b\u306e\u5185\u5bb9\u3092\u5c11\u3057\u30ea\u30d5\u30a1\u30af\u30bf\u30ea\u30f3\u30b0\u3057\u3066\u3001 Ansible \u3068\u3044\u3046\u30c4\u30fc\u30eb\u3092\u5229\u7528\u3057\u3066\u81ea\u52d5\u5316\u3057\u307e\u3057\u305f\u3002( Capistrano \u3067\u3059\u3050\u306b\u30c7\u30d7\u30ed\u30a4\u3067\u304d\u308b Rails \u74b0\u5883\u3092 Ansible \u3067\u81ea\u52d5\u69cb\u7bc9\u3059\u308b ) \u307b\u307c\u4e0b\u306b\u66f8\u3044\u305f\u5185\u5bb9\u3068\u540c\u69d8\u306e\u3053\u3068\u3092\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u309210\u884c\u304f\u3089\u3044\u7de8\u96c6\u3059\u308c\u3070\u51fa\u6765\u307e\u3059\u3002Capistrano \u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u30b5\u30f3\u30d7\u30eb \u3082\u914d\u7f6e\u3057\u3066\u3042\u308b\u306e\u3067\u3001\u6642\u9593\u304c\u7121\u3044\u5834\u5408\u306f\u3053\u3061\u3089\u306e\u307b\u3046\u304c\u65e9\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u5185\u5bb9\n\u4ee5\u4e0b\u306e\u3053\u3068\u304c\u3067\u304d\u308b\u4eba\u306b\u306f\u3053\u306e\u8a18\u4e8b\u306f\u4e0d\u8981\u306a\u60c5\u5831\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\u305d\u306e\u5834\u5408\u306f\u6b21\u306e\u8a18\u4e8b\u306b\u9032\u3093\u3067\u3044\u305f\u3060\u304f\u3053\u3068\u3067\u30e9\u30a4\u30d5\u30cf\u30c3\u30af\u3057\u3066\u3044\u305f\u3060\u3051\u308c\u3070\u3068\u601d\u3044\u307e\u3059\u3002\n\n\n\u30d1\u30b9\u30ef\u30fc\u30c9\u306a\u3057 sudo \u306e\u8a2d\u5b9a (Capistrano\u3067\u5fc5\u8981\u306a\u306e\u3067)\n\nrbenv \u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb (Ruby\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u7ba1\u7406\u3067\u5fc5\u8981\u306a\u306e\u3067)\n\nMySQL \u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb (DB\u306fMySQL\u3067)\n\nNginx \u306e\u8a2d\u5b9a (Apache\u3088\u308a\u306f\u4eca\u306f\u3053\u3063\u3061\u304c\u4e3b\u6d41\uff1f)\ngithub \u306b\u30c7\u30d7\u30ed\u30a4\u9375\u3092\u767b\u9332\nunicorn \u3084 database.yml \u3084 Capistrano \u95a2\u9023\u306e\u30d5\u30a1\u30a4\u30eb\u306e\u8a2d\u5b9a\n\n\n1. \u30d1\u30b9\u30ef\u30fc\u30c9\u306a\u3057 sudo \u306e\u8a2d\u5b9a\n\u30d1\u30b9\u30ef\u30fc\u30c9\u306a\u3057 sudo \u304c\u3067\u304d\u306a\u3044\u3068 Capistrano \u30c7\u30d7\u30ed\u30a4\u304c\u3067\u304d\u306a\u3044(\u4eca\u306f\u305d\u3046\u3067\u3082\u306a\u3044\u304b\u3082\uff1f)\u3002\n\u3059\u3067\u306b\u30d1\u30b9\u30ef\u30fc\u30c9\u306a\u3057\u3067 sudo \u304c\u3067\u304d\u308b\u5834\u5408\u306f\u4e0d\u8981 \n\n\u3053\u306e\u6b21\u306e\u64cd\u4f5c\u3092\u9593\u9055\u3048\u308b\u3068\u4e8c\u5ea6\u3068 sudo \u304c\u3067\u304d\u306a\u304f\u306a\u308b\u306e\u3067\u3001\u5148\u306b root \u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u8a2d\u5b9a\n\nsudo su\npasswd\n# \u65b0\u898f\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u5165\u529b\n\n\nvisudo \u3067sudo\u6a29\u9650\u306e\u8a2d\u5b9a\u3092\u5909\u66f4\n\nsudo visudo # \u7de8\u96c6\u753b\u9762\u3078\n# \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u6700\u5f8c\u306b\u4ee5\u4e0b\u306e\u4e00\u884c\u3092\u8ffd\u52a0 username \u306f\u30e6\u30fc\u30b6\u540d\n# username ALL=(ALL:ALL) NOPASSWD:ALL\n\n\n2. rbenv \u3092\u5165\u308c\u308b\nRuby \u81ea\u4f53\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u7ba1\u7406\u306b\u5229\u7528\u3002\u3053\u308c\u3067\u958b\u767a\u74b0\u5883\u3068\u30c7\u30d7\u30ed\u30a4\u5f8c\u306e\u74b0\u5883\u3067 ruby \u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u9055\u3046\u304b\u3089\u52d5\u304b\u306a\u3044\u3001\u307f\u305f\u3044\u306a\u3053\u3068\u3092\u56de\u907f\u3067\u304d\u308b\u3002\n\n\u30ec\u30dd\u30b8\u30c8\u30ea\u60c5\u5831\u3092\u66f4\u65b0\n\nsudo apt-get update\n\n\n\u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nsudo apt-get install -y git git-core curl zlib1g-dev build-essential libssl-dev libreadline-dev libyaml-dev libsqlite3-dev sqlite3 libxml2-dev libxslt1-dev libcurl4-openssl-dev python-software-properties libffi-dev\n\n\nrbenv \u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\ncd # \u30db\u30fc\u30e0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3078\u79fb\u52d5\n\ngit clone git://github.com/sstephenson/rbenv.git .rbenv\necho 'export PATH=\"$HOME/.rbenv/bin:$PATH\"' >> ~/.bash_profile\necho 'eval \"$(rbenv init -)\"' >> ~/.bash_profile\nsource ~/.bash_profile\n\n\n\u6b63\u3057\u304f\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u305f\u3053\u3068\u3092\u78ba\u8a8d\n\nrbenv-install -l\n# rbenv \u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3067\u304d\u308b ruby \u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u30ea\u30b9\u30c8\u304c\u8868\u793a\u3055\u308c\u308b\n\n\n3. rbenv \u3092\u7528\u3044\u3066 ruby \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nrbenv-install 2.2.0\n# \u7d50\u69cb\u6642\u9593\u304c\u304b\u304b\u308b\n\n\n\u6b63\u3057\u304f\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3067\u304d\u305f\u306e\u3092\u78ba\u8a8d\n\nrbenv versions\n# 2.2.0 \u3068\u8868\u793a\u3055\u308c\u308b\u306f\u305a\u3002\n\n\n\u304a\u305d\u3089\u304f bundle \u304c\u5165\u3063\u3066\u306a\u3044\u306e\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nrbenv global 2.2.0 # \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u6307\u5b9a\nrbenv exec gem install bundle # 'rbenv exec' \u3044\u3089\u306a\u3044\u304b\u3082\u3002\n# \u3053\u308c\u3067 rbenv exec bundler \u304c\u4f7f\u3048\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u306f\u305a\n\n\n4. MySQL \u306e\u6e96\u5099\n\nMySQL \u95a2\u9023\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nsudo apt-get install -y mysql-server mysql-client libmysqld-dev \n# MySQL \u306e root \u30e6\u30fc\u30b6\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u805e\u304b\u308c\u308b\u306e\u3067\u9069\u5f53\u306b\u3002\n\n\nRails \u3067\u4f7f\u3046\u30e6\u30fc\u30b6\u3068 DB \u3092\u4f5c\u6210\n\nmysql -u root -p\n# root \u30e6\u30fc\u30b6\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u3067\u30ed\u30b0\u30a4\u30f3\n\n# \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u4f5c\u6210\nCREATE DATABASE rails_database;\n\n# \u30e6\u30fc\u30b6\u4f5c\u6210(rails_user \u306e\u90e8\u5206\u3068rails_password \u3092\u5909\u3048\u3066\u304f\u3060\u3055\u3044)\nCREATE USER 'rails_user'@'localhost' IDENTIFIED BY 'rails_password';\n\n# \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u6a29\u9650\u3092\u4f5c\u3063\u305f\u30e6\u30fc\u30b6\u306b\u4e0e\u3048\u308b\nGRANT ALL PRIVILEGES ON rails_database.* TO 'rails_user'@'localhost';\n\n# \u4ee5\u4e0a\u306e\u8a2d\u5b9a\u3092\u53cd\u6620\nFLUSH PRIVILEGES;\n\n\n5. database.yml \u306b\u4e0a\u8a18\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u8a2d\u5b9a\u3092\u53cd\u6620\n\u4e0a\u3067\u8a2d\u5b9a\u3057\u305f MySQL \u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3084\u30e6\u30fc\u30b6\u540d\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u8a2d\u5b9a\u3002\n\ndatabase.yml\ndefault: &default\n  adapter: sqlite3\n  pool: 5\n  timeout: 5000\n\ndevelopment:\n  <<: *default\n  database: db/development.sqlite3\n\ntest:\n  <<: *default\n  database: db/test.sqlite3\n\nproduction:\n  adapter: mysql2\n  encoding: utf8\n  reconnect: false\n  database: rails_database\n  pool: 5\n  username: rails_user\n  password: rails_password\n  host: localhost\n\n\n\n6. nginx \u306e\u6e96\u5099\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nsudo apt-get install nginx\n\ncp /etc/nginx/sites-available/default /etc/nginx/sites-available/your_site.conf\nvim /etc/nginx/sites-available/your_site.conf\n# \u4e0b\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u53c2\u8003\u306b\u5909\u66f4\nln -s /etc/nginx/sites-available/your_site.conf /etc/nginx/sites-enabled/your_site.conf\n\n\nNginx \u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\n\n3\u884c\u76ee\u306eunix:...\u306e\u90e8\u5206\u306e socket \u306e\u6307\u5b9a\u304c unicorn \u306e\u8a2d\u5b9a\u3068\u4e00\u81f4\u3059\u308b\u3088\u3046\u306b\u6ce8\u610f\u3059\u308b\u3002\n\nsite-enable/your_site.conf\nupstream app {\n    # Path to Unicorn SOCK file, as defined previously\n    server unix:/var/www/your_site.com/shared/tmp/sockets/unicorn.sock fail_timeout=0;\n}\n\nserver {\n    listen 80;\n    server_name your_site.com, www.your_site.com;\n\n    # Application root, as defined previously\n    root /var/www/your_site.com/current/public;\n\n    try_files $uri/index.html $uri @app;\n\n    location @app {\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header Host $http_host;\n        proxy_redirect off;\n        proxy_pass http://app;\n    }\n\n    error_page 500 502 503 504 /500.html;\n    client_max_body_size 4G;\n    keepalive_timeout 10;\n}\n\n\n\n7. github \u306b\u30c7\u30d7\u30ed\u30a4\u9375\u3092\u767b\u9332\n\n\u9375\u304c\u306a\u3051\u308c\u3070\u9375\u3092\u4f5c\u6210\u3059\u308b\n\nssh-keygen\n# \u30a8\u30f3\u30bf\u30fc\u3001\u30a8\u30f3\u30bf\u30fc\u3001\u30a8\u30f3\u30bf\u30fc\ncat ~/.ssh/id_rsa.pub\n# \u51fa\u3066\u304d\u305f\u6587\u5b57\u3092\u53f3\u30af\u30ea\u30c3\u30af\u3067\u30b3\u30d4\u30fc\n# github \u306e\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306e\u8a2d\u5b9a\u304b\u3089 deploy key \u3092\u9078\u3093\u3067\u767b\u9332\n\n\n8. Gemfile \u306b\u5fc5\u8981\u306a Gem \u3092\u8a18\u8ff0\n\nMySQL\u3001unicorn\u3001Capistrano \u306b\u5fc5\u8981\u306a Gem \u3092\u52a0\u3048\u308b\n\n\nGemfile\n# \u4e0b\u8a18\u306e\u3082\u306e\u3092\u8ffd\u52a0\n\n# Use Unicorn as the app server\ngem 'unicorn'\n\n# MySQL adopter\ngem 'mysql2', '~> 0.3.13'\n\ngroup :development, :test do\n  # for Capistrano\n  gem 'capistrano'\n  gem 'capistrano-bundler'\n  gem 'capistrano-rails'\n  gem 'capistrano-rbenv', '~> 2.0'\n  gem 'capistrano3-unicorn'\nend\n\n\n\n\n9. Unicorn \u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u8a18\u8ff0\n\n\nsocket \u306e\u90e8\u5206\u304c\u4e0a\u8a18\u306e nginx \u306e\u8a2d\u5b9a\u3068\u565b\u307f\u5408\u3063\u3066\u3044\u306a\u3044\u3068\uff12\u56de\u76ee\u4ee5\u964d\u306b Capistrano \u30c7\u30d7\u30ed\u30a4\u3057\u305f\u3068\u304d\u306b\u3001\u30d7\u30ed\u30bb\u30b9\u304c\u65b0\u3057\u3044\u3082\u306e\u306b\u66f4\u65b0\u3055\u308c\u306a\u3044\u306e\u3067\u6ce8\u610f\n\npid \u3082\u5f8c\u8ff0\u3059\u308b Capistrano \u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e unicorn_pid \u30d1\u30e9\u30e1\u30fc\u30bf\u3068\u4e00\u81f4\u3055\u305b\u308b\u3053\u3068\u3092\u5fd8\u308c\u305a\u306b\u3002\n\n\nunicorn.rb\n# path\napp_path = '/var/www/your_site.com'\ncurrent_path = \"#{app_path}/current\"\nshared_path = \"#{app_path}/shared\"\n\nworking_directory current_path\npid File.expand_path('tmp/pids/unicorn.pid', shared_path)\nlisten File.expand_path('tmp/sockets/unicorn.sock', shared_path), :backlog => 64\n\n# logging\nstderr_path \"#{app_path}/shared/log/unicorn.stderr.log\"\nstdout_path \"#{app_path}/shared/log/unicorn.stdout.log\"\n\n# preload\npreload_app true\n\n# Number of processes\nworker_processes 4\n\n# Time-out\ntimeout 30\n\n# use correct Gemfile on restarts\nbefore_exec do |server|\n  ENV['BUNDLE_GEMFILE'] = \"#{app_path}/current/Gemfile\"\nend\n\nbefore_fork do |server, worker|\n  # the following is highly recomended for Rails + \"preload_app true\"\n  # as there's no need for the master process to hold a connection\n  if defined?(ActiveRecord::Base)\n    ActiveRecord::Base.connection.disconnect!\n  end\n\n  # Before forking, kill the master process that belongs to the .oldbin PID.\n  # This enables 0 downtime deploys.\n  old_pid = \"#{server.config[:pid]}.oldbin\"\n  if File.exists?(old_pid) && server.pid != old_pid\n    begin\n      Process.kill(\"QUIT\", File.read(old_pid).to_i)\n    rescue Errno::ENOENT, Errno::ESRCH\n      # someone else did our job for us\n    end\n  end\nend\n\nafter_fork do |server, worker|\n  if defined?(ActiveRecord::Base)\n    ActiveRecord::Base.establish_connection\n  end\nend\n\n\n\n10. Capistrano \u306e\u8a2d\u5b9a\ndeploy.rb \u306b\u3059\u3079\u3066\u306e\u30b5\u30fc\u30d0\u306b\u5171\u901a\u3059\u308b\u8a2d\u5b9a\u3092\u8a18\u8ff0\u3002config/deploy/production.rb \u306a\u3069\u306b\u74b0\u5883\u3054\u3068\u306e\u8a73\u7d30\u8a2d\u5b9a\u3092\u8a18\u8ff0\u3059\u308b\u3088\u3046\u306b\u3059\u308b\u3002\n\nCapfile\n# Load DSL and set up stages\nrequire 'capistrano/setup'\n\n# Include default deployment tasks\nrequire 'capistrano/deploy'\n\nrequire 'capistrano/rbenv'\nrequire 'capistrano/bundler'\nrequire 'capistrano/rails'\nrequire 'capistrano/rails/assets'\nrequire 'capistrano/rails/migrations'\nrequire 'capistrano3/unicorn'\n\n# Load custom tasks from `lib/capistrano/tasks` if you have any defined\nDir.glob('lib/capistrano/tasks/*.rake').each { |r| import r }\n\n\n\ndeploy.rb\n# config valid only for current version of Capistrano\nlock '3.4.0'\n\n# Multistage deployment extension\nset :application, 'your_site.com'\nset :repo_url, 'git@github.com:your_account/your_site.git'\nset :rbenv_ruby, '2.2.0'\nset :rbenv_type, :user\nset :deploy_to, \"/var/www/#{fetch(:application)}\"\n\nshared_path = \"#{fetch(:deploy_to)}/shared\"\nrelease_path = \"#{fetch(:deploy_to)}/current\"\n\nset :linked_dirs, fetch(:linked_dirs, []).push('log', 'tmp/pids', 'tmp/cache', 'tmp/sockets', 'vendor/bundle', 'public/system')\nset :keep_releases, 10\n\n# Unicorn\n# unicorn.rb \u3067\u6307\u5b9a\u3057\u305f pid \u3068\u4e00\u81f4\u3059\u308b\u3088\u3046\u306b\u3002\nset :unicorn_pid, \"#{shared_path}/tmp/pids/unicorn.pid\"\nset :unicorn_config_path, \"#{release_path}/config/unicorn.rb\"\n\nset :ssh_options, {\n  keys: %w(~/.ssh/id_rsa),\n  forward_agent: false,\n  auth_methods: %w(publickey)\n}\n\nafter 'deploy:publishing', 'deploy:restart'\nnamespace :deploy do\n  task :restart do\n    invoke 'unicorn:restart'\n  end\nend\n\n\n\ndeploy/production.rb\nserver 'yor_site.com', user: 'username', roles: %w{app db web}\nset :unicorn_pid, \"/var/www/#{fetch(:application)}/shared/tmp/pids/unicorn.pid\"\nset :stage, :production # \u3053\u308c\u3044\u3089\u306a\u3044\u304b\u3082\u3002\nset :unicorn_rack_env, 'production'\nset :unicorn_config_path, \"/var/www/#{fetch(:application)}/current/config/unicorn/production.rb\"\nset :rails_env, 'production'\nset :branch, 'master'\n\n\n\n\u6700\u5f8c: Capistrano \u3067\u30c7\u30d7\u30ed\u30a4\uff01\n\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306e app \u306a\u3069\u304c\u3042\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3067 Rails \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u30c7\u30d7\u30ed\u30a4\u3067\u304d\u308b....\u304b\u3082\u3057\u308c\u306a\u3044\u3002\nbundle exec cap production deploy\n\n\n\u53c2\u8003\u30b5\u30a4\u30c8\n\nHow To Deploy a Rails App with Unicorn and Nginx on Ubuntu 14.04\nHow To Install Wordpress with nginx on Ubuntu 12.04\nHow To Install Ruby on Rails with rbenv on Ubuntu 14.04\ncapistrano\u3067unicorn\u306eold\u30d7\u30ed\u30bb\u30b9\u304c\u6bba\u305b\u306a\u3044\n\nRuby on Rails \u3092 Capistrano \u3067\u81ea\u52d5\u30c7\u30d7\u30ed\u30a4\u3067\u304d\u308b\u3088\u3046\u306b Ubuntu \u3092\u8a2d\u5b9a\u3059\u308b\u6a5f\u4f1a\u304c\u3042\u3063\u305f\u306e\u3067\u3001\u4f5c\u696d\u5185\u5bb9\u3092\u5fd8\u308c\u306a\u3044\u3088\u3046\u306b\u30e1\u30e2\u3002 `Rails`\u3001`nginx`\u3001`MySQL`\u3001`Unicorn` \u306e\u69cb\u6210\u3002**\u30b4\u30fc\u30eb\u306f Ubunut 14.04 \u306bCapistrano \u3067 Rails \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u30c7\u30d7\u30ed\u30a4\u3067\u304d\u308b** \u3053\u3068\u3002 \n\n\n**\u8ffd\u8a18**: \u4ee5\u4e0b\u306e\u5185\u5bb9\u3092\u5c11\u3057\u30ea\u30d5\u30a1\u30af\u30bf\u30ea\u30f3\u30b0\u3057\u3066\u3001 [Ansible \u3068\u3044\u3046\u30c4\u30fc\u30eb\u3092\u5229\u7528\u3057\u3066\u81ea\u52d5\u5316](https://github.com/travelist/ansible-rails)\u3057\u307e\u3057\u305f\u3002( [Capistrano \u3067\u3059\u3050\u306b\u30c7\u30d7\u30ed\u30a4\u3067\u304d\u308b Rails \u74b0\u5883\u3092 Ansible \u3067\u81ea\u52d5\u69cb\u7bc9\u3059\u308b] (http://qiita.com/shimashima/items/b7c18c4489db3fcb3cbc) ) \u307b\u307c\u4e0b\u306b\u66f8\u3044\u305f\u5185\u5bb9\u3068\u540c\u69d8\u306e\u3053\u3068\u3092\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u309210\u884c\u304f\u3089\u3044\u7de8\u96c6\u3059\u308c\u3070\u51fa\u6765\u307e\u3059\u3002[Capistrano \u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u30b5\u30f3\u30d7\u30eb](https://github.com/travelist/ansible-rails/tree/master/rails_config) \u3082\u914d\u7f6e\u3057\u3066\u3042\u308b\u306e\u3067\u3001\u6642\u9593\u304c\u7121\u3044\u5834\u5408\u306f\u3053\u3061\u3089\u306e\u307b\u3046\u304c\u65e9\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n\n\n## \u5185\u5bb9\n\u4ee5\u4e0b\u306e\u3053\u3068\u304c\u3067\u304d\u308b\u4eba\u306b\u306f\u3053\u306e\u8a18\u4e8b\u306f\u4e0d\u8981\u306a\u60c5\u5831\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\u305d\u306e\u5834\u5408\u306f\u6b21\u306e\u8a18\u4e8b\u306b\u9032\u3093\u3067\u3044\u305f\u3060\u304f\u3053\u3068\u3067\u30e9\u30a4\u30d5\u30cf\u30c3\u30af\u3057\u3066\u3044\u305f\u3060\u3051\u308c\u3070\u3068\u601d\u3044\u307e\u3059\u3002\n\n- **\u30d1\u30b9\u30ef\u30fc\u30c9\u306a\u3057 sudo \u306e\u8a2d\u5b9a** (Capistrano\u3067\u5fc5\u8981\u306a\u306e\u3067)\n- **rbenv \u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb** (Ruby\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u7ba1\u7406\u3067\u5fc5\u8981\u306a\u306e\u3067)\n- **MySQL \u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb** (DB\u306fMySQL\u3067)\n- **Nginx \u306e\u8a2d\u5b9a** (Apache\u3088\u308a\u306f\u4eca\u306f\u3053\u3063\u3061\u304c\u4e3b\u6d41\uff1f)\n- **github \u306b\u30c7\u30d7\u30ed\u30a4\u9375\u3092\u767b\u9332**\n- **unicorn \u3084 database.yml \u3084 Capistrano \u95a2\u9023\u306e\u30d5\u30a1\u30a4\u30eb\u306e\u8a2d\u5b9a**\n\n\n## 1. \u30d1\u30b9\u30ef\u30fc\u30c9\u306a\u3057 sudo \u306e\u8a2d\u5b9a\n\u30d1\u30b9\u30ef\u30fc\u30c9\u306a\u3057 `sudo` \u304c\u3067\u304d\u306a\u3044\u3068 Capistrano \u30c7\u30d7\u30ed\u30a4\u304c\u3067\u304d\u306a\u3044(\u4eca\u306f\u305d\u3046\u3067\u3082\u306a\u3044\u304b\u3082\uff1f)\u3002\n**\u3059\u3067\u306b\u30d1\u30b9\u30ef\u30fc\u30c9\u306a\u3057\u3067 sudo \u304c\u3067\u304d\u308b\u5834\u5408\u306f\u4e0d\u8981** \n\n- \u3053\u306e\u6b21\u306e\u64cd\u4f5c\u3092\u9593\u9055\u3048\u308b\u3068\u4e8c\u5ea6\u3068 sudo \u304c\u3067\u304d\u306a\u304f\u306a\u308b\u306e\u3067\u3001\u5148\u306b root \u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u8a2d\u5b9a\n\n```\nsudo su\npasswd\n# \u65b0\u898f\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u5165\u529b\n```\n\n- visudo \u3067sudo\u6a29\u9650\u306e\u8a2d\u5b9a\u3092\u5909\u66f4\n\n```\nsudo visudo # \u7de8\u96c6\u753b\u9762\u3078\n# \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u6700\u5f8c\u306b\u4ee5\u4e0b\u306e\u4e00\u884c\u3092\u8ffd\u52a0 username \u306f\u30e6\u30fc\u30b6\u540d\n# username ALL=(ALL:ALL) NOPASSWD:ALL\n```\n\n## 2. rbenv \u3092\u5165\u308c\u308b\n\nRuby \u81ea\u4f53\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u7ba1\u7406\u306b\u5229\u7528\u3002\u3053\u308c\u3067\u958b\u767a\u74b0\u5883\u3068\u30c7\u30d7\u30ed\u30a4\u5f8c\u306e\u74b0\u5883\u3067 ruby \u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u9055\u3046\u304b\u3089\u52d5\u304b\u306a\u3044\u3001\u307f\u305f\u3044\u306a\u3053\u3068\u3092\u56de\u907f\u3067\u304d\u308b\u3002\n\n- \u30ec\u30dd\u30b8\u30c8\u30ea\u60c5\u5831\u3092\u66f4\u65b0\n\n```\nsudo apt-get update\n```\n\n\n- \u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```\nsudo apt-get install -y git git-core curl zlib1g-dev build-essential libssl-dev libreadline-dev libyaml-dev libsqlite3-dev sqlite3 libxml2-dev libxslt1-dev libcurl4-openssl-dev python-software-properties libffi-dev\n```\n\n- rbenv \u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```\ncd # \u30db\u30fc\u30e0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3078\u79fb\u52d5\n\ngit clone git://github.com/sstephenson/rbenv.git .rbenv\necho 'export PATH=\"$HOME/.rbenv/bin:$PATH\"' >> ~/.bash_profile\necho 'eval \"$(rbenv init -)\"' >> ~/.bash_profile\nsource ~/.bash_profile\n```\n\n- \u6b63\u3057\u304f\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u305f\u3053\u3068\u3092\u78ba\u8a8d\n\n```\nrbenv-install -l\n# rbenv \u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3067\u304d\u308b ruby \u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u30ea\u30b9\u30c8\u304c\u8868\u793a\u3055\u308c\u308b\n``` \n\n## 3. rbenv \u3092\u7528\u3044\u3066 ruby \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```\nrbenv-install 2.2.0\n# \u7d50\u69cb\u6642\u9593\u304c\u304b\u304b\u308b\n```\n\n- \u6b63\u3057\u304f\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3067\u304d\u305f\u306e\u3092\u78ba\u8a8d\n\n```\nrbenv versions\n# 2.2.0 \u3068\u8868\u793a\u3055\u308c\u308b\u306f\u305a\u3002\n```\n- \u304a\u305d\u3089\u304f bundle \u304c\u5165\u3063\u3066\u306a\u3044\u306e\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```\nrbenv global 2.2.0 # \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u6307\u5b9a\nrbenv exec gem install bundle # 'rbenv exec' \u3044\u3089\u306a\u3044\u304b\u3082\u3002\n# \u3053\u308c\u3067 rbenv exec bundler \u304c\u4f7f\u3048\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u306f\u305a\n```\n\n\n## 4. MySQL \u306e\u6e96\u5099\n\n- MySQL \u95a2\u9023\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```\nsudo apt-get install -y mysql-server mysql-client libmysqld-dev \n# MySQL \u306e root \u30e6\u30fc\u30b6\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u805e\u304b\u308c\u308b\u306e\u3067\u9069\u5f53\u306b\u3002\n```\n\n- Rails \u3067\u4f7f\u3046\u30e6\u30fc\u30b6\u3068 DB \u3092\u4f5c\u6210\n\n```\nmysql -u root -p\n# root \u30e6\u30fc\u30b6\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u3067\u30ed\u30b0\u30a4\u30f3\n\n# \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u4f5c\u6210\nCREATE DATABASE rails_database;\n\n# \u30e6\u30fc\u30b6\u4f5c\u6210(rails_user \u306e\u90e8\u5206\u3068rails_password \u3092\u5909\u3048\u3066\u304f\u3060\u3055\u3044)\nCREATE USER 'rails_user'@'localhost' IDENTIFIED BY 'rails_password';\n\n# \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u6a29\u9650\u3092\u4f5c\u3063\u305f\u30e6\u30fc\u30b6\u306b\u4e0e\u3048\u308b\nGRANT ALL PRIVILEGES ON rails_database.* TO 'rails_user'@'localhost';\n\n# \u4ee5\u4e0a\u306e\u8a2d\u5b9a\u3092\u53cd\u6620\nFLUSH PRIVILEGES;\n```\n\n## 5. database.yml \u306b\u4e0a\u8a18\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u8a2d\u5b9a\u3092\u53cd\u6620\n\n\u4e0a\u3067\u8a2d\u5b9a\u3057\u305f MySQL \u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3084\u30e6\u30fc\u30b6\u540d\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u8a2d\u5b9a\u3002\n\n```database.yml\ndefault: &default\n  adapter: sqlite3\n  pool: 5\n  timeout: 5000\n\ndevelopment:\n  <<: *default\n  database: db/development.sqlite3\n\ntest:\n  <<: *default\n  database: db/test.sqlite3\n\nproduction:\n  adapter: mysql2\n  encoding: utf8\n  reconnect: false\n  database: rails_database\n  pool: 5\n  username: rails_user\n  password: rails_password\n  host: localhost\n```\n\n## 6. nginx \u306e\u6e96\u5099\n\n- \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```\nsudo apt-get install nginx\n```\n\n```\ncp /etc/nginx/sites-available/default /etc/nginx/sites-available/your_site.conf\nvim /etc/nginx/sites-available/your_site.conf\n# \u4e0b\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u53c2\u8003\u306b\u5909\u66f4\nln -s /etc/nginx/sites-available/your_site.conf /etc/nginx/sites-enabled/your_site.conf\n```\n- Nginx \u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\n\n3\u884c\u76ee\u306e`unix:...`\u306e\u90e8\u5206\u306e **socket \u306e\u6307\u5b9a\u304c unicorn \u306e\u8a2d\u5b9a\u3068\u4e00\u81f4\u3059\u308b\u3088\u3046\u306b\u6ce8\u610f**\u3059\u308b\u3002\n\n```nginx:site-enable/your_site.conf\nupstream app {\n    # Path to Unicorn SOCK file, as defined previously\n    server unix:/var/www/your_site.com/shared/tmp/sockets/unicorn.sock fail_timeout=0;\n}\n\nserver {\n    listen 80;\n    server_name your_site.com, www.your_site.com;\n\n    # Application root, as defined previously\n    root /var/www/your_site.com/current/public;\n\n    try_files $uri/index.html $uri @app;\n\n    location @app {\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header Host $http_host;\n        proxy_redirect off;\n        proxy_pass http://app;\n    }\n\n    error_page 500 502 503 504 /500.html;\n    client_max_body_size 4G;\n    keepalive_timeout 10;\n}\n```\n\n## 7. github \u306b\u30c7\u30d7\u30ed\u30a4\u9375\u3092\u767b\u9332\n- \u9375\u304c\u306a\u3051\u308c\u3070\u9375\u3092\u4f5c\u6210\u3059\u308b\n\n```\nssh-keygen\n# \u30a8\u30f3\u30bf\u30fc\u3001\u30a8\u30f3\u30bf\u30fc\u3001\u30a8\u30f3\u30bf\u30fc\ncat ~/.ssh/id_rsa.pub\n# \u51fa\u3066\u304d\u305f\u6587\u5b57\u3092\u53f3\u30af\u30ea\u30c3\u30af\u3067\u30b3\u30d4\u30fc\n# github \u306e\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306e\u8a2d\u5b9a\u304b\u3089 deploy key \u3092\u9078\u3093\u3067\u767b\u9332\n```\n\n## 8. Gemfile \u306b\u5fc5\u8981\u306a Gem \u3092\u8a18\u8ff0\n\n- MySQL\u3001unicorn\u3001Capistrano \u306b\u5fc5\u8981\u306a Gem \u3092\u52a0\u3048\u308b\n\n```rb:Gemfile\n# \u4e0b\u8a18\u306e\u3082\u306e\u3092\u8ffd\u52a0\n\n# Use Unicorn as the app server\ngem 'unicorn'\n\n# MySQL adopter\ngem 'mysql2', '~> 0.3.13'\n\ngroup :development, :test do\n  # for Capistrano\n  gem 'capistrano'\n  gem 'capistrano-bundler'\n  gem 'capistrano-rails'\n  gem 'capistrano-rbenv', '~> 2.0'\n  gem 'capistrano3-unicorn'\nend\n\n```\n\n## 9. Unicorn \u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u8a18\u8ff0\n\n- **socket \u306e\u90e8\u5206\u304c\u4e0a\u8a18\u306e nginx \u306e\u8a2d\u5b9a\u3068\u565b\u307f\u5408\u3063\u3066\u3044\u306a\u3044\u3068\uff12\u56de\u76ee\u4ee5\u964d\u306b Capistrano \u30c7\u30d7\u30ed\u30a4\u3057\u305f\u3068\u304d\u306b\u3001\u30d7\u30ed\u30bb\u30b9\u304c\u65b0\u3057\u3044\u3082\u306e\u306b\u66f4\u65b0\u3055\u308c\u306a\u3044**\u306e\u3067\u6ce8\u610f\n- **pid \u3082\u5f8c\u8ff0\u3059\u308b Capistrano \u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e unicorn_pid \u30d1\u30e9\u30e1\u30fc\u30bf\u3068\u4e00\u81f4**\u3055\u305b\u308b\u3053\u3068\u3092\u5fd8\u308c\u305a\u306b\u3002\n\n```unicorn.rb\n# path\napp_path = '/var/www/your_site.com'\ncurrent_path = \"#{app_path}/current\"\nshared_path = \"#{app_path}/shared\"\n\nworking_directory current_path\npid File.expand_path('tmp/pids/unicorn.pid', shared_path)\nlisten File.expand_path('tmp/sockets/unicorn.sock', shared_path), :backlog => 64\n\n# logging\nstderr_path \"#{app_path}/shared/log/unicorn.stderr.log\"\nstdout_path \"#{app_path}/shared/log/unicorn.stdout.log\"\n\n# preload\npreload_app true\n\n# Number of processes\nworker_processes 4\n\n# Time-out\ntimeout 30\n\n# use correct Gemfile on restarts\nbefore_exec do |server|\n  ENV['BUNDLE_GEMFILE'] = \"#{app_path}/current/Gemfile\"\nend\n\nbefore_fork do |server, worker|\n  # the following is highly recomended for Rails + \"preload_app true\"\n  # as there's no need for the master process to hold a connection\n  if defined?(ActiveRecord::Base)\n    ActiveRecord::Base.connection.disconnect!\n  end\n\n  # Before forking, kill the master process that belongs to the .oldbin PID.\n  # This enables 0 downtime deploys.\n  old_pid = \"#{server.config[:pid]}.oldbin\"\n  if File.exists?(old_pid) && server.pid != old_pid\n    begin\n      Process.kill(\"QUIT\", File.read(old_pid).to_i)\n    rescue Errno::ENOENT, Errno::ESRCH\n      # someone else did our job for us\n    end\n  end\nend\n\nafter_fork do |server, worker|\n  if defined?(ActiveRecord::Base)\n    ActiveRecord::Base.establish_connection\n  end\nend\n```\n\n\n## 10. Capistrano \u306e\u8a2d\u5b9a\n\n`deploy.rb` \u306b\u3059\u3079\u3066\u306e\u30b5\u30fc\u30d0\u306b\u5171\u901a\u3059\u308b\u8a2d\u5b9a\u3092\u8a18\u8ff0\u3002`config/deploy/production.rb` \u306a\u3069\u306b\u74b0\u5883\u3054\u3068\u306e\u8a73\u7d30\u8a2d\u5b9a\u3092\u8a18\u8ff0\u3059\u308b\u3088\u3046\u306b\u3059\u308b\u3002\n\n```rb:Capfile\n# Load DSL and set up stages\nrequire 'capistrano/setup'\n\n# Include default deployment tasks\nrequire 'capistrano/deploy'\n\nrequire 'capistrano/rbenv'\nrequire 'capistrano/bundler'\nrequire 'capistrano/rails'\nrequire 'capistrano/rails/assets'\nrequire 'capistrano/rails/migrations'\nrequire 'capistrano3/unicorn'\n\n# Load custom tasks from `lib/capistrano/tasks` if you have any defined\nDir.glob('lib/capistrano/tasks/*.rake').each { |r| import r }\n```\n\n```deploy.rb\n# config valid only for current version of Capistrano\nlock '3.4.0'\n\n# Multistage deployment extension\nset :application, 'your_site.com'\nset :repo_url, 'git@github.com:your_account/your_site.git'\nset :rbenv_ruby, '2.2.0'\nset :rbenv_type, :user\nset :deploy_to, \"/var/www/#{fetch(:application)}\"\n\nshared_path = \"#{fetch(:deploy_to)}/shared\"\nrelease_path = \"#{fetch(:deploy_to)}/current\"\n\nset :linked_dirs, fetch(:linked_dirs, []).push('log', 'tmp/pids', 'tmp/cache', 'tmp/sockets', 'vendor/bundle', 'public/system')\nset :keep_releases, 10\n\n# Unicorn\n# unicorn.rb \u3067\u6307\u5b9a\u3057\u305f pid \u3068\u4e00\u81f4\u3059\u308b\u3088\u3046\u306b\u3002\nset :unicorn_pid, \"#{shared_path}/tmp/pids/unicorn.pid\"\nset :unicorn_config_path, \"#{release_path}/config/unicorn.rb\"\n\nset :ssh_options, {\n  keys: %w(~/.ssh/id_rsa),\n  forward_agent: false,\n  auth_methods: %w(publickey)\n}\n\nafter 'deploy:publishing', 'deploy:restart'\nnamespace :deploy do\n  task :restart do\n    invoke 'unicorn:restart'\n  end\nend\n```\n\n```deploy/production.rb\nserver 'yor_site.com', user: 'username', roles: %w{app db web}\nset :unicorn_pid, \"/var/www/#{fetch(:application)}/shared/tmp/pids/unicorn.pid\"\nset :stage, :production # \u3053\u308c\u3044\u3089\u306a\u3044\u304b\u3082\u3002\nset :unicorn_rack_env, 'production'\nset :unicorn_config_path, \"/var/www/#{fetch(:application)}/current/config/unicorn/production.rb\"\nset :rails_env, 'production'\nset :branch, 'master'\n```\n## \u6700\u5f8c: Capistrano \u3067\u30c7\u30d7\u30ed\u30a4\uff01\n\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306e `app` \u306a\u3069\u304c\u3042\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3067 Rails \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u30c7\u30d7\u30ed\u30a4\u3067\u304d\u308b....\u304b\u3082\u3057\u308c\u306a\u3044\u3002\n\n```\nbundle exec cap production deploy\n```\n\n## \u53c2\u8003\u30b5\u30a4\u30c8\n- [How To Deploy a Rails App with Unicorn and Nginx on Ubuntu 14.04](https://www.digitalocean.com/community/tutorials/how-to-deploy-a-rails-app-with-unicorn-and-nginx-on-ubuntu-14-04)\n- [How To Install Wordpress with nginx on Ubuntu 12.04](https://www.digitalocean.com/community/tutorials/how-to-install-wordpress-with-nginx-on-ubuntu-12-04)\n- [How To Install Ruby on Rails with rbenv on Ubuntu 14.04](https://www.digitalocean.com/community/tutorials/how-to-install-ruby-on-rails-with-rbenv-on-ubuntu-14-04)\n- [capistrano\u3067unicorn\u306eold\u30d7\u30ed\u30bb\u30b9\u304c\u6bba\u305b\u306a\u3044](http://h3poteto.hatenablog.com/entry/2015/05/10/192100)\n", "tags": ["Rails", "MySQL", "nginx", "capistrano", "Ubuntu"]}