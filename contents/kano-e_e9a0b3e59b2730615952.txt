{"tags": ["Rails4", "Authlogic", "OmniAuth"], "context": " More than 1 year has passed since last update.Authlogic\u3068OmniAuth\u3092\u4f7f\u3063\u3066\u8907\u6570\u306e\u30a2\u30ab\u30a6\u30f3\u30c8\u3068\u9023\u643a\u3059\u308b\u3067\u3001\n\n\u4f8b\u3048\u3070\u3001\u3053\u3053\u304b\u3089 Twitter \u30a2\u30ab\u30a6\u30f3\u30c8\u3067\u3082\u8a8d\u8a3c\u3055\u305b\u305f\u304f\u306a\u3063\u305f\u3089\u3002\nFacebookAccount \u3068\u540c\u3058\u8981\u9818\u3067\u8ffd\u52a0\u3059\u308c\u3070\u826f\u3044\u3060\u3051\u306a\u306e\u3067\u4ee5\u4e0b\u7565\u3002\n\n\u3068\u304b\u66f8\u3044\u305f\u306e\u3060\u3051\u308c\u3069\u3082\u3001\u5bfe\u5fdc\u30d7\u30ed\u30d0\u30a4\u30c0\u5897\u3084\u3059\u5ea6\u306b\u30e2\u30c7\u30eb\u4f5c\u308b\u306e\u9762\u5012\u3060\u306a\u3063\u3066\u601d\u3063\u305f\u306e\u3067\u3001\u3044\u3063\u3053\u306e\u30e2\u30c7\u30eb\u3067\u8907\u6570\u30d7\u30ed\u30d0\u30a4\u30c0\u5bfe\u5fdc\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u305f\u3088\u3002\n\u3068\u3044\u3046\u8a71\u3002\n\n\u3053\u308c\u307e\u3067\u306e\u3042\u3089\u3059\u3058\n\n1 User \u306b\u5bfe\u3057\u3066\u3001\u8907\u6570\u306e\u8a8d\u8a3c\u65b9\u6cd5(Facebook\u3084Twitter\u306a\u3069)\u3067\u30ed\u30b0\u30a4\u30f3\u3055\u305b\u305f\u304b\u3063\u305f\n\ndevise \u3092\u8ae6\u3081\u3066 Authlogic \u4f7f\u3046\u3053\u3068\u306b\u3057\u305f\nAuthlogic \u306e add on \u306f\u4f7f\u308f\u305a\u3001\u5bfe\u5fdc\u30b5\u30fc\u30d3\u30b9\u3082\u8c4a\u5bcc\u306a OmniAuth \u4f7f\u3046\u3053\u3068\u306b\u3057\u305f\n\ngem \u306e\u5c0e\u5165\u306a\u3093\u304b\u306f\u524d\u56de\u306e\u8a18\u4e8b\u3067\u3067\u304d\u3066\u3044\u308b\u524d\u63d0\u3002\n\n\u672c\u984c:\u5bfe\u5fdc\u30d7\u30ed\u30d0\u30a4\u30c0\u5897\u3084\u3059\u305f\u3073\u306b\u30e2\u30c7\u30eb\u4f5c\u308b\u306e\u9762\u5012\u3060\u306d\n\u5404\u30b5\u30fc\u30d3\u30b9\u6bce\u306e\u5dee\u7570\u306f OmniAuth \u304c\u3046\u307e\u3044\u3053\u3068\u30e9\u30c3\u30d4\u30f3\u30b0\u3057\u3066\u304f\u308c\u308b\u306e\u3067\u3001\u5358\u4e00\u30e2\u30c7\u30eb\u3067\u3082\u3044\u3051\u308b\u6c17\u304c\u3057\u305f\u306e\u3067\u3084\u3063\u3066\u307f\u305f\u3002\n\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u304b\u3089\u306f Account.authenticate(env['omniauth.auth']) \u3067\u547c\u3073\u51fa\u3059\u3002\n\napp/models/user.rb\nclass User < ActiveRecord::Base\n  acts_as_authentic\n\n  has_many :accounts\nend\n\n\n\napp/models/account.rb\nclass Account < ActiveRecord::Base\n  belongs_to :user\n\n  scope :by, ->(provider) { where(provider: provider) }\n  scope :by_uid, ->(provider, uid) { by(provider).where(uid: uid) }\n\n  # \u8a8d\u8a3c\u60c5\u5831\u304b\u3089\u30a2\u30ab\u30a6\u30f3\u30c8\u3092\u7528\u610f\u3059\u308b\n  #\n  # @param [AuthHash] auth\n  #   see https://github.com/intridea/omniauth/wiki/Auth-Hash-Schema\n  # @return [Account] \u8a8d\u8a3c\u3057\u305f\u30a2\u30ab\u30a6\u30f3\u30c8\u60c5\u5831\n  #   \u3053\u306e\u6642\u70b9\u3067\u306f\u307e\u3060save\u3055\u308c\u3066\u3044\u306a\u3044\n  def self.authenticate(auth)\n    account = by_uid(auth.provider, auth.uid).first_or_initialize\n\n    account.attributes = {\n      token: auth.credentials.token,\n      secret: auth.credentials.secret,\n      nickname: auth.info.nickname,\n      name: auth.info.name,\n      image_url: auth.info.image,\n      profile_url: auth.info.urls.fetch(auth.provider.to_s.camelize),\n    }\n\n    if auth.credentials.expires_at\n      account.expires_at = Time.zone.at(auth.credentials.expires_at)\n    end\n\n    account\n  end\n\n\n\u524d\u56de\u306e\u8a18\u4e8b\u3067\u306f\u3001\u3053\u306e\u30e1\u30bd\u30c3\u30c9\u5185\u3067 User.create \u307e\u3067\u3084\u3063\u3066\u3044\u305f\u306e\u3060\u3051\u308c\u3069\u3082\u3001\u4eca\u56de\u305d\u308c\u306f\u3084\u3081\u3066\u305f\u3002\n\u306a\u306e\u3067\u3001\u547c\u3073\u51fa\u3057\u305f\u5074\u3067 user \u306b\u3064\u3044\u3066\u306e\u51e6\u7406\u3092\u3088\u3057\u306a\u306b\u3057\u305f\u4e0a\u3067 save \u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\u3053\u308c\u306f\u65b0\u898f\u767b\u9332\u3068\u304b\u30ed\u30b0\u30a4\u30f3\u3068\u304b\u9023\u643a\u8ffd\u52a0\u3068\u304b\u306e\u5bfe\u5fdc\u306e\u305f\u3081\u306e\u5909\u66f4\u3002\n\u305d\u3082\u305d\u3082\u306e\u76ee\u7684\u3060\u3063\u305f\u300c1User\u306b\u3064\u304d\u8907\u6570\u30a2\u30ab\u30a6\u30f3\u30c8\u300d\u3068\u3044\u3046\u72b6\u614b\u306b\u3059\u308b\u305f\u3081\u306b\u5fc5\u8981\u3060\u3063\u305f\u3093\u3060\u3051\u3069\u3001\u305d\u308c\u306f\u305d\u308c\u3067\u9577\u304f\u306a\u308b\u306e\u3067\u3001\u4eca\u56de\u306f\u66f8\u304b\u306a\u3044(\u529b\u5c3d\u304d\u305f)\u3002\n\u305d\u3046\u3057\u305f\u3089\u3001\u5f8c\u306f\u5404\u30d7\u30ed\u30d0\u30a4\u30c0\u306e\u30a2\u30d7\u30ea\u8a2d\u5b9a\u3055\u3048\u3057\u3066\u3057\u307e\u3048\u3070\u3001\u5bfe\u5fdc\u30d7\u30ed\u30d0\u30a4\u30c0\u306f\u5272\u3068\u697d\u306b\u5897\u3084\u3057\u3066\u3044\u3051\u305d\u3046\u306a\u4e88\u611f\u3002\n\nconfig/initializers/omniauth_builder.rb\nRails.application.config.middleware.use OmniAuth::Builder do\n  provider :facebook,\n    Rails.application.secrets.facebook_app_id,\n    Rails.application.secrets.facebook_app_secret\n  provider :twitter,\n    Rails.application.secrets.twitter_api_key,\n    Rails.application.secrets.twitter_api_secret,\n    {\n      image_size: 'bigger',\n    }\nend\n\n\nOmniauth \u304c\u30e9\u30c3\u30d4\u30f3\u30b0\u3057\u3066\u304f\u308c\u3066\u308b\u3068\u306f\u3044\u3048\u3001\u5404\u30d7\u30ed\u30d0\u30a4\u30c0\u6bce\u306b\u53d6\u5f97\u3067\u304d\u308b\u9805\u76ee\u3067\u304d\u306a\u3044\u9805\u76ee\u3001\u3069\u3093\u306a\u5024\u304c\u5165\u3063\u3066\u6765\u308b\u304b\u3001\u306a\u3069\u7d50\u69cb\u3070\u3089\u3070\u3089\u306a\u306e\u3067\u6c17\u3092\u4ed8\u3051\u308b\u5fc5\u8981\u306f\u3042\u308b\u3002\n[Authlogic\u3068OmniAuth\u3092\u4f7f\u3063\u3066\u8907\u6570\u306e\u30a2\u30ab\u30a6\u30f3\u30c8\u3068\u9023\u643a\u3059\u308b](http://qiita.com/kano-e/items/14b3b64a76e1eab4d173)\u3067\u3001\n\n> \u4f8b\u3048\u3070\u3001\u3053\u3053\u304b\u3089 Twitter \u30a2\u30ab\u30a6\u30f3\u30c8\u3067\u3082\u8a8d\u8a3c\u3055\u305b\u305f\u304f\u306a\u3063\u305f\u3089\u3002\n> FacebookAccount \u3068\u540c\u3058\u8981\u9818\u3067\u8ffd\u52a0\u3059\u308c\u3070\u826f\u3044\u3060\u3051\u306a\u306e\u3067\u4ee5\u4e0b\u7565\u3002\n\n\u3068\u304b\u66f8\u3044\u305f\u306e\u3060\u3051\u308c\u3069\u3082\u3001\u5bfe\u5fdc\u30d7\u30ed\u30d0\u30a4\u30c0\u5897\u3084\u3059\u5ea6\u306b\u30e2\u30c7\u30eb\u4f5c\u308b\u306e\u9762\u5012\u3060\u306a\u3063\u3066\u601d\u3063\u305f\u306e\u3067\u3001\u3044\u3063\u3053\u306e\u30e2\u30c7\u30eb\u3067\u8907\u6570\u30d7\u30ed\u30d0\u30a4\u30c0\u5bfe\u5fdc\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u305f\u3088\u3002\n\u3068\u3044\u3046\u8a71\u3002\n\n## \u3053\u308c\u307e\u3067\u306e\u3042\u3089\u3059\u3058\n\n* 1 User \u306b\u5bfe\u3057\u3066\u3001\u8907\u6570\u306e\u8a8d\u8a3c\u65b9\u6cd5(Facebook\u3084Twitter\u306a\u3069)\u3067\u30ed\u30b0\u30a4\u30f3\u3055\u305b\u305f\u304b\u3063\u305f\n* [devise](https://github.com/plataformatec/devise) \u3092\u8ae6\u3081\u3066 [Authlogic](https://github.com/binarylogic/authlogic) \u4f7f\u3046\u3053\u3068\u306b\u3057\u305f\n* Authlogic \u306e add on \u306f\u4f7f\u308f\u305a\u3001\u5bfe\u5fdc\u30b5\u30fc\u30d3\u30b9\u3082\u8c4a\u5bcc\u306a [OmniAuth](https://github.com/intridea/omniauth) \u4f7f\u3046\u3053\u3068\u306b\u3057\u305f\n\ngem \u306e\u5c0e\u5165\u306a\u3093\u304b\u306f[\u524d\u56de\u306e\u8a18\u4e8b](http://qiita.com/kano-e/items/14b3b64a76e1eab4d173)\u3067\u3067\u304d\u3066\u3044\u308b\u524d\u63d0\u3002\n\n## \u672c\u984c:\u5bfe\u5fdc\u30d7\u30ed\u30d0\u30a4\u30c0\u5897\u3084\u3059\u305f\u3073\u306b\u30e2\u30c7\u30eb\u4f5c\u308b\u306e\u9762\u5012\u3060\u306d\n\n\u5404\u30b5\u30fc\u30d3\u30b9\u6bce\u306e\u5dee\u7570\u306f OmniAuth \u304c\u3046\u307e\u3044\u3053\u3068\u30e9\u30c3\u30d4\u30f3\u30b0\u3057\u3066\u304f\u308c\u308b\u306e\u3067\u3001\u5358\u4e00\u30e2\u30c7\u30eb\u3067\u3082\u3044\u3051\u308b\u6c17\u304c\u3057\u305f\u306e\u3067\u3084\u3063\u3066\u307f\u305f\u3002\n\n\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u304b\u3089\u306f `Account.authenticate(env['omniauth.auth'])` \u3067\u547c\u3073\u51fa\u3059\u3002\n\n```rb:app/models/user.rb\nclass User < ActiveRecord::Base\n  acts_as_authentic\n\n  has_many :accounts\nend\n```\n\n```rb:app/models/account.rb\nclass Account < ActiveRecord::Base\n  belongs_to :user\n\n  scope :by, ->(provider) { where(provider: provider) }\n  scope :by_uid, ->(provider, uid) { by(provider).where(uid: uid) }\n\n  # \u8a8d\u8a3c\u60c5\u5831\u304b\u3089\u30a2\u30ab\u30a6\u30f3\u30c8\u3092\u7528\u610f\u3059\u308b\n  #\n  # @param [AuthHash] auth\n  #   see https://github.com/intridea/omniauth/wiki/Auth-Hash-Schema\n  # @return [Account] \u8a8d\u8a3c\u3057\u305f\u30a2\u30ab\u30a6\u30f3\u30c8\u60c5\u5831\n  #   \u3053\u306e\u6642\u70b9\u3067\u306f\u307e\u3060save\u3055\u308c\u3066\u3044\u306a\u3044\n  def self.authenticate(auth)\n    account = by_uid(auth.provider, auth.uid).first_or_initialize\n\n    account.attributes = {\n      token: auth.credentials.token,\n      secret: auth.credentials.secret,\n      nickname: auth.info.nickname,\n      name: auth.info.name,\n      image_url: auth.info.image,\n      profile_url: auth.info.urls.fetch(auth.provider.to_s.camelize),\n    }\n\n    if auth.credentials.expires_at\n      account.expires_at = Time.zone.at(auth.credentials.expires_at)\n    end\n\n    account\n  end\n```\n\n[\u524d\u56de\u306e\u8a18\u4e8b](http://qiita.com/kano-e/items/14b3b64a76e1eab4d173)\u3067\u306f\u3001\u3053\u306e\u30e1\u30bd\u30c3\u30c9\u5185\u3067 User.create \u307e\u3067\u3084\u3063\u3066\u3044\u305f\u306e\u3060\u3051\u308c\u3069\u3082\u3001\u4eca\u56de\u305d\u308c\u306f\u3084\u3081\u3066\u305f\u3002\n\u306a\u306e\u3067\u3001\u547c\u3073\u51fa\u3057\u305f\u5074\u3067 `user` \u306b\u3064\u3044\u3066\u306e\u51e6\u7406\u3092\u3088\u3057\u306a\u306b\u3057\u305f\u4e0a\u3067 `save` \u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\n\u3053\u308c\u306f\u65b0\u898f\u767b\u9332\u3068\u304b\u30ed\u30b0\u30a4\u30f3\u3068\u304b\u9023\u643a\u8ffd\u52a0\u3068\u304b\u306e\u5bfe\u5fdc\u306e\u305f\u3081\u306e\u5909\u66f4\u3002\n\u305d\u3082\u305d\u3082\u306e\u76ee\u7684\u3060\u3063\u305f\u300c1User\u306b\u3064\u304d\u8907\u6570\u30a2\u30ab\u30a6\u30f3\u30c8\u300d\u3068\u3044\u3046\u72b6\u614b\u306b\u3059\u308b\u305f\u3081\u306b\u5fc5\u8981\u3060\u3063\u305f\u3093\u3060\u3051\u3069\u3001\u305d\u308c\u306f\u305d\u308c\u3067\u9577\u304f\u306a\u308b\u306e\u3067\u3001\u4eca\u56de\u306f\u66f8\u304b\u306a\u3044(\u529b\u5c3d\u304d\u305f)\u3002\n\n\u305d\u3046\u3057\u305f\u3089\u3001\u5f8c\u306f\u5404\u30d7\u30ed\u30d0\u30a4\u30c0\u306e\u30a2\u30d7\u30ea\u8a2d\u5b9a\u3055\u3048\u3057\u3066\u3057\u307e\u3048\u3070\u3001\u5bfe\u5fdc\u30d7\u30ed\u30d0\u30a4\u30c0\u306f\u5272\u3068\u697d\u306b\u5897\u3084\u3057\u3066\u3044\u3051\u305d\u3046\u306a\u4e88\u611f\u3002\n\n```rb:config/initializers/omniauth_builder.rb\nRails.application.config.middleware.use OmniAuth::Builder do\n  provider :facebook,\n    Rails.application.secrets.facebook_app_id,\n    Rails.application.secrets.facebook_app_secret\n  provider :twitter,\n    Rails.application.secrets.twitter_api_key,\n    Rails.application.secrets.twitter_api_secret,\n    {\n      image_size: 'bigger',\n    }\nend\n```\n\nOmniauth \u304c\u30e9\u30c3\u30d4\u30f3\u30b0\u3057\u3066\u304f\u308c\u3066\u308b\u3068\u306f\u3044\u3048\u3001\u5404\u30d7\u30ed\u30d0\u30a4\u30c0\u6bce\u306b\u53d6\u5f97\u3067\u304d\u308b\u9805\u76ee\u3067\u304d\u306a\u3044\u9805\u76ee\u3001\u3069\u3093\u306a\u5024\u304c\u5165\u3063\u3066\u6765\u308b\u304b\u3001\u306a\u3069\u7d50\u69cb\u3070\u3089\u3070\u3089\u306a\u306e\u3067\u6c17\u3092\u4ed8\u3051\u308b\u5fc5\u8981\u306f\u3042\u308b\u3002\n"}