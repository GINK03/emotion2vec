{"context": "\u4eca\u56de\u306f\u3001\u4e8b\u524d\u306b\u4f5c\u6210\u3057\u305fDevise\u306b\u3088\u308b\u8a8d\u8a3c\u6a5f\u80fd\u3068\u306f\u5225\u306b\u3001Twitter\u3084Facebook\u30a2\u30ab\u30a6\u30f3\u30c8\u3067\u8a8d\u8a3c\u3067\u304d\u308b\u3088\u3046\u306b\u5b9f\u88c5\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n1.gem\u306e\u8ffd\u52a0\u3002\nGemfile\n\ngem 'devise'\ngem 'omniauth'\ngem 'omniauth-twitter'\ngem 'omniauth-facebook'\n\n$ bundle install\n\n\n2.User\u30e2\u30c7\u30eb\u306bOmniAuth\u3067\u5229\u7528\u3059\u308b\u30ab\u30e9\u30e0\u3092\u8ffd\u52a0\u3002\n$ bundle exec rails generate migration AddOmniauthColumnsToUsers provider uid name\n\n\ndb/migrate/...\nclass AddOmniauthColumnsToUsers < ActiveRecord::Migration\n  def change\n    add_column :users, :uid,      :string, null: false, default: \"\"\n    add_column :users, :provider, :string, null: false, default: \"\"\n    add_column :users, :name,     :string\n\n    add_index :users, [:uid, :provider], unique: true\n  end\nend\n\n\n$ bundle exec rake db:migrate\n\nuid, provider, name \u306e3\u3064\u306e\u30ab\u30e9\u30e0\u304c\u8ffd\u52a0\u3055\u308c\u307e\u3057\u305f\u3002\n\n3.OAuth\u8a8d\u8a3c\u306b\u5fc5\u8981\u306a\u30ad\u30fc\u30fb\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u30c8\u30fc\u30af\u30f3\u3092\u8ffd\u8a18\u3002\n(1)Facebook \u306e API Key\nHome \u2013 Facebook\u958b\u767a\u8005 \u3067\u53d6\u5f97\u3002https://developers.facebook.com/\n\u30ed\u30b0\u30a4\u30f3 \u2192 \u53f3\u4e0a\u306e\u300cRegister Now\u300d\u304b\u3089 developer \u767b\u9332\u3002\nFacebook Developers \u306e\u53f3\u4e0a\u306e\u300c+\u65b0\u3057\u3044\u30a2\u30d7\u30ea\u3092\u4f5c\u6210\u300d\u3002\n\u30fb\u30a2\u30d7\u30ea\u540d\uff1a\u4efb\u610f\n\u30fb\u540d\u524d\u7a7a\u9593\uff1a\u4efb\u610f\n\u30fb\u30ab\u30c6\u30b4\u30ea\uff1a\u305d\u306e\u4ed6\uff08\u4efb\u610f\uff09\n\u3068\u5165\u529b\u3057\u3066\u3001App ID, App Secret \u3092\u53d6\u5f97\u3002\n\u30a2\u30d7\u30ea\u3092Facebook\u306b\u7d50\u5408\u3059\u308b\u65b9\u6cd5\u3092\u9078\u629e\u3067\u3001Facebook\u3067\u30ed\u30b0\u30a4\u30f3\u304c\u53ef\u80fd\u306a\u30a6\u30a7\u30d6\u30b5\u30a4\u30c8\u306b\u300chttp://localhost:3000\u300d\u3092\u5165\u529b\u3002\n(2)Twitter \u306e API Key\nTwitter Developers \u3067\u53d6\u5f97\u3002https://dev.twitter.com/\n\u30ed\u30b0\u30a4\u30f3 \u2192 \u53f3\u4e0a My Applications \u2192 Create a new application\n\u30fbName\uff1a\u4efb\u610f\n\u30fbDescription\uff1a\u4efb\u610f\n\u30fbWebsite\uff1a\u9069\u5f53\u306aURL\uff08http://localhost:3000 \u3060\u3068NG\uff09\n\u30fbCallback URL\uff1ahttp://127.0.0.1:3000/auth/twitter/callback\n\uff08http://localhost:3000 \u3060\u3068NG\uff09\n\u305d\u306e\u5f8c\u3001Consumer key, Consumer secret \u3092\u53d6\u5f97\u3057\u3001 key, secret \u3092 config/initializers/devise.rb \u306b\u8a2d\u5b9a\u3002\nSettings \u3067 \u300cAllow this application to be used to Sign in with Twitter\u300d\u306b\u30c1\u30a7\u30c3\u30af\u3002\u4e00\u56deTwitter\u3067OAuth\u8a8d\u8a3c\u3092\u884c\u3046\u3068\u3001\u6b21\u56de\u304b\u3089\u306f\u78ba\u8a8d\u753b\u9762\u304c\u7701\u7565\u3055\u308c\u308b\u3002\n\nconfig/initializers/devise.rb\n  # API key\n  if Rails.env.production?     \n    config.omniauth :facebook, \"App ID\", \"App Secret\"\n    config.omniauth :twitter,  \"Consumer key\", \"Consumer secret\"\n  else\n    config.omniauth :facebook, \"App ID\", \"App Secret\"\n    config.omniauth :twitter,  \"Consumer key\", \"Consumer secret\"\n  end\n\n\n\n4.User\u30e2\u30c7\u30eb\u306bomniauthable\u3092\u8ffd\u52a0\u3002\n\napp/models/user.rb\n  devise :database_authenticatable, :omniauthable, :registerable,\n         :recoverable, :rememberable, :trackable, :validatable, :confirmable\n\n\n\n5.OAuth\u306ecallback \u7528\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3092\u8ffd\u52a0\u3002\n\nconfig/routes.rb\ndevise_for :users, :controllers => {\n  :sessions      => \"users/sessions\",\n  :registrations => \"users/registrations\",\n  :passwords     => \"users/passwords\",\n  :omniauth_callbacks => \"users/omniauth_callbacks\" \n}\n\n\n\n6.Users::OmniauthCallbacksController\u3092\u4f5c\u6210\u3002\n\napp/controllers/users/omniauth_callbacks_controller.rb\nclass Users::OmniauthCallbacksController < Devise::OmniauthCallbacksController\n  def facebook\n    # You need to implement the method below in your model (e.g. app/models/user.rb)\n    @user = User.find_for_facebook_oauth(request.env[\"omniauth.auth\"], current_user)\n\n    if @user.persisted?\n      set_flash_message(:notice, :success, :kind => \"Facebook\") if is_navigational_format?\n      sign_in_and_redirect @user, :event => :authentication\n    else\n      session[\"devise.facebook_data\"] = request.env[\"omniauth.auth\"]\n      redirect_to new_user_registration_url\n    end\n  end\n\n  def twitter\n    # You need to implement the method below in your model\n    @user = User.find_for_twitter_oauth(request.env[\"omniauth.auth\"], current_user)\n\n    if @user.persisted?\n      set_flash_message(:notice, :success, :kind => \"Twitter\") if is_navigational_format?\n      sign_in_and_redirect @user, :event => :authentication\n    else\n      session[\"devise.twitter_data\"] = request.env[\"omniauth.auth\"].except(\"extra\")\n      redirect_to new_user_registration_url\n    end\n  end\nend\n\n\n\u203bdevise\u306e\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u4f5c\u6210\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3002\n\n$ rails g devise:controllers users\n\n\u4ee5\u4e0b\u306eController\u304c\u751f\u6210\u3055\u308c\u308b\u3002\nconfirmations_controller.rb\nomniauth_callbacks_controller.rb\npasswords_controller.rb\nregistrations_controller.rb\nsessions_controller.rb\nunlocks_controller.rb\n\n\n7.\u901a\u5e38\u30b5\u30a4\u30f3\u30a2\u30c3\u30d7\u6642\u306e uid \u30d5\u30a3\u30fc\u30eb\u30c9\u8a2d\u5b9a\u306e\u5b9f\u88c5\u3002\n\napp/controllers/users/registrations_controller.rb\nclass Users::RegistrationsController < Devise::RegistrationsController\n\n  def build_resource(hash=nil)\n    hash[:uid] = User.create_unique_string\n    super\n  end\n\nend\n\n\n\napp/models/user.rb\nclass User < ActiveRecord::Base\n  # \u30fb\u30fb\u30fb\n\n  # \u901a\u5e38\u30b5\u30a4\u30f3\u30a2\u30c3\u30d7\u6642\u306euid\u7528\u3001Twitter OAuth\u8a8d\u8a3c\u6642\u306eemail\u7528\u306buuid\u306a\u6587\u5b57\u5217\u3092\u751f\u6210\n  def self.create_unique_string\n    SecureRandom.uuid\n  end\n\n  # \u30fb\u30fb\u30fb\nend\n\n\n\n8.OAuth \u8a8d\u8a3c\u6642\u306e email \u30d5\u30a3\u30fc\u30eb\u30c9\u8a2d\u5b9a\u306e\u5b9f\u88c5\u3002\n\napp/models/user.rb\n  devise :database_authenticatable, :omniauthable, :registerable,\n         :recoverable, :rememberable, :trackable, :validatable, :confirmable\n\n  def self.find_for_facebook_oauth(auth, signed_in_resource=nil)\n    user = User.where(:provider => auth.provider, :uid => auth.uid).first\n    unless user\n      user = User.create(name:     auth.extra.raw_info.name,\n                         provider: auth.provider,\n                         uid:      auth.uid,\n                         email:    auth.info.email,\n                         password: Devise.friendly_token[0,20]\n                        )\n    end\n    user\n  end\n\n  def self.find_for_twitter_oauth(auth, signed_in_resource=nil)\n    user = User.where(:provider => auth.provider, :uid => auth.uid).first\n    unless user\n      user = User.create(name:     auth.info.nickname,\n                         provider: auth.provider,\n                         uid:      auth.uid,\n                         email:    User.create_unique_email,\n                         password: Devise.friendly_token[0,20]\n                        )\n    end\n    user\n  end\n\n  # \u901a\u5e38\u30b5\u30a4\u30f3\u30a2\u30c3\u30d7\u6642\u306euid\u7528\u3001Twitter OAuth\u8a8d\u8a3c\u6642\u306eemail\u7528\u306buuid\u306a\u6587\u5b57\u5217\u3092\u751f\u6210\n  def self.create_unique_string\n    SecureRandom.uuid\n  end\n\n  # twitter\u3067\u306femail\u3092\u53d6\u5f97\u3067\u304d\u306a\u3044\u306e\u3067\u3001\u9069\u5f53\u306b\u4e00\u610f\u306eemail\u3092\u751f\u6210\n  def self.create_unique_email\n    User.create_unique_string + \"@example.com\"\n  end\n\n\n\n9\u30d3\u30e5\u30fc\u306bOAuth\u8a8d\u8a3c\u7528\u306e\u30ed\u30b0\u30a4\u30f3\u3078\u306e\u30ea\u30f3\u30af\u3092\u8868\u793a\u3002\n\napp/views/layouts/application.html.erb\n<%= link_to \"Sign in with Facebook\", user_omniauth_authorize_path(:facebook), :class => 'navbar-link' %>\n<%= link_to \"Sign in with Twitter\",  user_omniauth_authorize_path(:twitter),  :class => 'navbar-link' %>\n\n\n\u4ee5\u4e0a\u3067\u7d42\u4e86\u3067\u3059\u3002\n\u4eca\u56de\u306f\u3001\u4e8b\u524d\u306b\u4f5c\u6210\u3057\u305fDevise\u306b\u3088\u308b\u8a8d\u8a3c\u6a5f\u80fd\u3068\u306f\u5225\u306b\u3001Twitter\u3084Facebook\u30a2\u30ab\u30a6\u30f3\u30c8\u3067\u8a8d\u8a3c\u3067\u304d\u308b\u3088\u3046\u306b\u5b9f\u88c5\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n#1.gem\u306e\u8ffd\u52a0\u3002\n```\nGemfile\n\ngem 'devise'\ngem 'omniauth'\ngem 'omniauth-twitter'\ngem 'omniauth-facebook'\n```\n```\n$ bundle install\n```\n\n#2.User\u30e2\u30c7\u30eb\u306bOmniAuth\u3067\u5229\u7528\u3059\u308b\u30ab\u30e9\u30e0\u3092\u8ffd\u52a0\u3002\n```\n$ bundle exec rails generate migration AddOmniauthColumnsToUsers provider uid name\n```\n```db/migrate/...\nclass AddOmniauthColumnsToUsers < ActiveRecord::Migration\n  def change\n    add_column :users, :uid,      :string, null: false, default: \"\"\n    add_column :users, :provider, :string, null: false, default: \"\"\n    add_column :users, :name,     :string\n\n    add_index :users, [:uid, :provider], unique: true\n  end\nend\n```\n```\n$ bundle exec rake db:migrate\n```\nuid, provider, name \u306e3\u3064\u306e\u30ab\u30e9\u30e0\u304c\u8ffd\u52a0\u3055\u308c\u307e\u3057\u305f\u3002\n\n#3.OAuth\u8a8d\u8a3c\u306b\u5fc5\u8981\u306a\u30ad\u30fc\u30fb\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u30c8\u30fc\u30af\u30f3\u3092\u8ffd\u8a18\u3002\n\n(1)Facebook \u306e API Key\n\nHome \u2013 Facebook\u958b\u767a\u8005 \u3067\u53d6\u5f97\u3002https://developers.facebook.com/\n\u30ed\u30b0\u30a4\u30f3 \u2192 \u53f3\u4e0a\u306e\u300cRegister Now\u300d\u304b\u3089 developer \u767b\u9332\u3002\nFacebook Developers \u306e\u53f3\u4e0a\u306e\u300c+\u65b0\u3057\u3044\u30a2\u30d7\u30ea\u3092\u4f5c\u6210\u300d\u3002\n\u30fb\u30a2\u30d7\u30ea\u540d\uff1a\u4efb\u610f\n\u30fb\u540d\u524d\u7a7a\u9593\uff1a\u4efb\u610f\n\u30fb\u30ab\u30c6\u30b4\u30ea\uff1a\u305d\u306e\u4ed6\uff08\u4efb\u610f\uff09\n\n\u3068\u5165\u529b\u3057\u3066\u3001App ID, App Secret \u3092\u53d6\u5f97\u3002\n\u30a2\u30d7\u30ea\u3092Facebook\u306b\u7d50\u5408\u3059\u308b\u65b9\u6cd5\u3092\u9078\u629e\u3067\u3001Facebook\u3067\u30ed\u30b0\u30a4\u30f3\u304c\u53ef\u80fd\u306a\u30a6\u30a7\u30d6\u30b5\u30a4\u30c8\u306b\u300chttp://localhost:3000\u300d\u3092\u5165\u529b\u3002\n\n(2)Twitter \u306e API Key\n\nTwitter Developers \u3067\u53d6\u5f97\u3002https://dev.twitter.com/\n\u30ed\u30b0\u30a4\u30f3 \u2192 \u53f3\u4e0a My Applications \u2192 Create a new application\n\u30fbName\uff1a\u4efb\u610f\n\u30fbDescription\uff1a\u4efb\u610f\n\u30fbWebsite\uff1a\u9069\u5f53\u306aURL\uff08http://localhost:3000 \u3060\u3068NG\uff09\n\u30fbCallback URL\uff1ahttp://127.0.0.1:3000/auth/twitter/callback\n\uff08http://localhost:3000 \u3060\u3068NG\uff09\n\n\u305d\u306e\u5f8c\u3001Consumer key, Consumer secret \u3092\u53d6\u5f97\u3057\u3001 key, secret \u3092 config/initializers/devise.rb \u306b\u8a2d\u5b9a\u3002\nSettings \u3067 \u300cAllow this application to be used to Sign in with Twitter\u300d\u306b\u30c1\u30a7\u30c3\u30af\u3002\u4e00\u56deTwitter\u3067OAuth\u8a8d\u8a3c\u3092\u884c\u3046\u3068\u3001\u6b21\u56de\u304b\u3089\u306f\u78ba\u8a8d\u753b\u9762\u304c\u7701\u7565\u3055\u308c\u308b\u3002\n\n```config/initializers/devise.rb\n  # API key\n  if Rails.env.production?     \n    config.omniauth :facebook, \"App ID\", \"App Secret\"\n    config.omniauth :twitter,  \"Consumer key\", \"Consumer secret\"\n  else\n    config.omniauth :facebook, \"App ID\", \"App Secret\"\n    config.omniauth :twitter,  \"Consumer key\", \"Consumer secret\"\n  end\n```\n#4.User\u30e2\u30c7\u30eb\u306bomniauthable\u3092\u8ffd\u52a0\u3002\n```app/models/user.rb\n  devise :database_authenticatable, :omniauthable, :registerable,\n         :recoverable, :rememberable, :trackable, :validatable, :confirmable\n```\n\n#5.OAuth\u306ecallback \u7528\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3092\u8ffd\u52a0\u3002\n```config/routes.rb\ndevise_for :users, :controllers => {\n  :sessions      => \"users/sessions\",\n  :registrations => \"users/registrations\",\n  :passwords     => \"users/passwords\",\n  :omniauth_callbacks => \"users/omniauth_callbacks\" \n}\n```\n#6.Users::OmniauthCallbacksController\u3092\u4f5c\u6210\u3002\n```app/controllers/users/omniauth_callbacks_controller.rb\nclass Users::OmniauthCallbacksController < Devise::OmniauthCallbacksController\n  def facebook\n    # You need to implement the method below in your model (e.g. app/models/user.rb)\n    @user = User.find_for_facebook_oauth(request.env[\"omniauth.auth\"], current_user)\n \n    if @user.persisted?\n      set_flash_message(:notice, :success, :kind => \"Facebook\") if is_navigational_format?\n      sign_in_and_redirect @user, :event => :authentication\n    else\n      session[\"devise.facebook_data\"] = request.env[\"omniauth.auth\"]\n      redirect_to new_user_registration_url\n    end\n  end\n \n  def twitter\n    # You need to implement the method below in your model\n    @user = User.find_for_twitter_oauth(request.env[\"omniauth.auth\"], current_user)\n \n    if @user.persisted?\n      set_flash_message(:notice, :success, :kind => \"Twitter\") if is_navigational_format?\n      sign_in_and_redirect @user, :event => :authentication\n    else\n      session[\"devise.twitter_data\"] = request.env[\"omniauth.auth\"].except(\"extra\")\n      redirect_to new_user_registration_url\n    end\n  end\nend\n```\n\u203bdevise\u306e\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u4f5c\u6210\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3002\n```\n$ rails g devise:controllers users\n```\n\u4ee5\u4e0b\u306eController\u304c\u751f\u6210\u3055\u308c\u308b\u3002\n\n```\nconfirmations_controller.rb\nomniauth_callbacks_controller.rb\npasswords_controller.rb\nregistrations_controller.rb\nsessions_controller.rb\nunlocks_controller.rb\n```\n#7.\u901a\u5e38\u30b5\u30a4\u30f3\u30a2\u30c3\u30d7\u6642\u306e uid \u30d5\u30a3\u30fc\u30eb\u30c9\u8a2d\u5b9a\u306e\u5b9f\u88c5\u3002\n\n```app/controllers/users/registrations_controller.rb\nclass Users::RegistrationsController < Devise::RegistrationsController\n \n  def build_resource(hash=nil)\n    hash[:uid] = User.create_unique_string\n    super\n  end\n \nend\n```\n\n```app/models/user.rb\nclass User < ActiveRecord::Base\n  # \u30fb\u30fb\u30fb\n \n  # \u901a\u5e38\u30b5\u30a4\u30f3\u30a2\u30c3\u30d7\u6642\u306euid\u7528\u3001Twitter OAuth\u8a8d\u8a3c\u6642\u306eemail\u7528\u306buuid\u306a\u6587\u5b57\u5217\u3092\u751f\u6210\n  def self.create_unique_string\n    SecureRandom.uuid\n  end\n \n  # \u30fb\u30fb\u30fb\nend\n```\n\n#8.OAuth \u8a8d\u8a3c\u6642\u306e email \u30d5\u30a3\u30fc\u30eb\u30c9\u8a2d\u5b9a\u306e\u5b9f\u88c5\u3002\n```app/models/user.rb\n  devise :database_authenticatable, :omniauthable, :registerable,\n         :recoverable, :rememberable, :trackable, :validatable, :confirmable\n\n  def self.find_for_facebook_oauth(auth, signed_in_resource=nil)\n    user = User.where(:provider => auth.provider, :uid => auth.uid).first\n    unless user\n      user = User.create(name:     auth.extra.raw_info.name,\n                         provider: auth.provider,\n                         uid:      auth.uid,\n                         email:    auth.info.email,\n                         password: Devise.friendly_token[0,20]\n                        )\n    end\n    user\n  end\n \n  def self.find_for_twitter_oauth(auth, signed_in_resource=nil)\n    user = User.where(:provider => auth.provider, :uid => auth.uid).first\n    unless user\n      user = User.create(name:     auth.info.nickname,\n                         provider: auth.provider,\n                         uid:      auth.uid,\n                         email:    User.create_unique_email,\n                         password: Devise.friendly_token[0,20]\n                        )\n    end\n    user\n  end\n \n  # \u901a\u5e38\u30b5\u30a4\u30f3\u30a2\u30c3\u30d7\u6642\u306euid\u7528\u3001Twitter OAuth\u8a8d\u8a3c\u6642\u306eemail\u7528\u306buuid\u306a\u6587\u5b57\u5217\u3092\u751f\u6210\n  def self.create_unique_string\n    SecureRandom.uuid\n  end\n \n  # twitter\u3067\u306femail\u3092\u53d6\u5f97\u3067\u304d\u306a\u3044\u306e\u3067\u3001\u9069\u5f53\u306b\u4e00\u610f\u306eemail\u3092\u751f\u6210\n  def self.create_unique_email\n    User.create_unique_string + \"@example.com\"\n  end\n```\n#9\u30d3\u30e5\u30fc\u306bOAuth\u8a8d\u8a3c\u7528\u306e\u30ed\u30b0\u30a4\u30f3\u3078\u306e\u30ea\u30f3\u30af\u3092\u8868\u793a\u3002\n```app/views/layouts/application.html.erb\n<%= link_to \"Sign in with Facebook\", user_omniauth_authorize_path(:facebook), :class => 'navbar-link' %>\n<%= link_to \"Sign in with Twitter\",  user_omniauth_authorize_path(:twitter),  :class => 'navbar-link' %>\n```\n\n\u4ee5\u4e0a\u3067\u7d42\u4e86\u3067\u3059\u3002\n\n\n\n", "tags": ["Rails", "Ruby", "Twitter", "Fasebook", "\u8a8d\u8a3c"]}