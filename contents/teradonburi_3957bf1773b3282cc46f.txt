{"context": "\n\n\u72ec\u308a\u307c\u3063\u3061\u306f\u3001\u5bc2\u3057\u3044\u3082\u3093\u306a\u30fb\u30fb\u30fb\n\u6700\u8fd1\u7d76\u8cdb\u307c\u3063\u3061\u6e80\u55ab\u3057\u3066\u307e\u3059\u3002\n\u6700\u8fd1\u306f\u307c\u3063\u3061\u904e\u304e\u3066\u3001\u307c\u3063\u3061\u751f\u6d3b\u3092\u5145\u5b9f\u3059\u308b\u307c\u3063\u3061\u5145\u3068\u3044\u3046\u30ef\u30fc\u30c9\u304c\u3042\u308b\u3088\u3046\u3067\u3059\u3002\n\u3061\u306a\u307f\u306b\u5225\u30ef\u30fc\u30c9\u306b\u30bd\u30ed\u5145\u3068\u3044\u3046\u3082\u306e\u304c\u3042\u308b\u3089\u3057\u3044\u306e\u3067\u3059\u304c\u3001\n\u3053\u3061\u3089\u306f\u53cb\u9054\u304c\u3044\u308b\u3051\u3069\u4e00\u4eba\u884c\u52d5\u3059\u308b\u4eba\u305f\u3061\u306e\u3053\u3068\u3089\u3057\u3044\u3067\u3059\u3002\n\uff08\u53cb\u9054\u3044\u308b\u306e\u306b\u5358\u72ec\u884c\u52d5\u3059\u308b\u3068\u304b\u307c\u3063\u3061\u306e\u6575\uff09\n\u6c7a\u3057\u3066\u30fb\u30fb\u30fb\u5bc2\u3057\u304f\u306a\u3093\u3066\u306a\u3044\u3093\u3060\u304b\u3089\u306d\uff01\n\nQiita\u3067\u4ef2\u9593\uff08\u4f3c\u305f\u3088\u3046\u306a\u601d\u8003\u306e\u4eba\uff09\u3092\u63a2\u3059\n\u305d\u3082\u305d\u3082Qiita\u3067\u63a2\u3059\u306a\u3068\u3044\u3046\u8a71\u3067\u3059\u304c\n\u305d\u3093\u306a\u308f\u3051\u3067Qiita API\u306a\u308b\u3082\u306e\u304c\u3042\u308b\u3088\u3046\u306a\u306e\u3067\nQiita\u6295\u7a3f\u8a18\u4e8b\u304b\u3089\u81ea\u5206\u306e\u6295\u7a3f\u3068\u4f3c\u305f\u3088\u3046\u306a\u6295\u7a3f\u3092\u3059\u308b\u4eba\u3092\n\u30d5\u30a9\u30ed\u30fc\u3059\u308b\u3068\u3044\u3046\u306f\u305f\u8ff7\u60d1\u306a\u4fbf\u5229\u306a\u6a5f\u80fd\u3092\u4f5c\u3063\u3066\u307f\u307e\u3057\u305f\u3002\n\u6b21\u306e\u3088\u3046\u306a\u6d41\u308c\u3067\u30d5\u30a9\u30ed\u30fc\u5bfe\u8c61\u3092\u63a2\u3057\u307e\u3059\u3002\n\n\u81ea\u5206\u306e\u6295\u7a3f\u5185\u5bb9\u304b\u3089\u30bf\u30b0\u62bd\u51fa\n\u30e6\u30fc\u30b6\u3092\u63a2\u3059\n\u6295\u7a3f\u306a\u3057\u306e\u30e6\u30fc\u30b6\u306f\u30b9\u30ad\u30c3\u30d7\n\u30e6\u30fc\u30b6\u306e\u6295\u7a3f\u3092\u53d6\u5f97\n\u81ea\u5206\u3068\u540c\u3058\u30bf\u30b0\u3092\u3064\u3051\u3066\u308b\u6295\u7a3f\u304c\u3042\u308b\u30e6\u30fc\u30b6\u306a\u3089\u30d5\u30a9\u30ed\u30fc\n\uff11\u301c\uff15\u3092\uff11\u6642\u9593\u304a\u304d\u306b\uff11\uff10\uff10\uff10\u30ea\u30af\u30a8\u30b9\u30c8\u4e0a\u9650\u8d85\u3048\u306a\u3044\u3088\u3046\u306bcron\u3067\u547c\u3073\u51fa\u3057\n\n\n\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\nNodeJS\u3067\u5b9f\u88c5\u3057\u3066\u3044\u307e\u3059\u3002\ncron\u3092\u4f7f\u3063\u3066\u3044\u308b\u306e\u3067cron,time\u30e2\u30b8\u30e5\u30fc\u30eb\u306f\u5fc5\u8981\u3067\u3059\u3002\n\npackage.json\n{\n  \"name\": \"qiita\",\n  \"version\": \"1.0.0\",\n  \"description\": \"\",\n  \"main\": \"index.js\",\n  \"scripts\": {\n    \"test\": \"echo \\\"Error: no test specified\\\" && exit 1\"\n  },\n  \"author\": \"\",\n  \"license\": \"ISC\",\n  \"dependencies\": {\n    \"cron\": \"^1.1.0\",\n    \"time\": \"^0.11.4\"\n  }\n}\n\n\n\u30bd\u30fc\u30b9\u672c\u4f53\u3067\u3059\u3002\u30af\u30fc\u30ed\u30f3\u306b\u3088\u308a\u3001\u6bce\u6642\uff08x\u6642\uff10\u5206\uff10\u79d2\uff09\u306b\u5b9a\u671f\u5b9f\u884c\u3055\u308c\u307e\u3059\u3002\nQiita\u30c8\u30fc\u30af\u30f3\u306f\u3054\u81ea\u5206\u306eQiita\u30a2\u30ab\u30a6\u30f3\u30c8\u306e\u3082\u306e\u306b\u5dee\u3057\u66ff\u3048\u3066\u304f\u3060\u3055\u3044\u3002\n\nqiitaFollower.js\nvar http = require('http');\nvar querystring = require('querystring');\n\n// qiita\u8a8d\u8a3c\u30c8\u30fc\u30af\u30f3\nvar token = '<Qiita\u30c8\u30fc\u30af\u30f3>';\n\n// search\nvar pageStart = 0;\n// \u691c\u7d22\u30da\u30fc\u30b8\u6570\u4e0a\u9650\nvar pageSearchMax = 50;\n\nvar isJSON = function(arg) {\n    arg = (typeof arg === \"function\") ? arg() : arg;\n    if (typeof arg  !== \"string\") {\n        return false;\n    }\n    try {\n        arg = (!JSON) ? eval(\"(\" + arg + \")\") : JSON.parse(arg);\n        return true;\n    } catch (e) {\n        return false;\n    }\n};\n\nfunction qiitaAPI(api,method,callback){\n\n\n    var options = {\n        hostname: 'qiita.com',\n        port: 80,\n        path: api,\n        method: method,\n        headers: {\n            'Content-Type': 'application/json',\n            'Authorization': 'Bearer ' + token\n        }\n    };\n\n\n    setTimeout(function(){\n        var req = http.request(options, function (res) {\n\n            var body = '';\n            res.setEncoding('utf8');\n\n            res.on('data', function (chunk) {\n                body += chunk;\n            });\n\n            res.on('end', function () {\n                callback(null,body);\n            });\n\n        }).on('error', function (e) {\n            console.log(e);\n            callback(e,null);\n        });\n\n        //req.write('');\n        req.end();\n    }, 500);    // Qiita\u30b5\u30fc\u30d0\u306b\u8ca0\u8377\u304b\u3051\u3059\u304e\u306a\u3044\n\n}\n\n\n// \u81ea\u5206\u306e\u6295\u7a3f\u3092\u53d6\u5f97\nfunction myposts() {\n    var deferred = Promise.defer();\n\n    var path = '/api/v2/authenticated_user/items';\n\n    path += '?' + querystring.stringify({\n        'page': 1,\n        'per_page': 100,\n    });\n\n\n    // \u975e\u540c\u671f\u95a2\u6570 \n    qiitaAPI(path,'GET', function(err, data){\n       if (err) {\n         return deferred.reject(err); // .catch\n       }\n       deferred.resolve(data); // then\n    });\n\n    return deferred.promise; \n}\n\n\n\n// \u30e6\u30fc\u30b6\u53d6\u5f97\nfunction users(page) {\n    var deferred = Promise.defer();\n\n    var path = '/api/v2/users';\n\n    path += '?' + querystring.stringify({\n        'page': page,\n        'per_page': 100,\n    });\n\n    // \u975e\u540c\u671f\u95a2\u6570 \n    qiitaAPI(path,'GET', function(err, data){\n       if (err) {\n         return deferred.reject(err); // .catch\n       }\n       deferred.resolve(data); // then\n    });\n\n    return deferred.promise; \n}\n\n\n\n// \u30e6\u30fc\u30b6\u306e\u6295\u7a3f\u3092\u53d6\u5f97\nfunction userpost(id) {\n    var deferred = Promise.defer();\n\n    var path = '/api/v2/users/' + id + '/items';\n\n    path += '?' + querystring.stringify({\n        'page': 1,\n        'per_page': 100,\n    });\n\n    qiitaAPI(path,'GET',function(err,data){\n        if(err !== null){\n            return deferred.reject(err); \n        }\n        deferred.resolve(data); \n    });\n\n    return deferred.promise; \n}\n\n// Qiita\u30e6\u30fc\u30b6\u3092\u30d5\u30a9\u30ed\u30fc\nfunction follow(id) {\n    var deferred = Promise.defer();\n\n    var path = '/api/v2/users/' + id + '/following';\n    console.log(\"path:\",path);\n\n    // \u975e\u540c\u671f\u95a2\u6570 \n    qiitaAPI(path,'PUT', function(err, data){\n        if (err) {\n            return deferred.reject(err); // .catch\n        }\n        deferred.resolve(data); // then\n    });\n\n    return deferred.promise; \n}\n\nfunction followQiitaUsers(){\n    // \u81ea\u5206\u306e\u6295\u7a3f\u306e\u30bf\u30b0\n    var mytags = {};\n    // \u30e6\u30fc\u30b6\n    var findusers = [];\n    // \u30d5\u30a9\u30ed\u30fc\u30e6\u30fc\u30b6\n    var followUsers = [];\n\n    // \u81ea\u5206\u306e\u6295\u7a3f\u53d6\u5f97\n    myposts()\n    .then(function (data) {\n\n\n        // \u81ea\u5206\u306e\u6295\u7a3f\u8a18\u4e8b\u306e\u30bf\u30b0\u3092\u53d6\u5f97\n        var datas = JSON.parse(data);\n\n        // 1\u6642\u95931000\u30ea\u30af\u30a8\u30b9\u30c8\u4e0a\u9650\u8d85\u3048\u305f\n        if(datas.type === 'rate_limit_exceeded'){\n            throw new Error(datas.message);\n        }\n\n        for(var i=0;i<datas.length;++i){\n            var tags = datas[i].tags;\n            for(var j=0;j<tags.length;++j){\n                mytags[tags[j].name] = tags[j].name;\n            }\n\n        }   \n        console.log(\"mytags:\",mytags);\n\n\n        var pages = [];\n        for(var i=pageStart;i<pageStart+pageSearchMax;++i){\n            pages.push(i);\n        }\n\n        // \u4ed6\u306e\u30e6\u30fc\u30b6\u60c5\u5831\u53d6\u5f97\n        return pages.reduce(function (promise, param) {\n            return promise.then(function () {\n                return users(param).then(function(data){\n                    var datas = JSON.parse(data);\n                    // 1\u6642\u95931000\u30ea\u30af\u30a8\u30b9\u30c8\u4e0a\u9650\u8d85\u3048\u305f\n                    if(datas.type === 'rate_limit_exceeded'){\n                        throw new Error(datas.message);\n                    }\n                    console.log(\"user page\",i,\":\",datas);\n\n                    Array.prototype.push.apply(findusers,datas);\n                });\n            });\n        }, Promise.resolve());\n\n    })\n    .then(function(){\n\n\n        var users = [];\n        for(var i=0;i<findusers.length;++i){\n            var id = findusers[i].id;\n            var items_count = findusers[i].items_count;\n            // \u30d7\u30ed\u30d5\u30a3\u30fc\u30eb\u753b\u50cf\n            var profile_image_url =  findusers[i].profile_image_url;\n            // \u30db\u30fc\u30e0\u30da\u30fc\u30b8\n            var website_url = findusers[i].website_url;\n            // \u6295\u7a3f\u304c\u3042\u308b\u4eba\u9650\u5b9a\n            if(items_count > 0){\n                users.push({id:id,image:profile_image_url,homepage:website_url});\n            }\n        }\n        console.log(\"users:\",users);\n\n\n        // \u30e6\u30fc\u30b6\u6295\u7a3f\u60c5\u5831\u53d6\u5f97\n        return users.reduce(function (promise, param) {\n            return promise.then(function () {\n                return userpost(param.id).then(function(data){\n                    var datas = JSON.parse(data);\n                    // 1\u6642\u95931000\u30ea\u30af\u30a8\u30b9\u30c8\u4e0a\u9650\u8d85\u3048\u305f\n                    if(datas.type === 'rate_limit_exceeded'){\n                        throw new Error(datas.message);\n                    }                    \n\n                    console.log(\"user id:\",param.id);\n                    var usertags = [];\n                    // \u30e6\u30fc\u30b6\u306e\u6295\u7a3f\u5185\u5bb9\u53d6\u5f97\n                    for(var i=0;i<datas.length;++i){\n                        var tags = datas[i].tags;\n                        for(var j=0;j<tags.length;++j){\n                            usertags[tags[j].name] = tags[j].name;\n                        }\n                        console.log(\"title:\",datas[i].title);\n                    }   \n                    console.log(\"usertags:\",usertags);\n\n                    // \u81ea\u5206\u3068\u540c\u3058\u6295\u7a3f\u30bf\u30b0\u3092\u6301\u3063\u3066\u3044\u308b\u304b\uff1f\n                    for(var mytag in mytags){\n                        // \u6301\u3063\u3066\u3044\u305f\u3089\u30d5\u30a9\u30ed\u30fc\u5bfe\u8c61\n                        if(usertags[mytag]){\n                            followUsers.push(param);\n                            break;\n                        }\n                    }                            \n\n                    return Promise.resolve();\n                }).catch(function(err){\n                    console.log(\"err:\",err);\n                    return Promise.reject(err);\n                });\n            });\n        }, Promise.resolve());\n\n\n    })\n    .then(function(){\n        console.log(\"followUsers:\",followUsers);\n\n        return followUsers.reduce(function (promise, param) {\n            return promise.then(function () {\n                return follow(param.id).then(function(data){\n                    try{\n                        if(isJSON(data)){\n                            var datas = JSON.parse(data);\n                            // 1\u6642\u95931000\u30ea\u30af\u30a8\u30b9\u30c8\u4e0a\u9650\u8d85\u3048\u305f\n                            if(datas.type === 'rate_limit_exceeded'){\n                                throw new Error(datas.message);\n                            }\n                            if(datas.type === 'forbidden'){\n                                console.log(\"\u3059\u3067\u306b\u30d5\u30a9\u30ed\u30fc\u6e08\u307f:\",param.id);   \n                            }\n                        }\n                    }catch(err){\n                    }\n                })\n                .catch(function(err){\n                    console.log(\"err:\",err);\n                    return Promise.reject(err);\n                });\n            });\n        }, Promise.resolve());\n    })\n    .then(function(){\n\n        console.log(\"------end-----\");\n        pageStart += pageSearchMax;// \u6210\u529f\u3057\u305f\u3089\u6b21\u306e\u691c\u7d22\u6642\u306f\u65b0\u3057\u3044\u30e6\u30fc\u30b6\u3092\u63a2\u3059\n        console.log(\"pageStart:\",pageStart);\n    })   \n    .catch(function(err){\n        console.log(\"------err-----\");\n        console.log(\"err:\",err);\n    });\n}\n\n\n\n/////////////////// cron\u306b\u3088\u308b\u5b9a\u671f\u5b9f\u884c //////////////////////\n\nvar cronJob = require('cron').CronJob;\n\n// \u6bce\u6642\u9593\u5b9f\u884c\nvar cronTime = \"0 0 * * * *\";\n\n// \u4e00\u5ea6\u3060\u3051\u5b9f\u884c\u3057\u305f\u3044\u5834\u5408\u3001Date\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3067\u6307\u5b9a\u3082\u53ef\u80fd\n// var cronTime = new Date();\n\nvar job = new cronJob({\n    //\u5b9f\u884c\u3057\u305f\u3044\u65e5\u6642 or crontab\u66f8\u5f0f\n    cronTime: cronTime,\n\n    //\u6307\u5b9a\u6642\u306b\u5b9f\u884c\u3057\u305f\u3044\u95a2\u6570\n    onTick: function() {\n        console.log('---------------- Cron Call --------------------');\n        followQiitaUsers();\n    },\n\n    //\u30b8\u30e7\u30d6\u306e\u5b8c\u4e86\u307e\u305f\u306f\u505c\u6b62\u6642\u306b\u5b9f\u884c\u3059\u308b\u95a2\u6570 \n    onComplete: function() {\n        console.log('onComplete!');\n    },\n\n    // \u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u3092\u7d42\u3059\u308b\u524d\u306b\u30b8\u30e7\u30d6\u3092\u958b\u59cb\u3059\u308b\u304b\u3069\u3046\u304b\n    start: false,\n\n    //\u30bf\u30a4\u30e0\u30be\u30fc\u30f3\n    timeZone: \"Asia/Tokyo\"\n});\n\n//\u30b8\u30e7\u30d6\u958b\u59cb\njob.start();\n//\u30b8\u30e7\u30d6\u505c\u6b62\n//job.stop();\n\n// \u30c6\u30b9\u30c8\n//followQiitaUsers();\n\n\n\npackage.json\u3068qiitaFollower.js\u3092\u540c\u30d5\u30a9\u30eb\u30c0\u306b\u5165\u308c\u3066\n\u4e0b\u8a18\u30b3\u30de\u30f3\u30c9\u3067\u5b9f\u884c\u3067\u304d\u307e\u3059\u308b\uff08\u307e\u3041\u3001NodeJS\u3084\u3063\u3066\u308b\u4eba\u3060\u3063\u305f\u3089\u308f\u304b\u308a\u307e\u3059\u308f\u306d\u30fb\u30fb\u30fb\uff09\n$npm install\n$node qiitaFollower.js\n\n\u30b5\u30fc\u30d0\u306b\u8a2d\u7f6e\u3057\u3066\u304a\u304f\u3068\u52dd\u624b\u306b\u30d5\u30a9\u30ed\u30fc\u3057\u3066\u304f\u308c\u3066\u5e78\u305b\u306b\u306a\u308c\u308b\u304b\u3082\napp.js\u3068\u304b\u3067require\u3059\u308b\u3060\u3051\u3067\u8a2d\u7f6e\u3067\u304d\u307e\u3059\u3002\n\napp.js\nrequire(\"./qiitaFollower\");\n\n\n\n\u6539\u826f\u6848\uff1f\n\u6295\u7a3f\u5185\u5bb9\u3082\u53d6\u5f97\u3067\u304d\u308b\u306e\u3067\u3001\n\u7279\u5b9a\u306e\u6295\u7a3f\u5185\u5bb9\u306b\u53cd\u5fdc\u3057\u3066\u30d5\u30a9\u30ed\u30fc\u5bfe\u8c61\u3068\u898b\u306a\u3057\u3066\u3082\u3044\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\u4ed6\u306b\u3082\u30d5\u30a9\u30ed\u30fc\u30e6\u30fc\u30b6\u304c\u4f55\u304b\u3057\u3089\u6295\u7a3f\u3057\u305f\u3089\u8cd1\u3084\u304b\u3057\u306b\u3044\u3044\u306d\u3057\u305f\u308a\u81ea\u52d5\u30b3\u30e1\u30f3\u30c8(\u3084\u3081\u308c)\u3057\u305f\u308a\u3068\u304b\n\n\u3042\u308c\u3047\u30fb\u30fb\u30fb\uff1f\n/api/v2/users\u3068\u3044\u3046\u5168\u30e6\u30fc\u30b6\u53d6\u5f97\u306eAPI\u304c\u3042\u308b\u306e\u3067\u3059\u304c\npage=100\nper_page=100\n\u304f\u3089\u3044\u3067Bad Request\u3068\u306a\u308a\u3001\u30a8\u30e9\u30fc\u3068\u306a\u308a\u307e\u3057\u305f\u3002\n\uff08\u3068\u3044\u3046\u3053\u3068\u306f\uff11\u4e07\u4eba\u304f\u3089\u3044\u3057\u304b\u53d6\u5f97\u3067\u304d\u306a\u3044\u3068\u3044\u3046\u3053\u3068\u306b\u30fb\u30fb\u30fb\uff09\n\n\u4f59\u8ac7\n\u3053\u306e\u8a18\u4e8b\u898b\u3066\u30d5\u30a9\u30ed\u30fc\u8fd4\u3057\u9802\u3051\u308c\u3070\u3001\u6ce3\u3044\u3066\u559c\u3073\u307e\u3059\u3002\n\u95a2\u4fc2\u306a\u3044\u3067\u3059\u304c\u571f\u65e5\u306f\u7279\u306b\u7528\u304c\u306a\u304f\u3068\u3082\u79cb\u8449\u539f\u3068\u304b\u3067\u30d6\u30e9\u30d6\u30e9\u3057\u3066\u305f\u308a\u3057\u307e\u3059\u3002\n\u79cb\u8449\u539f\u3067\u50d5\u3068\u63e1\u624b\n# \u72ec\u308a\u307c\u3063\u3061\u306f\u3001\u5bc2\u3057\u3044\u3082\u3093\u306a\u30fb\u30fb\u30fb\n\u6700\u8fd1\u7d76\u8cdb\u307c\u3063\u3061\u6e80\u55ab\u3057\u3066\u307e\u3059\u3002\n\u6700\u8fd1\u306f\u307c\u3063\u3061\u904e\u304e\u3066\u3001\u307c\u3063\u3061\u751f\u6d3b\u3092\u5145\u5b9f\u3059\u308b\u307c\u3063\u3061\u5145\u3068\u3044\u3046\u30ef\u30fc\u30c9\u304c\u3042\u308b\u3088\u3046\u3067\u3059\u3002\n\u3061\u306a\u307f\u306b\u5225\u30ef\u30fc\u30c9\u306b\u30bd\u30ed\u5145\u3068\u3044\u3046\u3082\u306e\u304c\u3042\u308b\u3089\u3057\u3044\u306e\u3067\u3059\u304c\u3001\n\u3053\u3061\u3089\u306f\u53cb\u9054\u304c\u3044\u308b\u3051\u3069\u4e00\u4eba\u884c\u52d5\u3059\u308b\u4eba\u305f\u3061\u306e\u3053\u3068\u3089\u3057\u3044\u3067\u3059\u3002\n\uff08~~\u53cb\u9054\u3044\u308b\u306e\u306b\u5358\u72ec\u884c\u52d5\u3059\u308b\u3068\u304b\u307c\u3063\u3061\u306e\u6575~~\uff09\n\n\u6c7a\u3057\u3066\u30fb\u30fb\u30fb\u5bc2\u3057\u304f\u306a\u3093\u3066\u306a\u3044\u3093\u3060\u304b\u3089\u306d\uff01\n\n# Qiita\u3067\u4ef2\u9593\uff08\u4f3c\u305f\u3088\u3046\u306a\u601d\u8003\u306e\u4eba\uff09\u3092\u63a2\u3059\n~~\u305d\u3082\u305d\u3082Qiita\u3067\u63a2\u3059\u306a\u3068\u3044\u3046\u8a71\u3067\u3059\u304c~~\n\u305d\u3093\u306a\u308f\u3051\u3067[Qiita API](https://qiita.com/api/v2/docs)\u306a\u308b\u3082\u306e\u304c\u3042\u308b\u3088\u3046\u306a\u306e\u3067\nQiita\u6295\u7a3f\u8a18\u4e8b\u304b\u3089\u81ea\u5206\u306e\u6295\u7a3f\u3068\u4f3c\u305f\u3088\u3046\u306a\u6295\u7a3f\u3092\u3059\u308b\u4eba\u3092\n\u30d5\u30a9\u30ed\u30fc\u3059\u308b\u3068\u3044\u3046~~\u306f\u305f\u8ff7\u60d1\u306a~~\u4fbf\u5229\u306a\u6a5f\u80fd\u3092\u4f5c\u3063\u3066\u307f\u307e\u3057\u305f\u3002\n\u6b21\u306e\u3088\u3046\u306a\u6d41\u308c\u3067\u30d5\u30a9\u30ed\u30fc\u5bfe\u8c61\u3092\u63a2\u3057\u307e\u3059\u3002\n\n1. \u81ea\u5206\u306e\u6295\u7a3f\u5185\u5bb9\u304b\u3089\u30bf\u30b0\u62bd\u51fa\n2. \u30e6\u30fc\u30b6\u3092\u63a2\u3059\n3. \u6295\u7a3f\u306a\u3057\u306e\u30e6\u30fc\u30b6\u306f\u30b9\u30ad\u30c3\u30d7\n4. \u30e6\u30fc\u30b6\u306e\u6295\u7a3f\u3092\u53d6\u5f97\n5. \u81ea\u5206\u3068\u540c\u3058\u30bf\u30b0\u3092\u3064\u3051\u3066\u308b\u6295\u7a3f\u304c\u3042\u308b\u30e6\u30fc\u30b6\u306a\u3089\u30d5\u30a9\u30ed\u30fc\n6. \uff11\u301c\uff15\u3092\uff11\u6642\u9593\u304a\u304d\u306b\uff11\uff10\uff10\uff10\u30ea\u30af\u30a8\u30b9\u30c8\u4e0a\u9650\u8d85\u3048\u306a\u3044\u3088\u3046\u306bcron\u3067\u547c\u3073\u51fa\u3057\n\n# \u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\nNodeJS\u3067\u5b9f\u88c5\u3057\u3066\u3044\u307e\u3059\u3002\ncron\u3092\u4f7f\u3063\u3066\u3044\u308b\u306e\u3067cron,time\u30e2\u30b8\u30e5\u30fc\u30eb\u306f\u5fc5\u8981\u3067\u3059\u3002\n\n```package.json\n{\n  \"name\": \"qiita\",\n  \"version\": \"1.0.0\",\n  \"description\": \"\",\n  \"main\": \"index.js\",\n  \"scripts\": {\n    \"test\": \"echo \\\"Error: no test specified\\\" && exit 1\"\n  },\n  \"author\": \"\",\n  \"license\": \"ISC\",\n  \"dependencies\": {\n    \"cron\": \"^1.1.0\",\n    \"time\": \"^0.11.4\"\n  }\n}\n```\n\n\u30bd\u30fc\u30b9\u672c\u4f53\u3067\u3059\u3002\u30af\u30fc\u30ed\u30f3\u306b\u3088\u308a\u3001\u6bce\u6642\uff08x\u6642\uff10\u5206\uff10\u79d2\uff09\u306b\u5b9a\u671f\u5b9f\u884c\u3055\u308c\u307e\u3059\u3002\nQiita\u30c8\u30fc\u30af\u30f3\u306f\u3054\u81ea\u5206\u306eQiita\u30a2\u30ab\u30a6\u30f3\u30c8\u306e\u3082\u306e\u306b\u5dee\u3057\u66ff\u3048\u3066\u304f\u3060\u3055\u3044\u3002\n\n```qiitaFollower.js\nvar http = require('http');\nvar querystring = require('querystring');\n\n// qiita\u8a8d\u8a3c\u30c8\u30fc\u30af\u30f3\nvar token = '<Qiita\u30c8\u30fc\u30af\u30f3>';\n\n// search\nvar pageStart = 0;\n// \u691c\u7d22\u30da\u30fc\u30b8\u6570\u4e0a\u9650\nvar pageSearchMax = 50;\n\nvar isJSON = function(arg) {\n    arg = (typeof arg === \"function\") ? arg() : arg;\n    if (typeof arg  !== \"string\") {\n        return false;\n    }\n    try {\n        arg = (!JSON) ? eval(\"(\" + arg + \")\") : JSON.parse(arg);\n        return true;\n    } catch (e) {\n        return false;\n    }\n};\n\nfunction qiitaAPI(api,method,callback){\n    \n\n    var options = {\n        hostname: 'qiita.com',\n        port: 80,\n        path: api,\n        method: method,\n        headers: {\n            'Content-Type': 'application/json',\n            'Authorization': 'Bearer ' + token\n        }\n    };\n\n    \n    setTimeout(function(){\n        var req = http.request(options, function (res) {\n\n            var body = '';\n            res.setEncoding('utf8');\n\n            res.on('data', function (chunk) {\n                body += chunk;\n            });\n\n            res.on('end', function () {\n                callback(null,body);\n            });\n\n        }).on('error', function (e) {\n            console.log(e);\n            callback(e,null);\n        });\n\n        //req.write('');\n        req.end();\n    }, 500);    // Qiita\u30b5\u30fc\u30d0\u306b\u8ca0\u8377\u304b\u3051\u3059\u304e\u306a\u3044\n\n}\n\n\n// \u81ea\u5206\u306e\u6295\u7a3f\u3092\u53d6\u5f97\nfunction myposts() {\n    var deferred = Promise.defer();\n\n    var path = '/api/v2/authenticated_user/items';\n\n    path += '?' + querystring.stringify({\n        'page': 1,\n        'per_page': 100,\n    });\n\n    \n    // \u975e\u540c\u671f\u95a2\u6570 \n    qiitaAPI(path,'GET', function(err, data){\n       if (err) {\n         return deferred.reject(err); // .catch\n       }\n       deferred.resolve(data); // then\n    });\n    \n    return deferred.promise; \n}\n\n\n\n// \u30e6\u30fc\u30b6\u53d6\u5f97\nfunction users(page) {\n    var deferred = Promise.defer();\n\n    var path = '/api/v2/users';\n\n    path += '?' + querystring.stringify({\n        'page': page,\n        'per_page': 100,\n    });\n    \n    // \u975e\u540c\u671f\u95a2\u6570 \n    qiitaAPI(path,'GET', function(err, data){\n       if (err) {\n         return deferred.reject(err); // .catch\n       }\n       deferred.resolve(data); // then\n    });\n    \n    return deferred.promise; \n}\n\n\n\n// \u30e6\u30fc\u30b6\u306e\u6295\u7a3f\u3092\u53d6\u5f97\nfunction userpost(id) {\n    var deferred = Promise.defer();\n\n    var path = '/api/v2/users/' + id + '/items';\n\n    path += '?' + querystring.stringify({\n        'page': 1,\n        'per_page': 100,\n    });\n\n    qiitaAPI(path,'GET',function(err,data){\n        if(err !== null){\n            return deferred.reject(err); \n        }\n        deferred.resolve(data); \n    });\n    \n    return deferred.promise; \n}\n\n// Qiita\u30e6\u30fc\u30b6\u3092\u30d5\u30a9\u30ed\u30fc\nfunction follow(id) {\n    var deferred = Promise.defer();\n\n    var path = '/api/v2/users/' + id + '/following';\n    console.log(\"path:\",path);\n\n    // \u975e\u540c\u671f\u95a2\u6570 \n    qiitaAPI(path,'PUT', function(err, data){\n        if (err) {\n            return deferred.reject(err); // .catch\n        }\n        deferred.resolve(data); // then\n    });\n\n    return deferred.promise; \n}\n\nfunction followQiitaUsers(){\n    // \u81ea\u5206\u306e\u6295\u7a3f\u306e\u30bf\u30b0\n    var mytags = {};\n    // \u30e6\u30fc\u30b6\n    var findusers = [];\n    // \u30d5\u30a9\u30ed\u30fc\u30e6\u30fc\u30b6\n    var followUsers = [];\n\n    // \u81ea\u5206\u306e\u6295\u7a3f\u53d6\u5f97\n    myposts()\n    .then(function (data) {\n\n\n        // \u81ea\u5206\u306e\u6295\u7a3f\u8a18\u4e8b\u306e\u30bf\u30b0\u3092\u53d6\u5f97\n        var datas = JSON.parse(data);\n        \n        // 1\u6642\u95931000\u30ea\u30af\u30a8\u30b9\u30c8\u4e0a\u9650\u8d85\u3048\u305f\n        if(datas.type === 'rate_limit_exceeded'){\n            throw new Error(datas.message);\n        }\n        \n        for(var i=0;i<datas.length;++i){\n            var tags = datas[i].tags;\n            for(var j=0;j<tags.length;++j){\n                mytags[tags[j].name] = tags[j].name;\n            }\n\n        }   \n        console.log(\"mytags:\",mytags);\n\n\n        var pages = [];\n        for(var i=pageStart;i<pageStart+pageSearchMax;++i){\n            pages.push(i);\n        }\n\n        // \u4ed6\u306e\u30e6\u30fc\u30b6\u60c5\u5831\u53d6\u5f97\n        return pages.reduce(function (promise, param) {\n            return promise.then(function () {\n                return users(param).then(function(data){\n                    var datas = JSON.parse(data);\n                    // 1\u6642\u95931000\u30ea\u30af\u30a8\u30b9\u30c8\u4e0a\u9650\u8d85\u3048\u305f\n                    if(datas.type === 'rate_limit_exceeded'){\n                        throw new Error(datas.message);\n                    }\n                    console.log(\"user page\",i,\":\",datas);\n\n                    Array.prototype.push.apply(findusers,datas);\n                });\n            });\n        }, Promise.resolve());\n\n    })\n    .then(function(){\n\n\n        var users = [];\n        for(var i=0;i<findusers.length;++i){\n            var id = findusers[i].id;\n            var items_count = findusers[i].items_count;\n            // \u30d7\u30ed\u30d5\u30a3\u30fc\u30eb\u753b\u50cf\n            var profile_image_url =  findusers[i].profile_image_url;\n            // \u30db\u30fc\u30e0\u30da\u30fc\u30b8\n            var website_url = findusers[i].website_url;\n            // \u6295\u7a3f\u304c\u3042\u308b\u4eba\u9650\u5b9a\n            if(items_count > 0){\n                users.push({id:id,image:profile_image_url,homepage:website_url});\n            }\n        }\n        console.log(\"users:\",users);\n\n\n        // \u30e6\u30fc\u30b6\u6295\u7a3f\u60c5\u5831\u53d6\u5f97\n        return users.reduce(function (promise, param) {\n            return promise.then(function () {\n                return userpost(param.id).then(function(data){\n                    var datas = JSON.parse(data);\n                    // 1\u6642\u95931000\u30ea\u30af\u30a8\u30b9\u30c8\u4e0a\u9650\u8d85\u3048\u305f\n                    if(datas.type === 'rate_limit_exceeded'){\n                        throw new Error(datas.message);\n                    }                    \n                    \n                    console.log(\"user id:\",param.id);\n                    var usertags = [];\n                    // \u30e6\u30fc\u30b6\u306e\u6295\u7a3f\u5185\u5bb9\u53d6\u5f97\n                    for(var i=0;i<datas.length;++i){\n                        var tags = datas[i].tags;\n                        for(var j=0;j<tags.length;++j){\n                            usertags[tags[j].name] = tags[j].name;\n                        }\n                        console.log(\"title:\",datas[i].title);\n                    }   \n                    console.log(\"usertags:\",usertags);\n\n                    // \u81ea\u5206\u3068\u540c\u3058\u6295\u7a3f\u30bf\u30b0\u3092\u6301\u3063\u3066\u3044\u308b\u304b\uff1f\n                    for(var mytag in mytags){\n                        // \u6301\u3063\u3066\u3044\u305f\u3089\u30d5\u30a9\u30ed\u30fc\u5bfe\u8c61\n                        if(usertags[mytag]){\n                            followUsers.push(param);\n                            break;\n                        }\n                    }                            \n\n                    return Promise.resolve();\n                }).catch(function(err){\n                    console.log(\"err:\",err);\n                    return Promise.reject(err);\n                });\n            });\n        }, Promise.resolve());\n\n\n    })\n    .then(function(){\n        console.log(\"followUsers:\",followUsers);\n\n        return followUsers.reduce(function (promise, param) {\n            return promise.then(function () {\n                return follow(param.id).then(function(data){\n                    try{\n                        if(isJSON(data)){\n                            var datas = JSON.parse(data);\n                            // 1\u6642\u95931000\u30ea\u30af\u30a8\u30b9\u30c8\u4e0a\u9650\u8d85\u3048\u305f\n                            if(datas.type === 'rate_limit_exceeded'){\n                                throw new Error(datas.message);\n                            }\n                            if(datas.type === 'forbidden'){\n                                console.log(\"\u3059\u3067\u306b\u30d5\u30a9\u30ed\u30fc\u6e08\u307f:\",param.id);   \n                            }\n                        }\n                    }catch(err){\n                    }\n                })\n                .catch(function(err){\n                    console.log(\"err:\",err);\n                    return Promise.reject(err);\n                });\n            });\n        }, Promise.resolve());\n    })\n    .then(function(){\n\n        console.log(\"------end-----\");\n        pageStart += pageSearchMax;// \u6210\u529f\u3057\u305f\u3089\u6b21\u306e\u691c\u7d22\u6642\u306f\u65b0\u3057\u3044\u30e6\u30fc\u30b6\u3092\u63a2\u3059\n        console.log(\"pageStart:\",pageStart);\n    })   \n    .catch(function(err){\n        console.log(\"------err-----\");\n        console.log(\"err:\",err);\n    });\n}\n\n\n\n/////////////////// cron\u306b\u3088\u308b\u5b9a\u671f\u5b9f\u884c //////////////////////\n\nvar cronJob = require('cron').CronJob;\n\n// \u6bce\u6642\u9593\u5b9f\u884c\nvar cronTime = \"0 0 * * * *\";\n\n// \u4e00\u5ea6\u3060\u3051\u5b9f\u884c\u3057\u305f\u3044\u5834\u5408\u3001Date\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3067\u6307\u5b9a\u3082\u53ef\u80fd\n// var cronTime = new Date();\n\nvar job = new cronJob({\n    //\u5b9f\u884c\u3057\u305f\u3044\u65e5\u6642 or crontab\u66f8\u5f0f\n    cronTime: cronTime,\n\n    //\u6307\u5b9a\u6642\u306b\u5b9f\u884c\u3057\u305f\u3044\u95a2\u6570\n    onTick: function() {\n        console.log('---------------- Cron Call --------------------');\n        followQiitaUsers();\n    },\n\n    //\u30b8\u30e7\u30d6\u306e\u5b8c\u4e86\u307e\u305f\u306f\u505c\u6b62\u6642\u306b\u5b9f\u884c\u3059\u308b\u95a2\u6570 \n    onComplete: function() {\n        console.log('onComplete!');\n    },\n\n    // \u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u3092\u7d42\u3059\u308b\u524d\u306b\u30b8\u30e7\u30d6\u3092\u958b\u59cb\u3059\u308b\u304b\u3069\u3046\u304b\n    start: false,\n\n    //\u30bf\u30a4\u30e0\u30be\u30fc\u30f3\n    timeZone: \"Asia/Tokyo\"\n});\n\n//\u30b8\u30e7\u30d6\u958b\u59cb\njob.start();\n//\u30b8\u30e7\u30d6\u505c\u6b62\n//job.stop();\n\n// \u30c6\u30b9\u30c8\n//followQiitaUsers();\n\n```\n\npackage.json\u3068qiitaFollower.js\u3092\u540c\u30d5\u30a9\u30eb\u30c0\u306b\u5165\u308c\u3066\n\u4e0b\u8a18\u30b3\u30de\u30f3\u30c9\u3067\u5b9f\u884c\u3067\u304d\u307e\u3059\u308b\uff08\u307e\u3041\u3001NodeJS\u3084\u3063\u3066\u308b\u4eba\u3060\u3063\u305f\u3089\u308f\u304b\u308a\u307e\u3059\u308f\u306d\u30fb\u30fb\u30fb\uff09\n\n```\n$npm install\n$node qiitaFollower.js\n```\n\n\u30b5\u30fc\u30d0\u306b\u8a2d\u7f6e\u3057\u3066\u304a\u304f\u3068\u52dd\u624b\u306b\u30d5\u30a9\u30ed\u30fc\u3057\u3066\u304f\u308c\u3066\u5e78\u305b\u306b\u306a\u308c\u308b\u304b\u3082\napp.js\u3068\u304b\u3067require\u3059\u308b\u3060\u3051\u3067\u8a2d\u7f6e\u3067\u304d\u307e\u3059\u3002\n\n```app.js\nrequire(\"./qiitaFollower\");\n```\n\n# \u6539\u826f\u6848\uff1f\n\u6295\u7a3f\u5185\u5bb9\u3082\u53d6\u5f97\u3067\u304d\u308b\u306e\u3067\u3001\n\u7279\u5b9a\u306e\u6295\u7a3f\u5185\u5bb9\u306b\u53cd\u5fdc\u3057\u3066\u30d5\u30a9\u30ed\u30fc\u5bfe\u8c61\u3068\u898b\u306a\u3057\u3066\u3082\u3044\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\u4ed6\u306b\u3082\u30d5\u30a9\u30ed\u30fc\u30e6\u30fc\u30b6\u304c\u4f55\u304b\u3057\u3089\u6295\u7a3f\u3057\u305f\u3089\u8cd1\u3084\u304b\u3057\u306b\u3044\u3044\u306d\u3057\u305f\u308a~~\u81ea\u52d5\u30b3\u30e1\u30f3\u30c8(\u3084\u3081\u308c)\u3057\u305f\u308a~~\u3068\u304b\n\n# \u3042\u308c\u3047\u30fb\u30fb\u30fb\uff1f\n/api/v2/users\u3068\u3044\u3046\u5168\u30e6\u30fc\u30b6\u53d6\u5f97\u306eAPI\u304c\u3042\u308b\u306e\u3067\u3059\u304c\npage=100\nper_page=100\n\u304f\u3089\u3044\u3067Bad Request\u3068\u306a\u308a\u3001\u30a8\u30e9\u30fc\u3068\u306a\u308a\u307e\u3057\u305f\u3002\n\uff08\u3068\u3044\u3046\u3053\u3068\u306f\uff11\u4e07\u4eba\u304f\u3089\u3044\u3057\u304b\u53d6\u5f97\u3067\u304d\u306a\u3044\u3068\u3044\u3046\u3053\u3068\u306b\u30fb\u30fb\u30fb\uff09\n\n# \u4f59\u8ac7\n\u3053\u306e\u8a18\u4e8b\u898b\u3066\u30d5\u30a9\u30ed\u30fc\u8fd4\u3057\u9802\u3051\u308c\u3070\u3001\u6ce3\u3044\u3066\u559c\u3073\u307e\u3059\u3002\n\u95a2\u4fc2\u306a\u3044\u3067\u3059\u304c\u571f\u65e5\u306f\u7279\u306b\u7528\u304c\u306a\u304f\u3068\u3082\u79cb\u8449\u539f\u3068\u304b\u3067\u30d6\u30e9\u30d6\u30e9\u3057\u3066\u305f\u308a\u3057\u307e\u3059\u3002\n~~\u79cb\u8449\u539f\u3067\u50d5\u3068\u63e1\u624b~~\n\n", "tags": ["Qiita", "JavaScript", "nodejs"]}