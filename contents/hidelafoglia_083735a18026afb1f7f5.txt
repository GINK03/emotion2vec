{"context": " More than 1 year has passed since last update.\n\nmacro.conf\n<Macro App $appname $port $base >\n    # Gunicorn \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092 /$appname \u306e apache Loction\u3067\u53d7\u3051\u308b\n    <Location /$appname/ >\n      ProxyPass http://127.0.0.1:$port/$appname/\n      ProxyPassReverse http://127.0.0.1:$port/$appname/\n\n      # Gunicorn \u30a2\u30d7\u30ea\u306b SCRIPT_NAME \u3092\u6e21\u3059\n      RequestHeader set SCRIPT_NAME /$appname\n\n    # RequestHeader set X-FORWARDED-SSL \"on\"\n    # RequestHeader set X-FORWARDED_PROTO \"https\"\n    </Location>\n\n    # Django /$appname/static \u30d5\u30a1\u30a4\u30eb\u306f\u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\u3057\u306a\u3044\n    <Location /$appname/static/ >\n        ProxyPass !\n    </Location>\n\n    # /$appname/static \u3092apache\u3067\u914d\u4fe1\u3055\u305b\u308b\n    Alias /$appname/static $base/web/static\n\n</Macro>\n\n\n<Macro Site $base>\n # \u30b5\u30a4\u30c8\u5168\u4f53\u306e\u5b9a\u7fa9\n ServerAdmin admin@you.com\n\n ProxyPreserveHost On\n\n LogLevel warn\n ErrorLog  $base/web/etc/apache2/logs/apache.error.log\n CustomLog $base/web/etc/apache2/logs/apache.access.log combined\n\n <Location / >\n    Require all granted\n </Location>\n</Macro>\n\n<Macro Certs $site>\n# \u8a3c\u660e\u66f8\u95a2\u9023 : /etc/apache/ssl/$site \u306b\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u4f5c\u3063\u3066\u304a\u304f\u3068\u304b\nSSLEngine on\nSSLCACertificateFile /etc/apache2/ssl/$site/ca.cert.pem\nSSLCertificateFile /etc/apache2/ssl/$site/cert.pem\nSSLCertificateKeyFile  /etc/apache2/ssl/$site/key.pem\n</Macro>\n\n\nyou.com.conf\n\n\u5148\u306b macro.conf \u304c\u8aad\u307f\u8fbc\u307e\u308c\u3066\u3044\u308b\u3053\u3068\nsudo a2enmod macro proxy proxy_http rewrite headers\n\n<VirtualHost *:80>\n   ServerName   https://you.com\n   ServerAlias  you.com\n   RewriteCond %{HTTPS} off\n\n   Use Site /home/vagrant/projects/yoursite\n\n    # \u3053\u3053\u304b\u3089gunicorn\u30a2\u30d7\u30ea\u3054\u3068\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\n   Include sites-enabled/app1.inc\n   Include sites-enabled/app2.inc\n</VirtualHost>\n\n<VirtualHost *:443>\n    ServerName   https://you.com\n    ServerAlias  you.com\n    SetEnv HTTPS ON\n\n    Use Certs you.com\n    Use Site /home/vagrant/projects/yoursite\n\n    RequestHeader set X-FORWARDED-SSL \"on\"\n    RequestHeader set X-FORWARDED_PROTO \"https\"\n\n    # \u3053\u3053\u304b\u3089gunicorn\u30a2\u30d7\u30ea\u3054\u3068\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\n   Include sites-enabled/app1.inc\n   Include sites-enabled/app2.inc\n</VirtualHost>\n\n\n$appname.inc\n\n\u305f\u3068\u3048\u3070 app1.inc\nTCP9000\u3067 gunicorn\u3067\u53d7\u3051\u308b\n/etc/apache2/sites-enabled\u306b\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3057\u3066\u304a\u304f\n\nUse App app1 9000 /home/vagrant/projects/yoursite/app1\n\n\ngunicorn\u30a2\u30d7\u30ea\n\nsupervisord.conf.d/app1.ini \u3068\u304b\n\n[program:app1]\n\ncommand=/home/vagrant/.anyenv/envs/pyenv/versions/wordpress/bin/gunicorn -c /home/vagrant/projects/yoursite/web/app/gunicorn.py app.wsgi:application  -b 127.0.0.1:9000\nuser=vagrant\nautostart=true\nautorestart=true\nredirect_stderr=true\nprocess_name=app1\n\n\ndjango \u3067SCRIPT_NAME\u306e\u5bfe\u5fdc\n\n\u30df\u30c9\u30eb\u30a6\u30a8\u30a2\u3067settings\u306b\u30d1\u30c3\u30c1\u3059\u308b\nsettings.py\n\nMIDDLEWARE_CLASSES += (\n    'app.middleware.SettingsMiddleware',   \n)\n\n\nmiddleware.py\n\nfrom django.conf import settings\n\nURLS = [\n    'STATIC_URL',\n    'LOGIN_URL',\n    'LOGOUT_URL',\n    'LOGIN_REDIRECT_URL', ]\n\n\nclass SettingsMiddleware(object):\n    def process_request(self, request):\n        prefix = request.META.get('SCRIPT_NAME')\n\n        if prefix:\n            for i in URLS:\n                val = getattr(settings, i, None)\n                if val and not val.startswith(prefix):\n                    setattr(settings, i, prefix + val)\n\n\n## macro.conf\n\n~~~xml\n<Macro App $appname $port $base >\n\t# Gunicorn \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092 /$appname \u306e apache Loction\u3067\u53d7\u3051\u308b\n    <Location /$appname/ >\n      ProxyPass http://127.0.0.1:$port/$appname/\n      ProxyPassReverse http://127.0.0.1:$port/$appname/\n\n\t  # Gunicorn \u30a2\u30d7\u30ea\u306b SCRIPT_NAME \u3092\u6e21\u3059\n      RequestHeader set SCRIPT_NAME /$appname\n\n    # RequestHeader set X-FORWARDED-SSL \"on\"\n    # RequestHeader set X-FORWARDED_PROTO \"https\"\n    </Location>\n\n\t# Django /$appname/static \u30d5\u30a1\u30a4\u30eb\u306f\u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\u3057\u306a\u3044\n    <Location /$appname/static/ >\n        ProxyPass !\n    </Location>\n\n\t# /$appname/static \u3092apache\u3067\u914d\u4fe1\u3055\u305b\u308b\n    Alias /$appname/static $base/web/static\n\n</Macro>\n\n\n<Macro Site $base>\n # \u30b5\u30a4\u30c8\u5168\u4f53\u306e\u5b9a\u7fa9\n ServerAdmin admin@you.com\n\n ProxyPreserveHost On\n\n LogLevel warn\n ErrorLog  $base/web/etc/apache2/logs/apache.error.log\n CustomLog $base/web/etc/apache2/logs/apache.access.log combined\n\n <Location / >\n    Require all granted\n </Location>\n</Macro>\n\n<Macro Certs $site>\n# \u8a3c\u660e\u66f8\u95a2\u9023 : /etc/apache/ssl/$site \u306b\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u4f5c\u3063\u3066\u304a\u304f\u3068\u304b\nSSLEngine on\nSSLCACertificateFile /etc/apache2/ssl/$site/ca.cert.pem\nSSLCertificateFile /etc/apache2/ssl/$site/cert.pem\nSSLCertificateKeyFile  /etc/apache2/ssl/$site/key.pem\n</Macro>\n~~~\n\n# you.com.conf\n\n- \u5148\u306b macro.conf \u304c\u8aad\u307f\u8fbc\u307e\u308c\u3066\u3044\u308b\u3053\u3068\n- ` sudo a2enmod macro proxy proxy_http rewrite headers`\n\n~~~xml\n<VirtualHost *:80>\n   ServerName   https://you.com\n   ServerAlias  you.com\n   RewriteCond %{HTTPS} off\n\n   Use Site /home/vagrant/projects/yoursite\n   \n\t# \u3053\u3053\u304b\u3089gunicorn\u30a2\u30d7\u30ea\u3054\u3068\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\n   Include sites-enabled/app1.inc\n   Include sites-enabled/app2.inc\n</VirtualHost>\n\n<VirtualHost *:443>\n    ServerName   https://you.com\n    ServerAlias  you.com\n    SetEnv HTTPS ON\n\n    Use Certs you.com\n    Use Site /home/vagrant/projects/yoursite\n\n    RequestHeader set X-FORWARDED-SSL \"on\"\n    RequestHeader set X-FORWARDED_PROTO \"https\"\n\n\t# \u3053\u3053\u304b\u3089gunicorn\u30a2\u30d7\u30ea\u3054\u3068\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\n   Include sites-enabled/app1.inc\n   Include sites-enabled/app2.inc\n</VirtualHost>\n~~~\n\n## $appname.inc\n\n- \u305f\u3068\u3048\u3070 app1.inc\n- TCP9000\u3067 gunicorn\u3067\u53d7\u3051\u308b\n- /etc/apache2/sites-enabled\u306b\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3057\u3066\u304a\u304f\n\n~~~\nUse App app1 9000 /home/vagrant/projects/yoursite/app1\n~~~\n\n## gunicorn\u30a2\u30d7\u30ea\n\n- supervisord.conf.d/app1.ini \u3068\u304b\n\n~~~ini\n[program:app1]\n\ncommand=/home/vagrant/.anyenv/envs/pyenv/versions/wordpress/bin/gunicorn -c /home/vagrant/projects/yoursite/web/app/gunicorn.py app.wsgi:application  -b 127.0.0.1:9000\nuser=vagrant\nautostart=true\nautorestart=true\nredirect_stderr=true\nprocess_name=app1\n~~~\n\n## django \u3067SCRIPT_NAME\u306e\u5bfe\u5fdc\n- \u30df\u30c9\u30eb\u30a6\u30a8\u30a2\u3067settings\u306b\u30d1\u30c3\u30c1\u3059\u308b\n\n- settings.py\n\n~~~py\nMIDDLEWARE_CLASSES += (\n    'app.middleware.SettingsMiddleware',   \n)\n~~~\n\n- middleware.py\n\n~~~py\nfrom django.conf import settings\n\nURLS = [\n    'STATIC_URL',\n    'LOGIN_URL',\n    'LOGOUT_URL',\n    'LOGIN_REDIRECT_URL', ]\n\n\nclass SettingsMiddleware(object):\n    def process_request(self, request):\n        prefix = request.META.get('SCRIPT_NAME')\n\n        if prefix:\n            for i in URLS:\n                val = getattr(settings, i, None)\n                if val and not val.startswith(prefix):\n                    setattr(settings, i, prefix + val)\n~~~                    \n", "tags": ["Django", "Apache", "gunicorn"]}