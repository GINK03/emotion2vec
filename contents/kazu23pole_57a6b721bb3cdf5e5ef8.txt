{"context": "AWS\u306e\u30ed\u30b0\uff08ELB, CloudFront, CloudTrail\uff09\u3092S3\u306b\u4fdd\u5b58\u3057\u3001Athena\u3067\u96c6\u8a08\u3057\u3066\u307f\u307e\u3057\u305f\u3002\nDDL\u5b9a\u7fa9\u3082\u8f09\u305b\u3066\u3044\u307e\u3059\u3002\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u8a18\u8f09\u306e\u3082\u306e\u3068\u306f\u7570\u306a\u308a\u3001\u4f7f\u3044\u3084\u3059\u3044\u5f62\u306b\u5909\u66f4\u3057\u307e\u3057\u305f\u3002\n\nAthena\u6982\u8981\n\nS3\u306b\u4fdd\u7ba1\u3057\u305f\u30c7\u30fc\u30bf\u306b\u5bfe\u3057\u3066\u30af\u30a8\u30ea\u3092\u5b9f\u884c\u3067\u304d\u308b\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u8d77\u52d5\u305b\u305a\u306bS3\u306e\u30c7\u30fc\u30bf\u306b\u5bfe\u3057\u3066\u76f4\u63a5SQL\u306e\u30af\u30a8\u30ea\u5b9f\u884c\u304c\u53ef\u80fd\nANSI SQL\u3092\u30b5\u30dd\u30fc\u30c8\n\u5185\u90e8\u7684\u306b\u306fPresto\u304c\u5b9f\u884c\u3055\u308c\u3066\u3044\u308b\u305f\u3081\u3001Presto\u3067\u4f7f\u3048\u308b\u3082\u306e\u306f\u5927\u62b5\u4f7f\u3048\u308b\n\u8ab2\u91d1\u306f\u30af\u30a8\u30ea\u5358\u4f4d\u3000\uff11TB\u306b\u3064\u304d$5\n\n\n\u307e\u3060\u30d0\u30fc\u30b8\u30cb\u30a2\u3068\u30aa\u30ec\u30b4\u30f3\u3067\u3057\u304b\u4f7f\u3048\u306a\u3044\n\n\u6771\u4eac\u30ea\u30fc\u30b8\u30e7\u30f3\u3067\u306f\u307e\u3060\u4f7f\u3048\u307e\u305b\u3093\nAthena\u306fS3\u3092\u53c2\u7167\u3059\u308b\u306e\u3067\u3001Athena(\u30d0\u30fc\u30b8\u30cb\u30a2)\u2192S3(\u6771\u4eac)\u306b\u3059\u308b\u3068\u5fae\u5999\u306b\u9045\u304f\u306a\u308a\u307e\u3059\n\n\n\u3084\u3063\u3066\u307f\u308b\n\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u4f5c\u308b\n\n\u6700\u521d\u306b\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u4f5c\u308a\u307e\u3059\n\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u3084\u3064\u3067\u3082\u3044\u3044\u3067\u3059\n\n\nsample\nCREATE DATABASE aws_logs;\n\n\n\n\n\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u308b\n\nGUI\u3067\u5165\u529b\u3082\u3067\u304d\u307e\u3059\u304c\u3001SQL\u3092\u66f8\u3044\u3066\u3044\u304d\u307e\u3059\n\n\nGUI\u3067\u30c6\u30fc\u30d6\u30eb\u5b9a\u7fa9\u3092\u5165\u529b\u3059\u308b\u306e\u304c\u7d50\u69cb\u9762\u5012\u3067\u3059\n\u4ee5\u4e0b\u3001DDL\u5b9a\u7fa9\u3067\u3059\n\n\n\n\nELB\n\nELB\nCREATE EXTERNAL TABLE IF NOT EXISTS aws_logs.elb_log (\n  request_protocol string,\n  request_timestamp string,\n  elb_name string,\n  request_ip string,\n  request_port int,\n  backend_ip string,\n  backend_port int,\n  request_processing_time double,\n  backend_processing_time double,\n  client_response_time double,\n  elb_response_code string,\n  backend_response_code string,\n  received_bytes bigint,\n  sent_bytes bigint,\n  request_verb string,\n  url string,\n  protocol string,\n  user_agent string,\n  ssl_cipher string,\n  ssl_protocol string,\n  arn string,\n  extra string )\nROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.RegexSerDe'\nWITH SERDEPROPERTIES (\n    'serialization.format' = '1','input.regex' = '([^ ]*) ([^ ]*) ([^ ]*) ([^ ]*):([0-9]*) ([^ ]*):([0-9]*) (-1|[.0-9]*) (-1|[.0-9]*) (-1|[.0-9]*) (-|[0-9]*) (-|[0-9]*) ([-0-9]*) ([-0-9]*) \\\\\\\"([^ ]*) ([^ ]*) (- |[^ ]*)\\\\\\\" (\\\"[^\\\"]*\\\") ([^ ]*) ([^ ]*) ([^ ]*) ([^ ]*)$' )\nLOCATION 's3://*******/********/'\n\n\n\nCloudFront\n\ncloudfront\nCREATE EXTERNAL TABLE IF NOT EXISTS aws_logs.cloudfront_log (\n  date STRING,\n  time STRING,\n  xEdgeLocation STRING,\n  scBytes INT,\n  cIp STRING,\n  csMethod STRING,\n  csHost STRING,\n  csUriStem STRING,\n  scStatus INT,\n  csReferer STRING,\n  csUserAgent STRING,\n  csUriQuery STRING,\n  csCookie STRING,\n  xEdgeResultType STRING,\n  xEdgeRequestId STRING,\n  xHostHeader STRING,\n  csProtocol STRING,\n  csBytes INT,\n  timeTaken INT,\n  xForwardedFor STRING,\n  sslProtocol STRING,\n  sslCipher STRING,\n  xEdgeResponseResultType STRING,\n  csProtocolVersion STRING\n)\nROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.RegexSerDe'\nWITH SERDEPROPERTIES (\n  'serialization.format' = '1','input.regex' = '([^ ]*)\\t([^ ]*)\\t([^ ]*)\\t([0-9]*)\\t([.0-9]*)\\t([^ ]*)\\t([^ ]*)\\t([^ ]*)\\t([0-9]*)\\t([^ ]*)\\t([^ ]*)\\t([^ ]*)\\t([^ ]*)\\t([^ ]*)\\t([^ ]*)\\t([^ ]*)\\t([^ ]*)\\t([0-9]*)\\t([^ ]*)\\t([^ ]*)\\t([^ ]*)\\t([^ ]*)\\t([^ ]*)\\t([^ ]*)$'\n) LOCATION 's3://****/******/'\n\n\n\nCloudTrail\n\ncloudtrail\nCREATE EXTERNAL TABLE IF NOT EXISTS sample.records (\n  records ARRAY<STRUCT<eventTime:STRING,eventSource:STRING,eventName:STRING>>\n)\nROW FORMAT SERDE 'org.openx.data.jsonserde.JsonSerDe'\nWITH SERDEPROPERTIES (\n  'serialization.format' = '1'\n) LOCATION 's3://********/***/'\n\n\n\nSELECT\u3059\u308b\n\nANSI SQL\u5bfe\u5fdc\u306a\u306e\u3067\u666e\u901a\u306bSQL\u3092\u5b9f\u884c\u3057\u3066\u304f\u3060\u3055\u3044\nCloudFront\u3068CloudTrail\u3060\u3051\u6ce8\u610f\u3057\u3066\u304f\u3060\u3055\u3044\n\n\nCloudFront\u306eSELECT\u6ce8\u610f\u70b9\n\n\u4e0a\u8a18\u306eDDL\u3092\u5b9f\u884c\u3059\u308b\u3068\u4e00\u90e8\u4f55\u3082\u5165\u3063\u3066\u306a\u3044\u30ec\u30b3\u30fc\u30c9\u304c\u3067\u304d\u3042\u304c\u308a\u307e\u3059\n\n\nCloudFront\u306e\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u306f\u5148\u982d2\u884c\u306b\u30b3\u30e1\u30f3\u30c8&\u30d8\u30c3\u30c0\u30fc\u304c\u5165\u3063\u3066\u3044\u307e\u3059\n\u73fe\u72b6\u3001Athena\u3067\u306f\u3053\u308c\u3092\u9664\u3044\u3066\u53d6\u308a\u8fbc\u3080\u3053\u3068\u304c\u3067\u304d\u307e\u305b\u3093\nPresto\u3067\u4f7f\u3048\u308borg.apache.hadoop.hive.serde2.OpenCSVSerde\u304c\u4f7f\u3048\u308b\u3088\u3046\u306b\u306a\u308b\u306e\u3092\u6c17\u9577\u306b\u5f85\u3061\u307e\u3057\u3087\u3046\n\n\nselect\u3059\u308b\u969b\u306b\u306fwhere\u53e5\u3067date NOT LIKE '#%'\u3092\u6307\u5b9a\u3059\u308b\u3088\u3046\u306b\u3057\u307e\u3057\u3087\u3046\n\n\nsample-select\nSELECT count(*) \nFROM aws_logs.cloudfront_log \nWHERE date NOT LIKE '#%'\n\n\n\nCloudTrail\u306eSELECT\u6ce8\u610f\u70b9\n\nCloudTrail\u306e\u30ed\u30b0\u306fJSON\u5f62\u5f0f\u306e\u305f\u3081\u3001\u30ab\u30e9\u30e0\u3092\u5206\u3051\u308b\u3053\u3068\u304c\u96e3\u3057\u3044\u3067\u3059(\u65b9\u6cd5\u3042\u308c\u3070\u6559\u3048\u3066\u304f\u3060\u3055\u3044)\nselect\u3059\u308b\u3068\u304d\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3059\u308b\u3002\u9762\u5012\u30fb\u30fb\u30fb\n\n\nsample-trail-select\nSELECT record.eventTime\nFROM aws_logs.traillog\nCROSS JOIN unnest(records) AS t(record)\nWHERE record.eventname='ConsoleLogin' limit 10\n\n\n\nsample-trail-select2\nSELECT record\nFROM aws_logs.traillog\nCROSS JOIN unnest(records) AS t(record)\nWHERE record.eventtime LIKE '2017-02-08%' limit 10\n\n\n\n\u307e\u3068\u3081\n\nELB\u3068CloudFront\u306e\u30ed\u30b0\u3092\u6295\u5165\u3059\u308b\u3060\u3051\u3067\u30015XX\u7cfb\u30a8\u30e9\u30fc\u306a\u3069\u306e\u8abf\u67fb\u304c\u304b\u306a\u308a\u697d\u306b\u306a\u308a\u307e\u3059\nTrail\u30ed\u30b0\u306f\u3082\u3046\u4e00\u6b69\u3067\u3059\u306d\u3002\u30ad\u30ec\u30a4\u306b\u30ab\u30e9\u30e0\u3067\u5165\u308c\u3070\u3001\u8abf\u67fb\u3057\u3084\u3059\u3044\u3002\n\u6642\u523b\u304c\u57fa\u672cUTC\u306a\u306e\u3067\u3001\u3061\u3087\u3063\u3068\u6ce8\u610f\u304c\u5fc5\u8981\n\nAWS\u306e\u30ed\u30b0\uff08ELB, CloudFront, CloudTrail\uff09\u3092S3\u306b\u4fdd\u5b58\u3057\u3001Athena\u3067\u96c6\u8a08\u3057\u3066\u307f\u307e\u3057\u305f\u3002\nDDL\u5b9a\u7fa9\u3082\u8f09\u305b\u3066\u3044\u307e\u3059\u3002\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u8a18\u8f09\u306e\u3082\u306e\u3068\u306f\u7570\u306a\u308a\u3001\u4f7f\u3044\u3084\u3059\u3044\u5f62\u306b\u5909\u66f4\u3057\u307e\u3057\u305f\u3002\n\n## Athena\u6982\u8981\n* S3\u306b\u4fdd\u7ba1\u3057\u305f\u30c7\u30fc\u30bf\u306b\u5bfe\u3057\u3066\u30af\u30a8\u30ea\u3092\u5b9f\u884c\u3067\u304d\u308b\n* \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u8d77\u52d5\u305b\u305a\u306bS3\u306e\u30c7\u30fc\u30bf\u306b\u5bfe\u3057\u3066\u76f4\u63a5SQL\u306e\u30af\u30a8\u30ea\u5b9f\u884c\u304c\u53ef\u80fd\n* ANSI SQL\u3092\u30b5\u30dd\u30fc\u30c8\n* \u5185\u90e8\u7684\u306b\u306fPresto\u304c\u5b9f\u884c\u3055\u308c\u3066\u3044\u308b\u305f\u3081\u3001Presto\u3067\u4f7f\u3048\u308b\u3082\u306e\u306f\u5927\u62b5\u4f7f\u3048\u308b\n* \u8ab2\u91d1\u306f\u30af\u30a8\u30ea\u5358\u4f4d\u3000\uff11TB\u306b\u3064\u304d$5\n\n## \u307e\u3060\u30d0\u30fc\u30b8\u30cb\u30a2\u3068\u30aa\u30ec\u30b4\u30f3\u3067\u3057\u304b\u4f7f\u3048\u306a\u3044\n* \u6771\u4eac\u30ea\u30fc\u30b8\u30e7\u30f3\u3067\u306f\u307e\u3060\u4f7f\u3048\u307e\u305b\u3093\n* Athena\u306fS3\u3092\u53c2\u7167\u3059\u308b\u306e\u3067\u3001Athena(\u30d0\u30fc\u30b8\u30cb\u30a2)\u2192S3(\u6771\u4eac)\u306b\u3059\u308b\u3068\u5fae\u5999\u306b\u9045\u304f\u306a\u308a\u307e\u3059\n\n## \u3084\u3063\u3066\u307f\u308b\n### \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u4f5c\u308b\n* \u6700\u521d\u306b\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u4f5c\u308a\u307e\u3059\n* \u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u3084\u3064\u3067\u3082\u3044\u3044\u3067\u3059\n\n```sql:sample\nCREATE DATABASE aws_logs;\n```\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2017-02-09 0.55.23.png](https://qiita-image-store.s3.amazonaws.com/0/98887/596ea0b4-9f83-ea13-bb54-53531b1ee8e1.png)\n\n\n### \u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u308b\n* GUI\u3067\u5165\u529b\u3082\u3067\u304d\u307e\u3059\u304c\u3001SQL\u3092\u66f8\u3044\u3066\u3044\u304d\u307e\u3059\n  * GUI\u3067\u30c6\u30fc\u30d6\u30eb\u5b9a\u7fa9\u3092\u5165\u529b\u3059\u308b\u306e\u304c\u7d50\u69cb\u9762\u5012\u3067\u3059\n  * \u4ee5\u4e0b\u3001DDL\u5b9a\u7fa9\u3067\u3059\n\n#### ELB\n```sql:ELB\nCREATE EXTERNAL TABLE IF NOT EXISTS aws_logs.elb_log (\n  request_protocol string,\n  request_timestamp string,\n  elb_name string,\n  request_ip string,\n  request_port int,\n  backend_ip string,\n  backend_port int,\n  request_processing_time double,\n  backend_processing_time double,\n  client_response_time double,\n  elb_response_code string,\n  backend_response_code string,\n  received_bytes bigint,\n  sent_bytes bigint,\n  request_verb string,\n  url string,\n  protocol string,\n  user_agent string,\n  ssl_cipher string,\n  ssl_protocol string,\n  arn string,\n  extra string )\nROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.RegexSerDe'\nWITH SERDEPROPERTIES (\n    'serialization.format' = '1','input.regex' = '([^ ]*) ([^ ]*) ([^ ]*) ([^ ]*):([0-9]*) ([^ ]*):([0-9]*) (-1|[.0-9]*) (-1|[.0-9]*) (-1|[.0-9]*) (-|[0-9]*) (-|[0-9]*) ([-0-9]*) ([-0-9]*) \\\\\\\"([^ ]*) ([^ ]*) (- |[^ ]*)\\\\\\\" (\\\"[^\\\"]*\\\") ([^ ]*) ([^ ]*) ([^ ]*) ([^ ]*)$' )\nLOCATION 's3://*******/********/'\n```\n\n#### CloudFront\n```sql:cloudfront\nCREATE EXTERNAL TABLE IF NOT EXISTS aws_logs.cloudfront_log (\n  date STRING,\n  time STRING,\n  xEdgeLocation STRING,\n  scBytes INT,\n  cIp STRING,\n  csMethod STRING,\n  csHost STRING,\n  csUriStem STRING,\n  scStatus INT,\n  csReferer STRING,\n  csUserAgent STRING,\n  csUriQuery STRING,\n  csCookie STRING,\n  xEdgeResultType STRING,\n  xEdgeRequestId STRING,\n  xHostHeader STRING,\n  csProtocol STRING,\n  csBytes INT,\n  timeTaken INT,\n  xForwardedFor STRING,\n  sslProtocol STRING,\n  sslCipher STRING,\n  xEdgeResponseResultType STRING,\n  csProtocolVersion STRING\n)\nROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.RegexSerDe'\nWITH SERDEPROPERTIES (\n  'serialization.format' = '1','input.regex' = '([^ ]*)\\t([^ ]*)\\t([^ ]*)\\t([0-9]*)\\t([.0-9]*)\\t([^ ]*)\\t([^ ]*)\\t([^ ]*)\\t([0-9]*)\\t([^ ]*)\\t([^ ]*)\\t([^ ]*)\\t([^ ]*)\\t([^ ]*)\\t([^ ]*)\\t([^ ]*)\\t([^ ]*)\\t([0-9]*)\\t([^ ]*)\\t([^ ]*)\\t([^ ]*)\\t([^ ]*)\\t([^ ]*)\\t([^ ]*)$'\n) LOCATION 's3://****/******/'\n```\n\n#### CloudTrail\n```sql:cloudtrail\nCREATE EXTERNAL TABLE IF NOT EXISTS sample.records (\n  records ARRAY<STRUCT<eventTime:STRING,eventSource:STRING,eventName:STRING>>\n)\nROW FORMAT SERDE 'org.openx.data.jsonserde.JsonSerDe'\nWITH SERDEPROPERTIES (\n  'serialization.format' = '1'\n) LOCATION 's3://********/***/'\n```\n\n### SELECT\u3059\u308b\n* ANSI SQL\u5bfe\u5fdc\u306a\u306e\u3067\u666e\u901a\u306bSQL\u3092\u5b9f\u884c\u3057\u3066\u304f\u3060\u3055\u3044\n* CloudFront\u3068CloudTrail\u3060\u3051\u6ce8\u610f\u3057\u3066\u304f\u3060\u3055\u3044\n\n#### CloudFront\u306eSELECT\u6ce8\u610f\u70b9\n* \u4e0a\u8a18\u306eDDL\u3092\u5b9f\u884c\u3059\u308b\u3068\u4e00\u90e8\u4f55\u3082\u5165\u3063\u3066\u306a\u3044\u30ec\u30b3\u30fc\u30c9\u304c\u3067\u304d\u3042\u304c\u308a\u307e\u3059\n  * CloudFront\u306e\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u306f\u5148\u982d2\u884c\u306b\u30b3\u30e1\u30f3\u30c8&\u30d8\u30c3\u30c0\u30fc\u304c\u5165\u3063\u3066\u3044\u307e\u3059\n  * \u73fe\u72b6\u3001Athena\u3067\u306f\u3053\u308c\u3092\u9664\u3044\u3066\u53d6\u308a\u8fbc\u3080\u3053\u3068\u304c\u3067\u304d\u307e\u305b\u3093\n  * Presto\u3067\u4f7f\u3048\u308b`org.apache.hadoop.hive.serde2.OpenCSVSerde`\u304c\u4f7f\u3048\u308b\u3088\u3046\u306b\u306a\u308b\u306e\u3092\u6c17\u9577\u306b\u5f85\u3061\u307e\u3057\u3087\u3046\n* select\u3059\u308b\u969b\u306b\u306fwhere\u53e5\u3067`date NOT LIKE '#%'`\u3092\u6307\u5b9a\u3059\u308b\u3088\u3046\u306b\u3057\u307e\u3057\u3087\u3046\n\n```sql:sample-select\nSELECT count(*) \nFROM aws_logs.cloudfront_log \nWHERE date NOT LIKE '#%'\n```\n\n#### CloudTrail\u306eSELECT\u6ce8\u610f\u70b9\n* CloudTrail\u306e\u30ed\u30b0\u306fJSON\u5f62\u5f0f\u306e\u305f\u3081\u3001\u30ab\u30e9\u30e0\u3092\u5206\u3051\u308b\u3053\u3068\u304c\u96e3\u3057\u3044\u3067\u3059(\u65b9\u6cd5\u3042\u308c\u3070\u6559\u3048\u3066\u304f\u3060\u3055\u3044)\n* select\u3059\u308b\u3068\u304d\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3059\u308b\u3002\u9762\u5012\u30fb\u30fb\u30fb\n\n```sql:sample-trail-select\nSELECT record.eventTime\nFROM aws_logs.traillog\nCROSS JOIN unnest(records) AS t(record)\nWHERE record.eventname='ConsoleLogin' limit 10\n```\n\n```sql:sample-trail-select2\nSELECT record\nFROM aws_logs.traillog\nCROSS JOIN unnest(records) AS t(record)\nWHERE record.eventtime LIKE '2017-02-08%' limit 10\n```\n\n### \u307e\u3068\u3081\n* ELB\u3068CloudFront\u306e\u30ed\u30b0\u3092\u6295\u5165\u3059\u308b\u3060\u3051\u3067\u30015XX\u7cfb\u30a8\u30e9\u30fc\u306a\u3069\u306e\u8abf\u67fb\u304c\u304b\u306a\u308a\u697d\u306b\u306a\u308a\u307e\u3059\n* Trail\u30ed\u30b0\u306f\u3082\u3046\u4e00\u6b69\u3067\u3059\u306d\u3002\u30ad\u30ec\u30a4\u306b\u30ab\u30e9\u30e0\u3067\u5165\u308c\u3070\u3001\u8abf\u67fb\u3057\u3084\u3059\u3044\u3002\n* \u6642\u523b\u304c\u57fa\u672cUTC\u306a\u306e\u3067\u3001\u3061\u3087\u3063\u3068\u6ce8\u610f\u304c\u5fc5\u8981\n\n", "tags": ["AWS", "Athena", "elb", "CloudFront", "Cloudtrail"]}