{"context": " More than 1 year has passed since last update.\u5168\u30ea\u30fc\u30b8\u30e7\u30f3\u3067CloudTrail\u3092\u6709\u52b9\u306b\u3057\u305f\u3068\u304d\u306e\u30e1\u30e2\n\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306f\u3053\u3061\u3089\u3092\u30d9\u30fc\u30b9\u306b\u3055\u305b\u3066\u3082\u3089\u3044\u307e\u3057\u305f\nhttps://gist.github.com/ryo0301/1ccf39346934f03dc28b\n\u4e8b\u524d\u306bCloudFormation\u7528\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u4fdd\u5b58\u3059\u308bs3bucket\u3092\u4f5c\u3063\u3066Web\u30a2\u30af\u30bb\u30b9\u3092\u8a31\u53ef\u3057\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\n\u4eca\u5f8c\u51fa\u3066\u304f\u308b[bucket-for-cloudformation-template]\u306f\u3053\u3053\u3067\u4f5c\u6210\u3057\u305f\u30d0\u30b1\u30c3\u30c8\u540d\u306b\u66f8\u304d\u63db\u3048\u3066\u304f\u3060\u3055\u3044\n\ncloudtrail\u306e\u30c7\u30fc\u30bf\u4fdd\u5b58\u5148s3bucket\u3092\u4f5c\u6210\n\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306e\u30d9\u30fc\u30b9\u3068\u3057\u3066\u4ee5\u4e0b\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u5229\u7528\u3057\u307e\u3059\u3002\nhttps://gist.github.com/ryo0301/1ccf39346934f03dc28b#file-cf-audit-outputs-template\nSNS\u306f\u4eca\u56de\u4e0d\u8981\u306a\u306e\u3067\u3001OperatorEmail\u3068Topic, TopicPolicy, SNSTopicName\u306f\u524a\u9664\u3057\u307e\u3059\u3002\n\ncf-audit-outputs.template\n{\n  \"AWSTemplateFormatVersion\" : \"2010-09-09\",\n  \"Parameters\" : {\n    \"ExpirationInDays\" : {\n      \"Description\" : \"Expiration of the CloudTrail logs in days\",\n      \"Type\" : \"Number\",\n      \"Default\" : 365\n    }\n  },\n  \"Resources\" : {\n    \"Bucket\" : {\n      \"DeletionPolicy\" : \"Retain\",\n      \"Type\" : \"AWS::S3::Bucket\",\n      \"Properties\" : {\n        \"LifecycleConfiguration\" : {\n          \"Rules\" : [\n            {\n              \"Status\" : \"Enabled\",\n              \"ExpirationInDays\" : {\"Ref\" : \"ExpirationInDays\"}\n            }\n          ]\n        }\n      }\n    },\n    \"BucketPolicy\" : {\n      \"Type\" : \"AWS::S3::BucketPolicy\",\n      \"Properties\" : {\n        \"Bucket\" : {\"Ref\" : \"Bucket\"},\n        \"PolicyDocument\" : {\n          \"Version\" : \"2012-10-17\",\n          \"Statement\" : [\n            {\n              \"Sid\" : \"AWSCloudTrailAclCheck\",\n              \"Effect\" : \"Allow\",\n              \"Principal\" : {\n                \"AWS\" : [\n                  \"arn:aws:iam::903692715234:root\",\n                  \"arn:aws:iam::859597730677:root\",\n                  \"arn:aws:iam::814480443879:root\",\n                  \"arn:aws:iam::216624486486:root\",\n                  \"arn:aws:iam::086441151436:root\",\n                  \"arn:aws:iam::388731089494:root\",\n                  \"arn:aws:iam::284668455005:root\",\n                  \"arn:aws:iam::113285607260:root\",\n                  \"arn:aws:iam::035351147821:root\" \n                ]\n              },\n              \"Action\" : \"s3:GetBucketAcl\",\n              \"Resource\" : { \"Fn::Join\" : [\"\", [\"arn:aws:s3:::\", {\"Ref\" : \"Bucket\"}]]}\n            },\n            {\n              \"Sid\" : \"AWSCloudTrailWrite\",\n              \"Effect\" : \"Allow\",\n              \"Principal\" : {\n                \"AWS\" : [\n                  \"arn:aws:iam::903692715234:root\",\n                  \"arn:aws:iam::859597730677:root\",\n                  \"arn:aws:iam::814480443879:root\",\n                  \"arn:aws:iam::216624486486:root\",\n                  \"arn:aws:iam::086441151436:root\",\n                  \"arn:aws:iam::388731089494:root\",\n                  \"arn:aws:iam::284668455005:root\",\n                  \"arn:aws:iam::113285607260:root\",\n                  \"arn:aws:iam::035351147821:root\" \n                ]\n              },\n              \"Action\" : \"s3:PutObject\",\n              \"Resource\" : { \"Fn::Join\" : [\"\", [\"arn:aws:s3:::\", {\"Ref\" : \"Bucket\"}, \"/AWSLogs/\", {\"Ref\" : \"AWS::AccountId\"}, \"/*\"]]},\n              \"Condition\" : {\n                \"StringEquals\" : {\n                  \"s3:x-amz-acl\" : \"bucket-owner-full-control\" \n                }\n              }\n            }\n          ]\n        }\n      }\n    }\n  },\n  \"Outputs\" : {\n    \"S3BucketName\" : {\n      \"Value\" : {\"Ref\" : \"Bucket\"},\n      \"Description\" : \"Name of the newly created S3 bucket.\" \n    }\n  }\n}\n\n\n\n\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306e\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3068cloudformation\u3067\u306es3\u30d0\u30b1\u30c3\u30c8\u306e\u4f5c\u6210\n% aws s3 cp cf-audit-outputs.template s3://[bucket-for-cloudformation-template]/cf-audit-outputs.template\n% aws cloudformation create-stack --stack-name audit-s3 --region ap-northeast-1 --template-url https://s3-ap-northeast-1.amazonaws.com/[bucket-for-cloudformation-template]/cf-audit-outputs.template\n\n\n\u5b9f\u884c\u7d50\u679c\u78ba\u8a8d\u65b9\u6cd5\n% aws cloudformation describe-stack-resources --stack-name audit-s3\n\n\u4eca\u5f8c\u51fa\u3066\u304f\u308b[bucket-for-cloudtrail]\u306f\u3053\u3053\u3067\u78ba\u8a8d\u3067\u304d\u308bS3\u30d0\u30b1\u30c3\u30c8\u540d\u306b\u66f8\u304d\u63db\u3048\u3066\u304f\u3060\u3055\u3044\n\ncloudtrail\u306e\u8a2d\u5b9a\n\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306e\u30d9\u30fc\u30b9\u3068\u3057\u3066\u4ee5\u4e0b\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u5229\u7528\u3057\u307e\u3059\u3002\nhttps://gist.github.com/ryo0301/1ccf39346934f03dc28b#file-cf-audit-cloudtrail-template\n% aws s3 cp cf-audit-cloudtrail.template s3://[bucket-for-cloudformation-template]/cf-audit-cloudtrail.template\n\nglobal service\u306e\u30ed\u30b0\u306f\u6771\u4eac\u30ea\u30fc\u30b8\u30e7\u30f3\u306b\u4fdd\u5b58\u3057\u307e\u3059\u3002\n\n\u6771\u4eac\u30ea\u30fc\u30b8\u30e7\u30f3\n% aws cloudformation create-stack --stack-name audit-cloudtrail --region ap-northeast-1 --template-url https://s3-ap-northeast-1.amazonaws.com/[bucket-for-cloudformation-template]/cf-audit-cloudtrail.template --parameters ParameterKey=BucketName,ParameterValue=[bucket-for-cloudtrail],UsePreviousValue=true ParameterKey=IncludeGlobalServiceEvents,ParameterValue=true,UsePreviousValue=true\n\n\n\u6771\u4eac\u30ea\u30fc\u30b8\u30e7\u30f3\u4ee5\u5916\n% REGIONS=(\"ap-southeast-1\" \"ap-southeast-2\" \"eu-central-1\" \"eu-west-1\" \"sa-east-1\" \"us-east-1\" \"us-west-1\" \"us-west-2\");for region in ${REGIONS[@]}; do; aws cloudformation create-stack --stack-name audit-cloudtrail --region $region --template-url https://s3-ap-northeast-1.amazonaws.com/[bucket-for-cloudformation-template]/cf-audit-cloudtrail.template --parameters ParameterKey=BucketName,ParameterValue=[bucket-for-cloudtrail],UsePreviousValue=true; done\n\n\n\u5b9f\u884c\u7d50\u679c\u78ba\u8a8d\u65b9\u6cd5\n% REGIONS=(\"ap-northeast-1\" \"ap-southeast-1\" \"ap-southeast-2\" \"eu-central-1\" \"eu-west-1\" \"sa-east-1\" \"us-east-1\" \"us-west-1\" \"us-west-2\");for region in ${REGIONS[@]}; do; aws cloudformation describe-stack-resources --region ${region} --stack-name audit-cloudtrail; done\n\n\u4ee5\u4e0a\u3067\u5b8c\u4e86\u3067\u3059\u3002\n\u5168\u30ea\u30fc\u30b8\u30e7\u30f3\u3067CloudTrail\u3092\u6709\u52b9\u306b\u3057\u305f\u3068\u304d\u306e\u30e1\u30e2\n\n\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306f\u3053\u3061\u3089\u3092\u30d9\u30fc\u30b9\u306b\u3055\u305b\u3066\u3082\u3089\u3044\u307e\u3057\u305f\nhttps://gist.github.com/ryo0301/1ccf39346934f03dc28b\n\n\u4e8b\u524d\u306bCloudFormation\u7528\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u4fdd\u5b58\u3059\u308bs3bucket\u3092\u4f5c\u3063\u3066Web\u30a2\u30af\u30bb\u30b9\u3092\u8a31\u53ef\u3057\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\n\u4eca\u5f8c\u51fa\u3066\u304f\u308b[bucket-for-cloudformation-template]\u306f\u3053\u3053\u3067\u4f5c\u6210\u3057\u305f\u30d0\u30b1\u30c3\u30c8\u540d\u306b\u66f8\u304d\u63db\u3048\u3066\u304f\u3060\u3055\u3044\n\n## cloudtrail\u306e\u30c7\u30fc\u30bf\u4fdd\u5b58\u5148s3bucket\u3092\u4f5c\u6210\n\n\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306e\u30d9\u30fc\u30b9\u3068\u3057\u3066\u4ee5\u4e0b\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u5229\u7528\u3057\u307e\u3059\u3002\n\nhttps://gist.github.com/ryo0301/1ccf39346934f03dc28b#file-cf-audit-outputs-template\n\nSNS\u306f\u4eca\u56de\u4e0d\u8981\u306a\u306e\u3067\u3001OperatorEmail\u3068Topic, TopicPolicy, SNSTopicName\u306f\u524a\u9664\u3057\u307e\u3059\u3002\n\n```json:cf-audit-outputs.template\n{\n  \"AWSTemplateFormatVersion\" : \"2010-09-09\",\n  \"Parameters\" : {\n    \"ExpirationInDays\" : {\n      \"Description\" : \"Expiration of the CloudTrail logs in days\",\n      \"Type\" : \"Number\",\n      \"Default\" : 365\n    }\n  },\n  \"Resources\" : {\n    \"Bucket\" : {\n      \"DeletionPolicy\" : \"Retain\",\n      \"Type\" : \"AWS::S3::Bucket\",\n      \"Properties\" : {\n        \"LifecycleConfiguration\" : {\n          \"Rules\" : [\n            {\n              \"Status\" : \"Enabled\",\n              \"ExpirationInDays\" : {\"Ref\" : \"ExpirationInDays\"}\n            }\n          ]\n        }\n      }\n    },\n    \"BucketPolicy\" : {\n      \"Type\" : \"AWS::S3::BucketPolicy\",\n      \"Properties\" : {\n        \"Bucket\" : {\"Ref\" : \"Bucket\"},\n        \"PolicyDocument\" : {\n          \"Version\" : \"2012-10-17\",\n          \"Statement\" : [\n            {\n              \"Sid\" : \"AWSCloudTrailAclCheck\",\n              \"Effect\" : \"Allow\",\n              \"Principal\" : {\n                \"AWS\" : [\n                  \"arn:aws:iam::903692715234:root\",\n                  \"arn:aws:iam::859597730677:root\",\n                  \"arn:aws:iam::814480443879:root\",\n                  \"arn:aws:iam::216624486486:root\",\n                  \"arn:aws:iam::086441151436:root\",\n                  \"arn:aws:iam::388731089494:root\",\n                  \"arn:aws:iam::284668455005:root\",\n                  \"arn:aws:iam::113285607260:root\",\n                  \"arn:aws:iam::035351147821:root\" \n                ]\n              },\n              \"Action\" : \"s3:GetBucketAcl\",\n              \"Resource\" : { \"Fn::Join\" : [\"\", [\"arn:aws:s3:::\", {\"Ref\" : \"Bucket\"}]]}\n            },\n            {\n              \"Sid\" : \"AWSCloudTrailWrite\",\n              \"Effect\" : \"Allow\",\n              \"Principal\" : {\n                \"AWS\" : [\n                  \"arn:aws:iam::903692715234:root\",\n                  \"arn:aws:iam::859597730677:root\",\n                  \"arn:aws:iam::814480443879:root\",\n                  \"arn:aws:iam::216624486486:root\",\n                  \"arn:aws:iam::086441151436:root\",\n                  \"arn:aws:iam::388731089494:root\",\n                  \"arn:aws:iam::284668455005:root\",\n                  \"arn:aws:iam::113285607260:root\",\n                  \"arn:aws:iam::035351147821:root\" \n                ]\n              },\n              \"Action\" : \"s3:PutObject\",\n              \"Resource\" : { \"Fn::Join\" : [\"\", [\"arn:aws:s3:::\", {\"Ref\" : \"Bucket\"}, \"/AWSLogs/\", {\"Ref\" : \"AWS::AccountId\"}, \"/*\"]]},\n              \"Condition\" : {\n                \"StringEquals\" : {\n                  \"s3:x-amz-acl\" : \"bucket-owner-full-control\" \n                }\n              }\n            }\n          ]\n        }\n      }\n    }\n  },\n  \"Outputs\" : {\n    \"S3BucketName\" : {\n      \"Value\" : {\"Ref\" : \"Bucket\"},\n      \"Description\" : \"Name of the newly created S3 bucket.\" \n    }\n  }\n}\n```\n\n### \u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306e\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3068cloudformation\u3067\u306es3\u30d0\u30b1\u30c3\u30c8\u306e\u4f5c\u6210\n``` shell\n% aws s3 cp cf-audit-outputs.template s3://[bucket-for-cloudformation-template]/cf-audit-outputs.template\n% aws cloudformation create-stack --stack-name audit-s3 --region ap-northeast-1 --template-url https://s3-ap-northeast-1.amazonaws.com/[bucket-for-cloudformation-template]/cf-audit-outputs.template\n```\n\n### \u5b9f\u884c\u7d50\u679c\u78ba\u8a8d\u65b9\u6cd5\n\n```\n% aws cloudformation describe-stack-resources --stack-name audit-s3\n```\n\n\u4eca\u5f8c\u51fa\u3066\u304f\u308b[bucket-for-cloudtrail]\u306f\u3053\u3053\u3067\u78ba\u8a8d\u3067\u304d\u308bS3\u30d0\u30b1\u30c3\u30c8\u540d\u306b\u66f8\u304d\u63db\u3048\u3066\u304f\u3060\u3055\u3044\n\n## cloudtrail\u306e\u8a2d\u5b9a\n\n\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306e\u30d9\u30fc\u30b9\u3068\u3057\u3066\u4ee5\u4e0b\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u5229\u7528\u3057\u307e\u3059\u3002\nhttps://gist.github.com/ryo0301/1ccf39346934f03dc28b#file-cf-audit-cloudtrail-template\n\n``` shell\n% aws s3 cp cf-audit-cloudtrail.template s3://[bucket-for-cloudformation-template]/cf-audit-cloudtrail.template\n```\n\nglobal service\u306e\u30ed\u30b0\u306f\u6771\u4eac\u30ea\u30fc\u30b8\u30e7\u30f3\u306b\u4fdd\u5b58\u3057\u307e\u3059\u3002\n\n### \u6771\u4eac\u30ea\u30fc\u30b8\u30e7\u30f3\n\n```\n% aws cloudformation create-stack --stack-name audit-cloudtrail --region ap-northeast-1 --template-url https://s3-ap-northeast-1.amazonaws.com/[bucket-for-cloudformation-template]/cf-audit-cloudtrail.template --parameters ParameterKey=BucketName,ParameterValue=[bucket-for-cloudtrail],UsePreviousValue=true ParameterKey=IncludeGlobalServiceEvents,ParameterValue=true,UsePreviousValue=true\n```\n\n### \u6771\u4eac\u30ea\u30fc\u30b8\u30e7\u30f3\u4ee5\u5916\n\n```\n% REGIONS=(\"ap-southeast-1\" \"ap-southeast-2\" \"eu-central-1\" \"eu-west-1\" \"sa-east-1\" \"us-east-1\" \"us-west-1\" \"us-west-2\");for region in ${REGIONS[@]}; do; aws cloudformation create-stack --stack-name audit-cloudtrail --region $region --template-url https://s3-ap-northeast-1.amazonaws.com/[bucket-for-cloudformation-template]/cf-audit-cloudtrail.template --parameters ParameterKey=BucketName,ParameterValue=[bucket-for-cloudtrail],UsePreviousValue=true; done\n```\n\n\n### \u5b9f\u884c\u7d50\u679c\u78ba\u8a8d\u65b9\u6cd5\n\n```\n% REGIONS=(\"ap-northeast-1\" \"ap-southeast-1\" \"ap-southeast-2\" \"eu-central-1\" \"eu-west-1\" \"sa-east-1\" \"us-east-1\" \"us-west-1\" \"us-west-2\");for region in ${REGIONS[@]}; do; aws cloudformation describe-stack-resources --region ${region} --stack-name audit-cloudtrail; done\n```\n\n\u4ee5\u4e0a\u3067\u5b8c\u4e86\u3067\u3059\u3002\n", "tags": ["AWS", "Cloudtrail", "CloudFormation"]}