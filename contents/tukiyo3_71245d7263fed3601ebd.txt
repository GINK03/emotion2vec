{"context": "\ndebian9\u306b\u3066\u5b9f\u65bd\n\n\n\u53c2\u8003\n\nNginx \u5165\u9580 - \u677e\u6c5f\u5de5\u696d\u9ad8\u7b49\u5c02\u9580\u5b66\u6821\n\n\n1. openssl.cnf\u306e\u6e96\u5099\n\n\u5165\u529b\u304c\u5927\u5909\u306a\u306e\u3067\u3001\u5171\u901a\u306e\u8a2d\u5b9a\u306fopenssl.cnf\u306b\u66f8\u3044\u3066\u304a\u304f\u3002\n\nmkdir /opt/demoCA\ncd /opt/demoCA\ncp -a /etc/ssl/openssl.cnf .\n\n\n/opt/demoCA/openssl.cnf\n-dir            = ./demoCA              # Where everything is kept\n+dir            = /opt/demoCA           # Where everything is kept\n certs          = $dir/certs            # Where the issued certs are kept\n crl_dir                = $dir/crl              # Where the issued crl are kept\n database       = $dir/index.txt        # database index file.\n@@ -70,7 +70,7 @@\n # crlnumber must also be commented out to leave a V1 CRL.\n # crl_extensions       = crl_ext\n\n-default_days   = 365                   # how long to certify for\n+default_days   = 3650                  # how long to certify for\n default_crl_days= 30                   # how long before next CRL\n default_md     = default               # use public key default MD\n preserve       = no                    # keep passed DN ordering\n@@ -126,17 +126,17 @@\n\n [ req_distinguished_name ]\n countryName                    = Country Name (2 letter code)\n-countryName_default            = AU\n+countryName_default            = JP\n countryName_min                        = 2\n countryName_max                        = 2\n\n stateOrProvinceName            = State or Province Name (full name)\n-stateOrProvinceName_default    = Some-State\n+stateOrProvinceName_default    = Tokyo\n\n localityName                   = Locality Name (eg, city)\n\n 0.organizationName             = Organization Name (eg, company)\n-0.organizationName_default     = Internet Widgits Pty Ltd\n+0.organizationName_default     = mycompany.jp\n\n # we can do this but it is not needed normally :-)\n #1.organizationName            = Second Organization Name (eg, company)\n\n\n\n2. \u8a8d\u8a3c\u5c40(CA)\u306e\u4f5c\u6210\n\n10.2.1 \u8a8d\u8a3c\u5c40\u306e\u4f5c\u6210\n\nopenssl  genrsa  -out cakey.pem   2048\n\n# Common Name : \u30b5\u30fc\u30d0\u30fc\u306e\u540d\u524d\u3092\u5165\u529b\u3059\u308b\u3053\u3068\nopenssl req -config openssl.cnf -new -x509 -key cakey.pem \\\n     -out cacert.pem\n\n\n3. \u30b5\u30fc\u30d0\u30fc\u8a3c\u660e\u66f8\u306e\u4f5c\u6210\n\n10.2.2 \u30b5\u30fc\u30d0\u8a3c\u660e\u66f8\u306e\u4f5c\u6210\n\nopenssl  genrsa  -out  private.pem  2048\n\n# Common Name : \u30b5\u30fc\u30d0\u30fc\u306e\u540d\u524d\u3092\u5165\u529b\u3059\u308b\u3053\u3068\nopenssl req -config openssl.cnf -new -key private.pem -out newreq.pem\n\n\n\u7f72\u540d\nmkdir private newcerts\nmv cakey.pem private/\nopenssl ca -config openssl.cnf -policy policy_anything \\\n    -out cert.pem -in newreq.pem\n\n\nnginx\u7528\u306b\u7d50\u5408\ncat  cert.pem  cacert.pem  >  allcert.pem\n\n\n\n4. nginx\u8a2d\u5b9a\n\n10.2.3 Nginx\u306e\u30b5\u30fc\u30d0SSL\u306e\u8a2d\u5b9a\n\n\n/etc/nginx/sites-enabled/default\n# http\u306e\u8a2d\u5b9a\nserver {\n        listen 80 default_server;\n        listen [::]:80 default_server;\n        ...\n}\n\n# https\u306e\u8a2d\u5b9a\nserver {\n        listen 443 ssl;\n        ssl_certificate /opt/demoCA/allcert.pem;\n        ssl_certificate_key /opt/demoCA/private.pem;\n\n        root /srv/www/html;\n        charset   utf-8;\n\n        index index.html index.htm index.nginx-debian.html index.php;\n        server_name _;\n        location / {\n                try_files $uri $uri/ =404;\n                autoindex on;\n        }\n        # php\u306e\u8a2d\u5b9a\n        location ~ \\.php$ {\n                include snippets/fastcgi-php.conf;\n                fastcgi_pass unix:/var/run/php/php7.0-fpm.sock;\n        }\n        # ssl\u8a3c\u660e\u66f8\u304c\u306a\u3044\u3068\u95b2\u89a7\u3067\u304d\u306a\u3044\u3088\u3046\u306b\u3059\u308b\n        ssl_verify_client on;\n        ssl_client_certificate /opt/demoCA/cacert.pem;\n}\n\n\n\nsyntax\u30c1\u30a7\u30c3\u30af\nnginx -t -c /etc/nginx/nginx.conf\n\n\n/etc/init.d/nginx restart\n\n\n5. \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u914d\u5e03\u7528\u306e\u8a3c\u660e\u66f8\n\n10.2.4.1 \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u8a3c\u660e\u66f8\u306e\u4f5c\u6210\n\nopenssl  genrsa  -out  client_private.pem  2048\n\n# Common Name : \u30e6\u30fc\u30b6\u30fc\u540d\u3092\u6307\u5b9a\nopenssl req -config openssl.cnf -new -key client_private.pem -out newreq.pem\n\ncat private.pem cert.pem cacert.pem \\\n| openssl pkcs12 -export -out client.p12 -name \"client key\"\n\n\n\nclient.p12\u3092\u914d\u5e03\u3057\u3001https://\u30b5\u30fc\u30d0\u30fc\u306eIP/\u306b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3002\n\n* debian9\u306b\u3066\u5b9f\u65bd\n\n## \u53c2\u8003\n\n* [Nginx \u5165\u9580 - \u677e\u6c5f\u5de5\u696d\u9ad8\u7b49\u5c02\u9580\u5b66\u6821](http://www2.matsue-ct.ac.jp/home/kanayama/text/nginx/)\n\n## 1. openssl.cnf\u306e\u6e96\u5099\n\n* \u5165\u529b\u304c\u5927\u5909\u306a\u306e\u3067\u3001\u5171\u901a\u306e\u8a2d\u5b9a\u306fopenssl.cnf\u306b\u66f8\u3044\u3066\u304a\u304f\u3002\n\n```bash:\nmkdir /opt/demoCA\ncd /opt/demoCA\ncp -a /etc/ssl/openssl.cnf .\n```\n\n```diff:/opt/demoCA/openssl.cnf\n-dir            = ./demoCA              # Where everything is kept\n+dir            = /opt/demoCA           # Where everything is kept\n certs          = $dir/certs            # Where the issued certs are kept\n crl_dir                = $dir/crl              # Where the issued crl are kept\n database       = $dir/index.txt        # database index file.\n@@ -70,7 +70,7 @@\n # crlnumber must also be commented out to leave a V1 CRL.\n # crl_extensions       = crl_ext\n\n-default_days   = 365                   # how long to certify for\n+default_days   = 3650                  # how long to certify for\n default_crl_days= 30                   # how long before next CRL\n default_md     = default               # use public key default MD\n preserve       = no                    # keep passed DN ordering\n@@ -126,17 +126,17 @@\n\n [ req_distinguished_name ]\n countryName                    = Country Name (2 letter code)\n-countryName_default            = AU\n+countryName_default            = JP\n countryName_min                        = 2\n countryName_max                        = 2\n\n stateOrProvinceName            = State or Province Name (full name)\n-stateOrProvinceName_default    = Some-State\n+stateOrProvinceName_default    = Tokyo\n\n localityName                   = Locality Name (eg, city)\n\n 0.organizationName             = Organization Name (eg, company)\n-0.organizationName_default     = Internet Widgits Pty Ltd\n+0.organizationName_default     = mycompany.jp\n\n # we can do this but it is not needed normally :-)\n #1.organizationName            = Second Organization Name (eg, company)\n```\n\n## 2. \u8a8d\u8a3c\u5c40(CA)\u306e\u4f5c\u6210\n\n* [10.2.1 \u8a8d\u8a3c\u5c40\u306e\u4f5c\u6210](http://www2.matsue-ct.ac.jp/home/kanayama/text/nginx/node95.html)\n\n```bash:\nopenssl  genrsa  -out cakey.pem   2048\n```\n\n```bash:\n# Common Name : \u30b5\u30fc\u30d0\u30fc\u306e\u540d\u524d\u3092\u5165\u529b\u3059\u308b\u3053\u3068\nopenssl req -config openssl.cnf -new -x509 -key cakey.pem \\\n     -out cacert.pem\n```\n\n## 3. \u30b5\u30fc\u30d0\u30fc\u8a3c\u660e\u66f8\u306e\u4f5c\u6210\n\n* [10.2.2 \u30b5\u30fc\u30d0\u8a3c\u660e\u66f8\u306e\u4f5c\u6210](http://www2.matsue-ct.ac.jp/home/kanayama/text/nginx/node96.html)\n\n```\nopenssl  genrsa  -out  private.pem  2048\n```\n\n```bash:\n# Common Name : \u30b5\u30fc\u30d0\u30fc\u306e\u540d\u524d\u3092\u5165\u529b\u3059\u308b\u3053\u3068\nopenssl req -config openssl.cnf -new -key private.pem -out newreq.pem\n```\n\n### \u7f72\u540d\n\n```bash:\nmkdir private newcerts\nmv cakey.pem private/\nopenssl ca -config openssl.cnf -policy policy_anything \\\n    -out cert.pem -in newreq.pem\n```\n\n```bash:nginx\u7528\u306b\u7d50\u5408\ncat  cert.pem  cacert.pem  >  allcert.pem\n```\n\n## 4. nginx\u8a2d\u5b9a\n\n* [10.2.3 Nginx\u306e\u30b5\u30fc\u30d0SSL\u306e\u8a2d\u5b9a](http://www2.matsue-ct.ac.jp/home/kanayama/text/nginx/node97.html)\n\n```nginx:/etc/nginx/sites-enabled/default\n# http\u306e\u8a2d\u5b9a\nserver {\n        listen 80 default_server;\n        listen [::]:80 default_server;\n        ...\n}\n\n# https\u306e\u8a2d\u5b9a\nserver {\n        listen 443 ssl;\n        ssl_certificate /opt/demoCA/allcert.pem;\n        ssl_certificate_key /opt/demoCA/private.pem;\n\n        root /srv/www/html;\n        charset   utf-8;\n\n        index index.html index.htm index.nginx-debian.html index.php;\n        server_name _;\n        location / {\n                try_files $uri $uri/ =404;\n                autoindex on;\n        }\n        # php\u306e\u8a2d\u5b9a\n        location ~ \\.php$ {\n                include snippets/fastcgi-php.conf;\n                fastcgi_pass unix:/var/run/php/php7.0-fpm.sock;\n        }\n        # ssl\u8a3c\u660e\u66f8\u304c\u306a\u3044\u3068\u95b2\u89a7\u3067\u304d\u306a\u3044\u3088\u3046\u306b\u3059\u308b\n        ssl_verify_client on;\n        ssl_client_certificate /opt/demoCA/cacert.pem;\n}\n```\n\n```bash:syntax\u30c1\u30a7\u30c3\u30af\nnginx -t -c /etc/nginx/nginx.conf\n```\n\n```bash:\n/etc/init.d/nginx restart\n```\n\n\n### 5. \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u914d\u5e03\u7528\u306e\u8a3c\u660e\u66f8\n\n* [10.2.4.1 \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u8a3c\u660e\u66f8\u306e\u4f5c\u6210](http://www2.matsue-ct.ac.jp/home/kanayama/text/nginx/node99.html)\n\n```bash:\nopenssl  genrsa  -out  client_private.pem  2048\n```\n\n```bash:\n# Common Name : \u30e6\u30fc\u30b6\u30fc\u540d\u3092\u6307\u5b9a\nopenssl req -config openssl.cnf -new -key client_private.pem -out newreq.pem\n```\n\n```\ncat private.pem cert.pem cacert.pem \\\n| openssl pkcs12 -export -out client.p12 -name \"client key\"\n```\n\n* `client.p12`\u3092\u914d\u5e03\u3057\u3001`https://\u30b5\u30fc\u30d0\u30fc\u306eIP/`\u306b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3002\n", "tags": ["nginx", "openssl"]}