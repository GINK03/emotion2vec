{"context": "PHP\u30d5\u30ed\u30f3\u30c8\u30a8\u30f3\u30c9\u304b\u3089\u5185\u90e8\u30ed\u30b0\u3092S3\u3068MySQL(MariaDB)\u306b\u683c\u7d0d\u3059\u308b\u30e1\u30e2\u3002\nS3\u306e\u5f8c\u306bMySQL\u306b\u5165\u308c\u3088\u3046\u3068\u3057\u3066\u5f15\u3063\u304b\u304b\u3063\u305f\u306e\u3067\u3001\u305d\u306e\u8a18\u9332\u3002\n\u30fb\u4f7f\u7528\u3059\u308bFluentd\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n/opt/td-agent/embedded/bin/fluent-gem install fluent-plugin-s3\n/opt/td-agent/embedded/bin/fluent-gem install fluent-plugin-forest\n/opt/td-agent/embedded/bin/fluent-gem install fluent-plugin-uri_decoder\nsudo yum install mysql-devel\nsudo yum install gcc-c++\n/opt/td-agent/embedded/bin/fluent-gem install fluent-plugin-mysql\n\u203bmysql-devel\u3068gcc-c++\u306ffluent-plugin-mysql\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306b\u5fc5\u8981\n\u30fb\u9001\u4fe1\u5074PHP\nHTTP\u901a\u4fe1\u306e\u30ec\u30a4\u30c6\u30f3\u30b7\u30fc\u3092\u8003\u3048\u308b\u3068\u30ed\u30fc\u30ab\u30eb\u306bFluentd\u5165\u308c\u3066\u7d4c\u7531\u3055\u305b\u308b\u3079\u304d\u306a\u306e\u304b\u3082\u3057\u308c\u306a\u3044\u3051\u3069\u3001\n\u7a3c\u50cd\u4e2d\u306e\u672c\u756a\u74b0\u5883\u3092\u5909\u66f4\u3057\u305f\u304f\u306a\u304b\u3063\u305f\u306e\u3067HTTP\u3067\u9001\u4fe1\n$keyword\u306furl_encode()\u3055\u308c\u3066\u3044\u308b\u3002\n    $postdata = array(\n       'keyword' => $keyword,\n       'hogehoge' => $hogehoge,\n       'mogemoge' => $mogemoge\n    );\n    $postjson = json_encode($postdata);\n    $postoption = array('http' => array(\n       'method' => 'POST',\n       'content' => \"json=\".$postjson\n    ));\n    $posturl = \"http://fluentdsrv:24225/geo.internal_log\";\n    $postrlt = file_get_contents($posturl, false, stream_context_create($postoption));\n\n\u30fb\u53d7\u4fe1\u5074Fluentd\n\u6700\u521d\u306fmatch\u306e\u30bf\u30b0\u3092\u5909\u3048\u3066\nuri_decode\u2192S3\u4fdd\u5b58\u2192MySQL\u4fdd\u5b58\n\u3067\u3084\u308d\u3046\u3068\u3057\u3066\u3044\u305f\u306e\u3060\u3051\u3069\u3001S3\u3068MySQL\u304c\u30b7\u30fc\u30b1\u30f3\u30b7\u30e3\u30eb\u306b\u3067\u304d\u306a\u3044\u3053\u3068\u304c\u5224\u660e\u3002\nhttp://qiita.com/nagais/items/ca96af840b8061102551\n\uff1efluentd\u306f\u4e00\u3064\u306e\u30a4\u30d9\u30f3\u30c8\u306b\u5bfe\u3057\u3066\u3001\u5148\u306b\u30de\u30c3\u30c1\u3059\u308b\u3082\u306e\u304c\u3042\u308b\u3068\u5f8c\u306ematch\u53e5\u306f\u52b9\u304b\u306a\u3044\u3002\n\u4eca\u601d\u3046\u3068remove_prefix,add_prefix\u5f8c\u306e\u30bf\u30b0\u3067S3\u4fdd\u5b58\u304c\u52d5\u3044\u3066\u3044\u305f\u306e\u3067\u3001\u5f8c\u7d9a\u306ematch\u304c\u52d5\u3044\u3066\u3044\u306a\u304b\u3063\u305f\u306e\u3060\u308d\u3046\u3002\ntype forest\u5229\u7528\u6642\u306e\u6ce8\u610f\u70b9\u304b\u3068\u3002\n\u3068\u3082\u3042\u308c\u3001\u30b7\u30fc\u30b1\u30f3\u30b7\u30e3\u30eb\u306b\u52d5\u4f5c\u3067\u304d\u306a\u3044\u306e\u306a\u3089type copy\u3092\u4f7f\u7528\u3057\u3066\u8907\u6570\u3067\u8a18\u8f09\u3002\n<source>\n  type http\n  port 24225\n</source>\n<match geo.internal_log>\n  type uri_decode\n  key_names keyword\n  remove_prefix geo\n  add_prefix decoded\n</match>\n<match decoded.internal_log>\n  type copy\n  <store>\n    type forest\n    subtype s3\n    <template>\n      aws_key_id ID\u3060\u3088\n      aws_sec_key \u9375\u3060\u3088\n      s3_bucket \u30d0\u30b1\u30c4\u540d\u3060\u3088\n      s3_region ap-northeast-1\n      s3_object_key_format %{path}%{time_slice}_%{index}.log.gz\n      buffer_path /var/log/fluent/s3/internal/\n      store_as gzip\n\n      path logs/internal/\n      time_slice_format %Y%m%d/%H_internal\n      time_slice_wait 10m\n    </template>\n  </store>\n\n  <store>\n    @type mysql_bulk\n    host DB\u30db\u30b9\u30c8\n    port \u30dd\u30fc\u30c8\u756a\u53f7\n    username DB\u30e6\u30fc\u30b6\u30fc\u540d\n    password DB\u30d1\u30b9\u30ef\u30fc\u30c9\n\n    database \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u540d\n    table \u30c6\u30fc\u30d6\u30eb\u540d\n    include_time_key yes\u3000\u203b\u8981\u3089\u306a\u3044\u304b\u3082\n\n    column_names id, datetime, keyword, hogehoge, mogemoge\n    key_names id, ${time}, keyword, hogehoge, mogemoge\n\n    flush_interval 10s\n  </store>\n</match>\n\n\nPHP\u30d5\u30ed\u30f3\u30c8\u30a8\u30f3\u30c9\u304b\u3089\u5185\u90e8\u30ed\u30b0\u3092S3\u3068MySQL(MariaDB)\u306b\u683c\u7d0d\u3059\u308b\u30e1\u30e2\u3002\nS3\u306e\u5f8c\u306bMySQL\u306b\u5165\u308c\u3088\u3046\u3068\u3057\u3066\u5f15\u3063\u304b\u304b\u3063\u305f\u306e\u3067\u3001\u305d\u306e\u8a18\u9332\u3002\n\n\u30fb\u4f7f\u7528\u3059\u308bFluentd\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n/opt/td-agent/embedded/bin/fluent-gem install fluent-plugin-s3\n/opt/td-agent/embedded/bin/fluent-gem install fluent-plugin-forest\n/opt/td-agent/embedded/bin/fluent-gem install fluent-plugin-uri_decoder\nsudo yum install mysql-devel\nsudo yum install gcc-c++\n/opt/td-agent/embedded/bin/fluent-gem install fluent-plugin-mysql\n\u203bmysql-devel\u3068gcc-c++\u306ffluent-plugin-mysql\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306b\u5fc5\u8981\n\n\u30fb\u9001\u4fe1\u5074PHP\nHTTP\u901a\u4fe1\u306e\u30ec\u30a4\u30c6\u30f3\u30b7\u30fc\u3092\u8003\u3048\u308b\u3068\u30ed\u30fc\u30ab\u30eb\u306bFluentd\u5165\u308c\u3066\u7d4c\u7531\u3055\u305b\u308b\u3079\u304d\u306a\u306e\u304b\u3082\u3057\u308c\u306a\u3044\u3051\u3069\u3001\n\u7a3c\u50cd\u4e2d\u306e\u672c\u756a\u74b0\u5883\u3092\u5909\u66f4\u3057\u305f\u304f\u306a\u304b\u3063\u305f\u306e\u3067HTTP\u3067\u9001\u4fe1\n$keyword\u306furl_encode()\u3055\u308c\u3066\u3044\u308b\u3002\n\n        $postdata = array(\n           'keyword' => $keyword,\n           'hogehoge' => $hogehoge,\n           'mogemoge' => $mogemoge\n        );\n        $postjson = json_encode($postdata);\n        $postoption = array('http' => array(\n           'method' => 'POST',\n           'content' => \"json=\".$postjson\n        ));\n        $posturl = \"http://fluentdsrv:24225/geo.internal_log\";\n        $postrlt = file_get_contents($posturl, false, stream_context_create($postoption));\n\n\u30fb\u53d7\u4fe1\u5074Fluentd\n\u6700\u521d\u306fmatch\u306e\u30bf\u30b0\u3092\u5909\u3048\u3066\nuri_decode\u2192S3\u4fdd\u5b58\u2192MySQL\u4fdd\u5b58\n\u3067\u3084\u308d\u3046\u3068\u3057\u3066\u3044\u305f\u306e\u3060\u3051\u3069\u3001S3\u3068MySQL\u304c\u30b7\u30fc\u30b1\u30f3\u30b7\u30e3\u30eb\u306b\u3067\u304d\u306a\u3044\u3053\u3068\u304c\u5224\u660e\u3002\nhttp://qiita.com/nagais/items/ca96af840b8061102551\n\uff1efluentd\u306f\u4e00\u3064\u306e\u30a4\u30d9\u30f3\u30c8\u306b\u5bfe\u3057\u3066\u3001\u5148\u306b\u30de\u30c3\u30c1\u3059\u308b\u3082\u306e\u304c\u3042\u308b\u3068\u5f8c\u306ematch\u53e5\u306f\u52b9\u304b\u306a\u3044\u3002\n\u4eca\u601d\u3046\u3068remove_prefix,add_prefix\u5f8c\u306e\u30bf\u30b0\u3067S3\u4fdd\u5b58\u304c\u52d5\u3044\u3066\u3044\u305f\u306e\u3067\u3001\u5f8c\u7d9a\u306ematch\u304c\u52d5\u3044\u3066\u3044\u306a\u304b\u3063\u305f\u306e\u3060\u308d\u3046\u3002\ntype forest\u5229\u7528\u6642\u306e\u6ce8\u610f\u70b9\u304b\u3068\u3002\n\u3068\u3082\u3042\u308c\u3001\u30b7\u30fc\u30b1\u30f3\u30b7\u30e3\u30eb\u306b\u52d5\u4f5c\u3067\u304d\u306a\u3044\u306e\u306a\u3089type copy\u3092\u4f7f\u7528\u3057\u3066\u8907\u6570<store>\u3067\u8a18\u8f09\u3002\n\n```xml\n<source>\n  type http\n  port 24225\n</source>\n<match geo.internal_log>\n  type uri_decode\n  key_names keyword\n  remove_prefix geo\n  add_prefix decoded\n</match>\n<match decoded.internal_log>\n  type copy\n  <store>\n    type forest\n    subtype s3\n    <template>\n      aws_key_id ID\u3060\u3088\n      aws_sec_key \u9375\u3060\u3088\n      s3_bucket \u30d0\u30b1\u30c4\u540d\u3060\u3088\n      s3_region ap-northeast-1\n      s3_object_key_format %{path}%{time_slice}_%{index}.log.gz\n      buffer_path /var/log/fluent/s3/internal/\n      store_as gzip\n\n      path logs/internal/\n      time_slice_format %Y%m%d/%H_internal\n      time_slice_wait 10m\n    </template>\n  </store>\n\n  <store>\n    @type mysql_bulk\n    host DB\u30db\u30b9\u30c8\n    port \u30dd\u30fc\u30c8\u756a\u53f7\n    username DB\u30e6\u30fc\u30b6\u30fc\u540d\n    password DB\u30d1\u30b9\u30ef\u30fc\u30c9\n\n    database \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u540d\n    table \u30c6\u30fc\u30d6\u30eb\u540d\n    include_time_key yes\u3000\u203b\u8981\u3089\u306a\u3044\u304b\u3082\n\n    column_names id, datetime, keyword, hogehoge, mogemoge\n    key_names id, ${time}, keyword, hogehoge, mogemoge\n\n    flush_interval 10s\n  </store>\n</match>\n\n", "tags": ["fluentd", "MySQL", "S3"]}