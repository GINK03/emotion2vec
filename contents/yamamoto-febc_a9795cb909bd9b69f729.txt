{"context": "\n\n\u9023\u8f09\u76ee\u6b21\n\n\u7b2c1\u56de\uff1a\u5c0e\u5165\u7de8\n\n\n\u6982\u8981\n\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n\u5b9f\u8df5 Step1\uff1a\u30b5\u30fc\u30d0\u30fc\uff11\u53f0\u69cb\u6210\n\n\n\u7b2c2\u56de\uff1a\u5b9f\u8df5\u7de8\n\n\n\u5b9f\u8df5 Step2\uff1a\u69cb\u6210/\u8a2d\u5b9a\u306e\u5909\u66f4\n\n\n\u30ea\u30bd\u30fc\u30b9\u306e\u8ffd\u52a0\n\u30ea\u30bd\u30fc\u30b9\u306e\u5909\u66f4\ncount\u69cb\u6587\noutput\u6a5f\u80fd\n\n\n\n\n\u7b2c3\u56de\uff1a\u5b9f\u8df5\u7de82\n\n\n\u5b9f\u8df5 Step3\uff1a\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\n\n\n\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u63a5\u7d9a\u8a2d\u5b9a\nfile\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\nremote-exec\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\n\u3055\u304f\u3089\u306e\u30af\u30e9\u30a6\u30c9DNS\u30ea\u30bd\u30fc\u30b9\u306e\u5229\u7528\n\n\n\n\n\u7b2c4\u56de\uff1a\u5fdc\u7528\u7de8(\u5f53\u8a18\u4e8b)\n\n\n\u5b9f\u8df5 Step4\uff1aWeb/DB 2-Tier\u69cb\u6210\n\n\nMySQL\u306e\u5229\u7528\n\u30b9\u30a4\u30c3\u30c1\u306b\u3088\u308b\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306e\u69cb\u7bc9\n\u30d1\u30b1\u30c3\u30c8\u30d5\u30a3\u30eb\u30bf/\u30b7\u30f3\u30d7\u30eb\u7ba1\u7406:Slack\u901a\u77e5\u306e\u5229\u7528\n\n\n\n\n\u7b2c5\u56de\uff1a\u5fdc\u7528\u7de82\n\n\n\u5b9f\u8df5 Step5\uff1a\u6771\u4eac/\u77f3\u72e9 \u30de\u30eb\u30c1\u30be\u30fc\u30f3\u69cb\u6210\n\n\n\u6771\u4eac\u3068\u77f3\u72e9\u3067\u30de\u30eb\u30c1\u30be\u30fc\u30f3\u69cb\u6210\nGSLB\u306b\u3088\u308b\u30be\u30fc\u30f3\u9593HA\u69cb\u6210\nMySQL \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3 + PHP(mysqlnd_ms)\u306b\u3088\u308bDB\u306e\u30af\u30e9\u30b9\u30bf\u30ea\u30f3\u30b0\n\nnull_resource\u3084template_file\u306a\u3069\u306e\u7279\u6b8a\u306a\u30ea\u30bd\u30fc\u30b9\ntf\u30d5\u30a1\u30a4\u30eb\u306e\u30ea\u30d5\u30a1\u30af\u30bf\u30ea\u30f3\u30b0\u3068\u30e2\u30b8\u30e5\u30fc\u30eb\u5316\n\n\n\n\n\u9023\u8f09\u7b2c4\u56de\u3067\u3059\u3002\n\u7b2c1\u56de\u304b\u3089\u9806\u756a\u306b\u304a\u8aad\u307f\u304f\u3060\u3055\u3044\u3002\n\u7b2c4\u56de\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9 / \u7b2c3\u56de\u3068\u306e\u5dee\u5206\u8868\u793a\n\n\n\u5b9f\u8df5 Step4\uff1aWeb/DB 2-Tier\u69cb\u6210\n\u3044\u3088\u3044\u3088\u5fdc\u7528\u7de8\u306b\u306a\u308a\u307e\u3059\u3002\nTerraform\u306e\u57fa\u672c\u7684\u306a\u64cd\u4f5c\u3092\u99c6\u4f7f\u3057\u3066\u5b9f\u904b\u7528\u306b\u8010\u3048\u308b\u30a4\u30f3\u30d5\u30e9\u3092\u69cb\u7bc9\u3057\u3066\u3044\u304d\u307e\u3057\u3087\u3046\u3002\n\u524d\u56de(\u7b2c3\u56de)\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u69cb\u6210\u3067\u3057\u305f\u3002\n\n\uff12\u53f0\u306eWeb\u30b5\u30fc\u30d0\u306b\u52a0\u3048\u3066DNS\u3078\u306e\u767b\u9332\u3082\u884c\u3063\u3066\u3044\u307e\u3057\u305f\u306d\u3002\n\u73fe\u6642\u70b9\u3067\u3082\u5916\u90e8\u304b\u3089\u306e\u63a5\u7d9a\u304c\u3067\u304d\u308b\u72b6\u614b\u306a\u306e\u3067\u3059\u304c\u3001\n\u4eca\u56de\u306f\u672c\u756a\u904b\u7528\u610f\u8b58\u3057\u3066\u69cb\u6210\u3092\u5909\u66f4\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\nWeb\u5c64/DB\u5c64\u306e\uff12\u968e\u5c64(2-tier)\u5316\n\u30b9\u30a4\u30c3\u30c1\u3092\u8ffd\u52a0\u3057\u3066\u3001DB\u3092\u914d\u7f6e\u3059\u308b\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u306a\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3092\u69cb\u7bc9\u3057\u307e\u3059\u3002\n\u4ee5\u4e0b\u306e\u30ea\u30bd\u30fc\u30b9\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\n\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u7528\u306b\u30b9\u30a4\u30c3\u30c1(sw01)\u3092\u8ffd\u52a0\n\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u5185\u306bDB\u30b5\u30fc\u30d0\u30fc(server_db + disk_db)\u3092\u8ffd\u52a0\n\nDB\u30b5\u30fc\u30d0\u30fc\u3067\u306fMySQL\u3092\u7a3c\u50cd\u3055\u305b\u307e\u3059\u3002\n\n\u975e\u6a5f\u80fd\u8981\u4ef6\u5bfe\u5fdc\n\u672c\u756a\u904b\u7528\u6642\u306b\u306f\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u5bfe\u5fdc\u3084\u76e3\u8996/\u6e2c\u5b9a\u3001\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306a\u3069\u306e\u975e\u6a5f\u80fd\u8981\u4ef6\u3082\u6e80\u305f\u3059\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u4eca\u56de\u306f\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306f\u624b\u52d5\u3001\u76e3\u8996\u306f\u901a\u77e5\u3060\u3051\u6765\u308b\u3088\u3046\u306b\u3057\u3066\u304a\u304d\u5fa9\u65e7\u306f\u624b\u52d5\u3067\u884c\u3046\u3082\u306e\u3068\u3057\u3066\u3001\n\u4ee5\u4e0b\u306e\u5bfe\u5fdc\u3060\u3051\u884c\u3044\u307e\u3059\u3002\n\n\u30d1\u30b1\u30c3\u30c8\u30d5\u30a3\u30eb\u30bf\u3092\u8ffd\u52a0\u3057\u3066\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u5bfe\u7b56\n\n\u30b7\u30f3\u30d7\u30eb\u76e3\u8996\u3067\u76e3\u8996 + Slack\u3078\u901a\u77e5\n\n\n\u4eca\u56de\u306e\u6700\u7d42\u7684\u306a\u69cb\u6210\n\n\u306a\u3093\u3060\u304b\u4e00\u6c17\u306b\u30ea\u30bd\u30fc\u30b9\u304c\u8ffd\u52a0\u3055\u308c\u3066\u8907\u96d1\u306b\u306a\u3063\u3066\u304d\u307e\u3057\u305f\u306d\u3002\n\u3067\u3082\u5927\u4e08\u592b\u3067\u3059\u3002\nTerraform\u3092\u4f7f\u3046\u306e\u3067\u3042\u308c\u3070\u3001\u30c8\u30e9\u30a4&\u30a8\u30e9\u30fc\u3067\u5b9a\u7fa9\u30d5\u30a1\u30a4\u30eb(tf\u30d5\u30a1\u30a4\u30eb)\u3092\n\u80b2\u3066\u3066 \u3044\u3051\u3070\u3044\u3044\u3093\u3067\u3059\u3002\ntf\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u3063\u3066\u30c6\u30b9\u30c8\u3057\u3066\u304a\u3051\u3070\u305d\u306e\u74b0\u5883\u306e\u518d\u73fe\u306f\u7c21\u5358\u306a\u3093\u3067\u3059\u304b\u3089\u306d\u3002\n\u3067\u306f\u65e9\u901f\u5b9f\u8df5\u3057\u3066\u3044\u304d\u307e\u3057\u3087\u3046\u3002\n\n\u5b9f\u8df5\n\n\u7b2c1\u6bb5\u968e\uff1aDB\u30b5\u30fc\u30d0\u30fc\u8ffd\u52a0\n\u307e\u305a\u306fDB\u30b5\u30fc\u30d0\u30fc\u3092\u8ffd\u52a0\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\u3053\u306e\u6bb5\u968e\u3067\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u69cb\u6210\u306b\u306a\u308a\u307e\u3059\u3002\n\nDB\u30b5\u30fc\u30d0\u30fc\u3068Web\u30b5\u30fc\u30d0\u30fc\u3068\u3067\u306f\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u8981\u4ef6\u304c\u7570\u306a\u308b\u305f\u3081\u3001\nSSH\u516c\u958b\u9375\u306fWeb\u5c64(server01\u306802)\u3068\u306f\u5225\u306e\u3082\u306e\u3092\u4f7f\u3046\u3088\u3046\u306b\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\u8ffd\u52a0\u3059\u308b\u30ea\u30bd\u30fc\u30b9\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\n\n\u30b5\u30fc\u30d0\u30fc(server_db)\n\u30c7\u30a3\u30b9\u30af(disk_db)\nSSH\u516c\u958b\u9375(dbkey)\n\n\u52a0\u3048\u3066\u3001DB\u30b5\u30fc\u30d0\u30fc\u306e\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u3082\u884c\u3063\u3066\u304a\u304d\u307e\u3059\u3002\n\u3055\u304f\u3089\u306e\u30af\u30e9\u30a6\u30c9\u306e\u30d1\u30d6\u30ea\u30c3\u30af\u30a2\u30fc\u30ab\u30a4\u30d6\u304b\u3089CentOS7.2\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u5834\u5408\u3001\nmysql community\u306eyum\u30ea\u30dd\u30b8\u30c8\u30ea\u304c\u3059\u3067\u306b\u767b\u9332\u3055\u308c\u3066\u304a\u308a\u3001\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304c\u5bb9\u6613\u306a\u305f\u3081\nMySQL5.6\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\u3059\u3067\u306b\u524d\u56de\u307e\u3067\u306b\u51fa\u3066\u304d\u305f\u30c6\u30af\u30cb\u30c3\u30af\u3060\u3051\u3067\u5bfe\u5fdc\u3067\u304d\u307e\u3059\u306d\uff01\n\n\u6e96\u5099\nDB\u30b5\u30fc\u30d0\u30fc\u7528\u306b\u30ad\u30fc\u30da\u30a2\u3092\u4f5c\u6210\u3057\u307e\u3057\u3087\u3046\u3002\n\nSSH\u7528\u30ad\u30fc\u30da\u30a2\u4f5c\u6210\n$ ssh-keygen -C \"\" -f ./id_rsa_db\nGenerating public/private rsa key pair.\nEnter passphrase (empty for no passphrase):  #\u4f55\u3082\u5165\u529b\u305b\u305aEnter\nEnter same passphrase again:                 #\u4f55\u3082\u5165\u529b\u305b\u305aEnter\n\n\n\n\u30ab\u30ec\u30f3\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306bid_rsa_db\u3068id_rsa_db.pub\u304c\u4f5c\u6210\u3055\u308c\u3066\u3044\u308b\u306f\u305a\u3067\u3059\u3002\n\n\u5b9a\u7fa9\u30d5\u30a1\u30a4\u30eb(tf\u30d5\u30a1\u30a4\u30eb)\u7de8\u96c6\n\u305d\u308c\u3067\u306ftf\u30d5\u30a1\u30a4\u30eb\u3092\u7de8\u96c6\u3057\u307e\u3057\u3087\u3046\u3002\u524d\u56de\u307e\u3067\u306etf\u30d5\u30a1\u30a4\u30eb\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\n\nsakura.tf(\u524d\u56de\u307e\u3067\u306etf\u30d5\u30a1\u30a4\u30eb\u5168\u4f53)\nprovider \"sakuracloud\" {\n    token = \"[ACCESS_TOKEN]\"\n    secret = \"[ACCESS_TOKEN_SECRET]\"\n}\n\nresource \"sakuracloud_disk\" \"disk\" {\n    name = \"${format(\"disk%02d\" , count.index+1)}\"\n    source_archive_name = \"CentOS 7.2 64bit\"\n    ssh_key_ids = [\"${sakuracloud_ssh_key.mykey.id}\"]\n    disable_pw_auth = true\n    count = 2\n}\n\nresource \"sakuracloud_server\" \"server\" {\n    name = \"${format(\"server%02d\" , count.index+1)}\"\n    disks = [\"${element(sakuracloud_disk.disk.*.id,count.index)}\"]\n    count = 2\n    # 1: \u30b5\u30fc\u30d0\u30fc\u306b\u306fSSH\u3067\u63a5\u7d9a\n    connection {\n       user = \"root\"\n       host = \"${self.base_nw_ipaddress}\"\n       private_key = \"${file(\"./id_rsa\")}\"\n    }\n\n    # \uff12\uff1a yum\u3067apache+PHP\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000provisioner \"remote-exec\" {\n        inline = [\n          \"yum install -y httpd httpd-devel php php-mbstring\",\n          \"chkconfig httpd on\"\n        ]\n   }\n\n   # 3: Web\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\n   provisioner \"file\" {\n        source = \"webapps/\"\n        destination = \"/var/www/html\"\n   }\n\n}\n\nresource \"sakuracloud_ssh_key\" \"mykey\" {\n    name = \"mykey\"\n    public_key = \"${file(\"./id_rsa.pub\")}\"\n}\n\nresource \"sakuracloud_dns\" \"dns\" {\n    zone = \"fe-bc.net\"\n    records = {\n        name = \"web\"\n        type = \"A\"\n        value = \"${sakuracloud_server.server.0.base_nw_ipaddress}\"\n    }\n    records = {\n        name = \"web\"\n        type = \"A\"\n        value = \"${sakuracloud_server.server.1.base_nw_ipaddress}\"\n    }\n}\n\noutput \"global_ip\" {\n    value = \"${join(\"\\n\" , formatlist(\"%s : %s\" , sakuracloud_server.server.*.name , sakuracloud_server.server.*.base_nw_ipaddress))}\"\n}\n\n\n\u3053\u3053\u306b\u4eca\u56de\u306e\u30ea\u30bd\u30fc\u30b9\u3092\u8db3\u3057\u3066\u3044\u304d\u307e\u3057\u3087\u3046\u3002\n\u4ee5\u4e0b\u3092\u8ffd\u8a18\u3057\u307e\u3059\u3002MySQL\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u306f\u4efb\u610f\u306e\u3082\u306e\u3092\u8a2d\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\nsakura.tf(\u8ffd\u52a0\u5206)\n\nvariable \"mysql_values\" {\n   default = {\n      # MySQL\u306eroot\u30e6\u30fc\u30b6\u30fc\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\n      root_password = \"mysql_password\"\n      # MySQL\u30c7\u30e2\u30a2\u30d7\u30ea\u7528\u30e6\u30fc\u30b6\u30fc\u306e\u540d\u524d\n      user_name = \"demo\"\n      # MySQL\u30c7\u30e2\u30a2\u30d7\u30ea\u7528\u30e6\u30fc\u30b6\u30fc\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\n      user_password = \"demo_password\"\n   }\n}\n\nresource \"sakuracloud_ssh_key\" \"dbkey\" {\n    name = \"dbkey\"\n    public_key = \"${file(\"./id_rsa_db.pub\")}\"\n}\n\nresource \"sakuracloud_disk\" \"disk_db\" {\n    name = \"disk_db\"\n    source_archive_name = \"CentOS 7.2 64bit\"\n    ssh_key_ids = [\"${sakuracloud_ssh_key.dbkey.id}\"]\n    disable_pw_auth = true\n}\n\nresource \"sakuracloud_server\" \"server_db\" {\n    name = \"server_db\"\n    disks = [\"${sakuracloud_disk.disk_db.id}\"]\n    # \u30b5\u30fc\u30d0\u30fc\u306b\u306fSSH\u3067\u63a5\u7d9a\n    connection {\n       user = \"root\"\n       host = \"${self.base_nw_ipaddress}\"\n       private_key = \"${file(\"./id_rsa_db\")}\"\n    }\n\n    provisioner \"remote-exec\" {\n        inline = [\n          \"yum install -y mysql-community-server\",\n          \"systemctl start mysql.service\",\n          \"mysql -uroot -e 'GRANT ALL ON *.* TO ${var.mysql_values.user_name}@\\\"192.168.2.%\\\" IDENTIFIED BY \\\"${var.mysql_values.user_password}\\\"'\" ,\n          \"mysqladmin -u root password '${var.mysql_values.root_password}'\",\n          \"systemctl stop firewalld.service\",\n          \"systemctl disable firewalld.service\"\n        ]\n    }\n}\n\n\n\n\u30dd\u30a4\u30f3\u30c8:variable\n\nvariable\u3068\u3044\u3046\u8a18\u8ff0\u304c\u65b0\u305f\u306b\u51fa\u3066\u304d\u307e\u3057\u305f\u306d\u3002\n\u3053\u308c\u306ftf\u30d5\u30a1\u30a4\u30eb\u5185\u3067\u5229\u7528\u51fa\u6765\u308b\u5909\u6570\u3092\u5b9a\u7fa9\u3059\u308b\u3082\u306e\u3067\u3059\u3002\nvariable\u3067\u5b9a\u7fa9\u3057\u3066\u304a\u3044\u305f\u5024\u306f\u3001${var.\u5909\u6570\u540d}\u3067\u53c2\u7167\u3067\u304d\u307e\u3059\u3002\n\u307e\u305f\u3001variable\u306f\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u304b\u3089\u4e0e\u3048\u305f\u308a\u3001\u5225\u9014\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u7528\u610f\u3057\u3066\u304a\u3044\u3066\n\u4e0e\u3048\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002(tfvar\u30d5\u30a1\u30a4\u30eb)\nvariable\u306b\u3064\u3044\u3066\u306e\u8a73\u7d30\u306a\u8aac\u660e\u306fTerraform\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092\u53c2\u7167\u304f\u3060\u3055\u3044\u3002\n\u3053\u3053\u3067\u306fMySQL\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3001MySQL\u30e6\u30fc\u30b6\u30fc\u306e\u8ffd\u52a0\u3001MySQL\u306eroot\u30d1\u30b9\u30ef\u30fc\u30c9\u306e\u8a2d\u5b9a\u307e\u3067\u3092\u884c\u3063\u3066\u3044\u307e\u3059\u3002\n\u6ce8\u610f\n\u4eca\u56de\u306f\u8a2d\u5b9a\u3092\u7c21\u5358\u306b\u3059\u308b\u305f\u3081\u306bmysql\u306eroot\u30e6\u30fc\u30b6\u30fc\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u3092mysqladmin\u30b3\u30de\u30f3\u30c9\u3067\n\u5b9f\u884c\u3059\u308b\u3060\u3051\u306e\u521d\u671f\u5316\u3068\u3057\u3066\u3044\u307e\u3059\u304c\u3001\u5b9f\u969b\u306b\u904b\u7528\u3059\u308b\u969b\u306fmysql_secure_instration\u76f8\u5f53\u306e\u51e6\u7406\u3092\u884c\u3046\u306a\u3069\u3001\u5341\u5206\u306b\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u306b\u914d\u616e\u304f\u3060\u3055\u3044\u3002\n\noutput\u306e\u8ffd\u52a0\n\u3053\u306e\u307e\u307e\u3067\u306foutput\u306bDB\u30b5\u30fc\u30d0\u30fc\u306e\u30b0\u30ed\u30fc\u30d0\u30ebIP\u304c\u8868\u793a\u3055\u308c\u307e\u305b\u3093\u306e\u3067\u3001\nDB\u30b5\u30fc\u30d0\u30fc\u306e\u30b0\u30ed\u30fc\u30d0\u30ebIP\u8868\u793a\u7528\u306boutput\u3092\u5b9a\u7fa9\u3057\u307e\u3057\u3087\u3046\u3002\n\u3064\u3044\u3067\u306bSSH\u63a5\u7d9a\u88dc\u52a9\u3082output\u5b9a\u7fa9\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\u4ee5\u4e0b\u3092\u8ffd\u8a18\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\nsakura.tf(SSH\u63a5\u7d9a\u88dc\u52a9output\u8ffd\u8a18)\noutput \"global_ip_db\" {\n    value = \"${format(\"%s : %s\\n\" , sakuracloud_server.server_db.name , sakuracloud_server.server_db.base_nw_ipaddress)}\"\n}\noutput \"ssh_web01\" {\n    value = \"${format(\"ssh root@%s -i %s/id_rsa\" , sakuracloud_server.server.0.base_nw_ipaddress , path.root)}\"\n}\noutput \"ssh_web02\" {\n    value = \"${format(\"ssh root@%s -i %s/id_rsa\" , sakuracloud_server.server.1.base_nw_ipaddress , path.root)}\"\n}\noutput \"ssh_db\" {\n    value = \"${format(\"ssh root@%s -i %s/id_rsa_db\" , sakuracloud_server.server_db.base_nw_ipaddress , path.root)}\"\n}\n\n\n\u3053\u308c\u3067terraform output ssh_web01\u3068\u5b9f\u884c\u3059\u308c\u3070ssh\u30b3\u30de\u30f3\u30c9\u304c\u51fa\u529b\u3055\u308c\u307e\u3059\u3002\n$(terraform output ssh_web01)\u306a\u3069\u3068\u3059\u308c\u3070\u5b9f\u884c\u3067\u304d\u307e\u3059\u3088!\n\u4ee5\u5f8c\u4f5c\u6210\u3057\u305f\u30b5\u30fc\u30d0\u30fc\u306bSSH\u3059\u308b\u969b\u306f\u4ee5\u4e0b\u30b3\u30de\u30f3\u30c9\u3067OK\u3067\u3059\u3002\n\nWeb\u30b5\u30fc\u30d0(server01) : $(terraform output ssh_web01)\n\nWeb\u30b5\u30fc\u30d0(server02) : $(terraform output ssh_web02)\n\nDB\u30b5\u30fc\u30d0(server_db) : $(terraform output ssh_db)\n\n\n\nplan\u3068apply\u306e\u5b9f\u884c\n\u3055\u3066\u3001\u3044\u3064\u3082\u901a\u308aterraform plan\u3057\u3066\u304b\u3089terraform apply\u3057\u307e\u3057\u3087\u3046\u3002\nDB\u30b5\u30fc\u30d0\u30fc\u304c\u8ffd\u52a0\u3055\u308c\u307e\u3057\u305f\u304b\uff1f\nSSH\u63a5\u7d9a\u3059\u308b\u306a\u3069\u3067\u52d5\u4f5c\u78ba\u8a8d\u3082\u3057\u3066\u304a\u304d\u307e\u3057\u3087\u3046\u3002\n\n\u7b2c2\u6bb5\u968e\uff1a\u30b9\u30a4\u30c3\u30c1\u8ffd\u52a0\u3067\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3068\u63a5\u7d9a\n\u3067\u306f\u7d9a\u3044\u3066\u30b9\u30a4\u30c3\u30c1\u3092\u8ffd\u52a0\u3057\u307e\u3057\u3087\u3046\u3002\n\u3053\u3093\u306a\u611f\u3058\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u3084\u308b\u3053\u3068\u306f\n\n\u30b9\u30a4\u30c3\u30c1\u7528\u30ea\u30bd\u30fc\u30b9(sakuracloud_switch)\u306e\u8ffd\u52a0\n\u30b9\u30a4\u30c3\u30c1\u3068\u30b5\u30fc\u30d0\u30fc\u306e\u63a5\u7d9a\n\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8IP\u306e\u5272\u308a\u632f\u308a(\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u3067\u5b9f\u65bd)\n\n\u3067\u3059\u3002\n\u307e\u305f\u3001Web\u30b5\u30fc\u30d0\u30fc\u3068DB\u30b5\u30fc\u30d0\u30fc\u9593\u3092\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3067\u63a5\u7d9a\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u306e\u3067\u3001\n\u30c7\u30e2\u7528\u306eWeb\u30a2\u30d7\u30ea(PHP)\u3082DB\u3092\u4f7f\u3046\u3088\u3046\u306b\u5909\u66f4\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\u9806\u756a\u306b\u3044\u304d\u307e\u3057\u3087\u3046\u3002\n\n\u30b9\u30a4\u30c3\u30c1\u7528\u30ea\u30bd\u30fc\u30b9\u306e\u5b9a\u7fa9\n\u3044\u3064\u3082\u901a\u308atf\u30d5\u30a1\u30a4\u30eb\u306b\u8ffd\u8a18\u3057\u307e\u3057\u3087\u3046\u3002\n\u4ee5\u4e0b\u3092\u8ffd\u8a18\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\nsakura.tf(\u30b9\u30a4\u30c3\u30c1\u8ffd\u52a0)\nresource \"sakuracloud_switch\" \"sw01\"{\n    name = \"sw01\"\n}\n\n\n\u3048\u3063\uff1f\u3053\u308c\u3060\u3051\uff1f\n\u306f\u3044\u3002\u30b9\u30a4\u30c3\u30c1\u306f\u8a2d\u5b9a\u9805\u76ee\u304c\u5c11\u306a\u3044\u306e\u3067\u3059\u3001\u3001\n\n\u30b9\u30a4\u30c3\u30c1\u3068\u30b5\u30fc\u30d0\u30fc\u306e\u63a5\u7d9a\n\u30b5\u30fc\u30d0\u30fc\u306e\u5b9a\u7fa9\u90e8\u5206\u3092\u4fee\u6b63\u3057\u307e\u3057\u3087\u3046\u3002\n\nsakura.tf(\u30b5\u30fc\u30d0\u30fc\u3068\u30b9\u30a4\u30c3\u30c1\u306e\u63a5\u7d9a)\n# Web\u30b5\u30fc\u30d0\u30fc\nresource \"sakuracloud_server\" \"server\" {\n    #(\u4e2d\u7565) \n\n    # \u30b9\u30a4\u30c3\u30c1\u3068\u63a5\u7d9a\u3059\u308b\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u3092\u5b9a\u7fa9\n    additional_interfaces = [\"${sakuracloud_switch.sw01.id}\"]\n\n   # \u4ee5\u4e0b\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0(\u7701\u7565)\n}\n# DB\u30b5\u30fc\u30d0\u30fc\nresource \"sakuracloud_server\" \"server_db\" {\n    #(\u4e2d\u7565) \n\n    # \u30b9\u30a4\u30c3\u30c1\u3068\u63a5\u7d9a\u3059\u308b\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u3092\u5b9a\u7fa9\n    additional_interfaces = [\"${sakuracloud_switch.sw01.id}\"]\n\n   # \u4ee5\u4e0b\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0(\u7701\u7565)\n}\n\n\n\n\n\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8IP\u306e\u5272\u308a\u5f53\u3066(\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0)\n\u3053\u308c\u3067\u5404\u30b5\u30fc\u30d0\u30fc\u306b\u5148\u307b\u3069\u8ffd\u52a0\u3057\u305f\u30b9\u30a4\u30c3\u30c1\u306b\u63a5\u7d9a\u3057\u305f\u72b6\u614b\u306eNIC\u304c\u8ffd\u52a0\u3055\u308c\u3066\u3044\u307e\u3059\u3002(eth1)\neth1\u306bIP\u30a2\u30c9\u30ec\u30b9\u3092\u8a2d\u5b9a\u3059\u308b\u3088\u3046\u306b\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u3057\u307e\u3057\u3087\u3046\u3002\n\u307e\u305a\u306f\u624b\u5143\u306e\u30de\u30b7\u30f3\u3067\u4ee5\u4e0b\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u4f5c\u6210\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\nIP\u8a2d\u5b9a\u7528\u30b9\u30af\u30ea\u30d7\u30c8\u4f5c\u6210\n$ vi provision_private_ip.sh\n\n\n\nprovision_private_ip.sh\n#!/bin/sh\n\n# eth1\u306eIP\u8a2d\u5b9a\ncat << EOS >> /etc/sysconfig/network-scripts/ifcfg-eth1\nBOOTPROTO=static\nPREFIX0=24\nDEVICE=eth1\nIPADDR0=$1\nONBOOT=yes\nEOS\n\n#\u53cd\u6620\nifdown eth1; ifup eth1\n\n\n\u5f15\u6570\u3067\u53d7\u3051\u53d6\u3063\u305fIP\u30a2\u30c9\u30ec\u30b9\u3092eth1\u306b\u8a2d\u5b9a\u3059\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u3067\u3059\u3002\n\u3053\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u3092Terraform\u306e\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u6a5f\u80fd\u3067\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9&\u5b9f\u884c\u3059\u308b\u3053\u3068\u3067IP\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\u3067\u306ftf\u30d5\u30a1\u30a4\u30eb\u306b\u8a18\u8f09\u3057\u307e\u3057\u3087\u3046\u3002\n\nsakura.tf(\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8IP\u5272\u308a\u632f\u308a)\n\nvariable \"private_ip_addresses\" {\n    default {\n      server01 : \"192.168.2.101\"\n      server02 : \"192.168.2.102\"\n      server_db : \"192.168.2.201\"\n    }\n}\n\n# Web\u30b5\u30fc\u30d0\u30fc\nresource \"sakuracloud_server\" \"server\" {\n    #(\u4e2d\u7565) \n\n    # \u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u5b9a\u7fa9\u306b\u4ee5\u4e0b\u3092\u8ffd\u8a18\n    # IP\u8a2d\u5b9a\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\n    provisioner \"file\" {\n        source = \"provision_private_ip.sh\"\n        destination = \"/tmp/provision_private_ip.sh\"\n    }\n\n    # IP\u8a2d\u5b9a\u5b9f\u884c\n    provisioner \"remote-exec\" {\n        inline = [\n          \"chmod +x /tmp/provision_private_ip.sh\",\n          \"/tmp/provision_private_ip.sh ${lookup(var.private_ip_addresses , self.name)}\"\n        ]\n    }\n}\n\n# DB\u30b5\u30fc\u30d0\u30fc\nresource \"sakuracloud_server\" \"server\" {\n    #(\u4e2d\u7565) \n\n    # \u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u5b9a\u7fa9\u306b\u4ee5\u4e0b\u3092\u8ffd\u8a18\n    # IP\u8a2d\u5b9a\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\n    provisioner \"file\" {\n        source = \"provision_private_ip.sh\"\n        destination = \"/tmp/provision_private_ip.sh\"\n    }\n\n    # IP\u8a2d\u5b9a\u5b9f\u884c\n    provisioner \"remote-exec\" {\n        inline = [\n          \"chmod +x /tmp/provision_private_ip.sh\",\n          \"/tmp/provision_private_ip.sh ${lookup(var.private_ip_addresses , self.name)}\"\n        ]\n    }\n}\n\n\n\n\n\u30dd\u30a4\u30f3\u30c8:lookup\n\n\u3053\u3053\u3067\u306f\u3001\u30b5\u30fc\u30d0\u30fc\u540d\u3068\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8IP\u306e\u5bfe\u5fdc\u95a2\u4fc2\u3092variable\u3068\u3057\u3066\u5b9a\u7fa9\u3057\u3066\u304a\u304d\u3001\n${lookup}\u3067\u30b5\u30fc\u30d0\u30fc\u540d\u3092\u30ad\u30fc\u3068\u3057\u3066\u6301\u3064\u5024\u3092\u53c2\u7167\u3057\u3066\u3044\u307e\u3059\u3002\ntf\u30d5\u30a1\u30a4\u30eb\u306e\u8a18\u8ff0\u3092\u30b9\u30c3\u30ad\u30ea\u3055\u305b\u308b\u306e\u306b\u6709\u52b9\u306a\u30c6\u30af\u30cb\u30c3\u30af\u3067\u3059\u3002\n\nWeb\u30a2\u30d7\u30ea\u306e\u4fee\u6b63\n\u30c7\u30e2\u7528\u306eWeb\u30a2\u30d7\u30ea\u3092DB\u306b\u7e4b\u3050\u3088\u3046\u306b\u4fee\u6b63\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\u4eca\u56de\u306f\u30c7\u30e2\u76ee\u7684\u3067\u3059\u306e\u3067\u5358\u7d14\u306bDB\u306b\u63a5\u7d9a\u3057\u3066\u5024\u304c\u53d6\u308c\u3066\u3044\u308c\u3070\u5341\u5206\u3067\u3059\u3002\n\u3088\u3063\u3066\u3001index.php\u306bDB\u63a5\u7d9a\u51e6\u7406\u3092\u76f4\u63a5\u66f8\u3044\u3061\u3083\u3044\u307e\u3059\u3002\nwebapps/index.php\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u66f4\u3057\u307e\u3057\u3087\u3046\u3002\nMySQL\u306e\u30e6\u30fc\u30b6\u30fc\u540d/\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u5909\u66f4\u3057\u3066\u3044\u308b\u5834\u5408\u306f\nnew mysqli\u306e\u5f15\u6570\u90e8\u5206\u3082\u4fee\u6b63\u3057\u3066\u304f\u3060\u3055\u3044\n\nwebapps/index.php\n<?php\n    date_default_timezone_set('Asia/Tokyo');\n    echo \"Terraform for \u3055\u304f\u3089\u306e\u30af\u30e9\u30a6\u30c9 \u30b9\u30bf\u30fc\u30c8\u30ac\u30a4\u30c9\u7528\u30c7\u30e2\". \"<br /><br />\";\n    echo \"IP\u30a2\u30c9\u30ec\u30b9:\" . $_SERVER[ 'SERVER_ADDR' ] . \"<br />\";\n    echo \"\u6642\u523b\uff1a\" . date(\"Y/m/d H:i:s\"). \"<br />\";\n\n    //DB\u63a5\u7d9a\u3057\u3066SQL\u3067\u6642\u523b\u53d6\u5f97\n    $mysqli = new mysqli('192.168.2.201', 'demo', 'demo_password');\n    if ($mysqli->connect_error) {\n        echo \"fail on connect:\".$mysqli->connect_error;\n        exit();\n    } \n    $mysqli->set_charset(\"utf8\");\n    $res = $mysqli->query(\"SELECT sysdate()\");\n    echo \"DB\u6642\u523b\uff1a\" . $res->fetch_row()[0] . \"<br />\";\n    $res->close();\n    $mysqli->close();    \n\n\nWeb\u30b5\u30fc\u30d0\u30fc\u306bPHP-MySQL\u7528\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3082\u8ffd\u52a0\u3057\u3066\u304a\u304d\u307e\u3057\u3087\u3046\u3002\n\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u90e8\u5206\u3092\u5909\u66f4\u3057\u307e\u3059\u3002\n\nsakura.tf(Web\u30b5\u30fc\u30d0\u306e\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0)\nresource \"sakuracloud_server\" \"server\" {\n#\u4e2d\u7565\n    provisioner \"remote-exec\" {\n        inline = [\n          # php-mysqlnd\u3092\u8ffd\u8a18\n          \"yum install -y httpd httpd-devel php php-mbstring php-mysqlnd\",\n          \"systemctl restart httpd.service\",\n          \"systemctl enable httpd.service\",\n          \"systemctl stop firewalld.service\",\n          \"systemctl disable firewalld.service\"\n        ]\n    }\n#\u4e2d\u7565\n\n\n\nplan\u3068apply\u306e\u5b9f\u884c\n\u4eca\u56de\u306f\u5b9f\u884c\u524d\u306bterraform destroy\u3057\u3066\u304b\u3089\nterraform plan\u3068terraform apply\u3057\u307e\u3057\u3087\u3046\u3002\n\u3046\u307e\u304f\u53cd\u6620\u3055\u308c\u307e\u3057\u305f\u306d\uff1f\nSSH\u63a5\u7d9a\u3057\u305f\u4e0a\u3067ip addr show\u3084ping\u3092\u8a66\u3057\u3066\u304a\u304f\u306e\u3082\u826f\u3044\u3067\u3057\u3087\u3046\u3002\n\u3053\u306e\u6bb5\u968e\u3067\u30d6\u30e9\u30a6\u30b6\u3067Web\u30b5\u30fc\u30d0\u30fc\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u8868\u793a\u306b\u306a\u308b\u306f\u305a\u3067\u3059\u3002\n\n\n\u7b2c3\u6bb5\u968e\uff1a\u30d1\u30b1\u30c3\u30c8\u30d5\u30a3\u30eb\u30bf\u3001\u30b7\u30f3\u30d7\u30eb\u76e3\u8996\u306e\u8ffd\u52a0\n\u3044\u3088\u3044\u3088\u6700\u7d42\u5f62\u3067\u3059\u3002\n\n\n\u30d1\u30b1\u30c3\u30c8\u30d5\u30a3\u30eb\u30bf\u306e\u8ffd\u52a0\n\u30d1\u30b1\u30c3\u30c8\u30d5\u30a3\u30eb\u30bf\u3092\u30b5\u30fc\u30d0\u30fc\u306b\u9069\u7528\n\u30b7\u30f3\u30d7\u30eb\u76e3\u8996\u306e\u8ffd\u52a0\n\n\u3092\u884c\u3044\u307e\u3057\u3087\u3046\u3002\n\n\u30d1\u30b1\u30c3\u30c8\u30d5\u30a3\u30eb\u30bf\u306e\u8ffd\u52a0\n\u30d1\u30b1\u30c3\u30c8\u30d5\u30a3\u30eb\u30bf\u3092\u5408\u8a082\u7a2e\u985e\u5b9a\u7fa9\u3057\u307e\u3059\u3002\n\n1: Web\u30b5\u30fc\u30d0\u30fc\u7528(pf_web)\n2: DB\u30b5\u30fc\u30d0\u30fc\u7528(pf_db)\n\n\u57fa\u672c\u7684\u306a\u30eb\u30fc\u30eb\u306f\n\nICMP\u5fdc\u7b54\u306f\u8a31\u53ef\nSSH\u63a5\u7d9a\u306f\u8a31\u53ef\n\u5fdc\u7b54\u30d1\u30b1\u30c3\u30c8\u306f\u8a31\u53ef\n\u5185\u90e8\u304b\u3089\u5916\u90e8\u3078\u306e\u30d1\u30b1\u30c3\u30c8\u306f\u8a31\u53ef\n\u4ee5\u5916\u306f\u3059\u3079\u3066\u62d2\u5426\n\n\u3068\u3057\u3001Web\u30b5\u30fc\u30d0\u30fc\u7528\u306b\u3064\u3044\u3066\u306f80\u756a\u3001443\u756a\u30dd\u30fc\u30c8\u3092\u8a31\u53ef\u3057\u307e\u3059\u3002\n\u3053\u308c\u3092\u305d\u308c\u305e\u308c\u306e\u30b5\u30fc\u30d0\u30fc\u306eeth0(\u30b0\u30ed\u30fc\u30d0\u30ebIP\u3092\u6301\u3063\u3066\u3044\u308bNIC)\u306b\u9069\u7528\u3057\u307e\u3059\u3002\nDB\u63a5\u7d9a\u306b\u3064\u3044\u3066\u306f\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30cd\u30c3\u30c8\u30ef\u30fc\u30af(192.168.2.0/24)\u7d4c\u7531\u3067\u306e\u30a2\u30af\u30bb\u30b9\u306e\u305f\u3081\u3001\n\u3053\u306e\u30d1\u30b1\u30c3\u30c8\u30d5\u30a3\u30eb\u30bf\u306e\u9069\u7528\u5bfe\u8c61\u5916\u3068\u306a\u308a\u3001\u30b5\u30fc\u30d0\u30fc\u9593\u3067\u306f\u304d\u3061\u3093\u3068\u63a5\u7d9a\u3067\u304d\u307e\u3059\u3002\ntf\u30d5\u30a1\u30a4\u30eb\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\n\n\u30d1\u30b1\u30c3\u30c8\u30d5\u30a3\u30eb\u30bf\u5b9a\u7fa9\nresource \"sakuracloud_packet_filter\" \"pf_web\" {\n    name = \"pf_web\"\n    expressions = {\n        protocol = \"tcp\"\n        source_nw = \"0.0.0.0/0\"\n        dest_port = \"22\"\n        description = \"Allow SSH\"\n        allow = true\n    }\n    expressions = {\n        protocol = \"tcp\"\n        source_nw = \"0.0.0.0/0\"\n        dest_port = \"80\"\n        description = \"Allow www\"\n        allow = true\n    }\n    expressions = {\n        protocol = \"tcp\"\n        source_nw = \"0.0.0.0/0\"\n        dest_port = \"443\"\n        description = \"Allow www(ssl)\"\n        allow = true\n    }\n    expressions = {\n        protocol = \"tcp\"\n        source_nw = \"0.0.0.0/0\"\n        dest_port = \"32768-61000\"\n        description = \"Allow return packet(tcp)\"\n        allow = true\n    }\n    expressions = {\n        protocol = \"udp\"\n        source_nw = \"0.0.0.0/0\"\n        dest_port = \"32768-61000\"\n        description = \"Allow return packet(udp)\"\n        allow = true\n    }\n    expressions = {\n        protocol = \"icmp\"\n        source_nw = \"0.0.0.0\"\n        allow = true\n        description = \"Allow all icmp\"\n    }\n    expressions = {\n        protocol = \"fragment\"\n        source_nw = \"0.0.0.0\"\n        allow = true\n        description = \"Allow all fragment\"\n    }\n    expressions = {\n        protocol = \"ip\"\n        source_nw = \"0.0.0.0\"\n        allow = false\n        description = \"Deny all\"\n    }\n}\n\nresource \"sakuracloud_packet_filter\" \"pf_db\" {\n    name = \"pf_db\"\n    expressions = {\n        protocol = \"tcp\"\n        source_nw = \"0.0.0.0/0\"\n        dest_port = \"22\"\n        description = \"Allow SSH\"\n        allow = true\n    }\n    expressions = {\n        protocol = \"tcp\"\n        source_nw = \"0.0.0.0/0\"\n        dest_port = \"32768-61000\"\n        description = \"Allow return packet(tcp)\"\n        allow = true\n    }\n    expressions = {\n        protocol = \"udp\"\n        source_nw = \"0.0.0.0/0\"\n        dest_port = \"32768-61000\"\n        description = \"Allow return packet(udp)\"\n        allow = true\n    }\n    expressions = {\n        protocol = \"icmp\"\n        source_nw = \"0.0.0.0\"\n        allow = true\n        description = \"Allow all icmp\"\n    }\n    expressions = {\n        protocol = \"fragment\"\n        source_nw = \"0.0.0.0\"\n        allow = true\n        description = \"Allow all fragment\"\n    }\n    expressions = {\n        protocol = \"ip\"\n        source_nw = \"0.0.0.0\"\n        allow = false\n        description = \"Deny all\"\n    }\n}\n\n\n\n\u30d1\u30b1\u30c3\u30c8\u30d5\u30a3\u30eb\u30bf\u3092\u30b5\u30fc\u30d0\u30fc\u306b\u63a5\u7d9a\ntf\u30d5\u30a1\u30a4\u30eb\u306e\u30b5\u30fc\u30d0\u30fc\u90e8\u5206\u3092\u4fee\u6b63\u3057\u307e\u3057\u3087\u3046\u3002\n\nsakura.tf(\u30d1\u30b1\u30c3\u30c8\u30d5\u30a3\u30eb\u30bf\u63a5\u7d9a)\n# web\u30b5\u30fc\u30d0\u30fc\nresource \"sakuracloud_server\" \"server\" {\n    # (\u4e2d\u7565)\n\n    # \u30d1\u30b1\u30c3\u30c8\u30d5\u30a3\u30eb\u30bf\u63a5\u7d9a\n    packet_filter_ids = [\"${sakuracloud_packet_filter.pf_web.id}\"]\n\n   # \u4ee5\u4e0b\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0(\u7701\u7565)\n}\n\n# DB\u30b5\u30fc\u30d0\u30fc\nresource \"sakuracloud_server\" \"server_db\" {\n    # (\u4e2d\u7565)\n\n    # \u30d1\u30b1\u30c3\u30c8\u30d5\u30a3\u30eb\u30bf\u63a5\u7d9a\n    packet_filter_ids = [\"${sakuracloud_packet_filter.pf_db.id}\"]\n\n   # \u4ee5\u4e0b\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0(\u7701\u7565)\n}\n\n\n\n\n\u30b7\u30f3\u30d7\u30eb\u76e3\u8996\u306e\u8ffd\u52a0\n\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u76e3\u8996\u3092\u884c\u3044\u307e\u3059\u3002\n\nping\u306b\u3088\u308b\u6b7b\u6d3b\u76e3\u8996(1\u5206\u9593\u9694)\nWeb\u30b5\u30fc\u30d0\u30fc\u3078\u306eHTTP\u76e3\u8996(/index.php\u3078\u30ea\u30af\u30a8\u30b9\u30c8\u30011\u5206\u9593\u9694)\n\u901a\u77e5\u306fslack\u306b\u5bfe\u3057\u3066\u884c\u3046\n\n\u4e8b\u524d\u306bslack\u9023\u643a\u7528\u306bwebhook\u306eURL\u304c\u5fc5\u8981\u3067\u3059\u3002\n\u5225\u9014slack\u306e\u8a2d\u5b9a\u3092\u884c\u3063\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\n\ntf\u30d5\u30a1\u30a4\u30eb\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002webhook\u306eURL\u306f\u5404\u81ea\u7f6e\u304d\u63db\u3048\u3066\u304f\u3060\u3055\u3044\u3002\n\nsakura.tf(\u30b7\u30f3\u30d7\u30eb\u76e3\u8996)\nvariable \"slack_webhook\" {\n    default = \"https://hooks.slack.com/services/XXXXXXXXX/XXXXXXXXX/XXXXXXXXXXXXXXXXXXXXXXXX\"\n}\n\n# ping\u76e3\u8996(DB\u30b5\u30fc\u30d0\u30fc)\nresource \"sakuracloud_simple_monitor\" \"ping_monitor_db\" {\n    target = \"${sakuracloud_server.server_db.base_nw_ipaddress}\"\n    health_check = {\n        protocol = \"ping\"\n        delay_loop = 60\n    }\n    notify_email_enabled = false\n    notify_slack_enabled = true\n    notify_slack_webhook = \"${var.slack_webhook}\"\n}\n\n# ping\u76e3\u8996(web\u30b5\u30fc\u30d0\u30fc\uff12\u53f0\u5206)\nresource \"sakuracloud_simple_monitor\" \"ping_monitor_web\" {\n    count = 2\n    target = \"${element(sakuracloud_server.server.*.base_nw_ipaddress , count.index)}\"\n    health_check = {\n        protocol = \"ping\"\n        delay_loop = 60\n    }\n    notify_email_enabled = false\n    notify_slack_enabled = true\n    notify_slack_webhook = \"${var.slack_webhook}\"\n}\n# web\u76e3\u8996(web\u30b5\u30fc\u30d0\u30fc2\u53f0\u5206)\nresource \"sakuracloud_simple_monitor\" \"http_monitor_web\" {\n    count = 2\n    target = \"${element(sakuracloud_server.server.*.base_nw_ipaddress , count.index)}\"\n    health_check = {\n        protocol = \"http\"\n        delay_loop = 60\n        path = \"/index.php\"\n        status = \"200\"\n    }\n    notify_email_enabled = false\n    notify_slack_enabled = true\n    notify_slack_webhook = \"${var.slack_webhook}\"\n}\n\n\n\nplan\u3068apply\u306e\u5b9f\u884c\n\u3044\u3088\u3044\u3088\u3067\u3059\u306d\uff01\u65e9\u901f\u5b9f\u884c\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\u3046\u307e\u304f\u3044\u304d\u307e\u3057\u305f\u3088\u306d\uff1f\n\u76e3\u8996\u304c\u3067\u304d\u3066\u3044\u308b\u304b\u8a66\u3057\u306b\u30b5\u30fc\u30d0\u30fc\u3092\u843d\u3068\u3057\u3066\u307f\u305f\u308a\u3057\u3066\u304f\u3060\u3055\u3044\u3002\nslack\u306b\u901a\u77e5\u304c\u304d\u3061\u3093\u3068\u5c4a\u3051\u3070OK\u3067\u3059\u3002\n\n\u6700\u7d42\u7684\u306a\u5b9a\u7fa9\u30d5\u30a1\u30a4\u30eb(tf\u30d5\u30a1\u30a4\u30eb)\n\u4eca\u56de\u306e\u6700\u7d42\u7684\u306atf\u30d5\u30a1\u30a4\u30eb\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u306f\u305a\u3067\u3059\u3002\n(\u30b3\u30e1\u30f3\u30c8\u306a\u3069\u5165\u308c\u3066\u6574\u5f62\u3057\u3066\u3044\u307e\u3059)\n\u3046\u307e\u304f\u3044\u304b\u306a\u3044\u65b9\u306f\u3053\u3061\u3089\u3068\u6bd4\u8f03\u3057\u3066\u307f\u3066\u304f\u3060\u3055\u3044\u3002\n\nsakura.tf(\u7b2c4\u56de\u306e\u6700\u7d42\u5f62)\n/*********************\n * Provider settings\n *********************/\nprovider \"sakuracloud\" {\n    token = \"[ACCESS_TOKEN]\"\n    secret = \"[ACCESS_TOKEN_SECRET]\"\n}\n\n/*****************\n * Variables \n *****************/\nvariable \"slack_webhook\" {\n    default = \"https://hooks.slack.com/services/X0XXX0XXX/X0XXXXXXX/9XXXOxxxxO8XxxX4XX1xxxxx\"\n}\nvariable \"mysql_values\" {\n   default = {\n      root_password = \"mysql_password\"\n      user_name = \"demo\"\n      user_password = \"demo_password\"\n   }\n}\nvariable \"private_ip_addresses\" {\n    default = {\n      server01 = \"192.168.2.101\"\n      server02 = \"192.168.2.102\"\n      server_db = \"192.168.2.201\"\n    }\n}\n\n/*****************\n * Disk\n *****************/\nresource \"sakuracloud_disk\" \"disk\" {\n    name = \"${format(\"disk%02d\" , count.index+1)}\"\n    source_archive_name = \"CentOS 7.2 64bit\"\n    ssh_key_ids = [\"${sakuracloud_ssh_key.mykey.id}\"]\n    disable_pw_auth = true\n    count = 2\n}\nresource \"sakuracloud_disk\" \"disk_db\" {\n    name = \"disk_db\"\n    source_archive_name = \"CentOS 7.2 64bit\"\n    ssh_key_ids = [\"${sakuracloud_ssh_key.dbkey.id}\"]\n    disable_pw_auth = true\n}\n\n/*****************\n * Server \n *****************/\nresource \"sakuracloud_server\" \"server\" {\n    name = \"${format(\"server%02d\" , count.index+1)}\"\n    disks = [\"${element(sakuracloud_disk.disk.*.id,count.index)}\"]\n    additional_interfaces = [\"${sakuracloud_switch.sw01.id}\"]\n    packet_filter_ids = [\"${sakuracloud_packet_filter.pf_web.id}\"]\n    count = 2\n    # \u30b5\u30fc\u30d0\u30fc\u306b\u306fSSH\u3067\u63a5\u7d9a\n    connection {\n       user = \"root\"\n       host = \"${self.base_nw_ipaddress}\"\n       private_key = \"${file(\"./id_rsa\")}\"\n    }\n\n    # yum\u3067apache+PHP\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n    provisioner \"remote-exec\" {\n        inline = [\n          \"yum install -y httpd httpd-devel php php-mbstring php-mysqlnd\",\n          \"systemctl restart httpd.service\",\n          \"systemctl enable httpd.service\",\n          \"systemctl stop firewalld.service\",\n          \"systemctl disable firewalld.service\"\n        ]\n    }\n\n    # Web\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\n    provisioner \"file\" {\n        source = \"webapps/\"\n        destination = \"/var/www/html\"\n    }\n\n    # IP\u8a2d\u5b9a\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\n    provisioner \"file\" {\n        source = \"provision_private_ip.sh\"\n        destination = \"/tmp/provision_private_ip.sh\"\n    }\n\n    # IP\u8a2d\u5b9a\u5b9f\u884c\n    provisioner \"remote-exec\" {\n        inline = [\n          \"chmod +x /tmp/provision_private_ip.sh\",\n          \"/tmp/provision_private_ip.sh ${lookup(var.private_ip_addresses , self.name)}\"\n        ]\n    }\n\n\n}\n\nresource \"sakuracloud_server\" \"server_db\" {\n    name = \"server_db\"\n    disks = [\"${sakuracloud_disk.disk_db.id}\"]\n    additional_interfaces = [\"${sakuracloud_switch.sw01.id}\"]\n    packet_filter_ids = [\"${sakuracloud_packet_filter.pf_db.id}\"]\n\n    # \u30b5\u30fc\u30d0\u30fc\u306b\u306fSSH\u3067\u63a5\u7d9a\n    connection {\n       user = \"root\"\n       host = \"${self.base_nw_ipaddress}\"\n       private_key = \"${file(\"./id_rsa_db\")}\"\n    }\n\n    # yum\u3067mysql\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n    provisioner \"remote-exec\" {\n        inline = [\n          \"yum install -y mysql-community-server\",\n          \"systemctl start mysql.service\",\n          \"mysql -uroot -e 'GRANT ALL ON *.* TO ${var.mysql_values.user_name}@\\\"192.168.2.%\\\" IDENTIFIED BY \\\"${var.mysql_values.user_password}\\\"'\" ,\n          \"mysqladmin -u root password '${var.mysql_values.root_password}'\",\n          \"systemctl stop firewalld.service\",\n          \"systemctl disable firewalld.service\"\n        ]\n    }\n\n    # IP\u8a2d\u5b9a\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\n    provisioner \"file\" {\n        source = \"provision_private_ip.sh\"\n        destination = \"/tmp/provision_private_ip.sh\"\n    }\n\n    # IP\u8a2d\u5b9a\u5b9f\u884c\n    provisioner \"remote-exec\" {\n        inline = [\n          \"chmod +x /tmp/provision_private_ip.sh\",\n          \"/tmp/provision_private_ip.sh ${lookup(var.private_ip_addresses , self.name)}\"\n        ]\n    }\n\n}\n\n/*****************\n * SSH key \n *****************/\nresource \"sakuracloud_ssh_key\" \"mykey\" {\n    name = \"mykey\"\n    public_key = \"${file(\"./id_rsa.pub\")}\"\n}\n\nresource \"sakuracloud_ssh_key\" \"dbkey\" {\n    name = \"dbkey\"\n    public_key = \"${file(\"./id_rsa_db.pub\")}\"\n}\n\n/*****************\n * Switch\n *****************/\nresource \"sakuracloud_switch\" \"sw01\" {\n  name = \"sw01\"\n}\n\n/*****************\n * PacketFilter\n *****************/\nresource \"sakuracloud_packet_filter\" \"pf_web\" {\n    name = \"pf_web\"\n    expressions = {\n        protocol = \"tcp\"\n        source_nw = \"0.0.0.0/0\"\n        dest_port = \"22\"\n        description = \"Allow SSH\"\n        allow = true\n    }\n    expressions = {\n        protocol = \"tcp\"\n        source_nw = \"0.0.0.0/0\"\n        dest_port = \"80\"\n        description = \"Allow www\"\n        allow = true\n    }\n    expressions = {\n        protocol = \"tcp\"\n        source_nw = \"0.0.0.0/0\"\n        dest_port = \"443\"\n        description = \"Allow www(ssl)\"\n        allow = true\n    }\n    expressions = {\n        protocol = \"tcp\"\n        source_nw = \"0.0.0.0/0\"\n        dest_port = \"32768-61000\"\n        description = \"Allow return packet(tcp)\"\n        allow = true\n    }\n    expressions = {\n        protocol = \"udp\"\n        source_nw = \"0.0.0.0/0\"\n        dest_port = \"32768-61000\"\n        description = \"Allow return packet(udp)\"\n        allow = true\n    }\n    expressions = {\n        protocol = \"icmp\"\n        source_nw = \"0.0.0.0\"\n        allow = true\n        description = \"Allow all icmp\"\n    }\n    expressions = {\n        protocol = \"fragment\"\n        source_nw = \"0.0.0.0\"\n        allow = true\n        description = \"Allow all fragment\"\n    }\n    expressions = {\n        protocol = \"ip\"\n        source_nw = \"0.0.0.0\"\n        allow = false\n        description = \"Deny all\"\n    }\n}\nresource \"sakuracloud_packet_filter\" \"pf_db\" {\n    name = \"pf_db\"\n    expressions = {\n        protocol = \"tcp\"\n        source_nw = \"0.0.0.0/0\"\n        dest_port = \"22\"\n        description = \"Allow SSH\"\n        allow = true\n    }\n   expressions = {\n        protocol = \"tcp\"\n        source_nw = \"0.0.0.0/0\"\n        dest_port = \"32768-61000\"\n        description = \"Allow return packet(tcp)\"\n        allow = true\n    }\n    expressions = {\n        protocol = \"udp\"\n        source_nw = \"0.0.0.0/0\"\n        dest_port = \"32768-61000\"\n        description = \"Allow return packet(udp)\"\n        allow = true\n    }\n    expressions = {\n        protocol = \"icmp\"\n        source_nw = \"0.0.0.0\"\n        allow = true\n        description = \"Allow all icmp\"\n    }\n    expressions = {\n        protocol = \"fragment\"\n        source_nw = \"0.0.0.0\"\n        allow = true\n        description = \"Allow all fragment\"\n    }\n    expressions = {\n        protocol = \"ip\"\n        source_nw = \"0.0.0.0\"\n        allow = false\n        description = \"Deny all\"\n    }\n}\n\n/*****************\n * SimpleMonitor\n *****************/\n\n# ping\u76e3\u8996(DB\u30b5\u30fc\u30d0\u30fc)\nresource \"sakuracloud_simple_monitor\" \"ping_monitor_db\" {\n    target = \"${sakuracloud_server.server_db.base_nw_ipaddress}\"\n    health_check = {\n        protocol = \"ping\"\n        delay_loop = 60\n    }\n    notify_email_enabled = false\n    notify_slack_enabled = true\n    notify_slack_webhook = \"${var.slack_webhook}\"\n}\n\n# ping\u76e3\u8996(web\u30b5\u30fc\u30d0\u30fc\uff12\u53f0\u5206)\nresource \"sakuracloud_simple_monitor\" \"ping_monitor_web\" {\n    count = 2\n    target = \"${element(sakuracloud_server.server.*.base_nw_ipaddress , count.index)}\"\n    health_check = {\n        protocol = \"ping\"\n        delay_loop = 60\n    }\n    notify_email_enabled = false\n    notify_slack_enabled = true\n    notify_slack_webhook = \"${var.slack_webhook}\"\n}\n# web\u76e3\u8996(web\u30b5\u30fc\u30d0\u30fc2\u53f0\u5206)\nresource \"sakuracloud_simple_monitor\" \"http_monitor_web\" {\n    count = 2\n    target = \"${element(sakuracloud_server.server.*.base_nw_ipaddress , count.index)}\"\n    health_check = {\n        protocol = \"http\"\n        delay_loop = 60\n        path = \"/index.php\"\n        status = \"200\"\n    }\n    notify_email_enabled = false\n    notify_slack_enabled = true\n    notify_slack_webhook = \"${var.slack_webhook}\"\n}\n\n\n/*****************\n * DNS\n *****************/\nresource \"sakuracloud_dns\" \"dns\" {\n    zone = \"fe-bc.net\"\n    records = {\n        name = \"web\"\n        type = \"A\"\n        value = \"${sakuracloud_server.server.1.base_nw_ipaddress}\"\n    }\n    records = {\n        name = \"web\"\n        type = \"A\"\n        value = \"${sakuracloud_server.server.0.base_nw_ipaddress}\"\n    }\n}\n\n/*****************\n * Output\n *****************/\noutput \"global_ip\" {\n    value = \"${join(\"\\n\" , formatlist(\"%s : %s\" , sakuracloud_server.server.*.name , sakuracloud_server.server.*.base_nw_ipaddress))}\"\n}\noutput \"global_ip_db\" {\n    value = \"${format(\"%s : %s\\n\" , sakuracloud_server.server_db.name , sakuracloud_server.server_db.base_nw_ipaddress)}\"\n}\noutput \"ssh_web01\" {\n    value = \"${format(\"ssh root@%s -i %s/id_rsa\" , sakuracloud_server.server.0.base_nw_ipaddress , path.root)}\"\n}\noutput \"ssh_web02\" {\n    value = \"${format(\"ssh root@%s -i %s/id_rsa\" , sakuracloud_server.server.1.base_nw_ipaddress , path.root)}\"\n}\noutput \"ssh_db\" {\n    value = \"${format(\"ssh root@%s -i %s/id_rsa_db\" , sakuracloud_server.server_db.base_nw_ipaddress , path.root)}\"\n}\n\n\n\n\u307e\u3068\u3081\n\u4eca\u56de\u306f\u76db\u308a\u3060\u304f\u3055\u3093\u3067\u3057\u305f\u306d\uff01\n\nDB\u30b5\u30fc\u30d0\u30fc\u306e\u8ffd\u52a0\n\u30b9\u30a4\u30c3\u30c1\u306e\u8ffd\u52a0 + \u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306e\u69cb\u7bc9\n\u30d1\u30b1\u30c3\u30c8\u30d5\u30a3\u30eb\u30bf\u306e\u8ffd\u52a0\n\u30b7\u30f3\u30d7\u30eb\u76e3\u8996\u306e\u8ffd\u52a0\n\n\u30b7\u30f3\u30d7\u30eb\u306a\u69cb\u6210\u306e\u30b7\u30b9\u30c6\u30e0\u306a\u3089\u5341\u5206\u306b\u5b9f\u7528\u3067\u304d\u308b\u30ec\u30d9\u30eb\u307e\u3067\u8fd1\u3065\u304d\u307e\u3057\u305f\u306d\uff01\n\u6b21\u56de\u306f\u3044\u3088\u3044\u3088\u4ed5\u4e0a\u3052\u3068\u3057\u3066\n\nMySQL \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3 + PHP(mysqlnd_ms)\u306b\u3088\u308b\u30af\u30e9\u30b9\u30bf\u30ea\u30f3\u30b0\n\u6771\u4eac\u3068\u77f3\u72e9\u3067\u30de\u30eb\u30c1\u30be\u30fc\u30f3\u69cb\u6210\nGSLB\u306b\u3088\u308b\u30be\u30fc\u30f3\u9593HA\u69cb\u6210\n\n\u3092\u884c\u3044\u307e\u3059\u3002\u304a\u697d\u3057\u307f\u306b  \n\u6b21\u56de\uff1a\u5b9f\u8df5 Step5\uff1a\u6771\u4eac/\u77f3\u72e9 \u30de\u30eb\u30c1\u30be\u30fc\u30f3\u69cb\u6210\n\n\u304a\u307e\u3051\uff1a\u3055\u304f\u3089\u306e\u30af\u30e9\u30a6\u30c9\u3067503\u30a8\u30e9\u30fc\nterraform destroy\u5b9f\u884c\u6642\u306b\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30a8\u30e9\u30fc\u304c\u51fa\u308b\u3053\u3068\u304c\u3042\u308a\u307e\u3059\u3002\n\n\u3055\u304f\u3089\u306e\u30af\u30e9\u30a6\u30c9503\u30a8\u30e9\u30fc\nError applying plan:\n\n1 error(s) occurred:\n\n* sakuracloud_server.server.0: \nError deleting SakuraCloud Server resource: Error in response:\n&sacloud.ResultErrorValue{\n    IsFatal:true, \n    Serial:\"c843d04c9fc1caaa26e4b1eba649245d\", \n    Status:\"503 Service Unavailable\", \n    ErrorCode:\"busy\", \n    ErrorMessage:\"\u30b5\u30fc\u30d3\u30b9\u304c\u5229\u7528\u3067\u304d\u307e\u305b\u3093\u3002\u30b5\u30fc\u30d0\u304c\u6df7\u96d1\u3057\u3066\u3044\u307e\u3059\u3002\u3057\u3070\u3089\u304f\u6642\u9593\u3092\u304a\u3044\u3066\u304b\u3089\u518d\u5ea6\u304a\u8a66\u3057\u304f\u3060\u3055\u3044\u3002\"\n}\n\nTerraform does not automatically rollback in the face of errors.\nInstead, your Terraform state file has been partially updated with\nany resources that successfully completed. Please address the error\nabove and apply again to incrementally change your infrastructure.\n\n\n\u305f\u304f\u3055\u3093\u306e\u30ea\u30bd\u30fc\u30b9\u3092\u4e00\u6c17\u306bdestroy\u3057\u305f\u5834\u5408\u306a\u3069\u306b\u51fa\u308b\u3053\u3068\u304c\u3042\u308a\u307e\u3059\u3002\n\u614c\u3066\u305a\u9a12\u304c\u305a\u3061\u3087\u3063\u3068\u6642\u9593\u3092\u304a\u3044\u3066terraform destroy\u3092\u518d\u5b9f\u884c\u3057\u307e\u3057\u3087\u3046\u3002\n## \u9023\u8f09\u76ee\u6b21\n\n#### [\u7b2c1\u56de\uff1a\u5c0e\u5165\u7de8](http://qiita.com/yamamoto-febc/items/ae92cd258cf040957487)\n  - \u6982\u8981\n  - \u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n  - \u5b9f\u8df5 Step1\uff1a\u30b5\u30fc\u30d0\u30fc\uff11\u53f0\u69cb\u6210\n\n#### [\u7b2c2\u56de\uff1a\u5b9f\u8df5\u7de8](http://qiita.com/yamamoto-febc/items/2480b11c9e6a8b64f78d)\n  - \u5b9f\u8df5 Step2\uff1a\u69cb\u6210/\u8a2d\u5b9a\u306e\u5909\u66f4\n    - \u30ea\u30bd\u30fc\u30b9\u306e\u8ffd\u52a0\n    - \u30ea\u30bd\u30fc\u30b9\u306e\u5909\u66f4\n    - count\u69cb\u6587\n    - output\u6a5f\u80fd\n\n#### [\u7b2c3\u56de\uff1a\u5b9f\u8df5\u7de82](http://qiita.com/yamamoto-febc/items/fe954e2d4a92b864cfef)\n  - \u5b9f\u8df5 Step3\uff1a\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\n    - \u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u63a5\u7d9a\u8a2d\u5b9a\n    - file\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\n    - remote-exec\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\n    - \u3055\u304f\u3089\u306e\u30af\u30e9\u30a6\u30c9DNS\u30ea\u30bd\u30fc\u30b9\u306e\u5229\u7528\n\n#### **[\u7b2c4\u56de\uff1a\u5fdc\u7528\u7de8](http://qiita.com/yamamoto-febc/items/a9795cb909bd9b69f729)(\u5f53\u8a18\u4e8b)**\n  - \u5b9f\u8df5 Step4\uff1aWeb/DB 2-Tier\u69cb\u6210\n    - MySQL\u306e\u5229\u7528\n    - \u30b9\u30a4\u30c3\u30c1\u306b\u3088\u308b\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306e\u69cb\u7bc9\n    - \u30d1\u30b1\u30c3\u30c8\u30d5\u30a3\u30eb\u30bf/\u30b7\u30f3\u30d7\u30eb\u7ba1\u7406:Slack\u901a\u77e5\u306e\u5229\u7528\n\n#### [\u7b2c5\u56de\uff1a\u5fdc\u7528\u7de82](http://qiita.com/yamamoto-febc/items/4b774404e041fa05688a)\n  - \u5b9f\u8df5 Step5\uff1a\u6771\u4eac/\u77f3\u72e9 \u30de\u30eb\u30c1\u30be\u30fc\u30f3\u69cb\u6210\n    - \u6771\u4eac\u3068\u77f3\u72e9\u3067\u30de\u30eb\u30c1\u30be\u30fc\u30f3\u69cb\u6210\n    - GSLB\u306b\u3088\u308b\u30be\u30fc\u30f3\u9593HA\u69cb\u6210\n    - MySQL \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3 + PHP(mysqlnd_ms)\u306b\u3088\u308bDB\u306e\u30af\u30e9\u30b9\u30bf\u30ea\u30f3\u30b0\n    - `null_resource`\u3084`template_file`\u306a\u3069\u306e\u7279\u6b8a\u306a\u30ea\u30bd\u30fc\u30b9\n    - tf\u30d5\u30a1\u30a4\u30eb\u306e\u30ea\u30d5\u30a1\u30af\u30bf\u30ea\u30f3\u30b0\u3068\u30e2\u30b8\u30e5\u30fc\u30eb\u5316\n\n---   \n\n\n\u9023\u8f09\u7b2c4\u56de\u3067\u3059\u3002\n[\u7b2c1\u56de](http://qiita.com/yamamoto-febc/items/ae92cd258cf040957487)\u304b\u3089\u9806\u756a\u306b\u304a\u8aad\u307f\u304f\u3060\u3055\u3044\u3002\n\n[\u7b2c4\u56de\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9](https://github.com/yamamoto-febc/terraform-for-sakuracloud-start-guide/tree/no4) / [\u7b2c3\u56de\u3068\u306e\u5dee\u5206\u8868\u793a](https://github.com/yamamoto-febc/terraform-for-sakuracloud-start-guide/compare/no3...no4)\n\n\n---\n\n# \u5b9f\u8df5 Step4\uff1aWeb/DB 2-Tier\u69cb\u6210\n\n\u3044\u3088\u3044\u3088\u5fdc\u7528\u7de8\u306b\u306a\u308a\u307e\u3059\u3002\nTerraform\u306e\u57fa\u672c\u7684\u306a\u64cd\u4f5c\u3092\u99c6\u4f7f\u3057\u3066\u5b9f\u904b\u7528\u306b\u8010\u3048\u308b\u30a4\u30f3\u30d5\u30e9\u3092\u69cb\u7bc9\u3057\u3066\u3044\u304d\u307e\u3057\u3087\u3046\u3002\n\n\u524d\u56de(\u7b2c3\u56de)\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u69cb\u6210\u3067\u3057\u305f\u3002\n\n![servers03.png](https://qiita-image-store.s3.amazonaws.com/0/20668/41304bb4-97e2-4ef1-b2d0-997e486398f8.png)\n\n\uff12\u53f0\u306eWeb\u30b5\u30fc\u30d0\u306b\u52a0\u3048\u3066DNS\u3078\u306e\u767b\u9332\u3082\u884c\u3063\u3066\u3044\u307e\u3057\u305f\u306d\u3002\n\u73fe\u6642\u70b9\u3067\u3082\u5916\u90e8\u304b\u3089\u306e\u63a5\u7d9a\u304c\u3067\u304d\u308b\u72b6\u614b\u306a\u306e\u3067\u3059\u304c\u3001\n\u4eca\u56de\u306f\u672c\u756a\u904b\u7528\u610f\u8b58\u3057\u3066\u69cb\u6210\u3092\u5909\u66f4\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n#### Web\u5c64/DB\u5c64\u306e\uff12\u968e\u5c64(2-tier)\u5316\n\n\u30b9\u30a4\u30c3\u30c1\u3092\u8ffd\u52a0\u3057\u3066\u3001DB\u3092\u914d\u7f6e\u3059\u308b\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u306a\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3092\u69cb\u7bc9\u3057\u307e\u3059\u3002\n\u4ee5\u4e0b\u306e\u30ea\u30bd\u30fc\u30b9\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\n  - \u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u7528\u306b\u30b9\u30a4\u30c3\u30c1(sw01)\u3092\u8ffd\u52a0\n  - \u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u5185\u306bDB\u30b5\u30fc\u30d0\u30fc(server_db + disk_db)\u3092\u8ffd\u52a0\n\nDB\u30b5\u30fc\u30d0\u30fc\u3067\u306fMySQL\u3092\u7a3c\u50cd\u3055\u305b\u307e\u3059\u3002\n\n#### \u975e\u6a5f\u80fd\u8981\u4ef6\u5bfe\u5fdc\n\n\u672c\u756a\u904b\u7528\u6642\u306b\u306f\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u5bfe\u5fdc\u3084\u76e3\u8996/\u6e2c\u5b9a\u3001\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306a\u3069\u306e\u975e\u6a5f\u80fd\u8981\u4ef6\u3082\u6e80\u305f\u3059\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u4eca\u56de\u306f\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306f\u624b\u52d5\u3001\u76e3\u8996\u306f\u901a\u77e5\u3060\u3051\u6765\u308b\u3088\u3046\u306b\u3057\u3066\u304a\u304d\u5fa9\u65e7\u306f\u624b\u52d5\u3067\u884c\u3046\u3082\u306e\u3068\u3057\u3066\u3001\n\u4ee5\u4e0b\u306e\u5bfe\u5fdc\u3060\u3051\u884c\u3044\u307e\u3059\u3002\n\n  - \u30d1\u30b1\u30c3\u30c8\u30d5\u30a3\u30eb\u30bf\u3092\u8ffd\u52a0\u3057\u3066\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u5bfe\u7b56\n  - [\u30b7\u30f3\u30d7\u30eb\u76e3\u8996](http://cloud-news.sakura.ad.jp/simplemonitor/)\u3067\u76e3\u8996 + Slack\u3078\u901a\u77e5\n\n\n#### \u4eca\u56de\u306e\u6700\u7d42\u7684\u306a\u69cb\u6210\n\n![server04.png](https://qiita-image-store.s3.amazonaws.com/0/20668/26ccbdc7-4147-7b01-4dc4-94e65457a6a7.png)\n\n\u306a\u3093\u3060\u304b\u4e00\u6c17\u306b\u30ea\u30bd\u30fc\u30b9\u304c\u8ffd\u52a0\u3055\u308c\u3066\u8907\u96d1\u306b\u306a\u3063\u3066\u304d\u307e\u3057\u305f\u306d\u3002\n\n\u3067\u3082\u5927\u4e08\u592b\u3067\u3059\u3002\nTerraform\u3092\u4f7f\u3046\u306e\u3067\u3042\u308c\u3070\u3001\u30c8\u30e9\u30a4&\u30a8\u30e9\u30fc\u3067\u5b9a\u7fa9\u30d5\u30a1\u30a4\u30eb(tf\u30d5\u30a1\u30a4\u30eb)\u3092\n:star:**\u80b2\u3066\u3066**:star: \u3044\u3051\u3070\u3044\u3044\u3093\u3067\u3059\u3002\ntf\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u3063\u3066\u30c6\u30b9\u30c8\u3057\u3066\u304a\u3051\u3070\u305d\u306e\u74b0\u5883\u306e\u518d\u73fe\u306f\u7c21\u5358\u306a\u3093\u3067\u3059\u304b\u3089\u306d\u3002\n\n\u3067\u306f\u65e9\u901f\u5b9f\u8df5\u3057\u3066\u3044\u304d\u307e\u3057\u3087\u3046\u3002\n\n# \u5b9f\u8df5\n\n## \u7b2c1\u6bb5\u968e\uff1aDB\u30b5\u30fc\u30d0\u30fc\u8ffd\u52a0\n\n\u307e\u305a\u306fDB\u30b5\u30fc\u30d0\u30fc\u3092\u8ffd\u52a0\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\u3053\u306e\u6bb5\u968e\u3067\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u69cb\u6210\u306b\u306a\u308a\u307e\u3059\u3002\n\n![server04_part1.png](https://qiita-image-store.s3.amazonaws.com/0/20668/e55d048e-c55d-6143-51f9-b49c8072491a.png)\n\nDB\u30b5\u30fc\u30d0\u30fc\u3068Web\u30b5\u30fc\u30d0\u30fc\u3068\u3067\u306f\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u8981\u4ef6\u304c\u7570\u306a\u308b\u305f\u3081\u3001\nSSH\u516c\u958b\u9375\u306fWeb\u5c64(server01\u306802)\u3068\u306f\u5225\u306e\u3082\u306e\u3092\u4f7f\u3046\u3088\u3046\u306b\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\u8ffd\u52a0\u3059\u308b\u30ea\u30bd\u30fc\u30b9\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\n\n  - \u30b5\u30fc\u30d0\u30fc(server_db)\n  - \u30c7\u30a3\u30b9\u30af(disk_db)\n  - SSH\u516c\u958b\u9375(dbkey)\n\n\u52a0\u3048\u3066\u3001DB\u30b5\u30fc\u30d0\u30fc\u306e\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u3082\u884c\u3063\u3066\u304a\u304d\u307e\u3059\u3002\n\u3055\u304f\u3089\u306e\u30af\u30e9\u30a6\u30c9\u306e\u30d1\u30d6\u30ea\u30c3\u30af\u30a2\u30fc\u30ab\u30a4\u30d6\u304b\u3089CentOS7.2\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u5834\u5408\u3001\nmysql community\u306eyum\u30ea\u30dd\u30b8\u30c8\u30ea\u304c\u3059\u3067\u306b\u767b\u9332\u3055\u308c\u3066\u304a\u308a\u3001\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304c\u5bb9\u6613\u306a\u305f\u3081\nMySQL5.6\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n\u3059\u3067\u306b\u524d\u56de\u307e\u3067\u306b\u51fa\u3066\u304d\u305f\u30c6\u30af\u30cb\u30c3\u30af\u3060\u3051\u3067\u5bfe\u5fdc\u3067\u304d\u307e\u3059\u306d\uff01\n\n### \u6e96\u5099\n\nDB\u30b5\u30fc\u30d0\u30fc\u7528\u306b\u30ad\u30fc\u30da\u30a2\u3092\u4f5c\u6210\u3057\u307e\u3057\u3087\u3046\u3002\n\n\n```bash:SSH\u7528\u30ad\u30fc\u30da\u30a2\u4f5c\u6210\n$ ssh-keygen -C \"\" -f ./id_rsa_db\nGenerating public/private rsa key pair.\nEnter passphrase (empty for no passphrase):  #\u4f55\u3082\u5165\u529b\u305b\u305aEnter\nEnter same passphrase again:                 #\u4f55\u3082\u5165\u529b\u305b\u305aEnter\n\n```\n\n\u30ab\u30ec\u30f3\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b`id_rsa_db`\u3068`id_rsa_db.pub`\u304c\u4f5c\u6210\u3055\u308c\u3066\u3044\u308b\u306f\u305a\u3067\u3059\u3002\n\n### \u5b9a\u7fa9\u30d5\u30a1\u30a4\u30eb(tf\u30d5\u30a1\u30a4\u30eb)\u7de8\u96c6\n\n\u305d\u308c\u3067\u306ftf\u30d5\u30a1\u30a4\u30eb\u3092\u7de8\u96c6\u3057\u307e\u3057\u3087\u3046\u3002\u524d\u56de\u307e\u3067\u306etf\u30d5\u30a1\u30a4\u30eb\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\n\n```sakura.tf(\u524d\u56de\u307e\u3067\u306etf\u30d5\u30a1\u30a4\u30eb\u5168\u4f53)\nprovider \"sakuracloud\" {\n    token = \"[ACCESS_TOKEN]\"\n    secret = \"[ACCESS_TOKEN_SECRET]\"\n}\n\nresource \"sakuracloud_disk\" \"disk\" {\n    name = \"${format(\"disk%02d\" , count.index+1)}\"\n    source_archive_name = \"CentOS 7.2 64bit\"\n    ssh_key_ids = [\"${sakuracloud_ssh_key.mykey.id}\"]\n    disable_pw_auth = true\n    count = 2\n}\n\nresource \"sakuracloud_server\" \"server\" {\n    name = \"${format(\"server%02d\" , count.index+1)}\"\n    disks = [\"${element(sakuracloud_disk.disk.*.id,count.index)}\"]\n    count = 2\n    # 1: \u30b5\u30fc\u30d0\u30fc\u306b\u306fSSH\u3067\u63a5\u7d9a\n    connection {\n       user = \"root\"\n       host = \"${self.base_nw_ipaddress}\"\n       private_key = \"${file(\"./id_rsa\")}\"\n    }\n\n    # \uff12\uff1a yum\u3067apache+PHP\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000provisioner \"remote-exec\" {\n        inline = [\n          \"yum install -y httpd httpd-devel php php-mbstring\",\n          \"chkconfig httpd on\"\n        ]\n   }\n\n   # 3: Web\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\n   provisioner \"file\" {\n        source = \"webapps/\"\n        destination = \"/var/www/html\"\n   }\n\n}\n\nresource \"sakuracloud_ssh_key\" \"mykey\" {\n    name = \"mykey\"\n    public_key = \"${file(\"./id_rsa.pub\")}\"\n}\n\nresource \"sakuracloud_dns\" \"dns\" {\n    zone = \"fe-bc.net\"\n    records = {\n        name = \"web\"\n        type = \"A\"\n        value = \"${sakuracloud_server.server.0.base_nw_ipaddress}\"\n    }\n    records = {\n        name = \"web\"\n        type = \"A\"\n        value = \"${sakuracloud_server.server.1.base_nw_ipaddress}\"\n    }\n}\n\noutput \"global_ip\" {\n    value = \"${join(\"\\n\" , formatlist(\"%s : %s\" , sakuracloud_server.server.*.name , sakuracloud_server.server.*.base_nw_ipaddress))}\"\n}\n```\n\n\u3053\u3053\u306b\u4eca\u56de\u306e\u30ea\u30bd\u30fc\u30b9\u3092\u8db3\u3057\u3066\u3044\u304d\u307e\u3057\u3087\u3046\u3002\n\u4ee5\u4e0b\u3092\u8ffd\u8a18\u3057\u307e\u3059\u3002MySQL\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u306f\u4efb\u610f\u306e\u3082\u306e\u3092\u8a2d\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n```sakura.tf(\u8ffd\u52a0\u5206)\n\nvariable \"mysql_values\" {\n   default = {\n      # MySQL\u306eroot\u30e6\u30fc\u30b6\u30fc\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\n      root_password = \"mysql_password\"\n      # MySQL\u30c7\u30e2\u30a2\u30d7\u30ea\u7528\u30e6\u30fc\u30b6\u30fc\u306e\u540d\u524d\n      user_name = \"demo\"\n      # MySQL\u30c7\u30e2\u30a2\u30d7\u30ea\u7528\u30e6\u30fc\u30b6\u30fc\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\n      user_password = \"demo_password\"\n   }\n}\n\nresource \"sakuracloud_ssh_key\" \"dbkey\" {\n    name = \"dbkey\"\n    public_key = \"${file(\"./id_rsa_db.pub\")}\"\n}\n\nresource \"sakuracloud_disk\" \"disk_db\" {\n    name = \"disk_db\"\n    source_archive_name = \"CentOS 7.2 64bit\"\n    ssh_key_ids = [\"${sakuracloud_ssh_key.dbkey.id}\"]\n    disable_pw_auth = true\n}\n\nresource \"sakuracloud_server\" \"server_db\" {\n    name = \"server_db\"\n    disks = [\"${sakuracloud_disk.disk_db.id}\"]\n    # \u30b5\u30fc\u30d0\u30fc\u306b\u306fSSH\u3067\u63a5\u7d9a\n    connection {\n       user = \"root\"\n       host = \"${self.base_nw_ipaddress}\"\n       private_key = \"${file(\"./id_rsa_db\")}\"\n    }\n\n    provisioner \"remote-exec\" {\n        inline = [\n          \"yum install -y mysql-community-server\",\n          \"systemctl start mysql.service\",\n          \"mysql -uroot -e 'GRANT ALL ON *.* TO ${var.mysql_values.user_name}@\\\"192.168.2.%\\\" IDENTIFIED BY \\\"${var.mysql_values.user_password}\\\"'\" ,\n          \"mysqladmin -u root password '${var.mysql_values.root_password}'\",\n          \"systemctl stop firewalld.service\",\n          \"systemctl disable firewalld.service\"\n        ]\n    }\n}\n```\n\n#### \u30dd\u30a4\u30f3\u30c8:`variable`\n\n`variable`\u3068\u3044\u3046\u8a18\u8ff0\u304c\u65b0\u305f\u306b\u51fa\u3066\u304d\u307e\u3057\u305f\u306d\u3002\n\u3053\u308c\u306ftf\u30d5\u30a1\u30a4\u30eb\u5185\u3067\u5229\u7528\u51fa\u6765\u308b\u5909\u6570\u3092\u5b9a\u7fa9\u3059\u308b\u3082\u306e\u3067\u3059\u3002\n`variable`\u3067\u5b9a\u7fa9\u3057\u3066\u304a\u3044\u305f\u5024\u306f\u3001`${var.\u5909\u6570\u540d}`\u3067\u53c2\u7167\u3067\u304d\u307e\u3059\u3002\n\u307e\u305f\u3001variable\u306f\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u304b\u3089\u4e0e\u3048\u305f\u308a\u3001\u5225\u9014\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u7528\u610f\u3057\u3066\u304a\u3044\u3066\n\u4e0e\u3048\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002(tfvar\u30d5\u30a1\u30a4\u30eb)\n`variable`\u306b\u3064\u3044\u3066\u306e\u8a73\u7d30\u306a\u8aac\u660e\u306f[Terraform\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](https://www.terraform.io/intro/getting-started/variables.html)\u3092\u53c2\u7167\u304f\u3060\u3055\u3044\u3002\n\n\u3053\u3053\u3067\u306fMySQL\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3001MySQL\u30e6\u30fc\u30b6\u30fc\u306e\u8ffd\u52a0\u3001MySQL\u306eroot\u30d1\u30b9\u30ef\u30fc\u30c9\u306e\u8a2d\u5b9a\u307e\u3067\u3092\u884c\u3063\u3066\u3044\u307e\u3059\u3002\n\n**\u6ce8\u610f**\n\u4eca\u56de\u306f\u8a2d\u5b9a\u3092\u7c21\u5358\u306b\u3059\u308b\u305f\u3081\u306bmysql\u306eroot\u30e6\u30fc\u30b6\u30fc\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u3092`mysqladmin`\u30b3\u30de\u30f3\u30c9\u3067\n\u5b9f\u884c\u3059\u308b\u3060\u3051\u306e\u521d\u671f\u5316\u3068\u3057\u3066\u3044\u307e\u3059\u304c\u3001\u5b9f\u969b\u306b\u904b\u7528\u3059\u308b\u969b\u306fmysql_secure_instration\u76f8\u5f53\u306e\u51e6\u7406\u3092\u884c\u3046\u306a\u3069\u3001\u5341\u5206\u306b\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u306b\u914d\u616e\u304f\u3060\u3055\u3044\u3002\n\n### output\u306e\u8ffd\u52a0\n\n\u3053\u306e\u307e\u307e\u3067\u306f`output`\u306bDB\u30b5\u30fc\u30d0\u30fc\u306e\u30b0\u30ed\u30fc\u30d0\u30ebIP\u304c\u8868\u793a\u3055\u308c\u307e\u305b\u3093\u306e\u3067\u3001\nDB\u30b5\u30fc\u30d0\u30fc\u306e\u30b0\u30ed\u30fc\u30d0\u30ebIP\u8868\u793a\u7528\u306b`output`\u3092\u5b9a\u7fa9\u3057\u307e\u3057\u3087\u3046\u3002\n\u3064\u3044\u3067\u306bSSH\u63a5\u7d9a\u88dc\u52a9\u3082`output`\u5b9a\u7fa9\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n\u4ee5\u4e0b\u3092\u8ffd\u8a18\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n```sakura.tf(SSH\u63a5\u7d9a\u88dc\u52a9output\u8ffd\u8a18)\noutput \"global_ip_db\" {\n    value = \"${format(\"%s : %s\\n\" , sakuracloud_server.server_db.name , sakuracloud_server.server_db.base_nw_ipaddress)}\"\n}\noutput \"ssh_web01\" {\n    value = \"${format(\"ssh root@%s -i %s/id_rsa\" , sakuracloud_server.server.0.base_nw_ipaddress , path.root)}\"\n}\noutput \"ssh_web02\" {\n    value = \"${format(\"ssh root@%s -i %s/id_rsa\" , sakuracloud_server.server.1.base_nw_ipaddress , path.root)}\"\n}\noutput \"ssh_db\" {\n    value = \"${format(\"ssh root@%s -i %s/id_rsa_db\" , sakuracloud_server.server_db.base_nw_ipaddress , path.root)}\"\n}\n```\n\n\u3053\u308c\u3067`terraform output ssh_web01`\u3068\u5b9f\u884c\u3059\u308c\u3070ssh\u30b3\u30de\u30f3\u30c9\u304c\u51fa\u529b\u3055\u308c\u307e\u3059\u3002\n`$(terraform output ssh_web01)`\u306a\u3069\u3068\u3059\u308c\u3070\u5b9f\u884c\u3067\u304d\u307e\u3059\u3088!\n\n\u4ee5\u5f8c\u4f5c\u6210\u3057\u305f\u30b5\u30fc\u30d0\u30fc\u306bSSH\u3059\u308b\u969b\u306f\u4ee5\u4e0b\u30b3\u30de\u30f3\u30c9\u3067OK\u3067\u3059\u3002\n\n  - Web\u30b5\u30fc\u30d0(server01) : `$(terraform output ssh_web01)`\n  - Web\u30b5\u30fc\u30d0(server02) : `$(terraform output ssh_web02)`\n  - DB\u30b5\u30fc\u30d0(server_db) : `$(terraform output ssh_db)`\n\n### `plan`\u3068`apply`\u306e\u5b9f\u884c\n\n\u3055\u3066\u3001\u3044\u3064\u3082\u901a\u308a`terraform plan`\u3057\u3066\u304b\u3089`terraform apply`\u3057\u307e\u3057\u3087\u3046\u3002\nDB\u30b5\u30fc\u30d0\u30fc\u304c\u8ffd\u52a0\u3055\u308c\u307e\u3057\u305f\u304b\uff1f\nSSH\u63a5\u7d9a\u3059\u308b\u306a\u3069\u3067\u52d5\u4f5c\u78ba\u8a8d\u3082\u3057\u3066\u304a\u304d\u307e\u3057\u3087\u3046\u3002\n\n## \u7b2c2\u6bb5\u968e\uff1a\u30b9\u30a4\u30c3\u30c1\u8ffd\u52a0\u3067\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3068\u63a5\u7d9a\n\n\u3067\u306f\u7d9a\u3044\u3066\u30b9\u30a4\u30c3\u30c1\u3092\u8ffd\u52a0\u3057\u307e\u3057\u3087\u3046\u3002\n\u3053\u3093\u306a\u611f\u3058\u306b\u306a\u308a\u307e\u3059\u3002\n\n![server04_part2.png](https://qiita-image-store.s3.amazonaws.com/0/20668/782c4fca-fe4f-0f3e-376e-2876f4c2031d.png)\n\n\u3084\u308b\u3053\u3068\u306f\n \n  - \u30b9\u30a4\u30c3\u30c1\u7528\u30ea\u30bd\u30fc\u30b9(sakuracloud_switch)\u306e\u8ffd\u52a0\n  - \u30b9\u30a4\u30c3\u30c1\u3068\u30b5\u30fc\u30d0\u30fc\u306e\u63a5\u7d9a\n  - \u30d7\u30e9\u30a4\u30d9\u30fc\u30c8IP\u306e\u5272\u308a\u632f\u308a(\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u3067\u5b9f\u65bd)\n\n\u3067\u3059\u3002\n\u307e\u305f\u3001Web\u30b5\u30fc\u30d0\u30fc\u3068DB\u30b5\u30fc\u30d0\u30fc\u9593\u3092\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3067\u63a5\u7d9a\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u306e\u3067\u3001\n\u30c7\u30e2\u7528\u306eWeb\u30a2\u30d7\u30ea(PHP)\u3082DB\u3092\u4f7f\u3046\u3088\u3046\u306b\u5909\u66f4\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n\n\u9806\u756a\u306b\u3044\u304d\u307e\u3057\u3087\u3046\u3002\n\n### \u30b9\u30a4\u30c3\u30c1\u7528\u30ea\u30bd\u30fc\u30b9\u306e\u5b9a\u7fa9\n\n\u3044\u3064\u3082\u901a\u308atf\u30d5\u30a1\u30a4\u30eb\u306b\u8ffd\u8a18\u3057\u307e\u3057\u3087\u3046\u3002\n\u4ee5\u4e0b\u3092\u8ffd\u8a18\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n```sakura.tf(\u30b9\u30a4\u30c3\u30c1\u8ffd\u52a0)\nresource \"sakuracloud_switch\" \"sw01\"{\n    name = \"sw01\"\n}\n```\n\n\u3048\u3063\uff1f\u3053\u308c\u3060\u3051\uff1f\n\u306f\u3044\u3002\u30b9\u30a4\u30c3\u30c1\u306f\u8a2d\u5b9a\u9805\u76ee\u304c\u5c11\u306a\u3044\u306e\u3067\u3059\u3001\u3001\n\n### \u30b9\u30a4\u30c3\u30c1\u3068\u30b5\u30fc\u30d0\u30fc\u306e\u63a5\u7d9a\n\n\u30b5\u30fc\u30d0\u30fc\u306e\u5b9a\u7fa9\u90e8\u5206\u3092\u4fee\u6b63\u3057\u307e\u3057\u3087\u3046\u3002\n\n```sakura.tf(\u30b5\u30fc\u30d0\u30fc\u3068\u30b9\u30a4\u30c3\u30c1\u306e\u63a5\u7d9a)\n# Web\u30b5\u30fc\u30d0\u30fc\nresource \"sakuracloud_server\" \"server\" {\n    #(\u4e2d\u7565) \n\n    # \u30b9\u30a4\u30c3\u30c1\u3068\u63a5\u7d9a\u3059\u308b\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u3092\u5b9a\u7fa9\n    additional_interfaces = [\"${sakuracloud_switch.sw01.id}\"]\n \n   # \u4ee5\u4e0b\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0(\u7701\u7565)\n}\n# DB\u30b5\u30fc\u30d0\u30fc\nresource \"sakuracloud_server\" \"server_db\" {\n    #(\u4e2d\u7565) \n\n    # \u30b9\u30a4\u30c3\u30c1\u3068\u63a5\u7d9a\u3059\u308b\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u3092\u5b9a\u7fa9\n    additional_interfaces = [\"${sakuracloud_switch.sw01.id}\"]\n \n   # \u4ee5\u4e0b\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0(\u7701\u7565)\n}\n\n```\n\n### \u30d7\u30e9\u30a4\u30d9\u30fc\u30c8IP\u306e\u5272\u308a\u5f53\u3066(\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0)\n\n\u3053\u308c\u3067\u5404\u30b5\u30fc\u30d0\u30fc\u306b\u5148\u307b\u3069\u8ffd\u52a0\u3057\u305f\u30b9\u30a4\u30c3\u30c1\u306b\u63a5\u7d9a\u3057\u305f\u72b6\u614b\u306eNIC\u304c\u8ffd\u52a0\u3055\u308c\u3066\u3044\u307e\u3059\u3002(eth1)\neth1\u306bIP\u30a2\u30c9\u30ec\u30b9\u3092\u8a2d\u5b9a\u3059\u308b\u3088\u3046\u306b\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u3057\u307e\u3057\u3087\u3046\u3002\n\n\u307e\u305a\u306f\u624b\u5143\u306e\u30de\u30b7\u30f3\u3067\u4ee5\u4e0b\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u4f5c\u6210\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n```bash:IP\u8a2d\u5b9a\u7528\u30b9\u30af\u30ea\u30d7\u30c8\u4f5c\u6210\n$ vi provision_private_ip.sh\n```\n\n```bash:provision_private_ip.sh\n#!/bin/sh\n\n# eth1\u306eIP\u8a2d\u5b9a\ncat << EOS >> /etc/sysconfig/network-scripts/ifcfg-eth1\nBOOTPROTO=static\nPREFIX0=24\nDEVICE=eth1\nIPADDR0=$1\nONBOOT=yes\nEOS\n\n#\u53cd\u6620\nifdown eth1; ifup eth1\n```\n\n\u5f15\u6570\u3067\u53d7\u3051\u53d6\u3063\u305fIP\u30a2\u30c9\u30ec\u30b9\u3092eth1\u306b\u8a2d\u5b9a\u3059\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u3067\u3059\u3002\n\u3053\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u3092Terraform\u306e\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u6a5f\u80fd\u3067\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9&\u5b9f\u884c\u3059\u308b\u3053\u3068\u3067IP\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n\u3067\u306ftf\u30d5\u30a1\u30a4\u30eb\u306b\u8a18\u8f09\u3057\u307e\u3057\u3087\u3046\u3002\n\n```sakura.tf(\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8IP\u5272\u308a\u632f\u308a)\n\nvariable \"private_ip_addresses\" {\n    default {\n      server01 : \"192.168.2.101\"\n      server02 : \"192.168.2.102\"\n      server_db : \"192.168.2.201\"\n    }\n}\n\n# Web\u30b5\u30fc\u30d0\u30fc\nresource \"sakuracloud_server\" \"server\" {\n    #(\u4e2d\u7565) \n        \n    # \u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u5b9a\u7fa9\u306b\u4ee5\u4e0b\u3092\u8ffd\u8a18\n    # IP\u8a2d\u5b9a\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\n    provisioner \"file\" {\n        source = \"provision_private_ip.sh\"\n        destination = \"/tmp/provision_private_ip.sh\"\n    }\n\n    # IP\u8a2d\u5b9a\u5b9f\u884c\n    provisioner \"remote-exec\" {\n        inline = [\n          \"chmod +x /tmp/provision_private_ip.sh\",\n          \"/tmp/provision_private_ip.sh ${lookup(var.private_ip_addresses , self.name)}\"\n        ]\n    }\n}\n\n# DB\u30b5\u30fc\u30d0\u30fc\nresource \"sakuracloud_server\" \"server\" {\n    #(\u4e2d\u7565) \n        \n    # \u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u5b9a\u7fa9\u306b\u4ee5\u4e0b\u3092\u8ffd\u8a18\n    # IP\u8a2d\u5b9a\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\n    provisioner \"file\" {\n        source = \"provision_private_ip.sh\"\n        destination = \"/tmp/provision_private_ip.sh\"\n    }\n\n    # IP\u8a2d\u5b9a\u5b9f\u884c\n    provisioner \"remote-exec\" {\n        inline = [\n          \"chmod +x /tmp/provision_private_ip.sh\",\n          \"/tmp/provision_private_ip.sh ${lookup(var.private_ip_addresses , self.name)}\"\n        ]\n    }\n}\n\n```\n\n#### \u30dd\u30a4\u30f3\u30c8:`lookup`\n\n\u3053\u3053\u3067\u306f\u3001\u30b5\u30fc\u30d0\u30fc\u540d\u3068\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8IP\u306e\u5bfe\u5fdc\u95a2\u4fc2\u3092`variable`\u3068\u3057\u3066\u5b9a\u7fa9\u3057\u3066\u304a\u304d\u3001\n`${lookup}`\u3067\u30b5\u30fc\u30d0\u30fc\u540d\u3092\u30ad\u30fc\u3068\u3057\u3066\u6301\u3064\u5024\u3092\u53c2\u7167\u3057\u3066\u3044\u307e\u3059\u3002\ntf\u30d5\u30a1\u30a4\u30eb\u306e\u8a18\u8ff0\u3092\u30b9\u30c3\u30ad\u30ea\u3055\u305b\u308b\u306e\u306b\u6709\u52b9\u306a\u30c6\u30af\u30cb\u30c3\u30af\u3067\u3059\u3002\n\n### Web\u30a2\u30d7\u30ea\u306e\u4fee\u6b63\n\n\u30c7\u30e2\u7528\u306eWeb\u30a2\u30d7\u30ea\u3092DB\u306b\u7e4b\u3050\u3088\u3046\u306b\u4fee\u6b63\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\u4eca\u56de\u306f\u30c7\u30e2\u76ee\u7684\u3067\u3059\u306e\u3067\u5358\u7d14\u306bDB\u306b\u63a5\u7d9a\u3057\u3066\u5024\u304c\u53d6\u308c\u3066\u3044\u308c\u3070\u5341\u5206\u3067\u3059\u3002\n\u3088\u3063\u3066\u3001`index.php`\u306bDB\u63a5\u7d9a\u51e6\u7406\u3092\u76f4\u63a5\u66f8\u3044\u3061\u3083\u3044\u307e\u3059\u3002\n`webapps/index.php`\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u66f4\u3057\u307e\u3057\u3087\u3046\u3002\n\n**MySQL\u306e\u30e6\u30fc\u30b6\u30fc\u540d/\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u5909\u66f4\u3057\u3066\u3044\u308b\u5834\u5408\u306f\n`new mysqli`\u306e\u5f15\u6570\u90e8\u5206\u3082\u4fee\u6b63\u3057\u3066\u304f\u3060\u3055\u3044**\n\n```webapps/index.php\n<?php\n    date_default_timezone_set('Asia/Tokyo');\n    echo \"Terraform for \u3055\u304f\u3089\u306e\u30af\u30e9\u30a6\u30c9 \u30b9\u30bf\u30fc\u30c8\u30ac\u30a4\u30c9\u7528\u30c7\u30e2\". \"<br /><br />\";\n    echo \"IP\u30a2\u30c9\u30ec\u30b9:\" . $_SERVER[ 'SERVER_ADDR' ] . \"<br />\";\n    echo \"\u6642\u523b\uff1a\" . date(\"Y/m/d H:i:s\"). \"<br />\";\n   \n    //DB\u63a5\u7d9a\u3057\u3066SQL\u3067\u6642\u523b\u53d6\u5f97\n    $mysqli = new mysqli('192.168.2.201', 'demo', 'demo_password');\n    if ($mysqli->connect_error) {\n        echo \"fail on connect:\".$mysqli->connect_error;\n        exit();\n    } \n    $mysqli->set_charset(\"utf8\");\n    $res = $mysqli->query(\"SELECT sysdate()\");\n    echo \"DB\u6642\u523b\uff1a\" . $res->fetch_row()[0] . \"<br />\";\n    $res->close();\n    $mysqli->close();    \n```\n\nWeb\u30b5\u30fc\u30d0\u30fc\u306bPHP-MySQL\u7528\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3082\u8ffd\u52a0\u3057\u3066\u304a\u304d\u307e\u3057\u3087\u3046\u3002\n\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u90e8\u5206\u3092\u5909\u66f4\u3057\u307e\u3059\u3002\n\n```sakura.tf(Web\u30b5\u30fc\u30d0\u306e\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0)\nresource \"sakuracloud_server\" \"server\" {\n#\u4e2d\u7565\n    provisioner \"remote-exec\" {\n        inline = [\n          # php-mysqlnd\u3092\u8ffd\u8a18\n          \"yum install -y httpd httpd-devel php php-mbstring php-mysqlnd\",\n          \"systemctl restart httpd.service\",\n          \"systemctl enable httpd.service\",\n          \"systemctl stop firewalld.service\",\n          \"systemctl disable firewalld.service\"\n        ]\n    }\n#\u4e2d\u7565\n```\n\n### `plan`\u3068`apply`\u306e\u5b9f\u884c\n\n\u4eca\u56de\u306f\u5b9f\u884c\u524d\u306b`terraform destroy`\u3057\u3066\u304b\u3089\n`terraform plan`\u3068`terraform apply`\u3057\u307e\u3057\u3087\u3046\u3002\n\n\u3046\u307e\u304f\u53cd\u6620\u3055\u308c\u307e\u3057\u305f\u306d\uff1f\nSSH\u63a5\u7d9a\u3057\u305f\u4e0a\u3067`ip addr show`\u3084`ping`\u3092\u8a66\u3057\u3066\u304a\u304f\u306e\u3082\u826f\u3044\u3067\u3057\u3087\u3046\u3002\n\n\u3053\u306e\u6bb5\u968e\u3067\u30d6\u30e9\u30a6\u30b6\u3067Web\u30b5\u30fc\u30d0\u30fc\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u8868\u793a\u306b\u306a\u308b\u306f\u305a\u3067\u3059\u3002\n![server04_webtest.png](https://qiita-image-store.s3.amazonaws.com/0/20668/ac93145d-d62f-8725-ecf0-7e61c697761d.png)\n\n\n## \u7b2c3\u6bb5\u968e\uff1a\u30d1\u30b1\u30c3\u30c8\u30d5\u30a3\u30eb\u30bf\u3001\u30b7\u30f3\u30d7\u30eb\u76e3\u8996\u306e\u8ffd\u52a0\n\n\u3044\u3088\u3044\u3088\u6700\u7d42\u5f62\u3067\u3059\u3002\n\n![server04_part3.png](https://qiita-image-store.s3.amazonaws.com/0/20668/6fa08f7f-f932-a368-a250-42bb46618946.png)\n\n\n  - \u30d1\u30b1\u30c3\u30c8\u30d5\u30a3\u30eb\u30bf\u306e\u8ffd\u52a0\n  - \u30d1\u30b1\u30c3\u30c8\u30d5\u30a3\u30eb\u30bf\u3092\u30b5\u30fc\u30d0\u30fc\u306b\u9069\u7528\n  - \u30b7\u30f3\u30d7\u30eb\u76e3\u8996\u306e\u8ffd\u52a0\n\n\u3092\u884c\u3044\u307e\u3057\u3087\u3046\u3002\n\n### \u30d1\u30b1\u30c3\u30c8\u30d5\u30a3\u30eb\u30bf\u306e\u8ffd\u52a0\n\n\u30d1\u30b1\u30c3\u30c8\u30d5\u30a3\u30eb\u30bf\u3092\u5408\u8a082\u7a2e\u985e\u5b9a\u7fa9\u3057\u307e\u3059\u3002\n\n  - 1: Web\u30b5\u30fc\u30d0\u30fc\u7528(pf_web)\n  - 2: DB\u30b5\u30fc\u30d0\u30fc\u7528(pf_db)\n\n\u57fa\u672c\u7684\u306a\u30eb\u30fc\u30eb\u306f\n\n  - ICMP\u5fdc\u7b54\u306f\u8a31\u53ef\n  - SSH\u63a5\u7d9a\u306f\u8a31\u53ef\n  - \u5fdc\u7b54\u30d1\u30b1\u30c3\u30c8\u306f\u8a31\u53ef\n  - \u5185\u90e8\u304b\u3089\u5916\u90e8\u3078\u306e\u30d1\u30b1\u30c3\u30c8\u306f\u8a31\u53ef\n  - \u4ee5\u5916\u306f\u3059\u3079\u3066\u62d2\u5426\n\n\u3068\u3057\u3001Web\u30b5\u30fc\u30d0\u30fc\u7528\u306b\u3064\u3044\u3066\u306f80\u756a\u3001443\u756a\u30dd\u30fc\u30c8\u3092\u8a31\u53ef\u3057\u307e\u3059\u3002\n\n\u3053\u308c\u3092\u305d\u308c\u305e\u308c\u306e\u30b5\u30fc\u30d0\u30fc\u306eeth0(\u30b0\u30ed\u30fc\u30d0\u30ebIP\u3092\u6301\u3063\u3066\u3044\u308bNIC)\u306b\u9069\u7528\u3057\u307e\u3059\u3002\nDB\u63a5\u7d9a\u306b\u3064\u3044\u3066\u306f\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30cd\u30c3\u30c8\u30ef\u30fc\u30af(192.168.2.0/24)\u7d4c\u7531\u3067\u306e\u30a2\u30af\u30bb\u30b9\u306e\u305f\u3081\u3001\n\u3053\u306e\u30d1\u30b1\u30c3\u30c8\u30d5\u30a3\u30eb\u30bf\u306e\u9069\u7528\u5bfe\u8c61\u5916\u3068\u306a\u308a\u3001\u30b5\u30fc\u30d0\u30fc\u9593\u3067\u306f\u304d\u3061\u3093\u3068\u63a5\u7d9a\u3067\u304d\u307e\u3059\u3002\n\ntf\u30d5\u30a1\u30a4\u30eb\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\n\n```sakura.tf:\u30d1\u30b1\u30c3\u30c8\u30d5\u30a3\u30eb\u30bf\u5b9a\u7fa9\nresource \"sakuracloud_packet_filter\" \"pf_web\" {\n    name = \"pf_web\"\n    expressions = {\n        protocol = \"tcp\"\n        source_nw = \"0.0.0.0/0\"\n        dest_port = \"22\"\n        description = \"Allow SSH\"\n        allow = true\n    }\n    expressions = {\n        protocol = \"tcp\"\n        source_nw = \"0.0.0.0/0\"\n        dest_port = \"80\"\n        description = \"Allow www\"\n        allow = true\n    }\n    expressions = {\n        protocol = \"tcp\"\n        source_nw = \"0.0.0.0/0\"\n        dest_port = \"443\"\n        description = \"Allow www(ssl)\"\n        allow = true\n    }\n    expressions = {\n        protocol = \"tcp\"\n        source_nw = \"0.0.0.0/0\"\n        dest_port = \"32768-61000\"\n        description = \"Allow return packet(tcp)\"\n        allow = true\n    }\n    expressions = {\n        protocol = \"udp\"\n        source_nw = \"0.0.0.0/0\"\n        dest_port = \"32768-61000\"\n        description = \"Allow return packet(udp)\"\n        allow = true\n    }\n    expressions = {\n        protocol = \"icmp\"\n        source_nw = \"0.0.0.0\"\n        allow = true\n        description = \"Allow all icmp\"\n    }\n    expressions = {\n        protocol = \"fragment\"\n        source_nw = \"0.0.0.0\"\n        allow = true\n        description = \"Allow all fragment\"\n    }\n    expressions = {\n        protocol = \"ip\"\n        source_nw = \"0.0.0.0\"\n        allow = false\n        description = \"Deny all\"\n    }\n}\n\nresource \"sakuracloud_packet_filter\" \"pf_db\" {\n    name = \"pf_db\"\n    expressions = {\n        protocol = \"tcp\"\n        source_nw = \"0.0.0.0/0\"\n        dest_port = \"22\"\n        description = \"Allow SSH\"\n        allow = true\n    }\n    expressions = {\n        protocol = \"tcp\"\n        source_nw = \"0.0.0.0/0\"\n        dest_port = \"32768-61000\"\n        description = \"Allow return packet(tcp)\"\n        allow = true\n    }\n    expressions = {\n        protocol = \"udp\"\n        source_nw = \"0.0.0.0/0\"\n        dest_port = \"32768-61000\"\n        description = \"Allow return packet(udp)\"\n        allow = true\n    }\n    expressions = {\n        protocol = \"icmp\"\n        source_nw = \"0.0.0.0\"\n        allow = true\n        description = \"Allow all icmp\"\n    }\n    expressions = {\n        protocol = \"fragment\"\n        source_nw = \"0.0.0.0\"\n        allow = true\n        description = \"Allow all fragment\"\n    }\n    expressions = {\n        protocol = \"ip\"\n        source_nw = \"0.0.0.0\"\n        allow = false\n        description = \"Deny all\"\n    }\n}\n```\n\n### \u30d1\u30b1\u30c3\u30c8\u30d5\u30a3\u30eb\u30bf\u3092\u30b5\u30fc\u30d0\u30fc\u306b\u63a5\u7d9a\n\ntf\u30d5\u30a1\u30a4\u30eb\u306e\u30b5\u30fc\u30d0\u30fc\u90e8\u5206\u3092\u4fee\u6b63\u3057\u307e\u3057\u3087\u3046\u3002\n\n```sakura.tf(\u30d1\u30b1\u30c3\u30c8\u30d5\u30a3\u30eb\u30bf\u63a5\u7d9a)\n# web\u30b5\u30fc\u30d0\u30fc\nresource \"sakuracloud_server\" \"server\" {\n    # (\u4e2d\u7565)\n\n    # \u30d1\u30b1\u30c3\u30c8\u30d5\u30a3\u30eb\u30bf\u63a5\u7d9a\n    packet_filter_ids = [\"${sakuracloud_packet_filter.pf_web.id}\"]\n \n   # \u4ee5\u4e0b\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0(\u7701\u7565)\n}\n\n# DB\u30b5\u30fc\u30d0\u30fc\nresource \"sakuracloud_server\" \"server_db\" {\n    # (\u4e2d\u7565)\n\n    # \u30d1\u30b1\u30c3\u30c8\u30d5\u30a3\u30eb\u30bf\u63a5\u7d9a\n    packet_filter_ids = [\"${sakuracloud_packet_filter.pf_db.id}\"]\n \n   # \u4ee5\u4e0b\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0(\u7701\u7565)\n}\n\n```\n\n### \u30b7\u30f3\u30d7\u30eb\u76e3\u8996\u306e\u8ffd\u52a0\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u76e3\u8996\u3092\u884c\u3044\u307e\u3059\u3002\n\n  - ping\u306b\u3088\u308b\u6b7b\u6d3b\u76e3\u8996(1\u5206\u9593\u9694)\n  - Web\u30b5\u30fc\u30d0\u30fc\u3078\u306eHTTP\u76e3\u8996(`/index.php`\u3078\u30ea\u30af\u30a8\u30b9\u30c8\u30011\u5206\u9593\u9694)\n  - \u901a\u77e5\u306fslack\u306b\u5bfe\u3057\u3066\u884c\u3046\n\n\u4e8b\u524d\u306bslack\u9023\u643a\u7528\u306bwebhook\u306eURL\u304c\u5fc5\u8981\u3067\u3059\u3002\n\u5225\u9014slack\u306e\u8a2d\u5b9a\u3092\u884c\u3063\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\n\n![slack_webhook.png](https://qiita-image-store.s3.amazonaws.com/0/20668/739ce9ca-a7f3-121b-faed-3eb9ba64d255.png)\n\n\ntf\u30d5\u30a1\u30a4\u30eb\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002webhook\u306eURL\u306f\u5404\u81ea\u7f6e\u304d\u63db\u3048\u3066\u304f\u3060\u3055\u3044\u3002\n\n```sakura.tf(\u30b7\u30f3\u30d7\u30eb\u76e3\u8996)\nvariable \"slack_webhook\" {\n    default = \"https://hooks.slack.com/services/XXXXXXXXX/XXXXXXXXX/XXXXXXXXXXXXXXXXXXXXXXXX\"\n}\n\n# ping\u76e3\u8996(DB\u30b5\u30fc\u30d0\u30fc)\nresource \"sakuracloud_simple_monitor\" \"ping_monitor_db\" {\n    target = \"${sakuracloud_server.server_db.base_nw_ipaddress}\"\n    health_check = {\n        protocol = \"ping\"\n        delay_loop = 60\n    }\n    notify_email_enabled = false\n    notify_slack_enabled = true\n    notify_slack_webhook = \"${var.slack_webhook}\"\n}\n\n# ping\u76e3\u8996(web\u30b5\u30fc\u30d0\u30fc\uff12\u53f0\u5206)\nresource \"sakuracloud_simple_monitor\" \"ping_monitor_web\" {\n    count = 2\n    target = \"${element(sakuracloud_server.server.*.base_nw_ipaddress , count.index)}\"\n    health_check = {\n        protocol = \"ping\"\n        delay_loop = 60\n    }\n    notify_email_enabled = false\n    notify_slack_enabled = true\n    notify_slack_webhook = \"${var.slack_webhook}\"\n}\n# web\u76e3\u8996(web\u30b5\u30fc\u30d0\u30fc2\u53f0\u5206)\nresource \"sakuracloud_simple_monitor\" \"http_monitor_web\" {\n    count = 2\n    target = \"${element(sakuracloud_server.server.*.base_nw_ipaddress , count.index)}\"\n    health_check = {\n        protocol = \"http\"\n        delay_loop = 60\n        path = \"/index.php\"\n        status = \"200\"\n    }\n    notify_email_enabled = false\n    notify_slack_enabled = true\n    notify_slack_webhook = \"${var.slack_webhook}\"\n}\n```\n\n### `plan`\u3068`apply`\u306e\u5b9f\u884c\n\n\u3044\u3088\u3044\u3088\u3067\u3059\u306d\uff01\u65e9\u901f\u5b9f\u884c\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\u3046\u307e\u304f\u3044\u304d\u307e\u3057\u305f\u3088\u306d\uff1f\n\n\u76e3\u8996\u304c\u3067\u304d\u3066\u3044\u308b\u304b\u8a66\u3057\u306b\u30b5\u30fc\u30d0\u30fc\u3092\u843d\u3068\u3057\u3066\u307f\u305f\u308a\u3057\u3066\u304f\u3060\u3055\u3044\u3002\nslack\u306b\u901a\u77e5\u304c\u304d\u3061\u3093\u3068\u5c4a\u3051\u3070OK\u3067\u3059\u3002\n\n## \u6700\u7d42\u7684\u306a\u5b9a\u7fa9\u30d5\u30a1\u30a4\u30eb(tf\u30d5\u30a1\u30a4\u30eb)\n\n\u4eca\u56de\u306e\u6700\u7d42\u7684\u306atf\u30d5\u30a1\u30a4\u30eb\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u306f\u305a\u3067\u3059\u3002\n(\u30b3\u30e1\u30f3\u30c8\u306a\u3069\u5165\u308c\u3066\u6574\u5f62\u3057\u3066\u3044\u307e\u3059)\n\u3046\u307e\u304f\u3044\u304b\u306a\u3044\u65b9\u306f\u3053\u3061\u3089\u3068\u6bd4\u8f03\u3057\u3066\u307f\u3066\u304f\u3060\u3055\u3044\u3002\n\n```sakura.tf(\u7b2c4\u56de\u306e\u6700\u7d42\u5f62)\n/*********************\n * Provider settings\n *********************/\nprovider \"sakuracloud\" {\n    token = \"[ACCESS_TOKEN]\"\n    secret = \"[ACCESS_TOKEN_SECRET]\"\n}\n\n/*****************\n * Variables \n *****************/\nvariable \"slack_webhook\" {\n    default = \"https://hooks.slack.com/services/X0XXX0XXX/X0XXXXXXX/9XXXOxxxxO8XxxX4XX1xxxxx\"\n}\nvariable \"mysql_values\" {\n   default = {\n      root_password = \"mysql_password\"\n      user_name = \"demo\"\n      user_password = \"demo_password\"\n   }\n}\nvariable \"private_ip_addresses\" {\n    default = {\n      server01 = \"192.168.2.101\"\n      server02 = \"192.168.2.102\"\n      server_db = \"192.168.2.201\"\n    }\n}\n\n/*****************\n * Disk\n *****************/\nresource \"sakuracloud_disk\" \"disk\" {\n    name = \"${format(\"disk%02d\" , count.index+1)}\"\n    source_archive_name = \"CentOS 7.2 64bit\"\n    ssh_key_ids = [\"${sakuracloud_ssh_key.mykey.id}\"]\n    disable_pw_auth = true\n    count = 2\n}\nresource \"sakuracloud_disk\" \"disk_db\" {\n    name = \"disk_db\"\n    source_archive_name = \"CentOS 7.2 64bit\"\n    ssh_key_ids = [\"${sakuracloud_ssh_key.dbkey.id}\"]\n    disable_pw_auth = true\n}\n\n/*****************\n * Server \n *****************/\nresource \"sakuracloud_server\" \"server\" {\n    name = \"${format(\"server%02d\" , count.index+1)}\"\n    disks = [\"${element(sakuracloud_disk.disk.*.id,count.index)}\"]\n    additional_interfaces = [\"${sakuracloud_switch.sw01.id}\"]\n    packet_filter_ids = [\"${sakuracloud_packet_filter.pf_web.id}\"]\n    count = 2\n    # \u30b5\u30fc\u30d0\u30fc\u306b\u306fSSH\u3067\u63a5\u7d9a\n    connection {\n       user = \"root\"\n       host = \"${self.base_nw_ipaddress}\"\n       private_key = \"${file(\"./id_rsa\")}\"\n    }\n\n    # yum\u3067apache+PHP\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n    provisioner \"remote-exec\" {\n        inline = [\n          \"yum install -y httpd httpd-devel php php-mbstring php-mysqlnd\",\n          \"systemctl restart httpd.service\",\n          \"systemctl enable httpd.service\",\n          \"systemctl stop firewalld.service\",\n          \"systemctl disable firewalld.service\"\n        ]\n    }\n\n    # Web\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\n    provisioner \"file\" {\n        source = \"webapps/\"\n        destination = \"/var/www/html\"\n    }\n\n    # IP\u8a2d\u5b9a\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\n    provisioner \"file\" {\n        source = \"provision_private_ip.sh\"\n        destination = \"/tmp/provision_private_ip.sh\"\n    }\n\n    # IP\u8a2d\u5b9a\u5b9f\u884c\n    provisioner \"remote-exec\" {\n        inline = [\n          \"chmod +x /tmp/provision_private_ip.sh\",\n          \"/tmp/provision_private_ip.sh ${lookup(var.private_ip_addresses , self.name)}\"\n        ]\n    }\n\n\n}\n\nresource \"sakuracloud_server\" \"server_db\" {\n    name = \"server_db\"\n    disks = [\"${sakuracloud_disk.disk_db.id}\"]\n    additional_interfaces = [\"${sakuracloud_switch.sw01.id}\"]\n    packet_filter_ids = [\"${sakuracloud_packet_filter.pf_db.id}\"]\n\n    # \u30b5\u30fc\u30d0\u30fc\u306b\u306fSSH\u3067\u63a5\u7d9a\n    connection {\n       user = \"root\"\n       host = \"${self.base_nw_ipaddress}\"\n       private_key = \"${file(\"./id_rsa_db\")}\"\n    }\n\n    # yum\u3067mysql\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n    provisioner \"remote-exec\" {\n        inline = [\n          \"yum install -y mysql-community-server\",\n          \"systemctl start mysql.service\",\n          \"mysql -uroot -e 'GRANT ALL ON *.* TO ${var.mysql_values.user_name}@\\\"192.168.2.%\\\" IDENTIFIED BY \\\"${var.mysql_values.user_password}\\\"'\" ,\n          \"mysqladmin -u root password '${var.mysql_values.root_password}'\",\n          \"systemctl stop firewalld.service\",\n          \"systemctl disable firewalld.service\"\n        ]\n    }\n\n    # IP\u8a2d\u5b9a\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\n    provisioner \"file\" {\n        source = \"provision_private_ip.sh\"\n        destination = \"/tmp/provision_private_ip.sh\"\n    }\n\n    # IP\u8a2d\u5b9a\u5b9f\u884c\n    provisioner \"remote-exec\" {\n        inline = [\n          \"chmod +x /tmp/provision_private_ip.sh\",\n          \"/tmp/provision_private_ip.sh ${lookup(var.private_ip_addresses , self.name)}\"\n        ]\n    }\n\n}\n\n/*****************\n * SSH key \n *****************/\nresource \"sakuracloud_ssh_key\" \"mykey\" {\n    name = \"mykey\"\n    public_key = \"${file(\"./id_rsa.pub\")}\"\n}\n\nresource \"sakuracloud_ssh_key\" \"dbkey\" {\n    name = \"dbkey\"\n    public_key = \"${file(\"./id_rsa_db.pub\")}\"\n}\n\n/*****************\n * Switch\n *****************/\nresource \"sakuracloud_switch\" \"sw01\" {\n  name = \"sw01\"\n}\n\n/*****************\n * PacketFilter\n *****************/\nresource \"sakuracloud_packet_filter\" \"pf_web\" {\n    name = \"pf_web\"\n    expressions = {\n        protocol = \"tcp\"\n        source_nw = \"0.0.0.0/0\"\n        dest_port = \"22\"\n        description = \"Allow SSH\"\n        allow = true\n    }\n    expressions = {\n        protocol = \"tcp\"\n        source_nw = \"0.0.0.0/0\"\n        dest_port = \"80\"\n        description = \"Allow www\"\n        allow = true\n    }\n    expressions = {\n        protocol = \"tcp\"\n        source_nw = \"0.0.0.0/0\"\n        dest_port = \"443\"\n        description = \"Allow www(ssl)\"\n        allow = true\n    }\n    expressions = {\n        protocol = \"tcp\"\n        source_nw = \"0.0.0.0/0\"\n        dest_port = \"32768-61000\"\n        description = \"Allow return packet(tcp)\"\n        allow = true\n    }\n    expressions = {\n        protocol = \"udp\"\n        source_nw = \"0.0.0.0/0\"\n        dest_port = \"32768-61000\"\n        description = \"Allow return packet(udp)\"\n        allow = true\n    }\n    expressions = {\n        protocol = \"icmp\"\n        source_nw = \"0.0.0.0\"\n        allow = true\n        description = \"Allow all icmp\"\n    }\n    expressions = {\n        protocol = \"fragment\"\n        source_nw = \"0.0.0.0\"\n        allow = true\n        description = \"Allow all fragment\"\n    }\n    expressions = {\n        protocol = \"ip\"\n        source_nw = \"0.0.0.0\"\n        allow = false\n        description = \"Deny all\"\n    }\n}\nresource \"sakuracloud_packet_filter\" \"pf_db\" {\n    name = \"pf_db\"\n    expressions = {\n        protocol = \"tcp\"\n        source_nw = \"0.0.0.0/0\"\n        dest_port = \"22\"\n        description = \"Allow SSH\"\n        allow = true\n    }\n   expressions = {\n        protocol = \"tcp\"\n        source_nw = \"0.0.0.0/0\"\n        dest_port = \"32768-61000\"\n        description = \"Allow return packet(tcp)\"\n        allow = true\n    }\n    expressions = {\n        protocol = \"udp\"\n        source_nw = \"0.0.0.0/0\"\n        dest_port = \"32768-61000\"\n        description = \"Allow return packet(udp)\"\n        allow = true\n    }\n    expressions = {\n        protocol = \"icmp\"\n        source_nw = \"0.0.0.0\"\n        allow = true\n        description = \"Allow all icmp\"\n    }\n    expressions = {\n        protocol = \"fragment\"\n        source_nw = \"0.0.0.0\"\n        allow = true\n        description = \"Allow all fragment\"\n    }\n    expressions = {\n        protocol = \"ip\"\n        source_nw = \"0.0.0.0\"\n        allow = false\n        description = \"Deny all\"\n    }\n}\n\n/*****************\n * SimpleMonitor\n *****************/\n\n# ping\u76e3\u8996(DB\u30b5\u30fc\u30d0\u30fc)\nresource \"sakuracloud_simple_monitor\" \"ping_monitor_db\" {\n    target = \"${sakuracloud_server.server_db.base_nw_ipaddress}\"\n    health_check = {\n        protocol = \"ping\"\n        delay_loop = 60\n    }\n    notify_email_enabled = false\n    notify_slack_enabled = true\n    notify_slack_webhook = \"${var.slack_webhook}\"\n}\n\n# ping\u76e3\u8996(web\u30b5\u30fc\u30d0\u30fc\uff12\u53f0\u5206)\nresource \"sakuracloud_simple_monitor\" \"ping_monitor_web\" {\n    count = 2\n    target = \"${element(sakuracloud_server.server.*.base_nw_ipaddress , count.index)}\"\n    health_check = {\n        protocol = \"ping\"\n        delay_loop = 60\n    }\n    notify_email_enabled = false\n    notify_slack_enabled = true\n    notify_slack_webhook = \"${var.slack_webhook}\"\n}\n# web\u76e3\u8996(web\u30b5\u30fc\u30d0\u30fc2\u53f0\u5206)\nresource \"sakuracloud_simple_monitor\" \"http_monitor_web\" {\n    count = 2\n    target = \"${element(sakuracloud_server.server.*.base_nw_ipaddress , count.index)}\"\n    health_check = {\n        protocol = \"http\"\n        delay_loop = 60\n        path = \"/index.php\"\n        status = \"200\"\n    }\n    notify_email_enabled = false\n    notify_slack_enabled = true\n    notify_slack_webhook = \"${var.slack_webhook}\"\n}\n\n\n/*****************\n * DNS\n *****************/\nresource \"sakuracloud_dns\" \"dns\" {\n    zone = \"fe-bc.net\"\n    records = {\n        name = \"web\"\n        type = \"A\"\n        value = \"${sakuracloud_server.server.1.base_nw_ipaddress}\"\n    }\n    records = {\n        name = \"web\"\n        type = \"A\"\n        value = \"${sakuracloud_server.server.0.base_nw_ipaddress}\"\n    }\n}\n\n/*****************\n * Output\n *****************/\noutput \"global_ip\" {\n    value = \"${join(\"\\n\" , formatlist(\"%s : %s\" , sakuracloud_server.server.*.name , sakuracloud_server.server.*.base_nw_ipaddress))}\"\n}\noutput \"global_ip_db\" {\n    value = \"${format(\"%s : %s\\n\" , sakuracloud_server.server_db.name , sakuracloud_server.server_db.base_nw_ipaddress)}\"\n}\noutput \"ssh_web01\" {\n    value = \"${format(\"ssh root@%s -i %s/id_rsa\" , sakuracloud_server.server.0.base_nw_ipaddress , path.root)}\"\n}\noutput \"ssh_web02\" {\n    value = \"${format(\"ssh root@%s -i %s/id_rsa\" , sakuracloud_server.server.1.base_nw_ipaddress , path.root)}\"\n}\noutput \"ssh_db\" {\n    value = \"${format(\"ssh root@%s -i %s/id_rsa_db\" , sakuracloud_server.server_db.base_nw_ipaddress , path.root)}\"\n}\n```\n\n\n## \u307e\u3068\u3081\n\n\u4eca\u56de\u306f\u76db\u308a\u3060\u304f\u3055\u3093\u3067\u3057\u305f\u306d\uff01\n\n  - DB\u30b5\u30fc\u30d0\u30fc\u306e\u8ffd\u52a0\n  - \u30b9\u30a4\u30c3\u30c1\u306e\u8ffd\u52a0 + \u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306e\u69cb\u7bc9\n  - \u30d1\u30b1\u30c3\u30c8\u30d5\u30a3\u30eb\u30bf\u306e\u8ffd\u52a0\n  - \u30b7\u30f3\u30d7\u30eb\u76e3\u8996\u306e\u8ffd\u52a0\n\n\u30b7\u30f3\u30d7\u30eb\u306a\u69cb\u6210\u306e\u30b7\u30b9\u30c6\u30e0\u306a\u3089\u5341\u5206\u306b\u5b9f\u7528\u3067\u304d\u308b\u30ec\u30d9\u30eb\u307e\u3067\u8fd1\u3065\u304d\u307e\u3057\u305f\u306d\uff01\n\n\u6b21\u56de\u306f\u3044\u3088\u3044\u3088\u4ed5\u4e0a\u3052\u3068\u3057\u3066\n\n  - MySQL \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3 + PHP(mysqlnd_ms)\u306b\u3088\u308b\u30af\u30e9\u30b9\u30bf\u30ea\u30f3\u30b0\n  - \u6771\u4eac\u3068\u77f3\u72e9\u3067\u30de\u30eb\u30c1\u30be\u30fc\u30f3\u69cb\u6210\n  - GSLB\u306b\u3088\u308b\u30be\u30fc\u30f3\u9593HA\u69cb\u6210\n\n\u3092\u884c\u3044\u307e\u3059\u3002\u304a\u697d\u3057\u307f\u306b :bangbang: \n\n\u6b21\u56de\uff1a[\u5b9f\u8df5 Step5\uff1a\u6771\u4eac/\u77f3\u72e9 \u30de\u30eb\u30c1\u30be\u30fc\u30f3\u69cb\u6210](http://qiita.com/yamamoto-febc/items/4b774404e041fa05688a)\n\n## \u304a\u307e\u3051\uff1a\u3055\u304f\u3089\u306e\u30af\u30e9\u30a6\u30c9\u3067503\u30a8\u30e9\u30fc\n\n`terraform destroy`\u5b9f\u884c\u6642\u306b\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30a8\u30e9\u30fc\u304c\u51fa\u308b\u3053\u3068\u304c\u3042\u308a\u307e\u3059\u3002\n\n```bash:\u3055\u304f\u3089\u306e\u30af\u30e9\u30a6\u30c9503\u30a8\u30e9\u30fc\nError applying plan:\n\n1 error(s) occurred:\n\n* sakuracloud_server.server.0: \nError deleting SakuraCloud Server resource: Error in response:\n&sacloud.ResultErrorValue{\n    IsFatal:true, \n    Serial:\"c843d04c9fc1caaa26e4b1eba649245d\", \n    Status:\"503 Service Unavailable\", \n    ErrorCode:\"busy\", \n    ErrorMessage:\"\u30b5\u30fc\u30d3\u30b9\u304c\u5229\u7528\u3067\u304d\u307e\u305b\u3093\u3002\u30b5\u30fc\u30d0\u304c\u6df7\u96d1\u3057\u3066\u3044\u307e\u3059\u3002\u3057\u3070\u3089\u304f\u6642\u9593\u3092\u304a\u3044\u3066\u304b\u3089\u518d\u5ea6\u304a\u8a66\u3057\u304f\u3060\u3055\u3044\u3002\"\n}\n\nTerraform does not automatically rollback in the face of errors.\nInstead, your Terraform state file has been partially updated with\nany resources that successfully completed. Please address the error\nabove and apply again to incrementally change your infrastructure.\n```\n\n\u305f\u304f\u3055\u3093\u306e\u30ea\u30bd\u30fc\u30b9\u3092\u4e00\u6c17\u306bdestroy\u3057\u305f\u5834\u5408\u306a\u3069\u306b\u51fa\u308b\u3053\u3068\u304c\u3042\u308a\u307e\u3059\u3002\n\u614c\u3066\u305a\u9a12\u304c\u305a\u3061\u3087\u3063\u3068\u6642\u9593\u3092\u304a\u3044\u3066`terraform destroy`\u3092\u518d\u5b9f\u884c\u3057\u307e\u3057\u3087\u3046\u3002\n", "tags": ["Hashicorp", "Terraform", "Go", "\u3055\u304f\u3089\u306e\u30af\u30e9\u30a6\u30c9"]}