{"context": " More than 1 year has passed since last update.\n\nTwilio\u304b\u3089\u306e\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u30ea\u30af\u30a8\u30b9\u30c8\n\u8981\u3059\u308b\u306b\u4ee5\u4e0b\u306e\u69d8\u306a\u3068\u304d\u306b\u4f7f\u3046\u3084\u3064\u3067\u3059\u3002\n\n\uff08\u30b5\u30fc\u30d0\u304c\uff09\u53d7\u3051\u53d6\u308bHTTP\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u78ba\u304b\u306bTwilio\u304b\u3089\u306e\u3082\u306e\u3067\u3042\u308a\u3001\u4e0d\u5be9\u306a\u7b2c\u4e09\u8005\u304b\u3089\u306e\u3082\u306e\u3067\u306f\u306a\u3044\u3053\u3068\u3092\u78ba\u5b9f\u306b\u3057\u305f\u3044\n\n\u8a73\u7d30\u306fTwilio\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092\u5fa1\u89a7\u304f\u3060\u3055\u3044\u3002\n\n\u3084\u308a\u65b9\n\nroutes.rb \u3092\u8a2d\u5b9a\u3059\u308b\ntwilio\u304b\u3089\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u53d7\u3051\u308b\u30eb\u30fc\u30c8\u306f\u3001\u4f55\u304b\u9069\u5f53\u306anamespace\u3092\u3064\u3051\u308b\u306e\u3092\u30aa\u30b9\u30b9\u30e1\u3057\u307e\u3059\u3002\n\nconfig/routes.rb\nRails.application.routes.draw do\n  namespace :phone do\n    post 'incoming', to: 'incoming#new', format: true\n  end\nend\n\n\n\nconfig\u3092\u8a2d\u5b9a\u3059\u308b\nconfig\u306btwilio\u306eAPI\u3092\u4f7f\u3046\u305f\u3081\u306e\u30ad\u30fc\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\uff08\u5b9f\u969b\u306f\u30bd\u30fc\u30b9\u4e0a\u306b\u76f4\u306b\u66f8\u3044\u305f\u308a\u306f\u3057\u306a\u3044\u3068\u601d\u3044\u307e\u3059\uff09\n\nconfig/initializers/twilio.rb\nTwilio.configure do |config|\n  config.account_sid = 'account_sid'\n  config.auth_token  = 'auth_token'\nend\n\n\n\napplication_controller.rb \u3092\u66f8\u304f\nTwilio\u7528\u306eapplication_controller.rb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u3053\u3053\u3067validation\u3092\u3057\u307e\u3059\u3002\n\napp/controllers/phone/application_controller.rb\nclass Phone::ApplicationController < ApplicationController\n  protect_from_forgery with: :null_session\n  before_action :validate_incoming_requests, if: -> { !(Rails.env.test? || Rails.env.development?) }\n\n  RequestValidationError = Class.new(StandardError)\n  rescue_from RequestValidationError, with: :handle_401\n\n  private\n\n  def validate_incoming_requests\n    return unless request.post?\n    validator = Twilio::Util::RequestValidator.new\n    signature = request.headers['X-Twilio-Signature']\n    fail RequestValidationError unless validator.validate(request.url, request.request_parameters, signature)\n  end\n\n  def handle_401\n    render xml: reject_twiml, status: 401\n  end\n\n  def reject_twiml\n    Twilio::TwiML::Response.new do |r|\n      r.Reject reason: :busy\n    end.text\n  end\nend\n\n\n\nController.rb \u3092\u66f8\u304f\n\u3053\u3053\u3067\u306fvalidation\u3092\u610f\u8b58\u3059\u308b\u5fc5\u8981\u306f\u6709\u308a\u307e\u305b\u3093\u3002\nTwilio\u7528\u306eapplication_controller.rb\u3092\u7d99\u627f\u3059\u308b\u306e\u3092\u304a\u5fd8\u308c\u306a\u304f\u3002\n\napp/controllers/phone/incoming_controller.rb\nclass Phone::IncomingController < Phone::ApplicationController\n  def new\n\u3000\u3000# \u672c\u5f53\u306fpost\u3089\u3057\u3044\u51e6\u7406\u3092\u66f8\u304f\n    render xml: say_twiml\n  end\n\n  private\n\n  def say_twiml\n    Twilio::TwiML::Response.new do |r|\n      r.Say 'It is fine today.'\n    end.text\n  end\nend\n\n\n\n\u6ce8\u610f\u70b9\n\nnamespace\u306b\"twilio\"\u3092\u4f7f\u308f\u306a\u3044\n\u305d\u306e\u540d\u524d\u306ftwilio-ruby\u30b8\u30a7\u30e0\u3067\u4f7f\u308f\u308c\u3066\u3044\u307e\u3059\u3002\u554f\u984c\u306a\u3044\u3068\u306f\u601d\u3044\u307e\u3059\u304c\u3001\u907f\u3051\u308b\u306b\u8d8a\u3057\u305f\u3053\u3068\u306f\u6709\u308a\u307e\u305b\u3093\u3002\u307e\u305f\u3001\u5927\u62b5\u306e\u5834\u5408\u306f\u3082\u3063\u3068\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306b\u9069\u3057\u305f\u540d\u524d\u304c\u3042\u308a\u307e\u3059\u3002\n\n\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u306e\u969b\u306brequest.params\u3092\u4f7f\u308f\u306a\u3044\nrequest.params\u3092\u4f7f\u3046\u3068validation\u304c\u5931\u6557\u3057\u307e\u3059\u3002request.params\u306b\u306frails\u3067\u8ffd\u52a0\u3057\u305fcontroller\u3084action\u306a\u3069\u304c\u542b\u307e\u308c\u3066\u3044\u308b\u304b\u3089\u3067\u3059\u3002\n\u306a\u306e\u3067\u3001\u4e0a\u8a18\u306e\u30bd\u30fc\u30b9\u3067\u306frequest.request_parameters\u3092\u4f7f\u7528\u3057\u3066\u3044\u307e\u3059\u3002\u3053\u308c\u306frails\u3067\u8ffd\u52a0\u3057\u305f\u5024\u306f\u542b\u307f\u307e\u305b\u3093\u3002\n\n\u53c2\u8003\nRails\u306eparams\u304b\u3089controller\u3068\u304bpath\u306b\u95a2\u4fc2\u3059\u308b\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u9664\u304d\u305f\u3044\nValidate Incoming Requests - twilio-ruby\n## Twilio\u304b\u3089\u306e\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u30ea\u30af\u30a8\u30b9\u30c8\n\u8981\u3059\u308b\u306b\u4ee5\u4e0b\u306e\u69d8\u306a\u3068\u304d\u306b\u4f7f\u3046\u3084\u3064\u3067\u3059\u3002\n\n> \uff08\u30b5\u30fc\u30d0\u304c\uff09\u53d7\u3051\u53d6\u308bHTTP\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u78ba\u304b\u306bTwilio\u304b\u3089\u306e\u3082\u306e\u3067\u3042\u308a\u3001\u4e0d\u5be9\u306a\u7b2c\u4e09\u8005\u304b\u3089\u306e\u3082\u306e\u3067\u306f\u306a\u3044\u3053\u3068\u3092\u78ba\u5b9f\u306b\u3057\u305f\u3044\n\n\u8a73\u7d30\u306f[Twilio\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](https://jp.twilio.com/docs/api/security#validating-requests)\u3092\u5fa1\u89a7\u304f\u3060\u3055\u3044\u3002\n\n## \u3084\u308a\u65b9\n\n### routes.rb \u3092\u8a2d\u5b9a\u3059\u308b\n\ntwilio\u304b\u3089\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u53d7\u3051\u308b\u30eb\u30fc\u30c8\u306f\u3001\u4f55\u304b\u9069\u5f53\u306anamespace\u3092\u3064\u3051\u308b\u306e\u3092\u30aa\u30b9\u30b9\u30e1\u3057\u307e\u3059\u3002\n\n```ruby:config/routes.rb\nRails.application.routes.draw do\n  namespace :phone do\n    post 'incoming', to: 'incoming#new', format: true\n  end\nend\n```\n\n### config\u3092\u8a2d\u5b9a\u3059\u308b\n\nconfig\u306btwilio\u306eAPI\u3092\u4f7f\u3046\u305f\u3081\u306e\u30ad\u30fc\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\uff08\u5b9f\u969b\u306f\u30bd\u30fc\u30b9\u4e0a\u306b\u76f4\u306b\u66f8\u3044\u305f\u308a\u306f\u3057\u306a\u3044\u3068\u601d\u3044\u307e\u3059\uff09\n\n```ruby:config/initializers/twilio.rb\nTwilio.configure do |config|\n  config.account_sid = 'account_sid'\n  config.auth_token  = 'auth_token'\nend\n```\n\n### application_controller.rb \u3092\u66f8\u304f\n\nTwilio\u7528\u306eapplication_controller.rb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u3053\u3053\u3067validation\u3092\u3057\u307e\u3059\u3002\n\n```ruby:app/controllers/phone/application_controller.rb\nclass Phone::ApplicationController < ApplicationController\n  protect_from_forgery with: :null_session\n  before_action :validate_incoming_requests, if: -> { !(Rails.env.test? || Rails.env.development?) }\n\n  RequestValidationError = Class.new(StandardError)\n  rescue_from RequestValidationError, with: :handle_401\n\n  private\n\n  def validate_incoming_requests\n    return unless request.post?\n    validator = Twilio::Util::RequestValidator.new\n    signature = request.headers['X-Twilio-Signature']\n    fail RequestValidationError unless validator.validate(request.url, request.request_parameters, signature)\n  end\n\n  def handle_401\n    render xml: reject_twiml, status: 401\n  end\n\n  def reject_twiml\n    Twilio::TwiML::Response.new do |r|\n      r.Reject reason: :busy\n    end.text\n  end\nend\n```\n\n### Controller.rb \u3092\u66f8\u304f\n\n\u3053\u3053\u3067\u306fvalidation\u3092\u610f\u8b58\u3059\u308b\u5fc5\u8981\u306f\u6709\u308a\u307e\u305b\u3093\u3002\nTwilio\u7528\u306eapplication_controller.rb\u3092\u7d99\u627f\u3059\u308b\u306e\u3092\u304a\u5fd8\u308c\u306a\u304f\u3002\n\n```ruby:app/controllers/phone/incoming_controller.rb\nclass Phone::IncomingController < Phone::ApplicationController\n  def new\n\u3000\u3000# \u672c\u5f53\u306fpost\u3089\u3057\u3044\u51e6\u7406\u3092\u66f8\u304f\n    render xml: say_twiml\n  end\n\n  private\n\n  def say_twiml\n    Twilio::TwiML::Response.new do |r|\n      r.Say 'It is fine today.'\n    end.text\n  end\nend\n```\n\n### \u6ce8\u610f\u70b9\n\n#### namespace\u306b\"twilio\"\u3092\u4f7f\u308f\u306a\u3044\n\n\u305d\u306e\u540d\u524d\u306ftwilio-ruby\u30b8\u30a7\u30e0\u3067\u4f7f\u308f\u308c\u3066\u3044\u307e\u3059\u3002\u554f\u984c\u306a\u3044\u3068\u306f\u601d\u3044\u307e\u3059\u304c\u3001\u907f\u3051\u308b\u306b\u8d8a\u3057\u305f\u3053\u3068\u306f\u6709\u308a\u307e\u305b\u3093\u3002\u307e\u305f\u3001\u5927\u62b5\u306e\u5834\u5408\u306f\u3082\u3063\u3068\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306b\u9069\u3057\u305f\u540d\u524d\u304c\u3042\u308a\u307e\u3059\u3002\n\n#### \u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u306e\u969b\u306brequest.params\u3092\u4f7f\u308f\u306a\u3044\n\n`request.params`\u3092\u4f7f\u3046\u3068validation\u304c\u5931\u6557\u3057\u307e\u3059\u3002`request.params`\u306b\u306frails\u3067\u8ffd\u52a0\u3057\u305f`controller`\u3084`action`\u306a\u3069\u304c\u542b\u307e\u308c\u3066\u3044\u308b\u304b\u3089\u3067\u3059\u3002\n\u306a\u306e\u3067\u3001\u4e0a\u8a18\u306e\u30bd\u30fc\u30b9\u3067\u306f`request.request_parameters`\u3092\u4f7f\u7528\u3057\u3066\u3044\u307e\u3059\u3002\u3053\u308c\u306frails\u3067\u8ffd\u52a0\u3057\u305f\u5024\u306f\u542b\u307f\u307e\u305b\u3093\u3002\n\n## \u53c2\u8003\n[Rails\u306eparams\u304b\u3089controller\u3068\u304bpath\u306b\u95a2\u4fc2\u3059\u308b\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u9664\u304d\u305f\u3044](http://qiita.com/sue738/items/7b3cccac9a2a02637e4f)\n[Validate Incoming Requests - twilio-ruby](http://twilio-ruby.readthedocs.org/en/latest/usage/validation.html)\n", "tags": ["Rails", "twilio", "Ruby"]}