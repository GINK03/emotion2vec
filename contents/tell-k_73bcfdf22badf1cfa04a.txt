{"context": "\n\n\u6982\u8981\n\nDjango\u306f 1.7 \u304b\u3089 migration \u6a5f\u80fd\u3092\u5185\u8535\u3059\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u3002\n\nmakemigrations \u3067\u81ea\u52d5\u3067\u5dee\u5206\u3092\u62bd\u51fa\u308b\u305f\u3081\u306b\u3001Model\u306e\u30ab\u30b9\u30bf\u30e0\u30d5\u30a3\u30fc\u30eb\u30c9\u3084\u30ab\u30b9\u30bf\u30e0\u30d0\u30ea\u30c7\u30fc\u30bf\u30fc\u306b\u7d30\u5de5\u3092\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\nField\u3067\u306f deconstruct \u30e1\u30bd\u30c3\u30c9\u306e\u5b9f\u88c5\u304c\u5fc5\u8981\nValidator \u3067\u306f deconstructible \u30c7\u30b3\u30ec\u30fc\u30bf\u306e\u4ed8\u4e0e\u3068\u3001 __eq__  \u30e1\u30bd\u30c3\u30c9\u306e\u5b9f\u88c5\u304c\u5fc5\u8981\n\u7c21\u5358\u306b\u5bfe\u5fdc\u5185\u5bb9\u3092\u307e\u3068\u3081\u308b\u3002\n\n\n\u906d\u9047\u3057\u305f\u30a8\u30e9\u30fc\n\n\u30ab\u30b9\u30bf\u30e0\u30d0\u30ea\u30c7\u30fc\u30bf\u30fc\u3092\u4f5c\u6210\u3057 makemigrations \u3092\u5b9f\u884c\u3057\u305f\u3089\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30a8\u30e9\u30fc\u306b\u906d\u9047\u3057\u305f\n\nThere are some values Django cannot serialize into migration files.\nFor more, see https://docs.djangoproject.com/en/1.9/topics/migrations/#migration-serializing\n\n\n\u3053\u308c\u3092\u89e3\u6c7a\u3057\u3088\u3046\u3068\u3057\u305f\u6642\u306b\u3001deconstruct \u306e\u8a71\u306b\u8fbf\u308a\u3064\u3044\u305f\n\n\n\u30ab\u30b9\u30bf\u30e0\u30d0\u30ea\u30c7\u30fc\u30bf\u30fc\n\n\u30af\u30e9\u30b9\u30d9\u30fc\u30b9\u306e\u30ab\u30b9\u30bf\u30e0\u30d0\u30ea\u30c7\u30fc\u30bf\u30fc \u306f 1.6 \u4ee5\u524d\u307e\u3067\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306b\u66f8\u3044\u3066\u3044\u305f\n\n# validators.py ----\n\nfrom django.core.exceptions import ValidationError\n\nclass UploadSizeValidator:\n\n    def __init__(self, size=None):\n        if size:\n            self.size = size\n\n    def __call__(self, value):\n        if value.file.size > self.size:\n            raise ValidationError('Upload Size Error')\n\n# models.py ----\n\nclass Question(models.Model):\n\n    question_image = models.ImageField(\n        upload_to='question_image',\n        validators=[UploadSizeValidator(size=200)],\n        default=None\n    )\n\n\n\u3060\u304c\u30011.7 \u304b\u3089\u306f Validator\u3092\u4e0b\u8a18\u306e\u3088\u3046\u306b\u5b9f\u88c5\u3057\u306a\u3044\u3068\u4e0a\u8a18\u306e\u30a8\u30e9\u30fc\u304c\u8868\u793a\u3055\u308c\u308b\u3002\n\nfrom django.core.exceptions import ValidationError\nfrom django.utils.deconstruct import deconstructible\n\n@deconstructible # <- decorator\u3092\u4ed8\u52a0\nclass UploadSizeValidator:\n\n    def __init__(self, size=None):\n        if size:\n            self.size = size\n\n    def __call__(self, value):\n        if value.file.size > self.size:\n            raise ValidationError('Upload Size Error')\n\n    def __eq__(self, other): # <- __eq__ \u30e1\u30bd\u30c3\u30c9\u3092\u5b9f\u88c5\n        return (\n            isinstance(other, self.__class__) and (self.size == other.size)\n        )\n\n\n\u3053\u308c\u3067\u521d\u3081\u3066 makemigrations \u304c\u901a\u308b\u3002\n\n__eq__  \u306f\u306a\u3093\u306e\u305f\u3081\u5fc5\u8981\u306a\u306e\u304b\u3068\u3044\u3046\u3068\u3001migration\u30d5\u30a1\u30a4\u30eb\u3092\u751f\u6210\u3059\u308b\u6642\u306e\u5dee\u5206\u6bd4\u8f03\u306b\u5229\u7528\u3059\u308b\u3002\n\u5177\u4f53\u7684\u306b\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u3053\u3068\u304c\u8d77\u304d\u308b\u3002\n\n1. UploadSizeValidator(size=100) \u3092Field\u306b\u8a2d\u5b9a\u3057\u305f\u72b6\u614b\u3067 migration \u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u3063\u305f\u3068\u3059\u308b\n2. size\u3092 200 \u306b\u5909\u66f4\u3057\u3066 makemigrations \u3092\u5b9f\u884c\u3059\u308b\n3. __eq__ \u30e1\u30bd\u30c3\u30c9 \u3067 \u5909\u66f4\u524d(other.size=100)\u3068\u5909\u66f4\u5f8c(self.size=200) \u306e size \u3092\u6bd4\u8f03\n4. \u4e00\u81f4\u3057\u306a\u3044\u306e\u3067\u3001AlterField \u306e migration \u30d5\u30a1\u30a4\u30eb\u304c\u751f\u6210\u3055\u308c\u308b\n\n\n\u5b9f\u969b\u306b\u751f\u6210\u3055\u308c\u305f migration \u306e\u5185\u5bb9\u306f\u3053\u3093\u306a\u611f\u3058\n\noperations = [\n    migrations.AlterField(\n        model_name='question',\n        name='question_image',\n        field=models.ImageField(\n          default=None, upload_to='question_image',\n          validators=[polls.validators.UploadSizeValidator(size=200)]\n        ),\n    ),\n\n\n\u3053\u3046\u3059\u308b\u3053\u3068\u3067\u3001\u30d0\u30ea\u30c7\u30fc\u30bf\u30fc \u306e\u4e2d\u8eab\u3082 migrate \u3057\u305f\u308a, backwards \u3067\u623b\u3057\u305f\u308a\u3067\u304d\u308b\u3002\n\u3061\u306a\u307f\u306b\u95a2\u6570\u30d9\u30fc\u30b9\u306e\u30d0\u30ea\u30c7\u30fc\u30bf\u30fc\u306f\u5dee\u5206\u6bd4\u8f03\u3067\u304d\u308b\u3082\u306e\u3092\u6301\u305f\u306a\u3044\u306e\u3067\u3001\u4eca\u307e\u3067\u306e\u66f8\u304d\u65b9\u3068\u4e00\u7dd2\u3002\nvalidators\u306b\u6307\u5b9a\u3057\u305f\u6642\u306b\u3001AlterField \u304c\u751f\u6210\u3055\u308c\u308b\u306e\u307f\n\ndef validate_even(value):\n    if value % 2 != 0:\n        raise ValidationError(\n            _('%(value)s is not an even number'),\n            params={'value': value},\n        )\n\n\n\u30ab\u30b9\u30bf\u30e0\u30d5\u30a3\u30fc\u30eb\u30c9\n\n\u30ab\u30b9\u30bf\u30e0\u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u4f5c\u308b\u6642\u306f\u3001deconstruct \u30e1\u30bd\u30c3\u30c9\u306e\u5b9f\u88c5\u304c\u5fc5\u8981\u306b\u306a\u308b\u3002\n\ndeconstruct \u306f \u4e0a\u8a18\u306e __eq__  \u3068\u4f3c\u305f\u3088\u3046\u306a\u5f79\u5272\u3092\u6301\u3064\n\u3064\u307e\u308a Field\u306b\u5909\u66f4\u304c\u3042\u3063\u305f\u304b\u3069\u3046\u304b\u3092\u6bd4\u8f03\u3059\u308b\u305f\u3081\u306e\u60c5\u5831\u3092\u8fd4\u3059\n\u60c5\u5831\u306f \u30d5\u30a3\u30fc\u30eb\u30c9\u540d(name), \u30d5\u30a3\u30fc\u30eb\u30c9\u306e\u30d1\u30b9(path), Field \u306e constructor\u3078\u306e \u5f15\u6570(args)\u3001\u30ad\u30fc\u30ef\u30fc\u30c9\u5f15\u6570(kwargs)\n\nclass HandField(models.Field):\n\n    def __init__(self, *args, **kwargs):\n        kwargs['max_length'] = 104\n        super(HandField, self).__init__(*args, **kwargs)\n\n    def deconstruct(self):  # <- deconstruct\n        name, path, args, kwargs = super(HandField, self).deconstruct()\n        del kwargs[\"max_length\"]\n        return name, path, args, kwargs\n\n# refs https://docs.djangoproject.com/ja/1.9/howto/custom-model-fields/#field-deconstruction\n\n\n\u307e\u3068\u3081\n\n\u30ab\u30b9\u30bf\u30e0\u30d0\u30ea\u30c7\u30fc\u30bf\u3068\u3001\u30ab\u30b9\u30bf\u30e0\u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u4f5c\u308b\u7279\u306f\u7d30\u5de5\u304c\u5fc5\u8981\n\u30ab\u30b9\u30bf\u30e0\u30b9\u30c8\u30ec\u30fc\u30b8\u30af\u30e9\u30b9\u3092\u4f5c\u308b\u6642\u3082 deconstructible \u304c\u5fc5\u8981\n\n\n\u53c2\u8003\n\nhttps://docs.djangoproject.com/ja/1.9/howto/custom-model-fields/#field-deconstruction\nhttps://docs.djangoproject.com/ja/1.9/topics/migrations/#custom-deconstruct-method\nhttps://docs.djangoproject.com/ja/1.9/howto/custom-file-storage/\n\n## \u6982\u8981\n\n- Django\u306f 1.7 \u304b\u3089 migration \u6a5f\u80fd\u3092\u5185\u8535\u3059\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u3002\n- **makemigrations** \u3067\u81ea\u52d5\u3067\u5dee\u5206\u3092\u62bd\u51fa\u308b\u305f\u3081\u306b\u3001Model\u306e\u30ab\u30b9\u30bf\u30e0\u30d5\u30a3\u30fc\u30eb\u30c9\u3084\u30ab\u30b9\u30bf\u30e0\u30d0\u30ea\u30c7\u30fc\u30bf\u30fc\u306b\u7d30\u5de5\u3092\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\n- Field\u3067\u306f **deconstruct** \u30e1\u30bd\u30c3\u30c9\u306e\u5b9f\u88c5\u304c\u5fc5\u8981\n- Validator \u3067\u306f **deconstructible** \u30c7\u30b3\u30ec\u30fc\u30bf\u306e\u4ed8\u4e0e\u3068\u3001 **\\_\\_eq\\_\\_**  \u30e1\u30bd\u30c3\u30c9\u306e\u5b9f\u88c5\u304c\u5fc5\u8981\n- \u7c21\u5358\u306b\u5bfe\u5fdc\u5185\u5bb9\u3092\u307e\u3068\u3081\u308b\u3002\n\n## \u906d\u9047\u3057\u305f\u30a8\u30e9\u30fc\n\n- \u30ab\u30b9\u30bf\u30e0\u30d0\u30ea\u30c7\u30fc\u30bf\u30fc\u3092\u4f5c\u6210\u3057 **makemigrations** \u3092\u5b9f\u884c\u3057\u305f\u3089\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30a8\u30e9\u30fc\u306b\u906d\u9047\u3057\u305f\n\n```bash:\nThere are some values Django cannot serialize into migration files.\nFor more, see https://docs.djangoproject.com/en/1.9/topics/migrations/#migration-serializing\n```\n\n- \u3053\u308c\u3092\u89e3\u6c7a\u3057\u3088\u3046\u3068\u3057\u305f\u6642\u306b\u3001**deconstruct** \u306e\u8a71\u306b\u8fbf\u308a\u3064\u3044\u305f\n\n## \u30ab\u30b9\u30bf\u30e0\u30d0\u30ea\u30c7\u30fc\u30bf\u30fc\n\n- \u30af\u30e9\u30b9\u30d9\u30fc\u30b9\u306e\u30ab\u30b9\u30bf\u30e0\u30d0\u30ea\u30c7\u30fc\u30bf\u30fc \u306f 1.6 \u4ee5\u524d\u307e\u3067\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306b\u66f8\u3044\u3066\u3044\u305f\n\n```python\n# validators.py ----\n\nfrom django.core.exceptions import ValidationError\n\nclass UploadSizeValidator:\n\n    def __init__(self, size=None):\n        if size:\n            self.size = size\n\n    def __call__(self, value):\n        if value.file.size > self.size:\n            raise ValidationError('Upload Size Error')\n\n# models.py ----\n\nclass Question(models.Model):\n\n    question_image = models.ImageField(\n        upload_to='question_image',\n        validators=[UploadSizeValidator(size=200)],\n        default=None\n    )\n```\n\n- \u3060\u304c\u30011.7 \u304b\u3089\u306f Validator\u3092\u4e0b\u8a18\u306e\u3088\u3046\u306b\u5b9f\u88c5\u3057\u306a\u3044\u3068\u4e0a\u8a18\u306e\u30a8\u30e9\u30fc\u304c\u8868\u793a\u3055\u308c\u308b\u3002\n\n```python\nfrom django.core.exceptions import ValidationError\nfrom django.utils.deconstruct import deconstructible\n\n@deconstructible # <- decorator\u3092\u4ed8\u52a0\nclass UploadSizeValidator:\n\n    def __init__(self, size=None):\n        if size:\n            self.size = size\n\n    def __call__(self, value):\n        if value.file.size > self.size:\n            raise ValidationError('Upload Size Error')\n\n    def __eq__(self, other): # <- __eq__ \u30e1\u30bd\u30c3\u30c9\u3092\u5b9f\u88c5\n        return (\n            isinstance(other, self.__class__) and (self.size == other.size)\n        )\n```\n\n- \u3053\u308c\u3067\u521d\u3081\u3066 **makemigrations** \u304c\u901a\u308b\u3002\n- **\\_\\_eq\\_\\_**  \u306f\u306a\u3093\u306e\u305f\u3081\u5fc5\u8981\u306a\u306e\u304b\u3068\u3044\u3046\u3068\u3001migration\u30d5\u30a1\u30a4\u30eb\u3092\u751f\u6210\u3059\u308b\u6642\u306e\u5dee\u5206\u6bd4\u8f03\u306b\u5229\u7528\u3059\u308b\u3002\n- \u5177\u4f53\u7684\u306b\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u3053\u3068\u304c\u8d77\u304d\u308b\u3002\n\n```\n1. UploadSizeValidator(size=100) \u3092Field\u306b\u8a2d\u5b9a\u3057\u305f\u72b6\u614b\u3067 migration \u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u3063\u305f\u3068\u3059\u308b\n2. size\u3092 200 \u306b\u5909\u66f4\u3057\u3066 makemigrations \u3092\u5b9f\u884c\u3059\u308b\n3. __eq__ \u30e1\u30bd\u30c3\u30c9 \u3067 \u5909\u66f4\u524d(other.size=100)\u3068\u5909\u66f4\u5f8c(self.size=200) \u306e size \u3092\u6bd4\u8f03\n4. \u4e00\u81f4\u3057\u306a\u3044\u306e\u3067\u3001AlterField \u306e migration \u30d5\u30a1\u30a4\u30eb\u304c\u751f\u6210\u3055\u308c\u308b\n```\n\n- \u5b9f\u969b\u306b\u751f\u6210\u3055\u308c\u305f migration \u306e\u5185\u5bb9\u306f\u3053\u3093\u306a\u611f\u3058\n\n```python\noperations = [\n    migrations.AlterField(\n        model_name='question',\n        name='question_image',\n        field=models.ImageField(\n          default=None, upload_to='question_image',\n          validators=[polls.validators.UploadSizeValidator(size=200)]\n        ),\n    ),\n```\n\n- \u3053\u3046\u3059\u308b\u3053\u3068\u3067\u3001\u30d0\u30ea\u30c7\u30fc\u30bf\u30fc \u306e\u4e2d\u8eab\u3082 migrate \u3057\u305f\u308a, backwards \u3067\u623b\u3057\u305f\u308a\u3067\u304d\u308b\u3002\n- \u3061\u306a\u307f\u306b\u95a2\u6570\u30d9\u30fc\u30b9\u306e\u30d0\u30ea\u30c7\u30fc\u30bf\u30fc\u306f\u5dee\u5206\u6bd4\u8f03\u3067\u304d\u308b\u3082\u306e\u3092\u6301\u305f\u306a\u3044\u306e\u3067\u3001\u4eca\u307e\u3067\u306e\u66f8\u304d\u65b9\u3068\u4e00\u7dd2\u3002\n- validators\u306b\u6307\u5b9a\u3057\u305f\u6642\u306b\u3001AlterField \u304c\u751f\u6210\u3055\u308c\u308b\u306e\u307f\n\n```python\ndef validate_even(value):\n    if value % 2 != 0:\n        raise ValidationError(\n            _('%(value)s is not an even number'),\n            params={'value': value},\n        )\n```\n\n## \u30ab\u30b9\u30bf\u30e0\u30d5\u30a3\u30fc\u30eb\u30c9\n\n- \u30ab\u30b9\u30bf\u30e0\u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u4f5c\u308b\u6642\u306f\u3001**deconstruct** \u30e1\u30bd\u30c3\u30c9\u306e\u5b9f\u88c5\u304c\u5fc5\u8981\u306b\u306a\u308b\u3002\n- **deconstruct** \u306f \u4e0a\u8a18\u306e **\\_\\_eq\\_\\_**  \u3068\u4f3c\u305f\u3088\u3046\u306a\u5f79\u5272\u3092\u6301\u3064\n- \u3064\u307e\u308a Field\u306b\u5909\u66f4\u304c\u3042\u3063\u305f\u304b\u3069\u3046\u304b\u3092\u6bd4\u8f03\u3059\u308b\u305f\u3081\u306e\u60c5\u5831\u3092\u8fd4\u3059\n- \u60c5\u5831\u306f \u30d5\u30a3\u30fc\u30eb\u30c9\u540d(name), \u30d5\u30a3\u30fc\u30eb\u30c9\u306e\u30d1\u30b9(path), Field \u306e constructor\u3078\u306e \u5f15\u6570(args)\u3001\u30ad\u30fc\u30ef\u30fc\u30c9\u5f15\u6570(kwargs)\n\n```python\nclass HandField(models.Field):\n\n    def __init__(self, *args, **kwargs):\n        kwargs['max_length'] = 104\n        super(HandField, self).__init__(*args, **kwargs)\n\n    def deconstruct(self):  # <- deconstruct\n        name, path, args, kwargs = super(HandField, self).deconstruct()\n        del kwargs[\"max_length\"]\n        return name, path, args, kwargs\n\n# refs https://docs.djangoproject.com/ja/1.9/howto/custom-model-fields/#field-deconstruction\n```\n\n## \u307e\u3068\u3081\n\n- \u30ab\u30b9\u30bf\u30e0\u30d0\u30ea\u30c7\u30fc\u30bf\u3068\u3001\u30ab\u30b9\u30bf\u30e0\u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u4f5c\u308b\u7279\u306f\u7d30\u5de5\u304c\u5fc5\u8981\n- \u30ab\u30b9\u30bf\u30e0\u30b9\u30c8\u30ec\u30fc\u30b8\u30af\u30e9\u30b9\u3092\u4f5c\u308b\u6642\u3082 **deconstructible** \u304c\u5fc5\u8981\n\n## \u53c2\u8003\n\n- https://docs.djangoproject.com/ja/1.9/howto/custom-model-fields/#field-deconstruction\n- https://docs.djangoproject.com/ja/1.9/topics/migrations/#custom-deconstruct-method\n- https://docs.djangoproject.com/ja/1.9/howto/custom-file-storage/\n", "tags": ["Django", "Python"]}