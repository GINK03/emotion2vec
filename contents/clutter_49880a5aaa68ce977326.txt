{"tags": ["fluentd", "log"], "context": "\n\n\u6982\u8981\n\u3055\u304f\u3089\u306e\u30ca\u30ec\u30c3\u30b8\u306e\u8aac\u660e\u304c\u4e00\u756a\u308f\u304b\u308a\u3084\u3059\u304b\u3063\u305f\u3067\u3059\u3002\nhttp://knowledge.sakura.ad.jp/tech/1336/\n\n\u74b0\u5883\n\nCentOS 6.7\nfluentd 0.12.20\n\n\nInstall+\u8a2d\u5b9a\n\u3053\u3093\u306a\u611f\u3058\u3067ansible\u3067install\u3057\u307e\u3057\u305f\u3002\nwebserver\u306b\u7acb\u3066\u305fapach\u306elog\u3092logserver\u3067\u53d7\u3051\u3066\u3044\u307e\u3059\u3002\nlog\u3092\u9001\u308b\u5074\u3082log\u3092\u53d7\u3051\u308b\u5074\u3082\u3069\u3061\u3089\u3082td-agent\u3068\u3044\u3046\u540c\u3058service\u304c\u52d5\u3044\u3066\u3044\u307e\u3059\u3002\nwebserver\u304c\u8907\u6570\u53f0\u306b\u306a\u3063\u305f\u6642\u306blogserver\u306blog\u304c\u96c6\u7d04\u3055\u308c\u308b\u306e\u3067\u3001\u3042\u3068\u306fElastic search\u3092\u4f55\u304b\u5165\u308c\u308c\u3070\u826f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\ntd-agent\u3068\u3044\u3046user\u3067\u5b9f\u884c\u3057\u3088\u3046\u3068\u3057\u3066permission denied\u304c\u767a\u751f\u3057\u3066\u3044\u305f\u306e\u3067\u3001root\u3067\u5b9f\u884c\u3059\u308b\u3088\u3046\u306b\u8a2d\u5b9afile\u3092\u66f8\u304d\u63db\u3048\u3066\u3044\u308b\u3002\n\nansible-galaxy\u304b\u3089\u6b21\u306erole\u3092\u4f7f\u308f\u305b\u3066\u3044\u305f\u3060\u304d\u307e\u3057\u305f\u3002\n\ngeerlingguy.apache\nwilliamyeh.fluentd\n\n\nwebserver.yml\n# webserver playbook\n- name: configure the web server\n  hosts: webserver\n  vars:\n    - apache_listen_port: 10443\n  roles:\n    - geerlingguy.apache\n  tasks:\n    - name: copy init files\n      copy: src=roles/tomcat8/files/httpd-proxy.conf dest=/etc/httpd/conf/httpd-proxy.conf owner=root group=wheel mode=0644\n\n    - name: deploy setting file\n      lineinfile: dest=/etc/httpd/conf/httpd.conf line='Include /etc/httpd/conf/httpd-proxy.conf'\n\n    - name: restart service and auto startup setting\n      service: name=httpd state=restarted\n\n- name: configure fluentd\n  hosts: webserver\n  vars:\n    - tdagent_conf_template: \"roles/td-agent/templates/web-td-agent.conf.j2\"\n    - aggregator_ip: \"{{ logserver.ip }}\"\n    - tdagent_port: \"{{ logserver.tdagent_port }}\"\n  roles:\n    - williamyeh.fluentd\n  tasks:\n    - name: change start user to root\n      lineinfile: >\n        dest=/etc/init.d/td-agent\n        regexp='TD_AGENT_USER'\n        line='TD_AGENT_USER=root'\n      notify: td-agent restart\n    - name: change start group to root\n      lineinfile: >\n        dest=/etc/init.d/td-agent\n        regexp='TD_AGENT_GROUP'\n        line='TD_AGENT_GROUP=root'\n      notify: td-agent restart\n  handlers:\n    - name: td-agent restart                                                         \n      service: name=td-agent state=restarted\n\n\n\nlogserver.yml\n# logserver playbook\n- name: configure fluentd\n  hosts: logserver\n  vars:\n    - tdagent_conf_template: \"roles/td-agent/templates/log-td-agent.conf.j2\"\n    - tdagent_port: 24224\n  roles:\n    - williamyeh.fluentd\n\n\n\nroles/td-agent/templates/web-td-agent.conf.j2\n####\n## Source descriptions:\n##\n\n#\n# Apache Log\n#\n## access\n<source>\n  type tail\n  path /var/log/httpd/access_log\n  tag apache.access\n  pos_file /var/log/td-agent/httpd-access_log.pos\n  format apache2\n</source>\n## error\n<source>\n  type tail\n  path /var/log/httpd/error_log\n  tag apache.error\n  pos_file /var/log/td-agent/httpd-error_log.pos\n  format apache_error\n</source>\n\n####\n## Output descriptions:\n##\n\n#\n# Apache Log\n#\n<match apache.**>\n  type forward\n  <server>\n    host {{ aggregator_ip }}\n    port {{ tdagent_port }}\n  </server>\n</match>\n\n\n\nroles/td-agent/templates/log-td-agent.conf.j2\n####\n## Source descriptions:\n##\n\n#\n# Recieve Logs\n#\n<source>\n  type forward\n  port {{ tdagent_port }}\n</source>\n\n####\n## Output descriptions:\n##\n<match apache.access>\n  type file\n  path /var/log/td-agent/httpd/access.log\n  time_slice_format %Y%m%d\n  time_slice-wait 10m\n  compress gzip\n</match>\n<match apache.error>\n  type file\n  path /var/log/td-agent/httpd/error.log\n  time_slice_format %Y%m%d\n  time_slice-wait 10m\n  compress gzip\n</match>\n\n\n\u69cb\u6210\u306f\u3053\u3093\u306a\u611f\u3058\n\n\n\u7d50\u679c\nwebserver\u306eapache\u306elog\n192.168.1.1 - - [07/Jul/2016:19:26:31 +0900] \"GET / HTTP/1.1\" 403 4961 \"-\" \"Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko\"\n192.168.1.1 - - [07/Jul/2016:19:26:40 +0900] \"GET / HTTP/1.1\" 403 4961 \"-\" \"Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko\"\n192.168.2.3 - - [07/Jul/2016:19:55:28 +0900] \"GET / HTTP/1.1\" 403 4961 \"-\" \"Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko\"\n192.168.2.3 - - [07/Jul/2016:19:55:28 +0900] \"GET /icons/apache_pb.gif HTTP/1.1\" 304 - \"http://164.70.6.213:10443/\" \"Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko\"\n\nlogserver\u306b\u9001\u3089\u308c\u305flog\n\n/var/log/td-agent/httpd/access.log\n2016-07-07T19:26:31+09:00       apache.access   {\"host\":\"192.168.1.1\",\"user\":null,\"method\":\"GET\",\"path\":\"/\",\"code\":403,\"size\":4961,\"referer\":null,\"agent\":\"Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko\"}\n2016-07-07T19:26:40+09:00       apache.access   {\"host\":\"192.168.1.1\",\"user\":null,\"method\":\"GET\",\"path\":\"/\",\"code\":403,\"size\":4961,\"referer\":null,\"agent\":\"Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko\"}\n2016-07-07T19:55:28+09:00       apache.access   {\"host\":\"192.168.2.3\",\"user\":null,\"method\":\"GET\",\"path\":\"/\",\"code\":403,\"size\":4961,\"referer\":null,\"agent\":\"Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko\"}\n2016-07-07T19:55:28+09:00       apache.access   {\"host\":\"192.168.2.3\",\"user\":null,\"method\":\"GET\",\"path\":\"/icons/apache_pb.gif\",\"code\":304,\"size\":null,\"referer\":\"http://164.70.6.213:10443/\",\"agent\":\"Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko\"}\n\n\n\n\u4fbf\u5229\u30c4\u30fc\u30eb\n\nlog\u306e\u6b63\u898f\u8868\u73fe\u3092\u66f8\u304f\u6642\u306b\u5f79\u7acb\u3061\u305d\u3046\u306a\u30b5\u30a4\u30c8\n\n\nhttp://fluentular.herokuapp.com/\n\n\n\n# \u6982\u8981\n\n\u3055\u304f\u3089\u306e\u30ca\u30ec\u30c3\u30b8\u306e\u8aac\u660e\u304c\u4e00\u756a\u308f\u304b\u308a\u3084\u3059\u304b\u3063\u305f\u3067\u3059\u3002\nhttp://knowledge.sakura.ad.jp/tech/1336/\n\n# \u74b0\u5883\n\n* CentOS 6.7\n* fluentd 0.12.20\n\n# Install+\u8a2d\u5b9a\n\n\u3053\u3093\u306a\u611f\u3058\u3067ansible\u3067install\u3057\u307e\u3057\u305f\u3002\nwebserver\u306b\u7acb\u3066\u305fapach\u306elog\u3092logserver\u3067\u53d7\u3051\u3066\u3044\u307e\u3059\u3002\nlog\u3092\u9001\u308b\u5074\u3082log\u3092\u53d7\u3051\u308b\u5074\u3082\u3069\u3061\u3089\u3082td-agent\u3068\u3044\u3046\u540c\u3058service\u304c\u52d5\u3044\u3066\u3044\u307e\u3059\u3002\nwebserver\u304c\u8907\u6570\u53f0\u306b\u306a\u3063\u305f\u6642\u306blogserver\u306blog\u304c\u96c6\u7d04\u3055\u308c\u308b\u306e\u3067\u3001\u3042\u3068\u306fElastic search\u3092\u4f55\u304b\u5165\u308c\u308c\u3070\u826f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n* td-agent\u3068\u3044\u3046user\u3067\u5b9f\u884c\u3057\u3088\u3046\u3068\u3057\u3066permission denied\u304c\u767a\u751f\u3057\u3066\u3044\u305f\u306e\u3067\u3001root\u3067\u5b9f\u884c\u3059\u308b\u3088\u3046\u306b\u8a2d\u5b9afile\u3092\u66f8\u304d\u63db\u3048\u3066\u3044\u308b\u3002\n\nansible-galaxy\u304b\u3089\u6b21\u306erole\u3092\u4f7f\u308f\u305b\u3066\u3044\u305f\u3060\u304d\u307e\u3057\u305f\u3002\n\n* geerlingguy.apache\n* williamyeh.fluentd\n\n```{webserver.yml}\n# webserver playbook\n- name: configure the web server\n  hosts: webserver\n  vars:\n    - apache_listen_port: 10443\n  roles:\n    - geerlingguy.apache\n  tasks:\n    - name: copy init files\n      copy: src=roles/tomcat8/files/httpd-proxy.conf dest=/etc/httpd/conf/httpd-proxy.conf owner=root group=wheel mode=0644\n\n    - name: deploy setting file\n      lineinfile: dest=/etc/httpd/conf/httpd.conf line='Include /etc/httpd/conf/httpd-proxy.conf'\n\n    - name: restart service and auto startup setting\n      service: name=httpd state=restarted\n\n- name: configure fluentd\n  hosts: webserver\n  vars:\n    - tdagent_conf_template: \"roles/td-agent/templates/web-td-agent.conf.j2\"\n    - aggregator_ip: \"{{ logserver.ip }}\"\n    - tdagent_port: \"{{ logserver.tdagent_port }}\"\n  roles:\n    - williamyeh.fluentd\n  tasks:\n    - name: change start user to root\n      lineinfile: >\n        dest=/etc/init.d/td-agent\n        regexp='TD_AGENT_USER'\n        line='TD_AGENT_USER=root'\n      notify: td-agent restart\n    - name: change start group to root\n      lineinfile: >\n        dest=/etc/init.d/td-agent\n        regexp='TD_AGENT_GROUP'\n        line='TD_AGENT_GROUP=root'\n      notify: td-agent restart\n  handlers:\n    - name: td-agent restart                                                         \n      service: name=td-agent state=restarted\n```\n\n```{logserver.yml}\n# logserver playbook\n- name: configure fluentd\n  hosts: logserver\n  vars:\n    - tdagent_conf_template: \"roles/td-agent/templates/log-td-agent.conf.j2\"\n    - tdagent_port: 24224\n  roles:\n    - williamyeh.fluentd\n```\n\n```{roles/td-agent/templates/web-td-agent.conf.j2}\n####\n## Source descriptions:\n##\n\n#\n# Apache Log\n#\n## access\n<source>\n  type tail\n  path /var/log/httpd/access_log\n  tag apache.access\n  pos_file /var/log/td-agent/httpd-access_log.pos\n  format apache2\n</source>\n## error\n<source>\n  type tail\n  path /var/log/httpd/error_log\n  tag apache.error\n  pos_file /var/log/td-agent/httpd-error_log.pos\n  format apache_error\n</source>\n\n####\n## Output descriptions:\n##\n\n#\n# Apache Log\n#\n<match apache.**>\n  type forward\n  <server>\n    host {{ aggregator_ip }}\n    port {{ tdagent_port }}\n  </server>\n</match>\n```\n\n```{roles/td-agent/templates/log-td-agent.conf.j2}\n####\n## Source descriptions:\n##\n\n#\n# Recieve Logs\n#\n<source>\n  type forward\n  port {{ tdagent_port }}\n</source>\n\n####\n## Output descriptions:\n##\n<match apache.access>\n  type file\n  path /var/log/td-agent/httpd/access.log\n  time_slice_format %Y%m%d\n  time_slice-wait 10m\n  compress gzip\n</match>\n<match apache.error>\n  type file\n  path /var/log/td-agent/httpd/error.log\n  time_slice_format %Y%m%d\n  time_slice-wait 10m\n  compress gzip\n</match>\n```\n\n\u69cb\u6210\u306f\u3053\u3093\u306a\u611f\u3058\n\n![fluentd_structure.png](https://qiita-image-store.s3.amazonaws.com/0/107806/55f611d8-cf9a-b016-ba4d-051673315f3f.png)\n\n\n# \u7d50\u679c\n\nwebserver\u306eapache\u306elog\n\n```{/var/log/httpd/access_log}\n192.168.1.1 - - [07/Jul/2016:19:26:31 +0900] \"GET / HTTP/1.1\" 403 4961 \"-\" \"Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko\"\n192.168.1.1 - - [07/Jul/2016:19:26:40 +0900] \"GET / HTTP/1.1\" 403 4961 \"-\" \"Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko\"\n192.168.2.3 - - [07/Jul/2016:19:55:28 +0900] \"GET / HTTP/1.1\" 403 4961 \"-\" \"Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko\"\n192.168.2.3 - - [07/Jul/2016:19:55:28 +0900] \"GET /icons/apache_pb.gif HTTP/1.1\" 304 - \"http://164.70.6.213:10443/\" \"Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko\"\n```\n\nlogserver\u306b\u9001\u3089\u308c\u305flog\n\n```{/var/log/td-agent/httpd/access.log}\n2016-07-07T19:26:31+09:00       apache.access   {\"host\":\"192.168.1.1\",\"user\":null,\"method\":\"GET\",\"path\":\"/\",\"code\":403,\"size\":4961,\"referer\":null,\"agent\":\"Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko\"}\n2016-07-07T19:26:40+09:00       apache.access   {\"host\":\"192.168.1.1\",\"user\":null,\"method\":\"GET\",\"path\":\"/\",\"code\":403,\"size\":4961,\"referer\":null,\"agent\":\"Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko\"}\n2016-07-07T19:55:28+09:00       apache.access   {\"host\":\"192.168.2.3\",\"user\":null,\"method\":\"GET\",\"path\":\"/\",\"code\":403,\"size\":4961,\"referer\":null,\"agent\":\"Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko\"}\n2016-07-07T19:55:28+09:00       apache.access   {\"host\":\"192.168.2.3\",\"user\":null,\"method\":\"GET\",\"path\":\"/icons/apache_pb.gif\",\"code\":304,\"size\":null,\"referer\":\"http://164.70.6.213:10443/\",\"agent\":\"Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko\"}\n```\n\n# \u4fbf\u5229\u30c4\u30fc\u30eb\n\n* log\u306e\u6b63\u898f\u8868\u73fe\u3092\u66f8\u304f\u6642\u306b\u5f79\u7acb\u3061\u305d\u3046\u306a\u30b5\u30a4\u30c8\n    - http://fluentular.herokuapp.com/\n"}