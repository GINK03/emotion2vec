{"context": " More than 1 year has passed since last update.\n\n\u521d\u3081\u306b\nBoto(AWS\u306ePython SDK)\u3092\u4f7f\u3063\u3066\u3001S3\u4e0a\u306b\u3042\u308bCloudTrail\u306elog\u3092Parse\u3057\u305f\u3044\u3001\u3068\u601d\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u5e7e\u3064\u304b\u30cf\u30de\u30c3\u305f\u7b87\u6240\u304c\u3042\u3063\u305f\u306e\u3068\u3001\u81ea\u5206\u306b\u305a\u3070\u308a\u53c2\u8003\u306b\u306a\u308b\u53d6\u3063\u639b\u304b\u308a\u306eSample Code\u304c\u3046\u307e\u304f\u898b\u3064\u304b\u3089\u306a\u304b\u3063\u305f\u306e\u3067\u3001\u3054\u53c2\u8003\u307e\u3067\u306bCode\u3092\u30c1\u30e9\u30b7\u306e\u88cf\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n\u30cf\u30de\u30c3\u305f\u7b87\u6240\n\nBoto3\u306fHTTP Proxy\u7d4c\u7531\u3067\u306eAccess\u3092\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u3044\u306a\u3044? \u3063\u307d\u304f\u3001\u7d50\u5c40Boto2\u3092\u4f7f\u3044\u307e\u3057\u305f\nCloudTrail\u306elog\u306fDefault\u3067gz\u5727\u7e2e\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u4e2d\u8eab\u3092parse\u3059\u308b\u306b\u306f\u89e3\u51cd\u51e6\u7406\u304c\u5fc5\u8981\n\u300eS3\u306exx\u3063\u3066Bucket\u306eaa/bb/cc\u306ePath\u4ee5\u4e0b\u306efile\u3060\u3051\u3092\u5bfe\u8c61\u300f\u3068\u3044\u3046\u5834\u5408\u306fbucket.list(prefix='aa/bb/cc')\n\n\n\u306a\u304a\u3001CloudTrail\u306elog\u306f\u3001Loggly\u3092\u4f7f\u3046\u3068\u89e3\u6790\u304c\u6357\u308b\u307f\u305f\u3044\u3067\u3059\u3002\n\nPython Code\u306b\u3064\u3044\u3066\n\n\u500b\u5225\u306b\u8a2d\u5b9a\u304c\u5fc5\u8981\u306a\u3082\u306e\naws_access_key_id, aws_secret_access_key,target_path, proxy, proxy_port\u304c\u500b\u5225\u8a2d\u5b9a\u5fc5\u8981\u3067\u3059\u3002\n\n\naws_access_key_id, aws_secret_access_key\u306f\u3001AWS\u5916\u90e8\u30a2\u30af\u30bb\u30b9\u7528\u306b\u4f5c\u6210\u3057\u305fIAM User\u306ekey\u3092\u8a2d\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044(\u4f5c\u6210\u3057\u305fIAM User\u306bS3\u3078\u306eReadAccess\u6a29(AmazonS3ReadOnlyAccess)\u306e\u4ed8\u4e0e\u3092\u5fd8\u308c\u305a\u306b!)\n\nproxy, proxy_port\u306fHTTP Proxy server\u306e\u8a2d\u5b9a\u3067\u3059\n\ntarget_bucket\u306f\u5bfe\u8c61\u306ebucket\u540d\u3001target_path\u306f\u89e3\u6790\u306e\u5bfe\u8c61\u3068\u3057\u305f\u3044S3\u306epath\u3067\u3059\u3001\u3053\u3053\u3067\u306fus-west-2\u306e2015/07\u306elog\u306e\u307f\u3092\u5bfe\u8c61\u3068\u3057\u307f\u307e\u3057\u305f\n\n\n\u88dc\u8db3\n\n\u4ee5\u4e0b\u306eSample code\u306eaccess key\u306a\u3069\u306f\u9069\u5f53\u306a\u6587\u5b57\u5217\u306b\u3057\u3066\u307e\u3059\nPython2.7, Boto v2.32.1\u3092\u4f7f\u3063\u3066\u3044\u307e\u3059\n\n\nCode\u306e\u5927\u67a0\u306e\u6d41\u308c\n\u4ee5\u4e0b\u306e\u69d8\u306a\u51e6\u7406\u306e\u6d41\u308c\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n\ntarget_bucketBucket\u306etarget_path\u4ee5\u4e0b\u306b\u3042\u308bfile(Key)\u3092List\u3057\u3001\u305d\u308c\u3089\u3092Download\u3059\u308b\nDownload\u3055\u308c\u305ffile(gz\u5f62\u5f0f)\u3092\u89e3\u51cd\u3057\u3001JSON\u3068\u3057\u3066\u8aad\u307f\u8fbc\u3080\nRDS\u95a2\u9023\u306eLog\u304c\u5408\u3063\u305f\u5834\u5408(['eventSource'] == 'rds.amazonaws.com')\u3001\u4e2d\u8eab\u3092\u6a19\u6e96\u51fa\u529b\u306b\u51fa\u3059\n\n\nimport boto.s3.connection, gzip, StringIO, json\n\naws_access_key_id='AKKBUGOIU4434DDTT'\naws_secret_access_key='78oiupoiuh7++REugoiusGSEE'\ntarget_bucket = 'your-backet-name'\ntarget_path = 'CroudTrail/AWSLogs/1234567899999888/CloudTrail/us-west-2/2015/07'\n\ndef main():\n  s3Instance = boto.s3.connection.S3Connection \\\n    (aws_access_key_id, aws_secret_access_key, proxy='your.proxy.server.com', proxy_port=8080)\n  s3Bucket   = s3Instance.get_bucket(target_bucket)\n  bucketList = s3Bucket.list(prefix=target_path)\n\n  for count, itemOne in enumerate(bucketList):\n    s3BucketKey = s3Bucket.get_key(itemOne.name)\n    buffer_gz = s3BucketKey.get_contents_as_string()\n    stringBuffer = StringIO.StringIO(buffer_gz)\n    buffer_text = gzip.GzipFile(fileobj=stringBuffer)\n\n    try:\n      responseJSON = json.loads(buffer_text.read())\n    except Exception, e:\n      print e\n    else:\n      for count, itemTwo in enumerate(responseJSON['Records']):\n        if itemTwo['eventSource'] == 'rds.amazonaws.com':\n          print json.dumps(itemTwo, separators=(',', ':'), indent=2)\n          print 'Event name = %s' % (itemTwo['eventName'])\n          print '================================='\n\n    stringBuffer.close()\n    buffer_text.close()\n\nif __name__ == '__main__':\n  main()\n\n## \u521d\u3081\u306b\nBoto(AWS\u306ePython SDK)\u3092\u4f7f\u3063\u3066\u3001S3\u4e0a\u306b\u3042\u308bCloudTrail\u306elog\u3092Parse\u3057\u305f\u3044\u3001\u3068\u601d\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u5e7e\u3064\u304b\u30cf\u30de\u30c3\u305f\u7b87\u6240\u304c\u3042\u3063\u305f\u306e\u3068\u3001\u81ea\u5206\u306b\u305a\u3070\u308a\u53c2\u8003\u306b\u306a\u308b\u53d6\u3063\u639b\u304b\u308a\u306eSample Code\u304c\u3046\u307e\u304f\u898b\u3064\u304b\u3089\u306a\u304b\u3063\u305f\u306e\u3067\u3001\u3054\u53c2\u8003\u307e\u3067\u306bCode\u3092\u30c1\u30e9\u30b7\u306e\u88cf\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n#### \u30cf\u30de\u30c3\u305f\u7b87\u6240\n* Boto3\u306fHTTP Proxy\u7d4c\u7531\u3067\u306eAccess\u3092\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u3044\u306a\u3044? \u3063\u307d\u304f\u3001\u7d50\u5c40Boto2\u3092\u4f7f\u3044\u307e\u3057\u305f\n* CloudTrail\u306elog\u306fDefault\u3067gz\u5727\u7e2e\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u4e2d\u8eab\u3092parse\u3059\u308b\u306b\u306f\u89e3\u51cd\u51e6\u7406\u304c\u5fc5\u8981\n* \u300eS3\u306exx\u3063\u3066Bucket\u306eaa/bb/cc\u306ePath\u4ee5\u4e0b\u306efile\u3060\u3051\u3092\u5bfe\u8c61\u300f\u3068\u3044\u3046\u5834\u5408\u306f`bucket.list(prefix='aa/bb/cc')`\n\n\u306a\u304a\u3001CloudTrail\u306elog\u306f\u3001[Loggly\u3092\u4f7f\u3046\u3068\u89e3\u6790\u304c\u6357\u308b](http://blog.serverworks.co.jp/tech/2014/10/10/loggly/)\u307f\u305f\u3044\u3067\u3059\u3002\n\n## Python Code\u306b\u3064\u3044\u3066\n\n### \u500b\u5225\u306b\u8a2d\u5b9a\u304c\u5fc5\u8981\u306a\u3082\u306e\n`aws_access_key_id`, `aws_secret_access_key`,`target_path`, `proxy`, `proxy_port`\u304c\u500b\u5225\u8a2d\u5b9a\u5fc5\u8981\u3067\u3059\u3002\n\n* `aws_access_key_id`, `aws_secret_access_key`\u306f\u3001AWS\u5916\u90e8\u30a2\u30af\u30bb\u30b9\u7528\u306b\u4f5c\u6210\u3057\u305fIAM User\u306ekey\u3092\u8a2d\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044(\u4f5c\u6210\u3057\u305fIAM User\u306bS3\u3078\u306eReadAccess\u6a29(`AmazonS3ReadOnlyAccess`)\u306e\u4ed8\u4e0e\u3092\u5fd8\u308c\u305a\u306b!)\n* `proxy`, `proxy_port`\u306fHTTP Proxy server\u306e\u8a2d\u5b9a\u3067\u3059\n* `target_bucket`\u306f\u5bfe\u8c61\u306ebucket\u540d\u3001`target_path`\u306f\u89e3\u6790\u306e\u5bfe\u8c61\u3068\u3057\u305f\u3044S3\u306epath\u3067\u3059\u3001\u3053\u3053\u3067\u306fus-west-2\u306e2015/07\u306elog\u306e\u307f\u3092\u5bfe\u8c61\u3068\u3057\u307f\u307e\u3057\u305f\n\n### \u88dc\u8db3\n* \u4ee5\u4e0b\u306eSample code\u306eaccess key\u306a\u3069\u306f\u9069\u5f53\u306a\u6587\u5b57\u5217\u306b\u3057\u3066\u307e\u3059\n* Python2.7, Boto v2.32.1\u3092\u4f7f\u3063\u3066\u3044\u307e\u3059\n\n### Code\u306e\u5927\u67a0\u306e\u6d41\u308c\n\u4ee5\u4e0b\u306e\u69d8\u306a\u51e6\u7406\u306e\u6d41\u308c\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n* `target_bucket`Bucket\u306e`target_path`\u4ee5\u4e0b\u306b\u3042\u308bfile(Key)\u3092List\u3057\u3001\u305d\u308c\u3089\u3092Download\u3059\u308b\n* Download\u3055\u308c\u305ffile(gz\u5f62\u5f0f)\u3092\u89e3\u51cd\u3057\u3001JSON\u3068\u3057\u3066\u8aad\u307f\u8fbc\u3080\n* RDS\u95a2\u9023\u306eLog\u304c\u5408\u3063\u305f\u5834\u5408(`['eventSource'] == 'rds.amazonaws.com'`)\u3001\u4e2d\u8eab\u3092\u6a19\u6e96\u51fa\u529b\u306b\u51fa\u3059\n\n\n```py\n\nimport boto.s3.connection, gzip, StringIO, json\n\naws_access_key_id='AKKBUGOIU4434DDTT'\naws_secret_access_key='78oiupoiuh7++REugoiusGSEE'\ntarget_bucket = 'your-backet-name'\ntarget_path = 'CroudTrail/AWSLogs/1234567899999888/CloudTrail/us-west-2/2015/07'\n\ndef main():\n  s3Instance = boto.s3.connection.S3Connection \\\n    (aws_access_key_id, aws_secret_access_key, proxy='your.proxy.server.com', proxy_port=8080)\n  s3Bucket   = s3Instance.get_bucket(target_bucket)\n  bucketList = s3Bucket.list(prefix=target_path)\n\n  for count, itemOne in enumerate(bucketList):\n    s3BucketKey = s3Bucket.get_key(itemOne.name)\n    buffer_gz = s3BucketKey.get_contents_as_string()\n    stringBuffer = StringIO.StringIO(buffer_gz)\n    buffer_text = gzip.GzipFile(fileobj=stringBuffer)\n\n    try:\n      responseJSON = json.loads(buffer_text.read())\n    except Exception, e:\n      print e\n    else:\n      for count, itemTwo in enumerate(responseJSON['Records']):\n        if itemTwo['eventSource'] == 'rds.amazonaws.com':\n          print json.dumps(itemTwo, separators=(',', ':'), indent=2)\n          print 'Event name = %s' % (itemTwo['eventName'])\n          print '================================='\n\n    stringBuffer.close()\n    buffer_text.close()\n\nif __name__ == '__main__':\n  main()\n```\n", "tags": ["boto", "Cloudtrail", "Python"]}