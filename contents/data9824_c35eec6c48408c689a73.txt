{"tags": ["R", "PRML"], "context": " \u3053\u306e\u8a18\u4e8b\u306f\u6700\u7d42\u66f4\u65b0\u65e5\u304b\u30891\u5e74\u4ee5\u4e0a\u304c\u7d4c\u904e\u3057\u3066\u3044\u307e\u3059\u3002PRML\u56f38.51\u306e\u6728\u69cb\u9020\u56e0\u5b50\u30b0\u30e9\u30d5\u306b\u3064\u3044\u3066\u3001\u7a4d\u548c\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\uff08sum-product\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\uff09\u306b\u3088\u308a\u3001\u5404\u5909\u6570\u30ce\u30fc\u30c9xn\u306e\u5468\u8fba\u5206\u5e03p(xn)\u3092\u6c42\u3081\u307e\u3059\u3002\n\u307e\u305a\u3001\u7d20\u6734\u306b\u5f0f8.61\u306e\u901a\u308a\u3001x\u304c\u53d6\u308a\u5f97\u308b\u72b6\u614b\u5168\u3066\u306e\u5834\u5408\u306b\u3064\u3044\u3066\u540c\u6642\u5206\u5e03\u3092\u6c42\u3081\u3066\u3001\u305d\u308c\u3089\u306e\u5408\u8a08\u306b\u3088\u308a\u5468\u8fba\u5206\u5e03\u3092\u6c42\u3081\u307e\u3059\u3002(\u306a\u304a\u3001\u3053\u306e\u5b9f\u88c5\u3067\u306f\u30b0\u30e9\u30d5\u3092\u89e3\u6790\u3057\u3066\u3044\u308b\u308f\u3051\u3067\u306f\u306a\u304f\u3001\u4eca\u56de\u306e\u4f8b\u306b\u5408\u308f\u305b\u3066\u56e0\u5b50\u306e\u7a4d\u3092\u6c7a\u3081\u3046\u3061\u3067\u8a08\u7b97\u3057\u3066\u3044\u307e\u3059\u3002)\n\u4e00\u65b9\u3001\u7a4d\u548c\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3092\u7528\u3044\u3066\u3001\u6728\u306e\u8449\u304b\u3089\u6839\u65b9\u5411\u3068\u3001\u6839\u304b\u3089\u8449\u65b9\u5411\u3078\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u30d1\u30c3\u30b7\u30f3\u30b0\u306b\u3088\u3063\u3066\u5168\u3066\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6c42\u3081\u3001\u5f0f8.63\u306e\u901a\u308a\u30e1\u30c3\u30bb\u30fc\u30b8\u306e\u7a4d\u3068\u3057\u3066\u3001\u540c\u3058\u7d50\u679c\u304c\u5f97\u3089\u308c\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\u306a\u304a\u3001\u5404\u5909\u6570\u30ce\u30fc\u30c9xn\u306f3\u500b\u306e\u72b6\u614b\u3092\u3068\u308b\u3082\u306e\u3068\u3057\u3001\u5404\u56e0\u5b50\u30ce\u30fc\u30c9\u306e\u56e0\u5b50f(x1,x2)\u306f\u3001x1==x2\u306e\u3068\u304d0.8\u3001\u305d\u3046\u3067\u306a\u3044\u3068\u304d0.1\u3068\u3057\u3066\u3044\u307e\u3059\u3002\n\u307e\u305f\u3001\u5909\u6570\u30ce\u30fc\u30c9x1\u306b\u50241\u3092\u89b3\u6e2c\u3057\u305f\u3068\u304d\u3001\u304a\u3088\u3073\u5909\u6570\u30ce\u30fc\u30c9x2\u306b\u50241\u3092\u89b3\u6e2c\u3057\u305f\u3068\u304d\u306e\u5468\u8fba\u5206\u5e03\u3082\u6c42\u3081\u307e\u3059\u3002\n\nlibrary(igraph)\nframe()\nset.seed(0)\npar(mfrow=c(3, 3))\npar(mar=c(2, 2, 1, 0))\npar(mgp=c(1, 0, 0))\nK <- 3\nN <- 4\nROOT <- 3\ng <- graph(c(1, N+1, N+1, 2, 4, N+2, N+2, 2, 2, N+3, N+3, 3), directed=F)\nV(g)$size <- 40\nV(g)$label.cex <- 1.5\nV(g)$shape <- \"circle\"\nV(g)$shape[(N+1):(N+3)] <- \"square\"\n\npotential1 <- function(n, xparent, xchild) {\n    # \u56e0\u6570\u30ce\u30fc\u30c9n\u306e\u30dd\u30c6\u30f3\u30b7\u30e3\u30eb\u95a2\u6570\n    #   xparent:\u4e0a\u5c64\u5909\u6570\u30ce\u30fc\u30c9\n    #   xchild:\u4e0b\u5c64\u5909\u6570\u30ce\u30fc\u30c9\n\n    p <- ifelse(xparent == xchild, 0.8, 0.1)\n}\npotential2 <- function(n, xparent, xchild) {\n\n    p <- potential1(n, xparent, xchild)\n    # \u5909\u6570\u30ce\u30fc\u30c91\u306b1\u3092\u89b3\u6e2c\n    OBSERVED <- 1\n    if (n == 5) {\n        p <- p * ifelse(xchild == OBSERVED, 1, 0)\n    }\n    p\n}\npotential3 <- function(n, xparent, xchild) {\n\n    p <- potential1(n, xparent, xchild)\n    # \u5909\u6570\u30ce\u30fc\u30c92\u306b1\u3092\u89b3\u6e2c\n    OBSERVED <- 1\n    if (n == 5 || n == 6) {\n        p <- p * ifelse(xparent == OBSERVED, 1, 0)\n    } else if (n == 7) {\n        p <- p * ifelse(xchild == OBSERVED, 1, 0)\n    }\n    p\n}\n\ndoplot.joint <- function(potential) {\n\n    # \u540c\u6642\u5206\u5e03\u3092\u6c42\u3081\u308b\n    d <- data.frame()\n    for (i in 0:(K^N - 1)) {  # O(K^N)\n        total.potential <- 1\n        xs <- c()\n        xs <- c(xs, (i) %% K)\n        for (n in 1:(N-1)) {\n            xn1 <- (i %/% K ^ (n - 1)) %% K\n            xn2 <- (i %/% K ^ n) %% K\n            xs <- c(xs, xn2)\n        }\n        total.potential <- (potential(5, xs[2], xs[1]) * potential(6, xs[2], xs[4]) * potential(7, xs[3], xs[2]))\n        d <- rbind(d, c(xs, total.potential))\n    }\n    names(d) <- c(paste0(\"x\", 1:N), \"p\")\n    cat(\"p(x)\\n\");print(rbind(head(d),tail(d)))\n\n    # \u540c\u6642\u5206\u5e03\u306e\u548c\u306b\u3088\u308a\u5468\u8fba\u5206\u5e03\u3092\u6c42\u3081\u308b\n    ps <- matrix(nrow=N, ncol=K)\n    rownames(ps) <- 1:N\n    colnames(ps) <- 0:(K-1)\n    z <- sum(d$p)\n    for (n in 1:N) {\n        for (xn in 0:(K-1)) {\n            ps[n, xn + 1] <- sum(d[d[, n] == xn, ]$p) / z\n        }\n    }\n    cat(\"p(xn)\\n\");print(ps)\n    barplot(t(ps), legend=0:(K-1), xlab=\"xn\", ylab=\"p(xn)\")\n    title(\"sum of joint\")\n}\n\ndoplot.message <- function(potential) {\n\n    mu <- as.data.frame(matrix(c(-1, -1, rep(NA, K)), ncol=2 + K))\n    names(mu) <- c(\"from\", \"to\", 0:(K-1))\n\n    mufxUp <- function(from, to) {\n        # \u4e0b\u5c64\u304b\u3089\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6c42\u3081\u3001\u305d\u308c\u3092\u57fa\u306b\u3001\u56e0\u5b50\u30ce\u30fc\u30c9from\u304b\u3089\u5909\u6570\u30ce\u30fc\u30c9to\u3078\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6c42\u3081\u308b\n\n        # \u4e0b\u5c64\u304b\u3089\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u5148\u306b\u6c42\u3081\u308b\n        children <- neighbors(g, from)\n        for (child in children) {\n            if (child != to) {\n                muxfUp(child, from)\n            }\n        }\n        # to\u4ee5\u5916\u304b\u3089\u306e\u30e1\u30c3\u30bb\u30fc\u30b8(\u306e\u7a4d)\u306b\u30dd\u30c6\u30f3\u30b7\u30e3\u30eb\u3092\u639b\u3051\u305f\u3082\u306e\u306e\u3001to\u4ee5\u5916\u306e\u78ba\u7387\u5909\u6570\u5024\u306b\u95a2\u3059\u308b\u548c\u3092\u6c42\u3081\u308b\n        p <- rep(NA, K)\n        for (x in 0:(K-1)) {  # O(K^\u96a3\u63a5\u30ce\u30fc\u30c9\u6570)\n            m <- as.matrix(mu[mu$from == children[children != to] & mu$to == from, c(-1, -2)])\n            p[x + 1] <- sum(potential(from, x, 0:(K-1)) * m)\n        }\n        mu <<- rbind(mu, c(from, to, p))\n        p\n    }\n    muxfUp <- function(from, to) {\n        # \u4e0b\u5c64\u304b\u3089\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6c42\u3081\u3001\u305d\u308c\u3092\u57fa\u306b\u3001\u5909\u6570\u30ce\u30fc\u30c9from\u304b\u3089\u56e0\u5b50\u30ce\u30fc\u30c9to\u3078\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6c42\u3081\u308b\n\n        # to\u4ee5\u5916\u306e\u30e1\u30c3\u30bb\u30fc\u30b8(\u306e\u7a4d)\u3092\u6c42\u3081\u308b\n        p <- rep(1, K)\n        for (child in neighbors(g, from)) {\n            if (child != to) {\n                p <- p * mufxUp(child, from)\n            }\n        }\n        mu <<- rbind(mu, c(from, to, p))\n        p\n    }\n    mufxDown <- function(from, to) {\n        # \u56e0\u5b50\u30ce\u30fc\u30c9from\u304b\u3089\u5909\u6570\u30ce\u30fc\u30c9to\u3078\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6c42\u3081\u3001\u305d\u308c\u3092\u57fa\u306b\u4e0b\u5c64\u3078\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3082\u6c42\u3081\u308b\n\n        # to\u4ee5\u5916\u304b\u3089\u306e\u30e1\u30c3\u30bb\u30fc\u30b8(\u306e\u7a4d)\u306b\u30dd\u30c6\u30f3\u30b7\u30e3\u30eb\u3092\u639b\u3051\u305f\u3082\u306e\u306e\u3001to\u4ee5\u5916\u306e\u78ba\u7387\u5909\u6570\u5024\u306b\u95a2\u3059\u308b\u548c\u3092\u6c42\u3081\u308b\n        children <- neighbors(g, from)\n        p <- rep(NA, K)\n        for (x in 0:(K-1)) {  # O(K^\u96a3\u63a5\u30ce\u30fc\u30c9\u6570)\n            m <- as.matrix(mu[mu$from == children[children != to] & mu$to == from, c(-1, -2)])\n            p[x + 1] <- sum(potential(from, 0:(K-1), x) * m)\n        }\n        mu <<- rbind(mu, c(from, to, p))\n        # \u4e0b\u5c64\u3078\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6c42\u3081\u308b\n        for (child in neighbors(g, to)) {\n            if (child != from) {\n                muxfDown(to, child)\n            }\n        }\n        p\n    }\n    muxfDown <- function(from, to) {\n        # \u5909\u6570\u30ce\u30fc\u30c9from\u304b\u3089\u56e0\u5b50\u30ce\u30fc\u30c9to\u3078\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6c42\u3081\u3001\u305d\u308c\u3092\u57fa\u306b\u4e0b\u5c64\u3078\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3082\u6c42\u3081\u308b\n\n        # to\u4ee5\u5916\u306e\u30e1\u30c3\u30bb\u30fc\u30b8(\u306e\u7a4d)\u3092\u6c42\u3081\u308b\n        p <- rep(1, K)\n        for (child in neighbors(g, from)) {\n            if (child != to) {\n                p <- p * as.matrix(mu[mu$from == child & mu$to == from, c(-1, -2)])\n            }\n        }\n        mu <<- rbind(mu, c(from, to, p))\n        # \u4e0b\u5c64\u3078\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6c42\u3081\u308b\n        for (child in neighbors(g, to)) {\n            if (child != from) {\n                mufxDown(to, child)\n            }\n        }\n        p\n    }\n\n    mufxUp(neighbors(g, ROOT)[1], ROOT)\n    muxfDown(ROOT, neighbors(g, ROOT)[1])\n    cat(\"mu\\n\");print(mu)\n    ps <- matrix(nrow=N, ncol=K)\n    rownames(ps) <- 1:N\n    colnames(ps) <- 0:(K-1)\n    for (n in 1:N) {\n        p <- apply(mu[mu$to == n, c(-1, -2)], 2, prod)\n        z <- sum(p)\n        ps[n, ] <- p / z\n    }\n    barplot(t(ps), legend=0:(K-1), xlab=\"xn\", ylab=\"p(xn)\")\n    title(\"message passing\")\n}\n\nV(g)$color=\"white\"\nplot(g, layout=layout.reingold.tilford(g, root=ROOT))\ndoplot.joint(potential1)\ndoplot.message(potential1)\n\nV(g)$color=\"white\"\nV(g)$color[1]=\"gray\"\nplot(g, layout=layout.reingold.tilford(g, root=ROOT))\ndoplot.joint(potential2)\ndoplot.message(potential2)\n\nV(g)$color=\"white\"\nV(g)$color[2]=\"gray\"\nplot(g, layout=layout.reingold.tilford(g, root=ROOT))\ndoplot.joint(potential3)\ndoplot.message(potential3)\n\nPRML\u56f38.51\u306e\u6728\u69cb\u9020\u56e0\u5b50\u30b0\u30e9\u30d5\u306b\u3064\u3044\u3066\u3001\u7a4d\u548c\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\uff08sum-product\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\uff09\u306b\u3088\u308a\u3001\u5404\u5909\u6570\u30ce\u30fc\u30c9xn\u306e\u5468\u8fba\u5206\u5e03p(xn)\u3092\u6c42\u3081\u307e\u3059\u3002\n\n\u307e\u305a\u3001\u7d20\u6734\u306b\u5f0f8.61\u306e\u901a\u308a\u3001x\u304c\u53d6\u308a\u5f97\u308b\u72b6\u614b\u5168\u3066\u306e\u5834\u5408\u306b\u3064\u3044\u3066\u540c\u6642\u5206\u5e03\u3092\u6c42\u3081\u3066\u3001\u305d\u308c\u3089\u306e\u5408\u8a08\u306b\u3088\u308a\u5468\u8fba\u5206\u5e03\u3092\u6c42\u3081\u307e\u3059\u3002(\u306a\u304a\u3001\u3053\u306e\u5b9f\u88c5\u3067\u306f\u30b0\u30e9\u30d5\u3092\u89e3\u6790\u3057\u3066\u3044\u308b\u308f\u3051\u3067\u306f\u306a\u304f\u3001\u4eca\u56de\u306e\u4f8b\u306b\u5408\u308f\u305b\u3066\u56e0\u5b50\u306e\u7a4d\u3092\u6c7a\u3081\u3046\u3061\u3067\u8a08\u7b97\u3057\u3066\u3044\u307e\u3059\u3002)\n\n\u4e00\u65b9\u3001\u7a4d\u548c\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3092\u7528\u3044\u3066\u3001\u6728\u306e\u8449\u304b\u3089\u6839\u65b9\u5411\u3068\u3001\u6839\u304b\u3089\u8449\u65b9\u5411\u3078\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u30d1\u30c3\u30b7\u30f3\u30b0\u306b\u3088\u3063\u3066\u5168\u3066\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6c42\u3081\u3001\u5f0f8.63\u306e\u901a\u308a\u30e1\u30c3\u30bb\u30fc\u30b8\u306e\u7a4d\u3068\u3057\u3066\u3001\u540c\u3058\u7d50\u679c\u304c\u5f97\u3089\u308c\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\u306a\u304a\u3001\u5404\u5909\u6570\u30ce\u30fc\u30c9xn\u306f3\u500b\u306e\u72b6\u614b\u3092\u3068\u308b\u3082\u306e\u3068\u3057\u3001\u5404\u56e0\u5b50\u30ce\u30fc\u30c9\u306e\u56e0\u5b50f(x1,x2)\u306f\u3001x1==x2\u306e\u3068\u304d0.8\u3001\u305d\u3046\u3067\u306a\u3044\u3068\u304d0.1\u3068\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u307e\u305f\u3001\u5909\u6570\u30ce\u30fc\u30c9x1\u306b\u50241\u3092\u89b3\u6e2c\u3057\u305f\u3068\u304d\u3001\u304a\u3088\u3073\u5909\u6570\u30ce\u30fc\u30c9x2\u306b\u50241\u3092\u89b3\u6e2c\u3057\u305f\u3068\u304d\u306e\u5468\u8fba\u5206\u5e03\u3082\u6c42\u3081\u307e\u3059\u3002\n\n![](https://dl.dropbox.com/sh/cwfemibvr7gk4cy/n_JVOvliVR/19.FactorGraphSumProduct.png)\n\n```r\nlibrary(igraph)\nframe()\nset.seed(0)\npar(mfrow=c(3, 3))\npar(mar=c(2, 2, 1, 0))\npar(mgp=c(1, 0, 0))\nK <- 3\nN <- 4\nROOT <- 3\ng <- graph(c(1, N+1, N+1, 2, 4, N+2, N+2, 2, 2, N+3, N+3, 3), directed=F)\nV(g)$size <- 40\nV(g)$label.cex <- 1.5\nV(g)$shape <- \"circle\"\nV(g)$shape[(N+1):(N+3)] <- \"square\"\n\npotential1 <- function(n, xparent, xchild) {\n\t# \u56e0\u6570\u30ce\u30fc\u30c9n\u306e\u30dd\u30c6\u30f3\u30b7\u30e3\u30eb\u95a2\u6570\n\t#\txparent:\u4e0a\u5c64\u5909\u6570\u30ce\u30fc\u30c9\n\t#\txchild:\u4e0b\u5c64\u5909\u6570\u30ce\u30fc\u30c9\n\t\n\tp <- ifelse(xparent == xchild, 0.8, 0.1)\n}\npotential2 <- function(n, xparent, xchild) {\n\t\n\tp <- potential1(n, xparent, xchild)\n\t# \u5909\u6570\u30ce\u30fc\u30c91\u306b1\u3092\u89b3\u6e2c\n\tOBSERVED <- 1\n\tif (n == 5) {\n\t\tp <- p * ifelse(xchild == OBSERVED, 1, 0)\n\t}\n\tp\n}\npotential3 <- function(n, xparent, xchild) {\n\t\n\tp <- potential1(n, xparent, xchild)\n\t# \u5909\u6570\u30ce\u30fc\u30c92\u306b1\u3092\u89b3\u6e2c\n\tOBSERVED <- 1\n\tif (n == 5 || n == 6) {\n\t\tp <- p * ifelse(xparent == OBSERVED, 1, 0)\n\t} else if (n == 7) {\n\t\tp <- p * ifelse(xchild == OBSERVED, 1, 0)\n\t}\n\tp\n}\n\ndoplot.joint <- function(potential) {\n\t\n\t# \u540c\u6642\u5206\u5e03\u3092\u6c42\u3081\u308b\n\td <- data.frame()\n\tfor (i in 0:(K^N - 1)) {  # O(K^N)\n\t\ttotal.potential <- 1\n\t\txs <- c()\n\t\txs <- c(xs, (i) %% K)\n\t\tfor (n in 1:(N-1)) {\n\t\t\txn1 <- (i %/% K ^ (n - 1)) %% K\n\t\t\txn2 <- (i %/% K ^ n) %% K\n\t\t\txs <- c(xs, xn2)\n\t\t}\n\t\ttotal.potential <- (potential(5, xs[2], xs[1]) * potential(6, xs[2], xs[4]) * potential(7, xs[3], xs[2]))\n\t\td <- rbind(d, c(xs, total.potential))\n\t}\n\tnames(d) <- c(paste0(\"x\", 1:N), \"p\")\n\tcat(\"p(x)\\n\");print(rbind(head(d),tail(d)))\n\n\t# \u540c\u6642\u5206\u5e03\u306e\u548c\u306b\u3088\u308a\u5468\u8fba\u5206\u5e03\u3092\u6c42\u3081\u308b\n\tps <- matrix(nrow=N, ncol=K)\n\trownames(ps) <- 1:N\n\tcolnames(ps) <- 0:(K-1)\n\tz <- sum(d$p)\n\tfor (n in 1:N) {\n\t\tfor (xn in 0:(K-1)) {\n\t\t\tps[n, xn + 1] <- sum(d[d[, n] == xn, ]$p) / z\n\t\t}\n\t}\n\tcat(\"p(xn)\\n\");print(ps)\n\tbarplot(t(ps), legend=0:(K-1), xlab=\"xn\", ylab=\"p(xn)\")\n\ttitle(\"sum of joint\")\n}\n\ndoplot.message <- function(potential) {\n\t\n\tmu <- as.data.frame(matrix(c(-1, -1, rep(NA, K)), ncol=2 + K))\n\tnames(mu) <- c(\"from\", \"to\", 0:(K-1))\n\n\tmufxUp <- function(from, to) {\n\t\t# \u4e0b\u5c64\u304b\u3089\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6c42\u3081\u3001\u305d\u308c\u3092\u57fa\u306b\u3001\u56e0\u5b50\u30ce\u30fc\u30c9from\u304b\u3089\u5909\u6570\u30ce\u30fc\u30c9to\u3078\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6c42\u3081\u308b\n\t\t\n\t\t# \u4e0b\u5c64\u304b\u3089\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u5148\u306b\u6c42\u3081\u308b\n\t\tchildren <- neighbors(g, from)\n\t\tfor (child in children) {\n\t\t\tif (child != to) {\n\t\t\t\tmuxfUp(child, from)\n\t\t\t}\n\t\t}\n\t\t# to\u4ee5\u5916\u304b\u3089\u306e\u30e1\u30c3\u30bb\u30fc\u30b8(\u306e\u7a4d)\u306b\u30dd\u30c6\u30f3\u30b7\u30e3\u30eb\u3092\u639b\u3051\u305f\u3082\u306e\u306e\u3001to\u4ee5\u5916\u306e\u78ba\u7387\u5909\u6570\u5024\u306b\u95a2\u3059\u308b\u548c\u3092\u6c42\u3081\u308b\n\t\tp <- rep(NA, K)\n\t\tfor (x in 0:(K-1)) {  # O(K^\u96a3\u63a5\u30ce\u30fc\u30c9\u6570)\n\t\t\tm <- as.matrix(mu[mu$from == children[children != to] & mu$to == from, c(-1, -2)])\n\t\t\tp[x + 1] <- sum(potential(from, x, 0:(K-1)) * m)\n\t\t}\n\t\tmu <<- rbind(mu, c(from, to, p))\n\t\tp\n\t}\n\tmuxfUp <- function(from, to) {\n\t\t# \u4e0b\u5c64\u304b\u3089\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6c42\u3081\u3001\u305d\u308c\u3092\u57fa\u306b\u3001\u5909\u6570\u30ce\u30fc\u30c9from\u304b\u3089\u56e0\u5b50\u30ce\u30fc\u30c9to\u3078\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6c42\u3081\u308b\n\t\t\n\t\t# to\u4ee5\u5916\u306e\u30e1\u30c3\u30bb\u30fc\u30b8(\u306e\u7a4d)\u3092\u6c42\u3081\u308b\n\t\tp <- rep(1, K)\n\t\tfor (child in neighbors(g, from)) {\n\t\t\tif (child != to) {\n\t\t\t\tp <- p * mufxUp(child, from)\n\t\t\t}\n\t\t}\n\t\tmu <<- rbind(mu, c(from, to, p))\n\t\tp\n\t}\n\tmufxDown <- function(from, to) {\n\t\t# \u56e0\u5b50\u30ce\u30fc\u30c9from\u304b\u3089\u5909\u6570\u30ce\u30fc\u30c9to\u3078\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6c42\u3081\u3001\u305d\u308c\u3092\u57fa\u306b\u4e0b\u5c64\u3078\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3082\u6c42\u3081\u308b\n\t\t\n\t\t# to\u4ee5\u5916\u304b\u3089\u306e\u30e1\u30c3\u30bb\u30fc\u30b8(\u306e\u7a4d)\u306b\u30dd\u30c6\u30f3\u30b7\u30e3\u30eb\u3092\u639b\u3051\u305f\u3082\u306e\u306e\u3001to\u4ee5\u5916\u306e\u78ba\u7387\u5909\u6570\u5024\u306b\u95a2\u3059\u308b\u548c\u3092\u6c42\u3081\u308b\n\t\tchildren <- neighbors(g, from)\n\t\tp <- rep(NA, K)\n\t\tfor (x in 0:(K-1)) {  # O(K^\u96a3\u63a5\u30ce\u30fc\u30c9\u6570)\n\t\t\tm <- as.matrix(mu[mu$from == children[children != to] & mu$to == from, c(-1, -2)])\n\t\t\tp[x + 1] <- sum(potential(from, 0:(K-1), x) * m)\n\t\t}\n\t\tmu <<- rbind(mu, c(from, to, p))\n\t\t# \u4e0b\u5c64\u3078\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6c42\u3081\u308b\n\t\tfor (child in neighbors(g, to)) {\n\t\t\tif (child != from) {\n\t\t\t\tmuxfDown(to, child)\n\t\t\t}\n\t\t}\n\t\tp\n\t}\n\tmuxfDown <- function(from, to) {\n\t\t# \u5909\u6570\u30ce\u30fc\u30c9from\u304b\u3089\u56e0\u5b50\u30ce\u30fc\u30c9to\u3078\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6c42\u3081\u3001\u305d\u308c\u3092\u57fa\u306b\u4e0b\u5c64\u3078\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3082\u6c42\u3081\u308b\n\t\t\n\t\t# to\u4ee5\u5916\u306e\u30e1\u30c3\u30bb\u30fc\u30b8(\u306e\u7a4d)\u3092\u6c42\u3081\u308b\n\t\tp <- rep(1, K)\n\t\tfor (child in neighbors(g, from)) {\n\t\t\tif (child != to) {\n\t\t\t\tp <- p * as.matrix(mu[mu$from == child & mu$to == from, c(-1, -2)])\n\t\t\t}\n\t\t}\n\t\tmu <<- rbind(mu, c(from, to, p))\n\t\t# \u4e0b\u5c64\u3078\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6c42\u3081\u308b\n\t\tfor (child in neighbors(g, to)) {\n\t\t\tif (child != from) {\n\t\t\t\tmufxDown(to, child)\n\t\t\t}\n\t\t}\n\t\tp\n\t}\n\t\n\tmufxUp(neighbors(g, ROOT)[1], ROOT)\n\tmuxfDown(ROOT, neighbors(g, ROOT)[1])\n\tcat(\"mu\\n\");print(mu)\n\tps <- matrix(nrow=N, ncol=K)\n\trownames(ps) <- 1:N\n\tcolnames(ps) <- 0:(K-1)\n\tfor (n in 1:N) {\n\t\tp <- apply(mu[mu$to == n, c(-1, -2)], 2, prod)\n\t\tz <- sum(p)\n\t\tps[n, ] <- p / z\n\t}\n\tbarplot(t(ps), legend=0:(K-1), xlab=\"xn\", ylab=\"p(xn)\")\n\ttitle(\"message passing\")\n}\n\nV(g)$color=\"white\"\nplot(g, layout=layout.reingold.tilford(g, root=ROOT))\ndoplot.joint(potential1)\ndoplot.message(potential1)\n\nV(g)$color=\"white\"\nV(g)$color[1]=\"gray\"\nplot(g, layout=layout.reingold.tilford(g, root=ROOT))\ndoplot.joint(potential2)\ndoplot.message(potential2)\n\nV(g)$color=\"white\"\nV(g)$color[2]=\"gray\"\nplot(g, layout=layout.reingold.tilford(g, root=ROOT))\ndoplot.joint(potential3)\ndoplot.message(potential3)\n```\n"}