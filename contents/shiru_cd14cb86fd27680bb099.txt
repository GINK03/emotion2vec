{"context": "HAProxy\u304c1.6.6\u306b\u306a\u3063\u3066\u52d5\u7684\u540d\u524d\u89e3\u6c7a\u304c\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u305f\u3002\nRDS\u3067HAProxy\u3092\u4f7f\u3046\u5834\u5408\u30011.5\u4ee5\u524d\u3067\u306fMulti-AZ\u30d5\u30a7\u30a4\u30eb\u30aa\u30fc\u30d0\u767a\u751f\u6642\u3084\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u518d\u4f5c\u6210\u306b\u306fHAProxy\u3092\u518d\u8d77\u52d5\u3059\u308b\u4f5c\u696d\u304c\u5fc5\u8981\u3060\u3063\u305f\u3002\n1.6.6\u306f\u52d5\u7684\u540d\u524d\u89e3\u6c7a\u304c\u51fa\u6765\u308b\u306e\u3067\u305d\u3053\u306b\u61f8\u5ff5\u3059\u308b\u5fc5\u8981\u304c\u7121\u304f\u306a\u308b\u3002\n20160711\u73fe\u5728\u306eAmazonLinux\u306e\u6a19\u6e96yum\u30ea\u30dd\u30b8\u30c8\u30ea\u3067\u306f1.5.2\u307e\u3067\u3057\u304b\u516c\u958b\u3055\u308c\u3066\u3044\u306a\u3044\u3002\nFedora24\u3067\u306fRPM\u304c\u516c\u958b\u3055\u308c\u3066\u308b\u3002\nhttps://www.rpmfind.net/linux/RPM/fedora/updates/24/x86_64/h/haproxy-1.6.6-2.fc24.x86_64.html\nAmazonLinux\u306eRPM\u3068Fedora24\u306eRPM\u3092\u30de\u30fc\u30b8\u3057\u3066\u30d3\u30eb\u30c9\u3059\u308b\u306e\u306b\u6210\u529f\u3057\u305f\u306e\u3067\u624b\u9806\u3092\u6b8b\u3059\u3002\n\u306a\u304a\u3001HAProxy 1.6\u7cfb\u304b\u3089\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u3066\u3044\u308blua\u306b\u306f\u975e\u5bfe\u5fdc\u3002 AmazonLinux\u306erpm/yum\u306flua 5.1\u306b\u4f9d\u5b58\u3057\u3066\u3044\u308b\u304c\nHAProxy 1.6\u7cfb\u3067lua\u3092\u5229\u7528\u3059\u308b\u5834\u5408\u3001lua 5.3\u304c\u5fc5\u8981\u306b\u306a\u308a\u82e6\u3057\u3081\u3089\u308c\u308b\u672a\u6765\u3057\u304b\u898b\u3048\u306a\u3044\u3002\n\nRPM\u30d3\u30eb\u30c9\u74b0\u5883\u306e\u7528\u610f\nrpmbuild\u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u3063\u3066rpm\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n\u30d3\u30eb\u30c9\u74b0\u5883\u3092\u4f7f\u3044\u6368\u3066\u308b\u5834\u5408\u306f\u6c17\u306b\u3059\u308b\u5fc5\u8981\u306f\u7121\u3044\u304c\n\u30b7\u30b9\u30c6\u30e0\u306b\u5f71\u97ff\u3092\u51fa\u3055\u306a\u3044\u305f\u3081\u306broot\u4ee5\u5916\u306e\u30e6\u30fc\u30b6\u3067\u30d3\u30eb\u30c9\u3059\u308b\u306e\u304c\u63a8\u5968\u3055\u308c\u3066\u308b\u3002\nrpmbuilder \u3068\u3044\u3046\u3088\u3046\u306a\u9069\u5f53\u306a\u30e6\u30fc\u30b6\u3092\u4f5c\u3063\u3066\u304a\u304f\u306e\u304c\u671b\u307e\u3057\u3044\u3002\n# yum -y groupinstall \"Development tools\"\n# yum -y install rpmdevtools\n# useradd -s /sbin/nologin mockbuild\n# useradd rpmbuilder\n# su - rpmbuilder\n$ rpmdev-setuptree\n$ exit\n\n\nHAProxy\u306e\u30bd\u30fc\u30b9\u3092\u96c6\u3081\u308b\n\nhaproxy-1.6.6-2.fc24.src.rpm\nrpmfind.net\u306b\u3066\u63d0\u4f9b\u3055\u308c\u3066\u3044\u308bFedora24\u306e\u30c6\u30b9\u30c8\u30ea\u30dd\u30b8\u30c8\u30ea\u304b\u3089201607\u6642\u70b9\u3067\u306e\u6700\u65b0\u7248\u3092\u53d6\u5f97\n# cd ~rpmbuilder\n# wget http://fr2.rpmfind.net/linux/fedora/linux/updates/24/SRPMS/h/haproxy-1.6.6-2.fc24.src.rpm\n# chmod a+r haproxy-1.6.6-2.fc24.src.rpm\n\n\nhaproxy-1.5.2-2.5.amzn1.src.rpm\nAmazonLinux\u3067\u63d0\u4f9b\u3055\u308c\u3066\u3044\u308bhaproxy-1.5.2\u306esrpm\u3082\u53d6\u5f97\u3059\u308b\nget_reference_source\u3067\u306f\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6e08\u307f\u30d1\u30c3\u30b1\u30fc\u30b8\u3057\u304b\u30bd\u30fc\u30b9\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u51fa\u6765\u306a\u3044\u305f\u3081\n# yum install haproxy-1.5.2-2.5.amzn1.x86_64\n# get_reference_source -p haproxy-1.5.2-2.5.amzn1.x86_64\n\nRequested package: haproxy-1.5.2-2.5.amzn1\nFound package from local RPM database: haproxy-1.5.2-2.5.amzn1.x86_64\nCorresponding source RPM to found package : haproxy-1.5.2-2.5.amzn1.src.rpm\n\nAre these parameters correct? Please type 'yes' to continue: yes\n\n\nyes \u3068\u5165\u529b\u3059\u308b\u3068/usr/src/srpm/debug/haproxy-1.5.2-2.5.amzn1.src.rpm \u306bSRPM\u304c\u4fdd\u5b58\u3055\u308c\u308b\n# mv /usr/src/srpm/debug/haproxy-1.5.2-2.5.amzn1.src.rpm ~rpmbuilder/\n# chmod a+r haproxy-1.5.2-2.5.amzn1.src.rpm\n\n\u3042\u3068\u306fHAProxy\u3092\u30d3\u30eb\u30c9\u3059\u308b\u306e\u306b\u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u5c0e\u5165\u3059\u308b\n# yum install pcre-devel zlib-devel openssl-devel\n\n\n\u30d3\u30eb\u30c9\n# su - rpmbuilder\n$ rpm -ivh haproxy-1.5.2-2.5.amzn1.src.rpm\n$ rpm -ivh haproxy-1.6.6-2.fc24.src.rpm\n\n\nspec\u30d5\u30a1\u30a4\u30eb\u4f5c\u6210\n~/rpmbuild/SPECS/haproxy.spec \u306b\u4ee5\u4e0b\u3092\u8a18\u8f09\n%define haproxy_user    haproxy\n%define haproxy_uid     188\n%define haproxy_group   %{haproxy_user}\n%define haproxy_gid     %{haproxy_uid}\n%define haproxy_home    %{_localstatedir}/lib/haproxy\n%define haproxy_confdir %{_sysconfdir}/haproxy\n%define haproxy_datadir %{_datadir}/haproxy\n\n%global _hardened_build 1\n\nName:           haproxy\nVersion:        1.6.6\nRelease:        1%{?dist}\nSummary:        HAProxy reverse proxy for high availability environments\n\nGroup:          System Environment/Daemons\nLicense:        GPLv2+\n\nURL:            http://www.haproxy.org/\nSource0:        http://www.haproxy.org/download/1.6/src/haproxy-%{version}.tar.gz\nSource1:        %{name}.init\nSource2:        %{name}.cfg\nSource3:        %{name}.logrotate\nSource4:        %{name}.sysconfig\nSource5:        halog.1\n\nPatch0:         halog-unused-variables.patch\nPatch1:         iprange-return-type.patch\n\n#BuildRequires:  lua-devel\nBuildRequires:  pcre-devel\nBuildRequires:  zlib-devel\nBuildRequires:  openssl-devel\n\nRequires(pre): /usr/bin/getent\nRequires(pre): %{_sbindir}/groupadd\nRequires(pre): %{_sbindir}/useradd\nRequires(post): /sbin/chkconfig\nRequires(preun): /sbin/chkconfig\nRequires(preun): /sbin/service\nRequires(postun): /sbin/service\n\n%description\nHAProxy is a TCP/HTTP reverse proxy which is particularly suited for high\navailability environments. Indeed, it can:\n - route HTTP requests depending on statically assigned cookies\n - spread load among several servers while assuring server persistence\n   through the use of HTTP cookies\n - switch to backup servers in the event a main one fails\n - accept connections to special ports dedicated to service monitoring\n - stop accepting connections without breaking existing ones\n - add, modify, and delete HTTP headers in both directions\n - block requests matching particular patterns\n - report detailed status to authenticated users from a URI\n   intercepted from the application\n\n%prep\n%setup -q\n%patch0 -p0\n%patch1 -p0\n\n%build\nregparm_opts=\n%ifarch %ix86 x86_64\nregparm_opts=\"USE_REGPARM=1\"\n%endif\n\n%{__make} %{?_smp_mflags} CPU=\"generic\" TARGET=\"linux2628\" USE_OPENSSL=1 USE_PCRE=1 USE_ZLIB=1 ${regparm_opts} ADDINC=\"%{optflags}\" USE_LINUX_TPROXY=1\n\npushd contrib/halog\n%{__make} ${halog} OPTIMIZE=\"%{optflags}\"\npopd\n\npushd contrib/iprange\n%{__make} iprange OPTIMIZE=\"%{optflags}\"\npopd\n\n%install\n%{__make} install-bin DESTDIR=%{buildroot} PREFIX=%{_prefix} TARGET=\"linux2628\"\n%{__make} install-man DESTDIR=%{buildroot} PREFIX=%{_prefix}\n\n%{__install} -p -D -m 0755 %{SOURCE1} %{buildroot}%{_initrddir}/%{name}\n%{__install} -p -D -m 0644 %{SOURCE2} %{buildroot}%{haproxy_confdir}/%{name}.cfg\n%{__install} -p -D -m 0644 %{SOURCE3} %{buildroot}%{_sysconfdir}/logrotate.d/%{name}\n%{__install} -p -D -m 0644 %{SOURCE4} %{buildroot}%{_sysconfdir}/sysconfig/%{name}\n%{__install} -p -D -m 0644 %{SOURCE5} %{buildroot}%{_mandir}/man1/halog.1\n%{__install} -d -m 0755 %{buildroot}%{haproxy_home}\n%{__install} -d -m 0755 %{buildroot}%{haproxy_datadir}\n%{__install} -d -m 0755 %{buildroot}%{_bindir}\n%{__install} -p -m 0755 ./contrib/halog/halog %{buildroot}%{_bindir}/halog\n%{__install} -p -m 0755 ./contrib/iprange/iprange %{buildroot}%{_bindir}/iprange\n%{__install} -p -m 0644 ./examples/errorfiles/* %{buildroot}%{haproxy_datadir}\n\n\nfor httpfile in $(find ./examples/errorfiles/ -type f)\ndo\n    %{__install} -p -m 0644 $httpfile %{buildroot}%{haproxy_datadir}\ndone\n\n%{__rm} -rf ./examples/errorfiles/\n\nfind ./examples/* -type f ! -name \"*.cfg\" -exec %{__rm} -f \"{}\" \\;\n\nfor textfile in $(find ./ -type f -name '*.txt')\ndo\n    %{__mv} $textfile $textfile.old\n    iconv --from-code ISO8859-1 --to-code UTF-8 --output $textfile $textfile.old\n    %{__rm} -f $textfile.old\ndone\n\n%pre\n/usr/bin/getent group %{haproxy_group} >/dev/null || \\\n    %{_sbindir}/groupadd -g %{haproxy_gid} -r %{haproxy_group}\n/usr/bin/getent passwd %{haproxy_user} >/dev/null || \\\n    %{_sbindir}/useradd -u %{haproxy_uid} -g %{haproxy_group} \\\n    -d %{haproxy_home} -s /sbin/nologin -r %{haproxy_user}\nexit 0\n\n%post\n/sbin/chkconfig --add haproxy\n\n%preun\nif [ \"$1\" -eq 0 ]; then\n    /sbin/service haproxy stop >/dev/null 2>&1\n    /sbin/chkconfig --del haproxy\nfi\n\n%postun\nif [ \"$1\" -ge 1 ]; then\n    /sbin/service haproxy condrestart >/dev/null 2>&1 || :\nfi\n\n%files\n%defattr(-,root,root,-)\n%doc doc/* examples/*\n%doc CHANGELOG LICENSE README ROADMAP VERSION\n%dir %{haproxy_confdir}\n%dir %{haproxy_datadir}\n%{haproxy_datadir}/*\n%config(noreplace) %{haproxy_confdir}/%{name}.cfg\n%config(noreplace) %{_sysconfdir}/logrotate.d/%{name}\n%config(noreplace) %{_sysconfdir}/sysconfig/%{name}\n%{_initrddir}/%{name}\n%{_sbindir}/%{name}\n%{_sbindir}/%{name}-systemd-wrapper\n%{_bindir}/halog\n%{_bindir}/iprange\n%{_mandir}/man1/*\n%attr(-,%{haproxy_user},%{haproxy_group}) %dir %{haproxy_home}\n\n\n%changelog\n* Tue Jul 5 2016 Yuki Furukoshi <furukoshi@cloudpack.jp>\n- initial build @1.6.6\n\n\n\u30d3\u30eb\u30c9\n$ rpmbuild -ba rpmbuild/SPECS/haproxy.spec\n\n\u5b8c\u4e86\u3059\u308b\u3068\u4ee5\u4e0b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306brpm\u30d5\u30a1\u30a4\u30eb\u304c\u51fa\u6765\u3066\u3044\u308b\u3002\n$ tree rpmbuild/RPMS/\nrpmbuild/RPMS/\n\u2514\u2500\u2500 x86_64\n    \u251c\u2500\u2500 haproxy-1.6.6-1.amzn1.x86_64.rpm\n    \u2514\u2500\u2500 haproxy-debuginfo-1.6.6-1.amzn1.x86_64.rpm\n\n\u5f8c\u306f\u30d3\u30eb\u30c9\u51fa\u6765\u305frpm\u3092 rpm -ivh \u3067\u5165\u308c\u305f\u308a\u3001\u716e\u308b\u306a\u308a\u713c\u304f\u306a\u308a\u597d\u304d\u306b\u3059\u308c\u3070\u826f\u3044\u3002\n\n\u53c2\u8003\n\nhttps://www.rpmfind.net/linux/RPM/fedora/updates/testing/24/x86_64/h/haproxy-1.6.6-2.fc24.x86_64.html\nhttp://uorat.hatenablog.com/entry/2016/05/29/173717\nhttps://github.com/otabari/haproxy-rpmbuilder\n\n\nHAProxy\u304c1.6.6\u306b\u306a\u3063\u3066\u52d5\u7684\u540d\u524d\u89e3\u6c7a\u304c\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u305f\u3002\nRDS\u3067HAProxy\u3092\u4f7f\u3046\u5834\u5408\u30011.5\u4ee5\u524d\u3067\u306fMulti-AZ\u30d5\u30a7\u30a4\u30eb\u30aa\u30fc\u30d0\u767a\u751f\u6642\u3084\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u518d\u4f5c\u6210\u306b\u306fHAProxy\u3092\u518d\u8d77\u52d5\u3059\u308b\u4f5c\u696d\u304c\u5fc5\u8981\u3060\u3063\u305f\u3002\n1.6.6\u306f\u52d5\u7684\u540d\u524d\u89e3\u6c7a\u304c\u51fa\u6765\u308b\u306e\u3067\u305d\u3053\u306b\u61f8\u5ff5\u3059\u308b\u5fc5\u8981\u304c\u7121\u304f\u306a\u308b\u3002\n\n20160711\u73fe\u5728\u306eAmazonLinux\u306e\u6a19\u6e96yum\u30ea\u30dd\u30b8\u30c8\u30ea\u3067\u306f1.5.2\u307e\u3067\u3057\u304b\u516c\u958b\u3055\u308c\u3066\u3044\u306a\u3044\u3002\n\nFedora24\u3067\u306fRPM\u304c\u516c\u958b\u3055\u308c\u3066\u308b\u3002\nhttps://www.rpmfind.net/linux/RPM/fedora/updates/24/x86_64/h/haproxy-1.6.6-2.fc24.x86_64.html\n\nAmazonLinux\u306eRPM\u3068Fedora24\u306eRPM\u3092\u30de\u30fc\u30b8\u3057\u3066\u30d3\u30eb\u30c9\u3059\u308b\u306e\u306b\u6210\u529f\u3057\u305f\u306e\u3067\u624b\u9806\u3092\u6b8b\u3059\u3002\n\n\u306a\u304a\u3001HAProxy 1.6\u7cfb\u304b\u3089\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u3066\u3044\u308blua\u306b\u306f\u975e\u5bfe\u5fdc\u3002 AmazonLinux\u306erpm/yum\u306flua 5.1\u306b\u4f9d\u5b58\u3057\u3066\u3044\u308b\u304c\nHAProxy 1.6\u7cfb\u3067lua\u3092\u5229\u7528\u3059\u308b\u5834\u5408\u3001lua 5.3\u304c\u5fc5\u8981\u306b\u306a\u308a\u82e6\u3057\u3081\u3089\u308c\u308b\u672a\u6765\u3057\u304b\u898b\u3048\u306a\u3044\u3002\n\n\n# RPM\u30d3\u30eb\u30c9\u74b0\u5883\u306e\u7528\u610f\nrpmbuild\u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u3063\u3066rpm\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3002\n\u30d3\u30eb\u30c9\u74b0\u5883\u3092\u4f7f\u3044\u6368\u3066\u308b\u5834\u5408\u306f\u6c17\u306b\u3059\u308b\u5fc5\u8981\u306f\u7121\u3044\u304c\n\u30b7\u30b9\u30c6\u30e0\u306b\u5f71\u97ff\u3092\u51fa\u3055\u306a\u3044\u305f\u3081\u306broot\u4ee5\u5916\u306e\u30e6\u30fc\u30b6\u3067\u30d3\u30eb\u30c9\u3059\u308b\u306e\u304c\u63a8\u5968\u3055\u308c\u3066\u308b\u3002\n\n`rpmbuilder` \u3068\u3044\u3046\u3088\u3046\u306a\u9069\u5f53\u306a\u30e6\u30fc\u30b6\u3092\u4f5c\u3063\u3066\u304a\u304f\u306e\u304c\u671b\u307e\u3057\u3044\u3002\n\n```\n# yum -y groupinstall \"Development tools\"\n# yum -y install rpmdevtools\n# useradd -s /sbin/nologin mockbuild\n# useradd rpmbuilder\n# su - rpmbuilder\n$ rpmdev-setuptree\n$ exit\n```\n\n# HAProxy\u306e\u30bd\u30fc\u30b9\u3092\u96c6\u3081\u308b\n## haproxy-1.6.6-2.fc24.src.rpm\nrpmfind.net\u306b\u3066\u63d0\u4f9b\u3055\u308c\u3066\u3044\u308bFedora24\u306e\u30c6\u30b9\u30c8\u30ea\u30dd\u30b8\u30c8\u30ea\u304b\u3089201607\u6642\u70b9\u3067\u306e\u6700\u65b0\u7248\u3092\u53d6\u5f97\n\n```\n# cd ~rpmbuilder\n# wget http://fr2.rpmfind.net/linux/fedora/linux/updates/24/SRPMS/h/haproxy-1.6.6-2.fc24.src.rpm\n# chmod a+r haproxy-1.6.6-2.fc24.src.rpm\n```\n\n## haproxy-1.5.2-2.5.amzn1.src.rpm\n\nAmazonLinux\u3067\u63d0\u4f9b\u3055\u308c\u3066\u3044\u308bhaproxy-1.5.2\u306esrpm\u3082\u53d6\u5f97\u3059\u308b\nget_reference_source\u3067\u306f\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6e08\u307f\u30d1\u30c3\u30b1\u30fc\u30b8\u3057\u304b\u30bd\u30fc\u30b9\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u51fa\u6765\u306a\u3044\u305f\u3081\n\n```\n# yum install haproxy-1.5.2-2.5.amzn1.x86_64\n# get_reference_source -p haproxy-1.5.2-2.5.amzn1.x86_64\n\nRequested package: haproxy-1.5.2-2.5.amzn1\nFound package from local RPM database: haproxy-1.5.2-2.5.amzn1.x86_64\nCorresponding source RPM to found package : haproxy-1.5.2-2.5.amzn1.src.rpm\n\nAre these parameters correct? Please type 'yes' to continue: yes\n\n```\n\n`yes` \u3068\u5165\u529b\u3059\u308b\u3068`/usr/src/srpm/debug/haproxy-1.5.2-2.5.amzn1.src.rpm` \u306bSRPM\u304c\u4fdd\u5b58\u3055\u308c\u308b\n\n```\n# mv /usr/src/srpm/debug/haproxy-1.5.2-2.5.amzn1.src.rpm ~rpmbuilder/\n# chmod a+r haproxy-1.5.2-2.5.amzn1.src.rpm\n```\n\n\u3042\u3068\u306fHAProxy\u3092\u30d3\u30eb\u30c9\u3059\u308b\u306e\u306b\u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u5c0e\u5165\u3059\u308b\n\n```\n# yum install pcre-devel zlib-devel openssl-devel\n```\n\n# \u30d3\u30eb\u30c9\n```\n# su - rpmbuilder\n$ rpm -ivh haproxy-1.5.2-2.5.amzn1.src.rpm\n$ rpm -ivh haproxy-1.6.6-2.fc24.src.rpm\n```\n\n## spec\u30d5\u30a1\u30a4\u30eb\u4f5c\u6210\n~/rpmbuild/SPECS/haproxy.spec \u306b\u4ee5\u4e0b\u3092\u8a18\u8f09\n\n```\n%define haproxy_user    haproxy\n%define haproxy_uid     188\n%define haproxy_group   %{haproxy_user}\n%define haproxy_gid     %{haproxy_uid}\n%define haproxy_home    %{_localstatedir}/lib/haproxy\n%define haproxy_confdir %{_sysconfdir}/haproxy\n%define haproxy_datadir %{_datadir}/haproxy\n\n%global _hardened_build 1\n\nName:           haproxy\nVersion:        1.6.6\nRelease:        1%{?dist}\nSummary:        HAProxy reverse proxy for high availability environments\n\nGroup:          System Environment/Daemons\nLicense:        GPLv2+\n\nURL:            http://www.haproxy.org/\nSource0:        http://www.haproxy.org/download/1.6/src/haproxy-%{version}.tar.gz\nSource1:        %{name}.init\nSource2:        %{name}.cfg\nSource3:        %{name}.logrotate\nSource4:        %{name}.sysconfig\nSource5:        halog.1\n\nPatch0:         halog-unused-variables.patch\nPatch1:         iprange-return-type.patch\n\n#BuildRequires:  lua-devel\nBuildRequires:  pcre-devel\nBuildRequires:  zlib-devel\nBuildRequires:  openssl-devel\n\nRequires(pre): /usr/bin/getent\nRequires(pre): %{_sbindir}/groupadd\nRequires(pre): %{_sbindir}/useradd\nRequires(post): /sbin/chkconfig\nRequires(preun): /sbin/chkconfig\nRequires(preun): /sbin/service\nRequires(postun): /sbin/service\n\n%description\nHAProxy is a TCP/HTTP reverse proxy which is particularly suited for high\navailability environments. Indeed, it can:\n - route HTTP requests depending on statically assigned cookies\n - spread load among several servers while assuring server persistence\n   through the use of HTTP cookies\n - switch to backup servers in the event a main one fails\n - accept connections to special ports dedicated to service monitoring\n - stop accepting connections without breaking existing ones\n - add, modify, and delete HTTP headers in both directions\n - block requests matching particular patterns\n - report detailed status to authenticated users from a URI\n   intercepted from the application\n\n%prep\n%setup -q\n%patch0 -p0\n%patch1 -p0\n\n%build\nregparm_opts=\n%ifarch %ix86 x86_64\nregparm_opts=\"USE_REGPARM=1\"\n%endif\n\n%{__make} %{?_smp_mflags} CPU=\"generic\" TARGET=\"linux2628\" USE_OPENSSL=1 USE_PCRE=1 USE_ZLIB=1 ${regparm_opts} ADDINC=\"%{optflags}\" USE_LINUX_TPROXY=1\n\npushd contrib/halog\n%{__make} ${halog} OPTIMIZE=\"%{optflags}\"\npopd\n\npushd contrib/iprange\n%{__make} iprange OPTIMIZE=\"%{optflags}\"\npopd\n\n%install\n%{__make} install-bin DESTDIR=%{buildroot} PREFIX=%{_prefix} TARGET=\"linux2628\"\n%{__make} install-man DESTDIR=%{buildroot} PREFIX=%{_prefix}\n\n%{__install} -p -D -m 0755 %{SOURCE1} %{buildroot}%{_initrddir}/%{name}\n%{__install} -p -D -m 0644 %{SOURCE2} %{buildroot}%{haproxy_confdir}/%{name}.cfg\n%{__install} -p -D -m 0644 %{SOURCE3} %{buildroot}%{_sysconfdir}/logrotate.d/%{name}\n%{__install} -p -D -m 0644 %{SOURCE4} %{buildroot}%{_sysconfdir}/sysconfig/%{name}\n%{__install} -p -D -m 0644 %{SOURCE5} %{buildroot}%{_mandir}/man1/halog.1\n%{__install} -d -m 0755 %{buildroot}%{haproxy_home}\n%{__install} -d -m 0755 %{buildroot}%{haproxy_datadir}\n%{__install} -d -m 0755 %{buildroot}%{_bindir}\n%{__install} -p -m 0755 ./contrib/halog/halog %{buildroot}%{_bindir}/halog\n%{__install} -p -m 0755 ./contrib/iprange/iprange %{buildroot}%{_bindir}/iprange\n%{__install} -p -m 0644 ./examples/errorfiles/* %{buildroot}%{haproxy_datadir}\n\n\nfor httpfile in $(find ./examples/errorfiles/ -type f)\ndo\n    %{__install} -p -m 0644 $httpfile %{buildroot}%{haproxy_datadir}\ndone\n\n%{__rm} -rf ./examples/errorfiles/\n\nfind ./examples/* -type f ! -name \"*.cfg\" -exec %{__rm} -f \"{}\" \\;\n\nfor textfile in $(find ./ -type f -name '*.txt')\ndo\n    %{__mv} $textfile $textfile.old\n    iconv --from-code ISO8859-1 --to-code UTF-8 --output $textfile $textfile.old\n    %{__rm} -f $textfile.old\ndone\n\n%pre\n/usr/bin/getent group %{haproxy_group} >/dev/null || \\\n    %{_sbindir}/groupadd -g %{haproxy_gid} -r %{haproxy_group}\n/usr/bin/getent passwd %{haproxy_user} >/dev/null || \\\n    %{_sbindir}/useradd -u %{haproxy_uid} -g %{haproxy_group} \\\n    -d %{haproxy_home} -s /sbin/nologin -r %{haproxy_user}\nexit 0\n\n%post\n/sbin/chkconfig --add haproxy\n\n%preun\nif [ \"$1\" -eq 0 ]; then\n    /sbin/service haproxy stop >/dev/null 2>&1\n    /sbin/chkconfig --del haproxy\nfi\n\n%postun\nif [ \"$1\" -ge 1 ]; then\n    /sbin/service haproxy condrestart >/dev/null 2>&1 || :\nfi\n\n%files\n%defattr(-,root,root,-)\n%doc doc/* examples/*\n%doc CHANGELOG LICENSE README ROADMAP VERSION\n%dir %{haproxy_confdir}\n%dir %{haproxy_datadir}\n%{haproxy_datadir}/*\n%config(noreplace) %{haproxy_confdir}/%{name}.cfg\n%config(noreplace) %{_sysconfdir}/logrotate.d/%{name}\n%config(noreplace) %{_sysconfdir}/sysconfig/%{name}\n%{_initrddir}/%{name}\n%{_sbindir}/%{name}\n%{_sbindir}/%{name}-systemd-wrapper\n%{_bindir}/halog\n%{_bindir}/iprange\n%{_mandir}/man1/*\n%attr(-,%{haproxy_user},%{haproxy_group}) %dir %{haproxy_home}\n\n\n%changelog\n* Tue Jul 5 2016 Yuki Furukoshi <furukoshi@cloudpack.jp>\n- initial build @1.6.6\n```\n\n\n## \u30d3\u30eb\u30c9\n```\n$ rpmbuild -ba rpmbuild/SPECS/haproxy.spec\n```\n\n\u5b8c\u4e86\u3059\u308b\u3068\u4ee5\u4e0b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306brpm\u30d5\u30a1\u30a4\u30eb\u304c\u51fa\u6765\u3066\u3044\u308b\u3002\n\n```\n$ tree rpmbuild/RPMS/\nrpmbuild/RPMS/\n\u2514\u2500\u2500 x86_64\n    \u251c\u2500\u2500 haproxy-1.6.6-1.amzn1.x86_64.rpm\n    \u2514\u2500\u2500 haproxy-debuginfo-1.6.6-1.amzn1.x86_64.rpm\n```\n\n\u5f8c\u306f\u30d3\u30eb\u30c9\u51fa\u6765\u305frpm\u3092 `rpm -ivh` \u3067\u5165\u308c\u305f\u308a\u3001\u716e\u308b\u306a\u308a\u713c\u304f\u306a\u308a\u597d\u304d\u306b\u3059\u308c\u3070\u826f\u3044\u3002\n\n\n# \u53c2\u8003\n- https://www.rpmfind.net/linux/RPM/fedora/updates/testing/24/x86_64/h/haproxy-1.6.6-2.fc24.x86_64.html\n- http://uorat.hatenablog.com/entry/2016/05/29/173717\n- https://github.com/otabari/haproxy-rpmbuilder\n", "tags": ["AWS", "haproxy", "rpmbuild", "rpm", "AmazonLinux"]}