{"tags": ["Sphinx", "LaTeX", "literalinclude", "code-block"], "context": " More than 1 year has passed since last update.\n\n\u554f\u984c\u70b9\n\n1\u30da\u30fc\u30b8\u3092\u8d85\u3048\u308b\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3092 code-block \u3084 literalinclude  \u30c7\u30a3\u30ec\u30af\u30c6\u30a3\u30d6\u3067\u914d\u7f6e. \n\u3055\u3089\u306b caption \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u6307\u5b9a\u3059\u308b.\n\u3053\u308c\u3092 latexpdfja \u3067\u30d3\u30eb\u30c9\n\n\u3053\u306e\u6642\n\n\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u304c\u9069\u5207\u306b\u6539\u884c\u3055\u308c\u306a\u3044. \n\ncaption \u3092\u6307\u5b9a\u3057\u306a\u3051\u308c\u3070\u4e00\u5fdc\u554f\u984c\u306a\u3044\nsphinx 1.3.1 + python 3.4.3 + windows 10\n\n\n\u3068\u308a\u3042\u3048\u305a\u306e\u7d50\u8ad6-Sphinx\u62e1\u5f35, \u4e26\u3073\u306b\u8a2d\u5b9a\u8ffd\u52a0\ncode-block \u4e26\u3073\u306b literalincude \u306b caption \u304c\u3064\u3044\u305f\u5834\u5408, \u5168\u4f53\u3092float\u3067\u56f2\u308f\u305a, captionof(capt-of \u30d1\u30c3\u30b1\u30fc\u30b8) \u3067\u30ad\u30e3\u30d7\u30b7\u30e7\u30f3\u3092\u633f\u5165\u3059\u308b\u7528\u306b\u5909\u66f4.\n\u307e\u305f\u305d\u306e\u305f\u3081\u306b newfloat, needspace\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u5229\u7528\u3059\u308b. \u6700\u8fd1\u306eTeXLive, MikeTeX\u3067\u306f\u3053\u308c\u3089\u304c\u6a19\u6e96\u3067\u5229\u7528\u3067\u304d\u308b\u306f\u305a.\n\u30b3\u30fc\u30c9\u306f, github (https://github.com/takaakiaoki/sphinx_latexnewfloat) \u306b\u7f6e\u304d\u307e\u3057\u305f.\n\n\u30e1\u30e2\n\n\u539f\u56e0\n\u691c\u8a3c\u3057\u305f .rst \u30d5\u30a1\u30a4\u30eb\u306f\u6b21\u306e\u901a\u308a.\n################################\nIncluding long sourcecode\n################################\n\nliteralinclude without caption\n==================================\n\n.. literalinclude:: bodeplot_lpf.m\n   :language: Octave\n\nliteralinclude with caption\n===================================\n\n.. literalinclude:: bodeplot_lpf.m\n   :language: Octave\n   :caption: Caption\n\nmake pseudoxml \u3068\u3059\u308b\u3068, \u3053\u306e\u30d5\u30a1\u30a4\u30eb\u304b\u3089\u4f5c\u3089\u308c\u305f .doctree \u3092 pseudoxml \u3067\u308f\u304b\u308a\u3084\u3059\u304f\u51fa\u529b\u3059\u308b\n<!-- \u524d\u7565 -->\n<section ids=\"including-long-sourcecode\" names=\"including\\ long\\ sourcecode\">\n    <title>\n        Including long sourcecode\n    <section ids=\"literalinclude-without-caption\" names=\"literalinclude\\ without\\ caption\">\n        <title>\n            literalinclude without caption\n        <literal_block highlight_args=\"{'linenostart': 1}\" language=\"Octave\" linenos=\"False\" source=\"bodeplot_lpf.m\" xml:space=\"preserve\">\n        <!-- \u3053\u3053\u304b\u3089\u30b3\u30fc\u30c9(\u7701\u7565) -->\n<section ids=\"literalinclude-with-caption\" names=\"literalinclude\\ with\\ caption\">\n    <title>\n        <container classes=\"literal-block-wrapper\" dupnames=\"caption\" ids=\"caption\" literal_block=\"True\">\n            <caption>\n                Caption\n            <literal_block highlight_args=\"{'linenostart': 1}\" language=\"Octave\" linenos=\"False\" source=\"bodeplot_lpf.m\" xml:space=\"preserve\">\n            <!-- \u3053\u3053\u304b\u3089\u30a4\u30f3\u30af\u30eb\u30fc\u30c9\u3055\u308c\u305f\u30b3\u30fc\u30c9(\u7701\u7565) -->\n\n\u3068\u3053\u306e\u3088\u3046\u306b, :caption: \u304c\u3064\u304f\u3053\u3068\u3067 ,  \u30bf\u30b0\u304c\u8ffd\u52a0\u3055\u308c\u308b.\n\u3053\u308c\u3092\u53d7\u3051\u3066, latex\u306e\u30bd\u30fc\u30b9\u30d5\u30a1\u30a4\u30eb\u306f\n% (\u524d\u7565)\n\\chapter{Including long sourcecode}\n\\label{code:welcome-to-latex-long-literalinclude-s-documentation}\\label{code::doc}\\label{code:including-long-sourcecode}\n\n\\section{literalinclude without caption}\n\\label{code:literalinclude-without-caption}\n\\begin{Verbatim}[commandchars=\\\\\\{\\}]\n   %%% \u3053\u3053\u306b\u30a4\u30f3\u30af\u30eb\u30fc\u30c9\u3055\u308c\u305f\u30b3\u30fc\u30c9(\u7701\u7565)\n\\end{Verbatim}\n% \u6b21\u306e\u30bb\u30af\u30b7\u30e7\u30f3\n\\section{literalinclude with caption}\n\\label{code:literalinclude-with-caption}\n\\begin{literal-block}\n\\caption{Caption}\n\\begin{Verbatim}[commandchars=\\\\\\{\\}]\n   %%% \u3053\u3053\u306b\u30a4\u30f3\u30af\u30eb\u30fc\u30c9\u3055\u308c\u305f\u30b3\u30fc\u30c9(\u7701\u7565)\n\\end{Verbatim}\n\\phantomsection\\label{code:caption}\n\\end{literal-block}\n   % (\u5f8c\u7565)\n\n\u3068\u5916\u90e8\u306b literal-block \u74b0\u5883(\u3068 caption)\u304c\u8ffd\u52a0\u3055\u308c\u308b. \u3053\u306e literal-block \u74b0\u5883\u306f\nsphinx.sty \u306b\u304a\u3044\u3066,\n% Define literal-block environment\n\\RequirePackage{float}\n\\floatstyle{plaintop}\n\\ifx\\thechapter\\undefined\n  \\newfloat{literal-block}{htbp}{loc}[section]\n\\else\n  \\newfloat{literal-block}{htbp}{loc}[chapter]\n\\fi\n\\floatname{literal-block}{List}\n\n\u3068 float \u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u7528\u3044\u3066\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u308b. \u3053\u306e float \u74b0\u5883\u3067\u306f\u6539\u9801\u304c\u884c\u308f\u308c\u306a\u3044.    \n\n\u3044\u3044\u52a0\u6e1b\u306a\u56de\u907f\u65b9\u6cd5\n\ncaption \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u3064\u3051\u306a\u3044\nlatex\u306e\u5834\u5408\u306b\u30b7\u30f3\u30bf\u30c3\u30af\u30b9\u30cf\u30a4\u30e9\u30a4\u30c6\u30a3\u30f3\u30b0\u3092\u884c\u308f\u306a\u3044\n\n.. only:: html\n\n   .. literalinclude:: bodeplot_lpf.m\n      :language: Octave\n      :caption: Caption\n\n.. only:: latex\n\n   .. include:: bodeplot_lpf.m\n      :literal:\n\n\n\u56de\u907f\u65b9\u6cd5, \u6539\u9020\n\nnewfloat, capt-of \u306e\u5229\u7528\n\u300cfloat\u74b0\u5883\u3067\u6539\u9801\u304c\u3067\u304d\u306a\u3044\u300d\u3068\u3044\u3046\u554f\u984c\u306b\u3064\u3044\u3066\u306f,\nhttp://tex.stackexchange.com/questions/175650/how-to-allow-page-break-inside-a-float-environment \u306b\u304a\u3044\u3066, capt-of \u4e26\u3073\u306b newfloat \u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u4f7f\u3046\u3068\u3088\u3044, \u3068\u306e\u3053\u3068.\ncapt-of, newfloat \u5171\u306b\u6700\u8fd1\u306eTeXLive\u306b\u542b\u307e\u308c\u3066\u3044\u308b\u306e\u3067, LaTeX\u306e\u74b0\u5883\u306b\u624b\u3092\u5165\u308c\u308b\u5fc5\u8981\u304c\u306a\u3044. \u672c\u6765\u306a\u3089\u3070, sphinx.sty \u3067\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u308b literal-block \u74b0\u5883\u3092\u3044\u3063\u305f\u3093\u30ea\u30bb\u30c3\u30c8\u3057, newfloat \u306e DeclareFloatingEnvironment \u3067\u518d\u5b9a\u7fa9\u3059\u308b\u65b9\u304c\u3088\u3044\u304c, \u3088\u3044\u65b9\u6cd5\u304c\u898b\u3064\u3051\u3089\u308c\u3066\u3044\u306a\u3044. \n% (\u524d\u7565)\n%\n% configure new literal-block-newfloat\n\\usepackage{newfloat}\n\\DeclareFloatingEnvironment[name={Listing}]{literal-block-newfloat}\n% copy from sphinx.sty\n\\ifx\\thechapter\\undefined\n  \\SetupFloatingEnvironment{literal-block-newfloat}{within=section,placement=h}\n\\else\n  \\SetupFloatingEnvironment{literal-block-newfloat}{within=chapter,placement=h}\n\\fi\n\\usepackage{capt-of}\n%\n% (\u4e2d\u7565)\n% \n% \u6b21\u306e\u30bb\u30af\u30b7\u30e7\u30f3\n\\section{literalinclude with caption}\n\\label{code:literalinclude-with-caption}\n\\captionof{literal-block-newfloat}{Caption}\n\\begin{Verbatim}[commandchars=\\\\\\{\\}]\n  %%% \u3053\u3053\u306b\u30a4\u30f3\u30af\u30eb\u30fc\u30c9\u3055\u308c\u305f\u30b3\u30fc\u30c9(\u7701\u7565)\n\\end{Verbatim}\n\\phantomsection\\label{code:caption}\n% \\end{literal-block}\n% (\u5f8c\u7565)\n\n\nlatex writer \u306e\u6539\u826f\n\u4e0a\u8a18\u8ffd\u52a0\u90e8\u5206\u306e \\usepackage \u5468\u8fba\u306f, conf.py \u306e latex_elements['preamble'] \u3092\u8a2d\u5b9a\u3059\u308c\u3070\u826f\u3044. \u4e00\u65b9, \u30b3\u30fc\u30c9\u53d6\u308a\u8fbc\u307f\u90e8\u5206\u306f, \n\n\\begin{literal-block} ... \\end{literal-block} \u3092\u51fa\u529b\u3057\u306a\u3044\n\\caption{ ... } \u306e\u4ee3\u308f\u308a\u306b \\captionof{literal-block-newfloat}{ ... } \u306b\u7f6e\u304d\u63db\u3048\u308b.\n\n\u3053\u306e\u90e8\u5206\u306e\u51fa\u529b\u306f, \n\nsphinx.writer.latex.LaTeXTranslator.visit_containar\nsphinx.writer.latex.LaTeXTranslator.depart_containar\n\n\u3067\u5b9f\u65bd\u3055\u308c\u308b.\n\nsphinx.writers.latex.py\ndef visit_container(self, node):\n    if node.get('literal_block'):\n        ids = ''\n        for id in self.next_literal_ids:\n            ids += self.hypertarget(id, anchor=False)\n        if node['ids']:\n            ids += self.hypertarget(node['ids'][0])\n        self.next_literal_ids.clear()\n        self.body.append('\\n\\\\begin{literal-block}\\n')\n        self.context.append(ids + '\\n\\\\end{literal-block}\\n')\n\ndef depart_container(self, node):\n    if node.get('literal_block'):\n        self.body.append(self.context.pop())\n\n\n\u3053\u308c\u3092\u898b\u308b\u3068 1. \u306f\u7c21\u5358\u306b\u51fa\u6765\u305d\u3046(\u5b9f\u969b\u3067\u304d\u305f). 2. \u306f visit_caption, depart_caption \u3067\u5171\u901a\u5316\u3055\u308c\u3066\u3044\u308b\u306e\u3067, \"visit_caption \u30ce\u30fc\u30c9\u304c visit_container \u7d4c\u7531\u3067\u547c\u3070\u308c\u305f\u5834\u5408\u306f\u51e6\u7406\u3092\u5909\u3048\u308b\" \u3053\u3068\u304c\u5fc5\u8981\u306b\u306a\u308b(in_caption \u3092\u53c2\u8003\u306b in_container_literal_block \u3092\u8ffd\u52a0).\n\n\u3044\u308d\u3044\u308d\u611f\u60f3\n\n\u306a\u3093\u304b\u304b\u3093\u3084\u3067 sphinx \u306e\u7c21\u5358\u306a\u62e1\u5f35\u304c\u66f8\u3051\u305f.\n\\captionof \u76f4\u5f8c\u306b\u6539\u9801\u3055\u308c\u308b\u3068\u30c0\u30b5\u3044\u306e\u3067, needspace \u30d1\u30c3\u30b1\u30fc\u30b8\u306b\u3088\u308a\\captionof \u3092\u5b9f\u884c\u3059\u308b\u305f\u3081\u306b\u5fc5\u8981\u306a\u30b9\u30da\u30fc\u30b9\u3092\u78ba\u8a8d\u3059\u308b\u69d8\u306b\u3057\u305f. latexnewfloat_needspaceforcaption \u30aa\u30d7\u30b7\u30e7\u30f3\u304c\u3064\u304f\u3053\u3068\u306b\n\\captionof \u76f4\u524d\u306e\u30b9\u30da\u30fc\u30b9\u304c\u72ed\u3044\u306e\u3067 \\vskip{0.5\\baselineskip} \u3092\u8ffd\u52a0. \u3053\u306e\u3042\u305f\u308a\u306f\u30a2\u30c9\u30db\u30c3\u30af\u306a\u306e\u3067\u304a\u3044\u304a\u3044\u8abf\u6574\nliteral-block-newfloat \u74b0\u5883\u521d\u671f\u5316\u3092 conf.py \u306e\u30d7\u30ea\u30a2\u30f3\u30d6\u30eb\u306b\u8a18\u8f09\u3059\u308b\u306e\u306f\u3044\u307e\u3044\u3061. writer \u304b translator \u306e\u4e2d\u306b\u5165\u308c\u308b\u306e\u304c\u59a5\u5f53. \u307e\u3060 builder translator writer \u306e\u95a2\u4fc2\u304c\u3088\u304f\u308f\u304b\u3089\u306a\u3044.\n\n# \u554f\u984c\u70b9\n\n* 1\u30da\u30fc\u30b8\u3092\u8d85\u3048\u308b\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3092 **code-block** \u3084 **literalinclude**  \u30c7\u30a3\u30ec\u30af\u30c6\u30a3\u30d6\u3067\u914d\u7f6e. \n* \u3055\u3089\u306b **caption** \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u6307\u5b9a\u3059\u308b.\n* \u3053\u308c\u3092 latexpdfja \u3067\u30d3\u30eb\u30c9\n\n\u3053\u306e\u6642\n\n* \u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u304c\u9069\u5207\u306b\u6539\u884c\u3055\u308c\u306a\u3044. \n* **caption** \u3092\u6307\u5b9a\u3057\u306a\u3051\u308c\u3070\u4e00\u5fdc\u554f\u984c\u306a\u3044\n* sphinx 1.3.1 + python 3.4.3 + windows 10\n\n# \u3068\u308a\u3042\u3048\u305a\u306e\u7d50\u8ad6-Sphinx\u62e1\u5f35, \u4e26\u3073\u306b\u8a2d\u5b9a\u8ffd\u52a0\n\ncode-block \u4e26\u3073\u306b literalincude \u306b caption \u304c\u3064\u3044\u305f\u5834\u5408, \u5168\u4f53\u3092float\u3067\u56f2\u308f\u305a, captionof(capt-of \u30d1\u30c3\u30b1\u30fc\u30b8) \u3067\u30ad\u30e3\u30d7\u30b7\u30e7\u30f3\u3092\u633f\u5165\u3059\u308b\u7528\u306b\u5909\u66f4.\n\u307e\u305f\u305d\u306e\u305f\u3081\u306b newfloat, needspace\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u5229\u7528\u3059\u308b. \u6700\u8fd1\u306eTeXLive, MikeTeX\u3067\u306f\u3053\u308c\u3089\u304c\u6a19\u6e96\u3067\u5229\u7528\u3067\u304d\u308b\u306f\u305a.\n\n\u30b3\u30fc\u30c9\u306f, github (https://github.com/takaakiaoki/sphinx_latexnewfloat) \u306b\u7f6e\u304d\u307e\u3057\u305f.\n\n# \u30e1\u30e2\n\n## \u539f\u56e0\n\n\u691c\u8a3c\u3057\u305f .rst \u30d5\u30a1\u30a4\u30eb\u306f\u6b21\u306e\u901a\u308a.\n\n```rst\n################################\nIncluding long sourcecode\n################################\n   \nliteralinclude without caption\n==================================\n\n.. literalinclude:: bodeplot_lpf.m\n   :language: Octave\n\nliteralinclude with caption\n===================================\n\n.. literalinclude:: bodeplot_lpf.m\n   :language: Octave\n   :caption: Caption\n```\n\nmake pseudoxml \u3068\u3059\u308b\u3068, \u3053\u306e\u30d5\u30a1\u30a4\u30eb\u304b\u3089\u4f5c\u3089\u308c\u305f .doctree \u3092 pseudoxml \u3067\u308f\u304b\u308a\u3084\u3059\u304f\u51fa\u529b\u3059\u308b\n\n```xml\n<!-- \u524d\u7565 -->\n<section ids=\"including-long-sourcecode\" names=\"including\\ long\\ sourcecode\">\n    <title>\n        Including long sourcecode\n    <section ids=\"literalinclude-without-caption\" names=\"literalinclude\\ without\\ caption\">\n        <title>\n            literalinclude without caption\n        <literal_block highlight_args=\"{'linenostart': 1}\" language=\"Octave\" linenos=\"False\" source=\"bodeplot_lpf.m\" xml:space=\"preserve\">\n        <!-- \u3053\u3053\u304b\u3089\u30b3\u30fc\u30c9(\u7701\u7565) -->\n<section ids=\"literalinclude-with-caption\" names=\"literalinclude\\ with\\ caption\">\n    <title>\n        <container classes=\"literal-block-wrapper\" dupnames=\"caption\" ids=\"caption\" literal_block=\"True\">\n            <caption>\n                Caption\n            <literal_block highlight_args=\"{'linenostart': 1}\" language=\"Octave\" linenos=\"False\" source=\"bodeplot_lpf.m\" xml:space=\"preserve\">\n            <!-- \u3053\u3053\u304b\u3089\u30a4\u30f3\u30af\u30eb\u30fc\u30c9\u3055\u308c\u305f\u30b3\u30fc\u30c9(\u7701\u7565) -->\n```\n\n\u3068\u3053\u306e\u3088\u3046\u306b, **\\:caption\\:** \u304c\u3064\u304f\u3053\u3068\u3067 **<container>, <caption>** \u30bf\u30b0\u304c\u8ffd\u52a0\u3055\u308c\u308b.\n\n\u3053\u308c\u3092\u53d7\u3051\u3066, latex\u306e\u30bd\u30fc\u30b9\u30d5\u30a1\u30a4\u30eb\u306f\n\n```latex\n% (\u524d\u7565)\n\\chapter{Including long sourcecode}\n\\label{code:welcome-to-latex-long-literalinclude-s-documentation}\\label{code::doc}\\label{code:including-long-sourcecode}\n\n\\section{literalinclude without caption}\n\\label{code:literalinclude-without-caption}\n\\begin{Verbatim}[commandchars=\\\\\\{\\}]\n   %%% \u3053\u3053\u306b\u30a4\u30f3\u30af\u30eb\u30fc\u30c9\u3055\u308c\u305f\u30b3\u30fc\u30c9(\u7701\u7565)\n\\end{Verbatim}\n% \u6b21\u306e\u30bb\u30af\u30b7\u30e7\u30f3\n\\section{literalinclude with caption}\n\\label{code:literalinclude-with-caption}\n\\begin{literal-block}\n\\caption{Caption}\n\\begin{Verbatim}[commandchars=\\\\\\{\\}]\n   %%% \u3053\u3053\u306b\u30a4\u30f3\u30af\u30eb\u30fc\u30c9\u3055\u308c\u305f\u30b3\u30fc\u30c9(\u7701\u7565)\n\\end{Verbatim}\n\\phantomsection\\label{code:caption}\n\\end{literal-block}\n   % (\u5f8c\u7565)\n```\n\n\u3068\u5916\u90e8\u306b literal-block \u74b0\u5883(\u3068 caption)\u304c\u8ffd\u52a0\u3055\u308c\u308b. \u3053\u306e literal-block \u74b0\u5883\u306f\nsphinx.sty \u306b\u304a\u3044\u3066,\n\n```latex\n% Define literal-block environment\n\\RequirePackage{float}\n\\floatstyle{plaintop}\n\\ifx\\thechapter\\undefined\n  \\newfloat{literal-block}{htbp}{loc}[section]\n\\else\n  \\newfloat{literal-block}{htbp}{loc}[chapter]\n\\fi\n\\floatname{literal-block}{List}\n```\n\n\u3068 float \u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u7528\u3044\u3066\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u308b. \u3053\u306e float \u74b0\u5883\u3067\u306f\u6539\u9801\u304c\u884c\u308f\u308c\u306a\u3044.    \n\n## \u3044\u3044\u52a0\u6e1b\u306a\u56de\u907f\u65b9\u6cd5\n\n1. **caption** \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u3064\u3051\u306a\u3044\n\n2. latex\u306e\u5834\u5408\u306b\u30b7\u30f3\u30bf\u30c3\u30af\u30b9\u30cf\u30a4\u30e9\u30a4\u30c6\u30a3\u30f3\u30b0\u3092\u884c\u308f\u306a\u3044\n\n```rst\n.. only:: html\n\n   .. literalinclude:: bodeplot_lpf.m\n      :language: Octave\n      :caption: Caption\n\n.. only:: latex\n\n   .. include:: bodeplot_lpf.m\n      :literal:\n```\n\n## \u56de\u907f\u65b9\u6cd5, \u6539\u9020\n\n### newfloat, capt-of \u306e\u5229\u7528\n\n\u300cfloat\u74b0\u5883\u3067\u6539\u9801\u304c\u3067\u304d\u306a\u3044\u300d\u3068\u3044\u3046\u554f\u984c\u306b\u3064\u3044\u3066\u306f,\nhttp://tex.stackexchange.com/questions/175650/how-to-allow-page-break-inside-a-float-environment \u306b\u304a\u3044\u3066, capt-of \u4e26\u3073\u306b newfloat \u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u4f7f\u3046\u3068\u3088\u3044, \u3068\u306e\u3053\u3068.\ncapt-of, newfloat \u5171\u306b\u6700\u8fd1\u306eTeXLive\u306b\u542b\u307e\u308c\u3066\u3044\u308b\u306e\u3067, LaTeX\u306e\u74b0\u5883\u306b\u624b\u3092\u5165\u308c\u308b\u5fc5\u8981\u304c\u306a\u3044. \u672c\u6765\u306a\u3089\u3070, sphinx.sty \u3067\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u308b literal-block \u74b0\u5883\u3092\u3044\u3063\u305f\u3093\u30ea\u30bb\u30c3\u30c8\u3057, newfloat \u306e DeclareFloatingEnvironment \u3067\u518d\u5b9a\u7fa9\u3059\u308b\u65b9\u304c\u3088\u3044\u304c, \u3088\u3044\u65b9\u6cd5\u304c\u898b\u3064\u3051\u3089\u308c\u3066\u3044\u306a\u3044. \n\n```latex\n% (\u524d\u7565)\n%\n% configure new literal-block-newfloat\n\\usepackage{newfloat}\n\\DeclareFloatingEnvironment[name={Listing}]{literal-block-newfloat}\n% copy from sphinx.sty\n\\ifx\\thechapter\\undefined\n  \\SetupFloatingEnvironment{literal-block-newfloat}{within=section,placement=h}\n\\else\n  \\SetupFloatingEnvironment{literal-block-newfloat}{within=chapter,placement=h}\n\\fi\n\\usepackage{capt-of}\n%\n% (\u4e2d\u7565)\n% \n% \u6b21\u306e\u30bb\u30af\u30b7\u30e7\u30f3\n\\section{literalinclude with caption}\n\\label{code:literalinclude-with-caption}\n\\captionof{literal-block-newfloat}{Caption}\n\\begin{Verbatim}[commandchars=\\\\\\{\\}]\n  %%% \u3053\u3053\u306b\u30a4\u30f3\u30af\u30eb\u30fc\u30c9\u3055\u308c\u305f\u30b3\u30fc\u30c9(\u7701\u7565)\n\\end{Verbatim}\n\\phantomsection\\label{code:caption}\n% \\end{literal-block}\n% (\u5f8c\u7565)\n```\n\n### latex writer \u306e\u6539\u826f\n\n\u4e0a\u8a18\u8ffd\u52a0\u90e8\u5206\u306e \\\\usepackage \u5468\u8fba\u306f, conf.py \u306e latex_elements['preamble'] \u3092\u8a2d\u5b9a\u3059\u308c\u3070\u826f\u3044. \u4e00\u65b9, \u30b3\u30fc\u30c9\u53d6\u308a\u8fbc\u307f\u90e8\u5206\u306f, \n\n1. \\\\begin{literal-block} ... \\\\end{literal-block} \u3092\u51fa\u529b\u3057\u306a\u3044\n2. \\\\caption{ ... } \u306e\u4ee3\u308f\u308a\u306b \\\\captionof{literal-block-newfloat}{ ... } \u306b\u7f6e\u304d\u63db\u3048\u308b.\n\n\u3053\u306e\u90e8\u5206\u306e\u51fa\u529b\u306f, \n\n* sphinx.writer.latex.LaTeXTranslator.visit_containar\n* sphinx.writer.latex.LaTeXTranslator.depart_containar\n\n\u3067\u5b9f\u65bd\u3055\u308c\u308b.\n\n```python:sphinx.writers.latex.py\ndef visit_container(self, node):\n    if node.get('literal_block'):\n        ids = ''\n        for id in self.next_literal_ids:\n            ids += self.hypertarget(id, anchor=False)\n        if node['ids']:\n            ids += self.hypertarget(node['ids'][0])\n        self.next_literal_ids.clear()\n        self.body.append('\\n\\\\begin{literal-block}\\n')\n        self.context.append(ids + '\\n\\\\end{literal-block}\\n')\n\ndef depart_container(self, node):\n    if node.get('literal_block'):\n        self.body.append(self.context.pop())\n```\n\n\u3053\u308c\u3092\u898b\u308b\u3068 1. \u306f\u7c21\u5358\u306b\u51fa\u6765\u305d\u3046(\u5b9f\u969b\u3067\u304d\u305f). 2. \u306f visit_caption, depart_caption \u3067\u5171\u901a\u5316\u3055\u308c\u3066\u3044\u308b\u306e\u3067, \"visit_caption \u30ce\u30fc\u30c9\u304c visit_container \u7d4c\u7531\u3067\u547c\u3070\u308c\u305f\u5834\u5408\u306f\u51e6\u7406\u3092\u5909\u3048\u308b\" \u3053\u3068\u304c\u5fc5\u8981\u306b\u306a\u308b(in_caption \u3092\u53c2\u8003\u306b in_container_literal_block \u3092\u8ffd\u52a0).\n\n## \u3044\u308d\u3044\u308d\u611f\u60f3\n\n* \u306a\u3093\u304b\u304b\u3093\u3084\u3067 sphinx \u306e\u7c21\u5358\u306a\u62e1\u5f35\u304c\u66f8\u3051\u305f.\n* \\captionof \u76f4\u5f8c\u306b\u6539\u9801\u3055\u308c\u308b\u3068\u30c0\u30b5\u3044\u306e\u3067, needspace \u30d1\u30c3\u30b1\u30fc\u30b8\u306b\u3088\u308a\\captionof \u3092\u5b9f\u884c\u3059\u308b\u305f\u3081\u306b\u5fc5\u8981\u306a\u30b9\u30da\u30fc\u30b9\u3092\u78ba\u8a8d\u3059\u308b\u69d8\u306b\u3057\u305f. latexnewfloat_needspaceforcaption \u30aa\u30d7\u30b7\u30e7\u30f3\u304c\u3064\u304f\u3053\u3068\u306b\n* \\captionof \u76f4\u524d\u306e\u30b9\u30da\u30fc\u30b9\u304c\u72ed\u3044\u306e\u3067 \\vskip{0.5\\baselineskip} \u3092\u8ffd\u52a0. \u3053\u306e\u3042\u305f\u308a\u306f\u30a2\u30c9\u30db\u30c3\u30af\u306a\u306e\u3067\u304a\u3044\u304a\u3044\u8abf\u6574\n* literal-block-newfloat \u74b0\u5883\u521d\u671f\u5316\u3092 conf.py \u306e\u30d7\u30ea\u30a2\u30f3\u30d6\u30eb\u306b\u8a18\u8f09\u3059\u308b\u306e\u306f\u3044\u307e\u3044\u3061. writer \u304b translator \u306e\u4e2d\u306b\u5165\u308c\u308b\u306e\u304c\u59a5\u5f53. \u307e\u3060 builder translator writer \u306e\u95a2\u4fc2\u304c\u3088\u304f\u308f\u304b\u3089\u306a\u3044.\n"}