{"context": "\n\n\u6982\u8981\n\nPi 3 booting part II: Ethernet\n\n\nYesterday, we introduced the first of two new boot modes which have now been added to the Raspberry Pi 3. Today, we introduce an even more exciting addition: network booting a Raspberry Pi with no SD card.\n\u6628\u65e5\u3001\u79c1\u305f\u3061\u306f\u30e9\u30ba\u30d9\u30ea\u30fc\u30d1\u30a43\u306b\u8ffd\u52a0\u3055\u308c\u305f2\u3064\u306e\u65b0\u3057\u3044\u30d6\u30fc\u30c8\u30e2\u30fc\u30c9\u306e\u4e00\u3064\u76ee\u3092\u7d39\u4ecb\u3057\u307e\u3057\u305f\u3002\u4eca\u65e5\u3001\u6211\u3005\u306f\u3001\u3055\u3089\u306b\u30a8\u30ad\u30b5\u30a4\u30c6\u30a3\u30f3\u30b0\u306a\u8ffd\u52a0\u6a5f\u80fd\uff1aSD\u30ab\u30fc\u30c9\u306a\u3057\u30e9\u30ba\u30d9\u30ea\u30fc\u30d1\u30a4\u3092\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30d6\u30fc\u30c8\u3000\u3092\u7d39\u4ecb\u3057\u307e\u3059\u3002\n\n\u3060\u305d\u3046\u3067\u3059\n\n\nNetwork Boot Your Raspberry Pi - \u624b\u9806\u306f\u3053\u3061\u3089\u3002\n\n\n\n\u30de\u30b8\u3067\u3001\u8d77\u52d5\u3057\u305f...\n\n\n\u74b0\u5883\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8: Raspberry Pi 3\n\u30b5\u30fc\u30d0: Raspberry Pi 2\nmicroSD 4GB 1\u679a\n2016-05-27-raspbian-jessie-lite.img\n\n\n\u624b\u9806\n\n\u307e\u305a\u306f\u901a\u5e38\u901a\u308a\u306b\u3001microSD\u306b\u3001Raspbian lite\u3092\u66f8\u304d\u8fbc\u3080.\n\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8 Raspberry Pi 3\u3067\u4f5c\u696d\n\n\u713c\u3044\u305fmicroSD\u3067\u8d77\u52d5\n\n# \u30ec\u30dd\u30b8\u30c8\u30eaDB\u66f4\u65b0, \u30d5\u30a1\u30fc\u30e0\u30a6\u30a7\u30a2\u306e\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8, config.txt\u306e\u8a2d\u5b9a, \u518d\u8d77\u52d5\nsudo apt-get update ; sudo apt-get install rpi-update -y ; sudo BRANCH=next rpi-update ; echo program_usb_boot_mode=1 | sudo tee -a /boot/config.txt ; sudo reboot\n#\n# \u518d\u8d77\u52d5\u5f8c\u3001 otp\u306e\u5024\u3092\u78ba\u8a8d\nvcgencmd otp_dump | grep 17:\n# > 17:3020000a \u3068\u306a\u3063\u3066\u3044\u308c\u3070OK\n#\n# MAC\u30a2\u30c9\u30ec\u30b9\u3092\u30e1\u30e2\u3063\u3066\u304a\u304f\u3068\u3044\u3044\u304b\u3082? (\u78ba\u8a8d\u306e\u305f\u3081)\ncat /sys/class/net/eth0/address \n#\n# \u96fb\u6e90OFF\nsudo poweroff \n\n\n\u30b5\u30fc\u30d0 Raspberry Pi 2\u3067\u4f5c\u696d\n\n\u2191\u3067\u4f7f\u3063\u305fmicroSD\u3092\u633f\u3059\u3002\n\n#> \u30af\u30e9\u30a4\u30a2\u30f3\u30c8Pi\u304c\u8d77\u52d5\u3059\u308b\u306e\u306b\u3001\u30eb\u30fc\u30c8\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u304c\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\u304c\u3001\n#> \u79c1\u305f\u3061\u306f\u30b5\u30fc\u30d0\u30fc\u4e0a\u3067\u4f55\u304b\u3092\u884c\u3046\u524d\u306b\u3001\n#> \u79c1\u305f\u3061\u306f\u305d\u306e\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u306e\u5b8c\u5168\u306a\u30b3\u30d4\u30fc\u3092\u4f5c\u6210\u3057\u3001/nfs/client1 \u3068\u547c\u3070\u308c\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u305d\u308c\u3092\u7f6e\u304f\u3064\u3082\u308a\u3067\u3059\u3002\n#\u3068\u306e\u3053\u3068\u3067\u3059.\nsudo mkdir -p /nfs/client1\nsudo apt-get install rsync\ntime sudo rsync -xa --progress --exclude /nfs / /nfs/client1\n#\n# time\u3067\u8a08\u6e2c\n#<<< sd\u30ab\u30fc\u30c9\u305d\u306e\uff11(\u307e\u3041\u307e\u3041)\n#real   6m52.395s\n#user   0m21.890s\n#sys    0m23.320s\n#<<< sd\u30ab\u30fc\u30c9\u305d\u306e\uff12(\u9045\u3044)\n#real   12m55.891s\n#user   0m42.560s\n#sys    0m44.310s\n#\n#\n# \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306e\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u306essh\u30db\u30b9\u30c8\u30ad\u30fc\u3092\u518d\u751f\u6210\ncd /nfs/client1\nsudo mount --bind /dev dev\nsudo mount --bind /sys sys\nsudo mount --bind /proc proc\nsudo chroot .\nrm /etc/ssh/ssh_host_*\ndpkg-reconfigure openssh-server\nexit\nsudo umount dev\nsudo umount sys\nsudo umount proc\n#\n# \u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u5468\u308a\u306e\u73fe\u5728\u306e\u8a2d\u5b9a\u53d6\u5f97\n# 'gateway' \nip route | grep default | awk '{print $3}'\n# 'brd'(broadcast)\nip -4 addr show dev eth0 | grep inet\ncat /etc/resolv.conf\n\n\n\u5b9f\u884c\u4f8b\npi@raspberrypi:/nfs/client1 $ ip route | grep default | awk '{print $3}'\n10.10.0.1\npi@raspberrypi:/nfs/client1 $ ip -4 addr show dev eth0 | grep inet\n    inet 10.10.1.96/21 brd 10.10.7.255 scope global eth0\npi@raspberrypi:/nfs/client1 $ cat /etc/resolv.conf\n# Generated by resolvconf\nnameserver 10.10.0.21\npi@raspberrypi:/nfs/client1 $ \n\n\n\n\u56fa\u5b9aIP\u306b\u3057\u307e\u3059\n\n\nsudo vi /etc/network/interfaces\n\n/etc/network/interfaces\n...\n#iface eth0 inet manual\nauto eth0\niface eth0 inet static \n        address 10.10.1.96\n        netmask 255.255.248.0\n        gateway 10.10.0.1\n...\n\n\n\n\nDHCP\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30c7\u30fc\u30e2\u30f3(dhcpcd)\u304b\u3089\u3001Debian\u6a19\u6e96\u306e\u3082\u306e(networking)\u306b\u5909\u66f4\n# DHCP\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30c7\u30fc\u30e2\u30f3(dhcpcd)\u304b\u3089\u3001Debian\u6a19\u6e96\u306e\u3082\u306e(networking)\u306b\u5909\u66f4\nsudo systemctl disable dhcpcd\nsudo systemctl enable networking\n#\n# \u518d\u8d77\u52d5\u3067\u3001\u8a2d\u5b9a\u53cd\u6620.\nsudo reboot\n\n\n\n\nDNS\u307e\u308f\u308a\u306e\u8a2d\u5b9a\n\n\u3053\u306e\u6642\u70b9\u3067DNS\u304c\u52d5\u3044\u3066\u306a\u3044\u306e\u3067\u3001\u3055\u3063\u304d\u30e1\u30e2\u3063\u305f\u9bd6\u306e\u30a2\u30c9\u30ec\u30b9\u3092 /etc/resolv.conf\u306b\u5165\u308c\u3066\u3001\u30a4\u30df\u30e5\u30fc\u30bf\u30d6\u30eb(immutable\u3042\u3068\u3067\u66f8\u304d\u63db\u3048\u3067\u304d\u306a\u3044\u3088\u3046)\u306b\u3059\u308b\u3088\u3002(dnsmasq\u304c\u3001\u3061\u3087\u3063\u304b\u3044\u3060\u3057\u3066\u304f\u308b\u3093\u3060\u3088)\n\necho \"nameserver 10.10.0.21\" | sudo tee -a /etc/resolv.conf\nsudo chattr +i /etc/resolv.conf\n\n### \n# \u5fc5\u8981\u306a\u30bd\u30d5\u30c8\u3092\u5165\u308c\u3066\u3001\n# sudo apt-get update\nsudo apt-get install dnsmasq tcpdump\n# dnsmasq \u304c\u3001\u3054\u306b\u3087\u3054\u306b\u3087\u3057\u306a\u3044\u3088\u3046\u306b\u3001\u3059\u308b\nsudo rm /etc/resolvconf/update.d/dnsmasq\n# sudo mv /etc/resolvconf/update.d/dnsmasq ~\n#\n# \u518d\u8d77\u52d5\nsudo reboot\n\n\ntcpdump\u3067\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3089\u305a\u3071\u3044\u304b\u3089\u306eDHCP\u30d1\u30b1\u30c3\u30c8\u3092\u307f\u3066\u307f\u3088\u3046\n\n\nsudo tcpdump -i eth0 port bootpc\u3068\u304b\n\nsudo tcpdump -i eth0 port bootpc | grep b8:27:eb:6c:0f:31\u3044\u3063\u3071\u3044\u30d1\u30b1\u30c3\u30c8\u304c\u98db\u3093\u3067\u305f\u3089\u3001MAC\u30a2\u30c9\u30ec\u30b9\u3067\u30d5\u30a3\u30eb\u30bf\u3057\u3066\u307f\u308b\u3001\u3068\u304b.\navahi\u30b5\u30fc\u30d3\u30b9\u3092\u5207\u3063\u3066\u307f\u308b\u306e\u3082\u3044\u3044\u304b\u3082\u3002\n\n\n\u5b9f\u884c\u4f8b--RPi3\u306e\u96fb\u6e90\u5165\u308c\u306610\uff5e25\u79d2\u5f8c\u3050\u3089\u3044\u3067\u5fdc\u7b54\u30ad\u30bf\npi@raspberrypi:~$ sudo tcpdump -i eth0 port bootpc | grep b8:27:eb:6c:0f:31\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes\n22:46:47.656127 IP 0.0.0.0.bootpc > 255.255.255.255.bootps: BOOTP/DHCP, Request from b8:27:eb:6c:0f:31 (oui Unknown), length 320\n\n\n\ndnsmasq\u306e\u8a2d\u5b9a\n\n\nDHCP\u306e\u5fdc\u7b54\u3067\u304d\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u5909\u66f4\nsudo echo | sudo tee /etc/dnsmasq.conf\nsudo vi /etc/dnsmasq.conf\n\n\n\ndhcp-range=\u306b\u306f\u3001\u30e1\u30e2\u3063\u305fbrd(broadcast)\u30a2\u30c9\u30ec\u30b9\u3092\u5165\u308c\u308b\n\n/etc/dnsmasq.conf\nport=0\ndhcp-range=10.10.7.255,proxy\nlog-dhcp\nenable-tftp\ntftp-root=/tftpboot\npxe-service=0,\"Raspberry Pi Boot\"\n\n\n\n\n/tftpboot\u4f5c\u6210\nsudo mkdir /tftpboot\nsudo chmod 777 /tftpboot\nsudo systemctl enable dnsmasq.service\nsudo systemctl restart dnsmasq.service\n\n\n\n\n/var/log/daemon.log\u3092\u89b3\u5bdf\u3002\ntail -f /var/log/daemon.log\n# \u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u304a\u304a\u3044\u3068\u304d..\n#tail -f /var/log/daemon.log | grep dnsmasq-tftp\n#\n\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3089\u305a\u3071\u3044\u306e\u96fb\u6e90\u3044\u308c\u308b\n\n\n\u5b9f\u884c\u4f8b-\u3053\u3093\u306a\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u51fa\u3066\u304f\u308b\npi@raspberrypi:~$ tail -f /var/log/daemon.log | grep dnsmasq-tftp\nAug  5 22:58:32 raspberrypi dnsmasq-tftp[692]: file /tftpboot/bootcode.bin not found\n\n\n\nbootcode.bin\u3068start.elf\u3092 /tftpboot\u306b\u30b3\u30d4\u30fc\n\nCTRL-Z\u3067\u6b62\u3081\u3066\u3001\u4ee5\u4e0b\u5b9f\u884c\n\n# bootcode.bin\u3068start.elf \u306a\u3069\u3092 `/tftpboot`\u306b\u30b3\u30d4\u30fc\ncp -r /boot/* /tftpboot`<br>\n#\n# dnsmasq\u30b5\u30fc\u30d3\u30b9\u518d\u8d77\u52d5\nsudo systemctl restart dnsmasq\n\n\nNFS ROOT\u306e\u8a2d\u5b9a\nsudo apt-get install nfs-kernel-server -y\necho \"/nfs/client1 *(rw,sync,no_subtree_check,no_root_squash)\" | sudo tee -a /etc/exports\nsudo systemctl enable rpcbind\nsudo systemctl restart rpcbind\nsudo systemctl enable nfs-kernel-server\nsudo systemctl restart nfs-kernel-server\n\n\n\nsudo vi /tftpboot/cmdline.txt/tftpboot/cmdline.txt\u306e\u7de8\u96c6\n\n\nnfsroot=<\u30b5\u30fc\u30d0\u3089\u305a\u3071\u3044\u306eIP>:/nfs/client... \u307f\u305f\u3044\u306b\u3059\u308b\n\n\n/tftpboot/cmdline.txt\ndwc_otg.lpm_enable=0 console=serial0,115200 console=tty1 root=/dev/nfs nfsroot=10.10.1.96:/nfs/client1 rw ip=dhcp rootwait elevator=deadline\n#\n#\u5143\u306e\u8a2d\u5b9a\n#dwc_otg.lpm_enable=0 console=serial0,115200 console=tty1 root=/dev/mmcblk0p2 rootfstype=ext4 elevator=deadline fsck.repair=yes rootwait\n\n\n\n\nsudo vi /nfs/client1/etc/fstab/nfs/client1/etc/fstab\u306e\u7de8\u96c6\n\n\n/dev/mmcblk0p\u306e\u3068\u3053\u3092\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8 #\n\n\n/nfs/client1/etc/fstab\nproc            /proc           proc    defaults          0       0\n#/dev/mmcblk0p1  /boot           vfat    defaults          0       2\n#/dev/mmcblk0p2  /               ext4    defaults,noatime  0       1\n# a swapfile is not a swap partition, no line here\n#   use  dphys-swapfile swap[on|off]  for that\n\n\n\n\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3089\u305a\u3071\u3044\u306e\u96fb\u6e90\u3092\u5165\u308c\u3066\u3001\u5f85\u3064...\n\nroot / \u304c\u3001nfs\n\npi@raspberrypi:~ $ ssh pi@10.10.1.62\npi@10.10.1.62's password: \n\nThe programs included with the Debian GNU/Linux system are free software;\nthe exact distribution terms for each program are described in the\nindividual files in /usr/share/doc/*/copyright.\n\nDebian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent\npermitted by applicable law.\nLast login: Fri Aug  5 23:08:41 2016 from 10.10.1.96\npi@raspberrypi:~ $ mount | grep nfs\n10.10.1.96:/nfs/client1 on / type nfs (rw,relatime,vers=2,rsize=4096,wsize=4096,namlen=255,hard,nolock,proto=udp,timeo=11,retrans=3,sec=sys,mountaddr=10.10.1.96,mountvers=1,mountproto=udp,local_lock=all,addr=10.10.1.96)\npi@raspberrypi:~ $ \n\n\n\u305d\u306e\u4ed6\n\n\u8907\u6570\u306e\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3063\u3066\u3001\u3067\u304d\u308b\u306e\uff1f(\u3089\u305a\u3071\u3044\uff13\u306f1\u53f0\u3057\u304b\u3082\u3063\u3066\u306a\u3044\u306e\u3067\u3001\u8a66\u305b\u3066\u3044\u306a\u3044)\n\u304a\u305d\u3044\u3002\u3002(apt-get install ... \u3068\u304b)I/O\u306e\u3084\u308a\u53d6\u308a\u304c\u5c11\u306a\u304f\u3001CPU\u3092\u3088\u304f\u4f7f\u3046\u30d7\u30ed\u30b0\u30e9\u30e0\u3001\u3001\u3001\u3060\u3068\u3088\u3044\u306e\u304b\u306a\uff1f\n\n\n## \u6982\u8981\n- [Pi 3 booting part II: Ethernet](https://www.raspberrypi.org/blog/pi-3-booting-part-ii-ethernet-all-the-awesome/)\n\n\n> Yesterday, we introduced the first of two new boot modes which have now been added to the Raspberry Pi 3. Today, we introduce an even more exciting addition: network booting a Raspberry Pi with no SD card.\n> \u6628\u65e5\u3001\u79c1\u305f\u3061\u306f\u30e9\u30ba\u30d9\u30ea\u30fc\u30d1\u30a43\u306b\u8ffd\u52a0\u3055\u308c\u305f2\u3064\u306e\u65b0\u3057\u3044\u30d6\u30fc\u30c8\u30e2\u30fc\u30c9\u306e\u4e00\u3064\u76ee\u3092\u7d39\u4ecb\u3057\u307e\u3057\u305f\u3002\u4eca\u65e5\u3001\u6211\u3005\u306f\u3001\u3055\u3089\u306b\u30a8\u30ad\u30b5\u30a4\u30c6\u30a3\u30f3\u30b0\u306a\u8ffd\u52a0\u6a5f\u80fd\uff1aSD\u30ab\u30fc\u30c9\u306a\u3057\u30e9\u30ba\u30d9\u30ea\u30fc\u30d1\u30a4\u3092\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30d6\u30fc\u30c8\u3000\u3092\u7d39\u4ecb\u3057\u307e\u3059\u3002\n\n\u3060\u305d\u3046\u3067\u3059\n\n- [Network Boot Your Raspberry Pi](https://www.raspberrypi.org/documentation/hardware/raspberrypi/bootmodes/net_tutorial.md) - \u624b\u9806\u306f\u3053\u3061\u3089\u3002\n\n<br>\n\n- \u30de\u30b8\u3067\u3001\u8d77\u52d5\u3057\u305f...\n\n\n## \u74b0\u5883\n- \u30af\u30e9\u30a4\u30a2\u30f3\u30c8: Raspberry Pi 3\n- \u30b5\u30fc\u30d0: Raspberry Pi 2\n- microSD 4GB 1\u679a\n- `2016-05-27-raspbian-jessie-lite.img`\n\n\n\n\n## \u624b\u9806\n\n- \u307e\u305a\u306f\u901a\u5e38\u901a\u308a\u306b\u3001microSD\u306b\u3001Raspbian lite\u3092\u66f8\u304d\u8fbc\u3080.\n\n### \u30af\u30e9\u30a4\u30a2\u30f3\u30c8 Raspberry Pi 3\u3067\u4f5c\u696d\n- \u713c\u3044\u305fmicroSD\u3067\u8d77\u52d5\n\n```\n# \u30ec\u30dd\u30b8\u30c8\u30eaDB\u66f4\u65b0, \u30d5\u30a1\u30fc\u30e0\u30a6\u30a7\u30a2\u306e\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8, config.txt\u306e\u8a2d\u5b9a, \u518d\u8d77\u52d5\nsudo apt-get update ; sudo apt-get install rpi-update -y ; sudo BRANCH=next rpi-update ; echo program_usb_boot_mode=1 | sudo tee -a /boot/config.txt ; sudo reboot\n#\n# \u518d\u8d77\u52d5\u5f8c\u3001 otp\u306e\u5024\u3092\u78ba\u8a8d\nvcgencmd otp_dump | grep 17:\n# > 17:3020000a \u3068\u306a\u3063\u3066\u3044\u308c\u3070OK\n#\n# MAC\u30a2\u30c9\u30ec\u30b9\u3092\u30e1\u30e2\u3063\u3066\u304a\u304f\u3068\u3044\u3044\u304b\u3082? (\u78ba\u8a8d\u306e\u305f\u3081)\ncat /sys/class/net/eth0/address \n#\n# \u96fb\u6e90OFF\nsudo poweroff \n```\n\n### \u30b5\u30fc\u30d0 Raspberry Pi 2\u3067\u4f5c\u696d\n- \u2191\u3067\u4f7f\u3063\u305fmicroSD\u3092\u633f\u3059\u3002\n\n```bash\n#> \u30af\u30e9\u30a4\u30a2\u30f3\u30c8Pi\u304c\u8d77\u52d5\u3059\u308b\u306e\u306b\u3001\u30eb\u30fc\u30c8\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u304c\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\u304c\u3001\n#> \u79c1\u305f\u3061\u306f\u30b5\u30fc\u30d0\u30fc\u4e0a\u3067\u4f55\u304b\u3092\u884c\u3046\u524d\u306b\u3001\n#> \u79c1\u305f\u3061\u306f\u305d\u306e\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u306e\u5b8c\u5168\u306a\u30b3\u30d4\u30fc\u3092\u4f5c\u6210\u3057\u3001/nfs/client1 \u3068\u547c\u3070\u308c\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u305d\u308c\u3092\u7f6e\u304f\u3064\u3082\u308a\u3067\u3059\u3002\n#\u3068\u306e\u3053\u3068\u3067\u3059.\nsudo mkdir -p /nfs/client1\nsudo apt-get install rsync\ntime sudo rsync -xa --progress --exclude /nfs / /nfs/client1\n#\n# time\u3067\u8a08\u6e2c\n#<<< sd\u30ab\u30fc\u30c9\u305d\u306e\uff11(\u307e\u3041\u307e\u3041)\n#real\t6m52.395s\n#user\t0m21.890s\n#sys\t0m23.320s\n#<<< sd\u30ab\u30fc\u30c9\u305d\u306e\uff12(\u9045\u3044)\n#real\t12m55.891s\n#user\t0m42.560s\n#sys\t0m44.310s\n#\n#\n# \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306e\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u306essh\u30db\u30b9\u30c8\u30ad\u30fc\u3092\u518d\u751f\u6210\ncd /nfs/client1\nsudo mount --bind /dev dev\nsudo mount --bind /sys sys\nsudo mount --bind /proc proc\nsudo chroot .\nrm /etc/ssh/ssh_host_*\ndpkg-reconfigure openssh-server\nexit\nsudo umount dev\nsudo umount sys\nsudo umount proc\n#\n# \u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u5468\u308a\u306e\u73fe\u5728\u306e\u8a2d\u5b9a\u53d6\u5f97\n# 'gateway' \nip route | grep default | awk '{print $3}'\n# 'brd'(broadcast)\nip -4 addr show dev eth0 | grep inet\ncat /etc/resolv.conf\n```\n\n```shell-session:\u5b9f\u884c\u4f8b\npi@raspberrypi:/nfs/client1 $ ip route | grep default | awk '{print $3}'\n10.10.0.1\npi@raspberrypi:/nfs/client1 $ ip -4 addr show dev eth0 | grep inet\n    inet 10.10.1.96/21 brd 10.10.7.255 scope global eth0\npi@raspberrypi:/nfs/client1 $ cat /etc/resolv.conf\n# Generated by resolvconf\nnameserver 10.10.0.21\npi@raspberrypi:/nfs/client1 $ \n```\n\n#### \u56fa\u5b9aIP\u306b\u3057\u307e\u3059\n- `sudo vi /etc/network/interfaces`\n\n    ```txt:/etc/network/interfaces\n...\n#iface eth0 inet manual\nauto eth0\niface eth0 inet static \n            address 10.10.1.96\n            netmask 255.255.248.0\n            gateway 10.10.0.1\n...\n```\n\n- DHCP\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30c7\u30fc\u30e2\u30f3(dhcpcd)\u304b\u3089\u3001Debian\u6a19\u6e96\u306e\u3082\u306e(networking)\u306b\u5909\u66f4\n\n    ```bash\n# DHCP\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30c7\u30fc\u30e2\u30f3(dhcpcd)\u304b\u3089\u3001Debian\u6a19\u6e96\u306e\u3082\u306e(networking)\u306b\u5909\u66f4\nsudo systemctl disable dhcpcd\nsudo systemctl enable networking\n#\n# \u518d\u8d77\u52d5\u3067\u3001\u8a2d\u5b9a\u53cd\u6620.\nsudo reboot\n```\n\n\n### DNS\u307e\u308f\u308a\u306e\u8a2d\u5b9a\n- \u3053\u306e\u6642\u70b9\u3067DNS\u304c\u52d5\u3044\u3066\u306a\u3044\u306e\u3067\u3001\u3055\u3063\u304d\u30e1\u30e2\u3063\u305f\u9bd6\u306e\u30a2\u30c9\u30ec\u30b9\u3092 `/etc/resolv.conf`\u306b\u5165\u308c\u3066\u3001\u30a4\u30df\u30e5\u30fc\u30bf\u30d6\u30eb(immutable\u3042\u3068\u3067\u66f8\u304d\u63db\u3048\u3067\u304d\u306a\u3044\u3088\u3046)\u306b\u3059\u308b\u3088\u3002(`dnsmasq`\u304c\u3001\u3061\u3087\u3063\u304b\u3044\u3060\u3057\u3066\u304f\u308b\u3093\u3060\u3088)\n\n```bash\necho \"nameserver 10.10.0.21\" | sudo tee -a /etc/resolv.conf\nsudo chattr +i /etc/resolv.conf\n\n### \n# \u5fc5\u8981\u306a\u30bd\u30d5\u30c8\u3092\u5165\u308c\u3066\u3001\n# sudo apt-get update\nsudo apt-get install dnsmasq tcpdump\n# dnsmasq \u304c\u3001\u3054\u306b\u3087\u3054\u306b\u3087\u3057\u306a\u3044\u3088\u3046\u306b\u3001\u3059\u308b\nsudo rm /etc/resolvconf/update.d/dnsmasq\n# sudo mv /etc/resolvconf/update.d/dnsmasq ~\n#\n# \u518d\u8d77\u52d5\nsudo reboot\n```\n\n### tcpdump\u3067\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3089\u305a\u3071\u3044\u304b\u3089\u306eDHCP\u30d1\u30b1\u30c3\u30c8\u3092\u307f\u3066\u307f\u3088\u3046\n\n- `sudo tcpdump -i eth0 port bootpc`<br>\u3068\u304b\n- `sudo tcpdump -i eth0 port bootpc | grep b8:27:eb:6c:0f:31`<br>\u3044\u3063\u3071\u3044\u30d1\u30b1\u30c3\u30c8\u304c\u98db\u3093\u3067\u305f\u3089\u3001MAC\u30a2\u30c9\u30ec\u30b9\u3067\u30d5\u30a3\u30eb\u30bf\u3057\u3066\u307f\u308b\u3001\u3068\u304b.\n- avahi\u30b5\u30fc\u30d3\u30b9\u3092\u5207\u3063\u3066\u307f\u308b\u306e\u3082\u3044\u3044\u304b\u3082\u3002\n\n```shell-session:\u5b9f\u884c\u4f8b--RPi3\u306e\u96fb\u6e90\u5165\u308c\u306610\uff5e25\u79d2\u5f8c\u3050\u3089\u3044\u3067\u5fdc\u7b54\u30ad\u30bf\npi@raspberrypi:~$ sudo tcpdump -i eth0 port bootpc | grep b8:27:eb:6c:0f:31\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes\n22:46:47.656127 IP 0.0.0.0.bootpc > 255.255.255.255.bootps: BOOTP/DHCP, Request from b8:27:eb:6c:0f:31 (oui Unknown), length 320\n```\n\n### dnsmasq\u306e\u8a2d\u5b9a\n- DHCP\u306e\u5fdc\u7b54\u3067\u304d\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u5909\u66f4\n\n    ```bash\nsudo echo | sudo tee /etc/dnsmasq.conf\nsudo vi /etc/dnsmasq.conf\n```\n- dhcp-range=\u306b\u306f\u3001\u30e1\u30e2\u3063\u305fbrd(broadcast)\u30a2\u30c9\u30ec\u30b9\u3092\u5165\u308c\u308b\n\n    ```txt:/etc/dnsmasq.conf\nport=0\ndhcp-range=10.10.7.255,proxy\nlog-dhcp\nenable-tftp\ntftp-root=/tftpboot\npxe-service=0,\"Raspberry Pi Boot\"\n```\n\n- `/tftpboot`\u4f5c\u6210\n\n    ```bash\nsudo mkdir /tftpboot\nsudo chmod 777 /tftpboot\nsudo systemctl enable dnsmasq.service\nsudo systemctl restart dnsmasq.service\n```\n\n\n#### `/var/log/daemon.log`\u3092\u89b3\u5bdf\u3002\n\n```bash\ntail -f /var/log/daemon.log\n# \u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u304a\u304a\u3044\u3068\u304d..\n#tail -f /var/log/daemon.log | grep dnsmasq-tftp\n#\n```\n- \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3089\u305a\u3071\u3044\u306e\u96fb\u6e90\u3044\u308c\u308b\n\n```shell-session:\u5b9f\u884c\u4f8b-\u3053\u3093\u306a\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u51fa\u3066\u304f\u308b\npi@raspberrypi:~$ tail -f /var/log/daemon.log | grep dnsmasq-tftp\nAug  5 22:58:32 raspberrypi dnsmasq-tftp[692]: file /tftpboot/bootcode.bin not found\n```\n\n#### `bootcode.bin`\u3068`start.elf`\u3092 `/tftpboot`\u306b\u30b3\u30d4\u30fc\n- CTRL-Z\u3067\u6b62\u3081\u3066\u3001\u4ee5\u4e0b\u5b9f\u884c\n\n```bash\n# bootcode.bin\u3068start.elf \u306a\u3069\u3092 `/tftpboot`\u306b\u30b3\u30d4\u30fc\ncp -r /boot/* /tftpboot`<br>\n#\n# dnsmasq\u30b5\u30fc\u30d3\u30b9\u518d\u8d77\u52d5\nsudo systemctl restart dnsmasq\n```\n\n### NFS ROOT\u306e\u8a2d\u5b9a\n\n```bash\nsudo apt-get install nfs-kernel-server -y\necho \"/nfs/client1 *(rw,sync,no_subtree_check,no_root_squash)\" | sudo tee -a /etc/exports\nsudo systemctl enable rpcbind\nsudo systemctl restart rpcbind\nsudo systemctl enable nfs-kernel-server\nsudo systemctl restart nfs-kernel-server\n```\n\n- `sudo vi /tftpboot/cmdline.txt`<br>`/tftpboot/cmdline.txt`\u306e\u7de8\u96c6\n    - `nfsroot=`<\u30b5\u30fc\u30d0\u3089\u305a\u3071\u3044\u306eIP>`:/nfs/client`... \u307f\u305f\u3044\u306b\u3059\u308b\n\n    ```txt:/tftpboot/cmdline.txt\ndwc_otg.lpm_enable=0 console=serial0,115200 console=tty1 root=/dev/nfs nfsroot=10.10.1.96:/nfs/client1 rw ip=dhcp rootwait elevator=deadline\n#\n#\u5143\u306e\u8a2d\u5b9a\n#dwc_otg.lpm_enable=0 console=serial0,115200 console=tty1 root=/dev/mmcblk0p2 rootfstype=ext4 elevator=deadline fsck.repair=yes rootwait\n```\n\n- `sudo vi /nfs/client1/etc/fstab`<br>`/nfs/client1/etc/fstab`\u306e\u7de8\u96c6\n    - `/dev/mmcblk0p`\u306e\u3068\u3053\u3092\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8 \\#\n\n    ```txt:/nfs/client1/etc/fstab\nproc            /proc           proc    defaults          0       0\n#/dev/mmcblk0p1  /boot           vfat    defaults          0       2\n#/dev/mmcblk0p2  /               ext4    defaults,noatime  0       1\n# a swapfile is not a swap partition, no line here\n#   use  dphys-swapfile swap[on|off]  for that\n```\n\n\n\n### \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3089\u305a\u3071\u3044\u306e\u96fb\u6e90\u3092\u5165\u308c\u3066\u3001\u5f85\u3064...\n\n- root `/` \u304c\u3001nfs\n \n```shell-session\npi@raspberrypi:~ $ ssh pi@10.10.1.62\npi@10.10.1.62's password: \n\nThe programs included with the Debian GNU/Linux system are free software;\nthe exact distribution terms for each program are described in the\nindividual files in /usr/share/doc/*/copyright.\n\nDebian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent\npermitted by applicable law.\nLast login: Fri Aug  5 23:08:41 2016 from 10.10.1.96\npi@raspberrypi:~ $ mount | grep nfs\n10.10.1.96:/nfs/client1 on / type nfs (rw,relatime,vers=2,rsize=4096,wsize=4096,namlen=255,hard,nolock,proto=udp,timeo=11,retrans=3,sec=sys,mountaddr=10.10.1.96,mountvers=1,mountproto=udp,local_lock=all,addr=10.10.1.96)\npi@raspberrypi:~ $ \n```\n\n\n\n## \u305d\u306e\u4ed6\n- \u8907\u6570\u306e\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3063\u3066\u3001\u3067\u304d\u308b\u306e\uff1f(\u3089\u305a\u3071\u3044\uff13\u306f1\u53f0\u3057\u304b\u3082\u3063\u3066\u306a\u3044\u306e\u3067\u3001\u8a66\u305b\u3066\u3044\u306a\u3044)\n- \u304a\u305d\u3044\u3002\u3002(apt-get install ... \u3068\u304b)<br>I/O\u306e\u3084\u308a\u53d6\u308a\u304c\u5c11\u306a\u304f\u3001CPU\u3092\u3088\u304f\u4f7f\u3046\u30d7\u30ed\u30b0\u30e9\u30e0\u3001\u3001\u3001\u3060\u3068\u3088\u3044\u306e\u304b\u306a\uff1f\n", "tags": ["RaspberryPi", "raspbian", "tftp"]}