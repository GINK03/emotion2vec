{"context": " More than 1 year has passed since last update.\n\u300c\u304b\u3093\u3070\u3093\u300d\u3092\u3001DDD\u3067\u8a2d\u8a08\u3057Rails\u3067\u5b9f\u88c5\u3057\u3066\u307f\u307e\u3057\u305f\u3002\nkanban_core_extension\n\u73fe\u6642\u70b9\u3067\u306f\u3001\u6700\u5c0f\u9650\u306e\u6a5f\u80fd\u3057\u304b\u3042\u308a\u307e\u305b\u3093\u304c\n\u30c9\u30e1\u30a4\u30f3\u99c6\u52d5\u8a2d\u8a08\u3092Rails\u3067\u5b9f\u88c5\u3059\u308b\u969b\u306e\u4e00\u4f8b\u3068\u3057\u3066\u53c2\u8003\u306b\u306a\u308c\u3070\u5e78\u3044\u3067\u3059\u3002\n\n\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u6a5f\u80fd\n\n\u958b\u767a\u3059\u308b\u30d5\u30a3\u30fc\u30c1\u30e3\uff08\u30bf\u30b9\u30af\uff09\u3092\u30ab\u30fc\u30c9\u3067\u8868\u73fe\u3057\u3001\u9032\u6357\u72b6\u6cc1\u3092\u304b\u3093\u3070\u3093\u30dc\u30fc\u30c9\u3067\u53ef\u8996\u5316\u3059\u308b\n\u30ab\u30fc\u30c9\u3092\u6b21\u306e\u30d5\u30a7\u30fc\u30ba\uff08\u9032\u6357\u306e\u533a\u5207\u308a\uff09\u306b\u9032\u3081\u308b\u6642\u306bWIP\u5236\u9650\u3092\u30c1\u30a7\u30c3\u30af\u3059\u308b\n\n\n\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u30b9\u30bf\u30a4\u30eb\nEvent Sourcing\u306a\u3057\u306eCQRS\u3067\u3059\u3002\n\u5909\u66f4\uff08Command\uff09\u306e\u6642\u3060\u3051\u30c9\u30e1\u30a4\u30f3\u30e2\u30c7\u30eb\u3092\u4f7f\u3044\u307e\u3059\u3002\n\u554f\u3044\u5408\u308f\u305b\uff08Query\uff09\u3067\u306f\u3001\u5fc5\u8981\u306a\u30c7\u30fc\u30bf\u3092\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u304b\u3089\u76f4\u63a5\u53d6\u5f97\u3057\u307e\u3059\u3002\n\u30ea\u30dd\u30b8\u30c8\u30ea\u304b\u3089\u30c9\u30e1\u30a4\u30f3\u30e2\u30c7\u30eb\u3092\u53d6\u5f97\u3059\u308b\u3053\u3068\u306f\u3057\u307e\u305b\u3093\u3002\n\u53d6\u5f97\u3057\u305f\u30c7\u30fc\u30bf\u306f\u69cb\u9020\u5316\u3055\u308c\u305f\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3067\u3059\u304c\u3001\u30c9\u30e1\u30a4\u30f3\u30ed\u30b8\u30c3\u30af\u306f\u4e00\u5207\u6301\u305f\u306a\u3044\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\u30c9\u30e1\u30a4\u30f3\u30e2\u30c7\u30eb\u306b\u3001\u60c5\u5831\u306e\u53d6\u5f97\u3084UI\u306e\u305f\u3081\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u6301\u305f\u305b\u305a\u3001\u30c9\u30e1\u30a4\u30f3\u306b\u95a2\u3059\u308b\u632f\u308b\u821e\u3044\u306b\u96c6\u4e2d\u3055\u305b\u308b\u305f\u3081\u3067\u3059\u3002\n\n\u69cb\u6210\n\u251c\u2500\u2500 Gemfile\n\u251c\u2500\u2500 Gemfile.lock\n\u251c\u2500\u2500 README.rdoc\n\u251c\u2500\u2500 Rakefile\n\u251c\u2500\u2500 app\n\u251c\u2500\u2500 bin\n\u251c\u2500\u2500 config\n\u251c\u2500\u2500 config.ru\n\u251c\u2500\u2500 db\n\u251c\u2500\u2500 domain (*)\n\u251c\u2500\u2500 lib\n\u251c\u2500\u2500 log\n\u251c\u2500\u2500 public\n\u251c\u2500\u2500 spec\n\u251c\u2500\u2500 tmp\n\u2514\u2500\u2500 vendor\n\nRails.root\u76f4\u4e0b\u306bdomain\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304c\u3042\u308b\u4ee5\u5916\u306f\u901a\u5e38\u306eRails\u3068\u540c\u3058\u3067\u3059\u3002\n\ndomain\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\ndomain\n\u251c\u2500\u2500 activity\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 complete_state.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 end_phase_spec.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 no_state.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 no_transition.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 no_wip_limit.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 phase.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 phase_spec.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 phase_spec_builder.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 state.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 step.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 transition.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 transition_setted.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 wip_limit.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 workflow.rb\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 workflow_builder.rb\n\u251c\u2500\u2500 activity.rb\n\u251c\u2500\u2500 feature\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 backlog_service.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 description.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 development_tracker.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 feature.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 feature_id.rb\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 state.rb\n\u251c\u2500\u2500 feature.rb\n\u251c\u2500\u2500 kanban\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 actions.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 add_card.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 board.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 board_builder.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 board_maintainer.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 card.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 card_added.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 card_map.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 card_removed.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 pull_card.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 push_card.rb\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 remove_card.rb\n\u251c\u2500\u2500 kanban.rb\n\u251c\u2500\u2500 project\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 description.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 operations.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 project.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 project_factory.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 project_id.rb\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 project_launched.rb\n\u2514\u2500\u2500 project.rb\n\n\u540d\u524d\u306e\u901a\u308a\u3001\u30e6\u30d3\u30ad\u30bf\u30b9\u8a00\u8a9e\u3092\u4f7f\u3063\u3066Ruby\u3067\u5b9f\u88c5\u3055\u308c\u305f\u30c9\u30e1\u30a4\u30f3\u30e2\u30c7\u30eb\u304c\u5165\u3063\u3066\u3044\u307e\u3059\u3002\n\u73fe\u6642\u70b9\u3067\u60f3\u5b9a\u3057\u3066\u3044\u308b\u3001\u5883\u754c\u3065\u3051\u3089\u308c\u305f\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u5185\u306b\u3042\u308b\u30e2\u30c7\u30eb\u3092\n\nActivity\nFeature\nKanban\nProject\n\n\u306e4\u3064\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u306b\u307e\u3068\u3081\u3066\u3044\u307e\u3059\u3002\n\n\u30a8\u30f3\u30c6\u30a3\u30c6\u30a3\uff08Entities\uff09\n\u30d0\u30ea\u30e5\u30fc\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\uff08Value Objects\uff09\n\u30b5\u30fc\u30d3\u30b9\uff08Domain Services\uff09\n\u30c9\u30e1\u30a4\u30f3\u30a4\u30d9\u30f3\u30c8\uff08Domain Events\uff09\n\n\u3068\u3044\u3063\u305f\u6226\u8853\u7684\u30d1\u30bf\u30fc\u30f3\u306b\u3088\u308b\u5206\u985e\u306f\u3057\u3066\u3044\u307e\u305b\u3093\u3002\n\napp\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\napp\n\u251c\u2500\u2500 assets\n\u251c\u2500\u2500 commands\n\u251c\u2500\u2500 controllers\n\u251c\u2500\u2500 forms\n\u251c\u2500\u2500 helpers\n\u251c\u2500\u2500 infrastructures\n\u251c\u2500\u2500 mailers\n\u251c\u2500\u2500 models\n\u2502\u00a0\u00a0  \u2514\u2500\u2500 view\n\u251c\u2500\u2500 repositories\n\u251c\u2500\u2500 services\n\u251c\u2500\u2500 validators\n\u2514\u2500\u2500 views\n\n\u30c7\u30d5\u30a9\u30eb\u30c8\u306econtrollers\u3001models\u3001views\u306a\u3069\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u4ed6\u306b\n\ncommands\ninfrastructures\nrepositories\nmodels/view\nservices\n\n\u3053\u308c\u3089\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u8ffd\u52a0\u3057\u3066\u3044\u307e\u3059\u3002\n\napp/commands\n\u30ec\u30a4\u30e4\u30fc\u30c9\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u5c64\u306e\u4e00\u90e8\u3067\u3059\u3002\nUI\u5c64\u306eRails\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u3068\u3001\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u5c64\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d3\u30b9\u3092\u7e4b\u304e\u307e\u3059\u3002\nclass FeaturesController < ApplicationController\n\n  def new\n    @command = AddFeatureCommand.new.tap do |c|\n      c.project_id_str = params[:project_id_str]\n    end\n  end\n\n  def create\n    @command = AddFeatureCommand.new(params[:add_feature_command])\n    if @command.execute(feature_service)\n      redirect_to backlog_url(@command.project_id_str), notice: 'Feature added to backlog!'\n    else\n      flash.now[:alert] = 'Ooops!'\n      render :new\n    end\n  end\nend\n\n\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u306f\u3001HTTP\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u5143\u306b\u30b3\u30de\u30f3\u30c9\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u751f\u6210\u3057\u305f\u5f8c\n\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d3\u30b9\u3092\u30b3\u30de\u30f3\u30c9\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306b\u6e21\u3057\u3066\u5b9f\u884c\u3057\u307e\u3059\u3002\nclass AddFeatureCommand\n  include ActiveModel::Model\n  include DomainObjectConversion\n\n  attr_accessor :project_id_str, :summary, :detail\n\n  validates :summary, presence: true\n  validates :detail, presence: true\n\n  def description\n    Feature::Description.new(summary, detail)\n  end\n\n  def execute(service)\n    return false unless valid?\n    service.add(project_id, description)\n  end\nend\n\n\u30b3\u30de\u30f3\u30c9\u306f\u3001\n\n\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3068\u304d\u306b\u5fc5\u8981\u306a\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\n\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u30c9\u30e1\u30a4\u30f3\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3078\u306e\u5909\u63db\uff08\u4e3b\u306b\u30d0\u30ea\u30e5\u30fc\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3078\u5909\u63db\u3059\u308b\uff09\n\u81ea\u8eab\u306b\u5bfe\u5fdc\u3059\u308b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d3\u30b9\u306e\u547c\u3073\u51fa\u3057\n\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\n\n\u3092\u62c5\u5f53\u3057\u307e\u3059\u3002\n\napp/infrastructures\n\nArize\n\u96c6\u7d04\uff08Aggregates\uff09\u3092\u69cb\u6210\u3059\u308b\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3068\u30ea\u30ec\u30fc\u30b7\u30e7\u30f3\uff08DB\u30ec\u30b3\u30fc\u30c9\uff09\u306e\u5909\u63db\u3092\u62c5\u5f53\u3057\u307e\u3059\u3002\nJava\u306a\u3069\u3067\u306f\u3001DataMapper\u30d1\u30bf\u30fc\u30f3\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u4f7f\u3063\u3066\u30ea\u30dd\u30b8\u30c8\u30ea\u306b\u5b9f\u88c5\u3059\u308b\u3053\u3068\u304c\u591a\u3044\u3068\u601d\u3044\u307e\u3059\u304c\u3001\n\u4eca\u56de\u306fRails\u6a19\u6e96\u306eActiveRecord\u3092\u4f7f\u3063\u3066\u3044\u307e\u3059\u3002\n\u305d\u306e\u5834\u5408\u3001\u30c9\u30e1\u30a4\u30f3\u30e2\u30c7\u30eb\u306e\u30a8\u30f3\u30c6\u30a3\u30c6\u30a3\u30af\u30e9\u30b9\u3092\u3001\u901a\u5e38\u306eRails\u30e2\u30c7\u30eb\u3068\u540c\u3058\u3088\u3046\u306b\u5b9f\u88c5\u3059\u308b\u3068\n\u30c9\u30e1\u30a4\u30f3\u306e\u632f\u308b\u821e\u3044\u3068\u3001\u30c7\u30fc\u30bf\u306b\u95a2\u3059\u308b\u632f\u308b\u821e\u3044\u304c\u6df7\u5728\u3057\u307e\u3059\u3002\n\u4eca\u56de\u306f\u7d50\u5c40\u3001\u30a8\u30f3\u30c6\u30a3\u30c6\u30a3\u30af\u30e9\u30b9\u306fActiveRecord::Base\u3092\u7d99\u627f\u3057\u3066\u3044\u3066\n\u5b9f\u969b\u306b\u306f\u901a\u5e38\u306eRails\u30e2\u30c7\u30eb\u3068\u5909\u308f\u3089\u306a\u3044\u306e\u3067\u3059\u304c\n\u30b3\u30fc\u30c9\uff08\u30d5\u30a1\u30a4\u30eb\uff09\u3060\u3051\u3067\u3082\u3001\u30c9\u30e1\u30a4\u30f3\u306e\u632f\u308b\u821e\u3044\u3068\u30c7\u30fc\u30bf\u306b\u95a2\u3059\u308b\u632f\u308b\u821e\u3044\u3092\u5206\u96e2\u3055\u305b\u305f\u304b\u3063\u305f\u306e\u3067\n\u3053\u306eapp/infrastructures/arize\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4ee5\u4e0b\u306b\u30e2\u30b8\u30e5\u30fc\u30eb\u3068\u3057\u3066\u5207\u308a\u51fa\u3057\u307e\u3057\u305f\u3002\nmodule Arize\n  module Card\n    extend ActiveSupport::Concern\n\n    included do\n      self.table_name = 'card_records'\n\n      include Writers\n      include Readers\n    end\n\n    module Writers\n\n      def feature_id=(a_feature_id)\n        self.feature_id_str = a_feature_id.to_s\n      end\n\n      def step=(a_step)\n        self.step_phase_name = a_step.phase.to_s\n        self.step_state_name = serialize_state(a_step.state)\n      end\n\n      def serialize_state(state)\n        state.to_s\n      end\n    end\n\n    module Readers\n\n      def feature_id\n        ::Feature::FeatureId.new(feature_id_str)\n      end\n\n      def step\n        ::Project::Step.new(\n          build_phase(step_phase_name),\n          build_state(step_state_name)\n        )\n      end\n\n      def build_phase(phase)\n        ::Project::Phase.new(phase)\n      end\n\n      def build_state(state)\n        ::Project::State.from_string(state)\n      end\n    end\n  end\nend\n\n\u901a\u5e38\u306eRails\u30e2\u30c7\u30eb\u3068\u9055\u3044\u3001\u30c6\u30fc\u30d6\u30eb\u540d\u306f\u30af\u30e9\u30b9\u540d\u306b_records\u63a5\u5c3e\u8f9e\u3092\u4ed8\u3051\u3066\u3044\u307e\u3059\u3002\nWriters\u3067\u30c9\u30e1\u30a4\u30f3\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u304b\u3089\u30ab\u30e9\u30e0\u578b\u3078\nReaders\u3067\u30ab\u30e9\u30e0\u578b\u304b\u3089\u30c9\u30e1\u30a4\u30f3\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3078\n\u5909\u63db\u3092\u884c\u3044\u307e\u3059\u3002\nmodule Kanban\n  class Card < ActiveRecord::Base\n    include Arize::Card\n\n    def self.write(feature_id)\n      new.tap do |card|\n        card.feature_id = feature_id\n      end\n    end\n\n    def relocate(to)\n      self.step = to\n    end\n\n    def ==(other)\n      if other.instance_of?(self.class)\n        self.feature_id == other.feature_id\n      else\n        self.feature_id == other\n      end\n    end\n  end\nend\n\n\u30c9\u30e1\u30a4\u30f3\u30e2\u30c7\u30eb\u306eKanban::Card\u30af\u30e9\u30b9\u306f\u3053\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\u30c9\u30e1\u30a4\u30f3\u306b\u95a2\u3059\u308b\u632f\u308b\u821e\u3044\u306e\u307f\u3067\u3059\u3002\n\nevent_publisher.rb\nWisper\u306e\u30e9\u30c3\u30d1\u30fc\u3067\u3059\u3002\n\u30c9\u30e1\u30a4\u30f3\u30a4\u30d9\u30f3\u30c8\u306epublish/subscribe\u3092\u6271\u3044\u307e\u3059\u3002\n\napp/repositories\n\u30ea\u30dd\u30b8\u30c8\u30ea\u306e\u5b9f\u88c5\u3067\u3059\u3002\n1\u3064\u306e\u96c6\u7d04\u306b1\u3064\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u304c\u5bfe\u5fdc\u3057\u307e\u3059\u3002\nclass BoardRepository\n\n  def find(project_id)\n    Kanban::Board\n      .includes(:cards)\n      .find_by(project_id_str: project_id.to_s)\n  end\n\n  def store(board)\n    board.save!\n  end\nend\n\n\u30c9\u30e1\u30a4\u30f3\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306b\u4f55\u3089\u304b\u306e\u5909\u66f4\u3092\u3057\u305f\u3044\u3068\u304d\u306e\u307f\u30ea\u30dd\u30b8\u30c8\u30ea\u3092\u4f7f\u3044\u307e\u3059\u3002\n\u3057\u305f\u304c\u3063\u3066\u3001\u30e1\u30bd\u30c3\u30c9\u306ffind\u3068store\u3060\u3051\u3067\u3059\u3002\n\u96c6\u7d04\u306e\u30eb\u30fc\u30c8\u30a8\u30f3\u30c6\u30a3\u30c6\u30a3\u306fActiveRecord::Base\u3092\u7d99\u627f\u3057\u3066\u3044\u307e\u3059\u306e\u3067\n\u901a\u5e38\u306eRails\u30e2\u30c7\u30eb\u3068\u540c\u3058\u3088\u3046\u306b\u6271\u3048\u307e\u3059\u3002\n\napp/models\n\u901a\u5e38\u306eRails\u30e2\u30c7\u30eb\u3067\u3059\u304c\u3001\u7528\u9014\u306fView\u5c02\u7528\u3067\u3059\u3002\n\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u3084\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u306a\u3069\u306f\u4e00\u5207\u884c\u3044\u307e\u305b\u3093\u3002\nclass ProjectRecord < ActiveRecord::Base\n  has_many :phase_spec_records, -> { order(:order) }\n  has_many :state_records, -> { order(:order) }\n\n  class << self\n\n    def with_workflow(project_id_str)\n      eager_load(:phase_spec_records, :state_records)\n        .find_by(project_id_str: project_id_str)\n    end\n  end\n\n  def name\n    description_name\n  end\n\n  def goal\n    description_goal\n  end\nend\n\n\napp/models/view\n\u30c9\u30e1\u30a4\u30f3\u306e\u72b6\u614b\u3092\u8868\u793a\u3059\u308b\u3068\u304d\u306f\u3001\u3053\u306eapp/models/view\u4ee5\u4e0b\u306e\u30e2\u30c7\u30eb\u3092\u76f4\u63a5\u53d6\u5f97\u3057\u307e\u3059\u3002\nclass BoardsController < ApplicationController\n  layout 'board'\n\n  def show\n    @stats = View::Stats.build(params[:project_id_str], [:backlogs, :ships])\n    @board = View::Board.build(params[:project_id_str])\n    if @board.header.phases.any?\n      render :show\n    else\n      render :bootstrap\n    end\n  end\nend\n\nmodule View\n  Board = Struct.new(:project_id_str, :project_name, :header, :body) do\n    class << self\n\n      def build(project_id_str)\n        project_with_workflow = ProjectRecord.with_workflow(project_id_str)\n\n        new(\n          project_id_str,\n          project_with_workflow.description_name,\n          header(project_with_workflow),\n          body(project_id_str)\n        )\n      end\n\n      private\n\n        def header(project_with_workflow)\n          View::BoardHeader.build(\n            project_with_workflow.project_id_str,\n            project_with_workflow.phase_spec_records.to_a,\n            project_with_workflow.state_records.to_a\n          )\n        end\n\n        def body(project_id_str)\n          cards = CardRecord.with_feature(project_id_str)\n          View::BoardBody.build(project_id_str, cards)\n        end\n    end\n\n    def step_size\n      header.phase_states.size\n    end\n  end\nend\n\n\u30c9\u30e1\u30a4\u30f3\u30e2\u30c7\u30eb\uff08Command\u30e2\u30c7\u30eb\uff09\u3068\u306f\u9055\u3044\u3001\n\u30c7\u30fc\u30bf\u306e\u554f\u3044\u5408\u308f\u305b\u306e\u305f\u3081\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u591a\u6570\u6301\u3063\u3066\u3044\u305f\u308a\n\u8907\u6570\u306e\u96c6\u7d04\u306b\u307e\u305f\u304c\u3063\u305f\u30c7\u30fc\u30bf\u3092\u30011\u7b87\u6240\u3067\u4fdd\u6301\u3057\u3066\u3044\u308b\u306e\u304c\u7279\u5fb4\u3067\u3059\u3002\n\napp/services\n\u30ec\u30a4\u30e4\u30fc\u30c9\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u5c64\u306e\u30b5\u30fc\u30d3\u30b9\u3067\u3059\u3002\n\u203b\u30c9\u30e1\u30a4\u30f3\u30b5\u30fc\u30d3\u30b9\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\u30c9\u30e1\u30a4\u30f3\u306e\u77e5\u8b58\u306f\u6301\u3063\u3066\u3044\u307e\u305b\u3093\u304c\u3001\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\u3092\u5b9f\u73fe\u3059\u308b\u305f\u3081\u306e\u51e6\u7406\u3092\u884c\u3044\u307e\u3059\u3002\nclass BoardService\n\n  def initialize(project_repository, board_repository, development_tracker)\n    @project_repository = project_repository\n    @board_repository = board_repository\n    @development_tracker = development_tracker\n  end\n\n  def add_card(project_id, feature_id)\n    EventPublisher.subscribe(@development_tracker)\n\n    project = @project_repository.find(project_id)\n    board = @board_repository.find(project_id)\n\n    action = Kanban::AddCard.new(feature_id, project.workflow)\n    board.update_by(action)\n\n    @board_repository.store(board)\n  end\n\n  def forward_card(project_id, feature_id, current_step)\n    EventPublisher.subscribe(@development_tracker)\n\n    board = @board_repository.find(project_id)\n    project = @project_repository.find(project_id)\n\n    action = Kanban::Actions.detect(feature_id, current_step, project.workflow)\n    board.update_by(action)\n\n    @board_repository.store(board)\n  end\nend\n\n\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u306b\u30ea\u30dd\u30b8\u30c8\u30ea\u3084\u30c9\u30e1\u30a4\u30f3\u30b5\u30fc\u30d3\u30b9\u3092\u6e21\u3057\u307e\u3059\u3002\n\u5fc5\u8981\u3067\u3042\u308c\u3070\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u3092\u7ba1\u7406\u3057\u307e\u3059\u3002\n\n\u307e\u3068\u3081\n\nRails\u3067\u3082DDD\u306f\u3067\u304d\u308b\n\u305f\u3060\u3057O/R\u30de\u30c3\u30d1\u30fc\u306f\u5de5\u592b\u304c\u5fc5\u8981\n\n\n\nrom\u3084Lotus::Model\u3082\u4f7f\u3048\u305d\u3046\n\n\n\u6700\u3082\u91cd\u8981\u306a\u306e\u306fdomain\u306b\u3044\u3044\u30e2\u30c7\u30eb\u3092\u4f5c\u308b\u3053\u3068\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2015-10-16 23.52.59.png](https://qiita-image-store.s3.amazonaws.com/0/38472/eb9a4aeb-14f9-2749-b43e-86f7761b2055.png)\n\n\u300c\u304b\u3093\u3070\u3093\u300d\u3092\u3001DDD\u3067\u8a2d\u8a08\u3057Rails\u3067\u5b9f\u88c5\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n[kanban_core_extension](https://github.com/haazime/kanban_core_extension)\n\n\u73fe\u6642\u70b9\u3067\u306f\u3001\u6700\u5c0f\u9650\u306e\u6a5f\u80fd\u3057\u304b\u3042\u308a\u307e\u305b\u3093\u304c\n\u30c9\u30e1\u30a4\u30f3\u99c6\u52d5\u8a2d\u8a08\u3092Rails\u3067\u5b9f\u88c5\u3059\u308b\u969b\u306e\u4e00\u4f8b\u3068\u3057\u3066\u53c2\u8003\u306b\u306a\u308c\u3070\u5e78\u3044\u3067\u3059\u3002\n\n## \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u6a5f\u80fd\n\n- \u958b\u767a\u3059\u308b\u30d5\u30a3\u30fc\u30c1\u30e3\uff08\u30bf\u30b9\u30af\uff09\u3092\u30ab\u30fc\u30c9\u3067\u8868\u73fe\u3057\u3001\u9032\u6357\u72b6\u6cc1\u3092\u304b\u3093\u3070\u3093\u30dc\u30fc\u30c9\u3067\u53ef\u8996\u5316\u3059\u308b\n- \u30ab\u30fc\u30c9\u3092\u6b21\u306e\u30d5\u30a7\u30fc\u30ba\uff08\u9032\u6357\u306e\u533a\u5207\u308a\uff09\u306b\u9032\u3081\u308b\u6642\u306bWIP\u5236\u9650\u3092\u30c1\u30a7\u30c3\u30af\u3059\u308b\n\n## \u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u30b9\u30bf\u30a4\u30eb\n\nEvent Sourcing\u306a\u3057\u306eCQRS\u3067\u3059\u3002\n\n\u5909\u66f4\uff08Command\uff09\u306e\u6642\u3060\u3051\u30c9\u30e1\u30a4\u30f3\u30e2\u30c7\u30eb\u3092\u4f7f\u3044\u307e\u3059\u3002\n\u554f\u3044\u5408\u308f\u305b\uff08Query\uff09\u3067\u306f\u3001\u5fc5\u8981\u306a\u30c7\u30fc\u30bf\u3092\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u304b\u3089\u76f4\u63a5\u53d6\u5f97\u3057\u307e\u3059\u3002\n**\u30ea\u30dd\u30b8\u30c8\u30ea**\u304b\u3089\u30c9\u30e1\u30a4\u30f3\u30e2\u30c7\u30eb\u3092\u53d6\u5f97\u3059\u308b\u3053\u3068\u306f\u3057\u307e\u305b\u3093\u3002\n\n\u53d6\u5f97\u3057\u305f\u30c7\u30fc\u30bf\u306f\u69cb\u9020\u5316\u3055\u308c\u305f\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3067\u3059\u304c\u3001\u30c9\u30e1\u30a4\u30f3\u30ed\u30b8\u30c3\u30af\u306f\u4e00\u5207\u6301\u305f\u306a\u3044\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\u30c9\u30e1\u30a4\u30f3\u30e2\u30c7\u30eb\u306b\u3001\u60c5\u5831\u306e\u53d6\u5f97\u3084UI\u306e\u305f\u3081\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u6301\u305f\u305b\u305a\u3001\u30c9\u30e1\u30a4\u30f3\u306b\u95a2\u3059\u308b\u632f\u308b\u821e\u3044\u306b\u96c6\u4e2d\u3055\u305b\u308b\u305f\u3081\u3067\u3059\u3002\n\n## \u69cb\u6210\n\n```text\n\u251c\u2500\u2500 Gemfile\n\u251c\u2500\u2500 Gemfile.lock\n\u251c\u2500\u2500 README.rdoc\n\u251c\u2500\u2500 Rakefile\n\u251c\u2500\u2500 app\n\u251c\u2500\u2500 bin\n\u251c\u2500\u2500 config\n\u251c\u2500\u2500 config.ru\n\u251c\u2500\u2500 db\n\u251c\u2500\u2500 domain (*)\n\u251c\u2500\u2500 lib\n\u251c\u2500\u2500 log\n\u251c\u2500\u2500 public\n\u251c\u2500\u2500 spec\n\u251c\u2500\u2500 tmp\n\u2514\u2500\u2500 vendor\n```\n\n`Rails.root`\u76f4\u4e0b\u306b`domain`\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304c\u3042\u308b\u4ee5\u5916\u306f\u901a\u5e38\u306eRails\u3068\u540c\u3058\u3067\u3059\u3002\n\n## domain\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\n\n```text\ndomain\n\u251c\u2500\u2500 activity\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 complete_state.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 end_phase_spec.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 no_state.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 no_transition.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 no_wip_limit.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 phase.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 phase_spec.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 phase_spec_builder.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 state.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 step.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 transition.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 transition_setted.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 wip_limit.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 workflow.rb\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 workflow_builder.rb\n\u251c\u2500\u2500 activity.rb\n\u251c\u2500\u2500 feature\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 backlog_service.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 description.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 development_tracker.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 feature.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 feature_id.rb\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 state.rb\n\u251c\u2500\u2500 feature.rb\n\u251c\u2500\u2500 kanban\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 actions.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 add_card.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 board.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 board_builder.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 board_maintainer.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 card.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 card_added.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 card_map.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 card_removed.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 pull_card.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 push_card.rb\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 remove_card.rb\n\u251c\u2500\u2500 kanban.rb\n\u251c\u2500\u2500 project\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 description.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 operations.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 project.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 project_factory.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 project_id.rb\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 project_launched.rb\n\u2514\u2500\u2500 project.rb\n```\n\n\u540d\u524d\u306e\u901a\u308a\u3001\u30e6\u30d3\u30ad\u30bf\u30b9\u8a00\u8a9e\u3092\u4f7f\u3063\u3066Ruby\u3067\u5b9f\u88c5\u3055\u308c\u305f\u30c9\u30e1\u30a4\u30f3\u30e2\u30c7\u30eb\u304c\u5165\u3063\u3066\u3044\u307e\u3059\u3002\n\u73fe\u6642\u70b9\u3067\u60f3\u5b9a\u3057\u3066\u3044\u308b\u3001**\u5883\u754c\u3065\u3051\u3089\u308c\u305f\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8**\u5185\u306b\u3042\u308b\u30e2\u30c7\u30eb\u3092\n\n- Activity\n- Feature\n- Kanban\n- Project\n\n\u306e4\u3064\u306e**\u30e2\u30b8\u30e5\u30fc\u30eb**\u306b\u307e\u3068\u3081\u3066\u3044\u307e\u3059\u3002\n\n- \u30a8\u30f3\u30c6\u30a3\u30c6\u30a3\uff08Entities\uff09\n- \u30d0\u30ea\u30e5\u30fc\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\uff08Value Objects\uff09\n- \u30b5\u30fc\u30d3\u30b9\uff08Domain Services\uff09\n- \u30c9\u30e1\u30a4\u30f3\u30a4\u30d9\u30f3\u30c8\uff08Domain Events\uff09\n\n\u3068\u3044\u3063\u305f\u6226\u8853\u7684\u30d1\u30bf\u30fc\u30f3\u306b\u3088\u308b\u5206\u985e\u306f\u3057\u3066\u3044\u307e\u305b\u3093\u3002\n\n## app\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\n\n```text\napp\n\u251c\u2500\u2500 assets\n\u251c\u2500\u2500 commands\n\u251c\u2500\u2500 controllers\n\u251c\u2500\u2500 forms\n\u251c\u2500\u2500 helpers\n\u251c\u2500\u2500 infrastructures\n\u251c\u2500\u2500 mailers\n\u251c\u2500\u2500 models\n\u2502\u00a0\u00a0  \u2514\u2500\u2500 view\n\u251c\u2500\u2500 repositories\n\u251c\u2500\u2500 services\n\u251c\u2500\u2500 validators\n\u2514\u2500\u2500 views\n```\n\n\u30c7\u30d5\u30a9\u30eb\u30c8\u306e`controllers`\u3001`models`\u3001`views`\u306a\u3069\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u4ed6\u306b\n\n- commands\n- infrastructures\n- repositories\n- models/view\n- services\n\n\u3053\u308c\u3089\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u8ffd\u52a0\u3057\u3066\u3044\u307e\u3059\u3002\n\n## app/commands\n\n**\u30ec\u30a4\u30e4\u30fc\u30c9\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3**\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u5c64\u306e\u4e00\u90e8\u3067\u3059\u3002\nUI\u5c64\u306eRails\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u3068\u3001\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u5c64\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d3\u30b9\u3092\u7e4b\u304e\u307e\u3059\u3002\n\n```rb\nclass FeaturesController < ApplicationController\n\n  def new\n    @command = AddFeatureCommand.new.tap do |c|\n      c.project_id_str = params[:project_id_str]\n    end\n  end\n\n  def create\n    @command = AddFeatureCommand.new(params[:add_feature_command])\n    if @command.execute(feature_service)\n      redirect_to backlog_url(@command.project_id_str), notice: 'Feature added to backlog!'\n    else\n      flash.now[:alert] = 'Ooops!'\n      render :new\n    end\n  end\nend\n```\n\n\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u306f\u3001HTTP\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u5143\u306b\u30b3\u30de\u30f3\u30c9\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u751f\u6210\u3057\u305f\u5f8c\n\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d3\u30b9\u3092\u30b3\u30de\u30f3\u30c9\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306b\u6e21\u3057\u3066\u5b9f\u884c\u3057\u307e\u3059\u3002\n\n```rb\nclass AddFeatureCommand\n  include ActiveModel::Model\n  include DomainObjectConversion\n\n  attr_accessor :project_id_str, :summary, :detail\n\n  validates :summary, presence: true\n  validates :detail, presence: true\n\n  def description\n    Feature::Description.new(summary, detail)\n  end\n\n  def execute(service)\n    return false unless valid?\n    service.add(project_id, description)\n  end\nend\n```\n\n\u30b3\u30de\u30f3\u30c9\u306f\u3001\n\n- \u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3068\u304d\u306b\u5fc5\u8981\u306a\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\n- \u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u30c9\u30e1\u30a4\u30f3\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3078\u306e\u5909\u63db\uff08\u4e3b\u306b**\u30d0\u30ea\u30e5\u30fc\u30aa\u30d6\u30b8\u30a7\u30af\u30c8**\u3078\u5909\u63db\u3059\u308b\uff09\n- \u81ea\u8eab\u306b\u5bfe\u5fdc\u3059\u308b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d3\u30b9\u306e\u547c\u3073\u51fa\u3057\n- \u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\n\n\u3092\u62c5\u5f53\u3057\u307e\u3059\u3002\n\n## app/infrastructures\n\n### Arize\n\n**\u96c6\u7d04\uff08Aggregates\uff09**\u3092\u69cb\u6210\u3059\u308b\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3068\u30ea\u30ec\u30fc\u30b7\u30e7\u30f3\uff08DB\u30ec\u30b3\u30fc\u30c9\uff09\u306e\u5909\u63db\u3092\u62c5\u5f53\u3057\u307e\u3059\u3002\nJava\u306a\u3069\u3067\u306f\u3001DataMapper\u30d1\u30bf\u30fc\u30f3\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u4f7f\u3063\u3066**\u30ea\u30dd\u30b8\u30c8\u30ea**\u306b\u5b9f\u88c5\u3059\u308b\u3053\u3068\u304c\u591a\u3044\u3068\u601d\u3044\u307e\u3059\u304c\u3001\n\u4eca\u56de\u306fRails\u6a19\u6e96\u306eActiveRecord\u3092\u4f7f\u3063\u3066\u3044\u307e\u3059\u3002\n\n\u305d\u306e\u5834\u5408\u3001\u30c9\u30e1\u30a4\u30f3\u30e2\u30c7\u30eb\u306e**\u30a8\u30f3\u30c6\u30a3\u30c6\u30a3**\u30af\u30e9\u30b9\u3092\u3001\u901a\u5e38\u306eRails\u30e2\u30c7\u30eb\u3068\u540c\u3058\u3088\u3046\u306b\u5b9f\u88c5\u3059\u308b\u3068\n\u30c9\u30e1\u30a4\u30f3\u306e\u632f\u308b\u821e\u3044\u3068\u3001\u30c7\u30fc\u30bf\u306b\u95a2\u3059\u308b\u632f\u308b\u821e\u3044\u304c\u6df7\u5728\u3057\u307e\u3059\u3002\n\n\u4eca\u56de\u306f\u7d50\u5c40\u3001\u30a8\u30f3\u30c6\u30a3\u30c6\u30a3\u30af\u30e9\u30b9\u306f`ActiveRecord::Base`\u3092\u7d99\u627f\u3057\u3066\u3044\u3066\n\u5b9f\u969b\u306b\u306f\u901a\u5e38\u306eRails\u30e2\u30c7\u30eb\u3068\u5909\u308f\u3089\u306a\u3044\u306e\u3067\u3059\u304c\n\u30b3\u30fc\u30c9\uff08\u30d5\u30a1\u30a4\u30eb\uff09\u3060\u3051\u3067\u3082\u3001\u30c9\u30e1\u30a4\u30f3\u306e\u632f\u308b\u821e\u3044\u3068\u30c7\u30fc\u30bf\u306b\u95a2\u3059\u308b\u632f\u308b\u821e\u3044\u3092\u5206\u96e2\u3055\u305b\u305f\u304b\u3063\u305f\u306e\u3067\n\u3053\u306e`app/infrastructures/arize`\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4ee5\u4e0b\u306b\u30e2\u30b8\u30e5\u30fc\u30eb\u3068\u3057\u3066\u5207\u308a\u51fa\u3057\u307e\u3057\u305f\u3002\n\n```rb\nmodule Arize\n  module Card\n    extend ActiveSupport::Concern\n\n    included do\n      self.table_name = 'card_records'\n\n      include Writers\n      include Readers\n    end\n\n    module Writers\n\n      def feature_id=(a_feature_id)\n        self.feature_id_str = a_feature_id.to_s\n      end\n\n      def step=(a_step)\n        self.step_phase_name = a_step.phase.to_s\n        self.step_state_name = serialize_state(a_step.state)\n      end\n\n      def serialize_state(state)\n        state.to_s\n      end\n    end\n\n    module Readers\n\n      def feature_id\n        ::Feature::FeatureId.new(feature_id_str)\n      end\n\n      def step\n        ::Project::Step.new(\n          build_phase(step_phase_name),\n          build_state(step_state_name)\n        )\n      end\n\n      def build_phase(phase)\n        ::Project::Phase.new(phase)\n      end\n\n      def build_state(state)\n        ::Project::State.from_string(state)\n      end\n    end\n  end\nend\n```\n\n\u901a\u5e38\u306eRails\u30e2\u30c7\u30eb\u3068\u9055\u3044\u3001\u30c6\u30fc\u30d6\u30eb\u540d\u306f\u30af\u30e9\u30b9\u540d\u306b`_records`\u63a5\u5c3e\u8f9e\u3092\u4ed8\u3051\u3066\u3044\u307e\u3059\u3002\n\n`Writers`\u3067`\u30c9\u30e1\u30a4\u30f3\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u304b\u3089\u30ab\u30e9\u30e0\u578b\u3078`\n`Readers`\u3067`\u30ab\u30e9\u30e0\u578b\u304b\u3089\u30c9\u30e1\u30a4\u30f3\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3078`\n\u5909\u63db\u3092\u884c\u3044\u307e\u3059\u3002\n\n```rb\nmodule Kanban\n  class Card < ActiveRecord::Base\n    include Arize::Card\n\n    def self.write(feature_id)\n      new.tap do |card|\n        card.feature_id = feature_id\n      end\n    end\n\n    def relocate(to)\n      self.step = to\n    end\n\n    def ==(other)\n      if other.instance_of?(self.class)\n        self.feature_id == other.feature_id\n      else\n        self.feature_id == other\n      end\n    end\n  end\nend\n```\n\n\u30c9\u30e1\u30a4\u30f3\u30e2\u30c7\u30eb\u306e`Kanban::Card`\u30af\u30e9\u30b9\u306f\u3053\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\u30c9\u30e1\u30a4\u30f3\u306b\u95a2\u3059\u308b\u632f\u308b\u821e\u3044\u306e\u307f\u3067\u3059\u3002\n\n### event_publisher.rb\n\n[Wisper](https://github.com/krisleech/wisper)\u306e\u30e9\u30c3\u30d1\u30fc\u3067\u3059\u3002\n\u30c9\u30e1\u30a4\u30f3\u30a4\u30d9\u30f3\u30c8\u306epublish/subscribe\u3092\u6271\u3044\u307e\u3059\u3002\n\n## app/repositories\n\n**\u30ea\u30dd\u30b8\u30c8\u30ea**\u306e\u5b9f\u88c5\u3067\u3059\u3002\n1\u3064\u306e**\u96c6\u7d04**\u306b1\u3064\u306e**\u30ea\u30dd\u30b8\u30c8\u30ea**\u304c\u5bfe\u5fdc\u3057\u307e\u3059\u3002\n\n```rb\nclass BoardRepository\n\n  def find(project_id)\n    Kanban::Board\n      .includes(:cards)\n      .find_by(project_id_str: project_id.to_s)\n  end\n\n  def store(board)\n    board.save!\n  end\nend\n```\n\n\u30c9\u30e1\u30a4\u30f3\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306b\u4f55\u3089\u304b\u306e\u5909\u66f4\u3092\u3057\u305f\u3044\u3068\u304d\u306e\u307f**\u30ea\u30dd\u30b8\u30c8\u30ea**\u3092\u4f7f\u3044\u307e\u3059\u3002\n\u3057\u305f\u304c\u3063\u3066\u3001\u30e1\u30bd\u30c3\u30c9\u306f`find`\u3068`store`\u3060\u3051\u3067\u3059\u3002\n\n**\u96c6\u7d04**\u306e\u30eb\u30fc\u30c8\u30a8\u30f3\u30c6\u30a3\u30c6\u30a3\u306f`ActiveRecord::Base`\u3092\u7d99\u627f\u3057\u3066\u3044\u307e\u3059\u306e\u3067\n\u901a\u5e38\u306eRails\u30e2\u30c7\u30eb\u3068\u540c\u3058\u3088\u3046\u306b\u6271\u3048\u307e\u3059\u3002\n\n## app/models\n\n\u901a\u5e38\u306eRails\u30e2\u30c7\u30eb\u3067\u3059\u304c\u3001\u7528\u9014\u306fView\u5c02\u7528\u3067\u3059\u3002\n\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u3084\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u306a\u3069\u306f\u4e00\u5207\u884c\u3044\u307e\u305b\u3093\u3002\n\n```rb\nclass ProjectRecord < ActiveRecord::Base\n  has_many :phase_spec_records, -> { order(:order) }\n  has_many :state_records, -> { order(:order) }\n\n  class << self\n\n    def with_workflow(project_id_str)\n      eager_load(:phase_spec_records, :state_records)\n        .find_by(project_id_str: project_id_str)\n    end\n  end\n\n  def name\n    description_name\n  end\n\n  def goal\n    description_goal\n  end\nend\n```\n\n## app/models/view\n\n\u30c9\u30e1\u30a4\u30f3\u306e\u72b6\u614b\u3092\u8868\u793a\u3059\u308b\u3068\u304d\u306f\u3001\u3053\u306e`app/models/view`\u4ee5\u4e0b\u306e\u30e2\u30c7\u30eb\u3092\u76f4\u63a5\u53d6\u5f97\u3057\u307e\u3059\u3002\n\n```rb\nclass BoardsController < ApplicationController\n  layout 'board'\n\n  def show\n    @stats = View::Stats.build(params[:project_id_str], [:backlogs, :ships])\n    @board = View::Board.build(params[:project_id_str])\n    if @board.header.phases.any?\n      render :show\n    else\n      render :bootstrap\n    end\n  end\nend\n```\n\n```rb\nmodule View\n  Board = Struct.new(:project_id_str, :project_name, :header, :body) do\n    class << self\n\n      def build(project_id_str)\n        project_with_workflow = ProjectRecord.with_workflow(project_id_str)\n\n        new(\n          project_id_str,\n          project_with_workflow.description_name,\n          header(project_with_workflow),\n          body(project_id_str)\n        )\n      end\n\n      private\n\n        def header(project_with_workflow)\n          View::BoardHeader.build(\n            project_with_workflow.project_id_str,\n            project_with_workflow.phase_spec_records.to_a,\n            project_with_workflow.state_records.to_a\n          )\n        end\n\n        def body(project_id_str)\n          cards = CardRecord.with_feature(project_id_str)\n          View::BoardBody.build(project_id_str, cards)\n        end\n    end\n\n    def step_size\n      header.phase_states.size\n    end\n  end\nend\n```\n\n\u30c9\u30e1\u30a4\u30f3\u30e2\u30c7\u30eb\uff08Command\u30e2\u30c7\u30eb\uff09\u3068\u306f\u9055\u3044\u3001\n\u30c7\u30fc\u30bf\u306e\u554f\u3044\u5408\u308f\u305b\u306e\u305f\u3081\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u591a\u6570\u6301\u3063\u3066\u3044\u305f\u308a\n\u8907\u6570\u306e**\u96c6\u7d04**\u306b\u307e\u305f\u304c\u3063\u305f\u30c7\u30fc\u30bf\u3092\u30011\u7b87\u6240\u3067\u4fdd\u6301\u3057\u3066\u3044\u308b\u306e\u304c\u7279\u5fb4\u3067\u3059\u3002\n\n## app/services\n\n**\u30ec\u30a4\u30e4\u30fc\u30c9\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3**\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u5c64\u306e\u30b5\u30fc\u30d3\u30b9\u3067\u3059\u3002\n\u203b\u30c9\u30e1\u30a4\u30f3\u30b5\u30fc\u30d3\u30b9\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\n\u30c9\u30e1\u30a4\u30f3\u306e\u77e5\u8b58\u306f\u6301\u3063\u3066\u3044\u307e\u305b\u3093\u304c\u3001\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\u3092\u5b9f\u73fe\u3059\u308b\u305f\u3081\u306e\u51e6\u7406\u3092\u884c\u3044\u307e\u3059\u3002\n\n```rb\nclass BoardService\n\n  def initialize(project_repository, board_repository, development_tracker)\n    @project_repository = project_repository\n    @board_repository = board_repository\n    @development_tracker = development_tracker\n  end\n\n  def add_card(project_id, feature_id)\n    EventPublisher.subscribe(@development_tracker)\n\n    project = @project_repository.find(project_id)\n    board = @board_repository.find(project_id)\n\n    action = Kanban::AddCard.new(feature_id, project.workflow)\n    board.update_by(action)\n\n    @board_repository.store(board)\n  end\n\n  def forward_card(project_id, feature_id, current_step)\n    EventPublisher.subscribe(@development_tracker)\n\n    board = @board_repository.find(project_id)\n    project = @project_repository.find(project_id)\n\n    action = Kanban::Actions.detect(feature_id, current_step, project.workflow)\n    board.update_by(action)\n\n    @board_repository.store(board)\n  end\nend\n```\n\n\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u306b**\u30ea\u30dd\u30b8\u30c8\u30ea**\u3084**\u30c9\u30e1\u30a4\u30f3\u30b5\u30fc\u30d3\u30b9**\u3092\u6e21\u3057\u307e\u3059\u3002\n\u5fc5\u8981\u3067\u3042\u308c\u3070\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u3092\u7ba1\u7406\u3057\u307e\u3059\u3002\n\n## \u307e\u3068\u3081\n\n- Rails\u3067\u3082DDD\u306f\u3067\u304d\u308b\n- \u305f\u3060\u3057O/R\u30de\u30c3\u30d1\u30fc\u306f\u5de5\u592b\u304c\u5fc5\u8981\n - [rom](http://rom-rb.org/)\u3084[Lotus::Model](https://github.com/lotus/model)\u3082\u4f7f\u3048\u305d\u3046\n- \u6700\u3082\u91cd\u8981\u306a\u306e\u306fdomain\u306b\u3044\u3044\u30e2\u30c7\u30eb\u3092\u4f5c\u308b\u3053\u3068\n", "tags": ["Rails", "DDD", "\u30c9\u30e1\u30a4\u30f3\u99c6\u52d5\u8a2d\u8a08"]}