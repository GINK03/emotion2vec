{"context": "CircleCI\u306e\u30d3\u30eb\u30c9\u7d50\u679c\u3092\u53d7\u3051\u53d6\u3063\u3066Slack\u306b\u901a\u77e5\u3057\u3066\u305f\u81ea\u524d\u306eHubot\u306eHeroku\u306edynos\u304c\u5207\u308c\u305f\u306e\u3067\u3001Heroku\u3092\u5e74\u672b\u306e\u5927\u6383\u9664\u3057\u3066GAS\u306b\u79fb\u884c\u3057\u305f\u8a71\u3067\u3059\u3002\n\nHTTP\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u53d7\u3051\u53d6\u308a\nCircleCi\u304b\u3089\u306fPost\u3067\u3053\u3046\u3044\u3046json\u3092\u53d7\u3051\u53d6\u308b\u3068\u3057\u307e\u3059\u3002\n{\n  \"payload\": {\n    \"vcs_url\" : \"https://github.com/circleci/mongofinil\",\n    \"build_url\" : \"https://circleci.com/gh/circleci/mongofinil/22\",\n    \"build_num\" : 22,\n    \"branch\" : \"master\",\n    ...\n  }\n}\n\nHubot\u306b\u306frouter\u3068\u3044\u3046HTTP\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u53d7\u3051\u53d6\u308b\u6a5f\u69cb\u304c\u3042\u308a\u307e\u3059\u304c\u3001\n\u4f8b\n* https://ota42y.com/blog/2014/08/29/hubot-post-server/\n* http://qiita.com/bouzuya/items/8e8ee8e2e8f83513ad35\n* http://int128.hatenablog.com/entry/2015/11/14/162217\n\u3053\u308c\u3092GAS\u3067\u4ee3\u7528\u3059\u308b\u3068\u3053\u3046\u306a\u308a\u307e\u3059\n\nParameterClass.js\nexport class ParameterClass {\n  constructor(e) {\n    const req = JSON.parse(e.postData.contents);\n    const payload  = req.payload;\n    this.status    = payload.status;\n    this.subject   = payload.subject;\n    this.build_url = payload.build_url;\n    this.branch    = payload.branch;\n    this.reponame  = payload.reponame;\n    this.username  = payload.username;\n  }\n\n  returnParams() {\n    return {\n      status:    this.status,\n      subject:   this.subject,\n      build_url: this.build_url,\n      branch:    this.branch,\n      reponame:  this.reponame,\n      username:  this.username\n    }\n  }\n}\n\n\n\nSlack\u3078\u306e\u901a\u77e5\nHubot\u904b\u7528\u6642\u306b\u306fSlack\u306eHubot\u306eintegration\u3092\u4f7f\u3063\u3066\u307e\u3057\u305f\u304c\u3001GAS\u3078\u306e\u79fb\u884c\u306b\u4f34\u3044incomming webhook\u306b\u5909\u3048\u307e\u3057\u305f\u3002\u4ee5\u4e0b\u306fincomming webhook\u306bpost\u3059\u308b\u30af\u30e9\u30b9\u3067\u3059\u3002\n\nPostClass.js\nexport class PostClass {\n  constructor(e) {\n    this.webhookUrl = \"webhook\u306eurl\";\n    this.params = e;\n  }\n\n  createPost() {\n    const value = `${this.params.subject}\\n` +\n      `CircleCI: ${this.params.build_url}` +\n      `branch: ${this.params.branch}`\n    const status = (this.params.status == 'failed') ? '#D00000':'#36a64f';\n    const payload = {\n      \"attachments\": [\n        {\n          \"fallback\": \"\u30cf\u30e9\u30b7\u30e7\u30fc\uff01\u30d3\u30eb\u30c9\u6210\u529f\uff01\",\n          \"pretext\": \"\u30cf\u30e9\u30b7\u30e7\u30fc\uff01\u30d3\u30eb\u30c9\u6210\u529f\uff01\",\n          \"color\":   status,\n          \"fields\": [\n            {\n              \"title\": this.params.username + \"\u3001\u30de\u30b9\u30bf\u30fc\u306b\u30de\u30fc\u30b8\u3057\u3066\u30c7\u30d7\u30ed\u30a4\u3057\u3066\u306d\u266a\",\n              \"value\": value,\n              \"short\": false\n            }\n          ]\n        }\n      ]\n    };\n    const options = {\n      \"method\": \"post\",\n      \"payload\": JSON.stringify(payload),\n      \"contentType\": \"application/json\"\n    };\n    UrlFetchApp.fetch(this.webhookUrl, options);\n  }\n\n\n\n\u3061\u306a\u307f\u306bPost\u5b9f\u884c\u3092axios\u3067\u3084\u308d\u3046\u3068\u8a66\u307f\u307e\u3057\u305f\u304c\u5931\u6557\u3057\u307e\u3057\u305f\u3002JavaScript\u306e\u5b9f\u884c\u3092\u30d6\u30e9\u30a6\u30b6\u3067\u306a\u304fGoogle\u306e\u30b5\u30fc\u30d0\u30fc\u5185\u3067\u884c\u3046\u305f\u3081\u3001\u3069\u3046\u3082GAS\u3067\u306f\u4e00\u822c\u306b\u4f7f\u308f\u308c\u308b\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u4e00\u90e8\u4f7f\u3048\u306a\u3044\u307f\u305f\u3044\u3067\u3059\u3002\n\n\u4e0a\u306e\u4e8c\u3064\u306e\u6a5f\u80fd\u3092bundle\u3057\u3066\u5b9f\u884c\u3059\u308b\n\u4e0a\u306e\u4e8c\u3064\u306e\u30af\u30e9\u30b9\u3092bundle\u3057\u3066\u4e00\u3064\u306e\u30d5\u30a1\u30a4\u30eb\u306b\u3057\u3066\u3001GAS\u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3057\u307e\u3059\u3002\n\nmain.js\nimport {ParameterClass} from './ParameterClass';\nimport {PostClass} from './PostClass';\n\nglobal.doPost = function(e) {\n  const parameterClass = new ParameterClass(e);\n  const params         = parameterClass.returnParams();\n  const postClass      = new PostClass(params);\n  postClass.createPost();\n}\n\n\n\nbrowserify -t babelify -p gasify ./main.js -o ./src/code.js\u3092\u5b9f\u884c\u3057\u3001code.js\u3092GAS\u306b\u3042\u3052\u3066\u304f\u3060\u3055\u3044\u3002\n\u52d5\u304b\u3057\u3066\u307f\u308b\u3068\u3053\u3046\u3044\u3046\u611f\u3058\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u30e1\u30c3\u30bb\u30fc\u30b8\u306e\u5185\u5bb9\u306f\u81ea\u5206\u597d\u307f\u306b\u3088\u3057\u306a\u306b\u5909\u3048\u3061\u3083\u3063\u3066\u304f\u3060\u3055\u3044\u3002\n\u307e\u305f\u4eca\u56deGAS\u306b\u30a2\u30d7\u30ed\u30fc\u30c9\u3059\u308b\u65b9\u6cd5\u3092\u8aac\u660e\u3057\u3066\u3044\u306a\u3044\u306e\u3067\u3001\u305d\u308c\u306f\u3053\u308c\u3092\u53c2\u8003\u306b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u53c2\u8003\u6587\u732e\n\nCircleCI notification\nCircleCI\u306e\u30d3\u30eb\u30c9\u7d50\u679c\u3092Slack\u306e\u30c0\u30a4\u30ec\u30af\u30c8\u30e1\u30c3\u30bb\u30fc\u30b8\u306b\u9001\u4fe1\u3059\u308b\nCircleCI\u3067\u30c8\u30d4\u30c3\u30af\u30d6\u30e9\u30f3\u30c1\u306e\u30d3\u30eb\u30c9\u306f\u5931\u6557/\u5fa9\u65e7\u6642\u3060\u3051\u901a\u77e5\u3001\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u30d6\u30e9\u30f3\u30c1\u306e\u30d3\u30eb\u30c9\u306f\u5168\u901a\u77e5\u3059\u308b\nGoogle Apps Script\u306e\u958b\u767a\u3092\u30e2\u30c0\u30f3\u306b\u884c\u3046\u65b9\u6cd5\n\u53d7\u3051\u53d6\u3063\u305fPOST\u30c7\u30fc\u30bf\u3092\u30c1\u30e3\u30c3\u30c8\u306b\u9001\u4fe1\u3059\u308bHubot\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u4f5c\u3063\u305f\nHubot \u3067\u30db\u30fc\u30e0\u30da\u30fc\u30b8\u3092\u3064\u304f\u308d\u3046\nHubot\u3067WebHook\u306eHTTP\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u53d7\u3051\u53d6\u308b\n\nCircleCI\u306e\u30d3\u30eb\u30c9\u7d50\u679c\u3092\u53d7\u3051\u53d6\u3063\u3066Slack\u306b\u901a\u77e5\u3057\u3066\u305f\u81ea\u524d\u306eHubot\u306eHeroku\u306edynos\u304c\u5207\u308c\u305f\u306e\u3067\u3001Heroku\u3092\u5e74\u672b\u306e\u5927\u6383\u9664\u3057\u3066GAS\u306b\u79fb\u884c\u3057\u305f\u8a71\u3067\u3059\u3002\n\n## HTTP\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u53d7\u3051\u53d6\u308a\n\nCircleCi\u304b\u3089\u306f[Post\u3067\u3053\u3046\u3044\u3046json\u3092\u53d7\u3051\u53d6\u308b](https://circleci.com/docs/configuration/#notify)\u3068\u3057\u307e\u3059\u3002\n\n```\n{\n  \"payload\": {\n    \"vcs_url\" : \"https://github.com/circleci/mongofinil\",\n    \"build_url\" : \"https://circleci.com/gh/circleci/mongofinil/22\",\n    \"build_num\" : 22,\n    \"branch\" : \"master\",\n    ...\n  }\n}\n```\n\nHubot\u306b\u306frouter\u3068\u3044\u3046HTTP\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u53d7\u3051\u53d6\u308b\u6a5f\u69cb\u304c\u3042\u308a\u307e\u3059\u304c\u3001\n\n\u4f8b\n* https://ota42y.com/blog/2014/08/29/hubot-post-server/\n* http://qiita.com/bouzuya/items/8e8ee8e2e8f83513ad35\n* http://int128.hatenablog.com/entry/2015/11/14/162217\n\n\u3053\u308c\u3092GAS\u3067\u4ee3\u7528\u3059\u308b\u3068\u3053\u3046\u306a\u308a\u307e\u3059\n\n```ParameterClass.js\nexport class ParameterClass {\n  constructor(e) {\n    const req = JSON.parse(e.postData.contents);\n    const payload  = req.payload;\n    this.status    = payload.status;\n    this.subject   = payload.subject;\n    this.build_url = payload.build_url;\n    this.branch    = payload.branch;\n    this.reponame  = payload.reponame;\n    this.username  = payload.username;\n  }\n\n  returnParams() {\n    return {\n      status:    this.status,\n      subject:   this.subject,\n      build_url: this.build_url,\n      branch:    this.branch,\n      reponame:  this.reponame,\n      username:  this.username\n    }\n  }\n}\n```\n\n## Slack\u3078\u306e\u901a\u77e5\n\nHubot\u904b\u7528\u6642\u306b\u306fSlack\u306eHubot\u306eintegration\u3092\u4f7f\u3063\u3066\u307e\u3057\u305f\u304c\u3001GAS\u3078\u306e\u79fb\u884c\u306b\u4f34\u3044incomming webhook\u306b\u5909\u3048\u307e\u3057\u305f\u3002\u4ee5\u4e0b\u306fincomming webhook\u306bpost\u3059\u308b\u30af\u30e9\u30b9\u3067\u3059\u3002\n\n```PostClass.js\nexport class PostClass {\n  constructor(e) {\n    this.webhookUrl = \"webhook\u306eurl\";\n    this.params = e;\n  }\n\n  createPost() {\n    const value = `${this.params.subject}\\n` +\n      `CircleCI: ${this.params.build_url}` +\n      `branch: ${this.params.branch}`\n    const status = (this.params.status == 'failed') ? '#D00000':'#36a64f';\n    const payload = {\n      \"attachments\": [\n        {\n          \"fallback\": \"\u30cf\u30e9\u30b7\u30e7\u30fc\uff01\u30d3\u30eb\u30c9\u6210\u529f\uff01\",\n          \"pretext\": \"\u30cf\u30e9\u30b7\u30e7\u30fc\uff01\u30d3\u30eb\u30c9\u6210\u529f\uff01\",\n          \"color\":   status,\n          \"fields\": [\n            {\n              \"title\": this.params.username + \"\u3001\u30de\u30b9\u30bf\u30fc\u306b\u30de\u30fc\u30b8\u3057\u3066\u30c7\u30d7\u30ed\u30a4\u3057\u3066\u306d\u266a\",\n              \"value\": value,\n              \"short\": false\n            }\n          ]\n        }\n      ]\n    };\n    const options = {\n      \"method\": \"post\",\n      \"payload\": JSON.stringify(payload),\n      \"contentType\": \"application/json\"\n    };\n    UrlFetchApp.fetch(this.webhookUrl, options);\n  }\n\n```\n\n\u3061\u306a\u307f\u306bPost\u5b9f\u884c\u3092axios\u3067\u3084\u308d\u3046\u3068\u8a66\u307f\u307e\u3057\u305f\u304c\u5931\u6557\u3057\u307e\u3057\u305f\u3002JavaScript\u306e\u5b9f\u884c\u3092\u30d6\u30e9\u30a6\u30b6\u3067\u306a\u304fGoogle\u306e\u30b5\u30fc\u30d0\u30fc\u5185\u3067\u884c\u3046\u305f\u3081\u3001\u3069\u3046\u3082GAS\u3067\u306f\u4e00\u822c\u306b\u4f7f\u308f\u308c\u308b\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u4e00\u90e8\u4f7f\u3048\u306a\u3044\u307f\u305f\u3044\u3067\u3059\u3002\n\n## \u4e0a\u306e\u4e8c\u3064\u306e\u6a5f\u80fd\u3092bundle\u3057\u3066\u5b9f\u884c\u3059\u308b\n\n\u4e0a\u306e\u4e8c\u3064\u306e\u30af\u30e9\u30b9\u3092bundle\u3057\u3066\u4e00\u3064\u306e\u30d5\u30a1\u30a4\u30eb\u306b\u3057\u3066\u3001GAS\u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3057\u307e\u3059\u3002\n\n```main.js\nimport {ParameterClass} from './ParameterClass';\nimport {PostClass} from './PostClass';\n\nglobal.doPost = function(e) {\n  const parameterClass = new ParameterClass(e);\n  const params         = parameterClass.returnParams();\n  const postClass      = new PostClass(params);\n  postClass.createPost();\n}\n\n```\n\n`browserify -t babelify -p gasify ./main.js -o ./src/code.js`\u3092\u5b9f\u884c\u3057\u3001code.js\u3092GAS\u306b\u3042\u3052\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u52d5\u304b\u3057\u3066\u307f\u308b\u3068\u3053\u3046\u3044\u3046\u611f\u3058\u306b\u306a\u308a\u307e\u3059\u3002\n<img width=\"722\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2017-01-04 17.50.16.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/68020/0c101558-53e1-b12f-cc0c-2c31c85ff659.png\">\n\n\u30e1\u30c3\u30bb\u30fc\u30b8\u306e\u5185\u5bb9\u306f\u81ea\u5206\u597d\u307f\u306b\u3088\u3057\u306a\u306b\u5909\u3048\u3061\u3083\u3063\u3066\u304f\u3060\u3055\u3044\u3002\n\u307e\u305f\u4eca\u56deGAS\u306b\u30a2\u30d7\u30ed\u30fc\u30c9\u3059\u308b\u65b9\u6cd5\u3092\u8aac\u660e\u3057\u3066\u3044\u306a\u3044\u306e\u3067\u3001\u305d\u308c\u306f[\u3053\u308c](http://technica-blog.jp/entry/2016/04/28/190236)\u3092\u53c2\u8003\u306b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n## \u53c2\u8003\u6587\u732e\n* [CircleCI notification](https://circleci.com/docs/configuration/#notify)\n* [CircleCI\u306e\u30d3\u30eb\u30c9\u7d50\u679c\u3092Slack\u306e\u30c0\u30a4\u30ec\u30af\u30c8\u30e1\u30c3\u30bb\u30fc\u30b8\u306b\u9001\u4fe1\u3059\u308b](http://blog.excite.co.jp/exdev/26496823/)\n* [CircleCI\u3067\u30c8\u30d4\u30c3\u30af\u30d6\u30e9\u30f3\u30c1\u306e\u30d3\u30eb\u30c9\u306f\u5931\u6557/\u5fa9\u65e7\u6642\u3060\u3051\u901a\u77e5\u3001\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u30d6\u30e9\u30f3\u30c1\u306e\u30d3\u30eb\u30c9\u306f\u5168\u901a\u77e5\u3059\u308b](http://qiita.com/kkanazaw/items/bf44ec6d004d51a5236a)\n* [Google Apps Script\u306e\u958b\u767a\u3092\u30e2\u30c0\u30f3\u306b\u884c\u3046\u65b9\u6cd5](http://technica-blog.jp/entry/2016/04/28/190236)\n* [\u53d7\u3051\u53d6\u3063\u305fPOST\u30c7\u30fc\u30bf\u3092\u30c1\u30e3\u30c3\u30c8\u306b\u9001\u4fe1\u3059\u308bHubot\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u4f5c\u3063\u305f](https://ota42y.com/blog/2014/08/29/hubot-post-server/)\n* [Hubot \u3067\u30db\u30fc\u30e0\u30da\u30fc\u30b8\u3092\u3064\u304f\u308d\u3046](http://qiita.com/bouzuya/items/8e8ee8e2e8f83513ad35)\n* [Hubot\u3067WebHook\u306eHTTP\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u53d7\u3051\u53d6\u308b](http://int128.hatenablog.com/entry/2015/11/14/162217)\n", "tags": ["Hubot", "JavaScript", "GoogleAppsScript"]}