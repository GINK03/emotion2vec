{"tags": ["CentOS6.x"], "context": " More than 1 year has passed since last update.\n\n\u5909\u66f4\u3059\u308b\u756a\u53f7\u3092\u78ba\u8a8d\niptables -nL --line-numbers \n\n\u5909\u66f4\u3059\u308b\u5834\u5408\niptables -R INPUT [\u5909\u66f4\u3059\u308b\u756a\u53f7] -s [\u5909\u66f4\u3059\u308bIP] -p tcp --dport 22 -j ACCEPT\n\n\u524a\u9664\u3059\u308b\u5834\u5408\niptables -D INPUT [\u524a\u9664\u3059\u308b\u756a\u53f7]\n\n\u304a\u307e\u3051\niptables -A INPUT  -p [tcp|udp] -s [\u9001\u4fe1\u5143IP] --sport [\u9001\u4fe1\u5143\u30dd\u30fc\u30c8] -d [\u9001\u4fe1\u5148IP] --dport [\u9001\u4fe1\u5148\u30dd\u30fc\u30c8] -j [ACCEPT|DROP|REJECT]\n\n\u67d0\u56fd\u3092\u62d2\u5426\u3059\u308b\n\niptables.sh\n#!/bin/sh\n\nAPNIC_URL='http://ftp.apnic.net/stats/apnic/delegated-apnic-latest'\n\n#------------------------------------------\n# APNIC \u304b\u3089 CN \u3060\u3051\u62bd\u51fa\u3057\u7121\u6761\u4ef6\u3067DROP\n#------------------------------------------\nfunction drop_cn_iptables(){\n\n    echo \"\u30c7\u30fc\u30bf\u30fc\u53d6\u5f97\u4e2d: ${APNIC_URL}\"\n    if curl -s ${APNIC_URL} > /tmp/delegated-apnic-latest\n    then\n        echo \"iptables \u8a2d\u5b9a\u4e2d: \u3057\u3070\u3089\u304f\u6642\u9593\u304c\u304b\u304b\u308a\u307e\u3059\"\n        iptables -D INPUT -j DROP-CHINA > /dev/null 2>&1\n        iptables -F DROP-CHINA          > /dev/null 2>&1\n        iptables -X DROP-CHINA          > /dev/null 2>&1\n        iptables -N DROP-CHINA\n        COUNT=0\n        for i in $(awk -F'|' '$2~/CN/&&$3~/ipv4/{print $4\",\"$5}' /tmp/delegated-apnic-latest)\n        do\n            IP_LIST_1=$(echo $i | cut -d',' -f1)\n            IP_LIST_2=$(echo $i | cut -d',' -f2)\n            IP_CN_LIST=$(cider_calc $IP_LIST_1 $IP_LIST_2)\n\n            if [ ${IP_CN_LIST} != 'null' ];then\n                iptables -A DROP-CHINA -s ${IP_CN_LIST} -j DROP\n                echo_erase \"iptables -A DROP-CHINA -s ${IP_CN_LIST} -j DROP\"\n            fi\n\n        done\n        iptables -A DROP-CHINA -j RETURN\n        iptables -I INPUT 1    -j DROP-CHINA\n        iptables -nvxL\n        rm -rf /tmp/delegated-apnic-latest\n    else\n        echo \"\u30c7\u30fc\u30bf\u30fc\u53d6\u5f97\u5931\u6557:${APNIC_URL}\"\n        exit 1\n    fi\n}\n\n#------------------------------------------\n# iptables \u306e\u521d\u671f\u5316\n#------------------------------------------\nfunction init_cn_iptables(){\n\n    iptables -D INPUT -j DROP-CHINA\n    iptables -F DROP-CHINA\n    iptables -X DROP-CHINA\n    iptables -nvxL\n    echo -e '\\n==================================================\\n'\n    echo -e '\\n120\u79d2\u9593\u53cd\u5fdc\u304c\u306a\u304b\u3063\u305f\u305f\u3081iptables \u3092\u521d\u671f\u5316\u3057\u307e\u3057\u305f\\n'\n}\n\n#------------------------------------------\n# \u4fdd\u6709IP\u6570\u3088\u308aCIDER\u3092\u7b97\u51fa\n#------------------------------------------\nfunction cider_calc(){\n\n    local IP_ADDRESS_NUM=4294967296\n    local IP_ADDRESS=$1\n    local IP_NUM=$2\n    local IP_CIDER='null'\n\n    for i in $(seq 1 32)\n    do\n        IP_ADDRESS_NUM=$((${IP_ADDRESS_NUM}/2))\n        if [ $((IP_ADDRESS_NUM/IP_NUM)) -eq 1 -a $((IP_ADDRESS_NUM%IP_NUM)) -eq 0 ]; then\n            IP_CIDER=$i\n            break\n        fi\n    done\n\n    if [ $IP_CIDER = 'null' ];then\n        echo 'null'\n    else\n        echo \"$IP_ADDRESS/$IP_CIDER\"\n    fi\n}\n\n#------------------------------------------\n# \u6a19\u6e96\u51fa\u529b\u3092\u5236\u5fa1\u3059\u308b\u95a2\u6570\n#------------------------------------------\nfunction echo_erase(){\n\n    local STRING=\"$1\"\n    echo -n ${STRING}\n    for i in $(seq 0 ${#STRING})\n    do\n        echo -n $'\\b'\n    done\n}\n\n#------------------------------------------\n# iptables \u306e \u5b9f\u884c\n#------------------------------------------\ndrop_cn_iptables\necho -e '\\n==================================================\\n'\necho -e \"### \u8a2d\u5b9a\u5b8c\u4e86 ###\\n\"\necho -e '\u73fe\u5728\u306e\u8a2d\u5b9a\u3067\u554f\u984c\u304c\u306a\u3051\u308c\u3070120\u79d2\u4ee5\u5185\u306b\u300c Ctrl + c \u300d\u3067\u629c\u3051\u3066\u30bb\u30fc\u30d6\u3057\u3066\u4e0b\u3055\u3044\u3002\\n'\nsleep 120\ninit_cn_iptables\n\n\n# \u5909\u66f4\u3059\u308b\u756a\u53f7\u3092\u78ba\u8a8d\niptables -nL --line-numbers \n\n# \u5909\u66f4\u3059\u308b\u5834\u5408\niptables -R INPUT [\u5909\u66f4\u3059\u308b\u756a\u53f7] -s [\u5909\u66f4\u3059\u308bIP] -p tcp --dport 22 -j ACCEPT\n\n# \u524a\u9664\u3059\u308b\u5834\u5408\niptables -D INPUT [\u524a\u9664\u3059\u308b\u756a\u53f7]\n\n# \u304a\u307e\u3051\niptables -A INPUT  -p [tcp|udp] -s [\u9001\u4fe1\u5143IP] --sport [\u9001\u4fe1\u5143\u30dd\u30fc\u30c8] -d [\u9001\u4fe1\u5148IP] --dport [\u9001\u4fe1\u5148\u30dd\u30fc\u30c8] -j [ACCEPT|DROP|REJECT]\n\n#\u67d0\u56fd\u3092\u62d2\u5426\u3059\u308b\n```bash:iptables.sh\n#!/bin/sh\n\nAPNIC_URL='http://ftp.apnic.net/stats/apnic/delegated-apnic-latest'\n\n#------------------------------------------\n# APNIC \u304b\u3089 CN \u3060\u3051\u62bd\u51fa\u3057\u7121\u6761\u4ef6\u3067DROP\n#------------------------------------------\nfunction drop_cn_iptables(){\n\n    echo \"\u30c7\u30fc\u30bf\u30fc\u53d6\u5f97\u4e2d: ${APNIC_URL}\"\n    if curl -s ${APNIC_URL} > /tmp/delegated-apnic-latest\n    then\n        echo \"iptables \u8a2d\u5b9a\u4e2d: \u3057\u3070\u3089\u304f\u6642\u9593\u304c\u304b\u304b\u308a\u307e\u3059\"\n        iptables -D INPUT -j DROP-CHINA > /dev/null 2>&1\n        iptables -F DROP-CHINA          > /dev/null 2>&1\n        iptables -X DROP-CHINA          > /dev/null 2>&1\n        iptables -N DROP-CHINA\n        COUNT=0\n        for i in $(awk -F'|' '$2~/CN/&&$3~/ipv4/{print $4\",\"$5}' /tmp/delegated-apnic-latest)\n        do\n            IP_LIST_1=$(echo $i | cut -d',' -f1)\n            IP_LIST_2=$(echo $i | cut -d',' -f2)\n            IP_CN_LIST=$(cider_calc $IP_LIST_1 $IP_LIST_2)\n\n            if [ ${IP_CN_LIST} != 'null' ];then\n                iptables -A DROP-CHINA -s ${IP_CN_LIST} -j DROP\n                echo_erase \"iptables -A DROP-CHINA -s ${IP_CN_LIST} -j DROP\"\n            fi\n\n        done\n        iptables -A DROP-CHINA -j RETURN\n        iptables -I INPUT 1    -j DROP-CHINA\n        iptables -nvxL\n        rm -rf /tmp/delegated-apnic-latest\n    else\n        echo \"\u30c7\u30fc\u30bf\u30fc\u53d6\u5f97\u5931\u6557:${APNIC_URL}\"\n        exit 1\n    fi\n}\n\n#------------------------------------------\n# iptables \u306e\u521d\u671f\u5316\n#------------------------------------------\nfunction init_cn_iptables(){\n\n    iptables -D INPUT -j DROP-CHINA\n    iptables -F DROP-CHINA\n    iptables -X DROP-CHINA\n    iptables -nvxL\n    echo -e '\\n==================================================\\n'\n    echo -e '\\n120\u79d2\u9593\u53cd\u5fdc\u304c\u306a\u304b\u3063\u305f\u305f\u3081iptables \u3092\u521d\u671f\u5316\u3057\u307e\u3057\u305f\\n'\n}\n\n#------------------------------------------\n# \u4fdd\u6709IP\u6570\u3088\u308aCIDER\u3092\u7b97\u51fa\n#------------------------------------------\nfunction cider_calc(){\n\n    local IP_ADDRESS_NUM=4294967296\n    local IP_ADDRESS=$1\n    local IP_NUM=$2\n    local IP_CIDER='null'\n\n    for i in $(seq 1 32)\n    do\n        IP_ADDRESS_NUM=$((${IP_ADDRESS_NUM}/2))\n        if [ $((IP_ADDRESS_NUM/IP_NUM)) -eq 1 -a $((IP_ADDRESS_NUM%IP_NUM)) -eq 0 ]; then\n            IP_CIDER=$i\n            break\n        fi\n    done\n\n    if [ $IP_CIDER = 'null' ];then\n        echo 'null'\n    else\n        echo \"$IP_ADDRESS/$IP_CIDER\"\n    fi\n}\n\n#------------------------------------------\n# \u6a19\u6e96\u51fa\u529b\u3092\u5236\u5fa1\u3059\u308b\u95a2\u6570\n#------------------------------------------\nfunction echo_erase(){\n\n    local STRING=\"$1\"\n    echo -n ${STRING}\n    for i in $(seq 0 ${#STRING})\n    do\n        echo -n $'\\b'\n    done\n}\n\n#------------------------------------------\n# iptables \u306e \u5b9f\u884c\n#------------------------------------------\ndrop_cn_iptables\necho -e '\\n==================================================\\n'\necho -e \"### \u8a2d\u5b9a\u5b8c\u4e86 ###\\n\"\necho -e '\u73fe\u5728\u306e\u8a2d\u5b9a\u3067\u554f\u984c\u304c\u306a\u3051\u308c\u3070120\u79d2\u4ee5\u5185\u306b\u300c Ctrl + c \u300d\u3067\u629c\u3051\u3066\u30bb\u30fc\u30d6\u3057\u3066\u4e0b\u3055\u3044\u3002\\n'\nsleep 120\ninit_cn_iptables\n```"}