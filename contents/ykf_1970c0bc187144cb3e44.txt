{"context": " More than 1 year has passed since last update.\u3053\u306e\u8a18\u4e8b\u306fAWS Advent Calendar 2014\u306e23\u65e5\u76ee\u306e\u8a18\u4e8b\u3067\u3059\u3002\n\n\u306f\u3058\u3081\u306b\n\u307f\u306a\u3055\u3093opsworks\u4f7f\u3063\u3066\u3044\u307e\u3059\u304b\uff1f\n\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u3066\u3044\u308b\u30a2\u30d7\u30ea\uff08rails\u3060\u3068\u304bnode.js\u3060\u3068\u304b\uff09\u306e\u30c7\u30d7\u30ed\u30a4\u306f\u5272\u3068\u7c21\u5358\u3067\u3059\u304c\u3001\n\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u3066\u3044\u306a\u3044\u30a2\u30d7\u30ea\uff08\u4eca\u56de\u306fdjango\uff09\u3092\u3069\u3046\u3084\u3063\u3066\u30bd\u30ec\u3063\u307d\u304f\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u304b\u3001\u306e\u596e\u95d8\u8a18\u3092\u3002\n\nopsworks\u4eca\u5317\u7523\u696d\nAWS\u516c\u5f0f\n\nchef-zero\npull\u578b\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0/\u30c7\u30d7\u30ed\u30a4\n\u753b\u9762\u30dd\u30c1\u30dd\u30c1\n\n\n\u4e0b\u8abf\u3079\n\uff08\u203bcommunity cookbook\u4f7f\u308f\u306a\u3044\u65b9\u91dd\u3067\u3059\uff09\n\u306a\u308b\u3079\u304fopsworks\u306e\u5143\u3005\u306eCookbook\u306b\u52a9\u3051\u3066\u3082\u3089\u3046\uff08&\u58ca\u3055\u306a\u3044\uff09\u5f62\u3067\u3001\nCustom Cookbook\u3092\u4f5c\u3063\u3066Django\u3092\u30c7\u30d7\u30ed\u30a4\u3057\u305f\u3044\n\u57fa\u672c\u7684\u306brails/unicorn\u306e\u30c7\u30d7\u30ed\u30a4\u30ec\u30b7\u30d4\u3092\u4e38\u30d1k...\n\u771f\u4f3c\u3059\u308b\u306e\u306f\u4e0b\u8a18\u306e\u30ec\u30b7\u30d4\u3067\u3059\uff08attributes\u629c\u3044\u3061\u3083\u3044\u307e\u3057\u305f\uff09\n\n\ndeploy\n\ndefinitions/opsworks_deploy.rb (\u30ea\u30bd\u30fc\u30b9\u5c55\u958b\u3068\u304brestart)\ndefinitions/opsworks_rails.rb (database.yml\u3068\u304b\u306e\u914d\u7f6e)\nrecipes/rails.rb (deploy/opsworks_rails\u3092\u30e9\u30c3\u30d7\u3057\u3066\u308b)\n\n\n\nrails\n\nlibraries/rails_configuration.rb (bundle install\u306e\u5b9f\u884c)\nrecipes/configure.rb (database.yml\u3068\u304b\u306e\u914d\u7f6e)\ntemplates/default/database.yml.erb (database.yml\u306e\u30c6\u30f3\u30d7\u30ec)\n\n\n\nunicorn\n\ndefinitions/unicorn_web_app.rb (nginx\u306econfig\u30d5\u30a1\u30a4\u30eb\u306e\u914d\u7f6e)\nrecipes/default.rb (unicorn\u306einstall)\nrecipes/rails.rb (unicorn\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u30fb\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u4f5c\u308b)\nrecipes/stop.rb (unicorn\u306e\u505c\u6b62)\ntemplates/default/nginx_uniconn_webapp.erb (nginx\u306econfig\u30d5\u30a1\u30a4\u30eb\u306e\u30c6\u30f3\u30d7\u30ec)\ntemplates/default/unicorn.conf.erb (unicorn\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u30c6\u30f3\u30d7\u30ec)\ntemplates/default/unicorn.service.erb (unicorn\u306e\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u30c6\u30f3\u30d7\u30ec)\n\n\n\n\u305d\u308c\u305e\u308c\u30c6\u30ad\u30c8\u30a6\u306b\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u7f6e\u304d\u63db\u3048\u3066Custom Cookbook\u3092\u4f5c\u308a\u307e\u3059\n\ndeploy -> custom_deploy\nrails -> django\nunicorn -> gunicorn\n\n\u203b Custom Cookbook\u304c\u3069\u3046\u30de\u30fc\u30b8\u3055\u308c\u308b\u306e\u304b\u306b\u3064\u3044\u3066\u306f\u3001\u3053\u3053\u3084\u3053\u3053\u3092\u53c2\u8003\u306b\n\n\u3044\u3056\u30ec\u30b7\u30d4\u66f8\u304b\u3093\u3068\u3059\n\u7d50\u69cb\u9577\u304f\u306a\u308b\u306e\u3067\u8981\u6240\u3060\u3051\u629c\u7c8b\u3067\u3002\n\nrails -> django\n\npip install\u307e\u308f\u308a\n\u3053\u3053\u3092\u53c2\u8003\u306b\u3001virtualenv\u3092\u4f5c\u3063\u3066pip install -r requirements.txt\u3059\u308b\u3088\u3046\u306b\uff08bundle install\u7684\u306a\uff09\n\u4eca\u56de\u306f\u3001/home/deploy/.venvs/\u914d\u4e0b\u306bvirtualenv\u3092\u4f5c\u308b\u3088\u3046\u306b\u3057\u307e\u3057\u305f\u3002\npython\u306e\u30d1\u30b9\u306f\u4ed6\u306ecookbook\u3067\u5b9a\u7fa9\u3057\u3066\u3044\u308c\u3070\u3088\u3057\u306a\u306b\u3002\n\ndjango/libraries/django_configration.rb\nmodule OpsWorks\n  module DjangoConfiguration\n    def self.pip(app_name, app_config, app_root_path)\n      if File.exists?(\"#{app_root_path}/requirements.txt\")\n        Chef::Log.info(\"requirements.txt detected.\")\n        Chef::Log.info(OpsWorks::ShellOut.shellout(\"sudo su - #{app_config[:user]} -c 'mkdir -p #{app_config[:home]}/.venvs'\"))\n\n        unless File.directory?(\"#{app_config[:home]}/.venvs/#{app_name}\")\n          Chef::Log.info(OpsWorks::ShellOut.shellout(\"sudo su - #{app_config[:user]} -c 'virtualenv-2.7 #{app_config[:home]}/.venvs/#{app_name} --python=/usr/bin/python2.7'\"))\n        end\n\n        Chef::Log.info(\"Running pip install.\")\n        Chef::Log.info(\"#{app_config[:home]}/.venvs/#{app_name}/bin/pip2.7 install -r #{app_root_path}/requirements.txt\")\n        Chef::Log.info(OpsWorks::ShellOut.shellout(\"sudo su - #{app_config[:user]} -c '#{app_config[:home]}/.venvs/#{app_name}/bin/pip2.7 install -r #{app_root_path}/requirements.txt 2>&1'\"))\n      end\n    end\n  end\nend\n\n\n\ndjango\u306econfig\u307e\u308f\u308a\n\u3053\u3053\u3084\u3053\u3053\u3092\u53c2\u8003\u306b\u3001database.py\u3068\u304b\u3092\u751f\u6210\u3059\u308b\u30ec\u30b7\u30d4\u3092\u4f5c\u308b\n\uff08\u30a2\u30d7\u30ea\u5074\u306esettings.py\u306a\u308a\u3001settings_production.py\u3067import\u3057\u3066\u3082\u3089\u3046\u3068\u3044\u3046\u524d\u63d0\uff09\n\ndjango/recipes/configure.rb\ninclude_recipe \"deploy\"\n\nnode[:deploy].each do |application, deploy|\n  deploy = node[:deploy][application]\n\n  if deploy[:application_type] != 'other' && deploy[:custom_application_type] == 'django'\n    Chef::Log.debug(\"Skipping goserver::configure application #{application} as it is not a django app\")\n    next\n  end\n\n  execute \"restart Django app #{application}\" do\n    cwd deploy[:current_path]\n    command node[:opsworks][:django_stack][:restart_command]\n    action :nothing\n  end\n\n  template \"#{deploy[:deploy_to]}/shared/config/database.py\" do\n    source 'database.py.erb'\n    cookbook 'django'\n    mode '0660'\n    group deploy[:group]\n    owner deploy[:user]\n    variables(:database => deploy[:database])\n\n    notifies :run, \"execute[restart Django app #{application}]\"\n\n    only_if do\n      deploy[:database][:host].present? && File.directory?(\"#{deploy[:deploy_to]}/shared/config/\")\n    end\n  end\n\n  # \u4e2d\u7565\n\nend\n\n\n\ndjango/templates/default/database.py.erb\nDATABASES = {\n    'default': {\n        'ENGINE':   <%= (@database[:engine] || 'django.db.backends.mysql').to_s.inspect %>,\n        'HOST':     <%= (@database[:host]   || 'localhost').to_s.inspect %>,\n        'PORT':     <%= (@database[:port]   || 3306).to_i %>,\n        'NAME':     <%=  @database[:database].to_s.inspect %>,\n        'USER':     <%=  @database[:username].to_s.inspect %>,\n        'PASSWORD': <%=  @database[:password].to_s.inspect %>,\n    },\n    <% if @database[:additional_databases] -%>\n    <!-- ... \u4e2d\u7565 ... -->\n    <% end -%>\n}\n\n\n\nunicorn -> gunicorn\n\u57fa\u672c\u7684\u306b\u306f s/unicorn/gunicorn/\u3057\u307e\u304f\u308b\u611f\u3058\u3067\n\ngunicorn\u306econfig\u307e\u308f\u308a\n\u3053\u3053\u3089\u3078\u3093\u3092\u53c2\u8003\u306b\u304c\u3093\u3070\u308b\n\ngunicorn/template/default/gunicorn.conf.py.erb\nworkers            = <%= node[:gunicorn][:worker_processes].to_i %>\nworker_class       = <%= node[:gunicorn][:worker_class].to_s.inspect %>\nworker_connections = <%= node[:gunicorn][:worker_connections].to_i %>\ntimeout            = <%= node[:gunicorn][:worker_timeout].to_i %>\nkeepalive          = <%= node[:gunicorn][:worker_keepalive].to_i %>\nmax_requests       = <%= node[:gunicorn][:worker_max_requests].to_i %>\n\n# \u4e2d\u7565\n\n\n\ngunicorn\u306e\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u307e\u308f\u308a\n\u3053\u3053\u3092\u53c2\u8003\u306b\u3002\nrails_env\u306b\u5408\u308f\u305b\u3066\u3001django_env\u307f\u305f\u3044\u306aattribute\u4f5c\u3063\u3066\u304a\u3044\u3066\u3001\u305d\u308c\u306b\u3088\u3063\u3066settings_{production|staging|development}.py\u3068\u304b\u5207\u308a\u66ff\u3048\u308b\u611f\u3058\npython\u306e\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u3092ruby\u3067\u66f8\u304f\u3068\u304b\u8b0e\u306a\u611f\u3058\u2026\u306a\u306e\u3067python\u3067\u66f8\u3044\u3066\u3082\u30a2\u30ea\u304b\u3068\n\ntemplates/default/gunicorn.service.erb\nAPP_NAME   = <%= @application.to_s.inspect %>\nROOT_PATH  = <%= @deploy[:deploy_to].to_s.inspect %>\nDJANGO_APP = \"<%= (@deploy[:django_project] || @application).to_s %>.wsgi\"\nDJANGO_ENV = \"DJANGO_SETTINGS_MODULE=<%= (@deploy[:django_project] || @application).to_s %>.settings_<%= @deploy[:django_env].to_s %>\"\n\n# \u4e2d\u7565\n\ndef start_gunicorn\n  run_and_ignore_exitcode_and_print_command \"cd #{ROOT_PATH}/current && <%= @deploy[:home] %>/.venvs/#{APP_NAME}/bin/gunicorn #{DJANGO_APP} --env #{DJANGO_ENV} --daemon -c #{ROOT_PATH}/shared/config/gunicorn.conf.py\"\nend\n\n# \u4e2d\u7565\n\n\n\n\ndeploy -> custom_deploy\n\ndjango\u306econfig\u307e\u308f\u308a\n\u3053\u3063\u3061\u306e\u30ec\u30b7\u30d4\u3067\u306f\u3001deploy\u5185\u3067restart\u3059\u308b\u306e\u3067\u3001notifies\u306f\u4e0d\u8981\n\uff08\u4eca\u56de\u304a\u3082\u3044\u3063\u304d\u308a\u30b9\u30eb\u30fc\u3057\u3066\u307e\u3059\u304c\u3001python\u306einstall\u306f\u3088\u3057\u306a\u306b\uff09\n\ncustom_deploy/definitions/opsworks_django.rb\ndefine :opsworks_django do\n  application = params[:app]\n  deploy = params[:deploy_data]\n\n  include_recipe node[:opsworks][:django_stack][:python_recipe] # python27::install\n  include_recipe node[:opsworks][:django_stack][:recipe] # gunicorn::django\n\n  template \"#{deploy[:deploy_to]}/shared/config/database.py\" do\n    source 'database.py.erb'\n    cookbook 'django'\n    mode '0660'\n    group deploy[:group]\n    owner deploy[:user]\n    variables(:database => deploy[:database])\n    only_if do\n      deploy[:database][:host].present? && File.directory?(\"#{deploy[:deploy_to]}/shared/config/\")\n    end\n  end\n\n  # \u4e2d\u7565\nend\n\n\n\ndeploy&restart\n\u3053\u3053\u3067\u3001application_type \u304c other\u3060\u3068 \u30ea\u30bd\u30fc\u30b9\u5c55\u958b\u3057\u3066\u304f\u308c\u306a\u3044\u306e\u3067...\uff08\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3057\u3066\u3082OK\u3067\u3059\u304c\uff09\n\ncustom_deploy/definitions/custom_deploy.rb\ndefine :custom_deploy do\n  application = params[:app]\n  deploy = params[:deploy_data]\n\n  # \u4e2d\u7565\n\n  # setup deployment & checkout\n  if deploy[:scm]\n\n      # \u4e2d\u7565\n\n      # django application restart \n      if deploy[:application_type] == 'other' && deploy[:custom_application_type] == 'django'\n          restart_command \"sleep #{deploy[:sleep_before_restart]} && #{node[:opsworks][:django_stack][:restart_command]}\"\n      end\n\n      # \u4e2d\u7565\n\n      before_migrate do\n        link_tempfiles_to_current_release\n\n        if deploy[:application_type] == 'other' && deploy[:custom_application_type] == 'python-scripts'\n          # install pip packages for python applications\n          OpsWorks::DjangoConfiguration.pip(application, node[:deploy][application], release_path)\n        end\n\n        # run user provided callback file\n        run_callback_from_file(\"#{release_path}/deploy/before_migrate.rb\")\n      end\n    end\n  end\n\n  ruby_block \"change HOME back to /root after source checkout\" do\n    block do\n      ENV['HOME'] = \"/root\"\n    end\n  end\n\n  # for django stack\n  if deploy[:application_type] == 'other' && deploy[:custom_application_type] == 'django'\n    case node[:opsworks][:django_stack][:name]\n    when 'nginx_gunicorn'\n      gunicorn_web_app do\n        application application\n        deploy deploy\n      end\n    else\n      raise \"Unsupport Django stack\"\n    end\n  end\n\n  # \u4e2d\u7565\nend\n\n\n\u6700\u5f8c\uff01\u30e9\u30c3\u30d7\u3057\u3066\u308b\u90e8\u5206\uff01\n\ncustom_deploy/recipes/django.rb\ninclude_recipe 'deploy'\n\nnode[:deploy].each do |application, deploy|\n\n  if deploy[:application_type] != 'other' || deploy[:custom_application_type] != 'django'\n    Chef::Log.debug(\"Skipping custom_deploy::django application #{application} as it is not a django app\")\n    next\n  end\n\n  opsworks_deploy_dir do\n    user deploy[:user]\n    group deploy[:group]\n    path deploy[:deploy_to]\n  end\n\n  custom_django do\n    deploy_data deploy\n    app application\n  end\n\n  custom_deploy do # \u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3059\u308b\u5834\u5408\u306f opsworks_deploy\u306e\u307e\u307e\u3067\n    deploy_data deploy\n    app application\n  end\nend\n\n\n\n\u3044\u3056\u30c7\u30d7\u30ed\u30a4\u305b\u3093\u3068\u3059\n\nStack Settings\n\u3053\u3093\u306a\u304b\u3093\u3058\u3067json\u3092\u66f8\u304f\u307e\u3059\n\ncustom.json\n  \"opsworks\": {\"django_stack\": {\"name\": \"nginx_gunicorn\"} },\n  \"deploy\": {\n    \"<your_app_name>\": {\n      \"user\": \"deploy\", \"group\": \"nginx\",\n      \"custom_application_type\": \"django\",\n\n      \"symlink_before_migrate\": {\n        \"config/database.py\": \"<your_app_name>/database.py\"\n      },\n\n      \"database\": {\n        ...\n      }\n    }\n  }\n\n\n\nLayers Settings\nOpsworks\u306b\u3066\u3001Layers->Custom Chef Recipes\u3067\u3001\u4e0b\u8a18\u3092\u6307\u5b9a\u3059\u308c\u3070OK\n\uff08\u3069\u3053\u304b\u3067include_recipe python27::install\u3057\u3066\u3042\u308b\u524d\u63d0\uff09\n\nSetup: (\u7279\u306b\u306a\u3057)\nConfigure: django::configure\n\nDeploy: custom_deploy::django\n\nUndeploy: (\u4f5c\u3063\u3066\u3044\u308c\u3070custom_deploy::django-undeploy)\nShutfown: (\u7279\u306b\u306a\u3057)\n\n\nLet's Deploy\n\u3068\u3044\u3046\u611f\u3058\u3067\u30c7\u30d7\u30ed\u30a4\u3067\u304d\u307e\u3059\n\n\u307e\u3068\u3081\n\u3068\u3044\u3046\u611f\u3058\u3067\u3001Web\u30b5\u30fc\u30d0/\u30d7\u30ed\u30bb\u30b9\u30de\u30cd\u30fc\u30b8\u30e3/\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af/\u8a00\u8a9e\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3092\u3059\u308c\u3070\u3001\n\u305f\u3044\u3066\u3044\u306e\u30a2\u30d7\u30ea\u306f\u4f3c\u305f\u3088\u3046\u306a\u611f\u3058\u3067\u30c7\u30d7\u30ed\u30a4\u3067\u304d\u308b\u3068\u601d\u3044\u307e\u3059\u3002\nDjango\u30c7\u30d7\u30ed\u30a4\u306eCookbook\u306f\u305d\u306e\u3046\u3061\u516c\u958b\u3067\u304d\u305f\u3089\u3057\u305f\u3044\u3067\u3059\u3002\n\n\u304b\u3089\u306e\u6240\u611f\n\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u3066\u3044\u306a\u3044\u30a2\u30d7\u30ea(=\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af/\u8a00\u8a9e)\u8f09\u305b\u308b\u306e\u306f\u7d50\u69cb\u8f9b\u3044\u3051\u3069\u3001\n\u4f7f\u3044\u307e\u308f\u305b\u308b\u30ec\u30b7\u30d4\u304c\u4e00\u5ea6\u66f8\u3051\u308c\u3070\u3001\u5f8c\u306fMgmtConsole\u30dd\u30c1\u30dd\u30c1\u3067\u3001\n\u300c\u660e\u65e5\u65b0\u3057\u3044\u30b5\u30fc\u30d3\u30b9\u30ea\u30ea\u30fc\u30b9\u3057\u305f\u3044\u3093\u3060\u3051\u3069\u300d\u2192\u300c\u3058\u3083\u3042\u5348\u524d\u4e2d\u306b\u74b0\u5883\u4f5c\u308b\u306d\u30fc\u2606\uff08\u309d\u03c9\u30fb\uff09v\uff77\uff6c\uff8b\uff9f\u300d\n\u3050\u3089\u3044\u306e\u30ce\u30ea\u3067\u5bfe\u5fdc\u3067\u304d\u308b\u306e\u3067\u3060\u3044\u3076\u7701\u30a8\u30cd\u3067\u304d\u307e\u3059\nopsworks\u306b\u95a2\u3057\u3066\u3001\u500b\u4eba\u7684\u306b\u3082\u3063\u3068\u71b1\u5f01\u3057\u305f\u3044\u3053\u3068\u306f\u305f\u304f\u3055\u3093\u3042\u308b\u306e\u3067\u3059\u304c\u3001\n\n\u30d0\u30c3\u30c1\u30b5\u30fc\u30d0\u306e\u30c7\u30d7\u30ed\u30a4\u3092\u3069\u3046\u3059\u308b\u304b\n\u30b5\u30fc\u30d0\u30ed\u30b0\u30a4\u30f3\u6a29\u9650\u306e\u7ba1\u7406\u307e\u308f\u308a\u304c\u30af\u30c3\u30bd\u5e78\u305b\nsecurity group\u3068instance profile\u304c\u30af\u30c3\u30bd\u5e78\u305b\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u81ea\u8eab\u306e\u8a2d\u5b9a\u306f\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u81ea\u8eab\u306b\u3055\u305b\u3088\u3046\uff08\u4f8b\u3048\u3070\u8d77\u52d5\u6642\u306broute53\u767b\u9332\u3068\u304b\uff09\n\n\u7684\u306a\u8a71\u3092\u5225\u9014\u66f8\u3051\u308c\u3070\u3002\u3002\u3002\n// opsworks\u3067django\u516c\u5f0f\u306b\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u6b32\u3057\u3044\u306a\u3041\u2026\n// AWS Advent Calendar\u306a\u306e\u306b\u3042\u3093\u307e\u308aAWS\u611f\u304c\u7121\u304f\u3066\u3059\u307f\u307e\u305b\u3093\u2026\n\n\u3053\u306e\u8a18\u4e8b\u306fAWS Advent Calendar 2014\u306e23\u65e5\u76ee\u306e\u8a18\u4e8b\u3067\u3059\u3002\n\n# \u306f\u3058\u3081\u306b\n\n\u307f\u306a\u3055\u3093opsworks\u4f7f\u3063\u3066\u3044\u307e\u3059\u304b\uff1f\n\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u3066\u3044\u308b\u30a2\u30d7\u30ea\uff08rails\u3060\u3068\u304bnode.js\u3060\u3068\u304b\uff09\u306e\u30c7\u30d7\u30ed\u30a4\u306f\u5272\u3068\u7c21\u5358\u3067\u3059\u304c\u3001\n\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u3066\u3044\u306a\u3044\u30a2\u30d7\u30ea\uff08\u4eca\u56de\u306fdjango\uff09\u3092\u3069\u3046\u3084\u3063\u3066\u30bd\u30ec\u3063\u307d\u304f\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u304b\u3001\u306e\u596e\u95d8\u8a18\u3092\u3002\n\n## opsworks\u4eca\u5317\u7523\u696d\n\n[AWS\u516c\u5f0f](http://aws.amazon.com/jp/opsworks/)\n\n* chef-zero\n* pull\u578b\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0/\u30c7\u30d7\u30ed\u30a4\n* \u753b\u9762\u30dd\u30c1\u30dd\u30c1\n\n## \u4e0b\u8abf\u3079\n\n\uff08\u203bcommunity cookbook\u4f7f\u308f\u306a\u3044\u65b9\u91dd\u3067\u3059\uff09\n\n\u306a\u308b\u3079\u304fopsworks\u306e\u5143\u3005\u306eCookbook\u306b\u52a9\u3051\u3066\u3082\u3089\u3046\uff08&\u58ca\u3055\u306a\u3044\uff09\u5f62\u3067\u3001\nCustom Cookbook\u3092\u4f5c\u3063\u3066Django\u3092\u30c7\u30d7\u30ed\u30a4\u3057\u305f\u3044\n\u57fa\u672c\u7684\u306brails/unicorn\u306e\u30c7\u30d7\u30ed\u30a4\u30ec\u30b7\u30d4\u3092\u4e38\u30d1k...\n\n\u771f\u4f3c\u3059\u308b\u306e\u306f\u4e0b\u8a18\u306e\u30ec\u30b7\u30d4\u3067\u3059\uff08attributes\u629c\u3044\u3061\u3083\u3044\u307e\u3057\u305f\uff09\n\n* [deploy](https://github.com/aws/opsworks-cookbooks/tree/release-chef-11.10/deploy)\n\t* definitions/opsworks_deploy.rb (\u30ea\u30bd\u30fc\u30b9\u5c55\u958b\u3068\u304brestart)\n\t* definitions/opsworks_rails.rb (database.yml\u3068\u304b\u306e\u914d\u7f6e)\n\t* recipes/rails.rb (deploy/opsworks_rails\u3092\u30e9\u30c3\u30d7\u3057\u3066\u308b)\n* [rails](https://github.com/aws/opsworks-cookbooks/tree/release-chef-11.10/rails)\n\t* libraries/rails_configuration.rb (bundle install\u306e\u5b9f\u884c)\n\t* recipes/configure.rb (database.yml\u3068\u304b\u306e\u914d\u7f6e)\n\t* templates/default/database.yml.erb (database.yml\u306e\u30c6\u30f3\u30d7\u30ec)\n* [unicorn](https://github.com/aws/opsworks-cookbooks/tree/release-chef-11.10/unicorn)\n\t* definitions/unicorn_web_app.rb (nginx\u306econfig\u30d5\u30a1\u30a4\u30eb\u306e\u914d\u7f6e)\n\t* recipes/default.rb (unicorn\u306einstall)\n\t* recipes/rails.rb (unicorn\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u30fb\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u4f5c\u308b)\n\t* recipes/stop.rb (unicorn\u306e\u505c\u6b62)\n\t* templates/default/nginx_uniconn_webapp.erb (nginx\u306econfig\u30d5\u30a1\u30a4\u30eb\u306e\u30c6\u30f3\u30d7\u30ec)\n\t* templates/default/unicorn.conf.erb (unicorn\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u30c6\u30f3\u30d7\u30ec)\n\t* templates/default/unicorn.service.erb (unicorn\u306e\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u30c6\u30f3\u30d7\u30ec)\n\n\u305d\u308c\u305e\u308c\u30c6\u30ad\u30c8\u30a6\u306b\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u7f6e\u304d\u63db\u3048\u3066Custom Cookbook\u3092\u4f5c\u308a\u307e\u3059\n\n* deploy -> custom_deploy\n* rails -> django\n* unicorn -> gunicorn\n\n\n\u203b Custom Cookbook\u304c\u3069\u3046\u30de\u30fc\u30b8\u3055\u308c\u308b\u306e\u304b\u306b\u3064\u3044\u3066\u306f\u3001[\u3053\u3053](http://docs.aws.amazon.com/ja_jp/opsworks/latest/userguide/workingcookbook-chef11-10.html)\u3084[\u3053\u3053](http://docs.aws.amazon.com/ja_jp/opsworks/latest/userguide/workingcookbook-installingcustom-enable.html)\u3092\u53c2\u8003\u306b\n\n\n# \u3044\u3056\u30ec\u30b7\u30d4\u66f8\u304b\u3093\u3068\u3059\n\n\u7d50\u69cb\u9577\u304f\u306a\u308b\u306e\u3067\u8981\u6240\u3060\u3051\u629c\u7c8b\u3067\u3002\n\n\n## rails -> django\n\n### pip install\u307e\u308f\u308a\n\n[\u3053\u3053](https://github.com/aws/opsworks-cookbooks/blob/release-chef-11.10/rails/libraries/rails_configuration.rb)\u3092\u53c2\u8003\u306b\u3001virtualenv\u3092\u4f5c\u3063\u3066pip install -r requirements.txt\u3059\u308b\u3088\u3046\u306b\uff08bundle install\u7684\u306a\uff09\n\u4eca\u56de\u306f\u3001/home/deploy/.venvs/<your_app_name>\u914d\u4e0b\u306bvirtualenv\u3092\u4f5c\u308b\u3088\u3046\u306b\u3057\u307e\u3057\u305f\u3002\n\npython\u306e\u30d1\u30b9\u306f\u4ed6\u306ecookbook\u3067\u5b9a\u7fa9\u3057\u3066\u3044\u308c\u3070\u3088\u3057\u306a\u306b\u3002\n\n```django/libraries/django_configration.rb\nmodule OpsWorks\n  module DjangoConfiguration\n    def self.pip(app_name, app_config, app_root_path)\n      if File.exists?(\"#{app_root_path}/requirements.txt\")\n        Chef::Log.info(\"requirements.txt detected.\")\n        Chef::Log.info(OpsWorks::ShellOut.shellout(\"sudo su - #{app_config[:user]} -c 'mkdir -p #{app_config[:home]}/.venvs'\"))\n\n        unless File.directory?(\"#{app_config[:home]}/.venvs/#{app_name}\")\n          Chef::Log.info(OpsWorks::ShellOut.shellout(\"sudo su - #{app_config[:user]} -c 'virtualenv-2.7 #{app_config[:home]}/.venvs/#{app_name} --python=/usr/bin/python2.7'\"))\n        end\n\n        Chef::Log.info(\"Running pip install.\")\n        Chef::Log.info(\"#{app_config[:home]}/.venvs/#{app_name}/bin/pip2.7 install -r #{app_root_path}/requirements.txt\")\n        Chef::Log.info(OpsWorks::ShellOut.shellout(\"sudo su - #{app_config[:user]} -c '#{app_config[:home]}/.venvs/#{app_name}/bin/pip2.7 install -r #{app_root_path}/requirements.txt 2>&1'\"))\n      end\n    end\n  end\nend\n```\n\n### django\u306econfig\u307e\u308f\u308a\n\n[\u3053\u3053](https://github.com/aws/opsworks-cookbooks/blob/release-chef-11.10/rails/recipes/configure.rb)\u3084[\u3053\u3053](https://docs.djangoproject.com/en/1.7/topics/db/multi-db/)\u3092\u53c2\u8003\u306b\u3001database.py\u3068\u304b\u3092\u751f\u6210\u3059\u308b\u30ec\u30b7\u30d4\u3092\u4f5c\u308b\n\uff08\u30a2\u30d7\u30ea\u5074\u306esettings.py\u306a\u308a\u3001settings_production.py\u3067import\u3057\u3066\u3082\u3089\u3046\u3068\u3044\u3046\u524d\u63d0\uff09\n\n\n```django/recipes/configure.rb\ninclude_recipe \"deploy\"\n\nnode[:deploy].each do |application, deploy|\n  deploy = node[:deploy][application]\n\n  if deploy[:application_type] != 'other' && deploy[:custom_application_type] == 'django'\n    Chef::Log.debug(\"Skipping goserver::configure application #{application} as it is not a django app\")\n    next\n  end\n\n  execute \"restart Django app #{application}\" do\n    cwd deploy[:current_path]\n    command node[:opsworks][:django_stack][:restart_command]\n    action :nothing\n  end\n\n  template \"#{deploy[:deploy_to]}/shared/config/database.py\" do\n    source 'database.py.erb'\n    cookbook 'django'\n    mode '0660'\n    group deploy[:group]\n    owner deploy[:user]\n    variables(:database => deploy[:database])\n\n    notifies :run, \"execute[restart Django app #{application}]\"\n\n    only_if do\n      deploy[:database][:host].present? && File.directory?(\"#{deploy[:deploy_to]}/shared/config/\")\n    end\n  end\n  \n  # \u4e2d\u7565\n\nend\n```\n\n```django/templates/default/database.py.erb\nDATABASES = {\n    'default': {\n        'ENGINE':   <%= (@database[:engine] || 'django.db.backends.mysql').to_s.inspect %>,\n        'HOST':     <%= (@database[:host]   || 'localhost').to_s.inspect %>,\n        'PORT':     <%= (@database[:port]   || 3306).to_i %>,\n        'NAME':     <%=  @database[:database].to_s.inspect %>,\n        'USER':     <%=  @database[:username].to_s.inspect %>,\n        'PASSWORD': <%=  @database[:password].to_s.inspect %>,\n    },\n    <% if @database[:additional_databases] -%>\n    <!-- ... \u4e2d\u7565 ... -->\n    <% end -%>\n}\n```\n\n\n\n## unicorn -> gunicorn\n\n\u57fa\u672c\u7684\u306b\u306f s/unicorn/gunicorn/\u3057\u307e\u304f\u308b\u611f\u3058\u3067\n\n### gunicorn\u306econfig\u307e\u308f\u308a\n\n[\u3053\u3053\u3089\u3078\u3093](http://docs.gunicorn.org/en/develop/configure.html)\u3092\u53c2\u8003\u306b\u304c\u3093\u3070\u308b\n\n```gunicorn/template/default/gunicorn.conf.py.erb\nworkers            = <%= node[:gunicorn][:worker_processes].to_i %>\nworker_class       = <%= node[:gunicorn][:worker_class].to_s.inspect %>\nworker_connections = <%= node[:gunicorn][:worker_connections].to_i %>\ntimeout            = <%= node[:gunicorn][:worker_timeout].to_i %>\nkeepalive          = <%= node[:gunicorn][:worker_keepalive].to_i %>\nmax_requests       = <%= node[:gunicorn][:worker_max_requests].to_i %>\n\n# \u4e2d\u7565\n```\n\n### gunicorn\u306e\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u307e\u308f\u308a\n\n[\u3053\u3053](https://github.com/aws/opsworks-cookbooks/blob/release-chef-11.10/unicorn/templates/default/unicorn.service.erb)\u3092\u53c2\u8003\u306b\u3002\nrails_env\u306b\u5408\u308f\u305b\u3066\u3001django_env\u307f\u305f\u3044\u306aattribute\u4f5c\u3063\u3066\u304a\u3044\u3066\u3001\u305d\u308c\u306b\u3088\u3063\u3066settings_{production|staging|development}.py\u3068\u304b\u5207\u308a\u66ff\u3048\u308b\u611f\u3058\n\npython\u306e\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u3092ruby\u3067\u66f8\u304f\u3068\u304b\u8b0e\u306a\u611f\u3058\u2026\u306a\u306e\u3067python\u3067\u66f8\u3044\u3066\u3082\u30a2\u30ea\u304b\u3068\n\n```templates/default/gunicorn.service.erb\nAPP_NAME   = <%= @application.to_s.inspect %>\nROOT_PATH  = <%= @deploy[:deploy_to].to_s.inspect %>\nDJANGO_APP = \"<%= (@deploy[:django_project] || @application).to_s %>.wsgi\"\nDJANGO_ENV = \"DJANGO_SETTINGS_MODULE=<%= (@deploy[:django_project] || @application).to_s %>.settings_<%= @deploy[:django_env].to_s %>\"\n\n# \u4e2d\u7565\n\ndef start_gunicorn\n  run_and_ignore_exitcode_and_print_command \"cd #{ROOT_PATH}/current && <%= @deploy[:home] %>/.venvs/#{APP_NAME}/bin/gunicorn #{DJANGO_APP} --env #{DJANGO_ENV} --daemon -c #{ROOT_PATH}/shared/config/gunicorn.conf.py\"\nend\n\n# \u4e2d\u7565\n\n```\n\n## deploy -> custom_deploy\n\n\n### django\u306econfig\u307e\u308f\u308a\n\n\u3053\u3063\u3061\u306e\u30ec\u30b7\u30d4\u3067\u306f\u3001deploy\u5185\u3067restart\u3059\u308b\u306e\u3067\u3001notifies\u306f\u4e0d\u8981\n\uff08\u4eca\u56de\u304a\u3082\u3044\u3063\u304d\u308a\u30b9\u30eb\u30fc\u3057\u3066\u307e\u3059\u304c\u3001python\u306einstall\u306f\u3088\u3057\u306a\u306b\uff09\n\n\n```custom_deploy/definitions/opsworks_django.rb\ndefine :opsworks_django do\n  application = params[:app]\n  deploy = params[:deploy_data]\n\n  include_recipe node[:opsworks][:django_stack][:python_recipe] # python27::install\n  include_recipe node[:opsworks][:django_stack][:recipe] # gunicorn::django\n\n  template \"#{deploy[:deploy_to]}/shared/config/database.py\" do\n    source 'database.py.erb'\n    cookbook 'django'\n    mode '0660'\n    group deploy[:group]\n    owner deploy[:user]\n    variables(:database => deploy[:database])\n    only_if do\n      deploy[:database][:host].present? && File.directory?(\"#{deploy[:deploy_to]}/shared/config/\")\n    end\n  end\n\n  # \u4e2d\u7565\nend\n```\n\n\n### deploy&restart\n\n[\u3053\u3053](https://github.com/aws/opsworks-cookbooks/blob/release-chef-11.10/deploy/definitions/opsworks_deploy.rb#L63)\u3067\u3001application_type \u304c other\u3060\u3068 \u30ea\u30bd\u30fc\u30b9\u5c55\u958b\u3057\u3066\u304f\u308c\u306a\u3044\u306e\u3067...\uff08\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3057\u3066\u3082OK\u3067\u3059\u304c\uff09\n\n```custom_deploy/definitions/custom_deploy.rb\ndefine :custom_deploy do\n  application = params[:app]\n  deploy = params[:deploy_data]\n\n  # \u4e2d\u7565\n\n  # setup deployment & checkout\n  if deploy[:scm]\n\n      # \u4e2d\u7565\n\n      # django application restart \n      if deploy[:application_type] == 'other' && deploy[:custom_application_type] == 'django'\n          restart_command \"sleep #{deploy[:sleep_before_restart]} && #{node[:opsworks][:django_stack][:restart_command]}\"\n      end\n\n      # \u4e2d\u7565\n\n      before_migrate do\n        link_tempfiles_to_current_release\n\n        if deploy[:application_type] == 'other' && deploy[:custom_application_type] == 'python-scripts'\n          # install pip packages for python applications\n          OpsWorks::DjangoConfiguration.pip(application, node[:deploy][application], release_path)\n        end\n\n        # run user provided callback file\n        run_callback_from_file(\"#{release_path}/deploy/before_migrate.rb\")\n      end\n    end\n  end\n\n  ruby_block \"change HOME back to /root after source checkout\" do\n    block do\n      ENV['HOME'] = \"/root\"\n    end\n  end\n\n  # for django stack\n  if deploy[:application_type] == 'other' && deploy[:custom_application_type] == 'django'\n    case node[:opsworks][:django_stack][:name]\n    when 'nginx_gunicorn'\n      gunicorn_web_app do\n        application application\n        deploy deploy\n      end\n    else\n      raise \"Unsupport Django stack\"\n    end\n  end\n\n  # \u4e2d\u7565\nend\n```\n\n\u6700\u5f8c\uff01\u30e9\u30c3\u30d7\u3057\u3066\u308b\u90e8\u5206\uff01\n\n```custom_deploy/recipes/django.rb\ninclude_recipe 'deploy'\n\nnode[:deploy].each do |application, deploy|\n\n  if deploy[:application_type] != 'other' || deploy[:custom_application_type] != 'django'\n    Chef::Log.debug(\"Skipping custom_deploy::django application #{application} as it is not a django app\")\n    next\n  end\n\n  opsworks_deploy_dir do\n    user deploy[:user]\n    group deploy[:group]\n    path deploy[:deploy_to]\n  end\n\n  custom_django do\n    deploy_data deploy\n    app application\n  end\n\n  custom_deploy do # \u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3059\u308b\u5834\u5408\u306f opsworks_deploy\u306e\u307e\u307e\u3067\n    deploy_data deploy\n    app application\n  end\nend\n```\n\n# \u3044\u3056\u30c7\u30d7\u30ed\u30a4\u305b\u3093\u3068\u3059\n\n### Stack Settings\n\n\u3053\u3093\u306a\u304b\u3093\u3058\u3067json\u3092\u66f8\u304f\u307e\u3059\n\n```custom.json\n  \"opsworks\": {\"django_stack\": {\"name\": \"nginx_gunicorn\"} },\n  \"deploy\": {\n    \"<your_app_name>\": {\n      \"user\": \"deploy\", \"group\": \"nginx\",\n      \"custom_application_type\": \"django\",\n\n      \"symlink_before_migrate\": {\n        \"config/database.py\": \"<your_app_name>/database.py\"\n      },\n\n      \"database\": {\n        ...\n      }\n    }\n  }\n```\n\n### Layers Settings\n\nOpsworks\u306b\u3066\u3001Layers->Custom Chef Recipes\u3067\u3001\u4e0b\u8a18\u3092\u6307\u5b9a\u3059\u308c\u3070OK\n\uff08\u3069\u3053\u304b\u3067include_recipe python27::install\u3057\u3066\u3042\u308b\u524d\u63d0\uff09\n\n* Setup: (\u7279\u306b\u306a\u3057)\n* Configure: ```django::configure```\n* Deploy: ```custom_deploy::django```\n* Undeploy: (\u4f5c\u3063\u3066\u3044\u308c\u3070custom_deploy::django-undeploy)\n* Shutfown: (\u7279\u306b\u306a\u3057)\n\n### Let's Deploy\n\n\u3068\u3044\u3046\u611f\u3058\u3067\u30c7\u30d7\u30ed\u30a4\u3067\u304d\u307e\u3059\n\n# \u307e\u3068\u3081\n\n\u3068\u3044\u3046\u611f\u3058\u3067\u3001Web\u30b5\u30fc\u30d0/\u30d7\u30ed\u30bb\u30b9\u30de\u30cd\u30fc\u30b8\u30e3/\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af/\u8a00\u8a9e\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3092\u3059\u308c\u3070\u3001\n\u305f\u3044\u3066\u3044\u306e\u30a2\u30d7\u30ea\u306f\u4f3c\u305f\u3088\u3046\u306a\u611f\u3058\u3067\u30c7\u30d7\u30ed\u30a4\u3067\u304d\u308b\u3068\u601d\u3044\u307e\u3059\u3002\nDjango\u30c7\u30d7\u30ed\u30a4\u306eCookbook\u306f\u305d\u306e\u3046\u3061\u516c\u958b\u3067\u304d\u305f\u3089\u3057\u305f\u3044\u3067\u3059\u3002\n\n## \u304b\u3089\u306e\u6240\u611f\n\n\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u3066\u3044\u306a\u3044\u30a2\u30d7\u30ea(=\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af/\u8a00\u8a9e)\u8f09\u305b\u308b\u306e\u306f\u7d50\u69cb\u8f9b\u3044\u3051\u3069\u3001\n\u4f7f\u3044\u307e\u308f\u305b\u308b\u30ec\u30b7\u30d4\u304c\u4e00\u5ea6\u66f8\u3051\u308c\u3070\u3001\u5f8c\u306fMgmtConsole\u30dd\u30c1\u30dd\u30c1\u3067\u3001\n\u300c\u660e\u65e5\u65b0\u3057\u3044\u30b5\u30fc\u30d3\u30b9\u30ea\u30ea\u30fc\u30b9\u3057\u305f\u3044\u3093\u3060\u3051\u3069\u300d\u2192\u300c\u3058\u3083\u3042\u5348\u524d\u4e2d\u306b\u74b0\u5883\u4f5c\u308b\u306d\u30fc\u2606\uff08\u309d\u03c9\u30fb\uff09v\uff77\uff6c\uff8b\uff9f\u300d\n\u3050\u3089\u3044\u306e\u30ce\u30ea\u3067\u5bfe\u5fdc\u3067\u304d\u308b\u306e\u3067\u3060\u3044\u3076\u7701\u30a8\u30cd\u3067\u304d\u307e\u3059\n\nopsworks\u306b\u95a2\u3057\u3066\u3001\u500b\u4eba\u7684\u306b\u3082\u3063\u3068\u71b1\u5f01\u3057\u305f\u3044\u3053\u3068\u306f\u305f\u304f\u3055\u3093\u3042\u308b\u306e\u3067\u3059\u304c\u3001\n\n* \u30d0\u30c3\u30c1\u30b5\u30fc\u30d0\u306e\u30c7\u30d7\u30ed\u30a4\u3092\u3069\u3046\u3059\u308b\u304b\n* \u30b5\u30fc\u30d0\u30ed\u30b0\u30a4\u30f3\u6a29\u9650\u306e\u7ba1\u7406\u307e\u308f\u308a\u304c\u30af\u30c3\u30bd\u5e78\u305b\n* security group\u3068instance profile\u304c\u30af\u30c3\u30bd\u5e78\u305b\n* \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u81ea\u8eab\u306e\u8a2d\u5b9a\u306f\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u81ea\u8eab\u306b\u3055\u305b\u3088\u3046\uff08\u4f8b\u3048\u3070\u8d77\u52d5\u6642\u306broute53\u767b\u9332\u3068\u304b\uff09\n\n\u7684\u306a\u8a71\u3092\u5225\u9014\u66f8\u3051\u308c\u3070\u3002\u3002\u3002\n\n// opsworks\u3067django\u516c\u5f0f\u306b\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u6b32\u3057\u3044\u306a\u3041\u2026\n\n// AWS Advent Calendar\u306a\u306e\u306b\u3042\u3093\u307e\u308aAWS\u611f\u304c\u7121\u304f\u3066\u3059\u307f\u307e\u305b\u3093\u2026\n", "tags": ["chef", "opsworks", "AWS", "Django"]}