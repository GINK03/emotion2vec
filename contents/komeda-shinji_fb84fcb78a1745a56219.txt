{"context": "CodeDeploy \u30aa\u30f3\u30d7\u30ec\u30df\u30b9\u3092\u305f\u3081\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n\u7d50\u8ad6\n\u914d\u5e03\u5143\u306b github \u3092\u6307\u5b9a\u3057\u305f\u3068\u304d\u306f\u3001S3 \u3078\u306e\u30a2\u30af\u30bb\u30b9\u306f\u4e0d\u8981\u3067\u3059\u3002\ncodedeploy-agent \u304c\u5bfe\u5fdc\u3057\u3066\u3044\u308b\u914d\u5e03\u5143\u304c\u3001S3 \u304b Github.com \u306a\u306e\u3067\u3001\u305d\u306e\u307e\u307e\u3060\u3068\u914d\u5e03\u5143\u30c7\u30fc\u30bf\u306e\u5834\u6240\u306f\u30a4\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8\u4e0a\u306b\u306a\u308a\u307e\u3059\u304c\u3001\u5c11\u3057\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u3092\u624b\u76f4\u3057\u3059\u308c\u3070\u3001\u30aa\u30f3\u30d7\u30ec\u30df\u30b9\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u304b\u3089\u30c7\u30d7\u30ed\u30a4\u3067\u304d\u307e\u3057\u305f\u3002\n\n\u30b5\u30dd\u30fc\u30c8\u3059\u308bOS\nThe AWS CodeDeploy agent has been tested\n\n  Amazon Linux 2014.09.1, 2015.03, 2016.03.0, 2016.03.1\n  Ubuntu Server 14.04 LTS\n  Windows Server 2008 R2 and Windows Server 2012 R2\n  Red Hat Enterprise Linux (RHEL) 7.x\n\n\u4eca\u56de\u306f\u3001Ubuntu 16.04.1 LTS\u00a0\u3067\u5b9f\u9a13\u3057\u305f\u305f\u3081\u3001\u30ea\u30b9\u30c8\u306b\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\nThe AWS CodeDeploy agent is available as open source for you to adapt to\n  your needs. It can be used with other on-premises instance operating\n  systems. For more information, go to the\u00a0AWS CodeDeploy Agent\u00a0repository in GitHub.\n\n\u81ea\u5206\u3067\u76f4\u3057\u3066\u306d\u3001\u3068\u3044\u3046\u3053\u3068\u3067\u3002\n\nUbuntu 16.04.1 LTS\nRuby2.0 \u304c\u52d5\u4f5c\u3059\u308c\u3070\u306a\u3093\u3068\u304b\u306a\u308a\u305d\u3046\u3067\u3059\u3002\nruby\u30d1\u30c3\u30b1\u30fc\u30b8\u306f2.3\u306a\u306e\u3067\u3001PPA\u304b\u3089 ruby2.0\n\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u76f4\u63a5\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n$ sudo apt-add-repository ppa:brightbox/ruby-ng\n$ sudo apt-get update\n$ sudo apt-get install ruby2.0 libruby2.0\n\n\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u3092\u624b\u52d5\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n$ wget https://aws-codedeploy-ap-northeast-1.s3.amazonaws.com/latest/install\n$ wget https://aws-codedeploy-ap-northeast-1.s3.amazonaws.com/latest/VERSION\n$ cat VERSION\n{\"rpm\":\"releases/codedeploy-agent-1.0-1.1037.noarch.rpm\",\"deb\":\"releases/codedeploy-agent_1.0-1.1037_all.deb\",\"msi\":\"releases/codedeploy-agent-1.0.1.998.msi\"}\n$ wget https://aws-codedeploy-ap-northeast-1.s3.amazonaws.com/releases/codedeploy-agent_1.0-1.1037_all.deb\n$ sudo dpkg -i codedeploy-agent_1.0-1.1037_all.deb\n\ndpkg -L codedeploy-agent\u00a0\u3059\u308b\u3068\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u305f\u30d5\u30a1\u30a4\u30eb\u4e00\u89a7\u304c\u8868\u793a\u3055\u308c\u307e\u3059\u3002\n\u4e00\u89a7\u306e\u4e2d\u306b\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u304c\u3042\u308a\u307e\u3057\u305f\u3002\n/etc/codedeploy-agent/conf/codedeployagent.yml\n---\n:log_aws_wire: false\n:log_dir: '/var/log/aws/codedeploy-agent/'\n:pid_dir: '/opt/codedeploy-agent/state/.pid/'\n:program_name: codedeploy-agent\n:root_dir: '/opt/codedeploy-agent/deployment-root'\n:verbose: false\n:wait_between_runs: 1\n:proxy_uri:\n:max_revisions: 5\n\n\n\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n$ export AWS_REGION=us-east-1\n$ NAME=Ubuntu-16\n$ IAM_USER_ARN=arn:aws:iam::XXXXXXXXXXXX:user/XXXXXXXXXX\n\n\u3053\u3053\u3067\u4f7f\u7528\u3059\u308b IAM \u30e6\u30fc\u30b6\u306b\u306f\u3001\u3064\u304e\u306e\u5185\u5bb9\u306e\u30dd\u30ea\u30b7\u30fc\u3092\u30a2\u30bf\u30c3\u30c1\u3057\u3066\u4f5c\u6210\u3057\u3066\u3042\u308a\u307e\u3059\u3002\n\u30dd\u30ea\u30b7\u30fc > CodeDeply-On-Premises\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"codedeploy:*\",\n                \"iam:CreateAccessKey\",\n                \"iam:CreateUser\",\n                \"iam:DeleteAccessKey\",\n                \"iam:DeleteUser\",\n                \"iam:DeleteUserPolicy\",\n                \"iam:ListAccessKeys\",\n                \"iam:ListUserPolicies\",\n                \"iam:PutUserPolicy\",\n                \"iam:GetUser\",\n                \"tag:GetTags\",\n                \"tag:GetResources\"\n            ],\n            \"Resource\": \"*\"\n        },\n        {\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"s3:Get*\",\n                \"s3:List*\"\n            ],\n            \"Resource\": [\n                \"arn:aws:s3:::aws-codedeploy-us-east-1/*\",\n                \"arn:aws:s3:::aws-codedeploy-us-east-2/*\",\n                \"arn:aws:s3:::aws-codedeploy-us-west-1/*\",\n                \"arn:aws:s3:::aws-codedeploy-us-west-2/*\",\n                \"arn:aws:s3:::aws-codedeploy-ap-northeast-1/*\",\n                \"arn:aws:s3:::aws-codedeploy-ap-northeast-2/*\",\n                \"arn:aws:s3:::aws-codedeploy-ap-south-1/*\",\n                \"arn:aws:s3:::aws-codedeploy-ap-southeast-1/*\",\n                \"arn:aws:s3:::aws-codedeploy-ap-southeast-2/*\",\n                \"arn:aws:s3:::aws-codedeploy-eu-central-1/*\",\n                \"arn:aws:s3:::aws-codedeploy-eu-west-1/*\",\n                \"arn:aws:s3:::aws-codedeploy-sa-east-1/*\"\n            ]\n        }\n    ]\n}\n\n\u30aa\u30f3\u30d7\u30ec\u30df\u30b9\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u767b\u9332\n$ aws deploy register-on-premises-instance --instance-name $NAME --iam-user-arn $IAM_USER_ARN --region $AWS_REGION\n$ aws deploy add-tags-to-on-premises-instances\n--instance-name $NAME --tags Key=Name,Value=CodeDeploy-OnPremises\n\n\u3042\u308b\u3044\u306f\u3001\u4e00\u884c\u3067\u307e\u3068\u3081\u3066\u5b9f\u884c\u3067\u304d\u307e\u3059\u3002\n$ aws deploy register --instance-name $NAME --iam-user-arn $IAM_USER_ARN --region $AWS_REGION --tags Key=Name,Value=CodeDeploy-OnPremises\n\n\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ sudo aws deploy install --override-config --config-file codedeploy.onpremises.yml\n\ncodedeploy.onpremises.yml:\n---\naws_access_key_id: XXXXXXXXXXXXXXXXXXXX\naws_secret_access_key: XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\niam_user_arn: arn:aws:iam::XXXXXXXXXXXX:user/XXXXXXXXXX\nregion: us-east-1\n\n\n\u30c7\u30d7\u30ed\u30a4\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\naws deploy create-application --application-name MyApp --region $AWS_REGION\n\n\u30ed\u30fc\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\naws iam create-role --role-name CodeDeploy-OnPremises --assume-role-policy-document file://CodeDeploy-Trust.json\n\nCodeDeploy-Trust.json:\n{ \"Version\": \"2012-10-17\", \"Statement\": [ { \"Sid\": \"\", \"Effect\": \"Allow\", \"Principal\": { \"Service\": [ \"codedeploy.us-east-1.amazonaws.com\" ] }, \"Action\":\n\"sts:AssumeRole\" } ] }\n\n$ SERVICE_ROLE_ARN=arn:aws:iam::XXXXXXXXXXXX:role/CodeDeploy-OnPremises\n\n\u30aa\u30f3\u30d7\u30ec\u30df\u30b9\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u4f7f\u7528\u3059\u308bIAM\u30e6\u30fc\u30b6\u306b\u30ed\u30fc\u30eb\u3092\u30a2\u30bf\u30c3\u30c1\u3057\u307e\u3059\u3002\naws iam attach-role-policy --role-name CodeDeployServiceRole --policy-arn $SERVICE_ROLE_ARN\n\n\u30c7\u30d7\u30ed\u30a4\u30e1\u30f3\u30c8\u30b0\u30eb\u30fc\u30d7\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\naws deploy create-deployment-group \\\n--region\u00a0$AWS_REGION --application-name MyApp \\\n--deployment-group-name MyDepGroup \\\n--deployment-config-name CodeDeployDefault.OneAtATime \\\n--on-premises-instance-tag-filters Key=Name,Value=Ubuntu-16,Type=KEY_AND_VALUE \\\n--service-role-arn $SERVICE_ROLE_ARN\n\n\n\u30c7\u30d7\u30ed\u30a4\n\u30c7\u30d7\u30ed\u30a4\u3057\u3066\u307f\u307e\u3059\u3002\nappspec.yml:\nversion: 0.0\nos: linux\nfiles:\n\u00a0 - source: subtree\n\u00a0 \u00a0 destination: /opt/codedeploy-on-premises\n\u00a0 - source: README.md\n\u00a0 \u00a0 destination: /opt/codedeploy-on-premises\n\u00a0 - source: LICENSE\n\u00a0 \u00a0 destination: /opt/codedeploy-on-premises\nhooks:\n\u00a0 ApplicationStop:\n\u00a0 \u00a0 - location: scripts/application-stop.sh\n\u00a0 \u00a0 \u00a0 timeout: 300\n\u00a0 \u00a0 \u00a0 runas: root\n\u00a0 BeforeInstall:\n\u00a0 \u00a0 - location: scripts/before-install.sh\n\u00a0 \u00a0 \u00a0 timeout: 300\n\u00a0 \u00a0 \u00a0 runas: root\n\u00a0 AfterInstall:\n\u00a0 \u00a0 - location: scripts/after-install.sh\n\u00a0 \u00a0 \u00a0 timeout: 300\n\u00a0 \u00a0 \u00a0 runas: root\n\u00a0 ApplicationStart:\n\u00a0 \u00a0 - location: scripts/application-start.sh\n\u00a0 \u00a0 \u00a0 timeout: 300\n\u00a0 \u00a0 \u00a0 runas: root\n\u00a0 ValidateService:\n\u00a0 \u00a0 - location: scripts/validate-service.sh\n\u00a0 \u00a0 \u00a0 timeout: 300\n\u00a0 \u00a0 \u00a0 runas: root\n\n$\u00a0aws deploy create-deployment --region $AWS_REGION --application-name MyApp --deployment-config-name CodeDeployDefault.OneAtATime --deployment-group-name MyDepGroup --github-location repository=xxxxx/yyyyyy,commitId=zzzzzzzz\n\n\n\u30af\u30ec\u30c7\u30f3\u30b7\u30e3\u30eb\u306b\u3064\u3044\u3066\n\nEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u5834\u5408\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u3067\u8a2d\u5b9a\u3059\u308b\u306e\u3067\u4e0d\u8981\u3067\u3059\u3002\n\u30aa\u30f3\u30d7\u30ec\u30df\u30b9\ncodedeploy.onpremises.yml\u3067\u6307\u5b9a\u3057\u307e\u3059\u3002\n\u767b\u9332\u3054\u3068\u306b1\u5bfe1\u3067IAM\u30e6\u30fc\u30b6\u304c\u5fc5\u8981\u3067\u3059\u3002\nGithub.com \u3078\u306e\u30a2\u30af\u30bb\u30b9\n\u30de\u30cd\u30fc\u30b8\u30e1\u30f3\u30c8\u30b3\u30f3\u30bd\u30fc\u30eb\u3067 \u300cGithub\u306b\u63a5\u7d9a\u300d\u3092\u5b9f\u884c\u3057\u3066\u304a\u3051\u3070\u3001\u30c7\u30d7\u30ed\u30a4\u6642\u306bOAuth\u306e\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u304c\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u306b\u6e21\u3063\u3066\u304f\u308b\u3088\u3046\u3067\u3059\u3002\n\u30ed\u30b0\u3067\u306f\u30de\u30b9\u30af\u3055\u308c\u3066\u3001 \"GitHubAccessToken\"=>\"REDACTED\" \u306b\u306a\u308a\u307e\u3059\u3002\n\n\n\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u306e\u52d5\u4f5c\n\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u306f\u3053\u3053\u306b\u5c55\u958b\u3055\u308c\u307e\u3059\u3002\n/opt/codedeploy-agent/deployment-root/${DEPLOYMENT_GROUP_ID}/${DEPLOYMENT_ID}/deployment-archive\nmax_revisions \u3067\u6307\u5b9a\u3057\u305f\u4e16\u4ee3\u5206\u4fdd\u5b58\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\u30dd\u30fc\u30ea\u30f3\u30b0\u5bfe\u8c61\u306eURL\u3002\u3053\u3053\u304b\u3089\u30b3\u30de\u30f3\u30c9\u3092\u53d7\u3051\u53d6\u3063\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\nvendor/gems/codedeploy-commands-1.0.0/lib/aws/plugins/deploy_control_endpoint.rb:\nurl = \"https://codedeploy-commands.#{cfg.region}.amazonaws.com\"\npoll_host_command(host_identifier:\u00a0IAM_USER_ARN)\n\ncodedeployagent.yml \u306b proxy_uri\n\u306e\u9805\u76ee\u304c\u3042\u308b\u306e\u3067\u3001\u30d7\u30ed\u30ad\u30b7\u30b5\u30fc\u30d0\u7d4c\u7531\u3067\u3082\u4f7f\u3048\u308b\u3088\u3046\u3067\u3059\u3002(\u672a\u78ba\u8a8d)\n\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u306e\u5834\u6240\n/var/log/aws/codedeploy-agent/codedeploy-agent.log\n/opt/codedeploy-agent/deployment-root/deployment-logs/codedeploy-agent-deployments.log\n\n\u30d5\u30c3\u30af\n\n\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u5b9f\u884c\u3067\u3001\u7d42\u4e86\u30b9\u30c6\u30fc\u30bf\u30b9 0 \u306e\u3068\u304d\u6210\u529f\u3001\u305d\u308c\u4ee5\u5916\u306e\u6642\u306f\u5931\u6557\u3067\u3059\u3002\nApplicationStop \u3060\u3051\u5b9f\u884c\u30bf\u30a4\u30df\u30f3\u30b0\u304c\u7570\u306a\u308a\u307e\u3059\u3002\nApplicationStop\u3067\u6307\u5b9a\u3055\u308c\u305f\u30b9\u30af\u30ea\u30d7\u30c8\u306f\u3001\u4eca\u56de\u306e\u30c7\u30d7\u30ed\u30a4\u3067\u306f\u306a\u304f\u3001\u5f8c\u306e\u30c7\u30d7\u30ed\u30a4\u306e\u6642\u306b\u3001\u3053\u306e\u30c7\u30d7\u30ed\u30a4\u3057\u305f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u505c\u6b62\u3059\u308b\u305f\u3081\u306b\u306b\u4f7f\u7528\u3055\u308c\u307e\u3059\u3002\n\n\nInstall\nappspec.yml \u306b\u66f8\u304b\u308c\u305f\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5bfe\u8c61\u306e\u30d5\u30a1\u30a4\u30eb\u306f\u3001Install \u306e\u30b9\u30c6\u30c3\u30d7\u3067\u5b58\u5728\u3057\u3066\u3044\u308c\u3070\u826f\u3044\u3088\u3046\u3067\u3059\u3002\nfiles: \u306b\u8a18\u8f09\u3057\u3066\u304a\u3044\u3066\u3001BeforeInstall \u30b9\u30af\u30ea\u30d7\u30c8\u3067\u6e96\u5099\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u305d\u3046\u3067\u3059\u3002\n\u305f\u3068\u3048\u3070\u3053\u306e\u3088\u3046\u306b\u3002\nDEPLOYMENT_ROOT=/opt/codedeploy-agent/deployment-root\nDEPLOYMENT_DIR=$DEPLOYMENT_ROOT/${DEPLOYMENT_GROUP_ID}/${DEPLOYMENT_ID}\n[ -d $DEPLOYMENT_DIR/subtree ] || mkdir $DEPLOYMENT_DIR/subtree\ncd /path/to/workset\ngit pull\nrsync -a --exclude .git . $DEPLOYMENT_DIR/subtree/.\n\n\n\u30b9\u30af\u30ea\u30d7\u30c8\u4e2d\u3067\u5229\u7528\u3067\u304d\u308b\u74b0\u5883\u5909\u6570\nAPPLICATION_NAME=\u30c7\u30d7\u30ed\u30a4\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u540d\nDEPLOYMENT_GROUP_NAME=\u30c7\u30d7\u30ed\u30a4\u30b0\u30eb\u30fc\u30d7\u540d\nDEPLOYMENT_GROUP_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\nDEPLOYMENT_ID=d-XXXXXXXXX\nLIFECYCLE_EVENT=\u30b9\u30c6\u30fc\u30b8\u540d\nAWS_HOST_IDENTIFIER=codedeploy.onpremises.yml\u306eiam_user_arn\nAWS_ACCESS_KEY=codedeploy.onpremises.yml\u306eaws_access_key_id\nAWS_SECRET_KEY=codedeploy.onpremises.yml\u306eaws_secret_access_key\nAWS_REGION=\u30ea\u30fc\u30b8\u30e7\u30f3\u540d\nPWD=/opt/codedeploy-agent\n\n\u30b9\u30c6\u30fc\u30b8\u540d: (ApplicationStop|BeforeInstall|AfterInstall|ApplicationStart|ValidateService)\n\n\u624b\u5143\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u304b\u3089\u30c7\u30d7\u30ed\u30a4\u3057\u305f\u3044\u3068\u304d\ngitbucket\u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u3066\u5b9f\u9a13\u3057\u307e\u3057\u305f\u3002\n\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u306e lib/instance_agent/plugins/codedeploy/command_executor.rb\n\u306e\u4e2d\u306bdownload_from_s3()\u3084download_from_github()\u304c\u3042\u308a\u307e\u3059\u3002\n\u3053\u3053\u306eURL\u3092\u66f8\u304d\u63db\u3048\u3066\u3001\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u304f\u308b\u30a2\u30fc\u30ab\u30a4\u30d6\u306e\u30bf\u30a4\u30d7\u3082\u5909\u66f4\u3057\u307e\u3057\u305f\u3002\n\u00a0 \u00a0 \u00a0 \u00a0 private\n\u00a0 \u00a0 \u00a0 \u00a0 def download_from_github(deployment_spec, account, repo, commit,\nanonymous, token)\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 retries = 0\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 errors = []\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 if InstanceAgent::Platform.util.supported_oses.include? 'windows'\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 deployment_spec.bundle_type = 'zip'\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 format = 'zipball'\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 else\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 #deployment_spec.bundle_type = 'tar'\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 #format = 'tarball'\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 deployment_spec.bundle_type = 'zip'\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 format = 'zip'\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 end\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 #uri = URI.parse(\"https://api.github.com/repos/#{account}/#{repo}/#{format}/#{commit}\")\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 #options = {:ssl_verify_mode => OpenSSL::SSL::VERIFY_PEER, :redirect => true, :ssl_ca_cert => ENV['AWS_SSL_CA_DIRECTORY']}\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 uri = URI.parse(\"https://gitbucket.repository.local/#{account}/#{repo}/archive/#{commit}.#{format}\")\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 options = {:ssl_verify_mode => OpenSSL::SSL::VERIFY_NONE, :redirect => true, :ssl_ca_cert => ENV['AWS_SSL_CA_DIRECTORY']}\n\n\u00a0\n\n\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u306fHTTP/HTTPS\u306e\u307f\u5bfe\u5fdc\u53ef\u80fd\u3067\u3059\u3002\n\u6e21\u305b\u308b\u30d1\u30e9\u30e1\u30fc\u30bf\u304c\u9650\u3089\u308c\u308b\u305f\u3081\u3001\u81ea\u7531\u5ea6\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\u8a8d\u8a3c\u304c\u5fc5\u8981\u306a\u5834\u5408\u306f\u3001\u5225\u9014 BeforeInstall \u30b9\u30af\u30ea\u30d7\u30c8\u3067\u53d6\u5f97\u3059\u308b\u65b9\u304c\u3088\u3055\u305d\u3046\u3067\u3059\u3002\n\n\n\u6c17\u306b\u306a\u308b\u70b9\nRuby 2.0.0\u7cfb\u306e\u516c\u5f0f\u30b5\u30dd\u30fc\u30c8\u306f2016\u5e742\u670824\u65e5\u306b\u7d42\u4e86\u3057\u3066\u3044\u307e\u3059\u3002\n\nRuby 2.0.0\u7cfb\u306b\u95a2\u3057\u3066\u306f\u4eca\u5f8c\u30d0\u30b0\u4fee\u6b63\u3084\u8106\u5f31\u6027\u4fee\u6b63\u306e\u30d1\u30c3\u30c1\u304c\u30ea\u30ea\u30fc\u30b9\u3055\u308c\u308b\u3053\u3068\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\nRuby 2.3 \u306b\u5bfe\u5fdc\u3059\u308b\u306e\u306f\u3044\u3064\u306b\u306a\u308b\u306e\u3067\u3057\u3087\u3046\u3002\nCodeDeploy \u30aa\u30f3\u30d7\u30ec\u30df\u30b9\u3092\u305f\u3081\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n\n\n\u7d50\u8ad6\n====\n\n\u914d\u5e03\u5143\u306b github \u3092\u6307\u5b9a\u3057\u305f\u3068\u304d\u306f\u3001S3 \u3078\u306e\u30a2\u30af\u30bb\u30b9\u306f\u4e0d\u8981\u3067\u3059\u3002\n\ncodedeploy-agent \u304c\u5bfe\u5fdc\u3057\u3066\u3044\u308b\u914d\u5e03\u5143\u304c\u3001S3 \u304b Github.com \u306a\u306e\u3067\u3001\u305d\u306e\u307e\u307e\u3060\u3068\u914d\u5e03\u5143\u30c7\u30fc\u30bf\u306e\u5834\u6240\u306f\u30a4\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8\u4e0a\u306b\u306a\u308a\u307e\u3059\u304c\u3001\u5c11\u3057\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u3092\u624b\u76f4\u3057\u3059\u308c\u3070\u3001\u30aa\u30f3\u30d7\u30ec\u30df\u30b9\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u304b\u3089\u30c7\u30d7\u30ed\u30a4\u3067\u304d\u307e\u3057\u305f\u3002\n\n\u30b5\u30dd\u30fc\u30c8\u3059\u308bOS\n==============\n\nThe AWS CodeDeploy agent has been **tested**\n\n-   Amazon Linux 2014.09.1, 2015.03, 2016.03.0, 2016.03.1\n-   Ubuntu Server 14.04 LTS\n-   Windows Server 2008 R2 and Windows Server 2012 R2\n-   Red Hat Enterprise Linux (RHEL) 7.x\n\n\u4eca\u56de\u306f\u3001Ubuntu 16.04.1 LTS\u00a0\u3067\u5b9f\u9a13\u3057\u305f\u305f\u3081\u3001\u30ea\u30b9\u30c8\u306b\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\n>   **The AWS CodeDeploy agent is available as open source for you to adapt to\n>   your needs**. It can be used with other on-premises instance operating\n>   systems. For more information, go to the\u00a0[AWS CodeDeploy Agent](https://github.com/aws/aws-codedeploy-agent)\u00a0repository in GitHub.\n\n\u81ea\u5206\u3067\u76f4\u3057\u3066\u306d\u3001\u3068\u3044\u3046\u3053\u3068\u3067\u3002\n\nUbuntu 16.04.1 LTS\n==================\n\nRuby2.0 \u304c\u52d5\u4f5c\u3059\u308c\u3070\u306a\u3093\u3068\u304b\u306a\u308a\u305d\u3046\u3067\u3059\u3002\n\nruby\u30d1\u30c3\u30b1\u30fc\u30b8\u306f2.3\u306a\u306e\u3067\u3001PPA\u304b\u3089 ruby2.0\n\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u76f4\u63a5\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n$ sudo apt-add-repository ppa:brightbox/ruby-ng\n$ sudo apt-get update\n$ sudo apt-get install ruby2.0 libruby2.0\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n\n\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u3092\u624b\u52d5\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n$ wget https://aws-codedeploy-ap-northeast-1.s3.amazonaws.com/latest/install\n$ wget https://aws-codedeploy-ap-northeast-1.s3.amazonaws.com/latest/VERSION\n$ cat VERSION\n{\"rpm\":\"releases/codedeploy-agent-1.0-1.1037.noarch.rpm\",\"deb\":\"releases/codedeploy-agent_1.0-1.1037_all.deb\",\"msi\":\"releases/codedeploy-agent-1.0.1.998.msi\"}\n$ wget https://aws-codedeploy-ap-northeast-1.s3.amazonaws.com/releases/codedeploy-agent_1.0-1.1037_all.deb\n$ sudo dpkg -i codedeploy-agent_1.0-1.1037_all.deb\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n\ndpkg -L codedeploy-agent\u00a0\u3059\u308b\u3068\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u305f\u30d5\u30a1\u30a4\u30eb\u4e00\u89a7\u304c\u8868\u793a\u3055\u308c\u307e\u3059\u3002\n\n\u4e00\u89a7\u306e\u4e2d\u306b\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u304c\u3042\u308a\u307e\u3057\u305f\u3002\n\n`/etc/codedeploy-agent/conf/codedeployagent.yml`\n\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n---\n:log_aws_wire: false\n:log_dir: '/var/log/aws/codedeploy-agent/'\n:pid_dir: '/opt/codedeploy-agent/state/.pid/'\n:program_name: codedeploy-agent\n:root_dir: '/opt/codedeploy-agent/deployment-root'\n:verbose: false\n:wait_between_runs: 1\n:proxy_uri:\n:max_revisions: 5\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n\n\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n============\n\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n$ export AWS_REGION=us-east-1\n$ NAME=Ubuntu-16\n$ IAM_USER_ARN=arn:aws:iam::XXXXXXXXXXXX:user/XXXXXXXXXX\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n\n\n\u3053\u3053\u3067\u4f7f\u7528\u3059\u308b IAM \u30e6\u30fc\u30b6\u306b\u306f\u3001\u3064\u304e\u306e\u5185\u5bb9\u306e\u30dd\u30ea\u30b7\u30fc\u3092\u30a2\u30bf\u30c3\u30c1\u3057\u3066\u4f5c\u6210\u3057\u3066\u3042\u308a\u307e\u3059\u3002\n\n\n\u30dd\u30ea\u30b7\u30fc > CodeDeply-On-Premises\n\n~~~~~~~\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"codedeploy:*\",\n                \"iam:CreateAccessKey\",\n                \"iam:CreateUser\",\n                \"iam:DeleteAccessKey\",\n                \"iam:DeleteUser\",\n                \"iam:DeleteUserPolicy\",\n                \"iam:ListAccessKeys\",\n                \"iam:ListUserPolicies\",\n                \"iam:PutUserPolicy\",\n                \"iam:GetUser\",\n                \"tag:GetTags\",\n                \"tag:GetResources\"\n            ],\n            \"Resource\": \"*\"\n        },\n        {\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"s3:Get*\",\n                \"s3:List*\"\n            ],\n            \"Resource\": [\n                \"arn:aws:s3:::aws-codedeploy-us-east-1/*\",\n                \"arn:aws:s3:::aws-codedeploy-us-east-2/*\",\n                \"arn:aws:s3:::aws-codedeploy-us-west-1/*\",\n                \"arn:aws:s3:::aws-codedeploy-us-west-2/*\",\n                \"arn:aws:s3:::aws-codedeploy-ap-northeast-1/*\",\n                \"arn:aws:s3:::aws-codedeploy-ap-northeast-2/*\",\n                \"arn:aws:s3:::aws-codedeploy-ap-south-1/*\",\n                \"arn:aws:s3:::aws-codedeploy-ap-southeast-1/*\",\n                \"arn:aws:s3:::aws-codedeploy-ap-southeast-2/*\",\n                \"arn:aws:s3:::aws-codedeploy-eu-central-1/*\",\n                \"arn:aws:s3:::aws-codedeploy-eu-west-1/*\",\n                \"arn:aws:s3:::aws-codedeploy-sa-east-1/*\"\n            ]\n        }\n    ]\n}\n~~~~~~~\n\n\u30aa\u30f3\u30d7\u30ec\u30df\u30b9\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u767b\u9332\n\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n$ aws deploy register-on-premises-instance --instance-name $NAME --iam-user-arn $IAM_USER_ARN --region $AWS_REGION\n$ aws deploy add-tags-to-on-premises-instances\n--instance-name $NAME --tags Key=Name,Value=CodeDeploy-OnPremises\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n\n\u3042\u308b\u3044\u306f\u3001\u4e00\u884c\u3067\u307e\u3068\u3081\u3066\u5b9f\u884c\u3067\u304d\u307e\u3059\u3002\n\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n$ aws deploy register --instance-name $NAME --iam-user-arn $IAM_USER_ARN --region $AWS_REGION --tags Key=Name,Value=CodeDeploy-OnPremises\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n\n\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n$ sudo aws deploy install --override-config --config-file codedeploy.onpremises.yml\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n\n`codedeploy.onpremises.yml`:\n\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n---\naws_access_key_id: XXXXXXXXXXXXXXXXXXXX\naws_secret_access_key: XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\niam_user_arn: arn:aws:iam::XXXXXXXXXXXX:user/XXXXXXXXXX\nregion: us-east-1\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n\n\u30c7\u30d7\u30ed\u30a4\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n======================\n\n\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\naws deploy create-application --application-name MyApp --region $AWS_REGION\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n\n\u30ed\u30fc\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\naws iam create-role --role-name CodeDeploy-OnPremises --assume-role-policy-document file://CodeDeploy-Trust.json\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n\n`CodeDeploy-Trust.json`:\n\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n{ \"Version\": \"2012-10-17\", \"Statement\": [ { \"Sid\": \"\", \"Effect\": \"Allow\", \"Principal\": { \"Service\": [ \"codedeploy.us-east-1.amazonaws.com\" ] }, \"Action\":\n\"sts:AssumeRole\" } ] }\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n$ SERVICE_ROLE_ARN=arn:aws:iam::XXXXXXXXXXXX:role/CodeDeploy-OnPremises\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n\n\u30aa\u30f3\u30d7\u30ec\u30df\u30b9\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u4f7f\u7528\u3059\u308bIAM\u30e6\u30fc\u30b6\u306b\u30ed\u30fc\u30eb\u3092\u30a2\u30bf\u30c3\u30c1\u3057\u307e\u3059\u3002\n\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\naws iam attach-role-policy --role-name CodeDeployServiceRole --policy-arn $SERVICE_ROLE_ARN\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n\n\u30c7\u30d7\u30ed\u30a4\u30e1\u30f3\u30c8\u30b0\u30eb\u30fc\u30d7\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\naws deploy create-deployment-group \\\n--region\u00a0$AWS_REGION --application-name MyApp \\\n--deployment-group-name MyDepGroup \\\n--deployment-config-name CodeDeployDefault.OneAtATime \\\n--on-premises-instance-tag-filters Key=Name,Value=Ubuntu-16,Type=KEY_AND_VALUE \\\n--service-role-arn $SERVICE_ROLE_ARN\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n\n\u30c7\u30d7\u30ed\u30a4\n========\n\n\u30c7\u30d7\u30ed\u30a4\u3057\u3066\u307f\u307e\u3059\u3002\n\n`appspec.yml`:\n\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\nversion: 0.0\nos: linux\nfiles:\n\u00a0 - source: subtree\n\u00a0 \u00a0 destination: /opt/codedeploy-on-premises\n\u00a0 - source: README.md\n\u00a0 \u00a0 destination: /opt/codedeploy-on-premises\n\u00a0 - source: LICENSE\n\u00a0 \u00a0 destination: /opt/codedeploy-on-premises\nhooks:\n\u00a0 ApplicationStop:\n\u00a0 \u00a0 - location: scripts/application-stop.sh\n\u00a0 \u00a0 \u00a0 timeout: 300\n\u00a0 \u00a0 \u00a0 runas: root\n\u00a0 BeforeInstall:\n\u00a0 \u00a0 - location: scripts/before-install.sh\n\u00a0 \u00a0 \u00a0 timeout: 300\n\u00a0 \u00a0 \u00a0 runas: root\n\u00a0 AfterInstall:\n\u00a0 \u00a0 - location: scripts/after-install.sh\n\u00a0 \u00a0 \u00a0 timeout: 300\n\u00a0 \u00a0 \u00a0 runas: root\n\u00a0 ApplicationStart:\n\u00a0 \u00a0 - location: scripts/application-start.sh\n\u00a0 \u00a0 \u00a0 timeout: 300\n\u00a0 \u00a0 \u00a0 runas: root\n\u00a0 ValidateService:\n\u00a0 \u00a0 - location: scripts/validate-service.sh\n\u00a0 \u00a0 \u00a0 timeout: 300\n\u00a0 \u00a0 \u00a0 runas: root\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n$\u00a0aws deploy create-deployment --region $AWS_REGION --application-name MyApp --deployment-config-name CodeDeployDefault.OneAtATime --deployment-group-name MyDepGroup --github-location repository=xxxxx/yyyyyy,commitId=zzzzzzzz\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n\n\u30af\u30ec\u30c7\u30f3\u30b7\u30e3\u30eb\u306b\u3064\u3044\u3066\n======================\n\n-   EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u5834\u5408\n    \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u3067\u8a2d\u5b9a\u3059\u308b\u306e\u3067\u4e0d\u8981\u3067\u3059\u3002\n\n-   \u30aa\u30f3\u30d7\u30ec\u30df\u30b9\n    `codedeploy.onpremises.yml`\u3067\u6307\u5b9a\u3057\u307e\u3059\u3002\n    \u767b\u9332\u3054\u3068\u306b1\u5bfe1\u3067IAM\u30e6\u30fc\u30b6\u304c\u5fc5\u8981\u3067\u3059\u3002\n\n-   Github.com \u3078\u306e\u30a2\u30af\u30bb\u30b9\n    \u30de\u30cd\u30fc\u30b8\u30e1\u30f3\u30c8\u30b3\u30f3\u30bd\u30fc\u30eb\u3067 \u300cGithub\u306b\u63a5\u7d9a\u300d\u3092\u5b9f\u884c\u3057\u3066\u304a\u3051\u3070\u3001\u30c7\u30d7\u30ed\u30a4\u6642\u306bOAuth\u306e\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u304c\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u306b\u6e21\u3063\u3066\u304f\u308b\u3088\u3046\u3067\u3059\u3002\n    \u30ed\u30b0\u3067\u306f\u30de\u30b9\u30af\u3055\u308c\u3066\u3001 \"GitHubAccessToken\"=\\>\"REDACTED\" \u306b\u306a\u308a\u307e\u3059\u3002\n\n\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u306e\u52d5\u4f5c\n==================\n\n\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u306f\u3053\u3053\u306b\u5c55\u958b\u3055\u308c\u307e\u3059\u3002\n\n`/opt/codedeploy-agent/deployment-root/${DEPLOYMENT_GROUP_ID}/${DEPLOYMENT_ID}/deployment-archive`\n\n\n`max_revisions` \u3067\u6307\u5b9a\u3057\u305f\u4e16\u4ee3\u5206\u4fdd\u5b58\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n\u30dd\u30fc\u30ea\u30f3\u30b0\u5bfe\u8c61\u306eURL\u3002\u3053\u3053\u304b\u3089\u30b3\u30de\u30f3\u30c9\u3092\u53d7\u3051\u53d6\u3063\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\n\n`vendor/gems/codedeploy-commands-1.0.0/lib/aws/plugins/deploy_control_endpoint.rb`:\n\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\nurl = \"https://codedeploy-commands.#{cfg.region}.amazonaws.com\"\npoll_host_command(host_identifier:\u00a0IAM_USER_ARN)\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n\n`codedeployagent.yml` \u306b `proxy_uri`\n\u306e\u9805\u76ee\u304c\u3042\u308b\u306e\u3067\u3001\u30d7\u30ed\u30ad\u30b7\u30b5\u30fc\u30d0\u7d4c\u7531\u3067\u3082\u4f7f\u3048\u308b\u3088\u3046\u3067\u3059\u3002(\u672a\u78ba\u8a8d)\n\n\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u306e\u5834\u6240\n\n`/var/log/aws/codedeploy-agent/codedeploy-agent.log`\n`/opt/codedeploy-agent/deployment-root/deployment-logs/codedeploy-agent-deployments.log`\n\n\u30d5\u30c3\u30af\n======\n\n* \u30b9\u30af\u30ea\u30d7\u30c8\u306e\u5b9f\u884c\u3067\u3001\u7d42\u4e86\u30b9\u30c6\u30fc\u30bf\u30b9 0 \u306e\u3068\u304d\u6210\u529f\u3001\u305d\u308c\u4ee5\u5916\u306e\u6642\u306f\u5931\u6557\u3067\u3059\u3002\n\n* ApplicationStop \u3060\u3051\u5b9f\u884c\u30bf\u30a4\u30df\u30f3\u30b0\u304c\u7570\u306a\u308a\u307e\u3059\u3002\n\n* ApplicationStop\u3067\u6307\u5b9a\u3055\u308c\u305f\u30b9\u30af\u30ea\u30d7\u30c8\u306f\u3001\u4eca\u56de\u306e\u30c7\u30d7\u30ed\u30a4\u3067\u306f\u306a\u304f\u3001\u5f8c\u306e\u30c7\u30d7\u30ed\u30a4\u306e\u6642\u306b\u3001\u3053\u306e\u30c7\u30d7\u30ed\u30a4\u3057\u305f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u505c\u6b62\u3059\u308b\u305f\u3081\u306b\u306b\u4f7f\u7528\u3055\u308c\u307e\u3059\u3002\n\nInstall\n=======\n\n`appspec.yml` \u306b\u66f8\u304b\u308c\u305f\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5bfe\u8c61\u306e\u30d5\u30a1\u30a4\u30eb\u306f\u3001Install \u306e\u30b9\u30c6\u30c3\u30d7\u3067\u5b58\u5728\u3057\u3066\u3044\u308c\u3070\u826f\u3044\u3088\u3046\u3067\u3059\u3002\n\n`files:` \u306b\u8a18\u8f09\u3057\u3066\u304a\u3044\u3066\u3001BeforeInstall \u30b9\u30af\u30ea\u30d7\u30c8\u3067\u6e96\u5099\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u305d\u3046\u3067\u3059\u3002\n\n\u305f\u3068\u3048\u3070\u3053\u306e\u3088\u3046\u306b\u3002\n\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\nDEPLOYMENT_ROOT=/opt/codedeploy-agent/deployment-root\nDEPLOYMENT_DIR=$DEPLOYMENT_ROOT/${DEPLOYMENT_GROUP_ID}/${DEPLOYMENT_ID}\n[ -d $DEPLOYMENT_DIR/subtree ] || mkdir $DEPLOYMENT_DIR/subtree\ncd /path/to/workset\ngit pull\nrsync -a --exclude .git . $DEPLOYMENT_DIR/subtree/.\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n\n\u30b9\u30af\u30ea\u30d7\u30c8\u4e2d\u3067\u5229\u7528\u3067\u304d\u308b\u74b0\u5883\u5909\u6570\n================================\n\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\nAPPLICATION_NAME=\u30c7\u30d7\u30ed\u30a4\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u540d\nDEPLOYMENT_GROUP_NAME=\u30c7\u30d7\u30ed\u30a4\u30b0\u30eb\u30fc\u30d7\u540d\nDEPLOYMENT_GROUP_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\nDEPLOYMENT_ID=d-XXXXXXXXX\nLIFECYCLE_EVENT=\u30b9\u30c6\u30fc\u30b8\u540d\nAWS_HOST_IDENTIFIER=codedeploy.onpremises.yml\u306eiam_user_arn\nAWS_ACCESS_KEY=codedeploy.onpremises.yml\u306eaws_access_key_id\nAWS_SECRET_KEY=codedeploy.onpremises.yml\u306eaws_secret_access_key\nAWS_REGION=\u30ea\u30fc\u30b8\u30e7\u30f3\u540d\nPWD=/opt/codedeploy-agent\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n\n\u30b9\u30c6\u30fc\u30b8\u540d: (ApplicationStop|BeforeInstall|AfterInstall|ApplicationStart|ValidateService)\n\n\n\u624b\u5143\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u304b\u3089\u30c7\u30d7\u30ed\u30a4\u3057\u305f\u3044\u3068\u304d\n======================================\n\ngitbucket\u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u3066\u5b9f\u9a13\u3057\u307e\u3057\u305f\u3002\n\n\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u306e `lib/instance_agent/plugins/codedeploy/command_executor.rb`\n\u306e\u4e2d\u306b`download_from_s3()`\u3084`download_from_github()`\u304c\u3042\u308a\u307e\u3059\u3002\n\n\u3053\u3053\u306eURL\u3092\u66f8\u304d\u63db\u3048\u3066\u3001\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u304f\u308b\u30a2\u30fc\u30ab\u30a4\u30d6\u306e\u30bf\u30a4\u30d7\u3082\u5909\u66f4\u3057\u307e\u3057\u305f\u3002\n\n\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n\u00a0 \u00a0 \u00a0 \u00a0 private\n\u00a0 \u00a0 \u00a0 \u00a0 def download_from_github(deployment_spec, account, repo, commit,\nanonymous, token)\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 retries = 0\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 errors = []\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 if InstanceAgent::Platform.util.supported_oses.include? 'windows'\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 deployment_spec.bundle_type = 'zip'\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 format = 'zipball'\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 else\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 #deployment_spec.bundle_type = 'tar'\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 #format = 'tarball'\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 deployment_spec.bundle_type = 'zip'\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 format = 'zip'\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 end\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 #uri = URI.parse(\"https://api.github.com/repos/#{account}/#{repo}/#{format}/#{commit}\")\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 #options = {:ssl_verify_mode => OpenSSL::SSL::VERIFY_PEER, :redirect => true, :ssl_ca_cert => ENV['AWS_SSL_CA_DIRECTORY']}\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 uri = URI.parse(\"https://gitbucket.repository.local/#{account}/#{repo}/archive/#{commit}.#{format}\")\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 options = {:ssl_verify_mode => OpenSSL::SSL::VERIFY_NONE, :redirect => true, :ssl_ca_cert => ENV['AWS_SSL_CA_DIRECTORY']}\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n\n\u00a0\n\n* \u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u306fHTTP/HTTPS\u306e\u307f\u5bfe\u5fdc\u53ef\u80fd\u3067\u3059\u3002\n\n* \u6e21\u305b\u308b\u30d1\u30e9\u30e1\u30fc\u30bf\u304c\u9650\u3089\u308c\u308b\u305f\u3081\u3001\u81ea\u7531\u5ea6\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\n* \u8a8d\u8a3c\u304c\u5fc5\u8981\u306a\u5834\u5408\u306f\u3001\u5225\u9014 BeforeInstall \u30b9\u30af\u30ea\u30d7\u30c8\u3067\u53d6\u5f97\u3059\u308b\u65b9\u304c\u3088\u3055\u305d\u3046\u3067\u3059\u3002\n\n\n\n\u6c17\u306b\u306a\u308b\u70b9\n==========\n\nRuby 2.0.0\u7cfb\u306e\u516c\u5f0f\u30b5\u30dd\u30fc\u30c8\u306f2016\u5e742\u670824\u65e5\u306b\u7d42\u4e86\u3057\u3066\u3044\u307e\u3059\u3002\n\n> Ruby 2.0.0\u7cfb\u306b\u95a2\u3057\u3066\u306f\u4eca\u5f8c\u30d0\u30b0\u4fee\u6b63\u3084\u8106\u5f31\u6027\u4fee\u6b63\u306e\u30d1\u30c3\u30c1\u304c\u30ea\u30ea\u30fc\u30b9\u3055\u308c\u308b\u3053\u3068\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\nRuby 2.3 \u306b\u5bfe\u5fdc\u3059\u308b\u306e\u306f\u3044\u3064\u306b\u306a\u308b\u306e\u3067\u3057\u3087\u3046\u3002\n", "tags": ["AWS", "CodeDeploy"]}