{"context": "Viibar\u30a2\u30c9\u30d9\u30f3\u30c8\u30ab\u30ec\u30f3\u30c0\u30fc\u306e\u30c8\u30c3\u30d7\u30d0\u30c3\u30bf\u30fc\u306f @yagince \u304c\u62c5\u5f53\u81f4\u3057\u307e\u3059\u3002\n\u30c6\u30b9\u30c8\u66f8\u304f\u306e\u304c\u5f53\u305f\u308a\u524d\u306b\u306a\u3063\u3066\u304d\u305f\u6628\u4eca\u3001\u30d5\u30eb\u30c6\u30b9\u30c8\u306fCI\u30b5\u30fc\u30d0\u306b\u4efb\u305b\u308b\u306e\u304c\u5f53\u305f\u308a\u524d\u306b\u306a\u3063\u3066\u3044\u308b\u65b9\u3082\u591a\u3044\u306e\u3067\u306f\u3068\u601d\u3044\u307e\u3059\u3002\n\u3057\u304b\u3057\u3001\u3053\u3093\u306a\u4e8b\u3042\u308a\u307e\u305b\u3093\u304b\uff1f\n\nCI\u306e\u30ad\u30e5\u30fc\u304c\u3081\u3063\u3061\u3083\u6e9c\u307e\u3063\u3066\u3057\u307e\u3046\n\u30a4\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8\u7e4b\u304c\u3089\u306a\u3044\u74b0\u5883\u306b\u3044\u308b\u6642\u306b\u30ea\u30e2\u30fc\u30c8\u306bpush\u3067\u304d\u306a\u3044\n\n\u305d\u3093\u306a\u6642\u3001\u30ed\u30fc\u30ab\u30eb\u3067\u30d5\u30eb\u30c6\u30b9\u30c8\u6d41\u3057\u305f\u3044\uff01\u3063\u3066\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3088\u306d\u3002\n\u306f\u3044\u3001\u79c1\u306f\u306a\u308a\u307e\u3057\u305f\u3002\n\u3068\u3044\u3046\u308f\u3051\u3067\u3001\u4eca\u56de\u306f\u30ed\u30fc\u30ab\u30eb\u74b0\u5883\u3067\u30d5\u30eb\u30c6\u30b9\u30c8\u6d41\u3059\u306e\u3092\u9811\u5f35\u308b\u305f\u3081\u306b\u3084\u3063\u305f\u3053\u3068\u3092\u66f8\u304d\u307e\u3059\u3002\n\u203b\u4eca\u56de\u306f\u30c6\u30b9\u30c8\u81ea\u4f53\u3092\u30ea\u30d5\u30a1\u30af\u30bf\u30ea\u30f3\u30b0\u3059\u308b\u306e\u3067\u306f\u306a\u304f\u30c4\u30fc\u30eb\u3084\u8a2d\u5b9a\u3092\u5909\u66f4\u3059\u308b\u4e8b\u3067\u6539\u5584\u3092\u8a66\u307f\u307e\u3059\n\n\u524d\u63d0\n\nRuby: 2.2.2\nRails: 4.2.3\nMySQL: 5.6.27\nOS: Mac OSX 10.10.5\n\n\n\u307e\u305a\u306f\u30d5\u30eb\u30c6\u30b9\u30c8\u6d41\u3057\u3066\u307f\u308b\n$ bin/rspec spec --format progress\n\n\u3053\u306e\u6642\u70b9\u3067\u300170\u5206\u524d\u5f8c\u304b\u304b\u3063\u3066\u307e\u3057\u305f\u3002\n\n\u30a2\u30d7\u30ed\u30fc\u30c11 : \u5206\u6563\u3055\u305b\u3066\u3059\u3053\u3057\u3067\u3082\u901f\u304f\u7d42\u308f\u308b\u3088\u3046\u306b\u3059\u308b\nRSpec\u306e\u5206\u6563\u5b9f\u884c\u3068\u3057\u3066\u306f\n\nRRRSpec\nparallel_tests\ntest-queue\n\n\u306a\u3069\u304c\u6709\u540d\u304b\u3068\u601d\u3044\u307e\u3059\u304c\u3001\u4eca\u56de\u306f\u4e00\u756a\u624b\u8efd\u306b\u51fa\u6765\u305d\u3046\u306atest-queue\u3092\u63a1\u7528\u3057\u307e\u3057\u305f\u3002\n\n\u5b9f\u884c\u7528\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u66f8\u304f\nGemfile\n...\n  gem 'test-queue'\n...\n\nbin/rspec-testqueue (\u540d\u524d\u306f\u306a\u3093\u3067\u3082\u826f\u3044\u3067\u3059)\n#!/usr/bin/env ruby\n\nENV['RAILS_ENV'] ||= 'test'\nrequire File.expand_path('../../config/environment', __FILE__)\n\nrequire 'test_queue'\nrequire 'test_queue/runner/rspec'\n\nclass RSpecTestQueueRunner < TestQueue::Runner::RSpec\n  def after_fork(num)\n    ENV.update('TEST_ENV_NUMBER' => num.to_s)\n\n    ActiveRecord::Base.configurations['test']['database'] << num.to_s\n    ActiveRecord::Base.establish_connection(:test)\n\n    ActiveRecord::Tasks::DatabaseTasks.drop_current\n    ActiveRecord::Tasks::DatabaseTasks.create_current\n    ActiveRecord::Tasks::DatabaseTasks.load_schema_current\n  end\n\n  def summarize\n    estatus = @completed.inject(0){ |s, worker| s + worker.status.exitstatus }\n    estatus = 255 if estatus > 255\n    exit(estatus)\n  end\n\n  def run_worker(iterator)\n    @run_worker_ret = super\n  end\n\n  def cleanup_worker\n    Kernel.exit @run_worker_ret if @run_worker_ret\n  end\nend\n\nRSpecTestQueueRunner.new.execute\n\n\n\nafter_fork\u3067\u3084\u3063\u3066\u3044\u308b\u3053\u3068\n\n\ndatabase\u540d\u306bsuffix\u3068\u3057\u3066\u6570\u5b57\u3092\u8ffd\u52a0\n\n\n\u901a\u5e38\u306e\u30c6\u30b9\u30c8\u7528\u306e\u30b9\u30ad\u30fc\u30de\u3068\u5206\u3051\u308b\u70ba\n\u5206\u6563\u3057\u305f\u74b0\u5883\u6bce\u306b\u30b9\u30ad\u30fc\u30de\u3092\u7528\u610f\u3059\u308b\u70ba\n\n\n\u30c6\u30fc\u30d6\u30eb\u3092\u5168\u3066drop\n\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\u3057\u306a\u304a\u3059\n\n\n\n\n\u5b9f\u884c\u3057\u3066\u307f\u308b\n$ time TEST_QUEUE_WORKERS=5 bin/rspec-testqueue spec --format progress\nTEST_QUEUE_WORKERS=5 bin/rspec-testqueue spec --format progress --color  1990.74s user 352.09s system 77% cpu 50:31.70 total\n\n\n\nTEST_QUEUE_WORKERS\u30675worker\u7acb\u3061\u4e0a\u3052\u3066\u307e\u3059\n\n\n\u30c7\u30d5\u30a9\u30eb\u30c8\u3060\u3068\u30de\u30b7\u30f3\u306e\u30b3\u30a2\u6570\u5206\u306eworker\u304c\u8d77\u52d5\u3055\u308c\u307e\u3059\n\u81ea\u5206\u306e\u74b0\u5883\u3060\u3068\u30b3\u30a2\u6570\u4ee5\u4e0a\u306b\u3042\u3052\u3066\u3082\u3053\u306e\u6642\u70b9\u3067\u306f\u3042\u307e\u308a\u5909\u308f\u308a\u307e\u305b\u3093\u3067\u3057\u305f\n\n\n\u7d50\u679c\n\n\n\u5b9f\u884c\u6642\u9593: \u7d0450\u5206\n\n20\u5206\u304f\u3089\u3044\u77ed\u7e2e\u3067\u304d\u307e\u3057\u305f\n\n\n\n\n\u30a2\u30d7\u30ed\u30fc\u30c12 : \u30ef\u30fc\u30cb\u30f3\u30b0\u306e\u51fa\u529b\u3092\u6e1b\u3089\u3059\nfeature spec\u306e\u5b9f\u884c\u6642\u306bCapybara\u304c\u5916\u90e8\u306eURL\u3092\u30d6\u30ed\u30c3\u30af\u3057\u305f\u8b66\u544a\u304c\u5927\u91cf\u306b\u51fa\u3066\u3044\u305f\u70ba\n\u305d\u308c\u3092\u6291\u5236\u3059\u308b\u70ba\u306b\u3001rails_helper.rb\u306b\u4ee5\u4e0b\u3092\u8ffd\u52a0\u3057\u307e\u3057\u305f\u3002\nCapybara::Webkit.configure do |config|\n  config.block_unknown_urls\nend\n\n\n\u5b9f\u884c\u3057\u3066\u307f\u308b\n$ time bin/rspec-testqueue spec --format progress\nbin/rspec-testqueue spec --format progress  1601.61s user 215.14s system 80% cpu 37:46.18 total\n\n\n\u7d50\u679c\n\n\n\u5b9f\u884c\u6642\u9593: \u7d0438\u5206\n\n\n12\u301c13\u5206\u901f\u304f\u306a\u3063\u305f\n\n\n\n\n\u30a2\u30d7\u30ed\u30fc\u30c13 : Database\u306e\u30af\u30ea\u30fc\u30f3\u30a2\u30c3\u30d7\u3092\u6539\u5584\u3059\u308b\n\u3053\u308c\u307e\u3067\u5f0a\u793e\u3067\u306fDatabaseCleaner\u3092\u4f7f\u3063\u3066\u3044\u307e\u3057\u305f\u304c\u3001DatabaseRewinder\u3092\u8a66\u3057\u3066\u307f\u308b\u4e8b\u306b\u3057\u307e\u3057\u305f\u3002\n\u3057\u304b\u3057\u3001\u3053\u308c\u304c\u306a\u304b\u306a\u304b\u66f2\u8005\u3067\u82e6\u52b4\u3057\u307e\u3057\u305f\u3002\n\nrails_helper.rb\u3067DatabaseRewinder\u3092\u4f7f\u3046\u3088\u3046\u306b\u4fee\u6b63\u3059\u308b\nREADME\u901a\u308a\u306b\u76f4\u3057\u305f\u3060\u3051\u3067\u7d42\u4e86\u3067\u3057\u305f\u3002\n\n\u5b9f\u884c\u3057\u3066\u307f\u308b\n$ time bin/rspec-testqueue spec --format progress\n...\nvendor/bundle/ruby/2.2.0/gems/activerecord-4.2.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:446:in `checkout_new_connection': ActiveRecord::ConnectionNotEstablished (ActiveRecord::ConnectionNotEstablished)\n...\n\n\u30a8\u30e9\u30fc\u767a\u751f\n\u203b\u3061\u306a\u307f\u306b\u3001test-queue\u3067\u306f\u306a\u304f\u666e\u901a\u306brspec\u30b3\u30de\u30f3\u30c9\u3067\u5b9f\u884c\u3059\u308b\u3068\u554f\u984c\u3042\u308a\u307e\u305b\u3093\u3067\u3057\u305f\n\u30b9\u30bf\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\u5168\u6587\n/******/vendor/bundle/ruby/2.2.0/gems/activerecord-4.2.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:446:in `checkout_new_connection': ActiveRecord::ConnectionNotEstablished (ActiveRecord::ConnectionNotEstablished)\n        from /******/vendor/bundle/ruby/2.2.0/gems/activerecord-4.2.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:422:in `acquire_connection'\n        from /******/vendor/bundle/ruby/2.2.0/gems/activerecord-4.2.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:349:in `block in checkout'\n        from /${HOME}/.rbenv/versions/2.2.2/lib/ruby/2.2.0/monitor.rb:211:in `mon_synchronize'\n        from /******/vendor/bundle/ruby/2.2.0/gems/activerecord-4.2.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:348:in `checkout'\n        from /******/vendor/bundle/ruby/2.2.0/gems/activerecord-4.2.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:263:in `block in connection'\n        from /${HOME}/.rbenv/versions/2.2.2/lib/ruby/2.2.0/monitor.rb:211:in `mon_synchronize'\n        from /******/vendor/bundle/ruby/2.2.0/gems/activerecord-4.2.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:262:in `connection'\n        from /******/vendor/bundle/ruby/2.2.0/gems/database_rewinder-0.5.3/lib/database_rewinder/cleaner.rb:29:in `clean_all'\n        from /******/vendor/bundle/ruby/2.2.0/gems/database_rewinder-0.5.3/lib/database_rewinder.rb:85:in `each'\n        from /******/vendor/bundle/ruby/2.2.0/gems/database_rewinder-0.5.3/lib/database_rewinder.rb:85:in `clean_all'\n        from /******/spec/rails_helper.rb:111:in `block (2 levels) in <top (required)>'\n        from /******/vendor/bundle/ruby/2.2.0/gems/rspec-core-3.4.0/lib/rspec/core/example.rb:424:in `instance_exec'\n        from /******/vendor/bundle/ruby/2.2.0/gems/rspec-core-3.4.0/lib/rspec/core/example.rb:424:in `instance_exec'\n        from /******/vendor/bundle/ruby/2.2.0/gems/rspec-core-3.4.0/lib/rspec/core/hooks.rb:357:in `run'\n        from /******/vendor/bundle/ruby/2.2.0/gems/rspec-core-3.4.0/lib/rspec/core/configuration.rb:1724:in `block in run_hooks_with'\n        from /******/vendor/bundle/ruby/2.2.0/gems/rspec-core-3.4.0/lib/rspec/core/configuration.rb:1724:in `each'\n        from /******/vendor/bundle/ruby/2.2.0/gems/rspec-core-3.4.0/lib/rspec/core/configuration.rb:1724:in `run_hooks_with'\n        from /******/vendor/bundle/ruby/2.2.0/gems/rspec-core-3.4.0/lib/rspec/core/configuration.rb:1679:in `with_suite_hooks'\n        from /******/vendor/bundle/ruby/2.2.0/gems/test-queue-0.2.13/lib/test_queue/runner/rspec3.rb:30:in `block in run_specs'\n        from /******/vendor/bundle/ruby/2.2.0/gems/rspec-core-3.4.0/lib/rspec/core/reporter.rb:77:in `report'\n        from /******/vendor/bundle/ruby/2.2.0/gems/test-queue-0.2.13/lib/test_queue/runner/rspec3.rb:29:in `run_specs'\n        from /******/vendor/bundle/ruby/2.2.0/gems/test-queue-0.2.13/lib/test_queue/runner/rspec.rb:22:in `run_worker'\n        from bin/rspec-testqueue:35:in `run_worker'\n        from /******/vendor/bundle/ruby/2.2.0/gems/test-queue-0.2.13/lib/test_queue/runner.rb:228:in `block (2 levels) in spawn_workers'\n        from /******/vendor/bundle/ruby/2.2.0/gems/test-queue-0.2.13/lib/test_queue/runner.rb:223:in `fork'\n        from /******/vendor/bundle/ruby/2.2.0/gems/test-queue-0.2.13/lib/test_queue/runner.rb:223:in `block in spawn_workers'\n        from /******/vendor/bundle/ruby/2.2.0/gems/test-queue-0.2.13/lib/test_queue/runner.rb:220:in `times'\n        from /******/vendor/bundle/ruby/2.2.0/gems/test-queue-0.2.13/lib/test_queue/runner.rb:220:in `spawn_workers'\n        from /******/vendor/bundle/ruby/2.2.0/gems/test-queue-0.2.13/lib/test_queue/runner.rb:160:in `execute_parallel'\n        from /******/vendor/bundle/ruby/2.2.0/gems/test-queue-0.2.13/lib/test_queue/runner.rb:94:in `execute'\n        from bin/rspec-testqueue:43:in `<main>'\n\n\u4e00\u90e8\u4f0f\u305b\u3066\u307e\u3059\u304c\u3001\u95a2\u4fc2\u306a\u3044\u3067\u3059\n\n\u4e8b\u8c61\n\u30b9\u30bf\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\u3092\u8ffd\u3063\u3066\u307f\u308b\u3068...\n\n\nDatabaseRewinder.clean_all\u3067\u30a8\u30e9\u30fc\u306b\u306a\u3063\u3066\u3044\u308b\n\nDatabaseRewinder.clean_all\u304b\u3089Cleaner\u306e#clean_all\u306b\u884c\u3063\u3066\nActiveRecord\u306eConnectionPool#connection\u306b\u884c\u3063\u3066\nconnection\u304c\u7121\u3044\u70ba\u3001\u306a\u3093\u3060\u304b\u3093\u3060\u3067\u3001\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u3092\u65b0\u3057\u304f\u5f35\u308d\u3046\u3068\u3057\u3066\n\u6700\u7d42\u7684\u306b\u306f\u3001checkout_new_connection\u3067ConnectionNotEstablished\u304craise\u3055\u308c\u3066\u3044\u305f\n\n\n\u539f\u56e0\n\ntest-queue\u306eafter_fork\u3067establish_connection\u3057\u305f\u6642\u306b\n\nremove_connection\u3055\u308c\u3066\n\n@automatic_connection\u304cfalse\u306b\u5909\u66f4\u3055\u308c\u3066\u3044\u308b\n\u306a\u306e\u3067\u3001DatabaseRewinder\u304c\u30ad\u30e3\u30c3\u30b7\u30e5\u3057\u3066\u3044\u308bconnection_pool\u304c\u5f8c\u304b\u3089\u30ea\u30b3\u30cd\u30af\u30c8\u3067\u304d\u306a\u3044\u72b6\u614b\u306b\u306a\u3063\u3066\u3044\u308b\u3088\u3046\u306b\u898b\u3048\u308b\n\n\n\u89e3\u6c7a\u7b56\nafter_fork\u5185\u3067\u3001database\u95a2\u9023\u306e\u6e96\u5099\u3092\u3057\u7d42\u308f\u3063\u305f\u5f8c\u306b\u3001\nDatabaseRewinder.init\u3059\u308b\u3053\u3068\u3067\u4e00\u65e6\u89e3\u6c7a\n...\nclass RSpecTestQueueRunner < TestQueue::Runner::RSpec\n  def after_fork(num)\n    ENV.update('TEST_ENV_NUMBER' => num.to_s)\n\n    ActiveRecord::Base.configurations['test']['database'] << num.to_s\n    ActiveRecord::Base.establish_connection(:test)\n\n    ActiveRecord::Tasks::DatabaseTasks.drop_current\n    ActiveRecord::Tasks::DatabaseTasks.create_current\n    ActiveRecord::Tasks::DatabaseTasks.load_schema_current\n\n    DatabaseRewinder.init\n  end\n...\nend\n\n\n\u5b9f\u884c\u3057\u3066\u307f\u308b\nbin/rspec-testqueue spec --format progress  1667.93s user 171.16s system 292% cpu 10:28.34 total\n\n\n\u7d50\u679c\n\n\n\u5b9f\u884c\u6642\u9593: \u7d0410\u5206\n\n\u7d0430\u5206\u901f\u304f\u306a\u3063\u305f\nmysqld\u306e\u8ca0\u8377\u304c\u8d85\u7d76\u8efd\u304f\u306a\u3063\u305f\nBefore\n\n\n\n\n\nAfter\n\n\n\n\n\n\n\n\n\n\u307e\u3068\u3081\n\ntest-queue\u3067\u5206\u6563\n\u30ed\u30b0\u306fI/O\u767a\u751f\u3059\u308b\u306e\u3067\u3001\u51fa\u529b\u3057\u307e\u304f\u308b\u3068\u3084\u3063\u3071\u308a\u9045\u3044\n\u8907\u6570\u30d7\u30ed\u30bb\u30b9\u306b\u5206\u6563\u3055\u305b\u308b\u3060\u3051\u3067\u540c\u3058DBServer\u3092\u4f7f\u3046\u3068\u7d50\u5c40DB\u306e\u8ca0\u8377\u304c\u3042\u304c\u3063\u3066\u901f\u304f\u306a\u3089\u306a\u3044\n\u30c6\u30b9\u30c8\u81ea\u4f53\u3092\u30ea\u30d5\u30a1\u30af\u30bf\u30ea\u30f3\u30b0\u305b\u305a\u3068\u3082\u3053\u3053\u307e\u3067\u306f\u3084\u308c\u308b\nBefore: 70m After: 10m \u7d0460\u5206\u77ed\u7e2e\n\n\nViibar\u30a2\u30c9\u30d9\u30f3\u30c8\u30ab\u30ec\u30f3\u30c0\u30fc\u306e\u30c8\u30c3\u30d7\u30d0\u30c3\u30bf\u30fc\u306f @yagince \u304c\u62c5\u5f53\u81f4\u3057\u307e\u3059\u3002\n\n\u30c6\u30b9\u30c8\u66f8\u304f\u306e\u304c\u5f53\u305f\u308a\u524d\u306b\u306a\u3063\u3066\u304d\u305f\u6628\u4eca\u3001\u30d5\u30eb\u30c6\u30b9\u30c8\u306fCI\u30b5\u30fc\u30d0\u306b\u4efb\u305b\u308b\u306e\u304c\u5f53\u305f\u308a\u524d\u306b\u306a\u3063\u3066\u3044\u308b\u65b9\u3082\u591a\u3044\u306e\u3067\u306f\u3068\u601d\u3044\u307e\u3059\u3002\n\u3057\u304b\u3057\u3001\u3053\u3093\u306a\u4e8b\u3042\u308a\u307e\u305b\u3093\u304b\uff1f\n\n- CI\u306e\u30ad\u30e5\u30fc\u304c\u3081\u3063\u3061\u3083\u6e9c\u307e\u3063\u3066\u3057\u307e\u3046\n- \u30a4\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8\u7e4b\u304c\u3089\u306a\u3044\u74b0\u5883\u306b\u3044\u308b\u6642\u306b\u30ea\u30e2\u30fc\u30c8\u306bpush\u3067\u304d\u306a\u3044\n\n\u305d\u3093\u306a\u6642\u3001\u30ed\u30fc\u30ab\u30eb\u3067\u30d5\u30eb\u30c6\u30b9\u30c8\u6d41\u3057\u305f\u3044\uff01\u3063\u3066\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3088\u306d\u3002\n\u306f\u3044\u3001\u79c1\u306f\u306a\u308a\u307e\u3057\u305f\u3002\n\n\u3068\u3044\u3046\u308f\u3051\u3067\u3001\u4eca\u56de\u306f\u30ed\u30fc\u30ab\u30eb\u74b0\u5883\u3067\u30d5\u30eb\u30c6\u30b9\u30c8\u6d41\u3059\u306e\u3092\u9811\u5f35\u308b\u305f\u3081\u306b\u3084\u3063\u305f\u3053\u3068\u3092\u66f8\u304d\u307e\u3059\u3002\n\n**\u203b\u4eca\u56de\u306f\u30c6\u30b9\u30c8\u81ea\u4f53\u3092\u30ea\u30d5\u30a1\u30af\u30bf\u30ea\u30f3\u30b0\u3059\u308b\u306e\u3067\u306f\u306a\u304f\u30c4\u30fc\u30eb\u3084\u8a2d\u5b9a\u3092\u5909\u66f4\u3059\u308b\u4e8b\u3067\u6539\u5584\u3092\u8a66\u307f\u307e\u3059**\n\n# \u524d\u63d0\n\n- Ruby: 2.2.2\n- Rails: 4.2.3\n- MySQL: 5.6.27\n- OS: Mac OSX 10.10.5\n\n# \u307e\u305a\u306f\u30d5\u30eb\u30c6\u30b9\u30c8\u6d41\u3057\u3066\u307f\u308b\n\n```\n$ bin/rspec spec --format progress\n```\n\n\u3053\u306e\u6642\u70b9\u3067\u3001**70\u5206\u524d\u5f8c**\u304b\u304b\u3063\u3066\u307e\u3057\u305f\u3002\n\n# \u30a2\u30d7\u30ed\u30fc\u30c11 : \u5206\u6563\u3055\u305b\u3066\u3059\u3053\u3057\u3067\u3082\u901f\u304f\u7d42\u308f\u308b\u3088\u3046\u306b\u3059\u308b\n\nRSpec\u306e\u5206\u6563\u5b9f\u884c\u3068\u3057\u3066\u306f\n\n- [RRRSpec](https://github.com/cookpad/rrrspec)\n- [parallel_tests](https://github.com/grosser/parallel_tests)\n- [test-queue](https://github.com/tmm1/test-queue)\n\n\u306a\u3069\u304c\u6709\u540d\u304b\u3068\u601d\u3044\u307e\u3059\u304c\u3001\u4eca\u56de\u306f\u4e00\u756a\u624b\u8efd\u306b\u51fa\u6765\u305d\u3046\u306a**test-queue**\u3092\u63a1\u7528\u3057\u307e\u3057\u305f\u3002\n\n## \u5b9f\u884c\u7528\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u66f8\u304f\n\nGemfile\n\n```rb\n...\n  gem 'test-queue'\n...\n```\n\nbin/rspec-testqueue (\u540d\u524d\u306f\u306a\u3093\u3067\u3082\u826f\u3044\u3067\u3059)\n\n```rb\n#!/usr/bin/env ruby\n\nENV['RAILS_ENV'] ||= 'test'\nrequire File.expand_path('../../config/environment', __FILE__)\n\nrequire 'test_queue'\nrequire 'test_queue/runner/rspec'\n\nclass RSpecTestQueueRunner < TestQueue::Runner::RSpec\n  def after_fork(num)\n    ENV.update('TEST_ENV_NUMBER' => num.to_s)\n\n    ActiveRecord::Base.configurations['test']['database'] << num.to_s\n    ActiveRecord::Base.establish_connection(:test)\n\n    ActiveRecord::Tasks::DatabaseTasks.drop_current\n    ActiveRecord::Tasks::DatabaseTasks.create_current\n    ActiveRecord::Tasks::DatabaseTasks.load_schema_current\n  end\n\n  def summarize\n    estatus = @completed.inject(0){ |s, worker| s + worker.status.exitstatus }\n    estatus = 255 if estatus > 255\n    exit(estatus)\n  end\n\n  def run_worker(iterator)\n    @run_worker_ret = super\n  end\n\n  def cleanup_worker\n    Kernel.exit @run_worker_ret if @run_worker_ret\n  end\nend\n\nRSpecTestQueueRunner.new.execute\n```\n\n- `after_fork`\u3067\u3084\u3063\u3066\u3044\u308b\u3053\u3068\n    - database\u540d\u306bsuffix\u3068\u3057\u3066\u6570\u5b57\u3092\u8ffd\u52a0\n        - \u901a\u5e38\u306e\u30c6\u30b9\u30c8\u7528\u306e\u30b9\u30ad\u30fc\u30de\u3068\u5206\u3051\u308b\u70ba\n        - \u5206\u6563\u3057\u305f\u74b0\u5883\u6bce\u306b\u30b9\u30ad\u30fc\u30de\u3092\u7528\u610f\u3059\u308b\u70ba\n    - \u30c6\u30fc\u30d6\u30eb\u3092\u5168\u3066drop\n    - \u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\u3057\u306a\u304a\u3059\n\n## \u5b9f\u884c\u3057\u3066\u307f\u308b\n\n```\n$ time TEST_QUEUE_WORKERS=5 bin/rspec-testqueue spec --format progress\nTEST_QUEUE_WORKERS=5 bin/rspec-testqueue spec --format progress --color  1990.74s user 352.09s system 77% cpu 50:31.70 total\n```\n\n- `TEST_QUEUE_WORKERS`\u30675worker\u7acb\u3061\u4e0a\u3052\u3066\u307e\u3059\n    - \u30c7\u30d5\u30a9\u30eb\u30c8\u3060\u3068\u30de\u30b7\u30f3\u306e\u30b3\u30a2\u6570\u5206\u306eworker\u304c\u8d77\u52d5\u3055\u308c\u307e\u3059\n    - \u81ea\u5206\u306e\u74b0\u5883\u3060\u3068\u30b3\u30a2\u6570\u4ee5\u4e0a\u306b\u3042\u3052\u3066\u3082\u3053\u306e\u6642\u70b9\u3067\u306f\u3042\u307e\u308a\u5909\u308f\u308a\u307e\u305b\u3093\u3067\u3057\u305f\n- \u7d50\u679c\n    - \u5b9f\u884c\u6642\u9593: **\u7d0450\u5206**\n    - **20\u5206\u304f\u3089\u3044\u77ed\u7e2e\u3067\u304d\u307e\u3057\u305f**\n\n# \u30a2\u30d7\u30ed\u30fc\u30c12 : \u30ef\u30fc\u30cb\u30f3\u30b0\u306e\u51fa\u529b\u3092\u6e1b\u3089\u3059\n\nfeature spec\u306e\u5b9f\u884c\u6642\u306bCapybara\u304c\u5916\u90e8\u306eURL\u3092\u30d6\u30ed\u30c3\u30af\u3057\u305f\u8b66\u544a\u304c\u5927\u91cf\u306b\u51fa\u3066\u3044\u305f\u70ba\n\u305d\u308c\u3092\u6291\u5236\u3059\u308b\u70ba\u306b\u3001`rails_helper.rb`\u306b\u4ee5\u4e0b\u3092\u8ffd\u52a0\u3057\u307e\u3057\u305f\u3002\n\n```rb\nCapybara::Webkit.configure do |config|\n  config.block_unknown_urls\nend\n```\n\n## \u5b9f\u884c\u3057\u3066\u307f\u308b\n\n```\n$ time bin/rspec-testqueue spec --format progress\nbin/rspec-testqueue spec --format progress  1601.61s user 215.14s system 80% cpu 37:46.18 total\n```\n\n- \u7d50\u679c\n    - \u5b9f\u884c\u6642\u9593: **\u7d0438\u5206**\n    - **12\u301c13\u5206**\u901f\u304f\u306a\u3063\u305f\n\n# \u30a2\u30d7\u30ed\u30fc\u30c13 : Database\u306e\u30af\u30ea\u30fc\u30f3\u30a2\u30c3\u30d7\u3092\u6539\u5584\u3059\u308b\n\n\u3053\u308c\u307e\u3067\u5f0a\u793e\u3067\u306f[DatabaseCleaner](https://github.com/DatabaseCleaner/database_cleaner)\u3092\u4f7f\u3063\u3066\u3044\u307e\u3057\u305f\u304c\u3001[DatabaseRewinder](https://github.com/amatsuda/database_rewinder)\u3092\u8a66\u3057\u3066\u307f\u308b\u4e8b\u306b\u3057\u307e\u3057\u305f\u3002\n\n\u3057\u304b\u3057\u3001\u3053\u308c\u304c\u306a\u304b\u306a\u304b\u66f2\u8005\u3067\u82e6\u52b4\u3057\u307e\u3057\u305f\u3002\n\n## `rails_helper.rb`\u3067DatabaseRewinder\u3092\u4f7f\u3046\u3088\u3046\u306b\u4fee\u6b63\u3059\u308b\n\n[README\u901a\u308a](https://github.com/amatsuda/database_rewinder#basic-configuration)\u306b\u76f4\u3057\u305f\u3060\u3051\u3067\u7d42\u4e86\u3067\u3057\u305f\u3002\n\n## \u5b9f\u884c\u3057\u3066\u307f\u308b\n\n```\n$ time bin/rspec-testqueue spec --format progress\n...\nvendor/bundle/ruby/2.2.0/gems/activerecord-4.2.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:446:in `checkout_new_connection': ActiveRecord::ConnectionNotEstablished (ActiveRecord::ConnectionNotEstablished)\n...\n```\n\n**\u30a8\u30e9\u30fc\u767a\u751f**\n\n\u203b\u3061\u306a\u307f\u306b\u3001test-queue\u3067\u306f\u306a\u304f\u666e\u901a\u306brspec\u30b3\u30de\u30f3\u30c9\u3067\u5b9f\u884c\u3059\u308b\u3068\u554f\u984c\u3042\u308a\u307e\u305b\u3093\u3067\u3057\u305f\n\n\u30b9\u30bf\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\u5168\u6587\n\n```\n/******/vendor/bundle/ruby/2.2.0/gems/activerecord-4.2.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:446:in `checkout_new_connection': ActiveRecord::ConnectionNotEstablished (ActiveRecord::ConnectionNotEstablished)\n        from /******/vendor/bundle/ruby/2.2.0/gems/activerecord-4.2.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:422:in `acquire_connection'\n        from /******/vendor/bundle/ruby/2.2.0/gems/activerecord-4.2.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:349:in `block in checkout'\n        from /${HOME}/.rbenv/versions/2.2.2/lib/ruby/2.2.0/monitor.rb:211:in `mon_synchronize'\n        from /******/vendor/bundle/ruby/2.2.0/gems/activerecord-4.2.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:348:in `checkout'\n        from /******/vendor/bundle/ruby/2.2.0/gems/activerecord-4.2.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:263:in `block in connection'\n        from /${HOME}/.rbenv/versions/2.2.2/lib/ruby/2.2.0/monitor.rb:211:in `mon_synchronize'\n        from /******/vendor/bundle/ruby/2.2.0/gems/activerecord-4.2.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:262:in `connection'\n        from /******/vendor/bundle/ruby/2.2.0/gems/database_rewinder-0.5.3/lib/database_rewinder/cleaner.rb:29:in `clean_all'\n        from /******/vendor/bundle/ruby/2.2.0/gems/database_rewinder-0.5.3/lib/database_rewinder.rb:85:in `each'\n        from /******/vendor/bundle/ruby/2.2.0/gems/database_rewinder-0.5.3/lib/database_rewinder.rb:85:in `clean_all'\n        from /******/spec/rails_helper.rb:111:in `block (2 levels) in <top (required)>'\n        from /******/vendor/bundle/ruby/2.2.0/gems/rspec-core-3.4.0/lib/rspec/core/example.rb:424:in `instance_exec'\n        from /******/vendor/bundle/ruby/2.2.0/gems/rspec-core-3.4.0/lib/rspec/core/example.rb:424:in `instance_exec'\n        from /******/vendor/bundle/ruby/2.2.0/gems/rspec-core-3.4.0/lib/rspec/core/hooks.rb:357:in `run'\n        from /******/vendor/bundle/ruby/2.2.0/gems/rspec-core-3.4.0/lib/rspec/core/configuration.rb:1724:in `block in run_hooks_with'\n        from /******/vendor/bundle/ruby/2.2.0/gems/rspec-core-3.4.0/lib/rspec/core/configuration.rb:1724:in `each'\n        from /******/vendor/bundle/ruby/2.2.0/gems/rspec-core-3.4.0/lib/rspec/core/configuration.rb:1724:in `run_hooks_with'\n        from /******/vendor/bundle/ruby/2.2.0/gems/rspec-core-3.4.0/lib/rspec/core/configuration.rb:1679:in `with_suite_hooks'\n        from /******/vendor/bundle/ruby/2.2.0/gems/test-queue-0.2.13/lib/test_queue/runner/rspec3.rb:30:in `block in run_specs'\n        from /******/vendor/bundle/ruby/2.2.0/gems/rspec-core-3.4.0/lib/rspec/core/reporter.rb:77:in `report'\n        from /******/vendor/bundle/ruby/2.2.0/gems/test-queue-0.2.13/lib/test_queue/runner/rspec3.rb:29:in `run_specs'\n        from /******/vendor/bundle/ruby/2.2.0/gems/test-queue-0.2.13/lib/test_queue/runner/rspec.rb:22:in `run_worker'\n        from bin/rspec-testqueue:35:in `run_worker'\n        from /******/vendor/bundle/ruby/2.2.0/gems/test-queue-0.2.13/lib/test_queue/runner.rb:228:in `block (2 levels) in spawn_workers'\n        from /******/vendor/bundle/ruby/2.2.0/gems/test-queue-0.2.13/lib/test_queue/runner.rb:223:in `fork'\n        from /******/vendor/bundle/ruby/2.2.0/gems/test-queue-0.2.13/lib/test_queue/runner.rb:223:in `block in spawn_workers'\n        from /******/vendor/bundle/ruby/2.2.0/gems/test-queue-0.2.13/lib/test_queue/runner.rb:220:in `times'\n        from /******/vendor/bundle/ruby/2.2.0/gems/test-queue-0.2.13/lib/test_queue/runner.rb:220:in `spawn_workers'\n        from /******/vendor/bundle/ruby/2.2.0/gems/test-queue-0.2.13/lib/test_queue/runner.rb:160:in `execute_parallel'\n        from /******/vendor/bundle/ruby/2.2.0/gems/test-queue-0.2.13/lib/test_queue/runner.rb:94:in `execute'\n        from bin/rspec-testqueue:43:in `<main>'\n```\n\n\u4e00\u90e8\u4f0f\u305b\u3066\u307e\u3059\u304c\u3001\u95a2\u4fc2\u306a\u3044\u3067\u3059\n\n## \u4e8b\u8c61\n\n\u30b9\u30bf\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\u3092\u8ffd\u3063\u3066\u307f\u308b\u3068...\n\n- `DatabaseRewinder.clean_all`\u3067\u30a8\u30e9\u30fc\u306b\u306a\u3063\u3066\u3044\u308b\n- [DatabaseRewinder.clean_all](https://github.com/amatsuda/database_rewinder/blob/76fae52d0c493819da302ba52fd37e96bcd937c8/lib/database_rewinder.rb#L84)\u304b\u3089[Cleaner\u306e#clean_all](https://github.com/amatsuda/database_rewinder/blob/76fae52d0c493819da302ba52fd37e96bcd937c8/lib/database_rewinder/cleaner.rb#L29)\u306b\u884c\u3063\u3066\n- ActiveRecord\u306e[ConnectionPool#connection](https://github.com/rails/rails/blob/v4.2.3/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L259-L265)\u306b\u884c\u3063\u3066\n- connection\u304c\u7121\u3044\u70ba\u3001\u306a\u3093\u3060\u304b\u3093\u3060\u3067\u3001\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u3092\u65b0\u3057\u304f\u5f35\u308d\u3046\u3068\u3057\u3066\n- \u6700\u7d42\u7684\u306b\u306f\u3001[checkout_new_connection](https://github.com/rails/rails/blob/v4.2.3/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L446)\u3067`ConnectionNotEstablished`\u304craise\u3055\u308c\u3066\u3044\u305f\n\n## \u539f\u56e0\n\n- test-queue\u306e`after_fork`\u3067[establish_connection\u3057\u305f\u6642](https://github.com/rails/rails/blob/v4.2.3/activerecord/lib/active_record/connection_handling.rb#L47-L58)\u306b\n- [remove_connection\u3055\u308c](https://github.com/rails/rails/blob/v4.2.3/activerecord/lib/active_record/connection_handling.rb#L56)\u3066\n- [@automatic_connection\u304cfalse\u306b\u5909\u66f4](https://github.com/rails/rails/blob/v4.2.3/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L590)\u3055\u308c\u3066\u3044\u308b\n- \u306a\u306e\u3067\u3001DatabaseRewinder\u304c\u30ad\u30e3\u30c3\u30b7\u30e5\u3057\u3066\u3044\u308bconnection_pool\u304c\u5f8c\u304b\u3089\u30ea\u30b3\u30cd\u30af\u30c8\u3067\u304d\u306a\u3044\u72b6\u614b\u306b\u306a\u3063\u3066\u3044\u308b\u3088\u3046\u306b\u898b\u3048\u308b\n\n## \u89e3\u6c7a\u7b56\n\n`after_fork`\u5185\u3067\u3001database\u95a2\u9023\u306e\u6e96\u5099\u3092\u3057\u7d42\u308f\u3063\u305f\u5f8c\u306b\u3001\n`DatabaseRewinder.init`\u3059\u308b\u3053\u3068\u3067\u4e00\u65e6\u89e3\u6c7a\n\n```rb\n...\nclass RSpecTestQueueRunner < TestQueue::Runner::RSpec\n  def after_fork(num)\n    ENV.update('TEST_ENV_NUMBER' => num.to_s)\n\n    ActiveRecord::Base.configurations['test']['database'] << num.to_s\n    ActiveRecord::Base.establish_connection(:test)\n\n    ActiveRecord::Tasks::DatabaseTasks.drop_current\n    ActiveRecord::Tasks::DatabaseTasks.create_current\n    ActiveRecord::Tasks::DatabaseTasks.load_schema_current\n\n    DatabaseRewinder.init\n  end\n...\nend\n```\n\n## \u5b9f\u884c\u3057\u3066\u307f\u308b\n\n```\nbin/rspec-testqueue spec --format progress  1667.93s user 171.16s system 292% cpu 10:28.34 total\n```\n\n- \u7d50\u679c\n    - \u5b9f\u884c\u6642\u9593: **\u7d0410\u5206**\n    - **\u7d0430\u5206\u901f\u304f\u306a\u3063\u305f**\n    - mysqld\u306e\u8ca0\u8377\u304c\u8d85\u7d76\u8efd\u304f\u306a\u3063\u305f\n    - Before\n        - <img width=\"815\" alt=\"test-before-1.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/9575/bb9e5ee6-a89d-cf49-b8be-e4437c3eba18.png\">\n    - After\n        - <img width=\"806\" alt=\"test-after-1.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/9575/eeca293b-5bdb-94c4-b7a7-de3dc08d23a6.png\">\n\n# \u307e\u3068\u3081\n\n- test-queue\u3067\u5206\u6563\n- \u30ed\u30b0\u306fI/O\u767a\u751f\u3059\u308b\u306e\u3067\u3001\u51fa\u529b\u3057\u307e\u304f\u308b\u3068\u3084\u3063\u3071\u308a\u9045\u3044\n- \u8907\u6570\u30d7\u30ed\u30bb\u30b9\u306b\u5206\u6563\u3055\u305b\u308b\u3060\u3051\u3067\u540c\u3058DBServer\u3092\u4f7f\u3046\u3068\u7d50\u5c40DB\u306e\u8ca0\u8377\u304c\u3042\u304c\u3063\u3066\u901f\u304f\u306a\u3089\u306a\u3044\n- \u30c6\u30b9\u30c8\u81ea\u4f53\u3092\u30ea\u30d5\u30a1\u30af\u30bf\u30ea\u30f3\u30b0\u305b\u305a\u3068\u3082\u3053\u3053\u307e\u3067\u306f\u3084\u308c\u308b\n- Before: 70m After: 10m **\u7d0460\u5206\u77ed\u7e2e**\n", "tags": ["Ruby", "Rails", "test"]}