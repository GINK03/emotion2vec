{"context": "\n\n\u74b0\u5883\nRuby on Rails\u304c\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3055\u308c\u3066\u3044\u308bCentOS 6.5\n\n\u53c2\u8003\nfluentd\u3067apache\u30ed\u30b0\u3092\u53ce\u96c6\u3059\u308b\nCentOS 6.5 (Vagrant)\u306b fluentd + elasticsearch + kibana \u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3059\u308b\nfluentd\u3067rails log\u3092tail\u3067\u76f4\u63a5\u53d6\u5f97\u3059\u308b\u65b9\u6cd5\ngem\u3092\u4f7f\u3063\u3066centos\u306bfluentd\u30b5\u30fc\u30d0\u3092\u69cb\u7bc9\u3059\u308b\n\u3044\u307e\u3055\u3089\u3060\u3051\u3069 fluentd \u306b\u5165\u9580\u3057\u305f\n\n\u624b\u9806\n\nfluentd\u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\nvagrant\u306b\u63a5\u7d9a\u3059\u308b\uff08vagrant\u74b0\u5883\u306e\u69cb\u7bc9\u3001vagrant up\u306f\u5225\u9014\u884c\u3063\u3066\u3044\u308b\u3082\u306e\u3068\u3059\u308b\uff09\n$ vagrant ssh\ngem install\u3067fluentd\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\n$ gem install fluentd --no-ri --no-rdoc\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u305f\u304b\u78ba\u8a8d\u3059\u308b\n$ fluentd\n\u307e\u3060config\u3092\u4f5c\u6210\u3057\u3066\u3044\u306a\u3044\u306e\u3067\u4e0b\u8a18\u306e\u30a8\u30e9\u30fc\u304c\u51fa\u308b\n/home/vagrant/.gem/ruby/2.1.0/gems/fluentd-0.14.9/lib/fluent/supervisor.rb:659:in `read': No such file or directory @ rb_sysopen - /etc/fluent/fluent.conf (Errno::ENOENT)\n        from /home/vagrant/.gem/ruby/2.1.0/gems/fluentd-0.14.9/lib/fluent/supervisor.rb:659:in `read_config'\n        from /home/vagrant/.gem/ruby/2.1.0/gems/fluentd-0.14.9/lib/fluent/supervisor.rb:416:in `run_supervisor'\n        from /home/vagrant/.gem/ruby/2.1.0/gems/fluentd-0.14.9/lib/fluent/command/fluentd.rb:286:in `<top (required)>'\n        from /opt/rubies/ruby-2.1.0/lib/ruby/site_ruby/2.1.0/rubygems/core_ext/kernel_require.rb:55:in `require'\n        from /opt/rubies/ruby-2.1.0/lib/ruby/site_ruby/2.1.0/rubygems/core_ext/kernel_require.rb:55:in `require'\n        from /home/vagrant/.gem/ruby/2.1.0/gems/fluentd-0.14.9/bin/fluentd:5:in`<top (required)>'\n        from /home/vagrant/.gem/ruby/2.1.0/bin/fluentd:22:in `load'\n        from /home/vagrant/.gem/ruby/2.1.0/bin/fluentd:22:in `<main>'\n\nconfig\u3092\u4f5c\u6210\u3057\u3066\u6a29\u9650\u3092\u4ed8\u4e0e\u3059\u308b\n$ cd /etc/\n$ sudo mkdir fluent\n$ sudo chmod 775 fluent/\n$ ls -ld fluent/\ndrwxrwxr-x 2 root root 4096 Nov 17 01:31 fluent/\n\nfluentd\u30b3\u30de\u30f3\u30c9\u3067\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\n$ cd ~/\n$ fluentd --setup /etc/fluent/\nInstalled /etc/fluent/fluent.conf.\n$ ls -l /etc/fluent/\ntotal 8\n-rw-rw-r-- 1 vagrant vagrant 2696 Nov 17 01:44 fluent.conf\ndrwxrwxr-x 2 vagrant vagrant 4096 Nov 17 01:44 plugin\n\nfluentd\u3092\u624b\u52d5\u3067\u8d77\u52d5\u3059\u308b\n$ fluentd -vv\n\u4e0b\u8a18\u306e\u30ed\u30b0\u304c\u51fa\u3066\u76e3\u8996\u72b6\u614b\u3068\u306a\u308b\n      </server>\n    </secondary>\n  </match>\n</ROOT>\n2016-11-17 01:47:10 +0000 [debug]: plugin/buffer.rb:114:start: buffer started in\nstance=70107182796180 stage_size=0 queue_size=0\n2016-11-17 01:47:10 +0000 [debug]: plugin/out_forward.rb:250:rebuild_weight_arra\ny: rebuilding weight array lost_weight=0\n2016-11-17 01:47:10 +0000 [debug]: plugin/out_forward.rb:250:rebuild_weight_arra\ny: rebuilding weight array lost_weight=0\n2016-11-17 01:47:10 +0000 [info]: plugin/in_debug_agent.rb:53:start: listening d\nRuby uri=\"druby://127.0.0.1:24230\" object=\"Fluent::Engine\"\n2016-11-17 01:47:10 +0000 [debug]: plugin/in_monitor_agent.rb:213:start: listeni\nng monitoring http server on http://0.0.0.0:24220/api/plugins\n2016-11-17 01:47:10 +0000 [debug]: plugin/in_http.rb:119:start: listening http b\nind=\"0.0.0.0\" port=8888\n2016-11-17 01:47:10 +0000 [info]: plugin/in_forward.rb:159:listen: listening flu\nent socket on 0.0.0.0:24224\n\n\u3053\u306e\u72b6\u614b\u306b\u5bfe\u3057\u3066\u3001\u5225\u306e\u30bf\u30fc\u30df\u30ca\u30eb\u304b\u3089\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\n$ echo '{\"first\":\"hello\"}' | fluent-cat debug.test\n\u4e0b\u8a18\u306e\u30ed\u30b0\u304c\u78ba\u8a8d\u3067\u304d\u308b\n2016-11-17 01:52:43.465981469 +0000 debug.test: {\"first\":\"hello\"}\n\nRails\u306e\u30ed\u30b0\u3092\u6574\u5f62\u3059\u308b\uff08rails\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306f\u5225\u9014\u4f5c\u6210\u3057\u3066\u3044\u308b\u3082\u306e\u3068\u3059\u308b\uff09\nrails\u30b5\u30fc\u30d0\u3092\u8d77\u52d5\u3059\u308b(\u4eee\u306b/vagrant/rails_project\u3068\u3059\u308b)\n$ cd /vagrant/rails_project\n$ bundle exec rails s\n\ntail\u30b3\u30de\u30f3\u30c9\u3067\u30ed\u30b0\u3092\u76e3\u8996\u3059\u308b\n$ tail -f log/development.log\n\u30d6\u30e9\u30a6\u30b6\u3067http://localhost:4000\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\nStarted GET \"/\" for 10.0.2.2 at 2016-11-14 05:14:52 +0000\n\nGem::LoadError (Specified 'mysql2' for database adapter, but the gem is not loaded. Add `gem 'mysql2'` to your Gemfile (and ensure its version is at the minimum required by ActiveRecord).):\n  /home.gem/ruby/2.1.0/gems/activerecord-4.1.0/lib/active_record/connection_adapters/connection_specification.rb:190:in `rescue in spec'\n  /home.gem/ruby/2.1.0/gems/activerecord-4.1.0/lib/active_record/connection_adapters/connection_specification.rb:187:in `spec'\n  /home.gem/ruby/2.1.0/gems/activerecord-4.1.0/lib/active_record/connection_handling.rb:50:in `establish_connection'\n  /home.gem/ruby/2.1.0/gems/activerecord-4.1.0/lib/active_record/railtie.rb:129:in `block (2 levels) in <class:Railtie>'\n  /home.gem/ruby/2.1.0/gems/activesupport-4.1.0/lib/active_support/lazy_load_hooks.rb:38:in `instance_eval'\n  /home.gem/ruby/2.1.0/gems/activesupport-4.1.0/lib/active_support/lazy_load_hooks.rb:38:in `execute_hook'\n  /home.gem/ruby/2.1.0/gems/activesupport-4.1.0/lib/active_support/lazy_load_hooks.rb:45:in `block in run_load_hooks'\n  /home.gem/ruby/2.1.0/gems/activesupport-4.1.0/lib/active_support/lazy_load_hooks.rb:44:in `each'\n:\n\nrails\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306econfig/environments/development.rb\u3092\u7de8\u96c6\u3059\u308b\n$ vi /vagrant/config/environments/development.rb\n\u4e0b\u8a18\u306e2\u884c\u3092\u8ffd\u52a0\u3059\u308b\nconfig.logger = Logger.new(config.paths[\"log\"].first)\nconfig.logger.formatter = Logger::Formatter.new\n\nrails\u30b5\u30fc\u30d0\u3092\u518d\u8d77\u52d5\u3059\u308b\uff08Ctrl+C\u3067\u505c\u6b62\u3057\u3066\u4e0b\u8a18\u30b3\u30de\u30f3\u30c9\u3067\u8d77\u52d5\u3059\u308b\uff09\n$ bundle exec rails s\n\u30d6\u30e9\u30a6\u30b6\u306b\u518d\u5ea6\u30a2\u30af\u30bb\u30b9\u3057\u3001tail log \u3092\u78ba\u8a8d\u3059\u308b\u3068\u4e0b\u8a18\u306e\u3088\u3046\u306b\u306a\u308b\nStarted GET \"/\" for 10.0.2.2 at 2016-11-14 05:21:58 +0000\nProcessing by Rails::WelcomeController#index as HTML\n  Rendered /home.gem/ruby/2.1.0/gems/railties-4.1.0/lib/rails/templates/rails/welcome/index.html.erb (6.9ms)\nCompleted 200 OK in 201ms (Views: 63.4ms | ActiveRecord: 0.0ms)\nD, [2016-11-17T02:13:25.598175 #3055] DEBUG -- :\nD, [2016-11-17T02:13:25.608725 #3055] DEBUG -- :\nI, [2016-11-17T02:13:25.611847 #3055]  INFO -- : Started GET \"/\" for 10.0.2.2 at 2016-11-17 02:13:25 +0000\nI, [2016-11-17T02:13:26.766705 #3055]  INFO -- : Processing by Rails::WelcomeController#index as HTML\nI, [2016-11-17T02:13:26.856320 #3055]  INFO -- :   Rendered /home.gem/ruby/2.1.0/gems/railties-4.1.0/lib/rails/templates/rails/welcome/index.html.erb (10.0ms)\nI, [2016-11-17T02:13:26.857168 #3055]  INFO -- : Completed 200 OK in 90ms (Views: 59.1ms | ActiveRecord: 0.0ms)\nD, [2016-11-17T02:14:52.731211 #3055] DEBUG -- :\nD, [2016-11-17T02:14:52.732490 #3055] DEBUG -- :\nI, [2016-11-17T02:14:52.732971 #3055]  INFO -- : Started GET \"/\" for 10.0.2.2 at 2016-11-17 02:14:52 +0000\nI, [2016-11-17T02:14:52.782571 #3055]  INFO -- : Processing by Rails::WelcomeController#index as HTML\nI, [2016-11-17T02:14:52.783872 #3055]  INFO -- :   Rendered /home.gem/ruby/2.1.0/gems/railties-4.1.0/lib/rails/templates/rails/welcome/index.html.erb (0.1ms)\n:\n\nrails\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306econfig/environment.rb\u3092\u7de8\u96c6\u3059\u308b\n$ vi /vagrant/config/environment.rb\n\u4e0b\u8a18\u306e\u30b3\u30fc\u30c9\u3092\u8ffd\u52a0\u3059\u308b\nclass Logger\n  class Formatter\n    def call(severity, time, progname, msg)\n      if msg.class.to_s == \"String\"\n        msg = msg.gsub(/\\n/, \"\")\n        if msg.present? && !msg.include?(\"assets\") && !msg.include?(\"erb\")\n          format = \"[%s %d] %5s -- %s: \\'%s\\'\\n\"\n          format % [\"#{time.strftime('%Y-%m-%d %H:%M:%S')}.#{'%06d' % time.usec.to_s}\",$$, severity, progname, msg2str(msg)]\n        end\n      end\n    end\n  end\nend\n\nrails\u30b5\u30fc\u30d0\u3092\u518d\u8d77\u52d5\u3059\u308b\uff08Ctrl+C\u3067\u505c\u6b62\u3057\u3066\u4e0b\u8a18\u30b3\u30de\u30f3\u30c9\u3067\u8d77\u52d5\u3059\u308b\uff09\n$ bundle exec rails s\n\u30d6\u30e9\u30a6\u30b6\u306b\u4e09\u5ea6\u30a2\u30af\u30bb\u30b9\u3057\u3001tail log \u3092\u78ba\u8a8d\u3059\u308b\u3068\u4e0b\u8a18\u306e\u3088\u3046\u306b\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u304c\u5909\u308f\u308b\n[2016-11-17 02:18:33.262558 3086]  INFO -- : 'Started GET \"/\" for 10.0.2.2 at 2016-11-17 02:18:33 +0000'\n[2016-11-17 02:18:33.935627 3086]  INFO -- : 'Processing by Rails::WelcomeController#index as HTML'\n[2016-11-17 02:18:34.003082 3086]  INFO -- : 'Completed 200 OK in 67ms (Views: 33.7ms | ActiveRecord: 0.0ms)'\n[2016-11-17 02:18:44.410584 3086]  INFO -- : 'Started GET \"/test\" for 10.0.2.2 at 2016-11-17 02:18:44 +0000'\n[2016-11-17 02:19:26.674791 3086]  INFO -- : 'Started GET \"/hello\" for 10.0.2.2at 2016-11-17 02:19:26 +0000'\n[2016-11-17 02:19:32.973006 3086]  INFO -- : 'Started GET \"/admin\" for 10.0.2.2at 2016-11-17 02:19:32 +0000'\n[2016-11-17 02:19:49.132995 3086]  INFO -- : 'Started GET \"/admin?id=1\" for 10.0.2.2 at 2016-11-17 02:19:49 +0000'\n[2016-11-17 02:20:28.717276 3086]  INFO -- : 'Started GET \"/boukis\" for 10.0.2.2 at 2016-11-17 02:20:28 +0000'\n[2016-11-17 02:22:03.817191 3101]  INFO -- : 'Started GET \"/\" for 10.0.2.2 at 2016-11-17 02:22:03 +0000'\n[2016-11-17 02:22:23.961576 3101]  INFO -- : 'Started GET \"/welcome\" for 10.0.2.2 at 2016-11-17 02:22:23 +0000'\n:\n\n\nfluentd\u306e\u6e96\u5099\nfluent-plugin-rewrite\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\n$ gem install fluent-plugin-rewrite\nfluentd\u30ed\u30b0\u306e\u683c\u7d0d\u5148\u3092\u4f5c\u6210\u3059\u308b\n$ sudo mkdir /var/log/fluent\n$ sudo chown root:`whoami` /var/log/fluent/\n$ sudo chmod 770 /var/log/fluent/\n\nfluent.conf\u3092\u7de8\u96c6\u3059\u308b\n$ vi /etc/fluent/fluent.conf\n\u4e0b\u8a18\u5185\u5bb9\u3092\u8ffd\u8a18\u3059\u308b\n<source>\n  type tail\n  path /vagrant/log/development.log\n  tag rails.log\n  pos_file /var/log/fluent/rails.pos\n  format /\\[(?<date>\\d{1,4}-\\d{1,2}-\\d{1,2} \\d{1,2}:\\d{1,2}:\\d{1,2}.\\d{1,6}) (?<process_id>[^ ]*)\\] *(?<log_level>[^ ]*) -- : '(?<message>[^\\']*[^\\]]*)'/\n</source>\n\n<match rails.log>\n  type rewrite\n  remove_prefix rails.log\n  add_prefix filtered\n  <rule>\n    key     message\n    pattern \\n\n    replace\n  </rule>\n  <rule>\n    key     message\n    pattern \\\"\n    replace \\'\n  </rule>\n</match>\n\n<match filtered>\n  type file\n  format json\n  path /var/log/fluent/rails_log\n  time_slice_format %Y%m%d\n  time_slice_wait 1s\n  compress gzip\n</match>\n\n\u624b\u52d5\u3067fluentd\u3092\u8d77\u52d5\u3059\u308b\n$ fluentd -c /etc/fluent/fluent.conf\n/var/log\u306bfluent\u30ed\u30b0\u304c\u51fa\u529b\u3055\u308c\u3066\u3044\u308b\n$ cd /var/log/fluent/rails_log/\n$ ls -ltr\ntotal 8\n-rw-r--r-- 1 vagrant vagrant  68 Nov 17 04:54 buffer.b54177fa819dc80d95a95ff652b\n1f8476.log.meta\n-rw-r--r-- 1 vagrant vagrant 757 Nov 17 04:54 buffer.b54177fa819dc80d95a95ff652b\n1f8476.log\n\n\u30ed\u30b0\u306e\u4e2d\u8eab\u3082\u51fa\u529b\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u308b\n[vagrant@vagrant-centos65 rails_log]$ cat buffer.b54177fa819dc80d95a95ff652b1f8476.log\n{\"date\":\"2016-11-17 04:54:03.247173\",\"process_id\":\"3126\",\"log_level\":\"INFO\",\"message\":\"Started GET /\\\" for 10.0.2.2 at 2016-11-17 04:54:03 +0000/ for 10.0.2.2 at 2016-11-17 04:54:03 +0000 for 10.0.2.2 at 2016-11-17 04:54:03 +0000\"}\n{\"date\":\"2016-11-17 04:54:21.783944\",\"process_id\":\"3126\",\"log_level\":\"INFO\",\"message\":\"Started GET /\\\" for 10.0.2.2 at 2016-11-17 04:54:21 +0000/ for 10.0.2.2 at 2016-11-17 04:54:21 +0000 for 10.0.2.2 at 2016-11-17 04:54:21 +0000\"}\n{\"date\":\"2016-11-17 04:54:22.044299\",\"process_id\":\"3126\",\"log_level\":\"INFO\",\"message\":\"Processing by Rails::WelcomeController#index as HTML\"}\n{\"date\":\"2016-11-17 04:54:22.081275\",\"process_id\":\"3126\",\"log_level\":\"INFO\",\"message\":\"Completed 200 OK in 36ms (Views: 2.4ms | ActiveRecord: 0.0ms)\"}\n\n\u5f8c\u7de8\u3067\u306f\u3001td-agent\u3092\u8a66\u3059\u3088\u3002\n## \u74b0\u5883\nRuby on Rails\u304c\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3055\u308c\u3066\u3044\u308bCentOS 6.5\n\n\n## \u53c2\u8003\n\n[fluentd\u3067apache\u30ed\u30b0\u3092\u53ce\u96c6\u3059\u308b](http://j-caw.co.jp/blog/?p=1311)\n[CentOS 6.5 (Vagrant)\u306b fluentd + elasticsearch + kibana \u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3059\u308b](http://j-caw.co.jp/blog/?p=1380)\n[fluentd\u3067rails log\u3092tail\u3067\u76f4\u63a5\u53d6\u5f97\u3059\u308b\u65b9\u6cd5](https://joppot.info/2014/08/27/1936)\n[gem\u3092\u4f7f\u3063\u3066centos\u306bfluentd\u30b5\u30fc\u30d0\u3092\u69cb\u7bc9\u3059\u308b](https://joppot.info/2014/07/23/1795)\n[\u3044\u307e\u3055\u3089\u3060\u3051\u3069 fluentd \u306b\u5165\u9580\u3057\u305f](http://blog.a-know.me/entry/2015/06/14/094945)\n\n## \u624b\u9806\n\n### fluentd\u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n\nvagrant\u306b\u63a5\u7d9a\u3059\u308b\uff08vagrant\u74b0\u5883\u306e\u69cb\u7bc9\u3001vagrant up\u306f\u5225\u9014\u884c\u3063\u3066\u3044\u308b\u3082\u306e\u3068\u3059\u308b\uff09\n\n`$ vagrant ssh`\n\ngem install\u3067fluentd\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\n\n`$ gem install fluentd --no-ri --no-rdoc`\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u305f\u304b\u78ba\u8a8d\u3059\u308b\n\n`$ fluentd`\n\n\u307e\u3060config\u3092\u4f5c\u6210\u3057\u3066\u3044\u306a\u3044\u306e\u3067\u4e0b\u8a18\u306e\u30a8\u30e9\u30fc\u304c\u51fa\u308b\n\n```\n/home/vagrant/.gem/ruby/2.1.0/gems/fluentd-0.14.9/lib/fluent/supervisor.rb:659:in `read': No such file or directory @ rb_sysopen - /etc/fluent/fluent.conf (Errno::ENOENT)\n        from /home/vagrant/.gem/ruby/2.1.0/gems/fluentd-0.14.9/lib/fluent/supervisor.rb:659:in `read_config'\n        from /home/vagrant/.gem/ruby/2.1.0/gems/fluentd-0.14.9/lib/fluent/supervisor.rb:416:in `run_supervisor'\n        from /home/vagrant/.gem/ruby/2.1.0/gems/fluentd-0.14.9/lib/fluent/command/fluentd.rb:286:in `<top (required)>'\n        from /opt/rubies/ruby-2.1.0/lib/ruby/site_ruby/2.1.0/rubygems/core_ext/kernel_require.rb:55:in `require'\n        from /opt/rubies/ruby-2.1.0/lib/ruby/site_ruby/2.1.0/rubygems/core_ext/kernel_require.rb:55:in `require'\n        from /home/vagrant/.gem/ruby/2.1.0/gems/fluentd-0.14.9/bin/fluentd:5:in`<top (required)>'\n        from /home/vagrant/.gem/ruby/2.1.0/bin/fluentd:22:in `load'\n        from /home/vagrant/.gem/ruby/2.1.0/bin/fluentd:22:in `<main>'\n```\n\nconfig\u3092\u4f5c\u6210\u3057\u3066\u6a29\u9650\u3092\u4ed8\u4e0e\u3059\u308b\n\n```\n$ cd /etc/\n$ sudo mkdir fluent\n$ sudo chmod 775 fluent/\n$ ls -ld fluent/\ndrwxrwxr-x 2 root root 4096 Nov 17 01:31 fluent/\n```\nfluentd\u30b3\u30de\u30f3\u30c9\u3067\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\n\n```\n$ cd ~/\n$ fluentd --setup /etc/fluent/\nInstalled /etc/fluent/fluent.conf.\n$ ls -l /etc/fluent/\ntotal 8\n-rw-rw-r-- 1 vagrant vagrant 2696 Nov 17 01:44 fluent.conf\ndrwxrwxr-x 2 vagrant vagrant 4096 Nov 17 01:44 plugin\n```\n\nfluentd\u3092\u624b\u52d5\u3067\u8d77\u52d5\u3059\u308b\n\n`$ fluentd -vv`\n\n\u4e0b\u8a18\u306e\u30ed\u30b0\u304c\u51fa\u3066\u76e3\u8996\u72b6\u614b\u3068\u306a\u308b\n\n```\n      </server>\n    </secondary>\n  </match>\n</ROOT>\n2016-11-17 01:47:10 +0000 [debug]: plugin/buffer.rb:114:start: buffer started in\nstance=70107182796180 stage_size=0 queue_size=0\n2016-11-17 01:47:10 +0000 [debug]: plugin/out_forward.rb:250:rebuild_weight_arra\ny: rebuilding weight array lost_weight=0\n2016-11-17 01:47:10 +0000 [debug]: plugin/out_forward.rb:250:rebuild_weight_arra\ny: rebuilding weight array lost_weight=0\n2016-11-17 01:47:10 +0000 [info]: plugin/in_debug_agent.rb:53:start: listening d\nRuby uri=\"druby://127.0.0.1:24230\" object=\"Fluent::Engine\"\n2016-11-17 01:47:10 +0000 [debug]: plugin/in_monitor_agent.rb:213:start: listeni\nng monitoring http server on http://0.0.0.0:24220/api/plugins\n2016-11-17 01:47:10 +0000 [debug]: plugin/in_http.rb:119:start: listening http b\nind=\"0.0.0.0\" port=8888\n2016-11-17 01:47:10 +0000 [info]: plugin/in_forward.rb:159:listen: listening flu\nent socket on 0.0.0.0:24224\n```\n\n\u3053\u306e\u72b6\u614b\u306b\u5bfe\u3057\u3066\u3001\u5225\u306e\u30bf\u30fc\u30df\u30ca\u30eb\u304b\u3089\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\n\n\n`$ echo '{\"first\":\"hello\"}' | fluent-cat debug.test`\n\n\u4e0b\u8a18\u306e\u30ed\u30b0\u304c\u78ba\u8a8d\u3067\u304d\u308b\n\n`2016-11-17 01:52:43.465981469 +0000 debug.test: {\"first\":\"hello\"}`\n\n### Rails\u306e\u30ed\u30b0\u3092\u6574\u5f62\u3059\u308b\uff08rails\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306f\u5225\u9014\u4f5c\u6210\u3057\u3066\u3044\u308b\u3082\u306e\u3068\u3059\u308b\uff09\n\nrails\u30b5\u30fc\u30d0\u3092\u8d77\u52d5\u3059\u308b(\u4eee\u306b/vagrant/rails_project\u3068\u3059\u308b)\n\n```\n$ cd /vagrant/rails_project\n$ bundle exec rails s\n```\n\ntail\u30b3\u30de\u30f3\u30c9\u3067\u30ed\u30b0\u3092\u76e3\u8996\u3059\u308b\n\n`$ tail -f log/development.log`\n\n\u30d6\u30e9\u30a6\u30b6\u3067http://localhost:4000\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\n\n```\nStarted GET \"/\" for 10.0.2.2 at 2016-11-14 05:14:52 +0000\n\nGem::LoadError (Specified 'mysql2' for database adapter, but the gem is not loaded. Add `gem 'mysql2'` to your Gemfile (and ensure its version is at the minimum required by ActiveRecord).):\n  /home.gem/ruby/2.1.0/gems/activerecord-4.1.0/lib/active_record/connection_adapters/connection_specification.rb:190:in `rescue in spec'\n  /home.gem/ruby/2.1.0/gems/activerecord-4.1.0/lib/active_record/connection_adapters/connection_specification.rb:187:in `spec'\n  /home.gem/ruby/2.1.0/gems/activerecord-4.1.0/lib/active_record/connection_handling.rb:50:in `establish_connection'\n  /home.gem/ruby/2.1.0/gems/activerecord-4.1.0/lib/active_record/railtie.rb:129:in `block (2 levels) in <class:Railtie>'\n  /home.gem/ruby/2.1.0/gems/activesupport-4.1.0/lib/active_support/lazy_load_hooks.rb:38:in `instance_eval'\n  /home.gem/ruby/2.1.0/gems/activesupport-4.1.0/lib/active_support/lazy_load_hooks.rb:38:in `execute_hook'\n  /home.gem/ruby/2.1.0/gems/activesupport-4.1.0/lib/active_support/lazy_load_hooks.rb:45:in `block in run_load_hooks'\n  /home.gem/ruby/2.1.0/gems/activesupport-4.1.0/lib/active_support/lazy_load_hooks.rb:44:in `each'\n:\n```\n\nrails\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306econfig/environments/development.rb\u3092\u7de8\u96c6\u3059\u308b\n\n`$ vi /vagrant/config/environments/development.rb`\n\n\u4e0b\u8a18\u306e2\u884c\u3092\u8ffd\u52a0\u3059\u308b\n\n```\nconfig.logger = Logger.new(config.paths[\"log\"].first)\nconfig.logger.formatter = Logger::Formatter.new\n```\n\nrails\u30b5\u30fc\u30d0\u3092\u518d\u8d77\u52d5\u3059\u308b\uff08Ctrl+C\u3067\u505c\u6b62\u3057\u3066\u4e0b\u8a18\u30b3\u30de\u30f3\u30c9\u3067\u8d77\u52d5\u3059\u308b\uff09\n\n`$ bundle exec rails s`\n\n\u30d6\u30e9\u30a6\u30b6\u306b\u518d\u5ea6\u30a2\u30af\u30bb\u30b9\u3057\u3001tail log \u3092\u78ba\u8a8d\u3059\u308b\u3068\u4e0b\u8a18\u306e\u3088\u3046\u306b\u306a\u308b\n\n```\nStarted GET \"/\" for 10.0.2.2 at 2016-11-14 05:21:58 +0000\nProcessing by Rails::WelcomeController#index as HTML\n  Rendered /home.gem/ruby/2.1.0/gems/railties-4.1.0/lib/rails/templates/rails/welcome/index.html.erb (6.9ms)\nCompleted 200 OK in 201ms (Views: 63.4ms | ActiveRecord: 0.0ms)\nD, [2016-11-17T02:13:25.598175 #3055] DEBUG -- :\nD, [2016-11-17T02:13:25.608725 #3055] DEBUG -- :\nI, [2016-11-17T02:13:25.611847 #3055]  INFO -- : Started GET \"/\" for 10.0.2.2 at 2016-11-17 02:13:25 +0000\nI, [2016-11-17T02:13:26.766705 #3055]  INFO -- : Processing by Rails::WelcomeController#index as HTML\nI, [2016-11-17T02:13:26.856320 #3055]  INFO -- :   Rendered /home.gem/ruby/2.1.0/gems/railties-4.1.0/lib/rails/templates/rails/welcome/index.html.erb (10.0ms)\nI, [2016-11-17T02:13:26.857168 #3055]  INFO -- : Completed 200 OK in 90ms (Views: 59.1ms | ActiveRecord: 0.0ms)\nD, [2016-11-17T02:14:52.731211 #3055] DEBUG -- :\nD, [2016-11-17T02:14:52.732490 #3055] DEBUG -- :\nI, [2016-11-17T02:14:52.732971 #3055]  INFO -- : Started GET \"/\" for 10.0.2.2 at 2016-11-17 02:14:52 +0000\nI, [2016-11-17T02:14:52.782571 #3055]  INFO -- : Processing by Rails::WelcomeController#index as HTML\nI, [2016-11-17T02:14:52.783872 #3055]  INFO -- :   Rendered /home.gem/ruby/2.1.0/gems/railties-4.1.0/lib/rails/templates/rails/welcome/index.html.erb (0.1ms)\n:\n```\n\nrails\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306econfig/environment.rb\u3092\u7de8\u96c6\u3059\u308b\n\n`$ vi /vagrant/config/environment.rb`\n\n\u4e0b\u8a18\u306e\u30b3\u30fc\u30c9\u3092\u8ffd\u52a0\u3059\u308b\n\n```\nclass Logger\n  class Formatter\n    def call(severity, time, progname, msg)\n      if msg.class.to_s == \"String\"\n        msg = msg.gsub(/\\n/, \"\")\n        if msg.present? && !msg.include?(\"assets\") && !msg.include?(\"erb\")\n          format = \"[%s %d] %5s -- %s: \\'%s\\'\\n\"\n          format % [\"#{time.strftime('%Y-%m-%d %H:%M:%S')}.#{'%06d' % time.usec.to_s}\",$$, severity, progname, msg2str(msg)]\n        end\n      end\n    end\n  end\nend\n```\n\nrails\u30b5\u30fc\u30d0\u3092\u518d\u8d77\u52d5\u3059\u308b\uff08Ctrl+C\u3067\u505c\u6b62\u3057\u3066\u4e0b\u8a18\u30b3\u30de\u30f3\u30c9\u3067\u8d77\u52d5\u3059\u308b\uff09\n\n`$ bundle exec rails s`\n\n\u30d6\u30e9\u30a6\u30b6\u306b\u4e09\u5ea6\u30a2\u30af\u30bb\u30b9\u3057\u3001tail log \u3092\u78ba\u8a8d\u3059\u308b\u3068\u4e0b\u8a18\u306e\u3088\u3046\u306b\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u304c\u5909\u308f\u308b\n\n```\n[2016-11-17 02:18:33.262558 3086]  INFO -- : 'Started GET \"/\" for 10.0.2.2 at 2016-11-17 02:18:33 +0000'\n[2016-11-17 02:18:33.935627 3086]  INFO -- : 'Processing by Rails::WelcomeController#index as HTML'\n[2016-11-17 02:18:34.003082 3086]  INFO -- : 'Completed 200 OK in 67ms (Views: 33.7ms | ActiveRecord: 0.0ms)'\n[2016-11-17 02:18:44.410584 3086]  INFO -- : 'Started GET \"/test\" for 10.0.2.2 at 2016-11-17 02:18:44 +0000'\n[2016-11-17 02:19:26.674791 3086]  INFO -- : 'Started GET \"/hello\" for 10.0.2.2at 2016-11-17 02:19:26 +0000'\n[2016-11-17 02:19:32.973006 3086]  INFO -- : 'Started GET \"/admin\" for 10.0.2.2at 2016-11-17 02:19:32 +0000'\n[2016-11-17 02:19:49.132995 3086]  INFO -- : 'Started GET \"/admin?id=1\" for 10.0.2.2 at 2016-11-17 02:19:49 +0000'\n[2016-11-17 02:20:28.717276 3086]  INFO -- : 'Started GET \"/boukis\" for 10.0.2.2 at 2016-11-17 02:20:28 +0000'\n[2016-11-17 02:22:03.817191 3101]  INFO -- : 'Started GET \"/\" for 10.0.2.2 at 2016-11-17 02:22:03 +0000'\n[2016-11-17 02:22:23.961576 3101]  INFO -- : 'Started GET \"/welcome\" for 10.0.2.2 at 2016-11-17 02:22:23 +0000'\n:\n```\n\n### fluentd\u306e\u6e96\u5099\n\nfluent-plugin-rewrite\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\n\n`$ gem install fluent-plugin-rewrite`\n\nfluentd\u30ed\u30b0\u306e\u683c\u7d0d\u5148\u3092\u4f5c\u6210\u3059\u308b\n\n```\n$ sudo mkdir /var/log/fluent\n$ sudo chown root:`whoami` /var/log/fluent/\n$ sudo chmod 770 /var/log/fluent/\n```\n\nfluent.conf\u3092\u7de8\u96c6\u3059\u308b\n\n`$ vi /etc/fluent/fluent.conf`\n\n\u4e0b\u8a18\u5185\u5bb9\u3092\u8ffd\u8a18\u3059\u308b\n\n```\n<source>\n  type tail\n  path /vagrant/log/development.log\n  tag rails.log\n  pos_file /var/log/fluent/rails.pos\n  format /\\[(?<date>\\d{1,4}-\\d{1,2}-\\d{1,2} \\d{1,2}:\\d{1,2}:\\d{1,2}.\\d{1,6}) (?<process_id>[^ ]*)\\] *(?<log_level>[^ ]*) -- : '(?<message>[^\\']*[^\\]]*)'/\n</source>\n \n<match rails.log>\n  type rewrite\n  remove_prefix rails.log\n  add_prefix filtered\n  <rule>\n    key     message\n    pattern \\n\n    replace\n  </rule>\n  <rule>\n    key     message\n    pattern \\\"\n    replace \\'\n  </rule>\n</match>\n \n<match filtered>\n  type file\n  format json\n  path /var/log/fluent/rails_log\n  time_slice_format %Y%m%d\n  time_slice_wait 1s\n  compress gzip\n</match>\n```\n\n\u624b\u52d5\u3067fluentd\u3092\u8d77\u52d5\u3059\u308b\n\n`$ fluentd -c /etc/fluent/fluent.conf`\n\n/var/log\u306bfluent\u30ed\u30b0\u304c\u51fa\u529b\u3055\u308c\u3066\u3044\u308b\n\n```\n$ cd /var/log/fluent/rails_log/\n$ ls -ltr\ntotal 8\n-rw-r--r-- 1 vagrant vagrant  68 Nov 17 04:54 buffer.b54177fa819dc80d95a95ff652b\n1f8476.log.meta\n-rw-r--r-- 1 vagrant vagrant 757 Nov 17 04:54 buffer.b54177fa819dc80d95a95ff652b\n1f8476.log\n```\n\n\u30ed\u30b0\u306e\u4e2d\u8eab\u3082\u51fa\u529b\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u308b\n\n```\n[vagrant@vagrant-centos65 rails_log]$ cat buffer.b54177fa819dc80d95a95ff652b1f8476.log\n{\"date\":\"2016-11-17 04:54:03.247173\",\"process_id\":\"3126\",\"log_level\":\"INFO\",\"message\":\"Started GET /\\\" for 10.0.2.2 at 2016-11-17 04:54:03 +0000/ for 10.0.2.2 at 2016-11-17 04:54:03 +0000 for 10.0.2.2 at 2016-11-17 04:54:03 +0000\"}\n{\"date\":\"2016-11-17 04:54:21.783944\",\"process_id\":\"3126\",\"log_level\":\"INFO\",\"message\":\"Started GET /\\\" for 10.0.2.2 at 2016-11-17 04:54:21 +0000/ for 10.0.2.2 at 2016-11-17 04:54:21 +0000 for 10.0.2.2 at 2016-11-17 04:54:21 +0000\"}\n{\"date\":\"2016-11-17 04:54:22.044299\",\"process_id\":\"3126\",\"log_level\":\"INFO\",\"message\":\"Processing by Rails::WelcomeController#index as HTML\"}\n{\"date\":\"2016-11-17 04:54:22.081275\",\"process_id\":\"3126\",\"log_level\":\"INFO\",\"message\":\"Completed 200 OK in 36ms (Views: 2.4ms | ActiveRecord: 0.0ms)\"}\n```\n\n\u5f8c\u7de8\u3067\u306f\u3001td-agent\u3092\u8a66\u3059\u3088\u3002\n\n", "tags": ["CentOS65", "RubyOnRails", "fluentd"]}