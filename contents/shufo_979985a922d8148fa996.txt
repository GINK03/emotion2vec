{"context": " More than 1 year has passed since last update.=====================\n\n\u74b0\u5883\n\nCentOS 6.5\nOpenLDAP\n\n\nOverview\n\u307e\u3068\u3082\u306b\u7ba1\u7406\u3059\u308b\u3068\u7169\u96d1\u306b\u306a\u308a\u304c\u3061\u306asudo\u3092LDAP\u3067\u4e00\u5143\u7684\u306b\u7ba1\u7406\u3057\u305f\u3044\u3002\n\nInstallation\n\nwith Ansible\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u624b\u9806\u306f\u5168\u3066playbook\u5316\u3057\u3066\u3042\u308a\u307e\u3059\u3002\nhttps://github.com/shufo/ansible-sudo-ldap\n$ git clone git@github.com:shufo/ansible-sudo-ldap.git\n$ cd ansible-sudo-ldap\n$ vagrant up\n\n\u3067Vagrant\u4eee\u60f3\u30de\u30b7\u30f3\u4e0a\u306b\u4ee5\u4e0b\u306e\u624b\u52d5\u3067\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u624b\u9806\u3092\u518d\u73fe\u3057\u305fOpenLDAP+sudo\u306a\u30c6\u30b9\u30c8\u74b0\u5883\u304c\u51fa\u6765\u307e\u3059\u3002(\u8981Ansible, Vagrant)\n\u7acb\u3061\u4e0a\u304c\u3063\u305f\u3089\n$ vagrant ssh\n[vagrant@vagrant ~]$ sudo su\n[root@vagrant ~]$ su - test\n[test@vagrant ~]$ sudo cat /var/log/secure \n\"Enter [test]'s Password:\" password\n\n\u3067\u52d5\u4f5c\u78ba\u8a8d\u51fa\u6765\u307e\u3059\u3002\n\u30ea\u30e2\u30fc\u30c8\u306b\u69cb\u7bc9\u3059\u308b\u5834\u5408\u306fansible_hosts\u30d5\u30a1\u30a4\u30eb\u3092\u7de8\u96c6\u3057\ndefault ansible_ssh_host=127.0.0.1 ansible_ssh_port=22\n\nplaybook\u3092\u76f4\u63a5\u5b9f\u884c\u3057\u3066\u304f\u3060\u3055\u3044\u3002\nansible-playbook site.yml -i ansible_hosts\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u306e\u307f\u69cb\u7bc9\u3059\u308b\u5834\u5408\u306ftasks/main.yml\u306eLDAP\u30b5\u30fc\u30d0\u5074\u7528\u306e\u30bf\u30b9\u30af\u3092\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n---\n# - include: server.yml\n- include: client.yml\n\n\n\u624b\u52d5\n\nLDAP\u30b5\u30fc\u30d0\u8a2d\u5b9a\n\nOpenLDAP\u3001\u4f9d\u5b58\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n  yum install openldap openldap-servers openldap-clients pam_ldap \n\n\nLDAP\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u521d\u671f\u5316\n\nmkdir /var/lib/ldap\nchown ldap:ldap /var/lib/ldap\nrm -fR /etc/openldap/slapd.d/*\n\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u30b3\u30d4\u30fc\n\ncp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG\ncp /usr/share/openldap-servers/slapd.conf.obsolete /etc/openldap/slapd.conf\n\n\nLDAP\u30b5\u30fc\u30d0\u306eroot\u30d1\u30b9\u30ef\u30fc\u30c9\u751f\u6210\n\n/usr/sbin/slappasswd -s password\n\n\n/etc/openldap/slapd.conf\n# \u30b9\u30ad\u30fc\u30de\u30d5\u30a1\u30a4\u30eb\u8a2d\u5b9a\ninclude /etc/openldap/schema/corba.schema\ninclude /etc/openldap/schema/core.schema\ninclude /etc/openldap/schema/cosine.schema\ninclude /etc/openldap/schema/duaconf.schema\ninclude /etc/openldap/schema/dyngroup.schema\ninclude /etc/openldap/schema/inetorgperson.schema\ninclude /etc/openldap/schema/java.schema\ninclude /etc/openldap/schema/misc.schema\ninclude /etc/openldap/schema/nis.schema\ninclude /etc/openldap/schema/openldap.schema\ninclude /etc/openldap/schema/ppolicy.schema\ninclude /etc/openldap/schema/collective.schema\n\n# \u63a5\u7d9a\u30d7\u30ed\u30c8\u30b3\u30eb\nallow bind_v2\n\n# \u7ba1\u7406\u30d5\u30a1\u30a4\u30eb\npidfile     /var/run/openldap/slapd.pid\nargsfile    /var/run/openldap/slapd.args\n\n# TLS\u8a2d\u5b9a\n#TLSCACertificatePath  /etc/openldap/ssl/cacert.pem\n#TLSCertificateFile    /etc/openldap/ssl/server.crt\n#TLSCertificateKeyFile /etc/openldap/ssl/server.key\n\n# userPassword\u306b\u95a2\u3059\u308b\u30a2\u30af\u30bb\u30b9\u6a29\naccess to attrs=userPassword\n    by self write\n    by dn=\"cn=Directory Manager,dc=example,dc=com\" write\n    by anonymous auth\n    by * none\n\n# \u305d\u306e\u4ed6\u306e\u5c5e\u6027\u306b\u5bfe\u3059\u308b\u30a2\u30af\u30bb\u30b9\u6a29\naccess to *\n    by self write\n    by dn=\"cn=Directory Manager,dc=example,dc=com\" write\n    by * read\n\n# monitor\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u5bfe\u3059\u308b\u30a2\u30af\u30bb\u30b9\u6a29\ndatabase monitor\naccess to *\n    by dn.exact=\"cn=Directory Manager,dc=example,dc=com\" read\n    by * none\n\n# \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u8a2d\u5b9a\ndatabase    bdb\nsuffix      \"dc=example,dc=com\"\ncheckpoint  1024 15\nrootdn      \"dc=example,dc=com\"\nrootpw      {SSHA}jadajsdna\u301c\u4e2d\u7565\u301chogehoge\ndirectory   /var/lib/ldap\n\n# index\u306e\u8a2d\u5b9a\nindex objectClass                       eq,pres\nindex ou,cn,mail,surname,givenname      eq,pres,sub\nindex uidNumber,gidNumber,loginShell    eq,pres\nindex uid,memberUid                     eq,pres,sub\nindex nisMapName,nisMapEntry            eq,pres,sub\n\n\n\n\nLDAP\u30b5\u30fc\u30d0\u306bsudo\u7528\u306eschema\u3092\u8aad\u307f\u3053\u307e\u305b\u308b\n\nschema.OpenLDAP\u3092\u30b9\u30ad\u30fc\u30de\u306b\u8ffd\u52a0\u3002\n  cp /usr/share/doc/sudo-1.8.6p3/schema.OpenLDAP /etc/openldap/schema/sudo.schema\n\n/etc/openldap/slapd.conf\u306b\n\n/etc/openldap/slapd.conf\n  include /etc/openldap/schema/sudo.schema\n\n\n\u3092\u8ffd\u52a0\u3002\n\nopenldap\u3092\u8d77\u52d5\n\n  service slapd start\n\n\n\u30a8\u30f3\u30c8\u30ea\u3092\u4f5c\u6210\u3059\u308b\n\n\u30d9\u30fc\u30b9\u306b\u306a\u308b\u30a8\u30f3\u30c8\u30ea\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\nadd_ou.ldif\n  dn: dc=example,dc=com\n  objectClass: dcObject\n  objectClass: organization\n  dc: example\n  o: example\n\n  dn: ou=people,dc=example,dc=com\n  objectClass: organizationalUnit\n  ou: people\n\n  dn: ou=groups,dc=example,dc=com\n  objectClass: organizationalUnit\n  ou: groups\n\n\n  ldapadd -D \"cn=Directory Manager,dc=example,dc=com\" -w password -f add_ou.ldif\n\n\n\u30e6\u30fc\u30b6\u3092\u4f5c\u6210\u3059\u308b\n\n\u30b5\u30f3\u30d7\u30eb\u3068\u3057\u3066test\u30e6\u30fc\u30b6\u3092\u4f5c\u6210\u3059\u308b\u3002\n\nadd_user.ldif\n  dn: uid=test,ou=people,dc=example,dc=com\nobjectClass: account\nobjectClass: posixAccount\nuid: test\ncn: test\nuserPassword: {SSHA}hogehoge\u301c\u4e2d\u7565\u301c\nloginShell: /bin/bash\nuidNumber: 1000\ngidNumber: 1000\nhomeDirectory: /home/test\n\n\nposixAccount\u30af\u30e9\u30b9\u306e\u5fc5\u9808\u5c5e\u6027\u306floginShell\u3001uidNumber\u3001gidNumber\u3001homeDirectory\u306a\u306e\u3067\u3053\u306e\uff14\u3064\u306f\u6700\u4f4e\u9650\u542b\u3081\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n  ldapadd -D \"cn=Directory Manager,dc=example,dc=com\" -w password -f add_user.ldif\n\n\n\u30b0\u30eb\u30fc\u30d7\u3092\u4f5c\u6210\u3059\u308b\n\n\u30b5\u30f3\u30d7\u30eb\u3068\u3057\u3066members\u30b0\u30eb\u30fc\u30d7\u3092\u4f5c\u6210\u3059\u308b\u3002\n\nadd_group.ldif\n  dn: cn=members,ou=groups,dc=example,dc=com\n  objectClass: top\n  cn: members\n  objectClass: posixGroup\n  gidNumber: 1000\n\n\n  ldapadd -D \"cn=Directory Manager,dc=example,dc=com\" -w password -f add_group.ldif\n\n\nsudoers\u7528ou\u3092\u4f5c\u6210\u3059\u308b\n\n  vim sudoersOU.ldif\n\n\nsudoersOU.ldif\n  dn: ou=SUDOers,dc=example,dc=com\n  description: SUDOers\n  objectClass: organizationalUnit\n  objectClass: top\n  ou: SUDOers\n\n\n  ldapadd -x -D \"cn=Directory Manager,dc=example,dc=com\" -w password -f sudoersOU.ldif\n\n\n/etc/sudoers\u3092\u7de8\u96c6\u3059\u308b\n\n  [root@agenttest user.0]# cat /etc/sudoers | grep -v \"^#\" | grep -v \"^\\s*$\"\nCmnd_Alias FILE_READ = /bin/cat, /bin/more, /usr/bin/tail\nCmnd_Alias SERVICE = /sbin/service\nCmnd_Alias NETWORK_LOOKUP = /bin/ping, /bin/netstat, /usr/bin/nslookup\nCmnd_Alias DELEGATING = /bin/chown, /bin/chmod, /bin/chgrp\nDefaults   !visiblepw\nDefaults    always_set_home\nDefaults    env_reset\nDefaults    env_keep=\"COLORS DISPLAY HOSTNAME HISTSIZE INPUTRC KDEDIR LS_COLORS\"\nDefaults    env_keep+=\"MAIL PS1 PS2 QTDIR USERNAME LANG LC_ADDRESS LC_CTYPE\"\nDefaults    env_keep+=\"LC_COLLATE LC_IDENTIFICATION LC_MEASUREMENT LC_MESSAGES\"\nDefaults    env_keep+=\"LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER LC_TELEPHONE\"\nDefaults    env_keep+=\"LC_TIME LC_ALL LANGUAGE LINGUAS _XKB_CHARSET XAUTHORITY\"\nDefaults    !root_sudo\nDefaults    !lecture\nDefaults    log_host\nDefaults    log_year\nDefaults    logfile=/var/log/sudo.log\nDefaults    ignore_dot\nDefaults    ignore_local_sudoers\nDefaults    timestamp_timeout=0\nDefaults    passprompt=\"Enter [%u]'s Password:\"\nDefaults    badpass_message=\"The password is not corresponding. Try again.\"\nDefaults    insults\nDefaults    secure_path=/sbin:/bin:/usr/sbin:/usr/bin\nroot    ALL=(ALL)   ALL\n%members       ALL=(ALL) FILE_READ\n%wheel ALL=NOPASSWD: ALL\n\n\u89e3\u8aac: Cmnd_Alias\u3067\u5b9a\u7fa9\u3057\u305f\u30b3\u30de\u30f3\u30c9\u306e\u96c6\u307e\u308a\u3092\u5404\u30b0\u30eb\u30fc\u30d7\u306b\u5bfe\u3057\u3066\u5272\u308a\u5f53\u3066\u3066\u3044\u308b\u3002\n%members       ALL=(ALL) FILE_READ\u3067members\u30b0\u30eb\u30fc\u30d7\u306bFILE_READ\u3067\u5b9a\u7fa9\u3057\u305f/bin/cat, /bin/more, /usr/bin/tail\u30b3\u30de\u30f3\u30c9\u306e\u5b9f\u884c\u3092\u8a31\u53ef\u3057\u3066\u3044\u308b\u3002members\u30b0\u30eb\u30fc\u30d7\u306e\u30e6\u30fc\u30b6\u306b\u5bfe\u3057\u3066ALL(\u5168\u3066)\u306e\u30db\u30b9\u30c8\u304b\u3089ALL(\u4efb\u610f)\u306e\u30e6\u30fc\u30b6\u6a29\u9650\u3067FILE_READ\u3067\u5b9a\u7fa9\u3057\u305f\u30b3\u30de\u30f3\u30c9\u304c\u5b9f\u884c\u53ef\u80fd\u3068\u3044\u3046\u610f\u5473\u3002less\u3067\u306f\u306a\u304fmore\u3092\u8a31\u53ef\u3057\u3066\u3044\u308b\u306e\u306fless\u306f:!/bin/bash\u3068less\u5185\u3067\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u3067root\u306e\u30b7\u30a7\u30eb\u3092\u53d6\u5f97\u51fa\u6765\u308b\u304b\u3089\u3002\n!root_sudo\u3067root\u3067\u306esudo\u3092\u7981\u6b62\u3001!lecture\u3067\u6700\u521d\u306b\u3067\u308b\u8aac\u660e\u3092\u975e\u8868\u793a\u3001ignore_local_sudoers\u3067LDAP\u53c2\u7167\u306e\u307f\u306b\u3057\u3066\u30ed\u30fc\u30ab\u30eb\u306e/etc/sudoers\u3092\u7121\u8996\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u308b\u3002\n\n\nsudoers2ldif\u3067ldif\u30d5\u30a1\u30a4\u30eb\u306b\u5909\u63db\u3059\u308b\n\n  export SUDOERS_BASE=ou=SUDOers,dc=example,dc=com\n  cat /etc/sudoers | perl /usr/share/doc/sudo-1.8.6p3/sudoers2ldif > sudoers.ldif\n\n\nsudoers.ldif\n  dn: cn=defaults,ou=SUDOers,dc=example,dc=com\n  objectClass: top\n  objectClass: sudoRole\n  cn: defaults\n  description: Default sudoOption's go here\n  sudoOption: !visiblepw\n    sudoOption: always_set_home\n  sudoOption: env_reset\n  sudoOption: env_keep=\"COLORS DISPLAY HOSTNAME HISTSIZE INPUTRC KDEDIR LS_COLORS\"\n  sudoOption: env_keep+=\"MAIL PS1 PS2 QTDIR USERNAME LANG LC_ADDRESS LC_CTYPE\"\n  sudoOption: env_keep+=\"LC_COLLATE LC_IDENTIFICATION LC_MEASUREMENT LC_MESSAGES\"\n  sudoOption: env_keep+=\"LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER LC_TELEPHONE\"\n  sudoOption: env_keep+=\"LC_TIME LC_ALL LANGUAGE LINGUAS _XKB_CHARSET XAUTHORITY\"\n  sudoOption: !root_sudo\n  sudoOption: !lecture\n  sudoOption: log_host\n  sudoOption: log_year\n  sudoOption: logfile=/var/log/sudo.log\n  sudoOption: ignore_dot\n  sudoOption: ignore_local_sudoers\n  sudoOption: timestamp_timeout=0\n  sudoOption: passprompt=\"Enter [%u]'s Password:\"\n  sudoOption: badpass_message=\"The password is not corresponding. Try again.\"\n  sudoOption: secure_path=/sbin:/bin:/usr/sbin:/usr/bin\n\n  \u301c\u4e2d\u7565\u301c\n\n\n\nLDIF\u3092\u30a4\u30f3\u30dd\u30fc\u30c8\u3059\u308b\n\nsudoers2ldif\u3067\u5909\u63db\u3057\u305fLDIF\u3092\u30a4\u30f3\u30dd\u30fc\u30c8\u3059\u308b\n  ldapadd -x -D \"cn=Directory Manager,dc=example,dc=com\" -w password -f sudoers.ldif\n\n\nLDAP\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u8a2d\u5b9a\n\n\u4f9d\u5b58\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n  yum install openldap-clients nss-pam-ldapd pam_ldap openssh-ldap authconfig\n\n\n\u8a8d\u8a3c\u5468\u308a\u3092authconfig\u3067\u8a2d\u5b9a\n\n  # LDAP\u306b\u3088\u308b\u30e6\u30fc\u30b6\u60c5\u5831\u53c2\u7167\u3092\u6709\u52b9\u306b\u3059\u308b\n  authconfig --enableldap --update\n  # LDAP\u306b\u3088\u308b\u8a8d\u8a3c\u3092\u6709\u52b9\u306b\u3059\u308b\n  authconfig --enableldapauth --update\n  # \u30e6\u30fc\u30b6\u306e\u30db\u30fc\u30e0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u81ea\u52d5\u4f5c\u6210\u3092\u6709\u52b9\u306b\u3059\u308b\n  authconfig --enablemkhomedir --update\n  # shadow\u30d1\u30b9\u30ef\u30fc\u30c9\u306e\u4f7f\u7528\u3092\u6709\u52b9\u306b\u3059\u308b\n  authconfig --enableshadow --update  \n  # local\u8a8d\u8a3c\u3092\u6709\u52b9\u306b\u3059\u308b\n  authconfig --enablelocauthorize --update\n  # LDAP\u30b5\u30fc\u30d0\u306eURI\u3092\u6307\u5b9a\n  authconfig --ldapserver=ldap://127.0.0.1:389 --update\n  # LDAP\u30b5\u30fc\u30d0\u306e\u30d9\u30fc\u30b9DN\u3092\u6307\u5b9a\n  authconfig --ldapbasedn=dc=example,dc=com --update \n\n\u4ee5\u4e0a\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u305f\u7d50\u679c\u306ePAM\u306e\u8a2d\u5b9a\u306f\u4ee5\u4e0b\u3067\u3059\u3002\n\n/etc/pam.d/system-auth\n  #%PAM-1.0\n  # This file is auto-generated.\n  # User changes will be destroyed the next time authconfig is run.\n  auth        required      pam_env.so\n  auth        sufficient    pam_unix.so nullok try_first_pass\n  auth        requisite     pam_succeed_if.so uid >= 500 quiet\n  auth        sufficient    pam_ldap.so use_first_pass\n  auth        required      pam_deny.so\n\n  account     required      pam_unix.so broken_shadow\n  account     sufficient    pam_localuser.so\n  account     sufficient    pam_succeed_if.so uid < 500 quiet\n  account     [default=bad success=ok user_unknown=ignore] pam_ldap.so\n  account     required      pam_permit.so\n\n  password    requisite     pam_cracklib.so try_first_pass retry=3 type=\n  password    sufficient    pam_unix.so sha512 shadow nullok try_first_pass use_authtok\n  password    sufficient    pam_ldap.so use_authtok\n  password    required      pam_deny.so\n\n  session     optional      pam_keyinit.so revoke\n  session     required      pam_limits.so\n  session     optional      pam_mkhomedir.so skel=/etc/skel umask=077\n  session     [success=1 default=ignore] pam_succeed_if.so service in crond quiet use_uid\n  session     required      pam_unix.so\n  session     optional      pam_ldap.so\n\n\npam_mkhomedir\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u6709\u52b9\u306b\u3057\u3066\u3044\u308b\u306e\u3067\u30e6\u30fc\u30b6\u306e\u30db\u30fc\u30e0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304c\u5b58\u5728\u3057\u306a\u3044\u5834\u5408\u81ea\u52d5\u7684\u306b\u4f5c\u3089\u308c\u307e\u3059\u3002\u81ea\u52d5\u524a\u9664\u306f\u3055\u308c\u306a\u3044\u306e\u3067\u5fc5\u8981\u306a\u304f\u306a\u3063\u305f\u3089\u524a\u9664\u3057\u307e\u3057\u3087\u3046\u3002\n\n/etc/pam.d/password-auth\n  #%PAM-1.0\n  # This file is auto-generated.\n  # User changes will be destroyed the next time authconfig is run.\n  auth        required      pam_env.so\n  auth        sufficient    pam_unix.so nullok try_first_pass\n  auth        requisite     pam_succeed_if.so uid >= 500 quiet\n  auth        sufficient    pam_ldap.so use_first_pass\n  auth        required      pam_deny.so\n\n  account     required      pam_unix.so broken_shadow\n  account     sufficient    pam_localuser.so\n  account     sufficient    pam_succeed_if.so uid < 500 quiet\n  account     [default=bad success=ok user_unknown=ignore] pam_ldap.so\n  account     required      pam_permit.so\n\n  password    requisite     pam_cracklib.so try_first_pass retry=3 type=\n  password    sufficient    pam_unix.so sha512 shadow nullok try_first_pass use_authtok\n  password    sufficient    pam_ldap.so use_authtok\n  password    required      pam_deny.so\n\n  session     optional      pam_keyinit.so revoke\n  session     required      pam_limits.so\n  session     optional      pam_mkhomedir.so skel=/etc/skel umask=077\n  session     [success=1 default=ignore] pam_succeed_if.so service in crond quiet use_uid\n  session     required      pam_unix.so\n  session     optional      pam_ldap.so\n\n\n\nsudo-ldap\u306e\u8a2d\u5b9a\n\nsudo-ldap.conf\u306fauthconfig\u3067\u306f\u8a2d\u5b9a\u51fa\u6765\u306a\u3044\u306e\u3067\u624b\u52d5\u3067\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n  [root@localhost]# sudo -V\n  ldap.conf path: /etc/sudo-ldap.conf\n\n  [root@localhost ]# cat /etc/sudo-ldap.conf  | grep -v \"^#\" | grep -v \"^\\s*$\"\n  binddn cn=Directory Manager\n  bindpw password\n  uri ldap://127.0.0.1:389\n  sudoers_base ou=SUDOers,dc=example,dc=com\n  sudoers_debug 1\n\n\nsudoers\u306e\u53c2\u7167\u5148\u3092ldap\u306b\u5207\u308a\u66ff\u3048\n\n  [root@localhost]# cat /etc/nsswitch.conf | grep sudoers\n  sudoers:  ldap files\n\n\n\u78ba\u8a8d\n\n\u4ed6\u30e6\u30fc\u30b6\u306bsu\u3057\u3066\u78ba\u8a8d\u3057\u3066\u307f\u308b\u3002\n  [root@localhost]# su - test\n  [shufo@localhost ~]$ sudo cat /var/log/secure \n  sudo: ldap_set_option: debug -> 0\n  sudo: ldap_set_option: ldap_version -> 3\n  sudo: ldap_sasl_bind_s() ok\n  sudo: Looking for cn=defaults: cn=defaults\n  sudo: found:cn=defaults,ou=SUDOers,dc=example,dc=com\n  sudo: ldap search '(|(sudoUser=test)(sudoUser=%test)(sudoUser=%#501)(sudoUser=ALL))'\n  sudo: searching from base 'ou=SUDOers,dc=example,dc=com'\n  sudo: adding search result\n  sudo: result now has 0 entries\n  sudo: ldap search '(sudoUser=+*)'\n  sudo: searching from base 'ou=SUDOers,dc=example,dc=com'\n  sudo: adding search result\n  sudo: result now has 0 entries\n  sudo: sorting remaining 0 entries\n  sudo: searching LDAP for sudoers entries\n  sudo: done with LDAP searches\n  sudo: user_matches=1\n  sudo: host_matches=0\n  sudo: sudo_ldap_lookup(0)=0x40\n  Enter [test]'s Password: [\u30d1\u30b9\u30ef\u30fc\u30c9\u5165\u529b]\n  test is not allowed to run sudo on localhost.  This incident will be reported.\n\nLDAP\u30b5\u30fc\u30d0\u306b\u554f\u3044\u5408\u308f\u305b\u3055\u308c\u3066\u3044\u308b\u306e\u304c\u30ed\u30b0\u304b\u3089\u5206\u304b\u308b\u3002\n  \u5b9f\u969b\u306b\u554f\u3044\u5408\u308f\u305b\u3066\u3044\u308b\u30af\u30a8\u30ea\u306fbaseDN\u306eou=SUDOers,dc=example,dc=com\u3092(|(sudoUser=shufo)(sudoUser=%shufo)(sudoUser=%#501)(sudoUser=ALL))\u3067\u691c\u7d22\u3057\u3066\u3044\u308b\u3002\n=====================\n\n## \u74b0\u5883\n\n- CentOS 6.5\n- OpenLDAP\n\n## Overview\n\n\u307e\u3068\u3082\u306b\u7ba1\u7406\u3059\u308b\u3068\u7169\u96d1\u306b\u306a\u308a\u304c\u3061\u306asudo\u3092LDAP\u3067\u4e00\u5143\u7684\u306b\u7ba1\u7406\u3057\u305f\u3044\u3002\n\n## Installation\n\n### with Ansible\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u624b\u9806\u306f\u5168\u3066playbook\u5316\u3057\u3066\u3042\u308a\u307e\u3059\u3002\n\nhttps://github.com/shufo/ansible-sudo-ldap\n\n```\n$ git clone git@github.com:shufo/ansible-sudo-ldap.git\n$ cd ansible-sudo-ldap\n$ vagrant up\n```\n\n\u3067Vagrant\u4eee\u60f3\u30de\u30b7\u30f3\u4e0a\u306b\u4ee5\u4e0b\u306e\u624b\u52d5\u3067\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u624b\u9806\u3092\u518d\u73fe\u3057\u305fOpenLDAP+sudo\u306a\u30c6\u30b9\u30c8\u74b0\u5883\u304c\u51fa\u6765\u307e\u3059\u3002(\u8981Ansible, Vagrant)\n\n\u7acb\u3061\u4e0a\u304c\u3063\u305f\u3089\n\n```\n$ vagrant ssh\n[vagrant@vagrant ~]$ sudo su\n[root@vagrant ~]$ su - test\n[test@vagrant ~]$ sudo cat /var/log/secure \n\"Enter [test]'s Password:\" password\n```\n\n\u3067\u52d5\u4f5c\u78ba\u8a8d\u51fa\u6765\u307e\u3059\u3002\n\n\u30ea\u30e2\u30fc\u30c8\u306b\u69cb\u7bc9\u3059\u308b\u5834\u5408\u306f`ansible_hosts`\u30d5\u30a1\u30a4\u30eb\u3092\u7de8\u96c6\u3057\n\n```ansible_hosts\ndefault ansible_ssh_host=127.0.0.1 ansible_ssh_port=22\n```\n\nplaybook\u3092\u76f4\u63a5\u5b9f\u884c\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n```shell\nansible-playbook site.yml -i ansible_hosts\n```\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u306e\u307f\u69cb\u7bc9\u3059\u308b\u5834\u5408\u306f`tasks/main.yml`\u306eLDAP\u30b5\u30fc\u30d0\u5074\u7528\u306e\u30bf\u30b9\u30af\u3092\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n```python\n---\n# - include: server.yml\n- include: client.yml\n```\n\n### \u624b\u52d5\n\n#### LDAP\u30b5\u30fc\u30d0\u8a2d\u5b9a\n\n- OpenLDAP\u3001\u4f9d\u5b58\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n  ```\n  yum install openldap openldap-servers openldap-clients pam_ldap \n  ```\n\n- LDAP\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u521d\u671f\u5316\n\n  ```bash\nmkdir /var/lib/ldap\nchown ldap:ldap /var/lib/ldap\nrm -fR /etc/openldap/slapd.d/*\n```\n\n- \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u30b3\u30d4\u30fc\n\n  ```bash\ncp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG\ncp /usr/share/openldap-servers/slapd.conf.obsolete /etc/openldap/slapd.conf\n```\n\n- LDAP\u30b5\u30fc\u30d0\u306eroot\u30d1\u30b9\u30ef\u30fc\u30c9\u751f\u6210\n\n  ```bash\n/usr/sbin/slappasswd -s password\n```\n\n```/etc/openldap/slapd.conf\n# \u30b9\u30ad\u30fc\u30de\u30d5\u30a1\u30a4\u30eb\u8a2d\u5b9a\ninclude /etc/openldap/schema/corba.schema\ninclude /etc/openldap/schema/core.schema\ninclude /etc/openldap/schema/cosine.schema\ninclude /etc/openldap/schema/duaconf.schema\ninclude /etc/openldap/schema/dyngroup.schema\ninclude /etc/openldap/schema/inetorgperson.schema\ninclude /etc/openldap/schema/java.schema\ninclude /etc/openldap/schema/misc.schema\ninclude /etc/openldap/schema/nis.schema\ninclude /etc/openldap/schema/openldap.schema\ninclude /etc/openldap/schema/ppolicy.schema\ninclude /etc/openldap/schema/collective.schema\n\n# \u63a5\u7d9a\u30d7\u30ed\u30c8\u30b3\u30eb\nallow bind_v2\n\n# \u7ba1\u7406\u30d5\u30a1\u30a4\u30eb\npidfile     /var/run/openldap/slapd.pid\nargsfile    /var/run/openldap/slapd.args\n\n# TLS\u8a2d\u5b9a\n#TLSCACertificatePath  /etc/openldap/ssl/cacert.pem\n#TLSCertificateFile    /etc/openldap/ssl/server.crt\n#TLSCertificateKeyFile /etc/openldap/ssl/server.key\n\n# userPassword\u306b\u95a2\u3059\u308b\u30a2\u30af\u30bb\u30b9\u6a29\naccess to attrs=userPassword\n    by self write\n    by dn=\"cn=Directory Manager,dc=example,dc=com\" write\n    by anonymous auth\n    by * none\n\n# \u305d\u306e\u4ed6\u306e\u5c5e\u6027\u306b\u5bfe\u3059\u308b\u30a2\u30af\u30bb\u30b9\u6a29\naccess to *\n    by self write\n    by dn=\"cn=Directory Manager,dc=example,dc=com\" write\n    by * read\n\n# monitor\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u5bfe\u3059\u308b\u30a2\u30af\u30bb\u30b9\u6a29\ndatabase monitor\naccess to *\n    by dn.exact=\"cn=Directory Manager,dc=example,dc=com\" read\n    by * none\n\n# \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u8a2d\u5b9a\ndatabase    bdb\nsuffix      \"dc=example,dc=com\"\ncheckpoint  1024 15\nrootdn      \"dc=example,dc=com\"\nrootpw      {SSHA}jadajsdna\u301c\u4e2d\u7565\u301chogehoge\ndirectory   /var/lib/ldap\n\n# index\u306e\u8a2d\u5b9a\nindex objectClass                       eq,pres\nindex ou,cn,mail,surname,givenname      eq,pres,sub\nindex uidNumber,gidNumber,loginShell    eq,pres\nindex uid,memberUid                     eq,pres,sub\nindex nisMapName,nisMapEntry            eq,pres,sub\n\n```\n\n\n- LDAP\u30b5\u30fc\u30d0\u306bsudo\u7528\u306eschema\u3092\u8aad\u307f\u3053\u307e\u305b\u308b\n\n  `schema.OpenLDAP`\u3092\u30b9\u30ad\u30fc\u30de\u306b\u8ffd\u52a0\u3002\n\n  ```bash\n  cp /usr/share/doc/sudo-1.8.6p3/schema.OpenLDAP /etc/openldap/schema/sudo.schema\n  ```\n  \n  /etc/openldap/slapd.conf\u306b\n\n  ```/etc/openldap/slapd.conf\n  include /etc/openldap/schema/sudo.schema\n  ```\n\n  \u3092\u8ffd\u52a0\u3002\n\n- openldap\u3092\u8d77\u52d5\n\n  ```\n  service slapd start\n  ```\n\n- \u30a8\u30f3\u30c8\u30ea\u3092\u4f5c\u6210\u3059\u308b\n\n  \u30d9\u30fc\u30b9\u306b\u306a\u308b\u30a8\u30f3\u30c8\u30ea\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n  ```add_ou.ldif\n  dn: dc=example,dc=com\n  objectClass: dcObject\n  objectClass: organization\n  dc: example\n  o: example\n\n  dn: ou=people,dc=example,dc=com\n  objectClass: organizationalUnit\n  ou: people\n\n  dn: ou=groups,dc=example,dc=com\n  objectClass: organizationalUnit\n  ou: groups\n  ```\n\n  ```bash\n  ldapadd -D \"cn=Directory Manager,dc=example,dc=com\" -w password -f add_ou.ldif\n  ```\n\n- \u30e6\u30fc\u30b6\u3092\u4f5c\u6210\u3059\u308b\n\n  \u30b5\u30f3\u30d7\u30eb\u3068\u3057\u3066`test`\u30e6\u30fc\u30b6\u3092\u4f5c\u6210\u3059\u308b\u3002\n\n  ```add_user.ldif\n  dn: uid=test,ou=people,dc=example,dc=com\nobjectClass: account\nobjectClass: posixAccount\nuid: test\ncn: test\nuserPassword: {SSHA}hogehoge\u301c\u4e2d\u7565\u301c\nloginShell: /bin/bash\nuidNumber: 1000\ngidNumber: 1000\nhomeDirectory: /home/test\n  ```\n  \n  `posixAccount`\u30af\u30e9\u30b9\u306e\u5fc5\u9808\u5c5e\u6027\u306f`loginShell`\u3001`uidNumber`\u3001`gidNumber`\u3001`homeDirectory`\u306a\u306e\u3067\u3053\u306e\uff14\u3064\u306f\u6700\u4f4e\u9650\u542b\u3081\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n  \n  ```bash\n  ldapadd -D \"cn=Directory Manager,dc=example,dc=com\" -w password -f add_user.ldif\n  ```\n\n- \u30b0\u30eb\u30fc\u30d7\u3092\u4f5c\u6210\u3059\u308b\n\n  \u30b5\u30f3\u30d7\u30eb\u3068\u3057\u3066`members`\u30b0\u30eb\u30fc\u30d7\u3092\u4f5c\u6210\u3059\u308b\u3002\n\n  ```add_group.ldif\n  dn: cn=members,ou=groups,dc=example,dc=com\n  objectClass: top\n  cn: members\n  objectClass: posixGroup\n  gidNumber: 1000\n  ```\n\n  ```bash\n  ldapadd -D \"cn=Directory Manager,dc=example,dc=com\" -w password -f add_group.ldif\n  ```\n\n- sudoers\u7528ou\u3092\u4f5c\u6210\u3059\u308b\n\n\n  ```\n  vim sudoersOU.ldif\n  ```\n\n  ```sudoersOU.ldif\n  dn: ou=SUDOers,dc=example,dc=com\n  description: SUDOers\n  objectClass: organizationalUnit\n  objectClass: top\n  ou: SUDOers\n  ```\n\n  ```bash\n  ldapadd -x -D \"cn=Directory Manager,dc=example,dc=com\" -w password -f sudoersOU.ldif\n  ```\n\n- /etc/sudoers\u3092\u7de8\u96c6\u3059\u308b\n\n  ```bash\n  [root@agenttest user.0]# cat /etc/sudoers | grep -v \"^#\" | grep -v \"^\\s*$\"\nCmnd_Alias FILE_READ = /bin/cat, /bin/more, /usr/bin/tail\nCmnd_Alias SERVICE = /sbin/service\nCmnd_Alias NETWORK_LOOKUP = /bin/ping, /bin/netstat, /usr/bin/nslookup\nCmnd_Alias DELEGATING = /bin/chown, /bin/chmod, /bin/chgrp\nDefaults   !visiblepw\nDefaults    always_set_home\nDefaults    env_reset\nDefaults    env_keep=\"COLORS DISPLAY HOSTNAME HISTSIZE INPUTRC KDEDIR LS_COLORS\"\nDefaults    env_keep+=\"MAIL PS1 PS2 QTDIR USERNAME LANG LC_ADDRESS LC_CTYPE\"\nDefaults    env_keep+=\"LC_COLLATE LC_IDENTIFICATION LC_MEASUREMENT LC_MESSAGES\"\nDefaults    env_keep+=\"LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER LC_TELEPHONE\"\nDefaults    env_keep+=\"LC_TIME LC_ALL LANGUAGE LINGUAS _XKB_CHARSET XAUTHORITY\"\nDefaults    !root_sudo\nDefaults    !lecture\nDefaults    log_host\nDefaults    log_year\nDefaults    logfile=/var/log/sudo.log\nDefaults    ignore_dot\nDefaults    ignore_local_sudoers\nDefaults    timestamp_timeout=0\nDefaults    passprompt=\"Enter [%u]'s Password:\"\nDefaults    badpass_message=\"The password is not corresponding. Try again.\"\nDefaults    insults\nDefaults    secure_path=/sbin:/bin:/usr/sbin:/usr/bin\nroot\tALL=(ALL) \tALL\n%members       ALL=(ALL) FILE_READ\n%wheel ALL=NOPASSWD: ALL\n  ```\n\n\u89e3\u8aac: `Cmnd_Alias`\u3067\u5b9a\u7fa9\u3057\u305f\u30b3\u30de\u30f3\u30c9\u306e\u96c6\u307e\u308a\u3092\u5404\u30b0\u30eb\u30fc\u30d7\u306b\u5bfe\u3057\u3066\u5272\u308a\u5f53\u3066\u3066\u3044\u308b\u3002\n`%members       ALL=(ALL) FILE_READ`\u3067`members`\u30b0\u30eb\u30fc\u30d7\u306b`FILE_READ`\u3067\u5b9a\u7fa9\u3057\u305f`/bin/cat, /bin/more, /usr/bin/tail`\u30b3\u30de\u30f3\u30c9\u306e\u5b9f\u884c\u3092\u8a31\u53ef\u3057\u3066\u3044\u308b\u3002`members`\u30b0\u30eb\u30fc\u30d7\u306e\u30e6\u30fc\u30b6\u306b\u5bfe\u3057\u3066`ALL`(\u5168\u3066)\u306e\u30db\u30b9\u30c8\u304b\u3089`ALL`(\u4efb\u610f)\u306e\u30e6\u30fc\u30b6\u6a29\u9650\u3067`FILE_READ`\u3067\u5b9a\u7fa9\u3057\u305f\u30b3\u30de\u30f3\u30c9\u304c\u5b9f\u884c\u53ef\u80fd\u3068\u3044\u3046\u610f\u5473\u3002`less`\u3067\u306f\u306a\u304f`more`\u3092\u8a31\u53ef\u3057\u3066\u3044\u308b\u306e\u306f`less`\u306f`:!/bin/bash`\u3068less\u5185\u3067\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u3067root\u306e\u30b7\u30a7\u30eb\u3092\u53d6\u5f97\u51fa\u6765\u308b\u304b\u3089\u3002\n`!root_sudo`\u3067root\u3067\u306esudo\u3092\u7981\u6b62\u3001`!lecture`\u3067\u6700\u521d\u306b\u3067\u308b\u8aac\u660e\u3092\u975e\u8868\u793a\u3001`ignore_local_sudoers`\u3067LDAP\u53c2\u7167\u306e\u307f\u306b\u3057\u3066\u30ed\u30fc\u30ab\u30eb\u306e/etc/sudoers\u3092\u7121\u8996\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u308b\u3002\n\n\n- `sudoers2ldif`\u3067ldif\u30d5\u30a1\u30a4\u30eb\u306b\u5909\u63db\u3059\u308b\n\n  ```bash\n  export SUDOERS_BASE=ou=SUDOers,dc=example,dc=com\n  cat /etc/sudoers | perl /usr/share/doc/sudo-1.8.6p3/sudoers2ldif > sudoers.ldif\n  ```\n\n  ```sudoers.ldif\n  dn: cn=defaults,ou=SUDOers,dc=example,dc=com\n  objectClass: top\n  objectClass: sudoRole\n  cn: defaults\n  description: Default sudoOption's go here\n  sudoOption: !visiblepw\n    sudoOption: always_set_home\n  sudoOption: env_reset\n  sudoOption: env_keep=\"COLORS DISPLAY HOSTNAME HISTSIZE INPUTRC KDEDIR LS_COLORS\"\n  sudoOption: env_keep+=\"MAIL PS1 PS2 QTDIR USERNAME LANG LC_ADDRESS LC_CTYPE\"\n  sudoOption: env_keep+=\"LC_COLLATE LC_IDENTIFICATION LC_MEASUREMENT LC_MESSAGES\"\n  sudoOption: env_keep+=\"LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER LC_TELEPHONE\"\n  sudoOption: env_keep+=\"LC_TIME LC_ALL LANGUAGE LINGUAS _XKB_CHARSET XAUTHORITY\"\n  sudoOption: !root_sudo\n  sudoOption: !lecture\n  sudoOption: log_host\n  sudoOption: log_year\n  sudoOption: logfile=/var/log/sudo.log\n  sudoOption: ignore_dot\n  sudoOption: ignore_local_sudoers\n  sudoOption: timestamp_timeout=0\n  sudoOption: passprompt=\"Enter [%u]'s Password:\"\n  sudoOption: badpass_message=\"The password is not corresponding. Try again.\"\n  sudoOption: secure_path=/sbin:/bin:/usr/sbin:/usr/bin\n    \n  \u301c\u4e2d\u7565\u301c\n  ```\n\n\n\n- LDIF\u3092\u30a4\u30f3\u30dd\u30fc\u30c8\u3059\u308b\n\n  `sudoers2ldif`\u3067\u5909\u63db\u3057\u305fLDIF\u3092\u30a4\u30f3\u30dd\u30fc\u30c8\u3059\u308b\n\n  ```bash\n  ldapadd -x -D \"cn=Directory Manager,dc=example,dc=com\" -w password -f sudoers.ldif\n  ```\n\n#### LDAP\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u8a2d\u5b9a\n\n  - \u4f9d\u5b58\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n  ```bash\n  yum install openldap-clients nss-pam-ldapd pam_ldap openssh-ldap authconfig\n  ```\n\n  - \u8a8d\u8a3c\u5468\u308a\u3092`authconfig`\u3067\u8a2d\u5b9a\n\n  ```bash\n  # LDAP\u306b\u3088\u308b\u30e6\u30fc\u30b6\u60c5\u5831\u53c2\u7167\u3092\u6709\u52b9\u306b\u3059\u308b\n  authconfig --enableldap --update\n  # LDAP\u306b\u3088\u308b\u8a8d\u8a3c\u3092\u6709\u52b9\u306b\u3059\u308b\n  authconfig --enableldapauth --update\n  # \u30e6\u30fc\u30b6\u306e\u30db\u30fc\u30e0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u81ea\u52d5\u4f5c\u6210\u3092\u6709\u52b9\u306b\u3059\u308b\n  authconfig --enablemkhomedir --update\n  # shadow\u30d1\u30b9\u30ef\u30fc\u30c9\u306e\u4f7f\u7528\u3092\u6709\u52b9\u306b\u3059\u308b\n  authconfig --enableshadow --update  \n  # local\u8a8d\u8a3c\u3092\u6709\u52b9\u306b\u3059\u308b\n  authconfig --enablelocauthorize --update\n  # LDAP\u30b5\u30fc\u30d0\u306eURI\u3092\u6307\u5b9a\n  authconfig --ldapserver=ldap://127.0.0.1:389 --update\n  # LDAP\u30b5\u30fc\u30d0\u306e\u30d9\u30fc\u30b9DN\u3092\u6307\u5b9a\n  authconfig --ldapbasedn=dc=example,dc=com --update \n  ```  \n\n  \u4ee5\u4e0a\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u305f\u7d50\u679c\u306ePAM\u306e\u8a2d\u5b9a\u306f\u4ee5\u4e0b\u3067\u3059\u3002\n\n  ```/etc/pam.d/system-auth\n  #%PAM-1.0\n  # This file is auto-generated.\n  # User changes will be destroyed the next time authconfig is run.\n  auth        required      pam_env.so\n  auth        sufficient    pam_unix.so nullok try_first_pass\n  auth        requisite     pam_succeed_if.so uid >= 500 quiet\n  auth        sufficient    pam_ldap.so use_first_pass\n  auth        required      pam_deny.so\n  \n  account     required      pam_unix.so broken_shadow\n  account     sufficient    pam_localuser.so\n  account     sufficient    pam_succeed_if.so uid < 500 quiet\n  account     [default=bad success=ok user_unknown=ignore] pam_ldap.so\n  account     required      pam_permit.so\n  \n  password    requisite     pam_cracklib.so try_first_pass retry=3 type=\n  password    sufficient    pam_unix.so sha512 shadow nullok try_first_pass use_authtok\n  password    sufficient    pam_ldap.so use_authtok\n  password    required      pam_deny.so\n  \n  session     optional      pam_keyinit.so revoke\n  session     required      pam_limits.so\n  session     optional      pam_mkhomedir.so skel=/etc/skel umask=077\n  session     [success=1 default=ignore] pam_succeed_if.so service in crond quiet use_uid\n  session     required      pam_unix.so\n  session     optional      pam_ldap.so\n  ```\n\n  `pam_mkhomedir`\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u6709\u52b9\u306b\u3057\u3066\u3044\u308b\u306e\u3067\u30e6\u30fc\u30b6\u306e\u30db\u30fc\u30e0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304c\u5b58\u5728\u3057\u306a\u3044\u5834\u5408\u81ea\u52d5\u7684\u306b\u4f5c\u3089\u308c\u307e\u3059\u3002\u81ea\u52d5\u524a\u9664\u306f\u3055\u308c\u306a\u3044\u306e\u3067\u5fc5\u8981\u306a\u304f\u306a\u3063\u305f\u3089\u524a\u9664\u3057\u307e\u3057\u3087\u3046\u3002\n\n  ```/etc/pam.d/password-auth\n  #%PAM-1.0\n  # This file is auto-generated.\n  # User changes will be destroyed the next time authconfig is run.\n  auth        required      pam_env.so\n  auth        sufficient    pam_unix.so nullok try_first_pass\n  auth        requisite     pam_succeed_if.so uid >= 500 quiet\n  auth        sufficient    pam_ldap.so use_first_pass\n  auth        required      pam_deny.so\n  \n  account     required      pam_unix.so broken_shadow\n  account     sufficient    pam_localuser.so\n  account     sufficient    pam_succeed_if.so uid < 500 quiet\n  account     [default=bad success=ok user_unknown=ignore] pam_ldap.so\n  account     required      pam_permit.so\n  \n  password    requisite     pam_cracklib.so try_first_pass retry=3 type=\n  password    sufficient    pam_unix.so sha512 shadow nullok try_first_pass use_authtok\n  password    sufficient    pam_ldap.so use_authtok\n  password    required      pam_deny.so\n  \n  session     optional      pam_keyinit.so revoke\n  session     required      pam_limits.so\n  session     optional      pam_mkhomedir.so skel=/etc/skel umask=077\n  session     [success=1 default=ignore] pam_succeed_if.so service in crond quiet use_uid\n  session     required      pam_unix.so\n  session     optional      pam_ldap.so\n  ```\n  \n  - sudo-ldap\u306e\u8a2d\u5b9a\n\n  `sudo-ldap.conf`\u306f`authconfig`\u3067\u306f\u8a2d\u5b9a\u51fa\u6765\u306a\u3044\u306e\u3067\u624b\u52d5\u3067\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n\n  ```bash\n  [root@localhost]# sudo -V\n  ldap.conf path: /etc/sudo-ldap.conf\n\n  [root@localhost ]# cat /etc/sudo-ldap.conf  | grep -v \"^#\" | grep -v \"^\\s*$\"\n  binddn cn=Directory Manager\n  bindpw password\n  uri ldap://127.0.0.1:389\n  sudoers_base ou=SUDOers,dc=example,dc=com\n  sudoers_debug 1\n  ```\n\n  - sudoers\u306e\u53c2\u7167\u5148\u3092ldap\u306b\u5207\u308a\u66ff\u3048\n  \n  ```\n  [root@localhost]# cat /etc/nsswitch.conf | grep sudoers\n  sudoers:\tldap files\n  ```\n\n  - \u78ba\u8a8d\n\n  \u4ed6\u30e6\u30fc\u30b6\u306bsu\u3057\u3066\u78ba\u8a8d\u3057\u3066\u307f\u308b\u3002\n \n  ```bash\n  [root@localhost]# su - test\n  [shufo@localhost ~]$ sudo cat /var/log/secure \n  sudo: ldap_set_option: debug -> 0\n  sudo: ldap_set_option: ldap_version -> 3\n  sudo: ldap_sasl_bind_s() ok\n  sudo: Looking for cn=defaults: cn=defaults\n  sudo: found:cn=defaults,ou=SUDOers,dc=example,dc=com\n  sudo: ldap search '(|(sudoUser=test)(sudoUser=%test)(sudoUser=%#501)(sudoUser=ALL))'\n  sudo: searching from base 'ou=SUDOers,dc=example,dc=com'\n  sudo: adding search result\n  sudo: result now has 0 entries\n  sudo: ldap search '(sudoUser=+*)'\n  sudo: searching from base 'ou=SUDOers,dc=example,dc=com'\n  sudo: adding search result\n  sudo: result now has 0 entries\n  sudo: sorting remaining 0 entries\n  sudo: searching LDAP for sudoers entries\n  sudo: done with LDAP searches\n  sudo: user_matches=1\n  sudo: host_matches=0\n  sudo: sudo_ldap_lookup(0)=0x40\n  Enter [test]'s Password: [\u30d1\u30b9\u30ef\u30fc\u30c9\u5165\u529b]\n  test is not allowed to run sudo on localhost.  This incident will be reported.\n  ```\n\n  LDAP\u30b5\u30fc\u30d0\u306b\u554f\u3044\u5408\u308f\u305b\u3055\u308c\u3066\u3044\u308b\u306e\u304c\u30ed\u30b0\u304b\u3089\u5206\u304b\u308b\u3002\n  \u5b9f\u969b\u306b\u554f\u3044\u5408\u308f\u305b\u3066\u3044\u308b\u30af\u30a8\u30ea\u306fbaseDN\u306e`ou=SUDOers,dc=example,dc=com`\u3092`(|(sudoUser=shufo)(sudoUser=%shufo)(sudoUser=%#501)(sudoUser=ALL))`\u3067\u691c\u7d22\u3057\u3066\u3044\u308b\u3002\n", "tags": ["CentOS", "openldap", "LDAP", "Linux"]}