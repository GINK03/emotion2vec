{"context": " More than 1 year has passed since last update.\n\n\u524d\u56de\u306e\u7d9a\u304d\u3067\u3059\n\u524d\u306e\u8a18\u4e8b : ELB+Swarm+Compose+Consul+Registrator\u3067\u5922\u306f\u53f6\u3046\u306e\u304b(1)\n\n\u30b9\u30d7\u30ea\u30c3\u30c8\u30d6\u30ec\u30a4\u30f3\u72b6\u614b\u306aConsul\u3092\u7acb\u3066\u308b\nSwarm\u306f\u5168\u30ce\u30fc\u30c9\u3068\u30b3\u30f3\u30c6\u30ca\u3092\u77e5\u3063\u3066\u3044\u308b\u304cConsul\u306f\u81ea\u30ce\u30fc\u30c9\u306e\u8a2d\u5b9a\u3057\u304b\u8cac\u4efb\u3092\u6301\u305f\u306a\u3044\u3088\u3046\u306b\u3057\u305f\u304b\u3063\u305f\u3002\nDockerman\u306e/root/docker-host/\u306bnodes\u3092\u6398\u3063\u3066\u305d\u3053\u306b\u65b0\u3057\u3044docker-compose.yml\u3092\u66f8\u3053\u3046\n# cd /root/docker-host\n# mkdir nodes\n# cd nodes\n# nano docker-compose.yml\n\n\ndocker-compose.yml\nconsul:\n  command: -server -bootstrap -ui-dir /ui\n  image: progrium/consul:latest\n  ports:\n  - \"8300\"\n  - \"8400\"\n  - \"8500\"\n  - \"8600/udp\"\n  environment:\n  - \"affinity:container!=nodes_consul_*\"\n  net: \"host\"\n\nregistrator:\n  command: consul://127.0.0.1:8500\n  image: progrium/registrator:latest\n  volumes:\n  - \"/var/run/docker.sock:/tmp/docker.sock\"\n  environment:\n  - \"affinity:container!=nodes_registrator_*\"\n  net: \"host\"\n\n\n\u3053\u306e\u69cb\u6210\u3067\u306f\n\n\u5404\u30ce\u30fc\u30c9\u3067Consul\u304c8500\u3067\u5f85\u3061\u53d7\u3051\u3057\nRegistrator\u304c\u81ea\u5206\u304c\u6240\u5c5e\u3057\u3066\u3044\u308b\u30ce\u30fc\u30c9\u306edocker\u30b3\u30f3\u30c6\u30ca\u3092\u628a\u63e1\u3057\u3066\u81ea\u5206\u3068\u540c\u3058\u30ce\u30fc\u30c9\u306eConsul\u306b\u901a\u77e5\n\n\u3068\u306a\u3063\u3066\u3044\u3066\u30b5\u30fc\u30d3\u30b9\u5b9a\u7fa9\u306eenvironment\u306b\u3042\u308baffinity:container!=\u307b\u306b\u3083\u3089\u3089\u306f\u540c\u3058\u30ce\u30fc\u30c9\u3067\u306e\u591a\u91cd\u8d77\u52d5\u3092\u9632\u6b62\u3059\u308b\u305f\u3081\u306b\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u3082\u306e\n\u3053\u3053\u307e\u3067\u306f\u60a9\u3080\u3068\u3053\u308d\u3082\u7121\u3044\u306e\u3067\u3055\u304f\u3063\u3068\u8d77\u52d5\u3057\u3066\u3057\u307e\u304a\u3046\nDOCKER_HOST\u30922380\u30dd\u30fc\u30c8(swarm manage)\u306b\u5411\u3051\u3066\u304b\u3089docker-compose\u3092\u3059\u308c\u3070Swarm API\u7d4c\u7531\u3067\u30b3\u30f3\u30c6\u30ca\u306e\u5236\u5fa1\u304c\u51fa\u6765\u308b\u3088\u3046\u306b\u306a\u308b\n# export DOCKER_HOST=tcp://localhost:2380\n# pwd\n/root/docker-host/nodes\n# docker-compose up -d consul\nCreating nodes_consul_1...\n# docker-compose scale consul=3\nCreating nodes_consul_2...\nCreating nodes_consul_3...\nStarting nodes_consul_2...\nStarting nodes_consul_3...\n# docker-compose up -d registrator\nCreating nodes_registrator_1...\n# docker-compose scale registrator=3\nCreating nodes_registrator_2...\nCreating nodes_registrator_3...\nStarting nodes_registrator_2...\nStarting nodes_registrator_3...\n# docker-compose ps\n       Name                      Command               State   Ports\n--------------------------------------------------------------------\nnodes_consul_1        /bin/start -server -bootst ...   Up\nnodes_consul_2        /bin/start -server -bootst ...   Up\nnodes_consul_3        /bin/start -server -bootst ...   Up\nnodes_registrator_1   /bin/registrator consul:// ...   Up\nnodes_registrator_2   /bin/registrator consul:// ...   Up\nnodes_registrator_3   /bin/registrator consul:// ...   Up\n\n\u3042\u3042\u3001\u306a\u3093\u3066\u697d\u3061\u3093\u306a\u3093\u3067\u3057\u3087\u3046\u3002\n\ndocker-loadbalancer\u3092\u30d3\u30eb\u30c9\u3059\u308b\n\u3053\u306edocker-loadbalancer\u306fConsul\u3068\u901a\u4fe1\u3057\u30b5\u30fc\u30d3\u30b9\u306e\u72b6\u614b\u5909\u5316\u306b\u5408\u308f\u305b\u3066Consul-templete\u8d77\u52d5\u3001\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u5c55\u958b\u3057\u3066\u3001Nginx\u3092\u5236\u5fa1\u3057\u3066\u304f\u308c\u308b\u3002\n\u30ce\u30fc\u30c9\u306e\u3069\u308c\u3067\u3082\u3044\u3044\u306e\u3067\u3001\u5c55\u958b\u3057\u3066\u8a2d\u5b9a\u3092\u4fee\u6b63\u3057\u3088\u3046\n# pwd\n/root/docker-host\n# git clone https://github.com/bellycard/docker-loadbalancer.git loadbalancer\nCloning into 'loadbalancer'...\nremote: Counting objects: 40, done.\nremote: Total 40 (delta 0), reused 0 (delta 0), pack-reused 40\nUnpacking objects: 100% (40/40), done.\nChecking connectivity... done.\n# cd loadbalancer\n# ls -al\n-rwxr-xr-x 1 root root  151 Mar  7 10:21 consul-template.service\n-rw-r--r-- 1 root root  619 Mar  7 10:21 Dockerfile\n-rw-r--r-- 1 root root  164 Mar  7 10:21 .envrc\n-rw-r--r-- 1 root root  532 Mar  7 10:21 fig.yml\ndrwxr-xr-x 8 root root 4096 Mar  7 10:21 .git\n-rw-r--r-- 1 root root  420 Mar  7 10:21 nginx.conf\n-rwxr-xr-x 1 root root  123 Mar  7 10:21 nginx.service\n-rw-r--r-- 1 root root 1064 Mar  7 10:21 README.md\n\n\u3053\u3053\u3067\u7de8\u96c6\u304c\u5fc5\u8981\u306a\u306e\u306f nginx.conf \u3068 consul-template.service \u3060\n\nnginx.conf\nupstream nohost {\n  least_conn;\n  server 127.0.0.1:65535;\n}\n\nupstream testweb {\n  least_conn;\n  {{range service \"production.testweb\"}}server {{.Address}}:{{.Port}} max_fails=3 fail_timeout=60 weight=1;\n  {{else}}server 127.0.0.1:65535; # force a 502{{end}}\n}\n\nserver {\n  listen 80 default_server;\n\n  location / {\n    proxy_pass http://nohost;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_set_header Host $host;\n    proxy_set_header X-Real-IP $remote_addr;\n  }\n}\n\nserver {\n  listen 80;\n  server_name docker.example.com;\n\n  location / {\n    proxy_pass http://testweb;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_set_header Host $host;\n    proxy_set_header X-Real-IP $remote_addr;\n  }\n}\n\n\n\u3053\u3046\u3059\u308b\u3053\u3068\u3067\n\u30b5\u30fc\u30d3\u30b9\u540d(SERVICE_NAME) testweb\n\u30bf\u30b0\u540d(SERVICE_TAGS) production\n\u3068\u3044\u3046\u74b0\u5883\u5909\u6570\u304c\u3064\u3044\u305f\u30b3\u30f3\u30c6\u30ca\u304c\u5897\u6e1b\u3057\u305f\u6642\u3001\u4e0a\u8a18\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092Consul-templete\u304c{{.Address}}:{{.Port}}\u90e8\u5206\u3092\u5b9f\u969b\u306eIP\u3068\u30dd\u30fc\u30c8\u756a\u53f7\u306b\u5c55\u958b\u3057\u3066\u304f\u308c\u308b\n\nconsul-template.service\n#!/bin/sh\n\nexec consul-template \\\n     -consul=127.0.0.1:8500 \\\n     -template \"/etc/consul-templates/nginx.conf:/etc/nginx/conf.d/app.conf:sv hup nginx\"\n\n\n\nConsul-template\u306e\u8d77\u52d5\u30aa\u30d7\u30b7\u30e7\u30f3\u306bConsul\u306e\u63a5\u7d9a\u5148\u304c\u66f8\u3044\u3066\u3042\u308b\u306e\u3067\u3053\u3053\u3092\u66f8\u304d\u63db\u3048\u3066\u3044\u308b\u3002\n(127.0.0.1\u3060\u3068\u3053\u306e\u30b3\u30f3\u30c6\u30ca\u5185\u306a\u3093\u3058\u3083\u306a\u3044\u306e\uff1f\u3068\u601d\u308f\u308c\u305f\u3042\u306a\u305f\u306f\u92ed\u3044.\u30db\u30b9\u30c8\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u6a5f\u80fd\u306e\u304a\u304b\u3052\u3067\u3059)\n\u66f8\u304d\u63db\u3048\u304c\u5b8c\u4e86\u3057\u305f\u306a\u3089\u3070\u30d3\u30eb\u30c9\u3057\u3066\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30ec\u30b8\u30b9\u30c8\u30ea\u306bpush\u3057\u3066\u3057\u307e\u304a\u3046\n# docker build .\nSending build context to Docker daemon 113.2 kB\nSending build context to Docker daemon\nStep 0 : FROM nginx:1.7\n ---> 2485b0f89951\nStep 1 : MAINTAINER Shane Sveller <shane@bellycard.com>\n ---> Using cache\n ---> 8b00a2293a97\n...\n...\n...\nStep 5 : ADD nginx.service /etc/service/nginx/run\n ---> b1b0b05a408b\nRemoving intermediate container ee6e15440531\nStep 6 : ADD consul-template.service /etc/service/consul-template/run\n ---> 1daacc85e833\nRemoving intermediate container bb545c650ac1\n...\n...\n...\nRemoving intermediate container 33bab34d8d86\nSuccessfully built d0b8fa1bb2df\n# docker tag d0b8fa1bb2df 10.10.0.110:5000/zerobytezero/docker-loadbalancer:latest\n# docker push 10.10.0.110:5000/zerobytezero/docker-loadbalancer:latest\nThe push refers to a repository [10.10.0.110:5000/zerobytezero/docker-loadbalancer] (len: 1)\nSending image list\nPushing repository 10.10.0.110:5000/zerobytezero/docker-loadbalancer (1 tags)\n...\n...\n...\n1daacc85e833: Image successfully pushed\nc878bca3ec0c: Image successfully pushed\n9201627715ed: Image successfully pushed\nd0b8fa1bb2df: Image successfully pushed\nPushing tag for rev [d0b8fa1bb2df] on {http://10.10.0.110:5000/v1/repositories/zerobytezero/docker-loadbalancer/tags/latest}\n\npush\u304c\u7d42\u308f\u3063\u305f\u306a\u3089\u3001\u5404\u30ce\u30fc\u30c9\u3067\u4e88\u3081pull\u3057\u3066\u304a\u3051\u3070OK.\nDockerman\u306b\u623b\u3063\u3066docker-compose.yml\u306b\u4ee5\u4e0b\u5b9a\u7fa9\u3092\u8ffd\u52a0\u3059\u308b\n\ndocker-compose.yml\nloadbalancer:\n  image: 10.10.0.110:5000/zerobytezero/docker-loadbalancer:latest\n  ports:\n  - \"80\"\n  expose:\n  - \"80\"\n  environment:\n  - \"affinity:container!=nodes_loadbalancer_*\"\n  net: \"host\"\n\n\ndocker-loadbalancer\u3082\u5404\u30ce\u30fc\u30c9\u306b1\u3064\u3060\u3051\u306b\u306a\u308b\u3088\u3046\u5236\u9650\u304c\u5fc5\u8981\u3060\n\u3088\u30fc\u3057loadbalancer\u3082\u7acb\u3061\u4e0a\u304c\u3063\u3066\u304a\u3057\u307e\u3044\uff01\n# docker-compose up -d loadbalancer\nCreating nodes_loadbalancer_1...\n# docker-compose scale loadbalancer=3\nCreating nodes_loadbalancer_2...\nCreating nodes_loadbalancer_3...\nStarting nodes_loadbalancer_2...\nStarting nodes_loadbalancer_3...\n\n\u6b8b\u308b\u306f\u4e2d\u8eab\u3060\u3051\u3060\u3063\n\nWeb\u30b3\u30f3\u30c6\u30ca\u3092\u6e96\u5099\u3059\u308b\n\u306a\u306b\u304b\u8868\u793a\u3059\u308b\u3082\u306e\u304c\u7121\u3044\u3068\u5bc2\u3057\u3044\u306e\u3067...\n# mkdir -p /docker-volumes/testweb\n# nano /docker-volumes/testweb/index.php\n\n\nindex.php\n<?php ini_set('date.timezone', 'Asia/Tokyo'); ?>\n<html>\n<head>\n  <title>docker-container</title>\n</head>\n<body>\n  <h1>\n    docker00:<?php echo $_SERVER['SERVER_ADDR']; ?>\n  </h1>\n  <ul>\n  <?php\n    foreach (getallheaders() as $name => $value) {\n      echo \"<li>$name: $value</li>\";\n    }\n  ?>\n  </ul>\n</body>\n</html>\n\n\n\u5404\u30ce\u30fc\u30c9\u306b\u305d\u308c\u305e\u308c\u3001\u3053\u3093\u306aPHP\u30d5\u30a1\u30a4\u30eb\u3092\u914d\u7f6e\u3057\u305f\u3002\n\"docker00\"\u306e\u90e8\u5206\u3092\u5404\u30ce\u30fc\u30c9\u540d\u306b\u66f8\u304d\u63db\u3048\u3066\u304a\u3051\u3070\u3069\u306e\u30ce\u30fc\u30c9\u304c\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u8fd4\u3057\u3066\u3044\u308b\u306e\u304b\u308f\u304b\u308a\u3084\u3059\u3044\u3068\u601d\u3046\u3002\nDockerman\u306edocker-compose.yml\u306b\u3055\u3089\u306b\u4ee5\u4e0b\u3092\u8ffd\u52a0\u3059\u308b\n\ndocker-compose.yml\nwebapps:\n  image: php:5.6-apache\n  volumes:\n   - \"/docker-volumes/testweb:/var/www/html\"\n  ports:\n   - \"80\"\n  environment:\n   - \"affinity:container!=nodes_webapps_*\"\n   - SERVICE_80_NAME=http\n   - SERVICE_NAME=testweb\n   - SERVICE_TAGS=production\n\nscalewebapps:\n  image: php:5.6-apache\n  volumes:\n   - \"/docker-volumes/testweb:/var/www/html\"\n  ports:\n   - \"80\"\n  environment:\n   - SERVICE_80_NAME=http\n   - SERVICE_NAME=testweb\n   - SERVICE_TAGS=production\n\n\n\n\u306a\u3093\u3067\uff12\u3064\u306b\u3057\u3061\u3083\u3063\u305f\u306e\uff1f\nNginx\u304c\u751f\u304d\u3066\u308b\u306e\u306b1\u53f0\u3082Web\u30b3\u30f3\u30c6\u30ca\u304c\u7121\u3044\u3068502\u304c\u8fd4\u3063\u3066\u3057\u307e\u3046\u306e\u3067\u3001\u6700\u4f4e\u9650\u30ce\u30fc\u30c9\u6570\u3068\u540c\u3058\u3060\u3051\u306eWeb\u30b5\u30fc\u30d0\u3092\u7528\u610f\u3057\u3066\u304a\u304f\u5fc5\u8981\u304c\u3042\u3063\u3066\u3001\u3053\u308c\u304cwebapps\u30b5\u30fc\u30d3\u30b9\u3002\nscalewebapps\u306f\u30eb\u30fc\u30eb\u306b\u7121\u7528\u3067ramdom\u306b\u30ce\u30fc\u30c9\u306b\u6563\u3089\u3070\u3063\u3066\u3044\u304f\u8a2d\u5b9a\u3068\u3057\u3066\u3001\u30d1\u30ef\u30fc\u4e0d\u8db3\u306f\u3053\u3044\u3064\u3092\u30b9\u30b1\u30fc\u30eb\u3059\u308b\u3053\u3068\u3067\u5bfe\u5fdc\u3057\u3066\u3044\u304f\u3002\n\u30ec\u30c3\u30c4\u8d77\u52d5\n# docker-compose up -d webapps\nCreating nodes_webapps_1...\n# docker-compose scale webapps=3\nCreating nodes_webapps_2...\nCreating nodes_webapps_3...\nStarting nodes_webapps_2...\nStarting nodes_webapps_3...\n\nregistrator_2 | 2015/03/07 23:21:37 registrator: added: 540cc048a95b ip-10-10-0-50:nodes_webapps_1:80\nconsul_2      |     2015/03/07 23:21:37 [INFO] agent: Synced service 'ip-10-10-0-50:nodes_webapps_1:80'\nregistrator_3 | 2015/03/07 23:21:39 registrator: added: 665e35e82457 ip-10-10-0-51:nodes_webapps_2:80\nconsul_1      |     2015/03/07 23:21:39 [INFO] agent: Synced service 'ip-10-10-0-51:nodes_webapps_2:80'\nregistrator_1 | 2015/03/07 23:21:39 registrator: added: e9aaf6a0c092 ip-10-10-0-49:nodes_webapps_3:80\nconsul_3      |     2015/03/07 23:21:39 [INFO] agent: Synced service 'ip-10-10-0-49:nodes_webapps_3:80'\n\n\u3061\u3083\u3093\u3068\u3001Registrator\u304cConsul\u306b\u767b\u9332\u3057\u3066\u304f\u308c\u3066\u308b\u307d\u3044\uff01\nMacbook\u306b/etc/hosts\u3092\u66f8\u3044\u3066\u30a2\u30af\u30bb\u30b9\u3057\u3066\u5404\u30ce\u30fc\u30c9\u304c\u3061\u3083\u3093\u3068\u52d5\u3044\u3066\u3044\u308b\u3088\u3046\u306a\u3089\u3001ELB\u914d\u4e0b\u306b\u30ce\u30fc\u30c9\u3092\u7f6e\u3044\u3066\u3057\u307e\u304a\u3046\u3002\n\n\u30ea\u30ed\u30fc\u30c9\u3059\u308b\u5ea6\u306b\u3061\u3083\u3093\u3068\u30ce\u30fc\u30c9\u304c\u30b0\u30ea\u30b0\u30ea\u3057\u3066\u308c\u3070\u5927\u6210\u529f\uff01\n\u3044\u3084\u30fc\u3001\u4e45\u3005\u306b\n\n\u30a4\u30f3\u30d5\u30e9\u5c4b\u306e\u9b42\u304c\u25ef\u25ef\u3059\u308b\uff01\uff01 by \u30b4\u30fc\u30eb\u30c7\u30f3\u30ab\u30e0\u30a4\n\n\u9577\u304f\u306a\u3063\u3061\u3083\u3063\u305f\u306e\u3067\u6b21\u306e\u8a18\u4e8b\u3067\u300c\u79d8\u6280\u30ce\u30fc\u30c9\u843d\u3068\u3057\u300d\u3068\u304b\u300c\u5fc5\u6bba300\u30b3\u30f3\u30c6\u30ca\u8d77\u52d5\u300d\u3068\u304b\u66f8\u304f\u3068\u3057\u307e\u3059\u304b\u306d\u3002\n\u30d1\u30c8\u30e9\u30c3\u30b7\u30e5\u3001\u50d5\u306f\u3082\u3046\u75b2\u308c\u305f\u3088\u3002\u3002\u3002\n\u6b21\u306e\u8a18\u4e8b : ELB+Swarm+Compose+Consul+Registrator\u3067\u5922\u306f\u53f6\u3046\u306e\u304b(3)\n# \u524d\u56de\u306e\u7d9a\u304d\u3067\u3059\n\n\u524d\u306e\u8a18\u4e8b : <a href=\"http://qiita.com/zERobYTe/items/dd9b2365c93da2638221\">ELB+Swarm+Compose+Consul+Registrator\u3067\u5922\u306f\u53f6\u3046\u306e\u304b(1)</a>\n\n# \u30b9\u30d7\u30ea\u30c3\u30c8\u30d6\u30ec\u30a4\u30f3\u72b6\u614b\u306aConsul\u3092\u7acb\u3066\u308b\n\nSwarm\u306f\u5168\u30ce\u30fc\u30c9\u3068\u30b3\u30f3\u30c6\u30ca\u3092\u77e5\u3063\u3066\u3044\u308b\u304cConsul\u306f\u81ea\u30ce\u30fc\u30c9\u306e\u8a2d\u5b9a\u3057\u304b\u8cac\u4efb\u3092\u6301\u305f\u306a\u3044\u3088\u3046\u306b\u3057\u305f\u304b\u3063\u305f\u3002\n\nDockerman\u306e/root/docker-host/\u306bnodes\u3092\u6398\u3063\u3066\u305d\u3053\u306b\u65b0\u3057\u3044docker-compose.yml\u3092\u66f8\u3053\u3046\n\n```bash\n# cd /root/docker-host\n# mkdir nodes\n# cd nodes\n# nano docker-compose.yml\n```\n\n```docker-compose.yml\nconsul:\n  command: -server -bootstrap -ui-dir /ui\n  image: progrium/consul:latest\n  ports:\n  - \"8300\"\n  - \"8400\"\n  - \"8500\"\n  - \"8600/udp\"\n  environment:\n  - \"affinity:container!=nodes_consul_*\"\n  net: \"host\"\n\nregistrator:\n  command: consul://127.0.0.1:8500\n  image: progrium/registrator:latest\n  volumes:\n  - \"/var/run/docker.sock:/tmp/docker.sock\"\n  environment:\n  - \"affinity:container!=nodes_registrator_*\"\n  net: \"host\"\n```\n\n\u3053\u306e\u69cb\u6210\u3067\u306f\n\n* \u5404\u30ce\u30fc\u30c9\u3067Consul\u304c8500\u3067\u5f85\u3061\u53d7\u3051\u3057\n* Registrator\u304c\u81ea\u5206\u304c\u6240\u5c5e\u3057\u3066\u3044\u308b\u30ce\u30fc\u30c9\u306edocker\u30b3\u30f3\u30c6\u30ca\u3092\u628a\u63e1\u3057\u3066\u81ea\u5206\u3068\u540c\u3058\u30ce\u30fc\u30c9\u306eConsul\u306b\u901a\u77e5\n\n\u3068\u306a\u3063\u3066\u3044\u3066\u30b5\u30fc\u30d3\u30b9\u5b9a\u7fa9\u306eenvironment\u306b\u3042\u308b`affinity:container!=\u307b\u306b\u3083\u3089\u3089`\u306f\u540c\u3058\u30ce\u30fc\u30c9\u3067\u306e\u591a\u91cd\u8d77\u52d5\u3092\u9632\u6b62\u3059\u308b\u305f\u3081\u306b\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u3082\u306e\n\n\u3053\u3053\u307e\u3067\u306f\u60a9\u3080\u3068\u3053\u308d\u3082\u7121\u3044\u306e\u3067\u3055\u304f\u3063\u3068\u8d77\u52d5\u3057\u3066\u3057\u307e\u304a\u3046\nDOCKER_HOST\u30922380\u30dd\u30fc\u30c8(swarm manage)\u306b\u5411\u3051\u3066\u304b\u3089docker-compose\u3092\u3059\u308c\u3070Swarm API\u7d4c\u7531\u3067\u30b3\u30f3\u30c6\u30ca\u306e\u5236\u5fa1\u304c\u51fa\u6765\u308b\u3088\u3046\u306b\u306a\u308b\n\n```bash\n# export DOCKER_HOST=tcp://localhost:2380\n# pwd\n/root/docker-host/nodes\n# docker-compose up -d consul\nCreating nodes_consul_1...\n# docker-compose scale consul=3\nCreating nodes_consul_2...\nCreating nodes_consul_3...\nStarting nodes_consul_2...\nStarting nodes_consul_3...\n# docker-compose up -d registrator\nCreating nodes_registrator_1...\n# docker-compose scale registrator=3\nCreating nodes_registrator_2...\nCreating nodes_registrator_3...\nStarting nodes_registrator_2...\nStarting nodes_registrator_3...\n# docker-compose ps\n       Name                      Command               State   Ports\n--------------------------------------------------------------------\nnodes_consul_1        /bin/start -server -bootst ...   Up\nnodes_consul_2        /bin/start -server -bootst ...   Up\nnodes_consul_3        /bin/start -server -bootst ...   Up\nnodes_registrator_1   /bin/registrator consul:// ...   Up\nnodes_registrator_2   /bin/registrator consul:// ...   Up\nnodes_registrator_3   /bin/registrator consul:// ...   Up\n```\n\n\u3042\u3042\u3001\u306a\u3093\u3066\u697d\u3061\u3093\u306a\u3093\u3067\u3057\u3087\u3046\u3002\n\n# docker-loadbalancer\u3092\u30d3\u30eb\u30c9\u3059\u308b\n\n\u3053\u306edocker-loadbalancer\u306fConsul\u3068\u901a\u4fe1\u3057\u30b5\u30fc\u30d3\u30b9\u306e\u72b6\u614b\u5909\u5316\u306b\u5408\u308f\u305b\u3066Consul-templete\u8d77\u52d5\u3001\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u5c55\u958b\u3057\u3066\u3001Nginx\u3092\u5236\u5fa1\u3057\u3066\u304f\u308c\u308b\u3002\n\n\u30ce\u30fc\u30c9\u306e\u3069\u308c\u3067\u3082\u3044\u3044\u306e\u3067\u3001\u5c55\u958b\u3057\u3066\u8a2d\u5b9a\u3092\u4fee\u6b63\u3057\u3088\u3046\n\n```bash\n# pwd\n/root/docker-host\n# git clone https://github.com/bellycard/docker-loadbalancer.git loadbalancer\nCloning into 'loadbalancer'...\nremote: Counting objects: 40, done.\nremote: Total 40 (delta 0), reused 0 (delta 0), pack-reused 40\nUnpacking objects: 100% (40/40), done.\nChecking connectivity... done.\n# cd loadbalancer\n# ls -al\n-rwxr-xr-x 1 root root  151 Mar  7 10:21 consul-template.service\n-rw-r--r-- 1 root root  619 Mar  7 10:21 Dockerfile\n-rw-r--r-- 1 root root  164 Mar  7 10:21 .envrc\n-rw-r--r-- 1 root root  532 Mar  7 10:21 fig.yml\ndrwxr-xr-x 8 root root 4096 Mar  7 10:21 .git\n-rw-r--r-- 1 root root  420 Mar  7 10:21 nginx.conf\n-rwxr-xr-x 1 root root  123 Mar  7 10:21 nginx.service\n-rw-r--r-- 1 root root 1064 Mar  7 10:21 README.md\n```\n\n\u3053\u3053\u3067\u7de8\u96c6\u304c\u5fc5\u8981\u306a\u306e\u306f nginx.conf \u3068 consul-template.service \u3060\n\n```nginx.conf\nupstream nohost {\n  least_conn;\n  server 127.0.0.1:65535;\n}\n\nupstream testweb {\n  least_conn;\n  {{range service \"production.testweb\"}}server {{.Address}}:{{.Port}} max_fails=3 fail_timeout=60 weight=1;\n  {{else}}server 127.0.0.1:65535; # force a 502{{end}}\n}\n\nserver {\n  listen 80 default_server;\n\n  location / {\n    proxy_pass http://nohost;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_set_header Host $host;\n    proxy_set_header X-Real-IP $remote_addr;\n  }\n}\n\nserver {\n  listen 80;\n  server_name docker.example.com;\n\n  location / {\n    proxy_pass http://testweb;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_set_header Host $host;\n    proxy_set_header X-Real-IP $remote_addr;\n  }\n}\n```\n\n\u3053\u3046\u3059\u308b\u3053\u3068\u3067\n\n\u30b5\u30fc\u30d3\u30b9\u540d(SERVICE_NAME) testweb\n\u30bf\u30b0\u540d(SERVICE_TAGS) production\n\n\u3068\u3044\u3046\u74b0\u5883\u5909\u6570\u304c\u3064\u3044\u305f\u30b3\u30f3\u30c6\u30ca\u304c\u5897\u6e1b\u3057\u305f\u6642\u3001\u4e0a\u8a18\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092Consul-templete\u304c{{.Address}}:{{.Port}}\u90e8\u5206\u3092\u5b9f\u969b\u306eIP\u3068\u30dd\u30fc\u30c8\u756a\u53f7\u306b\u5c55\u958b\u3057\u3066\u304f\u308c\u308b\n\n```sh:consul-template.service\n#!/bin/sh\n\nexec consul-template \\\n     -consul=127.0.0.1:8500 \\\n     -template \"/etc/consul-templates/nginx.conf:/etc/nginx/conf.d/app.conf:sv hup nginx\"\n     \n```\n\nConsul-template\u306e\u8d77\u52d5\u30aa\u30d7\u30b7\u30e7\u30f3\u306bConsul\u306e\u63a5\u7d9a\u5148\u304c\u66f8\u3044\u3066\u3042\u308b\u306e\u3067\u3053\u3053\u3092\u66f8\u304d\u63db\u3048\u3066\u3044\u308b\u3002\n(127.0.0.1\u3060\u3068\u3053\u306e\u30b3\u30f3\u30c6\u30ca\u5185\u306a\u3093\u3058\u3083\u306a\u3044\u306e\uff1f\u3068\u601d\u308f\u308c\u305f\u3042\u306a\u305f\u306f\u92ed\u3044.\u30db\u30b9\u30c8\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u6a5f\u80fd\u306e\u304a\u304b\u3052\u3067\u3059)\n\n\u66f8\u304d\u63db\u3048\u304c\u5b8c\u4e86\u3057\u305f\u306a\u3089\u3070\u30d3\u30eb\u30c9\u3057\u3066\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30ec\u30b8\u30b9\u30c8\u30ea\u306bpush\u3057\u3066\u3057\u307e\u304a\u3046\n\n```bash\n# docker build .\nSending build context to Docker daemon 113.2 kB\nSending build context to Docker daemon\nStep 0 : FROM nginx:1.7\n ---> 2485b0f89951\nStep 1 : MAINTAINER Shane Sveller <shane@bellycard.com>\n ---> Using cache\n ---> 8b00a2293a97\n...\n...\n...\nStep 5 : ADD nginx.service /etc/service/nginx/run\n ---> b1b0b05a408b\nRemoving intermediate container ee6e15440531\nStep 6 : ADD consul-template.service /etc/service/consul-template/run\n ---> 1daacc85e833\nRemoving intermediate container bb545c650ac1\n...\n...\n...\nRemoving intermediate container 33bab34d8d86\nSuccessfully built d0b8fa1bb2df\n# docker tag d0b8fa1bb2df 10.10.0.110:5000/zerobytezero/docker-loadbalancer:latest\n# docker push 10.10.0.110:5000/zerobytezero/docker-loadbalancer:latest\nThe push refers to a repository [10.10.0.110:5000/zerobytezero/docker-loadbalancer] (len: 1)\nSending image list\nPushing repository 10.10.0.110:5000/zerobytezero/docker-loadbalancer (1 tags)\n...\n...\n...\n1daacc85e833: Image successfully pushed\nc878bca3ec0c: Image successfully pushed\n9201627715ed: Image successfully pushed\nd0b8fa1bb2df: Image successfully pushed\nPushing tag for rev [d0b8fa1bb2df] on {http://10.10.0.110:5000/v1/repositories/zerobytezero/docker-loadbalancer/tags/latest}\n```\n\npush\u304c\u7d42\u308f\u3063\u305f\u306a\u3089\u3001\u5404\u30ce\u30fc\u30c9\u3067\u4e88\u3081pull\u3057\u3066\u304a\u3051\u3070OK.\n\nDockerman\u306b\u623b\u3063\u3066docker-compose.yml\u306b\u4ee5\u4e0b\u5b9a\u7fa9\u3092\u8ffd\u52a0\u3059\u308b\n\n```docker-compose.yml\nloadbalancer:\n  image: 10.10.0.110:5000/zerobytezero/docker-loadbalancer:latest\n  ports:\n  - \"80\"\n  expose:\n  - \"80\"\n  environment:\n  - \"affinity:container!=nodes_loadbalancer_*\"\n  net: \"host\"\n```\n\ndocker-loadbalancer\u3082\u5404\u30ce\u30fc\u30c9\u306b1\u3064\u3060\u3051\u306b\u306a\u308b\u3088\u3046\u5236\u9650\u304c\u5fc5\u8981\u3060\n\u3088\u30fc\u3057loadbalancer\u3082\u7acb\u3061\u4e0a\u304c\u3063\u3066\u304a\u3057\u307e\u3044\uff01\n\n```bash\n# docker-compose up -d loadbalancer\nCreating nodes_loadbalancer_1...\n# docker-compose scale loadbalancer=3\nCreating nodes_loadbalancer_2...\nCreating nodes_loadbalancer_3...\nStarting nodes_loadbalancer_2...\nStarting nodes_loadbalancer_3...\n```\n\n\u6b8b\u308b\u306f\u4e2d\u8eab\u3060\u3051\u3060\u3063\n\n# Web\u30b3\u30f3\u30c6\u30ca\u3092\u6e96\u5099\u3059\u308b\n\n\u306a\u306b\u304b\u8868\u793a\u3059\u308b\u3082\u306e\u304c\u7121\u3044\u3068\u5bc2\u3057\u3044\u306e\u3067...\n\n```bash\n# mkdir -p /docker-volumes/testweb\n# nano /docker-volumes/testweb/index.php\n```\n\n```php:index.php\n<?php ini_set('date.timezone', 'Asia/Tokyo'); ?>\n<html>\n<head>\n  <title>docker-container</title>\n</head>\n<body>\n  <h1>\n    docker00:<?php echo $_SERVER['SERVER_ADDR']; ?>\n  </h1>\n  <ul>\n  <?php\n    foreach (getallheaders() as $name => $value) {\n      echo \"<li>$name: $value</li>\";\n    }\n  ?>\n  </ul>\n</body>\n</html>\n```\n\n\u5404\u30ce\u30fc\u30c9\u306b\u305d\u308c\u305e\u308c\u3001\u3053\u3093\u306aPHP\u30d5\u30a1\u30a4\u30eb\u3092\u914d\u7f6e\u3057\u305f\u3002\n\"docker00\"\u306e\u90e8\u5206\u3092\u5404\u30ce\u30fc\u30c9\u540d\u306b\u66f8\u304d\u63db\u3048\u3066\u304a\u3051\u3070\u3069\u306e\u30ce\u30fc\u30c9\u304c\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u8fd4\u3057\u3066\u3044\u308b\u306e\u304b\u308f\u304b\u308a\u3084\u3059\u3044\u3068\u601d\u3046\u3002\n\nDockerman\u306edocker-compose.yml\u306b\u3055\u3089\u306b\u4ee5\u4e0b\u3092\u8ffd\u52a0\u3059\u308b\n\n```docker-compose.yml\nwebapps:\n  image: php:5.6-apache\n  volumes:\n   - \"/docker-volumes/testweb:/var/www/html\"\n  ports:\n   - \"80\"\n  environment:\n   - \"affinity:container!=nodes_webapps_*\"\n   - SERVICE_80_NAME=http\n   - SERVICE_NAME=testweb\n   - SERVICE_TAGS=production\n\nscalewebapps:\n  image: php:5.6-apache\n  volumes:\n   - \"/docker-volumes/testweb:/var/www/html\"\n  ports:\n   - \"80\"\n  environment:\n   - SERVICE_80_NAME=http\n   - SERVICE_NAME=testweb\n   - SERVICE_TAGS=production\n```\n\n### \u306a\u3093\u3067\uff12\u3064\u306b\u3057\u3061\u3083\u3063\u305f\u306e\uff1f\nNginx\u304c\u751f\u304d\u3066\u308b\u306e\u306b1\u53f0\u3082Web\u30b3\u30f3\u30c6\u30ca\u304c\u7121\u3044\u3068502\u304c\u8fd4\u3063\u3066\u3057\u307e\u3046\u306e\u3067\u3001\u6700\u4f4e\u9650\u30ce\u30fc\u30c9\u6570\u3068\u540c\u3058\u3060\u3051\u306eWeb\u30b5\u30fc\u30d0\u3092\u7528\u610f\u3057\u3066\u304a\u304f\u5fc5\u8981\u304c\u3042\u3063\u3066\u3001\u3053\u308c\u304cwebapps\u30b5\u30fc\u30d3\u30b9\u3002\n\nscalewebapps\u306f\u30eb\u30fc\u30eb\u306b\u7121\u7528\u3067ramdom\u306b\u30ce\u30fc\u30c9\u306b\u6563\u3089\u3070\u3063\u3066\u3044\u304f\u8a2d\u5b9a\u3068\u3057\u3066\u3001\u30d1\u30ef\u30fc\u4e0d\u8db3\u306f\u3053\u3044\u3064\u3092\u30b9\u30b1\u30fc\u30eb\u3059\u308b\u3053\u3068\u3067\u5bfe\u5fdc\u3057\u3066\u3044\u304f\u3002\n\n\u30ec\u30c3\u30c4\u8d77\u52d5\n\n```bash\n# docker-compose up -d webapps\nCreating nodes_webapps_1...\n# docker-compose scale webapps=3\nCreating nodes_webapps_2...\nCreating nodes_webapps_3...\nStarting nodes_webapps_2...\nStarting nodes_webapps_3...\n```\n\n```logs\nregistrator_2 | 2015/03/07 23:21:37 registrator: added: 540cc048a95b ip-10-10-0-50:nodes_webapps_1:80\nconsul_2      |     2015/03/07 23:21:37 [INFO] agent: Synced service 'ip-10-10-0-50:nodes_webapps_1:80'\nregistrator_3 | 2015/03/07 23:21:39 registrator: added: 665e35e82457 ip-10-10-0-51:nodes_webapps_2:80\nconsul_1      |     2015/03/07 23:21:39 [INFO] agent: Synced service 'ip-10-10-0-51:nodes_webapps_2:80'\nregistrator_1 | 2015/03/07 23:21:39 registrator: added: e9aaf6a0c092 ip-10-10-0-49:nodes_webapps_3:80\nconsul_3      |     2015/03/07 23:21:39 [INFO] agent: Synced service 'ip-10-10-0-49:nodes_webapps_3:80'\n```\n\n\u3061\u3083\u3093\u3068\u3001Registrator\u304cConsul\u306b\u767b\u9332\u3057\u3066\u304f\u308c\u3066\u308b\u307d\u3044\uff01\n\nMacbook\u306b/etc/hosts\u3092\u66f8\u3044\u3066\u30a2\u30af\u30bb\u30b9\u3057\u3066\u5404\u30ce\u30fc\u30c9\u304c\u3061\u3083\u3093\u3068\u52d5\u3044\u3066\u3044\u308b\u3088\u3046\u306a\u3089\u3001ELB\u914d\u4e0b\u306b\u30ce\u30fc\u30c9\u3092\u7f6e\u3044\u3066\u3057\u307e\u304a\u3046\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2015-03-08 8.48.49.png](https://qiita-image-store.s3.amazonaws.com/0/36701/26e2b768-af51-a7ba-878a-9b23dba76d82.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2015-03-08 8.48.49.png\")\n\n\u30ea\u30ed\u30fc\u30c9\u3059\u308b\u5ea6\u306b\u3061\u3083\u3093\u3068\u30ce\u30fc\u30c9\u304c\u30b0\u30ea\u30b0\u30ea\u3057\u3066\u308c\u3070\u5927\u6210\u529f\uff01\n\n\u3044\u3084\u30fc\u3001\u4e45\u3005\u306b\n\n>\u30a4\u30f3\u30d5\u30e9\u5c4b\u306e\u9b42\u304c\u25ef\u25ef\u3059\u308b\uff01\uff01 by \u30b4\u30fc\u30eb\u30c7\u30f3\u30ab\u30e0\u30a4\n\n\u9577\u304f\u306a\u3063\u3061\u3083\u3063\u305f\u306e\u3067\u6b21\u306e\u8a18\u4e8b\u3067\u300c\u79d8\u6280\u30ce\u30fc\u30c9\u843d\u3068\u3057\u300d\u3068\u304b\u300c\u5fc5\u6bba300\u30b3\u30f3\u30c6\u30ca\u8d77\u52d5\u300d\u3068\u304b\u66f8\u304f\u3068\u3057\u307e\u3059\u304b\u306d\u3002\n\n\u30d1\u30c8\u30e9\u30c3\u30b7\u30e5\u3001\u50d5\u306f\u3082\u3046\u75b2\u308c\u305f\u3088\u3002\u3002\u3002\n\n\n\u6b21\u306e\u8a18\u4e8b : <a href=\"http://qiita.com/zERobYTe/items/3415338f7fac5ced7577\">ELB+Swarm+Compose+Consul+Registrator\u3067\u5922\u306f\u53f6\u3046\u306e\u304b(3)</a>\n\n", "tags": ["docker", "consul"]}