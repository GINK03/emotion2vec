{"tags": ["WebGL", "GLSL", "Grimoire.js"], "context": "\u81ea\u4f5c\u306e\u30e9\u30a4\u30d6\u30e9\u30eaGrimoire.js\u3067PBR(Physically Based Rendering)\u3092\u5b9f\u88c5\u3057\u305f\u306e\u3067\u81ea\u5206\u306e\u7406\u89e3\u3082\u517c\u306d\u3066\u5c11\u3057\u307e\u3068\u3081\u307e\u3059\u3002\n\u3061\u306a\u307f\u306b\u3053\u306e\u30b7\u30a7\u30fc\u30c7\u30a3\u30f3\u30b0\u306f\u6b21\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u53d6\u308a\u8fbc\u307e\u308c\u307e\u3059\u3002\n\n\u5b9f\u969b\u306e\u30b5\u30f3\u30d7\u30eb\n\u3053\u3053\u304b\u3089\u306f\u96e3\u3057\u3044\u304b\u3082\u3057\u308c\u306a\u3044\u5185\u5bb9\u3002\n\n\u57fa\u790e\u7684\u306a\u7406\u8ad6\n\n\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u65b9\u7a0b\u5f0f\n\u3042\u308b\u70b9\u306b\u304a\u3051\u308b\u660e\u308b\u3055\u3092\u6c42\u3081\u308b\u3068\u3044\u3046\u3053\u3068\u306f\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u65b9\u7a0b\u5f0f\u3068\u547c\u3070\u308c\u308b\u4ee5\u4e0b\u306e\u5f0f\u3092\u3068\u304f\u3053\u3068\u305d\u306e\u3082\u306e\u3067\u3059\u3002\nLo(x,\u03c9v)=Le(x,\u03c9v)+\u222b\u03a9fr(x,\u03c9i,\u03c9v)Li(x,\u03c9l)(n\u22c5\u03c9i)d\u03c9ix:\u660e\u308b\u3055\u3092\u6c42\u3081\u305f\u3044\u70b9\u03c9v:x\u304b\u3089\u8996\u70b9\u3078\u306e\u65b9\u5411\u30d9\u30af\u30c8\u30ebn:\u70b9x\u306b\u304a\u3051\u308b\u6cd5\u7dda\u30d9\u30af\u30c8\u30ebfr:x\u306e\u70b9\u306b\u304a\u3051\u308b\u3001\u03c9i\u304b\u3089\u306e\u5149\u304c\u03c9v\u3078\u53cd\u5c04\u3059\u308b\u4fc2\u6570\u3092\u6c42\u3081\u308b\u5f0f(\u5f8c\u8ff0)\u03a9:\u534a\u7403\u4e0a\u306e\u7a4d\u5206\u9818\u57dfLo(x,\u03c9v)=Le(x,\u03c9v)+\u222b\u03a9fr(x,\u03c9i,\u03c9v)Li(x,\u03c9l)(n\u22c5\u03c9i)d\u03c9ix:\u660e\u308b\u3055\u3092\u6c42\u3081\u305f\u3044\u70b9\u03c9v:x\u304b\u3089\u8996\u70b9\u3078\u306e\u65b9\u5411\u30d9\u30af\u30c8\u30ebn:\u70b9x\u306b\u304a\u3051\u308b\u6cd5\u7dda\u30d9\u30af\u30c8\u30ebfr:x\u306e\u70b9\u306b\u304a\u3051\u308b\u3001\u03c9i\u304b\u3089\u306e\u5149\u304c\u03c9v\u3078\u53cd\u5c04\u3059\u308b\u4fc2\u6570\u3092\u6c42\u3081\u308b\u5f0f(\u5f8c\u8ff0)\u03a9:\u534a\u7403\u4e0a\u306e\u7a4d\u5206\u9818\u57df{L_o(x,\\omega_v) = L_e(x,\\omega_v) + \\int_\\Omega f_r(x,\\omega_i,\\omega_v)L_i(x,\\omega_l)(n \\cdot \\omega_i) d\\omega_i\n\\\\\nx:\u660e\u308b\u3055\u3092\u6c42\u3081\u305f\u3044\u70b9\\\\\n\\omega_v:x\u304b\u3089\u8996\u70b9\u3078\u306e\u65b9\u5411\u30d9\u30af\u30c8\u30eb\\\\\nn:\u70b9x\u306b\u304a\u3051\u308b\u6cd5\u7dda\u30d9\u30af\u30c8\u30eb\\\\\nfr:x\u306e\u70b9\u306b\u304a\u3051\u308b\u3001\\omega_i\u304b\u3089\u306e\u5149\u304c\\omega_v\u3078\u53cd\u5c04\u3059\u308b\u4fc2\u6570\u3092\u6c42\u3081\u308b\u5f0f(\u5f8c\u8ff0)\\\\\n\\Omega:\u534a\u7403\u4e0a\u306e\u7a4d\u5206\u9818\u57df\n}\n\u3053\u3046\u3057\u3066\u8a18\u8ff0\u3059\u308b\u3068\u3001\u975e\u5e38\u306b\u96e3\u89e3\u306b\u898b\u3048\u307e\u3059\u304c\u3001\u5206\u89e3\u3057\u3066\u8003\u3048\u307e\u3059\u3002\n\n\u5de6\u8fba\nLo(x,\u03c9v)Lo(x,\u03c9v){L_o(x,\\omega_v)\n}\n\u3053\u306e\u5f0f\u306b\u304a\u3051\u308b\u3001Lo\u306f\u70b9x\u306b\u304a\u3051\u308b\u03c9v\u65b9\u5411\u3078\u306e\u5149\u306e\u5f37\u3055\u3092\u8868\u3057\u307e\u3059\u3002\u3053\u308c\u306f\u3064\u307e\u308a\u3001\u3053\u306e\u70b9x\u306b\u304a\u3051\u308b\u30d4\u30af\u30bb\u30eb\u306e\u8272\u3068\u3044\u3046\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\nLe\nLe(x,\u03c9v)Le(x,\u03c9v){L_e(x,\\omega_v)\n}\n\u3053\u306e\u90e8\u5206\u306f\u3001\u81ea\u5df1\u767a\u5149\u8272(Emission)\u306e\u90e8\u5206\u3067\u3059\u3002\n\u3042\u308b\u70b9\u304b\u3089\u76ee\u306b\u5165\u3063\u3066\u304f\u308b\u5149\u3068\u3044\u3046\u306e\u306f\u305d\u306e\u70b9\u304c\u767a\u5149\u3057\u305f\u5149\u306e\u30a8\u30cd\u30eb\u30ae\u30fc\u3068\u305d\u306e\u70b9\u306b\u5165\u5c04\u3057\u305f\u5149\u306e\u4e2d\u3067\u3001\u76ee\u306b\u5411\u304b\u3063\u305f\u5149\u306e\u30a8\u30cd\u30eb\u30ae\u30fc\u306e\u5408\u8a08\u306e\u548c\u306b\u306a\u308a\u307e\u3059\u3002\n\u3053\u306eLe\u306e\u9805\u76ee\u306f\u3053\u306e\u3046\u3061\u306e \u767a\u5149\u3057\u305f\u30a8\u30cd\u30eb\u30ae\u30fc\u306b\u3042\u305f\u308b\u90e8\u5206 \u3067\u3059\u3002\u3053\u308c\u81ea\u8eab\u304c\u706b\u306a\u3069\u306e\u767a\u5149\u3059\u308b\u3082\u306e\u3067\u306a\u3044\u9650\u308a\u306f\u901a\u5e38\u5fc5\u8981\u3042\u308a\u307e\u305b\u3093\u3002\n\n\u7a4d\u5206\u306e\u90e8\u5206\n\u222b\u03a9fr(x,\u03c9i,\u03c9v)Li(x,\u03c9l)(n\u22c5\u03c9i)d\u03c9i\u222b\u03a9fr(x,\u03c9i,\u03c9v)Li(x,\u03c9l)(n\u22c5\u03c9i)d\u03c9i{\\int_\\Omega f_r(x,\\omega_i,\\omega_v)L_i(x,\\omega_l)(n \\cdot \\omega_i) d\\omega_i\n}\n\u3053\u306e\u90e8\u5206\u306b\u304a\u3051\u308b\u3001\u03c9i\u306f\u7a4d\u5206\u5909\u6570\u3067\u3059\u304c\u3001x\u3092\u4e2d\u5fc3\u3068\u3059\u308b\u534a\u7403\u4e0a\u306e\u65b9\u5411\u30d9\u30af\u30c8\u30eb\u3067\u3059\u3002\n\u3053\u306e\u3001\u534a\u7403\u4e0a\u306e\u5404\u65b9\u5411\u304b\u3089\u3001x\u306b\u5411\u304b\u3046\u5149\u306e\u3046\u3061\u3001\u8996\u7dda\u65b9\u5411\u306b\u53cd\u5c04\u3055\u308c\u308b\u5149\u306e\u91cf\u3060\u3051\u3092\u8db3\u3057\u5408\u308f\u305b\u305f\u3089\u6c42\u3081\u305f\u3044\u3082\u306e\u306b\u306a\u308a\u305d\u3046\u3067\u306f\u306a\u3044\u3067\u3059\u304b?\n\u3053\u308c\u3092\u3084\u308b\u305f\u3081\u306e\u7a4d\u5206\u306a\u306e\u3067\u3059\u3002\n\u307e\u305a\u306f\u3001\u03a9\u4e0a\u306e\u3042\u308b\u65b9\u5411\u3001\u03c9i\u304b\u3089\u5149\u304c\u5165\u5c04\u3057\u305f\u3068\u3057\u3066\u3001\u305d\u306e\u3068\u304d\u306b\u76ee\u306e\u65b9\u5411\u3078\u5411\u304b\u3046\u30a8\u30cd\u30eb\u30ae\u30fc\u306b\u5bc4\u4e0e\u3059\u308b\u91cf\u3092\u8003\u3048\u308b\u3068\u3057\u307e\u3057\u3087\u3046\u3002\n\u3053\u306e\u6642\u3001\u03c9i\u304b\u3089x\u306b\u5165\u5c04\u3055\u308c\u308b\u5149\u306e\u91cf\u3092Li(x,\u03c9i)\u3067\u8868\u3057\u3066\u3044\u307e\u3059\u3002\u3053\u3053\u3067\u3001Lambart\u306e\u4f59\u5f26\u5247\u306b\u3088\u3063\u3066\u3001\u6cd5\u7dda\u3068\u03c9i\u3068\u306e\u50be\u304d\u304c\u591a\u3051\u308c\u3070\u5927\u304d\u3044\u307b\u3069\u5358\u4f4d\u9762\u7a4d\u5f53\u305f\u308a\u306eLi(x,\u03c9i)\u306b\u3088\u3063\u3066\u7167\u5c04\u3055\u308c\u308b\u30a8\u30cd\u30eb\u30ae\u30fc\u306f\u6e1b\u5c11\u3057\u3001\u3053\u308c\u306f\u6cd5\u7dda\u3068\u306e\u306a\u3059\u89d2\u3092\u03b8\u3068\u3057\u305f\u3068\u304d\u3001cos\u03b8\u3092\u639b\u3051\u5408\u308f\u305b\u308b\u3053\u3068\u306b\u3088\u308a\u3001\u5358\u4f4d\u9762\u7a4d\u5f53\u305f\u308a\u306e\u30a8\u30cd\u30eb\u30ae\u30fc\u304c\u3082\u3068\u307e\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\u3064\u307e\u308a\u3001\u3053\u308c\u306f\u5358\u4f4d\u9762\u7a4d\u5f53\u305f\u308a\u306e\u5165\u5c04\u3057\u305f\u30a8\u30cd\u30eb\u30ae\u30fc\u306e\u5408\u8a08\u3067\u3059\u3002\n\u3053\u306e\u30a8\u30cd\u30eb\u30ae\u30fc\u304b\u3089\u7279\u5b9a\u306e\u65b9\u5411\u3078\u306e\u3042\u308b\u89d2\u5ea6\u5f53\u305f\u308a\u306e\u30a8\u30cd\u30eb\u30ae\u30fc\u306e\u6bd4\u304c\u6c42\u307e\u308c\u3070\u3001\u3053\u308c\u3092\u639b\u3051\u5408\u308f\u305b\u305f\u3082\u306e\u3092\u5408\u8a08\u3059\u308c\u3070\u3001\u4ed6\u306e\u3068\u3053\u308d\u304b\u3089\u3084\u3063\u3066\u304f\u308b\u5149\u306e\u53cd\u5c04\u306b\u3088\u3063\u3066\u5149\u304c\u76ee\u306b\u306f\u3044\u308b\u7387\u306f\u6c42\u307e\u308a\u307e\u3059\u3002\nfr\u306fx\u306e\u70b9\u304c\u3069\u306e\u3088\u3046\u306a\u6750\u8cea\u306b\u3088\u3063\u3066\u6210\u308a\u7acb\u3063\u3066\u3044\u308b\u304b\u306b\u3088\u3063\u3066\u6c7a\u307e\u308a\u307e\u3059\u3002\u3053\u306efr\u306fBRDF\u3068\u547c\u3070\u308c\u3001\u7269\u8cea\u306e\u7279\u6027\u304b\u3089\u5c0e\u304b\u308c\u308b\u5f0f\u3067\u3059\u3002\n\n\u5b9f\u7528\u4e0a\u306eBRDF\n\u5b9f\u7528\u4e0a\u306f\u3001\u3053\u306eBRDF\u306f\u4ee5\u4e0b\u306eDiffuse BRDF,Specular BRDF\u306b\u3088\u3063\u3066\u5206\u5272\u3055\u308c\u8a08\u7b97\u3055\u308c\u307e\u3059\u3002Diffuse\u306f\u62e1\u6563\u5149\u3001Specular\u306f\u53cd\u5c04\u5149\u306b\u5bc4\u4e0e\u3059\u308bBRDF\u3067\u3059\u3002\nfr=kdfd+(1\u2212kd)fsfr=kdfd+(1\u2212kd)fs{f_r = k_df_d + (1- k_d) f_s\n}\n\u3053\u3053\u3067\u3001kd\u306f0\u304b\u30891\u307e\u3067\u306e\u7bc4\u56f2\u3092\u53d6\u308a\u3001\u5c0f\u3055\u3051\u308c\u3070\u5c0f\u3055\u3044\u307b\u3069\u53cd\u5c04\u306b\u3088\u3063\u3066\u8272\u304c\u6c7a\u5b9a\u3059\u308b\u305f\u3081\u306b\u5bc4\u4e0e\u3059\u308b\u7387\u306f\u5927\u304d\u304f\u306a\u308a\u307e\u3059\u3002\nfs\u3068fd\u306b\u3064\u3044\u3066\u306f\u3001Unreal Engine\u306e\u30b3\u30fc\u30b9\u30ce\u30fc\u30c8\u3084\u3001Coding Labs: Physically Based Rendering Cook-Torrance\u304c\u3068\u3066\u3082\u53c2\u8003\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\u5177\u4f53\u7684\u306a\u6570\u5f0f\u3092\u3053\u3053\u306b\u8a18\u8ff0\u3059\u308b\u306e\u306f\u3001\u3059\u3054\u304f\u9762\u5012\u306a\u306e\u3067\u4e0a\u8a18\u306e\u30ea\u30f3\u30af\u3092\u53c2\u7167\u3057\u3066\u6b32\u3057\u3044\u3067\u3059\u304c\u3001\u57fa\u672c\u7684\u306b\u306fUnreal Engine\u306e\u63a1\u7528\u3057\u3066\u3044\u308b\u901a\u308a\u306b\u5b9f\u88c5\u3057\u3066\u3044\u307e\u3059\u3002\n\u3064\u307e\u308a\u3001\n\nDiffuse BRDF\u30fb\u30fb\u30fbLambert\nSpecular BRDF\n\n\nMicrofacet\u9805\u30fb\u30fb\u30fbGGX\n\u5e7e\u4f55\u6e1b\u8870\u9805\u30fb\u30fb\u30fbGGX\nFresnel\u9805\u30fb\u30fb\u30fbSchlick\u8fd1\u4f3c\n\n\n\n\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n\u5b9f\u88c5\u306e\u65b9\u91dd\nWebGL\u306eGLSL\u3067\u3001\u4efb\u610f\u500b\u306e\u30e9\u30a4\u30c8\u3092\u8868\u73fe\u3059\u308b\u306e\u306b\u306f\u69d8\u3005\u306a\u8ab2\u984c\u304c\u5b58\u5728\u3057\u307e\u3059\u3002\n\u7279\u306b\u3001\u30eb\u30fc\u30d7\u306e\u56de\u6570\u306b\u5909\u6570\u3092\u53d6\u308c\u306a\u3044\u306e\u304c\u5927\u304d\u306a\u8ab2\u984c\u3067\u3057\u3087\u3046\u3002\n\u62d9\u4f5c\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u306e\u5834\u5408\u3001\u4f9d\u5b58\u3059\u308b\u30de\u30af\u30ed\u304c\u52d5\u7684\u306b\u5909\u308f\u3063\u305f\u6642\u3060\u3051\u81ea\u52d5\u7684\u306b\u30b7\u30a7\u30fc\u30c0\u30fc\u3092\u30ea\u30b3\u30f3\u30d1\u30a4\u30eb\u3059\u308b\u6a5f\u80fd\u304c\u5165\u3063\u3066\u3044\u308b\u306e\u3067\u3001\u3053\u306e\u70b9\u306f\u3059\u3050\u306b\u5b9f\u88c5\u3067\u304d\u307e\u3059\u304c\u3001\u30e9\u30a4\u30c8\u306e\u6570\u304c\u5909\u52d5\u3057\u3059\u304e\u308b\u30b7\u30fc\u30f3\u306e\u5834\u5408\u3069\u3046\u3057\u3066\u3082\u91cd\u304f\u306a\u3063\u3066\u3057\u307e\u3046\u3068\u8a00\u3046\u6b20\u70b9\u306f\u5b58\u5728\u3057\u307e\u3059\u3002\n\n\u30e9\u30a4\u30c8\u306e\u30e9\u30c7\u30a3\u30a2\u30f3\u30b9\u306e\u5408\u8a08\n\u30b7\u30a7\u30fc\u30c0\u30fc\u5168\u4f53\u3092\u8cbc\u308b\u3068\u3059\u3054\u304f\u5927\u304d\u304f\u306a\u3063\u3066\u3057\u307e\u3046\u306e\u3067\u3001\u9806\u756a\u306b\u89e3\u8aac\u3057\u307e\u3059\u3002\n  vec3 shading(vec3 baseColor,vec3 fragNormal,vec3 fragPosition,float roughness){\n    vec3 lightingColor = vec3(0);\n\n    #ifdef USE_DIR_LIGHT\n      lightingColor.rgb += directionalLight(baseColor,fragNormal,fragPosition,roughness);\n    #endif\n\n    #ifdef USE_POINT_LIGHT\n      lightingColor.rgb += pointLight(baseColor,fragNormal,fragPosition,roughness);\n    #endif\n\n    #ifdef USE_SPOT_LIGHT\n      lightingColor.rgb += spotLight(baseColor,fragNormal,fragPosition,roughness);\n    #endif\n\n    return lightingColor;\n  }\n\n\u3053\u306e\u30e9\u30a4\u30c6\u30a3\u30f3\u30b0\u30ab\u30e9\u30fc\u306f\u4ee5\u4e0b\u306e\u5f0f\u306e\u90e8\u5206\u306b\u306a\u308a\u307e\u3059\u3002\n\u222b\u03a9fr(x,\u03c9i,\u03c9v)Li(x,\u03c9i)(n\u22c5\u03c9i)d\u03c9i\u222b\u03a9fr(x,\u03c9i,\u03c9v)Li(x,\u03c9i)(n\u22c5\u03c9i)d\u03c9i{\\int_\\Omega f_r(x,\\omega_i,\\omega_v)L_i(x,\\omega_i)(n \\cdot \\omega_i) d\\omega_i\n}\n\u3057\u304b\u3057\u3001\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u306a\u8a08\u7b97\u3067\u306f\u7a4d\u5206\u8a08\u7b97\u306a\u3069\u3067\u304d\u306a\u3044\u306e\u3067\u3001\u30b7\u30fc\u30f3\u4e2d\u306b\u5b58\u5728\u3059\u308b\u30e9\u30a4\u30c8\u5168\u3066\u306b\u5bfe\u3057\u30661\u56de\u76ee\u306e\u53cd\u5c04\u3057\u304b\u8003\u616e\u3057\u306a\u3044\u3082\u306e\u3068\u3057\u307e\u3059\u3002\u3064\u307e\u308a\u3001\u30e9\u30a4\u30c8\u304b\u3089\u76f4\u63a5\u306e\u5165\u5c04\u4ee5\u5916\u306a\u3044\u3068\u8003\u3048\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8fd1\u4f3c\u3057\u307e\u3059\u3002\n\u2211k=0N\u22121fr(x,\u03c9k,\u03c9v)L(k)i(x,\u03c9k)(n\u22c5\u03c9k)\u2211k=0N\u22121fr(x,\u03c9k,\u03c9v)Li(k)(x,\u03c9k)(n\u22c5\u03c9k){\\sum^{N-1}_{k=0}f_r(x,\\omega_k,\\omega_v)L_i^{(k)}(x,\\omega_k)(n \\cdot \\omega_k)\n}\n\u3053\u3053\u3067\u3001\u03c9k\u306fk\u756a\u76ee\u306e\u30e9\u30a4\u30c8\u306e\u65b9\u5411\u3078\u306e\u65b9\u5411\u30d9\u30af\u30c8\u30eb(\u305f\u3060\u3057\u3001\u30c7\u30a3\u30ec\u30af\u30b7\u30e7\u30ca\u30eb\u30e9\u30a4\u30c8\u306e\u5834\u5408\u3001\u660e\u78ba\u306a\u4f4d\u7f6e\u306f\u5b58\u5728\u3057\u306a\u3044\u306e\u3067\u3001\u3053\u306e\u5834\u5408\u30c7\u30a3\u30ec\u30af\u30b7\u30e7\u30ca\u30eb\u30e9\u30a4\u30c8\u81ea\u8eab\u306e\u65b9\u5411)\u3001\u307e\u305f\u3001Li(k)\u306f\u3001k\u756a\u76ee\u306e\u30e9\u30a4\u30c8\u304c\u03c9k\u306e\u65b9\u5411\u304b\u3089x\u306b\u653e\u5c04\u3059\u308b\u653e\u5c04\u7167\u5ea6\u306b\u306a\u308a\u307e\u3059\u3002\n\u4f8b\u3048\u3070\u3001\u30c7\u30a3\u30ec\u30af\u30b7\u30e7\u30ca\u30eb\u30e9\u30a4\u30c8\u3067\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u5b9f\u88c5\u306b\u306a\u308a\u307e\u3059\u3002\n  float lambert(vec3 lightDirection,vec3 surfaceNormal) {\n    return max(0.0, dot(lightDirection, surfaceNormal));\n  }\n\n  vec3 directionalLight(vec3 baseColor,vec3 fragNormal,vec3 fragPosition,float roughness){\n    vec3 result = vec3(0,0,0);\n    for(int i = 0; i < DIR_LIGHT_COUNT;i++){\n      vec3 lI = lambert(fragNormal,-_dLightDir[i]) * _dLightColor[i];\n      vec3 lColor = lI * PBR_BRDF(baseColor,-_dLightDir[i],normalize(_cameraPosition - fragPosition),fragNormal,roughness);\n      result += lColor;\n    }\n    return result;\n  }\n\n\u4e0a\u8a18\u306ePBR_BRDF\u306f\u5f8c\u307b\u3069\u8aac\u660e\u3057\u307e\u3059\u304c\u3001\u4e0a\u306efr\u306b\u3042\u305f\u308a\u3001\u4ee5\u4e0b\u306e5\u3064\u3092\u53d7\u3051\u53d6\u3063\u3066\u3044\u307e\u3059\u3002\n\nbaseColor(\u30a2\u30eb\u30d9\u30c9)\n\u30e9\u30a4\u30c8\u3078\u306e\u65b9\u5411(\u03c9k)\n\u30ab\u30e1\u30e9\u3078\u306e\u65b9\u5411(\u03c9v)\n\u305d\u306e\u70b9\u306e\u6cd5\u7dda(n)\n\u30e9\u30d5\u30cd\u30b9\n\n\u592a\u5b57\u306e\u9805\u76ee\u4ee5\u5916\u306f\u6570\u5f0f\u306e\u65b9\u3067\u306f\u3001fr\u306e\u4e2d\u306b\u4f7f\u308f\u308c\u307e\u3059\u304c\u3001\u3053\u3053\u3067\u306fx\u306b\u5fdc\u3058\u3066\u7570\u306a\u308b\u305f\u3081\u4e00\u7dd2\u306b\u6e21\u3057\u3066\u3044\u307e\u3059\u3002\n\u5b9f\u969b\u306ePBR\u306e\u5f0f\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n#ifndef DIFFUSE_BRDF\n    #define DIFFUSE_BRDF lambertBRDF\n\n    vec3 lambertBRDF(vec3 c,vec3 i,vec3 o,vec3 n,float roughness){\n      return c / PI;\n    }\n#endif\n\n#ifndef SPECULAR_BRDF\n\n    #define SPECULAR_BRDF cookTorranceBRDF\n\n    #ifndef CT_D\n      #define CT_D ctd_GGX_Distribution\n    #endif\n\n    #ifndef CT_F\n      #define CT_F ctf_Schlick\n    #endif\n\n    #ifndef CT_G\n      #define CT_G ctg_GGX_GeometryTerm\n    #endif\n\n    float ctd_GGX_Distribution(vec3 l,vec3 v,vec3 n,vec3 h,float roughness){\n      float alpha2 = pow(roughness,4.0);\n      float nh2 = pow(dot(n,h),2.0);\n      return alpha2/(PI*pow(nh2*(alpha2 - 1.0) + 1.0,2.0));\n    }\n\n    float ctg_GGX_GeometryTerm(vec3 l,vec3 v,vec3 n,vec3 h,float roughness){\n      float k = pow(roughness + 1.0,2.0)/8.0;\n      float ln = dot(l,n);\n      float vn = dot(v,n);\n      return (ln/(ln*(1.-k) + k))*(vn/(vn*(1.-k) + k));\n    }\n\n    float ctf_Schlick(vec3 l,vec3 v,vec3 n,vec3 h,float roughness){\n      float f0 = refractive;\n      float vh = dot(v,h);\n      return f0 + pow(1.0-vh,5.0) * (1.0 - f0);\n    }\n\n    vec3 cookTorranceBRDF(vec3 l,vec3 v,vec3 n,float r){\n      vec3 h = normalize(l+v);\n      return vec3(CT_D(l,v,n,h,r) * CT_F(l,v,n,h,r) * CT_G(l,v,n,h,r)/(4.0 * dot(l,n) * dot(v,n)));\n    }\n#endif\n\n#ifndef PBR_BRDF\n\n    #define PBR_BRDF pbrBRDF\n\n    vec3 pbrBRDF(vec3 c,vec3 i,vec3 o,vec3 n,float r){\n      float k0 = kCoeff;\n      return DIFFUSE_BRDF(c,i,o,n,r) * k0 + SPECULAR_BRDF(i,o,n,r) * (1.0 - k0);\n    }\n#endif\n\n\u5f8c\u304b\u3089\u3001\u5f0f\u3092\u5165\u308c\u66ff\u3048\u3084\u3059\u3044\u3088\u3046\u306b\u3001\u30de\u30af\u30ed\u304c\u304b\u306a\u308a\u4f7f\u308f\u308c\u3066\u3044\u3066\u8aad\u307f\u306b\u304f\u3044\u3067\u3059\u304c\u3001UE\u306e\u5f0f\u3092\u305d\u306e\u307e\u307e\u6301\u3063\u3066\u304d\u305f\u3088\u3046\u306a\u5f62\u3068\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\u3042\u3068\u306f\u3001\u30dd\u30a4\u30f3\u30c8\u30e9\u30a4\u30c8\u3084\u3001\u30b9\u30dd\u30c3\u30c8\u30e9\u30a4\u30c8\u3067\u3082\u3001\u540c\u3058BRDF\u304c\u4f7f\u3048\u308b\u306e\u3067\u3001\u305d\u306e\u624b\u524d\u307e\u3067\u3092\u5206\u3051\u3066\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u66f8\u3044\u3066\u3042\u3052\u308c\u3070\u826f\u3044\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n#ifdef USE_POINT_LIGHT\n  vec3 pointLight(vec3 baseColor,vec3 fragNormal,vec3 fragPosition,float roughness){\n    vec3 result = vec3(0,0,0);\n    for(int i = 0; i < POINT_LIGHT_COUNT;i++){\n      vec3 l2p = _pLightPosition[i] - fragPosition;\n      float d = length(l2p);\n      vec2 param = _pLightParam[i];\n      float atten = max(0.,1.0-d/param.x)/(1.0 + param.y*param.y*d);\n      l2p = normalize(l2p);\n      vec3 lI = lambert(fragNormal,l2p)* _pLightColor[i] * atten;\n      vec3 lColor = lI  * PBR_BRDF(baseColor,l2p,normalize(_cameraPosition - fragPosition),fragNormal,roughness);\n      result += lColor ;\n    }\n    return result;\n  }\n#endif\n#ifdef USE_SPOT_LIGHT\n  vec3 spotLight(vec3 baseColor,vec3 fragNormal,vec3 fragPosition,float roughness){\n    vec3 result = vec3(0);\n    for(int i = 0; i < SPOT_LIGHT_COUNT; i++){\n      float innerConeAngle = _sLightParam[i].x;\n      float outerConeAngle = _sLightParam[i].y;\n      float outCos=cos(outerConeAngle);\n      float innCos=cos(innerConeAngle);\n\n      vec3 p2l = _sLightPosition[i] - fragPosition;\n      float d = length(p2l);\n      p2l=p2l/d;\n      float c = dot(-p2l,normalize(_sLightDir[i]));\n      float decay = _sLightParam[i].z;//\u6e1b\u8870\u4fc2\u6570\n      decay = 1.;\n      float angleDecay = decay;\n      //\n      float distDecayCoefficient = 1.0 / (d * d);\n      float angleDecayCoefficient = pow(clamp((c-outCos)/(innCos-outCos),0.0,1.0),angleDecay);\n      //\n      vec3 lI = lambert(p2l,fragNormal)*_sLightColor[i]*angleDecayCoefficient*distDecayCoefficient;\n      vec3 lColor = lI * PBR_BRDF(baseColor,p2l,normalize(_cameraPosition - fragPosition),fragNormal,roughness);\n      result += lColor;\n    }\n    return result;\n  }\n#endif\n\n\u3059\u3054\u304f\u308f\u304b\u308a\u3065\u3089\u3044\u3067\u3059\u304c\u3001\u5927\u4e8b\u306a\u306e\u306flI\u3068\u3057\u3066\u305d\u306e\u5834\u6240\u306b\u5165\u5c04\u3059\u308b\u5149\u306e\u30e9\u30c7\u30a3\u30a2\u30f3\u30b9\u3092\u6c42\u3081\u3001\u305d\u306e\u307e\u307eBRDF\u3068\u306e\u8a08\u7b97\u7d50\u679c\u3068\u639b\u3051\u5408\u308f\u305b\u3066\u305d\u306e\u70b9\u306e\u30ab\u30e1\u30e9\u306e\u70b9\u3078\u306e\u7167\u5ea6\u304c\u308f\u304b\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\u30b7\u30a7\u30fc\u30c0\u30fc\u306e\u90e8\u5206\u306f\u4ee5\u4e0b\u306b\u7f6e\u3044\u3066\u3042\u308b\u306e\u3067\u3088\u304b\u3063\u305f\u3089\u53c2\u8003\u306b\u306a\u308c\u3070\u3002\nhttps://github.com/GrimoireGL/grimoirejs-forward-shading/blob/master/src/Shaders/ShadingChunk.sort\n\u307e\u305f\u3001\u3053\u308c\u306fgrimoire\u306e\u30ab\u30b9\u30bf\u30e0\u30de\u30c6\u30ea\u30a2\u30eb\u7528\u306e\u30d5\u30a1\u30a4\u30eb\u306a\u306e\u3067\u3001\u3053\u308c\u306b\u3064\u3044\u3066\u306f\u3044\u304b\u304c\u53c2\u8003\u306b\u306a\u308b\u3002\nGrimoire.js\u306e\u30ab\u30b9\u30bf\u30e0\u30de\u30c6\u30ea\u30a2\u30eb\n\u81ea\u4f5c\u306e\u30e9\u30a4\u30d6\u30e9\u30ea[Grimoire.js](https://grimoire.gl)\u3067PBR(Physically Based Rendering)\u3092\u5b9f\u88c5\u3057\u305f\u306e\u3067\u81ea\u5206\u306e\u7406\u89e3\u3082\u517c\u306d\u3066\u5c11\u3057\u307e\u3068\u3081\u307e\u3059\u3002\n\n\u3061\u306a\u307f\u306b\u3053\u306e\u30b7\u30a7\u30fc\u30c7\u30a3\u30f3\u30b0\u306f\u6b21\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u53d6\u308a\u8fbc\u307e\u308c\u307e\u3059\u3002\n\n![PBR\u3068Grimoire.js](https://i.gyazo.com/180f7e3a0ca2b5d67337f46ac3913a35.gif)\n\n\u5b9f\u969b\u306e[\u30b5\u30f3\u30d7\u30eb](https://kyasbal-1994.github.io/pbr-example/index.html)\n\n\u3053\u3053\u304b\u3089\u306f\u96e3\u3057\u3044\u304b\u3082\u3057\u308c\u306a\u3044\u5185\u5bb9\u3002\n\n# \u57fa\u790e\u7684\u306a\u7406\u8ad6\n\n## \u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u65b9\u7a0b\u5f0f\n\n\u3042\u308b\u70b9\u306b\u304a\u3051\u308b\u660e\u308b\u3055\u3092\u6c42\u3081\u308b\u3068\u3044\u3046\u3053\u3068\u306f`\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u65b9\u7a0b\u5f0f`\u3068\u547c\u3070\u308c\u308b\u4ee5\u4e0b\u306e\u5f0f\u3092\u3068\u304f\u3053\u3068\u305d\u306e\u3082\u306e\u3067\u3059\u3002\n\n```math\nL_o(x,\\omega_v) = L_e(x,\\omega_v) + \\int_\\Omega f_r(x,\\omega_i,\\omega_v)L_i(x,\\omega_l)(n \\cdot \\omega_i) d\\omega_i\n\\\\\nx:\u660e\u308b\u3055\u3092\u6c42\u3081\u305f\u3044\u70b9\\\\\n\\omega_v:x\u304b\u3089\u8996\u70b9\u3078\u306e\u65b9\u5411\u30d9\u30af\u30c8\u30eb\\\\\nn:\u70b9x\u306b\u304a\u3051\u308b\u6cd5\u7dda\u30d9\u30af\u30c8\u30eb\\\\\nfr:x\u306e\u70b9\u306b\u304a\u3051\u308b\u3001\\omega_i\u304b\u3089\u306e\u5149\u304c\\omega_v\u3078\u53cd\u5c04\u3059\u308b\u4fc2\u6570\u3092\u6c42\u3081\u308b\u5f0f(\u5f8c\u8ff0)\\\\\n\\Omega:\u534a\u7403\u4e0a\u306e\u7a4d\u5206\u9818\u57df\n```\n\n\u3053\u3046\u3057\u3066\u8a18\u8ff0\u3059\u308b\u3068\u3001\u975e\u5e38\u306b\u96e3\u89e3\u306b\u898b\u3048\u307e\u3059\u304c\u3001\u5206\u89e3\u3057\u3066\u8003\u3048\u307e\u3059\u3002\n\n### \u5de6\u8fba\n\n```math\nL_o(x,\\omega_v)\n```\n\n\u3053\u306e\u5f0f\u306b\u304a\u3051\u308b\u3001Lo\u306f\u70b9x\u306b\u304a\u3051\u308b\u03c9v\u65b9\u5411\u3078\u306e\u5149\u306e\u5f37\u3055\u3092\u8868\u3057\u307e\u3059\u3002\u3053\u308c\u306f\u3064\u307e\u308a\u3001\u3053\u306e\u70b9x\u306b\u304a\u3051\u308b\u30d4\u30af\u30bb\u30eb\u306e\u8272\u3068\u3044\u3046\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\n### Le\n\n```math\nL_e(x,\\omega_v)\n```\n\n\u3053\u306e\u90e8\u5206\u306f\u3001\u81ea\u5df1\u767a\u5149\u8272(Emission)\u306e\u90e8\u5206\u3067\u3059\u3002\n\u3042\u308b\u70b9\u304b\u3089\u76ee\u306b\u5165\u3063\u3066\u304f\u308b\u5149\u3068\u3044\u3046\u306e\u306f`\u305d\u306e\u70b9\u304c\u767a\u5149\u3057\u305f\u5149\u306e\u30a8\u30cd\u30eb\u30ae\u30fc`\u3068`\u305d\u306e\u70b9\u306b\u5165\u5c04\u3057\u305f\u5149\u306e\u4e2d\u3067\u3001\u76ee\u306b\u5411\u304b\u3063\u305f\u5149\u306e\u30a8\u30cd\u30eb\u30ae\u30fc\u306e\u5408\u8a08`\u306e\u548c\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u3053\u306eLe\u306e\u9805\u76ee\u306f\u3053\u306e\u3046\u3061\u306e **\u767a\u5149\u3057\u305f\u30a8\u30cd\u30eb\u30ae\u30fc\u306b\u3042\u305f\u308b\u90e8\u5206** \u3067\u3059\u3002\u3053\u308c\u81ea\u8eab\u304c\u706b\u306a\u3069\u306e\u767a\u5149\u3059\u308b\u3082\u306e\u3067\u306a\u3044\u9650\u308a\u306f\u901a\u5e38\u5fc5\u8981\u3042\u308a\u307e\u305b\u3093\u3002\n\n### \u7a4d\u5206\u306e\u90e8\u5206\n\n```math\n\\int_\\Omega f_r(x,\\omega_i,\\omega_v)L_i(x,\\omega_l)(n \\cdot \\omega_i) d\\omega_i\n```\n\n\u3053\u306e\u90e8\u5206\u306b\u304a\u3051\u308b\u3001\u03c9i\u306f\u7a4d\u5206\u5909\u6570\u3067\u3059\u304c\u3001x\u3092\u4e2d\u5fc3\u3068\u3059\u308b\u534a\u7403\u4e0a\u306e\u65b9\u5411\u30d9\u30af\u30c8\u30eb\u3067\u3059\u3002\n\n\u3053\u306e\u3001\u534a\u7403\u4e0a\u306e\u5404\u65b9\u5411\u304b\u3089\u3001x\u306b\u5411\u304b\u3046\u5149\u306e\u3046\u3061\u3001\u8996\u7dda\u65b9\u5411\u306b\u53cd\u5c04\u3055\u308c\u308b\u5149\u306e\u91cf\u3060\u3051\u3092\u8db3\u3057\u5408\u308f\u305b\u305f\u3089\u6c42\u3081\u305f\u3044\u3082\u306e\u306b\u306a\u308a\u305d\u3046\u3067\u306f\u306a\u3044\u3067\u3059\u304b?\n\n\u3053\u308c\u3092\u3084\u308b\u305f\u3081\u306e\u7a4d\u5206\u306a\u306e\u3067\u3059\u3002\n\n\u307e\u305a\u306f\u3001\u03a9\u4e0a\u306e\u3042\u308b\u65b9\u5411\u3001\u03c9i\u304b\u3089\u5149\u304c\u5165\u5c04\u3057\u305f\u3068\u3057\u3066\u3001\u305d\u306e\u3068\u304d\u306b\u76ee\u306e\u65b9\u5411\u3078\u5411\u304b\u3046\u30a8\u30cd\u30eb\u30ae\u30fc\u306b\u5bc4\u4e0e\u3059\u308b\u91cf\u3092\u8003\u3048\u308b\u3068\u3057\u307e\u3057\u3087\u3046\u3002\n\n\u3053\u306e\u6642\u3001\u03c9i\u304b\u3089x\u306b\u5165\u5c04\u3055\u308c\u308b\u5149\u306e\u91cf\u3092Li(x,\u03c9i)\u3067\u8868\u3057\u3066\u3044\u307e\u3059\u3002\u3053\u3053\u3067\u3001Lambart\u306e\u4f59\u5f26\u5247\u306b\u3088\u3063\u3066\u3001\u6cd5\u7dda\u3068\u03c9i\u3068\u306e\u50be\u304d\u304c\u591a\u3051\u308c\u3070\u5927\u304d\u3044\u307b\u3069\u5358\u4f4d\u9762\u7a4d\u5f53\u305f\u308a\u306eLi(x,\u03c9i)\u306b\u3088\u3063\u3066\u7167\u5c04\u3055\u308c\u308b\u30a8\u30cd\u30eb\u30ae\u30fc\u306f\u6e1b\u5c11\u3057\u3001\u3053\u308c\u306f\u6cd5\u7dda\u3068\u306e\u306a\u3059\u89d2\u3092\u03b8\u3068\u3057\u305f\u3068\u304d\u3001cos\u03b8\u3092\u639b\u3051\u5408\u308f\u305b\u308b\u3053\u3068\u306b\u3088\u308a\u3001\u5358\u4f4d\u9762\u7a4d\u5f53\u305f\u308a\u306e\u30a8\u30cd\u30eb\u30ae\u30fc\u304c\u3082\u3068\u307e\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u3064\u307e\u308a\u3001\u3053\u308c\u306f\u5358\u4f4d\u9762\u7a4d\u5f53\u305f\u308a\u306e\u5165\u5c04\u3057\u305f\u30a8\u30cd\u30eb\u30ae\u30fc\u306e\u5408\u8a08\u3067\u3059\u3002\n\u3053\u306e\u30a8\u30cd\u30eb\u30ae\u30fc\u304b\u3089\u7279\u5b9a\u306e\u65b9\u5411\u3078\u306e\u3042\u308b\u89d2\u5ea6\u5f53\u305f\u308a\u306e\u30a8\u30cd\u30eb\u30ae\u30fc\u306e\u6bd4\u304c\u6c42\u307e\u308c\u3070\u3001\u3053\u308c\u3092\u639b\u3051\u5408\u308f\u305b\u305f\u3082\u306e\u3092\u5408\u8a08\u3059\u308c\u3070\u3001\u4ed6\u306e\u3068\u3053\u308d\u304b\u3089\u3084\u3063\u3066\u304f\u308b\u5149\u306e\u53cd\u5c04\u306b\u3088\u3063\u3066\u5149\u304c\u76ee\u306b\u306f\u3044\u308b\u7387\u306f\u6c42\u307e\u308a\u307e\u3059\u3002\n\nfr\u306fx\u306e\u70b9\u304c\u3069\u306e\u3088\u3046\u306a\u6750\u8cea\u306b\u3088\u3063\u3066\u6210\u308a\u7acb\u3063\u3066\u3044\u308b\u304b\u306b\u3088\u3063\u3066\u6c7a\u307e\u308a\u307e\u3059\u3002\u3053\u306efr\u306fBRDF\u3068\u547c\u3070\u308c\u3001\u7269\u8cea\u306e\u7279\u6027\u304b\u3089\u5c0e\u304b\u308c\u308b\u5f0f\u3067\u3059\u3002\n\n## \u5b9f\u7528\u4e0a\u306eBRDF\n\n\u5b9f\u7528\u4e0a\u306f\u3001\u3053\u306eBRDF\u306f\u4ee5\u4e0b\u306eDiffuse BRDF,Specular BRDF\u306b\u3088\u3063\u3066\u5206\u5272\u3055\u308c\u8a08\u7b97\u3055\u308c\u307e\u3059\u3002Diffuse\u306f\u62e1\u6563\u5149\u3001Specular\u306f\u53cd\u5c04\u5149\u306b\u5bc4\u4e0e\u3059\u308bBRDF\u3067\u3059\u3002\n\n```math\nf_r = k_df_d + (1- k_d) f_s\n```\n\n\u3053\u3053\u3067\u3001kd\u306f0\u304b\u30891\u307e\u3067\u306e\u7bc4\u56f2\u3092\u53d6\u308a\u3001\u5c0f\u3055\u3051\u308c\u3070\u5c0f\u3055\u3044\u307b\u3069\u53cd\u5c04\u306b\u3088\u3063\u3066\u8272\u304c\u6c7a\u5b9a\u3059\u308b\u305f\u3081\u306b\u5bc4\u4e0e\u3059\u308b\u7387\u306f\u5927\u304d\u304f\u306a\u308a\u307e\u3059\u3002\n\nfs\u3068fd\u306b\u3064\u3044\u3066\u306f\u3001[Unreal Engine\u306e\u30b3\u30fc\u30b9\u30ce\u30fc\u30c8](http://project-asura.com/blog/archives/3124)\u3084\u3001[Coding Labs: Physically Based Rendering Cook-Torrance](http://www.codinglabs.net/article_physically_based_rendering_cook_torrance.aspx)\u304c\u3068\u3066\u3082\u53c2\u8003\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n\u5177\u4f53\u7684\u306a\u6570\u5f0f\u3092\u3053\u3053\u306b\u8a18\u8ff0\u3059\u308b\u306e\u306f\u3001\u3059\u3054\u304f\u9762\u5012\u306a\u306e\u3067\u4e0a\u8a18\u306e\u30ea\u30f3\u30af\u3092\u53c2\u7167\u3057\u3066\u6b32\u3057\u3044\u3067\u3059\u304c\u3001\u57fa\u672c\u7684\u306b\u306fUnreal Engine\u306e\u63a1\u7528\u3057\u3066\u3044\u308b\u901a\u308a\u306b\u5b9f\u88c5\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u3064\u307e\u308a\u3001\n\n* Diffuse BRDF\u30fb\u30fb\u30fbLambert\n* Specular BRDF\n    * Microfacet\u9805\u30fb\u30fb\u30fbGGX\n    * \u5e7e\u4f55\u6e1b\u8870\u9805\u30fb\u30fb\u30fbGGX\n    * Fresnel\u9805\u30fb\u30fb\u30fbSchlick\u8fd1\u4f3c\n\n\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n## \u5b9f\u88c5\u306e\u65b9\u91dd\n\nWebGL\u306eGLSL\u3067\u3001\u4efb\u610f\u500b\u306e\u30e9\u30a4\u30c8\u3092\u8868\u73fe\u3059\u308b\u306e\u306b\u306f\u69d8\u3005\u306a\u8ab2\u984c\u304c\u5b58\u5728\u3057\u307e\u3059\u3002\n\u7279\u306b\u3001\u30eb\u30fc\u30d7\u306e\u56de\u6570\u306b\u5909\u6570\u3092\u53d6\u308c\u306a\u3044\u306e\u304c\u5927\u304d\u306a\u8ab2\u984c\u3067\u3057\u3087\u3046\u3002\n\n\u62d9\u4f5c\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u306e\u5834\u5408\u3001\u4f9d\u5b58\u3059\u308b\u30de\u30af\u30ed\u304c\u52d5\u7684\u306b\u5909\u308f\u3063\u305f\u6642\u3060\u3051\u81ea\u52d5\u7684\u306b\u30b7\u30a7\u30fc\u30c0\u30fc\u3092\u30ea\u30b3\u30f3\u30d1\u30a4\u30eb\u3059\u308b\u6a5f\u80fd\u304c\u5165\u3063\u3066\u3044\u308b\u306e\u3067\u3001\u3053\u306e\u70b9\u306f\u3059\u3050\u306b\u5b9f\u88c5\u3067\u304d\u307e\u3059\u304c\u3001\u30e9\u30a4\u30c8\u306e\u6570\u304c\u5909\u52d5\u3057\u3059\u304e\u308b\u30b7\u30fc\u30f3\u306e\u5834\u5408\u3069\u3046\u3057\u3066\u3082\u91cd\u304f\u306a\u3063\u3066\u3057\u307e\u3046\u3068\u8a00\u3046\u6b20\u70b9\u306f\u5b58\u5728\u3057\u307e\u3059\u3002\n\n### \u30e9\u30a4\u30c8\u306e\u30e9\u30c7\u30a3\u30a2\u30f3\u30b9\u306e\u5408\u8a08\n\n\u30b7\u30a7\u30fc\u30c0\u30fc\u5168\u4f53\u3092\u8cbc\u308b\u3068\u3059\u3054\u304f\u5927\u304d\u304f\u306a\u3063\u3066\u3057\u307e\u3046\u306e\u3067\u3001\u9806\u756a\u306b\u89e3\u8aac\u3057\u307e\u3059\u3002\n\n```glsl\n  vec3 shading(vec3 baseColor,vec3 fragNormal,vec3 fragPosition,float roughness){\n    vec3 lightingColor = vec3(0);\n\n    #ifdef USE_DIR_LIGHT\n      lightingColor.rgb += directionalLight(baseColor,fragNormal,fragPosition,roughness);\n    #endif\n\n    #ifdef USE_POINT_LIGHT\n      lightingColor.rgb += pointLight(baseColor,fragNormal,fragPosition,roughness);\n    #endif\n\n    #ifdef USE_SPOT_LIGHT\n      lightingColor.rgb += spotLight(baseColor,fragNormal,fragPosition,roughness);\n    #endif\n\n    return lightingColor;\n  }\n```\n\n\u3053\u306e\u30e9\u30a4\u30c6\u30a3\u30f3\u30b0\u30ab\u30e9\u30fc\u306f\u4ee5\u4e0b\u306e\u5f0f\u306e\u90e8\u5206\u306b\u306a\u308a\u307e\u3059\u3002\n\n```math\n\\int_\\Omega f_r(x,\\omega_i,\\omega_v)L_i(x,\\omega_i)(n \\cdot \\omega_i) d\\omega_i\n```\n\n\u3057\u304b\u3057\u3001\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u306a\u8a08\u7b97\u3067\u306f\u7a4d\u5206\u8a08\u7b97\u306a\u3069\u3067\u304d\u306a\u3044\u306e\u3067\u3001\u30b7\u30fc\u30f3\u4e2d\u306b\u5b58\u5728\u3059\u308b\u30e9\u30a4\u30c8\u5168\u3066\u306b\u5bfe\u3057\u30661\u56de\u76ee\u306e\u53cd\u5c04\u3057\u304b\u8003\u616e\u3057\u306a\u3044\u3082\u306e\u3068\u3057\u307e\u3059\u3002\u3064\u307e\u308a\u3001\u30e9\u30a4\u30c8\u304b\u3089\u76f4\u63a5\u306e\u5165\u5c04\u4ee5\u5916\u306a\u3044\u3068\u8003\u3048\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8fd1\u4f3c\u3057\u307e\u3059\u3002\n\n```math\n\\sum^{N-1}_{k=0}f_r(x,\\omega_k,\\omega_v)L_i^{(k)}(x,\\omega_k)(n \\cdot \\omega_k)\n```\n\n\u3053\u3053\u3067\u3001\u03c9k\u306fk\u756a\u76ee\u306e\u30e9\u30a4\u30c8\u306e\u65b9\u5411\u3078\u306e\u65b9\u5411\u30d9\u30af\u30c8\u30eb(\u305f\u3060\u3057\u3001\u30c7\u30a3\u30ec\u30af\u30b7\u30e7\u30ca\u30eb\u30e9\u30a4\u30c8\u306e\u5834\u5408\u3001\u660e\u78ba\u306a\u4f4d\u7f6e\u306f\u5b58\u5728\u3057\u306a\u3044\u306e\u3067\u3001\u3053\u306e\u5834\u5408\u30c7\u30a3\u30ec\u30af\u30b7\u30e7\u30ca\u30eb\u30e9\u30a4\u30c8\u81ea\u8eab\u306e\u65b9\u5411)\u3001\u307e\u305f\u3001Li(k)\u306f\u3001k\u756a\u76ee\u306e\u30e9\u30a4\u30c8\u304c\u03c9k\u306e\u65b9\u5411\u304b\u3089x\u306b\u653e\u5c04\u3059\u308b\u653e\u5c04\u7167\u5ea6\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u4f8b\u3048\u3070\u3001\u30c7\u30a3\u30ec\u30af\u30b7\u30e7\u30ca\u30eb\u30e9\u30a4\u30c8\u3067\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u5b9f\u88c5\u306b\u306a\u308a\u307e\u3059\u3002\n\n```glsl\n  float lambert(vec3 lightDirection,vec3 surfaceNormal) {\n    return max(0.0, dot(lightDirection, surfaceNormal));\n  }\n\n  vec3 directionalLight(vec3 baseColor,vec3 fragNormal,vec3 fragPosition,float roughness){\n    vec3 result = vec3(0,0,0);\n    for(int i = 0; i < DIR_LIGHT_COUNT;i++){\n      vec3 lI = lambert(fragNormal,-_dLightDir[i]) * _dLightColor[i];\n      vec3 lColor = lI * PBR_BRDF(baseColor,-_dLightDir[i],normalize(_cameraPosition - fragPosition),fragNormal,roughness);\n      result += lColor;\n    }\n    return result;\n  }\n```\n\n\u4e0a\u8a18\u306e`PBR_BRDF`\u306f\u5f8c\u307b\u3069\u8aac\u660e\u3057\u307e\u3059\u304c\u3001\u4e0a\u306efr\u306b\u3042\u305f\u308a\u3001\u4ee5\u4e0b\u306e5\u3064\u3092\u53d7\u3051\u53d6\u3063\u3066\u3044\u307e\u3059\u3002\n\n* baseColor(\u30a2\u30eb\u30d9\u30c9)\n* **\u30e9\u30a4\u30c8\u3078\u306e\u65b9\u5411(\u03c9k)**\n* **\u30ab\u30e1\u30e9\u3078\u306e\u65b9\u5411(\u03c9v)**\n* **\u305d\u306e\u70b9\u306e\u6cd5\u7dda(n)**\n* \u30e9\u30d5\u30cd\u30b9\n\n\u592a\u5b57\u306e\u9805\u76ee\u4ee5\u5916\u306f\u6570\u5f0f\u306e\u65b9\u3067\u306f\u3001fr\u306e\u4e2d\u306b\u4f7f\u308f\u308c\u307e\u3059\u304c\u3001\u3053\u3053\u3067\u306fx\u306b\u5fdc\u3058\u3066\u7570\u306a\u308b\u305f\u3081\u4e00\u7dd2\u306b\u6e21\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u5b9f\u969b\u306ePBR\u306e\u5f0f\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n```glsl\n#ifndef DIFFUSE_BRDF\n    #define DIFFUSE_BRDF lambertBRDF\n\n    vec3 lambertBRDF(vec3 c,vec3 i,vec3 o,vec3 n,float roughness){\n      return c / PI;\n    }\n#endif\n\n#ifndef SPECULAR_BRDF\n\n    #define SPECULAR_BRDF cookTorranceBRDF\n\n    #ifndef CT_D\n      #define CT_D ctd_GGX_Distribution\n    #endif\n\n    #ifndef CT_F\n      #define CT_F ctf_Schlick\n    #endif\n\n    #ifndef CT_G\n      #define CT_G ctg_GGX_GeometryTerm\n    #endif\n\n    float ctd_GGX_Distribution(vec3 l,vec3 v,vec3 n,vec3 h,float roughness){\n      float alpha2 = pow(roughness,4.0);\n      float nh2 = pow(dot(n,h),2.0);\n      return alpha2/(PI*pow(nh2*(alpha2 - 1.0) + 1.0,2.0));\n    }\n\n    float ctg_GGX_GeometryTerm(vec3 l,vec3 v,vec3 n,vec3 h,float roughness){\n      float k = pow(roughness + 1.0,2.0)/8.0;\n      float ln = dot(l,n);\n      float vn = dot(v,n);\n      return (ln/(ln*(1.-k) + k))*(vn/(vn*(1.-k) + k));\n    }\n\n    float ctf_Schlick(vec3 l,vec3 v,vec3 n,vec3 h,float roughness){\n      float f0 = refractive;\n      float vh = dot(v,h);\n      return f0 + pow(1.0-vh,5.0) * (1.0 - f0);\n    }\n\n    vec3 cookTorranceBRDF(vec3 l,vec3 v,vec3 n,float r){\n      vec3 h = normalize(l+v);\n      return vec3(CT_D(l,v,n,h,r) * CT_F(l,v,n,h,r) * CT_G(l,v,n,h,r)/(4.0 * dot(l,n) * dot(v,n)));\n    }\n#endif\n\n#ifndef PBR_BRDF\n\n    #define PBR_BRDF pbrBRDF\n\n    vec3 pbrBRDF(vec3 c,vec3 i,vec3 o,vec3 n,float r){\n      float k0 = kCoeff;\n      return DIFFUSE_BRDF(c,i,o,n,r) * k0 + SPECULAR_BRDF(i,o,n,r) * (1.0 - k0);\n    }\n#endif\n```\n\n\u5f8c\u304b\u3089\u3001\u5f0f\u3092\u5165\u308c\u66ff\u3048\u3084\u3059\u3044\u3088\u3046\u306b\u3001\u30de\u30af\u30ed\u304c\u304b\u306a\u308a\u4f7f\u308f\u308c\u3066\u3044\u3066\u8aad\u307f\u306b\u304f\u3044\u3067\u3059\u304c\u3001UE\u306e\u5f0f\u3092\u305d\u306e\u307e\u307e\u6301\u3063\u3066\u304d\u305f\u3088\u3046\u306a\u5f62\u3068\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n\u3042\u3068\u306f\u3001\u30dd\u30a4\u30f3\u30c8\u30e9\u30a4\u30c8\u3084\u3001\u30b9\u30dd\u30c3\u30c8\u30e9\u30a4\u30c8\u3067\u3082\u3001\u540c\u3058BRDF\u304c\u4f7f\u3048\u308b\u306e\u3067\u3001\u305d\u306e\u624b\u524d\u307e\u3067\u3092\u5206\u3051\u3066\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u66f8\u3044\u3066\u3042\u3052\u308c\u3070\u826f\u3044\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\n```glsl\n#ifdef USE_POINT_LIGHT\n  vec3 pointLight(vec3 baseColor,vec3 fragNormal,vec3 fragPosition,float roughness){\n    vec3 result = vec3(0,0,0);\n    for(int i = 0; i < POINT_LIGHT_COUNT;i++){\n      vec3 l2p = _pLightPosition[i] - fragPosition;\n      float d = length(l2p);\n      vec2 param = _pLightParam[i];\n      float atten = max(0.,1.0-d/param.x)/(1.0 + param.y*param.y*d);\n      l2p = normalize(l2p);\n      vec3 lI = lambert(fragNormal,l2p)* _pLightColor[i] * atten;\n      vec3 lColor = lI  * PBR_BRDF(baseColor,l2p,normalize(_cameraPosition - fragPosition),fragNormal,roughness);\n      result += lColor ;\n    }\n    return result;\n  }\n#endif\n#ifdef USE_SPOT_LIGHT\n  vec3 spotLight(vec3 baseColor,vec3 fragNormal,vec3 fragPosition,float roughness){\n    vec3 result = vec3(0);\n    for(int i = 0; i < SPOT_LIGHT_COUNT; i++){\n      float innerConeAngle = _sLightParam[i].x;\n      float outerConeAngle = _sLightParam[i].y;\n      float outCos=cos(outerConeAngle);\n      float innCos=cos(innerConeAngle);\n\n      vec3 p2l = _sLightPosition[i] - fragPosition;\n      float d = length(p2l);\n      p2l=p2l/d;\n      float c = dot(-p2l,normalize(_sLightDir[i]));\n      float decay = _sLightParam[i].z;//\u6e1b\u8870\u4fc2\u6570\n      decay = 1.;\n      float angleDecay = decay;\n      //\n      float distDecayCoefficient = 1.0 / (d * d);\n      float angleDecayCoefficient = pow(clamp((c-outCos)/(innCos-outCos),0.0,1.0),angleDecay);\n      //\n      vec3 lI = lambert(p2l,fragNormal)*_sLightColor[i]*angleDecayCoefficient*distDecayCoefficient;\n      vec3 lColor = lI * PBR_BRDF(baseColor,p2l,normalize(_cameraPosition - fragPosition),fragNormal,roughness);\n      result += lColor;\n    }\n    return result;\n  }\n#endif\n```\n\n\u3059\u3054\u304f\u308f\u304b\u308a\u3065\u3089\u3044\u3067\u3059\u304c\u3001\u5927\u4e8b\u306a\u306e\u306flI\u3068\u3057\u3066\u305d\u306e\u5834\u6240\u306b\u5165\u5c04\u3059\u308b\u5149\u306e\u30e9\u30c7\u30a3\u30a2\u30f3\u30b9\u3092\u6c42\u3081\u3001\u305d\u306e\u307e\u307eBRDF\u3068\u306e\u8a08\u7b97\u7d50\u679c\u3068\u639b\u3051\u5408\u308f\u305b\u3066\u305d\u306e\u70b9\u306e\u30ab\u30e1\u30e9\u306e\u70b9\u3078\u306e\u7167\u5ea6\u304c\u308f\u304b\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u30b7\u30a7\u30fc\u30c0\u30fc\u306e\u90e8\u5206\u306f\u4ee5\u4e0b\u306b\u7f6e\u3044\u3066\u3042\u308b\u306e\u3067\u3088\u304b\u3063\u305f\u3089\u53c2\u8003\u306b\u306a\u308c\u3070\u3002\n\nhttps://github.com/GrimoireGL/grimoirejs-forward-shading/blob/master/src/Shaders/ShadingChunk.sort\n\n\u307e\u305f\u3001\u3053\u308c\u306fgrimoire\u306e\u30ab\u30b9\u30bf\u30e0\u30de\u30c6\u30ea\u30a2\u30eb\u7528\u306e\u30d5\u30a1\u30a4\u30eb\u306a\u306e\u3067\u3001\u3053\u308c\u306b\u3064\u3044\u3066\u306f\u3044\u304b\u304c\u53c2\u8003\u306b\u306a\u308b\u3002\n\n[Grimoire.js\u306e\u30ab\u30b9\u30bf\u30e0\u30de\u30c6\u30ea\u30a2\u30eb](https://grimoire.gl/guide/sort.html)\n\n\n"}