{"context": "Linux\u306e\u30d6\u30ed\u30c3\u30af\u5c64\u306b\u3064\u3044\u3066\u8abf\u3079\u305f\u3002\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3067\u4f5c\u3063\u305fbio\u69cb\u9020\u4f53\u3092\u30d6\u30ed\u30c3\u30af\u306e\u30ad\u30e5\u30fc\u306b\u3064\u306a\u3052\u308b\u90e8\u5206\u3092\u8aad\u3093\u3060\u3002\n\n\u30ab\u30fc\u30cd\u30eb\u30d0\u30fc\u30b8\u30e7\u30f3\nv4.4.0\n\next4\u306e\u30d0\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\nblk_sq_make_request()\u3042\u305f\u308a\u304c\u66f8\u304d\u8fbc\u307f\u6642\u306b\u901a\u308b\u95a2\u6570\u306e\u3088\u3046\u306a\u306e\u3067\u3001\u305d\u3053\u307e\u3067\u306e\u30d0\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\u3092\u307f\u305f\u3002kjournald2\u306fext4\u306e\u30ed\u30b0\u66f8\u304d\u8fbc\u307f\u306e\u305f\u3081\u306e\u30b9\u30ec\u30c3\u30c9\u3089\u3057\u3044\u3002\n>>> bt\n#0  blk_sq_make_request (q=0xffff880233a458c0, bio=0xffff8802330a8a00) at block/blk-mq.c:1340\n#1  0xffffffff813f30b3 in generic_make_request (bio=0xffff8802330a8a00) at block/blk-core.c:2065\n#2  0xffffffff813f3206 in submit_bio (rw=<optimized out>, bio=0xffff8802330a8a00) at block/blk-core.c:2128\n#3  0xffffffff81228daf in submit_bh_wbc (rw=866408640, bh=0xffff8802330a8a00, bio_flags=1, wbc=0x0 <irq_stack_union>) at fs/buffer.c:3045\n#4  0xffffffff81228e12 in submit_bh (rw=<optimized out>, bh=<optimized out>) at fs/buffer.c:3057\n#5  0xffffffff812c2de9 in jbd2_journal_commit_transaction (journal=0xffff8802362ee000) at fs/jbd2/commit.c:740\n#6  0xffffffff812c79eb in kjournald2 (arg=0xffff8802362ee000) at fs/jbd2/journal.c:223\n#7  0xffffffff81095e39 in kthread (_create=0xffff880233111f40) at kernel/kthread.c:209\n#8  0xffffffff818293cf in ret_from_fork () at arch/x86/entry/entry_64.S:468\n#9  0x0000000000000000 in ?? ()\n\n\u3082\u3046\u4e00\u3064\u3001dd\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u3067oflag=direct,sync\u3068\u3059\u308b\u3068\u3001\u6b21\u306e\u3088\u3046\u306b\u306a\u3063\u305f\u3002submit_bio()\u304b\u3089\u306f\u304a\u306a\u3058\u3002\n>>> bt\n#0  blk_sq_make_request (q=0xffff880233a458c0, bio=0xffff880233053000) at block/blk-mq.c:1340\n#1  0xffffffff813f30b3 in generic_make_request (bio=0xffff880233053000) at block/blk-core.c:2065\n#2  0xffffffff813f3206 in submit_bio (rw=<optimized out>, bio=0xffff880233053000) at block/blk-core.c:2128\n#3  0xffffffff81230a91 in dio_bio_submit (sdio=<optimized out>, dio=<optimized out>) at fs/direct-io.c:409\n#4  do_blockdev_direct_IO (iocb=<optimized out>, inode=0xffff880233053000, bdev=<optimized out>, iter=<optimized out>, offset=<optimized out>, get_block=<optimized out>, end_io=0x0 <irq_stack_union>, submit_io=<optimized out>, flags=3) at fs/direct-io.c:1282\n#5  0xffffffff81231473 in __blockdev_direct_IO (iocb=<optimized out>, inode=<optimized out>, bdev=<optimized out>, iter=<optimized out>, offset=<optimized out>, get_block=<optimized out>, end_io=0x0 <irq_stack_union>, submit_io=<optimized out>, flags=<optimized out>) at fs/direct-io.c:1341\n#6  0xffffffff812b5494 in blockdev_direct_IO (get_block=<optimized out>, offset=<optimized out>, iter=<optimized out>, inode=<optimized out>, iocb=<optimized out>) at include/linux/fs.h:2697\n#7  ext4_ind_direct_IO (iocb=0xffff880233a458c0, iter=0xffff880233053000, offset=0) at fs/ext4/indirect.c:709\n#8  0xffffffff81277130 in ext4_ext_direct_IO (offset=<optimized out>, iter=<optimized out>, iocb=<optimized out>) at fs/ext4/inode.c:3131\n#9  ext4_direct_IO (iocb=0xffff880234e33e68, iter=<optimized out>, offset=0) at fs/ext4/inode.c:3281\n#10 0xffffffff8117b4fa in generic_file_direct_write (iocb=0xffff880234e33e68, from=0xffff880234e33e90, pos=0) at mm/filemap.c:2437\n#11 0xffffffff8117b670 in __generic_file_write_iter (iocb=0xffff880234e33e68, from=0xffff880234e33e90) at mm/filemap.c:2617\n#12 0xffffffff812717cd in ext4_file_write_iter (iocb=0xffff880234e33e68, from=0xffff880234e33e90) at fs/ext4/file.c:171\n#13 0xffffffff811f2c4a in new_sync_write (ppos=<optimized out>, len=<optimized out>, buf=<optimized out>, filp=<optimized out>) at fs/read_write.c:478\n#14 __vfs_write (file=0xffff880235687100, p=<optimized out>, count=<optimized out>, pos=0xffff880234e33f20) at fs/read_write.c:491\n#15 0xffffffff811f3509 in vfs_write (file=0xffff880235687100, buf=0x2225000 \"\", count=<optimized out>, pos=0xffff880234e33f20) at fs/read_write.c:538\n#16 0xffffffff811f4106 in SYSC_write (count=<optimized out>, buf=<optimized out>, fd=<optimized out>) at fs/read_write.c:585\n#17 SyS_write (fd=<optimized out>, buf=35803136, count=1024) at fs/read_write.c:577\n#18 0xffffffff81829036 in entry_SYSCALL_64_fastpath () at arch/x86/entry/entry_64.S:185\n#19 0x00007ffc929c8a88 in ?? ()\n#20 0x0000000000000000 in ?? ()\n\n\nbio\u304c\u30c7\u30d0\u30a4\u30b9\u306e\u30ad\u30e5\u30fc\u306b\u7e4b\u304c\u308b\u307e\u3067\nbio\u3068\u306f\u30c7\u30d0\u30a4\u30b9\u4e0a\u306e\u66f8\u304d\u8fbc\u307f\u4f4d\u7f6e\uff08\u30c7\u30d0\u30a4\u30b9\u3068\u30bb\u30af\u30bf\u756a\u53f7\u306a\u3069\uff09\u3001\u30e1\u30e2\u30ea\u4e0a\u306e\u4f4d\u7f6e(io_vec)\u3092\u793a\u3057\u305f\u69cb\u9020\u4f53\u3060\u3002\nsubmit_bio()\u306f\u5b9f\u8ceageneric_make_request()\u306e\u30e9\u30c3\u30d1\u30fc\u306b\u306a\u3063\u3066\u3044\u308b\u3002\u6b21\u306e\u7b87\u6240\u304c\u30e1\u30a4\u30f3\u306e\u51e6\u7406\u3067\u3001q->make_request_fn()\u3067\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u30d6\u30ed\u30c3\u30af\u30c7\u30d0\u30a4\u30b9\u306b\u6e21\u3059\u3002\n    bio_list_init(&bio_list_on_stack);\n    current->bio_list = &bio_list_on_stack;\n    do {\n        struct request_queue *q = bdev_get_queue(bio->bi_bdev);\n\n        if (likely(blk_queue_enter(q, __GFP_DIRECT_RECLAIM) == 0)) {\n\n            ret = q->make_request_fn(q, bio);\n\n            blk_queue_exit(q);\n\n            bio = bio_list_pop(current->bio_list);\n        } else {\n            struct bio *bio_next = bio_list_pop(current->bio_list);\n\n            bio_io_error(bio);\n            bio = bio_next;\n        }\n    } while (bio);\n    current->bio_list = NULL; /* deactivate */\n\n\u30d0\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\u3067\u306f\u3001blk_sq_make_request()\u304c\u547c\u3070\u308c\u3066\u3044\u308b\u304c\u3001\u3053\u308c\u306fblk_mq_init_queue(), blk_init_allocated_queue()\u304b\u3089\u767b\u9332\u3055\u308c\u3066\u3044\u308b\u3002\n\nblk-mq\u3067\u306fIO\u30b9\u30b1\u30b8\u30e5\u30fc\u30e9\u3092\u4f7f\u308f\u306a\u3044\nIO\u30b9\u30b1\u30b8\u30e5\u30fc\u30e9\u3001\u547c\u3070\u308c\u306a\u3044\u306a\u3041\u3068\u601d\u3063\u3066\u3044\u305f\u3089\u3001\n## cat /sys/block/vda/queue/scheduler\nnone\n\n\u3069\u3046\u3084\u3089blk-mq\u306a\u308b\u4ed5\u7d44\u307f\u3067\u306fIO\u30b9\u30b1\u30b8\u30e5\u30fc\u30e9\u306f\u30d0\u30a4\u30d1\u30b9\u3055\u308c\u308b\u3089\u3057\u3044\n\nSCSI\u30c7\u30a3\u30b9\u30af(sdX)\n\u66f8\u7c4d\u306b\u3088\u308b\u3068\u3001\u4e00\u822c\u7684\u306b\u306f__make_request()\u304c\u3088\u3070\u308c\u308b\u3089\u3057\u3044\u304c\u3001\u4eca\u306e\u30ab\u30fc\u30cd\u30eb\u3067\u306f\u5225\u306e\u95a2\u6570\u307f\u305f\u3044\u3002\nSCSI\u30c7\u30d0\u30a4\u30b9\u3067\u306fblk_init_queue()\u304b\u3089blk_queue_bio()\u304c\u767b\u9332\u3055\u308c\u3066\u3044\u308b\u3002\nscsi\u30c7\u30d0\u30a4\u30b9\u304b\u3089\u306e\u547c\u3073\u51fa\u3057\u306fscsi_alloc_sdev()\u3042\u305f\u308a\u304b\u3089\u3002\u3064\u307e\u308a\u3001blk_queue_bio()\u306f__make_request()\u76f8\u5f53\u306a\u306e\u3060\u308d\u3046\u3002\u3053\u306e\u8fba\u308a\u306fblk-mq\u95a2\u9023\u3068\u5408\u308f\u305b\u3066\u3001\u6b21\u56de\u306b\u898b\u305f\u3044\u3002\nLinux\u306e\u30d6\u30ed\u30c3\u30af\u5c64\u306b\u3064\u3044\u3066\u8abf\u3079\u305f\u3002\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3067\u4f5c\u3063\u305fbio\u69cb\u9020\u4f53\u3092\u30d6\u30ed\u30c3\u30af\u306e\u30ad\u30e5\u30fc\u306b\u3064\u306a\u3052\u308b\u90e8\u5206\u3092\u8aad\u3093\u3060\u3002\n\n## \u30ab\u30fc\u30cd\u30eb\u30d0\u30fc\u30b8\u30e7\u30f3\n\nv4.4.0\n\n## ext4\u306e\u30d0\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\n\n`blk_sq_make_request()`\u3042\u305f\u308a\u304c\u66f8\u304d\u8fbc\u307f\u6642\u306b\u901a\u308b\u95a2\u6570\u306e\u3088\u3046\u306a\u306e\u3067\u3001\u305d\u3053\u307e\u3067\u306e\u30d0\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\u3092\u307f\u305f\u3002kjournald2\u306fext4\u306e\u30ed\u30b0\u66f8\u304d\u8fbc\u307f\u306e\u305f\u3081\u306e\u30b9\u30ec\u30c3\u30c9\u3089\u3057\u3044\u3002\n\n~~~\n>>> bt\n#0  blk_sq_make_request (q=0xffff880233a458c0, bio=0xffff8802330a8a00) at block/blk-mq.c:1340\n#1  0xffffffff813f30b3 in generic_make_request (bio=0xffff8802330a8a00) at block/blk-core.c:2065\n#2  0xffffffff813f3206 in submit_bio (rw=<optimized out>, bio=0xffff8802330a8a00) at block/blk-core.c:2128\n#3  0xffffffff81228daf in submit_bh_wbc (rw=866408640, bh=0xffff8802330a8a00, bio_flags=1, wbc=0x0 <irq_stack_union>) at fs/buffer.c:3045\n#4  0xffffffff81228e12 in submit_bh (rw=<optimized out>, bh=<optimized out>) at fs/buffer.c:3057\n#5  0xffffffff812c2de9 in jbd2_journal_commit_transaction (journal=0xffff8802362ee000) at fs/jbd2/commit.c:740\n#6  0xffffffff812c79eb in kjournald2 (arg=0xffff8802362ee000) at fs/jbd2/journal.c:223\n#7  0xffffffff81095e39 in kthread (_create=0xffff880233111f40) at kernel/kthread.c:209\n#8  0xffffffff818293cf in ret_from_fork () at arch/x86/entry/entry_64.S:468\n#9  0x0000000000000000 in ?? ()\n~~~\n\n\u3082\u3046\u4e00\u3064\u3001dd\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u3067`oflag=direct,sync`\u3068\u3059\u308b\u3068\u3001\u6b21\u306e\u3088\u3046\u306b\u306a\u3063\u305f\u3002`submit_bio()`\u304b\u3089\u306f\u304a\u306a\u3058\u3002\n\n~~~\n>>> bt\n#0  blk_sq_make_request (q=0xffff880233a458c0, bio=0xffff880233053000) at block/blk-mq.c:1340\n#1  0xffffffff813f30b3 in generic_make_request (bio=0xffff880233053000) at block/blk-core.c:2065\n#2  0xffffffff813f3206 in submit_bio (rw=<optimized out>, bio=0xffff880233053000) at block/blk-core.c:2128\n#3  0xffffffff81230a91 in dio_bio_submit (sdio=<optimized out>, dio=<optimized out>) at fs/direct-io.c:409\n#4  do_blockdev_direct_IO (iocb=<optimized out>, inode=0xffff880233053000, bdev=<optimized out>, iter=<optimized out>, offset=<optimized out>, get_block=<optimized out>, end_io=0x0 <irq_stack_union>, submit_io=<optimized out>, flags=3) at fs/direct-io.c:1282\n#5  0xffffffff81231473 in __blockdev_direct_IO (iocb=<optimized out>, inode=<optimized out>, bdev=<optimized out>, iter=<optimized out>, offset=<optimized out>, get_block=<optimized out>, end_io=0x0 <irq_stack_union>, submit_io=<optimized out>, flags=<optimized out>) at fs/direct-io.c:1341\n#6  0xffffffff812b5494 in blockdev_direct_IO (get_block=<optimized out>, offset=<optimized out>, iter=<optimized out>, inode=<optimized out>, iocb=<optimized out>) at include/linux/fs.h:2697\n#7  ext4_ind_direct_IO (iocb=0xffff880233a458c0, iter=0xffff880233053000, offset=0) at fs/ext4/indirect.c:709\n#8  0xffffffff81277130 in ext4_ext_direct_IO (offset=<optimized out>, iter=<optimized out>, iocb=<optimized out>) at fs/ext4/inode.c:3131\n#9  ext4_direct_IO (iocb=0xffff880234e33e68, iter=<optimized out>, offset=0) at fs/ext4/inode.c:3281\n#10 0xffffffff8117b4fa in generic_file_direct_write (iocb=0xffff880234e33e68, from=0xffff880234e33e90, pos=0) at mm/filemap.c:2437\n#11 0xffffffff8117b670 in __generic_file_write_iter (iocb=0xffff880234e33e68, from=0xffff880234e33e90) at mm/filemap.c:2617\n#12 0xffffffff812717cd in ext4_file_write_iter (iocb=0xffff880234e33e68, from=0xffff880234e33e90) at fs/ext4/file.c:171\n#13 0xffffffff811f2c4a in new_sync_write (ppos=<optimized out>, len=<optimized out>, buf=<optimized out>, filp=<optimized out>) at fs/read_write.c:478\n#14 __vfs_write (file=0xffff880235687100, p=<optimized out>, count=<optimized out>, pos=0xffff880234e33f20) at fs/read_write.c:491\n#15 0xffffffff811f3509 in vfs_write (file=0xffff880235687100, buf=0x2225000 \"\", count=<optimized out>, pos=0xffff880234e33f20) at fs/read_write.c:538\n#16 0xffffffff811f4106 in SYSC_write (count=<optimized out>, buf=<optimized out>, fd=<optimized out>) at fs/read_write.c:585\n#17 SyS_write (fd=<optimized out>, buf=35803136, count=1024) at fs/read_write.c:577\n#18 0xffffffff81829036 in entry_SYSCALL_64_fastpath () at arch/x86/entry/entry_64.S:185\n#19 0x00007ffc929c8a88 in ?? ()\n#20 0x0000000000000000 in ?? ()\n~~~\n\n## bio\u304c\u30c7\u30d0\u30a4\u30b9\u306e\u30ad\u30e5\u30fc\u306b\u7e4b\u304c\u308b\u307e\u3067\n\nbio\u3068\u306f\u30c7\u30d0\u30a4\u30b9\u4e0a\u306e\u66f8\u304d\u8fbc\u307f\u4f4d\u7f6e\uff08\u30c7\u30d0\u30a4\u30b9\u3068\u30bb\u30af\u30bf\u756a\u53f7\u306a\u3069\uff09\u3001\u30e1\u30e2\u30ea\u4e0a\u306e\u4f4d\u7f6e(io_vec)\u3092\u793a\u3057\u305f\u69cb\u9020\u4f53\u3060\u3002\n`submit_bio()`\u306f\u5b9f\u8cea`generic_make_request()`\u306e\u30e9\u30c3\u30d1\u30fc\u306b\u306a\u3063\u3066\u3044\u308b\u3002\u6b21\u306e\u7b87\u6240\u304c\u30e1\u30a4\u30f3\u306e\u51e6\u7406\u3067\u3001`q->make_request_fn()`\u3067\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u30d6\u30ed\u30c3\u30af\u30c7\u30d0\u30a4\u30b9\u306b\u6e21\u3059\u3002\n\n~~~\n\tbio_list_init(&bio_list_on_stack);\n\tcurrent->bio_list = &bio_list_on_stack;\n\tdo {\n\t\tstruct request_queue *q = bdev_get_queue(bio->bi_bdev);\n\n\t\tif (likely(blk_queue_enter(q, __GFP_DIRECT_RECLAIM) == 0)) {\n\n\t\t\tret = q->make_request_fn(q, bio);\n\n\t\t\tblk_queue_exit(q);\n\n\t\t\tbio = bio_list_pop(current->bio_list);\n\t\t} else {\n\t\t\tstruct bio *bio_next = bio_list_pop(current->bio_list);\n\n\t\t\tbio_io_error(bio);\n\t\t\tbio = bio_next;\n\t\t}\n\t} while (bio);\n\tcurrent->bio_list = NULL; /* deactivate */\n~~~\n\n\u30d0\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\u3067\u306f\u3001`blk_sq_make_request()`\u304c\u547c\u3070\u308c\u3066\u3044\u308b\u304c\u3001\u3053\u308c\u306f`blk_mq_init_queue()`, `blk_init_allocated_queue()`\u304b\u3089\u767b\u9332\u3055\u308c\u3066\u3044\u308b\u3002\n\n## blk-mq\u3067\u306fIO\u30b9\u30b1\u30b8\u30e5\u30fc\u30e9\u3092\u4f7f\u308f\u306a\u3044\n\nIO\u30b9\u30b1\u30b8\u30e5\u30fc\u30e9\u3001\u547c\u3070\u308c\u306a\u3044\u306a\u3041\u3068\u601d\u3063\u3066\u3044\u305f\u3089\u3001\n\n~~~\n## cat /sys/block/vda/queue/scheduler\nnone\n~~~\n\n\u3069\u3046\u3084\u3089blk-mq\u306a\u308b\u4ed5\u7d44\u307f\u3067\u306f[IO\u30b9\u30b1\u30b8\u30e5\u30fc\u30e9\u306f\u30d0\u30a4\u30d1\u30b9\u3055\u308c\u308b\u3089\u3057\u3044](https://www.thomas-krenn.com/en/wiki/Linux_Multi-Queue_Block_IO_Queueing_Mechanism_%28blk-mq%29)\n\n## SCSI\u30c7\u30a3\u30b9\u30af(sdX)\n\n\u66f8\u7c4d\u306b\u3088\u308b\u3068\u3001\u4e00\u822c\u7684\u306b\u306f`__make_request()`\u304c\u3088\u3070\u308c\u308b\u3089\u3057\u3044\u304c\u3001\u4eca\u306e\u30ab\u30fc\u30cd\u30eb\u3067\u306f\u5225\u306e\u95a2\u6570\u307f\u305f\u3044\u3002\nSCSI\u30c7\u30d0\u30a4\u30b9\u3067\u306f`blk_init_queue()`\u304b\u3089`blk_queue_bio()`\u304c\u767b\u9332\u3055\u308c\u3066\u3044\u308b\u3002\nscsi\u30c7\u30d0\u30a4\u30b9\u304b\u3089\u306e\u547c\u3073\u51fa\u3057\u306f`scsi_alloc_sdev()`\u3042\u305f\u308a\u304b\u3089\u3002\u3064\u307e\u308a\u3001`blk_queue_bio()`\u306f`__make_request()`\u76f8\u5f53\u306a\u306e\u3060\u308d\u3046\u3002\u3053\u306e\u8fba\u308a\u306fblk-mq\u95a2\u9023\u3068\u5408\u308f\u305b\u3066\u3001\u6b21\u56de\u306b\u898b\u305f\u3044\u3002\n", "tags": ["Linux", "kernel"]}