{"context": "\n\n(\u03a6\u03c9\u03a6)\u4eba\u5de5\u77e5\u80fdAPI\u304c\u516c\u958b\u3055\u308c\u305f\u305e\uff01\n\u30a2\u30a4\u30c9\u30eb\u30de\u30b9\u30bf\u30fc \u30b7\u30f3\u30c7\u30ec\u30e9\u30ac\u30fc\u30eb\u30ba\u306e\u524d\u5ddd\u307f\u304f\u3053\u3068\u901a\u79f0\u307f\u304f\u306b\u3083\u3093\u3001\u304b\u308f\u3044\u3044\u3067\u3059\u3088\u306d\n\u307f\u304f\u306b\u3083\u3093\u3068\u306b\u3083\u3093\u306b\u3083\u3093\u3057\u305f\u3044\n\u307f\u304f\u306b\u3083\u3093\u3068\u306b\u3083\u3093\u306b\u3083\u3093\u3057\u305f\u3044\n\u305d\u3093\u306a\u6c17\u6301\u3061\u3067\u3044\u305f\u3068\u3053\u308d\u3001\u682a\u5f0f\u4f1a\u793e\u30e6\u30fc\u30b6\u30fc\u30ed\u30fc\u30ab\u30eb\u3055\u3093\u304c\u4eba\u5de5\u77e5\u80fd\u306eAPI\u3092\u516c\u958b\u3057\u307e\u3057\u305f\u3002\n\u30e6\u30fc\u30b6\u30fc\u3068\u81ea\u52d5\u3067\u5bfe\u8a71\u3059\u308b\u4eba\u5de5\u77e5\u80fd\u30dc\u30c3\u30c8API\n\u3093\u2026\uff1f\uff1f\n\n\u307f\u304f\u306b\u3083\u3093\u3060\u2026\n\u3053\u308c\u306f\u307f\u304f\u306b\u3083\u3093\u304c\u5275\u308c\u308b\u305e\u2026\u3063\uff01\n\n(\u03a6\u03c9\u03a6)\u6210\u679c\u7269\n\u307f\u304f\u306b\u3083\u3093Bot\uff20\u4eba\u5de5\u77e5\u80fd\n\u5148\u77403000\u4eba\u306eAPI\u52df\u96c6\u306b\u5165\u308c\u305f\u306e\u3067\u3001\u3055\u3063\u305d\u304fGoogle Apps Script\u3067Twitter Bot\u3092\u4f5c\u3063\u3066\u307f\u307e\u3057\u305f\u3002\n\n\n(\u03a6\u03c9\u03a6)\u6a5f\u80fd\u6982\u8981\n\uff11\uff0e10\u5206\u3054\u3068\u306b\u30e1\u30f3\u30b7\u30e7\u30f3\u3092\u53d6\u5f97\n\uff12\uff0e\u8fd4\u4fe1\u3092\u30e6\u30fc\u30b6API\u3067\u751f\u6210\n\uff13\uff0e\u30cb\u30c3\u30af\u30cd\u30fc\u30e0\u3092API\u3067\u53d6\u5f97\uff08\u203bTwitter\u306e\u540d\u524d\u30d9\u30fc\u30b9\u306a\u306e\u3067\u53d6\u308c\u306a\u3044\u53ef\u80fd\u6027\u5927\uff09\n\uff14\uff0e\u307f\u304f\u306b\u3083\u3093\u8a9e\u306b\u30b3\u30f3\u30d1\u30a4\u30eb\n\uff15\uff0e\u30e1\u30f3\u30b7\u30e7\u30f3\u306b\u8fd4\u4fe1\u3057\u3066\u304f\u308c\u308b\n\n(\u03a6\u03c9\u03a6)\u4f7f\u7528\u3057\u305fAPI\n\n\u81ea\u52d5\u4f1a\u8a71API\n\u9001\u3089\u308c\u305f\u30e1\u30c3\u30bb\u30fc\u30b8\u3078\u306e\u8fd4\u4fe1\u3092\u53d6\u5f97\u3067\u304d\u307e\u3059\u3002\nLINE\u306e\u308a\u3093\u306a\u3061\u3083\u3093\u306e\u30a4\u30e1\u30fc\u30b8\u3067\u3059\u3002\n\n\u30ad\u30e3\u30e9\u30af\u30bf\u30fc\u4f1a\u8a71\u5909\u63dbAPI\n\u30e1\u30c3\u30bb\u30fc\u30b8\u306e\u53e3\u8abf\u3092\u5909\u63db\u3057\u3066\u53d6\u5f97\u3067\u304d\u307e\u3059\u3002\n\u73fe\u5728\u306f\u300c\u732b\u300d\u300c\u72ac\u300d\u300c\u8001\u4eba\u300d\u306b\u5bfe\u5fdc\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u6c0f\u540d\u81ea\u52d5\u8b58\u5225API\n\u540d\u524d\u304b\u3089\u300c\u59d3\u300d\u300c\u540d\u300d\u300c\u59d3(\u3088\u307f)\u300d\u300c\u540d(\u3088\u307f)\u300d\u300c\u6027\u5225\u300d\u300c\u30cb\u30c3\u30af\u30cd\u30fc\u30e0\u4e00\u89a7\u300d\u304c\u53d6\u5f97\u3067\u304d\u307e\u3059\u3002\n\n(\u03a6\u03c9\u03a6)\u514d\u8cac\nTwitter API\u3084\u30e6\u30fc\u30b6\u30fc\u30ed\u30fc\u30ab\u30eb\u306eAPI\u5236\u9650\u306f\u610f\u8b58\u3057\u3066\u3044\u307e\u305b\u3093\n\u30bd\u30fc\u30b9\u3092\u305d\u306e\u307e\u307e\u4f7f\u7528\u3059\u308b\u969b\u306f\u3054\u6ce8\u610f\u304f\u3060\u3055\u3044\n\n(\u03a6\u03c9\u03a6)\u30bd\u30fc\u30b9\n\nMikunyanBot.gs\n// Twitter\u306e\u8a8d\u8a3c\u30ad\u30fc\nvar CONSUMER_KEY = '{Twitter\u306eCONSUMER KEY}';\nvar CONSUMER_SECRET = '{Twitter\u306eCONSUMER SECRET}';\n\nvar USERLOCAL_API_KEY = 'sample'; // UserLocal\u306eAPI\u30ad\u30fc\nvar TWITTER_ID = '@MikunyanUL'; // Bot\u306eTwitter ID\n\n// \u30ea\u30d7\u30e9\u30a4\u6e08\u307f\u30b7\u30fc\u30c8\nvar MENTIONED_SHEET_URL = 'https://docs.google.com/spreadsheets/d/{\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306eID}/edit#gid=0';\nvar MENTIONED_SHEET;\nvar ALL_MENTIONED_ID; // \u30ea\u30d7\u30e9\u30a4\u6e08\u307fID\u4e00\u89a7\n\n// \u76f4\u8fd1100\u4ef6\u3078\u30ea\u30d7\u30e9\u30a4\u3092\u3059\u308b\nfunction replyAll() {\n\n  // \u30ea\u30d7\u30e9\u30a4\u6e08\u307f\u4e00\u89a7\u306e\u8aad\u307f\u8fbc\u307f\n  initReplied();\n\n  // \u3059\u3079\u3066\u306e\u30e1\u30f3\u30b7\u30e7\u30f3\u3092\u53d6\u5f97\n  var mentions = getTwitterMentions();\n  for each (mention in mentions) {\n    // \u30c4\u30a4\u30fc\u30c8\u60c5\u5831\u3092\u53d6\u5f97\n    var screenName = mention.user.screen_name;\n    var name = mention.user.name;\n    var text = mention.text.replace(TWITTER_ID, '').trim();\n    var mentionID = mention.id_str;\n\n    // \u30ea\u30d7\u30e9\u30a4\u6e08\u307f\u306a\u3089\u30b9\u30ad\u30c3\u30d7\n    if ( hasReplied(mentionID) ) continue;\n\n    // \u4eba\u5de5\u77e5\u80fd\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u53d6\u5f97\n    var message = getReplyCatMessage(screenName, name, text);\n\n    // \u30ea\u30d7\u30e9\u30a4\n    tweetText(message, mentionID);\n\n    // \u30ea\u30d7\u30e9\u30a4\u6e08\u307fID\u4e00\u89a7\u306b\u8a18\u9332\n    MENTIONED_SHEET.appendRow([mentionID]);\n  }\n}\n\n// \u30ea\u30d7\u30e9\u30a4\u6e08\u307f\u30c7\u30fc\u30bf\u3092\u30b9\u30d7\u30ec\u30c3\u30c9\u30b7\u30fc\u30c8\u304b\u3089\u8aad\u307f\u8fbc\u307f\nfunction initReplied() {\n var ss = SpreadsheetApp.openByUrl(MENTIONED_SHEET_URL);\n MENTIONED_SHEET = ss.getSheets()[0];\n\n var lastRow = MENTIONED_SHEET.getLastRow();\n if (lastRow == 0) {\n   ALL_MENTIONED_ID = [];\n   return;\n }\n\n // \u30c7\u30fc\u30bf\u30af\u30ea\u30fc\u30f3\n if (lastRow > 200) {\n   MENTIONED_SHEET.deleteRows(0, 100);\n   lastRow = MENTIONED_SHEET.getLastRow();\n }\n\n var cell = MENTIONED_SHEET.getRange(\"A1\");\n var allValue = cell.offset(0, 0, lastRow);\n ALL_MENTIONED_ID = allValue.getValues().map(function(v) { return v[0] });\n}\n\n/**\n * \u30ea\u30d7\u30e9\u30a4\u6e08\u307f\u30c4\u30a4\u30fc\u30c8\u304b\u30c1\u30a7\u30c3\u30af\n * @mentionID \u8fd4\u4fe1\u5148\u306e\u30c4\u30a4\u30fc\u30c8ID\n */\nfunction hasReplied(mentionID) {\n var index = ALL_MENTIONED_ID.indexOf(mentionID);\n if (index > -1) return true;\n return false;\n}\n\n/**\n * \u30c4\u30a4\u30fc\u30c8\u3059\u308b\n * @text \u30c4\u30a4\u30fc\u30c8\u3059\u308b\u6587\u7ae0\n * @mentionID \u8fd4\u4fe1\u5148\u306e\u30c4\u30a4\u30fc\u30c8ID\n */\nfunction tweetText(text, mentionID) {                         \n  var service = getService();\n  if (service.hasAccess()) {\n    var url = 'https://api.twitter.com/1.1/statuses/update.json';\n    var payload = {\n      status: text,\n      in_reply_to_status_id: mentionID\n    };\n    payload = Object.keys(payload).map(function(key) {\n      return encodeRfc3986(key) + '=' + encodeRfc3986(payload[key]);\n    }).join('&');\n    var response = service.fetch(url, {\n      method: 'post',\n      payload: payload,\n      escaping: false\n    });\n    var result = JSON.parse(response.getContentText());\n    Logger.log(JSON.stringify(result, null, 2));\n  } else {\n    var authorizationUrl = service.authorize();\n    Logger.log('URL\u306b\u30a2\u30af\u30bb\u30b9\u3057\u8a8d\u8a3c\u3057\u3066\u304f\u3060\u3055\u3044: %s',\n        authorizationUrl);\n  }\n}\n\n// \u30e1\u30f3\u30b7\u30e7\u30f3\u4e00\u89a7\u3092\u53d6\u5f97\u3059\u308b\nfunction getTwitterMentions() {                         \n  var service = getService();\n  if (service.hasAccess()) {\n    var url = 'https://api.twitter.com/1.1/statuses/mentions_timeline.json';\n    var response = service.fetch(url + '?count=200');\n    var result = JSON.parse(response.getContentText());\n    return result;\n  } else {\n    var authorizationUrl = service.authorize();\n    Logger.log('URL\u306b\u30a2\u30af\u30bb\u30b9\u3057\u8a8d\u8a3c\u3057\u3066\u304f\u3060\u3055\u3044: %s',\n        authorizationUrl);\n  }\n}\n\n// \u8fd4\u4fe1\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u751f\u6210\nfunction getReplyCatMessage(screenName, name, message) {\n\n  // \u30cb\u30c3\u30af\u30cd\u30fc\u30e0\u3000\u30a2\u30ab\u30a6\u30f3\u30c8\u540d\u304c(\u59d3)(\u540d)\u3058\u3083\u306a\u3044\u3068\u4e0a\u624b\u304f\u3044\u304d\u306b\u304f\u3044\n  var nickname = getNickname(name);\n\n  // \u30e1\u30c3\u30bb\u30fc\u30b8\u751f\u6210\n  var normalMessage = getReplyMessage(message);\n  normalMessage = normalMessage.replace(/[\\.\\?\uff1f\uff01\u30fc]/g, ''); // \u8a9e\u5c3e\u306b\u8a18\u53f7\u304c\u3042\u308b\u3068\u30ad\u30e3\u30e9\u30af\u30bf\u30fc\u5909\u63db\u3055\u308c\u306a\u3044\u3053\u3068\u304c\u3042\u308b\n  var catMessage = (normalMessage ? convertMessage(normalMessage, 'cat') : normalMessage);\n\n  // \u8fd4\u4fe1\u30e1\u30c3\u30bb\u30fc\u30b8\u4f5c\u6210\n  var replyMessage = '@' + screenName + ' ';\n  replyMessage += (nickname ? nickname + '\u3001' : '');\n  replyMessage += catMessage;\n  return replyMessage;\n}\n\n// \u4eba\u5de5\u77e5\u80fd\u306b\u3088\u308b\u8fd4\u4fe1\u30e1\u30c3\u30bb\u30fc\u30b8\u53d6\u5f97\nfunction getReplyMessage(message) {\n  // \u81ea\u52d5\u4f1a\u8a71API\n  var url = 'https://chatbot-api.userlocal.jp/api/chat';\n  url += '?message=' + encodeRfc3986(message);\n  url += '&key=' + USERLOCAL_API_KEY;\n\n  // API\u7d50\u679c\u53d6\u5f97\n  var response = UrlFetchApp.fetch(url);\n  var apiResult = JSON.parse(response.getContentText());\n  if (apiResult.status != 'success') return;\n  return apiResult.result;\n}\n\n// \u6307\u5b9a\u3057\u305f\u30bf\u30a4\u30d7\u306e\u8a71\u3057\u65b9\u306b\u5909\u66f4\nfunction convertMessage(message, characterType) {\n  // \u30ad\u30e3\u30e9\u30af\u30bf\u30fc\u4f1a\u8a71\u5909\u63dbAPI\n  var url = 'https://chatbot-api.userlocal.jp/api/character';\n  url += '?message=' + encodeRfc3986(message);\n  url += '&character_type=' + characterType // \u732b:cat \u72ac:dog \u8001\u4eba:roujin\n  url += '&key=' + USERLOCAL_API_KEY;\n\n  // API\u7d50\u679c\u53d6\u5f97\n  var response = UrlFetchApp.fetch(url);\n  var apiResult = JSON.parse(response.getContentText());\n  if (apiResult.status != 'success') return;\n  return apiResult.result;\n}\n\n// Twitter\u540d\u304b\u3089\u30cb\u30c3\u30af\u30cd\u30fc\u30e0\u3092\u53d6\u5f97\n// \u203b\u53d6\u308c\u306a\u3044\u3053\u3068\u3082\u3042\u308a\nfunction getNickname(name) {\n  // \u6c0f\u540d\u81ea\u52d5\u8b58\u5225API \n  var url = 'https://chatbot-api.userlocal.jp/api/name';\n  url += '?name=' + encodeRfc3986(name);\n  url += '&key=' + USERLOCAL_API_KEY;\n\n  // API\u7d50\u679c\u53d6\u5f97\n  var response = UrlFetchApp.fetch(url);\n  var apiResult = JSON.parse(response.getContentText());\n  if (apiResult.status != 'success') return;\n  var result = apiResult.result;\n\n  // \u300c\u540d\u300d\u300c\u540d(\u8aad\u307f)\u300d\u304c\u53d6\u5f97\u3067\u304d\u308b \u2192 \u30cb\u30c3\u30af\u30cd\u30fc\u30e0\u8fd4\u5374\n  // \u203b\u300c\u540d\u300d\u304c\u306a\u3044\u30c7\u30fc\u30bf\u306f\u30cb\u30c3\u30af\u30cd\u30fc\u30e0\u306e\u7cbe\u5ea6\u304c\u307e\u3060\u826f\u304f\u306a\u3044\u305f\u3081\n  if (!result.first_name) return;\n  if (!result.first_name_yomi) return;\n\n  // \u30cb\u30c3\u30af\u30cd\u30fc\u30e0\u3092\u5019\u88dc\u304b\u3089\u30e9\u30f3\u30c0\u30e0\u306b\u53d6\u5f97\n  var nicknames = result.nickname;\n  var nickname = nicknames[Math.floor(Math.random() * nicknames.length)];\n  return nickname;\n}\n\n\n\n\n(\u03a6\u03c9\u03a6)\u30bd\u30fc\u30b9(Twitter API\u7528)\n\nMikunyanBot.gs\n/**\n * Encodes a string using the RFC 3986 spec.\n */\nfunction encodeRfc3986(str) {\n  return encodeURIComponent(str).replace(/[!'()]/g, function(char) {\n    return escape(char);\n  }).replace(/\\*/g, \"%2A\");\n}\n\n/**\n * Reset the authorization state, so that it can be re-tested.\n */\nfunction reset() {\n  var service = getService();\n  service.reset();\n}\n\n/**\n * Configures the service.\n */\nfunction getService() {\n  return OAuth1.createService('Twitter')\n      // Set the endpoint URLs.\n      .setAccessTokenUrl('https://api.twitter.com/oauth/access_token')\n      .setRequestTokenUrl('https://api.twitter.com/oauth/request_token')\n      .setAuthorizationUrl('https://api.twitter.com/oauth/authorize')\n\n      // Set the consumer key and secret.\n      .setConsumerKey(CONSUMER_KEY)\n      .setConsumerSecret(CONSUMER_SECRET)\n\n      // Set the name of the callback function in the script referenced\n      // above that should be invoked to complete the OAuth flow.\n      .setCallbackFunction('authCallback')\n\n      // Set the property store where authorized tokens should be persisted.\n      .setPropertyStore(PropertiesService.getUserProperties());\n}\n\n/**\n * Handles the OAuth2 callback.\n */\nfunction authCallback(request) {\n  var service = getService();\n  var authorized = service.handleCallback(request);\n  if (authorized) {\n    return HtmlService.createHtmlOutput('Success!');\n  } else {\n    return HtmlService.createHtmlOutput('Denied');\n  }\n}\n\n\n\n\n\u53c2\u8003\u8a18\u4e8b\nGoogle Apps Script\u3067Twitter bot\u3092\u4f5c\u3063\u3066\u307f\u305f\n##(*\u03a6\u03c9\u03a6*)\u4eba\u5de5\u77e5\u80fdAPI\u304c\u516c\u958b\u3055\u308c\u305f\u305e\uff01\n\u30a2\u30a4\u30c9\u30eb\u30de\u30b9\u30bf\u30fc \u30b7\u30f3\u30c7\u30ec\u30e9\u30ac\u30fc\u30eb\u30ba\u306e\u524d\u5ddd\u307f\u304f\u3053\u3068\u901a\u79f0\u307f\u304f\u306b\u3083\u3093\u3001\u304b\u308f\u3044\u3044\u3067\u3059\u3088\u306d\n\u307f\u304f\u306b\u3083\u3093\u3068\u306b\u3083\u3093\u306b\u3083\u3093\u3057\u305f\u3044\n\u307f\u304f\u306b\u3083\u3093\u3068\u306b\u3083\u3093\u306b\u3083\u3093\u3057\u305f\u3044\n\n\u305d\u3093\u306a\u6c17\u6301\u3061\u3067\u3044\u305f\u3068\u3053\u308d\u3001\u682a\u5f0f\u4f1a\u793e\u30e6\u30fc\u30b6\u30fc\u30ed\u30fc\u30ab\u30eb\u3055\u3093\u304c\u4eba\u5de5\u77e5\u80fd\u306eAPI\u3092\u516c\u958b\u3057\u307e\u3057\u305f\u3002\n[\u30e6\u30fc\u30b6\u30fc\u3068\u81ea\u52d5\u3067\u5bfe\u8a71\u3059\u308b\u4eba\u5de5\u77e5\u80fd\u30dc\u30c3\u30c8API](http://ai.userlocal.jp/)\n\n\u3093\u2026\uff1f\uff1f\n![talk_cat.jpg](https://qiita-image-store.s3.amazonaws.com/0/45865/ab48aa89-8ae1-289a-e295-70709c7383f6.jpeg)\n\u307f\u304f\u306b\u3083\u3093\u3060\u2026\n\u3053\u308c\u306f\u307f\u304f\u306b\u3083\u3093\u304c\u5275\u308c\u308b\u305e\u2026\u3063\uff01\n\n##(*\u03a6\u03c9\u03a6*)\u6210\u679c\u7269\n[\u307f\u304f\u306b\u3083\u3093Bot\uff20\u4eba\u5de5\u77e5\u80fd](https://twitter.com/MikunyanUL/with_replies)\n\u5148\u77403000\u4eba\u306eAPI\u52df\u96c6\u306b\u5165\u308c\u305f\u306e\u3067\u3001\u3055\u3063\u305d\u304fGoogle Apps Script\u3067Twitter Bot\u3092\u4f5c\u3063\u3066\u307f\u307e\u3057\u305f\u3002\n![cad0e8e6-9461-9203-e65a-8d6ad134102a.png](https://qiita-image-store.s3.amazonaws.com/0/45865/c74c2be4-d649-46c5-342c-7f319921a99f.png)\n\n##(*\u03a6\u03c9\u03a6*)\u6a5f\u80fd\u6982\u8981\n\uff11\uff0e10\u5206\u3054\u3068\u306b\u30e1\u30f3\u30b7\u30e7\u30f3\u3092\u53d6\u5f97\n\uff12\uff0e\u8fd4\u4fe1\u3092\u30e6\u30fc\u30b6API\u3067\u751f\u6210\n\uff13\uff0e\u30cb\u30c3\u30af\u30cd\u30fc\u30e0\u3092API\u3067\u53d6\u5f97\uff08\u203bTwitter\u306e\u540d\u524d\u30d9\u30fc\u30b9\u306a\u306e\u3067\u53d6\u308c\u306a\u3044\u53ef\u80fd\u6027\u5927\uff09\n\uff14\uff0e\u307f\u304f\u306b\u3083\u3093\u8a9e\u306b\u30b3\u30f3\u30d1\u30a4\u30eb\n\uff15\uff0e\u30e1\u30f3\u30b7\u30e7\u30f3\u306b\u8fd4\u4fe1\u3057\u3066\u304f\u308c\u308b\n\n##(*\u03a6\u03c9\u03a6*)\u4f7f\u7528\u3057\u305fAPI\n###\u81ea\u52d5\u4f1a\u8a71API\n\u9001\u3089\u308c\u305f\u30e1\u30c3\u30bb\u30fc\u30b8\u3078\u306e\u8fd4\u4fe1\u3092\u53d6\u5f97\u3067\u304d\u307e\u3059\u3002\nLINE\u306e\u308a\u3093\u306a\u3061\u3083\u3093\u306e\u30a4\u30e1\u30fc\u30b8\u3067\u3059\u3002\n###\u30ad\u30e3\u30e9\u30af\u30bf\u30fc\u4f1a\u8a71\u5909\u63dbAPI\n\u30e1\u30c3\u30bb\u30fc\u30b8\u306e\u53e3\u8abf\u3092\u5909\u63db\u3057\u3066\u53d6\u5f97\u3067\u304d\u307e\u3059\u3002\n\u73fe\u5728\u306f\u300c\u732b\u300d\u300c\u72ac\u300d\u300c\u8001\u4eba\u300d\u306b\u5bfe\u5fdc\u3057\u3066\u3044\u307e\u3059\u3002\n###\u6c0f\u540d\u81ea\u52d5\u8b58\u5225API \n\u540d\u524d\u304b\u3089\u300c\u59d3\u300d\u300c\u540d\u300d\u300c\u59d3(\u3088\u307f)\u300d\u300c\u540d(\u3088\u307f)\u300d\u300c\u6027\u5225\u300d\u300c\u30cb\u30c3\u30af\u30cd\u30fc\u30e0\u4e00\u89a7\u300d\u304c\u53d6\u5f97\u3067\u304d\u307e\u3059\u3002\n\n##(*\u03a6\u03c9\u03a6*)\u514d\u8cac\nTwitter API\u3084\u30e6\u30fc\u30b6\u30fc\u30ed\u30fc\u30ab\u30eb\u306eAPI\u5236\u9650\u306f\u610f\u8b58\u3057\u3066\u3044\u307e\u305b\u3093\n\u30bd\u30fc\u30b9\u3092\u305d\u306e\u307e\u307e\u4f7f\u7528\u3059\u308b\u969b\u306f\u3054\u6ce8\u610f\u304f\u3060\u3055\u3044\n\n\n##(*\u03a6\u03c9\u03a6*)\u30bd\u30fc\u30b9\n\n```js:MikunyanBot.gs\n// Twitter\u306e\u8a8d\u8a3c\u30ad\u30fc\nvar CONSUMER_KEY = '{Twitter\u306eCONSUMER KEY}';\nvar CONSUMER_SECRET = '{Twitter\u306eCONSUMER SECRET}';\n\nvar USERLOCAL_API_KEY = 'sample'; // UserLocal\u306eAPI\u30ad\u30fc\nvar TWITTER_ID = '@MikunyanUL'; // Bot\u306eTwitter ID\n\n// \u30ea\u30d7\u30e9\u30a4\u6e08\u307f\u30b7\u30fc\u30c8\nvar MENTIONED_SHEET_URL = 'https://docs.google.com/spreadsheets/d/{\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306eID}/edit#gid=0';\nvar MENTIONED_SHEET;\nvar ALL_MENTIONED_ID; // \u30ea\u30d7\u30e9\u30a4\u6e08\u307fID\u4e00\u89a7\n\n// \u76f4\u8fd1100\u4ef6\u3078\u30ea\u30d7\u30e9\u30a4\u3092\u3059\u308b\nfunction replyAll() {\n  \n  // \u30ea\u30d7\u30e9\u30a4\u6e08\u307f\u4e00\u89a7\u306e\u8aad\u307f\u8fbc\u307f\n  initReplied();\n  \n  // \u3059\u3079\u3066\u306e\u30e1\u30f3\u30b7\u30e7\u30f3\u3092\u53d6\u5f97\n  var mentions = getTwitterMentions();\n  for each (mention in mentions) {\n    // \u30c4\u30a4\u30fc\u30c8\u60c5\u5831\u3092\u53d6\u5f97\n    var screenName = mention.user.screen_name;\n    var name = mention.user.name;\n    var text = mention.text.replace(TWITTER_ID, '').trim();\n    var mentionID = mention.id_str;\n    \n    // \u30ea\u30d7\u30e9\u30a4\u6e08\u307f\u306a\u3089\u30b9\u30ad\u30c3\u30d7\n    if ( hasReplied(mentionID) ) continue;\n    \n    // \u4eba\u5de5\u77e5\u80fd\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u53d6\u5f97\n    var message = getReplyCatMessage(screenName, name, text);\n    \n    // \u30ea\u30d7\u30e9\u30a4\n    tweetText(message, mentionID);\n\n    // \u30ea\u30d7\u30e9\u30a4\u6e08\u307fID\u4e00\u89a7\u306b\u8a18\u9332\n    MENTIONED_SHEET.appendRow([mentionID]);\n  }\n}\n\n// \u30ea\u30d7\u30e9\u30a4\u6e08\u307f\u30c7\u30fc\u30bf\u3092\u30b9\u30d7\u30ec\u30c3\u30c9\u30b7\u30fc\u30c8\u304b\u3089\u8aad\u307f\u8fbc\u307f\nfunction initReplied() {\n var ss = SpreadsheetApp.openByUrl(MENTIONED_SHEET_URL);\n MENTIONED_SHEET = ss.getSheets()[0];\n \n var lastRow = MENTIONED_SHEET.getLastRow();\n if (lastRow == 0) {\n   ALL_MENTIONED_ID = [];\n   return;\n }\n \n // \u30c7\u30fc\u30bf\u30af\u30ea\u30fc\u30f3\n if (lastRow > 200) {\n   MENTIONED_SHEET.deleteRows(0, 100);\n   lastRow = MENTIONED_SHEET.getLastRow();\n }\n \n var cell = MENTIONED_SHEET.getRange(\"A1\");\n var allValue = cell.offset(0, 0, lastRow);\n ALL_MENTIONED_ID = allValue.getValues().map(function(v) { return v[0] });\n}\n\n/**\n * \u30ea\u30d7\u30e9\u30a4\u6e08\u307f\u30c4\u30a4\u30fc\u30c8\u304b\u30c1\u30a7\u30c3\u30af\n * @mentionID \u8fd4\u4fe1\u5148\u306e\u30c4\u30a4\u30fc\u30c8ID\n */\nfunction hasReplied(mentionID) {\n var index = ALL_MENTIONED_ID.indexOf(mentionID);\n if (index > -1) return true;\n return false;\n}\n\n/**\n * \u30c4\u30a4\u30fc\u30c8\u3059\u308b\n * @text \u30c4\u30a4\u30fc\u30c8\u3059\u308b\u6587\u7ae0\n * @mentionID \u8fd4\u4fe1\u5148\u306e\u30c4\u30a4\u30fc\u30c8ID\n */\nfunction tweetText(text, mentionID) {                         \n  var service = getService();\n  if (service.hasAccess()) {\n    var url = 'https://api.twitter.com/1.1/statuses/update.json';\n    var payload = {\n      status: text,\n      in_reply_to_status_id: mentionID\n    };\n    payload = Object.keys(payload).map(function(key) {\n      return encodeRfc3986(key) + '=' + encodeRfc3986(payload[key]);\n    }).join('&');\n    var response = service.fetch(url, {\n      method: 'post',\n      payload: payload,\n      escaping: false\n    });\n    var result = JSON.parse(response.getContentText());\n    Logger.log(JSON.stringify(result, null, 2));\n  } else {\n    var authorizationUrl = service.authorize();\n    Logger.log('URL\u306b\u30a2\u30af\u30bb\u30b9\u3057\u8a8d\u8a3c\u3057\u3066\u304f\u3060\u3055\u3044: %s',\n        authorizationUrl);\n  }\n}\n\n// \u30e1\u30f3\u30b7\u30e7\u30f3\u4e00\u89a7\u3092\u53d6\u5f97\u3059\u308b\nfunction getTwitterMentions() {                         \n  var service = getService();\n  if (service.hasAccess()) {\n    var url = 'https://api.twitter.com/1.1/statuses/mentions_timeline.json';\n    var response = service.fetch(url + '?count=200');\n    var result = JSON.parse(response.getContentText());\n    return result;\n  } else {\n    var authorizationUrl = service.authorize();\n    Logger.log('URL\u306b\u30a2\u30af\u30bb\u30b9\u3057\u8a8d\u8a3c\u3057\u3066\u304f\u3060\u3055\u3044: %s',\n        authorizationUrl);\n  }\n}\n\n// \u8fd4\u4fe1\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u751f\u6210\nfunction getReplyCatMessage(screenName, name, message) {\n\n  // \u30cb\u30c3\u30af\u30cd\u30fc\u30e0\u3000\u30a2\u30ab\u30a6\u30f3\u30c8\u540d\u304c(\u59d3)(\u540d)\u3058\u3083\u306a\u3044\u3068\u4e0a\u624b\u304f\u3044\u304d\u306b\u304f\u3044\n  var nickname = getNickname(name);\n\n  // \u30e1\u30c3\u30bb\u30fc\u30b8\u751f\u6210\n  var normalMessage = getReplyMessage(message);\n  normalMessage = normalMessage.replace(/[\\.\\?\uff1f\uff01\u30fc]/g, ''); // \u8a9e\u5c3e\u306b\u8a18\u53f7\u304c\u3042\u308b\u3068\u30ad\u30e3\u30e9\u30af\u30bf\u30fc\u5909\u63db\u3055\u308c\u306a\u3044\u3053\u3068\u304c\u3042\u308b\n  var catMessage = (normalMessage ? convertMessage(normalMessage, 'cat') : normalMessage);\n  \n  // \u8fd4\u4fe1\u30e1\u30c3\u30bb\u30fc\u30b8\u4f5c\u6210\n  var replyMessage = '@' + screenName + ' ';\n  replyMessage += (nickname ? nickname + '\u3001' : '');\n  replyMessage += catMessage;\n  return replyMessage;\n}\n\n// \u4eba\u5de5\u77e5\u80fd\u306b\u3088\u308b\u8fd4\u4fe1\u30e1\u30c3\u30bb\u30fc\u30b8\u53d6\u5f97\nfunction getReplyMessage(message) {\n  // \u81ea\u52d5\u4f1a\u8a71API\n  var url = 'https://chatbot-api.userlocal.jp/api/chat';\n  url += '?message=' + encodeRfc3986(message);\n  url += '&key=' + USERLOCAL_API_KEY;\n  \n  // API\u7d50\u679c\u53d6\u5f97\n  var response = UrlFetchApp.fetch(url);\n  var apiResult = JSON.parse(response.getContentText());\n  if (apiResult.status != 'success') return;\n  return apiResult.result;\n}\n\n// \u6307\u5b9a\u3057\u305f\u30bf\u30a4\u30d7\u306e\u8a71\u3057\u65b9\u306b\u5909\u66f4\nfunction convertMessage(message, characterType) {\n  // \u30ad\u30e3\u30e9\u30af\u30bf\u30fc\u4f1a\u8a71\u5909\u63dbAPI\n  var url = 'https://chatbot-api.userlocal.jp/api/character';\n  url += '?message=' + encodeRfc3986(message);\n  url += '&character_type=' + characterType // \u732b:cat \u72ac:dog \u8001\u4eba:roujin\n  url += '&key=' + USERLOCAL_API_KEY;\n  \n  // API\u7d50\u679c\u53d6\u5f97\n  var response = UrlFetchApp.fetch(url);\n  var apiResult = JSON.parse(response.getContentText());\n  if (apiResult.status != 'success') return;\n  return apiResult.result;\n}\n\n// Twitter\u540d\u304b\u3089\u30cb\u30c3\u30af\u30cd\u30fc\u30e0\u3092\u53d6\u5f97\n// \u203b\u53d6\u308c\u306a\u3044\u3053\u3068\u3082\u3042\u308a\nfunction getNickname(name) {\n  // \u6c0f\u540d\u81ea\u52d5\u8b58\u5225API \n  var url = 'https://chatbot-api.userlocal.jp/api/name';\n  url += '?name=' + encodeRfc3986(name);\n  url += '&key=' + USERLOCAL_API_KEY;\n  \n  // API\u7d50\u679c\u53d6\u5f97\n  var response = UrlFetchApp.fetch(url);\n  var apiResult = JSON.parse(response.getContentText());\n  if (apiResult.status != 'success') return;\n  var result = apiResult.result;\n  \n  // \u300c\u540d\u300d\u300c\u540d(\u8aad\u307f)\u300d\u304c\u53d6\u5f97\u3067\u304d\u308b \u2192 \u30cb\u30c3\u30af\u30cd\u30fc\u30e0\u8fd4\u5374\n  // \u203b\u300c\u540d\u300d\u304c\u306a\u3044\u30c7\u30fc\u30bf\u306f\u30cb\u30c3\u30af\u30cd\u30fc\u30e0\u306e\u7cbe\u5ea6\u304c\u307e\u3060\u826f\u304f\u306a\u3044\u305f\u3081\n  if (!result.first_name) return;\n  if (!result.first_name_yomi) return;\n  \n  // \u30cb\u30c3\u30af\u30cd\u30fc\u30e0\u3092\u5019\u88dc\u304b\u3089\u30e9\u30f3\u30c0\u30e0\u306b\u53d6\u5f97\n  var nicknames = result.nickname;\n  var nickname = nicknames[Math.floor(Math.random() * nicknames.length)];\n  return nickname;\n}\n\n```\n\n##(*\u03a6\u03c9\u03a6*)\u30bd\u30fc\u30b9(Twitter API\u7528)\n```js:MikunyanBot.gs\n/**\n * Encodes a string using the RFC 3986 spec.\n */\nfunction encodeRfc3986(str) {\n  return encodeURIComponent(str).replace(/[!'()]/g, function(char) {\n    return escape(char);\n  }).replace(/\\*/g, \"%2A\");\n}\n\n/**\n * Reset the authorization state, so that it can be re-tested.\n */\nfunction reset() {\n  var service = getService();\n  service.reset();\n}\n\n/**\n * Configures the service.\n */\nfunction getService() {\n  return OAuth1.createService('Twitter')\n      // Set the endpoint URLs.\n      .setAccessTokenUrl('https://api.twitter.com/oauth/access_token')\n      .setRequestTokenUrl('https://api.twitter.com/oauth/request_token')\n      .setAuthorizationUrl('https://api.twitter.com/oauth/authorize')\n\n      // Set the consumer key and secret.\n      .setConsumerKey(CONSUMER_KEY)\n      .setConsumerSecret(CONSUMER_SECRET)\n\n      // Set the name of the callback function in the script referenced\n      // above that should be invoked to complete the OAuth flow.\n      .setCallbackFunction('authCallback')\n\n      // Set the property store where authorized tokens should be persisted.\n      .setPropertyStore(PropertiesService.getUserProperties());\n}\n\n/**\n * Handles the OAuth2 callback.\n */\nfunction authCallback(request) {\n  var service = getService();\n  var authorized = service.handleCallback(request);\n  if (authorized) {\n    return HtmlService.createHtmlOutput('Success!');\n  } else {\n    return HtmlService.createHtmlOutput('Denied');\n  }\n}\n\n```\n\n##\u53c2\u8003\u8a18\u4e8b\n[Google Apps Script\u3067Twitter bot\u3092\u4f5c\u3063\u3066\u307f\u305f](http://qiita.com/abe-perorist/items/2cedc0f577b4f10b4ccb)\n", "tags": ["\u4eba\u5de5\u77e5\u80fd", "GoogleAppsScript", "Twitter", "\u30a2\u30a4\u30c9\u30eb\u30de\u30b9\u30bf\u30fc"]}