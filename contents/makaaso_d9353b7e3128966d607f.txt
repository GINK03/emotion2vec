{"tags": ["openldap"], "context": " More than 1 year has passed since last update.\n\n\u3084\u308a\u305f\u3044\u3053\u3068\n\nSSH\u516c\u958b\u9375\u3092LDAP\u306b\u767b\u9332\u3057\u3066\u4e00\u5143\u7ba1\u7406\u3057\u305f\u3044\u305f\u3081\u8abf\u67fb\u3057\u307e\u3057\u305f\u3002OpenSSH\u3092\u30bd\u30fc\u30b9\u304b\u3089\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u3066\u3068\u304b\u3044\u308d\u3044\u308d\u60c5\u5831\u304c\u3042\u308a\u307e\u3057\u305f\u304c\u3001Ubuntu 14.04.1 LTS\u3067\u306fOpenSSH 6.6.1p1\u304capt-get\u3067\u5165\u624b\u3067\u304d\u308b\u306e\u3067\u30b9\u30ad\u30fc\u30de\u30d5\u30a1\u30a4\u30eb\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066include\u3059\u308b\u3060\u3051\u3067\u3057\u305f\u3002\n\n\n\u74b0\u5883\n\nOS:Ubuntu 14.04.1 LTS\nOpenSSH:6.6.1p1\nOpenLDAP:2.4.31\n\n\nLDAP\u30b5\u30fc\u30d0\u5074\u306e\u8a2d\u5b9a\n\n\u307e\u305aLDAP\u30b5\u30fc\u30d0\u3067\u306e\u8a2d\u5b9a\u624b\u9806\n\n\n1.OpenLdap\u30b5\u30fc\u30d3\u30b9\u505c\u6b62\nsudo su -\nservice slapd stop\n\n\n2.\u30b9\u30ad\u30fc\u30de\u30d5\u30a1\u30a4\u30eb\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\ncd /usr/local/src\nwget https://openssh-lpk.googlecode.com/files/openssh-lpk_openldap.schema\n\n\n3.\u30b9\u30ad\u30fc\u30de\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u30b3\u30d4\u30fc\nmv openssh-lpk_openldap.schema /etc/ldap/schema\n\n\n4.slapd.conf\u7de8\u96c6\nvi /etc/ldap/slapd.conf\n------------------------------------------------------------\ninclude         /etc/ldap/schema/openssh-lpk_openldap.schema\n------------------------------------------------------------\n\n\n5.ConfigDB\u524a\u9664\nrm -rf /etc/ldap/slapd.d/*\n\n\n6.ConfigDB\u518d\u4f5c\u6210\nslaptest -f /etc/ldap/slapd.conf -F /etc/ldap/slapd.d/\nchown -R openldap:openldap /etc/ldap/slapd.d\n\n\n7.OpenLdap\u30b5\u30fc\u30d3\u30b9\u8d77\u52d5\nservice slapd start\n\n\n\u3053\u308c\u3067LDAP\u306eAttribute\u306b\u300csshPublicKey\u300d\u304c\u8868\u793a\u3055\u308c\u516c\u958b\u9375\u304c\u8ffd\u52a0\u3067\u304d\u308b\n\n\nLDAP\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u306e\u8a2d\u5b9a\n\nsshd\u304cLDAP\u30b5\u30fc\u30d0\u306eSSH\u516c\u958b\u9375\u3092\u53d6\u5f97\u3059\u308b\u3088\u3046\u306b\u3059\u308b\u8a2d\u5b9a\u624b\u9806\n\n\n1.LDAP\u30b5\u30fc\u30d0\u304b\u3089SSH\u516c\u958b\u9375\u3092\u53d6\u5f97\u3059\u308b\u30b9\u30af\u30ea\u30d7\u30c8\n\n\u3084\u3063\u3066\u3044\u308b\u3053\u3068\u306fLDAP\u30b5\u30fc\u30d0\u306b\u63a5\u7d9a\u3057\u3066\u300cldapsearch\u300d\u306e\u7d50\u679c\u304b\u3089\u516c\u958b\u9375\u3060\u3051\u62bd\u51fa\n\nvi /opt/ssh-command/LdapGetSSHKey.sh\n------------------------------------------------------------\n#!/bin/bash\n\nuri=ldap://<LDAP-SERVER>\nbinddn=\"<BIND-USER>\"\nbindpw=<PASSWORD>\nbase=\"<BASE>\"\nuid=$1\n\nldapsearch -LLL -H ${uri} -w \"${bindpw}\" -D \"${binddn}\" -b \"${base}\" \"(& (objectClass=posixAccount) (uid=${uid}))\" \"sshPublicKey\" | sed -ne '2,$p' | sed -e 's/sshPublicKey: //g' | sed -e 's/^ //g' | tr -d '\\n'\n------------------------------------------------------------\n\n\n2.sshd\u306b\u8a8d\u8a3c\u30b3\u30de\u30f3\u30c9\u306e\u8a2d\u5b9a\nvi /etc/ssh/sshd_config\n------------------------------------------------------------\nAuthorizedKeysCommand /opt/ssh-command/LdapGetSSHKey.sh\nAuthorizedKeysCommandUser root\n------------------------------------------------------------\n\n\n\u203b\u53c2\u8003\nhttp://makaaso.hatenablog.com/entry/2015/12/10/145442\n\n#### \u3084\u308a\u305f\u3044\u3053\u3068\n\n* SSH\u516c\u958b\u9375\u3092LDAP\u306b\u767b\u9332\u3057\u3066\u4e00\u5143\u7ba1\u7406\u3057\u305f\u3044\u305f\u3081\u8abf\u67fb\u3057\u307e\u3057\u305f\u3002OpenSSH\u3092\u30bd\u30fc\u30b9\u304b\u3089\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u3066\u3068\u304b\u3044\u308d\u3044\u308d\u60c5\u5831\u304c\u3042\u308a\u307e\u3057\u305f\u304c\u3001Ubuntu 14.04.1 LTS\u3067\u306fOpenSSH 6.6.1p1\u304capt-get\u3067\u5165\u624b\u3067\u304d\u308b\u306e\u3067\u30b9\u30ad\u30fc\u30de\u30d5\u30a1\u30a4\u30eb\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066include\u3059\u308b\u3060\u3051\u3067\u3057\u305f\u3002\n\n#### \u74b0\u5883\n\n* OS:Ubuntu 14.04.1 LTS\n* OpenSSH:6.6.1p1\n* OpenLDAP:2.4.31\n\n#### LDAP\u30b5\u30fc\u30d0\u5074\u306e\u8a2d\u5b9a\n\n* \u307e\u305aLDAP\u30b5\u30fc\u30d0\u3067\u306e\u8a2d\u5b9a\u624b\u9806\n\n##### 1.OpenLdap\u30b5\u30fc\u30d3\u30b9\u505c\u6b62\n\n```\nsudo su -\nservice slapd stop\n```\n\n##### 2.\u30b9\u30ad\u30fc\u30de\u30d5\u30a1\u30a4\u30eb\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\n\n```\ncd /usr/local/src\nwget https://openssh-lpk.googlecode.com/files/openssh-lpk_openldap.schema\n```\n\n##### 3.\u30b9\u30ad\u30fc\u30de\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u30b3\u30d4\u30fc\n\n```\nmv openssh-lpk_openldap.schema /etc/ldap/schema\n```\n\n##### 4.slapd.conf\u7de8\u96c6\n\n```\nvi /etc/ldap/slapd.conf\n------------------------------------------------------------\ninclude         /etc/ldap/schema/openssh-lpk_openldap.schema\n------------------------------------------------------------\n```\n\n##### 5.ConfigDB\u524a\u9664\n\n```\nrm -rf /etc/ldap/slapd.d/*\n```\n\n##### 6.ConfigDB\u518d\u4f5c\u6210\n\n```\nslaptest -f /etc/ldap/slapd.conf -F /etc/ldap/slapd.d/\nchown -R openldap:openldap /etc/ldap/slapd.d\n```\n\n##### 7.OpenLdap\u30b5\u30fc\u30d3\u30b9\u8d77\u52d5\n\n```\nservice slapd start\n```\n\n* \u3053\u308c\u3067LDAP\u306eAttribute\u306b\u300csshPublicKey\u300d\u304c\u8868\u793a\u3055\u308c\u516c\u958b\u9375\u304c\u8ffd\u52a0\u3067\u304d\u308b\n\n#### LDAP\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u306e\u8a2d\u5b9a\n\n* sshd\u304cLDAP\u30b5\u30fc\u30d0\u306eSSH\u516c\u958b\u9375\u3092\u53d6\u5f97\u3059\u308b\u3088\u3046\u306b\u3059\u308b\u8a2d\u5b9a\u624b\u9806\n\n##### 1.LDAP\u30b5\u30fc\u30d0\u304b\u3089SSH\u516c\u958b\u9375\u3092\u53d6\u5f97\u3059\u308b\u30b9\u30af\u30ea\u30d7\u30c8\n\n* \u3084\u3063\u3066\u3044\u308b\u3053\u3068\u306fLDAP\u30b5\u30fc\u30d0\u306b\u63a5\u7d9a\u3057\u3066\u300cldapsearch\u300d\u306e\u7d50\u679c\u304b\u3089\u516c\u958b\u9375\u3060\u3051\u62bd\u51fa\n\n```\nvi /opt/ssh-command/LdapGetSSHKey.sh\n------------------------------------------------------------\n#!/bin/bash\n\nuri=ldap://<LDAP-SERVER>\nbinddn=\"<BIND-USER>\"\nbindpw=<PASSWORD>\nbase=\"<BASE>\"\nuid=$1\n\nldapsearch -LLL -H ${uri} -w \"${bindpw}\" -D \"${binddn}\" -b \"${base}\" \"(& (objectClass=posixAccount) (uid=${uid}))\" \"sshPublicKey\" | sed -ne '2,$p' | sed -e 's/sshPublicKey: //g' | sed -e 's/^ //g' | tr -d '\\n'\n------------------------------------------------------------\n```\n\n##### 2.sshd\u306b\u8a8d\u8a3c\u30b3\u30de\u30f3\u30c9\u306e\u8a2d\u5b9a\n\n```\nvi /etc/ssh/sshd_config\n------------------------------------------------------------\nAuthorizedKeysCommand /opt/ssh-command/LdapGetSSHKey.sh\nAuthorizedKeysCommandUser root\n------------------------------------------------------------\n```\n\n#### \u203b\u53c2\u8003\nhttp://makaaso.hatenablog.com/entry/2015/12/10/145442\n"}