{"context": "\n\n\u306f\u3058\u3081\u306b\n\u82e5\u5e72\u30bf\u30a4\u30c8\u30eb\u8a50\u6b3a\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3059\u304c\u3001\u7d50\u8ad6\u304b\u3089\u8a00\u3046\u3068\u307e\u3060\u30b5\u30fc\u30d3\u30b9\u904b\u7528\u958b\u59cb\u306b\u306f\u81f3\u3063\u3066\u3044\u307e\u305b\u3093\u3002 \n\u672c\u5f53\u306a\u3089\u3001\u5b9f\u969b\u306b\u3053\u3046\u3044\u3046\u3075\u3046\u306b\u904b\u7528\u3057\u3066\u3044\u308b\u3088\uff01\u3068\u3044\u3046\u60c5\u5831\u3092\u767a\u4fe1\u3067\u304d\u308c\u3070\u3088\u304b\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u307e\u3060\u7d4c\u9a13\u5024\u304c\u8db3\u3089\u306a\u3044\u3068\u3044\u3046\u7d50\u8ad6\u306b\u81f3\u308a\u307e\u3057\u305f\u3002\n\n\u3053\u308c\u3092\u66f8\u3044\u305f\u7d4c\u7def\n\n\nAmazon EC2 Container Service(ECS)\u3067\u30b5\u30fc\u30d3\u30b9\u904b\u7528\u3092\u3057\u305f\u3044\u3068\u601d\u3063\u3066\u30b0\u30b0\u3063\u3066\u307f\u305f\n\u308f\u308a\u3068\u305f\u304f\u3055\u3093\u60c5\u5831\u304c\u51fa\u3066\u304f\u308b\u306f\u51fa\u3066\u304f\u308b\u3093\u3060\u3051\u3069\u3001\u30b5\u30f3\u30d7\u30eb\u3092\u52d5\u304b\u3057\u3066\u307f\u305f\u3068\u304b\u7c21\u5358\u306a\u7d39\u4ecb\u306e\u307f\u306b\u7d42\u59cb\u3057\u3066\u3044\u308b\u3082\u306e\u304c\u591a\u304f\u3066\u3001\u5177\u4f53\u7684\u306a\u5b9f\u88c5\u4f8b\u306b\u8a00\u53ca\u3057\u3066\u3044\u308b\u3082\u306e\u306f\u3042\u307e\u308a\u306a\u304b\u3063\u305f\uff08\u3082\u3057\u304f\u306f\u898b\u3064\u3051\u3089\u308c\u306a\u304b\u3063\u305f\uff09\n\u5b9f\u969b\u306b\u30b5\u30fc\u30d3\u30b9\u3067\u904b\u7528\u3067\u304d\u308b\uff08\u304f\u3089\u3044\u306e\uff09\u74b0\u5883\u3092\u69cb\u7bc9\u3059\u308b\u305f\u3081\u306b\u306f\u3044\u308d\u3044\u308d\u3068\u8a66\u884c\u932f\u8aa4\u3059\u308b\u5fc5\u8981\u304c\u3042\u3063\u305f\n\u4eca\u5f8c\u540c\u3058\u3088\u3046\u306b\u8abf\u67fb\u3059\u308b\u4eba\u305f\u3061\u306e\u5f79\u306b\u7acb\u3064\u304b\u3068\u601d\u3044\u8a18\u4e8b\u306b\u3057\u3066\u307f\u305f \u2190\u4eca\u30b3\u30b3\n\n\n\u8a18\u4e8b\u3092\u8aad\u3080\u306b\u3042\u305f\u3063\u3066\n\u3053\u306e\u8a18\u4e8b\u4e2d\u3067\u306f\u3001\u4ee5\u4e0b\u306e\u524d\u63d0\u77e5\u8b58\u304c\u5fc5\u8981\u3068\u306a\u308a\u307e\u3059\u3002\u7279\u306b\u8aac\u660e\u306f\u884c\u3063\u3066\u3044\u306a\u3044\u306e\u3067\u3054\u4e86\u627f\u304f\u3060\u3055\u3044\u3002\n\nDocker\u305d\u306e\u3082\u306e\u306e\u77e5\u8b58\n\ndocker\u30b3\u30de\u30f3\u30c9\u306e\u4f7f\u7528\u65b9\u6cd5\n\nawscli\u306e\u4f7f\u7528\u65b9\u6cd5\n\n\nECS\u3067\u306a\u306b\u304c\u3067\u304d\u308b\u304b\u3001\u3067\u304d\u306a\u3044\u304b\n\nECS\u3068\u306f\u3001Amazon Web Service\u304c\u63d0\u4f9b\u3059\u308bDocker\u7528\u306e\u30aa\u30fc\u30b1\u30b9\u30c8\u30ec\u30fc\u30b7\u30e7\u30f3\u30c4\u30fc\u30eb\u306e1\u3064\n\n\n\u540c\u69d8\u306e\u30b5\u30fc\u30d3\u30b9\u3068\u3057\u3066\u306f\u3001Kubernetes\u3001Docker Swarm\u3001\u307b\u304b\u306b\u3082\u3044\u308d\u3044\u308d\n\n\nDocker\u30b3\u30f3\u30c6\u30ca\u306e\u8d77\u52d5\u65b9\u6cd5\u3084\u30b3\u30f3\u30c6\u30ca\u9593\u306e\u9023\u643a\u65b9\u6cd5\u3092\u5b9a\u7fa9\u3067\u304d\u308b\nDocker\u30b3\u30f3\u30c6\u30ca\u306e\u8d77\u52d5\u72b6\u614b\u3092\u8868\u793a\u3001\u5909\u66f4\u3067\u304d\u308b\n\n\n\u30b0\u30e9\u30d5\u30a3\u30ab\u30eb\u306b\u53ef\u8996\u5316\u3057\u3066\u304f\u308c\u308b\u308f\u3051\u3067\u306f\u306a\u3044\u306e\u3067\u3001\u5fc5\u8981\u3067\u3042\u308c\u3070\u81ea\u5206\u3067\u53ef\u8996\u5316\u30c4\u30fc\u30eb\u3092\u5c0e\u5165\u3057\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\n\n\n\u53e4\u3044\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u65b0\u3057\u3044\u30b3\u30f3\u30c6\u30ca\u3078\u306e\u5207\u308a\u66ff\u3048\u3092\u3001\u30c0\u30a6\u30f3\u30bf\u30a4\u30e0\u306a\u3057\u3067\u5b9f\u73fe\u3067\u304d\u308b\n\n\n\u3044\u308f\u3086\u308bBlue Green Deployment\n\n\n\n\nECS\u3067\u5fc5\u8981\u3068\u306a\u308b\u77e5\u8b58\n\nDocker\u306e\u77e5\u8b58\u5168\u822c\n\ndocker\u30b3\u30de\u30f3\u30c9\u306e\u4f7f\u7528\u65b9\u6cd5\n\n\nECS\u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9\u3092\u30dd\u30c1\u30dd\u30c1\u3084\u308b\u3060\u3051\u306a\u3089\u4e0d\u8981\u3067\u3059\u304c\u3001\u5b9f\u969b\u306b\u306fssh\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u30b3\u30de\u30f3\u30c9\u3092\u53e9\u304b\u306a\u3044\u3068\u4f55\u304c\u8d77\u304d\u3066\u3044\u308b\u304b\u5206\u304b\u3089\u306a\u3044\u3053\u3068\u304c\u3088\u304f\u3042\u308a\u307e\u3057\u305f\n\n\n\n\nECS\u3067\u5b9f\u65bd\u3059\u308b\u4f5c\u696d\u30d5\u30ed\u30fc\n\nCluster\u3092\u5b9a\u7fa9\n\n\n0\u500b\u4ee5\u4e0a\u306eContainer Instance\u3067\u69cb\u6210\u3055\u308c\u308b\n\n\nContainer Instance\u3092\u8d77\u52d5\n\n\n\u30b3\u30f3\u30c6\u30ca\u304c\u8d77\u52d5\u3059\u308bEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u8d77\u52d5\u3059\u308b\n\u3069\u306eCluster\u306b\u5c5e\u3059\u308b\u304b\u3092\u6307\u5b9a\u3059\u308b\n\n\nTask Definition\u3092\u5b9a\u7fa9\n\n\n1\u3064\u3001\u307e\u305f\u306f\u8907\u6570\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u305f\u3081\u306e\u5b9a\u7fa9\u3092\u8a18\u8ff0\u3059\u308b\n\u540c\u4e00Task Definition\u5185\u306e\u30b3\u30f3\u30c6\u30ca\u9593\u540c\u58eb\u306f\u304a\u4e92\u3044\u306b\u901a\u4fe1\u304c\u53ef\u80fd\n\u5185\u5bb9\u306f\u30ea\u30d3\u30b8\u30e7\u30f3\u3054\u3068\u306b\u4fdd\u6301\u3055\u308c\u3066\u304a\u308a\u3001\u5909\u66f4\u3059\u308b\u3068\u30ea\u30d3\u30b8\u30e7\u30f3\u304c\u4e0a\u304c\u308b\n\n\nService\u3092\u5b9a\u7fa9\n\n\nTask Definition\u306e\u7279\u5b9a\u30ea\u30d3\u30b8\u30e7\u30f3\u3092\u6307\u5b9a\u3059\u308b\n\u5e0c\u671b\u3059\u308b\u8d77\u52d5\u500b\u6570\u3092\u6307\u5b9a\u3059\u308b\n\u5fc5\u8981\u306a\u3089\u3070ELB\u3068\u306e\u95a2\u9023\u4ed8\u3051\u3092\u884c\u3046\n\n\n\n\n\u69cb\u6210\u306e\u8a2d\u8a08\n\u4ee5\u4e0b\u3067\u69cb\u6210\u3055\u308c\u308b\u3001\u6bd4\u8f03\u7684\u30b7\u30f3\u30d7\u30eb\u306a\u30b5\u30fc\u30d3\u30b9\u3092\u904b\u7528\u3059\u308b\u3053\u3068\u3092\u60f3\u5b9a\u3057\u307e\u3059\u3002\n\u5b9f\u969b\u306b\u306f\u3082\u3046\u5c11\u3057\u8907\u96d1\u306a\u69cb\u6210\u3067\u3042\u308b\u5834\u5408\u304c\u591a\u3044\u3068\u601d\u3044\u307e\u3059\u304c\u3001\u4e0b\u8a18\u306e\u5ef6\u9577\u3067\u8003\u3048\u308c\u3070 \n\n\u30b5\u30fc\u30d3\u30b9\u306e\u69cb\u6210\n\nELB\n\n\napache+app\n\n\n\u8907\u6570\u3067\u69cb\u6210\u3055\u308c\u308b\n\n\n\n\nredis\n\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u69cb\u6210\n\n\napp\n\nRoR\u30d9\u30fc\u30b9\u306eWEB\u30a2\u30d7\u30ea\u306e\u30b3\u30f3\u30c6\u30ca\nunicorn\u304c\u8d77\u52d5\u3059\u308b\n\u30b3\u30f3\u30c6\u30ca\u8d77\u52d5\u9ad8\u901f\u5316\u306e\u305f\u3081\u3001\u4e8b\u524d\u306bassets precompile\u3092\u3057\u305f\u3082\u306e\u3092\u30a4\u30e1\u30fc\u30b8\u5316\u3059\u308b\n\nDockerfile\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u611f\u3058\n\nDockerfile\nFROM ruby:2.2\n\nCOPY Gemfile Gemfile\nCOPY Gemfile.lock Gemfile.lock\nCOPY vendor/gems vendor/gems\n\nRUN apt-get update \\\n && apt-get install -y --no-install-recommends build-essential \\\n && mkdir -p /app/public\n\nWORKDIR /app\nRUN bundle install --without test:development\nCOPY . .\nRUN RAILS_ENV=$RAILS_ENV DB_ADAPTER=nulldb bundle exec rake assets:precompile # assets precompile\u6642\u306bDB\u63a5\u7d9a\u3057\u3088\u3046\u3068\u3059\u308b\u306e\u3092\u56de\u907f\u3059\u308b\u305f\u3081nulldb\u3092\u4f7f\u7528\n\nEXPOSE 3000\nVOLUME [\"/app/public\"]\nENTRYPOINT [\"bundle\", \"exec\", \"unicorn_rails\", \"-E\", $RAILS_ENV, \"-c\", \"config/unicorn.rb\"]\n\n\n\n\n\n\napache\n\napp\u306e\u524d\u6bb5\u306b\u3042\u305f\u308b\u30b3\u30f3\u30c6\u30ca\napache\uff0b\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u69cb\u6210\napp\u3068\u306e\u901a\u4fe1\u306fmod_proxy\u3067\u884c\u3046\n\nDockerfile\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u611f\u3058\n\nDockerfile\nFROM debian:jessie\n\nRUN apt-get update \\\n && apt-get install -y --no-install-recommends apache2\n && mkdir /var/www/public\n && a2enmod proxy \\\n            proxy_http\n\nCOPY sites-available/* /etc/apache2/sites-available/\nEXPOSE 80\nENTRYPOINT [\"/usr/sbin/apache2ctl\", \"-D\", \"FOREGROUND\"]\n\n\n\n\n\n\nredis\n\n\u30c7\u30fc\u30bf\u4e00\u6642\u8a18\u61b6\u5834\u6240\u3068\u3057\u3066\u5229\u7528\n\n\u8a73\u3057\u304f\u306f\u5f8c\u8ff0\u3057\u307e\u3059\u304c\u3001\u672c\u6765\u306f\u30b5\u30fc\u30d3\u30b9\u306e\u5b89\u5b9a\u6027\u3092\u8003\u616e\u3057\u3066\u8907\u6570\u30b3\u30f3\u30c6\u30ca\u3067\u5197\u9577\u5316\u3092\u3057\u3066\u304a\u304f\u304b\u3001Amazon ElastiCache\u306a\u3069\u306e\u30b5\u30fc\u30d3\u30b9\u3092\u5229\u7528\u3059\u308b\u306e\u304c\u9069\u5207\u3060\u3068\u601d\u3044\u307e\u3059\u304c\u3001\u4eca\u56de\u306e\u30c6\u30fc\u30de\u306e\u4e3b\u773c\u3067\u306f\u306a\u3044\u306e\u3067\u7c21\u6613\u306a\u69cb\u6210\u3068\u3057\u3066\u3044\u307e\u3059\n\n\u6a19\u6e96\u30b3\u30f3\u30c6\u30ca\u3092\u5229\u7528\u3059\u308b\u306e\u3067Dockerfile\u306f\u306a\u3057\n\n\n\n\nECS\u306e\u8a2d\u5b9a\n\n\u30af\u30e9\u30b9\u30bf\u306e\u4f5c\u6210\n\u4eca\u56de\u306fdefault\u3068\u3044\u3046\u540d\u524d\u306e\u30af\u30e9\u30b9\u30bf\u3092\u7528\u3044\u308b\u3082\u306e\u3068\u3057\u307e\u3059\u3002\u81ea\u5206\u3067\u4f5c\u6210\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n\nEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u8d77\u52d5\nECS\u306fEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4e0a\u3067\u5404\u30b3\u30f3\u30c6\u30ca\u3092\u5b9f\u884c\u3057\u307e\u3059\u304c\u3001\u305d\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u306fECS Agent\u3068\u3044\u3046\u30c7\u30fc\u30e2\u30f3\u30d7\u30ed\u30b0\u30e9\u30e0\u304c\u8d77\u52d5\u3057\u3066\u3044\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u65e2\u5b58\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306bECS Agent\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u308b\u3088\u3046\u3067\u3059\u304c\u3001ECS\u7528\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3068\u3057\u3066\u3059\u3067\u306b\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3055\u308c\u305fAMI\u304cAmazon\u304b\u3089\u63d0\u4f9b\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u3053\u3061\u3089\u3092\u5229\u7528\u3057\u3066\u65b0\u898f\u306b\u8d77\u52d5\u3059\u308b\u306e\u304c\u7c21\u5358\u304b\u3068\u601d\u3044\u307e\u3059\u3002\n\u5229\u7528\u53ef\u80fd\u306aAMI\u306e\u4e00\u89a7\u306f\u3053\u3061\u3089\u304b\u3089\u53c2\u7167\u3067\u304d\u307e\u3059\u3002\u81ea\u5206\u306eregion\u306b\u3042\u3063\u305fAMI\u3092\u9078\u3073\u307e\u3057\u3087\u3046\u3002\n\u4e0a\u8a18\u3067\u9078\u3093\u3060AMI\u3092\u6307\u5b9a\u3057\u3066\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u8d77\u52d5\u3059\u308b\u306e\u3067\u3059\u304c\u3001\u3044\u304f\u3064\u304b\u6ce8\u610f\u70b9\u304c\u3042\u308a\u307e\u3059\u3002\n\n\nUserData\u3067\u30af\u30e9\u30b9\u30bf\u6307\u5b9a\u3092\u884c\u3046\n\n\n\u4ee5\u4e0b\u306e\u5165\u529b\u3092\u3057\u3066\u304a\u304f\u3002default\u306e\u90e8\u5206\u306f\u5fc5\u8981\u306a\u3089\u7f6e\u304d\u63db\u3048\u308b\n#!/bin/bash\necho ECS_CLUSTER=default >> /etc/ecs/ecs.config\n\n\n\n\n\nECS\u306b\u5bfe\u3059\u308b\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\u306aIAM Role\u3092\u5272\u308a\u5f53\u3066\u308b\n\n\nAmazonEC2ContainerServiceforEC2Role\u3068\u3044\u3046\u30dd\u30ea\u30b7\u30fc\u3092attach\u3057\u305fRole\u3092\u4f5c\u6210\u3057\u3066\u304a\u304f\n\n\u30dd\u30ea\u30b7\u30fc\u306e\u5185\u5bb9\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308b\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"ecs:CreateCluster\",\n        \"ecs:DeregisterContainerInstance\",\n        \"ecs:DiscoverPollEndpoint\",\n        \"ecs:Poll\",\n        \"ecs:RegisterContainerInstance\",\n        \"ecs:StartTelemetrySession\",\n        \"ecs:Submit*\",\n        \"ecr:GetAuthorizationToken\",\n        \"ecr:BatchCheckLayerAvailability\",\n        \"ecr:GetDownloadUrlForLayer\",\n        \"ecr:BatchGetImage\",\n        \"logs:CreateLogStream\",\n        \"logs:PutLogEvents\"\n      ],\n      \"Resource\": \"*\"\n    }\n  ]\n}\n\n\n\n\n\nssh\u30ed\u30b0\u30a4\u30f3\u3092\u53ef\u80fd\u3068\u3059\u308b\n\n\u5fc5\u9808\u3067\u306f\u306a\u3044\u304c\u3001docker\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3067\u304d\u305f\u307b\u3046\u304c\u4fbf\u5229\u306a\u306e\u3067\u500b\u4eba\u7684\u306b\u30aa\u30b9\u30b9\u30e1\n\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\u306722\u756a\u30dd\u30fc\u30c8\u3092\u958b\u3051\u3066\u304a\u304f\u3001\u9069\u5207\u306aKeypair\u3092\u9078\u629e\u3057\u3066\u304a\u304f\u3001\u306a\u3069\n\n\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u8d77\u52d5\u5f8c\u3001\u30b3\u30f3\u30c6\u30ca\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4e00\u89a7\u306b\u542b\u307e\u308c\u3066\u3044\u308c\u3070\u6210\u529f\u3067\u3059\u3002\n$ aws --region ap-northeast-1 ecs list-container-instances --cluster default\n{\n  \"containerInstanceArns\": [\n    \"arn:aws:ecs:ap-northeast-1:NNNNNNNNNNNN:container-instance/aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaa\", \n  ]\n}\n\n\nTask Definition\u306e\u4f5c\u6210\n\u30b3\u30f3\u30c6\u30ca\u306e\u8d77\u52d5\u65b9\u6cd5\u3092Task Definition\u3068\u3057\u3066\u767b\u9332\u3057\u307e\u3059\u3002\nTask Definition\u306f\u3042\u304f\u307e\u3067\u30bf\u30b9\u30af\u306e\u5f62\u5f0f\u3092\u767b\u9332\u3059\u308b\u3060\u3051\u3067\u3001\u3053\u308c\u3060\u3051\u3067\u306f\u30b3\u30f3\u30c6\u30ca\u306f\u8d77\u52d5\u3057\u307e\u305b\u3093\u3002\n\u4eca\u56de\u306f\u4ee5\u4e0b\u306e\u69d8\u306aTask Definition\u5b9a\u7fa9\u3092\u3057\u307e\u3059\u3002\n\nweb-task\n\napp\u30b3\u30f3\u30c6\u30ca\u3068apache\u30b3\u30f3\u30c6\u30ca\u306e\u7d44\u307f\u5408\u308f\u305b\napache\u30b3\u30f3\u30c6\u30ca\u306f80\u756a\u30dd\u30fc\u30c8\u3067\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\u3068\u3059\u308b\n\n\n\nportMappings\u306e\u7b87\u6240\napache\u3068app\u306flinks\u3092\u5229\u7528\u3057\u3066\u901a\u4fe1\u53ef\u80fd\u306a\u306e\u3067\u3001app\u306e3000\u756a\u30dd\u30fc\u30c8\u306fportMappings\u3067\u306e\u958b\u653e\u306f\u3057\u306a\u304f\u3066\u3088\u3044\uff08\u3057\u3066\u3082\u3044\u3044\u3051\u3069\uff09\n\n\napache\u306fapp\u306b\u5bfe\u3057\u3066\u901a\u4fe1\u53ef\u80fd\u3067\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\n\n\n\nlinks\u306e\u7b87\u6240\u3067\u3001app\u3068\u3044\u3046\u30db\u30b9\u30c8\u540d\u3067web-app\u30b3\u30f3\u30c6\u30ca\u306b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u308b\n\nenvironments\u306e\u7b87\u6240\u3067\u3001PROXY_PASS\u3068\u3057\u3066app:3000\u3068\u3044\u3046\u5024\u3092\u30bb\u30c3\u30c8\u3057\u3066\u304a\u308a\u3001apache\u306emod_proxy\u8a2d\u5b9a\u306b\u3088\u3063\u3066\u3053\u306e\u74b0\u5883\u5909\u6570\u3092\u53c2\u7167\u3057\u3066\u3044\u308b\n\n\napache\u306fapp\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u53c2\u7167\u53ef\u80fd\u3067\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\n\n\nassets\u30d5\u30a1\u30a4\u30eb\u306fapache\u304c\u76f4\u63a5\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u3059\u308b\u305f\u3081\n\nvolumes, mountPoints\u306e\u7b87\u6240\n\n\napp\u306fredis\u306b\u5bfe\u3057\u3066\u901a\u4fe1\u53ef\u80fd\u3067\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\n\n\n\nenvironments\u306e\u7b87\u6240\u3067\u3001DOCKER_REDIS_HOST\u3068\u3057\u3066\u30b3\u30f3\u30c6\u30ca\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306eIP\u30a2\u30c9\u30ec\u30b9\u3092\u76f4\u63a5\u6307\u5b9a\u3059\u308b\n\u306a\u304a\u3001\u3053\u308c\u306f\u9650\u5b9a\u7684\u306a\u5bfe\u5fdc\u3067\u3042\u308a\u3001\u672c\u6765\u306a\u3089\u3070\u5f8c\u8ff0\u3059\u308bService Discovery\u306e\u4ed5\u7d44\u307f\u3092\u69cb\u7bc9\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\n\n\n\n\nweb-task.json\n{\n  \"taskDefinitionArn\": \"arn:aws:ecs:ap-northeast-1:NNNNNNNNNNNN:task-definition/web-task:1\",\n  \"revision\": 1,\n  \"containerDefinitions\": [\n    {\n      \"volumesFrom\": [],\n      \"memory\": 256,\n      \"extraHosts\": null,\n      \"dnsServers\": null,\n      \"disableNetworking\": null,\n      \"dnsSearchDomains\": null,\n      \"portMappings\": [\n        {\n          \"hostPort\": 80,\n          \"containerPort\": 80,\n          \"protocol\": \"tcp\"\n        }\n      ],\n      \"hostname\": null,\n      \"essential\": true,\n      \"entryPoint\": null,\n      \"mountPoints\": [\n        {\n          \"containerPath\": \"/var/www/public\",\n          \"sourceVolume\": \"assets_data\",\n          \"readOnly\": null\n        }\n      ],\n      \"name\": \"web-apache\",\n      \"ulimits\": null,\n      \"dockerSecurityOptions\": null,\n      \"environment\": [\n        {\n          \"name\": \"PROXY_PASS\",\n          \"value\": \"http://app:3000/\"\n        }\n      ],\n      \"links\": [\n        \"web-app:app\"\n      ],\n      \"workingDirectory\": null,\n      \"readonlyRootFilesystem\": null,\n      \"image\": \"YOUR_DOCKER_REPOS/apache\",\n      \"command\": null,\n      \"user\": null,\n      \"dockerLabels\": null,\n      \"logConfiguration\": null,\n      \"cpu\": 10,\n      \"privileged\": null\n    },\n    {\n      \"volumesFrom\": [],\n      \"memory\": 1000,\n      \"extraHosts\": null,\n      \"dnsServers\": null,\n      \"disableNetworking\": null,\n      \"dnsSearchDomains\": null,\n      \"portMappings\": [],\n      \"hostname\": null,\n      \"essential\": true,\n      \"entryPoint\": [],\n      \"mountPoints\": [\n        {\n          \"containerPath\": \"/app/public\",\n          \"sourceVolume\": \"assets_data\",\n          \"readOnly\": null\n        }\n      ],\n      \"name\": \"web-app\",\n      \"ulimits\": null,\n      \"dockerSecurityOptions\": null,\n      \"environment\": [\n        {\n          \"name\": \"RAILS_ENV\",\n          \"value\": \"production\"\n        },\n        {\n          \"name\": \"DOCKER_REDIS_HOST\",\n          \"value\": \"10.11.20.30\"\n        }\n      ],\n      \"links\": null,\n      \"workingDirectory\": null,\n      \"readonlyRootFilesystem\": null,\n      \"image\": \"YOUR_DOCKER_REPOS/app\",\n      \"command\": null,\n      \"user\": null,\n      \"dockerLabels\": null,\n      \"logConfiguration\": null,\n      \"cpu\": 50,\n      \"privileged\": null\n    }\n  ],\n  \"volumes\": [\n    {\n      \"host\": {\n        \"sourcePath\": \"assets_data\"\n      },\n      \"name\": \"assets_data\"\n    }\n  ],\n  \"family\": \"web\"\n}\n\n\n\nredis-task\n\nredis\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\n\u30c7\u30fc\u30bf\u30b9\u30c8\u30ec\u30fc\u30b8\u306f\u6c38\u7d9a\u5316\u3059\u308b\n\n\n\nmountPoints\u306e\u7b87\u6240\n\n\n\n\nredis-task.json\n{\n  \"taskDefinitionArn\": \"arn:aws:ecs:ap-northeast-1:NNNNNNNNNNNN:task-definition/redis-task:1\",\n  \"revision\": 1,\n  \"containerDefinitions\": [\n    {\n      \"volumesFrom\": [],\n      \"memory\": 512,\n      \"extraHosts\": null,\n      \"dnsServers\": null,\n      \"disableNetworking\": null,\n      \"dnsSearchDomains\": null,\n      \"portMappings\": [\n        {\n          \"hostPort\": 6379,\n          \"containerPort\": 6379,\n          \"protocol\": \"tcp\"\n        }\n      ],\n      \"hostname\": null,\n      \"essential\": true,\n      \"entryPoint\": null,\n      \"mountPoints\": [\n        {\n          \"containerPath\": \"/data\",\n          \"sourceVolume\": \"redis_data\",\n          \"readOnly\": null\n        }\n      ],\n      \"name\": \"redis\",\n      \"ulimits\": null,\n      \"dockerSecurityOptions\": null,\n      \"environment\": [],\n      \"links\": null,\n      \"workingDirectory\": null,\n      \"readonlyRootFilesystem\": null,\n      \"image\": \"redis:2.8\",\n      \"command\": null,\n      \"user\": null,\n      \"dockerLabels\": null,\n      \"logConfiguration\": null,\n      \"cpu\": 10,\n      \"privileged\": null\n    }\n  ],\n  \"volumes\": [\n    {\n      \"host\": {\n        \"sourcePath\": \"redis_data\"\n      },\n      \"name\": \"redis_data\"\n    }\n  ],\n  \"family\": \"redis\"\n}\n\n\n\nService\u306e\u4f5c\u6210\nTask Definition\u3092\u3069\u308c\u304f\u3089\u3044\u8d77\u52d5\u3059\u308b\u304b\u3001\u3092\u5b9a\u7fa9\u3059\u308b\u306e\u304cService\u3067\u3059\u3002\n\u3053\u308c\u3092\u767b\u9332\u3059\u308b\u3068\u3001\u6307\u5b9a\u3057\u305f\u6570\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3057\u3088\u3046\u3068\u3057\u307e\u3059\u3002\n\u305f\u3060\u3057\u3001\u7af6\u5408\u30ea\u30bd\u30fc\u30b9\u306e\u78ba\u4fdd\u3068\u3044\u3046\u6982\u5ff5\u304c\u3042\u3063\u3066\u3001\u3053\u308c\u304c\u7af6\u5408\u3059\u308b\u30b3\u30f3\u30c6\u30ca\u306f\u540c\u4e00\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3067\u306f\u8d77\u52d5\u3057\u307e\u305b\u3093\u3002\n\u4f8b\u3048\u3070\u3001web\u306f\u30db\u30b9\u30c8\u5074\u306e80\u756a\u30dd\u30fc\u30c8\u3092\u958b\u653e\u3059\u308b\u30b3\u30f3\u30c6\u30ca\u3092\u542b\u3080\u30bf\u30b9\u30af\u5b9a\u7fa9\u306a\u306e\u3067\u30011\u3064\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u6700\u59271\u3064\u307e\u3067\u3057\u304b\u8d77\u52d5\u3067\u304d\u307e\u305b\u3093\u3002\u8907\u6570\u306e\u30b3\u30f3\u30c6\u30ca\u304c\u5fc5\u8981\u306a\u3089\u3001\u305d\u306e\u3076\u3093\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3082\u8d77\u52d5\u3057\u3066\u304a\u304f\u5fc5\u8981\u304c\u3042\u308b\u308f\u3051\u3067\u3059\u3002\n\u4ed6\u306b\u3082\u3001\u30b3\u30f3\u30c6\u30ca\u306b\u5272\u308a\u5f53\u3066\u308b\u30e1\u30e2\u30ea\u3084CPU\u3068\u3044\u3063\u305f\u8981\u7d20\u3082\u30ea\u30bd\u30fc\u30b9\u306e\u4e00\u90e8\u306a\u306e\u3067\u3001\u3053\u308c\u304c\u4e0d\u8db3\u3059\u308b\u3088\u3046\u306a\u3089\u3070\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u8ffd\u52a0\u3092\u884c\u308f\u306a\u3044\u3068\u3001\u30b3\u30f3\u30c6\u30ca\u306f\u8d77\u52d5\u3055\u308c\u307e\u305b\u3093\u3002\n\u307e\u305fService\u306b\u306f\u3001Minimum healthy percent\u3068Maximum percent\u3068\u3044\u3046\u8a2d\u5b9a\u304c\u3042\u308b\u306e\u3067\u3059\u304c\u3001\u3053\u308c\u306b\u3064\u3044\u3066\u306f\u5f8c\u8ff0\u306eBlue Green Deployment\u3067\u8aac\u660e\u3057\u307e\u3059\u3002\n\u4e0b\u8a18\u3067\u306f\u3068\u308a\u3042\u3048\u305a\u3001\u305d\u308c\u305e\u308c50, 100\u3092\u6307\u5b9a\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\nweb-service\n\n\u30b3\u30f3\u30c6\u30ca\u65701\u3067\u8d77\u52d5\nELB\u3068\u306e\u95a2\u9023\u4ed8\u3051\u3092\u884c\u3046\n\n\nweb-service.json\n{\n  \"taskDefinition\": \"arn:aws:ecs:us-northeast-1:NNNNNNNNNNNN:task-definition/web-task:1\",\n  \"loadBalancers\": [\n    {\n      \"containerName\": \"web-apache\",\n      \"containerPort\": 80,\n      \"loadBalancerName\": \"your-elb-name-here\"\n    }\n  ],\n  \"role\": \"ecsServiceRole\",\n  \"desiredCount\": 1,\n  \"serviceName\": \"web-service\",\n  \"cluster\": \"default\",\n  \"deploymentConfiguration\": {\n    \"maximumPercent\": 100,\n    \"minimumHealthyPercent\": 50\n  }\n}\n\n\n\nredis-service\n\n\u30b3\u30f3\u30c6\u30ca\u65701\u3067\u8d77\u52d5\n\n\nredis-service.json\n{\n  \"taskDefinition\": \"arn:aws:ecs:ap-northeast-1:NNNNNNNNNNNN:task-definition/redis-task:1\",\n  \"role\": \"ecsServiceRole\",\n  \"desiredCount\": 1,\n  \"serviceName\": \"redis-service\",\n  \"cluster\": \"default\",\n  \"deploymentConfiguration\": {\n    \"maximumPercent\": 100,\n    \"minimumHealthyPercent\": 50\n  }\n}\n\n\n\n\u52d5\u4f5c\u78ba\u8a8d\n\nawscli\u304b\u3089\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3001desiredCount=runningCount\u306b\u306a\u3063\u3066\u3044\u308c\u3070\u5e0c\u671b\u901a\u308a\u30b3\u30f3\u30c6\u30ca\u304c\u8d77\u52d5\u3057\u3066\u3044\u307e\u3059\u3002\npendingCount\u304c1\u4ee5\u4e0a\u3067\u3042\u308c\u3070\u3001\u4eca\u307e\u3055\u306b\u8d77\u52d5\u4e2d\u3068\u3044\u3046\u72b6\u6cc1\u306a\u306e\u3067\u5c11\u3057\u5f85\u3061\u307e\u3057\u3087\u3046\u3002\n$ aws ecs --region ap-northeast-1 describe-services --cluster default --services web-service redis-service | jq '.services[] | {serviceName, status, desiredCount, pendingCount, runningCount}'\n{\n  \"serviceName\": \"web-service\",\n  \"status\": \"ACTIVE\",\n  \"desiredCount\": 1,\n  \"pendingCount\": 0,\n  \"runningCount\": 1\n}\n{\n  \"serviceName\": \"redis-service\",\n  \"status\": \"ACTIVE\",\n  \"desiredCount\": 1,\n  \"pendingCount\": 0,\n  \"runningCount\": 1\n}\n\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304b\u3089\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306bssh\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u3066\u304a\u3051\u3070\u3001\u5f8c\u306f\u901a\u5e38\u901a\u308adocker\u30b3\u30de\u30f3\u30c9\u304c\u4f7f\u3048\u307e\u3059\u3002\n$ ssh -i your-keypair-file ec2-user@container-instnce-ip\nLast login: Mon Jun  6 08:32:06 2016 from 1.2.3.4\n\n   __|  __|  __|\n   _|  (   \\__ \\   Amazon ECS-Optimized Amazon Linux AMI 2016.03.c\n ____|\\___|____/\n\nFor documentation visit, http://aws.amazon.com/documentation/ecs\n3 package(s) needed for security, out of 4 available\nRun \"sudo yum update\" to apply all updates.\n[ec2-user@ip-11-22-33-44 ~]$ docker ps\nCONTAINER ID        IMAGE                                                                COMMAND                  CREATED             STATUS              PORTS                        NAMES\n-snip-\n1e288e62a5d1        amazon/amazon-ecs-agent:latest                                       \"/agent\"                 3 days ago          Up 3 days           127.0.0.1:51678->51678/tcp   ecs-agent\n\n\n\u30c8\u30e9\u30d6\u30eb\u30b7\u30e5\u30fc\u30c6\u30a3\u30f3\u30b0\n\nrunningCount\u304c\u8db3\u308a\u306a\u3044\n\u3082\u3057\u3044\u3064\u307e\u3067\u7d4c\u3063\u3066\u3082runningCount\u304c0\u3067\u3042\u3063\u305f\u308adesiredCount\u672a\u6e80\u3067\u3042\u308b\u5834\u5408\u306f\u3001\u306a\u3093\u3089\u304b\u306e\u554f\u984c\u304c\u767a\u751f\u3057\u3066\u3044\u308b\u53ef\u80fd\u6027\u304c\u3042\u308a\u307e\u3059\u3002\n\u305d\u3046\u3044\u3046\u5834\u5408\u306f\u30a8\u30e9\u30fc\u304c\u51fa\u529b\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u78ba\u8a8d\u3057\u307e\u3059\u3002\n$ aws ecs --region ap-northeast-1 describe-services --cluster default --services web-service redis-service | jq '.services[].events[].message'\n\"(service web) was unable to place a task because no container instance met all of its requirements. The closest matching (container-instance 8f078cd3-40a7-4873-ae04-223a14c74b9e) has insufficient memory available. For more information, see the Troubleshooting section of the Amazon ECS Developer Guide.\"\n\n\u4e0a\u8a18\u4f8b\u3060\u3068\u3001\u7af6\u5408\u30ea\u30bd\u30fc\u30b9\u3068\u3057\u3066\u306e\u30e1\u30e2\u30ea\u304c\u3053\u308c\u4ee5\u4e0a\u5272\u308a\u5f53\u3066\u3067\u304d\u306a\u304b\u3063\u305f\u306e\u3067\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3067\u304d\u306a\u304b\u3063\u305f\u3053\u3068\u304c\u5206\u304b\u308a\u307e\u3059\u3002\n\u30e1\u30e2\u30ea\u8a2d\u5b9a\u3092\u5909\u66f4\u3059\u308b\u304b\u3001\u8ffd\u52a0\u3067\u30b3\u30f3\u30c6\u30ca\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u8d77\u52d5\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n\u30b3\u30f3\u30c6\u30ca\u306f\u8d77\u52d5\u3057\u3066\u3044\u308b\u304c\u3001\u3046\u307e\u304f\u901a\u4fe1\u3067\u304d\u3066\u3044\u306a\u3044\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8abf\u67fb\u5bfe\u8c61\u3092\u7d5e\u3063\u3066\u3044\u304f\u3068\u3088\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u30b3\u30f3\u30c6\u30ca\u81ea\u4f53\u306f\u6b63\u5e38\u306b\u52d5\u4f5c\u3057\u3066\u3044\u308b\u304b\uff1f\n\n\nssh\u30ed\u30b0\u30a4\u30f3\u3092\u53ef\u80fd\u306b\u3057\u3066\u3044\u308b\u306a\u3089\u3001\u30ed\u30b0\u30a4\u30f3\u5f8cdocker ps(or docker ps -a)\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u3066\u3001\u30b3\u30f3\u30c6\u30ca\u306e\u7a3c\u50cd\u72b6\u6cc1\u3092\u78ba\u8a8d\u3059\u308b\u3002\n\nportMappings\u3067\u30dd\u30fc\u30c8\u3092\u958b\u653e\u3057\u3066\u3044\u308b\u306a\u3089\u3001ELB\u3092\u7d4c\u7531\u3057\u306a\u3044\u3067\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u5bfe\u3057\u3066\u76f4\u63a5\u901a\u4fe1\u3057\u305f\u3089\u3069\u3046\u304b\uff1f\n\n\n\u5225\u9014\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\u3067\u30a2\u30af\u30bb\u30b9\u6a29\u9650\u3092\u4ed8\u4e0e\u3057\u3066\u304a\u304f\u5fc5\u8981\u304c\u3042\u308b\n\n\n\n\n\nweb-app\u306b\u554f\u984c\u304c\u3042\u308b\u306e\u304b\uff1f\n\n\nweb-app\u30b3\u30f3\u30c6\u30ca\u306b\u30a8\u30e9\u30fc\u30ed\u30b0\u304c\u51fa\u529b\u3055\u308c\u3066\u3044\u306a\u3044\u304b\u78ba\u8a8d\u3059\u308b\ncontainer-instance$ docker logs <web-app-container-id>\nI, [2016-06-03T10:26:15.859460 #1]  INFO -- : Refreshing Gem list\nI, [2016-06-03T10:26:28.349481 #1]  INFO -- : listening on addr=0.0.0.0:3000 fd=13\nI, [2016-06-03T10:26:28.354816 #1]  INFO -- : master process ready\nI, [2016-06-03T10:26:28.470681 #12]  INFO -- : worker=0 ready\n\n\n\nweb-app\u30b3\u30f3\u30c6\u30ca\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u3001unicorn\u3084RoR\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\ncontainer-instance$ docker exec -it <web-app-container-id> bash\nroot@web-app-container-id:/app# bundle exec rails console   # RoR\u304c\u52d5\u4f5c\u3057\u3066\u3044\u308b\u304b\nroot@web-app-container-id:/app# curl http://localhost:3000/ # unicorn\u304c\u52d5\u4f5c\u3057\u3066\u3044\u308b\u304b\nroot@web-app-container-id:/app# redis-cli -h $DOCKER_REDIS_HOST info # Redis\u3068\u306e\u901a\u4fe1\u304c\u3067\u304d\u3066\u3044\u308b\u304b\n\n\n\n\n\nweb-apache\u306b\u554f\u984c\u304c\u3042\u308b\u306e\u304b\uff1f\n\n\nweb-apache\u30b3\u30f3\u30c6\u30ca\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u3001proxy\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\ncontainer-instance$ docker exec -it <web-apache-container-id> bash\nroot@web-apache-container-id:/app# curl http://app:3000/     # web-app\u3068\u306e\u901a\u4fe1\u304c\u3067\u304d\u3066\u3044\u308b\u304b\nroot@web-apache-container-id:/app# curl http://localhost:80/ # web-app\u3068\u306eprox\uff59\u304c\u52d5\u4f5c\u3057\u3066\u3044\u308b\u304b\n\n\n\n\n\nELB\u3068\u30b3\u30f3\u30c6\u30ca\u306f\u6b63\u3057\u304f\u901a\u4fe1\u3067\u304d\u3066\u3044\u308b\u304b\uff1f\n\nELB\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u72b6\u614b\u3092\u78ba\u8a8d\u3057\u3001\u8a72\u5f53\u306e\u30b3\u30f3\u30c6\u30ca\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u5272\u308a\u5f53\u3066\u3089\u308c\u3066\u3044\u308b\u304b\uff1f\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u72b6\u614b\u306fHealthy\u304b\uff1f\n\n\n\n\n\nBlue Green Deployment\u306e\u65b9\u6cd5\nECS\u3067Blue Green Deployment\u3092\u5b9f\u65bd\u3059\u308b\u305f\u3081\u306b\u306f\u3001Service\u306e\u8a2d\u5b9a\u3067\u3042\u308bMinimum healthy percent\u3068Maximum percent\u3092\u7406\u89e3\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u304c\u3001\u3068\u308a\u3042\u3048\u305a\u30b7\u30f3\u30d7\u30eb\u304b\u3064\u6700\u5c0f\u69cb\u6210\u3067\u5b9f\u73fe\u3059\u308b\u306a\u3089\u3070\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3059\u308c\u3070OK\u3067\u3059\u3002\n\u5185\u5bb9\u306b\u3064\u3044\u3066\u8a73\u3057\u3044\u8aac\u660e\u306f\u3053\u3061\u3089\u304c\u53c2\u8003\u306b\u306a\u308a\u307e\u3059\u3002\n\u4e0b\u8a18\u306e\u4f8b\u3067\u306f\u30012\u53f0\u306e\u30b3\u30f3\u30c6\u30ca\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306bweb-task\u304c1\u3064\u305a\u3064\u8d77\u52d5\u3057\u3066\u3044\u308b\u30b3\u30f3\u30c6\u30ca\u69cb\u6210\u3067\u3042\u308b\u3082\u306e\u3068\u3057\u3066\u3044\u307e\u3059\u3002\n\u307e\u305f\u3001\u30c7\u30d7\u30ed\u30a4\u6642\u306b\u306f\u4e00\u6642\u7684\u306b\u8d77\u52d5\u30b3\u30f3\u30c6\u30ca\u6570\u304c1\u3064\u307e\u3067\u4e0b\u304c\u308b\u3053\u3068\u3092\u8a31\u5bb9\u3059\u308b\u3082\u306e\u3068\u3057\u307e\u3059\u3002\n\n\u4e8b\u524d\u6e96\u5099\n\n\u30af\u30e9\u30b9\u30bf\u5185\u306e\u30b3\u30f3\u30c6\u30ca\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306f2\u53f0\u306b\u3057\u3066\u304a\u304f\nService web-service\u306eMinimum healthy percent\u309250\u3001Maximum percent\u3092100\u306b\u3059\u308b\n\n\n\u30c7\u30d7\u30ed\u30a4\u6642\u306e\u4f5c\u696d\u3068\u6d41\u308c\nTask Definition\u306e\u5185\u5bb9\u3092\u5909\u66f4\u3057\u305f\u5834\u5408\u3001\u5909\u66f4\u3092Service\u306b\u53cd\u6620\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u306a\u304a\u3001Task Definition\u306e\u5909\u66f4\u3092\u4f34\u308f\u306a\u3044\u3088\u3046\u306a\u904b\u7528\uff08Docker\u30a4\u30e1\u30fc\u30b8\u3092\u66f4\u65b0\u3057\u3066\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3057\u305f\u306e\u3067\u3001\u30b3\u30f3\u30c6\u30ca\u3092\u518d\u5ea6\u8d77\u52d5\u3057\u76f4\u305b\u3070\u3088\u3044\u3001\u3068\u3044\u3046\u3088\u3046\u306a\u30b1\u30fc\u30b9\uff09\u3082\u3042\u308a\u5f97\u308b\u3068\u601d\u3044\u307e\u3059\u304c\u3001\u305d\u306e\u5834\u5408\u3082\u4e0b\u8a18\u306e\u30d5\u30ed\u30fc\u3067  \u304b\u3068\u601d\u3044\u307e\u3059\u3002\u7121\u99c4\u306bTask Definition\u3092\u5909\u66f4\u3059\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u304c\u3001\u30d5\u30ed\u30fc\u304c\u5358\u7d14\u306b\u306a\u308b\u3068\u3044\u3046\u5229\u70b9\u304c\u3042\u308a\u307e\u3059\u306e\u3067\u3002\n\n\u4f5c\u696d\u5185\u5bb9\n\n\nweb-task:1\u3092\u518d\u767b\u9332\u3059\u308b\u3068\u3001\u30ea\u30d3\u30b8\u30e7\u30f3\u304c\u30a4\u30f3\u30af\u30ea\u30e1\u30f3\u30c8\u3055\u308cweb-task:2\u304c\u767b\u9332\u3055\u308c\u308b\n\nweb-service\u306b\u95a2\u9023\u4ed8\u3051\u3089\u308c\u3066\u3044\u308bweb-task:1\u3092web-task:2\u306b\u5909\u66f4\u3059\u308b\n\n\nECS\u4e0a\u306e\u52d5\u304d\n\n\nweb-task:1\u00d72\u306e\u72b6\u614b\u306b\u306a\u3063\u3066\u3044\u308b\n\nweb-task:1\u00d71\u304c\u505c\u6b62\u3059\u308b\u304c\u3001\u5168\u30b3\u30f3\u30c6\u30ca\u500b\u6570\u306e\u3046\u3061\u534a\u5206\uff08\u3064\u307e\u308a1\u53f0\uff09\u306fweb-task:1\u00d71\u304c\u6b8b\u308b\n\nweb-task:1\u00d71\u304c\u505c\u6b62\u3057\u3001\u4ee3\u308f\u308a\u306bweb-task:2\u00d71\u304c\u8d77\u52d5\u3059\u308b\n\nweb-task:1\u00d71\u3001web-task:2\u00d71\u306e\u72b6\u614b\u306b\u306a\u308b\n\nweb-task:1\u00d71\u304c\u518d\u5ea6\u505c\u6b62\u3057\u3001\u3053\u308c\u3067web-task:2\u00d71\u306e\u307f\u306e\u72b6\u614b\u306b\u306a\u308b\n\nweb-task:2\u00d71\u304c\u8d77\u52d5\u3057\u3001\u3053\u308c\u3067web-task:2\u00d72\u306e\u72b6\u614b\u306b\u306a\u308b\n\n\u5168\u30b3\u30f3\u30c6\u30ca\u306e\u3046\u3061\u534a\u5206\u304cweb-task:1\u306e\u307e\u307e\u6b8b\u308b\u3068\u3044\u3046\u306e\u306f\u3001Minimum healthy percent\u304c50\u3067\u3042\u308b\u3053\u3068\u306b\u8d77\u56e0\u3057\u307e\u3059\u3002\n\nECS\u30ce\u30a6\u30cf\u30a6\n\u3082\u3057\u304b\u3059\u308b\u3068\u30ce\u30a6\u30cf\u30a6\u3068\u3044\u3046\u307b\u3069\u3067\u306f\u306a\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u304c\u3001\u6700\u521d\u7406\u89e3\u3057\u306b\u304f\u3044\u7b87\u6240\u304c\u3042\u3063\u305f\u306e\u3067\u66f8\u3044\u3066\u304a\u304d\u307e\u3059\u3002\n\n\u767b\u9332\u6e08\u306eTask Definition\u3092\u5909\u66f4\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u305a\u3001\u30ea\u30d3\u30b8\u30e7\u30f3\u3092\u5909\u3048\u3066\u518d\u767b\u9332\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\n\u306a\u3093\u3068\u306a\u304f\u3001update-task-definition\u7684\u306a\u3053\u3068\u304c\u3067\u304d\u305d\u3046\u306a\u6c17\u304c\u3057\u307e\u3059\u304c\u3001register-task-definition\u3057\u304b\u5b58\u5728\u3057\u307e\u305b\u3093\u3002\n\u65e2\u5b58\u306eTask Definition\u306b\u5bfe\u3057\u3066\u518d\u767b\u9332\u3059\u308b\u3068\u3001\u30ea\u30d3\u30b8\u30e7\u30f3\u304c\u30a4\u30f3\u30af\u30ea\u30e1\u30f3\u30c8\u3055\u308c\u307e\u3059\u3002\n\nTask Definition\u3092\u518d\u767b\u9332\u3057\u3066\u3082Service\u306b\u306f\u53cd\u6620\u3055\u308c\u306a\u3044\n\u524d\u8ff0\u306e\u901a\u308a\u3001Task Definition\u3092\u518d\u767b\u9332\u3057\u305f\u5834\u5408\u30ea\u30d3\u30b8\u30e7\u30f3\u304c\u30a4\u30f3\u30af\u30ea\u30e1\u30f3\u30c8\u3055\u308c\u307e\u3059\u304c\u3001Service\u306f\u30ea\u30d3\u30b8\u30e7\u30f3\u4ed8\u304d\u3067Task Definition\u3092\u53c2\u7167\u3057\u3066\u3044\u308b\u306e\u3067\u3001\u305d\u306e\u307e\u307e\u3067\u306f\u306a\u306b\u3082\u8d77\u304d\u307e\u305b\u3093\u3002\nupdate-service\u3067\u95a2\u9023\u4ed8\u3051\u3089\u308c\u305f\u30ea\u30d3\u30b8\u30e7\u30f3\u3092\u66f4\u65b0\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\nService\u3092\u524a\u9664\u3059\u308b\u306b\u306f\u30b3\u30f3\u30c6\u30ca\u3092\u505c\u6b62\u3057\u3066\u304a\u304b\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\ndelete-service\u3057\u3088\u3046\u3068\u3059\u308b\u3068\nA client error (InvalidParameterException) occurred when calling the DeleteService operation: The service cannot be stopped while the primary deployment is scaled above 0.\n\n\u306e\u3088\u3046\u306b\u6012\u3089\u308c\u3066\u3057\u307e\u3046\u3053\u3068\u304c\u3042\u308a\u307e\u3059\u3002\u3053\u308c\u306f\u3059\u3067\u306b\u30b3\u30f3\u30c6\u30ca\u304c\u8d77\u52d5\u3057\u3066\u3044\u308b\u5834\u5408\u306f\u524a\u9664\u3067\u304d\u306a\u3044\u305f\u3081\u3067\u3059\u3002\n\u3058\u3083\u3001stop-task\u3059\u308c\u3070\u3044\u3044\u3093\u3060\u306a\u3001\u3068\u601d\u3063\u3066\u505c\u6b62\u3055\u305b\u305f\u5f8c\u306b\u524a\u9664\u3057\u3088\u3046\u3068\u3057\u3066\u3082\u3001\u3044\u3064\u306e\u9593\u306b\u304bService\u304c\u30b3\u30f3\u30c6\u30ca\u3092\u81ea\u52d5\u7684\u306b\u8d77\u52d5\u3057\u3066\u304a\u308a\u3084\u3063\u3071\u308a\u3067\u304d\u306a\u3044\u3001\u3068\u306a\u308b\u3053\u3068\u304c\u591a\u3044\u3002\n\u6b63\u3057\u304f\u306f\u3001\u524d\u3082\u3063\u3066Service\u306edesiredCount\u30920\u306b\u3057\u3066\u304a\u3051\u3070\u305d\u308c\u4ee5\u4e0a\u30b3\u30f3\u30c6\u30ca\u306f\u81ea\u52d5\u8d77\u52d5\u3055\u308c\u306a\u3044\u306e\u3067\u3001\u30b3\u30f3\u30c6\u30ca\u304c\u3059\u3079\u3066\u505c\u6b62\u3057\u3066\u304b\u3089\u524a\u9664\u3059\u308c\u3070OK\u3002\n\n\u6ce8\u610f\u70b9\u3001\u8981\u6539\u5584\n\u73fe\u6642\u70b9\u3067\u306f\u3001\u4ee5\u4e0b\u306e\u554f\u984c\u304c\u89e3\u6d88\u3055\u308c\u3066\u3044\u307e\u305b\u3093\u3002\n\n\nRedis\u306e\u30c7\u30fc\u30bf\u30b9\u30c8\u30ec\u30fc\u30b8\u5834\u6240\nredis-task\u306b\u3088\u3063\u3066\u30b9\u30c8\u30ec\u30fc\u30b8\u306f\u6c38\u7d9a\u5316\u306e\u8a2d\u5b9a\u3092\u3057\u307e\u3057\u305f\u3002\u3053\u308c\u306b\u3088\u308a\u3001redis-task\u30b3\u30f3\u30c6\u30ca\u304c\u306a\u3093\u3089\u304b\u306e\u7406\u7531\u3067\u505c\u6b62\u3057\u3066\u3082\u3001\u6b21\u306b\u8d77\u52d5\u3057\u305fredis-task\u30b3\u30f3\u30c6\u30ca\u3067\u3082\u30c7\u30fc\u30bf\u5185\u5bb9\u306f\u5f15\u304d\u7d99\u304c\u308c\u308b\u306e\u3067\u3001\u6d88\u5931\u3059\u308b\u3053\u3068\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\u305f\u3060\u3057\u3053\u308c\u306f\u3001\u540c\u4e00\u30b3\u30f3\u30c6\u30ca\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4e0a\u3067\u8d77\u52d5\u3057\u305f\u306a\u3089\u3070\u3001\u3068\u3044\u3046\u524d\u63d0\u6761\u4ef6\u304c\u4ed8\u304d\u307e\u3059\u3002\n\u30b9\u30c8\u30ec\u30fc\u30b8\u306e\u672c\u4f53\u306f\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4e0a\u306b\u5b58\u5728\u3057\u3066\u3044\u308b\u305f\u3081\u3001\u5225\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3068\u306f\u5171\u6709\u3055\u308c\u306a\u3044\u305f\u3081\u3067\u3059\u3002\n\u3082\u3057redis-task\u30b3\u30f3\u30c6\u30ca\u304c\u505c\u6b62\u5f8c\u306b\u518d\u5ea6\u8d77\u52d5\u3055\u308c\u308b\u969b\u3001\u305f\u307e\u305f\u307e\u5225\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4e0a\u3067\u8d77\u52d5\u3055\u308c\u305f\u306a\u3089\u3070\u3001\u30c7\u30fc\u30bf\u306f\u6d88\u5931\u3059\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\u3053\u308c\u3092\u907f\u3051\u308b\u305f\u3081\u306b\u306f\u3001redis-task\u30b3\u30f3\u30c6\u30ca\u304c\u8d77\u52d5\u3059\u308b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u56fa\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u304c\u3001Service\u3092\u7528\u3044\u308b\u5834\u5408\u306f\u8d77\u52d5\u3059\u308b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u6307\u5b9a\u3059\u308b\u65b9\u6cd5\u304c\u898b\u5f53\u305f\u308a\u307e\u305b\u3093\u3067\u3057\u305f\u3002\nstart-task\u306b\u306f\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u6307\u5b9a\u3059\u308b\u624b\u6cd5\u304c\u3042\u308b\u306e\u3067\u3059\u304c\u3001\u3053\u308c\u3060\u3068\u30b3\u30f3\u30c6\u30ca\u304c\u306a\u3093\u3089\u304b\u306e\u7406\u7531\u3067\u505c\u6b62\u3057\u3066\u3082\u518d\u958b\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093\u3002\n\u7d50\u5c40\u3001Redis\u306b\u3064\u3044\u3066\u306fElastiCache\u306e\u3088\u3046\u306a\u5916\u90e8\u30b5\u30fc\u30d3\u30b9\u3092\u4f7f\u3046\u3079\u304d\u306a\u306e\u304b\u306a\u3042\u3001\u3068\u3044\u3046\u306e\u304c\u4eca\u306e\u5370\u8c61\u3067\u3059\u3002\n\n\nService Discovery\u306e\u65b9\u6cd5\nweb-task\u304b\u3089redis-task\u306b\u63a5\u7d9a\u3059\u308b\u305f\u3081\u306b\u306fIP\u30a2\u30c9\u30ec\u30b9\u3092\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u304c\u3001\u3053\u306eIP\u30a2\u30c9\u30ec\u30b9\u306f\u30b3\u30f3\u30c6\u30ca\u5185\u306e\u3082\u306e\u3067\u306f\u306a\u304f\u3001\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u81ea\u4f53\u306e\u3082\u306e\u3067\u306a\u3051\u308c\u3070\u306a\u308a\u307e\u305b\u3093\u3002\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u8907\u6570\u5b58\u5728\u3059\u308b\u5834\u5408\u3001\u5b9b\u5148\u3068\u306a\u308b\u30a2\u30c9\u30ec\u30b9\u306f\u4e00\u610f\u306b\u306f\u5b9a\u307e\u3089\u306a\u3044\u306e\u3067\u52d5\u7684\u306b\u6c7a\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u306e\u3067\u3059\u304c\u3001ECS\u3067\u306f\u3053\u308c\u306f\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u3066\u3044\u307e\u305b\u3093\u3002\n\u4e16\u306e\u4e2d\u306b\u306f\u3044\u308d\u3093\u306aService Discovery\u306e\u624b\u6cd5\u304c\u3042\u308b\u3068\u601d\u3044\u307e\u3059\u304c\u3001Consul\u304c\u4e00\u756a\u5229\u7528\u3057\u3084\u3059\u3044\u3088\u3046\u306b\u611f\u3058\u307e\u3057\u305f\u3002\n\nSwap\u30e1\u30e2\u30ea\u304c\u5229\u7528\u3067\u304d\u306a\u3044\n\u524d\u8ff0\u306e\u901a\u308a\u3001ECS\u3067\u306f\u7af6\u5408\u30ea\u30bd\u30fc\u30b9\u306e1\u3064\u3068\u3057\u3066\u30e1\u30e2\u30ea\u5272\u5f53\u91cf\u304c\u3042\u308b\u308f\u3051\u3067\u3059\u304c\u3001\u5236\u9650\u4e8b\u9805\u3068\u3057\u3066Swap\u30e1\u30e2\u30ea\u3092\u5229\u7528\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u306a\u304f\u306a\u3063\u3066\u3044\u307e\u3059\u3002\nECS\u306f\u5404\u30b3\u30f3\u30c6\u30ca\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30e1\u30e2\u30ea\u7a7a\u304d\u5bb9\u91cf\u3092\u628a\u63e1\u3057\u3066\u3044\u307e\u3059\u304c\u3001\u3053\u308c\u306b\u306fSwap\u30e1\u30e2\u30ea\u3076\u3093\u306f\u542b\u307e\u308c\u306a\u3044\u306e\u3067\u3059\u3002\n\u3055\u3089\u306b\u3001Task Definition\u3067\u306f\u30e1\u30e2\u30ea\u5272\u308a\u5f53\u3066\u91cf\u6307\u5b9a\u304c\u5fc5\u9808\u3068\u306a\u3063\u3066\u304a\u308a\u3001\u30b3\u30f3\u30c6\u30ca\u5185\u3067\u306f\u3053\u308c\u3092\u8d85\u3048\u305f\u30b5\u30a4\u30ba\u306e\u30e1\u30e2\u30ea\u78ba\u4fdd\u306f\u3067\u304d\u307e\u305b\u3093\uff08\u5f53\u305f\u308a\u524d\u3067\u3059\u304c\uff09\u3002\n\u7d50\u679c\u3068\u3057\u3066\u3001\u30b3\u30f3\u30c6\u30ca\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306bSwap\u304c\u3042\u308d\u3046\u304c\u306a\u304b\u308d\u3046\u304c\u5229\u7528\u53ef\u80fd\u306a\u30e1\u30e2\u30ea\u5bb9\u91cf\u306f\u7269\u7406\u30e1\u30e2\u30ea\u306e\u307f\u3067\u3042\u308a\u3001\u304b\u3064\u5272\u308a\u5f53\u3066\u6307\u5b9a\u304c\u5fc5\u9808\u3067\u3042\u308b\u305f\u3081\u3001\u7269\u7406\u30e1\u30e2\u30ea\u4ee5\u4e0a\u306e\u30e1\u30e2\u30ea\u78ba\u4fdd\u306f\u4e0d\u53ef\u80fd\u3068\u3044\u3046\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\u7d20\u306eDocker\u306a\u3089\u30e1\u30e2\u30ea\u5272\u308a\u5f53\u3066\u91cf\u306f\u30aa\u30d7\u30b7\u30e7\u30f3\u6271\u3044\u3067\u3001\u7701\u7565\u6642\u306f\u30e1\u30e2\u30ea\u78ba\u4fdd\u306e\u30b5\u30a4\u30ba\u5236\u9650\u306f\u30db\u30b9\u30c8\u5074\u306eSwap\u30e1\u30e2\u30ea\u3092\u542b\u3081\u305f\u30e1\u30e2\u30ea\u5bb9\u91cf\u306b\u5f93\u3044\u307e\u3059\u3002\u306a\u306e\u3067\u3001\u7269\u7406\u30e1\u30e2\u30ea\u4ee5\u4e0a\u306e\u30e1\u30e2\u30ea\u3092\u78ba\u4fdd\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\nSwap\u30e1\u30e2\u30ea\u304c\u4e00\u5207\u4f7f\u3048\u306a\u3044\u3068\u3044\u3046\u306e\u306f\u3001\u5834\u5408\u306b\u3088\u3063\u3066\u306f\u304d\u3064\u3044\u5236\u9650\u306b\u306a\u308a\u305d\u3046\u3067\u3059\u3002\n\u5b9f\u969b\u306b\u81ea\u5206\u306e\u74b0\u5883\u3067\u306f\u3001\u901a\u5e38\u306f\u305d\u3053\u307e\u3067\u3067\u3082\u306a\u3044\u304c\u3001\u4e00\u6642\u7684\u306b\u7269\u7406\u30e1\u30e2\u30ea\u3092\u8d85\u3048\u3066\u30e1\u30e2\u30ea\u3092\u78ba\u4fdd\u3057\u3088\u3046\u3068\u3059\u308b\u30d7\u30ed\u30b0\u30e9\u30e0\u304c\u52d5\u4f5c\u3057\u3066\u3044\u308b\u30b5\u30fc\u30d0\u304c\u3042\u308b\u306e\u3067\u3001\u3053\u308c\u3092ECS\u3067\u904b\u7528\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u306a\u3044\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\u3053\u308c\u3092\u554f\u984c\u8996\u3057\u3066\u3044\u308b\u4eba\u305f\u3061\u306f\u3084\u306f\u308a\u3044\u308b\u3088\u3046\u3067Issue\u304c\u4f5c\u3089\u308c\u3066\u304a\u308a\u3001\u305f\u304f\u3055\u3093\u306e+1\u30b3\u30e1\u30f3\u30c8\u304c\u4ed8\u3051\u3089\u308c\u3066\u3044\u307e\u3059\u304c\u3001\u4eca\u306e\u3068\u3053\u308d\u6539\u5584\u3055\u308c\u308b\u6c17\u914d\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n# \u306f\u3058\u3081\u306b\n\n\u82e5\u5e72\u30bf\u30a4\u30c8\u30eb\u8a50\u6b3a\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3059\u304c\u3001\u7d50\u8ad6\u304b\u3089\u8a00\u3046\u3068\u307e\u3060\u30b5\u30fc\u30d3\u30b9\u904b\u7528\u958b\u59cb\u306b\u306f\u81f3\u3063\u3066\u3044\u307e\u305b\u3093\u3002 :wink:\n\u672c\u5f53\u306a\u3089\u3001\u5b9f\u969b\u306b\u3053\u3046\u3044\u3046\u3075\u3046\u306b\u904b\u7528\u3057\u3066\u3044\u308b\u3088\uff01\u3068\u3044\u3046\u60c5\u5831\u3092\u767a\u4fe1\u3067\u304d\u308c\u3070\u3088\u304b\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u307e\u3060\u7d4c\u9a13\u5024\u304c\u8db3\u3089\u306a\u3044\u3068\u3044\u3046\u7d50\u8ad6\u306b\u81f3\u308a\u307e\u3057\u305f\u3002\n\n# \u3053\u308c\u3092\u66f8\u3044\u305f\u7d4c\u7def\n\n1. [Amazon EC2 Container Service(ECS)](https://aws.amazon.com/jp/ecs/)\u3067\u30b5\u30fc\u30d3\u30b9\u904b\u7528\u3092\u3057\u305f\u3044\u3068\u601d\u3063\u3066\u30b0\u30b0\u3063\u3066\u307f\u305f\n1. \u308f\u308a\u3068\u305f\u304f\u3055\u3093\u60c5\u5831\u304c\u51fa\u3066\u304f\u308b\u306f\u51fa\u3066\u304f\u308b\u3093\u3060\u3051\u3069\u3001\u30b5\u30f3\u30d7\u30eb\u3092\u52d5\u304b\u3057\u3066\u307f\u305f\u3068\u304b\u7c21\u5358\u306a\u7d39\u4ecb\u306e\u307f\u306b\u7d42\u59cb\u3057\u3066\u3044\u308b\u3082\u306e\u304c\u591a\u304f\u3066\u3001\u5177\u4f53\u7684\u306a\u5b9f\u88c5\u4f8b\u306b\u8a00\u53ca\u3057\u3066\u3044\u308b\u3082\u306e\u306f\u3042\u307e\u308a\u306a\u304b\u3063\u305f\uff08\u3082\u3057\u304f\u306f\u898b\u3064\u3051\u3089\u308c\u306a\u304b\u3063\u305f\uff09\n1. \u5b9f\u969b\u306b\u30b5\u30fc\u30d3\u30b9\u3067\u904b\u7528\u3067\u304d\u308b\uff08\u304f\u3089\u3044\u306e\uff09\u74b0\u5883\u3092\u69cb\u7bc9\u3059\u308b\u305f\u3081\u306b\u306f\u3044\u308d\u3044\u308d\u3068\u8a66\u884c\u932f\u8aa4\u3059\u308b\u5fc5\u8981\u304c\u3042\u3063\u305f\n1. \u4eca\u5f8c\u540c\u3058\u3088\u3046\u306b\u8abf\u67fb\u3059\u308b\u4eba\u305f\u3061\u306e\u5f79\u306b\u7acb\u3064\u304b\u3068\u601d\u3044\u8a18\u4e8b\u306b\u3057\u3066\u307f\u305f \u2190\u4eca\u30b3\u30b3\n\n# \u8a18\u4e8b\u3092\u8aad\u3080\u306b\u3042\u305f\u3063\u3066\n\n\u3053\u306e\u8a18\u4e8b\u4e2d\u3067\u306f\u3001\u4ee5\u4e0b\u306e\u524d\u63d0\u77e5\u8b58\u304c\u5fc5\u8981\u3068\u306a\u308a\u307e\u3059\u3002\u7279\u306b\u8aac\u660e\u306f\u884c\u3063\u3066\u3044\u306a\u3044\u306e\u3067\u3054\u4e86\u627f\u304f\u3060\u3055\u3044\u3002\n\n- Docker\u305d\u306e\u3082\u306e\u306e\u77e5\u8b58\n- `docker`\u30b3\u30de\u30f3\u30c9\u306e\u4f7f\u7528\u65b9\u6cd5\n- [awscli](https://aws.amazon.com/jp/cli/)\u306e\u4f7f\u7528\u65b9\u6cd5\n\n# ECS\u3067\u306a\u306b\u304c\u3067\u304d\u308b\u304b\u3001\u3067\u304d\u306a\u3044\u304b\n\n- ECS\u3068\u306f\u3001Amazon Web Service\u304c\u63d0\u4f9b\u3059\u308bDocker\u7528\u306e\u30aa\u30fc\u30b1\u30b9\u30c8\u30ec\u30fc\u30b7\u30e7\u30f3\u30c4\u30fc\u30eb\u306e1\u3064\n    - \u540c\u69d8\u306e\u30b5\u30fc\u30d3\u30b9\u3068\u3057\u3066\u306f\u3001[Kubernetes](http://kubernetes.io/)\u3001[Docker Swarm](https://docs.docker.com/swarm/)\u3001\u307b\u304b\u306b\u3082\u3044\u308d\u3044\u308d\n- Docker\u30b3\u30f3\u30c6\u30ca\u306e\u8d77\u52d5\u65b9\u6cd5\u3084\u30b3\u30f3\u30c6\u30ca\u9593\u306e\u9023\u643a\u65b9\u6cd5\u3092\u5b9a\u7fa9\u3067\u304d\u308b\n- Docker\u30b3\u30f3\u30c6\u30ca\u306e\u8d77\u52d5\u72b6\u614b\u3092\u8868\u793a\u3001\u5909\u66f4\u3067\u304d\u308b\n    - \u30b0\u30e9\u30d5\u30a3\u30ab\u30eb\u306b\u53ef\u8996\u5316\u3057\u3066\u304f\u308c\u308b\u308f\u3051\u3067\u306f\u306a\u3044\u306e\u3067\u3001\u5fc5\u8981\u3067\u3042\u308c\u3070\u81ea\u5206\u3067\u53ef\u8996\u5316\u30c4\u30fc\u30eb\u3092\u5c0e\u5165\u3057\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\n- \u53e4\u3044\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u65b0\u3057\u3044\u30b3\u30f3\u30c6\u30ca\u3078\u306e\u5207\u308a\u66ff\u3048\u3092\u3001\u30c0\u30a6\u30f3\u30bf\u30a4\u30e0\u306a\u3057\u3067\u5b9f\u73fe\u3067\u304d\u308b\n    - \u3044\u308f\u3086\u308bBlue Green Deployment\n\n# ECS\u3067\u5fc5\u8981\u3068\u306a\u308b\u77e5\u8b58\n\n- Docker\u306e\u77e5\u8b58\u5168\u822c\n- `docker`\u30b3\u30de\u30f3\u30c9\u306e\u4f7f\u7528\u65b9\u6cd5\n    - ECS\u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9\u3092\u30dd\u30c1\u30dd\u30c1\u3084\u308b\u3060\u3051\u306a\u3089\u4e0d\u8981\u3067\u3059\u304c\u3001\u5b9f\u969b\u306b\u306fssh\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u30b3\u30de\u30f3\u30c9\u3092\u53e9\u304b\u306a\u3044\u3068\u4f55\u304c\u8d77\u304d\u3066\u3044\u308b\u304b\u5206\u304b\u3089\u306a\u3044\u3053\u3068\u304c\u3088\u304f\u3042\u308a\u307e\u3057\u305f\n\n# ECS\u3067\u5b9f\u65bd\u3059\u308b\u4f5c\u696d\u30d5\u30ed\u30fc\n\n1. Cluster\u3092\u5b9a\u7fa9\n    - 0\u500b\u4ee5\u4e0a\u306eContainer Instance\u3067\u69cb\u6210\u3055\u308c\u308b\n1. Container Instance\u3092\u8d77\u52d5\n    - \u30b3\u30f3\u30c6\u30ca\u304c\u8d77\u52d5\u3059\u308bEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u8d77\u52d5\u3059\u308b\n    - \u3069\u306eCluster\u306b\u5c5e\u3059\u308b\u304b\u3092\u6307\u5b9a\u3059\u308b\n1. Task Definition\u3092\u5b9a\u7fa9\n    - 1\u3064\u3001\u307e\u305f\u306f\u8907\u6570\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u305f\u3081\u306e\u5b9a\u7fa9\u3092\u8a18\u8ff0\u3059\u308b\n    - \u540c\u4e00Task Definition\u5185\u306e\u30b3\u30f3\u30c6\u30ca\u9593\u540c\u58eb\u306f\u304a\u4e92\u3044\u306b\u901a\u4fe1\u304c\u53ef\u80fd\n    - \u5185\u5bb9\u306f\u30ea\u30d3\u30b8\u30e7\u30f3\u3054\u3068\u306b\u4fdd\u6301\u3055\u308c\u3066\u304a\u308a\u3001\u5909\u66f4\u3059\u308b\u3068\u30ea\u30d3\u30b8\u30e7\u30f3\u304c\u4e0a\u304c\u308b\n1. Service\u3092\u5b9a\u7fa9\n    - Task Definition\u306e\u7279\u5b9a\u30ea\u30d3\u30b8\u30e7\u30f3\u3092\u6307\u5b9a\u3059\u308b\n    - \u5e0c\u671b\u3059\u308b\u8d77\u52d5\u500b\u6570\u3092\u6307\u5b9a\u3059\u308b\n    - \u5fc5\u8981\u306a\u3089\u3070ELB\u3068\u306e\u95a2\u9023\u4ed8\u3051\u3092\u884c\u3046\n\n# \u69cb\u6210\u306e\u8a2d\u8a08\n\n\u4ee5\u4e0b\u3067\u69cb\u6210\u3055\u308c\u308b\u3001\u6bd4\u8f03\u7684\u30b7\u30f3\u30d7\u30eb\u306a\u30b5\u30fc\u30d3\u30b9\u3092\u904b\u7528\u3059\u308b\u3053\u3068\u3092\u60f3\u5b9a\u3057\u307e\u3059\u3002\n\u5b9f\u969b\u306b\u306f\u3082\u3046\u5c11\u3057\u8907\u96d1\u306a\u69cb\u6210\u3067\u3042\u308b\u5834\u5408\u304c\u591a\u3044\u3068\u601d\u3044\u307e\u3059\u304c\u3001\u4e0b\u8a18\u306e\u5ef6\u9577\u3067\u8003\u3048\u308c\u3070 :ok_hand:\n\n## \u30b5\u30fc\u30d3\u30b9\u306e\u69cb\u6210\n\n- ELB\n    - apache+app\n        - \u8907\u6570\u3067\u69cb\u6210\u3055\u308c\u308b\n- redis\n\n## \u30b3\u30f3\u30c6\u30ca\u306e\u69cb\u6210\n\n- app\n    - RoR\u30d9\u30fc\u30b9\u306eWEB\u30a2\u30d7\u30ea\u306e\u30b3\u30f3\u30c6\u30ca\n    - unicorn\u304c\u8d77\u52d5\u3059\u308b\n    - \u30b3\u30f3\u30c6\u30ca\u8d77\u52d5\u9ad8\u901f\u5316\u306e\u305f\u3081\u3001\u4e8b\u524d\u306bassets precompile\u3092\u3057\u305f\u3082\u306e\u3092\u30a4\u30e1\u30fc\u30b8\u5316\u3059\u308b\n    - Dockerfile\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u611f\u3058\n\n        ```text:Dockerfile\n        FROM ruby:2.2\n\n        COPY Gemfile Gemfile\n        COPY Gemfile.lock Gemfile.lock\n        COPY vendor/gems vendor/gems\n        \n        RUN apt-get update \\\n         && apt-get install -y --no-install-recommends build-essential \\\n         && mkdir -p /app/public\n\n        WORKDIR /app\n        RUN bundle install --without test:development\n        COPY . .\n        RUN RAILS_ENV=$RAILS_ENV DB_ADAPTER=nulldb bundle exec rake assets:precompile # assets precompile\u6642\u306bDB\u63a5\u7d9a\u3057\u3088\u3046\u3068\u3059\u308b\u306e\u3092\u56de\u907f\u3059\u308b\u305f\u3081nulldb\u3092\u4f7f\u7528\n        \n        EXPOSE 3000\n        VOLUME [\"/app/public\"]\n        ENTRYPOINT [\"bundle\", \"exec\", \"unicorn_rails\", \"-E\", $RAILS_ENV, \"-c\", \"config/unicorn.rb\"]\n        ```\n- apache\n    - app\u306e\u524d\u6bb5\u306b\u3042\u305f\u308b\u30b3\u30f3\u30c6\u30ca\n    - apache\uff0b\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u69cb\u6210\n    - app\u3068\u306e\u901a\u4fe1\u306f`mod_proxy`\u3067\u884c\u3046\n    - Dockerfile\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u611f\u3058\n\n        ```text:Dockerfile\n        FROM debian:jessie\n        \n        RUN apt-get update \\\n         && apt-get install -y --no-install-recommends apache2\n         && mkdir /var/www/public\n         && a2enmod proxy \\\n                    proxy_http\n\n        COPY sites-available/* /etc/apache2/sites-available/\n        EXPOSE 80\n        ENTRYPOINT [\"/usr/sbin/apache2ctl\", \"-D\", \"FOREGROUND\"]\n        ```\n- redis\n    - \u30c7\u30fc\u30bf\u4e00\u6642\u8a18\u61b6\u5834\u6240\u3068\u3057\u3066\u5229\u7528\n    - [\u8a73\u3057\u304f\u306f\u5f8c\u8ff0](#redis-storage)\u3057\u307e\u3059\u304c\u3001\u672c\u6765\u306f\u30b5\u30fc\u30d3\u30b9\u306e\u5b89\u5b9a\u6027\u3092\u8003\u616e\u3057\u3066\u8907\u6570\u30b3\u30f3\u30c6\u30ca\u3067\u5197\u9577\u5316\u3092\u3057\u3066\u304a\u304f\u304b\u3001[Amazon ElastiCache](https://aws.amazon.com/jp/elasticache/)\u306a\u3069\u306e\u30b5\u30fc\u30d3\u30b9\u3092\u5229\u7528\u3059\u308b\u306e\u304c\u9069\u5207\u3060\u3068\u601d\u3044\u307e\u3059\u304c\u3001\u4eca\u56de\u306e\u30c6\u30fc\u30de\u306e\u4e3b\u773c\u3067\u306f\u306a\u3044\u306e\u3067\u7c21\u6613\u306a\u69cb\u6210\u3068\u3057\u3066\u3044\u307e\u3059\n    - [\u6a19\u6e96\u30b3\u30f3\u30c6\u30ca](https://hub.docker.com/_/redis/)\u3092\u5229\u7528\u3059\u308b\u306e\u3067Dockerfile\u306f\u306a\u3057\n\n# ECS\u306e\u8a2d\u5b9a\n\n## \u30af\u30e9\u30b9\u30bf\u306e\u4f5c\u6210\n\n\u4eca\u56de\u306f`default`\u3068\u3044\u3046\u540d\u524d\u306e\u30af\u30e9\u30b9\u30bf\u3092\u7528\u3044\u308b\u3082\u306e\u3068\u3057\u307e\u3059\u3002\u81ea\u5206\u3067\u4f5c\u6210\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n\n## EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u8d77\u52d5\n\nECS\u306fEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4e0a\u3067\u5404\u30b3\u30f3\u30c6\u30ca\u3092\u5b9f\u884c\u3057\u307e\u3059\u304c\u3001\u305d\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u306f[ECS Agent](http://docs.aws.amazon.com/AmazonECS/latest/developerguide/ECS_agent.html)\u3068\u3044\u3046\u30c7\u30fc\u30e2\u30f3\u30d7\u30ed\u30b0\u30e9\u30e0\u304c\u8d77\u52d5\u3057\u3066\u3044\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n\u65e2\u5b58\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306bECS Agent\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u308b\u3088\u3046\u3067\u3059\u304c\u3001ECS\u7528\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3068\u3057\u3066\u3059\u3067\u306b\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3055\u308c\u305fAMI\u304cAmazon\u304b\u3089\u63d0\u4f9b\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u3053\u3061\u3089\u3092\u5229\u7528\u3057\u3066\u65b0\u898f\u306b\u8d77\u52d5\u3059\u308b\u306e\u304c\u7c21\u5358\u304b\u3068\u601d\u3044\u307e\u3059\u3002\n\u5229\u7528\u53ef\u80fd\u306aAMI\u306e\u4e00\u89a7\u306f[\u3053\u3061\u3089](http://docs.aws.amazon.com/AmazonECS/latest/developerguide/container_agent_versions.html#ecs-optimized-ami-agent-versions)\u304b\u3089\u53c2\u7167\u3067\u304d\u307e\u3059\u3002\u81ea\u5206\u306eregion\u306b\u3042\u3063\u305fAMI\u3092\u9078\u3073\u307e\u3057\u3087\u3046\u3002\n\n\u4e0a\u8a18\u3067\u9078\u3093\u3060AMI\u3092\u6307\u5b9a\u3057\u3066\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u8d77\u52d5\u3059\u308b\u306e\u3067\u3059\u304c\u3001\u3044\u304f\u3064\u304b\u6ce8\u610f\u70b9\u304c\u3042\u308a\u307e\u3059\u3002\n\n- UserData\u3067\u30af\u30e9\u30b9\u30bf\u6307\u5b9a\u3092\u884c\u3046\n    - \u4ee5\u4e0b\u306e\u5165\u529b\u3092\u3057\u3066\u304a\u304f\u3002`default`\u306e\u90e8\u5206\u306f\u5fc5\u8981\u306a\u3089\u7f6e\u304d\u63db\u3048\u308b\n\n        ```bash\n        #!/bin/bash\n        echo ECS_CLUSTER=default >> /etc/ecs/ecs.config\n        ```\n- ECS\u306b\u5bfe\u3059\u308b\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\u306aIAM Role\u3092\u5272\u308a\u5f53\u3066\u308b\n    - `AmazonEC2ContainerServiceforEC2Role`\u3068\u3044\u3046\u30dd\u30ea\u30b7\u30fc\u3092attach\u3057\u305fRole\u3092\u4f5c\u6210\u3057\u3066\u304a\u304f\n    - \u30dd\u30ea\u30b7\u30fc\u306e\u5185\u5bb9\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308b\n\n        ```json\n        {\n          \"Version\": \"2012-10-17\",\n          \"Statement\": [\n            {\n              \"Effect\": \"Allow\",\n              \"Action\": [\n                \"ecs:CreateCluster\",\n                \"ecs:DeregisterContainerInstance\",\n                \"ecs:DiscoverPollEndpoint\",\n                \"ecs:Poll\",\n                \"ecs:RegisterContainerInstance\",\n                \"ecs:StartTelemetrySession\",\n                \"ecs:Submit*\",\n                \"ecr:GetAuthorizationToken\",\n                \"ecr:BatchCheckLayerAvailability\",\n                \"ecr:GetDownloadUrlForLayer\",\n                \"ecr:BatchGetImage\",\n                \"logs:CreateLogStream\",\n                \"logs:PutLogEvents\"\n              ],\n              \"Resource\": \"*\"\n            }\n          ]\n        }\n        ```\n- ssh\u30ed\u30b0\u30a4\u30f3\u3092\u53ef\u80fd\u3068\u3059\u308b\n    - \u5fc5\u9808\u3067\u306f\u306a\u3044\u304c\u3001`docker`\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3067\u304d\u305f\u307b\u3046\u304c\u4fbf\u5229\u306a\u306e\u3067\u500b\u4eba\u7684\u306b\u30aa\u30b9\u30b9\u30e1\n    - \u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\u306722\u756a\u30dd\u30fc\u30c8\u3092\u958b\u3051\u3066\u304a\u304f\u3001\u9069\u5207\u306aKeypair\u3092\u9078\u629e\u3057\u3066\u304a\u304f\u3001\u306a\u3069\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u8d77\u52d5\u5f8c\u3001\u30b3\u30f3\u30c6\u30ca\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4e00\u89a7\u306b\u542b\u307e\u308c\u3066\u3044\u308c\u3070\u6210\u529f\u3067\u3059\u3002\n\n```shell-session\n$ aws --region ap-northeast-1 ecs list-container-instances --cluster default\n{\n  \"containerInstanceArns\": [\n    \"arn:aws:ecs:ap-northeast-1:NNNNNNNNNNNN:container-instance/aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaa\", \n  ]\n}\n```\n\n## Task Definition\u306e\u4f5c\u6210\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u8d77\u52d5\u65b9\u6cd5\u3092Task Definition\u3068\u3057\u3066\u767b\u9332\u3057\u307e\u3059\u3002\nTask Definition\u306f\u3042\u304f\u307e\u3067\u30bf\u30b9\u30af\u306e\u5f62\u5f0f\u3092\u767b\u9332\u3059\u308b\u3060\u3051\u3067\u3001\u3053\u308c\u3060\u3051\u3067\u306f\u30b3\u30f3\u30c6\u30ca\u306f\u8d77\u52d5\u3057\u307e\u305b\u3093\u3002\n\n\u4eca\u56de\u306f\u4ee5\u4e0b\u306e\u69d8\u306aTask Definition\u5b9a\u7fa9\u3092\u3057\u307e\u3059\u3002\n\n### web-task\n\n- app\u30b3\u30f3\u30c6\u30ca\u3068apache\u30b3\u30f3\u30c6\u30ca\u306e\u7d44\u307f\u5408\u308f\u305b\n- apache\u30b3\u30f3\u30c6\u30ca\u306f80\u756a\u30dd\u30fc\u30c8\u3067\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\u3068\u3059\u308b\n    - `portMappings`\u306e\u7b87\u6240\n    - apache\u3068app\u306flinks\u3092\u5229\u7528\u3057\u3066\u901a\u4fe1\u53ef\u80fd\u306a\u306e\u3067\u3001app\u306e3000\u756a\u30dd\u30fc\u30c8\u306fportMappings\u3067\u306e\u958b\u653e\u306f\u3057\u306a\u304f\u3066\u3088\u3044\uff08\u3057\u3066\u3082\u3044\u3044\u3051\u3069\uff09\n- apache\u306fapp\u306b\u5bfe\u3057\u3066\u901a\u4fe1\u53ef\u80fd\u3067\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\n    - `links`\u306e\u7b87\u6240\u3067\u3001`app`\u3068\u3044\u3046\u30db\u30b9\u30c8\u540d\u3067web-app\u30b3\u30f3\u30c6\u30ca\u306b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u308b\n    - `environments`\u306e\u7b87\u6240\u3067\u3001`PROXY_PASS`\u3068\u3057\u3066`app:3000`\u3068\u3044\u3046\u5024\u3092\u30bb\u30c3\u30c8\u3057\u3066\u304a\u308a\u3001apache\u306emod_proxy\u8a2d\u5b9a\u306b\u3088\u3063\u3066\u3053\u306e\u74b0\u5883\u5909\u6570\u3092\u53c2\u7167\u3057\u3066\u3044\u308b\n- apache\u306fapp\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u53c2\u7167\u53ef\u80fd\u3067\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\n    - assets\u30d5\u30a1\u30a4\u30eb\u306fapache\u304c\u76f4\u63a5\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u3059\u308b\u305f\u3081\n    - `volumes`, `mountPoints`\u306e\u7b87\u6240\n- app\u306fredis\u306b\u5bfe\u3057\u3066\u901a\u4fe1\u53ef\u80fd\u3067\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\n    - `environments`\u306e\u7b87\u6240\u3067\u3001`DOCKER_REDIS_HOST`\u3068\u3057\u3066\u30b3\u30f3\u30c6\u30ca\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306eIP\u30a2\u30c9\u30ec\u30b9\u3092\u76f4\u63a5\u6307\u5b9a\u3059\u308b\n    - \u306a\u304a\u3001\u3053\u308c\u306f\u9650\u5b9a\u7684\u306a\u5bfe\u5fdc\u3067\u3042\u308a\u3001\u672c\u6765\u306a\u3089\u3070[\u5f8c\u8ff0\u3059\u308bService Discovery\u306e\u4ed5\u7d44\u307f\u3092\u69cb\u7bc9](#service-discovery)\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\n\n```json:web-task.json\n{\n  \"taskDefinitionArn\": \"arn:aws:ecs:ap-northeast-1:NNNNNNNNNNNN:task-definition/web-task:1\",\n  \"revision\": 1,\n  \"containerDefinitions\": [\n    {\n      \"volumesFrom\": [],\n      \"memory\": 256,\n      \"extraHosts\": null,\n      \"dnsServers\": null,\n      \"disableNetworking\": null,\n      \"dnsSearchDomains\": null,\n      \"portMappings\": [\n        {\n          \"hostPort\": 80,\n          \"containerPort\": 80,\n          \"protocol\": \"tcp\"\n        }\n      ],\n      \"hostname\": null,\n      \"essential\": true,\n      \"entryPoint\": null,\n      \"mountPoints\": [\n        {\n          \"containerPath\": \"/var/www/public\",\n          \"sourceVolume\": \"assets_data\",\n          \"readOnly\": null\n        }\n      ],\n      \"name\": \"web-apache\",\n      \"ulimits\": null,\n      \"dockerSecurityOptions\": null,\n      \"environment\": [\n        {\n          \"name\": \"PROXY_PASS\",\n          \"value\": \"http://app:3000/\"\n        }\n      ],\n      \"links\": [\n        \"web-app:app\"\n      ],\n      \"workingDirectory\": null,\n      \"readonlyRootFilesystem\": null,\n      \"image\": \"YOUR_DOCKER_REPOS/apache\",\n      \"command\": null,\n      \"user\": null,\n      \"dockerLabels\": null,\n      \"logConfiguration\": null,\n      \"cpu\": 10,\n      \"privileged\": null\n    },\n    {\n      \"volumesFrom\": [],\n      \"memory\": 1000,\n      \"extraHosts\": null,\n      \"dnsServers\": null,\n      \"disableNetworking\": null,\n      \"dnsSearchDomains\": null,\n      \"portMappings\": [],\n      \"hostname\": null,\n      \"essential\": true,\n      \"entryPoint\": [],\n      \"mountPoints\": [\n        {\n          \"containerPath\": \"/app/public\",\n          \"sourceVolume\": \"assets_data\",\n          \"readOnly\": null\n        }\n      ],\n      \"name\": \"web-app\",\n      \"ulimits\": null,\n      \"dockerSecurityOptions\": null,\n      \"environment\": [\n        {\n          \"name\": \"RAILS_ENV\",\n          \"value\": \"production\"\n        },\n        {\n          \"name\": \"DOCKER_REDIS_HOST\",\n          \"value\": \"10.11.20.30\"\n        }\n      ],\n      \"links\": null,\n      \"workingDirectory\": null,\n      \"readonlyRootFilesystem\": null,\n      \"image\": \"YOUR_DOCKER_REPOS/app\",\n      \"command\": null,\n      \"user\": null,\n      \"dockerLabels\": null,\n      \"logConfiguration\": null,\n      \"cpu\": 50,\n      \"privileged\": null\n    }\n  ],\n  \"volumes\": [\n    {\n      \"host\": {\n        \"sourcePath\": \"assets_data\"\n      },\n      \"name\": \"assets_data\"\n    }\n  ],\n  \"family\": \"web\"\n}\n```\n\n### redis-task\n\n- redis\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\n- \u30c7\u30fc\u30bf\u30b9\u30c8\u30ec\u30fc\u30b8\u306f\u6c38\u7d9a\u5316\u3059\u308b\n    - `mountPoints`\u306e\u7b87\u6240\n\n```json:redis-task.json\n{\n  \"taskDefinitionArn\": \"arn:aws:ecs:ap-northeast-1:NNNNNNNNNNNN:task-definition/redis-task:1\",\n  \"revision\": 1,\n  \"containerDefinitions\": [\n    {\n      \"volumesFrom\": [],\n      \"memory\": 512,\n      \"extraHosts\": null,\n      \"dnsServers\": null,\n      \"disableNetworking\": null,\n      \"dnsSearchDomains\": null,\n      \"portMappings\": [\n        {\n          \"hostPort\": 6379,\n          \"containerPort\": 6379,\n          \"protocol\": \"tcp\"\n        }\n      ],\n      \"hostname\": null,\n      \"essential\": true,\n      \"entryPoint\": null,\n      \"mountPoints\": [\n        {\n          \"containerPath\": \"/data\",\n          \"sourceVolume\": \"redis_data\",\n          \"readOnly\": null\n        }\n      ],\n      \"name\": \"redis\",\n      \"ulimits\": null,\n      \"dockerSecurityOptions\": null,\n      \"environment\": [],\n      \"links\": null,\n      \"workingDirectory\": null,\n      \"readonlyRootFilesystem\": null,\n      \"image\": \"redis:2.8\",\n      \"command\": null,\n      \"user\": null,\n      \"dockerLabels\": null,\n      \"logConfiguration\": null,\n      \"cpu\": 10,\n      \"privileged\": null\n    }\n  ],\n  \"volumes\": [\n    {\n      \"host\": {\n        \"sourcePath\": \"redis_data\"\n      },\n      \"name\": \"redis_data\"\n    }\n  ],\n  \"family\": \"redis\"\n}\n```\n\n## Service\u306e\u4f5c\u6210\n\nTask Definition\u3092\u3069\u308c\u304f\u3089\u3044\u8d77\u52d5\u3059\u308b\u304b\u3001\u3092\u5b9a\u7fa9\u3059\u308b\u306e\u304cService\u3067\u3059\u3002\n\u3053\u308c\u3092\u767b\u9332\u3059\u308b\u3068\u3001\u6307\u5b9a\u3057\u305f\u6570\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3057\u3088\u3046\u3068\u3057\u307e\u3059\u3002\n\n\u305f\u3060\u3057\u3001\u7af6\u5408\u30ea\u30bd\u30fc\u30b9\u306e\u78ba\u4fdd\u3068\u3044\u3046\u6982\u5ff5\u304c\u3042\u3063\u3066\u3001\u3053\u308c\u304c\u7af6\u5408\u3059\u308b\u30b3\u30f3\u30c6\u30ca\u306f\u540c\u4e00\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3067\u306f\u8d77\u52d5\u3057\u307e\u305b\u3093\u3002\n\n\u4f8b\u3048\u3070\u3001web\u306f\u30db\u30b9\u30c8\u5074\u306e80\u756a\u30dd\u30fc\u30c8\u3092\u958b\u653e\u3059\u308b\u30b3\u30f3\u30c6\u30ca\u3092\u542b\u3080\u30bf\u30b9\u30af\u5b9a\u7fa9\u306a\u306e\u3067\u30011\u3064\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u6700\u59271\u3064\u307e\u3067\u3057\u304b\u8d77\u52d5\u3067\u304d\u307e\u305b\u3093\u3002\u8907\u6570\u306e\u30b3\u30f3\u30c6\u30ca\u304c\u5fc5\u8981\u306a\u3089\u3001\u305d\u306e\u3076\u3093\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3082\u8d77\u52d5\u3057\u3066\u304a\u304f\u5fc5\u8981\u304c\u3042\u308b\u308f\u3051\u3067\u3059\u3002\n\n\u4ed6\u306b\u3082\u3001\u30b3\u30f3\u30c6\u30ca\u306b\u5272\u308a\u5f53\u3066\u308b\u30e1\u30e2\u30ea\u3084CPU\u3068\u3044\u3063\u305f\u8981\u7d20\u3082\u30ea\u30bd\u30fc\u30b9\u306e\u4e00\u90e8\u306a\u306e\u3067\u3001\u3053\u308c\u304c\u4e0d\u8db3\u3059\u308b\u3088\u3046\u306a\u3089\u3070\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u8ffd\u52a0\u3092\u884c\u308f\u306a\u3044\u3068\u3001\u30b3\u30f3\u30c6\u30ca\u306f\u8d77\u52d5\u3055\u308c\u307e\u305b\u3093\u3002\n\n\u307e\u305fService\u306b\u306f\u3001`Minimum healthy percent`\u3068`Maximum percent`\u3068\u3044\u3046\u8a2d\u5b9a\u304c\u3042\u308b\u306e\u3067\u3059\u304c\u3001\u3053\u308c\u306b\u3064\u3044\u3066\u306f\u5f8c\u8ff0\u306e[Blue Green Deployment](#blue-green-deployment)\u3067\u8aac\u660e\u3057\u307e\u3059\u3002\n\u4e0b\u8a18\u3067\u306f\u3068\u308a\u3042\u3048\u305a\u3001\u305d\u308c\u305e\u308c`50`, `100`\u3092\u6307\u5b9a\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n### web-service\n\n- \u30b3\u30f3\u30c6\u30ca\u65701\u3067\u8d77\u52d5\n- ELB\u3068\u306e\u95a2\u9023\u4ed8\u3051\u3092\u884c\u3046\n\n```json:web-service.json\n{\n  \"taskDefinition\": \"arn:aws:ecs:us-northeast-1:NNNNNNNNNNNN:task-definition/web-task:1\",\n  \"loadBalancers\": [\n    {\n      \"containerName\": \"web-apache\",\n      \"containerPort\": 80,\n      \"loadBalancerName\": \"your-elb-name-here\"\n    }\n  ],\n  \"role\": \"ecsServiceRole\",\n  \"desiredCount\": 1,\n  \"serviceName\": \"web-service\",\n  \"cluster\": \"default\",\n  \"deploymentConfiguration\": {\n    \"maximumPercent\": 100,\n    \"minimumHealthyPercent\": 50\n  }\n}\n```\n\n### redis-service\n\n- \u30b3\u30f3\u30c6\u30ca\u65701\u3067\u8d77\u52d5\n\n```json:redis-service.json\n{\n  \"taskDefinition\": \"arn:aws:ecs:ap-northeast-1:NNNNNNNNNNNN:task-definition/redis-task:1\",\n  \"role\": \"ecsServiceRole\",\n  \"desiredCount\": 1,\n  \"serviceName\": \"redis-service\",\n  \"cluster\": \"default\",\n  \"deploymentConfiguration\": {\n    \"maximumPercent\": 100,\n    \"minimumHealthyPercent\": 50\n  }\n}\n```\n\n## \u52d5\u4f5c\u78ba\u8a8d\n\n### awscli\u304b\u3089\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3001`desiredCount`=`runningCount`\u306b\u306a\u3063\u3066\u3044\u308c\u3070\u5e0c\u671b\u901a\u308a\u30b3\u30f3\u30c6\u30ca\u304c\u8d77\u52d5\u3057\u3066\u3044\u307e\u3059\u3002\n`pendingCount`\u304c1\u4ee5\u4e0a\u3067\u3042\u308c\u3070\u3001\u4eca\u307e\u3055\u306b\u8d77\u52d5\u4e2d\u3068\u3044\u3046\u72b6\u6cc1\u306a\u306e\u3067\u5c11\u3057\u5f85\u3061\u307e\u3057\u3087\u3046\u3002\n\n```shell-session\n$ aws ecs --region ap-northeast-1 describe-services --cluster default --services web-service redis-service | jq '.services[] | {serviceName, status, desiredCount, pendingCount, runningCount}'\n{\n  \"serviceName\": \"web-service\",\n  \"status\": \"ACTIVE\",\n  \"desiredCount\": 1,\n  \"pendingCount\": 0,\n  \"runningCount\": 1\n}\n{\n  \"serviceName\": \"redis-service\",\n  \"status\": \"ACTIVE\",\n  \"desiredCount\": 1,\n  \"pendingCount\": 0,\n  \"runningCount\": 1\n}\n```\n\n### \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304b\u3089\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306bssh\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u3066\u304a\u3051\u3070\u3001\u5f8c\u306f\u901a\u5e38\u901a\u308adocker\u30b3\u30de\u30f3\u30c9\u304c\u4f7f\u3048\u307e\u3059\u3002\n\n```shell-session\n$ ssh -i your-keypair-file ec2-user@container-instnce-ip\nLast login: Mon Jun  6 08:32:06 2016 from 1.2.3.4\n\n   __|  __|  __|\n   _|  (   \\__ \\   Amazon ECS-Optimized Amazon Linux AMI 2016.03.c\n ____|\\___|____/\n\nFor documentation visit, http://aws.amazon.com/documentation/ecs\n3 package(s) needed for security, out of 4 available\nRun \"sudo yum update\" to apply all updates.\n[ec2-user@ip-11-22-33-44 ~]$ docker ps\nCONTAINER ID        IMAGE                                                                COMMAND                  CREATED             STATUS              PORTS                        NAMES\n-snip-\n1e288e62a5d1        amazon/amazon-ecs-agent:latest                                       \"/agent\"                 3 days ago          Up 3 days           127.0.0.1:51678->51678/tcp   ecs-agent\n```\n\n## \u30c8\u30e9\u30d6\u30eb\u30b7\u30e5\u30fc\u30c6\u30a3\u30f3\u30b0\n\n### runningCount\u304c\u8db3\u308a\u306a\u3044\n\n\u3082\u3057\u3044\u3064\u307e\u3067\u7d4c\u3063\u3066\u3082`runningCount`\u304c0\u3067\u3042\u3063\u305f\u308a`desiredCount`\u672a\u6e80\u3067\u3042\u308b\u5834\u5408\u306f\u3001\u306a\u3093\u3089\u304b\u306e\u554f\u984c\u304c\u767a\u751f\u3057\u3066\u3044\u308b\u53ef\u80fd\u6027\u304c\u3042\u308a\u307e\u3059\u3002\n\u305d\u3046\u3044\u3046\u5834\u5408\u306f\u30a8\u30e9\u30fc\u304c\u51fa\u529b\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```shell-session\n$ aws ecs --region ap-northeast-1 describe-services --cluster default --services web-service redis-service | jq '.services[].events[].message'\n\"(service web) was unable to place a task because no container instance met all of its requirements. The closest matching (container-instance 8f078cd3-40a7-4873-ae04-223a14c74b9e) has insufficient memory available. For more information, see the Troubleshooting section of the Amazon ECS Developer Guide.\"\n```\n\n\u4e0a\u8a18\u4f8b\u3060\u3068\u3001\u7af6\u5408\u30ea\u30bd\u30fc\u30b9\u3068\u3057\u3066\u306e\u30e1\u30e2\u30ea\u304c\u3053\u308c\u4ee5\u4e0a\u5272\u308a\u5f53\u3066\u3067\u304d\u306a\u304b\u3063\u305f\u306e\u3067\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3067\u304d\u306a\u304b\u3063\u305f\u3053\u3068\u304c\u5206\u304b\u308a\u307e\u3059\u3002\n\u30e1\u30e2\u30ea\u8a2d\u5b9a\u3092\u5909\u66f4\u3059\u308b\u304b\u3001\u8ffd\u52a0\u3067\u30b3\u30f3\u30c6\u30ca\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u8d77\u52d5\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n### \u30b3\u30f3\u30c6\u30ca\u306f\u8d77\u52d5\u3057\u3066\u3044\u308b\u304c\u3001\u3046\u307e\u304f\u901a\u4fe1\u3067\u304d\u3066\u3044\u306a\u3044\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8abf\u67fb\u5bfe\u8c61\u3092\u7d5e\u3063\u3066\u3044\u304f\u3068\u3088\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n- \u30b3\u30f3\u30c6\u30ca\u81ea\u4f53\u306f\u6b63\u5e38\u306b\u52d5\u4f5c\u3057\u3066\u3044\u308b\u304b\uff1f\n    - ssh\u30ed\u30b0\u30a4\u30f3\u3092\u53ef\u80fd\u306b\u3057\u3066\u3044\u308b\u306a\u3089\u3001\u30ed\u30b0\u30a4\u30f3\u5f8c`docker ps`(or `docker ps -a`)\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u3066\u3001\u30b3\u30f3\u30c6\u30ca\u306e\u7a3c\u50cd\u72b6\u6cc1\u3092\u78ba\u8a8d\u3059\u308b\u3002\n    - `portMappings`\u3067\u30dd\u30fc\u30c8\u3092\u958b\u653e\u3057\u3066\u3044\u308b\u306a\u3089\u3001ELB\u3092\u7d4c\u7531\u3057\u306a\u3044\u3067\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u5bfe\u3057\u3066\u76f4\u63a5\u901a\u4fe1\u3057\u305f\u3089\u3069\u3046\u304b\uff1f\n        - \u5225\u9014\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\u3067\u30a2\u30af\u30bb\u30b9\u6a29\u9650\u3092\u4ed8\u4e0e\u3057\u3066\u304a\u304f\u5fc5\u8981\u304c\u3042\u308b\n- web-app\u306b\u554f\u984c\u304c\u3042\u308b\u306e\u304b\uff1f\n    - web-app\u30b3\u30f3\u30c6\u30ca\u306b\u30a8\u30e9\u30fc\u30ed\u30b0\u304c\u51fa\u529b\u3055\u308c\u3066\u3044\u306a\u3044\u304b\u78ba\u8a8d\u3059\u308b\n\n        ```shell-session\n        container-instance$ docker logs <web-app-container-id>\n        I, [2016-06-03T10:26:15.859460 #1]  INFO -- : Refreshing Gem list\n        I, [2016-06-03T10:26:28.349481 #1]  INFO -- : listening on addr=0.0.0.0:3000 fd=13\n        I, [2016-06-03T10:26:28.354816 #1]  INFO -- : master process ready\n        I, [2016-06-03T10:26:28.470681 #12]  INFO -- : worker=0 ready\n        ```\n\n    - web-app\u30b3\u30f3\u30c6\u30ca\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u3001unicorn\u3084RoR\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\n\n        ```shell-session\n        container-instance$ docker exec -it <web-app-container-id> bash\n        root@web-app-container-id:/app# bundle exec rails console   # RoR\u304c\u52d5\u4f5c\u3057\u3066\u3044\u308b\u304b\n        root@web-app-container-id:/app# curl http://localhost:3000/ # unicorn\u304c\u52d5\u4f5c\u3057\u3066\u3044\u308b\u304b\n        root@web-app-container-id:/app# redis-cli -h $DOCKER_REDIS_HOST info # Redis\u3068\u306e\u901a\u4fe1\u304c\u3067\u304d\u3066\u3044\u308b\u304b\n        ```\n- web-apache\u306b\u554f\u984c\u304c\u3042\u308b\u306e\u304b\uff1f\n    - web-apache\u30b3\u30f3\u30c6\u30ca\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u3001proxy\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\n\n        ```shell-session\n        container-instance$ docker exec -it <web-apache-container-id> bash\n        root@web-apache-container-id:/app# curl http://app:3000/     # web-app\u3068\u306e\u901a\u4fe1\u304c\u3067\u304d\u3066\u3044\u308b\u304b\n        root@web-apache-container-id:/app# curl http://localhost:80/ # web-app\u3068\u306eprox\uff59\u304c\u52d5\u4f5c\u3057\u3066\u3044\u308b\u304b\n        ```\n- ELB\u3068\u30b3\u30f3\u30c6\u30ca\u306f\u6b63\u3057\u304f\u901a\u4fe1\u3067\u304d\u3066\u3044\u308b\u304b\uff1f\n    - ELB\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u72b6\u614b\u3092\u78ba\u8a8d\u3057\u3001\u8a72\u5f53\u306e\u30b3\u30f3\u30c6\u30ca\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u5272\u308a\u5f53\u3066\u3089\u308c\u3066\u3044\u308b\u304b\uff1f\n    - \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u72b6\u614b\u306fHealthy\u304b\uff1f\n\n<a name=\"blue-green-deployment\"></a>\n# Blue Green Deployment\u306e\u65b9\u6cd5\n\nECS\u3067Blue Green Deployment\u3092\u5b9f\u65bd\u3059\u308b\u305f\u3081\u306b\u306f\u3001Service\u306e\u8a2d\u5b9a\u3067\u3042\u308b`Minimum healthy percent`\u3068`Maximum percent`\u3092\u7406\u89e3\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u304c\u3001\u3068\u308a\u3042\u3048\u305a\u30b7\u30f3\u30d7\u30eb\u304b\u3064\u6700\u5c0f\u69cb\u6210\u3067\u5b9f\u73fe\u3059\u308b\u306a\u3089\u3070\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3059\u308c\u3070OK\u3067\u3059\u3002\n\n\u5185\u5bb9\u306b\u3064\u3044\u3066\u8a73\u3057\u3044\u8aac\u660e\u306f[\u3053\u3061\u3089](http://aws.typepad.com/sajp/2015/12/amazon-ecs-launches-new-deployment-capabilities-cloudwatch-metrics-singapore-and-frankfurt-regions.html)\u304c\u53c2\u8003\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u4e0b\u8a18\u306e\u4f8b\u3067\u306f\u30012\u53f0\u306e\u30b3\u30f3\u30c6\u30ca\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b`web-task`\u304c1\u3064\u305a\u3064\u8d77\u52d5\u3057\u3066\u3044\u308b\u30b3\u30f3\u30c6\u30ca\u69cb\u6210\u3067\u3042\u308b\u3082\u306e\u3068\u3057\u3066\u3044\u307e\u3059\u3002\n\u307e\u305f\u3001\u30c7\u30d7\u30ed\u30a4\u6642\u306b\u306f\u4e00\u6642\u7684\u306b\u8d77\u52d5\u30b3\u30f3\u30c6\u30ca\u6570\u304c1\u3064\u307e\u3067\u4e0b\u304c\u308b\u3053\u3068\u3092\u8a31\u5bb9\u3059\u308b\u3082\u306e\u3068\u3057\u307e\u3059\u3002\n\n## \u4e8b\u524d\u6e96\u5099\n\n1. \u30af\u30e9\u30b9\u30bf\u5185\u306e\u30b3\u30f3\u30c6\u30ca\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306f2\u53f0\u306b\u3057\u3066\u304a\u304f\n1. Service `web-service`\u306e`Minimum healthy percent`\u3092`50`\u3001`Maximum percent`\u3092`100`\u306b\u3059\u308b\n\n## \u30c7\u30d7\u30ed\u30a4\u6642\u306e\u4f5c\u696d\u3068\u6d41\u308c\n\nTask Definition\u306e\u5185\u5bb9\u3092\u5909\u66f4\u3057\u305f\u5834\u5408\u3001\u5909\u66f4\u3092Service\u306b\u53cd\u6620\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u306a\u304a\u3001Task Definition\u306e\u5909\u66f4\u3092\u4f34\u308f\u306a\u3044\u3088\u3046\u306a\u904b\u7528\uff08Docker\u30a4\u30e1\u30fc\u30b8\u3092\u66f4\u65b0\u3057\u3066\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3057\u305f\u306e\u3067\u3001\u30b3\u30f3\u30c6\u30ca\u3092\u518d\u5ea6\u8d77\u52d5\u3057\u76f4\u305b\u3070\u3088\u3044\u3001\u3068\u3044\u3046\u3088\u3046\u306a\u30b1\u30fc\u30b9\uff09\u3082\u3042\u308a\u5f97\u308b\u3068\u601d\u3044\u307e\u3059\u304c\u3001\u305d\u306e\u5834\u5408\u3082\u4e0b\u8a18\u306e\u30d5\u30ed\u30fc\u3067 :ok_hand: \u304b\u3068\u601d\u3044\u307e\u3059\u3002\u7121\u99c4\u306bTask Definition\u3092\u5909\u66f4\u3059\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u304c\u3001\u30d5\u30ed\u30fc\u304c\u5358\u7d14\u306b\u306a\u308b\u3068\u3044\u3046\u5229\u70b9\u304c\u3042\u308a\u307e\u3059\u306e\u3067\u3002\n\n### \u4f5c\u696d\u5185\u5bb9\n\n1. `web-task:1`\u3092\u518d\u767b\u9332\u3059\u308b\u3068\u3001\u30ea\u30d3\u30b8\u30e7\u30f3\u304c\u30a4\u30f3\u30af\u30ea\u30e1\u30f3\u30c8\u3055\u308c`web-task:2`\u304c\u767b\u9332\u3055\u308c\u308b\n1. `web-service`\u306b\u95a2\u9023\u4ed8\u3051\u3089\u308c\u3066\u3044\u308b`web-task:1`\u3092`web-task:2`\u306b\u5909\u66f4\u3059\u308b\n\n### ECS\u4e0a\u306e\u52d5\u304d\n\n1. `web-task:1`\u00d72\u306e\u72b6\u614b\u306b\u306a\u3063\u3066\u3044\u308b\n1. `web-task:1`\u00d71\u304c\u505c\u6b62\u3059\u308b\u304c\u3001\u5168\u30b3\u30f3\u30c6\u30ca\u500b\u6570\u306e\u3046\u3061\u534a\u5206\uff08\u3064\u307e\u308a1\u53f0\uff09\u306f`web-task:1`\u00d71\u304c\u6b8b\u308b\n1. `web-task:1`\u00d71\u304c\u505c\u6b62\u3057\u3001\u4ee3\u308f\u308a\u306b`web-task:2`\u00d71\u304c\u8d77\u52d5\u3059\u308b\n1. `web-task:1`\u00d71\u3001`web-task:2`\u00d71\u306e\u72b6\u614b\u306b\u306a\u308b\n1. `web-task:1`\u00d71\u304c\u518d\u5ea6\u505c\u6b62\u3057\u3001\u3053\u308c\u3067`web-task:2`\u00d71\u306e\u307f\u306e\u72b6\u614b\u306b\u306a\u308b\n1. `web-task:2`\u00d71\u304c\u8d77\u52d5\u3057\u3001\u3053\u308c\u3067`web-task:2`\u00d72\u306e\u72b6\u614b\u306b\u306a\u308b\n\n\u5168\u30b3\u30f3\u30c6\u30ca\u306e\u3046\u3061\u534a\u5206\u304c`web-task:1`\u306e\u307e\u307e\u6b8b\u308b\u3068\u3044\u3046\u306e\u306f\u3001`Minimum healthy percent`\u304c`50`\u3067\u3042\u308b\u3053\u3068\u306b\u8d77\u56e0\u3057\u307e\u3059\u3002\n\n# ECS\u30ce\u30a6\u30cf\u30a6\n\n\u3082\u3057\u304b\u3059\u308b\u3068\u30ce\u30a6\u30cf\u30a6\u3068\u3044\u3046\u307b\u3069\u3067\u306f\u306a\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u304c\u3001\u6700\u521d\u7406\u89e3\u3057\u306b\u304f\u3044\u7b87\u6240\u304c\u3042\u3063\u305f\u306e\u3067\u66f8\u3044\u3066\u304a\u304d\u307e\u3059\u3002\n\n## \u767b\u9332\u6e08\u306eTask Definition\u3092\u5909\u66f4\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u305a\u3001\u30ea\u30d3\u30b8\u30e7\u30f3\u3092\u5909\u3048\u3066\u518d\u767b\u9332\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\n\n\u306a\u3093\u3068\u306a\u304f\u3001update-task-definition\u7684\u306a\u3053\u3068\u304c\u3067\u304d\u305d\u3046\u306a\u6c17\u304c\u3057\u307e\u3059\u304c\u3001register-task-definition\u3057\u304b\u5b58\u5728\u3057\u307e\u305b\u3093\u3002\n\u65e2\u5b58\u306eTask Definition\u306b\u5bfe\u3057\u3066\u518d\u767b\u9332\u3059\u308b\u3068\u3001\u30ea\u30d3\u30b8\u30e7\u30f3\u304c\u30a4\u30f3\u30af\u30ea\u30e1\u30f3\u30c8\u3055\u308c\u307e\u3059\u3002\n\n## Task Definition\u3092\u518d\u767b\u9332\u3057\u3066\u3082Service\u306b\u306f\u53cd\u6620\u3055\u308c\u306a\u3044\n\n\u524d\u8ff0\u306e\u901a\u308a\u3001Task Definition\u3092\u518d\u767b\u9332\u3057\u305f\u5834\u5408\u30ea\u30d3\u30b8\u30e7\u30f3\u304c\u30a4\u30f3\u30af\u30ea\u30e1\u30f3\u30c8\u3055\u308c\u307e\u3059\u304c\u3001Service\u306f\u30ea\u30d3\u30b8\u30e7\u30f3\u4ed8\u304d\u3067Task Definition\u3092\u53c2\u7167\u3057\u3066\u3044\u308b\u306e\u3067\u3001\u305d\u306e\u307e\u307e\u3067\u306f\u306a\u306b\u3082\u8d77\u304d\u307e\u305b\u3093\u3002\nupdate-service\u3067\u95a2\u9023\u4ed8\u3051\u3089\u308c\u305f\u30ea\u30d3\u30b8\u30e7\u30f3\u3092\u66f4\u65b0\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n## Service\u3092\u524a\u9664\u3059\u308b\u306b\u306f\u30b3\u30f3\u30c6\u30ca\u3092\u505c\u6b62\u3057\u3066\u304a\u304b\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\n\ndelete-service\u3057\u3088\u3046\u3068\u3059\u308b\u3068\n\n```\nA client error (InvalidParameterException) occurred when calling the DeleteService operation: The service cannot be stopped while the primary deployment is scaled above 0.\n```\n\n\u306e\u3088\u3046\u306b\u6012\u3089\u308c\u3066\u3057\u307e\u3046\u3053\u3068\u304c\u3042\u308a\u307e\u3059\u3002\u3053\u308c\u306f\u3059\u3067\u306b\u30b3\u30f3\u30c6\u30ca\u304c\u8d77\u52d5\u3057\u3066\u3044\u308b\u5834\u5408\u306f\u524a\u9664\u3067\u304d\u306a\u3044\u305f\u3081\u3067\u3059\u3002\n\u3058\u3083\u3001stop-task\u3059\u308c\u3070\u3044\u3044\u3093\u3060\u306a\u3001\u3068\u601d\u3063\u3066\u505c\u6b62\u3055\u305b\u305f\u5f8c\u306b\u524a\u9664\u3057\u3088\u3046\u3068\u3057\u3066\u3082\u3001\u3044\u3064\u306e\u9593\u306b\u304bService\u304c\u30b3\u30f3\u30c6\u30ca\u3092\u81ea\u52d5\u7684\u306b\u8d77\u52d5\u3057\u3066\u304a\u308a\u3084\u3063\u3071\u308a\u3067\u304d\u306a\u3044\u3001\u3068\u306a\u308b\u3053\u3068\u304c\u591a\u3044\u3002\n\n\u6b63\u3057\u304f\u306f\u3001\u524d\u3082\u3063\u3066Service\u306e`desiredCount`\u30920\u306b\u3057\u3066\u304a\u3051\u3070\u305d\u308c\u4ee5\u4e0a\u30b3\u30f3\u30c6\u30ca\u306f\u81ea\u52d5\u8d77\u52d5\u3055\u308c\u306a\u3044\u306e\u3067\u3001\u30b3\u30f3\u30c6\u30ca\u304c\u3059\u3079\u3066\u505c\u6b62\u3057\u3066\u304b\u3089\u524a\u9664\u3059\u308c\u3070OK\u3002\n\n# \u6ce8\u610f\u70b9\u3001\u8981\u6539\u5584\n\n\u73fe\u6642\u70b9\u3067\u306f\u3001\u4ee5\u4e0b\u306e\u554f\u984c\u304c\u89e3\u6d88\u3055\u308c\u3066\u3044\u307e\u305b\u3093\u3002\n\n<a name=\"redis-storage\"><a/>\n## Redis\u306e\u30c7\u30fc\u30bf\u30b9\u30c8\u30ec\u30fc\u30b8\u5834\u6240\n\n`redis-task`\u306b\u3088\u3063\u3066\u30b9\u30c8\u30ec\u30fc\u30b8\u306f\u6c38\u7d9a\u5316\u306e\u8a2d\u5b9a\u3092\u3057\u307e\u3057\u305f\u3002\u3053\u308c\u306b\u3088\u308a\u3001`redis-task`\u30b3\u30f3\u30c6\u30ca\u304c\u306a\u3093\u3089\u304b\u306e\u7406\u7531\u3067\u505c\u6b62\u3057\u3066\u3082\u3001\u6b21\u306b\u8d77\u52d5\u3057\u305f`redis-task`\u30b3\u30f3\u30c6\u30ca\u3067\u3082\u30c7\u30fc\u30bf\u5185\u5bb9\u306f\u5f15\u304d\u7d99\u304c\u308c\u308b\u306e\u3067\u3001\u6d88\u5931\u3059\u308b\u3053\u3068\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\n\u305f\u3060\u3057\u3053\u308c\u306f\u3001\u540c\u4e00\u30b3\u30f3\u30c6\u30ca\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4e0a\u3067\u8d77\u52d5\u3057\u305f\u306a\u3089\u3070\u3001\u3068\u3044\u3046\u524d\u63d0\u6761\u4ef6\u304c\u4ed8\u304d\u307e\u3059\u3002\n\u30b9\u30c8\u30ec\u30fc\u30b8\u306e\u672c\u4f53\u306f\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4e0a\u306b\u5b58\u5728\u3057\u3066\u3044\u308b\u305f\u3081\u3001\u5225\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3068\u306f\u5171\u6709\u3055\u308c\u306a\u3044\u305f\u3081\u3067\u3059\u3002\n\n\u3082\u3057`redis-task`\u30b3\u30f3\u30c6\u30ca\u304c\u505c\u6b62\u5f8c\u306b\u518d\u5ea6\u8d77\u52d5\u3055\u308c\u308b\u969b\u3001\u305f\u307e\u305f\u307e\u5225\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4e0a\u3067\u8d77\u52d5\u3055\u308c\u305f\u306a\u3089\u3070\u3001\u30c7\u30fc\u30bf\u306f\u6d88\u5931\u3059\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u3053\u308c\u3092\u907f\u3051\u308b\u305f\u3081\u306b\u306f\u3001`redis-task`\u30b3\u30f3\u30c6\u30ca\u304c\u8d77\u52d5\u3059\u308b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u56fa\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u304c\u3001Service\u3092\u7528\u3044\u308b\u5834\u5408\u306f\u8d77\u52d5\u3059\u308b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u6307\u5b9a\u3059\u308b\u65b9\u6cd5\u304c\u898b\u5f53\u305f\u308a\u307e\u305b\u3093\u3067\u3057\u305f\u3002\n\nstart-task\u306b\u306f\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u6307\u5b9a\u3059\u308b\u624b\u6cd5\u304c\u3042\u308b\u306e\u3067\u3059\u304c\u3001\u3053\u308c\u3060\u3068\u30b3\u30f3\u30c6\u30ca\u304c\u306a\u3093\u3089\u304b\u306e\u7406\u7531\u3067\u505c\u6b62\u3057\u3066\u3082\u518d\u958b\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093\u3002\n\n\u7d50\u5c40\u3001Redis\u306b\u3064\u3044\u3066\u306fElastiCache\u306e\u3088\u3046\u306a\u5916\u90e8\u30b5\u30fc\u30d3\u30b9\u3092\u4f7f\u3046\u3079\u304d\u306a\u306e\u304b\u306a\u3042\u3001\u3068\u3044\u3046\u306e\u304c\u4eca\u306e\u5370\u8c61\u3067\u3059\u3002\n\n<a name=\"service-discovery\"><a/>\n## Service Discovery\u306e\u65b9\u6cd5\n\n`web-task`\u304b\u3089`redis-task`\u306b\u63a5\u7d9a\u3059\u308b\u305f\u3081\u306b\u306fIP\u30a2\u30c9\u30ec\u30b9\u3092\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u304c\u3001\u3053\u306eIP\u30a2\u30c9\u30ec\u30b9\u306f\u30b3\u30f3\u30c6\u30ca\u5185\u306e\u3082\u306e\u3067\u306f\u306a\u304f\u3001\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u81ea\u4f53\u306e\u3082\u306e\u3067\u306a\u3051\u308c\u3070\u306a\u308a\u307e\u305b\u3093\u3002\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u8907\u6570\u5b58\u5728\u3059\u308b\u5834\u5408\u3001\u5b9b\u5148\u3068\u306a\u308b\u30a2\u30c9\u30ec\u30b9\u306f\u4e00\u610f\u306b\u306f\u5b9a\u307e\u3089\u306a\u3044\u306e\u3067\u52d5\u7684\u306b\u6c7a\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u306e\u3067\u3059\u304c\u3001ECS\u3067\u306f\u3053\u308c\u306f\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u3066\u3044\u307e\u305b\u3093\u3002\n\n\u4e16\u306e\u4e2d\u306b\u306f\u3044\u308d\u3093\u306aService Discovery\u306e\u624b\u6cd5\u304c\u3042\u308b\u3068\u601d\u3044\u307e\u3059\u304c\u3001[Consul](https://www.consul.io/)\u304c\u4e00\u756a\u5229\u7528\u3057\u3084\u3059\u3044\u3088\u3046\u306b\u611f\u3058\u307e\u3057\u305f\u3002\n\n## Swap\u30e1\u30e2\u30ea\u304c\u5229\u7528\u3067\u304d\u306a\u3044\n\n\u524d\u8ff0\u306e\u901a\u308a\u3001ECS\u3067\u306f\u7af6\u5408\u30ea\u30bd\u30fc\u30b9\u306e1\u3064\u3068\u3057\u3066\u30e1\u30e2\u30ea\u5272\u5f53\u91cf\u304c\u3042\u308b\u308f\u3051\u3067\u3059\u304c\u3001\u5236\u9650\u4e8b\u9805\u3068\u3057\u3066Swap\u30e1\u30e2\u30ea\u3092\u5229\u7528\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u306a\u304f\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\nECS\u306f\u5404\u30b3\u30f3\u30c6\u30ca\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30e1\u30e2\u30ea\u7a7a\u304d\u5bb9\u91cf\u3092\u628a\u63e1\u3057\u3066\u3044\u307e\u3059\u304c\u3001\u3053\u308c\u306b\u306fSwap\u30e1\u30e2\u30ea\u3076\u3093\u306f\u542b\u307e\u308c\u306a\u3044\u306e\u3067\u3059\u3002\n\n\u3055\u3089\u306b\u3001Task Definition\u3067\u306f\u30e1\u30e2\u30ea\u5272\u308a\u5f53\u3066\u91cf\u6307\u5b9a\u304c\u5fc5\u9808\u3068\u306a\u3063\u3066\u304a\u308a\u3001\u30b3\u30f3\u30c6\u30ca\u5185\u3067\u306f\u3053\u308c\u3092\u8d85\u3048\u305f\u30b5\u30a4\u30ba\u306e\u30e1\u30e2\u30ea\u78ba\u4fdd\u306f\u3067\u304d\u307e\u305b\u3093\uff08\u5f53\u305f\u308a\u524d\u3067\u3059\u304c\uff09\u3002\n\n\u7d50\u679c\u3068\u3057\u3066\u3001\u30b3\u30f3\u30c6\u30ca\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306bSwap\u304c\u3042\u308d\u3046\u304c\u306a\u304b\u308d\u3046\u304c\u5229\u7528\u53ef\u80fd\u306a\u30e1\u30e2\u30ea\u5bb9\u91cf\u306f\u7269\u7406\u30e1\u30e2\u30ea\u306e\u307f\u3067\u3042\u308a\u3001\u304b\u3064\u5272\u308a\u5f53\u3066\u6307\u5b9a\u304c\u5fc5\u9808\u3067\u3042\u308b\u305f\u3081\u3001\u7269\u7406\u30e1\u30e2\u30ea\u4ee5\u4e0a\u306e\u30e1\u30e2\u30ea\u78ba\u4fdd\u306f\u4e0d\u53ef\u80fd\u3068\u3044\u3046\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u7d20\u306eDocker\u306a\u3089\u30e1\u30e2\u30ea\u5272\u308a\u5f53\u3066\u91cf\u306f\u30aa\u30d7\u30b7\u30e7\u30f3\u6271\u3044\u3067\u3001\u7701\u7565\u6642\u306f\u30e1\u30e2\u30ea\u78ba\u4fdd\u306e\u30b5\u30a4\u30ba\u5236\u9650\u306f\u30db\u30b9\u30c8\u5074\u306eSwap\u30e1\u30e2\u30ea\u3092\u542b\u3081\u305f\u30e1\u30e2\u30ea\u5bb9\u91cf\u306b\u5f93\u3044\u307e\u3059\u3002\u306a\u306e\u3067\u3001\u7269\u7406\u30e1\u30e2\u30ea\u4ee5\u4e0a\u306e\u30e1\u30e2\u30ea\u3092\u78ba\u4fdd\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\nSwap\u30e1\u30e2\u30ea\u304c\u4e00\u5207\u4f7f\u3048\u306a\u3044\u3068\u3044\u3046\u306e\u306f\u3001\u5834\u5408\u306b\u3088\u3063\u3066\u306f\u304d\u3064\u3044\u5236\u9650\u306b\u306a\u308a\u305d\u3046\u3067\u3059\u3002\n\u5b9f\u969b\u306b\u81ea\u5206\u306e\u74b0\u5883\u3067\u306f\u3001\u901a\u5e38\u306f\u305d\u3053\u307e\u3067\u3067\u3082\u306a\u3044\u304c\u3001\u4e00\u6642\u7684\u306b\u7269\u7406\u30e1\u30e2\u30ea\u3092\u8d85\u3048\u3066\u30e1\u30e2\u30ea\u3092\u78ba\u4fdd\u3057\u3088\u3046\u3068\u3059\u308b\u30d7\u30ed\u30b0\u30e9\u30e0\u304c\u52d5\u4f5c\u3057\u3066\u3044\u308b\u30b5\u30fc\u30d0\u304c\u3042\u308b\u306e\u3067\u3001\u3053\u308c\u3092ECS\u3067\u904b\u7528\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u306a\u3044\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u3053\u308c\u3092\u554f\u984c\u8996\u3057\u3066\u3044\u308b\u4eba\u305f\u3061\u306f\u3084\u306f\u308a\u3044\u308b\u3088\u3046\u3067[Issue](https://github.com/aws/amazon-ecs-agent/issues/124)\u304c\u4f5c\u3089\u308c\u3066\u304a\u308a\u3001\u305f\u304f\u3055\u3093\u306e+1\u30b3\u30e1\u30f3\u30c8\u304c\u4ed8\u3051\u3089\u308c\u3066\u3044\u307e\u3059\u304c\u3001\u4eca\u306e\u3068\u3053\u308d\u6539\u5584\u3055\u308c\u308b\u6c17\u914d\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n", "tags": ["AWS", "ECS", "docker"]}