{"tags": ["Emacs", "MacOSX", "\u3084\u3063\u3066\u307f\u305f", "\u30dd\u30a8\u30e0"], "context": "\u5df7\u3067\u8a71\u984c\u306eemacs\u3092macOS\u3067\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n\u76ee\u7684\n\nmalloc_set_state malloc_get_state\u306a\u3057\u3067\u3082\u30b3\u30f3\u30d1\u30a4\u30eb\u3067\u304d\u308b\u3053\u3068\u3092\u5b9f\u8a3c\u3059\u308b\u3002\nunexec\u3055\u308c\u3066\u3044\u306a\u3044emacs\u306e\u8d77\u52d5\u6642\u9593\u3092\u78ba\u8a8d\u3059\u308b\n\n\u8ffd\u8a18\uff1amalloc_get_state/malloc_set_state\u306fOSX\u3067\u306f\u305d\u3082\u305d\u3082\u4f7f\u308f\u308c\u3066\u3044\u306a\u3044\u306e\u3067\u3001\u5b9f\u8a3c\u3059\u308b\u610f\u5473\u304c\u3042\u308a\u307e\u305b\u3093\u3067\u3057\u305f\u3002\n\n\u74b0\u5883\n\nmacOS Sierra 10.12.2\n\u30b3\u30f3\u30d1\u30a4\u30e9 Apple LLVM 8.0.0 (clang-800.0.42.1)\n\n\n\u30b3\u30f3\u30d1\u30a4\u30eb\u624b\u9806\nwget http://ftp.gnu.org/gnu/emacs/emacs-25.1.tar.gz\ntar xf emacs-25.1.tar.gz\ncd emacs-25.1\n\n# /usr/local\u306b\u4f59\u8a08\u306a\u3082\u306e\u304c\u305f\u304f\u3055\u3093\u3042\u308b\u306e\u3067\u3001\u6a19\u6e96\u306e\u30d1\u30b9\u3060\u3051\u4f7f\u3046\nexport PATH=/usr/bin:/bin:/usr/sbin:/sbin\n\n./configure\n# GNU malloc\u306f\u4f7f\u308f\u306a\u3044\u8a2d\u5b9a\u306b\u306a\u308b\u3002\n#   Should Emacs use the GNU version of malloc?             no\n\ntime make\n\n# real  1m5.474s\n# user  0m59.310s\n# sys   0m4.596s\n\ntgz\u306760MB, \u30b3\u30f3\u30d1\u30a4\u30eb\u6642\u95931\u5206\u5f37\u3002\u6700\u8fd1\u306e\u91cd\u91cf\u7d1a\u306e\u30bd\u30d5\u30c8\u306b\u6bd4\u3079\u305f\u3089\u304b\u306a\u308a\u5c0f\u3055\u3044\u3067\u3059\u3002\u30d0\u30a4\u30ca\u30ea\u306fsrc\u306e\u4e0b\u306b\u3067\u304d\u307e\u3059\u3002\n\n\u8abf\u67fb\nmalloc_set_state malloc_get_state\u3092\u4f7f\u3063\u3066\u3044\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002 otool(Linux\u306eldd\u76f8\u5f53)\u3067\u4f55\u3092\u30ed\u30fc\u30c9\u3059\u308b\u306e\u304b\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3059\u3002\n$ otool -L src/emacs\nsrc/emacs:\n    /System/Library/Frameworks/AppKit.framework/Versions/C/AppKit (compatibility version 45.0.0, current version 1504.76.0)\n    /System/Library/Frameworks/IOKit.framework/Versions/A/IOKit (compatibility version 1.0.0, current version 275.0.0)\n    /usr/local/opt/jpeg/lib/libjpeg.8.dylib (compatibility version 13.0.0, current version 13.0.0)\n    /usr/lib/libxml2.2.dylib (compatibility version 10.0.0, current version 10.9.0)\n    /usr/lib/libncurses.5.4.dylib (compatibility version 5.4.0, current version 5.4.0)\n    /usr/lib/libz.1.dylib (compatibility version 1.0.0, current version 1.2.8)\n    /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1238.0.0)\n    /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation (compatibility version 150.0.0, current version 1348.28.0)\n    /System/Library/Frameworks/CoreGraphics.framework/Versions/A/CoreGraphics (compatibility version 64.0.0, current version 1070.13.0)\n    /System/Library/Frameworks/CoreText.framework/Versions/A/CoreText (compatibility version 1.0.0, current version 1.0.0)\n    /System/Library/Frameworks/Foundation.framework/Versions/C/Foundation (compatibility version 300.0.0, current version 1349.25.0)\n    /usr/lib/libobjc.A.dylib (compatibility version 1.0.0, current version 228.0.0)\n\nC/Foundation\u304clibc\u76f8\u5f53\u3060\u3068\u601d\u3046\u306e\u3067\u3001malloc\u3092grep\u3057\u3066\u307f\u307e\u3059\u3002malloc_set_state / malloc_get_state\u306f\u3042\u308a\u307e\u305b\u3093\u306d\u3002\n\u8ffd\u8a18\uff1a\u305d\u306e\u4ee3\u308f\u308azone\u3092\u4f7f\u3063\u3066\u5b9f\u73fe\u3057\u3066\u3044\u308b\u305d\u3046\u3067\u3059\u3002\u3053\u308c\u306fMacOS\u5c02\u7528\u3089\u3057\u3044\u3067\u3059\n$ nm /System/Library/Frameworks/Foundation.framework/Versions/C/Foundation | grep malloc\n                 U _malloc\n00000000001b087c t _mallocAcquire\n                 U _malloc_create_zone\n                 U _malloc_default_zone\n                 U _malloc_get_zone_name\n                 U _malloc_good_size\n                 U _malloc_set_zone_name\n                 U _malloc_size\n                 U _malloc_zone_calloc\n                 U _malloc_zone_free\n                 U _malloc_zone_from_ptr\n                 U _malloc_zone_malloc\n                 U _malloc_zone_realloc\n\n\n\u8d77\u52d5\n./src/temacs\u3067temacs\u8d77\u52d5\u3002\u3056\u3063\u304f\u308a6\u79d2\u304f\u3089\u3044\u3067\u3059\u3002\u3053\u306eGIF\u52d5\u753b\u306f\u5b9f\u969b\u3088\u308a\u304b\u306a\u308a\u9045\u3044\u3067\u3059\u3002\n\n\u753b\u9762\u306f\u8f09\u305b\u307e\u305b\u3093\u304c./src/emacs -nw\u3067emacs\u3092\u8d77\u52d5\u3057\u305f\u3089\u4e00\u77ac\u3067\u3057\u305f\u3002emacs\u306fdump\u6e08\u307f\u306e\u30d0\u30a4\u30ca\u30ea\u3067Makefile\u3092\u898b\u3066\u898b\u308b\u3068\u3001\u6b21\u306e\u30b3\u30de\u30f3\u30c9\u3067dump\u3057\u3066\u3044\u308b\u69d8\u5b50\u3002\n./temacs --batch --load loadup bootstrap\n\n\u611f\u60f3\uff08\u8003\u5bdf\u3067\u3055\u3048\u306a\u3044\u3067\u3059\uff09\n\u3042\u306eelisp\u3092\u30b9\u30eb\u30b9\u30eb\u3068\u30ed\u30fc\u30c9\u3059\u308b\u69d8\u5b50\u3001\u6614\u5927\u5b66\u3067DEC Ultrix\u3092\u4f7f\u3063\u3066\u3044\u305f\u6642\u306b\u898b\u305f\u6c17\u304c\u3059\u308b\u3002\u3068\u3044\u3046\u3053\u3068\u306fUltrix\u306eemacs\u306funexec\u3055\u308c\u3066\u3044\u306a\u304b\u3063\u305f\u306e\u304b\u3082\u3002\u4eca\u3068\u306a\u3063\u3066\u306fGNU libc\u306b\u30ea\u30f3\u30af\u3055\u308c\u3066\u3044\u305f\u306e\u304b\u3069\u3046\u304b\u3082\u308f\u304b\u3089\u306a\u3044\u3051\u3069\u3002\nMac\u3067dump\u304c\u3067\u304d\u3066\u3044\u308b\u306e\u306f\u304a\u305d\u3089\u304femacs\u304c\u72ec\u81ea\u306b\u6301\u3063\u3066\u3044\u308b\u4ed5\u7d44\u307f\u306e\u305f\u3081\u304b\u306a\uff1f\u3069\u3053\u304b\u3067\u8aad\u3093\u3060\u6c17\u304c\u3059\u308b\u3002 \u8ffd\u8a18: \u30ea\u30f3\u30af\u5148\u306e\u8a18\u4e8b\u306b\u305d\u3046\u660e\u8a18\u3055\u308c\u3066\u3044\u308b\u3002dump\u3067\u304d\u308b\u306e\u306f\u5f53\u305f\u308a\u524d\u3002\nemacs\u306e\u8a71\u306f\u304a\u3063\u3055\u3093\u30db\u30a4\u30db\u30a4\u3060\u3068\u81ea\u899a\u3057\u307e\u3057\u305f\u3002\n\n\u8ffd\u8a18\nMac OS\u306eunexec\u306fsrc/unexmacosx.c\u5b9f\u88c5\u3055\u308c\u3066\u3044\u307e\u3057\u305f\u3002\u8aac\u660e\u3092\u8aad\u3093\u3067\u3082\u3088\u304f\u308f\u304b\u308a\u307e\u305b\u3093\u304c\u3001OS\u6bce\u306b\u5b9f\u88c5\u3055\u308c\u3066\u3044\u308bunexec\u304c\u30e1\u30f3\u30c6\u4e0d\u80fd\u306b\u306a\u308b\u306e\u306f\u60f3\u50cf\u306b\u96e3\u304f\u3042\u308a\u307e\u305b\u3093\u3002\n     36 /* The Mac OS X implementation of unexec makes use of Darwin's `zone'\n     37    memory allocator.  All calls to malloc, realloc, and free in Emacs\n     38    are redirected to unexec_malloc, unexec_realloc, and unexec_free in\n     39    this file.  When temacs is run, all memory requests are handled in\n     40    the zone EmacsZone.  The Darwin memory allocator library calls\n     41    maintain the data structures to manage this zone.  Dumping writes\n     42    its contents to data segments of the executable file.  When emacs\n     43    is run, the loader recreates the contents of the zone in memory.\n     44    However since the initialization routine of the zone memory\n     45    allocator is run again, this `zone' can no longer be used as a\n     46    heap.  That is why emacs uses the ordinary malloc system call to\n     47    allocate memory.  Also, when a block of memory needs to be\n     48    reallocated and the new size is larger than the old one, a new\n     49    block must be obtained by malloc and the old contents copied to\n     50    it.  */\n\n[\u5df7\u3067\u8a71\u984c](http://qiita.com/itckw/items/ff079c7572d6a1acd349)\u306eemacs\u3092macOS\u3067\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n# \u76ee\u7684\n\n- ~~malloc_set_state malloc_get_state\u306a\u3057\u3067\u3082\u30b3\u30f3\u30d1\u30a4\u30eb\u3067\u304d\u308b\u3053\u3068\u3092\u5b9f\u8a3c\u3059\u308b\u3002~~\n- unexec\u3055\u308c\u3066\u3044\u306a\u3044emacs\u306e\u8d77\u52d5\u6642\u9593\u3092\u78ba\u8a8d\u3059\u308b\n\n\u8ffd\u8a18\uff1amalloc_get_state/malloc_set_state\u306fOSX\u3067\u306f\u305d\u3082\u305d\u3082\u4f7f\u308f\u308c\u3066\u3044\u306a\u3044\u306e\u3067\u3001\u5b9f\u8a3c\u3059\u308b\u610f\u5473\u304c\u3042\u308a\u307e\u305b\u3093\u3067\u3057\u305f\u3002\n\n# \u74b0\u5883\n\n- macOS Sierra 10.12.2\n- \u30b3\u30f3\u30d1\u30a4\u30e9 Apple LLVM 8.0.0 (clang-800.0.42.1)\n\n# \u30b3\u30f3\u30d1\u30a4\u30eb\u624b\u9806\n\n\n```bash\nwget http://ftp.gnu.org/gnu/emacs/emacs-25.1.tar.gz\ntar xf emacs-25.1.tar.gz\ncd emacs-25.1\n\n# /usr/local\u306b\u4f59\u8a08\u306a\u3082\u306e\u304c\u305f\u304f\u3055\u3093\u3042\u308b\u306e\u3067\u3001\u6a19\u6e96\u306e\u30d1\u30b9\u3060\u3051\u4f7f\u3046\nexport PATH=/usr/bin:/bin:/usr/sbin:/sbin\n\n./configure\n# GNU malloc\u306f\u4f7f\u308f\u306a\u3044\u8a2d\u5b9a\u306b\u306a\u308b\u3002\n#   Should Emacs use the GNU version of malloc?             no\n\ntime make\n\n# real\t1m5.474s\n# user\t0m59.310s\n# sys\t0m4.596s\n```\n\ntgz\u306760MB, \u30b3\u30f3\u30d1\u30a4\u30eb\u6642\u95931\u5206\u5f37\u3002\u6700\u8fd1\u306e\u91cd\u91cf\u7d1a\u306e\u30bd\u30d5\u30c8\u306b\u6bd4\u3079\u305f\u3089\u304b\u306a\u308a\u5c0f\u3055\u3044\u3067\u3059\u3002\u30d0\u30a4\u30ca\u30ea\u306fsrc\u306e\u4e0b\u306b\u3067\u304d\u307e\u3059\u3002\n\n# \u8abf\u67fb\n\n~~malloc_set_state malloc_get_state\u3092\u4f7f\u3063\u3066\u3044\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002~~ otool(Linux\u306eldd\u76f8\u5f53)\u3067\u4f55\u3092\u30ed\u30fc\u30c9\u3059\u308b\u306e\u304b\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3059\u3002\n\n```\n$ otool -L src/emacs\nsrc/emacs:\n\t/System/Library/Frameworks/AppKit.framework/Versions/C/AppKit (compatibility version 45.0.0, current version 1504.76.0)\n\t/System/Library/Frameworks/IOKit.framework/Versions/A/IOKit (compatibility version 1.0.0, current version 275.0.0)\n\t/usr/local/opt/jpeg/lib/libjpeg.8.dylib (compatibility version 13.0.0, current version 13.0.0)\n\t/usr/lib/libxml2.2.dylib (compatibility version 10.0.0, current version 10.9.0)\n\t/usr/lib/libncurses.5.4.dylib (compatibility version 5.4.0, current version 5.4.0)\n\t/usr/lib/libz.1.dylib (compatibility version 1.0.0, current version 1.2.8)\n\t/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1238.0.0)\n\t/System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation (compatibility version 150.0.0, current version 1348.28.0)\n\t/System/Library/Frameworks/CoreGraphics.framework/Versions/A/CoreGraphics (compatibility version 64.0.0, current version 1070.13.0)\n\t/System/Library/Frameworks/CoreText.framework/Versions/A/CoreText (compatibility version 1.0.0, current version 1.0.0)\n\t/System/Library/Frameworks/Foundation.framework/Versions/C/Foundation (compatibility version 300.0.0, current version 1349.25.0)\n\t/usr/lib/libobjc.A.dylib (compatibility version 1.0.0, current version 228.0.0)\n```\n\nC/Foundation\u304clibc\u76f8\u5f53\u3060\u3068\u601d\u3046\u306e\u3067\u3001malloc\u3092grep\u3057\u3066\u307f\u307e\u3059\u3002malloc_set_state / malloc_get_state\u306f\u3042\u308a\u307e\u305b\u3093\u306d\u3002\n\n\u8ffd\u8a18\uff1a\u305d\u306e\u4ee3\u308f\u308azone\u3092\u4f7f\u3063\u3066\u5b9f\u73fe\u3057\u3066\u3044\u308b\u305d\u3046\u3067\u3059\u3002\u3053\u308c\u306fMacOS\u5c02\u7528\u3089\u3057\u3044\u3067\u3059\n\n\n```\n$ nm /System/Library/Frameworks/Foundation.framework/Versions/C/Foundation | grep malloc\n                 U _malloc\n00000000001b087c t _mallocAcquire\n                 U _malloc_create_zone\n                 U _malloc_default_zone\n                 U _malloc_get_zone_name\n                 U _malloc_good_size\n                 U _malloc_set_zone_name\n                 U _malloc_size\n                 U _malloc_zone_calloc\n                 U _malloc_zone_free\n                 U _malloc_zone_from_ptr\n                 U _malloc_zone_malloc\n                 U _malloc_zone_realloc\n```\n\n# \u8d77\u52d5\n./src/temacs\u3067temacs\u8d77\u52d5\u3002\u3056\u3063\u304f\u308a6\u79d2\u304f\u3089\u3044\u3067\u3059\u3002\u3053\u306eGIF\u52d5\u753b\u306f\u5b9f\u969b\u3088\u308a\u304b\u306a\u308a\u9045\u3044\u3067\u3059\u3002\n\n![temacs.gif](https://qiita-image-store.s3.amazonaws.com/0/13775/f0b59338-f232-eb9c-d860-aebc509ec218.gif)\n\n\u753b\u9762\u306f\u8f09\u305b\u307e\u305b\u3093\u304c./src/emacs -nw\u3067emacs\u3092\u8d77\u52d5\u3057\u305f\u3089\u4e00\u77ac\u3067\u3057\u305f\u3002emacs\u306fdump\u6e08\u307f\u306e\u30d0\u30a4\u30ca\u30ea\u3067Makefile\u3092\u898b\u3066\u898b\u308b\u3068\u3001\u6b21\u306e\u30b3\u30de\u30f3\u30c9\u3067dump\u3057\u3066\u3044\u308b\u69d8\u5b50\u3002\n\n./temacs --batch --load loadup bootstrap\n\n# \u611f\u60f3\uff08\u8003\u5bdf\u3067\u3055\u3048\u306a\u3044\u3067\u3059\uff09\n\n\u3042\u306eelisp\u3092\u30b9\u30eb\u30b9\u30eb\u3068\u30ed\u30fc\u30c9\u3059\u308b\u69d8\u5b50\u3001\u6614\u5927\u5b66\u3067DEC Ultrix\u3092\u4f7f\u3063\u3066\u3044\u305f\u6642\u306b\u898b\u305f\u6c17\u304c\u3059\u308b\u3002\u3068\u3044\u3046\u3053\u3068\u306fUltrix\u306eemacs\u306funexec\u3055\u308c\u3066\u3044\u306a\u304b\u3063\u305f\u306e\u304b\u3082\u3002\u4eca\u3068\u306a\u3063\u3066\u306fGNU libc\u306b\u30ea\u30f3\u30af\u3055\u308c\u3066\u3044\u305f\u306e\u304b\u3069\u3046\u304b\u3082\u308f\u304b\u3089\u306a\u3044\u3051\u3069\u3002\n\n~~Mac\u3067dump\u304c\u3067\u304d\u3066\u3044\u308b\u306e\u306f\u304a\u305d\u3089\u304femacs\u304c\u72ec\u81ea\u306b\u6301\u3063\u3066\u3044\u308b\u4ed5\u7d44\u307f\u306e\u305f\u3081\u304b\u306a\uff1f\u3069\u3053\u304b\u3067\u8aad\u3093\u3060\u6c17\u304c\u3059\u308b\u3002~~ \u8ffd\u8a18: \u30ea\u30f3\u30af\u5148\u306e\u8a18\u4e8b\u306b\u305d\u3046\u660e\u8a18\u3055\u308c\u3066\u3044\u308b\u3002dump\u3067\u304d\u308b\u306e\u306f\u5f53\u305f\u308a\u524d\u3002\n\nemacs\u306e\u8a71\u306f\u304a\u3063\u3055\u3093\u30db\u30a4\u30db\u30a4\u3060\u3068\u81ea\u899a\u3057\u307e\u3057\u305f\u3002\n\n# \u8ffd\u8a18\n\nMac OS\u306eunexec\u306f`src/unexmacosx.c`\u5b9f\u88c5\u3055\u308c\u3066\u3044\u307e\u3057\u305f\u3002\u8aac\u660e\u3092\u8aad\u3093\u3067\u3082\u3088\u304f\u308f\u304b\u308a\u307e\u305b\u3093\u304c\u3001OS\u6bce\u306b\u5b9f\u88c5\u3055\u308c\u3066\u3044\u308bunexec\u304c\u30e1\u30f3\u30c6\u4e0d\u80fd\u306b\u306a\u308b\u306e\u306f\u60f3\u50cf\u306b\u96e3\u304f\u3042\u308a\u307e\u305b\u3093\u3002\n\n```\n     36 /* The Mac OS X implementation of unexec makes use of Darwin's `zone'\n     37    memory allocator.  All calls to malloc, realloc, and free in Emacs\n     38    are redirected to unexec_malloc, unexec_realloc, and unexec_free in\n     39    this file.  When temacs is run, all memory requests are handled in\n     40    the zone EmacsZone.  The Darwin memory allocator library calls\n     41    maintain the data structures to manage this zone.  Dumping writes\n     42    its contents to data segments of the executable file.  When emacs\n     43    is run, the loader recreates the contents of the zone in memory.\n     44    However since the initialization routine of the zone memory\n     45    allocator is run again, this `zone' can no longer be used as a\n     46    heap.  That is why emacs uses the ordinary malloc system call to\n     47    allocate memory.  Also, when a block of memory needs to be\n     48    reallocated and the new size is larger than the old one, a new\n     49    block must be obtained by malloc and the old contents copied to\n     50    it.  */\n```\n"}