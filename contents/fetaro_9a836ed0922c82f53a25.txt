{"context": " More than 1 year has passed since last update.Pacemaker+DRBD+heartbeat\u3067MySQL\u306e\u30af\u30e9\u30b9\u30bf\u69cb\u6210\u3092\u4f5c\u3063\u3066\u307f\u308b\u3002\n\u5229\u7528\u3059\u308b\u30d1\u30c3\u30b1\u30fc\u30b8\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3002\n\nCentOS 5.6\ndrbd83-8.3.12-2.el5.centos\nheartbeat-3.0.3-2.3.el5\npacemaker-1.0.12-1.el5.centos\nmysql-server-5.0.95-1.el5_7.1\n\n\u5404\u30d7\u30ed\u30c0\u30af\u30c8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306fyum\u3067\u51fa\u6765\u308b\u306e\u3067\u5272\u611b\u3002\u57fa\u672c\u7684\u306b\u306f\u516c\u5f0fHP\u3092\u3082\u3068\u306b\u3057\u3066\u3001\u3044\u308d\u3044\u308d\u88dc\u8db3\u3092\u5165\u308c\u3066\u3044\u304d\u307e\u3059\u3002\n\u4f5c\u308b\u74b0\u5883\u306f\u4ee5\u4e0b\u306e\u901a\u308a\n\n\u5171\u6709IP\u300c192.168.4.30\u300d \u306bMySQL\u3092\u7acb\u3066\u308b\n\u30ce\u30fc\u30c9\u300cdb1\u300d\n\n\n\u30b5\u30fc\u30d3\u30b9\u7528\uff1aeth1(192.168.4/24\u306b\u63a5\u7d9a)\n\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u7528\uff1aeth2(IP:192.168.5.31)\u3000\n\n\n\u30ce\u30fc\u30c9\u300cdb2\u300d\n\n\n\u30b5\u30fc\u30d3\u30b9\u7528\uff1aeth1(192.168.4/24\u306b\u63a5\u7d9a)\n** \u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u7528\uff1aeth2(IP:192.168.5.32)\u3000\n\n\n\n\n\u6e96\u5099\n\u307e\u305aDRBD\u306e\u8a2d\u5b9a\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3002/etc/drbd.conf\u3092\u7de8\u96c6\u3002 (DRBD\u306e\u521d\u671f\u5316\u4f5c\u696d\u306f\u5272\u611b\u3055\u305b\u3066\u3082\u3089\u3044\u307e\u3059\u3002 )\nresource r0 {\n    protocol C;\n    device /dev/drbd0;\n    meta-disk internal;\n\n    on db1 {\n        address 192.168.5.31:7801;\n        disk /dev/xvdb1;\n    }\n    on db2 {\n        address 192.168.5.32:7801;\n        disk /dev/xvdb1;\n    }\n}\n\nheartbeat\u306e\u8a2d\u5b9a\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3002/etc/ha.d/ha.cf\u3092\u7de8\u96c6\u3002\npacemaker on\nlogfile /var/log/ha-log\nlogfacility     local0\nkeepalive 2\nudpport 694\nucast eth2 192.168.5.32 #\u2190db2\u306e\u65b9\u306f192.168.5.31\nnode    db1\nnode    db2\n\n\u6b21\u306b\u3001mysql\u306e\u30c7\u30fc\u30bf\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092DRBD\u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u5909\u3048\u308b\u3002/etc/my.cnf\u3092\u7de8\u96c6\u3002\n[mysqld]\ndatadir=/service/mysql  #\u2190DRBD\u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u5bfe\u8c61\u306e/service\u4ee5\u4e0b\u306b\u3059\u308b\n(\u4ee5\u4e0b\u7565)\n\n\u3053\u3053\u307e\u3067\u3067\u304d\u305f\u3089\u3001heartbeat\u3092\u8d77\u52d5\u3002\n# /etc/init.d/heartbeat start \n\n\u8d77\u52d5\u3057\u305f\u3089\u3001crm_mon\u306e\u30b3\u30de\u30f3\u30c9\u3067\u3001\u30af\u30e9\u30b9\u30bf\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3002heartbeat\u304c\u8d77\u52d5\u3059\u308b\u3068\n============\nLast updated: Sat Mar 17 12:01:31 2012\nStack: Heartbeat\nCurrent DC: db2 (88696624-7159-4ad1-bdf3-aac07d645d99) - partition with quorum\nVersion: 1.0.12-unknown\n2 Nodes configured, unknown expected votes\n0 Resources configured.\n============\n\nOnline: [ db1 db2 ]\n\n\u306b\u306a\u308b\u3002\n\u3053\u308c\u3067\u6e96\u5099\u306f\uff2f\uff2b\u3002\n\n\u8a2d\u5b9a\npacemaker\u306e\u8a2d\u5b9a\u306b\u5165\u3063\u3066\u3044\u304f\u3002\u3069\u3061\u3089\u304b\u306e\u30ce\u30fc\u30c9\u3067\u3001crm\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u3001\u8a2d\u5b9a\u30c4\u30fc\u30eb\u3092\u8d77\u52d5\u3002\u305d\u306e\u5f8cconfigure\u3092\u5165\u529b\u3057\u3001\u8a2d\u5b9a\u30e2\u30fc\u30c9\u3078\u3002\n[root@db1 ~]# crm\ncrm(live)# configure\ncrm(live)configure#\n\n\u3053\u306e\u5f8c\u306f\u4ee5\u4e0b\u306e\u9806\u5e8f\u3067\u8a2d\u5b9a\u3057\u3066\u3044\u304f\u3002\n\n\u5168\u4f53\u306e\u8a2d\u5b9a\n\u5171\u6709IP\u30a2\u30c9\u30ec\u30b9\u3092\u30ea\u30bd\u30fc\u30b9\u3068\u3057\u3066\u8ffd\u52a0\nDRBD\u3092\u30ea\u30bd\u30fc\u30b9\u3068\u3057\u3066\u8ffd\u52a0\n\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0(\u30de\u30a6\u30f3\u30c8\u5b9a\u7fa9)\u3092\u30ea\u30bd\u30fc\u30b9\u3068\u3057\u3066\u8ffd\u52a0\nMySQL\u3092\u30ea\u30bd\u30fc\u30b9\u3068\u3057\u3066\u8ffd\u52a0\n\u30ea\u30bd\u30fc\u30b9\u306e\u30b0\u30eb\u30fc\u30d7\u3001\u30ea\u30bd\u30fc\u30b9\u9593\u306e\u5236\u7d04\u30fb\u9806\u5e8f\u306e\u8a2d\u5b9a\n\n\n\u5168\u4f53\u306e\u8a2d\u5b9a\n\u307e\u305a\u5168\u4f53\u306e\u8a2d\u5b9a\u306f\u3001\u4ee5\u4e0b\u30b3\u30de\u30f3\u30c9\u3092crm(live)configure#\u306e\u30d7\u30ed\u30f3\u30d7\u30c8\u306b\u6253\u3061\u8fbc\u3081\u3070\uff2f\uff2b\u3002\nproperty $id=\"cib-bootstrap-options\" no-quorum-policy=\"ignore\" stonith-enabled=\"false\"\n\nno-quorum-policy\u306f\uff12\u53f0\u69cb\u6210\u306e\u5834\u5408\u306f\u5fc5\u305aignore\u306b\u3057\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u3089\u3057\u3044\u3002 stonith-enabled\u306f\u76f8\u624b\u304c\u534a\u6b7b\u306b\u3057\u305f\u5834\u5408\u306b\u6b62\u3081\u3092\u523a\u3059\u6a5f\u80fd\u3060\u3051\u3069\u3001\u6b62\u3081\u3066\u304a\u304f\u3002\n\n\u5171\u6709IP\u30a2\u30c9\u30ec\u30b9\u306e\u30ea\u30bd\u30fc\u30b9\u306e\u8ffd\u52a0\n\u6b21\u306b\u3001\u5171\u6709IP\u30a2\u30c9\u30ec\u30b9\u306e\u30ea\u30bd\u30fc\u30b9\u306e\u8ffd\u52a0\nprimitive ip_mysql ocf:heartbeat:IPaddr2 params ip=\"192.168.4.30\" nic=\"eth1\"\n\n\u300cocf\u300d\u3063\u3066\u3044\u3046\u306e\u306fOpen Cluster Framework\u306e\u7565\u3067\u3001Open Cluster Framework project\u304c \u63a8\u5968\u3059\u308b\u30bf\u30a4\u30d7\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u3002/usr/lib/ocf/resource.d\u4ee5\u4e0b\u306b\u3042\u308b\u3002\n\u3053\u306e\u6bb5\u968e\u3067\u3001\u4e00\u56decommit\u3057\u3066\u6319\u52d5\u3092\u78ba\u8a8d\u3059\u308b\u3002\ncrm(live)configure# commit \n\n\u516c\u5f0fHP\u3067\u306f\u3001\u5168\u90e8\u8a2d\u5b9a\u3057\u3066\u304b\u3089commit\u3059\u308b\u624b\u9806\u306b\u306a\u3063\u3066\u3044\u308b\u304c\u3001\u4e00\u3064\u4e00\u3064\u78ba\u8a8d\u3057\u305f\u307b\u3046\u304c\u78ba\u5b9f\u306a\u306e\u3067\u3001\u3053\u307e\u3081\u306bcommit\u3059\u308b\u306e\u304c\u3088\u3044\u3068\u601d\u3046\u3002\ncommit\u3057\u3066\u3057\u3070\u3089\u304f\u3059\u308b\u3068\u3001crm_mon\u306e\u8868\u793a\u304c\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u308f\u308b\u3002\n============\nLast updated: Sat Mar 17 12:20:37 2012\nStack: Heartbeat\nCurrent DC: db2 (88696624-7159-4ad1-bdf3-aac07d645d99) - partition with quorum\nVersion: 1.0.12-unknown\n2 Nodes configured, unknown expected votes\n1 Resources configured.\n============\n\nOnline: [ db1 db2 ]\n\nip_mysql        (ocf::heartbeat:IPaddr2):       Started db1\u3000(\u2190\u30ea\u30bd\u30fc\u30b9\u304c\u8ffd\u52a0\u3055\u308c\u305f)\n\nifconfig\u3092\u6253\u3064\u3068\u3001\u78ba\u304b\u306bdb1\u306eeth1\u306b192.168.4.30\u304c\u4ed8\u3044\u3066\u3044\u308b\u3053\u3068\u304c\u5206\u304b\u308b\uff08\u5834\u5408\u306b\u3088\u3063\u3066\u306fdb2\u306b\u3064\u304f\u5834\u5408\u3082\u3042\u308b\uff09\u3002\n\nDRBD\u306e\u30ea\u30bd\u30fc\u30b9\u3092\u8ffd\u52a0\n\u6b21\u306b\u3001DRBD\u306e\u30ea\u30bd\u30fc\u30b9\u3092\u8ffd\u52a0\u3057\u3066\u3044\u304f\u3002\nprimitive drbd_mysql ocf:linbit:drbd params drbd_resource=\"r0\"\nms ms_drbd_mysql drbd_mysql meta master-max=\"1\" master-node-max=\"1\" clone-max=\"2\" clone-node-max=\"1\" notify=\"true\"\n\n\u300cms\u300d\u3068\u3044\u3046\u306e\u306f\u3001\u30de\u30b9\u30bf\u30fc\u30b9\u30ec\u30fc\u30d6\u69cb\u6210\u306e\u5834\u5408\u306b\u8a2d\u5b9a\u3059\u308b\u9805\u76ee\u3002\u5185\u5bb9\u306f\u516c\u5f0fHP\u53c2\u7167\u3002\n\u305d\u3093\u3067\u30b3\u30df\u30c3\u30c8\u3059\u308b\u3068\u3001crm_mon\u306e\u8868\u793a\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3002(\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u304c\u77ed\u3044\u3068\u304b\u3044\u3046\u30ef\u30fc\u30cb\u30f3\u30b0\u304c\u51fa\u308b\u304c\u7121\u8996)\n============\nLast updated: Sat Mar 17 12:23:59 2012\nStack: Heartbeat\nCurrent DC: db2 (88696624-7159-4ad1-bdf3-aac07d645d99) - partition with quorum\nVersion: 1.0.12-unknown\n2 Nodes configured, unknown expected votes\n2 Resources configured.\n============\n\nOnline: [ db1 db2 ]\n\nip_mysql        (ocf::heartbeat:IPaddr2):       Started db1\n Master/Slave Set: ms_drbd_mysql\u3000(\u2190\u30ea\u30bd\u30fc\u30b9\u304c\u8ffd\u52a0\u3055\u308c\u305f)\n     Masters: [ db1 ]\n     Slaves: [ db2 ]\n\n\u78ba\u8a8d\u306e\u305f\u3081\u306b\u300ccat /proc/drbd\u300d\u3092\u6253\u3064\u3068\u3001db1\u304cprimary\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u304c\u5206\u304b\u308b\u3002\n\n\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0(\u30de\u30a6\u30f3\u30c8\u5b9a\u7fa9)\u306e\u30ea\u30bd\u30fc\u30b9\u3092\u8ffd\u52a0\n\u7d9a\u3044\u3066\u3001\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u306e\u30ea\u30bd\u30fc\u30b9\u3092\u8ffd\u52a0\u3059\u308b\u3002\nprimitive fs_mysql ocf:heartbeat:Filesystem params device=\"/dev/drbd/by-res/r0\" directory=\"/service/\" fstype=\"ext3\"\n\n\u305d\u3093\u3067\u30b3\u30df\u30c3\u30c8\u3059\u308b\u3068\u3001crm_mon\u306e\u8868\u793a\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3002\n============\nLast updated: Sat Mar 17 13:34:00 2012\nStack: Heartbeat\nCurrent DC: db2 (88696624-7159-4ad1-bdf3-aac07d645d99) - partition with quorum\nVersion: 1.0.12-unknown\n2 Nodes configured, unknown expected votes\n3 Resources configured.\n============\n\nOnline: [ db1 db2 ]\n\nip_mysql        (ocf::heartbeat:IPaddr2):       Started db1\n Master/Slave Set: ms_drbd_mysql\n     Masters: [ db1 ]\n     Slaves: [ db2 ]\nfs_mysql        (ocf::heartbeat:Filesystem):    Started db1\n\n\u78ba\u8a8d\u306e\u305f\u3081\u306b\u300cdf\u300d\u30b3\u30de\u30f3\u30c9\u3092\u6253\u3064\u3068\u3001db1\u3067DRBD\u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u30de\u30a6\u30f3\u30c8\u3057\u3066\u3044\u308b\u3053\u3068\u304c\u5206\u304b\u308b\u3002\n\nMySQL\u306e\u30ea\u30bd\u30fc\u30b9\u306e\u8ffd\u52a0\n\u7d9a\u3044\u3066\u3001MySQL\u306e\u30ea\u30bd\u30fc\u30b9\u306e\u8ffd\u52a0\u3002\nprimitive mysqld lsb:mysqld\n\n\u300clsb\u300d\u3068\u3044\u3046\u306e\u306f\u3001Linux Standard Base\u306e\u7565\u3002Linux\u6a19\u6e96\u3067\u63d0\u4f9b\u3055\u308c\u308b/etc/init.d\u4ee5\u4e0b\u306b\u3042\u308b\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u3053\u3068\u3002\n\u3067\u3001\u30b3\u30df\u30c3\u30c8\u3059\u308b\u3068crm_mon\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308b\u3002\n============\nLast updated: Sat Mar 17 13:35:23 2012\nStack: Heartbeat\nCurrent DC: db2 (88696624-7159-4ad1-bdf3-aac07d645d99) - partition with quorum\nVersion: 1.0.12-unknown\n2 Nodes configured, unknown expected votes\n4 Resources configured.\n============\n\nOnline: [ db1 db2 ]\n\nip_mysql        (ocf::heartbeat:IPaddr2):       Started db1\n Master/Slave Set: ms_drbd_mysql\n     Masters: [ db1 ]\n     Slaves: [ db2 ]\nfs_mysql        (ocf::heartbeat:Filesystem):    Started db1\nmysqld  (lsb:mysqld):   Started db1  (\u2190\u8ffd\u52a0\u3055\u308c\u305f)\n\nSELinux\u304c\u52d5\u3044\u3066\u3044\u308b\u3068\u3001\u5225\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3078\u306e\u30c7\u30fc\u30bf\u4fdd\u5b58\u306f\u3067\u304d\u306a\u3044\u305f\u3081\u3001MySQL\u306e\u8d77\u52d5\u30a8\u30e9\u30fc\u306b\u306a\u308b\u53ef\u80fd\u6027\u3042\u308a\u3002SELinux\u3092\u5207\u308c\u3070\uff2f\uff2b\n\n\u30ea\u30bd\u30fc\u30b9\u306e\u30b0\u30eb\u30fc\u30d7\u3001\u30ea\u30bd\u30fc\u30b9\u9593\u306e\u5236\u7d04\u30fb\u9806\u5e8f\u306e\u8a2d\u5b9a\n\u6700\u5f8c\u306b\u3001\u30ea\u30bd\u30fc\u30b9\u306e\u30b0\u30eb\u30fc\u30d7\u3001\u30ea\u30bd\u30fc\u30b9\u9593\u306e\u5236\u7d04\u30fb\u9806\u5e8f\u306e\u8a2d\u5b9a\u3059\u308b\u3002\ngroup     mysql fs_mysql ip_mysql mysqld\ncolocation mysql_on_drbd inf: mysql ms_drbd_mysql:Master\norder      mysql_after_drbd inf: ms_drbd_mysql:promote mysql:start\n\n\u8a2d\u5b9a\u306e\u610f\u5473\u306f\u3001\n\uff11\u884c\u76ee\u306f\u300c\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3068\u5171\u6709IP\u3068MySQL\u3092\u30b0\u30eb\u30fc\u30d7\u300emysql\u300f\u306b\u6307\u5b9a\u300d\n\uff12\u884c\u76ee\u306f\u300cmysql\u30b0\u30eb\u30fc\u30d7\u3068DRBD\u306e\u30de\u30b9\u30bf\u30fc\u306f\u540c\u6642\u306b\u5b58\u5728\u3057\u306a\u304f\u3066\u306f\u306a\u3089\u306a\u3044\u300d\n\uff13\u884c\u76ee\u306f\u300cDRBD\u306e\u30de\u30b9\u30bf\u30fc\u304c\u8d77\u52d5\u3057\u305f\u5f8c\u306b\u3001mysql\u30b0\u30eb\u30fc\u30d7\u304c\u8d77\u52d5\u3057\u306a\u304f\u3066\u306f\u306a\u3089\u306a\u3044\u300d\n\n\u3053\u306e\u6307\u5b9a\u306b\u3088\u3063\u3066\u3001\u4eee\u306b\u3061\u3050\u306f\u3050\u306b\u30ea\u30bd\u30fc\u30b9\u304c\u914d\u7f6e\u3055\u308c\u3044\u305f\u3068\u3057\u3066\u3082\u3001\u4e0a\u8a18\u306e\u5236\u7d04\u306b\u5f93\u3063\u3066\u81ea\u52d5\u7684\u306b\u518d\u914d\u7f6e\u304c\u884c\u308f\u308c\u308b\u3002\n\u3053\u306e\u300cinf:\u300d\u3068\u3044\u3046\u6587\u5b57\u5217\u306f\u8b0e\u3067\u3001\u516c\u5f0fHP\u3092\u8aad\u3093\u3067\u3082\u4f55\u3082\u66f8\u3044\u3066\u3044\u306a\u3044\uff08\u7b46\u8005\u306fInfinity\u306e\u7565\u3067\u306f\u306a\u3044\u304b\u3068\u601d\u3063\u3066\u3044\u308b\uff09\u3002\u3088\u304f\u308f\u304b\u3089\u306a\u3044\u306e\u3067\u3001\u4ed5\u65b9\u306a\u304f\u3044\u308f\u308c\u308b\u304c\u307e\u307e\u306b\u6307\u5b9a\u3057\u3066\u3044\u308b\u3002\u305b\u3081\u3066\u516c\u5f0fHP\u306b\u306f\u30aa\u30d7\u30b7\u30e7\u30f3\u306e\u610f\u5473\u3050\u3089\u3044\u66f8\u3044\u3066\u307b\u3057\u3044\u3068\u3053\u308d\u3060\u3002\n\u6700\u7d42\u7684\u306bcrm_mon\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308b\u3002\n============\nLast updated: Sat Mar 17 13:36:23 2012\nStack: Heartbeat\nCurrent DC: db2 (88696624-7159-4ad1-bdf3-aac07d645d99) - partition with quorum\nVersion: 1.0.12-unknown\n2 Nodes configured, unknown expected votes\n2 Resources configured.\n============\n\nOnline: [ db1 db2 ]\n\n Master/Slave Set: ms_drbd_mysql\n     Masters: [ db1 ]\n     Slaves: [ db2 ]\n Resource Group: mysql (\u2190\u307e\u3068\u307e\u3063\u305f)\n     fs_mysql   (ocf::heartbeat:Filesystem):    Started db1\n     ip_mysql   (ocf::heartbeat:IPaddr2):       Started db1\n     mysqld     (lsb:mysqld):   Started db1\n\n\n\u8a2d\u5b9a\u306e\u30ea\u30bb\u30c3\u30c8\n\u3061\u306a\u307f\u306b\u3001\u8a2d\u5b9a\u306b\u5931\u6557\u3057\u305f\u5834\u5408\u306f\u3001\u4ee5\u4e0b\u306e\u624b\u9806\u3067\u30ea\u30bb\u30c3\u30c8\u3067\u304d\u308b\u3002\n# /etc/init.d/heartbeat stop\n# rm -rf /var/lib/heartbeat/crm/*\n\nPacemaker+DRBD+heartbeat\u3067MySQL\u306e\u30af\u30e9\u30b9\u30bf\u69cb\u6210\u3092\u4f5c\u3063\u3066\u307f\u308b\u3002\n\n\u5229\u7528\u3059\u308b\u30d1\u30c3\u30b1\u30fc\u30b8\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3002\n\n* CentOS 5.6\n* drbd83-8.3.12-2.el5.centos\n* heartbeat-3.0.3-2.3.el5\n* pacemaker-1.0.12-1.el5.centos\n* mysql-server-5.0.95-1.el5_7.1\n\n\u5404\u30d7\u30ed\u30c0\u30af\u30c8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306fyum\u3067\u51fa\u6765\u308b\u306e\u3067\u5272\u611b\u3002\u57fa\u672c\u7684\u306b\u306f\u516c\u5f0fHP\u3092\u3082\u3068\u306b\u3057\u3066\u3001\u3044\u308d\u3044\u308d\u88dc\u8db3\u3092\u5165\u308c\u3066\u3044\u304d\u307e\u3059\u3002\n\n\u4f5c\u308b\u74b0\u5883\u306f\u4ee5\u4e0b\u306e\u901a\u308a\n\n* \u5171\u6709IP\u300c192.168.4.30\u300d \u306bMySQL\u3092\u7acb\u3066\u308b\n* \u30ce\u30fc\u30c9\u300cdb1\u300d\n * \u30b5\u30fc\u30d3\u30b9\u7528\uff1aeth1(192.168.4/24\u306b\u63a5\u7d9a)\n * \u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u7528\uff1aeth2(IP:192.168.5.31)\u3000\n* \u30ce\u30fc\u30c9\u300cdb2\u300d\n * \u30b5\u30fc\u30d3\u30b9\u7528\uff1aeth1(192.168.4/24\u306b\u63a5\u7d9a)\n** \u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u7528\uff1aeth2(IP:192.168.5.32)\u3000\n\n\u6e96\u5099\n=================\n\n\u307e\u305aDRBD\u306e\u8a2d\u5b9a\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3002/etc/drbd.conf\u3092\u7de8\u96c6\u3002 (DRBD\u306e\u521d\u671f\u5316\u4f5c\u696d\u306f\u5272\u611b\u3055\u305b\u3066\u3082\u3089\u3044\u307e\u3059\u3002 )\n\n    resource r0 {\n        protocol C;\n        device /dev/drbd0;\n        meta-disk internal;\n\n        on db1 {\n            address 192.168.5.31:7801;\n            disk /dev/xvdb1;\n        }\n        on db2 {\n            address 192.168.5.32:7801;\n            disk /dev/xvdb1;\n        }\n    }\n\nheartbeat\u306e\u8a2d\u5b9a\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3002/etc/ha.d/ha.cf\u3092\u7de8\u96c6\u3002\n\n    pacemaker on\n    logfile /var/log/ha-log\n    logfacility     local0\n    keepalive 2\n    udpport 694\n    ucast eth2 192.168.5.32 #\u2190db2\u306e\u65b9\u306f192.168.5.31\n    node    db1\n    node    db2\n\n\u6b21\u306b\u3001mysql\u306e\u30c7\u30fc\u30bf\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092DRBD\u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u5909\u3048\u308b\u3002/etc/my.cnf\u3092\u7de8\u96c6\u3002\n\n    [mysqld]\n    datadir=/service/mysql  #\u2190DRBD\u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u5bfe\u8c61\u306e/service\u4ee5\u4e0b\u306b\u3059\u308b\n    (\u4ee5\u4e0b\u7565)\n\n\u3053\u3053\u307e\u3067\u3067\u304d\u305f\u3089\u3001heartbeat\u3092\u8d77\u52d5\u3002\n\n    # /etc/init.d/heartbeat start \n\n\u8d77\u52d5\u3057\u305f\u3089\u3001crm_mon\u306e\u30b3\u30de\u30f3\u30c9\u3067\u3001\u30af\u30e9\u30b9\u30bf\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3002heartbeat\u304c\u8d77\u52d5\u3059\u308b\u3068\n\n    ============\n    Last updated: Sat Mar 17 12:01:31 2012\n    Stack: Heartbeat\n    Current DC: db2 (88696624-7159-4ad1-bdf3-aac07d645d99) - partition with quorum\n    Version: 1.0.12-unknown\n    2 Nodes configured, unknown expected votes\n    0 Resources configured.\n    ============\n\n    Online: [ db1 db2 ]\n\n\u306b\u306a\u308b\u3002\n\n\u3053\u308c\u3067\u6e96\u5099\u306f\uff2f\uff2b\u3002\n\n\u8a2d\u5b9a\n================\n\npacemaker\u306e\u8a2d\u5b9a\u306b\u5165\u3063\u3066\u3044\u304f\u3002\u3069\u3061\u3089\u304b\u306e\u30ce\u30fc\u30c9\u3067\u3001crm\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u3001\u8a2d\u5b9a\u30c4\u30fc\u30eb\u3092\u8d77\u52d5\u3002\u305d\u306e\u5f8cconfigure\u3092\u5165\u529b\u3057\u3001\u8a2d\u5b9a\u30e2\u30fc\u30c9\u3078\u3002\n\n    [root@db1 ~]# crm\n    crm(live)# configure\n    crm(live)configure#\n\n\u3053\u306e\u5f8c\u306f\u4ee5\u4e0b\u306e\u9806\u5e8f\u3067\u8a2d\u5b9a\u3057\u3066\u3044\u304f\u3002\n\n1. \u5168\u4f53\u306e\u8a2d\u5b9a\n2. \u5171\u6709IP\u30a2\u30c9\u30ec\u30b9\u3092\u30ea\u30bd\u30fc\u30b9\u3068\u3057\u3066\u8ffd\u52a0\n3. DRBD\u3092\u30ea\u30bd\u30fc\u30b9\u3068\u3057\u3066\u8ffd\u52a0\n4. \u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0(\u30de\u30a6\u30f3\u30c8\u5b9a\u7fa9)\u3092\u30ea\u30bd\u30fc\u30b9\u3068\u3057\u3066\u8ffd\u52a0\n5. MySQL\u3092\u30ea\u30bd\u30fc\u30b9\u3068\u3057\u3066\u8ffd\u52a0\n6. \u30ea\u30bd\u30fc\u30b9\u306e\u30b0\u30eb\u30fc\u30d7\u3001\u30ea\u30bd\u30fc\u30b9\u9593\u306e\u5236\u7d04\u30fb\u9806\u5e8f\u306e\u8a2d\u5b9a\n\n\u5168\u4f53\u306e\u8a2d\u5b9a\n----------------\n\n\u307e\u305a\u5168\u4f53\u306e\u8a2d\u5b9a\u306f\u3001\u4ee5\u4e0b\u30b3\u30de\u30f3\u30c9\u3092crm(live)configure#\u306e\u30d7\u30ed\u30f3\u30d7\u30c8\u306b\u6253\u3061\u8fbc\u3081\u3070\uff2f\uff2b\u3002\n\n    property $id=\"cib-bootstrap-options\" no-quorum-policy=\"ignore\" stonith-enabled=\"false\"\n\nno-quorum-policy\u306f\uff12\u53f0\u69cb\u6210\u306e\u5834\u5408\u306f\u5fc5\u305aignore\u306b\u3057\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u3089\u3057\u3044\u3002 stonith-enabled\u306f\u76f8\u624b\u304c\u534a\u6b7b\u306b\u3057\u305f\u5834\u5408\u306b\u6b62\u3081\u3092\u523a\u3059\u6a5f\u80fd\u3060\u3051\u3069\u3001\u6b62\u3081\u3066\u304a\u304f\u3002\n\n\u5171\u6709IP\u30a2\u30c9\u30ec\u30b9\u306e\u30ea\u30bd\u30fc\u30b9\u306e\u8ffd\u52a0\n--------------------------------\n\n\u6b21\u306b\u3001\u5171\u6709IP\u30a2\u30c9\u30ec\u30b9\u306e\u30ea\u30bd\u30fc\u30b9\u306e\u8ffd\u52a0\n\n    primitive ip_mysql ocf:heartbeat:IPaddr2 params ip=\"192.168.4.30\" nic=\"eth1\"\n\n\u300cocf\u300d\u3063\u3066\u3044\u3046\u306e\u306fOpen Cluster Framework\u306e\u7565\u3067\u3001Open Cluster Framework project\u304c \u63a8\u5968\u3059\u308b\u30bf\u30a4\u30d7\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u3002/usr/lib/ocf/resource.d\u4ee5\u4e0b\u306b\u3042\u308b\u3002\n\n\u3053\u306e\u6bb5\u968e\u3067\u3001\u4e00\u56decommit\u3057\u3066\u6319\u52d5\u3092\u78ba\u8a8d\u3059\u308b\u3002\n\n    crm(live)configure# commit \n\n\u516c\u5f0fHP\u3067\u306f\u3001\u5168\u90e8\u8a2d\u5b9a\u3057\u3066\u304b\u3089commit\u3059\u308b\u624b\u9806\u306b\u306a\u3063\u3066\u3044\u308b\u304c\u3001\u4e00\u3064\u4e00\u3064\u78ba\u8a8d\u3057\u305f\u307b\u3046\u304c\u78ba\u5b9f\u306a\u306e\u3067\u3001\u3053\u307e\u3081\u306bcommit\u3059\u308b\u306e\u304c\u3088\u3044\u3068\u601d\u3046\u3002\n\ncommit\u3057\u3066\u3057\u3070\u3089\u304f\u3059\u308b\u3068\u3001crm_mon\u306e\u8868\u793a\u304c\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u308f\u308b\u3002\n\n    ============\n    Last updated: Sat Mar 17 12:20:37 2012\n    Stack: Heartbeat\n    Current DC: db2 (88696624-7159-4ad1-bdf3-aac07d645d99) - partition with quorum\n    Version: 1.0.12-unknown\n    2 Nodes configured, unknown expected votes\n    1 Resources configured.\n    ============\n\n    Online: [ db1 db2 ]\n\n    ip_mysql        (ocf::heartbeat:IPaddr2):       Started db1\u3000(\u2190\u30ea\u30bd\u30fc\u30b9\u304c\u8ffd\u52a0\u3055\u308c\u305f)\n\nifconfig\u3092\u6253\u3064\u3068\u3001\u78ba\u304b\u306bdb1\u306eeth1\u306b192.168.4.30\u304c\u4ed8\u3044\u3066\u3044\u308b\u3053\u3068\u304c\u5206\u304b\u308b\uff08\u5834\u5408\u306b\u3088\u3063\u3066\u306fdb2\u306b\u3064\u304f\u5834\u5408\u3082\u3042\u308b\uff09\u3002\n\nDRBD\u306e\u30ea\u30bd\u30fc\u30b9\u3092\u8ffd\u52a0\n------------------------\n\n\u6b21\u306b\u3001DRBD\u306e\u30ea\u30bd\u30fc\u30b9\u3092\u8ffd\u52a0\u3057\u3066\u3044\u304f\u3002\n\n    primitive drbd_mysql ocf:linbit:drbd params drbd_resource=\"r0\"\n    ms ms_drbd_mysql drbd_mysql meta master-max=\"1\" master-node-max=\"1\" clone-max=\"2\" clone-node-max=\"1\" notify=\"true\"\n\n\u300cms\u300d\u3068\u3044\u3046\u306e\u306f\u3001\u30de\u30b9\u30bf\u30fc\u30b9\u30ec\u30fc\u30d6\u69cb\u6210\u306e\u5834\u5408\u306b\u8a2d\u5b9a\u3059\u308b\u9805\u76ee\u3002\u5185\u5bb9\u306f\u516c\u5f0fHP\u53c2\u7167\u3002\n\n\u305d\u3093\u3067\u30b3\u30df\u30c3\u30c8\u3059\u308b\u3068\u3001crm_mon\u306e\u8868\u793a\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3002(\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u304c\u77ed\u3044\u3068\u304b\u3044\u3046\u30ef\u30fc\u30cb\u30f3\u30b0\u304c\u51fa\u308b\u304c\u7121\u8996)\n\n    ============\n    Last updated: Sat Mar 17 12:23:59 2012\n    Stack: Heartbeat\n    Current DC: db2 (88696624-7159-4ad1-bdf3-aac07d645d99) - partition with quorum\n    Version: 1.0.12-unknown\n    2 Nodes configured, unknown expected votes\n    2 Resources configured.\n    ============\n\n    Online: [ db1 db2 ]\n\n    ip_mysql        (ocf::heartbeat:IPaddr2):       Started db1\n     Master/Slave Set: ms_drbd_mysql\u3000(\u2190\u30ea\u30bd\u30fc\u30b9\u304c\u8ffd\u52a0\u3055\u308c\u305f)\n         Masters: [ db1 ]\n         Slaves: [ db2 ]\n\n\u78ba\u8a8d\u306e\u305f\u3081\u306b\u300ccat /proc/drbd\u300d\u3092\u6253\u3064\u3068\u3001db1\u304cprimary\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u304c\u5206\u304b\u308b\u3002\n\n\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0(\u30de\u30a6\u30f3\u30c8\u5b9a\u7fa9)\u306e\u30ea\u30bd\u30fc\u30b9\u3092\u8ffd\u52a0\n-----------------------------------------\n\n\u7d9a\u3044\u3066\u3001\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u306e\u30ea\u30bd\u30fc\u30b9\u3092\u8ffd\u52a0\u3059\u308b\u3002\n\n    primitive fs_mysql ocf:heartbeat:Filesystem params device=\"/dev/drbd/by-res/r0\" directory=\"/service/\" fstype=\"ext3\"\n\n\u305d\u3093\u3067\u30b3\u30df\u30c3\u30c8\u3059\u308b\u3068\u3001crm_mon\u306e\u8868\u793a\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3002\n\n    ============\n    Last updated: Sat Mar 17 13:34:00 2012\n    Stack: Heartbeat\n    Current DC: db2 (88696624-7159-4ad1-bdf3-aac07d645d99) - partition with quorum\n    Version: 1.0.12-unknown\n    2 Nodes configured, unknown expected votes\n    3 Resources configured.\n    ============\n\n    Online: [ db1 db2 ]\n\n    ip_mysql        (ocf::heartbeat:IPaddr2):       Started db1\n     Master/Slave Set: ms_drbd_mysql\n         Masters: [ db1 ]\n         Slaves: [ db2 ]\n    fs_mysql        (ocf::heartbeat:Filesystem):    Started db1\n\n\u78ba\u8a8d\u306e\u305f\u3081\u306b\u300cdf\u300d\u30b3\u30de\u30f3\u30c9\u3092\u6253\u3064\u3068\u3001db1\u3067DRBD\u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u30de\u30a6\u30f3\u30c8\u3057\u3066\u3044\u308b\u3053\u3068\u304c\u5206\u304b\u308b\u3002\n\nMySQL\u306e\u30ea\u30bd\u30fc\u30b9\u306e\u8ffd\u52a0\n-------------------------\n\n\u7d9a\u3044\u3066\u3001MySQL\u306e\u30ea\u30bd\u30fc\u30b9\u306e\u8ffd\u52a0\u3002\n\n    primitive mysqld lsb:mysqld\n\n\u300clsb\u300d\u3068\u3044\u3046\u306e\u306f\u3001Linux Standard Base\u306e\u7565\u3002Linux\u6a19\u6e96\u3067\u63d0\u4f9b\u3055\u308c\u308b/etc/init.d\u4ee5\u4e0b\u306b\u3042\u308b\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u3053\u3068\u3002\n\n\u3067\u3001\u30b3\u30df\u30c3\u30c8\u3059\u308b\u3068crm_mon\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308b\u3002\n\n    ============\n    Last updated: Sat Mar 17 13:35:23 2012\n    Stack: Heartbeat\n    Current DC: db2 (88696624-7159-4ad1-bdf3-aac07d645d99) - partition with quorum\n    Version: 1.0.12-unknown\n    2 Nodes configured, unknown expected votes\n    4 Resources configured.\n    ============\n\n    Online: [ db1 db2 ]\n\n    ip_mysql        (ocf::heartbeat:IPaddr2):       Started db1\n     Master/Slave Set: ms_drbd_mysql\n         Masters: [ db1 ]\n         Slaves: [ db2 ]\n    fs_mysql        (ocf::heartbeat:Filesystem):    Started db1\n    mysqld  (lsb:mysqld):   Started db1  (\u2190\u8ffd\u52a0\u3055\u308c\u305f)\n\nSELinux\u304c\u52d5\u3044\u3066\u3044\u308b\u3068\u3001\u5225\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3078\u306e\u30c7\u30fc\u30bf\u4fdd\u5b58\u306f\u3067\u304d\u306a\u3044\u305f\u3081\u3001MySQL\u306e\u8d77\u52d5\u30a8\u30e9\u30fc\u306b\u306a\u308b\u53ef\u80fd\u6027\u3042\u308a\u3002SELinux\u3092\u5207\u308c\u3070\uff2f\uff2b\n\n\u30ea\u30bd\u30fc\u30b9\u306e\u30b0\u30eb\u30fc\u30d7\u3001\u30ea\u30bd\u30fc\u30b9\u9593\u306e\u5236\u7d04\u30fb\u9806\u5e8f\u306e\u8a2d\u5b9a\n------------------------------------------\n\n\u6700\u5f8c\u306b\u3001\u30ea\u30bd\u30fc\u30b9\u306e\u30b0\u30eb\u30fc\u30d7\u3001\u30ea\u30bd\u30fc\u30b9\u9593\u306e\u5236\u7d04\u30fb\u9806\u5e8f\u306e\u8a2d\u5b9a\u3059\u308b\u3002\n\n    group     mysql fs_mysql ip_mysql mysqld\n    colocation mysql_on_drbd inf: mysql ms_drbd_mysql:Master\n    order      mysql_after_drbd inf: ms_drbd_mysql:promote mysql:start\n\n\u8a2d\u5b9a\u306e\u610f\u5473\u306f\u3001\n\n    \uff11\u884c\u76ee\u306f\u300c\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3068\u5171\u6709IP\u3068MySQL\u3092\u30b0\u30eb\u30fc\u30d7\u300emysql\u300f\u306b\u6307\u5b9a\u300d\n    \uff12\u884c\u76ee\u306f\u300cmysql\u30b0\u30eb\u30fc\u30d7\u3068DRBD\u306e\u30de\u30b9\u30bf\u30fc\u306f\u540c\u6642\u306b\u5b58\u5728\u3057\u306a\u304f\u3066\u306f\u306a\u3089\u306a\u3044\u300d\n    \uff13\u884c\u76ee\u306f\u300cDRBD\u306e\u30de\u30b9\u30bf\u30fc\u304c\u8d77\u52d5\u3057\u305f\u5f8c\u306b\u3001mysql\u30b0\u30eb\u30fc\u30d7\u304c\u8d77\u52d5\u3057\u306a\u304f\u3066\u306f\u306a\u3089\u306a\u3044\u300d\n\n\u3053\u306e\u6307\u5b9a\u306b\u3088\u3063\u3066\u3001\u4eee\u306b\u3061\u3050\u306f\u3050\u306b\u30ea\u30bd\u30fc\u30b9\u304c\u914d\u7f6e\u3055\u308c\u3044\u305f\u3068\u3057\u3066\u3082\u3001\u4e0a\u8a18\u306e\u5236\u7d04\u306b\u5f93\u3063\u3066\u81ea\u52d5\u7684\u306b\u518d\u914d\u7f6e\u304c\u884c\u308f\u308c\u308b\u3002\n\n\u3053\u306e\u300cinf:\u300d\u3068\u3044\u3046\u6587\u5b57\u5217\u306f\u8b0e\u3067\u3001\u516c\u5f0fHP\u3092\u8aad\u3093\u3067\u3082\u4f55\u3082\u66f8\u3044\u3066\u3044\u306a\u3044\uff08\u7b46\u8005\u306fInfinity\u306e\u7565\u3067\u306f\u306a\u3044\u304b\u3068\u601d\u3063\u3066\u3044\u308b\uff09\u3002\u3088\u304f\u308f\u304b\u3089\u306a\u3044\u306e\u3067\u3001\u4ed5\u65b9\u306a\u304f\u3044\u308f\u308c\u308b\u304c\u307e\u307e\u306b\u6307\u5b9a\u3057\u3066\u3044\u308b\u3002\u305b\u3081\u3066\u516c\u5f0fHP\u306b\u306f\u30aa\u30d7\u30b7\u30e7\u30f3\u306e\u610f\u5473\u3050\u3089\u3044\u66f8\u3044\u3066\u307b\u3057\u3044\u3068\u3053\u308d\u3060\u3002\n\n\u6700\u7d42\u7684\u306bcrm_mon\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308b\u3002\n\n    ============\n    Last updated: Sat Mar 17 13:36:23 2012\n    Stack: Heartbeat\n    Current DC: db2 (88696624-7159-4ad1-bdf3-aac07d645d99) - partition with quorum\n    Version: 1.0.12-unknown\n    2 Nodes configured, unknown expected votes\n    2 Resources configured.\n    ============\n\n    Online: [ db1 db2 ]\n\n     Master/Slave Set: ms_drbd_mysql\n         Masters: [ db1 ]\n         Slaves: [ db2 ]\n     Resource Group: mysql (\u2190\u307e\u3068\u307e\u3063\u305f)\n         fs_mysql   (ocf::heartbeat:Filesystem):    Started db1\n         ip_mysql   (ocf::heartbeat:IPaddr2):       Started db1\n         mysqld     (lsb:mysqld):   Started db1\n\n\u8a2d\u5b9a\u306e\u30ea\u30bb\u30c3\u30c8\n===================\n\n\u3061\u306a\u307f\u306b\u3001\u8a2d\u5b9a\u306b\u5931\u6557\u3057\u305f\u5834\u5408\u306f\u3001\u4ee5\u4e0b\u306e\u624b\u9806\u3067\u30ea\u30bb\u30c3\u30c8\u3067\u304d\u308b\u3002\n\n    # /etc/init.d/heartbeat stop\n    # rm -rf /var/lib/heartbeat/crm/*\n", "tags": ["pacemaker1.0.12", "drbd8.3.12", "heartbeat3.0.3", "MySQL5.0.95"]}