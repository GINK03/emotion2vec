{"context": " More than 1 year has passed since last update.\n\n\u6982\u8981\nVitess \u3092\u4f7f\u3063\u3066 MySQL \u30af\u30e9\u30b9\u30bf\u3092\u69cb\u7bc9\u3059\u308b\nvitess\nhttps://github.com/youtube/vitess/\n\n\u4e8b\u524d\u6e96\u5099\n\n\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306e\u4f5c\u6210\n\u30b5\u30fc\u30d3\u30b9\u30a2\u30ab\u30a6\u30f3\u30c8\u30ad\u30fc\u306e\u53d6\u5f97\uff08JSON\u5f62\u5f0f\uff09\ngcloud \u8a8d\u8a3c\u6e08\u307f\n\n\n\u30b3\u30f3\u30c6\u30ca\u30af\u30e9\u30b9\u30bf\u4f5c\u6210\n\u4ee5\u524d\u4f5c\u6210\u3057\u305f terraform \u306e\u30b3\u30fc\u30c9\u3092\u30d9\u30fc\u30b9\u306b\u69cb\u7bc9\n\u25a0tf \u30d5\u30a1\u30a4\u30eb\n\nprovider.tf\nprovider \"google\" {\n  credentials = \"${file(\"account.json\")}\"\n  project     = \"${var.project}\"\n  region      = \"${var.region}\"\n}\n\n\n\ncontainer_cluster.tf\nresource \"google_container_cluster\" \"default\" {\n  name = \"${var.cluster_name}\"\n  zone = \"${var.zone}\"\n  network = \"${var.network}\"\n  initial_node_count = \"${var.initial_node_count}\"\n\n  node_config {\n    machine_type = \"${var.machine_type}\"\n    disk_size_gb = \"${var.disk_size}\"\n    oauth_scopes = [\n      \"https://www.googleapis.com/auth/devstorage.read_write\"\n    ]\n  }\n\n  master_auth {\n    username = \"${var.master_auth_username}\"\n    password = \"${var.master_auth_password}\"\n  }\n}\n\n\n\nstorage_bucket.tf\nresource \"google_storage_bucket\" \"image-store\" {\n  name = \"${var.project}-backup-bucket\"\n  location = \"${var.location}\"\n}\n\n\n\nvariables.tf\nvariable \"project\" {}\nvariable \"location\" {\n  default = \"ASIA\"\n}\nvariable \"region\" {\n  default = \"asia-east1\"\n}\nvariable \"cluster_name\" {}\nvariable \"zone\" {}\nvariable \"network\" {}\nvariable \"initial_node_count\" {}\nvariable \"machine_type\" {}\nvariable \"disk_size\" {}\nvariable \"master_auth_username\" {}\nvariable \"master_auth_password\" {}\n\n\n\u25a0terraform.tfvars\n\nterraform.tfvars\n## project\nproject = \"**********\"\n\n## cluster config\ncluster_name = \"vitess-cluster\"\nzone = \"asia-east1-b\"\nnetwork = \"default\"\ninitial_node_count = \"4\"\n\n## node config\nmachine_type = \"n1-standard-2\"\ndisk_size = \"10\"\n\n## master auth\nmaster_auth_username = \"**********\"\nmaster_auth_password = \"**********\"\n\n\n\n\u69cb\u7bc9\u5185\u5bb9\n\n\ncluster\u540d \uff1a vitess-cluster (asia-east1-b)\nnode\u6570 \uff1a 4\u53f0 (n1-standard-2) \u203b\u3053\u308c\u4ee5\u4e0b\u306e\u30b9\u30da\u30c3\u30af\u3060\u3068\u7121\u7406\nnode \u306b\u5bfe\u3057\u3066\u3001\u30b9\u30c8\u30ec\u30fc\u30b8\u3078\u306e read/write \u6a29\u9650\u3092\u4ed8\u4e0e\nBucket\u540d \uff1a [\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d]-backup-bucket \u3067\u4f5c\u6210(ASIA)\n\n\n\n\u30af\u30e9\u30b9\u30bf\u4f5c\u6210\n$ terraform apply\n\n\u305d\u306e\u4ed6\u521d\u671f\u8a2d\u5b9a\n$ gcloud config set project [\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d]\n$ gcloud config set compute/zone asia-east1-b\n$ gcloud config set container/cluster vitess-cluster\n$ gcloud container clusters get-credentials vitess-cluster\n\n\nKubernetes \u4e0a\u3067 Vitess \u74b0\u5883\u3092\u69cb\u7bc9\nvtctlclient \u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ export GOPATH=`pwd`\n$ go get github.com/youtube/vitess/go/cmd/vtctlclient\n$ cp $GOPATH/bin/vtctlclient ~/bin/\n\nVitess \u521d\u671f\u8a2d\u5b9a\n$ cd $GOPATH/src/github.com/youtube/vitess/examples/kubernetes\n$ ./condigure.sh\nBackup Storage (file, gcs) [gcs]: \nGoogle Developers Console Project [\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d]:\nGoogle Cloud Storage bucket for Vitess backups: [\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d]-backup-bucket\nSaving config.sh...\n\netcd \u30af\u30e9\u30b9\u30bf\u69cb\u7bc9\netcd \u8d77\u52d5\u524d\u306b\u5916\u90e8\u304b\u3089\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306b\u30b5\u30fc\u30d3\u30b9\u7528\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u7de8\u96c6\n(\u3053\u308c\u3057\u306a\u3044\u3068\u5916\u90e8\u304b\u3089 WEB UI(vtctld) \u306b\u30a2\u30af\u30bb\u30b9\u3057\u305f\u969b\u306b Topology Browser \u304c\u53c2\u7167\u3067\u304d\u306a\u3044 )\n$ vi ./etcd-service-template.yaml\n spec:\n+  type: LoadBalancer\n   ports:\n     - port: 4001\n\netcd \u8d77\u52d5\n$ ./etcd-up.sh\nCreating etcd service for global cell...\nservice \"etcd-global\" created\nservice \"etcd-global-srv\" created\nCreating etcd replicationcontroller for global cell...\nreplicationcontroller \"etcd-global\" created\nCreating etcd service for test cell...\nservice \"etcd-test\" created\nservice \"etcd-test-srv\" created\nCreating etcd replicationcontroller for test cell...\nreplicationcontroller \"etcd-test\" created\n\n\u30b5\u30fc\u30d3\u30b9\u306e\u72b6\u614b\u78ba\u8a8d\n$ kubectl get svc\nNAME              CLUSTER_IP      EXTERNAL_IP       PORT(S)               SELECTOR                                AGE\netcd-global       10.31.247.111   ***.***.***.***   4001/TCP              app=vitess,cell=global,component=etcd   2m\netcd-global-srv   None            <none>            7001/TCP              app=vitess,cell=global,component=etcd   2m\netcd-test         10.31.244.184   ***.***.***.***   4001/TCP              app=vitess,cell=test,component=etcd     2m\netcd-test-srv     None            <none>            7001/TCP              app=vitess,cell=test,component=etcd     2m\n\nvtctld \u306e\u8d77\u52d5\n\u5916\u90e8\u304b\u3089\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306b\u30b5\u30fc\u30d3\u30b9\u7528\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u7de8\u96c6\n$ vi ./vtctld-service.yaml\n spec:\n+  type: LoadBalancer\n   ports:\n     - name: web\n\nvtctld \u8d77\u52d5\n$ ./vtctld-up.sh\nCreating vtctld service...\nservice \"vtctld\" created\nCreating vtctld replicationcontroller...\nreplicationcontroller \"vtctld\" created\n\nTo access vtctld web UI, start kubectl proxy in another terminal:\n  kubectl proxy --port=8001\nThen visit http://localhost:8001/api/v1/proxy/namespaces/default/services/vtctld:web/\n\n\u30b5\u30fc\u30d3\u30b9\u306e\u72b6\u614b\u78ba\u8a8d\n$ kubectl get svc\nNAME              CLUSTER_IP      EXTERNAL_IP      PORT(S)               SELECTOR                                AGE\nvtctld            10.55.250.136   ***.***.***.***  15000/TCP,15999/TCP   app=vitess,component=vtctld             1m\n\n\u4ee5\u4e0b\u306e\u30a2\u30c9\u30ec\u30b9\u306b\u3066 WEB UI \u306b\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\nhttp://[ EXTERNAL_IP ]:15000/api/v1/proxy/namespaces/default/services/vtctld:web/\n\nvttablet, MySQL Pod \u306e\u4f5c\u6210\n\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3067\u306f\u30ea\u30bd\u30fc\u30b9\u4e0d\u8db3\u3067\u30a8\u30e9\u30fc\u306b\u306a\u308b\u305f\u3081\u4fee\u6b63\n$ ./vttablet-pod-template.yaml\n@@ -30,8 +30,8 @@\n       resources:\n         limits:\n-          memory: \"1Gi\"\n-          cpu: \"500m\"\n+          memory: \"512Mi\"\n+          cpu: \"100m\"\n\n@@ -88,8 +88,8 @@\n       resources:\n         limits:\n-          memory: \"1Gi\"\n-          cpu: \"500m\"\n+          memory: \"512Mi\"\n+          cpu: \"100m\"\n\npod, keyspace \u4f5c\u6210\n$ ./vttablet-up.sh\nCreating test_keyspace.shard-0 pods in cell ...\nCreating pod for tablet test-0000000100...\npod \"vttablet-100\" created\nCreating pod for tablet test-0000000101...\npod \"vttablet-101\" created\nCreating pod for tablet test-0000000102...\npod \"vttablet-102\" created\nCreating pod for tablet test-0000000103...\npod \"vttablet-103\" created\nCreating pod for tablet test-0000000104...\npod \"vttablet-104\" created\n\n$ kubectl get pod\nNAME                READY     STATUS    RESTARTS   AGE\nvttablet-100        2/2       Running   1          1m\nvttablet-101        2/2       Running   1          1m\nvttablet-102        2/2       Running   0          1m\nvttablet-103        2/2       Running   0          1m\nvttablet-104        2/2       Running   0          1m\n\nMySQL \u521d\u671f\u5316\n$ ./kvtctl.sh RebuildKeyspaceGraph test_keyspace\nStarting port forwarding to vtctld...\n\n$ ./kvtctl.sh InitShardMaster -force test_keyspace/0 test-0000000100\nStarting port forwarding to vtctld...\nW1224 04:59:53.996276   20753 main.go:43] W1224 04:59:53.974546 logger.go:256] master-elect tablet est-0000000100 is not the shard master, proceeding anyway as -force was used\nW1224 04:59:53.997008   20753 main.go:43] W1224 04:59:53.975036 logger.go:256] master-elect tablet est-0000000100 is not a master in the shard, proceeding anyway as -force was used\n\n$ ./kvtctl.sh ListAllTablets test\nStarting port forwarding to vtctld...\ntest-0000000100 test_keyspace 0 master 10.28.2.10:15002 10.28.2.10:3306 []\ntest-0000000101 test_keyspace 0 replica 10.28.1.9:15002 10.28.1.9:3306 []\ntest-0000000102 test_keyspace 0 replica 10.28.0.8:15002 10.28.0.8:3306 []\ntest-0000000103 test_keyspace 0 rdonly 10.28.3.6:15002 10.28.3.6:3306 []\ntest-0000000104 test_keyspace 0 rdonly 10.28.3.7:15002 10.28.3.7:3306 []\n\nWEB UI \u304b\u3089 Shard Status \u78ba\u8a8d\n\n\u30c6\u30fc\u30d6\u30eb\u4f5c\u6210\n./kvtctl.sh ApplySchema -sql \"$(cat create_test_table.sql)\" test_keyspace\n\n\u4f5c\u6210\u3057\u305f\u30b9\u30ad\u30fc\u30de\u306e\u78ba\u8a8d\n$ ./kvtctl.sh GetSchema test-0000000100\nStarting port forwarding to vtctld...\n{\n  \"database_schema\": \"CREATE DATABASE /*!32312 IF NOT EXISTS*/ `{{.DatabaseName}}` /*!40100 DEFAULT CHARACTER SET utf8 */\",\n  \"table_definitions\": [\n    {\n      \"name\": \"messages\",\n      \"schema\": \"CREATE TABLE `messages` (\\n  `page` bigint(20) unsigned NOT NULL DEFAULT '0',\\n  `time_created_ns` bigint(20) unsigned NOT NULL DEFAULT '0',\\n  `keyspace_id` bigint(20) unsigned DEFAULT NULL,\\n  `message` varchar(10000) DEFAULT NULL,\\n  PRIMARY KEY (`page`,`time_created_ns`)\\n) ENGINE=InnoDB DEFAULT CHARSET=utf8\",\n      \"columns\": [\n        \"page\",\n        \"time_created_ns\",\n        \"keyspace_id\",\n        \"message\"\n      ],\n      \"primary_key_columns\": [\n        \"page\",\n        \"time_created_ns\"\n      ],\n      \"type\": \"BASE TABLE\",\n      \"data_length\": 16384,\n      \"row_count\": 3\n    }\n  ],\n  \"version\": \"6428d6f8bc7250889e9b57c878333211\"\n}\n\nvtctl \u3067\u53d6\u5f97\u3059\u308b\u5834\u5408\u306f\u4ee5\u4e0b\n$ vtctlclient -server [vtctld \u306e EXTERNAL_IP]:15999 GetSchema test-0000000100\n\nvtgate \u8d77\u52d5\n./vtgate-up.sh\nCreating vtgate service...\nservice \"vtgate\" created\nCreating vtgate replicationcontroller...\nreplicationcontroller \"vtgate\" created\n\n$ kubectl get svc\nNAME              CLUSTER_IP      EXTERNAL_IP       PORT(S)               SELECTOR                                AGE\nvtgate            10.31.252.42    ***.***.***.***   15001/TCP             app=vitess,component=vtgate             2m\n\n\u30b5\u30f3\u30d7\u30eb\u30a2\u30d7\u30ea\u5b9f\u884c\nguestbook \u8d77\u52d5\n$ ./guestbook-up.sh\nCreating guestbook service...\nservice \"guestbook\" created\nCreating guestbook replicationcontroller...\nreplicationcontroller \"guestbook\" created\n\n$ kubectl get svc\nNAME              CLUSTER_IP      EXTERNAL_IP       PORT(S)               SELECTOR                                AGE\nguestbook         10.31.250.204   ***.***.***.***   80/TCP                app=guestbook,component=frontend        2m\n\nhttp://[ EXTERNAL_IP ]/ \u306b\u30a2\u30af\u30bb\u30b9\n\nrandom page. \u306e\u30ea\u30f3\u30af\u3088\u308a\u9069\u5f53\u306b\u5165\u529b\n\nvtctl \u3088\u308a\u78ba\u8a8d\n$ vtctlclient -server [vtctld EXTERNAL_IP]:15999 VtGateExecuteShards -server [vtgate EXTERNAL_IP]:15001 -keyspace test_keyspace -shards 0 -tablet_type rdonly \"show tables\"\n{\n  \"Fields\": [\n    {\n      \"name\": \"Tables_in_vt_test_keyspace\",\n      \"type\": 6165\n    }\n  ],\n  \"RowsAffected\": 1,\n  \"InsertID\": 0,\n  \"Rows\": [\n    [\n      \"messages\"\n    ]\n  ]\n}\n\n\n$ vtctlclient -server [vtctld EXTERNAL_IP]:15999 VtGateExecuteShards -server [vtgate EXTERNAL_IP]:15001 -keyspace test_keyspace -shards 0 -tablet_type rdonly \"SELECT message FROM messages WHERE page=10 ORDER BY time_created_ns\"\n{\n  \"Fields\": [\n    {\n      \"name\": \"message\",\n      \"type\": 6165\n    }\n  ],\n  \"RowsAffected\": 5,\n  \"InsertID\": 0,\n  \"Rows\": [\n    [\n      \"1111111111\"\n    ],\n    [\n      \"2222222222\"\n    ],\n    [\n      \"3333333333\"\n    ],\n    [\n      \"4444444444\"\n    ],\n    [\n      \"5555555555\"\n    ]\n  ]\n}\n\nmaster \u5207\u308a\u66ff\u3048\n\u5207\u308a\u66ff\u3048\u524d\n$ ./kvtctl.sh ListAllTablets test\ntest-0000000100 test_keyspace 0 master 10.28.3.6:15002 10.28.3.6:3306 []\ntest-0000000101 test_keyspace 0 spare 10.28.1.6:15002 10.28.1.6:3306 []\ntest-0000000102 test_keyspace 0 replica 10.28.2.5:15002 10.28.2.5:3306 []\ntest-0000000103 test_keyspace 0 rdonly 10.28.0.6:15002 10.28.0.6:3306 []\ntest-0000000104 test_keyspace 0 rdonly 10.28.3.7:15002 10.28.3.7:3306 []\n\n\u5207\u308a\u66ff\u3048\n$ vtctlclient -server 130.211.252.96:15999 TabletExternallyReparented test-101\n\ntest-101 \u304c master \u306b\u306a\u308b\n$ ./kvtctl.sh ListAllTablets test\ntest-0000000100 test_keyspace 0 replica 10.28.3.6:15002 10.28.3.6:3306 []\ntest-0000000101 test_keyspace 0 master 10.28.1.6:15002 10.28.1.6:3306 []\ntest-0000000102 test_keyspace 0 replica 10.28.2.5:15002 10.28.2.5:3306 []\ntest-0000000103 test_keyspace 0 rdonly 10.28.0.6:15002 10.28.0.6:3306 []\ntest-0000000104 test_keyspace 0 rdonly 10.28.3.7:15002 10.28.3.7:3306 []\n\n\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\nrdonly Pod \u306b\u5bfe\u3057\u3066\u4ee5\u4e0b\u30b3\u30de\u30f3\u30c9\u5b9f\u884c\n$ ./kvtctl.sh Backup test-0000000104\n\nterraform \u3067\u4f5c\u6210\u3057\u305f Bucket \u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3055\u308c\u308b\n\n\u30b3\u30de\u30f3\u30c9\u3067\u78ba\u8a8d\n$ ./kvtctl.sh ListBackups test_keyspace/0\n2015-12-24.051117.test-0000000104\n\n\u30b9\u30b1\u30fc\u30eb\u30a2\u30a6\u30c8\n\u8a66\u305b\u3066\u3044\u306a\u3044\u306e\u3067\u5225\u9014\u30fb\u30fb\u30fb\n# \u6982\u8981\nVitess \u3092\u4f7f\u3063\u3066 MySQL \u30af\u30e9\u30b9\u30bf\u3092\u69cb\u7bc9\u3059\u308b\n\n**vitess**\nhttps://github.com/youtube/vitess/\n\n\n#\u4e8b\u524d\u6e96\u5099\n- \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306e\u4f5c\u6210\n- \u30b5\u30fc\u30d3\u30b9\u30a2\u30ab\u30a6\u30f3\u30c8\u30ad\u30fc\u306e\u53d6\u5f97\uff08JSON\u5f62\u5f0f\uff09\n- gcloud \u8a8d\u8a3c\u6e08\u307f\n\n\n#\u30b3\u30f3\u30c6\u30ca\u30af\u30e9\u30b9\u30bf\u4f5c\u6210\n[\u4ee5\u524d](http://qiita.com/quickguard/items/9fdf263b2f822474305c)\u4f5c\u6210\u3057\u305f terraform \u306e\u30b3\u30fc\u30c9\u3092\u30d9\u30fc\u30b9\u306b\u69cb\u7bc9\n\n\u25a0tf \u30d5\u30a1\u30a4\u30eb\n\n```:provider.tf\nprovider \"google\" {\n  credentials = \"${file(\"account.json\")}\"\n  project     = \"${var.project}\"\n  region      = \"${var.region}\"\n}\n```\n\n```:container_cluster.tf\nresource \"google_container_cluster\" \"default\" {\n  name = \"${var.cluster_name}\"\n  zone = \"${var.zone}\"\n  network = \"${var.network}\"\n  initial_node_count = \"${var.initial_node_count}\"\n\n  node_config {\n    machine_type = \"${var.machine_type}\"\n    disk_size_gb = \"${var.disk_size}\"\n    oauth_scopes = [\n      \"https://www.googleapis.com/auth/devstorage.read_write\"\n    ]\n  }\n\n  master_auth {\n    username = \"${var.master_auth_username}\"\n    password = \"${var.master_auth_password}\"\n  }\n}\n```\n\n```:storage_bucket.tf\nresource \"google_storage_bucket\" \"image-store\" {\n  name = \"${var.project}-backup-bucket\"\n  location = \"${var.location}\"\n}\n```\n\n```:variables.tf\nvariable \"project\" {}\nvariable \"location\" {\n  default = \"ASIA\"\n}\nvariable \"region\" {\n  default = \"asia-east1\"\n}\nvariable \"cluster_name\" {}\nvariable \"zone\" {}\nvariable \"network\" {}\nvariable \"initial_node_count\" {}\nvariable \"machine_type\" {}\nvariable \"disk_size\" {}\nvariable \"master_auth_username\" {}\nvariable \"master_auth_password\" {}\n```\n\n\n\u25a0terraform.tfvars\n\n```:terraform.tfvars\n## project\nproject = \"**********\"\n\n## cluster config\ncluster_name = \"vitess-cluster\"\nzone = \"asia-east1-b\"\nnetwork = \"default\"\ninitial_node_count = \"4\"\n\n## node config\nmachine_type = \"n1-standard-2\"\ndisk_size = \"10\"\n\n## master auth\nmaster_auth_username = \"**********\"\nmaster_auth_password = \"**********\"\n```\n\n- \u69cb\u7bc9\u5185\u5bb9\n  - cluster\u540d \uff1a vitess-cluster (asia-east1-b)\n  - node\u6570 \uff1a 4\u53f0 (n1-standard-2) \u203b\u3053\u308c\u4ee5\u4e0b\u306e\u30b9\u30da\u30c3\u30af\u3060\u3068\u7121\u7406\n  - node \u306b\u5bfe\u3057\u3066\u3001\u30b9\u30c8\u30ec\u30fc\u30b8\u3078\u306e read/write \u6a29\u9650\u3092\u4ed8\u4e0e\n  - Bucket\u540d \uff1a [\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d]-backup-bucket \u3067\u4f5c\u6210(ASIA)\n\n\n\u30af\u30e9\u30b9\u30bf\u4f5c\u6210\n\n```\n$ terraform apply\n```\n\n\u305d\u306e\u4ed6\u521d\u671f\u8a2d\u5b9a\n\n```\n$ gcloud config set project [\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d]\n$ gcloud config set compute/zone asia-east1-b\n$ gcloud config set container/cluster vitess-cluster\n$ gcloud container clusters get-credentials vitess-cluster\n```\n\n#Kubernetes \u4e0a\u3067 Vitess \u74b0\u5883\u3092\u69cb\u7bc9\n\n**vtctlclient \u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb**\n\n```\n$ export GOPATH=`pwd`\n$ go get github.com/youtube/vitess/go/cmd/vtctlclient\n$ cp $GOPATH/bin/vtctlclient ~/bin/\n```\n\n\n**Vitess \u521d\u671f\u8a2d\u5b9a**\n\n```\n$ cd $GOPATH/src/github.com/youtube/vitess/examples/kubernetes\n$ ./condigure.sh\nBackup Storage (file, gcs) [gcs]: \nGoogle Developers Console Project [\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d]:\nGoogle Cloud Storage bucket for Vitess backups: [\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d]-backup-bucket\nSaving config.sh...\n```\n\n**etcd \u30af\u30e9\u30b9\u30bf\u69cb\u7bc9**\n\netcd \u8d77\u52d5\u524d\u306b\u5916\u90e8\u304b\u3089\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306b\u30b5\u30fc\u30d3\u30b9\u7528\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u7de8\u96c6\n(\u3053\u308c\u3057\u306a\u3044\u3068\u5916\u90e8\u304b\u3089 WEB UI(vtctld) \u306b\u30a2\u30af\u30bb\u30b9\u3057\u305f\u969b\u306b Topology Browser \u304c\u53c2\u7167\u3067\u304d\u306a\u3044 )\n\n```\n$ vi ./etcd-service-template.yaml\n spec:\n+  type: LoadBalancer\n   ports:\n     - port: 4001\n```\n\netcd \u8d77\u52d5\n\n```\n$ ./etcd-up.sh\nCreating etcd service for global cell...\nservice \"etcd-global\" created\nservice \"etcd-global-srv\" created\nCreating etcd replicationcontroller for global cell...\nreplicationcontroller \"etcd-global\" created\nCreating etcd service for test cell...\nservice \"etcd-test\" created\nservice \"etcd-test-srv\" created\nCreating etcd replicationcontroller for test cell...\nreplicationcontroller \"etcd-test\" created\n```\n\n\u30b5\u30fc\u30d3\u30b9\u306e\u72b6\u614b\u78ba\u8a8d\n\n```\n$ kubectl get svc\nNAME              CLUSTER_IP      EXTERNAL_IP       PORT(S)               SELECTOR                                AGE\netcd-global       10.31.247.111   ***.***.***.***   4001/TCP              app=vitess,cell=global,component=etcd   2m\netcd-global-srv   None            <none>            7001/TCP              app=vitess,cell=global,component=etcd   2m\netcd-test         10.31.244.184   ***.***.***.***   4001/TCP              app=vitess,cell=test,component=etcd     2m\netcd-test-srv     None            <none>            7001/TCP              app=vitess,cell=test,component=etcd     2m\n```\n\n**vtctld \u306e\u8d77\u52d5**\n\u5916\u90e8\u304b\u3089\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306b\u30b5\u30fc\u30d3\u30b9\u7528\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u7de8\u96c6\n\n```\n$ vi ./vtctld-service.yaml\n spec:\n+  type: LoadBalancer\n   ports:\n     - name: web\n```\n\nvtctld \u8d77\u52d5\n\n```\n$ ./vtctld-up.sh\nCreating vtctld service...\nservice \"vtctld\" created\nCreating vtctld replicationcontroller...\nreplicationcontroller \"vtctld\" created\n\nTo access vtctld web UI, start kubectl proxy in another terminal:\n  kubectl proxy --port=8001\nThen visit http://localhost:8001/api/v1/proxy/namespaces/default/services/vtctld:web/\n```\n\n\u30b5\u30fc\u30d3\u30b9\u306e\u72b6\u614b\u78ba\u8a8d\n\n```\n$ kubectl get svc\nNAME              CLUSTER_IP      EXTERNAL_IP      PORT(S)               SELECTOR                                AGE\nvtctld            10.55.250.136   ***.***.***.***  15000/TCP,15999/TCP   app=vitess,component=vtctld             1m\n```\n\n\u4ee5\u4e0b\u306e\u30a2\u30c9\u30ec\u30b9\u306b\u3066 WEB UI \u306b\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\nhttp://[ EXTERNAL_IP ]:15000/api/v1/proxy/namespaces/default/services/vtctld:web/\n\n![01.png](https://qiita-image-store.s3.amazonaws.com/0/105824/4556379e-beea-3d22-a17b-6ee7e2c5915a.png)\n\n\n\n**vttablet, MySQL Pod \u306e\u4f5c\u6210**\n\n\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3067\u306f\u30ea\u30bd\u30fc\u30b9\u4e0d\u8db3\u3067\u30a8\u30e9\u30fc\u306b\u306a\u308b\u305f\u3081\u4fee\u6b63\n\n```\n$ ./vttablet-pod-template.yaml\n@@ -30,8 +30,8 @@\n       resources:\n         limits:\n-          memory: \"1Gi\"\n-          cpu: \"500m\"\n+          memory: \"512Mi\"\n+          cpu: \"100m\"\n\n@@ -88,8 +88,8 @@\n       resources:\n         limits:\n-          memory: \"1Gi\"\n-          cpu: \"500m\"\n+          memory: \"512Mi\"\n+          cpu: \"100m\"\n```\n\n**pod, keyspace \u4f5c\u6210**\n\n```\n$ ./vttablet-up.sh\nCreating test_keyspace.shard-0 pods in cell ...\nCreating pod for tablet test-0000000100...\npod \"vttablet-100\" created\nCreating pod for tablet test-0000000101...\npod \"vttablet-101\" created\nCreating pod for tablet test-0000000102...\npod \"vttablet-102\" created\nCreating pod for tablet test-0000000103...\npod \"vttablet-103\" created\nCreating pod for tablet test-0000000104...\npod \"vttablet-104\" created\n\n$ kubectl get pod\nNAME                READY     STATUS    RESTARTS   AGE\nvttablet-100        2/2       Running   1          1m\nvttablet-101        2/2       Running   1          1m\nvttablet-102        2/2       Running   0          1m\nvttablet-103        2/2       Running   0          1m\nvttablet-104        2/2       Running   0          1m\n```\n\n**MySQL \u521d\u671f\u5316**\n\n```\n$ ./kvtctl.sh RebuildKeyspaceGraph test_keyspace\nStarting port forwarding to vtctld...\n\n$ ./kvtctl.sh InitShardMaster -force test_keyspace/0 test-0000000100\nStarting port forwarding to vtctld...\nW1224 04:59:53.996276   20753 main.go:43] W1224 04:59:53.974546 logger.go:256] master-elect tablet est-0000000100 is not the shard master, proceeding anyway as -force was used\nW1224 04:59:53.997008   20753 main.go:43] W1224 04:59:53.975036 logger.go:256] master-elect tablet est-0000000100 is not a master in the shard, proceeding anyway as -force was used\n\n$ ./kvtctl.sh ListAllTablets test\nStarting port forwarding to vtctld...\ntest-0000000100 test_keyspace 0 master 10.28.2.10:15002 10.28.2.10:3306 []\ntest-0000000101 test_keyspace 0 replica 10.28.1.9:15002 10.28.1.9:3306 []\ntest-0000000102 test_keyspace 0 replica 10.28.0.8:15002 10.28.0.8:3306 []\ntest-0000000103 test_keyspace 0 rdonly 10.28.3.6:15002 10.28.3.6:3306 []\ntest-0000000104 test_keyspace 0 rdonly 10.28.3.7:15002 10.28.3.7:3306 []\n```\n\nWEB UI \u304b\u3089 Shard Status \u78ba\u8a8d\n![02.png](https://qiita-image-store.s3.amazonaws.com/0/105824/cc66efef-468c-180d-4cac-98f6c65c7b01.png)\n\n\n**\u30c6\u30fc\u30d6\u30eb\u4f5c\u6210**\n\n```\n./kvtctl.sh ApplySchema -sql \"$(cat create_test_table.sql)\" test_keyspace\n```\n\n\u4f5c\u6210\u3057\u305f\u30b9\u30ad\u30fc\u30de\u306e\u78ba\u8a8d\n\n```\n$ ./kvtctl.sh GetSchema test-0000000100\nStarting port forwarding to vtctld...\n{\n  \"database_schema\": \"CREATE DATABASE /*!32312 IF NOT EXISTS*/ `{{.DatabaseName}}` /*!40100 DEFAULT CHARACTER SET utf8 */\",\n  \"table_definitions\": [\n    {\n      \"name\": \"messages\",\n      \"schema\": \"CREATE TABLE `messages` (\\n  `page` bigint(20) unsigned NOT NULL DEFAULT '0',\\n  `time_created_ns` bigint(20) unsigned NOT NULL DEFAULT '0',\\n  `keyspace_id` bigint(20) unsigned DEFAULT NULL,\\n  `message` varchar(10000) DEFAULT NULL,\\n  PRIMARY KEY (`page`,`time_created_ns`)\\n) ENGINE=InnoDB DEFAULT CHARSET=utf8\",\n      \"columns\": [\n        \"page\",\n        \"time_created_ns\",\n        \"keyspace_id\",\n        \"message\"\n      ],\n      \"primary_key_columns\": [\n        \"page\",\n        \"time_created_ns\"\n      ],\n      \"type\": \"BASE TABLE\",\n      \"data_length\": 16384,\n      \"row_count\": 3\n    }\n  ],\n  \"version\": \"6428d6f8bc7250889e9b57c878333211\"\n}\n```\n\nvtctl \u3067\u53d6\u5f97\u3059\u308b\u5834\u5408\u306f\u4ee5\u4e0b\n\n```\n$ vtctlclient -server [vtctld \u306e EXTERNAL_IP]:15999 GetSchema test-0000000100\n```\n\n\n**vtgate \u8d77\u52d5**\n\n```\n./vtgate-up.sh\nCreating vtgate service...\nservice \"vtgate\" created\nCreating vtgate replicationcontroller...\nreplicationcontroller \"vtgate\" created\n\n$ kubectl get svc\nNAME              CLUSTER_IP      EXTERNAL_IP       PORT(S)               SELECTOR                                AGE\nvtgate            10.31.252.42    ***.***.***.***   15001/TCP             app=vitess,component=vtgate             2m\n```\n\n**\u30b5\u30f3\u30d7\u30eb\u30a2\u30d7\u30ea\u5b9f\u884c**\nguestbook \u8d77\u52d5\n\n```\n$ ./guestbook-up.sh\nCreating guestbook service...\nservice \"guestbook\" created\nCreating guestbook replicationcontroller...\nreplicationcontroller \"guestbook\" created\n\n$ kubectl get svc\nNAME              CLUSTER_IP      EXTERNAL_IP       PORT(S)               SELECTOR                                AGE\nguestbook         10.31.250.204   ***.***.***.***   80/TCP                app=guestbook,component=frontend        2m\n```\n\nhttp://[ EXTERNAL_IP ]/ \u306b\u30a2\u30af\u30bb\u30b9\n![top.png](https://qiita-image-store.s3.amazonaws.com/0/105824/810152c2-8fc7-4bc9-4c32-6c97513d99ce.png)\n\nrandom page. \u306e\u30ea\u30f3\u30af\u3088\u308a\u9069\u5f53\u306b\u5165\u529b\n![03.png](https://qiita-image-store.s3.amazonaws.com/0/105824/3f52305e-4670-03b3-6560-26cb66a3dc06.png)\n\n\n vtctl \u3088\u308a\u78ba\u8a8d\n\n```\n$ vtctlclient -server [vtctld EXTERNAL_IP]:15999 VtGateExecuteShards -server [vtgate EXTERNAL_IP]:15001 -keyspace test_keyspace -shards 0 -tablet_type rdonly \"show tables\"\n{\n  \"Fields\": [\n    {\n      \"name\": \"Tables_in_vt_test_keyspace\",\n      \"type\": 6165\n    }\n  ],\n  \"RowsAffected\": 1,\n  \"InsertID\": 0,\n  \"Rows\": [\n    [\n      \"messages\"\n    ]\n  ]\n}\n\n\n$ vtctlclient -server [vtctld EXTERNAL_IP]:15999 VtGateExecuteShards -server [vtgate EXTERNAL_IP]:15001 -keyspace test_keyspace -shards 0 -tablet_type rdonly \"SELECT message FROM messages WHERE page=10 ORDER BY time_created_ns\"\n{\n  \"Fields\": [\n    {\n      \"name\": \"message\",\n      \"type\": 6165\n    }\n  ],\n  \"RowsAffected\": 5,\n  \"InsertID\": 0,\n  \"Rows\": [\n    [\n      \"1111111111\"\n    ],\n    [\n      \"2222222222\"\n    ],\n    [\n      \"3333333333\"\n    ],\n    [\n      \"4444444444\"\n    ],\n    [\n      \"5555555555\"\n    ]\n  ]\n}\n```\n\n**master \u5207\u308a\u66ff\u3048**\n\u5207\u308a\u66ff\u3048\u524d\n\n```\n$ ./kvtctl.sh ListAllTablets test\ntest-0000000100 test_keyspace 0 master 10.28.3.6:15002 10.28.3.6:3306 []\ntest-0000000101 test_keyspace 0 spare 10.28.1.6:15002 10.28.1.6:3306 []\ntest-0000000102 test_keyspace 0 replica 10.28.2.5:15002 10.28.2.5:3306 []\ntest-0000000103 test_keyspace 0 rdonly 10.28.0.6:15002 10.28.0.6:3306 []\ntest-0000000104 test_keyspace 0 rdonly 10.28.3.7:15002 10.28.3.7:3306 []\n```\n\n\u5207\u308a\u66ff\u3048\n\n```\n$ vtctlclient -server 130.211.252.96:15999 TabletExternallyReparented test-101\n```\n\ntest-101 \u304c master \u306b\u306a\u308b\n\n```\n$ ./kvtctl.sh ListAllTablets test\ntest-0000000100 test_keyspace 0 replica 10.28.3.6:15002 10.28.3.6:3306 []\ntest-0000000101 test_keyspace 0 master 10.28.1.6:15002 10.28.1.6:3306 []\ntest-0000000102 test_keyspace 0 replica 10.28.2.5:15002 10.28.2.5:3306 []\ntest-0000000103 test_keyspace 0 rdonly 10.28.0.6:15002 10.28.0.6:3306 []\ntest-0000000104 test_keyspace 0 rdonly 10.28.3.7:15002 10.28.3.7:3306 []\n```\n\n\n**\u30d0\u30c3\u30af\u30a2\u30c3\u30d7**\nrdonly Pod \u306b\u5bfe\u3057\u3066\u4ee5\u4e0b\u30b3\u30de\u30f3\u30c9\u5b9f\u884c\n\n```\n$ ./kvtctl.sh Backup test-0000000104\n```\n\nterraform \u3067\u4f5c\u6210\u3057\u305f Bucket \u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3055\u308c\u308b\n\n![04png.png](https://qiita-image-store.s3.amazonaws.com/0/105824/55717346-2783-dcd3-d7dd-61cc781858b7.png)\n\n\n\u30b3\u30de\u30f3\u30c9\u3067\u78ba\u8a8d\n\n```\n$ ./kvtctl.sh ListBackups test_keyspace/0\n2015-12-24.051117.test-0000000104\n```\n\n**\u30b9\u30b1\u30fc\u30eb\u30a2\u30a6\u30c8**\n\u8a66\u305b\u3066\u3044\u306a\u3044\u306e\u3067\u5225\u9014\u30fb\u30fb\u30fb\n", "tags": ["kubernetes", "Vitess", "Terraform", "GoogleCloudPlatform", "GoogleContainerEngine"]}