{"context": " More than 1 year has passed since last update.Socket.io\u3068Backbone.js\u306b\u3088\u308bSingle Page Application\u6982\u8981\u7de8\u306b\u7d9a\u3044\u3066\u5b9f\u88c5\u7de8\u3068\u3057\u3066Demo\u306e\u30bd\u30fc\u30b9\u3092\u89e3\u8aac\u3057\u307e\u3059\u3002\nDemo\u306e\u30bd\u30fc\u30b9\u306fgithub\u3067\u516c\u958b\u3057\u3066\u3044\u307e\u3059\u3002\nbackbone_socket_io_reqev\n\n\u30c7\u30e2\u306e\u69cb\u6210\n-- app.js\n|- public  - index.html\n|\n|- backbone - spa.js\n            | template - timer.jst.ejs\n            |          |- time.jst.ejs\n            |\n            |-  app - router - sample_router.js.coffee\n                   |- models - timer.js.coffee\n                   |- views  - timer_view.js.coffee\n                            |- time_view.js.coffee\n\n\n\n\u30bd\u30fc\u30b9\u89e3\u8aac\n\n\u30b5\u30fc\u30d0\u5074\n\napp.js\nvar express = require('express')\nvar Timer = require('./timer')\nvar path = require('path')\nvar http = require('http')\n\nvar app = express();\n\nvar Mincer  = require('mincer');\nvar environment = new Mincer.Environment();\nenvironment.appendPath(__dirname + '/backbone');\napp.use('/assets', Mincer.createServer(environment));\n\napp.configure(function(){\n  app.set('port', 40000);\n});\napp.get(\"/\",function(req,res){\n  res.sendfile('public/index.html');\n});\napp.get(\"/spa/*\",function(req,res){\n  res.sendfile('public/index.html');\n});\n\nvar server = http.createServer(app);\n\nserver.listen(app.get('port'), function(){\n  console.log(\"Express server listening on port \" + app.get('port'));\n});\n\nvar socketIO = require('socket.io');\nvar IOReqEv = require('socket.io-reqev');\nvar ioReqEv = new IOReqEv(socketIO.listen(server));\nioReqEv.register(\"/timer\",new Timer());\n\n\nNode.js\u3067\u69cb\u7bc9\u3057\u3066\u3044\u307e\u3059\u3002\nSmartFX\u3067\u306fWeb\u30a2\u30d7\u30ea\u30b5\u30fc\u30d0\u3092rails\u3001Socket.io\u30b5\u30fc\u30d0\u3092node.js\u3068\u5206\u3051\u305f\u69cb\u6210\u306a\u306e\u3067\u3059\u304c\u3001\u5358\u7d14\u306a\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3067\u3042\u308c\u3070\u4eca\u56de\u306eDemo\u306e\u3088\u3046\u306bnode.js\u3067socket.io\u30b5\u30fc\u30d0\u3068Web\u30b5\u30fc\u30d0\u3092\u517c\u7528\u3059\u308b\u306e\u3082\u3044\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\u6700\u521d\u306e\u307b\u3046\u306b\u3042\u308bMincer\u3068\u3044\u3046\u306e\u306f\u3001Rails\u3067\u4f7f\u308f\u308c\u3066\u3044\u308bSprockets\u306eNode.js\u79fb\u690d\u7248\u3067\u3059\u3002\nCoffeeScript\u7b49\u306eAltJS\u3092\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u305f\u308a\u3001JST\u3092\u4f7f\u3046\u3053\u3068\u306b\u3088\u308atemplate\u30d5\u30a1\u30a4\u30eb\u3092\u5225\u30d5\u30a1\u30a4\u30eb\u3068\u3057\u3066\u7ba1\u7406\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u3001\u524d\u3082\u3063\u3066\u30b3\u30f3\u30d1\u30a4\u30eb\u3055\u308c\u308b\u306e\u3067\u3001\u52d5\u4f5c\u3082\u901f\u304f\u306a\u308a\u307e\u3059\u3002\nDevelopment\u74b0\u5883\u3067\u306f\u4eca\u56de\u306e\u3088\u3046\u306bMiddleware\u3068\u3057\u3066\u4f7f\u3046\u3053\u3068\u3067\u3001\u9045\u304f\u306a\u308a\u307e\u3059\u304c\u30d5\u30a1\u30a4\u30eb\u304c\u66f4\u65b0\u3055\u308c\u308b\u3068\u52d5\u7684\u306b\u53cd\u6620\u3055\u305b\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\nmincer\u306b\u3064\u3044\u3066\u306f\u9577\u304f\u306a\u308b\u306e\u3067\u5f8c\u3067Asset Pipeline\u306e\u3059\u3059\u3081\u3092\u53c2\u7167\u304f\u3060\u3055\u3044\u3002\n\u4eca\u56de\u306f\u5358\u7d14\u306aSPA\u306a\u306e\u3067\u3001app.get(\"/\")\u3068app.get(\"/spa/\")\u3067\u767b\u9332\u3057\u3066\u3044\u308bhandler\u306f\u3001\u9759\u7684\u306aindex.html\u3092\u8fd4\u3057\u3066\u3044\u308b\u3060\u3051\u3067\u3059\u3002\n/spa/ \u306e * \u306f splat\u3068\u547c\u3070\u308c\u308b\u3082\u306e\u3067\u3001/spa/\u4ee5\u4e0b\u306b\u3069\u3093\u306aPath\u304c\u7d9a\u3044\u3066\u3082\u3053\u306eHandler\u3092\u4f7f\u3044\u307e\u3059\u3068\u3044\u3046\u610f\u5473\u3067\u3059\u3002\n\u3053\u3053\u306fpushState\u3067\u4f7f\u3046\u4e0a\u3067\u91cd\u8981\u3067\u3059\u3002\nBackbone.js\u5074\u3067\u5207\u308a\u66ff\u3048\u308bURL\u306e\u5148\u982d\u3092/spa\u3068\u3064\u3051\u308b\u3053\u3068\u3067\u3001\u30ea\u30ed\u30fc\u30c9\u3055\u308c\u3066\u3082\u540c\u3058\u30da\u30fc\u30b8\u3092\u8fd4\u3059\u3060\u3051\u306e\u51e6\u7406\u3092\u3059\u308c\u3070\u3001Backbone\u5074\u3067URL\u3092\u89e3\u6790\u3057\u3066\u8a72\u5f53\u306e\u753b\u9762\u304c\u8868\u793a\u3055\u308c\u307e\u3059\u3002\nExpress(Web\u30b5\u30fc\u30d0)\u3068Socket.io\u3067\u30dd\u30fc\u30c8\u3092\u5171\u6709\u3057\u3066\u3044\u307e\u3059\u3002\nsocket.io\u306f\u305d\u306e\u307e\u307e\u3067\u306f\u306a\u304f\u3001socket.io-reqev\u3092\u631f\u3080\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u304c\u3001socket.io-reqev\u3092\u4f7f\u3046\u3068socket.io\u306ePath\u3054\u3068\u306b\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u304c\u767b\u9332\u3067\u304d\u3001\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u5074\u306fsocket.io\u3092\u610f\u8b58\u3057\u306a\u3044\u3067\u30d7\u30ed\u30b0\u30e9\u30e0\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\nsocket.io-reqev\u306f\u5f8c\u3067Socket.IO\u7528\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u3000socket.io-reqev\u3092\u3054\u53c2\u7167\u304f\u3060\u3055\u3044\u3002\n\ntimer.js\nvar events = require('events');\nvar Timer = function(){\n  this.events = [\"five\",\"ten\",\"thirty\"];\n  var that = this;\n  setInterval(function (){\n    var now = new Date();\n    if(now.getSeconds() % 5 == 0){\n      that.emit(\"five\", {id: \"five\",time: now.toString()});\n    }\n    if(now.getSeconds() % 10 == 0){\n      that.emit(\"ten\", {id: \"ten\",time: now.toString()});\n    }\n    if(now.getSeconds() % 30 == 0){\n      that.emit(\"thirty\", {id: \"thirty\",time: now.toString()});\n    }\n  },1000);\n  return this;\n}\nTimer.prototype = new events.EventEmitter();\nTimer.prototype.request = function(req,cb){\n  if(req==\"current\"){\n    cb(null,{id:\"current\", time: new Date().toString()});\n  }\n}\nmodule.exports = Timer;\n\n\nTimer\u306e\u6a5f\u80fd\u306f\n1. 5\u79d2\u300110\u79d2\u300130\u79d2\u3067\u5272\u308a\u304d\u308c\u305f\u3089\u3001\u5272\u308a\u5207\u308c\u305f\u30a4\u30d9\u30f3\u30c8\u3092emit\u3059\u308b\n2. request\u3067current\u304c\u6765\u305f\u5834\u5408\u306f\u73fe\u5728\u6642\u523b\u3092\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3067\u8fd4\u3059\n\u306e2\u3064\u3067\u3059\u3002\nsocket.io-reqev\u304ccallback\u306e\u5834\u5408\u306funicast\u3001emit\u306e\u5834\u5408\u306fbroadcast\u3067\u30c7\u30fc\u30bf\u3092\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u9001\u4fe1\u3057\u3066\u3044\u307e\u3059\u3002\n\u4f8b\u3048\u3070 \"five\"\u3092emit\u3059\u308b\u3068\u3001five\u30a4\u30d9\u30f3\u30c8\u3092subscribe\u3057\u3066\u304d\u305f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306bbroadcast\u3067\u6642\u523b\u3092\u8fd4\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\n\nspa.js\n//= require_self\n//= require_tree ./templates\n//= require_tree ./app\nvar Spa = {socket_io_url: \"http://localhost:40000\"};\nSpa.appStart = function(){\n  window.router = new Spa.SampleRouter();\n  Backbone.history.start({pushState: true})\n}\n\n\nManifest\u30d5\u30a1\u30a4\u30eb\u306b\u306a\u308a\u307e\u3059\u3002\u4e0a\u8a18\u306e\u30c7\u30a3\u30ec\u30af\u30c6\u30a3\u30d6\u306b\u3057\u305f\u304c\u3063\u3066\u3001Sprockets\u3082\u3057\u304f\u306fmincer\u306b\u3088\u3063\u3066\u30d5\u30a1\u30a4\u30eb\u304c\u30b3\u30f3\u30d1\u30a4\u30eb\u3001\u7d50\u5408\u3055\u308c\u307e\u3059\u3002\n\u30da\u30fc\u30b8\u304c\u8aad\u307f\u8fbc\u307e\u308c\u305f\u6642\u306e\u6700\u521d\u306e\u51e6\u7406\u3082\u3053\u3053\u3067\u5b9a\u7fa9\u3057\u3066\u3044\u307e\u3059\u3002\npushState\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306ffalse\u3067\u305d\u306e\u5834\u5408\u306fhashchange(\u30da\u30fc\u30b8\u5185\u30a2\u30f3\u30ab\u30fc\u306e#)\u304c\u4f7f\u308f\u308c\u307e\u3059\u3002\nhashchange\u304c\u3044\u3044\u5834\u5408\u306f\u3001\u4e0b\u8a18\u3067\u3059\u3002\n1.pushState\u306e\u5834\u5408\u306f\u30a4\u30d9\u30f3\u30c8\u3092\u62fe\u3063\u3066navigator\u3092\u547c\u3076\u5fc5\u8981\u304c\u3042\u308b\u306e\u306b\u5bfe\u3057\u3001#\u306e\u5834\u5408\u306fA\u30bf\u30b0\u306bhref=\"#users/1\"\u306a\u3069\u66f8\u304f\u3053\u3068\u3067\u76f4\u63a5\u9077\u79fb\u3067\u304d\u308b\u3002 \n2.pushState\u975e\u5bfe\u5fdc\u306e\u30d6\u30e9\u30a6\u30b6\u3067\u3082\u4f7f\u3048\u308b\n\u305f\u3060\u3001#\u306fiOS7\u3060\u3068application cache\u304c\u3046\u307e\u304f\u3044\u304b\u306a\u304b\u3063\u305f\u308a\u3001\u30bd\u30fc\u30b7\u30e3\u30eb\u3067\u4ed6\u306b\u5171\u6709\u3059\u308b\u969b\u306b#\u304c\u5225\u306e\u610f\u5473\u3092\u3082\u3063\u3066\u3044\u305f\u308a\u3068\u304a\u3059\u3059\u3081\u3057\u307e\u305b\u3093\u3002\n\ntimer.jst.ejs\n<span><a href=\"/\" <% if(type == \"current\"){ %> style=\"text-decoration:none;\"<% } %>>\u73fe\u5728</a></span>\n<span><a href=\"/spa/timers/five\" <% if(type == \"five\"){ %> style=\"text-decoration:none;\"<% } %>>5\u79d2</a></span>\n<span><a href=\"/spa/timers/ten\" <% if(type == \"ten\"){ %> style=\"text-decoration:none;\"<% } %>>10\u79d2</a></span>\n<span><a href=\"/spa/timers/thirty\" <% if(type == \"thirty\"){ %> style=\"text-decoration:none;\"<% } %>>30\u79d2</a></span>\n<table>\n    <tbody id=\"timerList\">\n    </tbody>\n</table>\n\n\n\ntime.jst.ejs\n<%= time %>\n\n\nejs\u3092\u4f7f\u3063\u305fJST\u3067\u3059\u3002\u30b3\u30f3\u30d1\u30a4\u30eb\u6642\u306b\u95a2\u6570\u5316\u3055\u308c\u3066\u3001view\u304b\u3089template\u3067\u547c\u3073\u51fa\u305b\u307e\u3059\u3002\n\u5225\u30d5\u30a1\u30a4\u30eb\u3067\u7ba1\u7406\u3067\u304d\u3001\u30c7\u30b6\u30a4\u30ca\u306b\u3082\u512a\u3057\u3044\u3067\u3059\u3002\n\nindex.html\n<!DOCTYPE html>\n<html>\n<head>\n<script type=\"text/javascript\" src=\"http://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js\"></script>\n<script type=\"text/javascript\" src=\"http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js\"></script>\n<script type=\"text/javascript\" src=\"http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.2/backbone-min.js\"></script>\n<script type=\"text/javascript\" src=\"http://cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.16/socket.io.min.js\"></script>\n<script type=\"text/javascript\" src=\"http://49.212.183.126:8080/js/io-reqev-client.js\"></script>\n<script type=\"text/javascript\" src=\"/assets/spa\"></script>\n<title>sample</title>\n</head>\n<body>\n    <div id=\"container\"></div>\n  <script type=\"text/javascript\">\n  $(document).ready(function(){\n    Spa.appStart();\n  })\n  </script>\n    </body>\n</html>\n\n\n\u4e00\u679a\u30da\u30e9\u306ehtml\u3067\u3059\u3002\u5fc5\u8981\u306ajs\u306einclude\u3092\u884c\u3044\u3001\u5185\u5bb9\u3092\u5dee\u3057\u66ff\u3048\u308b\u7528\u306ediv\u3092\u7528\u610f\u3057\u3001\u521d\u671f\u5316\u51e6\u7406\u3092\u547c\u3073\u51fa\u3057\u3066\u3044\u308b\u306e\u307f\u3067\u3059\u3002\n\nsample_router.js.coffee\nclass Spa.SampleRouter extends Backbone.Router\n  initialize: (options)->\n    @timers = new Spa.TimerCollection()\n\n  routes:\n    \"spa/timers/:type\": \"timer\"\n    \".*\": \"timer\"\n\n  timer:(type)->\n    @view.remove() if @view\n    @view = null\n    type ||= \"current\"\n    @view = new Spa.TimerView(collection: @timers,type: type)\n    $(\"#container\").html(@view.render().el)\n\n\n\nRouter\u3067\u3059\u3002\nTimerCollection\u306fSocket.io\u3092\u4f7f\u3063\u3066\u30c7\u30fc\u30bf\u3092\u7ba1\u7406\u3057\u3066\u3044\u308bcollection\u3067\u3059\u3002\nSocket.io\u306f\u4e00\u5ea6\u3064\u306a\u3050\u3068\u3064\u306a\u304e\u3063\u3071\u306a\u3057\u306e\u305f\u3081\u3001View\u8868\u793a\u3054\u3068\u306b\u751f\u6210\u3059\u308b\u306e\u3067\u306f\u306a\u304f\u3001\u521d\u671f\u6642\u306b\u4f5c\u6210\u3057\u3066\u3044\u307e\u3059\u3002\nroutes\u3067URL\u3068URL\u306b\u5bfe\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u3092\u63d0\u4f9b\u3057\u3066\u3044\u3066\u3001Demo\u3067\u63d0\u4f9b\u3059\u308b\u753b\u9762\u306f1\u3064\u306e\u307f\u3067\u3059\u3002\n/\u306e\u5834\u5408\u306f\u73fe\u5728\u3092\u6307\u5b9a\u3001\u305d\u308c\u4ee5\u5916\u306f\u3001/spa/timers\u306e\u5f8c\u306b5\u79d2\u300110\u79d2\u300130\u79d2\u3092\u793a\u3059\"five\",\"ten\",\"thirty\"\u306e\u3044\u305a\u308c\u304b\u304c\u306f\u3044\u308a\u307e\u3059\u3002\ntimer\u306e\u95a2\u6570\u306e\u5148\u982d\u3067view\u304c\u3042\u308c\u3070\u3001remove()\u3092\u547c\u3073\u51fa\u3057\u3066\u3044\u307e\u3059\u3002\n\u3053\u308c\u306fBackbone.js\u3067\u306f\u304a\u6c7a\u307e\u308a\u306e\u30a4\u30c7\u30a3\u30aa\u30e0\u3067\u3001remove\u3092\u547c\u3073\u51fa\u3059\u3053\u3068\u3067\u3001view\u5185\u3067listenTo\u3067\u767b\u9332\u3057\u305f\u308a\u3057\u305fevents\u304c\u958b\u653e\u3055\u308c\u307e\u3059\u3002\n\u3053\u308c\u3092\u547c\u3073\u3060\u3055\u305a\u306b@view\u3092\u4e0a\u66f8\u304d\u3057\u3066\u3057\u307e\u3046\u3068\u30ea\u30fc\u30af\u3057\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\ntimer.js\nclass Spa.Timer extends Backbone.Model\n\nclass Spa.TimerCollection extends Backbone.Collection\n  model: Spa.Timer\n  socket: null\n  @types: [\"current\",\"five\",\"ten\",\"thirty\"]\n\n  initialize: ()->\n    @add(_.map(Spa.TimerCollection.types,(type)-> new Spa.Timer(id: type)))\n    @socket = new IOReqEvClient(Spa.socket_io_url + \"/timer\", (obj)=> @update(obj))\n\n  update: (obj)->\n    @add(obj,merge: true)\n\n  watch: (id)->\n    return if !id || !@get(id)\n    @get(id).unset(\"time\")\n    param = if id == \"current\" then {requests: id} else {events: id}\n    @socket.watch(param)\n\n  unwatch: ()->\n    @socket.unwatch()\n\n\n\nModel\u304a\u3088\u3073Collection\u3067\u3059\u3002\nCollection\u306e\u521d\u671f\u51e6\u7406\u3067\u4eca\u56de\u4f7f\u3046Timer\u306e\u7a2e\u5225\u5206\u306eModel\u3092\u4f5c\u6210\u3057\u3066\u3044\u307e\u3059\u3002\n\u6700\u521d\u306b\u4f5c\u3063\u3066\u3057\u307e\u3046\u7406\u7531\u306f\u3001model\u304c\u306a\u3044\u3001model\u304c\u3042\u3063\u3066\u6642\u523b\u304c\u306a\u3044\u3001model\u304c\u3042\u3063\u3066\u6642\u523b\u304c\u3042\u308b\u306e3\u30d1\u30bf\u30fc\u30f3\u3088\u308amodel\u304c\u3042\u3063\u3066\u6642\u523b\u304c\u306a\u3044\u3001model\u304c\u3042\u3063\u3066\u6642\u523b\u304c\u3042\u308b\u306e2\u30d1\u30bf\u30fc\u30f3\u306b\u306a\u3063\u305f\u307b\u3046\u304c\u5b09\u3057\u3044\u3068\u601d\u3063\u305f\u304b\u3089\u3067\u3059\u3002\nIOReqEvClient\u306fsocket.io-reqev\u306edist\u306b\u542b\u307e\u308c\u308bclient\u7528\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3067\u3059\u3002\nSocket.io\u30b5\u30fc\u30d0\u306eURL+\u30a4\u30d9\u30f3\u30c8\u3084\u30ea\u30af\u30a8\u30b9\u30c8\u5bfe\u8c61\u306epath\u3092\u6307\u5b9a\u3057\u3001\u30c7\u30fc\u30bf\u3092\u53d7\u4fe1\u3057\u305f\u5834\u5408\u306ecallback\u3092\u767b\u9332\u3057\u3066\u3044\u307e\u3059\u3002\nupdate\u3067\u306f\u5358\u7d14\u306bBackbone\u306ecollection\u306eadd\u3092\u547c\u3073\u51fa\u3057\u3066\u3044\u307e\u3059\u304c\u3001merge\u306btrue\u3092\u6307\u5b9a\u3057\u3066\u3044\u308b\u305f\u3081\u3001\u540c\u3058ID\u306e\u5834\u5408\u306f\u8ffd\u52a0\u3067\u306f\u306a\u304f\u66f4\u65b0\u3055\u308c\u307e\u3059\u3002\nwatch\u306fSocket.io\u30b5\u30fc\u30d0\u306bsubscribe\u3057\u305f\u3044\u30a4\u30d9\u30f3\u30c8\u30011\u56de\u3060\u3051\u53d7\u3051\u305f\u3044(http\u306eGET\u306b\u76f8\u5f53)\u3001\u304a\u3088\u3073\u305d\u306e\u4e21\u65b9\u3092socket.io\u3092\u901a\u3058\u3066\u9001\u4fe1\u3057\u307e\u3059\u3002requests\u306b\u6e21\u3059\u30e1\u30c3\u30bb\u30fc\u30b8\u304cGET\u3067events\u3067\u6e21\u3059\u30e1\u30c3\u30bb\u30fc\u30b8\u304csubscribe\u3057\u305f\u3044\u30a4\u30d9\u30f3\u30c8\u306b\u306a\u308a\u307e\u3059\u3002\n\u3069\u3061\u3089\u3082\u5358\u4f53\u3067\u3082\u914d\u5217\u3067\u3082\u8a2d\u5b9a\u53ef\u80fd\u3067\u3059\u3002\n\u30c7\u30fc\u30bf\u3092\u53d7\u4fe1\u3059\u308c\u3070\u3001\u4e0a\u8a18\u306eupdate\u304c\u547c\u3070\u308c\u3066\u3001Backbone.js\u306b\u3088\u308achange\u30a4\u30d9\u30f3\u30c8\u304c\u8a72\u5f53\u306emodel\u306elistener\u306b\u901a\u77e5\u3055\u308c\u307e\u3059\u3002\nunwatch\u306fwatch\u3059\u308b\u3068\u3001subscribe\u3057\u305f\u30a4\u30d9\u30f3\u30c8\u304c\u3042\u308b\u5ea6\u306bsocket.io\u30b5\u30fc\u30d0\u304b\u3089push\u901a\u77e5\u3092\u53d7\u3051\u308b\u3088\u3046\u306b\u306a\u308b\u306e\u3067\u3001\u305d\u308c\u3092\u5fc5\u8981\u306a\u304f\u306a\u3063\u305f\u3053\u3068\u3092socket.io\u30b5\u30fc\u30d0\u306b\u4f1d\u3048\u307e\u3059\u3002\n\ntimer_view.js.coffee\nclass Spa.TimerView extends Backbone.View\n  template: JST[\"templates/timer\"]\n\n  events:\n    \"click a\": \"changeTimer\"\n\n  initialize: (options)->\n    @childViews = []\n    @type = options.type\n    @collection.watch(@type)\n    @model = @collection.get(@type)\n    @listenTo(@model,'change', @updateTimer)\n\n  changeTimer: (e)->\n    e.preventDefault()\n    e.stopPropagation()\n    router.navigate($(e.currentTarget).attr(\"href\"), {trigger: true})\n\n  updateTimer: ()->\n    view = new Spa.TimeView(model: @model)\n    @$(\"#timerList\").append(view.render().el)\n    @childViews.push(view)\n\n  render: ()->\n    $(@el).html(@template(type: @type))\n    @\n\n  remove: ()->\n    for v in @childViews\n      v.remove()\n    @collection.unwatch()\n    super()\n\n\n\n\ntime.js.coffee\nclass Spa.TimeView extends Backbone.View\n  template: JST[\"templates/time\"]\n  el: \"<tr/>\"\n\n  render: ()->\n    $(@el).html(@template(@model.toJSON()))\n    @\n\n\nView\u3067\u3059\u3002\n\u521d\u671f\u51e6\u7406\u3067\u3001collection\u306b\u5bfe\u3057\u3066\u3001\u73fe\u5728\u306e\u7a2e\u5225(\u73fe\u5728\u79d2\u30015\u79d2\u300110\u79d2\u300130\u79d2)\u3092watch\u306b\u6e21\u3057\u3066\u3044\u307e\u3059\u3002\ncollection\u304b\u3089\u7a2e\u5225\u306emodel\u3092\u53d6\u308a\u51fa\u3057\u3001listenTo\u3067\u5909\u66f4\u304c\u3042\u3063\u305f\u3089\u3001updateTimer\u306e\u51e6\u7406\u3092\u547c\u3073\u51fa\u3059\u3088\u3046\u306b\u767b\u9332\u3057\u3066\u3044\u307e\u3059\u3002\n\u521d\u671f\u5316\u3057\u3066\u3059\u3050\u306brouter\u304b\u3089render\u304c\u547c\u3073\u51fa\u3055\u308c\u307e\u3059\u304c\u3001\u3053\u306e\u6642\u306f\u67a0\u7d44\u307f\u3092\u8868\u793a\u3059\u308b\u3060\u3051\u3067\u3001\u6642\u523b\u30c7\u30fc\u30bf\u306fupdateTimer\u306b\u3088\u3063\u3066model\u306e\u66f4\u65b0\u6642\u306b\u884c\u308f\u308c\u307e\u3059\u3002\nupdateTimer\u306f\u547c\u3073\u51fa\u3055\u308c\u308b\u3068\u3001\u5b50View\u3092\u4f5c\u3063\u3066\u3001tbody\u306b\u8ffd\u52a0\u3057\u3001@childVeiws\u306b\u5b50View\u3092\u767b\u9332\u3057\u3066\u3044\u307e\u3059\u3002\nevents\u306b\u306fA\u30bf\u30b0\u304c\u30af\u30ea\u30c3\u30af\u3055\u308c\u305f\u3089\u3001\u305d\u306e\u30a4\u30d9\u30f3\u30c8\u3092\u62fe\u3063\u3066\u3001changeTimer\u3092\u547c\u3073\u51fa\u3059\u3088\u3046\u306b\u767b\u9332\u3057\u3066\u3044\u307e\u3059\u3002\nchangeTimer\u306f\u30ea\u30f3\u30af\u9077\u79fb\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30a4\u30d9\u30f3\u30c8\u3092\u30ad\u30e3\u30f3\u30bb\u30eb\u3057\u3066\u3001naviagte\u306b\u3088\u308bpushState\u3092\u4f7f\u3063\u3066router\u3092\u7d4c\u7531\u3057\u3066\u3001\u307e\u305f\u5225\u306eTimer\u306e\u753b\u9762\u306b\u5207\u308a\u66ff\u3048\u3066\u3044\u307e\u3059\u3002\nremove()\u306f\u3001\u753b\u9762\u306e\u5207\u308a\u66ff\u3048\u306e\u969b\u306b\u306frouter\u3067\u3001remove()\u304c\u547c\u3070\u308c\u308b\u3053\u3068\u306b\u306a\u3063\u3066\u3044\u3066\u3001Backbone.js\u306eremove\u3092override\u3057\u3066\u3001\u5b50View\u306e\u958b\u653e\u3068\u3001subscriber\u3092\u3084\u3081\u308b\u51e6\u7406\u3092\u884c\u3063\u305f\u5f8c\u3001\u5143\u3005\u306eBackbone.js\u306eremove()\u3092\u547c\u3073\u51fa\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u307e\u3068\u3081\n\u534a\u65e5\u3082\u3042\u308c\u3070\u3053\u3053\u306b\u66f8\u304b\u308c\u3066\u3044\u308b\u30d7\u30ed\u30b0\u30e9\u30e0\u306f\u7406\u89e3\u3067\u304d\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\u7c21\u5358\u306b\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u306eSinglePageApplication\u304c\u4f5c\u308c\u308b\u6c17\u306b\u306a\u308a\u307e\u305b\u3093\u304b\uff1f\nSPA\u3067\u30b5\u30af\u30b5\u30af\u52d5\u304fWeb\u304c\u4e16\u306e\u4e2d\u306b\u5897\u3048\u305f\u3089\u3044\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n[Socket.io\u3068Backbone.js\u306b\u3088\u308bSingle Page Application\u6982\u8981\u7de8](http://qiita.com/takeshy/items/a3a11c0f7470ba820b53)\u306b\u7d9a\u3044\u3066\u5b9f\u88c5\u7de8\u3068\u3057\u3066Demo\u306e\u30bd\u30fc\u30b9\u3092\u89e3\u8aac\u3057\u307e\u3059\u3002\n\nDemo\u306e\u30bd\u30fc\u30b9\u306fgithub\u3067\u516c\u958b\u3057\u3066\u3044\u307e\u3059\u3002\n[backbone_socket_io_reqev](https://github.com/takeshy/backbone_socket_io_reqev)\n\n\n# \u30c7\u30e2\u306e\u69cb\u6210\n\n<pre>\n-- app.js\n|- public  - index.html\n|\n|- backbone - spa.js\n            | template - timer.jst.ejs\n            |          |- time.jst.ejs\n            |\n            |-  app - router - sample_router.js.coffee\n                   |- models - timer.js.coffee\n                   |- views  - timer_view.js.coffee\n                            |- time_view.js.coffee\n\n</pre>\n\n# \u30bd\u30fc\u30b9\u89e3\u8aac\n\n## \u30b5\u30fc\u30d0\u5074\n\n``` app.js\nvar express = require('express')\nvar Timer = require('./timer')\nvar path = require('path')\nvar http = require('http')\n\nvar app = express();\n\nvar Mincer  = require('mincer');\nvar environment = new Mincer.Environment();\nenvironment.appendPath(__dirname + '/backbone');\napp.use('/assets', Mincer.createServer(environment));\n\napp.configure(function(){\n  app.set('port', 40000);\n});\napp.get(\"/\",function(req,res){\n  res.sendfile('public/index.html');\n});\napp.get(\"/spa/*\",function(req,res){\n  res.sendfile('public/index.html');\n});\n\nvar server = http.createServer(app);\n\nserver.listen(app.get('port'), function(){\n  console.log(\"Express server listening on port \" + app.get('port'));\n});\n\nvar socketIO = require('socket.io');\nvar IOReqEv = require('socket.io-reqev');\nvar ioReqEv = new IOReqEv(socketIO.listen(server));\nioReqEv.register(\"/timer\",new Timer());\n```\n\nNode.js\u3067\u69cb\u7bc9\u3057\u3066\u3044\u307e\u3059\u3002\n[SmartFX](http://smartfx.minkabu.jp)\u3067\u306fWeb\u30a2\u30d7\u30ea\u30b5\u30fc\u30d0\u3092rails\u3001Socket.io\u30b5\u30fc\u30d0\u3092node.js\u3068\u5206\u3051\u305f\u69cb\u6210\u306a\u306e\u3067\u3059\u304c\u3001\u5358\u7d14\u306a\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3067\u3042\u308c\u3070\u4eca\u56de\u306eDemo\u306e\u3088\u3046\u306bnode.js\u3067socket.io\u30b5\u30fc\u30d0\u3068Web\u30b5\u30fc\u30d0\u3092\u517c\u7528\u3059\u308b\u306e\u3082\u3044\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\u6700\u521d\u306e\u307b\u3046\u306b\u3042\u308bMincer\u3068\u3044\u3046\u306e\u306f\u3001Rails\u3067\u4f7f\u308f\u308c\u3066\u3044\u308bSprockets\u306eNode.js\u79fb\u690d\u7248\u3067\u3059\u3002\nCoffeeScript\u7b49\u306eAltJS\u3092\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u305f\u308a\u3001JST\u3092\u4f7f\u3046\u3053\u3068\u306b\u3088\u308atemplate\u30d5\u30a1\u30a4\u30eb\u3092\u5225\u30d5\u30a1\u30a4\u30eb\u3068\u3057\u3066\u7ba1\u7406\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u3001\u524d\u3082\u3063\u3066\u30b3\u30f3\u30d1\u30a4\u30eb\u3055\u308c\u308b\u306e\u3067\u3001\u52d5\u4f5c\u3082\u901f\u304f\u306a\u308a\u307e\u3059\u3002\nDevelopment\u74b0\u5883\u3067\u306f\u4eca\u56de\u306e\u3088\u3046\u306bMiddleware\u3068\u3057\u3066\u4f7f\u3046\u3053\u3068\u3067\u3001\u9045\u304f\u306a\u308a\u307e\u3059\u304c\u30d5\u30a1\u30a4\u30eb\u304c\u66f4\u65b0\u3055\u308c\u308b\u3068\u52d5\u7684\u306b\u53cd\u6620\u3055\u305b\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\nmincer\u306b\u3064\u3044\u3066\u306f\u9577\u304f\u306a\u308b\u306e\u3067\u5f8c\u3067[Asset Pipeline\u306e\u3059\u3059\u3081](http://takesy.cocolog-nifty.com/atico/2012/12/asset-pipeline-.html)\u3092\u53c2\u7167\u304f\u3060\u3055\u3044\u3002\n\n\u4eca\u56de\u306f\u5358\u7d14\u306aSPA\u306a\u306e\u3067\u3001app.get(\"/\")\u3068app.get(\"/spa/*\")\u3067\u767b\u9332\u3057\u3066\u3044\u308bhandler\u306f\u3001\u9759\u7684\u306aindex.html\u3092\u8fd4\u3057\u3066\u3044\u308b\u3060\u3051\u3067\u3059\u3002\n/spa/* \u306e * \u306f splat\u3068\u547c\u3070\u308c\u308b\u3082\u306e\u3067\u3001/spa/\u4ee5\u4e0b\u306b\u3069\u3093\u306aPath\u304c\u7d9a\u3044\u3066\u3082\u3053\u306eHandler\u3092\u4f7f\u3044\u307e\u3059\u3068\u3044\u3046\u610f\u5473\u3067\u3059\u3002\n\u3053\u3053\u306fpushState\u3067\u4f7f\u3046\u4e0a\u3067\u91cd\u8981\u3067\u3059\u3002\nBackbone.js\u5074\u3067\u5207\u308a\u66ff\u3048\u308bURL\u306e\u5148\u982d\u3092/spa\u3068\u3064\u3051\u308b\u3053\u3068\u3067\u3001\u30ea\u30ed\u30fc\u30c9\u3055\u308c\u3066\u3082\u540c\u3058\u30da\u30fc\u30b8\u3092\u8fd4\u3059\u3060\u3051\u306e\u51e6\u7406\u3092\u3059\u308c\u3070\u3001Backbone\u5074\u3067URL\u3092\u89e3\u6790\u3057\u3066\u8a72\u5f53\u306e\u753b\u9762\u304c\u8868\u793a\u3055\u308c\u307e\u3059\u3002\n\nExpress(Web\u30b5\u30fc\u30d0)\u3068Socket.io\u3067\u30dd\u30fc\u30c8\u3092\u5171\u6709\u3057\u3066\u3044\u307e\u3059\u3002\nsocket.io\u306f\u305d\u306e\u307e\u307e\u3067\u306f\u306a\u304f\u3001socket.io-reqev\u3092\u631f\u3080\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u304c\u3001socket.io-reqev\u3092\u4f7f\u3046\u3068socket.io\u306ePath\u3054\u3068\u306b\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u304c\u767b\u9332\u3067\u304d\u3001\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u5074\u306fsocket.io\u3092\u610f\u8b58\u3057\u306a\u3044\u3067\u30d7\u30ed\u30b0\u30e9\u30e0\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\nsocket.io-reqev\u306f\u5f8c\u3067[Socket.IO\u7528\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u3000socket.io-reqev](http://takesy.cocolog-nifty.com/atico/2013/12/socketiosocketi.html)\u3092\u3054\u53c2\u7167\u304f\u3060\u3055\u3044\u3002\n\n``` timer.js\nvar events = require('events');\nvar Timer = function(){\n  this.events = [\"five\",\"ten\",\"thirty\"];\n  var that = this;\n  setInterval(function (){\n    var now = new Date();\n    if(now.getSeconds() % 5 == 0){\n      that.emit(\"five\", {id: \"five\",time: now.toString()});\n    }\n    if(now.getSeconds() % 10 == 0){\n      that.emit(\"ten\", {id: \"ten\",time: now.toString()});\n    }\n    if(now.getSeconds() % 30 == 0){\n      that.emit(\"thirty\", {id: \"thirty\",time: now.toString()});\n    }\n  },1000);\n  return this;\n}\nTimer.prototype = new events.EventEmitter();\nTimer.prototype.request = function(req,cb){\n  if(req==\"current\"){\n    cb(null,{id:\"current\", time: new Date().toString()});\n  }\n}\nmodule.exports = Timer;\n```\n\nTimer\u306e\u6a5f\u80fd\u306f\n1. 5\u79d2\u300110\u79d2\u300130\u79d2\u3067\u5272\u308a\u304d\u308c\u305f\u3089\u3001\u5272\u308a\u5207\u308c\u305f\u30a4\u30d9\u30f3\u30c8\u3092emit\u3059\u308b\n2. request\u3067current\u304c\u6765\u305f\u5834\u5408\u306f\u73fe\u5728\u6642\u523b\u3092\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3067\u8fd4\u3059\n\u306e2\u3064\u3067\u3059\u3002\nsocket.io-reqev\u304ccallback\u306e\u5834\u5408\u306funicast\u3001emit\u306e\u5834\u5408\u306fbroadcast\u3067\u30c7\u30fc\u30bf\u3092\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u9001\u4fe1\u3057\u3066\u3044\u307e\u3059\u3002\n\u4f8b\u3048\u3070 \"five\"\u3092emit\u3059\u308b\u3068\u3001five\u30a4\u30d9\u30f3\u30c8\u3092subscribe\u3057\u3066\u304d\u305f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306bbroadcast\u3067\u6642\u523b\u3092\u8fd4\u3057\u3066\u3044\u307e\u3059\u3002\n\n\n## \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\n\n```spa.js\n//= require_self\n//= require_tree ./templates\n//= require_tree ./app\nvar Spa = {socket_io_url: \"http://localhost:40000\"};\nSpa.appStart = function(){\n  window.router = new Spa.SampleRouter();\n  Backbone.history.start({pushState: true})\n}\n```\n\nManifest\u30d5\u30a1\u30a4\u30eb\u306b\u306a\u308a\u307e\u3059\u3002\u4e0a\u8a18\u306e\u30c7\u30a3\u30ec\u30af\u30c6\u30a3\u30d6\u306b\u3057\u305f\u304c\u3063\u3066\u3001Sprockets\u3082\u3057\u304f\u306fmincer\u306b\u3088\u3063\u3066\u30d5\u30a1\u30a4\u30eb\u304c\u30b3\u30f3\u30d1\u30a4\u30eb\u3001\u7d50\u5408\u3055\u308c\u307e\u3059\u3002\n\u30da\u30fc\u30b8\u304c\u8aad\u307f\u8fbc\u307e\u308c\u305f\u6642\u306e\u6700\u521d\u306e\u51e6\u7406\u3082\u3053\u3053\u3067\u5b9a\u7fa9\u3057\u3066\u3044\u307e\u3059\u3002\npushState\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306ffalse\u3067\u305d\u306e\u5834\u5408\u306fhashchange(\u30da\u30fc\u30b8\u5185\u30a2\u30f3\u30ab\u30fc\u306e#)\u304c\u4f7f\u308f\u308c\u307e\u3059\u3002\nhashchange\u304c\u3044\u3044\u5834\u5408\u306f\u3001\u4e0b\u8a18\u3067\u3059\u3002\n1.pushState\u306e\u5834\u5408\u306f\u30a4\u30d9\u30f3\u30c8\u3092\u62fe\u3063\u3066navigator\u3092\u547c\u3076\u5fc5\u8981\u304c\u3042\u308b\u306e\u306b\u5bfe\u3057\u3001#\u306e\u5834\u5408\u306fA\u30bf\u30b0\u306bhref=\"#users/1\"\u306a\u3069\u66f8\u304f\u3053\u3068\u3067\u76f4\u63a5\u9077\u79fb\u3067\u304d\u308b\u3002 \n2.pushState\u975e\u5bfe\u5fdc\u306e\u30d6\u30e9\u30a6\u30b6\u3067\u3082\u4f7f\u3048\u308b\n\u305f\u3060\u3001#\u306fiOS7\u3060\u3068application cache\u304c\u3046\u307e\u304f\u3044\u304b\u306a\u304b\u3063\u305f\u308a\u3001\u30bd\u30fc\u30b7\u30e3\u30eb\u3067\u4ed6\u306b\u5171\u6709\u3059\u308b\u969b\u306b#\u304c\u5225\u306e\u610f\u5473\u3092\u3082\u3063\u3066\u3044\u305f\u308a\u3068\u304a\u3059\u3059\u3081\u3057\u307e\u305b\u3093\u3002\n\n``` timer.jst.ejs\n<span><a href=\"/\" <% if(type == \"current\"){ %> style=\"text-decoration:none;\"<% } %>>\u73fe\u5728</a></span>\n<span><a href=\"/spa/timers/five\" <% if(type == \"five\"){ %> style=\"text-decoration:none;\"<% } %>>5\u79d2</a></span>\n<span><a href=\"/spa/timers/ten\" <% if(type == \"ten\"){ %> style=\"text-decoration:none;\"<% } %>>10\u79d2</a></span>\n<span><a href=\"/spa/timers/thirty\" <% if(type == \"thirty\"){ %> style=\"text-decoration:none;\"<% } %>>30\u79d2</a></span>\n<table>\n\t<tbody id=\"timerList\">\n\t</tbody>\n</table>\n```\n\n``` time.jst.ejs\n<%= time %>\n```\n\nejs\u3092\u4f7f\u3063\u305fJST\u3067\u3059\u3002\u30b3\u30f3\u30d1\u30a4\u30eb\u6642\u306b\u95a2\u6570\u5316\u3055\u308c\u3066\u3001view\u304b\u3089template\u3067\u547c\u3073\u51fa\u305b\u307e\u3059\u3002\n\u5225\u30d5\u30a1\u30a4\u30eb\u3067\u7ba1\u7406\u3067\u304d\u3001\u30c7\u30b6\u30a4\u30ca\u306b\u3082\u512a\u3057\u3044\u3067\u3059\u3002\n\n``` index.html\n<!DOCTYPE html>\n<html>\n<head>\n<script type=\"text/javascript\" src=\"http://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js\"></script>\n<script type=\"text/javascript\" src=\"http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js\"></script>\n<script type=\"text/javascript\" src=\"http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.2/backbone-min.js\"></script>\n<script type=\"text/javascript\" src=\"http://cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.16/socket.io.min.js\"></script>\n<script type=\"text/javascript\" src=\"http://49.212.183.126:8080/js/io-reqev-client.js\"></script>\n<script type=\"text/javascript\" src=\"/assets/spa\"></script>\n<title>sample</title>\n</head>\n<body>\n\t<div id=\"container\"></div>\n  <script type=\"text/javascript\">\n  $(document).ready(function(){\n    Spa.appStart();\n  })\n  </script>\n\t</body>\n</html>\n```\n\n\u4e00\u679a\u30da\u30e9\u306ehtml\u3067\u3059\u3002\u5fc5\u8981\u306ajs\u306einclude\u3092\u884c\u3044\u3001\u5185\u5bb9\u3092\u5dee\u3057\u66ff\u3048\u308b\u7528\u306ediv\u3092\u7528\u610f\u3057\u3001\u521d\u671f\u5316\u51e6\u7406\u3092\u547c\u3073\u51fa\u3057\u3066\u3044\u308b\u306e\u307f\u3067\u3059\u3002\n\n``` sample_router.js.coffee\nclass Spa.SampleRouter extends Backbone.Router\n  initialize: (options)->\n    @timers = new Spa.TimerCollection()\n\n  routes:\n    \"spa/timers/:type\": \"timer\"\n    \".*\": \"timer\"\n\n  timer:(type)->\n    @view.remove() if @view\n    @view = null\n    type ||= \"current\"\n    @view = new Spa.TimerView(collection: @timers,type: type)\n    $(\"#container\").html(@view.render().el)\n\n```\nRouter\u3067\u3059\u3002\nTimerCollection\u306fSocket.io\u3092\u4f7f\u3063\u3066\u30c7\u30fc\u30bf\u3092\u7ba1\u7406\u3057\u3066\u3044\u308bcollection\u3067\u3059\u3002\nSocket.io\u306f\u4e00\u5ea6\u3064\u306a\u3050\u3068\u3064\u306a\u304e\u3063\u3071\u306a\u3057\u306e\u305f\u3081\u3001View\u8868\u793a\u3054\u3068\u306b\u751f\u6210\u3059\u308b\u306e\u3067\u306f\u306a\u304f\u3001\u521d\u671f\u6642\u306b\u4f5c\u6210\u3057\u3066\u3044\u307e\u3059\u3002\n\nroutes\u3067URL\u3068URL\u306b\u5bfe\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u3092\u63d0\u4f9b\u3057\u3066\u3044\u3066\u3001Demo\u3067\u63d0\u4f9b\u3059\u308b\u753b\u9762\u306f1\u3064\u306e\u307f\u3067\u3059\u3002\n/\u306e\u5834\u5408\u306f\u73fe\u5728\u3092\u6307\u5b9a\u3001\u305d\u308c\u4ee5\u5916\u306f\u3001/spa/timers\u306e\u5f8c\u306b5\u79d2\u300110\u79d2\u300130\u79d2\u3092\u793a\u3059\"five\",\"ten\",\"thirty\"\u306e\u3044\u305a\u308c\u304b\u304c\u306f\u3044\u308a\u307e\u3059\u3002\n\ntimer\u306e\u95a2\u6570\u306e\u5148\u982d\u3067view\u304c\u3042\u308c\u3070\u3001remove()\u3092\u547c\u3073\u51fa\u3057\u3066\u3044\u307e\u3059\u3002\n\u3053\u308c\u306fBackbone.js\u3067\u306f\u304a\u6c7a\u307e\u308a\u306e\u30a4\u30c7\u30a3\u30aa\u30e0\u3067\u3001remove\u3092\u547c\u3073\u51fa\u3059\u3053\u3068\u3067\u3001view\u5185\u3067listenTo\u3067\u767b\u9332\u3057\u305f\u308a\u3057\u305fevents\u304c\u958b\u653e\u3055\u308c\u307e\u3059\u3002\n\u3053\u308c\u3092\u547c\u3073\u3060\u3055\u305a\u306b@view\u3092\u4e0a\u66f8\u304d\u3057\u3066\u3057\u307e\u3046\u3068\u30ea\u30fc\u30af\u3057\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\n\n``` timer.js\nclass Spa.Timer extends Backbone.Model\n\nclass Spa.TimerCollection extends Backbone.Collection\n  model: Spa.Timer\n  socket: null\n  @types: [\"current\",\"five\",\"ten\",\"thirty\"]\n\n  initialize: ()->\n    @add(_.map(Spa.TimerCollection.types,(type)-> new Spa.Timer(id: type)))\n    @socket = new IOReqEvClient(Spa.socket_io_url + \"/timer\", (obj)=> @update(obj))\n\n  update: (obj)->\n    @add(obj,merge: true)\n\n  watch: (id)->\n    return if !id || !@get(id)\n    @get(id).unset(\"time\")\n    param = if id == \"current\" then {requests: id} else {events: id}\n    @socket.watch(param)\n\n  unwatch: ()->\n    @socket.unwatch()\n\n```\n\nModel\u304a\u3088\u3073Collection\u3067\u3059\u3002\nCollection\u306e\u521d\u671f\u51e6\u7406\u3067\u4eca\u56de\u4f7f\u3046Timer\u306e\u7a2e\u5225\u5206\u306eModel\u3092\u4f5c\u6210\u3057\u3066\u3044\u307e\u3059\u3002\n\u6700\u521d\u306b\u4f5c\u3063\u3066\u3057\u307e\u3046\u7406\u7531\u306f\u3001model\u304c\u306a\u3044\u3001model\u304c\u3042\u3063\u3066\u6642\u523b\u304c\u306a\u3044\u3001model\u304c\u3042\u3063\u3066\u6642\u523b\u304c\u3042\u308b\u306e3\u30d1\u30bf\u30fc\u30f3\u3088\u308amodel\u304c\u3042\u3063\u3066\u6642\u523b\u304c\u306a\u3044\u3001model\u304c\u3042\u3063\u3066\u6642\u523b\u304c\u3042\u308b\u306e2\u30d1\u30bf\u30fc\u30f3\u306b\u306a\u3063\u305f\u307b\u3046\u304c\u5b09\u3057\u3044\u3068\u601d\u3063\u305f\u304b\u3089\u3067\u3059\u3002\nIOReqEvClient\u306fsocket.io-reqev\u306edist\u306b\u542b\u307e\u308c\u308bclient\u7528\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3067\u3059\u3002\nSocket.io\u30b5\u30fc\u30d0\u306eURL+\u30a4\u30d9\u30f3\u30c8\u3084\u30ea\u30af\u30a8\u30b9\u30c8\u5bfe\u8c61\u306epath\u3092\u6307\u5b9a\u3057\u3001\u30c7\u30fc\u30bf\u3092\u53d7\u4fe1\u3057\u305f\u5834\u5408\u306ecallback\u3092\u767b\u9332\u3057\u3066\u3044\u307e\u3059\u3002\nupdate\u3067\u306f\u5358\u7d14\u306bBackbone\u306ecollection\u306eadd\u3092\u547c\u3073\u51fa\u3057\u3066\u3044\u307e\u3059\u304c\u3001merge\u306btrue\u3092\u6307\u5b9a\u3057\u3066\u3044\u308b\u305f\u3081\u3001\u540c\u3058ID\u306e\u5834\u5408\u306f\u8ffd\u52a0\u3067\u306f\u306a\u304f\u66f4\u65b0\u3055\u308c\u307e\u3059\u3002\nwatch\u306fSocket.io\u30b5\u30fc\u30d0\u306bsubscribe\u3057\u305f\u3044\u30a4\u30d9\u30f3\u30c8\u30011\u56de\u3060\u3051\u53d7\u3051\u305f\u3044(http\u306eGET\u306b\u76f8\u5f53)\u3001\u304a\u3088\u3073\u305d\u306e\u4e21\u65b9\u3092socket.io\u3092\u901a\u3058\u3066\u9001\u4fe1\u3057\u307e\u3059\u3002requests\u306b\u6e21\u3059\u30e1\u30c3\u30bb\u30fc\u30b8\u304cGET\u3067events\u3067\u6e21\u3059\u30e1\u30c3\u30bb\u30fc\u30b8\u304csubscribe\u3057\u305f\u3044\u30a4\u30d9\u30f3\u30c8\u306b\u306a\u308a\u307e\u3059\u3002\n\u3069\u3061\u3089\u3082\u5358\u4f53\u3067\u3082\u914d\u5217\u3067\u3082\u8a2d\u5b9a\u53ef\u80fd\u3067\u3059\u3002\n\u30c7\u30fc\u30bf\u3092\u53d7\u4fe1\u3059\u308c\u3070\u3001\u4e0a\u8a18\u306eupdate\u304c\u547c\u3070\u308c\u3066\u3001Backbone.js\u306b\u3088\u308achange\u30a4\u30d9\u30f3\u30c8\u304c\u8a72\u5f53\u306emodel\u306elistener\u306b\u901a\u77e5\u3055\u308c\u307e\u3059\u3002\nunwatch\u306fwatch\u3059\u308b\u3068\u3001subscribe\u3057\u305f\u30a4\u30d9\u30f3\u30c8\u304c\u3042\u308b\u5ea6\u306bsocket.io\u30b5\u30fc\u30d0\u304b\u3089push\u901a\u77e5\u3092\u53d7\u3051\u308b\u3088\u3046\u306b\u306a\u308b\u306e\u3067\u3001\u305d\u308c\u3092\u5fc5\u8981\u306a\u304f\u306a\u3063\u305f\u3053\u3068\u3092socket.io\u30b5\u30fc\u30d0\u306b\u4f1d\u3048\u307e\u3059\u3002\n\n``` timer_view.js.coffee\nclass Spa.TimerView extends Backbone.View\n  template: JST[\"templates/timer\"]\n\n  events:\n    \"click a\": \"changeTimer\"\n\n  initialize: (options)->\n    @childViews = []\n    @type = options.type\n    @collection.watch(@type)\n    @model = @collection.get(@type)\n    @listenTo(@model,'change', @updateTimer)\n\n  changeTimer: (e)->\n    e.preventDefault()\n    e.stopPropagation()\n    router.navigate($(e.currentTarget).attr(\"href\"), {trigger: true})\n\n  updateTimer: ()->\n    view = new Spa.TimeView(model: @model)\n    @$(\"#timerList\").append(view.render().el)\n    @childViews.push(view)\n\n  render: ()->\n    $(@el).html(@template(type: @type))\n    @\n\n  remove: ()->\n    for v in @childViews\n      v.remove()\n    @collection.unwatch()\n    super()\n\n```\n\n``` time.js.coffee\nclass Spa.TimeView extends Backbone.View\n  template: JST[\"templates/time\"]\n  el: \"<tr/>\"\n\n  render: ()->\n    $(@el).html(@template(@model.toJSON()))\n    @\n```\n\nView\u3067\u3059\u3002\n\u521d\u671f\u51e6\u7406\u3067\u3001collection\u306b\u5bfe\u3057\u3066\u3001\u73fe\u5728\u306e\u7a2e\u5225(\u73fe\u5728\u79d2\u30015\u79d2\u300110\u79d2\u300130\u79d2)\u3092watch\u306b\u6e21\u3057\u3066\u3044\u307e\u3059\u3002\ncollection\u304b\u3089\u7a2e\u5225\u306emodel\u3092\u53d6\u308a\u51fa\u3057\u3001listenTo\u3067\u5909\u66f4\u304c\u3042\u3063\u305f\u3089\u3001updateTimer\u306e\u51e6\u7406\u3092\u547c\u3073\u51fa\u3059\u3088\u3046\u306b\u767b\u9332\u3057\u3066\u3044\u307e\u3059\u3002\n\u521d\u671f\u5316\u3057\u3066\u3059\u3050\u306brouter\u304b\u3089render\u304c\u547c\u3073\u51fa\u3055\u308c\u307e\u3059\u304c\u3001\u3053\u306e\u6642\u306f\u67a0\u7d44\u307f\u3092\u8868\u793a\u3059\u308b\u3060\u3051\u3067\u3001\u6642\u523b\u30c7\u30fc\u30bf\u306fupdateTimer\u306b\u3088\u3063\u3066model\u306e\u66f4\u65b0\u6642\u306b\u884c\u308f\u308c\u307e\u3059\u3002\nupdateTimer\u306f\u547c\u3073\u51fa\u3055\u308c\u308b\u3068\u3001\u5b50View\u3092\u4f5c\u3063\u3066\u3001tbody\u306b\u8ffd\u52a0\u3057\u3001@childVeiws\u306b\u5b50View\u3092\u767b\u9332\u3057\u3066\u3044\u307e\u3059\u3002\nevents\u306b\u306fA\u30bf\u30b0\u304c\u30af\u30ea\u30c3\u30af\u3055\u308c\u305f\u3089\u3001\u305d\u306e\u30a4\u30d9\u30f3\u30c8\u3092\u62fe\u3063\u3066\u3001changeTimer\u3092\u547c\u3073\u51fa\u3059\u3088\u3046\u306b\u767b\u9332\u3057\u3066\u3044\u307e\u3059\u3002\nchangeTimer\u306f\u30ea\u30f3\u30af\u9077\u79fb\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30a4\u30d9\u30f3\u30c8\u3092\u30ad\u30e3\u30f3\u30bb\u30eb\u3057\u3066\u3001naviagte\u306b\u3088\u308bpushState\u3092\u4f7f\u3063\u3066router\u3092\u7d4c\u7531\u3057\u3066\u3001\u307e\u305f\u5225\u306eTimer\u306e\u753b\u9762\u306b\u5207\u308a\u66ff\u3048\u3066\u3044\u307e\u3059\u3002\nremove()\u306f\u3001\u753b\u9762\u306e\u5207\u308a\u66ff\u3048\u306e\u969b\u306b\u306frouter\u3067\u3001remove()\u304c\u547c\u3070\u308c\u308b\u3053\u3068\u306b\u306a\u3063\u3066\u3044\u3066\u3001Backbone.js\u306eremove\u3092override\u3057\u3066\u3001\u5b50View\u306e\u958b\u653e\u3068\u3001subscriber\u3092\u3084\u3081\u308b\u51e6\u7406\u3092\u884c\u3063\u305f\u5f8c\u3001\u5143\u3005\u306eBackbone.js\u306eremove()\u3092\u547c\u3073\u51fa\u3057\u3066\u3044\u307e\u3059\u3002\n\n\n# \u307e\u3068\u3081\n\n\u534a\u65e5\u3082\u3042\u308c\u3070\u3053\u3053\u306b\u66f8\u304b\u308c\u3066\u3044\u308b\u30d7\u30ed\u30b0\u30e9\u30e0\u306f\u7406\u89e3\u3067\u304d\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\u7c21\u5358\u306b\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u306eSinglePageApplication\u304c\u4f5c\u308c\u308b\u6c17\u306b\u306a\u308a\u307e\u305b\u3093\u304b\uff1f\nSPA\u3067\u30b5\u30af\u30b5\u30af\u52d5\u304fWeb\u304c\u4e16\u306e\u4e2d\u306b\u5897\u3048\u305f\u3089\u3044\u3044\u3068\u601d\u3044\u307e\u3059\u3002", "tags": ["Backbone.js", "JavaScript", "Socket.io", "CoffeeScript"]}