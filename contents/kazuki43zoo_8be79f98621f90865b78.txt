{"context": "\u4eca\u56de\u306f\u3001Servlet 3.0\u3067\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u305f\u975e\u540c\u671f\u51e6\u7406\u306b\u3064\u3044\u3066\u8aac\u660e\u3057\u307e\u3059\u3002\u3053\u308c\u306f\u3001\u5f8c\u65e5\u6295\u7a3f\u4e88\u5b9a\u306e\u300cSpring MVC(+Spring Boot)\u4e0a\u3067\u306eServlet\u6a19\u6e96\u306e\u975e\u540c\u671f\u51e6\u7406\u3092\u7406\u89e3\u3059\u308b\u300d\u306e\u524d\u63d0\u3068\u306a\u308b\u57fa\u790e\u77e5\u8b58\u306b\u306a\u308a\u307e\u3059\u3002\u79c1\u81ea\u8eabServlet\u6a19\u6e96\u306e\u975e\u540c\u671f\u51e6\u7406\u306f\u4f7f\u3063\u305f\u3053\u3068\u306f\u307b\u307c\u306a\u3044\u306e\u3067\u3001\u9593\u9055\u3063\u3066\u3044\u308b\u7b87\u6240\u304c\u3042\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\uff0b\u7d30\u304b\u3044\u52d5\u4f5c\u4ed5\u69d8\u306e\u8aac\u660e\u306f\u672c\u6295\u7a3f\u3067\u306f\u6271\u3044\u307e\u305b\u3093\u30fb\u30fb\u30fb \uff08\u3042\u3057\u304b\u3089\u305a \uff09 \n\n\u52d5\u4f5c\u78ba\u8a8d\u74b0\u5883\n\nJava SE 8\nTomcat 8.0 (Servlet 3.1)\n\n\n\u307e\u305a\u306f\u666e\u901a\u306eServlet\u3092\u4f5c\u3063\u3066\u307f\u308b\n\u975e\u540c\u671f\u3046\u3093\u306c\u3093\u306e\u524d\u306b\u3001\u307e\u305a\u666e\u901a\u306eServlet\u3092\u4f5c\u3063\u3066\u307f\u307e\u3057\u3087\u3046\u3002\nwaitSec\u3067\u6307\u5b9a\u3057\u305f\u79d2\u6570\u3060\u3051\u5f85\u3063\u3066\u304b\u3089 \"/complete.jsp\"\u306b\u9077\u79fb\u3059\u308b\u3068\u3044\u3046\u30b7\u30f3\u30d7\u30eb\u306a\u30b5\u30fc\u30d6\u30ec\u30c3\u30c8\u3067\u3059\u3002\n\nsrc/main/java/com/example/component/StandardServlet.java\npackage com.example.component;\n\nimport javax.servlet.ServletException;\nimport javax.servlet.annotation.WebServlet;\nimport javax.servlet.http.HttpServlet;\nimport javax.servlet.http.HttpServletRequest;\nimport javax.servlet.http.HttpServletResponse;\nimport java.io.IOException;\nimport java.time.LocalDateTime;\nimport java.util.Optional;\nimport java.util.concurrent.TimeUnit;\n\n@WebServlet(urlPatterns = \"/standard\")\npublic class StandardServlet extends HttpServlet {\n\n    @Override\n    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {\n        Console.println(\"Start doGet.\");\n\n        long waitSec = Optional.ofNullable(request.getParameter(\"waitSec\"))\n                .map(Long::valueOf).orElse(0L);\n\n        request.setAttribute(\"acceptedTime\", LocalDateTime.now());\n\n        String dispatchPath;\n        try {\n            heavyProcessing(waitSec, request);\n            dispatchPath = \"/complete.jsp\";\n        } catch (Exception e) {\n            dispatchPath = \"/error.jsp\";\n        }\n\n        request.getRequestDispatcher(dispatchPath).forward(request, response);\n\n        Console.println(\"End doGet.\");\n    }\n\n    private void heavyProcessing(long waitSec, HttpServletRequest request) {\n\n        if (waitSec == 999) {\n            throw new IllegalStateException(\"Special parameter for confirm error.\");\n        }\n\n        try {\n            TimeUnit.SECONDS.sleep(waitSec);\n        } catch (InterruptedException e) {\n            Thread.interrupted();\n        }\n\n        request.setAttribute(\"completedTime\", LocalDateTime.now());\n\n    }\n\n}\n\n\nLogback\u306a\u3069\u306e\u30ed\u30ac\u30fc\u3092\u5165\u308c\u3066\u3082\u3044\u3044\u3051\u3069\u3001\u306a\u3093\u3068\u306a\u304f\u6a19\u6e96\u51fa\u529b\u306b\u30ed\u30b0\u3092\u51fa\u529b\u3059\u308b\u7c21\u6613\u30af\u30e9\u30b9\u3092\u4f5c\u308b\u3053\u3068\u306b\u3057\u3066\u307f\u305f\u3002\uff08\u30ed\u30ac\u30fc\u4f7f\u3044\u305f\u3044\u4eba\u306f\u30ed\u30ac\u30fc\u306b\u3057\u3066\u304f\u3060\u3055\u3044\uff01\uff01\uff09\n\nsrc/main/java/com/example/component/Console.java\npackage com.example.component;\n\nimport java.time.LocalDateTime;\n\npublic class Console {\n    public static void println(Object target) {\n        System.out.println(LocalDateTime.now() + \" \" + Thread.currentThread() + \": \" + target);\n    }\n}\n\n\nJSP\u306f\u3053\u3093\u306a\u611f\u3058\u3002\n\nsrc/main/webapp/complete.jsp\n<%@ page import=\"com.example.component.Console\" %>\n<% Console.println(\"Called complete.jsp\"); %>\n<% Console.println(request.getDispatcherType()); %>\n\n<html>\n<body>\n<h2>Processing is complete !</h2>\n<p>Accept timestamp is ${acceptedTime}</p>\n<p>Complete timestamp is ${completedTime}</p>\n<p><a href=\"${pageContext.request.contextPath}/\">Go to Top</a></p>\n</body>\n</html>\n\n\ncURL\u3084\u30d6\u30e9\u30a6\u30b6\u3092\u4f7f\u3063\u3066\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001complete.jsp\u3067\u751f\u6210\u3055\u308c\u305fHTML\u304c\u8fd4\u5374\u3055\u308c\u307e\u3059\u3002\n$ curl -D - http://localhost:8080/standard?waitSec=1\n\n\nHTTP\u30ec\u30b9\u30dd\u30f3\u30b9\nHTTP/1.1 200 OK\nServer: Apache-Coyote/1.1\nSet-Cookie: JSESSIONID=B19F3B445442E16E9CF1EA4E855BFE24; Path=/; HttpOnly\nContent-Type: text/html;charset=ISO-8859-1\nContent-Length: 201\nDate: Sun, 15 May 2016 12:40:55 GMT\n\n<html>\n<body>\n<h2>Processing is complete !</h2>\n<p>Accept timestamp is 2016-05-15T21:40:54.902</p>\n<p>Complete timestamp is 2016-05-15T21:40:55.903</p>\n<p><a href=\"/\">Go to Top</a></p>\n</body>\n</html>\n\n\n\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d0\u30fc\u4e0a\u306e\u30b3\u30f3\u30bd\u30fc\u30eb\u306b\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30ed\u30b0\u304c\u51fa\u529b\u3055\u308c\u307e\u3059\u3002\n\n\u30b3\u30f3\u30bd\u30fc\u30eb\n2016-05-15T21:40:54.902 Thread[http-nio-8080-exec-6,5,main]: Start doGet.\n2016-05-15T21:40:55.904 Thread[http-nio-8080-exec-6,5,main]: Called complete.jsp\n2016-05-15T21:40:55.904 Thread[http-nio-8080-exec-6,5,main]: FORWARD\n2016-05-15T21:40:55.905 Thread[http-nio-8080-exec-6,5,main]: End doGet.\n\n\n\u3042\u305f\u308a\u524d\u3067\u3059\u304c\u3001\u5168\u3066\u540c\u3058\u30b9\u30ec\u30c3\u30c9\u3067\u5b9f\u884c\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3059\u3002\n\nServlet\u6a19\u6e96\u306e\u4ed5\u7d44\u307f\u3092\u5229\u7528\u3057\u3066\u975e\u540c\u671f\u5b9f\u88c5\u306b\u3057\u3066\u307f\u308b\nStandardServlet\u306e\u5b9f\u88c5\u3092\u3001Servlet\u6a19\u6e96\u306e\u4ed5\u7d44\u307f\u3092\u4f7f\u3063\u3066\u975e\u540c\u671f\u5b9f\u88c5\u306b\u3057\u3066\u307f\u307e\u3059\u3002\u3053\u3053\u3067\u306f\u3001\u975e\u540c\u671f\u7528\u306b\u5225\u306eServlet\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\nsrc/main/java/com/example/component/AsyncServlet.java\npackage com.example.component;\n\nimport javax.servlet.AsyncContext;\nimport javax.servlet.ServletException;\nimport javax.servlet.annotation.WebServlet;\nimport javax.servlet.http.HttpServlet;\nimport javax.servlet.http.HttpServletRequest;\nimport javax.servlet.http.HttpServletResponse;\nimport java.io.IOException;\nimport java.time.LocalDateTime;\nimport java.util.Optional;\nimport java.util.concurrent.TimeUnit;\n\n@WebServlet(urlPatterns = \"/async\", asyncSupported = true) // asyncSupported\u5c5e\u6027\u3092true\u306b\u3057\u3001\u975e\u540c\u671f\u51e6\u7406\u3092\u6271\u3048\u308b\u3088\u3046\u306b\u3059\u308b\npublic class AsyncServlet extends HttpServlet {\n\n    @Override\n    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {\n        Console.println(\"Start doGet.\");\n\n        long wait = Optional.ofNullable(request.getParameter(\"waitSec\"))\n                .map(Long::valueOf).orElse(0L);\n\n        request.setAttribute(\"acceptedTime\", LocalDateTime.now());\n\n        // \u975e\u540c\u671f\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u958b\u59cb\u3057\u3001\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u53d6\u5f97\u3059\u308b\u3002\n        AsyncContext asyncContext = request.startAsync(request, response);\n\n        // \u975e\u540c\u671f\u3067\u5b9f\u884c\u3057\u305f\u3044\u51e6\u7406\u3092\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u53d7\u3051\u4ed8\u3051\u305f\u30b9\u30ec\u30c3\u30c9\u3068\u306f\u5225\u306e\u30b9\u30ec\u30c3\u30c9\u3067\u958b\u59cb\u3059\u308b\u3002\n        // AsyncContext#start\u30e1\u30bd\u30c3\u30c9\u3092\u4f7f\u7528\u3059\u308b\u3068\u3001\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d0\u30fc(Tomcat)\u304c\u7ba1\u7406\u3057\u3066\u3044\u308b\u30b9\u30ec\u30c3\u30c9\u304c\u4f7f\u308f\u308c\u308b\u3002\n        asyncContext.start(() -> {\n            Console.println(\"Start Async processing.\");\n\n            String dispatchPath;\n            try {\n                heavyProcessing(wait, (HttpServletRequest) asyncContext.getRequest());\n                dispatchPath = \"/complete.jsp\";\n            } catch (Exception e) {\n                dispatchPath = \"/error.jsp\";\n            }\n\n            // \u6307\u5b9a\u3057\u305f\u30d1\u30b9(complete.jsp)\u3078\u306e\u30c7\u30a3\u30b9\u30d1\u30c3\u30c1\u3092\u884c\u3046\n            // \u6307\u5b9a\u3057\u305f\u30d1\u30b9\u306b\u5bfe\u3059\u308b\u51e6\u7406\u306f\u3001\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d0\u30fc(Tomcat)\u304c\u7ba1\u7406\u3057\u3066\u3044\u308b\u30b9\u30ec\u30c3\u30c9\u30d7\u30fc\u30eb\u306e\u30b9\u30ec\u30c3\u30c9\u304c\u4f7f\u308f\u308c\u308b\u3002\n            asyncContext.dispatch(dispatchPath);\n\n            Console.println(\"End Async processing.\");\n        });\n\n        // \u975e\u540c\u671f\u51e6\u7406\u3092\u8d77\u52d5\u3057\u305f\u5f8c\u306b\u3001\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u53d7\u3051\u53d6\u3063\u305f\u30b9\u30ec\u30c3\u30c9\u306e\u51e6\u7406\u3092\u7d42\u4e86\u3057\u3001\u30b9\u30ec\u30c3\u30c9\u30d7\u30fc\u30eb\u306b\u623b\u3059\u3002\n        // \u540c\u671f\u30ea\u30af\u30a8\u30b9\u30c8\u3060\u3068HTTP\u30ec\u30b9\u30dd\u30f3\u30b9\u304c\u5b8c\u4e86\u3057\u3066\u3057\u307e\u3046\u304c\u3001\u975e\u540c\u671f\u30ea\u30af\u30a8\u30b9\u30c8\u3060\u3068\u30e1\u30bd\u30c3\u30c9\u3092\u629c\u3051\u3066\u3082HTTP\u30ec\u30b9\u30dd\u30f3\u30b9\u306f\u884c\u308f\u308c\u306a\u3044\uff08\u6b63\u78ba\u306b\u306f\u5b8c\u4e86\u3057\u306a\u3044\uff09\u3002\n        Console.println(\"End doGet.\");\n    }\n\n    private void heavyProcessing(long waitSec, HttpServletRequest request) {\n\n        if (waitSec == 999) {\n            throw new IllegalStateException(\"Special parameter for confirm error.\");\n        }\n\n        try {\n            TimeUnit.SECONDS.sleep(waitSec);\n        } catch (InterruptedException e) {\n            Thread.interrupted();\n        }\n\n        request.setAttribute(\"completedTime\", LocalDateTime.now());\n\n    }\n\n}\n\n\nweb.xml \u3060\u3068\u30fb\u30fb\u30fb\n\nsrc/main/webapp/WEB-INF/web.xml\n<servlet>\n    <servlet-name>AsyncServlet</servlet-name>\n    <servlet-class>com.example.component.AsyncServlet</servlet-class>\n    <async-supported>true</async-supported> <!-- true\u3092\u6307\u5b9a\u3057\u3066\u975e\u540c\u671f\u3092\u30b5\u30dd\u30fc\u30c8\u3059\u308b -->\n</servlet>\n<!-- ... -->\n\n\ncURL\u3084\u30d6\u30e9\u30a6\u30b6\u3092\u4f7f\u3063\u3066\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n$ curl -D - http://localhost:8080/async?waitSec=1\n\n\nHTTP\u30ec\u30b9\u30dd\u30f3\u30b9\nHTTP/1.1 200 OK\nServer: Apache-Coyote/1.1\nSet-Cookie: JSESSIONID=62614119E151341D5A7179699731E8DF; Path=/; HttpOnly\nContent-Type: text/html;charset=ISO-8859-1\nContent-Length: 201\nDate: Sun, 15 May 2016 13:26:54 GMT\n\n<html>\n<body>\n<h2>Processing is complete !</h2>\n<p>Accept timestamp is 2016-05-15T22:26:53.205</p>\n<p>Complete timestamp is 2016-05-15T22:26:54.208</p>\n<p><a href=\"/\">Go to Top</a></p>\n</body>\n</html>\n\n\n\u3042\u308c\u3042\u308c\u30fb\u30fb\u30fbHTTP\u30ec\u30b9\u30dd\u30f3\u30b9\u3092\u898b\u308b\u3060\u3051\u3060\u3068\u3001\u540c\u671f\u578b\u3068\u4e00\u7dd2\u3067\u3059\u306d\u30fb\u30fb\u30fb\u30fb\u3002\u30b5\u30fc\u30d0\u30fc\u5074\u306e\u30ed\u30b0\u3082\u898b\u3066\u307f\u307e\u3057\u3087\u3046\uff01\uff01\n\n\u30b3\u30f3\u30bd\u30fc\u30eb\n2016-05-15T22:26:53.204 Thread[http-nio-8080-exec-8,5,main]: Start doGet.\n2016-05-15T22:26:53.205 Thread[http-nio-8080-exec-8,5,main]: End doGet.\n2016-05-15T22:26:53.205 Thread[http-nio-8080-exec-9,5,main]: Start Async processing.\n2016-05-15T22:26:54.209 Thread[http-nio-8080-exec-9,5,main]: End Async processing.\n2016-05-15T22:26:54.211 Thread[http-nio-8080-exec-10,5,main]: Called complete.jsp\n2016-05-15T22:26:54.211 Thread[http-nio-8080-exec-10,5,main]: ASYNC\n\n\nHTTP\u30ec\u30b9\u30dd\u30f3\u30b9\u306e\u7d50\u679c\u306f\u4e00\u7dd2\u3067\u3059\u304c\u3001\u30b5\u30fc\u30d0\u30fc\u5074\u306e\u51e6\u7406\u306f\uff13\u3064\u306e\u30b9\u30ec\u30c3\u30c9\u306b\u308f\u304b\u308c\u3066\u51e6\u7406\u304c\u884c\u308f\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3059\u3002\u305f\u3076\u3093\u30c6\u30ad\u30b9\u30c8\u3060\u3051\u3060\u3068\u4f1d\u308f\u308a\u305a\u3089\u3044\u3068\u601d\u3046\u306e\u3067\u3001\u52d5\u304d\u3092\u7d75\u3067\u3042\u308f\u3089\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\n\u3060\u3044\u3060\u3044\u3053\u3093\u306a\u611f\u3058\u3067\u52d5\u3044\u3066\u3044\u307e\u3059\u3002\n\u3078\u301c\u3068\u3044\u3046\u611f\u3058\u3067\u306f\u3042\u308a\u307e\u3059\u304c\u3001\u3053\u308c\u3060\u3068\u975e\u540c\u671f\u306b\u3059\u308b\u610f\u5473\u3042\u308b\u306e\uff1f\u540c\u671f\u578b\u3068\u4f55\u304c\u9055\u3046\u306e\uff1f\u5358\u306b\u8907\u96d1\u306b\u306a\u308b\u3060\u3051\u3058\u3083\u3093\u30fb\u30fb\u30fb\u3068\u601d\u3063\u3061\u3083\u3044\u307e\u3059\u3088\u306d\uff01\uff1f\n\u305d\u3046\u306a\u3093\u3067\u3059\u30fb\u30fb\u30fb\u975e\u540c\u671f\u51e6\u7406(\u4e3b\u306b\u91cd\u305f\u3044\u51e6\u7406\u3001\u9577\u3044\u9593\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3068\u306e\u63a5\u7d9a\u3092\u7dad\u6301\u3057\u305f\u3044\u51e6\u7406\u306a\u3069)\u3092\u884c\u3046\u30b9\u30ec\u30c3\u30c9\uff08\u4e0a\u306e\u7d75\u3060\u3068\u3001\u300chttp-nio-8080-exec-9\u300d\u306e\u30b9\u30ec\u30c3\u30c9\uff09\u3092\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d0\u30fc\u304c\u30ea\u30af\u30a8\u30b9\u30c8\u51e6\u7406\u3092\u884c\u3046\u305f\u3081\u306b\u7528\u610f\u3057\u3066\u3044\u308b\u30b9\u30ec\u30c3\u30c9\u3092\u4f7f\u3063\u3066\u3057\u307e\u3046\u3068\u3001\u975e\u540c\u671f\u306b\u3059\u308b\u610f\u5473\u304c\u306a\u3044\u306e\u3067\u3059\u30fb\u30fb\u30fb\u3002\n\u79c1\u306e\u8db3\u308a\u3066\u3044\u306a\u3044\u304b\u3082\u3057\u308c\u306a\u3044\u8a8d\u8b58\u3067\u306f\u30fb\u30fb\u30fb\n\u975e\u540c\u671f\u51e6\u7406\u306f\u300c\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d0\u30fc\u304c\u30ea\u30af\u30a8\u30b9\u30c8\u51e6\u7406\u3092\u884c\u3046\u305f\u3081\u306b\u7528\u610f\u3057\u3066\u3044\u308b\u30b9\u30ec\u30c3\u30c9\u300d\u3067\u306f\u306a\u304f\u300c\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u304c\u7528\u610f\u3059\u308b\u30b9\u30ec\u30c3\u30c9\uff08\u30b9\u30ec\u30c3\u30c9\u30d7\u30fc\u30eb\u304b\u3089\u53d6\u5f97\u3057\u305f\u30b9\u30ec\u30c3\u30c9\uff09\u300d\u3092\u4f7f\u3046\u3053\u3068\u3067\u3001\u975e\u540c\u671f\u51e6\u7406\u3092\u5b9f\u884c\u3057\u3066\u3044\u308b\u6700\u4e2d\u3067\u3082\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d0\u30fc\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u53d7\u4ed8\u3092\u30d6\u30ed\u30c3\u30af\u3055\u305b\u306a\u3044\u305f\u3081\u306e\u6a5f\u80fd\u3060\u3068\u601d\u3063\u3066\u3044\u307e\u3059\u3002\uff08\u3053\u3053\u306f\u79c1\u306e\u8a8d\u8b58\u4e0d\u8db3\u306a\u3060\u3051\u306e\u53ef\u80fd\u6027\u3042\u308a  \uff09\n\u79c1\u306e\u8a8d\u8b58\u3092\u7d75\u306b\u53cd\u6620\u3059\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d0\u30fc\u7ba1\u7406\u306e\u30b9\u30ec\u30c3\u30c9\u306f\u3001\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u53d7\u4ed8\u3068\u30ec\u30b9\u30dd\u30f3\u30b9\u30c7\u30fc\u30bf\u306e\u751f\u6210\u3068\u3044\u3046\u6bd4\u8f03\u7684\u8efd\u3044\u51e6\u7406\u306b\u5c02\u5ff5\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n\n\u30a2\u30d7\u30ea\u7ba1\u7406\u306e\u30b9\u30ec\u30c3\u30c9\u3092\u4f7f\u7528\u3057\u305f\u975e\u540c\u671f\u5b9f\u88c5\u306b\u3057\u3066\u307f\u308b\n\u975e\u540c\u671f\u51e6\u7406\u306e\u5b9f\u884c\u3092ExecutorService\u7d4c\u7531\u3067\u5b9f\u884c\u3059\u308b\u3088\u3046\u306b\u5909\u66f4\u3057\u307e\u3057\u3087\u3046\u3002\n\u307e\u305a\u3001init\u3068destory\u30e1\u30bd\u30c3\u30c9\u3092\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3057\u3001\u6307\u5b9a\u3057\u305f\u6570\u306e\u30b9\u30ec\u30c3\u30c9\u30d7\u30fc\u30eb\u3092\u3082\u3064ExecutorService\u306e\u751f\u6210\u30fb\u7834\u68c4\u3092\u884c\u3044\u307e\u3059\u3002\n\nsrc/main/java/com/example/component/AsyncServlet.java\n@WebServlet(urlPatterns = \"/async\", asyncSupported = true)\npublic class AsyncServlet extends HttpServlet {\n\n    private ExecutorService executorService;\n\n    // ExecutorService\u3092\u751f\u6210\u3059\u308b\n    @Override\n    public void init() throws ServletException {\n        this.executorService = Executors.newFixedThreadPool(10);\n    }\n\n    // ExecutorService\u3092\u505c\u6b62\u3059\u308b\n    @Override\n    public void destroy() {\n        try {\n            executorService.shutdown();\n            executorService.awaitTermination(60, TimeUnit.SECONDS);\n        } catch (InterruptedException e) {\n            Thread.interrupted();\n        }\n    }\n    ...\n}\n\n\n\u6b21\u306b\u3001AsyncContext#start()\u3068\u3057\u3066\u3044\u305f\u90e8\u5206\u3092ExecutorService\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u4f7f\u7528\u3059\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\nexecutorService.execute(() -> { // ExecutorService\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u4f7f\u3063\u3066\u5225\u30b9\u30ec\u30c3\u30c9\u3067\u51e6\u7406\u3092\u884c\u3046\n    // ...\n});\n\n\u30b5\u30fc\u30d6\u30ec\u30c3\u30c8\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001\u30ed\u30b0\u304c\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u3001\u975e\u540c\u671f\u51e6\u7406\u304c\u30a2\u30d7\u30ea\u7ba1\u7406\u306e\u30b9\u30ec\u30c3\u30c9\u4e0a\u3067\u52d5\u3044\u3066\u3044\u308b\u306e\u304c\u308f\u304b\u308a\u307e\u3059\u3002\n\n\u30b3\u30f3\u30bd\u30fc\u30eb\n2016-05-16T00:07:47.021 Thread[http-nio-8080-exec-5,5,main]: End doGet.\n2016-05-16T00:07:47.021 Thread[pool-1-thread-1,5,main]: Start Async processing.\n2016-05-16T00:07:48.026 Thread[pool-1-thread-1,5,main]: End Async processing.\n2016-05-16T00:07:48.079 Thread[http-nio-8080-exec-6,5,main]: Called complete.jsp\n2016-05-16T00:07:48.079 Thread[http-nio-8080-exec-6,5,main]: ASYNC\n\n\n\n\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u306e\u6307\u5b9a\n\u975e\u540c\u671f\u51e6\u7406\u306b\u306f\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3092\u8a2d\u3051\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\u30c7\u30d5\u30a9\u30eb\u30c8\u306f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d0\u30fc\u306e\u8a2d\u5b9a\u306b\u4f9d\u5b58\u3057\u307e\u3059\u304c\u3001\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u5074\u3067\u660e\u793a\u7684\u306b\u3057\u3066\u3044\u308b\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n...\nAsyncContext asyncContext = request.startAsync(request, response);\nasyncContext.setTimeout(3000); // \u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u6642\u9593(\u30df\u30ea\u79d2\u5358\u4f4d)\u3092\u6307\u5b9a\u3059\u308b\u30020\u3092\u6307\u5b9a\u3059\u308b\u3068\u7121\u5236\u9650\u3002\n...\n\n\n\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u306e\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\n\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u6642\u9593\u3092\u8d85\u3048\u3066\u3082\u975e\u540c\u671f\u51e6\u7406\u304c\u7d42\u308f\u3089\u306a\u3044\u5834\u5408\u306f\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u3060\u3068500(Internal Server Error)\u306b\u306a\u308a\u307e\u3059\u3002\n$ curl -D - http://localhost:8080/async?waitSec=4\n\n\nHTTP\u30ec\u30b9\u30dd\u30f3\u30b9\nHTTP/1.1 500 Internal Server Error\nServer: Apache-Coyote/1.1\nContent-Type: text/html;charset=utf-8\nContent-Language: ja\nContent-Length: 1065\nDate: Sun, 15 May 2016 15:44:23 GMT\nConnection: close\n\n...\n\n\n\u307e\u305f\u3001\u30b5\u30fc\u30d0\u30fc\u5074\u306e\u30b3\u30f3\u30bd\u30fc\u30eb\u30ed\u30b0\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n2016-05-16T00:54:26.771 Thread[http-nio-8080-exec-8,5,main]: Start doGet.\n2016-05-16T00:54:26.771 Thread[http-nio-8080-exec-8,5,main]: End doGet.\n2016-05-16T00:54:26.771 Thread[pool-1-thread-3,5,main]: Start Async processing.\nException in thread \"pool-1-thread-3\" java.lang.IllegalStateException: The request associated with the AsyncContext has already completed processing.\n    at org.apache.catalina.core.AsyncContextImpl.check(AsyncContextImpl.java:536)\n    at org.apache.catalina.core.AsyncContextImpl.dispatch(AsyncContextImpl.java:186)\n    at com.example.component.AsyncServlet.lambda$doGet$0(AsyncServlet.java:64)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\n\n\u3053\u3053\u3067\u610f\u8b58\u3057\u3066\u307b\u3057\u3044\u306e\u306f\u3001\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u5f8c\u3082\u975e\u540c\u671f\u51e6\u7406\u81ea\u4f53\u306f\u5b9f\u884c\u3055\u308c\u7d9a\u3051\u308b\u3068\u3044\u3046\u70b9\u3067\u3059\u3002\u4eca\u56de\u306e\u30b1\u30fc\u30b9\u3060\u3068\u3001\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u5f8c\u306bAsyncContext#dispatch\u30e1\u30bd\u30c3\u30c9\u304c\u547c\u3073\u51fa\u3055\u308c\u3001\u7d50\u679c\u3068\u3057\u3066\u30a8\u30e9\u30fc\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\nNote: \u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u5f8c\u306e\u975e\u540c\u671f\u51e6\u7406\u5185\u3067\u306e\u30a8\u30e9\u30fc\u306e\u56de\u907f\u65b9\u6cd5\u306b\u3064\u3044\u3066\n\u3044\u307e\u3044\u3061\u4f55\u304c\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9\u306a\u306e\u304b\u308f\u304b\u3063\u3066\u3044\u307e\u305b\u3093\u30fb\u30fb\u30fb  IBM\u306e\u30da\u30fc\u30b8\u306b\u306f\u3001AtomicBoolean\u3092\u4f7f\u3063\u3066\u56de\u907f\u3059\u308b\u65b9\u6cd5\u304c\u7d39\u4ecb\u3055\u308c\u3066\u3044\u307e\u3057\u305f\u304c\u3001\u3053\u308c\u3067\u672c\u5f53\u306b\u89e3\u6c7a\u3055\u308c\u308b\u306e\u304b\u7591\u554f\u30fb\u30fb\u30fb\u3002\u8ab0\u304b\u30d8\u30eb\u30d7\u30df\u30fc\u301c\u3002Spring\u304c\u3053\u306e\u3042\u305f\u308a\u3092\u3069\u3046\u6271\u3063\u3066\u3044\u308b\u306e\u304b\u8abf\u3079\u3066\u307f\u307e\u3059\u3002\n\u30102016/5/22\u3011\nSpring MVC\u3067\u3082\u3001\u30ea\u30af\u30a8\u30b9\u30c8\u30b9\u30b3\u30fc\u30d7\u3067AtomicBoolean\u306a\u5909\u6570\u3092\u5171\u6709\u3057\u3066\u591a\u91cddispatch\u3092\u9632\u3044\u3067\u3044\u307e\u3057\u305f\u3002\u306a\u304a\u3001Spring MVC\u3092\u4f7f\u7528\u3057\u305f\u975e\u540c\u671f\u51e6\u7406\u306b\u3064\u3044\u3066\u306f\u3001\u300cSpring MVC(+Spring Boot)\u4e0a\u3067\u306e\u975e\u540c\u671f\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u7406\u89e3\u3059\u308b -\u524d\u7de8-\u300d\u3092\u3054\u89a7\u304f\u3060\u3055\u3044\u3002\n\n\n\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u30a8\u30e9\u30fc\u753b\u9762\u3078\u9077\u79fb\u3055\u305b\u308b\n\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u305f\u5834\u5408\u306f\u3001500(Internal Server Error)\u3067\u306f\u306a\u304f\u5c02\u7528\u306e\u30a8\u30e9\u30fc\u753b\u9762\u306a\u3069\u306b\u9077\u79fb\u3055\u305b\u305f\u3044\u306e\u3067\u306f\u306a\u3044\u3067\u3057\u3087\u3046\u304b\u3002\u3053\u3053\u3067\u306f\u3001\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u30a8\u30e9\u30fc\u7528\u306eJSP\u306b\u30c7\u30a3\u30b9\u30d1\u30c3\u30c1\u3057\u3066\u307f\u307e\u3059\u3002\n\u307e\u305a\u3001\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u30a8\u30e9\u30fc\u753b\u9762\u7528\u306eJSP\u3092\u4f5c\u308a\u307e\u3059\u3002\n\nsrc/main/webapp/timeout.jsp\n<%@ page import=\"com.example.component.Console\" trimDirectiveWhitespaces=\"true\" %>\n<% Console.println(\"Called timeout.jsp\"); %>\n<% Console.println(request.getDispatcherType()); %>\n\n<html>\n<body>\n<h2>Timeout!</h2>\n<p><a href=\"${pageContext.request.contextPath}/\">Go to Top</a></p>\n</body>\n</html>\n\n\n\u6b21\u306b\u3001javax.servlet.AsyncListener\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u3092\u5b9f\u88c5\u3057\u3001onTimeout\u30e1\u30bd\u30c3\u30c9\u306b\u30a8\u30e9\u30fc\u51e6\u7406(timeout.jsp\u3078\u306e\u30c7\u30a3\u30b9\u30d1\u30c3\u30c1\u51e6\u7406)\u3092\u5b9f\u88c5\u3057\u307e\u3059\u3002\n@WebServlet(urlPatterns = \"/async\", asyncSupported = true)\npublic class AsyncServlet extends HttpServlet implements AsyncListener {\n    // ...\n    @Override\n    public void onComplete(AsyncEvent event) throws IOException {\n        Console.println(\"onComplete:\" + event);\n    }\n\n    @Override\n    public void onTimeout(AsyncEvent event) throws IOException {\n        Console.println(\"onTimeout:\" + event);\n        event.getAsyncContext().dispatch(\"/timeout.jsp\"); // timeout.jsp\u3078\u30c7\u30a3\u30b9\u30d1\u30c3\u30c1\u3059\u308b\n    }\n\n    @Override\n    public void onError(AsyncEvent event) throws IOException {\n        Console.println(\"onError:\" + event);\n    }\n\n    @Override\n    public void onStartAsync(AsyncEvent event) throws IOException {\n        Console.println(\"onStartAsync:\" + event);\n    }\n}\n\n$ curl -D - http://localhost:8080/async?waitSec=4\n\n\nHTTP\u30ec\u30b9\u30dd\u30f3\u30b9\nHTTP/1.1 200 OK\nServer: Apache-Coyote/1.1\nSet-Cookie: JSESSIONID=6696B7A54D07D3300658115D8ED093D8; Path=/; HttpOnly\nContent-Type: text/html;charset=ISO-8859-1\nContent-Length: 81\nDate: Sun, 15 May 2016 16:22:47 GMT\n\n<html>\n<body>\n<h2>Timeout!</h2>\n<p><a href=\"/\">Go to Top</a></p>\n</body>\n</html>\n\n\n\u30b5\u30fc\u30d0\u30fc\u5074\u306e\u30b3\u30f3\u30bd\u30fc\u30eb\u30ed\u30b0\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u30b3\u30f3\u30bd\u30fc\u30eb\n2016-05-16T01:23:23.488 Thread[http-nio-8080-exec-2,5,main]: Start doGet.\n2016-05-16T01:23:23.488 Thread[http-nio-8080-exec-2,5,main]: End doGet.\n2016-05-16T01:23:23.488 Thread[pool-1-thread-5,5,main]: Start Async processing.\n2016-05-16T01:23:26.496 Thread[http-nio-8080-exec-3,5,main]: onTimeout:javax.servlet.AsyncEvent@339e5a11\n2016-05-16T01:23:26.498 Thread[http-nio-8080-exec-3,5,main]: Called timeout.jsp\n2016-05-16T01:23:26.498 Thread[http-nio-8080-exec-3,5,main]: ASYNC\n2016-05-16T01:23:26.498 Thread[http-nio-8080-exec-3,5,main]: onComplete:javax.servlet.AsyncEvent@339e5a11\n...\n\n\n\n\u975e\u540c\u671f\u51e6\u7406\u7d42\u4e86\u5f8c\u306e\u632f\u308b\u821e\u3044\n\u672c\u6295\u7a3f\u3067\u6271\u3063\u305f\u30b5\u30f3\u30d7\u30eb\u3067\u306f\u3001\u975e\u540c\u671f\u51e6\u7406\u304c\u7d42\u4e86\u3057\u305f\u5f8c\u306b\u6307\u5b9a\u3057\u305f\u30d1\u30b9\u306b\u30c7\u30a3\u30b9\u30d1\u30c3\u30c1\u3059\u308b\u65b9\u5f0f\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u304c\u3001\u30c7\u30a3\u30b9\u30d1\u30c3\u30c1\u305b\u305a\u306b\u3059\u3050\u306b\u5b8c\u4e86\u3055\u305b\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n\n\n\n\u30e1\u30bd\u30c3\u30c9\n\u8aac\u660e\n\n\n\n\ndispatch\n\u3053\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u547c\u3073\u51fa\u3059\u3068\u3001\u30b5\u30fc\u30d6\u30ec\u30c3\u30c8\u30b3\u30f3\u30c6\u30ca\u306f\u6307\u5b9a\u3055\u308c\u305f\u30d1\u30b9\u3078\u30c7\u30a3\u30b9\u30d1\u30c3\u30c1\u3057\u307e\u3059\u3002(\u30b5\u30f3\u30d7\u30eb\u3067\u306f\u3053\u3061\u3089\u306e\u65b9\u6cd5\u3092\u4f7f\u3063\u3066\u3044\u307e\u3059)\n\n\ncomplete\n\u3053\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u547c\u3073\u51fa\u3059\u3068\u3001\u30b5\u30fc\u30d6\u30ec\u30c3\u30c8\u30b3\u30f3\u30c6\u30ca\u306fHTTP\u30ec\u30b9\u30dd\u30f3\u30b9\u3092\u5b8c\u4e86\u3057\u307e\u3059\u3002\u3053\u306e\u30e1\u30bd\u30c3\u30c9\u306f\u3001\u3053\u306e\u5f8c\u7d39\u4ecb\u3059\u308b\u300c\u5206\u5272\u30ec\u30b9\u30dd\u30f3\u30b9\u300d\u6642\u3068\u4e00\u7dd2\u306b\u4f7f\u3046\u3053\u3068\u304c\u591a\u3044\u3068\u601d\u308f\u308c\u307e\u3059\u3002\n\n\n\n\n\u30ec\u30b9\u30dd\u30f3\u30b9\u65b9\u6cd5\n\u672c\u6295\u7a3f\u3067\u6271\u3063\u305f\u30b5\u30f3\u30d7\u30eb\u3067\u306f\u3001\u30c7\u30a3\u30b9\u30d1\u30c3\u30c1\u5f8c\u306b\u307e\u3068\u3081\u3066\u30ec\u30b9\u30dd\u30f3\u30b9\u3092\u8fd4\u5374\u3057\u3066\u3044\u307e\u3059\u304c\u3001\u975e\u540c\u671f\u51e6\u7406\u4e2d\u306b\u5206\u5272\u3057\u3066\u30ec\u30b9\u30dd\u30f3\u30b9\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n\n\n\n\u65b9\u6cd5\n\u8aac\u660e\n\n\n\n\n\u4e00\u62ec\n\u30c7\u30a3\u30b9\u30d1\u30c3\u30c1\u5f8c\u306e\u51e6\u7406\u3067\u4e00\u62ec\u3067\u30ec\u30b9\u30dd\u30f3\u30b9\u3057\u307e\u3059\u3002\u672c\u6295\u7a3f\u306e\u30b5\u30f3\u30d7\u30eb\u5b9f\u88c5\u306f\u3001\u3053\u306e\u65b9\u5f0f\u3067\u306e\u5b9f\u88c5\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n\n\u5206\u5272\n\u975e\u540c\u671f\u51e6\u7406\u3092\u958b\u59cb\u3059\u308b\u524d\u306b\u30ec\u30b9\u30dd\u30f3\u30b9\u3092\u3044\u3063\u305f\u3093\u30d5\u30e9\u30c3\u30b7\u30e5\u3059\u308b\u3053\u3068\u3067\u3001\u5206\u5272\u30ec\u30b9\u30dd\u30f3\u30b9(Transfer-Encoding: chunked)\u3068\u306a\u308b\u3053\u3068\u3092\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3078\u901a\u77e5\u3057\u3001\u4ee5\u964d\u306f\u4efb\u610f\u306e\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u30c7\u30fc\u30bf\u3092\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3078\u9001\u4fe1(Push)\u3057\u307e\u3059\u3002 \u3053\u306e\u65b9\u6cd5\u306f\u3001HTTP Streaming\u3092\u5b9f\u73fe\u3059\u308b\u969b\u306b\u3082\u4f7f\u7528\u3067\u304d\u307e\u3059\u3002\n\n\n\n\u5206\u5272\u30ec\u30b9\u30dd\u30f3\u30b9\u65b9\u5f0f\u306e\u5229\u7528\u30a4\u30e1\u30fc\u30b8\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\n\n\n\u975e\u540c\u671f\u30ea\u30af\u30a8\u30b9\u30c8\u7528\u306e\u30a4\u30d9\u30f3\u30c8\u30ea\u30b9\u30ca\u30fc\n\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u306e\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u306e\u3068\u3053\u308d\u3067onTimeout\u30e1\u30bd\u30c3\u30c9\u3092\u5b9f\u88c5\u3057\u307e\u3057\u305f\u304c\u3001onTimeout\u30e1\u30bd\u30c3\u30c9\u4ee5\u5916\u306b\u3082\u3044\u304f\u3064\u304b\u306e\u30e1\u30bd\u30c3\u30c9\u304c\u63d0\u4f9b\u3055\u308c\u3066\u3044\u307e\u3059\u3002\uff08\u8aac\u660e\u306f\u9593\u9055\u3063\u3066\u3044\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u30fb\u30fb\u30fb\uff09\n\n\n\n\u30e1\u30bd\u30c3\u30c9\n\u8aac\u660e\n\n\n\n\nonComplete\n\u975e\u540c\u671f\u30ea\u30af\u30a8\u30b9\u30c8(dispatch\u5f8c\u306e\u51e6\u7406)\u304c\u5b8c\u4e86\u3057\u305f\u6642\u306b\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3055\u308c\u308b\u3002\n\n\nonTimeout\n\u30b5\u30fc\u30d6\u30ec\u30c3\u30c8\u30b3\u30f3\u30c6\u30ca\u304c\u975e\u540c\u671f\u51e6\u7406\u306e\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3092\u691c\u77e5\u3057\u305f\u6642\u306b\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3055\u308c\u308b\u3002\n\n\nonError\n\u975e\u540c\u671f\u30ea\u30af\u30a8\u30b9\u30c8(dispatch\u5f8c\u306e\u51e6\u7406)\u3067\u30b5\u30fc\u30d6\u30ec\u30c3\u30c8\u30b3\u30f3\u30c6\u30ca\u306b\u901a\u77e5\u3055\u308c\u308b\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u305f\u6642\u306b\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3055\u308c\u308b\u3002\uff08\u305f\u3076\u3093\u30fb\u30fb\u30fb\uff09\n\n\nonStartAsync\n\u975e\u540c\u671f\u30ea\u30af\u30a8\u30b9\u30c8(dispatch\u5f8c\u306e\u51e6\u7406)\u4e2d\u306b\u3001\u65b0\u305f\u306b\u5225\u306e\u975e\u540c\u671f\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u958b\u59cb\u3055\u308c\u305f\u6642\u306b\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3055\u308c\u308b\u3002\uff08\u305f\u3076\u3093\u30fb\u30fb\u30fb\uff09\n\n\n\n\n\u30b5\u30fc\u30d6\u30ec\u30c3\u30c8\u30d5\u30a3\u30eb\u30bf\u30fc\u306e\u632f\u308b\u821e\u3044\nServlet\u6a19\u6e96\u306e\u975e\u540c\u671f\u51e6\u7406\u3092\u5229\u7528\u3059\u308b\u5834\u5408\u306f\u3001Servlet\u306b\u52a0\u3048\u3066Filter\u3082\u975e\u540c\u671f\u51e6\u7406\u306b\u30b5\u30dd\u30fc\u30c8\u3055\u305b\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u3072\u3068\u3064\u3067\u3082\u975e\u540c\u671f\u306b\u5bfe\u5fdc\u3057\u3066\u3044\u306a\u3044Filter\u304c\u3042\u308b\u3068\u30a8\u30e9\u30fc\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n@WebFilter(urlPatterns = \"/*\", asyncSupported = true) // asyncSupported\u5c5e\u6027\u3092true\u306b\u3057\u3001\u975e\u540c\u671f\u51e6\u7406\u3092\u6271\u3048\u308b\u3088\u3046\u306b\u3059\u308b\npublic class CustomFilter implements Filter {\n    @Override\n    public void init(FilterConfig filterConfig) throws ServletException {\n    }\n    @Override\n    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {\n        chain.doFilter(request, response);\n    }\n    @Override\n    public void destroy() {\n    }\n}\n\nweb.xml \u3060\u3068\u30fb\u30fb\u30fb\n\nsrc/main/webapp/WEB-INF/web.xml\n<filter>\n    <filter-name>CustomFilter</filter-name>\n    <filter-class>com.example.component.CustomFilter</filter-class>\n    <async-supported>true</async-supported> <!-- true\u3092\u6307\u5b9a\u3057\u3066\u975e\u540c\u671f\u3092\u30b5\u30dd\u30fc\u30c8\u3059\u308b -->\n</filter>\n<!-- ... -->\n\n\n\u307e\u305f\u3001\u975e\u540c\u671f\u51e6\u7406\u7d42\u4e86\u5f8c\u306e\u30c7\u30a3\u30b9\u30d1\u30c3\u30c1\u306b\u30b5\u30fc\u30d6\u30ec\u30c3\u30c8\u30d5\u30a3\u30eb\u30bf\u30fc\u3092\u9069\u7528\u3057\u305f\u3044\u5834\u5408\u306f\u3001DispatcherType\u3068\u3057\u3066ASYNC\u3092\u6307\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n@WebFilter(urlPatterns = \"/*\", asyncSupported = true, dispatcherTypes = DispatcherType.ASYNC) // dispatcherTypes\u5c5e\u6027\u306bASYNC\u3092\u6307\u5b9a\u3057\u3001\u975e\u540c\u671f\u51e6\u7406\u3092\u9069\u7528\u5bfe\u8c61\u306b\u3059\u308b\npublic class CustomFilter implements Filter {\n    // ...\n}\n\nweb.xml \u3060\u3068\u30fb\u30fb\u30fb\n\nsrc/main/webapp/WEB-INF/web.xml\n<!-- ... -->\n<filter-mapping>\n    <filter-name>CustomFilter</filter-name>\n    <url-pattern>/*</url-pattern>\n    <dispatcher>ASYNC</dispatcher> <!-- dispatcher\u30bf\u30b0\u306bASYNC\u3092\u6307\u5b9a -->\n</filter-mapping>\n\n\n\n\u307e\u3068\u3081\n\u4eca\u56de\u306f\u3001\u5f8c\u65e5\u6295\u7a3f\u4e88\u5b9a\u306e\u300cSpring MVC(+Spring Boot)\u4e0a\u3067\u306eServlet\u6a19\u6e96\u306e\u975e\u540c\u671f\u51e6\u7406\u3092\u7406\u89e3\u3059\u308b\u300d\u306e\u524d\u63d0\u3068\u306a\u308b\u77e5\u8b58\u3092\u4e8b\u524d\u306b\u7d39\u4ecb\u3057\u3066\u304a\u304d\u307e\u3057\u305f\u3002\u79c1\u3082\u307b\u307c\u521d\u3081\u3066\u4f7f\u3046\u306e\u3067\u3001\u9593\u9055\u3063\u305f\u3053\u3068\u3092\u66f8\u3044\u3066\u3044\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\uff08\u6709\u8b58\u8005\u306e\u65b9\u306f\u662f\u975e\u30b3\u30e1\u30f3\u30c8\u3092  \uff09\n\n\u53c2\u8003\u30b5\u30a4\u30c8\n\nhttp://www.cresc.co.jp/tech/java/Servlet_Specifications/Servlet_Specification_3_0_Japanese.pdf\nhttp://www.ibm.com/support/knowledgecenter/SSAW57_8.5.5/com.ibm.websphere.nd.doc/ae/cweb_asyncservlet.html?lang=ja\n\n\u4eca\u56de\u306f\u3001Servlet 3.0\u3067\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u305f\u975e\u540c\u671f\u51e6\u7406\u306b\u3064\u3044\u3066\u8aac\u660e\u3057\u307e\u3059\u3002\u3053\u308c\u306f\u3001\u5f8c\u65e5\u6295\u7a3f\u4e88\u5b9a\u306e\u300cSpring MVC(+Spring Boot)\u4e0a\u3067\u306eServlet\u6a19\u6e96\u306e\u975e\u540c\u671f\u51e6\u7406\u3092\u7406\u89e3\u3059\u308b\u300d\u306e\u524d\u63d0\u3068\u306a\u308b\u57fa\u790e\u77e5\u8b58\u306b\u306a\u308a\u307e\u3059\u3002\u79c1\u81ea\u8eabServlet\u6a19\u6e96\u306e\u975e\u540c\u671f\u51e6\u7406\u306f\u4f7f\u3063\u305f\u3053\u3068\u306f\u307b\u307c\u306a\u3044\u306e\u3067\u3001\u9593\u9055\u3063\u3066\u3044\u308b\u7b87\u6240\u304c\u3042\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\uff0b\u7d30\u304b\u3044\u52d5\u4f5c\u4ed5\u69d8\u306e\u8aac\u660e\u306f\u672c\u6295\u7a3f\u3067\u306f\u6271\u3044\u307e\u305b\u3093\u30fb\u30fb\u30fb \uff08\u3042\u3057\u304b\u3089\u305a :sweat_smile:\uff09 \n\n# \u52d5\u4f5c\u78ba\u8a8d\u74b0\u5883\n\n* Java SE 8\n* Tomcat 8.0 (Servlet 3.1)\n\n# \u307e\u305a\u306f\u666e\u901a\u306eServlet\u3092\u4f5c\u3063\u3066\u307f\u308b\n\n\u975e\u540c\u671f\u3046\u3093\u306c\u3093\u306e\u524d\u306b\u3001\u307e\u305a\u666e\u901a\u306eServlet\u3092\u4f5c\u3063\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n`waitSec`\u3067\u6307\u5b9a\u3057\u305f\u79d2\u6570\u3060\u3051\u5f85\u3063\u3066\u304b\u3089 `\"/complete.jsp\"`\u306b\u9077\u79fb\u3059\u308b\u3068\u3044\u3046\u30b7\u30f3\u30d7\u30eb\u306a\u30b5\u30fc\u30d6\u30ec\u30c3\u30c8\u3067\u3059\u3002\n\n```java:src/main/java/com/example/component/StandardServlet.java\npackage com.example.component;\n\nimport javax.servlet.ServletException;\nimport javax.servlet.annotation.WebServlet;\nimport javax.servlet.http.HttpServlet;\nimport javax.servlet.http.HttpServletRequest;\nimport javax.servlet.http.HttpServletResponse;\nimport java.io.IOException;\nimport java.time.LocalDateTime;\nimport java.util.Optional;\nimport java.util.concurrent.TimeUnit;\n\n@WebServlet(urlPatterns = \"/standard\")\npublic class StandardServlet extends HttpServlet {\n\n    @Override\n    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {\n        Console.println(\"Start doGet.\");\n\n        long waitSec = Optional.ofNullable(request.getParameter(\"waitSec\"))\n                .map(Long::valueOf).orElse(0L);\n\n        request.setAttribute(\"acceptedTime\", LocalDateTime.now());\n\n        String dispatchPath;\n        try {\n            heavyProcessing(waitSec, request);\n            dispatchPath = \"/complete.jsp\";\n        } catch (Exception e) {\n            dispatchPath = \"/error.jsp\";\n        }\n\n        request.getRequestDispatcher(dispatchPath).forward(request, response);\n\n        Console.println(\"End doGet.\");\n    }\n\n    private void heavyProcessing(long waitSec, HttpServletRequest request) {\n\n        if (waitSec == 999) {\n            throw new IllegalStateException(\"Special parameter for confirm error.\");\n        }\n\n        try {\n            TimeUnit.SECONDS.sleep(waitSec);\n        } catch (InterruptedException e) {\n            Thread.interrupted();\n        }\n\n        request.setAttribute(\"completedTime\", LocalDateTime.now());\n\n    }\n\n}\n```\n\nLogback\u306a\u3069\u306e\u30ed\u30ac\u30fc\u3092\u5165\u308c\u3066\u3082\u3044\u3044\u3051\u3069\u3001\u306a\u3093\u3068\u306a\u304f\u6a19\u6e96\u51fa\u529b\u306b\u30ed\u30b0\u3092\u51fa\u529b\u3059\u308b\u7c21\u6613\u30af\u30e9\u30b9\u3092\u4f5c\u308b\u3053\u3068\u306b\u3057\u3066\u307f\u305f\u3002\uff08\u30ed\u30ac\u30fc\u4f7f\u3044\u305f\u3044\u4eba\u306f\u30ed\u30ac\u30fc\u306b\u3057\u3066\u304f\u3060\u3055\u3044\uff01\uff01\uff09\n\n```java:src/main/java/com/example/component/Console.java\npackage com.example.component;\n\nimport java.time.LocalDateTime;\n\npublic class Console {\n    public static void println(Object target) {\n        System.out.println(LocalDateTime.now() + \" \" + Thread.currentThread() + \": \" + target);\n    }\n}\n```\n\nJSP\u306f\u3053\u3093\u306a\u611f\u3058\u3002\n\n```jsp:src/main/webapp/complete.jsp\n<%@ page import=\"com.example.component.Console\" %>\n<% Console.println(\"Called complete.jsp\"); %>\n<% Console.println(request.getDispatcherType()); %>\n\n<html>\n<body>\n<h2>Processing is complete !</h2>\n<p>Accept timestamp is ${acceptedTime}</p>\n<p>Complete timestamp is ${completedTime}</p>\n<p><a href=\"${pageContext.request.contextPath}/\">Go to Top</a></p>\n</body>\n</html>\n```\n\ncURL\u3084\u30d6\u30e9\u30a6\u30b6\u3092\u4f7f\u3063\u3066\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001`complete.jsp`\u3067\u751f\u6210\u3055\u308c\u305fHTML\u304c\u8fd4\u5374\u3055\u308c\u307e\u3059\u3002\n\n```bash\n$ curl -D - http://localhost:8080/standard?waitSec=1\n```\n```text:HTTP\u30ec\u30b9\u30dd\u30f3\u30b9\nHTTP/1.1 200 OK\nServer: Apache-Coyote/1.1\nSet-Cookie: JSESSIONID=B19F3B445442E16E9CF1EA4E855BFE24; Path=/; HttpOnly\nContent-Type: text/html;charset=ISO-8859-1\nContent-Length: 201\nDate: Sun, 15 May 2016 12:40:55 GMT\n\n<html>\n<body>\n<h2>Processing is complete !</h2>\n<p>Accept timestamp is 2016-05-15T21:40:54.902</p>\n<p>Complete timestamp is 2016-05-15T21:40:55.903</p>\n<p><a href=\"/\">Go to Top</a></p>\n</body>\n</html>\n```\n\n\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d0\u30fc\u4e0a\u306e\u30b3\u30f3\u30bd\u30fc\u30eb\u306b\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30ed\u30b0\u304c\u51fa\u529b\u3055\u308c\u307e\u3059\u3002\n\n```text:\u30b3\u30f3\u30bd\u30fc\u30eb\n2016-05-15T21:40:54.902 Thread[http-nio-8080-exec-6,5,main]: Start doGet.\n2016-05-15T21:40:55.904 Thread[http-nio-8080-exec-6,5,main]: Called complete.jsp\n2016-05-15T21:40:55.904 Thread[http-nio-8080-exec-6,5,main]: FORWARD\n2016-05-15T21:40:55.905 Thread[http-nio-8080-exec-6,5,main]: End doGet.\n```\n\n\u3042\u305f\u308a\u524d\u3067\u3059\u304c\u3001\u5168\u3066\u540c\u3058\u30b9\u30ec\u30c3\u30c9\u3067\u5b9f\u884c\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3059\u3002\n\n# Servlet\u6a19\u6e96\u306e\u4ed5\u7d44\u307f\u3092\u5229\u7528\u3057\u3066\u975e\u540c\u671f\u5b9f\u88c5\u306b\u3057\u3066\u307f\u308b\n\n`StandardServlet`\u306e\u5b9f\u88c5\u3092\u3001Servlet\u6a19\u6e96\u306e\u4ed5\u7d44\u307f\u3092\u4f7f\u3063\u3066\u975e\u540c\u671f\u5b9f\u88c5\u306b\u3057\u3066\u307f\u307e\u3059\u3002\u3053\u3053\u3067\u306f\u3001\u975e\u540c\u671f\u7528\u306b\u5225\u306eServlet\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```java:src/main/java/com/example/component/AsyncServlet.java\npackage com.example.component;\n\nimport javax.servlet.AsyncContext;\nimport javax.servlet.ServletException;\nimport javax.servlet.annotation.WebServlet;\nimport javax.servlet.http.HttpServlet;\nimport javax.servlet.http.HttpServletRequest;\nimport javax.servlet.http.HttpServletResponse;\nimport java.io.IOException;\nimport java.time.LocalDateTime;\nimport java.util.Optional;\nimport java.util.concurrent.TimeUnit;\n\n@WebServlet(urlPatterns = \"/async\", asyncSupported = true) // asyncSupported\u5c5e\u6027\u3092true\u306b\u3057\u3001\u975e\u540c\u671f\u51e6\u7406\u3092\u6271\u3048\u308b\u3088\u3046\u306b\u3059\u308b\npublic class AsyncServlet extends HttpServlet {\n\n    @Override\n    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {\n        Console.println(\"Start doGet.\");\n\n        long wait = Optional.ofNullable(request.getParameter(\"waitSec\"))\n                .map(Long::valueOf).orElse(0L);\n\n        request.setAttribute(\"acceptedTime\", LocalDateTime.now());\n\n        // \u975e\u540c\u671f\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u958b\u59cb\u3057\u3001\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u53d6\u5f97\u3059\u308b\u3002\n        AsyncContext asyncContext = request.startAsync(request, response);\n\n        // \u975e\u540c\u671f\u3067\u5b9f\u884c\u3057\u305f\u3044\u51e6\u7406\u3092\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u53d7\u3051\u4ed8\u3051\u305f\u30b9\u30ec\u30c3\u30c9\u3068\u306f\u5225\u306e\u30b9\u30ec\u30c3\u30c9\u3067\u958b\u59cb\u3059\u308b\u3002\n        // AsyncContext#start\u30e1\u30bd\u30c3\u30c9\u3092\u4f7f\u7528\u3059\u308b\u3068\u3001\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d0\u30fc(Tomcat)\u304c\u7ba1\u7406\u3057\u3066\u3044\u308b\u30b9\u30ec\u30c3\u30c9\u304c\u4f7f\u308f\u308c\u308b\u3002\n        asyncContext.start(() -> {\n            Console.println(\"Start Async processing.\");\n\n            String dispatchPath;\n            try {\n                heavyProcessing(wait, (HttpServletRequest) asyncContext.getRequest());\n                dispatchPath = \"/complete.jsp\";\n            } catch (Exception e) {\n                dispatchPath = \"/error.jsp\";\n            }\n\n            // \u6307\u5b9a\u3057\u305f\u30d1\u30b9(complete.jsp)\u3078\u306e\u30c7\u30a3\u30b9\u30d1\u30c3\u30c1\u3092\u884c\u3046\n            // \u6307\u5b9a\u3057\u305f\u30d1\u30b9\u306b\u5bfe\u3059\u308b\u51e6\u7406\u306f\u3001\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d0\u30fc(Tomcat)\u304c\u7ba1\u7406\u3057\u3066\u3044\u308b\u30b9\u30ec\u30c3\u30c9\u30d7\u30fc\u30eb\u306e\u30b9\u30ec\u30c3\u30c9\u304c\u4f7f\u308f\u308c\u308b\u3002\n            asyncContext.dispatch(dispatchPath);\n\n            Console.println(\"End Async processing.\");\n        });\n\n        // \u975e\u540c\u671f\u51e6\u7406\u3092\u8d77\u52d5\u3057\u305f\u5f8c\u306b\u3001\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u53d7\u3051\u53d6\u3063\u305f\u30b9\u30ec\u30c3\u30c9\u306e\u51e6\u7406\u3092\u7d42\u4e86\u3057\u3001\u30b9\u30ec\u30c3\u30c9\u30d7\u30fc\u30eb\u306b\u623b\u3059\u3002\n        // \u540c\u671f\u30ea\u30af\u30a8\u30b9\u30c8\u3060\u3068HTTP\u30ec\u30b9\u30dd\u30f3\u30b9\u304c\u5b8c\u4e86\u3057\u3066\u3057\u307e\u3046\u304c\u3001\u975e\u540c\u671f\u30ea\u30af\u30a8\u30b9\u30c8\u3060\u3068\u30e1\u30bd\u30c3\u30c9\u3092\u629c\u3051\u3066\u3082HTTP\u30ec\u30b9\u30dd\u30f3\u30b9\u306f\u884c\u308f\u308c\u306a\u3044\uff08\u6b63\u78ba\u306b\u306f\u5b8c\u4e86\u3057\u306a\u3044\uff09\u3002\n        Console.println(\"End doGet.\");\n    }\n\n    private void heavyProcessing(long waitSec, HttpServletRequest request) {\n\n        if (waitSec == 999) {\n            throw new IllegalStateException(\"Special parameter for confirm error.\");\n        }\n\n        try {\n            TimeUnit.SECONDS.sleep(waitSec);\n        } catch (InterruptedException e) {\n            Thread.interrupted();\n        }\n\n        request.setAttribute(\"completedTime\", LocalDateTime.now());\n\n    }\n\n}\n```\n\n`web.xml` \u3060\u3068\u30fb\u30fb\u30fb\n\n```xml:src/main/webapp/WEB-INF/web.xml\n<servlet>\n    <servlet-name>AsyncServlet</servlet-name>\n    <servlet-class>com.example.component.AsyncServlet</servlet-class>\n    <async-supported>true</async-supported> <!-- true\u3092\u6307\u5b9a\u3057\u3066\u975e\u540c\u671f\u3092\u30b5\u30dd\u30fc\u30c8\u3059\u308b -->\n</servlet>\n<!-- ... -->\n```\n\n\ncURL\u3084\u30d6\u30e9\u30a6\u30b6\u3092\u4f7f\u3063\u3066\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\n```bash\n$ curl -D - http://localhost:8080/async?waitSec=1\n```\n```text:HTTP\u30ec\u30b9\u30dd\u30f3\u30b9\nHTTP/1.1 200 OK\nServer: Apache-Coyote/1.1\nSet-Cookie: JSESSIONID=62614119E151341D5A7179699731E8DF; Path=/; HttpOnly\nContent-Type: text/html;charset=ISO-8859-1\nContent-Length: 201\nDate: Sun, 15 May 2016 13:26:54 GMT\n\n<html>\n<body>\n<h2>Processing is complete !</h2>\n<p>Accept timestamp is 2016-05-15T22:26:53.205</p>\n<p>Complete timestamp is 2016-05-15T22:26:54.208</p>\n<p><a href=\"/\">Go to Top</a></p>\n</body>\n</html>\n```\n\n\u3042\u308c\u3042\u308c\u30fb\u30fb\u30fbHTTP\u30ec\u30b9\u30dd\u30f3\u30b9\u3092\u898b\u308b\u3060\u3051\u3060\u3068\u3001\u540c\u671f\u578b\u3068\u4e00\u7dd2\u3067\u3059\u306d\u30fb\u30fb\u30fb\u30fb\u3002\u30b5\u30fc\u30d0\u30fc\u5074\u306e\u30ed\u30b0\u3082\u898b\u3066\u307f\u307e\u3057\u3087\u3046\uff01\uff01\n\n```text:\u30b3\u30f3\u30bd\u30fc\u30eb\n2016-05-15T22:26:53.204 Thread[http-nio-8080-exec-8,5,main]: Start doGet.\n2016-05-15T22:26:53.205 Thread[http-nio-8080-exec-8,5,main]: End doGet.\n2016-05-15T22:26:53.205 Thread[http-nio-8080-exec-9,5,main]: Start Async processing.\n2016-05-15T22:26:54.209 Thread[http-nio-8080-exec-9,5,main]: End Async processing.\n2016-05-15T22:26:54.211 Thread[http-nio-8080-exec-10,5,main]: Called complete.jsp\n2016-05-15T22:26:54.211 Thread[http-nio-8080-exec-10,5,main]: ASYNC\n```\n\nHTTP\u30ec\u30b9\u30dd\u30f3\u30b9\u306e\u7d50\u679c\u306f\u4e00\u7dd2\u3067\u3059\u304c\u3001\u30b5\u30fc\u30d0\u30fc\u5074\u306e\u51e6\u7406\u306f\uff13\u3064\u306e\u30b9\u30ec\u30c3\u30c9\u306b\u308f\u304b\u308c\u3066\u51e6\u7406\u304c\u884c\u308f\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3059\u3002\u305f\u3076\u3093\u30c6\u30ad\u30b9\u30c8\u3060\u3051\u3060\u3068\u4f1d\u308f\u308a\u305a\u3089\u3044\u3068\u601d\u3046\u306e\u3067\u3001\u52d5\u304d\u3092\u7d75\u3067\u3042\u308f\u3089\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\n![servlet-async-example.png](https://qiita-image-store.s3.amazonaws.com/0/117313/a7a3f863-292b-b733-f6e3-f3a70ed76804.png)\n\n\u3060\u3044\u3060\u3044\u3053\u3093\u306a\u611f\u3058\u3067\u52d5\u3044\u3066\u3044\u307e\u3059\u3002\n\u3078\u301c\u3068\u3044\u3046\u611f\u3058\u3067\u306f\u3042\u308a\u307e\u3059\u304c\u3001\u3053\u308c\u3060\u3068\u975e\u540c\u671f\u306b\u3059\u308b\u610f\u5473\u3042\u308b\u306e\uff1f\u540c\u671f\u578b\u3068\u4f55\u304c\u9055\u3046\u306e\uff1f\u5358\u306b\u8907\u96d1\u306b\u306a\u308b\u3060\u3051\u3058\u3083\u3093\u30fb\u30fb\u30fb\u3068\u601d\u3063\u3061\u3083\u3044\u307e\u3059\u3088\u306d\uff01\uff1f\n\u305d\u3046\u306a\u3093\u3067\u3059\u30fb\u30fb\u30fb\u975e\u540c\u671f\u51e6\u7406(\u4e3b\u306b\u91cd\u305f\u3044\u51e6\u7406\u3001\u9577\u3044\u9593\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3068\u306e\u63a5\u7d9a\u3092\u7dad\u6301\u3057\u305f\u3044\u51e6\u7406\u306a\u3069)\u3092\u884c\u3046\u30b9\u30ec\u30c3\u30c9\uff08\u4e0a\u306e\u7d75\u3060\u3068\u3001\u300chttp-nio-8080-exec-9\u300d\u306e\u30b9\u30ec\u30c3\u30c9\uff09\u3092\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d0\u30fc\u304c\u30ea\u30af\u30a8\u30b9\u30c8\u51e6\u7406\u3092\u884c\u3046\u305f\u3081\u306b\u7528\u610f\u3057\u3066\u3044\u308b\u30b9\u30ec\u30c3\u30c9\u3092\u4f7f\u3063\u3066\u3057\u307e\u3046\u3068\u3001\u975e\u540c\u671f\u306b\u3059\u308b\u610f\u5473\u304c\u306a\u3044\u306e\u3067\u3059\u30fb\u30fb\u30fb\u3002\n\u79c1\u306e\u8db3\u308a\u3066\u3044\u306a\u3044\u304b\u3082\u3057\u308c\u306a\u3044\u8a8d\u8b58\u3067\u306f\u30fb\u30fb\u30fb\n\u975e\u540c\u671f\u51e6\u7406\u306f\u300c\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d0\u30fc\u304c\u30ea\u30af\u30a8\u30b9\u30c8\u51e6\u7406\u3092\u884c\u3046\u305f\u3081\u306b\u7528\u610f\u3057\u3066\u3044\u308b\u30b9\u30ec\u30c3\u30c9\u300d\u3067\u306f\u306a\u304f\u300c\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u304c\u7528\u610f\u3059\u308b\u30b9\u30ec\u30c3\u30c9\uff08\u30b9\u30ec\u30c3\u30c9\u30d7\u30fc\u30eb\u304b\u3089\u53d6\u5f97\u3057\u305f\u30b9\u30ec\u30c3\u30c9\uff09\u300d\u3092\u4f7f\u3046\u3053\u3068\u3067\u3001\u975e\u540c\u671f\u51e6\u7406\u3092\u5b9f\u884c\u3057\u3066\u3044\u308b\u6700\u4e2d\u3067\u3082\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d0\u30fc\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u53d7\u4ed8\u3092\u30d6\u30ed\u30c3\u30af\u3055\u305b\u306a\u3044\u305f\u3081\u306e\u6a5f\u80fd\u3060\u3068\u601d\u3063\u3066\u3044\u307e\u3059\u3002\uff08**\u3053\u3053\u306f\u79c1\u306e\u8a8d\u8b58\u4e0d\u8db3\u306a\u3060\u3051\u306e\u53ef\u80fd\u6027\u3042\u308a** :sweat_smile: \uff09\n\n\u79c1\u306e\u8a8d\u8b58\u3092\u7d75\u306b\u53cd\u6620\u3059\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d0\u30fc\u7ba1\u7406\u306e\u30b9\u30ec\u30c3\u30c9\u306f\u3001\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u53d7\u4ed8\u3068\u30ec\u30b9\u30dd\u30f3\u30b9\u30c7\u30fc\u30bf\u306e\u751f\u6210\u3068\u3044\u3046\u6bd4\u8f03\u7684\u8efd\u3044\u51e6\u7406\u306b\u5c02\u5ff5\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n![servlet-async-example-using-app-managed-thread.png](https://qiita-image-store.s3.amazonaws.com/0/117313/2f96c7ff-3a05-a5dd-731b-8d2b4eb69505.png)\n\n# \u30a2\u30d7\u30ea\u7ba1\u7406\u306e\u30b9\u30ec\u30c3\u30c9\u3092\u4f7f\u7528\u3057\u305f\u975e\u540c\u671f\u5b9f\u88c5\u306b\u3057\u3066\u307f\u308b\n\n\u975e\u540c\u671f\u51e6\u7406\u306e\u5b9f\u884c\u3092`ExecutorService`\u7d4c\u7531\u3067\u5b9f\u884c\u3059\u308b\u3088\u3046\u306b\u5909\u66f4\u3057\u307e\u3057\u3087\u3046\u3002\n\u307e\u305a\u3001`init`\u3068`destory`\u30e1\u30bd\u30c3\u30c9\u3092\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3057\u3001\u6307\u5b9a\u3057\u305f\u6570\u306e\u30b9\u30ec\u30c3\u30c9\u30d7\u30fc\u30eb\u3092\u3082\u3064`ExecutorService`\u306e\u751f\u6210\u30fb\u7834\u68c4\u3092\u884c\u3044\u307e\u3059\u3002\n\n```java:src/main/java/com/example/component/AsyncServlet.java\n@WebServlet(urlPatterns = \"/async\", asyncSupported = true)\npublic class AsyncServlet extends HttpServlet {\n\n    private ExecutorService executorService;\n\n    // ExecutorService\u3092\u751f\u6210\u3059\u308b\n    @Override\n    public void init() throws ServletException {\n        this.executorService = Executors.newFixedThreadPool(10);\n    }\n\n    // ExecutorService\u3092\u505c\u6b62\u3059\u308b\n    @Override\n    public void destroy() {\n        try {\n            executorService.shutdown();\n            executorService.awaitTermination(60, TimeUnit.SECONDS);\n        } catch (InterruptedException e) {\n            Thread.interrupted();\n        }\n    }\n    ...\n}\n```\n\n\u6b21\u306b\u3001`AsyncContext#start()`\u3068\u3057\u3066\u3044\u305f\u90e8\u5206\u3092`ExecutorService`\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u4f7f\u7528\u3059\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\n```java\nexecutorService.execute(() -> { // ExecutorService\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u4f7f\u3063\u3066\u5225\u30b9\u30ec\u30c3\u30c9\u3067\u51e6\u7406\u3092\u884c\u3046\n    // ...\n});\n```\n\n\u30b5\u30fc\u30d6\u30ec\u30c3\u30c8\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001\u30ed\u30b0\u304c\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u3001\u975e\u540c\u671f\u51e6\u7406\u304c\u30a2\u30d7\u30ea\u7ba1\u7406\u306e\u30b9\u30ec\u30c3\u30c9\u4e0a\u3067\u52d5\u3044\u3066\u3044\u308b\u306e\u304c\u308f\u304b\u308a\u307e\u3059\u3002\n\n```text:\u30b3\u30f3\u30bd\u30fc\u30eb\n2016-05-16T00:07:47.021 Thread[http-nio-8080-exec-5,5,main]: End doGet.\n2016-05-16T00:07:47.021 Thread[pool-1-thread-1,5,main]: Start Async processing.\n2016-05-16T00:07:48.026 Thread[pool-1-thread-1,5,main]: End Async processing.\n2016-05-16T00:07:48.079 Thread[http-nio-8080-exec-6,5,main]: Called complete.jsp\n2016-05-16T00:07:48.079 Thread[http-nio-8080-exec-6,5,main]: ASYNC\n```\n\n# \u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u306e\u6307\u5b9a\n\n\u975e\u540c\u671f\u51e6\u7406\u306b\u306f\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3092\u8a2d\u3051\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\u30c7\u30d5\u30a9\u30eb\u30c8\u306f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d0\u30fc\u306e\u8a2d\u5b9a\u306b\u4f9d\u5b58\u3057\u307e\u3059\u304c\u3001\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u5074\u3067\u660e\u793a\u7684\u306b\u3057\u3066\u3044\u308b\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n\n```java\n...\nAsyncContext asyncContext = request.startAsync(request, response);\nasyncContext.setTimeout(3000); // \u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u6642\u9593(\u30df\u30ea\u79d2\u5358\u4f4d)\u3092\u6307\u5b9a\u3059\u308b\u30020\u3092\u6307\u5b9a\u3059\u308b\u3068\u7121\u5236\u9650\u3002\n...\n```\n\n# \u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u306e\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\n\n\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u6642\u9593\u3092\u8d85\u3048\u3066\u3082\u975e\u540c\u671f\u51e6\u7406\u304c\u7d42\u308f\u3089\u306a\u3044\u5834\u5408\u306f\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u3060\u3068500(Internal Server Error)\u306b\u306a\u308a\u307e\u3059\u3002\n\n```bash\n$ curl -D - http://localhost:8080/async?waitSec=4\n```\n\n```text:HTTP\u30ec\u30b9\u30dd\u30f3\u30b9\nHTTP/1.1 500 Internal Server Error\nServer: Apache-Coyote/1.1\nContent-Type: text/html;charset=utf-8\nContent-Language: ja\nContent-Length: 1065\nDate: Sun, 15 May 2016 15:44:23 GMT\nConnection: close\n\n...\n```\n\n\u307e\u305f\u3001\u30b5\u30fc\u30d0\u30fc\u5074\u306e\u30b3\u30f3\u30bd\u30fc\u30eb\u30ed\u30b0\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n```text\n2016-05-16T00:54:26.771 Thread[http-nio-8080-exec-8,5,main]: Start doGet.\n2016-05-16T00:54:26.771 Thread[http-nio-8080-exec-8,5,main]: End doGet.\n2016-05-16T00:54:26.771 Thread[pool-1-thread-3,5,main]: Start Async processing.\nException in thread \"pool-1-thread-3\" java.lang.IllegalStateException: The request associated with the AsyncContext has already completed processing.\n\tat org.apache.catalina.core.AsyncContextImpl.check(AsyncContextImpl.java:536)\n\tat org.apache.catalina.core.AsyncContextImpl.dispatch(AsyncContextImpl.java:186)\n\tat com.example.component.AsyncServlet.lambda$doGet$0(AsyncServlet.java:64)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n\tat java.lang.Thread.run(Thread.java:745)\n```\n\n\u3053\u3053\u3067\u610f\u8b58\u3057\u3066\u307b\u3057\u3044\u306e\u306f\u3001**\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u5f8c\u3082\u975e\u540c\u671f\u51e6\u7406\u81ea\u4f53\u306f\u5b9f\u884c\u3055\u308c\u7d9a\u3051\u308b**\u3068\u3044\u3046\u70b9\u3067\u3059\u3002\u4eca\u56de\u306e\u30b1\u30fc\u30b9\u3060\u3068\u3001\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u5f8c\u306b`AsyncContext#dispatch`\u30e1\u30bd\u30c3\u30c9\u304c\u547c\u3073\u51fa\u3055\u308c\u3001\u7d50\u679c\u3068\u3057\u3066\u30a8\u30e9\u30fc\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n> **Note: \u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u5f8c\u306e\u975e\u540c\u671f\u51e6\u7406\u5185\u3067\u306e\u30a8\u30e9\u30fc\u306e\u56de\u907f\u65b9\u6cd5\u306b\u3064\u3044\u3066**\n> \u3044\u307e\u3044\u3061\u4f55\u304c\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9\u306a\u306e\u304b\u308f\u304b\u3063\u3066\u3044\u307e\u305b\u3093\u30fb\u30fb\u30fb :sweat_smile: [IBM\u306e\u30da\u30fc\u30b8](http://www.ibm.com/support/knowledgecenter/SSAW57_8.5.5/com.ibm.websphere.nd.doc/ae/cweb_asyncservlet.html?lang=ja)\u306b\u306f\u3001`AtomicBoolean`\u3092\u4f7f\u3063\u3066\u56de\u907f\u3059\u308b\u65b9\u6cd5\u304c\u7d39\u4ecb\u3055\u308c\u3066\u3044\u307e\u3057\u305f\u304c\u3001\u3053\u308c\u3067\u672c\u5f53\u306b\u89e3\u6c7a\u3055\u308c\u308b\u306e\u304b\u7591\u554f\u30fb\u30fb\u30fb\u3002\u8ab0\u304b\u30d8\u30eb\u30d7\u30df\u30fc\u301c\u3002Spring\u304c\u3053\u306e\u3042\u305f\u308a\u3092\u3069\u3046\u6271\u3063\u3066\u3044\u308b\u306e\u304b\u8abf\u3079\u3066\u307f\u307e\u3059\u3002\n> \n> \u30102016/5/22\u3011\n> Spring MVC\u3067\u3082\u3001\u30ea\u30af\u30a8\u30b9\u30c8\u30b9\u30b3\u30fc\u30d7\u3067`AtomicBoolean`\u306a\u5909\u6570\u3092\u5171\u6709\u3057\u3066\u591a\u91cddispatch\u3092\u9632\u3044\u3067\u3044\u307e\u3057\u305f\u3002\u306a\u304a\u3001Spring MVC\u3092\u4f7f\u7528\u3057\u305f\u975e\u540c\u671f\u51e6\u7406\u306b\u3064\u3044\u3066\u306f\u3001\u300c[Spring MVC(+Spring Boot)\u4e0a\u3067\u306e\u975e\u540c\u671f\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u7406\u89e3\u3059\u308b -\u524d\u7de8-](http://qiita.com/kazuki43zoo/items/ce88dea403c596249e8a)\u300d\u3092\u3054\u89a7\u304f\u3060\u3055\u3044\u3002\n\n## \u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u30a8\u30e9\u30fc\u753b\u9762\u3078\u9077\u79fb\u3055\u305b\u308b\n\n\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u305f\u5834\u5408\u306f\u3001500(Internal Server Error)\u3067\u306f\u306a\u304f\u5c02\u7528\u306e\u30a8\u30e9\u30fc\u753b\u9762\u306a\u3069\u306b\u9077\u79fb\u3055\u305b\u305f\u3044\u306e\u3067\u306f\u306a\u3044\u3067\u3057\u3087\u3046\u304b\u3002\u3053\u3053\u3067\u306f\u3001\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u30a8\u30e9\u30fc\u7528\u306eJSP\u306b\u30c7\u30a3\u30b9\u30d1\u30c3\u30c1\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u307e\u305a\u3001\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u30a8\u30e9\u30fc\u753b\u9762\u7528\u306eJSP\u3092\u4f5c\u308a\u307e\u3059\u3002\n\n```jsp:src/main/webapp/timeout.jsp\n<%@ page import=\"com.example.component.Console\" trimDirectiveWhitespaces=\"true\" %>\n<% Console.println(\"Called timeout.jsp\"); %>\n<% Console.println(request.getDispatcherType()); %>\n\n<html>\n<body>\n<h2>Timeout!</h2>\n<p><a href=\"${pageContext.request.contextPath}/\">Go to Top</a></p>\n</body>\n</html>\n```\n\n\u6b21\u306b\u3001`javax.servlet.AsyncListener`\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u3092\u5b9f\u88c5\u3057\u3001`onTimeout`\u30e1\u30bd\u30c3\u30c9\u306b\u30a8\u30e9\u30fc\u51e6\u7406(`timeout.jsp`\u3078\u306e\u30c7\u30a3\u30b9\u30d1\u30c3\u30c1\u51e6\u7406)\u3092\u5b9f\u88c5\u3057\u307e\u3059\u3002\n\n```java\n@WebServlet(urlPatterns = \"/async\", asyncSupported = true)\npublic class AsyncServlet extends HttpServlet implements AsyncListener {\n    // ...\n    @Override\n    public void onComplete(AsyncEvent event) throws IOException {\n        Console.println(\"onComplete:\" + event);\n    }\n\n    @Override\n    public void onTimeout(AsyncEvent event) throws IOException {\n        Console.println(\"onTimeout:\" + event);\n        event.getAsyncContext().dispatch(\"/timeout.jsp\"); // timeout.jsp\u3078\u30c7\u30a3\u30b9\u30d1\u30c3\u30c1\u3059\u308b\n    }\n\n    @Override\n    public void onError(AsyncEvent event) throws IOException {\n        Console.println(\"onError:\" + event);\n    }\n\n    @Override\n    public void onStartAsync(AsyncEvent event) throws IOException {\n        Console.println(\"onStartAsync:\" + event);\n    }\n}\n```\n\n```bash\n$ curl -D - http://localhost:8080/async?waitSec=4\n```\n\n```text:HTTP\u30ec\u30b9\u30dd\u30f3\u30b9\nHTTP/1.1 200 OK\nServer: Apache-Coyote/1.1\nSet-Cookie: JSESSIONID=6696B7A54D07D3300658115D8ED093D8; Path=/; HttpOnly\nContent-Type: text/html;charset=ISO-8859-1\nContent-Length: 81\nDate: Sun, 15 May 2016 16:22:47 GMT\n\n<html>\n<body>\n<h2>Timeout!</h2>\n<p><a href=\"/\">Go to Top</a></p>\n</body>\n</html>\n```\n\n\u30b5\u30fc\u30d0\u30fc\u5074\u306e\u30b3\u30f3\u30bd\u30fc\u30eb\u30ed\u30b0\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n```text:\u30b3\u30f3\u30bd\u30fc\u30eb\n2016-05-16T01:23:23.488 Thread[http-nio-8080-exec-2,5,main]: Start doGet.\n2016-05-16T01:23:23.488 Thread[http-nio-8080-exec-2,5,main]: End doGet.\n2016-05-16T01:23:23.488 Thread[pool-1-thread-5,5,main]: Start Async processing.\n2016-05-16T01:23:26.496 Thread[http-nio-8080-exec-3,5,main]: onTimeout:javax.servlet.AsyncEvent@339e5a11\n2016-05-16T01:23:26.498 Thread[http-nio-8080-exec-3,5,main]: Called timeout.jsp\n2016-05-16T01:23:26.498 Thread[http-nio-8080-exec-3,5,main]: ASYNC\n2016-05-16T01:23:26.498 Thread[http-nio-8080-exec-3,5,main]: onComplete:javax.servlet.AsyncEvent@339e5a11\n...\n```\n\n# \u975e\u540c\u671f\u51e6\u7406\u7d42\u4e86\u5f8c\u306e\u632f\u308b\u821e\u3044\n\n\u672c\u6295\u7a3f\u3067\u6271\u3063\u305f\u30b5\u30f3\u30d7\u30eb\u3067\u306f\u3001\u975e\u540c\u671f\u51e6\u7406\u304c\u7d42\u4e86\u3057\u305f\u5f8c\u306b\u6307\u5b9a\u3057\u305f\u30d1\u30b9\u306b\u30c7\u30a3\u30b9\u30d1\u30c3\u30c1\u3059\u308b\u65b9\u5f0f\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u304c\u3001\u30c7\u30a3\u30b9\u30d1\u30c3\u30c1\u305b\u305a\u306b\u3059\u3050\u306b\u5b8c\u4e86\u3055\u305b\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n\n| \u30e1\u30bd\u30c3\u30c9 | \u8aac\u660e |\n| ------- | ---- |\n| `dispatch` | \u3053\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u547c\u3073\u51fa\u3059\u3068\u3001\u30b5\u30fc\u30d6\u30ec\u30c3\u30c8\u30b3\u30f3\u30c6\u30ca\u306f\u6307\u5b9a\u3055\u308c\u305f\u30d1\u30b9\u3078\u30c7\u30a3\u30b9\u30d1\u30c3\u30c1\u3057\u307e\u3059\u3002(\u30b5\u30f3\u30d7\u30eb\u3067\u306f\u3053\u3061\u3089\u306e\u65b9\u6cd5\u3092\u4f7f\u3063\u3066\u3044\u307e\u3059) |\n| `complete` | \u3053\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u547c\u3073\u51fa\u3059\u3068\u3001\u30b5\u30fc\u30d6\u30ec\u30c3\u30c8\u30b3\u30f3\u30c6\u30ca\u306fHTTP\u30ec\u30b9\u30dd\u30f3\u30b9\u3092\u5b8c\u4e86\u3057\u307e\u3059\u3002\u3053\u306e\u30e1\u30bd\u30c3\u30c9\u306f\u3001\u3053\u306e\u5f8c\u7d39\u4ecb\u3059\u308b\u300c\u5206\u5272\u30ec\u30b9\u30dd\u30f3\u30b9\u300d\u6642\u3068\u4e00\u7dd2\u306b\u4f7f\u3046\u3053\u3068\u304c\u591a\u3044\u3068\u601d\u308f\u308c\u307e\u3059\u3002 |\n\n# \u30ec\u30b9\u30dd\u30f3\u30b9\u65b9\u6cd5\n\n\u672c\u6295\u7a3f\u3067\u6271\u3063\u305f\u30b5\u30f3\u30d7\u30eb\u3067\u306f\u3001\u30c7\u30a3\u30b9\u30d1\u30c3\u30c1\u5f8c\u306b\u307e\u3068\u3081\u3066\u30ec\u30b9\u30dd\u30f3\u30b9\u3092\u8fd4\u5374\u3057\u3066\u3044\u307e\u3059\u304c\u3001\u975e\u540c\u671f\u51e6\u7406\u4e2d\u306b\u5206\u5272\u3057\u3066\u30ec\u30b9\u30dd\u30f3\u30b9\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n\n| \u65b9\u6cd5 | \u8aac\u660e |\n| --- | ---- |\n| \u4e00\u62ec | \u30c7\u30a3\u30b9\u30d1\u30c3\u30c1\u5f8c\u306e\u51e6\u7406\u3067\u4e00\u62ec\u3067\u30ec\u30b9\u30dd\u30f3\u30b9\u3057\u307e\u3059\u3002\u672c\u6295\u7a3f\u306e\u30b5\u30f3\u30d7\u30eb\u5b9f\u88c5\u306f\u3001\u3053\u306e\u65b9\u5f0f\u3067\u306e\u5b9f\u88c5\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002 |\n| \u5206\u5272 | \u975e\u540c\u671f\u51e6\u7406\u3092\u958b\u59cb\u3059\u308b\u524d\u306b\u30ec\u30b9\u30dd\u30f3\u30b9\u3092\u3044\u3063\u305f\u3093\u30d5\u30e9\u30c3\u30b7\u30e5\u3059\u308b\u3053\u3068\u3067\u3001\u5206\u5272\u30ec\u30b9\u30dd\u30f3\u30b9(Transfer-Encoding: chunked)\u3068\u306a\u308b\u3053\u3068\u3092\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3078\u901a\u77e5\u3057\u3001\u4ee5\u964d\u306f\u4efb\u610f\u306e\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u30c7\u30fc\u30bf\u3092\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3078\u9001\u4fe1(Push)\u3057\u307e\u3059\u3002 \u3053\u306e\u65b9\u6cd5\u306f\u3001HTTP Streaming\u3092\u5b9f\u73fe\u3059\u308b\u969b\u306b\u3082\u4f7f\u7528\u3067\u304d\u307e\u3059\u3002 |\n\n\u5206\u5272\u30ec\u30b9\u30dd\u30f3\u30b9\u65b9\u5f0f\u306e\u5229\u7528\u30a4\u30e1\u30fc\u30b8\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\n\n![servlet-async-chunked.png](https://qiita-image-store.s3.amazonaws.com/0/117313/1c698027-b36d-5943-0e4b-77c15f15eef4.png)\n\n\n# \u975e\u540c\u671f\u30ea\u30af\u30a8\u30b9\u30c8\u7528\u306e\u30a4\u30d9\u30f3\u30c8\u30ea\u30b9\u30ca\u30fc\n\n\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u306e\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u306e\u3068\u3053\u308d\u3067`onTimeout`\u30e1\u30bd\u30c3\u30c9\u3092\u5b9f\u88c5\u3057\u307e\u3057\u305f\u304c\u3001`onTimeout`\u30e1\u30bd\u30c3\u30c9\u4ee5\u5916\u306b\u3082\u3044\u304f\u3064\u304b\u306e\u30e1\u30bd\u30c3\u30c9\u304c\u63d0\u4f9b\u3055\u308c\u3066\u3044\u307e\u3059\u3002\uff08\u8aac\u660e\u306f\u9593\u9055\u3063\u3066\u3044\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u30fb\u30fb\u30fb\uff09\n\n| \u30e1\u30bd\u30c3\u30c9 | \u8aac\u660e |\n| ------ | ---- |\n| `onComplete` | \u975e\u540c\u671f\u30ea\u30af\u30a8\u30b9\u30c8(dispatch\u5f8c\u306e\u51e6\u7406)\u304c\u5b8c\u4e86\u3057\u305f\u6642\u306b\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3055\u308c\u308b\u3002 |\n| `onTimeout` | \u30b5\u30fc\u30d6\u30ec\u30c3\u30c8\u30b3\u30f3\u30c6\u30ca\u304c\u975e\u540c\u671f\u51e6\u7406\u306e\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3092\u691c\u77e5\u3057\u305f\u6642\u306b\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3055\u308c\u308b\u3002 |\n| `onError` | \u975e\u540c\u671f\u30ea\u30af\u30a8\u30b9\u30c8(dispatch\u5f8c\u306e\u51e6\u7406)\u3067\u30b5\u30fc\u30d6\u30ec\u30c3\u30c8\u30b3\u30f3\u30c6\u30ca\u306b\u901a\u77e5\u3055\u308c\u308b\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u305f\u6642\u306b\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3055\u308c\u308b\u3002\uff08\u305f\u3076\u3093\u30fb\u30fb\u30fb\uff09 |\n| `onStartAsync` | \u975e\u540c\u671f\u30ea\u30af\u30a8\u30b9\u30c8(dispatch\u5f8c\u306e\u51e6\u7406)\u4e2d\u306b\u3001\u65b0\u305f\u306b\u5225\u306e\u975e\u540c\u671f\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u958b\u59cb\u3055\u308c\u305f\u6642\u306b\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3055\u308c\u308b\u3002\uff08\u305f\u3076\u3093\u30fb\u30fb\u30fb\uff09 |\n\n# \u30b5\u30fc\u30d6\u30ec\u30c3\u30c8\u30d5\u30a3\u30eb\u30bf\u30fc\u306e\u632f\u308b\u821e\u3044\n\nServlet\u6a19\u6e96\u306e\u975e\u540c\u671f\u51e6\u7406\u3092\u5229\u7528\u3059\u308b\u5834\u5408\u306f\u3001Servlet\u306b\u52a0\u3048\u3066Filter\u3082\u975e\u540c\u671f\u51e6\u7406\u306b\u30b5\u30dd\u30fc\u30c8\u3055\u305b\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u3072\u3068\u3064\u3067\u3082\u975e\u540c\u671f\u306b\u5bfe\u5fdc\u3057\u3066\u3044\u306a\u3044Filter\u304c\u3042\u308b\u3068\u30a8\u30e9\u30fc\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\n```java\n@WebFilter(urlPatterns = \"/*\", asyncSupported = true) // asyncSupported\u5c5e\u6027\u3092true\u306b\u3057\u3001\u975e\u540c\u671f\u51e6\u7406\u3092\u6271\u3048\u308b\u3088\u3046\u306b\u3059\u308b\npublic class CustomFilter implements Filter {\n    @Override\n    public void init(FilterConfig filterConfig) throws ServletException {\n    }\n    @Override\n    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {\n        chain.doFilter(request, response);\n    }\n    @Override\n    public void destroy() {\n    }\n}\n```\n\n`web.xml` \u3060\u3068\u30fb\u30fb\u30fb\n\n```xml:src/main/webapp/WEB-INF/web.xml\n<filter>\n    <filter-name>CustomFilter</filter-name>\n    <filter-class>com.example.component.CustomFilter</filter-class>\n    <async-supported>true</async-supported> <!-- true\u3092\u6307\u5b9a\u3057\u3066\u975e\u540c\u671f\u3092\u30b5\u30dd\u30fc\u30c8\u3059\u308b -->\n</filter>\n<!-- ... -->\n```\n\n\u307e\u305f\u3001\u975e\u540c\u671f\u51e6\u7406\u7d42\u4e86\u5f8c\u306e\u30c7\u30a3\u30b9\u30d1\u30c3\u30c1\u306b\u30b5\u30fc\u30d6\u30ec\u30c3\u30c8\u30d5\u30a3\u30eb\u30bf\u30fc\u3092\u9069\u7528\u3057\u305f\u3044\u5834\u5408\u306f\u3001`DispatcherType`\u3068\u3057\u3066`ASYNC`\u3092\u6307\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n```java\n@WebFilter(urlPatterns = \"/*\", asyncSupported = true, dispatcherTypes = DispatcherType.ASYNC) // dispatcherTypes\u5c5e\u6027\u306bASYNC\u3092\u6307\u5b9a\u3057\u3001\u975e\u540c\u671f\u51e6\u7406\u3092\u9069\u7528\u5bfe\u8c61\u306b\u3059\u308b\npublic class CustomFilter implements Filter {\n    // ...\n}\n```\n\n`web.xml` \u3060\u3068\u30fb\u30fb\u30fb\n\n```xml:src/main/webapp/WEB-INF/web.xml\n<!-- ... -->\n<filter-mapping>\n    <filter-name>CustomFilter</filter-name>\n    <url-pattern>/*</url-pattern>\n    <dispatcher>ASYNC</dispatcher> <!-- dispatcher\u30bf\u30b0\u306bASYNC\u3092\u6307\u5b9a -->\n</filter-mapping>\n```\n\n# \u307e\u3068\u3081\n\n\u4eca\u56de\u306f\u3001\u5f8c\u65e5\u6295\u7a3f\u4e88\u5b9a\u306e\u300cSpring MVC(+Spring Boot)\u4e0a\u3067\u306eServlet\u6a19\u6e96\u306e\u975e\u540c\u671f\u51e6\u7406\u3092\u7406\u89e3\u3059\u308b\u300d\u306e\u524d\u63d0\u3068\u306a\u308b\u77e5\u8b58\u3092\u4e8b\u524d\u306b\u7d39\u4ecb\u3057\u3066\u304a\u304d\u307e\u3057\u305f\u3002\u79c1\u3082\u307b\u307c\u521d\u3081\u3066\u4f7f\u3046\u306e\u3067\u3001\u9593\u9055\u3063\u305f\u3053\u3068\u3092\u66f8\u3044\u3066\u3044\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\uff08\u6709\u8b58\u8005\u306e\u65b9\u306f\u662f\u975e\u30b3\u30e1\u30f3\u30c8\u3092 :wink: \uff09\n\n# \u53c2\u8003\u30b5\u30a4\u30c8\n\n* http://www.cresc.co.jp/tech/java/Servlet_Specifications/Servlet_Specification_3_0_Japanese.pdf\n* http://www.ibm.com/support/knowledgecenter/SSAW57_8.5.5/com.ibm.websphere.nd.doc/ae/cweb_asyncservlet.html?lang=ja\n", "tags": ["Java", "JavaEE", "servlet", "async"]}