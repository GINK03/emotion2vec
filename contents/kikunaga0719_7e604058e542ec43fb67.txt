{"context": " More than 1 year has passed since last update.\n\n\u4f7f\u3063\u305f\u3082\u306e\n\nFluentd(td-agent)\nMongoDB\nCentOS\nRuby\n\n\n\u69cb\u6210\n+-------+--------+                        +--------------------+\n|WEB Server      |                        |MongoDB(Replica set)|\n|                |                        |                    |\n|  +-----------+ |                        |  +--------------+  |\n|  |Ruby(Rails)| |                        |  |Master        |  |\n|  ++----------+ |                        |  +--------------+  |\n|   |            |                        |  +--------------+  |\n|   |  +-------+ |   +----------------+   |  |Slave         |  |\n|   +--+Fluentd+-----+ Fluentd Server +---+  +--------------+  |\n|      +-------+ |   +----------------+   |  +--------------+  |\n|                |                        |  |Slave         |  |\n+----------------+                        |  +--------------+  |\n                                          |  +--------------+  |\n                                          |  |Arbiter       |  |\n                                          |  +--------------+  |\n                                          |                    |\n                                          +--------------------+\n\n\nWeb\u30b5\u30fc\u30d0\u306f\u30b9\u30b1\u30fc\u30eb\u3092\u60f3\u5b9a\u3057\u3001\u6700\u7d42\u7684\u306b\u306fPassenger\u3067Rails\u30a2\u30d7\u30ea\u3092\u7a3c\u52d5\u3055\u305b\u308b\nRuby(Rails)\u30a2\u30d7\u30ea\u304b\u3089\u30ed\u30fc\u30ab\u30eb\u306eFluentd\u306b\u6e21\u3057Forward\u3059\u308b\n\u2191\u4e2d\u592e\u306eFluentd\u30b5\u30fc\u30d0\u304c\u843d\u3061\u305f/\u843d\u3068\u3057\u305f\u3068\u304d\u306e\u30d0\u30c3\u30d5\u30a1\u3092\u671f\u5f85\nFluentd\u30b5\u30fc\u30d0\u3067\u306fWeb\u30b5\u30fc\u30d0\u304b\u3089Forward\u3055\u308c\u3066\u304d\u305f\u30c7\u30fc\u30bf\u3092MongoDB\u306b\u66f8\u304d\u8fbc\u3080\n\u2191MongoDB\u304c\u843d\u3061\u305f/\u843d\u3068\u3057\u305f\u3068\u304d\u306e\u30d0\u30c3\u30d5\u30a1\u3092\u671f\u5f85\n\u2191\u4e2d\u592e\u306eFluentd\u30b5\u30fc\u30d0\u306f\u73fe\u72b6\u306f\u5358\u6a5f\u80fd\u3060\u304c\u5f8c\u3005\u3001\u6d41\u308c\u3066\u304f\u308b\u30c7\u30fc\u30bf\u3092\u30b4\u30cb\u30e7\u30b4\u30cb\u30e7\u3059\u308b\u4e88\u5b9a\nMongoDB\u306f\u30ec\u30d7\u30ea\u30ab\u30bb\u30c3\u30c8\u3067\u69cb\u7bc9\u3059\u308b\n\n\n\u5404\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nWeb\u30b5\u30fc\u30d0\n\nRVM\n# \\curl -sSL https://get.rvm.io | bash -s stable\n# yum -y --enablerepo=epel install libyaml libyaml-devel\n# rvm install 2.1.2\n\n\nFluentd(td-agent)\n# curl -L http://toolbelt.treasuredata.com/sh/install-redhat.sh | sh\n\n\nRVM\u304ctd-agent\u3068\u30b3\u30f3\u30d5\u30ea\u30af\u30c8\u3057\u306a\u3044\u3088\u3046\u306b\u30ea\u30bb\u30c3\u30c8\u3057\u3066\u304a\u304f\n# rvm reset\n\n\nFluentd\u30b5\u30fc\u30d0\n# curl -L http://toolbelt.treasuredata.com/sh/install-redhat.sh | sh\n\n\nMongoDB\n# cat > /etc/yum.repos.d/mongodb.repo <<EOF\n[mongodb]\nname=MongoDB Repository\nbaseurl=http://downloads-distro.mongodb.org/repo/redhat/os/x86_64/\ngpgcheck=0\nenabled=0\nEOF\n# yum -y --enablerepo=mongodb install mongodb-org\n\n\nWeb\u30b5\u30fc\u30d0\u306eFluentd(td-agent)\u306e\u8a2d\u5b9a\n<source>\n  type forward\n  port 24224\n  bind 0.0.0.0\n</source>\n\n<match ruby.*>\n  type forward\n  heartbeat_type udp\n\n  <server>\n    name fluentd-center\n    host fluentd-devel\n    port 24224\n  </server>\n\n  buffer_type file\n  buffer_path /var/log/td-agent/buffer/ruby.*.buffer\n  #\u308f\u3056\u3068\u30c1\u30e3\u30f3\u30af\u30b5\u30a4\u30ba\u306f\u5c0f\u3055\u304f\u8a2d\u5b9a\u3001\u7406\u7531\u306f\u5f8c\u8ff0\n  buffer_chunk_limit 5m\n</match>\n\n\nFluentd(td-agent)\u30b5\u30fc\u30d0\u306e\u8a2d\u5b9a\n<source>\n  type forward\n  port 24224\n  bind 0.0.0.0\n</source>\n\n<match ruby.*>\n  type mongo_replset\n  nodes 172.16.254.10:37011,172.16.254.10:37012,172.16.254.10:37013\n  database app_development\n  collection development_log\n  capped\n  capped_size 500m\n\n  buffer_type file\n  buffer_path /var/log/td-agent/buffer/ruby.*.buffer\n  #\u308f\u3056\u3068\u30c1\u30e3\u30f3\u30af\u30b5\u30a4\u30ba\u306f\u5c0f\u3055\u304f\u8a2d\u5b9a\u3001\u7406\u7531\u306f\u5f8c\u8ff0\n  buffer_chunk_limit 5m\n</match>\n\n\nMongoDB\u306e\u30ec\u30d7\u30ea\u30ab\u30bb\u30c3\u30c8\n\n\u4eca\u56de\u306f\u30ea\u30bd\u30fc\u30b9\u306e\u5236\u9650\u306b\u3088\u308a\u30dd\u30fc\u30c8\u9055\u3044\u3067\u8907\u6570\u306emongod\u3092\u8d77\u52d5\u3055\u305b\u3001\u30ec\u30d7\u30ea\u30ab\u30bb\u30c3\u30c8\u3067\u69cb\u7bc9\u3059\u308b\n\n# mkdir -p /srv/mongodb/{0,1,2,3}\n# cat > /srv/mongodb/mongo_start.sh <<EOF\nmongod --replSet fluentd --port 37010 --dbpath /srv/mongodb/0 --logpath /srv/mongodb/0.log --logappend --pidfilepath /srv/mongodb/0.pid --directoryperdb --fork\nmongod --replSet fluentd --port 37011 --dbpath /srv/mongodb/1 --logpath /srv/mongodb/1.log --logappend --pidfilepath /srv/mongodb/1.pid --directoryperdb --fork\nmongod --replSet fluentd --port 37012 --dbpath /srv/mongodb/2 --logpath /srv/mongodb/2.log --logappend --pidfilepath /srv/mongodb/2.pid --directoryperdb --fork\nmongod --replSet fluentd --port 37013 --dbpath /srv/mongodb/3 --logpath /srv/mongodb/3.log --logappend --pidfilepath /srv/mongodb/3.pid --directoryperdb --fork\nEOF\n# chmod +x /srv/mongodb/mongo_start.sh\n# /srv/mongodb/mongo_start.sh\n# mongo 172.16.254.10:37011\nconfig = {\n  _id : \"fluentd\",\n  members : [\n    { _id : 0, host : \"172.16.254.10:37010\", arbiterOnly : true },\n    { _id : 1, host : \"172.16.254.10:37011\" },\n    { _id : 2, host : \"172.16.254.10:37012\" },\n    { _id : 3, host : \"172.16.254.10:37013\" }\n  ]\n}\n\nrs.initiate(config)\nrs.status()\n\n\n\u30c7\u30fc\u30bf\u3092\u6d41\u3057\u3066\u307f\u308b\n\nWeb\u30b5\u30fc\u30d0\u4e0a\u306b\u9069\u5f53\u306aRuby\u306e\u30b3\u30fc\u30c9\u3092\u66f8\u3044\u3066\u30c7\u30fc\u30bf\u3092\u6d41\u3059\n\nfluent-logger\u3092\u4f7f\u3063\u3066\u9069\u5f53\u306a\u30c7\u30fc\u30bf\u3092\u7d44\u307f\u7acb\u3066\u6d41\u3059\n\n$ mkdir -p ~/src/logger_test\n$ echo 'logger_test' > ~/src/logger_test/.ruby-gemset\n$ echo 'ruby-2.1.2' > ~/src/logger_test/.ruby-version\n$ cd ~/src/logger_test\n$ bundle init\n$ echo \"gem 'fluent-logger'\" >> Gemfile\n$ bundle install --path=vendor/bundle --binstubs=bin\n$ touch dummy_log.rb\n\n\ndummy_log.rb\nrequire 'fluent-logger'\n\nlog = Fluent::Logger::FluentLogger.new('ruby', :host=>'localhost', :port=>24224)\nfor i in 1..1_000_000\n  log.post(\"front\", {\"agent\"=>\"foo\", \"number\"=>i})\nend\n\n\n$ ruby dummy_log.rb\n\n\n\u7d50\u679c\n\n\u3059\u3079\u3066\u306e\u30b5\u30fc\u30d0\u3067\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u304c\u6b63\u5e38\u306b\u8d77\u52d5\u3057\u3066\u3044\u308b\u72b6\u614b\u3067\u306fWeb\u30b5\u30fc\u30d0\u304b\u3089\u6d41\u3057\u305f\u30c7\u30fc\u30bf\u306fMongoDB\u306b\u8a18\u9332\u3055\u308c\u305f\n(\u3053\u306e\u3068\u304d\u306firb\u4e0a\u30671\u4ef6\u3065\u3064\u6d41\u3057\u305f)\n\u4e0a\u8a18\u306e\u6319\u52d5\u3092\u78ba\u8a8d\u5f8c\u3001100\u4e07\u4ef6\u306e\u30c7\u30fc\u30bf\u3092\u4e00\u6c17\u306b\u6d41\u3057\u305f\u3001\u3053\u306e\u5834\u5408\u3082\u6210\u529f\n\u6b21\u306b\u4e2d\u592e\u306eFluentd(td-agent)\u30b5\u30fc\u30d0\u304c\u843d\u3061\u305f\u3053\u3068\u3092\u60f3\u5b9a\u3057\u3001\u4e2d\u592e\u306eFluentd\u3092\u505c\u6b62\u3055\u305b\u3066Web\u30b5\u30fc\u30d0\u304b\u3089100\u4e07\u4ef6\u306e\u30c7\u30fc\u30bf\u3092\u6d41\u3057\u305f\u5f8c\u306b\u4e2d\u592e\u306eFluentd\u3092\u8d77\u52d5\u3055\u305b\u305f\n\u7d50\u679c\u3001\u4ee5\u4e0b\u306e\u30a8\u30e9\u30fc\u3092\u51fa\u529b\u3057\u3066MongoDB\u3078\u306e\u66f8\u304d\u8fbc\u307f\u51e6\u7406\u304c\u505c\u6b62\n\n2014-08-12 15:20:42 +0900 [warn]: temporarily failed to flush the buffer. next_retry=2014-08-12 15:20:40 +0900 error_class=\"Mongo::InvalidOperation\" error=\"Exceded maximum insert size of 8388608 bytes\" instance=69874005868640\n  2014-08-12 15:20:42 +0900 [warn]: /usr/lib64/fluent/ruby/lib/ruby/gems/1.9.1/gems/mongo-1.8.6/lib/mongo/collection.rb:1103:in `insert_documents'\n  2014-08-12 15:20:42 +0900 [warn]: /usr/lib64/fluent/ruby/lib/ruby/gems/1.9.1/gems/mongo-1.8.6/lib/mongo/collection.rb:375:in `insert'\n  2014-08-12 15:20:42 +0900 [warn]: /usr/lib64/fluent/ruby/lib/ruby/gems/1.9.1/gems/fluent-plugin-mongo-0.7.3/lib/fluent/plugin/out_mongo.rb:136:in `operate'\n  2014-08-12 15:20:42 +0900 [warn]: /usr/lib64/fluent/ruby/lib/ruby/gems/1.9.1/gems/fluent-plugin-mongo-0.7.3/lib/fluent/plugin/out_mongo_replset.rb:42:in `block in operate'\n  2014-08-12 15:20:42 +0900 [warn]: /usr/lib64/fluent/ruby/lib/ruby/gems/1.9.1/gems/fluent-plugin-mongo-0.7.3/lib/fluent/plugin/out_mongo_replset.rb:58:in `rescue_connection_failure'\n  2014-08-12 15:20:42 +0900 [warn]: /usr/lib64/fluent/ruby/lib/ruby/gems/1.9.1/gems/fluent-plugin-mongo-0.7.3/lib/fluent/plugin/out_mongo_replset.rb:41:in `operate'\n  2014-08-12 15:20:42 +0900 [warn]: /usr/lib64/fluent/ruby/lib/ruby/gems/1.9.1/gems/fluent-plugin-mongo-0.7.3/lib/fluent/plugin/out_mongo.rb:115:in `write'\n  2014-08-12 15:20:42 +0900 [warn]: /usr/lib64/fluent/ruby/lib/ruby/gems/1.9.1/gems/fluentd-0.10.50/lib/fluent/buffer.rb:296:in `write_chunk'\n  2014-08-12 15:20:42 +0900 [warn]: /usr/lib64/fluent/ruby/lib/ruby/gems/1.9.1/gems/fluentd-0.10.50/lib/fluent/buffer.rb:276:in `pop'\n  2014-08-12 15:20:42 +0900 [warn]: /usr/lib64/fluent/ruby/lib/ruby/gems/1.9.1/gems/fluentd-0.10.50/lib/fluent/output.rb:310:in `try_flush'\n  2014-08-12 15:20:42 +0900 [warn]: /usr/lib64/fluent/ruby/lib/ruby/gems/1.9.1/gems/fluentd-0.10.50/lib/fluent/output.rb:132:in `run'\n\n\u4e0a\u6d41\u3001\u4e0b\u6d41\u3067\u306e\u30d0\u30c3\u30d5\u30a1\u30fc\u306e\u30c1\u30e3\u30f3\u30af\u30b5\u30a4\u30ba\u3092\u8abf\u6574\u3057\u3066\u3082\u73fe\u8c61\u306f\u6539\u5584\u305b\u305a\u3001\u304a\u624b\u4e0a\u3052\u72b6\u614b\n4. \u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306e\u72b6\u614b\u3092\u7591\u3044\"type mongo_replset\"\u304b\u3089\"type mongo\"\u306b\u5909\u66f4\u3057\u3001\u30b7\u30f3\u30b0\u30eb\u306eMongoDB\u306b\u5bfe\u3057\u3066\"3.\"\u3068\u540c\u3058\u60f3\u5b9a\u3067\u30c7\u30fc\u30bf\u3092\u6d41\u3057\u305f\n\u7d50\u679c\u3001\u4e0a\u8a18\u306e\u3088\u3046\u306a\u30a8\u30e9\u30fc\u306f\u767a\u751f\u305b\u305a\u306b\u30d0\u30c3\u30d5\u30a1\u306b\u6e9c\u307e\u3063\u3066\u3044\u305f\u30c7\u30fc\u30bf\u304cMongoDB\u3078\u66f8\u304d\u8fbc\u307e\u308c\u305f\n\n\u8003\u5bdf\n\n\u8d77\u52d5\u76f4\u5f8c\u306efluentd\u3078\u5927\u5bb9\u91cf\u306e\u30c7\u30fc\u30bf\u3092\u6295\u3052\u3001\u30ec\u30d7\u30ea\u30ab\u30bb\u30c3\u30c8\u3092\u7d44\u3093\u3060MongoDB\u306b\u5bfe\u3057\u3066\u66f8\u304d\u8fbc\u307f\u3092\u884c\u3046\u3068\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3059\u308b\u3088\u3046\u3067\u3042\u308b\n\u79c1\u306e\u7d44\u3093\u3060\u3001MongoDB\u306e\u30ec\u30d7\u30ea\u30ab\u30bb\u30c3\u30c8\u306b\u554f\u984c\u304c\u3042\u308b\u306e\u304b\uff1f\uff1f\uff1f\n\n\n\u8ffd\u8a18\n\nmongo\u306e\u30c9\u30e9\u30a4\u30d0\u3092\u66f4\u65b0\u3057\u3066\u307f\u305f\n\n\u30c0\u30e1\u3082\u3068\u3067td-agent\u304c\u5185\u5305\u3057\u3066\u3044\u308bgem\u306emongo\u3092\u66f4\u65b0\u3057\u305f\ntd-agent\u8d77\u52d5\u6642\u306b\"bson_ext\u3092\u8ffd\u52a0\u3057\u305f\u65b9\u304c\u3044\u3044\u3088\"\u3068\u6307\u6458\u3055\u308c\u305f\u306e\u3067bson_ext\u3082\u8ffd\u52a0\n\n# export PATH=$PATH:/usr/lib64/fluent/ruby/bin/\n# fluent-gem update mongo\n# fluent-gem install bson_ext\n# fluent-gem list\n\n*** LOCAL GEMS ***\n\naws-sdk (1.38.0)\nbigdecimal (1.1.0)\nbson (1.10.2, 1.8.6)\nbson_ext (1.10.2, 1.8.6)\nbundler (1.3.6)\ncool.io (1.1.1)\ndiff-lcs (1.2.5)\nfluent-logger (0.4.9)\nfluent-mixin-config-placeholders (0.2.4)\nfluent-mixin-plaintextformatter (0.2.6)\nfluent-plugin-flume (0.1.1)\nfluent-plugin-mongo (0.7.3)\nfluent-plugin-rewrite-tag-filter (1.4.1)\nfluent-plugin-s3 (0.4.0)\nfluent-plugin-scribe (0.10.10)\nfluent-plugin-td (0.10.20)\nfluent-plugin-td-monitoring (0.1.2)\nfluent-plugin-webhdfs (0.2.2)\nfluentd (0.10.50)\ngit (1.2.7)\nhirb (0.7.2)\nhttp_parser.rb (0.5.1)\nhttpclient (2.3.4.1)\nio-console (0.3)\niobuffer (1.1.2)\nipaddress (0.8.0)\njeweler (1.6.2)\njson (1.7.7, 1.5.5)\nltsv (0.1.0)\nmini_portile (0.6.0)\nminitest (2.5.1)\nmixlib-cli (1.5.0)\nmixlib-config (2.1.0)\nmixlib-log (1.6.0)\nmixlib-shellout (1.4.0)\nmongo (1.10.2, 1.8.6)\nmsgpack (0.4.7)\nnokogiri (1.5.10)\nohai (6.20.0)\nparallel (0.6.5)\nrake (0.9.2.2)\nrdoc (3.9.5)\nrspec (3.0.0)\nrspec-core (3.0.1)\nrspec-expectations (3.0.1)\nrspec-mocks (3.0.1)\nrspec-support (3.0.0)\nrubyzip (0.9.9)\nsigdump (0.2.2)\nstring-scrub (0.0.3)\nsystemu (2.5.2)\ntd (0.10.99)\ntd-client (0.8.61)\ntd-logger (0.3.23)\nthrift (0.8.0)\nuuidtools (2.1.4)\nwebhdfs (0.5.5)\nyajl-ruby (1.1.0)\n\n\n\u7d50\u679c\u3001\u6628\u65e5\u306e\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u306a\u304f\u306a\u308a\u6b63\u5e38\u306bINSERT\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u3063\u305f\uff01\n\u3067\u3082\u3001\u3053\u306e\u5bfe\u5fdc\u65b9\u6cd5\u3067\u826f\u3044\u306e\u3060\u308d\u3046\u304b\uff1f\uff1f\uff1f\n\n# \u4f7f\u3063\u305f\u3082\u306e\n* Fluentd(td-agent)\n* MongoDB\n* CentOS\n* Ruby\n\n# \u69cb\u6210\n```\n+-------+--------+                        +--------------------+\n|WEB Server      |                        |MongoDB(Replica set)|\n|                |                        |                    |\n|  +-----------+ |                        |  +--------------+  |\n|  |Ruby(Rails)| |                        |  |Master        |  |\n|  ++----------+ |                        |  +--------------+  |\n|   |            |                        |  +--------------+  |\n|   |  +-------+ |   +----------------+   |  |Slave         |  |\n|   +--+Fluentd+-----+ Fluentd Server +---+  +--------------+  |\n|      +-------+ |   +----------------+   |  +--------------+  |\n|                |                        |  |Slave         |  |\n+----------------+                        |  +--------------+  |\n                                          |  +--------------+  |\n                                          |  |Arbiter       |  |\n                                          |  +--------------+  |\n                                          |                    |\n                                          +--------------------+\n```\n* Web\u30b5\u30fc\u30d0\u306f\u30b9\u30b1\u30fc\u30eb\u3092\u60f3\u5b9a\u3057\u3001\u6700\u7d42\u7684\u306b\u306fPassenger\u3067Rails\u30a2\u30d7\u30ea\u3092\u7a3c\u52d5\u3055\u305b\u308b\n* Ruby(Rails)\u30a2\u30d7\u30ea\u304b\u3089\u30ed\u30fc\u30ab\u30eb\u306eFluentd\u306b\u6e21\u3057Forward\u3059\u308b\n* \u2191\u4e2d\u592e\u306eFluentd\u30b5\u30fc\u30d0\u304c\u843d\u3061\u305f/\u843d\u3068\u3057\u305f\u3068\u304d\u306e\u30d0\u30c3\u30d5\u30a1\u3092\u671f\u5f85\n* Fluentd\u30b5\u30fc\u30d0\u3067\u306fWeb\u30b5\u30fc\u30d0\u304b\u3089Forward\u3055\u308c\u3066\u304d\u305f\u30c7\u30fc\u30bf\u3092MongoDB\u306b\u66f8\u304d\u8fbc\u3080\n* \u2191MongoDB\u304c\u843d\u3061\u305f/\u843d\u3068\u3057\u305f\u3068\u304d\u306e\u30d0\u30c3\u30d5\u30a1\u3092\u671f\u5f85\n* \u2191\u4e2d\u592e\u306eFluentd\u30b5\u30fc\u30d0\u306f\u73fe\u72b6\u306f\u5358\u6a5f\u80fd\u3060\u304c\u5f8c\u3005\u3001\u6d41\u308c\u3066\u304f\u308b\u30c7\u30fc\u30bf\u3092\u30b4\u30cb\u30e7\u30b4\u30cb\u30e7\u3059\u308b\u4e88\u5b9a\n* MongoDB\u306f\u30ec\u30d7\u30ea\u30ab\u30bb\u30c3\u30c8\u3067\u69cb\u7bc9\u3059\u308b\n\n# \u5404\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n## Web\u30b5\u30fc\u30d0\n### RVM\n```\n# \\curl -sSL https://get.rvm.io | bash -s stable\n# yum -y --enablerepo=epel install libyaml libyaml-devel\n# rvm install 2.1.2\n```\n### Fluentd(td-agent)\n```\n# curl -L http://toolbelt.treasuredata.com/sh/install-redhat.sh | sh\n```\n### RVM\u304ctd-agent\u3068\u30b3\u30f3\u30d5\u30ea\u30af\u30c8\u3057\u306a\u3044\u3088\u3046\u306b\u30ea\u30bb\u30c3\u30c8\u3057\u3066\u304a\u304f\n```\n# rvm reset\n```\n\n## Fluentd\u30b5\u30fc\u30d0\n```\n# curl -L http://toolbelt.treasuredata.com/sh/install-redhat.sh | sh\n```\n\n## MongoDB\n```\n# cat > /etc/yum.repos.d/mongodb.repo <<EOF\n[mongodb]\nname=MongoDB Repository\nbaseurl=http://downloads-distro.mongodb.org/repo/redhat/os/x86_64/\ngpgcheck=0\nenabled=0\nEOF\n# yum -y --enablerepo=mongodb install mongodb-org\n```\n\n# Web\u30b5\u30fc\u30d0\u306eFluentd(td-agent)\u306e\u8a2d\u5b9a\n```\n<source>\n  type forward\n  port 24224\n  bind 0.0.0.0\n</source>\n\n<match ruby.*>\n  type forward\n  heartbeat_type udp\n\n  <server>\n    name fluentd-center\n    host fluentd-devel\n    port 24224\n  </server>\n\n  buffer_type file\n  buffer_path /var/log/td-agent/buffer/ruby.*.buffer\n  #\u308f\u3056\u3068\u30c1\u30e3\u30f3\u30af\u30b5\u30a4\u30ba\u306f\u5c0f\u3055\u304f\u8a2d\u5b9a\u3001\u7406\u7531\u306f\u5f8c\u8ff0\n  buffer_chunk_limit 5m\n</match>\n```\n\n# Fluentd(td-agent)\u30b5\u30fc\u30d0\u306e\u8a2d\u5b9a\n```\n<source>\n  type forward\n  port 24224\n  bind 0.0.0.0\n</source>\n\n<match ruby.*>\n  type mongo_replset\n  nodes 172.16.254.10:37011,172.16.254.10:37012,172.16.254.10:37013\n  database app_development\n  collection development_log\n  capped\n  capped_size 500m\n\n  buffer_type file\n  buffer_path /var/log/td-agent/buffer/ruby.*.buffer\n  #\u308f\u3056\u3068\u30c1\u30e3\u30f3\u30af\u30b5\u30a4\u30ba\u306f\u5c0f\u3055\u304f\u8a2d\u5b9a\u3001\u7406\u7531\u306f\u5f8c\u8ff0\n  buffer_chunk_limit 5m\n</match>\n```\n\n## MongoDB\u306e\u30ec\u30d7\u30ea\u30ab\u30bb\u30c3\u30c8\n* \u4eca\u56de\u306f\u30ea\u30bd\u30fc\u30b9\u306e\u5236\u9650\u306b\u3088\u308a\u30dd\u30fc\u30c8\u9055\u3044\u3067\u8907\u6570\u306emongod\u3092\u8d77\u52d5\u3055\u305b\u3001\u30ec\u30d7\u30ea\u30ab\u30bb\u30c3\u30c8\u3067\u69cb\u7bc9\u3059\u308b\n\n```\n# mkdir -p /srv/mongodb/{0,1,2,3}\n# cat > /srv/mongodb/mongo_start.sh <<EOF\nmongod --replSet fluentd --port 37010 --dbpath /srv/mongodb/0 --logpath /srv/mongodb/0.log --logappend --pidfilepath /srv/mongodb/0.pid --directoryperdb --fork\nmongod --replSet fluentd --port 37011 --dbpath /srv/mongodb/1 --logpath /srv/mongodb/1.log --logappend --pidfilepath /srv/mongodb/1.pid --directoryperdb --fork\nmongod --replSet fluentd --port 37012 --dbpath /srv/mongodb/2 --logpath /srv/mongodb/2.log --logappend --pidfilepath /srv/mongodb/2.pid --directoryperdb --fork\nmongod --replSet fluentd --port 37013 --dbpath /srv/mongodb/3 --logpath /srv/mongodb/3.log --logappend --pidfilepath /srv/mongodb/3.pid --directoryperdb --fork\nEOF\n# chmod +x /srv/mongodb/mongo_start.sh\n# /srv/mongodb/mongo_start.sh\n# mongo 172.16.254.10:37011\nconfig = {\n  _id : \"fluentd\",\n  members : [\n    { _id : 0, host : \"172.16.254.10:37010\", arbiterOnly : true },\n    { _id : 1, host : \"172.16.254.10:37011\" },\n    { _id : 2, host : \"172.16.254.10:37012\" },\n    { _id : 3, host : \"172.16.254.10:37013\" }\n  ]\n}\n\nrs.initiate(config)\nrs.status()\n```\n\n# \u30c7\u30fc\u30bf\u3092\u6d41\u3057\u3066\u307f\u308b\n* Web\u30b5\u30fc\u30d0\u4e0a\u306b\u9069\u5f53\u306aRuby\u306e\u30b3\u30fc\u30c9\u3092\u66f8\u3044\u3066\u30c7\u30fc\u30bf\u3092\u6d41\u3059\n* [fluent-logger](http://rubygems.org/gems/fluent-logger)\u3092\u4f7f\u3063\u3066\u9069\u5f53\u306a\u30c7\u30fc\u30bf\u3092\u7d44\u307f\u7acb\u3066\u6d41\u3059\n\n```\n$ mkdir -p ~/src/logger_test\n$ echo 'logger_test' > ~/src/logger_test/.ruby-gemset\n$ echo 'ruby-2.1.2' > ~/src/logger_test/.ruby-version\n$ cd ~/src/logger_test\n$ bundle init\n$ echo \"gem 'fluent-logger'\" >> Gemfile\n$ bundle install --path=vendor/bundle --binstubs=bin\n$ touch dummy_log.rb\n```\n```rb:dummy_log.rb\nrequire 'fluent-logger'\n\nlog = Fluent::Logger::FluentLogger.new('ruby', :host=>'localhost', :port=>24224)\nfor i in 1..1_000_000\n  log.post(\"front\", {\"agent\"=>\"foo\", \"number\"=>i})\nend\n```\n```\n$ ruby dummy_log.rb\n```\n\n# \u7d50\u679c\n1. \u3059\u3079\u3066\u306e\u30b5\u30fc\u30d0\u3067\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u304c\u6b63\u5e38\u306b\u8d77\u52d5\u3057\u3066\u3044\u308b\u72b6\u614b\u3067\u306fWeb\u30b5\u30fc\u30d0\u304b\u3089\u6d41\u3057\u305f\u30c7\u30fc\u30bf\u306fMongoDB\u306b\u8a18\u9332\u3055\u308c\u305f\n(\u3053\u306e\u3068\u304d\u306firb\u4e0a\u30671\u4ef6\u3065\u3064\u6d41\u3057\u305f)\n\n2. \u4e0a\u8a18\u306e\u6319\u52d5\u3092\u78ba\u8a8d\u5f8c\u3001100\u4e07\u4ef6\u306e\u30c7\u30fc\u30bf\u3092\u4e00\u6c17\u306b\u6d41\u3057\u305f\u3001\u3053\u306e\u5834\u5408\u3082\u6210\u529f\n3. \u6b21\u306b\u4e2d\u592e\u306eFluentd(td-agent)\u30b5\u30fc\u30d0\u304c\u843d\u3061\u305f\u3053\u3068\u3092\u60f3\u5b9a\u3057\u3001\u4e2d\u592e\u306eFluentd\u3092\u505c\u6b62\u3055\u305b\u3066Web\u30b5\u30fc\u30d0\u304b\u3089100\u4e07\u4ef6\u306e\u30c7\u30fc\u30bf\u3092\u6d41\u3057\u305f\u5f8c\u306b\u4e2d\u592e\u306eFluentd\u3092\u8d77\u52d5\u3055\u305b\u305f\n\u7d50\u679c\u3001\u4ee5\u4e0b\u306e\u30a8\u30e9\u30fc\u3092\u51fa\u529b\u3057\u3066MongoDB\u3078\u306e\u66f8\u304d\u8fbc\u307f\u51e6\u7406\u304c\u505c\u6b62\n\n```\n2014-08-12 15:20:42 +0900 [warn]: temporarily failed to flush the buffer. next_retry=2014-08-12 15:20:40 +0900 error_class=\"Mongo::InvalidOperation\" error=\"Exceded maximum insert size of 8388608 bytes\" instance=69874005868640\n  2014-08-12 15:20:42 +0900 [warn]: /usr/lib64/fluent/ruby/lib/ruby/gems/1.9.1/gems/mongo-1.8.6/lib/mongo/collection.rb:1103:in `insert_documents'\n  2014-08-12 15:20:42 +0900 [warn]: /usr/lib64/fluent/ruby/lib/ruby/gems/1.9.1/gems/mongo-1.8.6/lib/mongo/collection.rb:375:in `insert'\n  2014-08-12 15:20:42 +0900 [warn]: /usr/lib64/fluent/ruby/lib/ruby/gems/1.9.1/gems/fluent-plugin-mongo-0.7.3/lib/fluent/plugin/out_mongo.rb:136:in `operate'\n  2014-08-12 15:20:42 +0900 [warn]: /usr/lib64/fluent/ruby/lib/ruby/gems/1.9.1/gems/fluent-plugin-mongo-0.7.3/lib/fluent/plugin/out_mongo_replset.rb:42:in `block in operate'\n  2014-08-12 15:20:42 +0900 [warn]: /usr/lib64/fluent/ruby/lib/ruby/gems/1.9.1/gems/fluent-plugin-mongo-0.7.3/lib/fluent/plugin/out_mongo_replset.rb:58:in `rescue_connection_failure'\n  2014-08-12 15:20:42 +0900 [warn]: /usr/lib64/fluent/ruby/lib/ruby/gems/1.9.1/gems/fluent-plugin-mongo-0.7.3/lib/fluent/plugin/out_mongo_replset.rb:41:in `operate'\n  2014-08-12 15:20:42 +0900 [warn]: /usr/lib64/fluent/ruby/lib/ruby/gems/1.9.1/gems/fluent-plugin-mongo-0.7.3/lib/fluent/plugin/out_mongo.rb:115:in `write'\n  2014-08-12 15:20:42 +0900 [warn]: /usr/lib64/fluent/ruby/lib/ruby/gems/1.9.1/gems/fluentd-0.10.50/lib/fluent/buffer.rb:296:in `write_chunk'\n  2014-08-12 15:20:42 +0900 [warn]: /usr/lib64/fluent/ruby/lib/ruby/gems/1.9.1/gems/fluentd-0.10.50/lib/fluent/buffer.rb:276:in `pop'\n  2014-08-12 15:20:42 +0900 [warn]: /usr/lib64/fluent/ruby/lib/ruby/gems/1.9.1/gems/fluentd-0.10.50/lib/fluent/output.rb:310:in `try_flush'\n  2014-08-12 15:20:42 +0900 [warn]: /usr/lib64/fluent/ruby/lib/ruby/gems/1.9.1/gems/fluentd-0.10.50/lib/fluent/output.rb:132:in `run'\n```\n\u4e0a\u6d41\u3001\u4e0b\u6d41\u3067\u306e\u30d0\u30c3\u30d5\u30a1\u30fc\u306e\u30c1\u30e3\u30f3\u30af\u30b5\u30a4\u30ba\u3092\u8abf\u6574\u3057\u3066\u3082\u73fe\u8c61\u306f\u6539\u5584\u305b\u305a\u3001\u304a\u624b\u4e0a\u3052\u72b6\u614b\n4. \u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306e\u72b6\u614b\u3092\u7591\u3044\"type mongo_replset\"\u304b\u3089\"type mongo\"\u306b\u5909\u66f4\u3057\u3001\u30b7\u30f3\u30b0\u30eb\u306eMongoDB\u306b\u5bfe\u3057\u3066\"3.\"\u3068\u540c\u3058\u60f3\u5b9a\u3067\u30c7\u30fc\u30bf\u3092\u6d41\u3057\u305f\n\u7d50\u679c\u3001\u4e0a\u8a18\u306e\u3088\u3046\u306a\u30a8\u30e9\u30fc\u306f\u767a\u751f\u305b\u305a\u306b\u30d0\u30c3\u30d5\u30a1\u306b\u6e9c\u307e\u3063\u3066\u3044\u305f\u30c7\u30fc\u30bf\u304cMongoDB\u3078\u66f8\u304d\u8fbc\u307e\u308c\u305f\n\n# \u8003\u5bdf\n* \u8d77\u52d5\u76f4\u5f8c\u306efluentd\u3078\u5927\u5bb9\u91cf\u306e\u30c7\u30fc\u30bf\u3092\u6295\u3052\u3001\u30ec\u30d7\u30ea\u30ab\u30bb\u30c3\u30c8\u3092\u7d44\u3093\u3060MongoDB\u306b\u5bfe\u3057\u3066\u66f8\u304d\u8fbc\u307f\u3092\u884c\u3046\u3068\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3059\u308b\u3088\u3046\u3067\u3042\u308b\n* \u79c1\u306e\u7d44\u3093\u3060\u3001MongoDB\u306e\u30ec\u30d7\u30ea\u30ab\u30bb\u30c3\u30c8\u306b\u554f\u984c\u304c\u3042\u308b\u306e\u304b\uff1f\uff1f\uff1f\n\n* * *\n*\u8ffd\u8a18*\n# mongo\u306e\u30c9\u30e9\u30a4\u30d0\u3092\u66f4\u65b0\u3057\u3066\u307f\u305f\n* \u30c0\u30e1\u3082\u3068\u3067td-agent\u304c\u5185\u5305\u3057\u3066\u3044\u308bgem\u306emongo\u3092\u66f4\u65b0\u3057\u305f\n* td-agent\u8d77\u52d5\u6642\u306b\"bson_ext\u3092\u8ffd\u52a0\u3057\u305f\u65b9\u304c\u3044\u3044\u3088\"\u3068\u6307\u6458\u3055\u308c\u305f\u306e\u3067bson_ext\u3082\u8ffd\u52a0\n\n```\n# export PATH=$PATH:/usr/lib64/fluent/ruby/bin/\n# fluent-gem update mongo\n# fluent-gem install bson_ext\n# fluent-gem list\n\n*** LOCAL GEMS ***\n\naws-sdk (1.38.0)\nbigdecimal (1.1.0)\nbson (1.10.2, 1.8.6)\nbson_ext (1.10.2, 1.8.6)\nbundler (1.3.6)\ncool.io (1.1.1)\ndiff-lcs (1.2.5)\nfluent-logger (0.4.9)\nfluent-mixin-config-placeholders (0.2.4)\nfluent-mixin-plaintextformatter (0.2.6)\nfluent-plugin-flume (0.1.1)\nfluent-plugin-mongo (0.7.3)\nfluent-plugin-rewrite-tag-filter (1.4.1)\nfluent-plugin-s3 (0.4.0)\nfluent-plugin-scribe (0.10.10)\nfluent-plugin-td (0.10.20)\nfluent-plugin-td-monitoring (0.1.2)\nfluent-plugin-webhdfs (0.2.2)\nfluentd (0.10.50)\ngit (1.2.7)\nhirb (0.7.2)\nhttp_parser.rb (0.5.1)\nhttpclient (2.3.4.1)\nio-console (0.3)\niobuffer (1.1.2)\nipaddress (0.8.0)\njeweler (1.6.2)\njson (1.7.7, 1.5.5)\nltsv (0.1.0)\nmini_portile (0.6.0)\nminitest (2.5.1)\nmixlib-cli (1.5.0)\nmixlib-config (2.1.0)\nmixlib-log (1.6.0)\nmixlib-shellout (1.4.0)\nmongo (1.10.2, 1.8.6)\nmsgpack (0.4.7)\nnokogiri (1.5.10)\nohai (6.20.0)\nparallel (0.6.5)\nrake (0.9.2.2)\nrdoc (3.9.5)\nrspec (3.0.0)\nrspec-core (3.0.1)\nrspec-expectations (3.0.1)\nrspec-mocks (3.0.1)\nrspec-support (3.0.0)\nrubyzip (0.9.9)\nsigdump (0.2.2)\nstring-scrub (0.0.3)\nsystemu (2.5.2)\ntd (0.10.99)\ntd-client (0.8.61)\ntd-logger (0.3.23)\nthrift (0.8.0)\nuuidtools (2.1.4)\nwebhdfs (0.5.5)\nyajl-ruby (1.1.0)\n```\n* \u7d50\u679c\u3001\u6628\u65e5\u306e\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u306a\u304f\u306a\u308a\u6b63\u5e38\u306bINSERT\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u3063\u305f\uff01\n* \u3067\u3082\u3001\u3053\u306e\u5bfe\u5fdc\u65b9\u6cd5\u3067\u826f\u3044\u306e\u3060\u308d\u3046\u304b\uff1f\uff1f\uff1f\n", "tags": ["fluentd0.10.50", "Ruby2.1.2", "MongoDB2.6.4", "CentOS6.5"]}