{"context": "sidekiq\u4f7f\u3063\u305f\u3053\u3068\u306a\u304b\u3063\u305f\u306e\u3067\u4f7f\u3063\u3066\u307f\u307e\u3057\u305f\u3002\nhttp://sidekiq.org/\nsinatra\u3067post\u304b\u3089\u30d1\u30e9\u30e1\u30fc\u30bf\u53d7\u3051\u53d6\u3063\u3066\u3001\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306equeue\u306b\u91cd\u3044\u51e6\u7406\u3092\u6d41\u3059\u307f\u305f\u3044\u306a\u4e8b\u3092\u3057\u305f\u3044\u306a\u3068\u601d\u3063\u3066\u8abf\u3079\u305f\u30e1\u30e2\u3067\u3059\u3002\n\u4eca\u56de\u306f\u30c0\u30df\u30fc\u306e\u51e6\u7406\u3068\u3057\u3066\u3001\u6570\u79d2sleep\u5f8c\u306bPOST\u3067\u53d7\u3051\u53d6\u3063\u305f\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u30ad\u30fc\u3068\u3057\u3066\u30d0\u30ea\u30e5\u30fc\u306btrue\u3092\u5165\u308c\u308b\u3088\u3046\u306a\u51e6\u7406\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\u691c\u8a3c\u7528\u306b\u66f8\u3044\u305f\u30b3\u30fc\u30c9\u306f\u3053\u3053\u306b\u7f6e\u304d\u307e\u3057\u305f\nhttps://github.com/ara-ta3/sinatra-and-sidekiq\n\nWeb App\u306e\u6e96\u5099\nsinatra + unicorn\u3067web\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u66f8\u304d\u307e\u3059\n\u30d5\u30a1\u30a4\u30eb\u69cb\u6210\u306f\u3053\u3093\u306a\u611f\u3058\u3067\u3059\n$tree\n.\n\u251c\u2500\u2500 Gemfile\n\u251c\u2500\u2500 Gemfile.lock\n\u251c\u2500\u2500 Makefile\n\u251c\u2500\u2500 Worker.rb\n\u251c\u2500\u2500 app.rb\n\u251c\u2500\u2500 config.ru\n\u251c\u2500\u2500 log\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 unicorn.stderr.log\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 unicorn.stdout.log\n\u2514\u2500\u2500 unicorn.rb\n\n1 directory, 9 files\n\nGemfile\nsource \"https://rubygems.org\"\n\ngem \"sinatra\"\ngem \"unicorn\"\ngem \"sidekiq\"\ngem \"redis\"\n\napp.rb\nrequire \"sinatra\"\nrequire \"json\"\nrequire \"redis\"\n\nclass App < Sinatra::Base\n\n    @@redis = Redis.new(:url => \"redis://localhost/10\")\n    get '/' do\n        content_type :json\n        all = {}\n        @@redis.keys.each {|k| \n            all[k] = @@redis.get(k)\n        }\n        all.to_json\n    end\n\n    post '/' do\n        d = params[:x]\n        # \u3068\u3066\u3082\u91cd\u3044\u51e6\u7406\u3092\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306eQueue\u306b\u4efb\u305b\u308b\n        Worker.perform_async(d)\n        content_type :json\n        res = {\n            result: \"ok\"\n        }\n        res.to_json\n    end\nend\n\nconfig.ru\nrequire \"./app.rb\"\nrequire \"./Worker.rb\"\nrequire \"sidekiq\"\nrequire 'sidekiq/web'\n\nSidekiq.configure_server do |config|\n    config.redis = { url: 'redis://localhost:6379', namespace: 'sidekiq' }\nend\n\nrun Rack::URLMap.new('/' => App, '/sidekiq' => Sidekiq::Web)\n\nunicorn.rb\n@dir = \"./\"\n\nworker_processes 2\nworking_directory @dir\n\ntimeout 300\nlisten 8081\n\nstderr_path \"#{@dir}log/unicorn.stderr.log\"\nstdout_path \"#{@dir}log/unicorn.stdout.log\"\n\n\u8d77\u52d5\u30b3\u30de\u30f3\u30c9\n$bundle exec unicorn -c unicorn.rb\n...\n\n#\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3067\n$curl -i localhost:8081\nHTTP/1.1 200 OK\nDate: Mon, 19 Sep 2016 09:43:35 GMT\nConnection: close\nContent-Type: application/json\nContent-Length: 2\nX-Content-Type-Options: nosniff\n\n{}%\n\n# \u30c0\u30df\u30fc\u306e\u91cd\u3044\u51e6\u7406\u3092\u8d77\u52d5\u3059\u308b\u30b3\u30de\u30f3\u30c9\n# worker\u3092\u52d5\u304b\u3057\u3066\u3044\u306a\u3044\u306e\u3067\u51e6\u7406\u3055\u308c\u307e\u305b\u3093\u304c\u3053\u306e\u5b9f\u884c\u5f8c\u306b\u30ad\u30e5\u30fc\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u6e9c\u307e\u308b\u611f\u3058\u3067\u3059\n$curl -i -X POST localhost:8081 -d 'x=hoge'\nHTTP/1.1 200 OK\nDate: Mon, 19 Sep 2016 09:43:38 GMT\nConnection: close\nContent-Type: application/json\nContent-Length: 15\nX-Content-Type-Options: nosniff\n\n{\"result\":\"ok\"}%\n\n$cat log/unicorn.stderr.log\nI, [2016-09-19T18:39:36.673794 #41193]  INFO -- : listening on addr=0.0.0.0:8081 fd=9\nI, [2016-09-19T18:39:36.673899 #41193]  INFO -- : worker=0 spawning...\nI, [2016-09-19T18:39:36.674996 #41193]  INFO -- : worker=1 spawning...\nI, [2016-09-19T18:39:36.675474 #41193]  INFO -- : master process ready\nI, [2016-09-19T18:39:36.676282 #41194]  INFO -- : worker=0 spawned pid=41194\nI, [2016-09-19T18:39:36.676482 #41195]  INFO -- : worker=1 spawned pid=41195\nI, [2016-09-19T18:39:36.676773 #41194]  INFO -- : Refreshing Gem list\nI, [2016-09-19T18:39:36.676799 #41195]  INFO -- : Refreshing Gem list\nI, [2016-09-19T18:39:36.806327 #41194]  INFO -- : worker=0 ready\nI, [2016-09-19T18:39:36.806394 #41195]  INFO -- : worker=1 ready\n127.0.0.1 - - [19/Sep/2016:18:39:39 +0900] \"GET / HTTP/1.1\" 200 2 0.0081\n127.0.0.1 - - [19/Sep/2016:18:39:40 +0900] \"POST / HTTP/1.1\" 200 15 0.0089\nI, [2016-09-19T18:39:42.898632 #41193]  INFO -- : reaped #<Process::Status: pid 41195 exit 0> worker=1\nI, [2016-09-19T18:39:42.898718 #41193]  INFO -- : reaped #<Process::Status: pid 41194 exit 0> worker=0\nI, [2016-09-19T18:39:42.898984 #41193]  INFO -- : master complete\n\n\u3064\u3044\u3067\u306bsidekiq\u306eWeb UI\u3082\u3042\u308b\u3089\u3057\u304f\u3001\u8ffd\u52a0\u3057\u3066\u307f\u307e\u3057\u305f\u3002\nlocalhost:8081/sidekiq/ \u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u898b\u308c\u307e\u3059\u3002\nlocalhost:8081/sidekiq \u3060\u3068\u898b\u308c\u306a\u3044\u306e\u3067\u6ce8\u610f\u3067\u3059\u3002\n\n\u4fbf\u5229\u305d\u3046\n\nWorker\u306e\u6e96\u5099\nworker\u5074\u306f\u5b9f\u88c5\u66f8\u3044\u3066\u5b9f\u884c\u3059\u308b\u3060\u3051\u3067\u3059\u3002\nWorker.rb\nrequire \"redis\"\nrequire \"sidekiq\"\n\nclass Worker\n    include Sidekiq::Worker\n    sidekiq_options queue: :event\n    @@redis = Redis.new(:url => \"redis://localhost/10\")\n\n    def perform(key)\n        sleep(2)\n        # \u307b\u3093\u3068\u306f\u91cd\u3044SQL\u3092\u767a\u884c\u3057\u305f\u308a\u3057\u3066MySQL\u306b\u66f8\u304d\u8fbc\u3093\u3060\u308a\u3059\u308b\u3082\u306e\u3092\u60f3\u5b9a\n        @@redis.set(key, true)\n    end\nend\n\n\u5f8c\u306f\u5b9f\u884c\u3060\u3051\u3067\u3059\u3002\n\u30ed\u30b0\u306b\u51e6\u7406\u7d50\u679c\u304c\u6d41\u308c\u305f\u308a\u3059\u308b\u306e\u3067\u308f\u304b\u308a\u3084\u3059\u3044\u3067\u3059\u3002\n$bundle exec sidekiq -r ./Worker.rb -q event\n\n\n         m,\n         `$b\n    .ss,  $$:         .,d$\n    `$$P,d$P'    .,md$P\"'\n     ,$$$$$bmmd$$$P^'\n   .d$$$$$$$$$$P'\n   $$^' `\"^$$$'       ____  _     _      _    _\n   $:     ,$$:       / ___|(_) __| | ___| | _(_) __ _\n   `b     :$$        \\___ \\| |/ _` |/ _ \\ |/ / |/ _` |\n          $$:         ___) | | (_| |  __/   <| | (_| |\n          $$         |____/|_|\\__,_|\\___|_|\\_\\_|\\__, |\n        .d$$                                       |_|\n\n2016-09-19T09:52:15.738Z 41994 TID-owno79hy0 INFO: Running in ruby 2.3.0p0 (2015-12-25 revision 53290) [x86_64-darwin14]\n2016-09-19T09:52:15.738Z 41994 TID-owno79hy0 INFO: See LICENSE and the LGPL-3.0 for licensing details.\n2016-09-19T09:52:15.738Z 41994 TID-owno79hy0 INFO: Upgrade to Sidekiq Pro for more features and support: http://sidekiq.org\n2016-09-19T09:52:15.738Z 41994 TID-owno79hy0 INFO: Booting Sidekiq 4.2.1 with redis options {:url=>nil}\n2016-09-19T09:52:15.751Z 41994 TID-owno79hy0 INFO: Starting processing, hit Ctrl-C to stop\n2016-09-19T09:52:16.154Z 41994 TID-owno4qck0 Worker JID-a8ac5c4dfe50040b51b8a825 INFO: start\n2016-09-19T09:52:16.156Z 41994 TID-owno4qamk Worker JID-c369a462be8d818d9d13b4e5 INFO: start\n2016-09-19T09:52:16.157Z 41994 TID-owno4qawk Worker JID-ef961372d2ac86b215db3d07 INFO: start\n2016-09-19T09:52:18.160Z 41994 TID-owno4qck0 Worker JID-a8ac5c4dfe50040b51b8a825 INFO: done: 2.006 sec\n2016-09-19T09:52:18.160Z 41994 TID-owno4qamk Worker JID-c369a462be8d818d9d13b4e5 INFO: done: 2.004 sec\n2016-09-19T09:52:18.160Z 41994 TID-owno4qawk Worker JID-ef961372d2ac86b215db3d07 INFO: done: 2.004 sec\n\n\n\u307e\u3068\u3081\n\nsidekiq\u4fbf\u5229\u305d\u3046\nUI\u304d\u308c\u3044\n\nsidekiq\u4f7f\u3063\u305f\u3053\u3068\u306a\u304b\u3063\u305f\u306e\u3067\u4f7f\u3063\u3066\u307f\u307e\u3057\u305f\u3002\nhttp://sidekiq.org/\n\nsinatra\u3067post\u304b\u3089\u30d1\u30e9\u30e1\u30fc\u30bf\u53d7\u3051\u53d6\u3063\u3066\u3001\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306equeue\u306b\u91cd\u3044\u51e6\u7406\u3092\u6d41\u3059\u307f\u305f\u3044\u306a\u4e8b\u3092\u3057\u305f\u3044\u306a\u3068\u601d\u3063\u3066\u8abf\u3079\u305f\u30e1\u30e2\u3067\u3059\u3002\n\u4eca\u56de\u306f\u30c0\u30df\u30fc\u306e\u51e6\u7406\u3068\u3057\u3066\u3001\u6570\u79d2sleep\u5f8c\u306bPOST\u3067\u53d7\u3051\u53d6\u3063\u305f\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u30ad\u30fc\u3068\u3057\u3066\u30d0\u30ea\u30e5\u30fc\u306btrue\u3092\u5165\u308c\u308b\u3088\u3046\u306a\u51e6\u7406\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\n\n\u691c\u8a3c\u7528\u306b\u66f8\u3044\u305f\u30b3\u30fc\u30c9\u306f\u3053\u3053\u306b\u7f6e\u304d\u307e\u3057\u305f\nhttps://github.com/ara-ta3/sinatra-and-sidekiq\n\n# Web App\u306e\u6e96\u5099\n\nsinatra + unicorn\u3067web\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u66f8\u304d\u307e\u3059\n\u30d5\u30a1\u30a4\u30eb\u69cb\u6210\u306f\u3053\u3093\u306a\u611f\u3058\u3067\u3059\n\n```zsh\n$tree\n.\n\u251c\u2500\u2500 Gemfile\n\u251c\u2500\u2500 Gemfile.lock\n\u251c\u2500\u2500 Makefile\n\u251c\u2500\u2500 Worker.rb\n\u251c\u2500\u2500 app.rb\n\u251c\u2500\u2500 config.ru\n\u251c\u2500\u2500 log\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 unicorn.stderr.log\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 unicorn.stdout.log\n\u2514\u2500\u2500 unicorn.rb\n\n1 directory, 9 files\n```\n\n\nGemfile\n\n```\nsource \"https://rubygems.org\"\n\ngem \"sinatra\"\ngem \"unicorn\"\ngem \"sidekiq\"\ngem \"redis\"\n```\n\napp.rb\n\n```rb\nrequire \"sinatra\"\nrequire \"json\"\nrequire \"redis\"\n\nclass App < Sinatra::Base\n\n    @@redis = Redis.new(:url => \"redis://localhost/10\")\n    get '/' do\n        content_type :json\n        all = {}\n        @@redis.keys.each {|k| \n            all[k] = @@redis.get(k)\n        }\n        all.to_json\n    end\n\n    post '/' do\n        d = params[:x]\n        # \u3068\u3066\u3082\u91cd\u3044\u51e6\u7406\u3092\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306eQueue\u306b\u4efb\u305b\u308b\n        Worker.perform_async(d)\n        content_type :json\n        res = {\n            result: \"ok\"\n        }\n        res.to_json\n    end\nend\n```\n\nconfig.ru\n\n```rb\nrequire \"./app.rb\"\nrequire \"./Worker.rb\"\nrequire \"sidekiq\"\nrequire 'sidekiq/web'\n\nSidekiq.configure_server do |config|\n    config.redis = { url: 'redis://localhost:6379', namespace: 'sidekiq' }\nend\n\nrun Rack::URLMap.new('/' => App, '/sidekiq' => Sidekiq::Web)\n```\n\nunicorn.rb\n\n```rb\n@dir = \"./\"\n\nworker_processes 2\nworking_directory @dir\n\ntimeout 300\nlisten 8081\n\nstderr_path \"#{@dir}log/unicorn.stderr.log\"\nstdout_path \"#{@dir}log/unicorn.stdout.log\"\n```\n\n\u8d77\u52d5\u30b3\u30de\u30f3\u30c9\n\n```zsh\n$bundle exec unicorn -c unicorn.rb\n...\n\n#\u5225\u30bf\u30fc\u30df\u30ca\u30eb\u3067\n$curl -i localhost:8081\nHTTP/1.1 200 OK\nDate: Mon, 19 Sep 2016 09:43:35 GMT\nConnection: close\nContent-Type: application/json\nContent-Length: 2\nX-Content-Type-Options: nosniff\n\n{}%\n\n# \u30c0\u30df\u30fc\u306e\u91cd\u3044\u51e6\u7406\u3092\u8d77\u52d5\u3059\u308b\u30b3\u30de\u30f3\u30c9\n# worker\u3092\u52d5\u304b\u3057\u3066\u3044\u306a\u3044\u306e\u3067\u51e6\u7406\u3055\u308c\u307e\u305b\u3093\u304c\u3053\u306e\u5b9f\u884c\u5f8c\u306b\u30ad\u30e5\u30fc\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u6e9c\u307e\u308b\u611f\u3058\u3067\u3059\n$curl -i -X POST localhost:8081 -d 'x=hoge'\nHTTP/1.1 200 OK\nDate: Mon, 19 Sep 2016 09:43:38 GMT\nConnection: close\nContent-Type: application/json\nContent-Length: 15\nX-Content-Type-Options: nosniff\n\n{\"result\":\"ok\"}%\n\n$cat log/unicorn.stderr.log\nI, [2016-09-19T18:39:36.673794 #41193]  INFO -- : listening on addr=0.0.0.0:8081 fd=9\nI, [2016-09-19T18:39:36.673899 #41193]  INFO -- : worker=0 spawning...\nI, [2016-09-19T18:39:36.674996 #41193]  INFO -- : worker=1 spawning...\nI, [2016-09-19T18:39:36.675474 #41193]  INFO -- : master process ready\nI, [2016-09-19T18:39:36.676282 #41194]  INFO -- : worker=0 spawned pid=41194\nI, [2016-09-19T18:39:36.676482 #41195]  INFO -- : worker=1 spawned pid=41195\nI, [2016-09-19T18:39:36.676773 #41194]  INFO -- : Refreshing Gem list\nI, [2016-09-19T18:39:36.676799 #41195]  INFO -- : Refreshing Gem list\nI, [2016-09-19T18:39:36.806327 #41194]  INFO -- : worker=0 ready\nI, [2016-09-19T18:39:36.806394 #41195]  INFO -- : worker=1 ready\n127.0.0.1 - - [19/Sep/2016:18:39:39 +0900] \"GET / HTTP/1.1\" 200 2 0.0081\n127.0.0.1 - - [19/Sep/2016:18:39:40 +0900] \"POST / HTTP/1.1\" 200 15 0.0089\nI, [2016-09-19T18:39:42.898632 #41193]  INFO -- : reaped #<Process::Status: pid 41195 exit 0> worker=1\nI, [2016-09-19T18:39:42.898718 #41193]  INFO -- : reaped #<Process::Status: pid 41194 exit 0> worker=0\nI, [2016-09-19T18:39:42.898984 #41193]  INFO -- : master complete\n```\n\n\u3064\u3044\u3067\u306bsidekiq\u306eWeb UI\u3082\u3042\u308b\u3089\u3057\u304f\u3001\u8ffd\u52a0\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n`localhost:8081/sidekiq/` \u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u898b\u308c\u307e\u3059\u3002\n`localhost:8081/sidekiq` \u3060\u3068\u898b\u308c\u306a\u3044\u306e\u3067\u6ce8\u610f\u3067\u3059\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-09-19 18.46.26.png](https://qiita-image-store.s3.amazonaws.com/0/8279/39a4d0d3-57ba-382d-2337-bf97a6c2b1f4.png)\n\n\u4fbf\u5229\u305d\u3046\n\n# Worker\u306e\u6e96\u5099\n\nworker\u5074\u306f\u5b9f\u88c5\u66f8\u3044\u3066\u5b9f\u884c\u3059\u308b\u3060\u3051\u3067\u3059\u3002\n\nWorker.rb\n\n```rb\nrequire \"redis\"\nrequire \"sidekiq\"\n\nclass Worker\n    include Sidekiq::Worker\n    sidekiq_options queue: :event\n    @@redis = Redis.new(:url => \"redis://localhost/10\")\n\n    def perform(key)\n        sleep(2)\n        # \u307b\u3093\u3068\u306f\u91cd\u3044SQL\u3092\u767a\u884c\u3057\u305f\u308a\u3057\u3066MySQL\u306b\u66f8\u304d\u8fbc\u3093\u3060\u308a\u3059\u308b\u3082\u306e\u3092\u60f3\u5b9a\n        @@redis.set(key, true)\n    end\nend\n```\n\n\u5f8c\u306f\u5b9f\u884c\u3060\u3051\u3067\u3059\u3002\n\u30ed\u30b0\u306b\u51e6\u7406\u7d50\u679c\u304c\u6d41\u308c\u305f\u308a\u3059\u308b\u306e\u3067\u308f\u304b\u308a\u3084\u3059\u3044\u3067\u3059\u3002\n\n```zsh\n$bundle exec sidekiq -r ./Worker.rb -q event\n\n\n         m,\n         `$b\n    .ss,  $$:         .,d$\n    `$$P,d$P'    .,md$P\"'\n     ,$$$$$bmmd$$$P^'\n   .d$$$$$$$$$$P'\n   $$^' `\"^$$$'       ____  _     _      _    _\n   $:     ,$$:       / ___|(_) __| | ___| | _(_) __ _\n   `b     :$$        \\___ \\| |/ _` |/ _ \\ |/ / |/ _` |\n          $$:         ___) | | (_| |  __/   <| | (_| |\n          $$         |____/|_|\\__,_|\\___|_|\\_\\_|\\__, |\n        .d$$                                       |_|\n\n2016-09-19T09:52:15.738Z 41994 TID-owno79hy0 INFO: Running in ruby 2.3.0p0 (2015-12-25 revision 53290) [x86_64-darwin14]\n2016-09-19T09:52:15.738Z 41994 TID-owno79hy0 INFO: See LICENSE and the LGPL-3.0 for licensing details.\n2016-09-19T09:52:15.738Z 41994 TID-owno79hy0 INFO: Upgrade to Sidekiq Pro for more features and support: http://sidekiq.org\n2016-09-19T09:52:15.738Z 41994 TID-owno79hy0 INFO: Booting Sidekiq 4.2.1 with redis options {:url=>nil}\n2016-09-19T09:52:15.751Z 41994 TID-owno79hy0 INFO: Starting processing, hit Ctrl-C to stop\n2016-09-19T09:52:16.154Z 41994 TID-owno4qck0 Worker JID-a8ac5c4dfe50040b51b8a825 INFO: start\n2016-09-19T09:52:16.156Z 41994 TID-owno4qamk Worker JID-c369a462be8d818d9d13b4e5 INFO: start\n2016-09-19T09:52:16.157Z 41994 TID-owno4qawk Worker JID-ef961372d2ac86b215db3d07 INFO: start\n2016-09-19T09:52:18.160Z 41994 TID-owno4qck0 Worker JID-a8ac5c4dfe50040b51b8a825 INFO: done: 2.006 sec\n2016-09-19T09:52:18.160Z 41994 TID-owno4qamk Worker JID-c369a462be8d818d9d13b4e5 INFO: done: 2.004 sec\n2016-09-19T09:52:18.160Z 41994 TID-owno4qawk Worker JID-ef961372d2ac86b215db3d07 INFO: done: 2.004 sec\n```\n\n# \u307e\u3068\u3081\n\n- sidekiq\u4fbf\u5229\u305d\u3046\n- UI\u304d\u308c\u3044\n", "tags": ["Ruby", "sidekiq"]}