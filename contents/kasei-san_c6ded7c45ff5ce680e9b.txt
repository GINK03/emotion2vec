{"tags": ["Rails4", "\u30ea\u30d5\u30a1\u30af\u30bf\u30ea\u30f3\u30b0"], "context": "\u9700\u8981\u304c\u3042\u308a\u305d\u3046\u306a\u5272\u306b\u3084\u308a\u65b9\u304c\u3069\u3053\u306b\u3082\u306a\u304b\u3063\u305f\u306e\u3067\u30e1\u30e2\n\n\u3069\u3093\u306a\u3068\u304d\u306b\u6709\u52b9?\n\n\u5f8c\u304b\u3089\u3001\u5171\u901a\u306e\u5b50\u3092\u6301\u3064\u89aamodel\u304c\u5fc5\u8981\u306b\u306a\u3063\u305f\u3068\u304d\n\n\n\u4f8b\n\n\u89aa\u5b50\u95a2\u4fc2(has_one)\u306b\u3042\u308b User model\u3068Profile model\u304c\u3042\u308b\n\u3053\u308c\u3092\u30dd\u30ea\u30e2\u30fc\u30d5\u30a3\u30c3\u30af\u95a2\u9023\u306b\u5909\u66f4\u3057\u3066\u3001\u65b0\u3057\u3044\u89aamodel Shop\u3092\u8ffd\u52a0\u3057\u305f\u3044\n\n\n\u73fe\u72b6\u306e\u30b3\u30fc\u30c9\n\napp/models/user.rb\nclass User < ActiveRecord::Base\n  has_one :profile\n  accepts_nested_attributes_for :profile\nend\n\n\n\napp/models/profile.rb\nclass Profile < ActiveRecord::Base\n  belongs_to :user\nend\n\n\n\n\u624b\u9806\n\nprofile model \u306e after_save \u3067\u30dd\u30ea\u30e2\u30fc\u30d5\u30a3\u30c3\u30af\u95a2\u9023\u306e\u30ab\u30e9\u30e0\u3092\u66f4\u65b0\u3059\u308b\u51e6\u7406\u3092\u8ffd\u52a0\nprofile\u30c6\u30fc\u30d6\u30eb\u306b\u3001\u30dd\u30ea\u30e2\u30fc\u30d5\u30a3\u30c3\u30af\u95a2\u9023\u306e\u30ab\u30e9\u30e0\u3092\u8ffd\u52a0\nuser, profile model \u306e\u95a2\u9023\u3092\u30dd\u30ea\u30e2\u30fc\u30d5\u30a3\u30c3\u30af\u95a2\u9023\u306b\u5909\u66f4\nprofile\u30c6\u30fc\u30d6\u30eb\u304b\u3089\u3001user_id \u30ab\u30e9\u30e0\u3092\u524a\u9664\n\n\n1. profile model \u306e after_save \u3067\u30dd\u30ea\u30e2\u30fc\u30d5\u30a3\u30c3\u30af\u95a2\u9023\u306e\u30ab\u30e9\u30e0\u3092\u66f4\u65b0\u3059\u308b\u51e6\u7406\u3092\u8ffd\u52a0\n\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u3059\u308b\u524d\u306b\u4e88\u3081\u8ffd\u52a0\u3059\u308b\u3053\u3068\u3067\u3001\n\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u76f4\u5f8c\u304b\u3089\u3001\u30dd\u30ea\u30e2\u30fc\u30d5\u30a3\u30c3\u30af\u95a2\u9023\u306e\u30ab\u30e9\u30e0\u304c\u66f4\u65b0\u3055\u308c\u308b\u3088\u3046\u306b\u3059\u308b\n\napp/models/profile.rb\n class Profile < ActiveRecord::Base\n   belongs_to :user\n\n   before_save :set_profilable_id\n\n   def set_profilable_id\n     if self.has_attribute?(:profilable_id)\n       self.profilable_id   = self.user_id\n       self.profilable_type = 'User'\n     end\n   end\n end\n\n\n\n\u3053\u306e\u6642\u70b9\u3067\u306e\u30c6\u30fc\u30d6\u30eb\nsqlite> select * from users;\nid          name        created_at                  updated_at\n----------  ----------  --------------------------  --------------------------\n1           1           2016-06-25 16:51:53.577972  2016-06-25 16:51:53.577972\nsqlite> select * from profiles;\nid          user_id     description  created_at                  updated_at\n----------  ----------  -----------  --------------------------  --------------------------\n1           1           1            2016-06-25 16:51:53.586769  2016-06-25 16:51:53.586769\n\n\n2. profile\u30c6\u30fc\u30d6\u30eb\u306b\u3001\u30dd\u30ea\u30e2\u30fc\u30d5\u30a3\u30c3\u30af\u95a2\u9023\u306e\u30ab\u30e9\u30e0\u3092\u8ffd\u52a0\n\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u5185\u3067\u3001\u65e2\u5b58\u306e\u30c6\u30fc\u30d6\u30eb\u306e\u30dd\u30ea\u30e2\u30fc\u30d5\u30a3\u30c3\u30af\u95a2\u9023\u3092\u66f4\u65b0\u3057\u3066\u304a\u304f\nclass AddReferenceOnProfile < ActiveRecord::Migration\n  def up\n    add_reference :profiles, :profilable, polymorphic: true, index: true\n\n    Profile.all.each do |profile|\n      if profile.user\n        user = profile.user\n        profile.profilable_id   = user.id\n        profile.profilable_type = user.class.to_s\n        profile.save!\n      end\n    end\n  end\n\n  def down\n    remove_reference :profiles, :profilable, polymorphic: true, index: true\n  end\nend\n\n\n\u3053\u306e\u6642\u70b9\u3067\u306e\u30c6\u30fc\u30d6\u30eb\n\n\u30dd\u30ea\u30e2\u30fc\u30d5\u30a3\u30c3\u30af\u95a2\u9023\u7528\u306e\u30ab\u30e9\u30e0 profilable_id profilable_type \u304c\u8ffd\u52a0\n\u305d\u308c\u3089\u306b\u5fc5\u8981\u306a\u5024\u304c\u683c\u7d0d\u3055\u308c\u3066\u3044\u308b\n\n\n\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u6642\n\u8ffd\u52a0/\u66f4\u65b0\u6642 \n\n\n\nprofile.id \u306e\u5024\u304c\u304a\u304b\u3057\u3044\u306e\u306f\u3001accepts_nested_attributes_for :profile\n \u3057\u3066\u3044\u308b\u306e\u306b\u3001 params.require(:user).permit \u306b profile_id \u3092\u8ffd\u52a0\u3057\u5fd8\u308c\u305f\u305f\u3081...\n\nsqlite> select * from users;\nid          name        created_at                  updated_at\n----------  ----------  --------------------------  --------------------------\n1           1           2016-06-25 16:51:53.577972  2016-06-25 16:51:53.577972\n2           2           2016-06-25 16:53:32.988076  2016-06-25 16:53:32.988076\nsqlite> select * from profiles;\nid          user_id     description  created_at                  updated_at                  profilable_id  profilable_type\n----------  ----------  -----------  --------------------------  --------------------------  -------------  ---------------\n3           1           1            2016-06-25 16:53:27.580845  2016-06-25 16:53:27.580845  1              User\n4           2           2            2016-06-25 16:53:32.990474  2016-06-25 16:53:32.990474  2              User\n\n\n3. user, profile model \u306e\u95a2\u9023\u3092\u30dd\u30ea\u30e2\u30fc\u30d5\u30a3\u30c3\u30af\u95a2\u9023\u306b\u5909\u66f4\n\napp/models/user.rb\nclass User < ActiveRecord::Base\n  has_one :profile, :as => :profilable\n  accepts_nested_attributes_for :profile\nend\n\n\n\napp/models/profile.rb\nclass Profile < ActiveRecord::Base\n  belongs_to :profilable, polymorphic: true\nend\n\n\nform \u306e profile \u306b profilable_id \u3092\u8ffd\u52a0\n\napp/views/users/_form.html.erb\n  <div class=\"field\">\n    <%= f.label :name %><br>\n    <%= f.text_field :name %>\n  </div>\n  <div class=\"field\">\n    <%= f.fields_for :profile, @user.profile do |p| %>\n      <%= p.hidden_field :profilable_id, value: @user.profile.profilable_id %><br>\n      <%= p.label :description %><br>\n      <%= p.text_field :description %>\n    <% end %>\n  </div>\n\n\n\napp/controllers/users_controller.rb\n    def user_params\n      params.require(:user).permit(:name, profile_attributes: %i[description profilable_id id])\n    end\n\n\n\n4. profile\u30c6\u30fc\u30d6\u30eb\u304b\u3089\u3001user_id \u30ab\u30e9\u30e0\u3092\u524a\u9664\nclass RemoveUserIdColumnOnProfile < ActiveRecord::Migration\n  def change\n    remove_column :profiles, :user_id\n  end\nend\n\n\n\u30b3\u30fc\u30c9\nhttps://github.com/kasei-san/refactor_to_polymorphic\n\u9700\u8981\u304c\u3042\u308a\u305d\u3046\u306a\u5272\u306b\u3084\u308a\u65b9\u304c\u3069\u3053\u306b\u3082\u306a\u304b\u3063\u305f\u306e\u3067\u30e1\u30e2\n\n# \u3069\u3093\u306a\u3068\u304d\u306b\u6709\u52b9?\n\n- \u5f8c\u304b\u3089\u3001\u5171\u901a\u306e\u5b50\u3092\u6301\u3064\u89aamodel\u304c\u5fc5\u8981\u306b\u306a\u3063\u305f\u3068\u304d\n\n\n# \u4f8b\n\n- \u89aa\u5b50\u95a2\u4fc2(has_one)\u306b\u3042\u308b User model\u3068Profile model\u304c\u3042\u308b\n- \u3053\u308c\u3092\u30dd\u30ea\u30e2\u30fc\u30d5\u30a3\u30c3\u30af\u95a2\u9023\u306b\u5909\u66f4\u3057\u3066\u3001\u65b0\u3057\u3044\u89aamodel Shop\u3092\u8ffd\u52a0\u3057\u305f\u3044\n\n# \u73fe\u72b6\u306e\u30b3\u30fc\u30c9\n\n```app/models/user.rb\nclass User < ActiveRecord::Base\n  has_one :profile\n  accepts_nested_attributes_for :profile\nend\n```\n\n```app/models/profile.rb\nclass Profile < ActiveRecord::Base\n  belongs_to :user\nend\n```\n\n# \u624b\u9806\n\n1. profile model \u306e after_save \u3067\u30dd\u30ea\u30e2\u30fc\u30d5\u30a3\u30c3\u30af\u95a2\u9023\u306e\u30ab\u30e9\u30e0\u3092\u66f4\u65b0\u3059\u308b\u51e6\u7406\u3092\u8ffd\u52a0\n2. profile\u30c6\u30fc\u30d6\u30eb\u306b\u3001\u30dd\u30ea\u30e2\u30fc\u30d5\u30a3\u30c3\u30af\u95a2\u9023\u306e\u30ab\u30e9\u30e0\u3092\u8ffd\u52a0\n3. user, profile model \u306e\u95a2\u9023\u3092\u30dd\u30ea\u30e2\u30fc\u30d5\u30a3\u30c3\u30af\u95a2\u9023\u306b\u5909\u66f4\n4. profile\u30c6\u30fc\u30d6\u30eb\u304b\u3089\u3001user_id \u30ab\u30e9\u30e0\u3092\u524a\u9664\n\n# 1. profile model \u306e after_save \u3067\u30dd\u30ea\u30e2\u30fc\u30d5\u30a3\u30c3\u30af\u95a2\u9023\u306e\u30ab\u30e9\u30e0\u3092\u66f4\u65b0\u3059\u308b\u51e6\u7406\u3092\u8ffd\u52a0\n\n\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u3059\u308b\u524d\u306b\u4e88\u3081\u8ffd\u52a0\u3059\u308b\u3053\u3068\u3067\u3001\n\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u76f4\u5f8c\u304b\u3089\u3001\u30dd\u30ea\u30e2\u30fc\u30d5\u30a3\u30c3\u30af\u95a2\u9023\u306e\u30ab\u30e9\u30e0\u304c\u66f4\u65b0\u3055\u308c\u308b\u3088\u3046\u306b\u3059\u308b\n\n```app/models/profile.rb\n class Profile < ActiveRecord::Base\n   belongs_to :user\n \n   before_save :set_profilable_id\n \n   def set_profilable_id\n     if self.has_attribute?(:profilable_id)\n       self.profilable_id   = self.user_id\n       self.profilable_type = 'User'\n     end\n   end\n end\n```\n\n## \u3053\u306e\u6642\u70b9\u3067\u306e\u30c6\u30fc\u30d6\u30eb\n\n```\nsqlite> select * from users;\nid          name        created_at                  updated_at\n----------  ----------  --------------------------  --------------------------\n1           1           2016-06-25 16:51:53.577972  2016-06-25 16:51:53.577972\nsqlite> select * from profiles;\nid          user_id     description  created_at                  updated_at\n----------  ----------  -----------  --------------------------  --------------------------\n1           1           1            2016-06-25 16:51:53.586769  2016-06-25 16:51:53.586769\n```\n\n# 2. profile\u30c6\u30fc\u30d6\u30eb\u306b\u3001\u30dd\u30ea\u30e2\u30fc\u30d5\u30a3\u30c3\u30af\u95a2\u9023\u306e\u30ab\u30e9\u30e0\u3092\u8ffd\u52a0\n\n\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u5185\u3067\u3001\u65e2\u5b58\u306e\u30c6\u30fc\u30d6\u30eb\u306e\u30dd\u30ea\u30e2\u30fc\u30d5\u30a3\u30c3\u30af\u95a2\u9023\u3092\u66f4\u65b0\u3057\u3066\u304a\u304f\n\n```\nclass AddReferenceOnProfile < ActiveRecord::Migration\n  def up\n    add_reference :profiles, :profilable, polymorphic: true, index: true\n\n    Profile.all.each do |profile|\n      if profile.user\n        user = profile.user\n        profile.profilable_id   = user.id\n        profile.profilable_type = user.class.to_s\n        profile.save!\n      end\n    end\n  end\n\n  def down\n    remove_reference :profiles, :profilable, polymorphic: true, index: true\n  end\nend\n```\n\n## \u3053\u306e\u6642\u70b9\u3067\u306e\u30c6\u30fc\u30d6\u30eb\n\n- \u30dd\u30ea\u30e2\u30fc\u30d5\u30a3\u30c3\u30af\u95a2\u9023\u7528\u306e\u30ab\u30e9\u30e0 `profilable_id` `profilable_type` \u304c\u8ffd\u52a0\n- \u305d\u308c\u3089\u306b\u5fc5\u8981\u306a\u5024\u304c\u683c\u7d0d\u3055\u308c\u3066\u3044\u308b\n    - \u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u6642\n    - \u8ffd\u52a0/\u66f4\u65b0\u6642 \n- `profile.id` \u306e\u5024\u304c\u304a\u304b\u3057\u3044\u306e\u306f\u3001`accepts_nested_attributes_for :profile\n` \u3057\u3066\u3044\u308b\u306e\u306b\u3001 `params.require(:user).permit` \u306b `profile_id` \u3092\u8ffd\u52a0\u3057\u5fd8\u308c\u305f\u305f\u3081...\n\n```\nsqlite> select * from users;\nid          name        created_at                  updated_at\n----------  ----------  --------------------------  --------------------------\n1           1           2016-06-25 16:51:53.577972  2016-06-25 16:51:53.577972\n2           2           2016-06-25 16:53:32.988076  2016-06-25 16:53:32.988076\nsqlite> select * from profiles;\nid          user_id     description  created_at                  updated_at                  profilable_id  profilable_type\n----------  ----------  -----------  --------------------------  --------------------------  -------------  ---------------\n3           1           1            2016-06-25 16:53:27.580845  2016-06-25 16:53:27.580845  1              User\n4           2           2            2016-06-25 16:53:32.990474  2016-06-25 16:53:32.990474  2              User\n```\n\n# 3. user, profile model \u306e\u95a2\u9023\u3092\u30dd\u30ea\u30e2\u30fc\u30d5\u30a3\u30c3\u30af\u95a2\u9023\u306b\u5909\u66f4\n\n```app/models/user.rb\nclass User < ActiveRecord::Base\n  has_one :profile, :as => :profilable\n  accepts_nested_attributes_for :profile\nend\n```\n\n```app/models/profile.rb\nclass Profile < ActiveRecord::Base\n  belongs_to :profilable, polymorphic: true\nend\n```\n\nform \u306e profile \u306b `profilable_id` \u3092\u8ffd\u52a0\n\n``` app/views/users/_form.html.erb \n  <div class=\"field\">\n    <%= f.label :name %><br>\n    <%= f.text_field :name %>\n  </div>\n  <div class=\"field\">\n    <%= f.fields_for :profile, @user.profile do |p| %>\n      <%= p.hidden_field :profilable_id, value: @user.profile.profilable_id %><br>\n      <%= p.label :description %><br>\n      <%= p.text_field :description %>\n    <% end %>\n  </div>\n```\n\n```app/controllers/users_controller.rb\n    def user_params\n      params.require(:user).permit(:name, profile_attributes: %i[description profilable_id id])\n    end\n```\n\n# 4. profile\u30c6\u30fc\u30d6\u30eb\u304b\u3089\u3001user_id \u30ab\u30e9\u30e0\u3092\u524a\u9664\n\n```\nclass RemoveUserIdColumnOnProfile < ActiveRecord::Migration\n  def change\n    remove_column :profiles, :user_id\n  end\nend\n```\n\n# \u30b3\u30fc\u30c9\n\nhttps://github.com/kasei-san/refactor_to_polymorphic\n"}