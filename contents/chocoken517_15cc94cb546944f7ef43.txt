{"context": " More than 1 year has passed since last update.\n\n\u8aac\u660e\u3067\u4f7f\u7528\u3059\u308b\u30c6\u30fc\u30d6\u30eb\u306eER\u56f3\n\n\nthrough(\u591a\u5bfe\u591a\u95a2\u9023)\nclass Hoge < ActiveRecord::Base\n  has_many :hoge_categories\n  has_many :categories, through: :hoge_categories\nend\n\nclass HogeCategory < ActiveRecord::Base\n  belongs_to :hoge\n  belongs_to :category\nend\n\nclass Category < ActiveRecord::Base\n  has_many :hoge_categories\n  has_many :hoges, through: :hoge_categories\nend\n\n\u5b9f\u88c5\u4f8b\n[1] pry(main)> Category.find_by(id: 1).hoges\n  Category Load (0.3ms)  SELECT  `categories`.* FROM `categories` WHERE `categories`.`id` = 1 LIMIT 1\n\n  Hoge Load (0.3ms)  SELECT `hoges`.* FROM `hoges` INNER JOIN `hoge_categories` ON `hoges`.`id` = `hoge_categories`.`hoge_id` WHERE `hoge_categories`.`category_id` = 1\n\n=> [#<Hoge:0x007fad7b5006d8 id: 1, name: \"hogehoge\", status: 0, created_at: Thu, 26 Nov 2015 10:14:41 JST +09:00, updated_at: Thu, 26 Nov 2015 10:14:41 JST +09:00>]\n\n\n\nenum\nclass Hoge < ActiveRecord::Base\n  has_many :hoge_categories\n  has_many :categories, through: :hoge_categories\n\n  enum status: {\n           display: 0,\n           hide: 1,\n       }\nend\n\nstatus\u304c0\u306e\u60c5\u5831\u3092\u53d6\u5f97\n[1] pry(main)> Hoge.display\n  Hoge Load (0.4ms)  SELECT `hoges`.* FROM `hoges` WHERE `hoges`.`status` = 0\n\nkey + ? \n[1] pry(main)> Category.find_by(id: 1).hoges\n  Category Load (0.3ms)  SELECT  `categories`.* FROM `categories` WHERE `categories`.`id` = 1 LIMIT 1\n  Hoge Load (0.4ms)  SELECT `hoges`.* FROM `hoges` INNER JOIN `hoge_categories` ON `hoges`.`id` = `hoge_categories`.`hoge_id` WHERE `hoge_categories`.`category_id` = 1\n\n=> [#<Hoge:0x007fce0797b508 id: 1, name: \"hogehoge\", status: 1, created_at: Thu, 26 Nov 2015 15:47:52 JST +09:00, updated_at: Thu, 26 Nov 2015 15:47:52 JST +09:00>,\n #<Hoge:0x007fce0797b300 id: 2, name: \"hogehoge2\", status: 0, created_at: Thu, 26 Nov 2015 15:53:35 JST +09:00, updated_at: Thu, 26 Nov 2015 15:53:35 JST +09:00>]\n\n\u2191 \u306e\u7d50\u679c\u304b\u3089 select(&:hide?) \u3067\u3001status\u304c1\u306e\u60c5\u5831\u306b\u7d5e\u308b\n\n[2] pry(main)> Category.find_by(id: 1).hoges.select(&:hide?)\n  Category Load (0.3ms)  SELECT  `categories`.* FROM `categories` WHERE `categories`.`id` = 1 LIMIT 1\n  Hoge Load (0.3ms)  SELECT `hoges`.* FROM `hoges` INNER JOIN `hoge_categories` ON `hoges`.`id` = `hoge_categories`.`hoge_id` WHERE `hoge_categories`.`category_id` = 1\n\n=> [#<Hoge:0x007fce07a94e30 id: 1, name: \"hogehoge\", status: 1, created_at: Thu, 26 Nov 2015 15:47:52 JST +09:00, updated_at: Thu, 26 Nov 2015 15:47:52 JST +09:00>]\n\n\n\n\njoins\n[1] pry(main)> Preset.joins(:category)\n  Preset Load (0.3ms)  SELECT `presets`.* FROM `presets` INNER JOIN `categories` ON `categories`.`id` = `presets`.`category_id`\n\n\u8907\u6570\u306ejoins\n[1] pry(main)>  Preset.joins(category: [hoge_categories: :hoge])\n  Preset Load (0.3ms)  SELECT `presets`.* FROM `presets` INNER JOIN `categories` ON `categories`.`id` = `presets`.`category_id` INNER JOIN `hoge_categories` ON `hoge_categories`.`category_id` = `categories`.`id` INNER JOIN `hoges` ON `hoges`.`id` = `hoge_categories`.`hoge_id`\n\n\u2191 \u306fthrough\u3057\u3066\u3044\u308b\u306e\u3067\u2193\u3067\u3044\u3051\u307e\u3059\u3002\n[2] pry(main)> Preset.joins(category: :hoges)\n  Preset Load (0.3ms)  SELECT `presets`.* FROM `presets` INNER JOIN `categories` ON `categories`.`id` = `presets`.`category_id` INNER JOIN `hoge_categories` ON `hoge_categories`.`category_id` = `categories`.`id` INNER JOIN `hoges` ON `hoges`.`id` = `hoge_categories`.`hoge_id`\n\n\u8907\u6570joins\u306ewhere\n[15] pry(main)> Preset.joins(category: :hoges).where(hoges: { name: 'hogehoge' })\n  Preset Load (0.5ms)  SELECT `presets`.* FROM `presets` INNER JOIN `categories` ON `categories`.`id` = `presets`.`category_id` INNER JOIN `hoge_categories` ON `hoge_categories`.`category_id` = `categories`.`id` INNER JOIN `hoges` ON `hoges`.`id` = `hoge_categories`.`hoge_id` WHERE `hoges`.`name` = 'hogehoge'\n\n\nscope\nclass Preset < ActiveRecord::Base\n  belongs_to :category, required: true\n\n  scope :hoges, -> { joins(category: :hoges) }\nend\n\nclass Category < ActiveRecord::Base\n  has_many :hoge_categories\n  has_many :hoges, through: :hoge_categories\n\n  scope :by_group_type, ->(group_type) { where(group_type: group_type) } \nend\n\n[1] pry(main)> Category.by_group_type(1)\n  Category Load (0.3ms)  SELECT `categories`.* FROM `categories` WHERE `categories`.`group_type` = 1\n\nmerge\n[1] pry(main)> Preset.hoges.merge(Category.by_group_type(1))\n  Preset Load (0.5ms)  SELECT `presets`.* FROM `presets` INNER JOIN `categories` ON `categories`.`id` = `presets`.`category_id` INNER JOIN `hoge_categories` ON `hoge_categories`.`category_id` = `categories`.`id` INNER JOIN `hoges` ON `hoges`.`id` = `hoge_categories`.`hoge_id` WHERE `categories`.`group_type` = 1\n\n\n\u751fSQL\nsql = \"select * from categories where name = 'hogehoge' and group_type = 1\"\n\nActiveRecord::Base.connection.select_all(sql)\n\n\u30a8\u30b9\u30b1\u30fc\u30d7\u51e6\u7406\u3055\u305b\u308b\u5834\u5408\nsql = 'select * from categories where name = ? and group_type = ?'\n\nsanitize_sql = ActiveRecord::Base.send(:sanitize_sql_array, [sql, 'hogehoge', 1])\n\nActiveRecord::Base.connection.select_all(sanitize_sql)\n\n\narel_table\nclass Preset < ActiveRecord::Base\n  belongs_to :category, required: true\n\n  scope :hoges, -> { joins(category: :hoges) }\n\n  scope :preset_ids, lambda { |job_id, employ_id|\n     where((arel_table[:job_id].eq(job_id).or(arel_table[:job_id].eq(nil)))\n            .and(arel_table[:employ_id].eq(employ_id).or(arel_table[:employ_id].eq(nil))))\n   }\nend\n\nscope\u3092\u5b9f\u884c\n[1] pry(main)> Preset.preset_ids(1,1)\n  Preset Load (0.3ms)  SELECT `presets`.* FROM `presets` WHERE ((`presets`.`job_id` = 1 OR `presets`.`job_id` IS NULL) AND (`presets`.`employ_id` = 1 OR `presets`.`employ_id` IS NULL))\n\n\n## \u8aac\u660e\u3067\u4f7f\u7528\u3059\u308b\u30c6\u30fc\u30d6\u30eb\u306eER\u56f3\n\n<img width=\"795\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2015-11-26 12.23.24.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/94772/144b9357-c5f4-6ecb-07c7-e82ba3240725.png\">\n\n\n## through(\u591a\u5bfe\u591a\u95a2\u9023)\n\n```\nclass Hoge < ActiveRecord::Base\n  has_many :hoge_categories\n  has_many :categories, through: :hoge_categories\nend\n\nclass HogeCategory < ActiveRecord::Base\n  belongs_to :hoge\n  belongs_to :category\nend\n\nclass Category < ActiveRecord::Base\n  has_many :hoge_categories\n  has_many :hoges, through: :hoge_categories\nend\n```\n\n\u5b9f\u88c5\u4f8b\n\n```\n[1] pry(main)> Category.find_by(id: 1).hoges\n  Category Load (0.3ms)  SELECT  `categories`.* FROM `categories` WHERE `categories`.`id` = 1 LIMIT 1\n\n  Hoge Load (0.3ms)  SELECT `hoges`.* FROM `hoges` INNER JOIN `hoge_categories` ON `hoges`.`id` = `hoge_categories`.`hoge_id` WHERE `hoge_categories`.`category_id` = 1\n\n=> [#<Hoge:0x007fad7b5006d8 id: 1, name: \"hogehoge\", status: 0, created_at: Thu, 26 Nov 2015 10:14:41 JST +09:00, updated_at: Thu, 26 Nov 2015 10:14:41 JST +09:00>]\n\n```\n\n\n## enum\n\n```\nclass Hoge < ActiveRecord::Base\n  has_many :hoge_categories\n  has_many :categories, through: :hoge_categories\n\n  enum status: {\n           display: 0,\n           hide: 1,\n       }\nend\n```\n\nstatus\u304c0\u306e\u60c5\u5831\u3092\u53d6\u5f97\n\n```\n[1] pry(main)> Hoge.display\n  Hoge Load (0.4ms)  SELECT `hoges`.* FROM `hoges` WHERE `hoges`.`status` = 0\n```\n\nkey + ? \n\n```\n[1] pry(main)> Category.find_by(id: 1).hoges\n  Category Load (0.3ms)  SELECT  `categories`.* FROM `categories` WHERE `categories`.`id` = 1 LIMIT 1\n  Hoge Load (0.4ms)  SELECT `hoges`.* FROM `hoges` INNER JOIN `hoge_categories` ON `hoges`.`id` = `hoge_categories`.`hoge_id` WHERE `hoge_categories`.`category_id` = 1\n\n=> [#<Hoge:0x007fce0797b508 id: 1, name: \"hogehoge\", status: 1, created_at: Thu, 26 Nov 2015 15:47:52 JST +09:00, updated_at: Thu, 26 Nov 2015 15:47:52 JST +09:00>,\n #<Hoge:0x007fce0797b300 id: 2, name: \"hogehoge2\", status: 0, created_at: Thu, 26 Nov 2015 15:53:35 JST +09:00, updated_at: Thu, 26 Nov 2015 15:53:35 JST +09:00>]\n\n\u2191 \u306e\u7d50\u679c\u304b\u3089 select(&:hide?) \u3067\u3001status\u304c1\u306e\u60c5\u5831\u306b\u7d5e\u308b\n\n[2] pry(main)> Category.find_by(id: 1).hoges.select(&:hide?)\n  Category Load (0.3ms)  SELECT  `categories`.* FROM `categories` WHERE `categories`.`id` = 1 LIMIT 1\n  Hoge Load (0.3ms)  SELECT `hoges`.* FROM `hoges` INNER JOIN `hoge_categories` ON `hoges`.`id` = `hoge_categories`.`hoge_id` WHERE `hoge_categories`.`category_id` = 1\n\n=> [#<Hoge:0x007fce07a94e30 id: 1, name: \"hogehoge\", status: 1, created_at: Thu, 26 Nov 2015 15:47:52 JST +09:00, updated_at: Thu, 26 Nov 2015 15:47:52 JST +09:00>]\n\n\n```\n\n## joins\n```\n[1] pry(main)> Preset.joins(:category)\n  Preset Load (0.3ms)  SELECT `presets`.* FROM `presets` INNER JOIN `categories` ON `categories`.`id` = `presets`.`category_id`\n```\n\n\u8907\u6570\u306ejoins\n\n```\n[1] pry(main)>  Preset.joins(category: [hoge_categories: :hoge])\n  Preset Load (0.3ms)  SELECT `presets`.* FROM `presets` INNER JOIN `categories` ON `categories`.`id` = `presets`.`category_id` INNER JOIN `hoge_categories` ON `hoge_categories`.`category_id` = `categories`.`id` INNER JOIN `hoges` ON `hoges`.`id` = `hoge_categories`.`hoge_id`\n\n\u2191 \u306fthrough\u3057\u3066\u3044\u308b\u306e\u3067\u2193\u3067\u3044\u3051\u307e\u3059\u3002\n[2] pry(main)> Preset.joins(category: :hoges)\n  Preset Load (0.3ms)  SELECT `presets`.* FROM `presets` INNER JOIN `categories` ON `categories`.`id` = `presets`.`category_id` INNER JOIN `hoge_categories` ON `hoge_categories`.`category_id` = `categories`.`id` INNER JOIN `hoges` ON `hoges`.`id` = `hoge_categories`.`hoge_id`\n```\n\n\u8907\u6570joins\u306ewhere\n\n```\n[15] pry(main)> Preset.joins(category: :hoges).where(hoges: { name: 'hogehoge' })\n  Preset Load (0.5ms)  SELECT `presets`.* FROM `presets` INNER JOIN `categories` ON `categories`.`id` = `presets`.`category_id` INNER JOIN `hoge_categories` ON `hoge_categories`.`category_id` = `categories`.`id` INNER JOIN `hoges` ON `hoges`.`id` = `hoge_categories`.`hoge_id` WHERE `hoges`.`name` = 'hogehoge'\n```\n\n## scope\n```\nclass Preset < ActiveRecord::Base\n  belongs_to :category, required: true\n\n  scope :hoges, -> { joins(category: :hoges) }\nend\n\nclass Category < ActiveRecord::Base\n  has_many :hoge_categories\n  has_many :hoges, through: :hoge_categories\n  \n  scope :by_group_type, ->(group_type) { where(group_type: group_type) } \nend\n```\n\n```\n[1] pry(main)> Category.by_group_type(1)\n  Category Load (0.3ms)  SELECT `categories`.* FROM `categories` WHERE `categories`.`group_type` = 1\n```\n\nmerge\n\n```\n[1] pry(main)> Preset.hoges.merge(Category.by_group_type(1))\n  Preset Load (0.5ms)  SELECT `presets`.* FROM `presets` INNER JOIN `categories` ON `categories`.`id` = `presets`.`category_id` INNER JOIN `hoge_categories` ON `hoge_categories`.`category_id` = `categories`.`id` INNER JOIN `hoges` ON `hoges`.`id` = `hoge_categories`.`hoge_id` WHERE `categories`.`group_type` = 1\n```\n\n\n## \u751fSQL\n```\nsql = \"select * from categories where name = 'hogehoge' and group_type = 1\"\n\nActiveRecord::Base.connection.select_all(sql)\n```\n\n\u30a8\u30b9\u30b1\u30fc\u30d7\u51e6\u7406\u3055\u305b\u308b\u5834\u5408\n\n```\nsql = 'select * from categories where name = ? and group_type = ?'\n\nsanitize_sql = ActiveRecord::Base.send(:sanitize_sql_array, [sql, 'hogehoge', 1])\n\nActiveRecord::Base.connection.select_all(sanitize_sql)\n```\n\n## arel_table\n```\nclass Preset < ActiveRecord::Base\n  belongs_to :category, required: true\n\n  scope :hoges, -> { joins(category: :hoges) }\n\n  scope :preset_ids, lambda { |job_id, employ_id|\n     where((arel_table[:job_id].eq(job_id).or(arel_table[:job_id].eq(nil)))\n            .and(arel_table[:employ_id].eq(employ_id).or(arel_table[:employ_id].eq(nil))))\n   }\nend\n```\n\nscope\u3092\u5b9f\u884c\n\n```\n[1] pry(main)> Preset.preset_ids(1,1)\n  Preset Load (0.3ms)  SELECT `presets`.* FROM `presets` WHERE ((`presets`.`job_id` = 1 OR `presets`.`job_id` IS NULL) AND (`presets`.`employ_id` = 1 OR `presets`.`employ_id` IS NULL))\n\n```\n", "tags": ["Rails", "Ruby", "ActiveRecord"]}