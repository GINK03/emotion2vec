{"tags": ["cppBuilder", "appComm", "networkApp"], "context": "\n\u52d5\u4f5c\u74b0\u5883\nC++ Builder XE4 on Windows 7 pro (32bit)\n\n\nhttp://qiita.com/7of9/items/0166b705d73559386f67\n\u306b\u3066\u898b\u3064\u3051\u305fcode example\u3092C++ Builder\u3067\u52d5\u304b\u3057\u3066\u307f\u305f\u3002\n\nv0.1\n\nSender.cpp\n//---------------------------------------------------------------------------\n\n#include <vcl.h>\n#pragma hdrstop\n\n#include \"Sender.h\"\n#include <tchar.h>\n\n//---------------------------------------------------------------------------\n#pragma package(smart_init)\n#pragma resource \"*.dfm\"\nTForm2 *Form2;\n//---------------------------------------------------------------------------\n__fastcall TForm2::TForm2(TComponent* Owner)\n    : TForm(Owner)\n{\n}\n//---------------------------------------------------------------------------\n\n#define BUF_SIZE (256)\n#if 1\nTCHAR szName[] = TEXT(\"MyfileMappingObject\");\n#else\nTCHAR szName[] = TEXT(\"Global\\\\MyfileMappingObject\");\n#endif\nTCHAR szMsg[] = TEXT(\"Message from first process\");\n\nvoid __fastcall TForm2::Button1Click(TObject *Sender)\n{\n    HANDLE hMapFile;\n    LPCTSTR pBuf;\n\n    hMapFile = CreateFileMapping(\n        INVALID_HANDLE_VALUE,\n        NULL,\n        PAGE_READWRITE,\n        0,\n        BUF_SIZE,\n        szName);\n\n    if (hMapFile == NULL) {\n        String msg = String().sprintf(L\"Could not create file mapping object (%d)\\n\", GetLastError());\n        ShowMessage(msg);\n        return;\n    }\n\n    pBuf = (LPTSTR) MapViewOfFile(hMapFile,\n        FILE_MAP_ALL_ACCESS,\n        0,\n        0,\n        BUF_SIZE);\n\n    if (pBuf == NULL) {\n        String msg = String().sprintf(L\"Could not map view of file (%d)\\n\", GetLastError());\n        ShowMessage(msg);\n        return;\n    }\n\n    CopyMemory((PVOID)pBuf, szMsg, (_tcslen(szMsg) * sizeof(TCHAR)));\n\n    UnmapViewOfFile(pBuf);\n\n    CloseHandle(hMapFile);\n}\n//---------------------------------------------------------------------------\n\n\nszName[]\u306e\u5b9a\u7fa9\u306b\u304a\u3044\u3066Global\\\\\u3092\u3064\u3051\u305f\u3082\u306e\u3067\u306fCould not create file mapping object (5)\u3068\u306a\u3063\u305f\u3002\n#if 1\u3067\u5b9a\u7fa9\u3057\u305f\u65b9\u306b\u3059\u308b\u3068CloseHandle()\u307e\u3067\u5b9f\u884c\u3055\u308c\u305f\u3002\nGlobal\\\u4ed8\u304d\u3067\u5b9f\u884c\u3059\u308b\u5834\u5408\u306f administrator\u3067\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u3088\u3046\u3060\u3002\nhttp://stackoverflow.com/questions/2647051/error-using-createfilemapping-c\n\nThere is a note about this in the MSDN article you referenced above, saying that you must be an Administrator to create global shared memory objects in Windows Vista/7.\n\nGlobal\\\\\u4ee5\u5916\u306b\u3082Local\\\\\u3068\u3044\u3046\u5b9a\u7fa9\u3082\u3042\u308b\nhttps://msdn.microsoft.com/ja-jp/library/cc430039.aspx\n\u4e0a\u8a18\u306e\u30b3\u30fc\u30c9\u3092Local\\\\\u3067\u5b9f\u884c\u3059\u308b\u3068\u30a8\u30e9\u30fc\u304c\u51fa\u305a\u306b\u6700\u5f8c\u307e\u3067\u5b9f\u884c\u3055\u308c\u305f\u3002\n\nv0.2\nCloseHandle()\u3092\u5225\u306e\u30dc\u30bf\u30f3\u51e6\u7406\u3068\u3057\u305f\u3002\n\nSender.cpp\n//---------------------------------------------------------------------------\n\n#include <vcl.h>\n#pragma hdrstop\n\n#include \"Sender.h\"\n#include <tchar.h>\n\n//---------------------------------------------------------------------------\n#pragma package(smart_init)\n#pragma resource \"*.dfm\"\nTForm2 *Form2;\n//---------------------------------------------------------------------------\n__fastcall TForm2::TForm2(TComponent* Owner)\n    : TForm(Owner)\n{\n}\n//---------------------------------------------------------------------------\n\n#define BUF_SIZE (256)\n#if 1\nTCHAR szName[] = TEXT(\"GlobalMyfileMappingObject\");\n#else\nTCHAR szName[] = TEXT(\"Global\\\\MyfileMappingObject\");\n#endif\nTCHAR szMsg[] = TEXT(\"Message from first process\");\n\nHANDLE hMapFile;\n\nvoid __fastcall TForm2::B_sendClick(TObject *Sender)\n{\n    LPCTSTR pBuf;\n\n    hMapFile = CreateFileMapping(\n        INVALID_HANDLE_VALUE,\n        NULL,\n        PAGE_READWRITE,\n        0,\n        BUF_SIZE,\n        szName);\n\n    if (hMapFile == NULL) {\n        String msg = String().sprintf(L\"Could not create file mapping object (%d)\\n\", GetLastError());\n        ShowMessage(msg);\n        return;\n    }\n\n    pBuf = (LPTSTR) MapViewOfFile(hMapFile,\n        FILE_MAP_ALL_ACCESS,\n        0,\n        0,\n        BUF_SIZE);\n\n    if (pBuf == NULL) {\n        String msg = String().sprintf(L\"Could not map view of file (%d)\\n\", GetLastError());\n        ShowMessage(msg);\n        return;\n    }\n\n    CopyMemory((PVOID)pBuf, szMsg, (_tcslen(szMsg) * sizeof(TCHAR)));\n\n    UnmapViewOfFile(pBuf);\n\n}\n//---------------------------------------------------------------------------\nvoid __fastcall TForm2::B_closeClick(TObject *Sender)\n{\n    CloseHandle(hMapFile);\n}\n//---------------------------------------------------------------------------\n\n\n```txt:\u52d5\u4f5c\u74b0\u5883\nC++ Builder XE4 on Windows 7 pro (32bit)\n```\n\nhttp://qiita.com/7of9/items/0166b705d73559386f67\n\u306b\u3066\u898b\u3064\u3051\u305fcode example\u3092C++ Builder\u3067\u52d5\u304b\u3057\u3066\u307f\u305f\u3002\n\n## v0.1\n\n```Sender.cpp\n//---------------------------------------------------------------------------\n\n#include <vcl.h>\n#pragma hdrstop\n\n#include \"Sender.h\"\n#include <tchar.h>\n\n//---------------------------------------------------------------------------\n#pragma package(smart_init)\n#pragma resource \"*.dfm\"\nTForm2 *Form2;\n//---------------------------------------------------------------------------\n__fastcall TForm2::TForm2(TComponent* Owner)\n\t: TForm(Owner)\n{\n}\n//---------------------------------------------------------------------------\n\n#define BUF_SIZE (256)\n#if 1\nTCHAR szName[] = TEXT(\"MyfileMappingObject\");\n#else\nTCHAR szName[] = TEXT(\"Global\\\\MyfileMappingObject\");\n#endif\nTCHAR szMsg[] = TEXT(\"Message from first process\");\n\nvoid __fastcall TForm2::Button1Click(TObject *Sender)\n{\n\tHANDLE hMapFile;\n\tLPCTSTR pBuf;\n\n\thMapFile = CreateFileMapping(\n\t\tINVALID_HANDLE_VALUE,\n\t\tNULL,\n\t\tPAGE_READWRITE,\n\t\t0,\n\t\tBUF_SIZE,\n\t\tszName);\n\n\tif (hMapFile == NULL) {\n\t\tString msg = String().sprintf(L\"Could not create file mapping object (%d)\\n\", GetLastError());\n\t\tShowMessage(msg);\n\t\treturn;\n\t}\n\n\tpBuf = (LPTSTR) MapViewOfFile(hMapFile,\n\t\tFILE_MAP_ALL_ACCESS,\n\t\t0,\n\t\t0,\n\t\tBUF_SIZE);\n\n\tif (pBuf == NULL) {\n\t\tString msg = String().sprintf(L\"Could not map view of file (%d)\\n\", GetLastError());\n\t\tShowMessage(msg);\n\t\treturn;\n\t}\n\n\tCopyMemory((PVOID)pBuf, szMsg, (_tcslen(szMsg) * sizeof(TCHAR)));\n\n\tUnmapViewOfFile(pBuf);\n\n\tCloseHandle(hMapFile);\n}\n//---------------------------------------------------------------------------\n```\n\n\nszName[]\u306e\u5b9a\u7fa9\u306b\u304a\u3044\u3066`Global\\\\`\u3092\u3064\u3051\u305f\u3082\u306e\u3067\u306f`Could not create file mapping object (5)`\u3068\u306a\u3063\u305f\u3002\n\n`#if 1`\u3067\u5b9a\u7fa9\u3057\u305f\u65b9\u306b\u3059\u308b\u3068CloseHandle()\u307e\u3067\u5b9f\u884c\u3055\u308c\u305f\u3002\n\nGlobal\\\\\u4ed8\u304d\u3067\u5b9f\u884c\u3059\u308b\u5834\u5408\u306f administrator\u3067\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u3088\u3046\u3060\u3002\n\nhttp://stackoverflow.com/questions/2647051/error-using-createfilemapping-c\n\n> There is a note about this in the MSDN article you referenced above, saying that you must be an Administrator to create global shared memory objects in Windows Vista/7.\n\n`Global\\\\`\u4ee5\u5916\u306b\u3082`Local\\\\`\u3068\u3044\u3046\u5b9a\u7fa9\u3082\u3042\u308b\nhttps://msdn.microsoft.com/ja-jp/library/cc430039.aspx\n\n\u4e0a\u8a18\u306e\u30b3\u30fc\u30c9\u3092`Local\\\\`\u3067\u5b9f\u884c\u3059\u308b\u3068\u30a8\u30e9\u30fc\u304c\u51fa\u305a\u306b\u6700\u5f8c\u307e\u3067\u5b9f\u884c\u3055\u308c\u305f\u3002\n\n\n## v0.2\n\nCloseHandle()\u3092\u5225\u306e\u30dc\u30bf\u30f3\u51e6\u7406\u3068\u3057\u305f\u3002\n\n```Sender.cpp\n//---------------------------------------------------------------------------\n\n#include <vcl.h>\n#pragma hdrstop\n\n#include \"Sender.h\"\n#include <tchar.h>\n\n//---------------------------------------------------------------------------\n#pragma package(smart_init)\n#pragma resource \"*.dfm\"\nTForm2 *Form2;\n//---------------------------------------------------------------------------\n__fastcall TForm2::TForm2(TComponent* Owner)\n\t: TForm(Owner)\n{\n}\n//---------------------------------------------------------------------------\n\n#define BUF_SIZE (256)\n#if 1\nTCHAR szName[] = TEXT(\"GlobalMyfileMappingObject\");\n#else\nTCHAR szName[] = TEXT(\"Global\\\\MyfileMappingObject\");\n#endif\nTCHAR szMsg[] = TEXT(\"Message from first process\");\n\nHANDLE hMapFile;\n\nvoid __fastcall TForm2::B_sendClick(TObject *Sender)\n{\n\tLPCTSTR pBuf;\n\n\thMapFile = CreateFileMapping(\n\t\tINVALID_HANDLE_VALUE,\n\t\tNULL,\n\t\tPAGE_READWRITE,\n\t\t0,\n\t\tBUF_SIZE,\n\t\tszName);\n\n\tif (hMapFile == NULL) {\n\t\tString msg = String().sprintf(L\"Could not create file mapping object (%d)\\n\", GetLastError());\n\t\tShowMessage(msg);\n\t\treturn;\n\t}\n\n\tpBuf = (LPTSTR) MapViewOfFile(hMapFile,\n\t\tFILE_MAP_ALL_ACCESS,\n\t\t0,\n\t\t0,\n\t\tBUF_SIZE);\n\n\tif (pBuf == NULL) {\n\t\tString msg = String().sprintf(L\"Could not map view of file (%d)\\n\", GetLastError());\n\t\tShowMessage(msg);\n\t\treturn;\n\t}\n\n\tCopyMemory((PVOID)pBuf, szMsg, (_tcslen(szMsg) * sizeof(TCHAR)));\n\n\tUnmapViewOfFile(pBuf);\n\n}\n//---------------------------------------------------------------------------\nvoid __fastcall TForm2::B_closeClick(TObject *Sender)\n{\n\tCloseHandle(hMapFile);\n}\n//---------------------------------------------------------------------------\n```\n\n"}