{"context": " More than 1 year has passed since last update.\u524d\u56de\u306e\u7d9a\u304d\u3002\u6b21\u306f\u3001nginx\u2192fluentd\u2192elasticsearch\u2192kibana\u3067\u53ef\u8996\u5316\u3057\u3066\u307f\u308b\u3002\n\nNginx\n\ninstall\n# rpm -ivh http://nginx.org/packages/centos/6/noarch/RPMS/nginx-release-centos-6-0.el6.ngx.noarch.rpm\n# yum -y install nginx\n# nginx -V\nnginx version: nginx/1.8.0\n\n\nnginx.conf\n\nlog_format\u3092ltsv\n\n# vi /etc/nginx/nginx.con\n\nhttp {\n    include       /etc/nginx/mime.types;\n    default_type  application/octet-stream;\n\n    log_format ltsv   \"time:$time_local\"\n                      \"\\thost:$remote_addr\"\n                      \"\\tforwardedfor:$http_x_forwarded_for\"\n                      \"\\treq:$request\"\n                      \"\\tstatus:$status\"\n                      \"\\tsize:$body_bytes_sent\"\n                      \"\\treferer:$http_referer\"\n                      \"\\tua:$http_user_agent\"\n                      \"\\treqtime:$request_time\"\n                      \"\\tcache:$upstream_http_x_cache\"\n                      \"\\truntime:$upstream_http_x_runtime\"\n                      \"\\tvhost:$host\";\n\n    access_log  /var/log/nginx/access.log  ltsv;\n\n\n\u8d77\u52d5\n# chkconfig --add nginx\n# chkconfig nginx on\n# /etc/init.d/nginx start\n\n\ntd-agent\n\ninstall\n# curl -L https://toolbelt.treasuredata.com/sh/install-redhat-td-agent2.sh | sh\n\n\nplugin\n\nfluent-plugin-elasticsearch\n\ntd-agent-gem install fluent-plugin-elasticsearch\n\n\nfluent-plugin-woothee\n\ntd-agent-gem install fluent-plugin-woothee\n\n\ntd-agent.conf\n# vi /etc/td-agent/td-agent.conf\n\n## File input\n<source>\n  type tail\n  format ltsv\n  path /var/log/nginx/access.log\n  pos_file /var/log/nginx/access.log.pos\n  tag access.nginx\n  time_key time\n  time_format %d/%b/%Y:%H:%M:%S %z\n</source>\n\n## Merged ua\n<match access.nginx>\n  type woothee\n  key_name ua\n  add_prefix merged\n  merge_agent_info yes\n</match>\n\n## Multiple output\n<match merged.access.nginx>\n  type copy\n  <store>\n    type elasticsearch\n    index_name service_name\n    type_name access\n    include_tag_key true\n    tag_key @log_name\n    host 127.0.0.1\n    port 9200\n    logstash_format true\n    logstash_prefix service_name.access\n    flush_interval 3s\n  </store>\n  <store>\n    type file\n    path /var/log/nginx/merged.access.nginx.log\n    time_slice_format %Y%m%d\n    time_slice_wait 10m\n    time_format %Y%m%dT%H%M%S%z\n    compress gzip\n  </store>\n</match>\n\n\n\u8d77\u52d5\n# chkconfig --add td-agent\n# chkconfig td-agent on\n# /etc/init.d/td-agent start\n\n\nkibana\n\nlogstash_prefix\u306b\u6307\u5b9a\u3057\u305f\u300cservice_name.access-*\u300d\n\n\n\n\u8a2d\u5b9a\u307e\u308f\u308a\u306f\u3053\u3053\u3089\u3078\u3093\u3068\u540c\u3058\n\n[\u524d\u56de\u306e\u7d9a\u304d](http://qiita.com/takaheraw@github/items/612d5ecf84d4e1ab4dc1)\u3002\u6b21\u306f\u3001nginx\u2192fluentd\u2192elasticsearch\u2192kibana\u3067\u53ef\u8996\u5316\u3057\u3066\u307f\u308b\u3002\n\n# Nginx\n\n## install\n\n```\n# rpm -ivh http://nginx.org/packages/centos/6/noarch/RPMS/nginx-release-centos-6-0.el6.ngx.noarch.rpm\n# yum -y install nginx\n# nginx -V\nnginx version: nginx/1.8.0\n```\n\n## nginx.conf\n\n+ log_format\u3092ltsv\n\n```\n# vi /etc/nginx/nginx.con\n```\n```\nhttp {\n    include       /etc/nginx/mime.types;\n    default_type  application/octet-stream;\n\n    log_format ltsv   \"time:$time_local\"\n                      \"\\thost:$remote_addr\"\n                      \"\\tforwardedfor:$http_x_forwarded_for\"\n                      \"\\treq:$request\"\n                      \"\\tstatus:$status\"\n                      \"\\tsize:$body_bytes_sent\"\n                      \"\\treferer:$http_referer\"\n                      \"\\tua:$http_user_agent\"\n                      \"\\treqtime:$request_time\"\n                      \"\\tcache:$upstream_http_x_cache\"\n                      \"\\truntime:$upstream_http_x_runtime\"\n                      \"\\tvhost:$host\";\n\n    access_log  /var/log/nginx/access.log  ltsv;\n```\n\n## \u8d77\u52d5\n\n```\n# chkconfig --add nginx\n# chkconfig nginx on\n# /etc/init.d/nginx start\n```\n\n# td-agent\n\n## install\n\n```\n# curl -L https://toolbelt.treasuredata.com/sh/install-redhat-td-agent2.sh | sh\n```\n\n## plugin\n\n### [fluent-plugin-elasticsearch](https://github.com/uken/fluent-plugin-elasticsearch)\n\n```\ntd-agent-gem install fluent-plugin-elasticsearch\n```\n\n### [fluent-plugin-woothee](https://github.com/woothee/fluent-plugin-woothee)\n\n```\ntd-agent-gem install fluent-plugin-woothee\n```\n\n## td-agent.conf\n\n```\n# vi /etc/td-agent/td-agent.conf\n```\n```\n## File input\n<source>\n  type tail\n  format ltsv\n  path /var/log/nginx/access.log\n  pos_file /var/log/nginx/access.log.pos\n  tag access.nginx\n  time_key time\n  time_format %d/%b/%Y:%H:%M:%S %z\n</source>\n\n## Merged ua\n<match access.nginx>\n  type woothee\n  key_name ua\n  add_prefix merged\n  merge_agent_info yes\n</match>\n\n## Multiple output\n<match merged.access.nginx>\n  type copy\n  <store>\n    type elasticsearch\n    index_name service_name\n    type_name access\n    include_tag_key true\n    tag_key @log_name\n    host 127.0.0.1\n    port 9200\n    logstash_format true\n    logstash_prefix service_name.access\n    flush_interval 3s\n  </store>\n  <store>\n    type file\n    path /var/log/nginx/merged.access.nginx.log\n    time_slice_format %Y%m%d\n    time_slice_wait 10m\n    time_format %Y%m%dT%H%M%S%z\n    compress gzip\n  </store>\n</match>\n```\n\n## \u8d77\u52d5\n\n```\n# chkconfig --add td-agent\n# chkconfig td-agent on\n# /etc/init.d/td-agent start\n```\n\n# kibana\n\n+ logstash_prefix\u306b\u6307\u5b9a\u3057\u305f\u300cservice_name.access-*\u300d\n\n![kibana.png](https://qiita-image-store.s3.amazonaws.com/0/7086/ee2d48a3-a32c-83a1-7fe5-537c09f34f02.png)\n\n+ \u8a2d\u5b9a\u307e\u308f\u308a\u306f[\u3053\u3053\u3089\u3078\u3093](http://qiita.com/takaheraw@github/items/612d5ecf84d4e1ab4dc1#kibana)\u3068\u540c\u3058\n", "tags": ["nginx", "fluentd", "Elasticsearch", "Kibana4"]}