{"tags": ["zabbix-server", "pcs", "corosync", "HA"], "context": "CentOS7\u304b\u3089crm\u304c\u4f7f\u3048\u306a\u304f\u306a\u308b\u306e\u3067pcs\u3067zabbix\u30b5\u30fc\u30d0\u306e\u5197\u9577\u69cb\u6210\u3092\u304c\u3093\u3070\u3063\u3066\u307f\u3088\u3046\u3068\u3044\u3046\u8a18\u9332\u3067\u3059\u3002\n\u76e3\u8996\u30b5\u30fc\u30d0\u304c\u9577\u6642\u9593\u76e3\u8996\u3067\u304d\u306a\u304f\u3063\u3066\u5fa9\u65e7\u306b\u6642\u9593\u304c\u304b\u304b\u308b\u3068\u304b\u5272\u3068\u3042\u308a\u3048\u306a\u3044\u3068\u3044\u3046\u304b\u3001\u3082\u3057\u4e3b\u7cfb\u304c\u3057\u3093\u3067\u3082\u5f85\u6a5f\u7cfb\u304c\u3059\u3050\u751f\u304d\u8fd4\u308b\u3088\u3046\u306b\u3057\u305f\u3044\u3057\u6df1\u591c\u65e9\u671d\u306b\u6642\u9593\u306e\u304b\u304b\u308b\u5fa9\u65e7\u306b\u501f\u308a\u51fa\u3055\u308c\u305f\u3089\u8d85\u3044\u3084\u3060\u3057\u30df\u30b9\u308b\u3068\u5371\u306a\u3044\u304b\u3089\u81ea\u52d5\u5316\u4e0d\u53ef\u907f\u3068\u3044\u3046\u8a8d\u8b58\u3067\u3059\u3002\n\u3082\u306f\u3084\u624b\u52d5\u904b\u7528\u3067\u30ab\u30d0\u30fc\u3068\u304b\u7b4b\u8089\u904b\u7528\u3068\u304b\u30e0\u30ea\u306a\u304a\u5e74\u9803\u3067\u3059\u307f\u307e\u305b\u3093\u3002\u5bdd\u306a\u3044\u3068\u5bff\u547d\u304c\u3061\u3062\u307f\u305d\u3046\u3002\u5065\u5eb7\u8d85\u3060\u3044\u3058\u3002\n\u30fb\u30db\u30b9\u30c8\u540d\u3092\u4ed8\u3051\u76f4\u3059\uff08set-hostname\u3092\u6307\u5b9a\u3059\u308b\u3068\u518d\u8d77\u52d5\u5f8c\u3082\u53cd\u6620\u3055\u308c\u308b\uff09\n# hostnamectl set-hostname monitor-mng-cent7-test-komi01\n# hostnamectl set-hostname monitor-mng-cent7-test-komi02\n\n\n\uff08\u691c\u8a3c\u306a\u306e\u3067\u3072\u3089\u304d\u306a\u304a\u3063\u3066root\u3067\u3084\u3063\u3066\u307e\u3059\u304c\u305d\u3046\u3067\u306a\u3044\u5834\u5408\u306fsudo\u3064\u3051\u3066\u304f\u3060\u3055\u3044\u3002\uff09\n\u30fbhosts\u3092\u306a\u304a\u3059\n# vi /etc/hosts\n127.0.0.1  localhost localhost.localdomain localhost4 localhost4.localdomain4\n#::1         localhost localhost.localdomain localhost6 localhost6.localdomain6\n\n192.168.3.104   monitor-mng-cent7-test-komi02 mon7-2\n192.168.3.103   monitor-mng-cent7-test-komi01 mon7-1 localhost\n\n\u4e00\u884c\u76ee\u306b\u306a\u3093\u304b\u8ffd\u8a18\u3059\u308b\u3068\u5909\u306a\u52d5\u304d\u3057\u3066\u305f\u3002\nlocalhost\u3092\u81ea\u5206\u306e\u884c\uff081\u884c\u76ee\u4ee5\u5916\uff09\u306b\u66f8\u304f\u5fc5\u8981\u304c\u3042\u308b\u304b\u306f\u78ba\u304b\u3081\u304d\u308c\u3066\u3044\u306a\u3044\u304d\u304c\u3059\u308b\u3002\n\u30fb\u3044\u3061\u304a\u3046\u758e\u901a\u78ba\u8a8d\n# ping mon7-1\n# ping mon7-2\n\n\u30fb\u30af\u30e9\u30b9\u30bf\u5236\u5fa1\u30bd\u30d5\u30c8\u3092\u5165\u308c\u308b\n# yum clean all\n# yum install --enablerepo base pcs fence-agents-all\n\n\u30fb\u52dd\u624b\u306b\u5165\u3063\u305f\u30e6\u30fc\u30b6\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u66f4\u65b0\uff08\u3042\u3068\u3067\u30ce\u30fc\u30c9\u767b\u9332\u306e\u3068\u304d\u306b\u30d1\u30b9\u30ef\u30fc\u30c9\u3064\u304b\u3046\uff09\n# passwd hacluster\n****\n\n\u30fbpcsd\u3092\u8d77\u52d5\u3001\u6709\u52b9\u5316\n# systemctl start pcsd\n# systemctl enable pcsd\n\n# systemctl status pcsd\n\u25cf pcsd.service - PCS GUI and remote configuration interface\n   Loaded: loaded (/usr/lib/systemd/system/pcsd.service; enabled; vendor preset: disabled)\n   Active: active (running) since Tue 2016-07-12 01:26:04 UTC; 55s ago\n Main PID: 3679 (pcsd)\n   CGroup: /system.slice/pcsd.service\n           \u251c\u25003679 /bin/sh /usr/lib/pcsd/pcsd start\n           \u251c\u25003683 /bin/bash -c ulimit -S -c 0 >/dev/null 2>&1 ; /usr/bin/ruby -I/usr/lib/pcsd /usr/lib/...\n           \u2514\u25003684 /usr/bin/ruby -I/usr/lib/pcsd /usr/lib/pcsd/ssl.rb\n\nJul 12 01:26:04 monitor-mng-cent7-test-komi01 systemd[1]: Starting PCS GUI and remote configuration i.....Jul 12 01:26:04 monitor-mng-cent7-test-komi01 systemd[1]: Started PCS GUI and remote configuration in...e.Hint: Some lines were ellipsized, use -l to show in full.\n\n\u30fb\u30ce\u30fc\u30c9\u3092\u8a8d\u8a3c\u3059\u308b\n# pcs cluster auth monitor-mng-cent7-test-komi01 monitor-mng-cent7-test-komi02 -u hacluster -p ***** --force\nmonitor-mng-cent7-test-komi01: Authorized\nmonitor-mng-cent7-test-komi02: Authorized\n\n\u30fb\u30af\u30e9\u30b9\u30bf\u3092\u4f5c\u6210\u3059\u308b\n\u7247\u65b9\u3067\u4e00\u56de\u3060\u3051\n# pcs cluster setup --name zabbixcluster monitor-mng-cent7-test-komi01 monitor-mng-cent7-test-komi02\nShutting down pacemaker/corosync services...\nRedirecting to /bin/systemctl stop  pacemaker.service\nRedirecting to /bin/systemctl stop  corosync.service\nKilling any remaining services...\nRemoving all cluster configuration files...\nmonitor-mng-cent7-test-komi01: Succeeded\nmonitor-mng-cent7-test-komi02: Succeeded\nSynchronizing pcsd certificates on nodes monitor-mng-cent7-test-komi01, monitor-mng-cent7-test-komi02...\nmonitor-mng-cent7-test-komi01: Success\nmonitor-mng-cent7-test-komi02: Success\n\nRestaring pcsd on the nodes in order to reload the certificates...\nmonitor-mng-cent7-test-komi01: Success\nmonitor-mng-cent7-test-komi02: Success\n\n\u30fb\u30af\u30e9\u30b9\u30bf\u3092\u958b\u59cb\u3055\u305b\u308b\n# pcs cluster start --all\nmonitor-mng-cent7-test-komi02: Starting Cluster...\nmonitor-mng-cent7-test-komi01: Starting Cluster...\n\n\u30fb\u52d5\u4f5c\u78ba\u8a8d\n# corosync-cfgtool -s\nPrinting ring status.\nLocal node ID 1\nRING ID 0\n        id      = 127.0.0.1\n        status  = ring 0 active with no faults\n\n\"status\"\u304c\"active\"\u304b\u3064\"no faults\"\u3067\u3042\u308c\u3070\u3001\u554f\u984c\u306a\u304f\u901a\u4fe1\u304c\u884c\u3048\u3066\u3044\u308b\u3002\n\u540c\u69d8\u306b\u3001\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3067\u3082corosync\u306e\u52d5\u4f5c\u72b6\u6cc1\u3092\u78ba\u8a8d\u3067\u304d\u308b\u3002\n# corosync-cmapctl | grep members\nruntime.totem.pg.mrp.srp.members.1.config_version (u64) = 0\nruntime.totem.pg.mrp.srp.members.1.ip (str) = r(0) ip(127.0.0.1) \nruntime.totem.pg.mrp.srp.members.1.join_count (u32) = 1\nruntime.totem.pg.mrp.srp.members.1.status (str) = joined\n\n# pcs status corosync\n\nMembership information\n----------------------\n    Nodeid      Votes Name\n         1          1 monitor-mng-cent7-test-komi01 (local)\n\n# ps aux|egrep -a 'PID|coro|pace'|grep -v grep\nUSER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND\nroot      4206  1.0  3.7 190580 38432 ?        Ssl  01:35   0:08 corosync\nroot      4221  0.0  0.7 130488  7240 ?        Ss   01:35   0:00 /usr/sbin/pacemakerd -f\nhaclust+  4222  0.0  1.3 131316 14016 ?        Ss   01:35   0:00 /usr/libexec/pacemaker/cib\nroot      4223  0.0  0.6 132924  6952 ?        Ss   01:35   0:00 /usr/libexec/pacemaker/stonithd\nroot      4224  0.0  0.4 102940  5000 ?        Ss   01:35   0:00 /usr/libexec/pacemaker/lrmd\nhaclust+  4225  0.0  0.6 124760  6720 ?        Ss   01:35   0:00 /usr/libexec/pacemaker/attrd\nhaclust+  4226  0.0  2.0 150972 20896 ?        Ss   01:35   0:00 /usr/libexec/pacemaker/pengine\nhaclust+  4227  0.0  1.0 184184 11068 ?        Ss   01:35   0:00 /usr/libexec/pacemaker/crmd\n\n\n# pcs status\nCluster name: zabbixcluster\nWARNING: no stonith devices and stonith-enabled is not false\nLast updated: Tue Jul 12 01:50:28 2016          Last change: Tue Jul 12 01:35:24 2016 by hacluster via crmd on monitor-mng-cent7-test-komi01\nStack: corosync\nCurrent DC: monitor-mng-cent7-test-komi01 (version 1.1.13-10.el7_2.2-44eb2dd) - partition WITHOUT quorum\n2 nodes and 0 resources configured\n\nNode monitor-mng-cent7-test-komi02: UNCLEAN (offline)\nOnline: [ monitor-mng-cent7-test-komi01 ]\n\nFull list of resources:\n\n\nPCSD Status:\n  monitor-mng-cent7-test-komi01: Online\n  monitor-mng-cent7-test-komi02: Online\n\nDaemon Status:\n  corosync: active/disabled\n  pacemaker: active/disabled\n  pcsd: active/enabled\n\n\u203b\u4e0a\u306e\u62ec\u5f27\u5185\u306eOnline\u304clocalhost\u3060\u3051\u306b\u306a\u3063\u3066\u3057\u307e\u3046\u306e\u306f\u5192\u982d\u306ehosts\u306e\u3042\u305f\u308a\u306b\u66f8\u3044\u305f\u3068\u304a\u308a\u30c0\u30e1\u3067\u3059\u3002\n\u30fb\u8a2d\u5b9a\u3092\u78ba\u8a8d\n# crm_verify -L -V\n   error: unpack_resources:     Resource start-up disabled since no STONITH resources have been defined\n   error: unpack_resources:     Either configure some or disable STONITH with the stonith-enabled option\n   error: unpack_resources:     NOTE: Clusters with shared data need STONITH to ensure data integrity\nErrors found during check: config not valid\n\n\u30fbstonith\u3092\u7121\u52b9\u306b\u3059\u308b\uff08\u4e0a\u8a18error\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6d88\u3059\uff09\npcs property set stonith-enabled=false\ncrm_verify -L -V\n\n\u30fb\u30ea\u30bd\u30fc\u30b9\u8ffd\u52a0\u4f8b\uff08\u4eee\u60f3IP\u306e\u5834\u5408\uff09\n\u30ea\u30bd\u30fc\u30b9ID\uff1aVIP\n\u30ea\u30bd\u30fc\u30b9\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\uff08RA\uff09\uff1a\"ocf:heartbeat:IPaddr2\"\nIP\u30a2\u30c9\u30ec\u30b9\uff1a192.168.56.10/24\uff08HostOnly\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30a2\u30c9\u30ec\u30b9\uff09\n\u76e3\u8996\u9593\u9694\uff1a10sec\n\n# pcs resource create VIP ocf:heartbeat:IPaddr2 \\\n    ip=192.168.56.10 cidr_netmask=24 op monitor interval=10s\n\n\u3053\u3093\u306a\u304b\u3093\u3058\u307d\u3044\u3002\n\u306e\u3067\u3053\u308c\u3092\u53c2\u8003\u306b\u3042\u3068\u3067zabbix\u5165\u308c\u306a\u304a\u3057\u3066\u304b\u3089\u305d\u306e\u30ea\u30bd\u30fc\u30b9\u3092\u8ffd\u52a0\u3059\u308b\u3002\n\u3068\u308a\u3042\u3048\u305a\u306a\u3093\u3068\u306a\u304fzabbix\u3044\u308c\u306a\u304a\u3059\u3002\n\u305d\u306e\u307e\u3048\u306bMySQL\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5165\u308c\u308b\u3002\n\u30fbmysql\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3092\u3044\u308c\u308b\uff08\u672c\u4f53\u30c7\u30fc\u30bf\u306fRDS\u3067\u4fdd\u7ba1\u3059\u308b\u306e\u3067\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3060\u3051\u5165\u308c\u3068\u304f\uff09\n\u203b\u3044\u307e\u307e\u3067\u306e\u5165\u308c\u65b9\u306fchef\u3068\u306e\u76f8\u6027\u304c\u60aa\u304b\u3063\u305f\u306e\u3067\u30b3\u30df\u30e5\u30cb\u30c6\u30a3\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u3092\u63a1\u7528\u3057\u3066\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5165\u308c\u308b\u3053\u3068\u306b\u3057\u3088\u3046\u304b\u3068\u3002\nRDS\u306fmaria\u306f\u4f7f\u3048\u306a\u3044\u6c17\u304c\u3059\u308b\u306e\u3067\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u6d88\u3059\uff08CentOS7\u304b\u3089maria\u3055\u3093\u306elib\u304c\u6a19\u6e96\u3067\u5165\u3063\u3066\u3044\u308b\u6a21\u69d8\uff09\nyum remove mariadb-libs\n==========================================================================================================\n Package                       Arch             Version                         Repository           Size\n==========================================================================================================\nRemoving:\n mariadb-libs                  x86_64           1:5.5.44-2.el7.centos           installed           4.4 M\nRemoving for dependencies:\n php-mysql                     x86_64           5.4.16-36.1.el7_2.1             @updates            232 k\n postfix                       x86_64           2:2.10.1-6.el7                  installed            12 M\n zabbix-server-mysql           x86_64           3.0.3-1.el7                     @zabbix             3.3 M\n zabbix-web                    noarch           3.0.3-1.el7                     @zabbix              29 M\n zabbix-web-japanese           noarch           3.0.3-1.el7                     @zabbix             0.0  \n zabbix-web-mysql              noarch           3.0.3-1.el7                     @zabbix             0.0  \n\nTransaction Summary\n==========================================================================================================\nRemove  1 Package (+6 Dependent packages)\n\n\u5148\u306bzabbix\u3092\u5165\u308c\u3066\u3057\u307e\u3046\u3068\u4f9d\u5b58\u3067\u4e38\u3054\u3068\u6d88\u3055\u308c\u308b\u306e\u3067\u6ce8\u610f\u3002\u624b\u9806\u306fzabbix\u3088\u308a*db-libs\u5165\u308c\u66ff\u3048\u3092\u771f\u3063\u5148\u306b\u3057\u305f\u307b\u3046\u304c\u3044\u3044\u3002\nrm -rf /var/lib/mysql/\n\nyum localinstall http://dev.mysql.com/get/mysql57-community-release-el7-7.noarch.rpm\n\n# yum info mysql-community-server\n\nName        : mysql-community-server\nArch        : x86_64\nVersion     : 5.7.13\nRelease     : 1.el7\nSize        : 151 M\nRepo        : mysql57-community/x86_64\nSummary     : A very fast and reliable SQL database server\nURL         : http://www.mysql.com/\nLicense     : Copyright (c) 2000, 2016, Oracle and/or its affiliates. All rights reserved. Under GPLv2\n            : license as shown in the Description field.\nDescription : The MySQL(TM) software delivers a very fast, multi-threaded, multi-user,\n            : and robust SQL (Structured Query Language) database server. MySQL Server\n            : is intended for mission-critical, heavy-load production systems as well\n            : as for embedding into mass-deployed software. MySQL is a trademark of\n            : Oracle and/or its affiliates\n            : \n            : The MySQL software has Dual Licensing, which means you can use the MySQL\n            : software free of charge under the GNU General Public License\n            : (http://www.gnu.org/licenses/). You can also purchase commercial MySQL\n            : licenses from Oracle and/or its affiliates if you do not wish to be bound by the terms of\n            : the GPL. See the chapter \"Licensing and Support\" in the manual for\n            : further info.\n            : \n            : The MySQL web site (http://www.mysql.com/) provides the latest news and\n            : information about the MySQL software.  Also please see the documentation\n            : and the manual for more information.\n            : \n            : This package includes the MySQL server binary as well as related utilities\n            : to run and administer a MySQL server.\n\n\n# yum install mysql-community-client mysql-community-libs mysql-community-devel mysql-community-common\n\n# vi /etc/my.cnf\n[mysqldump]\nquick\nmax_allowed_packet = 16M\ndefault-character-set = utf8\n\n[mysql]\nno-auto-rehash\ndefault-character-set = utf8\n\n\u30fbconfrict\u3057\u305f\u306e\u3067zabbix2.2\u3092\u524a\u9664\nyum remove zabbix-relase zabbix-agent zabbix\nrpm -e zabbix-release\nrpm -qa|grep zabbix\n\n\u30fbzabbix3.0\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u767b\u9332\nrpm -ivh http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm\n\n\u30fb\u672c\u4f53\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nyum -y install zabbix-server-mysql zabbix-web-mysql zabbix-web-japanese\n==========================================================================================================\n Package                       Arch         Version                      Repository                  Size\n==========================================================================================================\nInstalling:\n zabbix-server-mysql           x86_64       3.0.3-1.el7                  zabbix                     1.7 M\n zabbix-web-japanese           noarch       3.0.3-1.el7                  zabbix                     4.4 k\n zabbix-web-mysql              noarch       3.0.3-1.el7                  zabbix                     3.9 k\nInstalling for dependencies:\n OpenIPMI-libs                 x86_64       2.0.19-11.el7                base                       501 k\n dejavu-fonts-common           noarch       2.33-6.el7                   base                        64 k\n dejavu-sans-fonts             noarch       2.33-6.el7                   base                       1.4 M\n fontpackages-filesystem       noarch       1.44-8.el7                   base                       9.9 k\n fping                         x86_64       3.10-1.el7                   zabbix-non-supported        40 k\n httpd                         x86_64       2.4.6-40.el7.centos.1        updates                    2.7 M\n httpd-tools                   x86_64       2.4.6-40.el7.centos.1        updates                     82 k\n iksemel                       x86_64       1.4-2.el7.centos             zabbix-non-supported        49 k\n libXpm                        x86_64       3.5.11-3.el7                 base                        54 k\n libzip                        x86_64       0.10.1-8.el7                 base                        48 k\n php                           x86_64       5.4.16-36.1.el7_2.1          updates                    1.4 M\n php-bcmath                    x86_64       5.4.16-36.1.el7_2.1          updates                     56 k\n php-cli                       x86_64       5.4.16-36.1.el7_2.1          updates                    2.7 M\n php-common                    x86_64       5.4.16-36.1.el7_2.1          updates                    563 k\n php-gd                        x86_64       5.4.16-36.1.el7_2.1          updates                    126 k\n php-ldap                      x86_64       5.4.16-36.1.el7_2.1          updates                     51 k\n php-mbstring                  x86_64       5.4.16-36.1.el7_2.1          updates                    503 k\n php-mysql                     x86_64       5.4.16-36.1.el7_2.1          updates                     99 k\n php-pdo                       x86_64       5.4.16-36.1.el7_2.1          updates                     97 k\n php-xml                       x86_64       5.4.16-36.1.el7_2.1          updates                    124 k\n t1lib                         x86_64       5.1.2-14.el7                 base                       166 k\n unixODBC                      x86_64       2.3.1-11.el7                 base                       413 k\n vlgothic-p-fonts              noarch       20130607-2.el7               base                       2.2 M\n zabbix-web                    noarch       3.0.3-1.el7                  zabbix                     3.5 M\n\nTransaction Summary\n==========================================================================================================\nInstall  3 Packages (+24 Dependent packages)\n\nInstalled:\n  zabbix-server-mysql.x86_64 0:3.0.3-1.el7       zabbix-web-japanese.noarch 0:3.0.3-1.el7        zabbix-web-mysql.noarch 0:3.0.3-1.el7         \n\nDependency Installed:\n  OpenIPMI-libs.x86_64 0:2.0.19-11.el7          dejavu-fonts-common.noarch 0:2.33-6.el7       \n  dejavu-sans-fonts.noarch 0:2.33-6.el7         fontpackages-filesystem.noarch 0:1.44-8.el7   \n  fping.x86_64 0:3.10-4.el7                     httpd.x86_64 0:2.4.6-40.el7.centos.1          \n  httpd-tools.x86_64 0:2.4.6-40.el7.centos.1    iksemel.x86_64 0:1.4-6.el7                    \n  libXpm.x86_64 0:3.5.11-3.el7                  libzip.x86_64 0:0.10.1-8.el7                  \n  php.x86_64 0:5.4.16-36.1.el7_2.1              php-bcmath.x86_64 0:5.4.16-36.1.el7_2.1       \n  php-cli.x86_64 0:5.4.16-36.1.el7_2.1          php-common.x86_64 0:5.4.16-36.1.el7_2.1       \n  php-gd.x86_64 0:5.4.16-36.1.el7_2.1           php-ldap.x86_64 0:5.4.16-36.1.el7_2.1         \n  php-mbstring.x86_64 0:5.4.16-36.1.el7_2.1     php-mysql.x86_64 0:5.4.16-36.1.el7_2.1        \n  php-pdo.x86_64 0:5.4.16-36.1.el7_2.1          php-xml.x86_64 0:5.4.16-36.1.el7_2.1          \n  t1lib.x86_64 0:5.1.2-14.el7                   unixODBC.x86_64 0:2.3.1-11.el7                \n  vlgothic-p-fonts.noarch 0:20130607-2.el7      zabbix-web.noarch 0:3.0.3-1.el7               \n\nComplete!\n\n\u30fbagent\u305d\u306e\u305f\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n# yum -y install zabbix-agent\nRunning transaction\n  Installing : zabbix-agent-3.0.3-1.el7.x86_64                                                \n        1/1   Verifying  : zabbix-agent-3.0.3-1.el7.x86_64                                    \n                    1/1 \nInstalled:\n  zabbix-agent.x86_64 0:3.0.3-1.el7 \n\n# yum -y install zabbix-get\n\nInstalled:\n  zabbix-get.x86_64 0:3.0.3-1.el7     \n\n\u30fbrds\u306e\u6e96\u5099\u3068zabbix\u7528\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u4f5c\u6210\nid\u3068pass\u3068schema\u3068host\u60c5\u5831\u3092\u63a7\u3048\u3066\u304a\u304f\uff08zabbix-server.conf\u306b\u3042\u3068\u3067\u304b\u304f\uff09\n\u5165\u308c\u305fmysql\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3067\u63a5\u7d9a\u78ba\u8a8d\u3057\u3066\u304a\u304f\u306e\u3068zabbix\u306b\u540c\u68b1\u306esql\u5b9f\u884c\u3059\u308b\nmysql -u mn***_op -p -h monitor-test.****.rds.amazonaws.com\n\ncd /usr/share/doc/zabbix-server-mysql-3.0.3/\nzcat create.sql.gz | mysql -u mn***_op -p -h monitor-test.****.rds.amazonaws.com zabbix\n\n\u30fbzabbix-server.conf\u307b\u304b\u306e\u8a2d\u5b9a\u3092\u3059\u308b\n# vim /etc/zabbix/zabbix_server.conf\n\nDBHost\u307b\u304b\u3092\u4fee\u6b63\n# vim /etc/httpd/conf.d/zabbix.conf\n\n\u30bf\u30a4\u30e0\u30be\u30fc\u30f3\u3092Asia/Tokyo\u306b\u4fee\u6b63\n# vi /etc/httpd/conf.d/status.conf\nExtendedStatus on\n<Location /server-status>\nSetHandler server-status\nRequire ip 127.0.0.1\n</Location>\n\nocf\u306eWEBServer\u7528\u306b\u5fc5\u8981\u306a\u62e1\u5f35\u30b9\u30c6\u30fc\u30bf\u30b9\u3092\u307f\u308c\u308b\u3088\u3046\u306b\u3059\u308b\u3084\u3064\n\u30fbURL\u30a2\u30af\u30bb\u30b9\u3057\u3066\u521d\u671f\u8a2d\u5b9a\nhttp://52.xxx.xxx.xxx/zabbix/\nDB\u60c5\u5831\u3092\u5165\u529b\u3057\u3066\u305d\u306e\u307e\u307e\u3059\u3059\u3080\n\u30fb\u30ea\u30bd\u30fc\u30b9\u3092\u767b\u9332\u3059\u308b\u305f\u3081\u306b\u65e2\u5b58\u306e\u60c5\u5831\u3092\u3068\u3063\u3066\u304f\u308b\n$ sudo crm configure show\n\npostfix\u306fActAct\u306b\u3057\u3066HA\u30ea\u30bd\u30fc\u30b9\u304b\u3089\u306f\u305a\u3057\u3001\u305d\u3053\u3092apache\u7528\u306b\u5909\u3048\u308b\u3088\u3066\u3044\u3002\n\u4eee\u60f3IP\u3092\u30d1\u30d6\u30ea\u30c3\u30af\u30af\u30e9\u30a6\u30c9\u4e0a\u3067\u30d5\u30a7\u30a4\u30eb\u30aa\u30fc\u30d0\u3055\u305b\u308b\u306e\u306f\u3057\u306a\u3044\u3002\u624b\u524d\u306bELB\u3092\u304b\u307e\u3059\u65b9\u5f0f\u3067\u3044\u304f\u3002\nprimitive p_zabbix ocf:heartbeat:zabbixserver \\\n        params binary=\"/usr/sbin/zabbix_server\" pid=\"/var/run/zabbix/zabbix_server.pid\" \\\n        op start interval=\"0\" timeout=\"20s\" \\\n        op monitor interval=\"10s\" timeout=\"20s\" \\\n        op stop interval=\"0\" timeout=\"20s\" \\\n        meta target-role=\"Started\"\ngroup grpZabbixServer p_zabbix p_postfix\nproperty $id=\"cib-bootstrap-options\" \\\n        dc-version=\"1.0.13-30bb726\" \\\n        cluster-infrastructure=\"Heartbeat\" \\\n        stonith-enabled=\"false\" \\\n        no-quorum-policy=\"ignore\" \\\n        last-lrm-refresh=\"1466682065\"\n\n\u30fb\u30ea\u30bd\u30fc\u30b9\u767b\u9332\u3092\u3059\u308b\n\u2193ocf\u3060\u3068\u30ea\u30bd\u30fc\u30b9\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u304c\u306a\u3044\u3068\u3044\u308f\u308c\u3066\u3057\u307e\u3046\u306e\u3067\u3068\u308a\u3042\u3048\u305azabbix\u306fsystemd\u3092\u3064\u304b\u3046\u3053\u3068\u306b\u3002\npcs resource create p_zabbix ocf:heartbeat:zabbixserver \\\n params binary=\"/usr/sbin/zabbix_server\" pid=\"/var/run/zabbix/zabbix_server.pid\" \\\n op monitor interval=\"10s\" timeout=\"20s\" \\\n op stop interval=\"0\" timeout=\"20s\" \\\n meta target-role=\"Started\"\nError: Unable to create resource 'ocf:heartbeat:zabbixserver', it is not installed on this system (use --force to override)\n\n# pcs resource show\n Resource Group: grpZabbixServer\n     zabbix_server      (systemd:zabbix-server):        Stopped\n     WebSite    (ocf::heartbeat:apache):        Stopped\n\nzabbix\u306fsystemd\u3067\u304c\u3093\u3070\u308b\npcs resource create web_server systemd:httpd op monitor interval=10s\npcs resource group add grpZabbixServer web_server\npcs constraint colocation add web_server zabbix_server INFINITY\n\n# pcs resource show\n Resource Group: grpZabbixServer\n     zabbix_server      (systemd:zabbix-server):        Started monitor-mng-cent7-test-komi01\n     web_server (systemd:httpd):        Started monitor-mng-cent7-test-komi01\n\n\u30fb\u30b9\u30c6\u30fc\u30bf\u30b9\u78ba\u8a8d\n# pcs status\nCluster name: zabbixcluster\nLast updated: Tue Jul 12 06:39:36 2016          Last change: Tue Jul 12 06:39:17 2016 by root via crm_attribute on monitor-mng-cent7-test-komi01\nStack: corosync\nCurrent DC: monitor-mng-cent7-test-komi01 (version 1.1.13-10.el7_2.2-44eb2dd) - partition WITHOUT quorum\n2 nodes and 2 resources configured\n\nOnline: [ monitor-mng-cent7-test-komi01 ]\nOFFLINE: [ monitor-mng-cent7-test-komi02 ]\n\nFull list of resources:\n\n Resource Group: grpZabbixServer\n     zabbix_server      (systemd:zabbix-server):        Started monitor-mng-cent7-test-komi01\n     WebSite    (ocf::heartbeat:apache):        Stopped\n\nFailed Actions:\n* WebSite_start_0 on monitor-mng-cent7-test-komi01 'unknown error' (1): call=13, status=Timed Out, exitreason='none',\n    last-rc-change='Tue Jul 12 06:39:09 2016', queued=0ms, exec=40002ms\n\n\nPCSD Status:\n  monitor-mng-cent7-test-komi01: Online\n  monitor-mng-cent7-test-komi02: Online\n\nDaemon Status:\n  corosync: active/disabled\n  pacemaker: active/disabled\n  pcsd: active/enabled\n\n\u30fbconfig\u3092\u78ba\u8a8d\n# pcs config show\nCluster Name: zabbixcluster\nCorosync Nodes:\n monitor-mng-cent7-test-komi01 monitor-mng-cent7-test-komi02 \nPacemaker Nodes:\n monitor-mng-cent7-test-komi01 monitor-mng-cent7-test-komi02 \n\nResources: \n Group: grpZabbixServer\n  Resource: zabbix_server (class=systemd type=zabbix-server)\n   Operations: monitor interval=10s (zabbix_server-monitor-interval-10s)\n  Resource: WebSite (class=ocf provider=heartbeat type=apache)\n   Attributes: configfile=/etc/httpd/conf/httpd.conf statusurl=http://localhost/server-status \n   Operations: start interval=0s timeout=40s (WebSite-start-interval-0s)\n               stop interval=0s timeout=60s (WebSite-stop-interval-0s)\n               monitor interval=1min (WebSite-monitor-interval-1min)\n\nStonith Devices: \nFencing Levels: \n\nLocation Constraints:\nOrdering Constraints:\nColocation Constraints:\n  WebSite with zabbix_server (score:INFINITY) (id:colocation-WebSite-zabbix_server-INFINITY)\n\nResources Defaults:\n resource-stickiness: INFINITY\n migration-threshold: 1\nOperations Defaults:\n No defaults set\n\nCluster Properties:\n cluster-infrastructure: corosync\n cluster-name: zabbixcluster\n dc-version: 1.1.13-10.el7_2.2-44eb2dd\n default-action-timeout: 240\n default-resource-stickiness: 200\n have-watchdog: false\n no-quorum-policy: ignore\n stonith-enabled: false\n\n# corosync-cmapctl | grep members\nruntime.totem.pg.mrp.srp.members.1.config_version (u64) = 0\nruntime.totem.pg.mrp.srp.members.1.ip (str) = r(0) ip(127.0.0.1) \u2190\u3053\u3053\u304c\u307e\u305a\u3044\u3063\u307d\u3044\nruntime.totem.pg.mrp.srp.members.1.join_count (u32) = 1\nruntime.totem.pg.mrp.srp.members.1.status (str) = joined\n\n\u3069\u3046\u3082hosts\u306e\u4e00\u884c\u76ee\u306b\u30af\u30e9\u30b9\u30bf\u767b\u9332\u306b\u6307\u5b9a\u3057\u305f\u30db\u30b9\u30c8\u540d\u3092\u66f8\u304f\u306e\u304c\u307e\u305a\u3044\u3063\u307d\u3044\n# vi /etc/hosts\n127.0.0.1  monitor-mng-cent7-test-komi01  localhost localhost.localdomain localhost4 localhost4.localdomain4\n\u3000\u2193\n127.0.0.1    localhost localhost.localdomain localhost4 localhost4.localdomain4\n\n\u306a\u304a\u3057\u3066\n# pcs cluster stop --all\n# pcs cluster start --all\n# pcs status\n\n\u3053\u308c\u3092\u7e70\u308a\u8fd4\u3057\u305f\u3068\u3053\u308d\u76f4\u3063\u305f\u3057Online\u304c\u4e21\u65b9\u306b\u306a\u3063\u305f\u6a21\u69d8\u3002\n# corosync-cmapctl | grep members\nruntime.totem.pg.mrp.srp.members.1.config_version (u64) = 0\nruntime.totem.pg.mrp.srp.members.1.ip (str) = r(0) ip(192.168.3.103) \nruntime.totem.pg.mrp.srp.members.1.join_count (u32) = 1\nruntime.totem.pg.mrp.srp.members.1.status (str) = joined\nruntime.totem.pg.mrp.srp.members.2.config_version (u64) = 0\nruntime.totem.pg.mrp.srp.members.2.ip (str) = r(0) ip(192.168.3.104) \nruntime.totem.pg.mrp.srp.members.2.join_count (u32) = 1\nruntime.totem.pg.mrp.srp.members.2.status (str) = joined\n\n\u3061\u306a\u307f\u306b\u8d77\u52d5\u4e2d\u306b\n/etc/corosync/corosync.conf\u306e\u30ce\u30fc\u30c9\u540d\u3092\u5909\u3048\u305f\u308a\u3059\u308b\u3068pcs cluster stop\u304c\u3067\u304d\u306a\u304f\u306a\u308b\u6a21\u69d8\u3002\napache\u5074\u3082ocf\u3060\u3068\u30b9\u30c6\u30fc\u30bf\u30b9\u306b\u30d5\u30a7\u30a4\u30eb\u3067\u3066\u3044\u305f\nFailed Actions:\n* WebSite_start_0 on monitor-mng-cent7-test-komi01 'unknown error' (1): call=12, status=Timed Out, exitreason='none',\n    last-rc-change='Tue Jul 12 07:27:47 2016', queued=0ms, exec=40003ms\n\n\u3068\u308a\u3042\u3048\u305a\u3053\u308c(Fail)\u304c\u3067\u3066\u3044\u3066\u5207\u308a\u66ff\u308f\u308b\u3053\u3068\u306f\u3042\u308a\u3048\u306a\u3044\u3002\n\u30fbcib\u3092\u78ba\u8a8d\u3057\u3066\u307f\u308b\n# pcs cluster cib\n\u51fa\u529b\u7d50\u679c\u306f\u9577\u3044\u306e\u3067\u7701\u7565\n\n# cibadmin --query\u3067\u3082\u540c\u3058\u306e\u51fa\u308b\u3002\n\u30fbFailCount\u306e\u30af\u30ea\u30a2\u65b9\u6cd5\n# pcs resource cleanup WebSite\nWaiting for 4 replies from the CRMd.... OK\nCleaning up zabbix_server on monitor-mng-cent7-test-komi01, removing fail-count-zabbix_server\nCleaning up zabbix_server on monitor-mng-cent7-test-komi02, removing fail-count-zabbix_server\nCleaning up WebSite on monitor-mng-cent7-test-komi01, removing fail-count-WebSite\nCleaning up WebSite on monitor-mng-cent7-test-komi02, removing fail-count-WebSite\n\n# pcs status\nCluster name: zabbixcluster\nLast updated: Tue Jul 12 08:52:30 2016          Last change: Tue Jul 12 08:52:16 2016 by hacluster via crmd on monitor-mng-cent7-test-komi01\nStack: corosync\nCurrent DC: monitor-mng-cent7-test-komi02 (version 1.1.13-10.el7_2.2-44eb2dd) - partition with quorum\n2 nodes and 2 resources configured\n\nOnline: [ monitor-mng-cent7-test-komi01 monitor-mng-cent7-test-komi02 ]\n\nFull list of resources:\n\n Resource Group: grpZabbixServer\n     zabbix_server      (systemd:zabbix-server):        Started monitor-mng-cent7-test-komi02\n     WebSite    (ocf::heartbeat:apache):        Started monitor-mng-cent7-test-komi02\n\nPCSD Status:\n  monitor-mng-cent7-test-komi01: Online\n  monitor-mng-cent7-test-komi02: Online\n\nDaemon Status:\n  corosync: active/disabled\n  pacemaker: active/disabled\n  pcsd: active/enabled\n\n\u3044\u3044\u611f\u3058\u306b\u30af\u30ea\u30a2\u3055\u308c\u305f\u3002\n\u30fb\u3053\u3053\u304b\u3089\u5207\u308a\u66ff\u3048\u30c6\u30b9\u30c8\uff08\u9577\u3044\uff09\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u3066\u307f\u3066\u3082\u5168\u304f\u79fb\u52d5\u3057\u306a\u304b\u3063\u305f\u3002\n# pcs resource move zabbix_server monitor-mng-cent7-test-komi01\n\n2\u5074\u3092\u30b9\u30bf\u30f3\u30d0\u30a4\u306b\u3059\u308b\u30b3\u30de\u30f3\u30c9\u3092\u6253\u3063\u3066\u307f\u305f\u3068\u3053\u308d\u30ea\u30bd\u30fc\u30b9\u304c\u79fb\u3063\u305f\n# pcs cluster standby monitor-mng-cent7-test-komi02\n\n# pcs cluster unstandby --all\n\n\u3068\u3059\u308b\u306801\u5074\u3067web\u304c\u843d\u3061\u3066\u308b\u6271\u3044\u306e\u3068\u304d\u300102\u5074\u306b\u30ea\u30bd\u30fc\u30b9\u304c\u79fb\u52d5\u3057\u3066\u5168\u30ea\u30bd\u30fc\u30b9start\u3059\u308b\n# pcs status\nCluster name: zabbixcluster\nLast updated: Tue Jul 12 09:25:28 2016          Last change: Tue Jul 12 09:23:35 2016 by root via crm_attribute on monitor-mng-cent7-test-komi01\nStack: corosync\nCurrent DC: monitor-mng-cent7-test-komi02 (version 1.1.13-10.el7_2.2-44eb2dd) - partition with quorum\n2 nodes and 2 resources configured\n\nOnline: [ monitor-mng-cent7-test-komi01 monitor-mng-cent7-test-komi02 ]\n\nFull list of resources:\n\n Resource Group: grpZabbixServer\n     zabbix_server      (systemd:zabbix-server):        Started monitor-mng-cent7-test-komi02\n     WebSite    (ocf::heartbeat:apache):        Started monitor-mng-cent7-test-komi02\n\nFailed Actions:\n* WebSite_start_0 on monitor-mng-cent7-test-komi01 'unknown error' (1): call=42, status=Timed Out, exitreason='none',\n    last-rc-change='Tue Jul 12 09:21:27 2016', queued=0ms, exec=40002ms\n\n\nPCSD Status:\n  monitor-mng-cent7-test-komi01: Online\n  monitor-mng-cent7-test-komi02: Online\n\nDaemon Status:\n  corosync: active/disabled\n  pacemaker: active/disabled\n  pcsd: active/enabled\n\nFailedAction\u3067\u3066\u308b\u306e\u306focf\u304clocalhost\u306eServer-status\u3068\u304b\u307f\u3066\u305f\u305f\u3081\u3002\n\u78ba\u304b\u306bserver-status\u3092curl\u3067\u307f\u308b\u3068404\u306a\u306e\u3067\u305d\u306e\u305b\u3044\u3060\u3063\u305f\u6a21\u69d8\u3002\n\u30b9\u30c6\u30fc\u30bf\u30b9\u307e\u3067\u898b\u3066\u304f\u308c\u306a\u304f\u3066\u3044\u3044\u3068\u601d\u3044\u65e5\u548c\u3063\u3066systemd\u306b\u5909\u3048\u307e\u3057\u305f\u3002\ncurl http://localhost/server-status\n\n\u30ea\u30bd\u30fc\u30b9\u3092\u6d88\u3057\u3066systemd\u306e\u30ea\u30bd\u30fc\u30b9\u3092\u767b\u9332\u3057\u3066\u307f\u308b\n# pcs resource delete WebSite\n# pcs resource show\n Resource Group: grpZabbixServer\n     zabbix_server      (systemd:zabbix-server):        Started monitor-mng-cent7-test-komi01\n\napache\u3082ocf\u304c\u96e3\u3057\u3044\u306e\u3067systemd\u3067\u304c\u3093\u3070\u308b\u3002systemd\u3060\u3068\u30ea\u30bd\u30fc\u30b9\u3064\u304b\u3093\u3067\u308b\u9593\u306b\u30b5\u30fc\u30d3\u30b9\u518d\u8d77\u52d5\u3068\u304b\u3067\u304d\u306a\u304f\u306a\u308b\u306e\u3067\u3044\u3044\u611f\u3058\u306b\u601d\u308f\u308c\u308b\u3002\npcs resource create web_server systemd:httpd op monitor interval=10s\npcs resource group add grpZabbixServer web_server\npcs constraint colocation add web_server zabbix_server INFINITY\n\n# pcs resource show\n Resource Group: grpZabbixServer\n     zabbix_server      (systemd:zabbix-server):        Started monitor-mng-cent7-test-komi01\n     web_server (systemd:httpd):        Started monitor-mng-cent7-test-komi01\n\n# pcs status\nCluster name: zabbixcluster\nLast updated: Tue Jul 12 10:05:04 2016          Last change: Tue Jul 12 10:02:54 2016 by root via cibadmin on monitor-mng-cent7-test-komi01\nStack: corosync\nCurrent DC: monitor-mng-cent7-test-komi02 (version 1.1.13-10.el7_2.2-44eb2dd) - partition with quorum\n2 nodes and 2 resources configured\n\nNode monitor-mng-cent7-test-komi02: standby\nOnline: [ monitor-mng-cent7-test-komi01 ]\n\nFull list of resources:\n\n Resource Group: grpZabbixServer\n     zabbix_server      (systemd:zabbix-server):        Started monitor-mng-cent7-test-komi01\n     web_server (systemd:httpd):        Started monitor-mng-cent7-test-komi01\n\nPCSD Status:\n  monitor-mng-cent7-test-komi01: Online\n  monitor-mng-cent7-test-komi02: Online\n\nDaemon Status:\n  corosync: active/disabled\n  pacemaker: active/disabled\n  pcsd: active/enabled\n\n\u30fb\u30b9\u30bf\u30f3\u30d0\u30a4\u89e3\u9664\n# pcs cluster unstandby --all\n# pcs status\nCluster name: zabbixcluster\nLast updated: Tue Jul 12 10:05:52 2016          Last change: Tue Jul 12 10:05:50 2016 by root via crm_attribute on monitor-mng-cent7-test-komi01\nStack: corosync\nCurrent DC: monitor-mng-cent7-test-komi02 (version 1.1.13-10.el7_2.2-44eb2dd) - partition with quorum\n2 nodes and 2 resources configured\n\nOnline: [ monitor-mng-cent7-test-komi01 monitor-mng-cent7-test-komi02 ]\n\nFull list of resources:\n\n Resource Group: grpZabbixServer\n     zabbix_server      (systemd:zabbix-server):        Started monitor-mng-cent7-test-komi01\n     web_server (systemd:httpd):        Started monitor-mng-cent7-test-komi01\n\nPCSD Status:\n  monitor-mng-cent7-test-komi01: Online\n  monitor-mng-cent7-test-komi02: Online\n\nDaemon Status:\n  corosync: active/disabled\n  pacemaker: active/disabled\n  pcsd: active/enabled\n\n01\u5074\uff1a\n# netstat -lnpt\nActive Internet connections (only servers)\nProto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    \ntcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      1020/sshd           \ntcp        0      0 0.0.0.0:10050           0.0.0.0:*               LISTEN      8723/zabbix_agentd  \ntcp        0      0 0.0.0.0:10051           0.0.0.0:*               LISTEN      19346/zabbix_server \ntcp6       0      0 :::80                   :::*                    LISTEN      20467/httpd         \ntcp6       0      0 :::2224                 :::*                    LISTEN      4141/ruby           \ntcp6       0      0 :::22                   :::*                    LISTEN      1020/sshd           \ntcp6       0      0 :::10050                :::*                    LISTEN      8723/zabbix_agentd  \ntcp6       0      0 :::10051                :::*                    LISTEN      19346/zabbix_server \n\n02\u5074\uff1a\n# netstat -lnpt\nActive Internet connections (only servers)\nProto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    \ntcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      1026/sshd           \ntcp6       0      0 :::2224                 :::*                    LISTEN      4268/ruby           \ntcp6       0      0 :::22                   :::*                    LISTEN      1026/sshd      \n\n\u3053\u306e\u307b\u3046\u304c\u3088\u3055\u3052\u3002\nocf\u3060\u3068pcs\u3067stop\u3067\u3082netstat\u3067\u307f\u308b\u3068\u8d77\u52d5\u3057\u3066\u308b\u304b\u3093\u3058\u3060\u3063\u305f\uff08\u4eee\u60f3IP\u3082\u4e00\u7dd2\u306b\u79fb\u3059\u308f\u3051\u3067\u306a\u304fELB\u3064\u304b\u3046\u524d\u63d0\u306a\u306e\u3067\u3001\u30c7\u30fc\u30bf\u91cd\u8907\u3057\u305d\u3046\u3067\u3042\u3076\u306a\u3044\u6319\u52d5\u306a\u6c17\u304c\u3057\u305f\uff09\u3002\n\u3061\u3087\u3063\u3068\u5207\u308a\u66ff\u3048\u3066\u307f\u308b\n# pcs cluster stop monitor-mng-cent7-test-komi01\nmonitor-mng-cent7-test-komi01: Stopping Cluster (pacemaker)...\nmonitor-mng-cent7-test-komi01: Stopping Cluster (corosync)...\n\n\u7121\u4e8b\u306b\u30ea\u30bd\u30fc\u30b9\u304c\u79fb\u52d5\u3002\n# pcs status\nCluster name: zabbixcluster\nLast updated: Tue Jul 12 10:18:01 2016          Last change: Tue Jul 12 10:05:50 2016 by root via crm_attribute on monitor-mng-cent7-test-komi01\nStack: corosync\nCurrent DC: monitor-mng-cent7-test-komi02 (version 1.1.13-10.el7_2.2-44eb2dd) - partition with quorum\n2 nodes and 2 resources configured\n\nOnline: [ monitor-mng-cent7-test-komi02 ]\nOFFLINE: [ monitor-mng-cent7-test-komi01 ]\n\nFull list of resources:\n\n Resource Group: grpZabbixServer\n     zabbix_server      (systemd:zabbix-server):        Started monitor-mng-cent7-test-komi02\n     web_server (systemd:httpd):        Started monitor-mng-cent7-test-komi02\n\nPCSD Status:\n  monitor-mng-cent7-test-komi01: Online\n  monitor-mng-cent7-test-komi02: Online\n\nDaemon Status:\n  corosync: active/disabled\n  pacemaker: active/disabled\n  pcsd: active/enabled\n\n\u843d\u3068\u3057\u305f\u307b\u3046\u3092\u8d77\u52d5\u3057\u3066\u307f\u3066\u3001\u30b9\u30c6\u30fc\u30bf\u30b9\u78ba\u8a8d\uff08\u8d77\u52d5\u3060\u3051\u3067\u30ea\u30bd\u30fc\u30b9\u304c\u79fb\u52d5\u3057\u306a\u3044\u3053\u3068\u306e\u78ba\u8a8d\uff09\n# pcs cluster start monitor-mng-cent7-test-komi01\n# pcs status\nCluster name: zabbixcluster\nLast updated: Tue Jul 12 10:19:19 2016          Last change: Tue Jul 12 10:05:50 2016 by root via crm_attribute on monitor-mng-cent7-test-komi01\nStack: corosync\nCurrent DC: monitor-mng-cent7-test-komi02 (version 1.1.13-10.el7_2.2-44eb2dd) - partition with quorum\n2 nodes and 2 resources configured\n\nOnline: [ monitor-mng-cent7-test-komi01 monitor-mng-cent7-test-komi02 ]\n\nFull list of resources:\n\n Resource Group: grpZabbixServer\n     zabbix_server      (systemd:zabbix-server):        Started monitor-mng-cent7-test-komi02\n     web_server (systemd:httpd):        Started monitor-mng-cent7-test-komi02\n\nPCSD Status:\n  monitor-mng-cent7-test-komi01: Online\n  monitor-mng-cent7-test-komi02: Online\n\nDaemon Status:\n  corosync: active/disabled\n  pacemaker: active/disabled\n  pcsd: active/enabled\n\n\u3068\u304f\u306b\u554f\u984c\u306a\u3055\u305d\u3046\u3002\n[root@monitor-mng-cent7-test-komi02 zabbix-server-mysql-3.0.3]# netstat -lnpt\nActive Internet connections (only servers)\nProto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    \ntcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      1026/sshd           \ntcp        0      0 0.0.0.0:10051           0.0.0.0:*               LISTEN      21196/zabbix_server \ntcp6       0      0 :::80                   :::*                    LISTEN      21236/httpd         \ntcp6       0      0 :::2224                 :::*                    LISTEN      4268/ruby           \ntcp6       0      0 :::22                   :::*                    LISTEN      1026/sshd           \ntcp6       0      0 :::10051                :::*                    LISTEN      21196/zabbix_server \n[root@monitor-mng-cent7-test-komi01 yum.repos.d]# netstat -lnpt\nActive Internet connections (only servers)\nProto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    \ntcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      1020/sshd           \ntcp        0      0 0.0.0.0:10050           0.0.0.0:*               LISTEN      8723/zabbix_agentd  \ntcp6       0      0 :::2224                 :::*                    LISTEN      4141/ruby           \ntcp6       0      0 :::22                   :::*                    LISTEN      1020/sshd           \ntcp6       0      0 :::10050                :::*                    LISTEN      8723/zabbix_agentd  \n\n\u3067\u306f\u300102\u3092standby\u306b\u3057\u3066\u30ea\u30bd\u30fc\u30b9\u3092\u79fb\u52d5\u3057\u3066\u307f\u308b\n# pcs cluster standby monitor-mng-cent7-test-komi02\n# pcs status\nCluster name: zabbixcluster\nLast updated: Tue Jul 12 10:22:36 2016          Last change: Tue Jul 12 10:22:23 2016 by root via crm_attribute on monitor-mng-cent7-test-komi02\nStack: corosync\nCurrent DC: monitor-mng-cent7-test-komi02 (version 1.1.13-10.el7_2.2-44eb2dd) - partition with quorum\n2 nodes and 2 resources configured\n\nNode monitor-mng-cent7-test-komi02: standby\nOnline: [ monitor-mng-cent7-test-komi01 ]\n\nFull list of resources:\n\n Resource Group: grpZabbixServer\n     zabbix_server      (systemd:zabbix-server):        Started monitor-mng-cent7-test-komi01\n     web_server (systemd:httpd):        Started monitor-mng-cent7-test-komi01\n\nPCSD Status:\n  monitor-mng-cent7-test-komi01: Online\n  monitor-mng-cent7-test-komi02: Online\n\nDaemon Status:\n  corosync: active/disabled\n  pacemaker: active/disabled\n  pcsd: active/enabled\n\n# pcs cluster unstandby --all\n# pcs status\nCluster name: zabbixcluster\nLast updated: Tue Jul 12 10:24:34 2016          Last change: Tue Jul 12 10:24:31 2016 by root via crm_attribute on monitor-mng-cent7-test-komi02\nStack: corosync\nCurrent DC: monitor-mng-cent7-test-komi02 (version 1.1.13-10.el7_2.2-44eb2dd) - partition with quorum\n2 nodes and 2 resources configured\n\nOnline: [ monitor-mng-cent7-test-komi01 monitor-mng-cent7-test-komi02 ]\n\nFull list of resources:\n\n Resource Group: grpZabbixServer\n     zabbix_server      (systemd:zabbix-server):        Started monitor-mng-cent7-test-komi01\n     web_server (systemd:httpd):        Started monitor-mng-cent7-test-komi01\n\nPCSD Status:\n  monitor-mng-cent7-test-komi01: Online\n  monitor-mng-cent7-test-komi02: Online\n\nDaemon Status:\n  corosync: active/disabled\n  pacemaker: active/disabled\n  pcsd: active/enabled\n\n\u3072\u3068\u307e\u305a\u624b\u52d5\u5207\u308a\u66ff\u3048\u30c6\u30b9\u30c8\u5b8c\u4e86\u3002Fail\u306e\u30af\u30ea\u30a2\u306e\u624b\u9806\u3082\u7279\u5b9a\u3067\u304d\u305f\u3002\n\uff08\u3053\u308c\u3092chef\u306b\u3057\u306a\u3044\u3068\u306a\u30fc\u3002\u3002\uff09\n\u30fb\u30ed\u30b0\u307e\u308f\u308a\n/var/log/cluster/corosync.log\u306b\u305d\u308c\u3089\u3057\u3044\u306e\u304c\u5b58\u5728\u3059\u308b\n\u7279\u5b9a\u306e\u6642\u9593\u5206\u53d6\u308a\u51fa\u3059\u65b9\u6cd5\n# pcs cluster report --from \"2016-07-12 09:00:00\" /tmp/dest\n# ll /tmp\ntotal 60\n-rw-r--r-- 1 root root 54519 Jul 12 10:35 dest.tar.bz2\n\n\u3053\u3093\u306a\u304b\u3093\u3058\u3067\u3067\u3066\u304f\u308b\u3002\u4ee5\u4e0b\u306e\u3088\u3046\u306bto\u306e\u6307\u5b9a\u3082\u53ef\u80fd\u3002\nreport [--from \"YYYY-M-D H:M:S\" [--to \"YYYY-M-D\" H:M:S\"]] dest\n\n\u30fb\u30d5\u30a7\u30a4\u30eb\u56de\u6570\u3092\u7279\u5b9a\n#  pcs resource failcount show zabbix_server\nNo failcounts for zabbix_server\n\n\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u306b\u69d8\u5b50\u3092\u307f\u308b\u306b\u306f\nwatch pcs status\u3068\u304b\u3059\u308b\u3057\u304b\u306a\u3055\u305d\u3046\uff08help\u3092\u773a\u3081\u3066\u307f\u3066\uff09\n\u3068\u308a\u3042\u3048\u305a\u4ee5\u4e0a\u3001\u4ee5\u4e0b\u53c2\u8003\u3002\n\u53c2\u8003\uff1a\nhttp://kan3aa.hatenablog.com/entry/2015/06/05/135150\nhttps://blog.apar.jp/zabbix/4177/\nhttp://weblabo.oscasierra.net/installing-mysql57-centos7-yum/\nhttp://doruby.kbmj.com/taka/20131018/yum_update_crm_pcs_\nhttp://infra.blog.shinobi.jp/Entry/107/\nhttp://blog.matsumoto-r.jp/?p=3482\nhttps://ericsysmin.com/2016/02/18/configuring-high-availability-ha-zabbix-server-on-centos-7/\nhttps://gist.github.com/kogoto/92eef35b28ae632a11f7\n# pcs cluster --help\nhttp://yomon.hatenablog.com/entry/2016/04/13/110035\nhttp://qiita.com/tukiyo3/items/27dcc7f15a8b4e4cf8a5\n# pcs resource --help\nhttps://access.redhat.com/documentation/ja-JP/Red_Hat_Enterprise_Linux/6/html/Configuring_the_Red_Hat_High_Availability_Add-On_with_Pacemaker/ch-clustresources-HAAR.html\nCentOS7\u304b\u3089crm\u304c\u4f7f\u3048\u306a\u304f\u306a\u308b\u306e\u3067pcs\u3067zabbix\u30b5\u30fc\u30d0\u306e\u5197\u9577\u69cb\u6210\u3092\u304c\u3093\u3070\u3063\u3066\u307f\u3088\u3046\u3068\u3044\u3046\u8a18\u9332\u3067\u3059\u3002\n\u76e3\u8996\u30b5\u30fc\u30d0\u304c\u9577\u6642\u9593\u76e3\u8996\u3067\u304d\u306a\u304f\u3063\u3066\u5fa9\u65e7\u306b\u6642\u9593\u304c\u304b\u304b\u308b\u3068\u304b\u5272\u3068\u3042\u308a\u3048\u306a\u3044\u3068\u3044\u3046\u304b\u3001\u3082\u3057\u4e3b\u7cfb\u304c\u3057\u3093\u3067\u3082\u5f85\u6a5f\u7cfb\u304c\u3059\u3050\u751f\u304d\u8fd4\u308b\u3088\u3046\u306b\u3057\u305f\u3044\u3057\u6df1\u591c\u65e9\u671d\u306b\u6642\u9593\u306e\u304b\u304b\u308b\u5fa9\u65e7\u306b\u501f\u308a\u51fa\u3055\u308c\u305f\u3089\u8d85\u3044\u3084\u3060\u3057\u30df\u30b9\u308b\u3068\u5371\u306a\u3044\u304b\u3089\u81ea\u52d5\u5316\u4e0d\u53ef\u907f\u3068\u3044\u3046\u8a8d\u8b58\u3067\u3059\u3002\n\u3082\u306f\u3084\u624b\u52d5\u904b\u7528\u3067\u30ab\u30d0\u30fc\u3068\u304b\u7b4b\u8089\u904b\u7528\u3068\u304b\u30e0\u30ea\u306a\u304a\u5e74\u9803\u3067\u3059\u307f\u307e\u305b\u3093\u3002\u5bdd\u306a\u3044\u3068\u5bff\u547d\u304c\u3061\u3062\u307f\u305d\u3046\u3002\u5065\u5eb7\u8d85\u3060\u3044\u3058\u3002\n\n\u30fb\u30db\u30b9\u30c8\u540d\u3092\u4ed8\u3051\u76f4\u3059\uff08set-hostname\u3092\u6307\u5b9a\u3059\u308b\u3068\u518d\u8d77\u52d5\u5f8c\u3082\u53cd\u6620\u3055\u308c\u308b\uff09\n\n```\n# hostnamectl set-hostname monitor-mng-cent7-test-komi01\n# hostnamectl set-hostname monitor-mng-cent7-test-komi02\n\n```\n\n\uff08\u691c\u8a3c\u306a\u306e\u3067\u3072\u3089\u304d\u306a\u304a\u3063\u3066root\u3067\u3084\u3063\u3066\u307e\u3059\u304c\u305d\u3046\u3067\u306a\u3044\u5834\u5408\u306fsudo\u3064\u3051\u3066\u304f\u3060\u3055\u3044\u3002\uff09\n\n\u30fbhosts\u3092\u306a\u304a\u3059\n\n```\n# vi /etc/hosts\n127.0.0.1  localhost localhost.localdomain localhost4 localhost4.localdomain4\n#::1         localhost localhost.localdomain localhost6 localhost6.localdomain6\n\n192.168.3.104   monitor-mng-cent7-test-komi02 mon7-2\n192.168.3.103   monitor-mng-cent7-test-komi01 mon7-1 localhost\n```\n\n\u4e00\u884c\u76ee\u306b\u306a\u3093\u304b\u8ffd\u8a18\u3059\u308b\u3068\u5909\u306a\u52d5\u304d\u3057\u3066\u305f\u3002\nlocalhost\u3092\u81ea\u5206\u306e\u884c\uff081\u884c\u76ee\u4ee5\u5916\uff09\u306b\u66f8\u304f\u5fc5\u8981\u304c\u3042\u308b\u304b\u306f\u78ba\u304b\u3081\u304d\u308c\u3066\u3044\u306a\u3044\u304d\u304c\u3059\u308b\u3002\n\n\u30fb\u3044\u3061\u304a\u3046\u758e\u901a\u78ba\u8a8d\n\n```\n# ping mon7-1\n# ping mon7-2\n```\n\n\u30fb\u30af\u30e9\u30b9\u30bf\u5236\u5fa1\u30bd\u30d5\u30c8\u3092\u5165\u308c\u308b\n\n```\n# yum clean all\n# yum install --enablerepo base pcs fence-agents-all\n```\n\n\u30fb\u52dd\u624b\u306b\u5165\u3063\u305f\u30e6\u30fc\u30b6\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u66f4\u65b0\uff08\u3042\u3068\u3067\u30ce\u30fc\u30c9\u767b\u9332\u306e\u3068\u304d\u306b\u30d1\u30b9\u30ef\u30fc\u30c9\u3064\u304b\u3046\uff09\n\n```\n# passwd hacluster\n****\n```\n\n\u30fbpcsd\u3092\u8d77\u52d5\u3001\u6709\u52b9\u5316\n\n```\n# systemctl start pcsd\n# systemctl enable pcsd\n\n# systemctl status pcsd\n\u25cf pcsd.service - PCS GUI and remote configuration interface\n   Loaded: loaded (/usr/lib/systemd/system/pcsd.service; enabled; vendor preset: disabled)\n   Active: active (running) since Tue 2016-07-12 01:26:04 UTC; 55s ago\n Main PID: 3679 (pcsd)\n   CGroup: /system.slice/pcsd.service\n           \u251c\u25003679 /bin/sh /usr/lib/pcsd/pcsd start\n           \u251c\u25003683 /bin/bash -c ulimit -S -c 0 >/dev/null 2>&1 ; /usr/bin/ruby -I/usr/lib/pcsd /usr/lib/...\n           \u2514\u25003684 /usr/bin/ruby -I/usr/lib/pcsd /usr/lib/pcsd/ssl.rb\n\nJul 12 01:26:04 monitor-mng-cent7-test-komi01 systemd[1]: Starting PCS GUI and remote configuration i.....Jul 12 01:26:04 monitor-mng-cent7-test-komi01 systemd[1]: Started PCS GUI and remote configuration in...e.Hint: Some lines were ellipsized, use -l to show in full.\n```\n\n\u30fb\u30ce\u30fc\u30c9\u3092\u8a8d\u8a3c\u3059\u308b\n\n```\n# pcs cluster auth monitor-mng-cent7-test-komi01 monitor-mng-cent7-test-komi02 -u hacluster -p ***** --force\nmonitor-mng-cent7-test-komi01: Authorized\nmonitor-mng-cent7-test-komi02: Authorized\n```\n\n\u30fb\u30af\u30e9\u30b9\u30bf\u3092\u4f5c\u6210\u3059\u308b\n\u7247\u65b9\u3067\u4e00\u56de\u3060\u3051\n\n```\n# pcs cluster setup --name zabbixcluster monitor-mng-cent7-test-komi01 monitor-mng-cent7-test-komi02\nShutting down pacemaker/corosync services...\nRedirecting to /bin/systemctl stop  pacemaker.service\nRedirecting to /bin/systemctl stop  corosync.service\nKilling any remaining services...\nRemoving all cluster configuration files...\nmonitor-mng-cent7-test-komi01: Succeeded\nmonitor-mng-cent7-test-komi02: Succeeded\nSynchronizing pcsd certificates on nodes monitor-mng-cent7-test-komi01, monitor-mng-cent7-test-komi02...\nmonitor-mng-cent7-test-komi01: Success\nmonitor-mng-cent7-test-komi02: Success\n\nRestaring pcsd on the nodes in order to reload the certificates...\nmonitor-mng-cent7-test-komi01: Success\nmonitor-mng-cent7-test-komi02: Success\n```\n\n\u30fb\u30af\u30e9\u30b9\u30bf\u3092\u958b\u59cb\u3055\u305b\u308b\n\n```\n# pcs cluster start --all\nmonitor-mng-cent7-test-komi02: Starting Cluster...\nmonitor-mng-cent7-test-komi01: Starting Cluster...\n```\n\n\u30fb\u52d5\u4f5c\u78ba\u8a8d\n\n```\n# corosync-cfgtool -s\nPrinting ring status.\nLocal node ID 1\nRING ID 0\n        id      = 127.0.0.1\n        status  = ring 0 active with no faults\n```\n\n\"status\"\u304c\"active\"\u304b\u3064\"no faults\"\u3067\u3042\u308c\u3070\u3001\u554f\u984c\u306a\u304f\u901a\u4fe1\u304c\u884c\u3048\u3066\u3044\u308b\u3002\n\u540c\u69d8\u306b\u3001\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3067\u3082corosync\u306e\u52d5\u4f5c\u72b6\u6cc1\u3092\u78ba\u8a8d\u3067\u304d\u308b\u3002\n\n```\n# corosync-cmapctl | grep members\nruntime.totem.pg.mrp.srp.members.1.config_version (u64) = 0\nruntime.totem.pg.mrp.srp.members.1.ip (str) = r(0) ip(127.0.0.1) \nruntime.totem.pg.mrp.srp.members.1.join_count (u32) = 1\nruntime.totem.pg.mrp.srp.members.1.status (str) = joined\n\n# pcs status corosync\n\nMembership information\n----------------------\n    Nodeid      Votes Name\n         1          1 monitor-mng-cent7-test-komi01 (local)\n\n# ps aux|egrep -a 'PID|coro|pace'|grep -v grep\nUSER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND\nroot      4206  1.0  3.7 190580 38432 ?        Ssl  01:35   0:08 corosync\nroot      4221  0.0  0.7 130488  7240 ?        Ss   01:35   0:00 /usr/sbin/pacemakerd -f\nhaclust+  4222  0.0  1.3 131316 14016 ?        Ss   01:35   0:00 /usr/libexec/pacemaker/cib\nroot      4223  0.0  0.6 132924  6952 ?        Ss   01:35   0:00 /usr/libexec/pacemaker/stonithd\nroot      4224  0.0  0.4 102940  5000 ?        Ss   01:35   0:00 /usr/libexec/pacemaker/lrmd\nhaclust+  4225  0.0  0.6 124760  6720 ?        Ss   01:35   0:00 /usr/libexec/pacemaker/attrd\nhaclust+  4226  0.0  2.0 150972 20896 ?        Ss   01:35   0:00 /usr/libexec/pacemaker/pengine\nhaclust+  4227  0.0  1.0 184184 11068 ?        Ss   01:35   0:00 /usr/libexec/pacemaker/crmd\n\n\n# pcs status\nCluster name: zabbixcluster\nWARNING: no stonith devices and stonith-enabled is not false\nLast updated: Tue Jul 12 01:50:28 2016          Last change: Tue Jul 12 01:35:24 2016 by hacluster via crmd on monitor-mng-cent7-test-komi01\nStack: corosync\nCurrent DC: monitor-mng-cent7-test-komi01 (version 1.1.13-10.el7_2.2-44eb2dd) - partition WITHOUT quorum\n2 nodes and 0 resources configured\n\nNode monitor-mng-cent7-test-komi02: UNCLEAN (offline)\nOnline: [ monitor-mng-cent7-test-komi01 ]\n\nFull list of resources:\n\n\nPCSD Status:\n  monitor-mng-cent7-test-komi01: Online\n  monitor-mng-cent7-test-komi02: Online\n\nDaemon Status:\n  corosync: active/disabled\n  pacemaker: active/disabled\n  pcsd: active/enabled\n```\n\n\u203b\u4e0a\u306e\u62ec\u5f27\u5185\u306eOnline\u304clocalhost\u3060\u3051\u306b\u306a\u3063\u3066\u3057\u307e\u3046\u306e\u306f\u5192\u982d\u306ehosts\u306e\u3042\u305f\u308a\u306b\u66f8\u3044\u305f\u3068\u304a\u308a\u30c0\u30e1\u3067\u3059\u3002\n\n\u30fb\u8a2d\u5b9a\u3092\u78ba\u8a8d\n\n```\n# crm_verify -L -V\n   error: unpack_resources:     Resource start-up disabled since no STONITH resources have been defined\n   error: unpack_resources:     Either configure some or disable STONITH with the stonith-enabled option\n   error: unpack_resources:     NOTE: Clusters with shared data need STONITH to ensure data integrity\nErrors found during check: config not valid\n```\n\n\u30fbstonith\u3092\u7121\u52b9\u306b\u3059\u308b\uff08\u4e0a\u8a18error\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6d88\u3059\uff09\n\n```\npcs property set stonith-enabled=false\ncrm_verify -L -V\n```\n\n\u30fb\u30ea\u30bd\u30fc\u30b9\u8ffd\u52a0\u4f8b\uff08\u4eee\u60f3IP\u306e\u5834\u5408\uff09\n\n```\n\u30ea\u30bd\u30fc\u30b9ID\uff1aVIP\n\u30ea\u30bd\u30fc\u30b9\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\uff08RA\uff09\uff1a\"ocf:heartbeat:IPaddr2\"\nIP\u30a2\u30c9\u30ec\u30b9\uff1a192.168.56.10/24\uff08HostOnly\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30a2\u30c9\u30ec\u30b9\uff09\n\u76e3\u8996\u9593\u9694\uff1a10sec\n\n# pcs resource create VIP ocf:heartbeat:IPaddr2 \\\n    ip=192.168.56.10 cidr_netmask=24 op monitor interval=10s\n```\n\n\u3053\u3093\u306a\u304b\u3093\u3058\u307d\u3044\u3002\n\u306e\u3067\u3053\u308c\u3092\u53c2\u8003\u306b\u3042\u3068\u3067zabbix\u5165\u308c\u306a\u304a\u3057\u3066\u304b\u3089\u305d\u306e\u30ea\u30bd\u30fc\u30b9\u3092\u8ffd\u52a0\u3059\u308b\u3002\n\n\n\u3068\u308a\u3042\u3048\u305a\u306a\u3093\u3068\u306a\u304fzabbix\u3044\u308c\u306a\u304a\u3059\u3002\n\u305d\u306e\u307e\u3048\u306bMySQL\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5165\u308c\u308b\u3002\n\n\n\u30fbmysql\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3092\u3044\u308c\u308b\uff08\u672c\u4f53\u30c7\u30fc\u30bf\u306fRDS\u3067\u4fdd\u7ba1\u3059\u308b\u306e\u3067\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3060\u3051\u5165\u308c\u3068\u304f\uff09\n\n\u203b\u3044\u307e\u307e\u3067\u306e\u5165\u308c\u65b9\u306fchef\u3068\u306e\u76f8\u6027\u304c\u60aa\u304b\u3063\u305f\u306e\u3067\u30b3\u30df\u30e5\u30cb\u30c6\u30a3\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u3092\u63a1\u7528\u3057\u3066\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5165\u308c\u308b\u3053\u3068\u306b\u3057\u3088\u3046\u304b\u3068\u3002\n\nRDS\u306fmaria\u306f\u4f7f\u3048\u306a\u3044\u6c17\u304c\u3059\u308b\u306e\u3067\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u6d88\u3059\uff08CentOS7\u304b\u3089maria\u3055\u3093\u306elib\u304c\u6a19\u6e96\u3067\u5165\u3063\u3066\u3044\u308b\u6a21\u69d8\uff09\n\n```\nyum remove mariadb-libs\n==========================================================================================================\n Package                       Arch             Version                         Repository           Size\n==========================================================================================================\nRemoving:\n mariadb-libs                  x86_64           1:5.5.44-2.el7.centos           installed           4.4 M\nRemoving for dependencies:\n php-mysql                     x86_64           5.4.16-36.1.el7_2.1             @updates            232 k\n postfix                       x86_64           2:2.10.1-6.el7                  installed            12 M\n zabbix-server-mysql           x86_64           3.0.3-1.el7                     @zabbix             3.3 M\n zabbix-web                    noarch           3.0.3-1.el7                     @zabbix              29 M\n zabbix-web-japanese           noarch           3.0.3-1.el7                     @zabbix             0.0  \n zabbix-web-mysql              noarch           3.0.3-1.el7                     @zabbix             0.0  \n\nTransaction Summary\n==========================================================================================================\nRemove  1 Package (+6 Dependent packages)\n```\n\n\u5148\u306bzabbix\u3092\u5165\u308c\u3066\u3057\u307e\u3046\u3068\u4f9d\u5b58\u3067\u4e38\u3054\u3068\u6d88\u3055\u308c\u308b\u306e\u3067\u6ce8\u610f\u3002\u624b\u9806\u306fzabbix\u3088\u308a*db-libs\u5165\u308c\u66ff\u3048\u3092\u771f\u3063\u5148\u306b\u3057\u305f\u307b\u3046\u304c\u3044\u3044\u3002\n\n```\nrm -rf /var/lib/mysql/\n\nyum localinstall http://dev.mysql.com/get/mysql57-community-release-el7-7.noarch.rpm\n\n# yum info mysql-community-server\n\nName        : mysql-community-server\nArch        : x86_64\nVersion     : 5.7.13\nRelease     : 1.el7\nSize        : 151 M\nRepo        : mysql57-community/x86_64\nSummary     : A very fast and reliable SQL database server\nURL         : http://www.mysql.com/\nLicense     : Copyright (c) 2000, 2016, Oracle and/or its affiliates. All rights reserved. Under GPLv2\n            : license as shown in the Description field.\nDescription : The MySQL(TM) software delivers a very fast, multi-threaded, multi-user,\n            : and robust SQL (Structured Query Language) database server. MySQL Server\n            : is intended for mission-critical, heavy-load production systems as well\n            : as for embedding into mass-deployed software. MySQL is a trademark of\n            : Oracle and/or its affiliates\n            : \n            : The MySQL software has Dual Licensing, which means you can use the MySQL\n            : software free of charge under the GNU General Public License\n            : (http://www.gnu.org/licenses/). You can also purchase commercial MySQL\n            : licenses from Oracle and/or its affiliates if you do not wish to be bound by the terms of\n            : the GPL. See the chapter \"Licensing and Support\" in the manual for\n            : further info.\n            : \n            : The MySQL web site (http://www.mysql.com/) provides the latest news and\n            : information about the MySQL software.  Also please see the documentation\n            : and the manual for more information.\n            : \n            : This package includes the MySQL server binary as well as related utilities\n            : to run and administer a MySQL server.\n\n\n# yum install mysql-community-client mysql-community-libs mysql-community-devel mysql-community-common\n\n# vi /etc/my.cnf\n[mysqldump]\nquick\nmax_allowed_packet = 16M\ndefault-character-set = utf8\n\n[mysql]\nno-auto-rehash\ndefault-character-set = utf8\n```\n\n\u30fbconfrict\u3057\u305f\u306e\u3067zabbix2.2\u3092\u524a\u9664\n\n```\nyum remove zabbix-relase zabbix-agent zabbix\nrpm -e zabbix-release\nrpm -qa|grep zabbix\n```\n\n\u30fbzabbix3.0\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u767b\u9332\n\n```\nrpm -ivh http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm\n```\n\n\u30fb\u672c\u4f53\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```\nyum -y install zabbix-server-mysql zabbix-web-mysql zabbix-web-japanese\n==========================================================================================================\n Package                       Arch         Version                      Repository                  Size\n==========================================================================================================\nInstalling:\n zabbix-server-mysql           x86_64       3.0.3-1.el7                  zabbix                     1.7 M\n zabbix-web-japanese           noarch       3.0.3-1.el7                  zabbix                     4.4 k\n zabbix-web-mysql              noarch       3.0.3-1.el7                  zabbix                     3.9 k\nInstalling for dependencies:\n OpenIPMI-libs                 x86_64       2.0.19-11.el7                base                       501 k\n dejavu-fonts-common           noarch       2.33-6.el7                   base                        64 k\n dejavu-sans-fonts             noarch       2.33-6.el7                   base                       1.4 M\n fontpackages-filesystem       noarch       1.44-8.el7                   base                       9.9 k\n fping                         x86_64       3.10-1.el7                   zabbix-non-supported        40 k\n httpd                         x86_64       2.4.6-40.el7.centos.1        updates                    2.7 M\n httpd-tools                   x86_64       2.4.6-40.el7.centos.1        updates                     82 k\n iksemel                       x86_64       1.4-2.el7.centos             zabbix-non-supported        49 k\n libXpm                        x86_64       3.5.11-3.el7                 base                        54 k\n libzip                        x86_64       0.10.1-8.el7                 base                        48 k\n php                           x86_64       5.4.16-36.1.el7_2.1          updates                    1.4 M\n php-bcmath                    x86_64       5.4.16-36.1.el7_2.1          updates                     56 k\n php-cli                       x86_64       5.4.16-36.1.el7_2.1          updates                    2.7 M\n php-common                    x86_64       5.4.16-36.1.el7_2.1          updates                    563 k\n php-gd                        x86_64       5.4.16-36.1.el7_2.1          updates                    126 k\n php-ldap                      x86_64       5.4.16-36.1.el7_2.1          updates                     51 k\n php-mbstring                  x86_64       5.4.16-36.1.el7_2.1          updates                    503 k\n php-mysql                     x86_64       5.4.16-36.1.el7_2.1          updates                     99 k\n php-pdo                       x86_64       5.4.16-36.1.el7_2.1          updates                     97 k\n php-xml                       x86_64       5.4.16-36.1.el7_2.1          updates                    124 k\n t1lib                         x86_64       5.1.2-14.el7                 base                       166 k\n unixODBC                      x86_64       2.3.1-11.el7                 base                       413 k\n vlgothic-p-fonts              noarch       20130607-2.el7               base                       2.2 M\n zabbix-web                    noarch       3.0.3-1.el7                  zabbix                     3.5 M\n\nTransaction Summary\n==========================================================================================================\nInstall  3 Packages (+24 Dependent packages)\n\nInstalled:\n  zabbix-server-mysql.x86_64 0:3.0.3-1.el7       zabbix-web-japanese.noarch 0:3.0.3-1.el7        zabbix-web-mysql.noarch 0:3.0.3-1.el7         \n\nDependency Installed:\n  OpenIPMI-libs.x86_64 0:2.0.19-11.el7          dejavu-fonts-common.noarch 0:2.33-6.el7       \n  dejavu-sans-fonts.noarch 0:2.33-6.el7         fontpackages-filesystem.noarch 0:1.44-8.el7   \n  fping.x86_64 0:3.10-4.el7                     httpd.x86_64 0:2.4.6-40.el7.centos.1          \n  httpd-tools.x86_64 0:2.4.6-40.el7.centos.1    iksemel.x86_64 0:1.4-6.el7                    \n  libXpm.x86_64 0:3.5.11-3.el7                  libzip.x86_64 0:0.10.1-8.el7                  \n  php.x86_64 0:5.4.16-36.1.el7_2.1              php-bcmath.x86_64 0:5.4.16-36.1.el7_2.1       \n  php-cli.x86_64 0:5.4.16-36.1.el7_2.1          php-common.x86_64 0:5.4.16-36.1.el7_2.1       \n  php-gd.x86_64 0:5.4.16-36.1.el7_2.1           php-ldap.x86_64 0:5.4.16-36.1.el7_2.1         \n  php-mbstring.x86_64 0:5.4.16-36.1.el7_2.1     php-mysql.x86_64 0:5.4.16-36.1.el7_2.1        \n  php-pdo.x86_64 0:5.4.16-36.1.el7_2.1          php-xml.x86_64 0:5.4.16-36.1.el7_2.1          \n  t1lib.x86_64 0:5.1.2-14.el7                   unixODBC.x86_64 0:2.3.1-11.el7                \n  vlgothic-p-fonts.noarch 0:20130607-2.el7      zabbix-web.noarch 0:3.0.3-1.el7               \n\nComplete!\n```\n\n\u30fbagent\u305d\u306e\u305f\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```\n# yum -y install zabbix-agent\nRunning transaction\n  Installing : zabbix-agent-3.0.3-1.el7.x86_64                                                \n        1/1   Verifying  : zabbix-agent-3.0.3-1.el7.x86_64                                    \n                    1/1 \nInstalled:\n  zabbix-agent.x86_64 0:3.0.3-1.el7 \n\n# yum -y install zabbix-get\n\nInstalled:\n  zabbix-get.x86_64 0:3.0.3-1.el7     \n```\n\n\n\u30fbrds\u306e\u6e96\u5099\u3068zabbix\u7528\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u4f5c\u6210\n\nid\u3068pass\u3068schema\u3068host\u60c5\u5831\u3092\u63a7\u3048\u3066\u304a\u304f\uff08zabbix-server.conf\u306b\u3042\u3068\u3067\u304b\u304f\uff09\n\u5165\u308c\u305fmysql\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3067\u63a5\u7d9a\u78ba\u8a8d\u3057\u3066\u304a\u304f\u306e\u3068zabbix\u306b\u540c\u68b1\u306esql\u5b9f\u884c\u3059\u308b\n\n```\nmysql -u mn***_op -p -h monitor-test.****.rds.amazonaws.com\n\ncd /usr/share/doc/zabbix-server-mysql-3.0.3/\nzcat create.sql.gz | mysql -u mn***_op -p -h monitor-test.****.rds.amazonaws.com zabbix\n```\n\n\u30fbzabbix-server.conf\u307b\u304b\u306e\u8a2d\u5b9a\u3092\u3059\u308b\n\n```\n# vim /etc/zabbix/zabbix_server.conf\n```\n\nDBHost\u307b\u304b\u3092\u4fee\u6b63\n\n```\n# vim /etc/httpd/conf.d/zabbix.conf\n```\n\n\u30bf\u30a4\u30e0\u30be\u30fc\u30f3\u3092Asia/Tokyo\u306b\u4fee\u6b63\n\n```\n# vi /etc/httpd/conf.d/status.conf\nExtendedStatus on\n<Location /server-status>\nSetHandler server-status\nRequire ip 127.0.0.1\n</Location>\n```\n\nocf\u306eWEBServer\u7528\u306b\u5fc5\u8981\u306a\u62e1\u5f35\u30b9\u30c6\u30fc\u30bf\u30b9\u3092\u307f\u308c\u308b\u3088\u3046\u306b\u3059\u308b\u3084\u3064\n\n\n\u30fbURL\u30a2\u30af\u30bb\u30b9\u3057\u3066\u521d\u671f\u8a2d\u5b9a\n\nhttp://52.xxx.xxx.xxx/zabbix/\n\nDB\u60c5\u5831\u3092\u5165\u529b\u3057\u3066\u305d\u306e\u307e\u307e\u3059\u3059\u3080\n\n\u30fb\u30ea\u30bd\u30fc\u30b9\u3092\u767b\u9332\u3059\u308b\u305f\u3081\u306b\u65e2\u5b58\u306e\u60c5\u5831\u3092\u3068\u3063\u3066\u304f\u308b\n\n```\n$ sudo crm configure show\n```\n\npostfix\u306fActAct\u306b\u3057\u3066HA\u30ea\u30bd\u30fc\u30b9\u304b\u3089\u306f\u305a\u3057\u3001\u305d\u3053\u3092apache\u7528\u306b\u5909\u3048\u308b\u3088\u3066\u3044\u3002\n\u4eee\u60f3IP\u3092\u30d1\u30d6\u30ea\u30c3\u30af\u30af\u30e9\u30a6\u30c9\u4e0a\u3067\u30d5\u30a7\u30a4\u30eb\u30aa\u30fc\u30d0\u3055\u305b\u308b\u306e\u306f\u3057\u306a\u3044\u3002\u624b\u524d\u306bELB\u3092\u304b\u307e\u3059\u65b9\u5f0f\u3067\u3044\u304f\u3002\n\n```\nprimitive p_zabbix ocf:heartbeat:zabbixserver \\\n        params binary=\"/usr/sbin/zabbix_server\" pid=\"/var/run/zabbix/zabbix_server.pid\" \\\n        op start interval=\"0\" timeout=\"20s\" \\\n        op monitor interval=\"10s\" timeout=\"20s\" \\\n        op stop interval=\"0\" timeout=\"20s\" \\\n        meta target-role=\"Started\"\ngroup grpZabbixServer p_zabbix p_postfix\nproperty $id=\"cib-bootstrap-options\" \\\n        dc-version=\"1.0.13-30bb726\" \\\n        cluster-infrastructure=\"Heartbeat\" \\\n        stonith-enabled=\"false\" \\\n        no-quorum-policy=\"ignore\" \\\n        last-lrm-refresh=\"1466682065\"\n```\n\n\u30fb\u30ea\u30bd\u30fc\u30b9\u767b\u9332\u3092\u3059\u308b\n\n\u2193ocf\u3060\u3068\u30ea\u30bd\u30fc\u30b9\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u304c\u306a\u3044\u3068\u3044\u308f\u308c\u3066\u3057\u307e\u3046\u306e\u3067\u3068\u308a\u3042\u3048\u305azabbix\u306fsystemd\u3092\u3064\u304b\u3046\u3053\u3068\u306b\u3002\n\n```\npcs resource create p_zabbix ocf:heartbeat:zabbixserver \\\n params binary=\"/usr/sbin/zabbix_server\" pid=\"/var/run/zabbix/zabbix_server.pid\" \\\n op monitor interval=\"10s\" timeout=\"20s\" \\\n op stop interval=\"0\" timeout=\"20s\" \\\n meta target-role=\"Started\"\nError: Unable to create resource 'ocf:heartbeat:zabbixserver', it is not installed on this system (use --force to override)\n\n# pcs resource show\n Resource Group: grpZabbixServer\n     zabbix_server      (systemd:zabbix-server):        Stopped\n     WebSite    (ocf::heartbeat:apache):        Stopped\n```\n\nzabbix\u306fsystemd\u3067\u304c\u3093\u3070\u308b\n\n```\npcs resource create web_server systemd:httpd op monitor interval=10s\npcs resource group add grpZabbixServer web_server\npcs constraint colocation add web_server zabbix_server INFINITY\n\n# pcs resource show\n Resource Group: grpZabbixServer\n     zabbix_server      (systemd:zabbix-server):        Started monitor-mng-cent7-test-komi01\n     web_server (systemd:httpd):        Started monitor-mng-cent7-test-komi01\n```\n\n\u30fb\u30b9\u30c6\u30fc\u30bf\u30b9\u78ba\u8a8d\n\n```\n# pcs status\nCluster name: zabbixcluster\nLast updated: Tue Jul 12 06:39:36 2016          Last change: Tue Jul 12 06:39:17 2016 by root via crm_attribute on monitor-mng-cent7-test-komi01\nStack: corosync\nCurrent DC: monitor-mng-cent7-test-komi01 (version 1.1.13-10.el7_2.2-44eb2dd) - partition WITHOUT quorum\n2 nodes and 2 resources configured\n\nOnline: [ monitor-mng-cent7-test-komi01 ]\nOFFLINE: [ monitor-mng-cent7-test-komi02 ]\n\nFull list of resources:\n\n Resource Group: grpZabbixServer\n     zabbix_server      (systemd:zabbix-server):        Started monitor-mng-cent7-test-komi01\n     WebSite    (ocf::heartbeat:apache):        Stopped\n\nFailed Actions:\n* WebSite_start_0 on monitor-mng-cent7-test-komi01 'unknown error' (1): call=13, status=Timed Out, exitreason='none',\n    last-rc-change='Tue Jul 12 06:39:09 2016', queued=0ms, exec=40002ms\n\n\nPCSD Status:\n  monitor-mng-cent7-test-komi01: Online\n  monitor-mng-cent7-test-komi02: Online\n\nDaemon Status:\n  corosync: active/disabled\n  pacemaker: active/disabled\n  pcsd: active/enabled\n```\n\n\u30fbconfig\u3092\u78ba\u8a8d\n\n```\n# pcs config show\nCluster Name: zabbixcluster\nCorosync Nodes:\n monitor-mng-cent7-test-komi01 monitor-mng-cent7-test-komi02 \nPacemaker Nodes:\n monitor-mng-cent7-test-komi01 monitor-mng-cent7-test-komi02 \n\nResources: \n Group: grpZabbixServer\n  Resource: zabbix_server (class=systemd type=zabbix-server)\n   Operations: monitor interval=10s (zabbix_server-monitor-interval-10s)\n  Resource: WebSite (class=ocf provider=heartbeat type=apache)\n   Attributes: configfile=/etc/httpd/conf/httpd.conf statusurl=http://localhost/server-status \n   Operations: start interval=0s timeout=40s (WebSite-start-interval-0s)\n               stop interval=0s timeout=60s (WebSite-stop-interval-0s)\n               monitor interval=1min (WebSite-monitor-interval-1min)\n\nStonith Devices: \nFencing Levels: \n\nLocation Constraints:\nOrdering Constraints:\nColocation Constraints:\n  WebSite with zabbix_server (score:INFINITY) (id:colocation-WebSite-zabbix_server-INFINITY)\n\nResources Defaults:\n resource-stickiness: INFINITY\n migration-threshold: 1\nOperations Defaults:\n No defaults set\n\nCluster Properties:\n cluster-infrastructure: corosync\n cluster-name: zabbixcluster\n dc-version: 1.1.13-10.el7_2.2-44eb2dd\n default-action-timeout: 240\n default-resource-stickiness: 200\n have-watchdog: false\n no-quorum-policy: ignore\n stonith-enabled: false\n```\n\n```\n# corosync-cmapctl | grep members\nruntime.totem.pg.mrp.srp.members.1.config_version (u64) = 0\nruntime.totem.pg.mrp.srp.members.1.ip (str) = r(0) ip(127.0.0.1) \u2190\u3053\u3053\u304c\u307e\u305a\u3044\u3063\u307d\u3044\nruntime.totem.pg.mrp.srp.members.1.join_count (u32) = 1\nruntime.totem.pg.mrp.srp.members.1.status (str) = joined\n```\n\n\u3069\u3046\u3082hosts\u306e\u4e00\u884c\u76ee\u306b\u30af\u30e9\u30b9\u30bf\u767b\u9332\u306b\u6307\u5b9a\u3057\u305f\u30db\u30b9\u30c8\u540d\u3092\u66f8\u304f\u306e\u304c\u307e\u305a\u3044\u3063\u307d\u3044\n\n```\n# vi /etc/hosts\n127.0.0.1  monitor-mng-cent7-test-komi01  localhost localhost.localdomain localhost4 localhost4.localdomain4\n\u3000\u2193\n127.0.0.1    localhost localhost.localdomain localhost4 localhost4.localdomain4\n```\n\n\u306a\u304a\u3057\u3066\n\n```\n# pcs cluster stop --all\n# pcs cluster start --all\n# pcs status\n```\n\n\u3053\u308c\u3092\u7e70\u308a\u8fd4\u3057\u305f\u3068\u3053\u308d\u76f4\u3063\u305f\u3057Online\u304c\u4e21\u65b9\u306b\u306a\u3063\u305f\u6a21\u69d8\u3002\n\n```\n# corosync-cmapctl | grep members\nruntime.totem.pg.mrp.srp.members.1.config_version (u64) = 0\nruntime.totem.pg.mrp.srp.members.1.ip (str) = r(0) ip(192.168.3.103) \nruntime.totem.pg.mrp.srp.members.1.join_count (u32) = 1\nruntime.totem.pg.mrp.srp.members.1.status (str) = joined\nruntime.totem.pg.mrp.srp.members.2.config_version (u64) = 0\nruntime.totem.pg.mrp.srp.members.2.ip (str) = r(0) ip(192.168.3.104) \nruntime.totem.pg.mrp.srp.members.2.join_count (u32) = 1\nruntime.totem.pg.mrp.srp.members.2.status (str) = joined\n```\n\n\u3061\u306a\u307f\u306b\u8d77\u52d5\u4e2d\u306b\n`/etc/corosync/corosync.conf`\u306e\u30ce\u30fc\u30c9\u540d\u3092\u5909\u3048\u305f\u308a\u3059\u308b\u3068`pcs cluster stop`\u304c\u3067\u304d\u306a\u304f\u306a\u308b\u6a21\u69d8\u3002\n\napache\u5074\u3082ocf\u3060\u3068\u30b9\u30c6\u30fc\u30bf\u30b9\u306b\u30d5\u30a7\u30a4\u30eb\u3067\u3066\u3044\u305f\n\n```\nFailed Actions:\n* WebSite_start_0 on monitor-mng-cent7-test-komi01 'unknown error' (1): call=12, status=Timed Out, exitreason='none',\n    last-rc-change='Tue Jul 12 07:27:47 2016', queued=0ms, exec=40003ms\n```\n\n\u3068\u308a\u3042\u3048\u305a\u3053\u308c(Fail)\u304c\u3067\u3066\u3044\u3066\u5207\u308a\u66ff\u308f\u308b\u3053\u3068\u306f\u3042\u308a\u3048\u306a\u3044\u3002\n\n\u30fbcib\u3092\u78ba\u8a8d\u3057\u3066\u307f\u308b\n\n```\n# pcs cluster cib\n\u51fa\u529b\u7d50\u679c\u306f\u9577\u3044\u306e\u3067\u7701\u7565\n```\n\n`# cibadmin --query`\u3067\u3082\u540c\u3058\u306e\u51fa\u308b\u3002\n\n\u30fbFailCount\u306e\u30af\u30ea\u30a2\u65b9\u6cd5\n\n```\n# pcs resource cleanup WebSite\nWaiting for 4 replies from the CRMd.... OK\nCleaning up zabbix_server on monitor-mng-cent7-test-komi01, removing fail-count-zabbix_server\nCleaning up zabbix_server on monitor-mng-cent7-test-komi02, removing fail-count-zabbix_server\nCleaning up WebSite on monitor-mng-cent7-test-komi01, removing fail-count-WebSite\nCleaning up WebSite on monitor-mng-cent7-test-komi02, removing fail-count-WebSite\n```\n\n```\n# pcs status\nCluster name: zabbixcluster\nLast updated: Tue Jul 12 08:52:30 2016          Last change: Tue Jul 12 08:52:16 2016 by hacluster via crmd on monitor-mng-cent7-test-komi01\nStack: corosync\nCurrent DC: monitor-mng-cent7-test-komi02 (version 1.1.13-10.el7_2.2-44eb2dd) - partition with quorum\n2 nodes and 2 resources configured\n\nOnline: [ monitor-mng-cent7-test-komi01 monitor-mng-cent7-test-komi02 ]\n\nFull list of resources:\n\n Resource Group: grpZabbixServer\n     zabbix_server      (systemd:zabbix-server):        Started monitor-mng-cent7-test-komi02\n     WebSite    (ocf::heartbeat:apache):        Started monitor-mng-cent7-test-komi02\n\nPCSD Status:\n  monitor-mng-cent7-test-komi01: Online\n  monitor-mng-cent7-test-komi02: Online\n\nDaemon Status:\n  corosync: active/disabled\n  pacemaker: active/disabled\n  pcsd: active/enabled\n```\n\n\u3044\u3044\u611f\u3058\u306b\u30af\u30ea\u30a2\u3055\u308c\u305f\u3002\n\n\n\u30fb\u3053\u3053\u304b\u3089\u5207\u308a\u66ff\u3048\u30c6\u30b9\u30c8\uff08\u9577\u3044\uff09\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u3066\u307f\u3066\u3082\u5168\u304f\u79fb\u52d5\u3057\u306a\u304b\u3063\u305f\u3002\n\n```\n# pcs resource move zabbix_server monitor-mng-cent7-test-komi01\n```\n\n2\u5074\u3092\u30b9\u30bf\u30f3\u30d0\u30a4\u306b\u3059\u308b\u30b3\u30de\u30f3\u30c9\u3092\u6253\u3063\u3066\u307f\u305f\u3068\u3053\u308d\u30ea\u30bd\u30fc\u30b9\u304c\u79fb\u3063\u305f\n\n```\n# pcs cluster standby monitor-mng-cent7-test-komi02\n```\n\n```\n# pcs cluster unstandby --all\n```\n\n\u3068\u3059\u308b\u306801\u5074\u3067web\u304c\u843d\u3061\u3066\u308b\u6271\u3044\u306e\u3068\u304d\u300102\u5074\u306b\u30ea\u30bd\u30fc\u30b9\u304c\u79fb\u52d5\u3057\u3066\u5168\u30ea\u30bd\u30fc\u30b9start\u3059\u308b\n\n```\n# pcs status\nCluster name: zabbixcluster\nLast updated: Tue Jul 12 09:25:28 2016          Last change: Tue Jul 12 09:23:35 2016 by root via crm_attribute on monitor-mng-cent7-test-komi01\nStack: corosync\nCurrent DC: monitor-mng-cent7-test-komi02 (version 1.1.13-10.el7_2.2-44eb2dd) - partition with quorum\n2 nodes and 2 resources configured\n\nOnline: [ monitor-mng-cent7-test-komi01 monitor-mng-cent7-test-komi02 ]\n\nFull list of resources:\n\n Resource Group: grpZabbixServer\n     zabbix_server      (systemd:zabbix-server):        Started monitor-mng-cent7-test-komi02\n     WebSite    (ocf::heartbeat:apache):        Started monitor-mng-cent7-test-komi02\n\nFailed Actions:\n* WebSite_start_0 on monitor-mng-cent7-test-komi01 'unknown error' (1): call=42, status=Timed Out, exitreason='none',\n    last-rc-change='Tue Jul 12 09:21:27 2016', queued=0ms, exec=40002ms\n\n\nPCSD Status:\n  monitor-mng-cent7-test-komi01: Online\n  monitor-mng-cent7-test-komi02: Online\n\nDaemon Status:\n  corosync: active/disabled\n  pacemaker: active/disabled\n  pcsd: active/enabled\n```\n\nFailedAction\u3067\u3066\u308b\u306e\u306focf\u304clocalhost\u306eServer-status\u3068\u304b\u307f\u3066\u305f\u305f\u3081\u3002\n\u78ba\u304b\u306bserver-status\u3092curl\u3067\u307f\u308b\u3068404\u306a\u306e\u3067\u305d\u306e\u305b\u3044\u3060\u3063\u305f\u6a21\u69d8\u3002\n\u30b9\u30c6\u30fc\u30bf\u30b9\u307e\u3067\u898b\u3066\u304f\u308c\u306a\u304f\u3066\u3044\u3044\u3068\u601d\u3044\u65e5\u548c\u3063\u3066systemd\u306b\u5909\u3048\u307e\u3057\u305f\u3002\n\n```\ncurl http://localhost/server-status\n```\n\n\u30ea\u30bd\u30fc\u30b9\u3092\u6d88\u3057\u3066systemd\u306e\u30ea\u30bd\u30fc\u30b9\u3092\u767b\u9332\u3057\u3066\u307f\u308b\n\n```\n# pcs resource delete WebSite\n# pcs resource show\n Resource Group: grpZabbixServer\n     zabbix_server      (systemd:zabbix-server):        Started monitor-mng-cent7-test-komi01\n```\n\napache\u3082ocf\u304c\u96e3\u3057\u3044\u306e\u3067systemd\u3067\u304c\u3093\u3070\u308b\u3002systemd\u3060\u3068\u30ea\u30bd\u30fc\u30b9\u3064\u304b\u3093\u3067\u308b\u9593\u306b\u30b5\u30fc\u30d3\u30b9\u518d\u8d77\u52d5\u3068\u304b\u3067\u304d\u306a\u304f\u306a\u308b\u306e\u3067\u3044\u3044\u611f\u3058\u306b\u601d\u308f\u308c\u308b\u3002\n\n```\npcs resource create web_server systemd:httpd op monitor interval=10s\npcs resource group add grpZabbixServer web_server\npcs constraint colocation add web_server zabbix_server INFINITY\n\n# pcs resource show\n Resource Group: grpZabbixServer\n     zabbix_server      (systemd:zabbix-server):        Started monitor-mng-cent7-test-komi01\n     web_server (systemd:httpd):        Started monitor-mng-cent7-test-komi01\n```\n\n```\n# pcs status\nCluster name: zabbixcluster\nLast updated: Tue Jul 12 10:05:04 2016          Last change: Tue Jul 12 10:02:54 2016 by root via cibadmin on monitor-mng-cent7-test-komi01\nStack: corosync\nCurrent DC: monitor-mng-cent7-test-komi02 (version 1.1.13-10.el7_2.2-44eb2dd) - partition with quorum\n2 nodes and 2 resources configured\n\nNode monitor-mng-cent7-test-komi02: standby\nOnline: [ monitor-mng-cent7-test-komi01 ]\n\nFull list of resources:\n\n Resource Group: grpZabbixServer\n     zabbix_server      (systemd:zabbix-server):        Started monitor-mng-cent7-test-komi01\n     web_server (systemd:httpd):        Started monitor-mng-cent7-test-komi01\n\nPCSD Status:\n  monitor-mng-cent7-test-komi01: Online\n  monitor-mng-cent7-test-komi02: Online\n\nDaemon Status:\n  corosync: active/disabled\n  pacemaker: active/disabled\n  pcsd: active/enabled\n```\n\n\u30fb\u30b9\u30bf\u30f3\u30d0\u30a4\u89e3\u9664\n\n```\n# pcs cluster unstandby --all\n# pcs status\nCluster name: zabbixcluster\nLast updated: Tue Jul 12 10:05:52 2016          Last change: Tue Jul 12 10:05:50 2016 by root via crm_attribute on monitor-mng-cent7-test-komi01\nStack: corosync\nCurrent DC: monitor-mng-cent7-test-komi02 (version 1.1.13-10.el7_2.2-44eb2dd) - partition with quorum\n2 nodes and 2 resources configured\n\nOnline: [ monitor-mng-cent7-test-komi01 monitor-mng-cent7-test-komi02 ]\n\nFull list of resources:\n\n Resource Group: grpZabbixServer\n     zabbix_server      (systemd:zabbix-server):        Started monitor-mng-cent7-test-komi01\n     web_server (systemd:httpd):        Started monitor-mng-cent7-test-komi01\n\nPCSD Status:\n  monitor-mng-cent7-test-komi01: Online\n  monitor-mng-cent7-test-komi02: Online\n\nDaemon Status:\n  corosync: active/disabled\n  pacemaker: active/disabled\n  pcsd: active/enabled\n\n01\u5074\uff1a\n# netstat -lnpt\nActive Internet connections (only servers)\nProto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    \ntcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      1020/sshd           \ntcp        0      0 0.0.0.0:10050           0.0.0.0:*               LISTEN      8723/zabbix_agentd  \ntcp        0      0 0.0.0.0:10051           0.0.0.0:*               LISTEN      19346/zabbix_server \ntcp6       0      0 :::80                   :::*                    LISTEN      20467/httpd         \ntcp6       0      0 :::2224                 :::*                    LISTEN      4141/ruby           \ntcp6       0      0 :::22                   :::*                    LISTEN      1020/sshd           \ntcp6       0      0 :::10050                :::*                    LISTEN      8723/zabbix_agentd  \ntcp6       0      0 :::10051                :::*                    LISTEN      19346/zabbix_server \n\n02\u5074\uff1a\n# netstat -lnpt\nActive Internet connections (only servers)\nProto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    \ntcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      1026/sshd           \ntcp6       0      0 :::2224                 :::*                    LISTEN      4268/ruby           \ntcp6       0      0 :::22                   :::*                    LISTEN      1026/sshd      \n```\n\n\u3053\u306e\u307b\u3046\u304c\u3088\u3055\u3052\u3002\nocf\u3060\u3068pcs\u3067stop\u3067\u3082netstat\u3067\u307f\u308b\u3068\u8d77\u52d5\u3057\u3066\u308b\u304b\u3093\u3058\u3060\u3063\u305f\uff08\u4eee\u60f3IP\u3082\u4e00\u7dd2\u306b\u79fb\u3059\u308f\u3051\u3067\u306a\u304fELB\u3064\u304b\u3046\u524d\u63d0\u306a\u306e\u3067\u3001\u30c7\u30fc\u30bf\u91cd\u8907\u3057\u305d\u3046\u3067\u3042\u3076\u306a\u3044\u6319\u52d5\u306a\u6c17\u304c\u3057\u305f\uff09\u3002\n\n\u3061\u3087\u3063\u3068\u5207\u308a\u66ff\u3048\u3066\u307f\u308b\n\n```\n# pcs cluster stop monitor-mng-cent7-test-komi01\nmonitor-mng-cent7-test-komi01: Stopping Cluster (pacemaker)...\nmonitor-mng-cent7-test-komi01: Stopping Cluster (corosync)...\n```\n\n\u7121\u4e8b\u306b\u30ea\u30bd\u30fc\u30b9\u304c\u79fb\u52d5\u3002\n\n```\n# pcs status\nCluster name: zabbixcluster\nLast updated: Tue Jul 12 10:18:01 2016          Last change: Tue Jul 12 10:05:50 2016 by root via crm_attribute on monitor-mng-cent7-test-komi01\nStack: corosync\nCurrent DC: monitor-mng-cent7-test-komi02 (version 1.1.13-10.el7_2.2-44eb2dd) - partition with quorum\n2 nodes and 2 resources configured\n\nOnline: [ monitor-mng-cent7-test-komi02 ]\nOFFLINE: [ monitor-mng-cent7-test-komi01 ]\n\nFull list of resources:\n\n Resource Group: grpZabbixServer\n     zabbix_server      (systemd:zabbix-server):        Started monitor-mng-cent7-test-komi02\n     web_server (systemd:httpd):        Started monitor-mng-cent7-test-komi02\n\nPCSD Status:\n  monitor-mng-cent7-test-komi01: Online\n  monitor-mng-cent7-test-komi02: Online\n\nDaemon Status:\n  corosync: active/disabled\n  pacemaker: active/disabled\n  pcsd: active/enabled\n```\n\n\u843d\u3068\u3057\u305f\u307b\u3046\u3092\u8d77\u52d5\u3057\u3066\u307f\u3066\u3001\u30b9\u30c6\u30fc\u30bf\u30b9\u78ba\u8a8d\uff08\u8d77\u52d5\u3060\u3051\u3067\u30ea\u30bd\u30fc\u30b9\u304c\u79fb\u52d5\u3057\u306a\u3044\u3053\u3068\u306e\u78ba\u8a8d\uff09\n\n```\n# pcs cluster start monitor-mng-cent7-test-komi01\n# pcs status\nCluster name: zabbixcluster\nLast updated: Tue Jul 12 10:19:19 2016          Last change: Tue Jul 12 10:05:50 2016 by root via crm_attribute on monitor-mng-cent7-test-komi01\nStack: corosync\nCurrent DC: monitor-mng-cent7-test-komi02 (version 1.1.13-10.el7_2.2-44eb2dd) - partition with quorum\n2 nodes and 2 resources configured\n\nOnline: [ monitor-mng-cent7-test-komi01 monitor-mng-cent7-test-komi02 ]\n\nFull list of resources:\n\n Resource Group: grpZabbixServer\n     zabbix_server      (systemd:zabbix-server):        Started monitor-mng-cent7-test-komi02\n     web_server (systemd:httpd):        Started monitor-mng-cent7-test-komi02\n\nPCSD Status:\n  monitor-mng-cent7-test-komi01: Online\n  monitor-mng-cent7-test-komi02: Online\n\nDaemon Status:\n  corosync: active/disabled\n  pacemaker: active/disabled\n  pcsd: active/enabled\n```\n\n\u3068\u304f\u306b\u554f\u984c\u306a\u3055\u305d\u3046\u3002\n\n```\n[root@monitor-mng-cent7-test-komi02 zabbix-server-mysql-3.0.3]# netstat -lnpt\nActive Internet connections (only servers)\nProto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    \ntcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      1026/sshd           \ntcp        0      0 0.0.0.0:10051           0.0.0.0:*               LISTEN      21196/zabbix_server \ntcp6       0      0 :::80                   :::*                    LISTEN      21236/httpd         \ntcp6       0      0 :::2224                 :::*                    LISTEN      4268/ruby           \ntcp6       0      0 :::22                   :::*                    LISTEN      1026/sshd           \ntcp6       0      0 :::10051                :::*                    LISTEN      21196/zabbix_server \n[root@monitor-mng-cent7-test-komi01 yum.repos.d]# netstat -lnpt\nActive Internet connections (only servers)\nProto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    \ntcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      1020/sshd           \ntcp        0      0 0.0.0.0:10050           0.0.0.0:*               LISTEN      8723/zabbix_agentd  \ntcp6       0      0 :::2224                 :::*                    LISTEN      4141/ruby           \ntcp6       0      0 :::22                   :::*                    LISTEN      1020/sshd           \ntcp6       0      0 :::10050                :::*                    LISTEN      8723/zabbix_agentd  \n```\n\n\u3067\u306f\u300102\u3092standby\u306b\u3057\u3066\u30ea\u30bd\u30fc\u30b9\u3092\u79fb\u52d5\u3057\u3066\u307f\u308b\n\n```\n# pcs cluster standby monitor-mng-cent7-test-komi02\n# pcs status\nCluster name: zabbixcluster\nLast updated: Tue Jul 12 10:22:36 2016          Last change: Tue Jul 12 10:22:23 2016 by root via crm_attribute on monitor-mng-cent7-test-komi02\nStack: corosync\nCurrent DC: monitor-mng-cent7-test-komi02 (version 1.1.13-10.el7_2.2-44eb2dd) - partition with quorum\n2 nodes and 2 resources configured\n\nNode monitor-mng-cent7-test-komi02: standby\nOnline: [ monitor-mng-cent7-test-komi01 ]\n\nFull list of resources:\n\n Resource Group: grpZabbixServer\n     zabbix_server      (systemd:zabbix-server):        Started monitor-mng-cent7-test-komi01\n     web_server (systemd:httpd):        Started monitor-mng-cent7-test-komi01\n\nPCSD Status:\n  monitor-mng-cent7-test-komi01: Online\n  monitor-mng-cent7-test-komi02: Online\n\nDaemon Status:\n  corosync: active/disabled\n  pacemaker: active/disabled\n  pcsd: active/enabled\n\n# pcs cluster unstandby --all\n# pcs status\nCluster name: zabbixcluster\nLast updated: Tue Jul 12 10:24:34 2016          Last change: Tue Jul 12 10:24:31 2016 by root via crm_attribute on monitor-mng-cent7-test-komi02\nStack: corosync\nCurrent DC: monitor-mng-cent7-test-komi02 (version 1.1.13-10.el7_2.2-44eb2dd) - partition with quorum\n2 nodes and 2 resources configured\n\nOnline: [ monitor-mng-cent7-test-komi01 monitor-mng-cent7-test-komi02 ]\n\nFull list of resources:\n\n Resource Group: grpZabbixServer\n     zabbix_server      (systemd:zabbix-server):        Started monitor-mng-cent7-test-komi01\n     web_server (systemd:httpd):        Started monitor-mng-cent7-test-komi01\n\nPCSD Status:\n  monitor-mng-cent7-test-komi01: Online\n  monitor-mng-cent7-test-komi02: Online\n\nDaemon Status:\n  corosync: active/disabled\n  pacemaker: active/disabled\n  pcsd: active/enabled\n```\n\n\u3072\u3068\u307e\u305a\u624b\u52d5\u5207\u308a\u66ff\u3048\u30c6\u30b9\u30c8\u5b8c\u4e86\u3002Fail\u306e\u30af\u30ea\u30a2\u306e\u624b\u9806\u3082\u7279\u5b9a\u3067\u304d\u305f\u3002\n\uff08\u3053\u308c\u3092chef\u306b\u3057\u306a\u3044\u3068\u306a\u30fc\u3002\u3002\uff09\n\n\u30fb\u30ed\u30b0\u307e\u308f\u308a\n\n`/var/log/cluster/corosync.log`\u306b\u305d\u308c\u3089\u3057\u3044\u306e\u304c\u5b58\u5728\u3059\u308b\n\n\u7279\u5b9a\u306e\u6642\u9593\u5206\u53d6\u308a\u51fa\u3059\u65b9\u6cd5\n\n```\n# pcs cluster report --from \"2016-07-12 09:00:00\" /tmp/dest\n# ll /tmp\ntotal 60\n-rw-r--r-- 1 root root 54519 Jul 12 10:35 dest.tar.bz2\n```\n\n\u3053\u3093\u306a\u304b\u3093\u3058\u3067\u3067\u3066\u304f\u308b\u3002\u4ee5\u4e0b\u306e\u3088\u3046\u306bto\u306e\u6307\u5b9a\u3082\u53ef\u80fd\u3002\n\n```\nreport [--from \"YYYY-M-D H:M:S\" [--to \"YYYY-M-D\" H:M:S\"]] dest\n```\n\n\n\u30fb\u30d5\u30a7\u30a4\u30eb\u56de\u6570\u3092\u7279\u5b9a\n\n```\n#  pcs resource failcount show zabbix_server\nNo failcounts for zabbix_server\n```\n\n\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u306b\u69d8\u5b50\u3092\u307f\u308b\u306b\u306f\n`watch pcs status`\u3068\u304b\u3059\u308b\u3057\u304b\u306a\u3055\u305d\u3046\uff08help\u3092\u773a\u3081\u3066\u307f\u3066\uff09\n\n\u3068\u308a\u3042\u3048\u305a\u4ee5\u4e0a\u3001\u4ee5\u4e0b\u53c2\u8003\u3002\n\n\u53c2\u8003\uff1a\nhttp://kan3aa.hatenablog.com/entry/2015/06/05/135150\nhttps://blog.apar.jp/zabbix/4177/\nhttp://weblabo.oscasierra.net/installing-mysql57-centos7-yum/\nhttp://doruby.kbmj.com/taka/20131018/yum_update_crm_pcs_\nhttp://infra.blog.shinobi.jp/Entry/107/\nhttp://blog.matsumoto-r.jp/?p=3482\nhttps://ericsysmin.com/2016/02/18/configuring-high-availability-ha-zabbix-server-on-centos-7/\nhttps://gist.github.com/kogoto/92eef35b28ae632a11f7\n`# pcs cluster --help`\nhttp://yomon.hatenablog.com/entry/2016/04/13/110035\nhttp://qiita.com/tukiyo3/items/27dcc7f15a8b4e4cf8a5\n`# pcs resource --help`\nhttps://access.redhat.com/documentation/ja-JP/Red_Hat_Enterprise_Linux/6/html/Configuring_the_Red_Hat_High_Availability_Add-On_with_Pacemaker/ch-clustresources-HAAR.html\n\n\n"}