{"context": " More than 1 year has passed since last update.\n\n\u76ee\u7684\n\u3053\u306e\u8a18\u4e8b\u3067\u306fPHP\u3067Spatialite\u3092\u4f7f\u3046\u65b9\u6cd5\u306b\u3064\u3044\u3066\u89e3\u8aac\u3057\u307e\u3059\u3002\nSpatialite\u306e\u30d3\u30eb\u30c9\u306a\u3069\u306b\u3064\u3044\u3066\u306f\u4e0b\u8a18\u3092\u53c2\u8003\u306b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u5730\u56f3\u3068\u304b\u306e\u7a7a\u9593\u60c5\u5831\u3092SQLite\u306b\u683c\u7d0d\u3059\u308bSpatiaLite\u3092\u4f7f\u7528\u3057\u3066\u307f\u308b \nhttp://qiita.com/mima_ita/items/64f6c2b8bb47c4b5b391\n\u6700\u7d42\u76ee\u7684\u3068\u3057\u3066\u306f\u4ee5\u4e0b\u306e\u30b3\u30fc\u30c9\u304c\u52d5\u4f5c\u3059\u308b\u3053\u3068\u3092\u76ee\u6a19\u3068\u3057\u307e\u3059\u3002\n<?php\n\nclass MyDB extends SQLite3\n{\n    function __construct()\n    {\n        $this->open(':memory:');\n    }\n}\n\n$ver = SQLite3::version();\nvar_dump($ver);\n\n\n$db = new MyDB();\nif (!$db->loadExtension('mod_spatialite.dll')) {\n  exit();\n}\n\n\n# reporting some version info\n$rs = $db->query('SELECT sqlite_version()');\nwhile ($row = $rs->fetchArray())\n{\n  print \"SQLite version: $row[0]\" . PHP_EOL;\n}\n\n$rs = $db->query('SELECT spatialite_version()');\nwhile ($row = $rs->fetchArray())\n{\n  print \"SpatiaLite version: $row[0]\" . PHP_EOL;\n}\n\n$db->exec('SELECT InitSpatialMetaData()');\n$db->exec('CREATE TABLE foo (name TEXT)');\n$db->exec('SELECT AddGeometryColumn(\"foo\", \"Geometry\", 0, \"POINT\", 2)');\n\n#SQLite 3.7.17\u4ee5\u964d\u3058\u3083\u306a\u3044\u3068RTree\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u306f\u4f5c\u308c\u306a\u3044\nif ($ver->versionNumber < 3007017) {\n  print \"RTree-Index is Not supported. (< 3.7.17)\" . PHP_EOL;\n} else {\n  $db->exec('SELECT CreateSpatialIndex(\"foo\", \"Geometry\")');\n}\n$db->exec('INSERT INTO foo VALUES(\"test1\", GeometryFromText(\"POINT(140 30)\"))');\n$db->exec('INSERT INTO foo VALUES(\"test2\", GeometryFromText(\"POINT(135 33)\"))');\n\n$rs = $db->query('SELECT name, AsGeoJson(\"Geometry\") AS geo FROM foo');\n\nwhile ($row = $rs->fetchArray())\n{\n  var_dump($row);\n}\n\n$db->close();\n\n\n?>\n\n\n\u524d\u63d0\nPHP5.5\u4ee5\u964d\u3067\u306a\u3044\u3068loadExtension\u306f\u52d5\u4f5c\u3057\u307e\u305b\u3093\u3002\n\u5c11\u306a\u304f\u3068\u3082\u3001PHP5.3\u3067\u306f\u57fa\u672c\u7121\u7406(\u203b\uff09\u3067\u3001PHP5.6\u3067\u306f\u3044\u3051\u307e\u3057\u305f\u3002\n\u306a\u306e\u3067\u3001\u7279\u306b\u5236\u7d04\u304c\u306a\u3051\u308c\u3070PHP\u306e\u6700\u65b0\u3092\u7528\u610f\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u306a\u304a\u3001\u57fa\u672c\u7121\u7406\u3068\u3044\u3046\u306e\u306f\u3001\u6a5f\u80fd\u3092\u843d\u3068\u3057\u3066\u3001\u306a\u3093\u3084\u304b\u3093\u3084\u3059\u308c\u3070\u3001\u306a\u3093\u3068\u304b\u306a\u308a\u306f\u3057\u307e\u3059\u3002\n\u3042\u3068\u3001Windows\u30e6\u30fc\u30b6\u306e\u4eba\u306f\u82e6\u52b4\u3057\u307e\u3059\u3002Linux\u3068\u304bMac\u306e\u30d1\u30b9\u306e\u533a\u5207\u308a\u304c\"/\"\u306e\u74b0\u5883\u3060\u3068\u6bd4\u8f03\u7684\u697d\u3067\u3059\u3002\n\nphp.ini\u306e\u4fee\u6b63\nloadExtension\u3092\u7528\u3044\u3066\u62e1\u5f35\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u4f7f\u3046\u5834\u5408\u3001php.ini\u3092\u4fee\u6b63\u3057\u3066\u3001\u62e1\u5f35\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u8aad\u307f\u8fbc\u3081\u308b\u3088\u3046\u306b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\nWindows\u306e\u5834\u5408\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u3067SQLite3\u304c\u7121\u52b9\u306b\u306a\u3063\u3066\u3044\u308b\u5834\u5408\u3082\u3042\u308b\u306e\u3067php.ini\u306e\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3092\u5916\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\nphp.ini\nextension=php_sqlite3.dll\n\n\n\u6b21\u306b\u62e1\u5f35\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u683c\u7d0d\u3057\u3066\u3044\u308b\u30d5\u30a9\u30eb\u30c0\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\nphp.ini\n[sqlite3]\nsqlite3.extension_dir =C:\\tool\\spatialite\\mod_spatialite-4.2.0-win-x86\n\n\nPHP\u306eSQLite\u3067\u306f\u3001\u3053\u3053\u3067\u6307\u5b9a\u3057\u305f\u30d5\u30a9\u30eb\u30c0\u4ee5\u5916\u304b\u3089\u62e1\u5f35\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u30ed\u30fc\u30c9\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093\u3002\n\u3042\u3068\u306f\u74b0\u5883\u5909\u6570\u306ePATH\u306b\u4e0a\u8a18\u306e\u30d5\u30a9\u30eb\u30c0\u3092\u6307\u5b9a\u3059\u308c\u3070\u3001\u30e9\u30c3\u30ad\u30fc\u30ac\u30a4\u306a\u74b0\u5883\u3067\u306f\u52d5\u4f5c\u3057\u307e\u3059\u3002\u304a\u75b2\u308c\u69d8\u3067\u3057\u305f\u3002\n\u4ee5\u4e0b\u306e\u30a8\u30e9\u30fc\u304c\u51fa\u308b\u5834\u5408\u306f\u3001\u3053\u3053\u304b\u3089\u304c\u672c\u5f53\u306e\u5730\u7344\u3067\u3059\u3002\nPHP Warning:  SQLite3::loadExtension(): \u6307\u5b9a\u3055\u308c\u305f\u30d7\u30ed\u30b7\u30fc\u30b8\u30e3\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093\u3002\n\n\n\u4f55\u3067\u30a8\u30e9\u30fc\u306b\u306a\u308b\u304b\n\u304a\u305d\u3089\u304f\u3001\u3053\u3053\u3067\u30a8\u30e9\u30fc\u306b\u306a\u308b\u306e\u306fPHP\u304c\u4f7f\u7528\u3057\u3066\u3044\u308bSQLite\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u53e4\u3044\u304b\u3001Windows\u30e6\u30fc\u30b6\u306e\u4eba\u3060\u3068\u601d\u3044\u307e\u3059\u3002\n\u306a\u305c\u30a8\u30e9\u30fc\u306b\u306a\u308b\u304b\u306e\u524d\u306bSQLite\u306e\u62e1\u5f35\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u30a8\u30f3\u30c8\u30ea\u30fc\u30dd\u30a4\u30f3\u30c8\u304c\u95a2\u4fc2\u3057\u3066\u3044\u307e\u3059\u3002\nRun-Time Loadable Extensions \nhttp://www.sqlite.org/loadext.html\n\u672c\u6765\u306eSQLite\u306eload_extension\u306fload_extension(X,Y)\u3068\u306a\u3063\u3066\u304a\u308a\u3001\uff12\u3064\u306e\u5f15\u6570\u3092\u53d6\u308a\u307e\u3059\u3002X\u304c\u30e2\u30b8\u30e5\u30fc\u30eb\u540d\u3067Y\u304c\u30a8\u30f3\u30c8\u30ea\u30fc\u30dd\u30a4\u30f3\u30c8\u306e\u95a2\u6570\u540d\u3068\u306a\u308a\u307e\u3059\u3002\n\u3053\u306eY\u306f\u7701\u7565\u53ef\u80fd\u3067\u3001PHP\u306eloadExtension\u95a2\u6570\u306e\u5834\u5408\u3001\u7701\u7565\u3057\u3066\u5b9f\u884c\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\u3053\u306e\u7701\u7565\u3055\u308c\u305f\u5834\u5408\u306e\u6319\u52d5\u306f\u6b21\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\u30fb\u3082\u3057\u7701\u7565\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u306f\u3000sqlite3_extension_init \u3092\u4f7f\u7528\u3059\u308b\n\u30fb\u3053\u308c\u3067\u30ed\u30fc\u30c9\u3067\u304d\u306a\u3044\u5834\u5408\u306f\u3001\u6700\u5f8c\u306e\"/\" \u4ee5\u964d\u3092\u4f7f\u7528\u3059\u308b\u3002\u3053\u306e\u6642\u3001\u63a5\u982d\u8a9e\u306elib\u306f\u9664\u53bb\u3057\u3001\u30a2\u30eb\u30d5\u30a1\u30d9\u30c3\u30c8\u306e\u307f\u3092\u5c0f\u6587\u5b57\u306b\u3057\u3001\u62e1\u5f35\u5b50\u306f\u8003\u616e\u3057\u306a\u3044\u3002\n\u5177\u4f53\u7684\u306b\u306f\u6b21\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\"/usr/lib/libmathfunc-4.8.so\" \u21d2 \"sqlite3_mathfunc_init\". \n\"./SpellFixExt.dll\" \u21d2\"sqlite3_spellfixext_init\"\n\u306a\u304a\u3001mod_spatialite.dll\u306e\u30a8\u30f3\u30c8\u30ea\u30fc\u30dd\u30a4\u30f3\u30c8\u306f\u300csqlite3_modspatialite_init\u300d\u3068\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\u3053\u308c\u306b\u3064\u3044\u3066\u306f\u3001Dependency.Walker\u3067\u8abf\u3079\u308b\u304b\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u8aad\u3093\u3067\u304f\u3060\u3055\u3044\u3002\n\nhttp://www.dependencywalker.com/\n\u3064\u307e\u308a\u3001PHP\u304b\u3089loadExtension\u3092\u884c\u3063\u305f\u5834\u5408\u306b\u30a8\u30f3\u30c8\u30ea\u30fc\u30dd\u30a4\u30f3\u30c8\u3092\u300csqlite3_modspatialite_init\u300d\u306b\u5909\u63db\u3067\u304d\u3066\u3044\u306a\u3044\u306e\u304c\u3001\u3053\u306e\u30a8\u30e9\u30fc\u306e\u539f\u56e0\u3068\u306a\u308a\u307e\u3059\u3002\n\n\u4f55\u6545\u3001\u53e4\u3044PHP\u3067\u306fsqlite3_modspatialite_init\u3068\u3044\u3046\u30a8\u30f3\u30c8\u30ea\u30fc\u30dd\u30a4\u30f3\u30c8\u3092\u53d6\u5f97\u3067\u304d\u306a\u3044\u304b\nPHP5.4\u4ee5\u524d\u306e\u5834\u5408\u306f\u8a71\u306f\u7c21\u5358\u3067\u3059\u3002\u53e4\u3044SQLite\u306e\u4ed5\u69d8\u306b\u306f\u3053\u306e\u6a5f\u80fd\u304c\u306a\u304b\u3063\u305f\u3082\u306e\u3068\u63a8\u6e2c\u3067\u304d\u307e\u3059\u3002\n\u5b9f\u969b\u3001PHP5.4\u306b\u30d0\u30f3\u30c9\u30eb\u3055\u308c\u3066\u3044\u308bSQLite\u306e\u30b3\u30fc\u30c9\u306b\u3001\u8a72\u5f53\u306e\u51e6\u7406\u306f\u5b58\u5728\u3057\u307e\u305b\u3093\u3002\nhttps://github.com/php/php-src/blob/PHP-5.4/ext/sqlite3/libsqlite/sqlite3.c\nstatic int sqlite3LoadExtension(\n  sqlite3 *db,          /* Load the extension into this database connection */\n  const char *zFile,    /* Name of the shared library containing extension */\n  const char *zProc,    /* Entry point.  Use \"sqlite3_extension_init\" if 0 */\n  char **pzErrMsg       /* Put error message here if not 0 */\n){\n// \u7565\n  if( zProc==0 ){\n    zProc = \"sqlite3_extension_init\";\n  }\n\n  handle = sqlite3OsDlOpen(pVfs, zFile);\n  if( handle==0 ){\n    if( pzErrMsg ){\n      *pzErrMsg = zErrmsg = sqlite3_malloc(nMsg);\n      if( zErrmsg ){\n        sqlite3_snprintf(nMsg, zErrmsg, \n            \"unable to open shared library [%s]\", zFile);\n        sqlite3OsDlError(pVfs, nMsg-1, zErrmsg);\n      }\n    }\n    return SQLITE_ERROR;\n  }\n  xInit = (int(*)(sqlite3*,char**,const sqlite3_api_routines*))\n                   sqlite3OsDlSym(pVfs, handle, zProc);\n  if( xInit==0 ){\n    if( pzErrMsg ){\n      *pzErrMsg = zErrmsg = sqlite3_malloc(nMsg);\n      if( zErrmsg ){\n        sqlite3_snprintf(nMsg, zErrmsg,\n            \"no entry point [%s] in shared library [%s]\", zProc,zFile);\n        sqlite3OsDlError(pVfs, nMsg-1, zErrmsg);\n      }\n      sqlite3OsDlClose(pVfs, handle);\n    }\n    return SQLITE_ERROR;\n  }else if( xInit(db, &zErrmsg, &sqlite3Apis) ){\n    if( pzErrMsg ){\n      *pzErrMsg = sqlite3_mprintf(\"error during initialization: %s\", zErrmsg);\n    }\n    sqlite3_free(zErrmsg);\n    sqlite3OsDlClose(pVfs, handle);\n    return SQLITE_ERROR;\n  }\n\n\n\u898b\u3066\u308f\u304b\u308b\u901a\u308a\u3001sqlite3OsDlSym\u3067xInit\u304c\u53d6\u5f97\u3067\u304d\u306a\u304b\u3063\u305f\u5834\u5408\u306b\u30a8\u30e9\u30fc\u3068\u3057\u3066\u8fd4\u3057\u3066\u3044\u307e\u3059\u3002\n\u4e00\u65b9\u3001PHP5.5\u3067\u306f\u3001xInit\u304c\u53d6\u5f97\u3067\u304d\u306a\u304b\u3063\u305f\u5834\u5408\u306b\u3001\u4ee3\u66ff\u306e\u30a8\u30f3\u30c8\u30ea\u30fc\u30dd\u30a4\u30f3\u30c8\u3092\u53d6\u5f97\u3059\u308b\u51e6\u7406\u304c\u8a18\u8ff0\u3055\u308c\u3066\u3044\u307e\u3059\u3002\nhttps://raw.githubusercontent.com/php/php-src/PHP-5.5/ext/sqlite3/libsqlite/sqlite3.c\nstatic int sqlite3LoadExtension(\n  sqlite3 *db,          /* Load the extension into this database connection */\n  const char *zFile,    /* Name of the shared library containing extension */\n  const char *zProc,    /* Entry point.  Use \"sqlite3_extension_init\" if 0 */\n  char **pzErrMsg       /* Put error message here if not 0 */\n){\n// \u7565\n  xInit = (int(*)(sqlite3*,char**,const sqlite3_api_routines*))\n                   sqlite3OsDlSym(pVfs, handle, zEntry);\n\n  /* If no entry point was specified and the default legacy\n  ** entry point name \"sqlite3_extension_init\" was not found, then\n  ** construct an entry point name \"sqlite3_X_init\" where the X is\n  ** replaced by the lowercase value of every ASCII alphabetic \n  ** character in the filename after the last \"/\" upto the first \".\",\n  ** and eliding the first three characters if they are \"lib\".  \n  ** Examples:\n  **\n  **    /usr/local/lib/libExample5.4.3.so ==>  sqlite3_example_init\n  **    C:/lib/mathfuncs.dll              ==>  sqlite3_mathfuncs_init\n  */\n  if( xInit==0 && zProc==0 ){\n    int iFile, iEntry, c;\n    int ncFile = sqlite3Strlen30(zFile);\n    zAltEntry = sqlite3_malloc(ncFile+30);\n    if( zAltEntry==0 ){\n      sqlite3OsDlClose(pVfs, handle);\n      return SQLITE_NOMEM;\n    }\n    memcpy(zAltEntry, \"sqlite3_\", 8);\n    for(iFile=ncFile-1; iFile>=0 && zFile[iFile]!='/'; iFile--){}\n    iFile++;\n    if( sqlite3_strnicmp(zFile+iFile, \"lib\", 3)==0 ) iFile += 3;\n    for(iEntry=8; (c = zFile[iFile])!=0 && c!='.'; iFile++){\n      if( sqlite3Isalpha(c) ){\n        zAltEntry[iEntry++] = (char)sqlite3UpperToLower[(unsigned)c];\n      }\n    }\n    memcpy(zAltEntry+iEntry, \"_init\", 6);\n    zEntry = zAltEntry;\n    xInit = (int(*)(sqlite3*,char**,const sqlite3_api_routines*))\n                     sqlite3OsDlSym(pVfs, handle, zEntry);\n  }\n\n\u3053\u306e\u3088\u3046\u306b\u53e4\u3044PHP\u3060\u3068\u30d0\u30f3\u30c9\u30eb\u3055\u308c\u3066\u3044\u308bSQLite\u306e\u30a8\u30f3\u30c8\u30ea\u30fc\u30dd\u30a4\u30f3\u30c8\u306e\u53d6\u5f97\u65b9\u6cd5\u304c\u7570\u306a\u308b\u305f\u3081\u306b\u3001\u30a8\u30e9\u30fc\u306b\u306a\u308b\u306e\u3067\u3059\u3002\n\n\u4f55\u6545\u3001Windows\u3067\u306fsqlite3_modspatialite_init\u3068\u3044\u3046\u30a8\u30f3\u30c8\u30ea\u30fc\u30dd\u30a4\u30f3\u30c8\u3092\u53d6\u5f97\u3067\u304d\u306a\u3044\u304b\n\u6b21\u306bWindows\u3067\u306f\u3069\u3046\u3057\u3066\u65b0\u3057\u3044PHP\u3067\u3082\u30a8\u30f3\u30c8\u30ea\u30fc\u30dd\u30a4\u30f3\u30c8\u3092\u53d6\u5f97\u3067\u304d\u306a\u3044\u304b\u8aac\u660e\u3057\u307e\u3059\u3002\nPHP\u306fsqlite3.extension_dir \u3067\u6307\u5b9a\u3057\u305f\u30d5\u30a9\u30eb\u30c0\u540d\u3068\u3001loadExtension\u3067\u6307\u5b9a\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u540d\u3092\u7d44\u307f\u5408\u308f\u305b\u3066\u3001sqlite3LoadExtension\u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\u3002\n\u3064\u307e\u308a\u3001sqlite3LoadExtension\u306b\u6e21\u3055\u308c\u308bzFile\u306f\u6b21\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\nC:\\tool\\spatialite\\mod_spatialite-4.2.0-win-x86\\mod_spatialite.dll\n\nUNIX\u306e\u5834\u5408\u3001\u30d1\u30b9\u306e\u533a\u5207\u308a\u304c\u300c/\u300d\u306a\u306e\u3067\u9069\u5207\u306b\u30d5\u30a1\u30a4\u30eb\u540d\u3092\u62bd\u51fa\u3057\u307e\u3059\u304c\u3001Windows\u3060\u3068\u300c\\\u300d\u306a\u306e\u3067\u62bd\u51fa\u3057\u307e\u305b\u3093\u3002\u3053\u306e\u5834\u5408\u3001\u30a8\u30f3\u30c8\u30ea\u30fc\u30dd\u30a4\u30f3\u30c8\u3068\u3057\u3066\u671f\u5f85\u3055\u308c\u308b\u306e\u304c\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3057\u307e\u3046\u306e\u3067\u3059\u3002\nctoolspatialitemod_spatialitewinmod_spatialite\n\n\n\u5bfe\u5fdc\u7b56\n\u3088\u3046\u3059\u308b\u306b\u30a8\u30f3\u30c8\u30ea\u30fc\u30dd\u30a4\u30f3\u30c8\u3092\u8a8d\u8b58\u3055\u305b\u308c\u3070\u3044\u3044\u306e\u3067\u3059\u3002\n\u6b8b\u5ff5\u306a\u3053\u3068\u306bPHP\u3067\u306f\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306aSQL\u3092\u8a8d\u3081\u3066\u3044\u307e\u305b\u3093\u3002\nSELECT load_extension(\"mod_spatialite\", \"sqlite3_modspatialite_init\")'\n\nhttps://github.com/php/php-src/blob/PHP-5.5/ext/sqlite3/sqlite3.c\n\nsqlite3.c\nPHP_METHOD(sqlite3, loadExtension)\n{\n    php_sqlite3_db_object *db_obj;\n    zval *object = getThis();\n    char *extension, *lib_path, *extension_dir, *errtext = NULL;\n    char fullpath[MAXPATHLEN];\n    int extension_len, extension_dir_len;\n    db_obj = (php_sqlite3_db_object *)zend_object_store_get_object(object TSRMLS_CC);\n\n    SQLITE3_CHECK_INITIALIZED(db_obj, db_obj->initialised, SQLite3)\n\n    if (FAILURE == zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, \"s\", &extension, &extension_len)) {\n        return;\n    }\n\n#ifdef ZTS\n    if ((strncmp(sapi_module.name, \"cgi\", 3) != 0) &&\n        (strcmp(sapi_module.name, \"cli\") != 0) &&\n        (strncmp(sapi_module.name, \"embed\", 5) != 0)\n    ) {     php_sqlite3_error(db_obj, \"Not supported in multithreaded Web servers\");\n        RETURN_FALSE;\n    }\n#endif\n\n    if (!SQLITE3G(extension_dir)) {\n        php_sqlite3_error(db_obj, \"SQLite Extension are disabled\");\n        RETURN_FALSE;\n    }\n\n    if (extension_len == 0) {\n        php_sqlite3_error(db_obj, \"Empty string as an extension\");\n        RETURN_FALSE;\n    }\n\n    extension_dir = SQLITE3G(extension_dir);\n    extension_dir_len = strlen(SQLITE3G(extension_dir));\n\n    if (IS_SLASH(extension_dir[extension_dir_len-1])) {\n        spprintf(&lib_path, 0, \"%s%s\", extension_dir, extension);\n    } else {\n        spprintf(&lib_path, 0, \"%s%c%s\", extension_dir, DEFAULT_SLASH, extension);\n    }\n\n    if (!VCWD_REALPATH(lib_path, fullpath)) {\n        php_sqlite3_error(db_obj, \"Unable to load extension at '%s'\", lib_path);\n        efree(lib_path);\n        RETURN_FALSE;\n    }\n\n    efree(lib_path);\n\n    if (strncmp(fullpath, extension_dir, extension_dir_len) != 0) {\n        php_sqlite3_error(db_obj, \"Unable to open extensions outside the defined directory\");\n        RETURN_FALSE;\n    }\n\n    /* Extension loading should only be enabled for when we attempt to load */\n    sqlite3_enable_load_extension(db_obj->db, 1);\n    if (sqlite3_load_extension(db_obj->db, fullpath, 0, &errtext) != SQLITE_OK) {\n        php_sqlite3_error(db_obj, \"%s\", errtext);\n        sqlite3_free(errtext);\n        sqlite3_enable_load_extension(db_obj->db, 0);\n        RETURN_FALSE;\n    }\n    sqlite3_enable_load_extension(db_obj->db, 0);\n\n    RETURN_TRUE;\n}\n\n\n\nloadExtension\u3092\u3059\u308b\u307e\u3048\u306bsqlite3_enable_load_extension\u3067\u62e1\u5f35\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u8a31\u53ef\u3057\u3066\u3001\u51e6\u7406\u304c\u7d42\u4e86\u3057\u305f\u3089\u4e0d\u8a31\u53ef\u306b\u3057\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3059\u3002\n\u3064\u307e\u308a\u3001PHP\u306e\u601d\u60f3\u3068\u3057\u3066\u306fSELECT\u3067load_extension\u306f\u3055\u305b\u306a\u3044\u3068\u3044\u3046\u3082\u306e\u306b\u306a\u308a\u307e\u3059\u3002\n\u3053\u308c\u4ee5\u5916\u306b\u56de\u907f\u3059\u308b\u65b9\u6cd5\u306f\uff13\u3064\u3042\u308a\u307e\u3059\u3002\n\uff11\u3064 mod_spatialite\u306e\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3067\u30a8\u30f3\u30c8\u30ea\u30fc\u30dd\u30a4\u30f3\u30c8\u540d\u3092\u5909\u66f4\u3059\u308b\n\uff12\u3064 mod_spatialite.dll\u3092\u30d0\u30a4\u30ca\u30ea\u30a8\u30c7\u30a3\u30bf\u3067\u958b\u3044\u3066\u3001\u30a8\u30f3\u30c8\u30ea\u30fc\u30dd\u30a4\u30f3\u30c8\u540d\u3092\u6539\u3056\u3093\u3059\u308b\n\uff13\u3064 sqlite\u306e\u30b3\u30fc\u30c9\u3067\u300c\\\u300d\u3082\u8003\u616e\u3059\u308b\u3088\u3046\u306b\u3059\u308b\u3002\n\u4ee5\u4e0a\u306e\uff13\u3064\u3067\u3059\u3002\n\nmod_spatialite\u306e\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3067\u30a8\u30f3\u30c8\u30ea\u30fc\u30dd\u30a4\u30f3\u30c8\u540d\u3092\u5909\u66f4\u3059\u308b\n\u3053\u308c\u306b\u95a2\u3057\u3066\u306f\u672a\u691c\u8a3c\u3067\u3059\u3002\n\u305f\u3060\u3001\u30a8\u30f3\u30c8\u30ea\u30fc\u30dd\u30a4\u30f3\u30c8\u3092\u4fee\u6b63\u3059\u308b\u306e\u306f\u697d\u3067\u3082\u3001mod_spatialite\u3092Windows\u3067\u30d3\u30eb\u30c9\u3059\u308b\u74b0\u5883\u3092\u4f5c\u308b\u306e\u306f\u3057\u3093\u3069\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\nmod_spatialite.dll\u3092\u30d0\u30a4\u30ca\u30ea\u30a8\u30c7\u30a3\u30bf\u3067\u958b\u3044\u3066\u3001\u30a8\u30f3\u30c8\u30ea\u30fc\u30dd\u30a4\u30f3\u30c8\u540d\u3092\u6539\u3056\u3093\u3059\u308b\n\n\nsqlite3_modspatialite_init\u3068\u3044\u3046\u6587\u5b57\u3092\u30d0\u30a4\u30ca\u30ea\u30a8\u30c7\u30a3\u30bf\u3067\u691c\u7d22\u3057\u3066\u3001sqlite3_extension_init\u306b\u7f6e\u304d\u63db\u3048\u307e\u3059\u3002\u3053\u306e\u969b\u3001\u8db3\u308a\u306a\u3044\u3068\u3053\u308d\u306b\u306f00\u3067\u57cb\u3081\u307e\u3059\u3002\u524a\u9664\u3057\u305f\u308a\u3059\u308b\u3068\u3001\u30a2\u30c9\u30ec\u30b9\u304c\u5909\u308f\u308b\u306e\u3067\u52d5\u4f5c\u3057\u306a\u304f\u306a\u308a\u307e\u3059\u3002\n\u3053\u306e\u65b9\u6cd5\u3067\u5bfe\u5fdc\u3057\u305f\u5834\u5408\u3001RTree\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u4f7f\u7528\u3067\u304d\u306a\u304f\u306a\u308b\u3053\u3068\u306b\u76ee\u3092\u3064\u3076\u308c\u3070PHP5.3\u3067\u3082mod_spatialite\u3092\u5229\u7528\u3067\u304d\u307e\u3059\u3002\n\nsqlite\u306e\u30b3\u30fc\u30c9\u3067\u300c\\\u300d\u3082\u8003\u616e\u3059\u308b\u3088\u3046\u306b\u3059\u308b\u3002\n\u305d\u3082\u305d\u3082\u8ad6\u3068\u3057\u3066\u3001sqlite3.c\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u4fee\u6b63\u3059\u308c\u3070\u300c\\\u300d\u3067\u3082\u30d5\u30a1\u30a4\u30eb\u540d\u306e\u307f\u3092\u62bd\u51fa\u3057\u307e\u3059\u3002\n\nsqlite3.c\n  if( xInit==0 && zProc==0 ){\n    int iFile, iEntry, c;\n    int ncFile = sqlite3Strlen30(zFile);\n    zAltEntry = sqlite3_malloc(ncFile+30);\n    if( zAltEntry==0 ){\n      sqlite3OsDlClose(pVfs, handle);\n      return SQLITE_NOMEM;\n    }\n    memcpy(zAltEntry, \"sqlite3_\", 8);\n    // Windows \u5bfe\u5fdc\n    //for(iFile=ncFile-1; iFile>=0 && zFile[iFile]!='/'; iFile--){}\n    for(iFile=ncFile-1; iFile>=0 && (zFile[iFile]!='/' && zFile[iFile]!='\\\\'); iFile--){}\n\n\n\u3042\u3068\u306fPHP\u306e\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3092Windows\u3067\u30d3\u30eb\u30c9\u3059\u308b\u65b9\u6cd5\u3067\u3059\u304c\u3001\u4ee5\u4e0b\u3092\u53c2\u8003\u306b\u3059\u308b\u3068\u826f\u3044\u3067\u3057\u3087\u3046\u3002\nPHP\u62e1\u5f35\u30e2\u30b8\u30e5\u30fc\u30eb\u3092 Windows \u3067\u30d3\u30eb\u30c9 \nhttp://ngyuki.hatenablog.com/entry/20120625/p1\nPHP \u3092 Windows \u3067\u30d3\u30eb\u30c9 \nhttp://ngyuki.hatenablog.com/entry/20120701/p1\nphp_sqlite3.dll\u3092\u4f5c\u6210\u3059\u308b\u306b\u306f\u6b21\u306e\u3088\u3046\u306aconfigure\u3067\u3044\u3051\u307e\u3057\u305f\u3002\nconfigure --disable-all --enable-cli --enable-cgi  --with-sqlite3=shared\nnmake\n\n\u4e00\u5fdcx86\u3067PHP5.6\u306eSQLite\u3092\u30d3\u30eb\u30c9\u3057\u305f\u3082\u306e\u3092\u4ee5\u4e0b\u306b\u7f6e\u304d\u307e\u3059\u3002\nhttp://needtec.sakura.ne.jp/release/php_sqlite3.zip\n\n\u307e\u3068\u3081\n\u3053\u306e\u3088\u3046\u306b\u3001Spatialite\u3092PHP\u3067\u4f7f\u3046\u306b\u306f\u304b\u306a\u308a\u82e6\u52b4\u304c\u5fc5\u8981\u3067\u3059\u3002\n##\u76ee\u7684\n\u3053\u306e\u8a18\u4e8b\u3067\u306fPHP\u3067Spatialite\u3092\u4f7f\u3046\u65b9\u6cd5\u306b\u3064\u3044\u3066\u89e3\u8aac\u3057\u307e\u3059\u3002\n\nSpatialite\u306e\u30d3\u30eb\u30c9\u306a\u3069\u306b\u3064\u3044\u3066\u306f\u4e0b\u8a18\u3092\u53c2\u8003\u306b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n **\u5730\u56f3\u3068\u304b\u306e\u7a7a\u9593\u60c5\u5831\u3092SQLite\u306b\u683c\u7d0d\u3059\u308bSpatiaLite\u3092\u4f7f\u7528\u3057\u3066\u307f\u308b** \nhttp://qiita.com/mima_ita/items/64f6c2b8bb47c4b5b391\n\n\n\u6700\u7d42\u76ee\u7684\u3068\u3057\u3066\u306f\u4ee5\u4e0b\u306e\u30b3\u30fc\u30c9\u304c\u52d5\u4f5c\u3059\u308b\u3053\u3068\u3092\u76ee\u6a19\u3068\u3057\u307e\u3059\u3002\n\n```php\n<?php\n\nclass MyDB extends SQLite3\n{\n    function __construct()\n    {\n        $this->open(':memory:');\n    }\n}\n\n$ver = SQLite3::version();\nvar_dump($ver);\n\n\n$db = new MyDB();\nif (!$db->loadExtension('mod_spatialite.dll')) {\n  exit();\n}\n\n\n# reporting some version info\n$rs = $db->query('SELECT sqlite_version()');\nwhile ($row = $rs->fetchArray())\n{\n  print \"SQLite version: $row[0]\" . PHP_EOL;\n}\n\n$rs = $db->query('SELECT spatialite_version()');\nwhile ($row = $rs->fetchArray())\n{\n  print \"SpatiaLite version: $row[0]\" . PHP_EOL;\n}\n\n$db->exec('SELECT InitSpatialMetaData()');\n$db->exec('CREATE TABLE foo (name TEXT)');\n$db->exec('SELECT AddGeometryColumn(\"foo\", \"Geometry\", 0, \"POINT\", 2)');\n\n#SQLite 3.7.17\u4ee5\u964d\u3058\u3083\u306a\u3044\u3068RTree\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u306f\u4f5c\u308c\u306a\u3044\nif ($ver->versionNumber < 3007017) {\n  print \"RTree-Index is Not supported. (< 3.7.17)\" . PHP_EOL;\n} else {\n  $db->exec('SELECT CreateSpatialIndex(\"foo\", \"Geometry\")');\n}\n$db->exec('INSERT INTO foo VALUES(\"test1\", GeometryFromText(\"POINT(140 30)\"))');\n$db->exec('INSERT INTO foo VALUES(\"test2\", GeometryFromText(\"POINT(135 33)\"))');\n\n$rs = $db->query('SELECT name, AsGeoJson(\"Geometry\") AS geo FROM foo');\n\nwhile ($row = $rs->fetchArray())\n{\n  var_dump($row);\n}\n\n$db->close();\n\n\n?>\n```\n\n##\u524d\u63d0\nPHP5.5\u4ee5\u964d\u3067\u306a\u3044\u3068loadExtension\u306f\u52d5\u4f5c\u3057\u307e\u305b\u3093\u3002\n\u5c11\u306a\u304f\u3068\u3082\u3001PHP5.3\u3067\u306f\u57fa\u672c\u7121\u7406(\u203b\uff09\u3067\u3001PHP5.6\u3067\u306f\u3044\u3051\u307e\u3057\u305f\u3002\n\u306a\u306e\u3067\u3001\u7279\u306b\u5236\u7d04\u304c\u306a\u3051\u308c\u3070PHP\u306e\u6700\u65b0\u3092\u7528\u610f\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u306a\u304a\u3001\u57fa\u672c\u7121\u7406\u3068\u3044\u3046\u306e\u306f\u3001\u6a5f\u80fd\u3092\u843d\u3068\u3057\u3066\u3001\u306a\u3093\u3084\u304b\u3093\u3084\u3059\u308c\u3070\u3001\u306a\u3093\u3068\u304b\u306a\u308a\u306f\u3057\u307e\u3059\u3002\n\n\n\u3042\u3068\u3001Windows\u30e6\u30fc\u30b6\u306e\u4eba\u306f\u82e6\u52b4\u3057\u307e\u3059\u3002Linux\u3068\u304bMac\u306e\u30d1\u30b9\u306e\u533a\u5207\u308a\u304c\"/\"\u306e\u74b0\u5883\u3060\u3068\u6bd4\u8f03\u7684\u697d\u3067\u3059\u3002\n\n\n##php.ini\u306e\u4fee\u6b63\nloadExtension\u3092\u7528\u3044\u3066\u62e1\u5f35\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u4f7f\u3046\u5834\u5408\u3001php.ini\u3092\u4fee\u6b63\u3057\u3066\u3001\u62e1\u5f35\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u8aad\u307f\u8fbc\u3081\u308b\u3088\u3046\u306b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\nWindows\u306e\u5834\u5408\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u3067SQLite3\u304c\u7121\u52b9\u306b\u306a\u3063\u3066\u3044\u308b\u5834\u5408\u3082\u3042\u308b\u306e\u3067php.ini\u306e\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3092\u5916\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n```ini:php.ini\nextension=php_sqlite3.dll\n```\n\n\u6b21\u306b\u62e1\u5f35\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u683c\u7d0d\u3057\u3066\u3044\u308b\u30d5\u30a9\u30eb\u30c0\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n```ini:php.ini\n[sqlite3]\nsqlite3.extension_dir =C:\\tool\\spatialite\\mod_spatialite-4.2.0-win-x86\n```\n\nPHP\u306eSQLite\u3067\u306f\u3001\u3053\u3053\u3067\u6307\u5b9a\u3057\u305f\u30d5\u30a9\u30eb\u30c0\u4ee5\u5916\u304b\u3089\u62e1\u5f35\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u30ed\u30fc\u30c9\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093\u3002\n\n\u3042\u3068\u306f\u74b0\u5883\u5909\u6570\u306ePATH\u306b\u4e0a\u8a18\u306e\u30d5\u30a9\u30eb\u30c0\u3092\u6307\u5b9a\u3059\u308c\u3070\u3001\u30e9\u30c3\u30ad\u30fc\u30ac\u30a4\u306a\u74b0\u5883\u3067\u306f\u52d5\u4f5c\u3057\u307e\u3059\u3002\u304a\u75b2\u308c\u69d8\u3067\u3057\u305f\u3002\n\n\u4ee5\u4e0b\u306e\u30a8\u30e9\u30fc\u304c\u51fa\u308b\u5834\u5408\u306f\u3001\u3053\u3053\u304b\u3089\u304c\u672c\u5f53\u306e\u5730\u7344\u3067\u3059\u3002\n\n```\nPHP Warning:  SQLite3::loadExtension(): \u6307\u5b9a\u3055\u308c\u305f\u30d7\u30ed\u30b7\u30fc\u30b8\u30e3\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093\u3002\n```\n\n##\u4f55\u3067\u30a8\u30e9\u30fc\u306b\u306a\u308b\u304b\n\u304a\u305d\u3089\u304f\u3001\u3053\u3053\u3067\u30a8\u30e9\u30fc\u306b\u306a\u308b\u306e\u306fPHP\u304c\u4f7f\u7528\u3057\u3066\u3044\u308bSQLite\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u53e4\u3044\u304b\u3001Windows\u30e6\u30fc\u30b6\u306e\u4eba\u3060\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u306a\u305c\u30a8\u30e9\u30fc\u306b\u306a\u308b\u304b\u306e\u524d\u306bSQLite\u306e\u62e1\u5f35\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u30a8\u30f3\u30c8\u30ea\u30fc\u30dd\u30a4\u30f3\u30c8\u304c\u95a2\u4fc2\u3057\u3066\u3044\u307e\u3059\u3002\n\n **Run-Time Loadable Extensions** \nhttp://www.sqlite.org/loadext.html\n\n\u672c\u6765\u306eSQLite\u306eload_extension\u306fload_extension(X,Y)\u3068\u306a\u3063\u3066\u304a\u308a\u3001\uff12\u3064\u306e\u5f15\u6570\u3092\u53d6\u308a\u307e\u3059\u3002X\u304c\u30e2\u30b8\u30e5\u30fc\u30eb\u540d\u3067Y\u304c\u30a8\u30f3\u30c8\u30ea\u30fc\u30dd\u30a4\u30f3\u30c8\u306e\u95a2\u6570\u540d\u3068\u306a\u308a\u307e\u3059\u3002\n\u3053\u306eY\u306f\u7701\u7565\u53ef\u80fd\u3067\u3001PHP\u306eloadExtension\u95a2\u6570\u306e\u5834\u5408\u3001\u7701\u7565\u3057\u3066\u5b9f\u884c\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n\u3053\u306e\u7701\u7565\u3055\u308c\u305f\u5834\u5408\u306e\u6319\u52d5\u306f\u6b21\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\u30fb\u3082\u3057\u7701\u7565\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u306f\u3000sqlite3_extension_init \u3092\u4f7f\u7528\u3059\u308b\n\u30fb\u3053\u308c\u3067\u30ed\u30fc\u30c9\u3067\u304d\u306a\u3044\u5834\u5408\u306f\u3001\u6700\u5f8c\u306e\"/\" \u4ee5\u964d\u3092\u4f7f\u7528\u3059\u308b\u3002\u3053\u306e\u6642\u3001\u63a5\u982d\u8a9e\u306elib\u306f\u9664\u53bb\u3057\u3001\u30a2\u30eb\u30d5\u30a1\u30d9\u30c3\u30c8\u306e\u307f\u3092\u5c0f\u6587\u5b57\u306b\u3057\u3001\u62e1\u5f35\u5b50\u306f\u8003\u616e\u3057\u306a\u3044\u3002\n\u5177\u4f53\u7684\u306b\u306f\u6b21\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n\"/usr/lib/libmathfunc-4.8.so\" \u21d2 \"sqlite3_mathfunc_init\". \n\"./SpellFixExt.dll\" \u21d2\"sqlite3_spellfixext_init\"\n\n\n\u306a\u304a\u3001mod_spatialite.dll\u306e\u30a8\u30f3\u30c8\u30ea\u30fc\u30dd\u30a4\u30f3\u30c8\u306f\u300csqlite3_modspatialite_init\u300d\u3068\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n\u3053\u308c\u306b\u3064\u3044\u3066\u306f\u3001Dependency.Walker\u3067\u8abf\u3079\u308b\u304b\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u8aad\u3093\u3067\u304f\u3060\u3055\u3044\u3002\n\n![spatialite.png](https://qiita-image-store.s3.amazonaws.com/0/47856/f6340ec8-6dfe-1865-8ec9-e8701e8a13b9.png)\nhttp://www.dependencywalker.com/\n\n\u3064\u307e\u308a\u3001PHP\u304b\u3089loadExtension\u3092\u884c\u3063\u305f\u5834\u5408\u306b\u30a8\u30f3\u30c8\u30ea\u30fc\u30dd\u30a4\u30f3\u30c8\u3092\u300csqlite3_modspatialite_init\u300d\u306b\u5909\u63db\u3067\u304d\u3066\u3044\u306a\u3044\u306e\u304c\u3001\u3053\u306e\u30a8\u30e9\u30fc\u306e\u539f\u56e0\u3068\u306a\u308a\u307e\u3059\u3002\n\n###\u4f55\u6545\u3001\u53e4\u3044PHP\u3067\u306fsqlite3_modspatialite_init\u3068\u3044\u3046\u30a8\u30f3\u30c8\u30ea\u30fc\u30dd\u30a4\u30f3\u30c8\u3092\u53d6\u5f97\u3067\u304d\u306a\u3044\u304b\nPHP5.4\u4ee5\u524d\u306e\u5834\u5408\u306f\u8a71\u306f\u7c21\u5358\u3067\u3059\u3002\u53e4\u3044SQLite\u306e\u4ed5\u69d8\u306b\u306f\u3053\u306e\u6a5f\u80fd\u304c\u306a\u304b\u3063\u305f\u3082\u306e\u3068\u63a8\u6e2c\u3067\u304d\u307e\u3059\u3002\n\u5b9f\u969b\u3001PHP5.4\u306b\u30d0\u30f3\u30c9\u30eb\u3055\u308c\u3066\u3044\u308bSQLite\u306e\u30b3\u30fc\u30c9\u306b\u3001\u8a72\u5f53\u306e\u51e6\u7406\u306f\u5b58\u5728\u3057\u307e\u305b\u3093\u3002\n\nhttps://github.com/php/php-src/blob/PHP-5.4/ext/sqlite3/libsqlite/sqlite3.c\n\n```c\nstatic int sqlite3LoadExtension(\n  sqlite3 *db,          /* Load the extension into this database connection */\n  const char *zFile,    /* Name of the shared library containing extension */\n  const char *zProc,    /* Entry point.  Use \"sqlite3_extension_init\" if 0 */\n  char **pzErrMsg       /* Put error message here if not 0 */\n){\n// \u7565\n  if( zProc==0 ){\n    zProc = \"sqlite3_extension_init\";\n  }\n\n  handle = sqlite3OsDlOpen(pVfs, zFile);\n  if( handle==0 ){\n    if( pzErrMsg ){\n      *pzErrMsg = zErrmsg = sqlite3_malloc(nMsg);\n      if( zErrmsg ){\n        sqlite3_snprintf(nMsg, zErrmsg, \n            \"unable to open shared library [%s]\", zFile);\n        sqlite3OsDlError(pVfs, nMsg-1, zErrmsg);\n      }\n    }\n    return SQLITE_ERROR;\n  }\n  xInit = (int(*)(sqlite3*,char**,const sqlite3_api_routines*))\n                   sqlite3OsDlSym(pVfs, handle, zProc);\n  if( xInit==0 ){\n    if( pzErrMsg ){\n      *pzErrMsg = zErrmsg = sqlite3_malloc(nMsg);\n      if( zErrmsg ){\n        sqlite3_snprintf(nMsg, zErrmsg,\n            \"no entry point [%s] in shared library [%s]\", zProc,zFile);\n        sqlite3OsDlError(pVfs, nMsg-1, zErrmsg);\n      }\n      sqlite3OsDlClose(pVfs, handle);\n    }\n    return SQLITE_ERROR;\n  }else if( xInit(db, &zErrmsg, &sqlite3Apis) ){\n    if( pzErrMsg ){\n      *pzErrMsg = sqlite3_mprintf(\"error during initialization: %s\", zErrmsg);\n    }\n    sqlite3_free(zErrmsg);\n    sqlite3OsDlClose(pVfs, handle);\n    return SQLITE_ERROR;\n  }\n\n```\n\n\u898b\u3066\u308f\u304b\u308b\u901a\u308a\u3001sqlite3OsDlSym\u3067xInit\u304c\u53d6\u5f97\u3067\u304d\u306a\u304b\u3063\u305f\u5834\u5408\u306b\u30a8\u30e9\u30fc\u3068\u3057\u3066\u8fd4\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u4e00\u65b9\u3001PHP5.5\u3067\u306f\u3001xInit\u304c\u53d6\u5f97\u3067\u304d\u306a\u304b\u3063\u305f\u5834\u5408\u306b\u3001\u4ee3\u66ff\u306e\u30a8\u30f3\u30c8\u30ea\u30fc\u30dd\u30a4\u30f3\u30c8\u3092\u53d6\u5f97\u3059\u308b\u51e6\u7406\u304c\u8a18\u8ff0\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\nhttps://raw.githubusercontent.com/php/php-src/PHP-5.5/ext/sqlite3/libsqlite/sqlite3.c\n\n```c\nstatic int sqlite3LoadExtension(\n  sqlite3 *db,          /* Load the extension into this database connection */\n  const char *zFile,    /* Name of the shared library containing extension */\n  const char *zProc,    /* Entry point.  Use \"sqlite3_extension_init\" if 0 */\n  char **pzErrMsg       /* Put error message here if not 0 */\n){\n// \u7565\n  xInit = (int(*)(sqlite3*,char**,const sqlite3_api_routines*))\n                   sqlite3OsDlSym(pVfs, handle, zEntry);\n\n  /* If no entry point was specified and the default legacy\n  ** entry point name \"sqlite3_extension_init\" was not found, then\n  ** construct an entry point name \"sqlite3_X_init\" where the X is\n  ** replaced by the lowercase value of every ASCII alphabetic \n  ** character in the filename after the last \"/\" upto the first \".\",\n  ** and eliding the first three characters if they are \"lib\".  \n  ** Examples:\n  **\n  **    /usr/local/lib/libExample5.4.3.so ==>  sqlite3_example_init\n  **    C:/lib/mathfuncs.dll              ==>  sqlite3_mathfuncs_init\n  */\n  if( xInit==0 && zProc==0 ){\n    int iFile, iEntry, c;\n    int ncFile = sqlite3Strlen30(zFile);\n    zAltEntry = sqlite3_malloc(ncFile+30);\n    if( zAltEntry==0 ){\n      sqlite3OsDlClose(pVfs, handle);\n      return SQLITE_NOMEM;\n    }\n    memcpy(zAltEntry, \"sqlite3_\", 8);\n    for(iFile=ncFile-1; iFile>=0 && zFile[iFile]!='/'; iFile--){}\n    iFile++;\n    if( sqlite3_strnicmp(zFile+iFile, \"lib\", 3)==0 ) iFile += 3;\n    for(iEntry=8; (c = zFile[iFile])!=0 && c!='.'; iFile++){\n      if( sqlite3Isalpha(c) ){\n        zAltEntry[iEntry++] = (char)sqlite3UpperToLower[(unsigned)c];\n      }\n    }\n    memcpy(zAltEntry+iEntry, \"_init\", 6);\n    zEntry = zAltEntry;\n    xInit = (int(*)(sqlite3*,char**,const sqlite3_api_routines*))\n                     sqlite3OsDlSym(pVfs, handle, zEntry);\n  }\n```\n\n\u3053\u306e\u3088\u3046\u306b\u53e4\u3044PHP\u3060\u3068\u30d0\u30f3\u30c9\u30eb\u3055\u308c\u3066\u3044\u308bSQLite\u306e\u30a8\u30f3\u30c8\u30ea\u30fc\u30dd\u30a4\u30f3\u30c8\u306e\u53d6\u5f97\u65b9\u6cd5\u304c\u7570\u306a\u308b\u305f\u3081\u306b\u3001\u30a8\u30e9\u30fc\u306b\u306a\u308b\u306e\u3067\u3059\u3002\n\n\n###\u4f55\u6545\u3001Windows\u3067\u306fsqlite3_modspatialite_init\u3068\u3044\u3046\u30a8\u30f3\u30c8\u30ea\u30fc\u30dd\u30a4\u30f3\u30c8\u3092\u53d6\u5f97\u3067\u304d\u306a\u3044\u304b\n\n\u6b21\u306bWindows\u3067\u306f\u3069\u3046\u3057\u3066\u65b0\u3057\u3044PHP\u3067\u3082\u30a8\u30f3\u30c8\u30ea\u30fc\u30dd\u30a4\u30f3\u30c8\u3092\u53d6\u5f97\u3067\u304d\u306a\u3044\u304b\u8aac\u660e\u3057\u307e\u3059\u3002\nPHP\u306fsqlite3.extension_dir \u3067\u6307\u5b9a\u3057\u305f\u30d5\u30a9\u30eb\u30c0\u540d\u3068\u3001loadExtension\u3067\u6307\u5b9a\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u540d\u3092\u7d44\u307f\u5408\u308f\u305b\u3066\u3001sqlite3LoadExtension\u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u3064\u307e\u308a\u3001sqlite3LoadExtension\u306b\u6e21\u3055\u308c\u308bzFile\u306f\u6b21\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n```\nC:\\tool\\spatialite\\mod_spatialite-4.2.0-win-x86\\mod_spatialite.dll\n```\n\nUNIX\u306e\u5834\u5408\u3001\u30d1\u30b9\u306e\u533a\u5207\u308a\u304c\u300c/\u300d\u306a\u306e\u3067\u9069\u5207\u306b\u30d5\u30a1\u30a4\u30eb\u540d\u3092\u62bd\u51fa\u3057\u307e\u3059\u304c\u3001Windows\u3060\u3068\u300c\\\u300d\u306a\u306e\u3067\u62bd\u51fa\u3057\u307e\u305b\u3093\u3002\u3053\u306e\u5834\u5408\u3001\u30a8\u30f3\u30c8\u30ea\u30fc\u30dd\u30a4\u30f3\u30c8\u3068\u3057\u3066\u671f\u5f85\u3055\u308c\u308b\u306e\u304c\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3057\u307e\u3046\u306e\u3067\u3059\u3002\n\n```\nctoolspatialitemod_spatialitewinmod_spatialite\n```\n\n##\u5bfe\u5fdc\u7b56\n\u3088\u3046\u3059\u308b\u306b\u30a8\u30f3\u30c8\u30ea\u30fc\u30dd\u30a4\u30f3\u30c8\u3092\u8a8d\u8b58\u3055\u305b\u308c\u3070\u3044\u3044\u306e\u3067\u3059\u3002\n\u6b8b\u5ff5\u306a\u3053\u3068\u306bPHP\u3067\u306f\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306aSQL\u3092\u8a8d\u3081\u3066\u3044\u307e\u305b\u3093\u3002\n\n```sql\nSELECT load_extension(\"mod_spatialite\", \"sqlite3_modspatialite_init\")'\n```\n\nhttps://github.com/php/php-src/blob/PHP-5.5/ext/sqlite3/sqlite3.c\n\n```c:sqlite3.c\nPHP_METHOD(sqlite3, loadExtension)\n{\n\tphp_sqlite3_db_object *db_obj;\n\tzval *object = getThis();\n\tchar *extension, *lib_path, *extension_dir, *errtext = NULL;\n\tchar fullpath[MAXPATHLEN];\n\tint extension_len, extension_dir_len;\n\tdb_obj = (php_sqlite3_db_object *)zend_object_store_get_object(object TSRMLS_CC);\n\n\tSQLITE3_CHECK_INITIALIZED(db_obj, db_obj->initialised, SQLite3)\n\n\tif (FAILURE == zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, \"s\", &extension, &extension_len)) {\n\t\treturn;\n\t}\n\n#ifdef ZTS\n\tif ((strncmp(sapi_module.name, \"cgi\", 3) != 0) &&\n\t\t(strcmp(sapi_module.name, \"cli\") != 0) &&\n\t\t(strncmp(sapi_module.name, \"embed\", 5) != 0)\n\t) {\t\tphp_sqlite3_error(db_obj, \"Not supported in multithreaded Web servers\");\n\t\tRETURN_FALSE;\n\t}\n#endif\n\n\tif (!SQLITE3G(extension_dir)) {\n\t\tphp_sqlite3_error(db_obj, \"SQLite Extension are disabled\");\n\t\tRETURN_FALSE;\n\t}\n\n\tif (extension_len == 0) {\n\t\tphp_sqlite3_error(db_obj, \"Empty string as an extension\");\n\t\tRETURN_FALSE;\n\t}\n\n\textension_dir = SQLITE3G(extension_dir);\n\textension_dir_len = strlen(SQLITE3G(extension_dir));\n\n\tif (IS_SLASH(extension_dir[extension_dir_len-1])) {\n\t\tspprintf(&lib_path, 0, \"%s%s\", extension_dir, extension);\n\t} else {\n\t\tspprintf(&lib_path, 0, \"%s%c%s\", extension_dir, DEFAULT_SLASH, extension);\n\t}\n\n\tif (!VCWD_REALPATH(lib_path, fullpath)) {\n\t\tphp_sqlite3_error(db_obj, \"Unable to load extension at '%s'\", lib_path);\n\t\tefree(lib_path);\n\t\tRETURN_FALSE;\n\t}\n\n\tefree(lib_path);\n\n\tif (strncmp(fullpath, extension_dir, extension_dir_len) != 0) {\n\t\tphp_sqlite3_error(db_obj, \"Unable to open extensions outside the defined directory\");\n\t\tRETURN_FALSE;\n\t}\n\n\t/* Extension loading should only be enabled for when we attempt to load */\n\tsqlite3_enable_load_extension(db_obj->db, 1);\n\tif (sqlite3_load_extension(db_obj->db, fullpath, 0, &errtext) != SQLITE_OK) {\n\t\tphp_sqlite3_error(db_obj, \"%s\", errtext);\n\t\tsqlite3_free(errtext);\n\t\tsqlite3_enable_load_extension(db_obj->db, 0);\n\t\tRETURN_FALSE;\n\t}\n\tsqlite3_enable_load_extension(db_obj->db, 0);\n\n\tRETURN_TRUE;\n}\n\n```\n\nloadExtension\u3092\u3059\u308b\u307e\u3048\u306bsqlite3_enable_load_extension\u3067\u62e1\u5f35\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u8a31\u53ef\u3057\u3066\u3001\u51e6\u7406\u304c\u7d42\u4e86\u3057\u305f\u3089\u4e0d\u8a31\u53ef\u306b\u3057\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3059\u3002\n\u3064\u307e\u308a\u3001PHP\u306e\u601d\u60f3\u3068\u3057\u3066\u306fSELECT\u3067load_extension\u306f\u3055\u305b\u306a\u3044\u3068\u3044\u3046\u3082\u306e\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u3053\u308c\u4ee5\u5916\u306b\u56de\u907f\u3059\u308b\u65b9\u6cd5\u306f\uff13\u3064\u3042\u308a\u307e\u3059\u3002\n\n\uff11\u3064 mod_spatialite\u306e\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3067\u30a8\u30f3\u30c8\u30ea\u30fc\u30dd\u30a4\u30f3\u30c8\u540d\u3092\u5909\u66f4\u3059\u308b\n\uff12\u3064 mod_spatialite.dll\u3092\u30d0\u30a4\u30ca\u30ea\u30a8\u30c7\u30a3\u30bf\u3067\u958b\u3044\u3066\u3001\u30a8\u30f3\u30c8\u30ea\u30fc\u30dd\u30a4\u30f3\u30c8\u540d\u3092\u6539\u3056\u3093\u3059\u308b\n\uff13\u3064 sqlite\u306e\u30b3\u30fc\u30c9\u3067\u300c\\\u300d\u3082\u8003\u616e\u3059\u308b\u3088\u3046\u306b\u3059\u308b\u3002\n\n\u4ee5\u4e0a\u306e\uff13\u3064\u3067\u3059\u3002\n\n###mod_spatialite\u306e\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3067\u30a8\u30f3\u30c8\u30ea\u30fc\u30dd\u30a4\u30f3\u30c8\u540d\u3092\u5909\u66f4\u3059\u308b\n\u3053\u308c\u306b\u95a2\u3057\u3066\u306f\u672a\u691c\u8a3c\u3067\u3059\u3002\n\u305f\u3060\u3001\u30a8\u30f3\u30c8\u30ea\u30fc\u30dd\u30a4\u30f3\u30c8\u3092\u4fee\u6b63\u3059\u308b\u306e\u306f\u697d\u3067\u3082\u3001mod_spatialite\u3092Windows\u3067\u30d3\u30eb\u30c9\u3059\u308b\u74b0\u5883\u3092\u4f5c\u308b\u306e\u306f\u3057\u3093\u3069\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n\n### mod_spatialite.dll\u3092\u30d0\u30a4\u30ca\u30ea\u30a8\u30c7\u30a3\u30bf\u3067\u958b\u3044\u3066\u3001\u30a8\u30f3\u30c8\u30ea\u30fc\u30dd\u30a4\u30f3\u30c8\u540d\u3092\u6539\u3056\u3093\u3059\u308b\n\n![spatialite_bin.png](https://qiita-image-store.s3.amazonaws.com/0/47856/0be5ebef-2ba6-d1e2-d14d-2fdfbbdfd246.png)\n\n![spatialite_bin2.png](https://qiita-image-store.s3.amazonaws.com/0/47856/f370afef-410c-5205-0eb7-7040ecd89741.png)\n\nsqlite3_modspatialite_init\u3068\u3044\u3046\u6587\u5b57\u3092\u30d0\u30a4\u30ca\u30ea\u30a8\u30c7\u30a3\u30bf\u3067\u691c\u7d22\u3057\u3066\u3001sqlite3_extension_init\u306b\u7f6e\u304d\u63db\u3048\u307e\u3059\u3002\u3053\u306e\u969b\u3001\u8db3\u308a\u306a\u3044\u3068\u3053\u308d\u306b\u306f00\u3067\u57cb\u3081\u307e\u3059\u3002\u524a\u9664\u3057\u305f\u308a\u3059\u308b\u3068\u3001\u30a2\u30c9\u30ec\u30b9\u304c\u5909\u308f\u308b\u306e\u3067\u52d5\u4f5c\u3057\u306a\u304f\u306a\u308a\u307e\u3059\u3002\n\n\u3053\u306e\u65b9\u6cd5\u3067\u5bfe\u5fdc\u3057\u305f\u5834\u5408\u3001RTree\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u4f7f\u7528\u3067\u304d\u306a\u304f\u306a\u308b\u3053\u3068\u306b\u76ee\u3092\u3064\u3076\u308c\u3070PHP5.3\u3067\u3082mod_spatialite\u3092\u5229\u7528\u3067\u304d\u307e\u3059\u3002\n\n### sqlite\u306e\u30b3\u30fc\u30c9\u3067\u300c\\\u300d\u3082\u8003\u616e\u3059\u308b\u3088\u3046\u306b\u3059\u308b\u3002\n\u305d\u3082\u305d\u3082\u8ad6\u3068\u3057\u3066\u3001sqlite3.c\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u4fee\u6b63\u3059\u308c\u3070\u300c\\\u300d\u3067\u3082\u30d5\u30a1\u30a4\u30eb\u540d\u306e\u307f\u3092\u62bd\u51fa\u3057\u307e\u3059\u3002\n\n```c:sqlite3.c\n  if( xInit==0 && zProc==0 ){\n    int iFile, iEntry, c;\n    int ncFile = sqlite3Strlen30(zFile);\n    zAltEntry = sqlite3_malloc(ncFile+30);\n    if( zAltEntry==0 ){\n      sqlite3OsDlClose(pVfs, handle);\n      return SQLITE_NOMEM;\n    }\n    memcpy(zAltEntry, \"sqlite3_\", 8);\n  \t// Windows \u5bfe\u5fdc\n    //for(iFile=ncFile-1; iFile>=0 && zFile[iFile]!='/'; iFile--){}\n    for(iFile=ncFile-1; iFile>=0 && (zFile[iFile]!='/' && zFile[iFile]!='\\\\'); iFile--){}\n```\n\n\u3042\u3068\u306fPHP\u306e\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3092Windows\u3067\u30d3\u30eb\u30c9\u3059\u308b\u65b9\u6cd5\u3067\u3059\u304c\u3001\u4ee5\u4e0b\u3092\u53c2\u8003\u306b\u3059\u308b\u3068\u826f\u3044\u3067\u3057\u3087\u3046\u3002\n\n **PHP\u62e1\u5f35\u30e2\u30b8\u30e5\u30fc\u30eb\u3092 Windows \u3067\u30d3\u30eb\u30c9** \nhttp://ngyuki.hatenablog.com/entry/20120625/p1\n\n **PHP \u3092 Windows \u3067\u30d3\u30eb\u30c9** \nhttp://ngyuki.hatenablog.com/entry/20120701/p1\n\n\nphp_sqlite3.dll\u3092\u4f5c\u6210\u3059\u308b\u306b\u306f\u6b21\u306e\u3088\u3046\u306aconfigure\u3067\u3044\u3051\u307e\u3057\u305f\u3002\n\n```\nconfigure --disable-all --enable-cli --enable-cgi  --with-sqlite3=shared\nnmake\n```\n\n\u4e00\u5fdcx86\u3067PHP5.6\u306eSQLite\u3092\u30d3\u30eb\u30c9\u3057\u305f\u3082\u306e\u3092\u4ee5\u4e0b\u306b\u7f6e\u304d\u307e\u3059\u3002\nhttp://needtec.sakura.ne.jp/release/php_sqlite3.zip\n\n##\u307e\u3068\u3081\n\u3053\u306e\u3088\u3046\u306b\u3001Spatialite\u3092PHP\u3067\u4f7f\u3046\u306b\u306f\u304b\u306a\u308a\u82e6\u52b4\u304c\u5fc5\u8981\u3067\u3059\u3002\n", "tags": ["PHP5.6", "SQLite3"]}