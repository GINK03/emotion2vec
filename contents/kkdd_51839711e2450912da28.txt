{"context": "\u3053\u3093\u306b\u3061\u306f\u3002\nMapbox GL JS + d3.js + svg \u30aa\u30fc\u30d0\u30ec\u30a4 + transition + topojson \u30c7\u30fc\u30bf\u8aad\u307f\u8fbc\u307f\u306e\u4f8b\u3092\u898b\u3064\u3051\u307e\u3057\u305f\u3002\n\nIan Johnson\u2019s Block \nWWSD #11: Mapbox-gl + d3 SVG overlay\n\n\u3053\u308c\u3092\u3001tilt/rotation \u5bfe\u5fdc\u3078\u5c0f\u4fee\u6b63\u3057\u3001\u52a0\u3048\u3066 tooltip/popup \u6a5f\u80fd\u3092\u624b\u52d5\u3067\u4f5c\u3063\u3066\u307f\u307e\u3057\u305f1\u3002\n\n\nmapboxgl_d3_svg.html\n<!DOCTYPE html>\n<head>\n  <meta charset=\"utf-8\">\n  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />\n  <script src=\"http://d3js.org/topojson.v1.min.js\"></script>\n  <script src=\"http://d3js.org/d3.v3.min.js\"></script>\n  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.29.0/mapbox-gl.js'></script>\n  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.29.0/mapbox-gl.css' rel='stylesheet' />\n  <style>\n    body { margin:0;position:fixed;top:0;right:0;bottom:0;left:0; }\n    #map { \n      position:absolute; \n      width: 100%;\n      height: 100%;\n    }\n    svg {\n      position: absolute;\n      width: 100%;\n      height: 100%;\n    }\n    .tooltip {\n      font-family: \"Helvetica\";\n      font-size:12px;\n      width:auto;\n      height:auto;\n      position:absolute;\n      text-align:center;\n      border-style:solid;\n      border-width:1px;\n      background-color: rgba(255,255,255,0.5);\n      border-radius: 2px;    \n    }\n  </style>\n</head>\n\n<body>\n  <div id=\"map\"></div>\n  <script>\n    var mapCenter = [-0.1,51.5119112], mapZoom = 13.5;\n//mapboxgl.accessToken = '<your access token here>';\n    var map = new mapboxgl.Map({\n      container: 'map',\n      style: 'mapbox://styles/mapbox/light-v9',\n      center: mapCenter,\n      zoom: mapZoom,\n    })\n    map.addControl(new mapboxgl.NavigationControl());\n\n    function mapboxProjection(lonlat) {\n      var p = map.project(new mapboxgl.LngLat(lonlat[0], lonlat[1]))\n      return [p.x, p.y];\n    }\n\n    var container = map.getCanvasContainer()\n    var svg = d3.select(container).append(\"svg\")  \n    var tooltipOffset = [-12, 24];\n    var tooltip = d3.select(\"body\")\n                     .append(\"div\")\n                     .attr(\"class\", \"tooltip\")\n\n    var url = \"http://enjalot.github.io/wwsd/data/UK/london_stations.topojson\";\n    d3.json(url, function(err, data) {\n      var points = topojson.feature(data, data.objects.london_stations)\n      var dots = svg.selectAll(\"circle.dot\").data(points.features)\n      var defaultFillColor = \"#0082a3\";\n\n      dots.enter().append(\"circle\").classed(\"dot\", true)\n      .attr(\"r\", 1)\n      .style({\n        fill: defaultFillColor,\n        \"fill-opacity\": 0.6,\n        stroke: \"#004d60\",\n        \"stroke-width\": 1\n      })\n      .transition().duration(1400)\n      .attr(\"r\", 8)\n\n      function render() {\n        dots\n          .each(function(d) {d.geometry.proj = mapboxProjection(d.geometry.coordinates);})\n          .attr(\"transform\", function(d) { return \"translate(\" + d.geometry.proj + \")\" })\n      }\n\n      dots\n      .on(\"mouseover\", function(d,i) {\n        d3.select(this).style({fill: \"#f04040\"});\n        tooltip\n          .html(d.properties.lines.map(function(x){return x.name}).join(', '))\n          .style(\"left\",(d.geometry.proj[0]+tooltipOffset[0])+\"px\")\n          .style(\"top\",(d.geometry.proj[1]-tooltipOffset[1])+\"px\")\n          .style(\"display\", \"inline\");\n      })\n      .on(\"mouseout\", function(d,i) {\n        d3.select(this).style({fill: defaultFillColor});\n        tooltip\n          .style(\"display\", \"none\");\n      })\n\n      map.on(\"viewreset\", function() {\n        render()\n      })\n      map.on(\"move\", function() {\n        render()\n      })\n\n      render()\n    })\n\n  </script>\n</body>\n\n\n\n\n\n\n\u306a\u304amap.queryRenderedFeatures(e.point, { layers: [layer_name] }) \u3092\u4f7f\u3046\u3084\u308a\u65b9\u306b\u3082\u5c11\u3057\u6311\u6226\u3057\u305f\u3051\u308c\u3069\u3001\u307e\u3060\u826f\u304f\u5206\u304b\u3063\u3066\u3044\u307e\u305b\u3093\u3002\u00a0\u21a9\n\n\n\n\u3053\u3093\u306b\u3061\u306f\u3002\n[Mapbox GL JS](https://www.mapbox.com/mapbox-gl-js/api/) + d3.js + svg \u30aa\u30fc\u30d0\u30ec\u30a4 + transition + topojson \u30c7\u30fc\u30bf\u8aad\u307f\u8fbc\u307f\u306e\u4f8b\u3092\u898b\u3064\u3051\u307e\u3057\u305f\u3002\n\n- [Ian Johnson\u2019s Block \n  WWSD #11: Mapbox-gl + d3 SVG overlay](https://bl.ocks.org/enjalot/0d87f32a1ccb9a720d29ba74142ba365)\n\n\u3053\u308c\u3092\u3001tilt/rotation \u5bfe\u5fdc\u3078\u5c0f\u4fee\u6b63\u3057\u3001\u52a0\u3048\u3066 tooltip/popup \u6a5f\u80fd\u3092\u624b\u52d5\u3067\u4f5c\u3063\u3066\u307f\u307e\u3057\u305f[^1]\u3002\n\n[^1]: \u306a\u304a```map.queryRenderedFeatures(e.point, { layers: [layer_name] })``` \u3092\u4f7f\u3046\u3084\u308a\u65b9\u306b\u3082\u5c11\u3057\u6311\u6226\u3057\u305f\u3051\u308c\u3069\u3001\u307e\u3060\u826f\u304f\u5206\u304b\u3063\u3066\u3044\u307e\u305b\u3093\u3002\n\n<img width=\"486\" alt=\"mapboxgl.jpg\" src=\"https://qiita-image-store.s3.amazonaws.com/0/54617/4d4b3e3b-36b6-9651-7aa2-b11d53d001ed.jpeg\">\n\n```mapboxgl_d3_svg.html\n<!DOCTYPE html>\n<head>\n  <meta charset=\"utf-8\">\n  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />\n  <script src=\"http://d3js.org/topojson.v1.min.js\"></script>\n  <script src=\"http://d3js.org/d3.v3.min.js\"></script>\n  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.29.0/mapbox-gl.js'></script>\n  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.29.0/mapbox-gl.css' rel='stylesheet' />\n  <style>\n    body { margin:0;position:fixed;top:0;right:0;bottom:0;left:0; }\n    #map { \n      position:absolute; \n      width: 100%;\n      height: 100%;\n    }\n    svg {\n      position: absolute;\n      width: 100%;\n      height: 100%;\n    }\n    .tooltip {\n      font-family: \"Helvetica\";\n      font-size:12px;\n      width:auto;\n      height:auto;\n      position:absolute;\n      text-align:center;\n      border-style:solid;\n      border-width:1px;\n      background-color: rgba(255,255,255,0.5);\n      border-radius: 2px;    \n    }\n  </style>\n</head>\n\n<body>\n  <div id=\"map\"></div>\n  <script>\n    var mapCenter = [-0.1,51.5119112], mapZoom = 13.5;\n//mapboxgl.accessToken = '<your access token here>';\n    var map = new mapboxgl.Map({\n      container: 'map',\n      style: 'mapbox://styles/mapbox/light-v9',\n      center: mapCenter,\n      zoom: mapZoom,\n    })\n    map.addControl(new mapboxgl.NavigationControl());\n\n    function mapboxProjection(lonlat) {\n      var p = map.project(new mapboxgl.LngLat(lonlat[0], lonlat[1]))\n      return [p.x, p.y];\n    }\n\n    var container = map.getCanvasContainer()\n    var svg = d3.select(container).append(\"svg\")  \n    var tooltipOffset = [-12, 24];\n    var tooltip = d3.select(\"body\")\n                     .append(\"div\")\n                     .attr(\"class\", \"tooltip\")\n\n    var url = \"http://enjalot.github.io/wwsd/data/UK/london_stations.topojson\";\n    d3.json(url, function(err, data) {\n      var points = topojson.feature(data, data.objects.london_stations)\n      var dots = svg.selectAll(\"circle.dot\").data(points.features)\n      var defaultFillColor = \"#0082a3\";\n      \n      dots.enter().append(\"circle\").classed(\"dot\", true)\n      .attr(\"r\", 1)\n      .style({\n        fill: defaultFillColor,\n        \"fill-opacity\": 0.6,\n        stroke: \"#004d60\",\n        \"stroke-width\": 1\n      })\n      .transition().duration(1400)\n      .attr(\"r\", 8)\n\n      function render() {\n        dots\n          .each(function(d) {d.geometry.proj = mapboxProjection(d.geometry.coordinates);})\n          .attr(\"transform\", function(d) { return \"translate(\" + d.geometry.proj + \")\" })\n      }\n\n      dots\n      .on(\"mouseover\", function(d,i) {\n        d3.select(this).style({fill: \"#f04040\"});\n        tooltip\n          .html(d.properties.lines.map(function(x){return x.name}).join(', '))\n          .style(\"left\",(d.geometry.proj[0]+tooltipOffset[0])+\"px\")\n          .style(\"top\",(d.geometry.proj[1]-tooltipOffset[1])+\"px\")\n          .style(\"display\", \"inline\");\n      })\n      .on(\"mouseout\", function(d,i) {\n        d3.select(this).style({fill: defaultFillColor});\n        tooltip\n          .style(\"display\", \"none\");\n      })\n\n      map.on(\"viewreset\", function() {\n        render()\n      })\n      map.on(\"move\", function() {\n        render()\n      })\n\n      render()\n    })\n\n  </script>\n</body>\n```\n", "tags": ["JavaScript", "d3.js", "GIS", "mapbox"]}