{"context": "\n\nSecure Boot \u306b\u3064\u3044\u3066\nSecure Boot \u3068\u306fOS \u8d77\u52d5\u6642\u306b\u305d\u306e\u30ed\u30fc\u30c0\u30fc\u304c\u30de\u30b7\u30f3(\u30d5\u30a1\u30fc\u30e0\u30a6\u30a7\u30a2)\u306b\u3068\u3063\u3066\u4fe1\u983c\u306e\u3042\u308b\u7f72\u540d\u304c\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u306e\u307f\u30ed\u30fc\u30c0\u30fc\u3092\u5b9f\u884c\u3057\u3001\u4fe1\u983c\u51fa\u6765\u306a\u3044\u4e0d\u6b63\u306a\u30ed\u30fc\u30c0\u30fc\u306f\u5b9f\u884c\u306f\u3055\u308c\u306a\u3044\u3088\u3046\u306b\u3059\u308b\u6a5f\u80fd\u306e\u3053\u3068\u3067\u3059\u3002\n\u3053\u306e\u6a5f\u80fd\u3092\u4f7f\u7528\u3059\u308b\u3053\u3068\u306b\u3088\u308a\u3001\u77e5\u3089\u306a\u3044\u3046\u3061\u306b\u3042\u306a\u305f\u304c\u4f7f\u7528\u3057\u3066\u3044\u308bPC \u306eUSB \u3084HDD\u3001SSD \u306b\u60aa\u610f\u306e\u3042\u308bOS \u30a4\u30e1\u30fc\u30b8\u304c\u5165\u3063\u305f\u3082\u306e\u304c\u88c5\u7740\u3055\u308c\u3066\u3044\u305f\u5834\u5408\u306b\u305d\u308c\u3092\u8d77\u52d5\u3057\u3066\u3057\u307e\u3046\u306e\u3092\u9632\u3044\u3060\u308a\u3001\u524d\u56deOS \u8d77\u52d5\u6642\u306b\u30ed\u30fc\u30c0\u304c\u66f8\u304d\u63db\u3048\u3089\u308c\u3066\u60aa\u610f\u306e\u3042\u308b\u30a4\u30e1\u30fc\u30b8\u3092\u8d77\u52d5\u3055\u305b\u3088\u3046\u3068\u3057\u305f\u653b\u6483\u306b\u5bfe\u51e6\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u4eca\u56de\u306fSecure Boot \u3092\u5c0e\u5165\u3059\u308b\u306b\u3042\u305f\u3063\u3066\u3001Think Pad T460s \u3092\u4f7f\u7528\u3057\u307e\u3057\u305f\u3002\n\nBoot \u6642\u306e\u6982\u7565\u56f3\nSecure Boot \u306f\u4ee5\u4e0b\u306e\u30b3\u30f3\u30dd\u30fc\u30cd\u30f3\u30c8\u304b\u3089\u69cb\u6210\u3055\u308c\u307e\u3059\u3002\n\n\nSecure boot \u3092\u69cb\u6210\u3059\u308b\u79d8\u5bc6\u9375\u4e00\u89a7\n\n\n \u79d8\u5bc6\u9375\n \u5f79\u5272\n\n\n Platform Key (PK)\n db \u3068dbx \u3092\u7de8\u96c6\u3059\u308b\u305f\u3081\u306e\u9375\u3002\u4e00\u822c\u7684\u306b\u306f\u30cf\u30fc\u30c9\u30a6\u30a7\u30a2\u30d9\u30f3\u30c0\u304b\u3089\u63d0\u4f9b(OEM)\u3055\u308c\u308b\u3002\n\n\n Key Exchange Key (KEK)\n PK \u3068KEK \u3092\u7de8\u96c6\u3059\u308b\u305f\u3081\u306e\u9375\u3002\n\n\n Authorized DB (db)\n \u4fe1\u983c\u306e\u304a\u3051\u308bbootloader \u306e\u691c\u8a3c\u3092\u884c\u3046\u305f\u3081\u306e\u8a3c\u660e\u66f8\u3068\u30cf\u30c3\u30b7\u30e5\u5024\u3002\u8907\u6570\u3082\u3042\u308a\u3046\u308b\u3002\u4f8b\u3048\u3070Microsoft Windows Production CA \u306a\u3069\u3002\n\n\n Unauthorized DB (dbx)\n \u4e0d\u9069\u5207\u306abootloader \u3092\u691c\u8a3c\u3059\u308b\u305f\u3081\u306e\u8a3c\u660e\u66f8\u3068\u30cf\u30c3\u30b7\u30e5\u3002\u8907\u6570\u3082\u3042\u308a\u3046\u308b\u3002\u4e00\u822c\u7684\u306b\u547c\u3070\u308c\u308bCertificate Revocation List(CRL) \u3068\u4f3c\u305f\u3082\u306e\u3002\n\n\n\n\nSecure boot \u304cbootloader \u3092\u691c\u8a3c\u3057\u3066\u5b89\u5168\u306bOS \u3092\u8d77\u52d5\u3059\u308b\u307e\u3067\u306e\u51e6\u7406\u30b7\u30fc\u30b1\u30f3\u30b9\u306f\u6b21\u306e\u3088\u3046\u306b\u56f3\u793a\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u4e0b\u56f3\u306eboot \u30b7\u30fc\u30b1\u30f3\u30b9\u306f\u65e2\u306bPK \u3092\u4f7f\u7528\u3057\u3066db \u53ca\u3073dbx \u306e\u8a2d\u5b9a\u304c\u5b8c\u4e86\u3057\u3066\u3044\u308b\u3053\u3068\u304c\u524d\u63d0\u306b\u306a\u308a\u307e\u3059\u3002\n\n\nTrying out UEFI boot security on a recent Linux system\n\n\nhttp://www.linux-magazine.com/index.php/layout/set/print/Issues/2014/164/The-State-of-Secure-Boot/(tagID)/154\n\n\n\n\nshim\nshim \u306f\u81ea\u5df1CA \u8a3c\u660e\u66f8\u3092\u683c\u7d0d\u3057\u305ffirst stage boot loader \u3067\u3067\u3001GRUB 2 \u3084ELILO \u306a\u3069\u306eboot loader \u3092\u30ed\u30fc\u30c9\u3059\u308b\u3053\u3068\u304c\u5f79\u5272\u3067\u3059(\u4eca\u56de\u306fGRUB 2 \u3092\u4f7f\u7528\u3057\u307e\u3059\u306e\u3067\u3001GRUB 2 \u306b\u3064\u3044\u3066\u306e\u307f\u8a18\u8ff0\u3057\u307e\u3059)\u3002\n\u3053\u306eCA \u8a3c\u660e\u66f8\u306fGRUB 2 boot loader \u306e\u7f72\u540d\u3092\u691c\u8a3c\u3059\u308b\u305f\u3081\u306b\u4f7f\u7528\u3055\u308c\u307e\u3059\u3002\n\u305d\u3057\u3066GRUB 2 \u306f\u5f8c\u307b\u3069kernel \u306e\u7f72\u540d\u3092\u691c\u8a3c\u3059\u308b\u305f\u3081\u306bshim \u306e\u51e6\u7406\u3092call back \u3057\u307e\u3059\u3002\nTODO: \u4eca\u56de\u5b9f\u65bd\u3057\u305fArch Linux \u3067Secure boot \u3092\u5b9f\u73fe\u3059\u308b\u65b9\u6cd5\u3067\u306f\u3001shim \u3092\u4f7f\u7528\u3057\u3066\u3044\u308b\u306e\u304b\u5426\u304b\u3001\u3082\u3057\u304f\u306f\u4ed6\u306epreloader \u3092 \u4f7f\u3063\u3066\u3044\u308b\u306e\u304b\u3069\u3046\u304b\u78ba\u8a8d\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u3002\u60c5\u5831\u6c42\u3080...\u3002\n\nSecure boot \u74b0\u5883\u69cb\u7bc9\nsecure boot \u306e\u6982\u8981\u3092\u8aac\u660e\u3057\u305f\u306e\u3067\u3001\u3053\u3053\u304b\u3089\u306fArch Linux \u3067secure boot \u3092\u884c\u3046\u305f\u3081\u306e\u624b\u9806\u3092\u8aac\u660e\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nsecure boot \u3092\u5b9f\u73fe\u3059\u308b\u305f\u3081\u306bArch Linux \u3067\u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\n\u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n# pacman -S sbsigntools\n# pacman -S openssl\n\n\n\n\u7f72\u540d\u7528\u306e\u9375\u306e\u4f5c\u6210\nopenssl \u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u7528\u3057\u3066PK, KEK, db \u306b\u7f72\u540d\u3092\u884c\u3046\u305f\u3081\u306e\u9375\u3092\u751f\u6210\u3057\u307e\u3059\u3002\n\nopenssl(RSA)\n# openssl genrsa -out my-arch-linux.key 2048\n# openssl req -new -x509 -sha256 -subj '/CN=my-arch-linux' -key my-arch-linux.key -out my-arch-linux.pem\n# openssl x509 -in my-arch-linux.pem -inform PEM -out my-arch-linux.der -outform DER\n\n\nuuidgen \u3092\u4f7f\u7528\u3057\u3066\u9375\u306e\u6240\u6709\u8005\u3092\u8868\u3059\u305f\u3081\u306eGUID \u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n# guid=$(uuidgen)\n# echo $guid\n\n\u6b21\u306bEFI_SIGNATURE_LIST (\u7f72\u540d\u30ea\u30b9\u30c8)\u3092\u4f5c\u6210\u3057\u3066\u3044\u304d\u307e\u3057\u3087\u3046\u3002\n\u3053\u3053\u3067\u767b\u9332\u3055\u308c\u308bmy-arch-linux.der \u306e\u7f72\u540d\u306f\u81ea\u5df1\u7f72\u540d\u3068\u306a\u308a\u307e\u3059\u3002\n# sbsiglist --owner $guid --type x509 --output my-arch-linux.der.siglist my-arch-linux.der\n\nsbvarsign \u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u7528\u3057\u3066\u5404\u9375\u60c5\u5831\u3001\u5909\u6570\u3068\u305d\u306e\u5024\u306b\u5bfe\u3057\u3066\u7f72\u540d\u3092\u884c\u3063\u3066\u3044\u304d\u307e\u3059\u3002\n\nPKKEKdb\u306esignedupdate\u3092\u4f5c\u6210\u3059\u308b\nfor n in PK KEK db\ndo\n    sbvarsign --key my-arch-linux.key --cert my-arch-linux.pem --output my-arch-linux.der.siglist.$n.signed $n my-arch-linux.der.siglist\ndone\n\n\n\u6b21\u306bkeystore \u3092\u4f5c\u6210\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n# mkdir -p /etc/secureboot/keys/{PK,KEK,db,dbx}\n# cp *.PK.signed /etc/secureboot/keys/PK/\n# cp *.KEK.signed /etc/secureboot/keys/KEK/\n# cp *.db.signed /etc/secureboot/keys/db/\n\nsbkeysync \u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u7528\u3057\u3066firmware \u306e\u9375\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3068\u60c5\u5831\u3092\u540c\u671f\u3055\u305b\u307e\u3059\u3002\n\u4e0a\u8a18\u3067/etc/secureboot/keys \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u914d\u4e0b\u306b\u9375\u3092\u4f5c\u6210\u3057\u307e\u3057\u305f\u304c\u3001\u3053\u308c\u4ee5\u5916\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f7f\u7528\u3057\u305f\u3044\u5834\u5408\u306fsbkeysync \u30b3\u30de\u30f3\u30c9\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u306b--keystore and/or --no-default-keystores \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u52a0\u3048\u3066\u5b9f\u884c\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u307e\u305a\u306f--dry-run \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u4ed8\u3051\u3066\u3001\u30c6\u30b9\u30c8\u30e2\u30fc\u30c9\u3067\u5b9f\u884c\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\nsbkeysync(dry-run)\n# sbkeysync --verbose --pk --dry-run\n\n\n\u7d50\u679c\u306b\u554f\u984c\u7121\u3044\u3088\u3046\u3067\u3042\u308c\u3070\u3001\u4eca\u5ea6\u306f--dry-run \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u5916\u3057\u3066\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u307e\u3059(firemware \u4e0a\u306e\u9375DB \u304c\u66f4\u65b0\u3055\u308c\u307e \u3059\u306e\u3067\u3001\u899a\u609f\u3092\u6c7a\u3081\u3066\u304f\u3060\u3055\u3044\u2026)\u3002\n\u3053\u3053\u3067\u6ce8\u610f\u3057\u3066\u3044\u305f\u3060\u304d\u305f\u3044\u306e\u306f\u3001firmware \u306b\u3088\u3063\u3066\u306f\u3053\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u3067\u3001\u81ea\u52d5\u7684\u306bset up \u30e2\u30fc\u30c9\u304b\u3089secure boot \u5f37\u5236\u30e2\u30fc\u30c9\u3078\u79fb\u884c\u3057\u3066\u3057\u307e\u3046\u3082\u306e\u304c\u3042\u308b\u305d\u3046\u3067\u3059\u3002\n\u305d\u306e\u305f\u3081\u3001\u3084\u3063\u3071\u308asecure boot \u3092off \u306b\u3057\u305f\u3044\u5834\u5408\u306e\u4fdd\u967a\u306e\u610f\u5473\u3082\u8fbc\u3081\u3066\u3001\u4e8b\u524d\u306b\u304a\u4f7f\u3044\u306e\u30b3\u30f3\u30d4\u30e5\u30fc\u30bf\u306efirmware \u306e\u8a2d\u5b9a\u753b\u9762\u304b\u3089secure boot \u3092OFF \u306b\u3059\u308b\u65b9\u6cd5\u3084PK \u3092\u524a\u9664\u3059\u308b\u65b9\u6cd5\u304c\u3042\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\n\nsbkeysync\n# sbkeysync --verbose --pk\n\n... \u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30a8\u30e9\u30fc\u304c\u51fa\u305f ...\nNew keys in filesystem:\n /etc/secureboot/keys/db/my-arch-linux.der.siglist.db.signed\n /etc/secureboot/keys/KEK/my-arch-linux.der.siglist.KEK.signed\n /etc/secureboot/keys/PK/my-arch-linux.der.siglist.PK.signed\nInserting key update /etc/secureboot/keys/db/my-arch-linux.der.siglist.db.signed into db\nCan't create key file /sys/firmware/efi/efivars/db-d719b2cb-3d3a-4596-a3bc-dad00e67656f: Permission denied\nError syncing keystore file /etc/secureboot/keys/db/my-arch-linux.der.siglist.db.signed\nInserting key update /etc/secureboot/keys/KEK/my-arch-linux.der.siglist.KEK.signed into KEK\nCan't create key file /sys/firmware/efi/efivars/KEK-8be4df61-93ca-11d2-aa0d-00e098032b8c: Permission denied\nError syncing keystore file /etc/secureboot/keys/KEK/my-arch-linux.der.siglist.KEK.signed\n\n\n--dry-run \u30e2\u30fc\u30c9\u3067\u6210\u529f\u3057\u3066\u3082\u5b9f\u969b\u306b\u540c\u671f\u3057\u3088\u3046\u3068\u3059\u308b\u3068\u5931\u6557\u3057\u307e\u3057\u305f\u3002\n\u539f\u56e0\u306fUEFI \u306esecure boot \u30e2\u30fc\u30c9\u304csetup \u30e2\u30fc\u30c9\u306b\u306a\u3063\u3066\u3044\u306a\u3044\u305f\u3081\u3067\u3057\u305f\u3002\n\u304a\u4f7f\u3044\u306e\u30de\u30b7\u30f3\u306b\u3088\u3063\u3066\u30a8\u30e9\u30fc\u306b\u306a\u3063\u305f\u308a\u3001\u306a\u3089\u306a\u304b\u3063\u305f\u308a\u306f\u7570\u306a\u3063\u3066\u304f\u308b\u3068\u601d\u3044\u307e\u3059\u306e\u3067\u3001\u6b21\u306e\u5bfe\u5fdc\u306f\u3042\u304f\u307e\u3067\u53c2\u8003\u7a0b\u5ea6\u306b\u3068\u3069 \u3081\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\nsecure boot \u30e2\u30fc\u30c9\u3092setup \u30e2\u30fc\u30c9\u3078\u5909\u66f4\u3059\u308b\u305f\u3081\u306b\u3001\u4e00\u65e6\u30de\u30b7\u30f3\u3092\u518d\u8d77\u52d5\u3057\u3001Lenovo \u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u753b\u9762\u30e1\u30cb\u30e5\u30fc\u304b\u3089\u8a2d\u5b9a\u3092\u5909\u66f4\u3057\u3001\u518d\u5ea6OS \u3092\u8d77\u52d5\u3055\u305b\u307e\u3059\u3002\n\nLenovo\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u753b\u9762\u304b\u3089...\nSecurity\n  -> Secure Boot\n    -> Reset to Setup Mode [Enter]\n    -> Clear All Secure Boot Keys [Enter]\n\n// \"Reset to Setup Mode\" \u3067Enter \u30ad\u30fc\u3092\u62bc\u3057\u3066Setup Mode \u3092\u30ea\u30bb\u30c3\u30c8\n// \u5ff5\u306e\u305f\u3081\"Clear All Secure Boot Keys\" \u3067\u3082Enter \u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u3066\u3059\u3079\u3066\u306e\u9375\u3092\u30ea\u30bb\u30c3\u30c8\n\n\n\nbootloader \u306b\u7f72\u540d\u3092\u884c\u3046\nbootloader \u306b\u7f72\u540d\u3092\u884c\u3044\u307e\u3059\u3002\n\u4eca\u56de\u306f\u30ce\u30fc\u30c8PC \u4e0a\u3067\u65e2\u306b\u8d77\u52d5\u3057\u3066\u3044\u308bArch Linux \u306ebootloader \u306b\u5bfe\u3057\u3066\u7f72\u540d\u3092\u884c\u3044\u307e\u3059\u3002\n\u5b9f\u969b\u3001\u91cd\u8981\u306aLinux \u30b7\u30b9\u30c6\u30e0\u3092\u60f3\u5b9a\u3057\u305fSecure Boot \u3092\u884c\u3046\u5834\u5408\u306f\u3001\u7f72\u540d\u3092\u884c\u3046bootloader(OS) \u3068\u9375\u3092\u7ba1\u7406\u3059\u308bOS \u306f\u5225\u306e\u7269\u3067\u3042 \u308b\u3053\u3068\u304c\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u4e0a\u306f\u597d\u307e\u3057\u3044\u3067\u304c\u3001\u4eca\u56de\u306f\u52d5\u4f5c\u78ba\u8a8d\u76ee\u7684\u306a\u306e\u3067\u3001\u305d\u306e\u3088\u3046\u306a\u3053\u3068\u306f\u6c17\u306b\u305b\u305a\u306b\u7f72\u540d\u3092\u884c\u3063\u3066\u3044\u304d\u307e\u3059\u3002\n\nbootloader\u306b\u7f72\u540d\u3092\u884c\u3046\n# sbsign --key my-arch-linux.key --cert my-arch-linux.pem --output grubx64.efi /boot/efi/EFI/arch/grubx64.efi\n# cp /boot/efi/EFI/arch/grubx64.efi{,.bak}\n# cp grubx64.efi /boot/efi/EFI/arch/\n\n\n\nSecure Boot \u30e2\u30fc\u30c9\u3067\u8d77\u52d5\u3059\u308b\nbootloader \u3078\u306e\u7f72\u540d\u3082\u5b8c\u4e86\u3057\u305f\u3089\u3001\u30de\u30b7\u30f3\u3092\u518d\u8d77\u52d5\u3057\u3001\u30cf\u30fc\u30c9\u30a6\u30a7\u30a2\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u753b\u9762\u304b\u3089Secure Boot \u30e2\u30fc\u30c9\u304cON \u306b\u306a\u3063\u3066 \u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\u4f8b\n// Lenovo \u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u753b\u9762\u304b\u3089...\nSecurity\n  -> Secure Boot\n    -> Secure Boot [Enabled]\n\n\nSecure Boot \u30e2\u30fc\u30c9\u304cON \u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u305f\u3089\u3001\u305d\u306e\u307e\u307eOS \u306eboot \u30d7\u30ed\u30bb\u30b9\u3078\u9032\u307f\u3001\u6b63\u5e38\u306bLinux \u304c\u8d77\u52d5\u3067\u304d\u308c\u3070\u6210\u529f\u3067\u3059\u3002\n\u6b63\u3057\u304fSecure Boot \u30e2\u30fc\u30c9\u3067Linux \u304c\u8d77\u52d5\u3057\u3066\u3044\u308b\u304b\u3069\u3046\u304b\u3092\u78ba\u8a8d\u3057\u305f\u3044\u5834\u5408\u306f\u3001USB \u30e1\u30e2\u30ea\u306b\u4ed6\u306eLinux \u30a4\u30e1\u30fc\u30b8\u3092\u5165\u308c\u3066USB  \u304b\u3089\u8d77\u52d5\u3055\u305b\u3066\u307f\u3066\u304f\u3060\u3055\u3044\u3002\n\u305d\u306e\u6642\u306bUSB \u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u7f72\u540d\u304c\u884c\u308f\u308c\u3066\u3044\u306a\u3044\u3001\u3082\u3057\u304f\u306f\u7f72\u540d\u691c\u8a3c\u306b\u30d1\u30b9\u3067\u304d\u305a\u306b\u8d77\u52d5\u306b\u5931\u6557\u3059\u308c\u3070\u3001Secure Boot \u306e\u52d5 \u4f5c\u3068\u3057\u3066\u6b63\u5e38\u306b\u904b\u8ee2\u3057\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\n\nsetup \u30e2\u30fc\u30c9(\u3082\u3057\u304f\u306fSecure Boot \u30e2\u30fc\u30c9OFF)\u3078\u5207\u308a\u623b\u3057\u3059\u308b\nSecure Boot \u30e2\u30fc\u30c9\u3092\u30ea\u30bb\u30c3\u30c8\u3057\u305f\u3044\u3001\u3082\u3057\u304f\u306fSecure Boot \u30e2\u30fc\u30c9\u3092\u7121\u52b9\u306b\u3057\u305f\u3044\u5834\u5408\u306f\u4ee5\u4e0b\u306e\u624b\u9806\u3092\u5b9f\u65bd\u3057\u307e\u3059\u3002\n\n\u65b9\u6cd51: \u30cf\u30fc\u30c9\u30a6\u30a7\u30a2\u30d9\u30f3\u30c0\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u753b\u9762\u304b\u3089Secure Boot \u30e2\u30fc\u30c9\u3092OFF \u306b\u3059\u308b\n\u4eca\u56de\u691c\u8a3c\u306b\u4f7f\u7528\u3057\u305fLenovo T460s \u306e\u3088\u3046\u306b\u3001\u30cf\u30fc\u30c9\u30a6\u30a7\u30a2\u5074\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u753b\u9762\u306bSecure Boot \u3092\u8a2d\u5b9a\u3059\u308b\u30e1\u30cb\u30e5\u30fc\u304c\u3042\u308b\u5834\u5408\u306f\u3001\u305d\u3061\u3089\u304b\u3089OFF \u306b\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n\u4f8b\n// Lenovo \u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u753b\u9762\u304b\u3089...\nSecurity\n  -> Secure Boot\n    -> Reset to Setup Mode [Enter]   // Enter \u3092\u62bc\u4e0b\u3059\u308b\n    -> Clear All Secure Boot Keys [Enter] // Enter \u3092\u62bc\u4e0b\u3059\u308b\n\n\n\u66f4\u306bSecure Boot \u30e2\u30fc\u30c9\u3092OFF \u306b\u3057\u305f\u3044\u5834\u5408\u306f\"Secure Boot\" \u3082Disabled \u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n\u4f8b\n// Lenovo \u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u753b\u9762\u304b\u3089...\nSecurity\n  -> Secure Boot\n    -> Secure Boot [Disabled]\n\n\n\n\u65b9\u6cd52: \u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u304b\u3089firmware \u4e0a\u306e\u30e1\u30e2\u30ea\u3092\u66f8\u304d\u63db\u3048\u308b\n(\u3053\u306e\u65b9\u6cd5\u3092\u5b9f\u65bd\u3057\u3066\u3082\u623b\u3089\u306a\u3044firmware \u304c\u3042\u308b\u3088\u3046\u3067\u3059\u3002\u5b9f\u884c\u306f\u81ea\u5df1\u8cac\u4efb\u3067\u304a\u306d\u304c\u3044\u3057\u307e\u3059...)\n\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u304b\u3089setup \u30e2\u30fc\u30c9\u3078\u5207\u308a\u623b\u3057\u3092\u3057\u305f\u3044\u5834\u5408\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u624b\u9806\u3067\u7a7a\u3063\u307d\u306ePK \u3092\u4e0a\u66f8\u304d\u3057\u3066\u3042\u3052\u308b\u3053\u3068\u3067\u884c\u3046\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n# : > empty\n# sbvarsign --key my-arch-linux.key --cert my-arch-linux.pem --attrs NON_VOLATILE,BOOTSERVICE_ACCESS,RUNTIME_ACCESS --include-attrs --output empty.PK.signed PK empty\n# dd bs=4K if=empty.PK.signed of=/sys/firmware/efi/efivars/PK-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\n(xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx \u306f\u4f7f\u3063\u3066\u3044\u308b\u74b0\u5883\u3054\u3068\u306b\u7570\u306a\u308b)\n\n\n\u5099\u5fd8\u9332: \u7f72\u540dECDSA \u79d8\u5bc6\u9375\u3067\u4f5c\u6210\u3059\u308b\u5834\u5408\n\u6700\u5f8c\u306b...\u672c\u624b\u9806\u306f\u4ee5\u4e0a\u3067\u7d42\u4e86\u3067\u3059\u304c\u3001ECDSA \u3067\u3082\u7f72\u540d\u304c\u884c\u3046\u3053\u3068\u304c\u3067\u304d\u308b\u304b\u3069\u3046\u304b\u306b\u3064\u3044\u3066\u30c6\u30b9\u30c8\u3092\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\u7d50\u679c\u304b\u3089\u5148\u306b\u3044\u3046\u3068\u3001\u4eca\u56de\u81ea\u5206\u304c\u4f7f\u7528\u3057\u305f\u30cf\u30fc\u30c9\u30a6\u30a7\u30a2\u3067\u306f\u3001ECDSA \u306a\u79d8\u5bc6\u9375\u3092\u4f7f\u3063\u305f\u65b9\u6cd5\u306f\u5b9f\u65bd\u4e0d\u80fd\u3067\u3057\u305f\u3002\n\u5099\u5fd8\u9332\u30022016/08 \u73fe\u5728\u3001ECDSA \u306b\u3066\u767b\u9332\u3057\u3088\u3046\u3068\u3057\u3066\u3082\u3001firmware \u3068\u60c5\u5831\u306e\u540c\u671f\u3092\u884c\u3046\u3068\u304d\u306b\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u3066\u767b\u9332\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u305b\u3093\u3002\n\u304a\u4f7f\u3044\u306e\u30cf\u30fc\u30c9\u30a6\u30a7\u30a2\u74b0\u5883\u306b\u3088\u3063\u3066\u3082\u5909\u308f\u3063\u3066\u304f\u308b\u53ef\u80fd\u6027\u304c\u3042\u308b\u305f\u3081\u3001\u3042\u304f\u307e\u3067\u53c2\u8003\u7a0b\u5ea6\u306b\u3057\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\n\nopenssl(ECDSA)\n# openssl ecparam -list_curves\n...\nsecp521r1\n...\n\n# openssl ecparam -out my-arch-linux.key -name secp521r1 -genkey\n# openssl ecparam -out my-arch-linux.key -name prime256v1 -genkey\n# openssl ecparam -out my-arch-linux.key -name secp384r1 -genkey\n\n# openssl req -new -x509 -sha256 -subj '/CN=my-arch-linux' -key my-arch-linux.key -out my-arch-linux.pem\n# openssl x509 -in my-arch-linux.pem -inform PEM -out my-arch-linux.der -outform DER\n\n\n\u6955\u5186\u66f2\u7dda\u3068\u3057\u3066\u30e1\u30b8\u30e3\u30fc\u3069\u3053\u308d\u3067\u3042\u308bprime256v1, secp384r1, secp521r1 \u3042\u305f\u308a\u3092\u8a66\u3057\u3066\u307f\u305f\u304c\u3069\u308c\u3082\u30c0\u30e1\u3002\n\nprime256v1,secp384r1,secp521r1\nInserting key update /etc/secureboot/keys/db/my-arch-linux.der.siglist.db.signed into db\nError writing key update: Invalid argument\nError syncing keystore file /etc/secureboot/keys/db/my-arch-linux.der.siglist.db.signed\nInserting key update /etc/secureboot/keys/KEK/my-arch-linux.der.siglist.KEK.signed into KEK\nError writing key update: Invalid argument\nError syncing keystore file /etc/secureboot/keys/KEK/my-arch-linux.der.siglist.KEK.signed\n\n\n\n\u53c2\u8003\n\n\nShim\n\nhttps://docs.fedoraproject.org/en-US/Fedora/18/html/UEFI_Secure_Boot_Guide/sect-UEFI_Secure_Boot_Guide-Implementation_of_UEFI_Secure_Boot-Shim.html\n\n\n\nSecure Boot \u53c2\u8003\n\nhttps://wiki.ubuntu.com/SecurityTeam/SecureBoot\nhttp://jk.ozlabs.org/docs/sbkeysync-maintaing-uefi-key-databases/\n\n\n\n\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306b\u3064\u5165\u308c\u306f\u4ee5\u4e0b\u306e\u30da\u30fc\u30b8\u304c\u53c2\u8003\u306b\u306a\u308b\n\nhttp://www.linux-magazine.com/Issues/2014/164/The-State-of-Secure-Boot\n\n\n\nopenssl \u306a\u3069\u304c\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u3044\u308b\u6955\u5186\u66f2\u7dda\u306b\u3064\u3044\u3066\n\nhttps://en.wikipedia.org/wiki/Comparison_of_TLS_implementations#Supported_elliptic_curves\n\n\n\nWhich elliptic curve should I use?\n\nhttp://security.stackexchange.com/questions/78621/which-elliptic-curve-should-i-use\n\n\n\n# Secure Boot \u306b\u3064\u3044\u3066\nSecure Boot \u3068\u306fOS \u8d77\u52d5\u6642\u306b\u305d\u306e\u30ed\u30fc\u30c0\u30fc\u304c\u30de\u30b7\u30f3(\u30d5\u30a1\u30fc\u30e0\u30a6\u30a7\u30a2)\u306b\u3068\u3063\u3066\u4fe1\u983c\u306e\u3042\u308b\u7f72\u540d\u304c\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u306e\u307f\u30ed\u30fc\u30c0\u30fc\u3092\u5b9f\u884c\u3057\u3001\u4fe1\u983c\u51fa\u6765\u306a\u3044\u4e0d\u6b63\u306a\u30ed\u30fc\u30c0\u30fc\u306f\u5b9f\u884c\u306f\u3055\u308c\u306a\u3044\u3088\u3046\u306b\u3059\u308b\u6a5f\u80fd\u306e\u3053\u3068\u3067\u3059\u3002\n\u3053\u306e\u6a5f\u80fd\u3092\u4f7f\u7528\u3059\u308b\u3053\u3068\u306b\u3088\u308a\u3001\u77e5\u3089\u306a\u3044\u3046\u3061\u306b\u3042\u306a\u305f\u304c\u4f7f\u7528\u3057\u3066\u3044\u308bPC \u306eUSB \u3084HDD\u3001SSD \u306b\u60aa\u610f\u306e\u3042\u308bOS \u30a4\u30e1\u30fc\u30b8\u304c\u5165\u3063\u305f\u3082\u306e\u304c\u88c5\u7740\u3055\u308c\u3066\u3044\u305f\u5834\u5408\u306b\u305d\u308c\u3092\u8d77\u52d5\u3057\u3066\u3057\u307e\u3046\u306e\u3092\u9632\u3044\u3060\u308a\u3001\u524d\u56deOS \u8d77\u52d5\u6642\u306b\u30ed\u30fc\u30c0\u304c\u66f8\u304d\u63db\u3048\u3089\u308c\u3066\u60aa\u610f\u306e\u3042\u308b\u30a4\u30e1\u30fc\u30b8\u3092\u8d77\u52d5\u3055\u305b\u3088\u3046\u3068\u3057\u305f\u653b\u6483\u306b\u5bfe\u51e6\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n\u4eca\u56de\u306fSecure Boot \u3092\u5c0e\u5165\u3059\u308b\u306b\u3042\u305f\u3063\u3066\u3001Think Pad T460s \u3092\u4f7f\u7528\u3057\u307e\u3057\u305f\u3002\n\n# Boot \u6642\u306e\u6982\u7565\u56f3\nSecure Boot \u306f\u4ee5\u4e0b\u306e\u30b3\u30f3\u30dd\u30fc\u30cd\u30f3\u30c8\u304b\u3089\u69cb\u6210\u3055\u308c\u307e\u3059\u3002\n![Linux_SecureBoot0001.png](https://qiita-image-store.s3.amazonaws.com/0/70152/a10b5a68-6956-725f-8f3b-5a69940f3a35.png)\n\n\n* Secure boot \u3092\u69cb\u6210\u3059\u308b\u79d8\u5bc6\u9375\u4e00\u89a7\n<table><tbody>\n  <tr>\n    <th> \u79d8\u5bc6\u9375</th>\n    <th> \u5f79\u5272</th>\n  </tr>\n  <tr>\n    <td> Platform Key (PK)</td>\n    <td> db \u3068dbx \u3092\u7de8\u96c6\u3059\u308b\u305f\u3081\u306e\u9375\u3002\u4e00\u822c\u7684\u306b\u306f\u30cf\u30fc\u30c9\u30a6\u30a7\u30a2\u30d9\u30f3\u30c0\u304b\u3089\u63d0\u4f9b(OEM)\u3055\u308c\u308b\u3002</td>\n  </tr>\n  <tr>\n    <td> Key Exchange Key (KEK)</td>\n    <td> PK \u3068KEK \u3092\u7de8\u96c6\u3059\u308b\u305f\u3081\u306e\u9375\u3002</td>\n  </tr>\n  <tr>\n    <td> Authorized DB (db)</td>\n    <td> \u4fe1\u983c\u306e\u304a\u3051\u308bbootloader \u306e\u691c\u8a3c\u3092\u884c\u3046\u305f\u3081\u306e\u8a3c\u660e\u66f8\u3068\u30cf\u30c3\u30b7\u30e5\u5024\u3002\u8907\u6570\u3082\u3042\u308a\u3046\u308b\u3002\u4f8b\u3048\u3070Microsoft Windows Production CA \u306a\u3069\u3002</td>\n  </tr>\n  <tr>\n    <td> Unauthorized DB (dbx)</td>\n    <td> \u4e0d\u9069\u5207\u306abootloader \u3092\u691c\u8a3c\u3059\u308b\u305f\u3081\u306e\u8a3c\u660e\u66f8\u3068\u30cf\u30c3\u30b7\u30e5\u3002\u8907\u6570\u3082\u3042\u308a\u3046\u308b\u3002\u4e00\u822c\u7684\u306b\u547c\u3070\u308c\u308bCertificate Revocation List(CRL) \u3068\u4f3c\u305f\u3082\u306e\u3002</td>\n  </tr>\n</tbody></table>\n\nSecure boot \u304cbootloader \u3092\u691c\u8a3c\u3057\u3066\u5b89\u5168\u306bOS \u3092\u8d77\u52d5\u3059\u308b\u307e\u3067\u306e\u51e6\u7406\u30b7\u30fc\u30b1\u30f3\u30b9\u306f\u6b21\u306e\u3088\u3046\u306b\u56f3\u793a\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u4e0b\u56f3\u306eboot \u30b7\u30fc\u30b1\u30f3\u30b9\u306f\u65e2\u306bPK \u3092\u4f7f\u7528\u3057\u3066db \u53ca\u3073dbx \u306e\u8a2d\u5b9a\u304c\u5b8c\u4e86\u3057\u3066\u3044\u308b\u3053\u3068\u304c\u524d\u63d0\u306b\u306a\u308a\u307e\u3059\u3002\n![Linux_SecureBoot0000.png](https://qiita-image-store.s3.amazonaws.com/0/70152/73ff4b93-f017-e5e5-3ce4-b96bd259cb52.png)\n\n- Trying out UEFI boot security on a recent Linux system\n    - http://www.linux-magazine.com/index.php/layout/set/print/Issues/2014/164/The-State-of-Secure-Boot/(tagID)/154\n\n## shim\nshim \u306f\u81ea\u5df1CA \u8a3c\u660e\u66f8\u3092\u683c\u7d0d\u3057\u305ffirst stage boot loader \u3067\u3067\u3001GRUB 2 \u3084ELILO \u306a\u3069\u306eboot loader \u3092\u30ed\u30fc\u30c9\u3059\u308b\u3053\u3068\u304c\u5f79\u5272\u3067\u3059(\u4eca\u56de\u306fGRUB 2 \u3092\u4f7f\u7528\u3057\u307e\u3059\u306e\u3067\u3001GRUB 2 \u306b\u3064\u3044\u3066\u306e\u307f\u8a18\u8ff0\u3057\u307e\u3059)\u3002\n\u3053\u306eCA \u8a3c\u660e\u66f8\u306fGRUB 2 boot loader \u306e\u7f72\u540d\u3092\u691c\u8a3c\u3059\u308b\u305f\u3081\u306b\u4f7f\u7528\u3055\u308c\u307e\u3059\u3002\n\u305d\u3057\u3066GRUB 2 \u306f\u5f8c\u307b\u3069kernel \u306e\u7f72\u540d\u3092\u691c\u8a3c\u3059\u308b\u305f\u3081\u306bshim \u306e\u51e6\u7406\u3092call back \u3057\u307e\u3059\u3002\n\nTODO: \u4eca\u56de\u5b9f\u65bd\u3057\u305fArch Linux \u3067Secure boot \u3092\u5b9f\u73fe\u3059\u308b\u65b9\u6cd5\u3067\u306f\u3001shim \u3092\u4f7f\u7528\u3057\u3066\u3044\u308b\u306e\u304b\u5426\u304b\u3001\u3082\u3057\u304f\u306f\u4ed6\u306epreloader \u3092 \u4f7f\u3063\u3066\u3044\u308b\u306e\u304b\u3069\u3046\u304b\u78ba\u8a8d\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u3002\u60c5\u5831\u6c42\u3080...\u3002\n\n# Secure boot \u74b0\u5883\u69cb\u7bc9\nsecure boot \u306e\u6982\u8981\u3092\u8aac\u660e\u3057\u305f\u306e\u3067\u3001\u3053\u3053\u304b\u3089\u306fArch Linux \u3067secure boot \u3092\u884c\u3046\u305f\u3081\u306e\u624b\u9806\u3092\u8aac\u660e\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n## \u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nsecure boot \u3092\u5b9f\u73fe\u3059\u308b\u305f\u3081\u306bArch Linux \u3067\u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\n\n```console:\u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n# pacman -S sbsigntools\n# pacman -S openssl\n```\n\n\n## \u7f72\u540d\u7528\u306e\u9375\u306e\u4f5c\u6210\n`openssl` \u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u7528\u3057\u3066`PK`, `KEK`, `db` \u306b\u7f72\u540d\u3092\u884c\u3046\u305f\u3081\u306e\u9375\u3092\u751f\u6210\u3057\u307e\u3059\u3002\n\n\n```console:openssl(RSA)\n# openssl genrsa -out my-arch-linux.key 2048\n# openssl req -new -x509 -sha256 -subj '/CN=my-arch-linux' -key my-arch-linux.key -out my-arch-linux.pem\n# openssl x509 -in my-arch-linux.pem -inform PEM -out my-arch-linux.der -outform DER\n```\n\n\n`uuidgen` \u3092\u4f7f\u7528\u3057\u3066\u9375\u306e\u6240\u6709\u8005\u3092\u8868\u3059\u305f\u3081\u306eGUID \u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```console\n# guid=$(uuidgen)\n# echo $guid\n```\n\n\n\u6b21\u306b`EFI_SIGNATURE_LIST` (\u7f72\u540d\u30ea\u30b9\u30c8)\u3092\u4f5c\u6210\u3057\u3066\u3044\u304d\u307e\u3057\u3087\u3046\u3002\n\u3053\u3053\u3067\u767b\u9332\u3055\u308c\u308b`my-arch-linux.der` \u306e\u7f72\u540d\u306f\u81ea\u5df1\u7f72\u540d\u3068\u306a\u308a\u307e\u3059\u3002\n\n```console\n# sbsiglist --owner $guid --type x509 --output my-arch-linux.der.siglist my-arch-linux.der\n```\n\n\n`sbvarsign` \u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u7528\u3057\u3066\u5404\u9375\u60c5\u5831\u3001\u5909\u6570\u3068\u305d\u306e\u5024\u306b\u5bfe\u3057\u3066\u7f72\u540d\u3092\u884c\u3063\u3066\u3044\u304d\u307e\u3059\u3002\n\n\n```bash:PKKEKdb\u306esignedupdate\u3092\u4f5c\u6210\u3059\u308b\nfor n in PK KEK db\ndo\n    sbvarsign --key my-arch-linux.key --cert my-arch-linux.pem --output my-arch-linux.der.siglist.$n.signed $n my-arch-linux.der.siglist\ndone\n```\n\n\n\u6b21\u306bkeystore \u3092\u4f5c\u6210\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n\n```console\n# mkdir -p /etc/secureboot/keys/{PK,KEK,db,dbx}\n# cp *.PK.signed /etc/secureboot/keys/PK/\n# cp *.KEK.signed /etc/secureboot/keys/KEK/\n# cp *.db.signed /etc/secureboot/keys/db/\n```\n\n\n`sbkeysync` \u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u7528\u3057\u3066firmware \u306e\u9375\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3068\u60c5\u5831\u3092\u540c\u671f\u3055\u305b\u307e\u3059\u3002\n\u4e0a\u8a18\u3067`/etc/secureboot/keys` \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u914d\u4e0b\u306b\u9375\u3092\u4f5c\u6210\u3057\u307e\u3057\u305f\u304c\u3001\u3053\u308c\u4ee5\u5916\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f7f\u7528\u3057\u305f\u3044\u5834\u5408\u306f`sbkeysync` \u30b3\u30de\u30f3\u30c9\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u306b`--keystore` and/or `--no-default-keystores` \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u52a0\u3048\u3066\u5b9f\u884c\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u307e\u305a\u306f`--dry-run` \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u4ed8\u3051\u3066\u3001\u30c6\u30b9\u30c8\u30e2\u30fc\u30c9\u3067\u5b9f\u884c\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\n\n```console:sbkeysync(dry-run)\n# sbkeysync --verbose --pk --dry-run\n```\n\n\n\u7d50\u679c\u306b\u554f\u984c\u7121\u3044\u3088\u3046\u3067\u3042\u308c\u3070\u3001\u4eca\u5ea6\u306f`--dry-run` \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u5916\u3057\u3066\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u307e\u3059(firemware \u4e0a\u306e\u9375DB \u304c\u66f4\u65b0\u3055\u308c\u307e \u3059\u306e\u3067\u3001\u899a\u609f\u3092\u6c7a\u3081\u3066\u304f\u3060\u3055\u3044\u2026)\u3002\n\u3053\u3053\u3067\u6ce8\u610f\u3057\u3066\u3044\u305f\u3060\u304d\u305f\u3044\u306e\u306f\u3001firmware \u306b\u3088\u3063\u3066\u306f\u3053\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u3067\u3001\u81ea\u52d5\u7684\u306b`set up \u30e2\u30fc\u30c9`\u304b\u3089`secure boot \u5f37\u5236\u30e2\u30fc\u30c9`\u3078\u79fb\u884c\u3057\u3066\u3057\u307e\u3046\u3082\u306e\u304c\u3042\u308b\u305d\u3046\u3067\u3059\u3002\n\u305d\u306e\u305f\u3081\u3001\u3084\u3063\u3071\u308asecure boot \u3092off \u306b\u3057\u305f\u3044\u5834\u5408\u306e\u4fdd\u967a\u306e\u610f\u5473\u3082\u8fbc\u3081\u3066\u3001\u4e8b\u524d\u306b\u304a\u4f7f\u3044\u306e\u30b3\u30f3\u30d4\u30e5\u30fc\u30bf\u306efirmware \u306e\u8a2d\u5b9a\u753b\u9762\u304b\u3089secure boot \u3092OFF \u306b\u3059\u308b\u65b9\u6cd5\u3084PK \u3092\u524a\u9664\u3059\u308b\u65b9\u6cd5\u304c\u3042\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\n\n\n```console:sbkeysync\n# sbkeysync --verbose --pk\n\n... \u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30a8\u30e9\u30fc\u304c\u51fa\u305f ...\nNew keys in filesystem:\n /etc/secureboot/keys/db/my-arch-linux.der.siglist.db.signed\n /etc/secureboot/keys/KEK/my-arch-linux.der.siglist.KEK.signed\n /etc/secureboot/keys/PK/my-arch-linux.der.siglist.PK.signed\nInserting key update /etc/secureboot/keys/db/my-arch-linux.der.siglist.db.signed into db\nCan't create key file /sys/firmware/efi/efivars/db-d719b2cb-3d3a-4596-a3bc-dad00e67656f: Permission denied\nError syncing keystore file /etc/secureboot/keys/db/my-arch-linux.der.siglist.db.signed\nInserting key update /etc/secureboot/keys/KEK/my-arch-linux.der.siglist.KEK.signed into KEK\nCan't create key file /sys/firmware/efi/efivars/KEK-8be4df61-93ca-11d2-aa0d-00e098032b8c: Permission denied\nError syncing keystore file /etc/secureboot/keys/KEK/my-arch-linux.der.siglist.KEK.signed\n```\n\n\n`--dry-run` \u30e2\u30fc\u30c9\u3067\u6210\u529f\u3057\u3066\u3082\u5b9f\u969b\u306b\u540c\u671f\u3057\u3088\u3046\u3068\u3059\u308b\u3068\u5931\u6557\u3057\u307e\u3057\u305f\u3002\n\u539f\u56e0\u306fUEFI \u306esecure boot \u30e2\u30fc\u30c9\u304c`setup \u30e2\u30fc\u30c9`\u306b\u306a\u3063\u3066\u3044\u306a\u3044\u305f\u3081\u3067\u3057\u305f\u3002\n\u304a\u4f7f\u3044\u306e\u30de\u30b7\u30f3\u306b\u3088\u3063\u3066\u30a8\u30e9\u30fc\u306b\u306a\u3063\u305f\u308a\u3001\u306a\u3089\u306a\u304b\u3063\u305f\u308a\u306f\u7570\u306a\u3063\u3066\u304f\u308b\u3068\u601d\u3044\u307e\u3059\u306e\u3067\u3001\u6b21\u306e\u5bfe\u5fdc\u306f\u3042\u304f\u307e\u3067\u53c2\u8003\u7a0b\u5ea6\u306b\u3068\u3069 \u3081\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\n\nsecure boot \u30e2\u30fc\u30c9\u3092`setup \u30e2\u30fc\u30c9`\u3078\u5909\u66f4\u3059\u308b\u305f\u3081\u306b\u3001\u4e00\u65e6\u30de\u30b7\u30f3\u3092\u518d\u8d77\u52d5\u3057\u3001Lenovo \u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u753b\u9762\u30e1\u30cb\u30e5\u30fc\u304b\u3089\u8a2d\u5b9a\u3092\u5909\u66f4\u3057\u3001\u518d\u5ea6OS \u3092\u8d77\u52d5\u3055\u305b\u307e\u3059\u3002\n\n```text:Lenovo\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u753b\u9762\u304b\u3089...\nSecurity\n  -> Secure Boot\n    -> Reset to Setup Mode [Enter]\n    -> Clear All Secure Boot Keys [Enter]\n\n// \"Reset to Setup Mode\" \u3067Enter \u30ad\u30fc\u3092\u62bc\u3057\u3066Setup Mode \u3092\u30ea\u30bb\u30c3\u30c8\n// \u5ff5\u306e\u305f\u3081\"Clear All Secure Boot Keys\" \u3067\u3082Enter \u30ad\u30fc\u3092\u62bc\u4e0b\u3057\u3066\u3059\u3079\u3066\u306e\u9375\u3092\u30ea\u30bb\u30c3\u30c8\n```\n\n\n## bootloader \u306b\u7f72\u540d\u3092\u884c\u3046\nbootloader \u306b\u7f72\u540d\u3092\u884c\u3044\u307e\u3059\u3002\n\u4eca\u56de\u306f\u30ce\u30fc\u30c8PC \u4e0a\u3067\u65e2\u306b\u8d77\u52d5\u3057\u3066\u3044\u308bArch Linux \u306ebootloader \u306b\u5bfe\u3057\u3066\u7f72\u540d\u3092\u884c\u3044\u307e\u3059\u3002\n\n\u5b9f\u969b\u3001\u91cd\u8981\u306aLinux \u30b7\u30b9\u30c6\u30e0\u3092\u60f3\u5b9a\u3057\u305fSecure Boot \u3092\u884c\u3046\u5834\u5408\u306f\u3001\u7f72\u540d\u3092\u884c\u3046bootloader(OS) \u3068\u9375\u3092\u7ba1\u7406\u3059\u308bOS \u306f\u5225\u306e\u7269\u3067\u3042 \u308b\u3053\u3068\u304c\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u4e0a\u306f\u597d\u307e\u3057\u3044\u3067\u304c\u3001\u4eca\u56de\u306f\u52d5\u4f5c\u78ba\u8a8d\u76ee\u7684\u306a\u306e\u3067\u3001\u305d\u306e\u3088\u3046\u306a\u3053\u3068\u306f\u6c17\u306b\u305b\u305a\u306b\u7f72\u540d\u3092\u884c\u3063\u3066\u3044\u304d\u307e\u3059\u3002\n\n\n```console:bootloader\u306b\u7f72\u540d\u3092\u884c\u3046\n# sbsign --key my-arch-linux.key --cert my-arch-linux.pem --output grubx64.efi /boot/efi/EFI/arch/grubx64.efi\n# cp /boot/efi/EFI/arch/grubx64.efi{,.bak}\n# cp grubx64.efi /boot/efi/EFI/arch/\n```\n\n\n## Secure Boot \u30e2\u30fc\u30c9\u3067\u8d77\u52d5\u3059\u308b\nbootloader \u3078\u306e\u7f72\u540d\u3082\u5b8c\u4e86\u3057\u305f\u3089\u3001\u30de\u30b7\u30f3\u3092\u518d\u8d77\u52d5\u3057\u3001\u30cf\u30fc\u30c9\u30a6\u30a7\u30a2\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u753b\u9762\u304b\u3089Secure Boot \u30e2\u30fc\u30c9\u304cON \u306b\u306a\u3063\u3066 \u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```text:\u4f8b:LenovoT460s\u306e\u5834\u5408\n// Lenovo \u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u753b\u9762\u304b\u3089...\nSecurity\n  -> Secure Boot\n    -> Secure Boot [Enabled]\n```\n\n\nSecure Boot \u30e2\u30fc\u30c9\u304cON \u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u305f\u3089\u3001\u305d\u306e\u307e\u307eOS \u306eboot \u30d7\u30ed\u30bb\u30b9\u3078\u9032\u307f\u3001\u6b63\u5e38\u306bLinux \u304c\u8d77\u52d5\u3067\u304d\u308c\u3070\u6210\u529f\u3067\u3059\u3002\n\n\u6b63\u3057\u304fSecure Boot \u30e2\u30fc\u30c9\u3067Linux \u304c\u8d77\u52d5\u3057\u3066\u3044\u308b\u304b\u3069\u3046\u304b\u3092\u78ba\u8a8d\u3057\u305f\u3044\u5834\u5408\u306f\u3001USB \u30e1\u30e2\u30ea\u306b\u4ed6\u306eLinux \u30a4\u30e1\u30fc\u30b8\u3092\u5165\u308c\u3066USB  \u304b\u3089\u8d77\u52d5\u3055\u305b\u3066\u307f\u3066\u304f\u3060\u3055\u3044\u3002\n\u305d\u306e\u6642\u306bUSB \u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u7f72\u540d\u304c\u884c\u308f\u308c\u3066\u3044\u306a\u3044\u3001\u3082\u3057\u304f\u306f\u7f72\u540d\u691c\u8a3c\u306b\u30d1\u30b9\u3067\u304d\u305a\u306b\u8d77\u52d5\u306b\u5931\u6557\u3059\u308c\u3070\u3001Secure Boot \u306e\u52d5 \u4f5c\u3068\u3057\u3066\u6b63\u5e38\u306b\u904b\u8ee2\u3057\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\n\n# setup \u30e2\u30fc\u30c9(\u3082\u3057\u304f\u306fSecure Boot \u30e2\u30fc\u30c9OFF)\u3078\u5207\u308a\u623b\u3057\u3059\u308b\nSecure Boot \u30e2\u30fc\u30c9\u3092\u30ea\u30bb\u30c3\u30c8\u3057\u305f\u3044\u3001\u3082\u3057\u304f\u306fSecure Boot \u30e2\u30fc\u30c9\u3092\u7121\u52b9\u306b\u3057\u305f\u3044\u5834\u5408\u306f\u4ee5\u4e0b\u306e\u624b\u9806\u3092\u5b9f\u65bd\u3057\u307e\u3059\u3002\n\n## \u65b9\u6cd51: \u30cf\u30fc\u30c9\u30a6\u30a7\u30a2\u30d9\u30f3\u30c0\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u753b\u9762\u304b\u3089Secure Boot \u30e2\u30fc\u30c9\u3092OFF \u306b\u3059\u308b\n\u4eca\u56de\u691c\u8a3c\u306b\u4f7f\u7528\u3057\u305fLenovo T460s \u306e\u3088\u3046\u306b\u3001\u30cf\u30fc\u30c9\u30a6\u30a7\u30a2\u5074\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u753b\u9762\u306bSecure Boot \u3092\u8a2d\u5b9a\u3059\u308b\u30e1\u30cb\u30e5\u30fc\u304c\u3042\u308b\u5834\u5408\u306f\u3001\u305d\u3061\u3089\u304b\u3089OFF \u306b\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n\n```text:\u4f8b:LenovoT460s\u306e\u5834\u5408\n// Lenovo \u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u753b\u9762\u304b\u3089...\nSecurity\n  -> Secure Boot\n    -> Reset to Setup Mode [Enter]   // Enter \u3092\u62bc\u4e0b\u3059\u308b\n    -> Clear All Secure Boot Keys [Enter] // Enter \u3092\u62bc\u4e0b\u3059\u308b\n```\n\n\n\u66f4\u306bSecure Boot \u30e2\u30fc\u30c9\u3092OFF \u306b\u3057\u305f\u3044\u5834\u5408\u306f\"Secure Boot\" \u3082Disabled \u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n\n```text:\u4f8b:LenovoT460s\u306e\u5834\u5408\n// Lenovo \u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u753b\u9762\u304b\u3089...\nSecurity\n  -> Secure Boot\n    -> Secure Boot [Disabled]\n```\n\n\n## \u65b9\u6cd52: \u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u304b\u3089firmware \u4e0a\u306e\u30e1\u30e2\u30ea\u3092\u66f8\u304d\u63db\u3048\u308b\n(\u3053\u306e\u65b9\u6cd5\u3092\u5b9f\u65bd\u3057\u3066\u3082\u623b\u3089\u306a\u3044firmware \u304c\u3042\u308b\u3088\u3046\u3067\u3059\u3002\u5b9f\u884c\u306f\u81ea\u5df1\u8cac\u4efb\u3067\u304a\u306d\u304c\u3044\u3057\u307e\u3059...)\n\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u304b\u3089setup \u30e2\u30fc\u30c9\u3078\u5207\u308a\u623b\u3057\u3092\u3057\u305f\u3044\u5834\u5408\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u624b\u9806\u3067\u7a7a\u3063\u307d\u306ePK \u3092\u4e0a\u66f8\u304d\u3057\u3066\u3042\u3052\u308b\u3053\u3068\u3067\u884c\u3046\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n\n```console\n# : > empty\n# sbvarsign --key my-arch-linux.key --cert my-arch-linux.pem --attrs NON_VOLATILE,BOOTSERVICE_ACCESS,RUNTIME_ACCESS --include-attrs --output empty.PK.signed PK empty\n# dd bs=4K if=empty.PK.signed of=/sys/firmware/efi/efivars/PK-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\n(xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx \u306f\u4f7f\u3063\u3066\u3044\u308b\u74b0\u5883\u3054\u3068\u306b\u7570\u306a\u308b)\n```\n\n\n# \u5099\u5fd8\u9332: \u7f72\u540dECDSA \u79d8\u5bc6\u9375\u3067\u4f5c\u6210\u3059\u308b\u5834\u5408\n\u6700\u5f8c\u306b...\u672c\u624b\u9806\u306f\u4ee5\u4e0a\u3067\u7d42\u4e86\u3067\u3059\u304c\u3001ECDSA \u3067\u3082\u7f72\u540d\u304c\u884c\u3046\u3053\u3068\u304c\u3067\u304d\u308b\u304b\u3069\u3046\u304b\u306b\u3064\u3044\u3066\u30c6\u30b9\u30c8\u3092\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\u7d50\u679c\u304b\u3089\u5148\u306b\u3044\u3046\u3068\u3001\u4eca\u56de\u81ea\u5206\u304c\u4f7f\u7528\u3057\u305f\u30cf\u30fc\u30c9\u30a6\u30a7\u30a2\u3067\u306f\u3001ECDSA \u306a\u79d8\u5bc6\u9375\u3092\u4f7f\u3063\u305f\u65b9\u6cd5\u306f\u5b9f\u65bd\u4e0d\u80fd\u3067\u3057\u305f\u3002\n\u5099\u5fd8\u9332\u30022016/08 \u73fe\u5728\u3001ECDSA \u306b\u3066\u767b\u9332\u3057\u3088\u3046\u3068\u3057\u3066\u3082\u3001firmware \u3068\u60c5\u5831\u306e\u540c\u671f\u3092\u884c\u3046\u3068\u304d\u306b\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u3066\u767b\u9332\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u305b\u3093\u3002\n\u304a\u4f7f\u3044\u306e\u30cf\u30fc\u30c9\u30a6\u30a7\u30a2\u74b0\u5883\u306b\u3088\u3063\u3066\u3082\u5909\u308f\u3063\u3066\u304f\u308b\u53ef\u80fd\u6027\u304c\u3042\u308b\u305f\u3081\u3001\u3042\u304f\u307e\u3067\u53c2\u8003\u7a0b\u5ea6\u306b\u3057\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\n\n```console:openssl(ECDSA)\n# openssl ecparam -list_curves\n...\nsecp521r1\n...\n\n# openssl ecparam -out my-arch-linux.key -name secp521r1 -genkey\n# openssl ecparam -out my-arch-linux.key -name prime256v1 -genkey\n# openssl ecparam -out my-arch-linux.key -name secp384r1 -genkey\n\n# openssl req -new -x509 -sha256 -subj '/CN=my-arch-linux' -key my-arch-linux.key -out my-arch-linux.pem\n# openssl x509 -in my-arch-linux.pem -inform PEM -out my-arch-linux.der -outform DER\n```\n\n\n\u6955\u5186\u66f2\u7dda\u3068\u3057\u3066\u30e1\u30b8\u30e3\u30fc\u3069\u3053\u308d\u3067\u3042\u308b`prime256v1`, `secp384r1`, `secp521r1` \u3042\u305f\u308a\u3092\u8a66\u3057\u3066\u307f\u305f\u304c\u3069\u308c\u3082\u30c0\u30e1\u3002\n\n\n```text:prime256v1,secp384r1,secp521r1\nInserting key update /etc/secureboot/keys/db/my-arch-linux.der.siglist.db.signed into db\nError writing key update: Invalid argument\nError syncing keystore file /etc/secureboot/keys/db/my-arch-linux.der.siglist.db.signed\nInserting key update /etc/secureboot/keys/KEK/my-arch-linux.der.siglist.KEK.signed into KEK\nError writing key update: Invalid argument\nError syncing keystore file /etc/secureboot/keys/KEK/my-arch-linux.der.siglist.KEK.signed\n```\n\n\n# \u53c2\u8003\n- Shim\n    - https://docs.fedoraproject.org/en-US/Fedora/18/html/UEFI_Secure_Boot_Guide/sect-UEFI_Secure_Boot_Guide-Implementation_of_UEFI_Secure_Boot-Shim.html\n\n- Secure Boot \u53c2\u8003\n    - https://wiki.ubuntu.com/SecurityTeam/SecureBoot\n    - http://jk.ozlabs.org/docs/sbkeysync-maintaing-uefi-key-databases/\n\n- \u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306b\u3064\u5165\u308c\u306f\u4ee5\u4e0b\u306e\u30da\u30fc\u30b8\u304c\u53c2\u8003\u306b\u306a\u308b\n    - http://www.linux-magazine.com/Issues/2014/164/The-State-of-Secure-Boot\n\n- openssl \u306a\u3069\u304c\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u3044\u308b\u6955\u5186\u66f2\u7dda\u306b\u3064\u3044\u3066\n    - https://en.wikipedia.org/wiki/Comparison_of_TLS_implementations#Supported_elliptic_curves\n\n- Which elliptic curve should I use?\n    - http://security.stackexchange.com/questions/78621/which-elliptic-curve-should-i-use\n", "tags": ["Linux", "archLinux", "openssl"]}