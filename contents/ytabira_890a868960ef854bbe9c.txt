{"context": "AWS\u306eEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u7d44\u307f\u8fbc\u307e\u308c\u3066\u3044\u308b\u30b9\u30c6\u30fc\u30bf\u30b9\u30c1\u30a7\u30c3\u30af\u306e\u30a2\u30e9\u30fc\u30e0\u3092OpsWorks\u304c\u63d0\u4f9b\u3059\u308bChef\u306e\u30ec\u30b7\u30d4\u3067\u4f5c\u6210\u3059\u308b\u624b\u9806\u3067\u3059\u3002\nEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306f\u969c\u5bb3\u304c\u767a\u751f\u3057\u305f\u3068\u304d\u306b\u30b9\u30c6\u30fc\u30bf\u30b9\u30c1\u30a7\u30c3\u30af\u306e\u5931\u6557\u3092\u5831\u544a\u3057\u3066\u518d\u8d77\u52d5\u3059\u308b\u3053\u3068\u304c\u3042\u308b\u306e\u3067\u3001\u305d\u306e\u30c1\u30a7\u30c3\u30af\u306e\u305f\u3081\u306e\u30a2\u30e9\u30fc\u30e0\u3067\u3059\u3002(\u30b9\u30c6\u30fc\u30bf\u30b9\u30c1\u30a7\u30c3\u30af\u306b\u3064\u3044\u3066\u306f https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/monitoring-system-instance-status-check.html?icmpid=docs_ec2_console \u3092\u53c2\u7167)\n\n\u524d\u63d0\u6761\u4ef6\n\nOS: Amazon Linux 2016.09\nOpsWorks\u306eChef\u306e\u30d0\u30fc\u30b8\u30e7\u30f3: 12\n\n\nSNS\u30c8\u30d4\u30c3\u30af\u306e\u4f5c\u6210\n\u5148\u306b\u901a\u77e5\u5148\u306eSNS\u30c8\u30d4\u30c3\u30af\u3092CloudFormation\u3067\u4f5c\u6210\u3057\u307e\u3059\u3002Endpoint\u306e\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u306f\u9069\u5b9c\u8aad\u307f\u66ff\u3048\u3066\u4e0b\u3055\u3044(AWS::SNS::Topic\u306b\u3064\u3044\u3066\u306f https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-properties-sns-topic.html \u3092\u53c2\u7167)\u3002 Properties\u306eTopicName(https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-properties-sns-topic.html#cfn-sns-topic-name) \u306b\u3064\u3044\u3066\u306f\u6307\u5b9a\u3059\u308b\u3068\u30ea\u30bd\u30fc\u30b9\u306e\u7f6e\u304d\u63db\u3048\u304c\u767a\u751f\u3057\u305f\u3068\u304d\u306b\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3059\u308b(\u66f4\u65b0\u306e\u5ea6\u306b\u65b0\u3057\u3044\u540d\u524d\u3092\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b)\u306e\u3067\u3042\u3048\u3066\u6307\u5b9a\u3057\u307e\u305b\u3093\u3002\n\nsns.template\n{\n  \"AWSTemplateFormatVersion\": \"2010-09-09\",\n  \"Description\": \"SNS Topic\",\n  \"Resources\": {\n    \"AlarmTopic\": {\n      \"Type\": \"AWS::SNS::Topic\",\n      \"Properties\": {\n        \"DisplayName\": \"\u30b9\u30c6\u30fc\u30bf\u30b9\u30c1\u30a7\u30c3\u30af\u5931\u6557\u306e\u901a\u77e5\",\n        \"Subscription\": [\n          {\n            \"Endpoint\": \"hoge@example.com\",\n            \"Protocol\": \"email\"\n          }\n        ]\n      }\n    }\n  },\n  \"Outputs\": {\n    \"AlarmTopic\": {\n      \"Value\": {\n        \"Ref\": \"AlarmTopic\"\n      },\n      \"Description\": \"Alarm Topic ARN\"\n    }\n  }\n}\n\n\n\n\u30c8\u30d4\u30c3\u30afSNS\u306eARN\u3092Chef\u30ec\u30b7\u30d4\u306eattributes\u306b\u8a2d\u5b9a\nCloudFormation\u3067\u4f5c\u6210\u3057\u305f\u30b9\u30bf\u30c3\u30af\u306eOutputs\u30bf\u30d6\u306b\u4f5c\u6210\u3057\u305fSNS\u30c8\u30d4\u30c3\u30af\u306eARN\u304c\u8868\u793a\u3055\u308c\u308b\u306e\u3067\u3053\u3053\u306b\u8cbc\u308a\u4ed8\u3051\u307e\u3059\u3002(AWS\u30b3\u30f3\u30bd\u30fc\u30eb\u306eCloufFormation\u306e\u753b\u9762\u304b\u3089\u4f5c\u6210\u3057\u305f\u30b9\u30bf\u30c3\u30af\u3092\u9078\u629e\u3057\u3001Outputs\u30bf\u30d6\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068\u8868\u793a\u3055\u308c\u307e\u3059)\n\nsample_cookbook/attributes/default.rb\ndefault[:sns][:alarm_topic] = \"arn:aws:sns:ap-northeast-1:*******************\"\n\n\n\n\u30a2\u30e9\u30fc\u30e0\u4f5c\u6210\u306e\u30ec\u30b7\u30d4\nawscli\u3092\u4f7f\u3063\u3066\u30a2\u30e9\u30fc\u30e0\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\nsample_cookbook/recipes/default.rb\n##\n#=== data bags\u304b\u3089\u60c5\u5831\u3092\u53d6\u5f97\nstack = search(:aws_opsworks_stack).first\ninstance = search(:aws_opsworks_instance, \"hostname:#{node[:hostname]}\").first\n\n##\n#=== \u30b9\u30c6\u30fc\u30bf\u30b9\u30c1\u30a7\u30c3\u30af\u5931\u6557\u30a2\u30e9\u30fc\u30e0\u306e\u4f5c\u6210\nexecute \"Create status check failed alarm\" do\n  command %W{\n    aws cloudwatch put-metric-alarm\n    --region \"#{stack[:region]}\"\n    --alarm-name \"#{stack[:name]} StatusCheckFailed at #{node[:hostname]} > 1\"\n    --alarm-description \"[#{stack[:name]}]#{node[:hostname]}(#{instance[:ec2_instance_id]})\u3067\u30b9\u30c6\u30fc\u30bf\u30b9\u30c1\u30a7\u30c3\u30af\u306b\u5931\u6557\u3057\u307e\u3057\u305f\u3002\"\n    --metric-name StatusCheckFailed\n    --namespace 'AWS/EC2'\n    --statistic Maximum\n    --period 300\n    --threshold 0\n    --comparison-operator GreaterThanThreshold\n    --dimensions Name=InstanceId,Value=\"#{instance[:ec2_instance_id]}\"\n    --alarm-actions #{node[:sns][:alarm_topic]}\n    --ok-actions #{node[:sns][:alarm_topic]}\n    --evaluation-periods 1\n    --unit Count\n  }.join(' ')\nend\n\n\n\n\u53c2\u8003\u5143\nhttp://docs.aws.amazon.com/cli/latest/reference/cloudwatch/put-metric-alarm.html\nhttps://docs.aws.amazon.com/ja_jp/opsworks/latest/userguide/data-bags.html\nAWS\u306eEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u7d44\u307f\u8fbc\u307e\u308c\u3066\u3044\u308b\u30b9\u30c6\u30fc\u30bf\u30b9\u30c1\u30a7\u30c3\u30af\u306e\u30a2\u30e9\u30fc\u30e0\u3092OpsWorks\u304c\u63d0\u4f9b\u3059\u308bChef\u306e\u30ec\u30b7\u30d4\u3067\u4f5c\u6210\u3059\u308b\u624b\u9806\u3067\u3059\u3002\nEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306f\u969c\u5bb3\u304c\u767a\u751f\u3057\u305f\u3068\u304d\u306b\u30b9\u30c6\u30fc\u30bf\u30b9\u30c1\u30a7\u30c3\u30af\u306e\u5931\u6557\u3092\u5831\u544a\u3057\u3066\u518d\u8d77\u52d5\u3059\u308b\u3053\u3068\u304c\u3042\u308b\u306e\u3067\u3001\u305d\u306e\u30c1\u30a7\u30c3\u30af\u306e\u305f\u3081\u306e\u30a2\u30e9\u30fc\u30e0\u3067\u3059\u3002(\u30b9\u30c6\u30fc\u30bf\u30b9\u30c1\u30a7\u30c3\u30af\u306b\u3064\u3044\u3066\u306f https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/monitoring-system-instance-status-check.html?icmpid=docs_ec2_console \u3092\u53c2\u7167)\n\n### \u524d\u63d0\u6761\u4ef6\n* OS: Amazon Linux 2016.09\n* OpsWorks\u306eChef\u306e\u30d0\u30fc\u30b8\u30e7\u30f3: 12\n\n### SNS\u30c8\u30d4\u30c3\u30af\u306e\u4f5c\u6210\n\u5148\u306b\u901a\u77e5\u5148\u306eSNS\u30c8\u30d4\u30c3\u30af\u3092CloudFormation\u3067\u4f5c\u6210\u3057\u307e\u3059\u3002`Endpoint`\u306e\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u306f\u9069\u5b9c\u8aad\u307f\u66ff\u3048\u3066\u4e0b\u3055\u3044(AWS::SNS::Topic\u306b\u3064\u3044\u3066\u306f https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-properties-sns-topic.html \u3092\u53c2\u7167)\u3002 `Properties`\u306e`TopicName`(https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-properties-sns-topic.html#cfn-sns-topic-name) \u306b\u3064\u3044\u3066\u306f\u6307\u5b9a\u3059\u308b\u3068\u30ea\u30bd\u30fc\u30b9\u306e\u7f6e\u304d\u63db\u3048\u304c\u767a\u751f\u3057\u305f\u3068\u304d\u306b\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3059\u308b(\u66f4\u65b0\u306e\u5ea6\u306b\u65b0\u3057\u3044\u540d\u524d\u3092\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b)\u306e\u3067\u3042\u3048\u3066\u6307\u5b9a\u3057\u307e\u305b\u3093\u3002\n\n\n```json:sns.template\n{\n  \"AWSTemplateFormatVersion\": \"2010-09-09\",\n  \"Description\": \"SNS Topic\",\n  \"Resources\": {\n    \"AlarmTopic\": {\n      \"Type\": \"AWS::SNS::Topic\",\n      \"Properties\": {\n        \"DisplayName\": \"\u30b9\u30c6\u30fc\u30bf\u30b9\u30c1\u30a7\u30c3\u30af\u5931\u6557\u306e\u901a\u77e5\",\n        \"Subscription\": [\n          {\n            \"Endpoint\": \"hoge@example.com\",\n            \"Protocol\": \"email\"\n          }\n        ]\n      }\n    }\n  },\n  \"Outputs\": {\n    \"AlarmTopic\": {\n      \"Value\": {\n        \"Ref\": \"AlarmTopic\"\n      },\n      \"Description\": \"Alarm Topic ARN\"\n    }\n  }\n}\n```\n\n### \u30c8\u30d4\u30c3\u30afSNS\u306eARN\u3092Chef\u30ec\u30b7\u30d4\u306eattributes\u306b\u8a2d\u5b9a\nCloudFormation\u3067\u4f5c\u6210\u3057\u305f\u30b9\u30bf\u30c3\u30af\u306eOutputs\u30bf\u30d6\u306b\u4f5c\u6210\u3057\u305fSNS\u30c8\u30d4\u30c3\u30af\u306eARN\u304c\u8868\u793a\u3055\u308c\u308b\u306e\u3067\u3053\u3053\u306b\u8cbc\u308a\u4ed8\u3051\u307e\u3059\u3002(AWS\u30b3\u30f3\u30bd\u30fc\u30eb\u306eCloufFormation\u306e\u753b\u9762\u304b\u3089\u4f5c\u6210\u3057\u305f\u30b9\u30bf\u30c3\u30af\u3092\u9078\u629e\u3057\u3001Outputs\u30bf\u30d6\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068\u8868\u793a\u3055\u308c\u307e\u3059)\n\n```ruby:sample_cookbook/attributes/default.rb\ndefault[:sns][:alarm_topic] = \"arn:aws:sns:ap-northeast-1:*******************\"\n```\n\n### \u30a2\u30e9\u30fc\u30e0\u4f5c\u6210\u306e\u30ec\u30b7\u30d4\nawscli\u3092\u4f7f\u3063\u3066\u30a2\u30e9\u30fc\u30e0\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```ruby:sample_cookbook/recipes/default.rb\n##\n#=== data bags\u304b\u3089\u60c5\u5831\u3092\u53d6\u5f97\nstack = search(:aws_opsworks_stack).first\ninstance = search(:aws_opsworks_instance, \"hostname:#{node[:hostname]}\").first\n\n##\n#=== \u30b9\u30c6\u30fc\u30bf\u30b9\u30c1\u30a7\u30c3\u30af\u5931\u6557\u30a2\u30e9\u30fc\u30e0\u306e\u4f5c\u6210\nexecute \"Create status check failed alarm\" do\n  command %W{\n    aws cloudwatch put-metric-alarm\n    --region \"#{stack[:region]}\"\n    --alarm-name \"#{stack[:name]} StatusCheckFailed at #{node[:hostname]} > 1\"\n    --alarm-description \"[#{stack[:name]}]#{node[:hostname]}(#{instance[:ec2_instance_id]})\u3067\u30b9\u30c6\u30fc\u30bf\u30b9\u30c1\u30a7\u30c3\u30af\u306b\u5931\u6557\u3057\u307e\u3057\u305f\u3002\"\n    --metric-name StatusCheckFailed\n    --namespace 'AWS/EC2'\n    --statistic Maximum\n    --period 300\n    --threshold 0\n    --comparison-operator GreaterThanThreshold\n    --dimensions Name=InstanceId,Value=\"#{instance[:ec2_instance_id]}\"\n    --alarm-actions #{node[:sns][:alarm_topic]}\n    --ok-actions #{node[:sns][:alarm_topic]}\n    --evaluation-periods 1\n    --unit Count\n  }.join(' ')\nend\n```\n\n### \u53c2\u8003\u5143\nhttp://docs.aws.amazon.com/cli/latest/reference/cloudwatch/put-metric-alarm.html\nhttps://docs.aws.amazon.com/ja_jp/opsworks/latest/userguide/data-bags.html\n", "tags": ["AWS", "chef", "CloudFormation", "opsworks"]}