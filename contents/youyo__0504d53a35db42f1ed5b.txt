{"context": " More than 1 year has passed since last update.\n\n\u3084\u308b\u3053\u3068\n\n\u624b\u9806\n\n\nMySQL\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3(GTID mode)\nMHA\u3067\u5197\u9577\u5316\nHAproxy,consul,consul-template\u3067\u30de\u30b9\u30bf\u30fc\u5207\u308a\u66ff\u3048&\u8ca0\u8377\u5206\u6563\n\n\n\n\n\u3084\u3089\u306a\u3044\u3053\u3068\n\nMHA\u3084consul\u306a\u3069\u306e\u8aac\u660e\n\n\u203b \u305f\u3060\u306e\u30e1\u30e2\u66f8\u304d\u306a\u306e\u3067\u3059\n\n\u624b\u9806\n\n\u74b0\u5883\n\ncentos 6.6\nmysql 5.6\nhaproxy 1.5.2\nconsul 0.5.2\nconsul-template 0.10.0\n\n\n\u69cb\u6210\n\nmha-manager 1\u53f0\nmysql-server 3\u53f0\napp-server \u6570\u53f0\n\n\n\nMySQL\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3(GTID mode)\n\nmysql-server\u3059\u3079\u3066\n\nyum install -y http://dev.mysql.com/get/mysql-community-release-el6-5.noarch.rpm\nyum install -y mysql-server mysql\n\nvim /etc/my.cnf\n\n\n/etc/my.cnf\nserver-id = 1 # \u3066\u304d\u3068\u3046\u306b\nlog-bin = mysqld-bin\nlog-slave-updates\nbinlog_format = MIXED\nexpire_logs_days = 2\ngtid-mode=ON\nenforce-gtid-consistency\n\n\nservice mysqld start\nchkconfig mysqld on\n\n\n\u30de\u30b9\u30bf\u30fc\u306b\u3059\u308b1\u53f0\u306b\u3066\n\nmysql> grant replication slave on *.* to repl@'192.168.%.%' identified by 'replipass';\nmysql> flush privileges;\n\nmysqldump --all-databases --triggers --routines --events > fulldump.sql\n\n\n\u30b9\u30ec\u30fc\u30d6\u306b\u3066\n\nmysql < fulldump.sql\nmysql> flush privileges;\nmysql> change master to master_host = '192.168.151.101', master_port=3306, master_user='repl', master_password='replipass', master_auto_position=1;\nmysql> start slave;\n\n\nMHA\u3067\u5197\u9577\u5316\n\n\u30de\u30b9\u30bf\u30fc\u30ce\u30fc\u30c9\u3067\n\nMHA\u7528\u7ba1\u7406\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210(root\u3067\u3082\u3044\u3044\u3051\u3069\nmysql> grant all privileges on *.* to mha@'192.168.%.%' identified by 'mhapassword';\nmysql> flush privileges;\n\n\nmha-node\u3067\n\nwget https://72003f4c60f5cc941cd1c7d448fc3c99e0aebaa8.googledrive.com/host/0B1lu97m8-haWeHdGWXp0YVVUSlk/mha4mysql-node-0.56-0.el6.noarch.rpm\nyum localinstall -y mha4mysql-node-0.56-0.el6.noarch.rpm\n\n\nmha-manager\u3067\n\nyum install -y http://dev.mysql.com/get/mysql-community-release-el6-5.noarch.rpm epel-release\nyum install -y mysql\n\nwget https://72003f4c60f5cc941cd1c7d448fc3c99e0aebaa8.googledrive.com/host/0B1lu97m8-haWeHdGWXp0YVVUSlk/mha4mysql-node-0.56-0.el6.noarch.rpm\nwget https://72003f4c60f5cc941cd1c7d448fc3c99e0aebaa8.googledrive.com/host/0B1lu97m8-haWeHdGWXp0YVVUSlk/mha4mysql-manager-0.56-0.el6.noarch.rpm\nyum localinstall -y mha4mysql-node-0.56-0.el6.noarch.rpm mha4mysql-manager-0.56-0.el6.noarch.rpm\n\nvim /etc/mha.conf\nln -s /etc/mha.conf /etc/masterha_default.cnf\n\n\n/etc/mha.conf\n[server default]\nuser=mha\npassword=mhapassword\nmanager_workdir=/var/lib/mha\nmanager_log=/var/log/mha.log\nremote_workdir=/var/lib/mha\nrepl_user=repl\nrepl_password=replipass\nssh_user=root\nssh_port=22\n#master_ip_failover_script=/var/lib/mha/master_ip_failover_script.sh\n#master_ip_online_change_script=/var/lib/mha/master_ip_online_change_script.sh\n\n[server1]\nhostname=192.168.151.101\n[server2]\nhostname=192.168.151.102\n[server3]\nhostname=192.168.151.103\n\n\nssh-keygen -t rsa -f /root/.ssh/id_rsa -q -N \"\" -C \"\"\ncat /root/.ssh/id_rsa.pub >> /root/.ssh/authorized_keys\n\n\u203b \u5404mysql-server\u306b\u914d\u5e03\u3059\u308b\n\ncat <<EOL> /root/.ssh/id_rsa\nEOL\necho '' >> /root/.ssh/authorized_keys\nchmod 600 /root/.ssh/authorized_keys\nchmod 400 /root/.ssh/id_rsa\nchmod 700 /root/.ssh/\n\n\n\u63a5\u7d9a\u78ba\u8a8d\n\nmasterha_check_ssh --conf=/etc/mha.conf\nmasterha_check_repl --conf=/etc/mha.conf\n\n\n\u8d77\u52d5\n\nmasterha_manager --conf=/etc/mha.conf --ignore_last_failover\n\nmaster\u3092\u843d\u3068\u3059\u3068slave\u304c\u6607\u683c\u3057\u3066\u304f\u308b\u306f\u305a\u3002(10\u79d2~\u304f\u3089\u3044\u3060\u3063\u305f)\n\nHAproxy,consul,consul-template\u3067\u30de\u30b9\u30bf\u30fc\u5207\u308a\u66ff\u3048&\u8ca0\u8377\u5206\u6563\n\nstatus-check\u7528\u306e\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210\n\u30de\u30b9\u30bf\u30fc\u30ce\u30fc\u30c9\u3067\n\nmysql> grant select on *.* to haproxy@'192.168.%.%';\nmysql> grant select on *.* to haproxy@'127.0.0.1';\n\n\n\u5168\u30b5\u30fc\u30d0\u306bconsul\u5165\u308c\u308b\n\ncd /usr/local/src/\nwget https://dl.bintray.com/mitchellh/consul/0.5.2_linux_amd64.zip\nunzip 0.5.2_linux_amd64.zip\nmv consul /usr/local/bin/\n\n\nmha-manager\u3067consul agent -server\u8d77\u52d5\n\nmkdir /var/lib/consul\nconsul agent -server -bootstrap -client=127.0.0.1 -dc=mha -node=`hostname` -data-dir=/var/lib/consul -bind=0.0.0.0\n\n\nmha-node\u3067\u3082consul agent -server\u8d77\u52d5\n\nmkdir /var/lib/consul /etc/consul\nvim /etc/consul/mysql.json\nconsul agent -server -dc=mha -node=`hostname` -config-dir=/etc/consul -data-dir=/var/lib/consul -bind=0.0.0.0 -client=127.0.0.1 -join=192.168.151.110\n\n\n/etc/consul/mysql.json\n{\n    \"service\": {\n        \"name\": \"mysql\",\n        \"tags\": [\"mysql\"],\n        \"port\": 3306,\n        \"check\": {\n            \"script\": \"mysql -u haproxy -h 127.0.0.1 -P 3306 -e 'select 1' >/dev/null 2>&1\",\n            \"interval\": \"5s\"\n        }\n    }\n}\n\n\n\nmha-manager\u306bmaster_ip_failover_script,master_ip_online_change_script\u3092\u4ed5\u8fbc\u3080\n\nvim /var/lib/mha/master_ip_failover_script.sh\nvim /var/lib/mha/master_ip_online_change_script.sh\nchmod 700 /var/lib/mha/master_ip_failover_script.sh\nchmod 700 /var/lib/mha/master_ip_online_change_script.sh\nvim /etc/mha.conf\n\n\n/var/lib/mha/master_ip_failover_script.sh\n#!/bin/bash -u\n\nOPT=$(getopt -q -o a -l command:,ssh_user:,orig_master_host:,orig_master_ip:,orig_master_port:,new_master_host:,new_master_ip:,new_master_port:,new_master_user:,new_master_password: -- \"$@\")\nif [ $? -ne 0 ]; then\n  exit 1\nfi\n\neval set -- \"$OPT\"\nMODE=none\nNEW_IP=0.0.0.0\nNEW_PORT=0\n\nwhile true\ndo\n    case \"$1\" in\n    --command)\n        if [ \"$2\" == \"start\" ]; then\n            MODE=$2\n        elif [ \"$2\" == \"status\" ]; then\n            exit 0\n        elif [ \"$2\" == \"stop\" -o \"$2\" == \"stopssh\" ]; then\n            exit 0\n        else\n            exit 0\n        fi\n        shift 2\n        ;;\n    --new_master_ip)\n        if [ $MODE == \"start\" ]; then\n            NEW_IP=$2\n        fi\n        shift 2\n        ;;\n    --new_master_port)\n        if [ $MODE == \"start\" ]; then\n            NEW_PORT=$2\n        fi\n        shift 2\n        ;;\n    --)\n        shift\n        break\n        ;;\n    *)\n        shift\n        ;;\n    esac\ndone\n\ncase \"$MODE\" in\nstart)\n    # \u65b0\u30de\u30b9\u30bf\u30fc\u767b\u9332\u51e6\u7406\n    curl -q -XPUT -d \"${NEW_IP}\" http://127.0.0.1:8500/v1/kv/service/mha/ip\n    curl -q -XPUT -d \"${NEW_PORT}\" http://127.0.0.1:8500/v1/kv/service/mha/port\n    exit 0\n    ;;\n*)\n    exit 0\n    ;;\nesac\n\n\n\n/var/lib/mha/master_ip_online_change_script.sh\n#!/bin/bash -u\n\nOPT=$(getopt -o a -l command:,orig_master_host:,orig_master_ip:,orig_master_port:,orig_master_user:,orig_master_ssh_user:,orig_master_password:,new_master_host:,new_master_ip:,new_master_port:,new_master_user:,new_master_password:,new_master_ssh_user:,orig_master_ssh_port:,new_master_ssh_port:,orig_master_is_new_slave -- \"$@\")\nif [ $? -ne 0 ]; then\n  echo $OPT\n  exit 1\nfi\n\neval set -- \"$OPT\"\nMODE=none\nNEW_IP=0.0.0.0\nNEW_PORT=0\n\nwhile true\ndo\n    case \"$1\" in\n    --command)\n        if [ \"$2\" == \"start\" ]; then\n            MODE=$2\n        elif [ \"$2\" == \"stop\" -o \"$2\" == \"stopssh\" ]; then\n            exit 0\n        else\n            exit 0\n        fi\n        shift 2\n        ;;\n    --new_master_ip)\n        if [ $MODE == \"start\" ]; then\n            NEW_IP=$2\n        fi\n        shift 2\n        ;;\n    --new_master_port)\n        if [ $MODE == \"start\" ]; then\n            NEW_PORT=$2\n        fi\n        shift 2\n        ;;\n    --)\n        shift\n        break\n        ;;\n    *)\n        shift\n        ;;\n    esac\ndone\n\ncase \"$MODE\" in\nstart)\n    curl -q -XPUT -d \"${NEW_IP}\" http://127.0.0.1:8500/v1/kv/service/mha/ip\n    curl -q -XPUT -d \"${NEW_PORT}\" http://127.0.0.1:8500/v1/kv/service/mha/port\n    exit 0\n    ;;\n*)\n    exit 0\n    ;;\nesac\n\n\n\u203b master_ip_failover_script.sh \u3060\u3051\u3067\u5341\u5206\u306a\u6c17\u304c\u3059\u308b\u3002\u4f55\u3067\u5206\u3051\u305f\u304b\u306f\u5fd8\u308c\u305f\u306e\u3067\u305d\u306e\u307e\u307e\u3002\n\n/etc/mha.conf\n[server default]\nuser=mha\npassword=mhapassword\nmanager_workdir=/var/lib/mha\nmanager_log=/var/log/mha.log\nremote_workdir=/var/lib/mha\nrepl_user=repl\nrepl_password=replipass\nssh_user=root\nssh_port=22\nmaster_ip_failover_script=/var/lib/mha/master_ip_failover_script.sh\nmaster_ip_online_change_script=/var/lib/mha/master_ip_online_change_script.sh\n\n[server1]\nhostname=192.168.151.101\n[server2]\nhostname=192.168.151.102\n[server3]\nhostname=192.168.151.103\n\n\n\nmha-manager\u518d\u8d77\u52d5\n\nmasterha_manager --conf=/etc/mha.conf --ignore_last_failover\n\n\nconsul\u306ekvs\u306b\u30de\u30b9\u30bf\u30fc\u306e\u60c5\u5831\u3092\u521d\u56de\u767b\u9332\u3059\u308b\n\ncurl -XPUT -d '192.168.151.101' http://127.0.0.1:8500/v1/kv/service/mha/ip\ncurl -XPUT -d '3306' http://127.0.0.1:8500/v1/kv/service/mha/port\n\n\napp-server\u306bhaproxy\u3044\u308c\u308b\n\nyum install haproxy\nvim /etc/haproxy/haproxy.cfg\nservice haproxy start\nchkconfig haproxy on\n\n\n/etc/haproxy/haproxy.cfg\nglobal\n    log     127.0.0.1 local2\n    chroot      /var/lib/haproxy\n    pidfile     /var/run/haproxy.pid\n    maxconn     10000\n    user        haproxy\n    group       haproxy\n    daemon\n    stats socket    /var/lib/haproxy/stats\n\ndefaults\n    mode        tcp\n    log     global\n    option      tcplog\n    retries     3\n    timeout connect 10s\n    timeout client  1m\n    timeout server  1m\n\n\n\napp-server\u3067consul agent\u3092\u8d77\u52d5\n\nconsul agent -dc=mha -node=`hostname` -data-dir=/var/lib/consul -bind=0.0.0.0 -client=127.0.0.1 -join=192.168.151.110\n\n\napp-server\u306bconsul-template\u3092\u5165\u308c\u3066\u52d5\u304b\u3059\n\ncd /usr/local/src/\nwget https://github.com/hashicorp/consul-template/releases/download/v0.10.0/consul-template_0.10.0_linux_amd64.tar.gz\ntar xvzf consul-template_0.10.0_linux_amd64.tar.gz\nmv consul-template_0.10.0_linux_amd64/consul-template /usr/local/bin/\nchown root: /usr/local/bin/consul-template\nvim /etc/haproxy/haproxy.cfg.ctmpl\nconsul-template -consul=127.0.0.1:8500 -template=/etc/haproxy/haproxy.cfg.ctmpl:/etc/haproxy/haproxy.cfg:\"service haproxy reload\"\n\n\n/etc/haproxy/haproxy.cfg.ctmpl\nglobal\n    log     127.0.0.1 local2\n    chroot      /var/lib/haproxy\n    pidfile     /var/run/haproxy.pid\n    maxconn     10000\n    user        haproxy\n    group       haproxy\n    daemon\n    stats socket    /var/lib/haproxy/stats\n\ndefaults\n    mode        tcp\n    log     global\n    option      tcplog\n    retries     3\n    timeout connect 10s\n    timeout client  1m\n    timeout server  1m\n\nlisten mysql-master\n    bind 127.0.0.1:3306\n    mode tcp\n    option mysql-check user haproxy\n    server master {{key \"service/mha/ip\"}}:{{key \"service/mha/port\"}} check port {{key \"service/mha/port\"}} inter 2000 fall 5\n\nlisten mysql-slave\n    bind 127.0.0.1:3307\n    mode tcp\n    option mysql-check user haproxy\n    balance leastconn{{range service \"mysql\"}}\n    server {{.Node}} {{.Address}}:{{.Port}} check port {{.Port}} inter 2000 fall 5{{end}}\n\n\n\n\u5b8c\u6210\n\n\u5404app-server\u306e127.0.0.1:3306\u304c\u30de\u30b9\u30bf\u30fc\u30ce\u30fc\u30c9\u306b\u63a5\u7d9a\u3057\u3001127.0.0.1:3307\u304cmysql-server\u5168\u3066\u306b\u5206\u6563\u3059\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\n\u30de\u30b9\u30bf\u30fc\u304c\u843d\u3061\u308b\u3068\u5225\u30ce\u30fc\u30c9\u304c\u30de\u30b9\u30bf\u30fc\u306b\u6607\u683c\u3057\u3001haproxy\u3067\u306e\u632f\u308a\u5206\u3051\u5148\u3082\u5207\u308a\u66ff\u308f\u308b\n\u30b9\u30ec\u30fc\u30d6\u304c\u6b62\u307e\u3063\u305f\u5834\u5408\u3001consul\u306estatus check\u3067\u691c\u77e5\u3055\u308chaproxy\u304b\u3089\u5916\u308c\u308b\nmha-manager\u306fSPOF\u3002\u3061\u3083\u3093\u3068\u76e3\u8996\u3057\u3066\u6c17\u3065\u3051\u308c\u3070\u3061\u3087\u3063\u3068\u3050\u3089\u3044\u6b62\u307e\u3063\u3066\u3082\u3044\u3044\u3068\u601d\u3063\u3066\u308b\u306e\u3067\u6c17\u306b\u3057\u306a\u3044\u3002(\u305d\u306e\u3046\u3061\u5197\u9577\u5316\u3059\u308b\u304b\u3082\n\n# masterha_master_switch --master_state=alive --conf=/etc/mha.conf --interactive=0 --orig_master_is_new_slave \u3053\u306e\u30b3\u30de\u30f3\u30c9\u3067\u4e00\u77ac\u3067\u30de\u30b9\u30bf\u30fc\u5207\u308a\u66ff\u308f\u308b\ncentos7\u7cfb\u3067\u30827\u7cfb\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u4f7f\u3048\u3070\u3061\u3083\u3093\u3068\u52d5\u3044\u305f\n\nconsul-haproxy\u3068\u3044\u3046\u30ba\u30d0\u30ea\u306a\u3082\u306e\u304c\u3042\u308b\u304c\u4eca\u56de\u306f\u5fd8\u308c\u308b(\u3042\u3068\u304b\u3089\u6c17\u3065\u3044\u305f\n\n\nhttp://blog.cloudpack.jp/2014/08/14/consul-haproxy-a-little-tips/\nhttps://github.com/hashicorp/consul-haproxy\n\n\n\n## \u3084\u308b\u3053\u3068\n\n- \u624b\u9806\n\t- MySQL\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3(GTID mode)\n\t- MHA\u3067\u5197\u9577\u5316\n\t- HAproxy,consul,consul-template\u3067\u30de\u30b9\u30bf\u30fc\u5207\u308a\u66ff\u3048&\u8ca0\u8377\u5206\u6563\n\n## \u3084\u3089\u306a\u3044\u3053\u3068\n\n- MHA\u3084consul\u306a\u3069\u306e\u8aac\u660e\n\n\u203b \u305f\u3060\u306e\u30e1\u30e2\u66f8\u304d\u306a\u306e\u3067\u3059\n\n## \u624b\u9806\n\n### \u74b0\u5883\n\n- centos 6.6\n- mysql 5.6\n- haproxy 1.5.2\n- consul 0.5.2\n- consul-template 0.10.0\n\n### \u69cb\u6210\n\n- mha-manager 1\u53f0\n- mysql-server 3\u53f0\n- app-server \u6570\u53f0\n\n![mha-haproxy.png](https://qiita-image-store.s3.amazonaws.com/0/14975/147c5073-bfbe-78b6-cde3-ed151c52bffd.png)\n\n\n### MySQL\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3(GTID mode)\n\n- mysql-server\u3059\u3079\u3066\n\n```\nyum install -y http://dev.mysql.com/get/mysql-community-release-el6-5.noarch.rpm\nyum install -y mysql-server mysql\n\nvim /etc/my.cnf\n```\n\n``` /etc/my.cnf\nserver-id = 1 # \u3066\u304d\u3068\u3046\u306b\nlog-bin = mysqld-bin\nlog-slave-updates\nbinlog_format = MIXED\nexpire_logs_days = 2\ngtid-mode=ON\nenforce-gtid-consistency\n```\n\n```\nservice mysqld start\nchkconfig mysqld on\n```\n\n- \u30de\u30b9\u30bf\u30fc\u306b\u3059\u308b1\u53f0\u306b\u3066\n\n```\nmysql> grant replication slave on *.* to repl@'192.168.%.%' identified by 'replipass';\nmysql> flush privileges;\n\nmysqldump --all-databases --triggers --routines --events > fulldump.sql\n```\n\n- \u30b9\u30ec\u30fc\u30d6\u306b\u3066\n\n```\nmysql < fulldump.sql\nmysql> flush privileges;\nmysql> change master to master_host = '192.168.151.101', master_port=3306, master_user='repl', master_password='replipass', master_auto_position=1;\nmysql> start slave;\n```\n\n### MHA\u3067\u5197\u9577\u5316\n\n- \u30de\u30b9\u30bf\u30fc\u30ce\u30fc\u30c9\u3067\n\nMHA\u7528\u7ba1\u7406\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210(root\u3067\u3082\u3044\u3044\u3051\u3069\n\n```\nmysql> grant all privileges on *.* to mha@'192.168.%.%' identified by 'mhapassword';\nmysql> flush privileges;\n```\n\n- mha-node\u3067\n\n```\nwget https://72003f4c60f5cc941cd1c7d448fc3c99e0aebaa8.googledrive.com/host/0B1lu97m8-haWeHdGWXp0YVVUSlk/mha4mysql-node-0.56-0.el6.noarch.rpm\nyum localinstall -y mha4mysql-node-0.56-0.el6.noarch.rpm\n```\n\n- mha-manager\u3067\n\n```\nyum install -y http://dev.mysql.com/get/mysql-community-release-el6-5.noarch.rpm epel-release\nyum install -y mysql\n\nwget https://72003f4c60f5cc941cd1c7d448fc3c99e0aebaa8.googledrive.com/host/0B1lu97m8-haWeHdGWXp0YVVUSlk/mha4mysql-node-0.56-0.el6.noarch.rpm\nwget https://72003f4c60f5cc941cd1c7d448fc3c99e0aebaa8.googledrive.com/host/0B1lu97m8-haWeHdGWXp0YVVUSlk/mha4mysql-manager-0.56-0.el6.noarch.rpm\nyum localinstall -y mha4mysql-node-0.56-0.el6.noarch.rpm mha4mysql-manager-0.56-0.el6.noarch.rpm\n\nvim /etc/mha.conf\nln -s /etc/mha.conf /etc/masterha_default.cnf\n```\n\n``` /etc/mha.conf\n[server default]\nuser=mha\npassword=mhapassword\nmanager_workdir=/var/lib/mha\nmanager_log=/var/log/mha.log\nremote_workdir=/var/lib/mha\nrepl_user=repl\nrepl_password=replipass\nssh_user=root\nssh_port=22\n#master_ip_failover_script=/var/lib/mha/master_ip_failover_script.sh\n#master_ip_online_change_script=/var/lib/mha/master_ip_online_change_script.sh\n\n[server1]\nhostname=192.168.151.101\n[server2]\nhostname=192.168.151.102\n[server3]\nhostname=192.168.151.103\n```\n\n```\nssh-keygen -t rsa -f /root/.ssh/id_rsa -q -N \"\" -C \"\"\ncat /root/.ssh/id_rsa.pub >> /root/.ssh/authorized_keys\n\n\u203b \u5404mysql-server\u306b\u914d\u5e03\u3059\u308b\n\ncat <<EOL> /root/.ssh/id_rsa\nEOL\necho '' >> /root/.ssh/authorized_keys\nchmod 600 /root/.ssh/authorized_keys\nchmod 400 /root/.ssh/id_rsa\nchmod 700 /root/.ssh/\n```\n\n- \u63a5\u7d9a\u78ba\u8a8d\n\n```\nmasterha_check_ssh --conf=/etc/mha.conf\nmasterha_check_repl --conf=/etc/mha.conf\n```\n\n- \u8d77\u52d5\n\n```\nmasterha_manager --conf=/etc/mha.conf --ignore_last_failover\n```\n\nmaster\u3092\u843d\u3068\u3059\u3068slave\u304c\u6607\u683c\u3057\u3066\u304f\u308b\u306f\u305a\u3002(10\u79d2~\u304f\u3089\u3044\u3060\u3063\u305f)\n\n### HAproxy,consul,consul-template\u3067\u30de\u30b9\u30bf\u30fc\u5207\u308a\u66ff\u3048&\u8ca0\u8377\u5206\u6563\n\n- status-check\u7528\u306e\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210\n- \u30de\u30b9\u30bf\u30fc\u30ce\u30fc\u30c9\u3067\n\n```\nmysql> grant select on *.* to haproxy@'192.168.%.%';\nmysql> grant select on *.* to haproxy@'127.0.0.1';\n```\n\n- \u5168\u30b5\u30fc\u30d0\u306bconsul\u5165\u308c\u308b\n\n```\ncd /usr/local/src/\nwget https://dl.bintray.com/mitchellh/consul/0.5.2_linux_amd64.zip\nunzip 0.5.2_linux_amd64.zip\nmv consul /usr/local/bin/\n```\n\n- mha-manager\u3067`consul agent -server `\u8d77\u52d5\n\n```\nmkdir /var/lib/consul\nconsul agent -server -bootstrap -client=127.0.0.1 -dc=mha -node=`hostname` -data-dir=/var/lib/consul -bind=0.0.0.0\n```\n\n- mha-node\u3067\u3082`consul agent -server `\u8d77\u52d5\n\n```\nmkdir /var/lib/consul /etc/consul\nvim /etc/consul/mysql.json\nconsul agent -server -dc=mha -node=`hostname` -config-dir=/etc/consul -data-dir=/var/lib/consul -bind=0.0.0.0 -client=127.0.0.1 -join=192.168.151.110\n```\n\n``` /etc/consul/mysql.json\n{\n\t\"service\": {\n\t\t\"name\": \"mysql\",\n\t\t\"tags\": [\"mysql\"],\n\t\t\"port\": 3306,\n\t\t\"check\": {\n\t\t\t\"script\": \"mysql -u haproxy -h 127.0.0.1 -P 3306 -e 'select 1' >/dev/null 2>&1\",\n\t\t\t\"interval\": \"5s\"\n\t\t}\n\t}\n}\n```\n\n- mha-manager\u306b`master_ip_failover_script`,`master_ip_online_change_script`\u3092\u4ed5\u8fbc\u3080\n\n```\nvim /var/lib/mha/master_ip_failover_script.sh\nvim /var/lib/mha/master_ip_online_change_script.sh\nchmod 700 /var/lib/mha/master_ip_failover_script.sh\nchmod 700 /var/lib/mha/master_ip_online_change_script.sh\nvim /etc/mha.conf\n```\n\n``` /var/lib/mha/master_ip_failover_script.sh\n#!/bin/bash -u\n\nOPT=$(getopt -q -o a -l command:,ssh_user:,orig_master_host:,orig_master_ip:,orig_master_port:,new_master_host:,new_master_ip:,new_master_port:,new_master_user:,new_master_password: -- \"$@\")\nif [ $? -ne 0 ]; then\n  exit 1\nfi\n\neval set -- \"$OPT\"\nMODE=none\nNEW_IP=0.0.0.0\nNEW_PORT=0\n\nwhile true\ndo\n\tcase \"$1\" in\n\t--command)\n\t\tif [ \"$2\" == \"start\" ]; then\n\t\t\tMODE=$2\n\t\telif [ \"$2\" == \"status\" ]; then\n\t\t\texit 0\n\t\telif [ \"$2\" == \"stop\" -o \"$2\" == \"stopssh\" ]; then\n\t\t\texit 0\n\t\telse\n\t\t\texit 0\n\t\tfi\n\t\tshift 2\n\t\t;;\n\t--new_master_ip)\n\t\tif [ $MODE == \"start\" ]; then\n\t\t\tNEW_IP=$2\n\t\tfi\n\t\tshift 2\n\t\t;;\n\t--new_master_port)\n\t\tif [ $MODE == \"start\" ]; then\n\t\t\tNEW_PORT=$2\n\t\tfi\n\t\tshift 2\n\t\t;;\n\t--)\n\t\tshift\n\t\tbreak\n\t\t;;\n\t*)\n\t\tshift\n\t\t;;\n\tesac\ndone\n\ncase \"$MODE\" in\nstart)\n\t# \u65b0\u30de\u30b9\u30bf\u30fc\u767b\u9332\u51e6\u7406\n\tcurl -q -XPUT -d \"${NEW_IP}\" http://127.0.0.1:8500/v1/kv/service/mha/ip\n\tcurl -q -XPUT -d \"${NEW_PORT}\" http://127.0.0.1:8500/v1/kv/service/mha/port\n\texit 0\n\t;;\n*)\n\texit 0\n\t;;\nesac\n```\n\n``` /var/lib/mha/master_ip_online_change_script.sh\n#!/bin/bash -u\n\nOPT=$(getopt -o a -l command:,orig_master_host:,orig_master_ip:,orig_master_port:,orig_master_user:,orig_master_ssh_user:,orig_master_password:,new_master_host:,new_master_ip:,new_master_port:,new_master_user:,new_master_password:,new_master_ssh_user:,orig_master_ssh_port:,new_master_ssh_port:,orig_master_is_new_slave -- \"$@\")\nif [ $? -ne 0 ]; then\n  echo $OPT\n  exit 1\nfi\n\neval set -- \"$OPT\"\nMODE=none\nNEW_IP=0.0.0.0\nNEW_PORT=0\n\nwhile true\ndo\n\tcase \"$1\" in\n\t--command)\n\t\tif [ \"$2\" == \"start\" ]; then\n\t\t\tMODE=$2\n\t\telif [ \"$2\" == \"stop\" -o \"$2\" == \"stopssh\" ]; then\n\t\t\texit 0\n\t\telse\n\t\t\texit 0\n\t\tfi\n\t\tshift 2\n\t\t;;\n\t--new_master_ip)\n\t\tif [ $MODE == \"start\" ]; then\n\t\t\tNEW_IP=$2\n\t\tfi\n\t\tshift 2\n\t\t;;\n\t--new_master_port)\n\t\tif [ $MODE == \"start\" ]; then\n\t\t\tNEW_PORT=$2\n\t\tfi\n\t\tshift 2\n\t\t;;\n\t--)\n\t\tshift\n\t\tbreak\n\t\t;;\n\t*)\n\t\tshift\n\t\t;;\n\tesac\ndone\n\ncase \"$MODE\" in\nstart)\n\tcurl -q -XPUT -d \"${NEW_IP}\" http://127.0.0.1:8500/v1/kv/service/mha/ip\n\tcurl -q -XPUT -d \"${NEW_PORT}\" http://127.0.0.1:8500/v1/kv/service/mha/port\n\texit 0\n\t;;\n*)\n\texit 0\n\t;;\nesac\n```\n\n\u203b `master_ip_failover_script.sh` \u3060\u3051\u3067\u5341\u5206\u306a\u6c17\u304c\u3059\u308b\u3002\u4f55\u3067\u5206\u3051\u305f\u304b\u306f\u5fd8\u308c\u305f\u306e\u3067\u305d\u306e\u307e\u307e\u3002\n\n``` /etc/mha.conf\n[server default]\nuser=mha\npassword=mhapassword\nmanager_workdir=/var/lib/mha\nmanager_log=/var/log/mha.log\nremote_workdir=/var/lib/mha\nrepl_user=repl\nrepl_password=replipass\nssh_user=root\nssh_port=22\nmaster_ip_failover_script=/var/lib/mha/master_ip_failover_script.sh\nmaster_ip_online_change_script=/var/lib/mha/master_ip_online_change_script.sh\n\n[server1]\nhostname=192.168.151.101\n[server2]\nhostname=192.168.151.102\n[server3]\nhostname=192.168.151.103\n```\n\n- mha-manager\u518d\u8d77\u52d5\n\n```\nmasterha_manager --conf=/etc/mha.conf --ignore_last_failover\n```\n\n- consul\u306ekvs\u306b\u30de\u30b9\u30bf\u30fc\u306e\u60c5\u5831\u3092\u521d\u56de\u767b\u9332\u3059\u308b\n\n```\ncurl -XPUT -d '192.168.151.101' http://127.0.0.1:8500/v1/kv/service/mha/ip\ncurl -XPUT -d '3306' http://127.0.0.1:8500/v1/kv/service/mha/port\n```\n\n- app-server\u306bhaproxy\u3044\u308c\u308b\n\n```\nyum install haproxy\nvim /etc/haproxy/haproxy.cfg\nservice haproxy start\nchkconfig haproxy on\n```\n\n``` /etc/haproxy/haproxy.cfg\nglobal\n\tlog\t\t127.0.0.1 local2\n\tchroot\t\t/var/lib/haproxy\n\tpidfile\t\t/var/run/haproxy.pid\n\tmaxconn\t\t10000\n\tuser\t\thaproxy\n\tgroup\t\thaproxy\n\tdaemon\n\tstats socket\t/var/lib/haproxy/stats\n\ndefaults\n\tmode\t\ttcp\n\tlog\t\tglobal\n\toption\t\ttcplog\n\tretries\t\t3\n\ttimeout connect\t10s\n\ttimeout client\t1m\n\ttimeout server\t1m\n```\n\n- app-server\u3067`consul agent`\u3092\u8d77\u52d5\n\n```\nconsul agent -dc=mha -node=`hostname` -data-dir=/var/lib/consul -bind=0.0.0.0 -client=127.0.0.1 -join=192.168.151.110\n```\n\n- app-server\u306b`consul-template`\u3092\u5165\u308c\u3066\u52d5\u304b\u3059\n\n```\ncd /usr/local/src/\nwget https://github.com/hashicorp/consul-template/releases/download/v0.10.0/consul-template_0.10.0_linux_amd64.tar.gz\ntar xvzf consul-template_0.10.0_linux_amd64.tar.gz\nmv consul-template_0.10.0_linux_amd64/consul-template /usr/local/bin/\nchown root: /usr/local/bin/consul-template\nvim /etc/haproxy/haproxy.cfg.ctmpl\nconsul-template -consul=127.0.0.1:8500 -template=/etc/haproxy/haproxy.cfg.ctmpl:/etc/haproxy/haproxy.cfg:\"service haproxy reload\"\n```\n\n``` /etc/haproxy/haproxy.cfg.ctmpl\nglobal\n\tlog\t\t127.0.0.1 local2\n\tchroot\t\t/var/lib/haproxy\n\tpidfile\t\t/var/run/haproxy.pid\n\tmaxconn\t\t10000\n\tuser\t\thaproxy\n\tgroup\t\thaproxy\n\tdaemon\n\tstats socket\t/var/lib/haproxy/stats\n\ndefaults\n\tmode\t\ttcp\n\tlog\t\tglobal\n\toption\t\ttcplog\n\tretries\t\t3\n\ttimeout connect\t10s\n\ttimeout client\t1m\n\ttimeout server\t1m\n\nlisten mysql-master\n\tbind 127.0.0.1:3306\n\tmode tcp\n\toption mysql-check user haproxy\n\tserver master {{key \"service/mha/ip\"}}:{{key \"service/mha/port\"}} check port {{key \"service/mha/port\"}} inter 2000 fall 5\n\nlisten mysql-slave\n\tbind 127.0.0.1:3307\n\tmode tcp\n\toption mysql-check user haproxy\n\tbalance leastconn{{range service \"mysql\"}}\n\tserver {{.Node}} {{.Address}}:{{.Port}} check port {{.Port}} inter 2000 fall 5{{end}}\n```\n\n## \u5b8c\u6210\n\n- \u5404app-server\u306e`127.0.0.1:3306`\u304c\u30de\u30b9\u30bf\u30fc\u30ce\u30fc\u30c9\u306b\u63a5\u7d9a\u3057\u3001`127.0.0.1:3307`\u304cmysql-server\u5168\u3066\u306b\u5206\u6563\u3059\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\n- \u30de\u30b9\u30bf\u30fc\u304c\u843d\u3061\u308b\u3068\u5225\u30ce\u30fc\u30c9\u304c\u30de\u30b9\u30bf\u30fc\u306b\u6607\u683c\u3057\u3001haproxy\u3067\u306e\u632f\u308a\u5206\u3051\u5148\u3082\u5207\u308a\u66ff\u308f\u308b\n- \u30b9\u30ec\u30fc\u30d6\u304c\u6b62\u307e\u3063\u305f\u5834\u5408\u3001consul\u306e`status check`\u3067\u691c\u77e5\u3055\u308chaproxy\u304b\u3089\u5916\u308c\u308b\n- mha-manager\u306fSPOF\u3002\u3061\u3083\u3093\u3068\u76e3\u8996\u3057\u3066\u6c17\u3065\u3051\u308c\u3070\u3061\u3087\u3063\u3068\u3050\u3089\u3044\u6b62\u307e\u3063\u3066\u3082\u3044\u3044\u3068\u601d\u3063\u3066\u308b\u306e\u3067\u6c17\u306b\u3057\u306a\u3044\u3002(\u305d\u306e\u3046\u3061\u5197\u9577\u5316\u3059\u308b\u304b\u3082\n- `# masterha_master_switch --master_state=alive --conf=/etc/mha.conf --interactive=0 --orig_master_is_new_slave` \u3053\u306e\u30b3\u30de\u30f3\u30c9\u3067\u4e00\u77ac\u3067\u30de\u30b9\u30bf\u30fc\u5207\u308a\u66ff\u308f\u308b\n- centos7\u7cfb\u3067\u30827\u7cfb\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u4f7f\u3048\u3070\u3061\u3083\u3093\u3068\u52d5\u3044\u305f\n- `consul-haproxy`\u3068\u3044\u3046\u30ba\u30d0\u30ea\u306a\u3082\u306e\u304c\u3042\u308b\u304c\u4eca\u56de\u306f\u5fd8\u308c\u308b(\u3042\u3068\u304b\u3089\u6c17\u3065\u3044\u305f\n\t- http://blog.cloudpack.jp/2014/08/14/consul-haproxy-a-little-tips/\n\t- https://github.com/hashicorp/consul-haproxy\n\n", "tags": ["MHA", "haproxy", "MySQL", "consul"]}