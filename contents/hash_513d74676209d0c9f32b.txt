{"context": " More than 1 year has passed since last update.\u4ee5\u4e0b\u3092config/deploy/production.rb\u306b\u8ffd\u52a0\n\u5916\u90e8\u30b3\u30de\u30f3\u30c9\u306eawscli\u3068jq\u3092\u4f7f\u3046\u3068\u7c21\u5358\u306b\u304b\u3051\u305f\u306e\u3067\u6a2a\u7740\u3057\u3066\u3057\u307e\u3063\u305f.\n\n# \u5e38\u306b\u7acb\u3063\u3066\u308b\u30b5\u30fc\u30d0\nserver '10.0.1.120', :app, alias: 'web1'\nserver '10.0.1.121', :app, alias: 'web2'\n\n\ndef installed?(cmd)\n  `which #{cmd.to_s} > /dev/null; echo $?`.to_i.zero?\nend\n\nif installed?(:aws) && installed?(:jq)\n  instance_ids = `aws autoscaling describe-auto-scaling-instances | jq \".AutoScalingInstances[].InstanceId\"`.split(\"\\n\")\n  private_ips = `aws ec2 describe-instances --instance-ids #{instance_ids.join(' ')} | jq \".Reservations[].Instances[].PrivateIpAddress\"`.gsub('\"', '').split(\"\\n\")\n  private_ips.each do |ip|\n    # AWS API\u7d4c\u7531\u3067\u53d6\u5f97\u3057\u305f\u73fe\u5728\u7a3c\u50cd\u4e2dAutoScaling\u30b5\u30fc\u30d0\u306eip\u3092\u8ffd\u52a0\n    eval \"server '#{ip}', :app\"\n  end\nelse\n  puts '[ deploy to autoscaling servers skipped. ]'\n  puts 'awscli and jq required. For Mac OS X, try \"$ brew install awscli jq\"'\nend\n\n\u6d41\u308c\u3068\u3057\u3066\u306f\naws autoscaling describe-auto-scaling-instances\u3067\u73fe\u5728\u7a3c\u50cd\u4e2d\u306eAutoScaling\u30b5\u30fc\u30d0\u304c\u53d6\u308c\u308b.\njson\u3067\u7d50\u679c\u304c\u8fd4\u3063\u3066\u304f\u308b\u306e\u3067jq\u3092\u4f7f\u3063\u3066jq \".AutoScalingInstances[].InstanceId\"\u3068\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9ID\u3060\u3051\u3092\u7d5e\u308a\u8fbc\u3093\u3067\u53d6\u5f97.\n\u6b21\u306b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9ID\u3092\u5143\u306b\u3057\u3066aws ec2 describe-instances\u3067\u8a73\u7d30\u30c7\u30fc\u30bf\u3092\u5f97\u308b.\n\u540c\u3058\u304fAWS api\u306ejson\u7d50\u679c\u3092\u30d1\u30a4\u30d7\u306b\u6e21\u3057, jq \".Reservations[].Instances[].PrivateIpAddress\"\u3067\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8IP\u30a2\u30c9\u30ec\u30b9\u3092\u5f97\u308b. \u3053\u306e\u3068\u304d\u30c0\u30d6\u30eb\u30af\u30aa\u30fc\u30c8\u3092\u542b\u3093\u3060\"10.0.1.200\"\u306e\u3088\u3046\u306a\u6587\u5b57\u5217\u304c\u8fd4\u3063\u3066\u304f\u308b\u306e\u3067gsub\u3067\u9664\u53bb.\n\u6700\u5f8c\u306b\u5f97\u3089\u308c\u305fip addr\u3092main\u4e2d\u3067eval\u3059\u308b\u3068\u3044\u3046\u884c\u5100\u306e\u60aa\u3044\u3053\u3068\u3092\u3084\u3063\u3066\u308b\u304c, Capistrano\u7d14\u6b63\u306e\u6a5f\u80fd\u3067\u52d5\u7684\u306b\u30b5\u30fc\u30d0\u8ffd\u52a0\u3067\u304d\u308b\u306a\u3089\u305d\u3046\u3057\u305f\u3044.\n\n\u4ee5\u4e0b\u3092`config/deploy/production.rb`\u306b\u8ffd\u52a0\n\n\u5916\u90e8\u30b3\u30de\u30f3\u30c9\u306eawscli\u3068jq\u3092\u4f7f\u3046\u3068\u7c21\u5358\u306b\u304b\u3051\u305f\u306e\u3067\u6a2a\u7740\u3057\u3066\u3057\u307e\u3063\u305f.\n\n`````ruby\n\n# \u5e38\u306b\u7acb\u3063\u3066\u308b\u30b5\u30fc\u30d0\nserver '10.0.1.120', :app, alias: 'web1'\nserver '10.0.1.121', :app, alias: 'web2'\n\n\ndef installed?(cmd)\n  `which #{cmd.to_s} > /dev/null; echo $?`.to_i.zero?\nend\n\nif installed?(:aws) && installed?(:jq)\n  instance_ids = `aws autoscaling describe-auto-scaling-instances | jq \".AutoScalingInstances[].InstanceId\"`.split(\"\\n\")\n  private_ips = `aws ec2 describe-instances --instance-ids #{instance_ids.join(' ')} | jq \".Reservations[].Instances[].PrivateIpAddress\"`.gsub('\"', '').split(\"\\n\")\n  private_ips.each do |ip|\n    # AWS API\u7d4c\u7531\u3067\u53d6\u5f97\u3057\u305f\u73fe\u5728\u7a3c\u50cd\u4e2dAutoScaling\u30b5\u30fc\u30d0\u306eip\u3092\u8ffd\u52a0\n    eval \"server '#{ip}', :app\"\n  end\nelse\n  puts '[ deploy to autoscaling servers skipped. ]'\n  puts 'awscli and jq required. For Mac OS X, try \"$ brew install awscli jq\"'\nend\n`````\n\n\n\u6d41\u308c\u3068\u3057\u3066\u306f\n\n`aws autoscaling describe-auto-scaling-instances`\u3067\u73fe\u5728\u7a3c\u50cd\u4e2d\u306eAutoScaling\u30b5\u30fc\u30d0\u304c\u53d6\u308c\u308b.\n\njson\u3067\u7d50\u679c\u304c\u8fd4\u3063\u3066\u304f\u308b\u306e\u3067jq\u3092\u4f7f\u3063\u3066`jq \".AutoScalingInstances[].InstanceId\"`\u3068\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9ID\u3060\u3051\u3092\u7d5e\u308a\u8fbc\u3093\u3067\u53d6\u5f97.\n\n\u6b21\u306b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9ID\u3092\u5143\u306b\u3057\u3066`aws ec2 describe-instances`\u3067\u8a73\u7d30\u30c7\u30fc\u30bf\u3092\u5f97\u308b.\n\n\u540c\u3058\u304fAWS api\u306ejson\u7d50\u679c\u3092\u30d1\u30a4\u30d7\u306b\u6e21\u3057, `jq \".Reservations[].Instances[].PrivateIpAddress\"`\u3067\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8IP\u30a2\u30c9\u30ec\u30b9\u3092\u5f97\u308b. \u3053\u306e\u3068\u304d\u30c0\u30d6\u30eb\u30af\u30aa\u30fc\u30c8\u3092\u542b\u3093\u3060`\"10.0.1.200\"`\u306e\u3088\u3046\u306a\u6587\u5b57\u5217\u304c\u8fd4\u3063\u3066\u304f\u308b\u306e\u3067gsub\u3067\u9664\u53bb.\n\n\u6700\u5f8c\u306b\u5f97\u3089\u308c\u305fip addr\u3092main\u4e2d\u3067eval\u3059\u308b\u3068\u3044\u3046\u884c\u5100\u306e\u60aa\u3044\u3053\u3068\u3092\u3084\u3063\u3066\u308b\u304c, Capistrano\u7d14\u6b63\u306e\u6a5f\u80fd\u3067\u52d5\u7684\u306b\u30b5\u30fc\u30d0\u8ffd\u52a0\u3067\u304d\u308b\u306a\u3089\u305d\u3046\u3057\u305f\u3044.\n", "tags": ["jq", "Ruby", "AWS", "capistrano"]}