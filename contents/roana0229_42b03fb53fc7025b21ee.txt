{"context": " More than 1 year has passed since last update.\n\ngithub\u306e\u30d7\u30eb\u30ea\u30af\n\u3069\u3046\u3057\u305f\u3082\u3093\u304b\u3068\u89e3\u6c7a\u7b56\u3092\u63a2\u3057\u3066\u3044\u305f\u3068\u3053\u308d\u3001\u30d7\u30eb\u30ea\u30af\u306b\u3042\u308a\u307e\u3057\u305f\u306e\u3067\u307e\u3068\u3081\u305f\u3082\u306e\u3067\u3059\u3002\n\nhttps://github.com/fnichol/chef-rbenv/issues/98\nhttps://github.com/fnichol/chef-rbenv/issues/107\n\n\nVagrantfile,Berksfile\u306e\u5185\u5bb9\n\ncentos6.5 - 64bit\u3092\u4f7f\u7528\u3057\u3066\u3044\u307e\u3059\u3002\n\n# -*- mode: ruby -*-\n# vi: set ft=ruby :\n\nVagrant.configure(2) do |config|\n  # \u500b\u4eba\u3067\u597d\u304d\u306a\u3088\u3046\u306b\n  config.vm.box = \"vm_centos_6.5\"\n  config.vm.box_url = \"http://developer.nrel.gov/downloads/vagrant-boxes/CentOS-6.5-x86_64-v20140504.box\"\n\n  # Omnibus\n  config.omnibus.chef_version = :latest\n\n  # Chef\n  config.vm.provision \"chef_solo\" do |chef|\n    chef.cookbooks_path = [\"../cookbooks\", \"../site-cookbooks\"]\n    chef.run_list = [\n      \"ruby_build\",\n      \"rbenv::system\"\n    ]\n\n    chef.json = {\n      \"rbenv\" => {\n        \"global\" => \"2.2.1\",\n        \"rubies\" => [ \"2.2.1\" ],\n        \"gems\" => {\n          \"2.2.1\" => [\n            { \"name\" => \"bundler\" }\n          ]\n        }\n      }\n    }\n  end\n\nend\n\n\nsource \"https://api.berkshelf.com\"\n\ncookbook 'ruby_build'\ncookbook 'rbenv', :git => 'https://github.com/muskox/chef-rbenv'\n\n\u3053\u3093\u306a\u611f\u3058\u306e\u8a2d\u5b9a\u3067vagrant up\u3059\u308b\u3068\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3059\u3002\nchef\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u306b\u3088\u308a\u767a\u751f\u3057\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\n\n\u30a8\u30e9\u30fc\u3068\u89e3\u6c7a\u7b562\u3064(A,B)\n\nNoMethodError undefined method `rbenv_rehash'\n\nerror.log\n==> default: [2015-04-07T21:18:15+00:00] INFO: Building rbenv_ruby[2.2.1] (system), this could take a while...\n==> default: [2015-04-07T21:22:38+00:00] INFO: script[rbenv install 2.2.1 (system)] ran successfully\n==> default: [2015-04-07T21:22:38+00:00] INFO: script[rbenv global 2.2.1 (system)] ran successfully\n==> default: \n==> default: ================================================================================\n==> default: Error executing action `install` on resource 'rbenv_gem[2.2.1::bundler] (system)'\n==> default: ================================================================================\n==> default: \n==> default: \n==> default: NoMethodError\n==> default: -------------\n==> default: undefined method `rbenv_rehash' for #<Chef::Provider::Package::RbenvRubygems:0x000000089f8280>\n==> default: \n==> default: \n==> default: Cookbook Trace:\n==> default: ---------------\n==> default: \n==> default: /tmp/vagrant-chef/2901d75c86b5ccba09402efe1b2d9b8a/cookbooks/rbenv/libraries/chef_provider_package_rbenvrubygems.rb:89:in `rehash'\n==> default: /tmp/vagrant-chef/2901d75c86b5ccba09402efe1b2d9b8a/cookbooks/rbenv/libraries/chef_provider_package_rbenvrubygems.rb:69:in `install_package'\n==> default: \n==> default: Resource Declaration:\n==> default: ---------------------\n==> default: # In /tmp/vagrant-chef/2901d75c86b5ccba09402efe1b2d9b8a/cookbooks/rbenv/recipes/system.rb\n==> default: \n==> default:  46:     rbenv_gem gem['name'] do\n==> default:  47:       rbenv_version rubie\n==> default:  48: \n==> default:  49:       %w{version action options source}.each do |attr|\n==> default:  50:         send(attr, gem[attr]) if gem[attr]\n==> default:  51:       end\n==> default:  52:     end\n==> default:  53:   end\n==> default: \n==> default: Compiled Resource:\n==> default: ------------------\n==> default: # Declared in /tmp/vagrant-chef/2901d75c86b5ccba09402efe1b2d9b8a/cookbooks/rbenv/recipes/system.rb:46:in `block (2 levels) in from_file'\n==> default: \n==> default: rbenv_gem(\"bundler\") do\n==> default:   provider Chef::Provider::Package::RbenvRubygems\n==> default:   action :install\n==> default:   retries 0\n==> default:   retry_delay 2\n==> default:   default_guard_interpreter :default\n==> default:   declared_type :rbenv_gem\n==> default:   cookbook_name :rbenv\n==> default:   recipe_name \"system\"\n==> default:   rbenv_version \"2.2.1\"\n==> default:   package_name \"bundler\"\n==> default:   gem_binary \"export RBENV_ROOT=\\\"/usr/local/rbenv\\\" && export PATH=\\\"$RBENV_ROOT/bin:$RBENV_ROOT/shims:$PATH\\\" && export RBENV_VERSION=\\\"2.2.1\\\" && $RBENV_ROOT/shims/gem\"\n==> default:   version \"1.9.2\"\n==> default: end\n==> default: \n==> default: \n==> default: [2015-04-07T21:22:43+00:00] INFO: Running queued delayed notifications before re-raising exception\n==> default: [2015-04-07T21:22:43+00:00] ERROR: Running exception handlers\n==> default: [2015-04-07T21:22:43+00:00] ERROR: Exception handlers complete\n==> default: [2015-04-07T21:22:43+00:00] FATAL: Stacktrace dumped to /var/chef/cache/chef-stacktrace.out\n==> default: [2015-04-07T21:22:43+00:00] ERROR: rbenv_gem[2.2.1::bundler] (system) (rbenv::system line 46) had an error: NoMethodError: undefined method `rbenv_rehash' for #<Chef::Provider::Package::RbenvRubygems:0x000000089f8280>\n==> default: [2015-04-07T21:22:43+00:00] FATAL: Chef::Exceptions::ChildConvergeError: Chef run process exited unsuccessfully (exit code 1)\n\n\n\nA.cookbook\u306erbenv\u3092\u4fee\u6b63\u3059\u308b\n\ncookbooks/rbenv/libraries/chef_provider_package_rbenvrubygems.rb\n### \u8ffd\u8a18\nrequire 'etc'\n###\n\nclass Chef\n  module Rbenv\n  ...\n  end\n\n  class Provider\n    class Package\n      class RbenvRubygems < Chef::Provider::Package::Rubygems\n\n        ...\n\n        def install_package(name, version)\n          # super\n          ### \u5143\u306e\u547c\u3073\u51fa\u3057\u3092\u30b3\u30e1\u30f3\u30c8\u5316\u3057\u3066\u3001\u8ffd\u8a18\n          run_as_user(rbenv_user) { super }\n          ###\n          rehash\n          true\n        end\n\n        def remove_package(name, version)\n          # super\n          ### \u5143\u306e\u547c\u3073\u51fa\u3057\u3092\u30b3\u30e1\u30f3\u30c8\u5316\u3057\u3066\u3001\u8ffd\u8a18\n          run_as_user(rbenv_user) { super }\n          ###\n          rehash\n          true\n        end\n\n        ...\n\n        # def rehash\n        #   rbenv_rehash new_resource do\n        #     root_path rbenv_root\n        #     user rbenv_user if rbenv_user\n        #     action :nothing\n        #   end.run_action(:run)\n        # end\n\n        ### \u5143\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u30b3\u30e1\u30f3\u30c8\u5316\u3057\u3066\u3001\u8ffd\u8a18\n        def rehash\n          e = ::Chef::Resource::RbenvRehash.new(new_resource.name, @run_context)\n          e.root_path rbenv_root\n          e.user rbenv_user if rbenv_user\n          e.action :nothing\n          e.run_action(:run)\n        end\n        ###\n\n      end\n    end\n  end\nend\n\n\n\n\ncookbooks/rbenv/libraries/chef_rbenv_script_helpers.rb\nclass Chef\n  module Rbenv\n    module ScriptHelpers\n\n      ...\n\n      ### \u8ffd\u8a18\n      def run_as_user(username, &block)\n        if username\n          user = Etc.getpwnam(username)\n          Process.fork do\n            Process.uid = user.uid\n            block.call\n          end\n          Process.wait\n        else\n          block.call\n        end\n      end\n      ###\n\n    end\n  end\nend\n\n\n\n\nB.chef\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u4e0b\u3052\u308b\n# config.omnibus.chef_version = :latest\nconfig.omnibus.chef_version = \"11.18.6\"\n\n\n## github\u306e\u30d7\u30eb\u30ea\u30af\n\n\u3069\u3046\u3057\u305f\u3082\u3093\u304b\u3068\u89e3\u6c7a\u7b56\u3092\u63a2\u3057\u3066\u3044\u305f\u3068\u3053\u308d\u3001\u30d7\u30eb\u30ea\u30af\u306b\u3042\u308a\u307e\u3057\u305f\u306e\u3067\u307e\u3068\u3081\u305f\u3082\u306e\u3067\u3059\u3002\n\n* https://github.com/fnichol/chef-rbenv/issues/98\n* https://github.com/fnichol/chef-rbenv/issues/107\n\n## Vagrantfile,Berksfile\u306e\u5185\u5bb9\n\n* centos6.5 - 64bit\u3092\u4f7f\u7528\u3057\u3066\u3044\u307e\u3059\u3002\n\n```Vagrantfile\n# -*- mode: ruby -*-\n# vi: set ft=ruby :\n\nVagrant.configure(2) do |config|\n  # \u500b\u4eba\u3067\u597d\u304d\u306a\u3088\u3046\u306b\n  config.vm.box = \"vm_centos_6.5\"\n  config.vm.box_url = \"http://developer.nrel.gov/downloads/vagrant-boxes/CentOS-6.5-x86_64-v20140504.box\"\n\n  # Omnibus\n  config.omnibus.chef_version = :latest\n\n  # Chef\n  config.vm.provision \"chef_solo\" do |chef|\n    chef.cookbooks_path = [\"../cookbooks\", \"../site-cookbooks\"]\n    chef.run_list = [\n      \"ruby_build\",\n      \"rbenv::system\"\n    ]\n\n    chef.json = {\n      \"rbenv\" => {\n        \"global\" => \"2.2.1\",\n        \"rubies\" => [ \"2.2.1\" ],\n        \"gems\" => {\n          \"2.2.1\" => [\n            { \"name\" => \"bundler\" }\n          ]\n        }\n      }\n    }\n  end\n\nend\n\n```\n\n```Berksfile\nsource \"https://api.berkshelf.com\"\n\ncookbook 'ruby_build'\ncookbook 'rbenv', :git => 'https://github.com/muskox/chef-rbenv'\n```\n\n\u3053\u3093\u306a\u611f\u3058\u306e\u8a2d\u5b9a\u3067`vagrant up`\u3059\u308b\u3068\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3059\u3002\nchef\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u306b\u3088\u308a\u767a\u751f\u3057\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\n\n## \u30a8\u30e9\u30fc\u3068\u89e3\u6c7a\u7b562\u3064(A,B)\n\n### NoMethodError undefined method `rbenv_rehash'\n\n\n```error.log\n==> default: [2015-04-07T21:18:15+00:00] INFO: Building rbenv_ruby[2.2.1] (system), this could take a while...\n==> default: [2015-04-07T21:22:38+00:00] INFO: script[rbenv install 2.2.1 (system)] ran successfully\n==> default: [2015-04-07T21:22:38+00:00] INFO: script[rbenv global 2.2.1 (system)] ran successfully\n==> default: \n==> default: ================================================================================\n==> default: Error executing action `install` on resource 'rbenv_gem[2.2.1::bundler] (system)'\n==> default: ================================================================================\n==> default: \n==> default: \n==> default: NoMethodError\n==> default: -------------\n==> default: undefined method `rbenv_rehash' for #<Chef::Provider::Package::RbenvRubygems:0x000000089f8280>\n==> default: \n==> default: \n==> default: Cookbook Trace:\n==> default: ---------------\n==> default: \n==> default: /tmp/vagrant-chef/2901d75c86b5ccba09402efe1b2d9b8a/cookbooks/rbenv/libraries/chef_provider_package_rbenvrubygems.rb:89:in `rehash'\n==> default: /tmp/vagrant-chef/2901d75c86b5ccba09402efe1b2d9b8a/cookbooks/rbenv/libraries/chef_provider_package_rbenvrubygems.rb:69:in `install_package'\n==> default: \n==> default: Resource Declaration:\n==> default: ---------------------\n==> default: # In /tmp/vagrant-chef/2901d75c86b5ccba09402efe1b2d9b8a/cookbooks/rbenv/recipes/system.rb\n==> default: \n==> default:  46:     rbenv_gem gem['name'] do\n==> default:  47:       rbenv_version rubie\n==> default:  48: \n==> default:  49:       %w{version action options source}.each do |attr|\n==> default:  50:         send(attr, gem[attr]) if gem[attr]\n==> default:  51:       end\n==> default:  52:     end\n==> default:  53:   end\n==> default: \n==> default: Compiled Resource:\n==> default: ------------------\n==> default: # Declared in /tmp/vagrant-chef/2901d75c86b5ccba09402efe1b2d9b8a/cookbooks/rbenv/recipes/system.rb:46:in `block (2 levels) in from_file'\n==> default: \n==> default: rbenv_gem(\"bundler\") do\n==> default:   provider Chef::Provider::Package::RbenvRubygems\n==> default:   action :install\n==> default:   retries 0\n==> default:   retry_delay 2\n==> default:   default_guard_interpreter :default\n==> default:   declared_type :rbenv_gem\n==> default:   cookbook_name :rbenv\n==> default:   recipe_name \"system\"\n==> default:   rbenv_version \"2.2.1\"\n==> default:   package_name \"bundler\"\n==> default:   gem_binary \"export RBENV_ROOT=\\\"/usr/local/rbenv\\\" && export PATH=\\\"$RBENV_ROOT/bin:$RBENV_ROOT/shims:$PATH\\\" && export RBENV_VERSION=\\\"2.2.1\\\" && $RBENV_ROOT/shims/gem\"\n==> default:   version \"1.9.2\"\n==> default: end\n==> default: \n==> default: \n==> default: [2015-04-07T21:22:43+00:00] INFO: Running queued delayed notifications before re-raising exception\n==> default: [2015-04-07T21:22:43+00:00] ERROR: Running exception handlers\n==> default: [2015-04-07T21:22:43+00:00] ERROR: Exception handlers complete\n==> default: [2015-04-07T21:22:43+00:00] FATAL: Stacktrace dumped to /var/chef/cache/chef-stacktrace.out\n==> default: [2015-04-07T21:22:43+00:00] ERROR: rbenv_gem[2.2.1::bundler] (system) (rbenv::system line 46) had an error: NoMethodError: undefined method `rbenv_rehash' for #<Chef::Provider::Package::RbenvRubygems:0x000000089f8280>\n==> default: [2015-04-07T21:22:43+00:00] FATAL: Chef::Exceptions::ChildConvergeError: Chef run process exited unsuccessfully (exit code 1)\n```\n\n\n### A.cookbook\u306erbenv\u3092\u4fee\u6b63\u3059\u308b\n\n```cookbooks/rbenv/libraries/chef_provider_package_rbenvrubygems.rb\n### \u8ffd\u8a18\nrequire 'etc'\n###\n\nclass Chef\n  module Rbenv\n  ...\n  end\n\n  class Provider\n    class Package\n      class RbenvRubygems < Chef::Provider::Package::Rubygems\n      \n        ...\n        \n        def install_package(name, version)\n          # super\n          ### \u5143\u306e\u547c\u3073\u51fa\u3057\u3092\u30b3\u30e1\u30f3\u30c8\u5316\u3057\u3066\u3001\u8ffd\u8a18\n          run_as_user(rbenv_user) { super }\n          ###\n          rehash\n          true\n        end\n\n        def remove_package(name, version)\n          # super\n          ### \u5143\u306e\u547c\u3073\u51fa\u3057\u3092\u30b3\u30e1\u30f3\u30c8\u5316\u3057\u3066\u3001\u8ffd\u8a18\n          run_as_user(rbenv_user) { super }\n          ###\n          rehash\n          true\n        end\n        \n        ...\n\n        # def rehash\n        #   rbenv_rehash new_resource do\n        #     root_path rbenv_root\n        #     user rbenv_user if rbenv_user\n        #     action :nothing\n        #   end.run_action(:run)\n        # end\n        \n        ### \u5143\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u30b3\u30e1\u30f3\u30c8\u5316\u3057\u3066\u3001\u8ffd\u8a18\n        def rehash\n          e = ::Chef::Resource::RbenvRehash.new(new_resource.name, @run_context)\n          e.root_path rbenv_root\n          e.user rbenv_user if rbenv_user\n          e.action :nothing\n          e.run_action(:run)\n        end\n        ###\n        \n      end\n    end\n  end\nend\n\n```\n\n```cookbooks/rbenv/libraries/chef_rbenv_script_helpers.rb\nclass Chef\n  module Rbenv\n    module ScriptHelpers\n    \n      ...\n\n      ### \u8ffd\u8a18\n      def run_as_user(username, &block)\n        if username\n          user = Etc.getpwnam(username)\n          Process.fork do\n            Process.uid = user.uid\n            block.call\n          end\n          Process.wait\n        else\n          block.call\n        end\n      end\n      ###\n      \n    end\n  end\nend\n\n```\n\n### B.chef\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u4e0b\u3052\u308b\n\n```\n# config.omnibus.chef_version = :latest\nconfig.omnibus.chef_version = \"11.18.6\"\n```\n", "tags": ["chef", "rbenv", "Gem", "vagrant"]}