{"context": " More than 1 year has passed since last update.\n\n0. \u306f\u3058\u3081\u306b\n\u524d\u56de\u306f\u3001\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u306b\u3064\u3044\u3066\u8aac\u660e\u3057\u307e\u3057\u305f\u3002\n\u4eca\u56de\u306f\u3001\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u3066\u8d77\u52d5\u6e08\u306e elasticsearch\u306b\u30c7\u30fc\u30bf\u3092\u6295\u5165\u3057\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n0.1 \u51e6\u7406\u6982\u8981\nHTTP\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u3092Powershell\u3092\u4f7f\u3063\u3066Elasticsearch\u306b\u30a4\u30f3\u30dd\u30fc\u30c8\u3057\u307e\u3059\u3002\n\u30c7\u30fc\u30bf\u3092\u6295\u5165\u3059\u308b\u65b9\u6cd5\u306f\u3001cURL\u3092\u4f7f\u7528\u3059\u308b\u65b9\u6cd5\u304c\u3088\u304f\u77e5\u3089\u308c\u3066\u3044\u307e\u3059\u304c\u3001\u4eca\u56de\u4f7f\u7528\u3059\u308b\u30ed\u30b0\u306f\u3001\u4e00\u65e6\u3001Key-Value\u578b\u3067\u5207\u308a\u51fa\u3057\u305f\u5f8c\u306b\u30c7\u30fc\u30bf\u6295\u5165\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u306e\u3067\u3001Powershell\u3092\u4f7f\u3063\u3066\u30ed\u30b0\u306e\u5207\u308a\u51fa\u3057\u3068\u30a4\u30f3\u30dd\u30fc\u30c8\u306e\u4e21\u65b9\u3092\u4e00\u5ea6\u306b\u5b9f\u65bd\u3059\u308b\u3053\u3068\u306b\u3057\u307e\u3059\u3002\n\u6295\u5165\u3059\u308b\u30ed\u30b0\u306f\u624b\u6301\u3061\u306e\u3082\u306e\u3067\u3082\u304b\u307e\u308f\u306a\u3044\u306e\u3067\u3059\u304c\u3001\u3069\u3046\u3044\u3046\u3053\u3068\u304c\u3067\u304d\u308b\u306e\u304b\u3092\u308f\u304b\u308a\u3084\u3059\u304f\u8aac\u660e\u3059\u308b\u305f\u3081\u306b\u516c\u958b\u3055\u308c\u3066\u3044\u3066\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u53ef\u80fd\u306a\u30ed\u30b0\u3092\u304a\u8a66\u3057\u89e3\u6790\u7528\u3068\u3057\u3066\u4f7f\u7528\u3057\u307e\u3059\u3002\n\n0.2 Elasticsearch\u3067\u62bc\u3055\u3048\u3066\u304a\u304f\u3079\u304d\u7528\u8a9e\uff08Windows\u30ed\u30fc\u30ab\u30eb\u74b0\u5883\u3067\u4f7f\u7528\u3059\u308b\u5834\u5408\uff09\nDBMS\u3067\u305f\u3068\u3048\u308b\u306a\u3089\u3070\n\ndatabase\u304cindex\ntable\u304ctype\n\u5404\u30ab\u30e9\u30e0\u306e\u578b\u5b9a\u7fa9\u304cmapping\n\n\u306b\u5bfe\u5fdc\u3057\u307e\u3059\u304c\u3001\u7269\u7406\u7684\u306b\u306f\u3001\u3072\u3068\u3064\u306eindex\u306b\u5bfe\u3057\u3066\u3072\u3068\u3064\u306e\u30d5\u30a9\u30eb\u30c0\u304c\u4f5c\u6210\u3055\u308c\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u7b49\u3092\u30a4\u30f3\u30dd\u30fc\u30c8\u3059\u308b\u3068\u30c7\u30fc\u30bf\u306f\u3059\u3079\u3066\u305d\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u5185\u306b\u683c\u7d0d\u3055\u308c\u307e\u3059\u3002\n\u3072\u3068\u3064\u306eindex\u306b\u306f\u8907\u6570\u306etype\u3092\u4f5c\u6210\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u304c\u3001\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u306e\u89e3\u6790\u306a\u3069\u3067\u306f\u3072\u3068\u3064\u306eindex\u306b\u5bfe\u3057\u3066\u3072\u3068\u3064\u306etype\u3092\u4f5c\u6210\u3059\u308c\u3070\u3044\u3044\u306e\u3067\u306f\u306a\u3044\u304b\u3068\u601d\u3044\u307e\u3059\u3002\n\u5c1a\u3001Kibana\u306e\u89e3\u6790\u5358\u4f4d\u306f\u3001index\u5358\u4f4d\u306b\u306a\u308a\u307e\u3059\u3002\n\n1\uff0e\u304a\u8a66\u3057\u89e3\u6790\u7528\u30ed\u30b0\u6e96\u5099 epa-http.log\n\u304a\u8a66\u3057\u89e3\u6790\u7528\u30ed\u30b0\u3068\u3057\u3066\u4ee5\u4e0b\u30b5\u30a4\u30c8\u3067\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u53ef\u80fd\u306aHTTP\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\uff08\u7c73\u56fd\u306e\u516c\u7684\u6a5f\u95a2\u304c\u63d0\u4f9b\u3057\u3066\u3044\u308b\u30ed\u30b0\u3067\u3059\uff09\nThe Internet Traffic Archive\nhttp://ita.ee.lbl.gov/html/contrib/EPA-HTTP.html\n\u4e0b\u90e8\u3001Distribution\u306b\u3042\u308b\u300ccompressed ASCII\u300d\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068\u5727\u7e2e\u3055\u308c\u305f\u30ed\u30b0\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3067\u304d\u307e\u3059\u3002\n\u89e3\u51cd\u3057\u3066\u9069\u5f53\u306a\u30d5\u30a9\u30eb\u30c0\u306b\u683c\u7d0d\u3057\u3066\u304f\u3060\u3055\u3044\u3002\uff08\u62e1\u5f35\u5b50\u304c\".Z\"\u3067OS\u6a19\u6e96\u306e\u30c4\u30fc\u30eb\u3067\u306f\u89e3\u51cd\u3067\u304d\u306a\u3044\u3068\u601d\u3044\u307e\u3059\u306e\u3067\u9069\u5f53\u306a\u30c4\u30fc\u30eb\u3092\u4f7f\u7528\u3057\u3066\u89e3\u51cd\u3057\u3066\u304f\u3060\u3055\u3044\uff09\n\u683c\u7d0d\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\n\uff08\u4f8b\uff09C:\\work\\logs\n\u30d5\u30a1\u30a4\u30eb\u540d\uff08\u4f5c\u6210\u3057\u305f\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u90fd\u5408\u4e0a\u3001\u62e1\u5f35\u5b50\u3092\".log\"\u306b\u5909\u66f4\u3057\u3066\u304f\u3060\u3055\u3044\uff09\n\uff08\u4f8b\uff09epa-http.log\n\n2. \u30ed\u30b0\u306e\u30d1\u30fc\u30b5\u6e96\u5099 EpaHttpParser.psml\n\u30ed\u30b0\u3092\u30d5\u30a3\u30fc\u30eb\u30c9\u5358\u4f4d\u306b\u5207\u308a\u51fa\u3059\u30d1\u30fc\u30b5\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002Powershell\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u3068\u3057\u3066\u914d\u7f6e\u3057\u3066\u304a\u304f\u3068Elasticsearch\u3060\u3051\u3067\u306a\u304fMongoDB\u3084\u305d\u306e\u4ed6\u3001Key-Value\u578b\u306e\u30c7\u30fc\u30bf\u3092\u5fc5\u8981\u3068\u3059\u308b\u3068\u304d\u306b\u30e1\u30a4\u30f3\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u304b\u3089\u547c\u3073\u51fa\u305b\u3070\u4f7f\u7528\u3067\u304d\u308b\u306e\u3067\u4fbf\u5229\u3067\u3059\u3002\n\u4f5c\u6210\u3057\u305f\u30b9\u30af\u30ea\u30d7\u30c8\u306f\u4ee5\u4e0b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u914d\u7f6e\u3057\u307e\u3059\u3002\uff08\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304c\u306a\u3044\u5834\u5408\u306f\u4f5c\u6210\u304c\u5fc5\u8981\uff09\nC:\\Users\\<\u30e6\u30fc\u30b6\u540d>\\Documents\\WindowsPowerShell\\Modules\\EpaHttpLogParser\\EpaHttpLogParser.psml\n\nEpaHttpLogParser.psm1\n\n\nfunction Read-ApacheLog\n{\n    param(\n        [Parameter(Mandatory=$true)]\n        [string]\n        $Path\n    )\n    # \u30d5\u30a1\u30a4\u30eb\u540d\n    $file_name = Split-Path $Path -Leaf\n    # \u30d5\u30a1\u30a4\u30eb\u884c\u6570\n    $file_num = (Get-Content $Path | Measure-Object).count\n    # \u8aad\u307f\u8fbc\u307f\u884c\u6570\n    $read_num = 0\n    Write-host \"\u30d5\u30a1\u30a4\u30eb\u540d:`t\" $Path\n    Write-host \"\u30d5\u30a1\u30a4\u30eb\u884c\u6570:`t\" $file_num\n\n    Get-Content -Path $Path | Foreach-Object {\n        if ($_ -match (\"^(?<Host>.*?) \\[(?<TimeString>.*?)\\] `\"(?<Method>.*?) (?<Path>.*?) (?<Version>.*?)`\" (?<Status>.*?) (?<BytesSent>.*?)$\") -or ($_ -match \"^(?<Host>.*?) \\[(?<TimeString>.*?)\\] `\"(?<Method>.*?) (?<Path>.*?)`\" (?<Status>.*?) (?<BytesSent>.*?)$\")) {\n            $entry = $matches\n            $entryDateTime = \"1995:08:\" + $entry.TimeString\n            $entry.Time = [DateTime]::ParseExact($entryDateTime, \"yyyy:MM:dd:HH:mm:ss\", [System.Globalization.CultureInfo]::InvariantCulture)\n            #### \u4e00\u822c\u7684\u306aApache\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u306e\u65e5\u4ed8\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u7528\n            #### $entry.Time = [DateTime]::ParseExact($entry.TimeString, \"dd/MMM/yyyy:HH:mm:ss zzz\", [System.Globalization.CultureInfo]::InvariantCulture)\n\n            # \u30ed\u30b0\u8aad\u8fbc\u9032\u6357\u30d7\u30ed\u30b0\u30ec\u30b9\u30d0\u30fc\u7528\n            $read_num ++\n            # \u9032\u6357\u306e\u30d1\u30fc\u30bb\u30f3\u30c6\u30fc\u30b8\u3092\u6c42\u3081\u308b\n            $p = $read_num / $file_num * 100\n            # \u30d7\u30ed\u30b0\u30ec\u30b9\u30d0\u30fc\u3092\u8868\u793a\u3000500\u884c\u6bce\u306b\u66f4\u65b0\n            if(($read_num % 500) -eq 0){\n                Write-Progress \"reading... $file_name : $file_num lines\" ($p.Tostring(\"#.\") + \"%\") -percentComplete $p\n            }\n            return New-Object PSObject -Property $entry\n        }else{\n            # \u60f3\u5b9a\u3057\u305f\u30ed\u30b0\u306e\u30d1\u30bf\u30fc\u30f3\u306bmatch\u3057\u306a\u3044\u6642\u306f\u3001\u30ed\u30b0\u3092\u53d6\u308a\u8fbc\u307e\u305a\u306b\u305d\u306e\u5185\u5bb9\u3092\u51fa\u529b\u3059\u308b\n            Write-Host \"Invalid requests: $_\" -ForeGroundColor Red\n        }\n    }\n}\n\n\n\u88dc\u8db3\n\u30ed\u30b0\u3092\u898b\u3066\u3082\u3089\u3046\u3068\u308f\u304b\u308b\u306e\u3067\u3059\u304c\u6a19\u6e96\u7684\u306aApache\u30ed\u30b0\u3068\u306f\u5c11\u3057\u5f62\u5f0f\u304c\u7570\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\u4eca\u56de\u4f7f\u7528\u3057\u305f\u30ed\u30b0\u3092\u5207\u308a\u51fa\u3057\u305f\u3044\u30d5\u30a3\u30fc\u30eb\u30c9\u5358\u4f4d\u3067\u5206\u985e\u3059\u308b\u3068\u4ee5\u4e0b\u306e3\u30d1\u30bf\u30fc\u30f3\u304c\u3042\u308a\u307e\u3057\u305f\u3002\n\n\u30d1\u30bf\u30fc\u30f31. \u3059\u3079\u3066\u306e\u30d5\u30a3\u30fc\u30eb\u30c9\u304c\u3042\u308b\n141.243.1.172 [29:23:53:25] \"GET /Software.html HTTP/1.0\" 200 1497\n\u30d1\u30bf\u30fc\u30f32. Version(HTTP/1.0\u90e8\u5206)\u306e\u60c5\u5831\u304c\u306a\u3044\nsandy.rtptok1.epa.gov [30:10:48:24] \"GET /OWOW/PubList/\" 200 1933\n\u30d1\u30bf\u30fc\u30f33. Version\u3001Method(PUT\u3001GET\u7b49)\u306e\u60c5\u5831\u304c\u306a\u3044\nwillard-ibmpc12.cac-labs.psu.edu [30:15:17:12] \"cons/circle_logo_small.gif\" 400 -\n\n\n\u4eca\u56de\u4f5c\u6210\u3057\u305f\u30d1\u30fc\u30b5\u30fc\u3067\u306f\u3001\u30d1\u30bf\u30fc\u30f31\u3068\u30d1\u30bf\u30fc\u30f32\u3092\u53d6\u308a\u8fbc\u3093\u3067\u30d1\u30bf\u30fc\u30f33\u306f\"Invalid requests\"\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u51fa\u529b\u3057\u3066\u30b9\u30ad\u30c3\u30d7\u3059\u308b\u3088\u3046\u306b\u3057\u307e\u3057\u305f\u3002\n\u3053\u306e\u8fba\u306f\u3001\u4f7f\u7528\u7528\u9014\u306b\u5408\u308f\u305b\u3066\u4f5c\u6210\u3059\u308c\u3070\u826f\u3044\u3068\u601d\u3044\u307e\u3059\u304c\u3001\u60f3\u5b9a\u30d1\u30bf\u30fc\u30f3\u306b\u30de\u30c3\u30c1\u3057\u306a\u3044\u884c\u306f\u6642\u3005\u767a\u751f\u3059\u308b\u53ef\u80fd\u6027\u304c\u3042\u308b\u306e\u3067\u305d\u306e\u884c\u304c\u3069\u306e\u3088\u3046\u306a\u5185\u5bb9\u306a\u306e\u304b\u51fa\u529b\u3059\u308b\u51e6\u7406\u3092\u5165\u308c\u3066\u304a\u304f\u3068\u4fbf\u5229\u3060\u3068\u601d\u3044\u307e\u3059\u3002  \n\u65e5\u4ed8\u306f\"\u5e74\u6708\"\u90e8\u5206\u304c\u7701\u7565\u3055\u308c\u3066\u307e\u3059\u306e\u3067\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u30b5\u30a4\u30c8\u306b\u8a18\u8f09\u3055\u308c\u3066\u3044\u308b\u60c5\u5831\uff081995\u5e748\u6708\uff09\u3092\u4ed8\u52a0\u3057\u307e\u3057\u305f\u3002\u5c1a\u3001\u30ed\u30b0\u306e\u30bf\u30a4\u30e0\u30be\u30fc\u30f3\u306fEDT\uff08\u6771\u90e8\u590f\u6642\u9593\uff09\u3067\u3059\u304c\u3001\u308f\u304b\u308a\u3084\u3059\u304f\u3059\u308b\u305f\u3081\u306bJST+9\u3067\u53d6\u308a\u8fbc\u3080\u3064\u304f\u308a\u306b\u3057\u307e\u3057\u305f\u3002\n\u30d1\u30fc\u30b5\u306e\u4f5c\u6210\u306b\u95a2\u3057\u3066\u306f\u4ee5\u4e0b\u30b5\u30a4\u30c8\u3092\u53c2\u8003\u306b\u4f5c\u6210\u3057\u307e\u3057\u305f\u3002\nd.sunnyone.org\nPowerShell\u3067Apache\u306e\u30ed\u30b0\u3092\u96c6\u8a08\u3059\u308b\nhttp://d.sunnyone.org/2012/12/powershellapache_15.html\n\n3. \u30c7\u30fc\u30bf\u6295\u5165\u7528\u30e1\u30a4\u30f3\u30b9\u30af\u30ea\u30d7\u30c8\u6e96\u5099 EPA-HTTP_log_to_ES.ps1\n\u30c7\u30fc\u30bf\u6295\u5165\u306f\u8a66\u884c\u932f\u8aa4\u306e\u7d50\u679c\u306a\u306e\u3067\u30d9\u30b9\u30c8\u306a\u65b9\u6cd5\u304b\u3069\u3046\u304b\u306f\u81ea\u4fe1\u304c\u3042\u308a\u307e\u305b\u3093\u304c\u3001\u3068\u308a\u3042\u3048\u305a\u601d\u3044\u901a\u308a\u306e\u30de\u30c3\u30d4\u30f3\u30b0\u3067\u30c7\u30fc\u30bf\u3092\u6295\u5165\u3067\u304d\u307e\u3057\u305f\u3002\n\nEPA-HTTP_log_to_ES.ps1\n# Paser\u8ffd\u52a0\nImport-Module EpaHttpLogParser -force\n[void][Reflection.Assembly]::LoadWithPartialName(\"System.Web.Extensions\")\n\n$ESEndPoint = \"http://localhost:9200\"\n$indexname = \"epa-http_log_index\"\n$typename = \"epa-http_log_type\"\n\n$indexedEndpoint = $ESEndPoint + \"/\" + $indexname + \"/\" + $typename\n$webClient = new-object System.net.WebClient\n\n# \u30ed\u30b0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u8a2d\u5b9a\n# \u4e0b\u8a18\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u5185\u306b\u5b58\u5728\u3059\u308b\u62e1\u5f35\u5b50\".log\"\u306e\u30d5\u30a1\u30a4\u30eb\u304c\u51e6\u7406\u5bfe\u8c61\u306b\u306a\u308a\u307e\u3059\n$files_path = \"C:\\work\\logs\\\"\n\n$files = Get-ChildItem -Path $files_path -Recurse | where {$_.Extension -eq \".log\"}\nWrite-host \"\u2193\u2193\u2193 \u5bfe\u8c61\u30d5\u30a1\u30a4\u30eb\u4e00\u89a7 \u2193\u2193\u2193\"\n$files | %{\n    $_.fullname\n}\nWrite-host \"\u2191\u2191\u2191 \u5bfe\u8c61\u30d5\u30a1\u30a4\u30eb\u4e00\u89a7 \u2191\u2191\u2191\"\n\n# \u51e6\u7406\u6642\u9593\u8a08\u6e2c\u958b\u59cb\n$sw = New-Object System.Diagnostics.StopWatch\n$sw.Start()\n\n# \u30d5\u30a1\u30a4\u30eb\u8aad\u307f\u8fbc\u307f\u958b\u59cb\n$files | %{\n    # document\u6570\u30ab\u30a6\u30f3\u30bf\u30fc\u521d\u671f\u5316\n    $doc_num = 0\n\n    # \u30d1\u30fc\u30b5\u30fc\u547c\u3073\u51fa\u3057\n    Read-ApacheLog $_.fullname | %{\n        # Elasticserch\u306b\u6295\u5165\u3059\u308b\u30c7\u30fc\u30bf\u3092\u683c\u7d0d\u3059\u308b\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u4f5c\u6210\n        $metrics = new-object 'System.Collections.Generic.Dictionary[string,object]'\n        # \u5404\u30d5\u30a3\u30fc\u30eb\u30c9\u306eKey\u3068Value\u3092\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306b\u8ffd\u52a0\u3059\u308b\n        # Remote host\n        $metrics.Add(\"host\", $_.Host)\n        # Time the request was received \u203b\u308f\u304b\u308a\u3084\u3059\u3044\u3088\u3046\u306b\u65e5\u672c\u6642\u9593\u3068\u3057\u3066\u30c7\u30fc\u30bf\u8ffd\u52a0\u3059\u308b\n        $metrics.Add(\"@timestamp\", ($_.Time.ToString(\"yyyy-MM-ddTHH:mm:ss+09:00\")))\n        # Request method\n        $metrics.Add(\"method\", $_.Method)\n        # Request URI\n        $metrics.Add(\"uri\", $_.Path)\n        # Status code\n        $metrics.Add(\"status\", $_.Status)\n        # Size of response in bytes \u203bint\u578b\u306e\u6570\u5024\u3068\u3057\u3066\u6295\u5165\u3059\u308b\u3068Number\u578b\u306bMapping\u3055\u308c\u308b\n        $metrics.Add(\"size\", ($_.ByteSent -as [int]))\n\n        $serializedMetric = new-object System.Text.StringBuilder\n        $javaScriptSerializer = new-object System.Web.Script.Serialization.JavaScriptSerializer\n        $javaScriptSerializer.Serialize($metrics, $serializedMetric);\n\n        [void]$webClient.UploadString($indexedEndpoint, $serializedMetric.ToString())\n\n        # \u51e6\u7406\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u6570\n        $doc_num ++\n    }\n    Write-host \"\u51e6\u7406\u30d5\u30a1\u30a4\u30eb\uff1a`t\" $_.name\n    Write-host \"\u51e6\u7406\u884c\u6570\uff1a`t\" $doc_num\n    $sum_doc_num += $doc_num\n}\n# \u51e6\u7406\u6642\u9593\u8a08\u6e2c\u505c\u6b62\n$sw.Stop()\nWrite-host \"\u6240\u8981\u6642\u9593\uff1a`t\" $sw.Elapsed.ToString()\nWrite-host \"\u7dcf\u51e6\u7406\u884c\u6570\uff1a`t\" $sum_doc_num\n\n\n\u6570\u5024\u3068\u3057\u3066\u30c7\u30fc\u30bf\u30bb\u30c3\u30c8\u3059\u308b\u3068number\u578b\u3067mapping\u3055\u308c\u3001\u5408\u8a08\u3001\u5e73\u5747\u3001\u6700\u5927\u6700\u5c0f\u5024\u7b49\u3092\u6c42\u3081\u308b\u3053\u3068\u304c\u53ef\u80fd\u3068\u306a\u308a\u307e\u3059\u3002\u4eca\u56de\u306f\u30ec\u30b9\u30dd\u30f3\u30b9\u30b5\u30a4\u30ba\u306e\u5024\u3092number\u578b\u3001\u6642\u523b\u3092date\u578b\u3001\u305d\u306e\u4ed6\u306fstring\u578b\u306bmapping\u3057\u307e\u3057\u305f\u3002\n\u3053\u3046\u3044\u3063\u305f\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u4f5c\u6210\u3057\u305f\u3068\u304d\u306b\u3042\u308a\u304c\u3061\u306a\u53d6\u308a\u8fbc\u307f\u3082\u308c\u306b\u6c17\u3065\u304f\u3088\u3046\u306b\u6700\u4f4e\u9650\u306e\u30c1\u30a7\u30c3\u30af\uff08\u51e6\u7406\u884c\u6570\u306e\u30c1\u30a7\u30c3\u30af\uff09\u3092\u5165\u308c\u3066\u3044\u307e\u3059\u3002\u307e\u305f\u3001\u5927\u91cf\u30ed\u30b0\u3092\u51e6\u7406\u3059\u308b\u3068\u304d\u306b\u304b\u304b\u308b\u6642\u9593\u3092\u898b\u7a4d\u3082\u308c\u308b\u3088\u3046\u306b\u51e6\u7406\u6642\u9593\u306e\u8a08\u6e2c\u51e6\u7406\u3082\u5165\u308c\u3066\u3044\u307e\u3059\u3002\n\u30c7\u30fc\u30bf\u6295\u5165\u306b\u95a2\u3057\u3066\u306f\u4ee5\u4e0b\u30b5\u30a4\u30c8\u3092\u53c2\u8003\u306b\u4f5c\u6210\u3057\u307e\u3057\u305f\u3002\nREADY.\nElastic Search: Pushing data into Elastic Search from Windows PowerShell\nhttp://thereadyprompt.blogspot.jp/2014/01/eleastic-search-pushing-data-into.html\n\n4. PowerShell \u30b9\u30af\u30ea\u30d7\u30c8\u5b9f\u884c\n\n4-1\uff0ePowerShell\u30b3\u30f3\u30bd\u30fc\u30eb\u8d77\u52d5\n\u306f\u3058\u3081\u3066PowerShell\u3092\u5b9f\u884c\u3059\u308b\u5834\u5408\u306f\u7ba1\u7406\u8005\u3067\u30b3\u30f3\u30bd\u30fc\u30eb\u3092\u8d77\u52d5\u3057\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306b\u3057\u3066\u5b9f\u884c\u30dd\u30ea\u30b7\u30fc\u306e\u5909\u66f4\u304c\u5fc5\u8981\u3067\u3059\u3002\nSet-ExecutionPolicy RemoteSigned\n<\u53c2\u8003\u30b5\u30a4\u30c8>Windows\u7ba1\u7406\u8005\u306e\u305f\u3081\u306ePowerShell\nhttp://powershell.wiki.fc2.com/wiki/PowerShell%E3%81%AE%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95\n\n4-2\uff0e\u30b9\u30af\u30ea\u30d7\u30c8\u5b9f\u884c\nPS> EPA-HTTP_log_to_ES.ps1\n\n4-3\uff0e\u30c7\u30fc\u30bf\u6295\u5165\u78ba\u8a8d\nPS C:\\work\\scripts> .\\EPA-HTTP_log_to_ES.ps1\n\u2193\u2193\u2193 \u5bfe\u8c61\u30d5\u30a1\u30a4\u30eb\u4e00\u89a7 \u2193\u2193\u2193\nC:\\work\\logs\\epa-http.log\n\u2191\u2191\u2191 \u5bfe\u8c61\u30d5\u30a1\u30a4\u30eb\u4e00\u89a7 \u2191\u2191\u2191\n\u30d5\u30a1\u30a4\u30eb\u540d:      C:\\work\\logs\\epa-http.log\n\u30d5\u30a1\u30a4\u30eb\u884c\u6570:    47748\nInvalid requests: willard-ibmpc12.cac-labs.psu.edu [30:15:17:12] \"cons/circle_logo_small.gif\" 400 -\nInvalid requests: willard-ibmpc12.cac-labs.psu.edu [30:15:17:13] \"cons/book.gif\" 400 -\nInvalid requests: willard-ibmpc12.cac-labs.psu.edu [30:15:17:13] \"ogos/small_gopher.gif\" 400 -\nInvalid requests: willard-ibmpc12.cac-labs.psu.edu [30:15:17:13] \"ogos/small_ftp.gif\" 400 -\nInvalid requests: willard-ibmpc12.cac-labs.psu.edu [30:15:17:13] \"ogos/us-flag.gif\" 400 -\nInvalid requests: willard-ibmpc12.cac-labs.psu.edu [30:15:17:13] \"cons/ok2-0.gif\" 400 -\n\u51e6\u7406\u30d5\u30a1\u30a4\u30eb\uff1a   epa-http.log\n\u51e6\u7406\u884c\u6570\uff1a       47742\n\u6240\u8981\u6642\u9593\uff1a       00:01:27.2963457\n\u7dcf\u51e6\u7406\u884c\u6570\uff1a     47742\n\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u306e\u7dcf\u884c\u6570\u304c47748\u884c\u3067\u3053\u306e\u51856\u884c\u3092Invalid requests\u3068\u3057\u3066\u30b9\u30ad\u30c3\u30d7\u3057\u3066\u5dee\u5f1547742\u884c\u3092Elasticsearch\u306b\u30a4\u30f3\u30dd\u30fc\u30c8\u51fa\u6765\u307e\u3057\u305f\u3002\n\u3053\u308c\u3067\u30ed\u30b0\u306e\u6295\u5165\u306f\u5b8c\u4e86\u3067\u3059\u3002\n\u6b21\u56de\u306f\u3001\u3053\u306eindex\u3092Kibana\u3067\u53c2\u7167\u3057\u3066\u307f\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n#0. \u306f\u3058\u3081\u306b\n[\u524d\u56de](http://qiita.com/Aco-gt/items/ad351387c1ab3ad2561f)\u306f\u3001\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u306b\u3064\u3044\u3066\u8aac\u660e\u3057\u307e\u3057\u305f\u3002\n\u4eca\u56de\u306f\u3001\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u3066\u8d77\u52d5\u6e08\u306e elasticsearch\u306b\u30c7\u30fc\u30bf\u3092\u6295\u5165\u3057\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n##0.1 \u51e6\u7406\u6982\u8981\nHTTP\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u3092Powershell\u3092\u4f7f\u3063\u3066Elasticsearch\u306b\u30a4\u30f3\u30dd\u30fc\u30c8\u3057\u307e\u3059\u3002\n\u30c7\u30fc\u30bf\u3092\u6295\u5165\u3059\u308b\u65b9\u6cd5\u306f\u3001cURL\u3092\u4f7f\u7528\u3059\u308b\u65b9\u6cd5\u304c\u3088\u304f\u77e5\u3089\u308c\u3066\u3044\u307e\u3059\u304c\u3001\u4eca\u56de\u4f7f\u7528\u3059\u308b\u30ed\u30b0\u306f\u3001\u4e00\u65e6\u3001Key-Value\u578b\u3067\u5207\u308a\u51fa\u3057\u305f\u5f8c\u306b\u30c7\u30fc\u30bf\u6295\u5165\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u306e\u3067\u3001Powershell\u3092\u4f7f\u3063\u3066\u30ed\u30b0\u306e\u5207\u308a\u51fa\u3057\u3068\u30a4\u30f3\u30dd\u30fc\u30c8\u306e\u4e21\u65b9\u3092\u4e00\u5ea6\u306b\u5b9f\u65bd\u3059\u308b\u3053\u3068\u306b\u3057\u307e\u3059\u3002\n\u6295\u5165\u3059\u308b\u30ed\u30b0\u306f\u624b\u6301\u3061\u306e\u3082\u306e\u3067\u3082\u304b\u307e\u308f\u306a\u3044\u306e\u3067\u3059\u304c\u3001\u3069\u3046\u3044\u3046\u3053\u3068\u304c\u3067\u304d\u308b\u306e\u304b\u3092\u308f\u304b\u308a\u3084\u3059\u304f\u8aac\u660e\u3059\u308b\u305f\u3081\u306b\u516c\u958b\u3055\u308c\u3066\u3044\u3066\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u53ef\u80fd\u306a\u30ed\u30b0\u3092\u304a\u8a66\u3057\u89e3\u6790\u7528\u3068\u3057\u3066\u4f7f\u7528\u3057\u307e\u3059\u3002\n##0.2 Elasticsearch\u3067\u62bc\u3055\u3048\u3066\u304a\u304f\u3079\u304d\u7528\u8a9e\uff08Windows\u30ed\u30fc\u30ab\u30eb\u74b0\u5883\u3067\u4f7f\u7528\u3059\u308b\u5834\u5408\uff09\nDBMS\u3067\u305f\u3068\u3048\u308b\u306a\u3089\u3070\n\n* database\u304cindex\n* table\u304ctype\n* \u5404\u30ab\u30e9\u30e0\u306e\u578b\u5b9a\u7fa9\u304cmapping\n\n\u306b\u5bfe\u5fdc\u3057\u307e\u3059\u304c\u3001\u7269\u7406\u7684\u306b\u306f\u3001\u3072\u3068\u3064\u306eindex\u306b\u5bfe\u3057\u3066\u3072\u3068\u3064\u306e\u30d5\u30a9\u30eb\u30c0\u304c\u4f5c\u6210\u3055\u308c\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u7b49\u3092\u30a4\u30f3\u30dd\u30fc\u30c8\u3059\u308b\u3068\u30c7\u30fc\u30bf\u306f\u3059\u3079\u3066\u305d\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u5185\u306b\u683c\u7d0d\u3055\u308c\u307e\u3059\u3002\n\u3072\u3068\u3064\u306eindex\u306b\u306f\u8907\u6570\u306etype\u3092\u4f5c\u6210\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u304c\u3001\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u306e\u89e3\u6790\u306a\u3069\u3067\u306f\u3072\u3068\u3064\u306eindex\u306b\u5bfe\u3057\u3066\u3072\u3068\u3064\u306etype\u3092\u4f5c\u6210\u3059\u308c\u3070\u3044\u3044\u306e\u3067\u306f\u306a\u3044\u304b\u3068\u601d\u3044\u307e\u3059\u3002\n\u5c1a\u3001Kibana\u306e\u89e3\u6790\u5358\u4f4d\u306f\u3001index\u5358\u4f4d\u306b\u306a\u308a\u307e\u3059\u3002\n\n#1\uff0e\u304a\u8a66\u3057\u89e3\u6790\u7528\u30ed\u30b0\u6e96\u5099 epa-http.log\n\u304a\u8a66\u3057\u89e3\u6790\u7528\u30ed\u30b0\u3068\u3057\u3066\u4ee5\u4e0b\u30b5\u30a4\u30c8\u3067\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u53ef\u80fd\u306aHTTP\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\uff08\u7c73\u56fd\u306e\u516c\u7684\u6a5f\u95a2\u304c\u63d0\u4f9b\u3057\u3066\u3044\u308b\u30ed\u30b0\u3067\u3059\uff09\nThe Internet Traffic Archive\nhttp://ita.ee.lbl.gov/html/contrib/EPA-HTTP.html\n\u4e0b\u90e8\u3001Distribution\u306b\u3042\u308b\u300ccompressed ASCII\u300d\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068\u5727\u7e2e\u3055\u308c\u305f\u30ed\u30b0\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3067\u304d\u307e\u3059\u3002\n\u89e3\u51cd\u3057\u3066\u9069\u5f53\u306a\u30d5\u30a9\u30eb\u30c0\u306b\u683c\u7d0d\u3057\u3066\u304f\u3060\u3055\u3044\u3002\uff08\u62e1\u5f35\u5b50\u304c\".Z\"\u3067OS\u6a19\u6e96\u306e\u30c4\u30fc\u30eb\u3067\u306f\u89e3\u51cd\u3067\u304d\u306a\u3044\u3068\u601d\u3044\u307e\u3059\u306e\u3067\u9069\u5f53\u306a\u30c4\u30fc\u30eb\u3092\u4f7f\u7528\u3057\u3066\u89e3\u51cd\u3057\u3066\u304f\u3060\u3055\u3044\uff09\n\u683c\u7d0d\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\n\uff08\u4f8b\uff09C:\\work\\logs\n\u30d5\u30a1\u30a4\u30eb\u540d\uff08\u4f5c\u6210\u3057\u305f\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u90fd\u5408\u4e0a\u3001\u62e1\u5f35\u5b50\u3092\".log\"\u306b\u5909\u66f4\u3057\u3066\u304f\u3060\u3055\u3044\uff09\n\uff08\u4f8b\uff09epa-http.log\n\n#2. \u30ed\u30b0\u306e\u30d1\u30fc\u30b5\u6e96\u5099 EpaHttpParser.psml\n\u30ed\u30b0\u3092\u30d5\u30a3\u30fc\u30eb\u30c9\u5358\u4f4d\u306b\u5207\u308a\u51fa\u3059\u30d1\u30fc\u30b5\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002Powershell\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u3068\u3057\u3066\u914d\u7f6e\u3057\u3066\u304a\u304f\u3068Elasticsearch\u3060\u3051\u3067\u306a\u304fMongoDB\u3084\u305d\u306e\u4ed6\u3001Key-Value\u578b\u306e\u30c7\u30fc\u30bf\u3092\u5fc5\u8981\u3068\u3059\u308b\u3068\u304d\u306b\u30e1\u30a4\u30f3\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u304b\u3089\u547c\u3073\u51fa\u305b\u3070\u4f7f\u7528\u3067\u304d\u308b\u306e\u3067\u4fbf\u5229\u3067\u3059\u3002\n\u4f5c\u6210\u3057\u305f\u30b9\u30af\u30ea\u30d7\u30c8\u306f\u4ee5\u4e0b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u914d\u7f6e\u3057\u307e\u3059\u3002\uff08\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304c\u306a\u3044\u5834\u5408\u306f\u4f5c\u6210\u304c\u5fc5\u8981\uff09\nC:\\Users\\\\<\u30e6\u30fc\u30b6\u540d>\\Documents\\WindowsPowerShell\\Modules\\EpaHttpLogParser\\EpaHttpLogParser.psml\n\n```ps1:EpaHttpLogParser.psm1\n\n\nfunction Read-ApacheLog\n{\n\tparam(\n\t\t[Parameter(Mandatory=$true)]\n\t\t[string]\n\t\t$Path\n\t)\n\t# \u30d5\u30a1\u30a4\u30eb\u540d\n\t$file_name = Split-Path $Path -Leaf\n\t# \u30d5\u30a1\u30a4\u30eb\u884c\u6570\n\t$file_num = (Get-Content $Path | Measure-Object).count\n\t# \u8aad\u307f\u8fbc\u307f\u884c\u6570\n\t$read_num = 0\n\tWrite-host \"\u30d5\u30a1\u30a4\u30eb\u540d:`t\" $Path\n\tWrite-host \"\u30d5\u30a1\u30a4\u30eb\u884c\u6570:`t\" $file_num\n\t\n\tGet-Content -Path $Path | Foreach-Object {\n\t\tif ($_ -match (\"^(?<Host>.*?) \\[(?<TimeString>.*?)\\] `\"(?<Method>.*?) (?<Path>.*?) (?<Version>.*?)`\" (?<Status>.*?) (?<BytesSent>.*?)$\") -or ($_ -match \"^(?<Host>.*?) \\[(?<TimeString>.*?)\\] `\"(?<Method>.*?) (?<Path>.*?)`\" (?<Status>.*?) (?<BytesSent>.*?)$\")) {\n\t\t\t$entry = $matches\n\t\t\t$entryDateTime = \"1995:08:\" + $entry.TimeString\n\t\t\t$entry.Time = [DateTime]::ParseExact($entryDateTime, \"yyyy:MM:dd:HH:mm:ss\", [System.Globalization.CultureInfo]::InvariantCulture)\n\t\t\t#### \u4e00\u822c\u7684\u306aApache\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u306e\u65e5\u4ed8\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u7528\n\t\t\t#### $entry.Time = [DateTime]::ParseExact($entry.TimeString, \"dd/MMM/yyyy:HH:mm:ss zzz\", [System.Globalization.CultureInfo]::InvariantCulture)\n\t\t\n\t\t\t# \u30ed\u30b0\u8aad\u8fbc\u9032\u6357\u30d7\u30ed\u30b0\u30ec\u30b9\u30d0\u30fc\u7528\n\t\t\t$read_num ++\n\t\t\t# \u9032\u6357\u306e\u30d1\u30fc\u30bb\u30f3\u30c6\u30fc\u30b8\u3092\u6c42\u3081\u308b\n\t\t\t$p = $read_num / $file_num * 100\n\t\t\t# \u30d7\u30ed\u30b0\u30ec\u30b9\u30d0\u30fc\u3092\u8868\u793a\u3000500\u884c\u6bce\u306b\u66f4\u65b0\n\t\t\tif(($read_num % 500) -eq 0){\n\t\t\t\tWrite-Progress \"reading... $file_name : $file_num lines\" ($p.Tostring(\"#.\") + \"%\") -percentComplete $p\n\t\t\t}\n\t\t\treturn New-Object PSObject -Property $entry\n\t\t}else{\n\t\t\t# \u60f3\u5b9a\u3057\u305f\u30ed\u30b0\u306e\u30d1\u30bf\u30fc\u30f3\u306bmatch\u3057\u306a\u3044\u6642\u306f\u3001\u30ed\u30b0\u3092\u53d6\u308a\u8fbc\u307e\u305a\u306b\u305d\u306e\u5185\u5bb9\u3092\u51fa\u529b\u3059\u308b\n\t\t\tWrite-Host \"Invalid requests: $_\" -ForeGroundColor Red\n\t\t}\n\t}\n}\n```\n\u88dc\u8db3\n\u30ed\u30b0\u3092\u898b\u3066\u3082\u3089\u3046\u3068\u308f\u304b\u308b\u306e\u3067\u3059\u304c\u6a19\u6e96\u7684\u306aApache\u30ed\u30b0\u3068\u306f\u5c11\u3057\u5f62\u5f0f\u304c\u7570\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\u4eca\u56de\u4f7f\u7528\u3057\u305f\u30ed\u30b0\u3092\u5207\u308a\u51fa\u3057\u305f\u3044\u30d5\u30a3\u30fc\u30eb\u30c9\u5358\u4f4d\u3067\u5206\u985e\u3059\u308b\u3068\u4ee5\u4e0b\u306e3\u30d1\u30bf\u30fc\u30f3\u304c\u3042\u308a\u307e\u3057\u305f\u3002\n\n* \u30d1\u30bf\u30fc\u30f31. \u3059\u3079\u3066\u306e\u30d5\u30a3\u30fc\u30eb\u30c9\u304c\u3042\u308b  \n141.243.1.172 [29:23:53:25] \"GET /Software.html HTTP/1.0\" 200 1497\n* \u30d1\u30bf\u30fc\u30f32. Version(HTTP/1.0\u90e8\u5206)\u306e\u60c5\u5831\u304c\u306a\u3044  \nsandy.rtptok1.epa.gov [30:10:48:24] \"GET /OWOW/PubList/\" 200 1933\n* \u30d1\u30bf\u30fc\u30f33. Version\u3001Method(PUT\u3001GET\u7b49)\u306e\u60c5\u5831\u304c\u306a\u3044  \nwillard-ibmpc12.cac-labs.psu.edu [30:15:17:12] \"cons/circle_logo_small.gif\" 400 -  \n\n\u4eca\u56de\u4f5c\u6210\u3057\u305f\u30d1\u30fc\u30b5\u30fc\u3067\u306f\u3001\u30d1\u30bf\u30fc\u30f31\u3068\u30d1\u30bf\u30fc\u30f32\u3092\u53d6\u308a\u8fbc\u3093\u3067\u30d1\u30bf\u30fc\u30f33\u306f\"Invalid requests\"\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u51fa\u529b\u3057\u3066\u30b9\u30ad\u30c3\u30d7\u3059\u308b\u3088\u3046\u306b\u3057\u307e\u3057\u305f\u3002\n\u3053\u306e\u8fba\u306f\u3001\u4f7f\u7528\u7528\u9014\u306b\u5408\u308f\u305b\u3066\u4f5c\u6210\u3059\u308c\u3070\u826f\u3044\u3068\u601d\u3044\u307e\u3059\u304c\u3001\u60f3\u5b9a\u30d1\u30bf\u30fc\u30f3\u306b\u30de\u30c3\u30c1\u3057\u306a\u3044\u884c\u306f\u6642\u3005\u767a\u751f\u3059\u308b\u53ef\u80fd\u6027\u304c\u3042\u308b\u306e\u3067\u305d\u306e\u884c\u304c\u3069\u306e\u3088\u3046\u306a\u5185\u5bb9\u306a\u306e\u304b\u51fa\u529b\u3059\u308b\u51e6\u7406\u3092\u5165\u308c\u3066\u304a\u304f\u3068\u4fbf\u5229\u3060\u3068\u601d\u3044\u307e\u3059\u3002  \n\n\u65e5\u4ed8\u306f\"\u5e74\u6708\"\u90e8\u5206\u304c\u7701\u7565\u3055\u308c\u3066\u307e\u3059\u306e\u3067\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u30b5\u30a4\u30c8\u306b\u8a18\u8f09\u3055\u308c\u3066\u3044\u308b\u60c5\u5831\uff081995\u5e748\u6708\uff09\u3092\u4ed8\u52a0\u3057\u307e\u3057\u305f\u3002\u5c1a\u3001\u30ed\u30b0\u306e\u30bf\u30a4\u30e0\u30be\u30fc\u30f3\u306fEDT\uff08\u6771\u90e8\u590f\u6642\u9593\uff09\u3067\u3059\u304c\u3001\u308f\u304b\u308a\u3084\u3059\u304f\u3059\u308b\u305f\u3081\u306bJST+9\u3067\u53d6\u308a\u8fbc\u3080\u3064\u304f\u308a\u306b\u3057\u307e\u3057\u305f\u3002\n\n\u30d1\u30fc\u30b5\u306e\u4f5c\u6210\u306b\u95a2\u3057\u3066\u306f\u4ee5\u4e0b\u30b5\u30a4\u30c8\u3092\u53c2\u8003\u306b\u4f5c\u6210\u3057\u307e\u3057\u305f\u3002\nd.sunnyone.org\nPowerShell\u3067Apache\u306e\u30ed\u30b0\u3092\u96c6\u8a08\u3059\u308b\nhttp://d.sunnyone.org/2012/12/powershellapache_15.html\n\n#3. \u30c7\u30fc\u30bf\u6295\u5165\u7528\u30e1\u30a4\u30f3\u30b9\u30af\u30ea\u30d7\u30c8\u6e96\u5099 EPA-HTTP_log_to_ES.ps1\n\u30c7\u30fc\u30bf\u6295\u5165\u306f\u8a66\u884c\u932f\u8aa4\u306e\u7d50\u679c\u306a\u306e\u3067\u30d9\u30b9\u30c8\u306a\u65b9\u6cd5\u304b\u3069\u3046\u304b\u306f\u81ea\u4fe1\u304c\u3042\u308a\u307e\u305b\u3093\u304c\u3001\u3068\u308a\u3042\u3048\u305a\u601d\u3044\u901a\u308a\u306e\u30de\u30c3\u30d4\u30f3\u30b0\u3067\u30c7\u30fc\u30bf\u3092\u6295\u5165\u3067\u304d\u307e\u3057\u305f\u3002\n\n```ps1:EPA-HTTP_log_to_ES.ps1\n# Paser\u8ffd\u52a0\nImport-Module EpaHttpLogParser -force\n[void][Reflection.Assembly]::LoadWithPartialName(\"System.Web.Extensions\")\n\n$ESEndPoint = \"http://localhost:9200\"\n$indexname = \"epa-http_log_index\"\n$typename = \"epa-http_log_type\"\n\n$indexedEndpoint = $ESEndPoint + \"/\" + $indexname + \"/\" + $typename\n$webClient = new-object System.net.WebClient\n\n# \u30ed\u30b0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u8a2d\u5b9a\n# \u4e0b\u8a18\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u5185\u306b\u5b58\u5728\u3059\u308b\u62e1\u5f35\u5b50\".log\"\u306e\u30d5\u30a1\u30a4\u30eb\u304c\u51e6\u7406\u5bfe\u8c61\u306b\u306a\u308a\u307e\u3059\n$files_path = \"C:\\work\\logs\\\"\n\n$files = Get-ChildItem -Path $files_path -Recurse | where {$_.Extension -eq \".log\"}\nWrite-host \"\u2193\u2193\u2193 \u5bfe\u8c61\u30d5\u30a1\u30a4\u30eb\u4e00\u89a7 \u2193\u2193\u2193\"\n$files | %{\n\t$_.fullname\n}\nWrite-host \"\u2191\u2191\u2191 \u5bfe\u8c61\u30d5\u30a1\u30a4\u30eb\u4e00\u89a7 \u2191\u2191\u2191\"\n\n# \u51e6\u7406\u6642\u9593\u8a08\u6e2c\u958b\u59cb\n$sw = New-Object System.Diagnostics.StopWatch\n$sw.Start()\n\n# \u30d5\u30a1\u30a4\u30eb\u8aad\u307f\u8fbc\u307f\u958b\u59cb\n$files | %{\n\t# document\u6570\u30ab\u30a6\u30f3\u30bf\u30fc\u521d\u671f\u5316\n\t$doc_num = 0\n\t\n\t# \u30d1\u30fc\u30b5\u30fc\u547c\u3073\u51fa\u3057\n\tRead-ApacheLog $_.fullname | %{\n\t\t# Elasticserch\u306b\u6295\u5165\u3059\u308b\u30c7\u30fc\u30bf\u3092\u683c\u7d0d\u3059\u308b\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u4f5c\u6210\n\t\t$metrics = new-object 'System.Collections.Generic.Dictionary[string,object]'\n\t\t# \u5404\u30d5\u30a3\u30fc\u30eb\u30c9\u306eKey\u3068Value\u3092\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306b\u8ffd\u52a0\u3059\u308b\n\t\t# Remote host\n\t\t$metrics.Add(\"host\", $_.Host)\n\t\t# Time the request was received \u203b\u308f\u304b\u308a\u3084\u3059\u3044\u3088\u3046\u306b\u65e5\u672c\u6642\u9593\u3068\u3057\u3066\u30c7\u30fc\u30bf\u8ffd\u52a0\u3059\u308b\n\t\t$metrics.Add(\"@timestamp\", ($_.Time.ToString(\"yyyy-MM-ddTHH:mm:ss+09:00\")))\n\t\t# Request method\n\t\t$metrics.Add(\"method\", $_.Method)\n\t\t# Request URI\n\t\t$metrics.Add(\"uri\", $_.Path)\n\t\t# Status code\n\t\t$metrics.Add(\"status\", $_.Status)\n\t\t# Size of response in bytes \u203bint\u578b\u306e\u6570\u5024\u3068\u3057\u3066\u6295\u5165\u3059\u308b\u3068Number\u578b\u306bMapping\u3055\u308c\u308b\n\t\t$metrics.Add(\"size\", ($_.ByteSent -as [int]))\n\t\t\n\t\t$serializedMetric = new-object System.Text.StringBuilder\n\t\t$javaScriptSerializer = new-object System.Web.Script.Serialization.JavaScriptSerializer\n\t\t$javaScriptSerializer.Serialize($metrics, $serializedMetric);\n\t\t\n\t\t[void]$webClient.UploadString($indexedEndpoint, $serializedMetric.ToString())\n\t\t\n\t\t# \u51e6\u7406\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u6570\n\t\t$doc_num ++\n\t}\n\tWrite-host \"\u51e6\u7406\u30d5\u30a1\u30a4\u30eb\uff1a`t\" $_.name\n\tWrite-host \"\u51e6\u7406\u884c\u6570\uff1a`t\" $doc_num\n\t$sum_doc_num += $doc_num\n}\n# \u51e6\u7406\u6642\u9593\u8a08\u6e2c\u505c\u6b62\n$sw.Stop()\nWrite-host \"\u6240\u8981\u6642\u9593\uff1a`t\" $sw.Elapsed.ToString()\nWrite-host \"\u7dcf\u51e6\u7406\u884c\u6570\uff1a`t\" $sum_doc_num\n```\n\n\u6570\u5024\u3068\u3057\u3066\u30c7\u30fc\u30bf\u30bb\u30c3\u30c8\u3059\u308b\u3068number\u578b\u3067mapping\u3055\u308c\u3001\u5408\u8a08\u3001\u5e73\u5747\u3001\u6700\u5927\u6700\u5c0f\u5024\u7b49\u3092\u6c42\u3081\u308b\u3053\u3068\u304c\u53ef\u80fd\u3068\u306a\u308a\u307e\u3059\u3002\u4eca\u56de\u306f\u30ec\u30b9\u30dd\u30f3\u30b9\u30b5\u30a4\u30ba\u306e\u5024\u3092number\u578b\u3001\u6642\u523b\u3092date\u578b\u3001\u305d\u306e\u4ed6\u306fstring\u578b\u306bmapping\u3057\u307e\u3057\u305f\u3002\n\u3053\u3046\u3044\u3063\u305f\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u4f5c\u6210\u3057\u305f\u3068\u304d\u306b\u3042\u308a\u304c\u3061\u306a\u53d6\u308a\u8fbc\u307f\u3082\u308c\u306b\u6c17\u3065\u304f\u3088\u3046\u306b\u6700\u4f4e\u9650\u306e\u30c1\u30a7\u30c3\u30af\uff08\u51e6\u7406\u884c\u6570\u306e\u30c1\u30a7\u30c3\u30af\uff09\u3092\u5165\u308c\u3066\u3044\u307e\u3059\u3002\u307e\u305f\u3001\u5927\u91cf\u30ed\u30b0\u3092\u51e6\u7406\u3059\u308b\u3068\u304d\u306b\u304b\u304b\u308b\u6642\u9593\u3092\u898b\u7a4d\u3082\u308c\u308b\u3088\u3046\u306b\u51e6\u7406\u6642\u9593\u306e\u8a08\u6e2c\u51e6\u7406\u3082\u5165\u308c\u3066\u3044\u307e\u3059\u3002\n\n\u30c7\u30fc\u30bf\u6295\u5165\u306b\u95a2\u3057\u3066\u306f\u4ee5\u4e0b\u30b5\u30a4\u30c8\u3092\u53c2\u8003\u306b\u4f5c\u6210\u3057\u307e\u3057\u305f\u3002\nREADY.\nElastic Search: Pushing data into Elastic Search from Windows PowerShell\nhttp://thereadyprompt.blogspot.jp/2014/01/eleastic-search-pushing-data-into.html\n\n#4. PowerShell \u30b9\u30af\u30ea\u30d7\u30c8\u5b9f\u884c\n##4-1\uff0ePowerShell\u30b3\u30f3\u30bd\u30fc\u30eb\u8d77\u52d5\n\u306f\u3058\u3081\u3066PowerShell\u3092\u5b9f\u884c\u3059\u308b\u5834\u5408\u306f\u7ba1\u7406\u8005\u3067\u30b3\u30f3\u30bd\u30fc\u30eb\u3092\u8d77\u52d5\u3057\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306b\u3057\u3066\u5b9f\u884c\u30dd\u30ea\u30b7\u30fc\u306e\u5909\u66f4\u304c\u5fc5\u8981\u3067\u3059\u3002\nSet-ExecutionPolicy RemoteSigned\n\n<\u53c2\u8003\u30b5\u30a4\u30c8>Windows\u7ba1\u7406\u8005\u306e\u305f\u3081\u306ePowerShell\nhttp://powershell.wiki.fc2.com/wiki/PowerShell%E3%81%AE%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95\n\n##4-2\uff0e\u30b9\u30af\u30ea\u30d7\u30c8\u5b9f\u884c\nPS> EPA-HTTP_log_to_ES.ps1\n\n##4-3\uff0e\u30c7\u30fc\u30bf\u6295\u5165\u78ba\u8a8d\nPS C:\\work\\scripts> .\\EPA-HTTP_log_to_ES.ps1\n\u2193\u2193\u2193 \u5bfe\u8c61\u30d5\u30a1\u30a4\u30eb\u4e00\u89a7 \u2193\u2193\u2193\nC:\\work\\logs\\epa-http.log\n\u2191\u2191\u2191 \u5bfe\u8c61\u30d5\u30a1\u30a4\u30eb\u4e00\u89a7 \u2191\u2191\u2191\n\u30d5\u30a1\u30a4\u30eb\u540d:      C:\\work\\logs\\epa-http.log\n\u30d5\u30a1\u30a4\u30eb\u884c\u6570:    47748\nInvalid requests: willard-ibmpc12.cac-labs.psu.edu [30:15:17:12] \"cons/circle_logo_small.gif\" 400 -\nInvalid requests: willard-ibmpc12.cac-labs.psu.edu [30:15:17:13] \"cons/book.gif\" 400 -\nInvalid requests: willard-ibmpc12.cac-labs.psu.edu [30:15:17:13] \"ogos/small_gopher.gif\" 400 -\nInvalid requests: willard-ibmpc12.cac-labs.psu.edu [30:15:17:13] \"ogos/small_ftp.gif\" 400 -\nInvalid requests: willard-ibmpc12.cac-labs.psu.edu [30:15:17:13] \"ogos/us-flag.gif\" 400 -\nInvalid requests: willard-ibmpc12.cac-labs.psu.edu [30:15:17:13] \"cons/ok2-0.gif\" 400 -\n\u51e6\u7406\u30d5\u30a1\u30a4\u30eb\uff1a   epa-http.log\n\u51e6\u7406\u884c\u6570\uff1a       47742\n\u6240\u8981\u6642\u9593\uff1a       00:01:27.2963457\n\u7dcf\u51e6\u7406\u884c\u6570\uff1a     47742\n\n\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u306e\u7dcf\u884c\u6570\u304c47748\u884c\u3067\u3053\u306e\u51856\u884c\u3092Invalid requests\u3068\u3057\u3066\u30b9\u30ad\u30c3\u30d7\u3057\u3066\u5dee\u5f1547742\u884c\u3092Elasticsearch\u306b\u30a4\u30f3\u30dd\u30fc\u30c8\u51fa\u6765\u307e\u3057\u305f\u3002\n\u3053\u308c\u3067\u30ed\u30b0\u306e\u6295\u5165\u306f\u5b8c\u4e86\u3067\u3059\u3002\n\n[\u6b21\u56de](http://qiita.com/Aco-gt/items/ee60d2c9cf472d37825d)\u306f\u3001\u3053\u306eindex\u3092Kibana\u3067\u53c2\u7167\u3057\u3066\u307f\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n", "tags": ["Windows", "PowerShell", "Elasticsearch1.4.1", "kibana4.0.0", "Beta2"]}