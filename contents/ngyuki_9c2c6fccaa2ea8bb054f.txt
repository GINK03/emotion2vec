{"context": "\u3084\u3063\u3066\u307f\u307e\u3057\u305f\u3002\n\nVagrant\nsv01/sv02 \u304c NFS \u3092\u30de\u30a6\u30f3\u30c8\u3059\u308b\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3067\u3001nfs01/nfs02 \u304c NFS \u30b5\u30fc\u30d0\u3067\u3059\u3002\nVagrant.configure(2) do |config|\n  config.vm.box = \"bento/centos-7.2\"\n  config.ssh.insert_key = false\n  config.vm.define \"sv01\" do |config|\n    config.vm.hostname = \"sv01\"\n    config.vm.network :private_network, ip: \"192.168.33.11\", virtualbox__intnet: \"ha-nfs\"\n  end\n  config.vm.define \"sv02\" do |config|\n    config.vm.hostname = \"sv02\"\n    config.vm.network :private_network, ip: \"192.168.33.12\", virtualbox__intnet: \"ha-nfs\"\n  end\n  config.vm.define \"nfs01\" do |config|\n    config.vm.hostname = \"nfs01\"\n    config.vm.network :private_network, ip: \"192.168.33.21\", virtualbox__intnet: \"ha-nfs\"\n  end\n  config.vm.define \"nfs02\" do |config|\n    config.vm.hostname = \"nfs02\"\n    config.vm.network :private_network, ip: \"192.168.33.22\", virtualbox__intnet: \"ha-nfs\"\n  end\n  config.vm.provider :virtualbox do |v|\n    v.linked_clone = true\n  end\nend\n\nvagrant up \u306e\u5f8c\u3001\u540d\u524d\u3067\u89e3\u6c7a\u3067\u304d\u308b\u3088\u3046\u306b hosts \u3092\u4f5c\u6210\u3057\u3066\u304a\u304d\u307e\u3059\u3002\nsudo tee /etc/hosts <<EOS\n127.0.0.1     localhost localhost.localdomain localhost4 localhost4.localdomain4\n::1           localhost localhost.localdomain localhost6 localhost6.localdomain6\n192.168.33.11 sv01\n192.168.33.12 sv02\n192.168.33.21 nfs01\n192.168.33.22 nfs02\n192.168.33.20 nfsvip\nEOS\n\nnfsvip \u306f Floating IP \u3067\u4ed8\u3051\u308b\u4e88\u5b9a\u306e NFS \u30b5\u30fc\u30d0\u306e\u30a2\u30af\u30c6\u30a3\u30d6\u5074\u306e\u4eee\u60f3\u30a2\u30c9\u30ec\u30b9\u3067\u3059\u3002\n\n\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u3092 yum \u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002DRBD \u306f ELrepo \u304b\u3089\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n# [nfs01/nfs02]\nsudo yum -y install http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm\nsudo yum -y install kmod-drbd84 pacemaker corosync resource-agents pcs nfs-utils\n\n\nDRBD\nDRBD \u306e\u8a2d\u5b9a\u3092\u884c\u3044\u307e\u3059\u3002Vagrant \u74b0\u5883\u3067\u306e\u691c\u8a3c\u306a\u306e\u3067\u7c21\u5358\u5316\u306e\u305f\u3081\u306b\u30eb\u30fc\u30d7\u30d0\u30c3\u30af\u30c7\u30d0\u30a4\u30b9\u3092\u4f7f\u3044\u307e\u3059\u3002\n# [nfs01/nfs02]\nsudo fallocate -l 1G /var/opt/drbddisk\nsudo losetup /dev/loop0 /var/opt/drbddisk\n\nsudo tee /etc/drbd.d/nfs.res <<EOS\nresource nfs\n{\n    protocol C;\n    device /dev/drbd0;\n    meta-disk internal;\n\n    on nfs01 {\n        address 192.168.33.21:7791;\n        disk /dev/loop0;\n    }\n\n    on nfs02 {\n        address 192.168.33.22:7791;\n        disk /dev/loop0;\n    }\n}\nEOS\n\n\u30e1\u30bf\u30c7\u30fc\u30bf\u3092\u4f5c\u6210\u3057\u3066\u958b\u59cb\u3057\u307e\u3059\u3002\n# [nfs01/nfs02]\nsudo drbdadm create-md nfs\nsudo systemctl start drbd.service\nsudo systemctl status drbd.service\n\n\u958b\u59cb\u76f4\u5f8c\u306a\u306e\u3067 Inconsistent \u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n# [nfs01/nfs02]\ncat /proc/drbd\n# (...snip...)\n# 0: cs:Connected ro:Secondary/Secondary ds:Inconsistent/Inconsistent C r-----\n#    ns:0 nr:0 dw:0 dr:0 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:1048508\n\nnfs01 \u3092\u30d7\u30e9\u30a4\u30de\u30ea\u306b\u3057\u307e\u3059\u3002\n# [nfs01]\nsudo drbdadm primary nfs --force\n\n--force \u3057\u305f\u306e\u3067\u540c\u671f\u3082\u958b\u59cb\u3057\u307e\u3059\u3002\n# [nfs01]\ncat /proc/drbd\n# (...snip...)\n# 0: cs:SyncSource ro:Primary/Secondary ds:UpToDate/Inconsistent C r-----\n#    ns:1720 nr:0 dw:0 dr:2632 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:1046788\n#        [>....................] sync'ed:  0.4% (1046788/1048508)K\n#        finish: 0:08:43 speed: 1,720 (1,720) K/sec\n\nDRBD \u306e\u30d6\u30ed\u30c3\u30af\u30c7\u30d0\u30a4\u30b9\u3092 xfs \u3067\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3057\u307e\u3059\u3002\n# [nfs01]\nsudo mkfs.xfs /dev/drbd/by-res/nfs\n\n\u30de\u30a6\u30f3\u30c8\u30dd\u30a4\u30f3\u30c8\u3092\u4f5c\u6210\u3057\u3066\u30de\u30a6\u30f3\u30c8\u3057\u307e\u3059\u3002\n# [nfs01]\nsudo mkdir -p /drbd/nfs\nsudo mount /dev/drbd/by-res/nfs /drbd/nfs\n\n\u5fc5\u8981\u306a\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\u305d\u308c\u305e\u308c exportfs \u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3068 /var/lib/nfs \u306b mount --bind \u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3067\u3059\uff08ocf:heartbeat:nfsserver \u304c\u52dd\u624b\u306b\u3084\u308a\u307e\u3059\uff09\u3002\n# [nfs01]\nsudo mkdir -p /drbd/nfs/nfsroot\nsudo mkdir -p /drbd/nfs/var-lib-nfs\n\n\u30a2\u30f3\u30de\u30a6\u30f3\u30c8\u3057\u3066\u30bb\u30ab\u30f3\u30c0\u30ea\u306b\u623b\u3057\u307e\u3059\u3002\n# [nfs01]\nsudo umount /drbd/nfs\nsudo drbdadm secondary nfs\n\n\u6b21\u306f nfs02 \u3067\u4f5c\u696d\u3057\u307e\u3059\u3002\u3082\u3046\u305d\u308d\u305d\u308d\u540c\u671f\u3082\u7d42\u308f\u3063\u3066\u3044\u308b\u3067\u3057\u3087\u3046\u3002\n# [nfs02]\ncat /proc/drbd\n# (...snip...)\n# 0: cs:Connected ro:Secondary/Secondary ds:UpToDate/UpToDate C r-----\n#    ns:728889 nr:0 dw:1054333 dr:725379 al:12 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0\n\nDRBD \u30ea\u30bd\u30fc\u30b9\u3092\u30d7\u30e9\u30a4\u30de\u30ea\u306b\u3057\u307e\u3059\u3002\n# [nfs02]\nsudo drbdadm primary nfs\n\n\u30de\u30a6\u30f3\u30c8\u30dd\u30a4\u30f3\u30c8\u3092\u4f5c\u6210\u3057\u3066\u30de\u30a6\u30f3\u30c8\u3057\u307e\u3059\u3002\n# [nfs02]\nsudo mkdir -p /drbd/nfs\nsudo mount /dev/drbd/by-res/nfs /drbd/nfs\n\nnfs01 \u3067\u4f5c\u6210\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304c\u898b\u3048\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n# [nfs02]\nls /drbd/nfs\n# nfsroot  var-lib-nfs\n\n\u30a2\u30f3\u30de\u30a6\u30f3\u30c8\u3057\u3066\u30bb\u30ab\u30f3\u30c0\u30ea\u306b\u623b\u308a\u307e\u3059\u3002\n# [nfs02]\nsudo umount /drbd/nfs\nsudo drbdadm secondary nfs\n\nDRBD \u306e\u4f5c\u696d\u306f\u7d42\u308f\u308a\u306a\u306e\u3067\u505c\u6b62\u3057\u3066\u304a\u304d\u307e\u3059\uff08DRBD \u306f Pacemaker \u304b\u3089\u958b\u59cb\u3055\u308c\u308b\uff09\u3002\n# [nfs01/nfs02]\nsudo systemctl stop drbd.service\nsudo systemctl status drbd.service\n\n\nCorosync\nCorosync \u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u4e0b\u8a18\u306e\u3088\u3046\u306a\u611f\u3058\u3067\u4f5c\u6210\u3057\u307e\u3059\u3002\uff12\u30ce\u30fc\u30c9\u306a\u306e\u3067 quorum \u3067 two_node: 1 \u304c\u5fc5\u8981\u3067\u3059\u3002\n# [nfs01/nfs02]\nsudo tee /etc/corosync/corosync.conf <<EOS\ntotem {\n    version: 2\n    crypto_cipher: none\n    crypto_hash: none\n    token: 4000\n    rrp_mode: active\n    transport: udpu\n\n    interface {\n        ringnumber: 0\n        bindnetaddr: 192.168.33.0\n        mcastaddr: 239.255.1.1\n        mcastport: 5405\n    }\n}\n\nlogging {\n    timestamp: on\n    debug: off\n    to_stderr: no\n    to_syslog: no\n    to_logfile: yes\n    logfile: /var/log/cluster/corosync.log\n}\n\nnodelist {\n    node {\n        ring0_addr: 192.168.33.21\n        nodeid: 1\n    }\n    node {\n        ring0_addr: 192.168.33.22\n        nodeid: 2\n    }\n}\n\nquorum {\n    provider: corosync_votequorum\n    two_node: 1\n}\nEOS\n\n\u958b\u59cb\u3057\u307e\u3059\u3002pacemaker \u3092\u958b\u59cb\u3059\u308b\u3068 corosync \u3082\u958b\u59cb\u3059\u308b\u306e\u3067 pacemaker \u3060\u3051\u3067\u826f\u3044\u3067\u3059\u3002\n# [nfs01/nfs02]\nsudo systemctl start pacemaker.service\nsudo systemctl status pacemaker.service\n\n\u4e21\u65b9\u306e\u30ce\u30fc\u30c9\u304c\u30aa\u30f3\u30e9\u30a4\u30f3\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n# [nfs01]\nsudo crm_mon -1\n# (...snip...)\n#\n# Online: [ nfs01 nfs02 ]\n#\n# (...snip...)\n\n\nPacemaker\nPacemaker \u306e\u30ea\u30bd\u30fc\u30b9\u5b9a\u7fa9\u3092\u884c\u3044\u307e\u3059\u3002\n\u307e\u305a\u306f\u30d7\u30ed\u30d1\u30c6\u30a3\u3084\u30ea\u30bd\u30fc\u30b9\u30c7\u30d5\u30a9\u30eb\u30c8\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n# [nfs01]\nsudo pcs property set stonith-enabled=\"false\"\nsudo pcs property set no-quorum-policy=\"ignore\"\nsudo pcs property set start-failure-is-fatal=\"false\"\nsudo pcs resource defaults migration-threshold=\"5\"\nsudo pcs resource defaults resource-stickiness=\"INFINITY\"\nsudo pcs resource defaults failure-timeout=\"3600s\"\n\nCIB \u3092\u30d5\u30a1\u30a4\u30eb\u306b\u51fa\u529b\u3057\u307e\u3059\u3002\n# [nfs01]\nsudo pcs cluster cib output.cib\n\n\u51fa\u529b\u3057\u305f CIB \u30d5\u30a1\u30a4\u30eb\u3092\u5bfe\u8c61\u306b\u30ea\u30bd\u30fc\u30b9\u3092\u4f5c\u6210\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\u307e\u305a\u306f DRBD \u306e\u30ea\u30bd\u30fc\u30b9\u3002\u3053\u308c\u306f Master/Slave \u30ea\u30bd\u30fc\u30b9\u3067\u3059\u3002\n# [nfs01]\nsudo pcs -f output.cib resource create drbd ocf:linbit:drbd \\\n  drbd_resource=\"nfs\" drbdconf=\"/etc/drbd.conf\" \\\n    op start timeout=\"240s\" on-fail=\"restart\" \\\n    op stop  timeout=\"100s\" on-fail=\"block\" \\\n    op monitor interval=\"20s\" timeout=\"20s\" start-delay=\"1m\" on-fail=\"restart\" \\\n      --master meta notify=\"true\" \n\nDRBD \u30c7\u30d0\u30a4\u30b9\u306e\u30de\u30a6\u30f3\u30c8\u3001\u4eee\u60f3\u30a2\u30c9\u30ec\u30b9\u306e\u4ed8\u4e0e\u3001NFS \u30b5\u30fc\u30d0\u3001exportfs \u306e\u30ea\u30bd\u30fc\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u3053\u308c\u3089\u306f\u901a\u5e38\u306e\u30ea\u30bd\u30fc\u30b9\u3067\u3059\u3002\n# [nfs01]\nsudo pcs -f output.cib resource create fs ocf:heartbeat:Filesystem \\\n  device=\"/dev/drbd/by-res/nfs\" directory=\"/drbd/nfs\" fstype=\"xfs\" \\\n    op start timeout=\"60s\" on-fail=\"restart\" \\\n    op stop  timeout=\"60s\" on-fail=\"block\" \\\n    op monitor interval=\"10s\" timeout=\"60s\" on-fail=\"restart\"\n\nsudo pcs -f output.cib resource create vip ocf:heartbeat:IPaddr2 \\\n  ip=\"192.168.33.20\" cidr_netmask=\"24\" nic=\"enp0s8\" \\\n    op start timeout=\"20s\" on-fail=\"restart\" \\\n    op stop  timeout=\"20s\" on-fail=\"block\" \\\n    op monitor interval=\"10s\" timeout=\"20s\" on-fail=\"restart\"\n\nsudo pcs -f output.cib resource create nfsserver ocf:heartbeat:nfsserver \\\n  nfs_shared_infodir=\"/drbd/nfs/var-lib-nfs\" \\\n    op start timeout=\"20s\" \\\n    op stop  timeout=\"20s\" \\\n    op monitor interval=\"10s\" timeout=\"10s\" on-fail=\"restart\" start-delay=\"20s\"\n\nsudo pcs -f output.cib resource create exportfs ocf:heartbeat:exportfs \\\n  clientspec=\"192.168.33.0/24\" options=\"rw,no_root_squash\" directory=\"/drbd/nfs/nfsroot\" fsid=\"root\"\n\n\u30b0\u30eb\u30fc\u30d7\u306b\u3057\u307e\u3059\u3002\n# [nfs01]\nsudo pcs -f output.cib resource group add group-nfs fs vip nfsserver exportfs\n\ndrbd \u30ea\u30bd\u30fc\u30b9\u3068\u2191\u306e\u30b0\u30eb\u30fc\u30d7\u3068\u306e\u5236\u7d04\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u2191\u306e\u30b0\u30eb\u30fc\u30d7\u306f drbd \u306e\u30de\u30b9\u30bf\u30fc\u3068\u540c\u3058\u30ce\u30fc\u30c9\u3067\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u3057\u3001drbd \u306e\u30d7\u30ed\u30e2\u30fc\u30c8\u304c\u5148\u306b\u884c\u308f\u308c\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n# [nfs01]\nsudo pcs -f output.cib constraint colocation add master drbd-master with group-nfs INFINITY\nsudo pcs -f output.cib constraint order promote drbd-master then start group-nfs\n\nCIB \u30d5\u30a1\u30a4\u30eb\u306e\u5909\u66f4\u3092\u9069\u7528\u3057\u307e\u3059\u3002\n# [nfs01]\nsudo pcs cluster cib-push output.cib\n\n\u30b9\u30c6\u30fc\u30bf\u30b9\u3092\u8868\u793a\u3055\u305b\u3066\u305d\u308c\u3063\u307d\u304f\u306a\u3063\u3066\u3044\u308c\u3070 OK \u3067\u3059\u3002\n# [nfs01]\nsudo pcs status\n# (...snip...)\n#\n# Online: [ nfs01 nfs02 ]\n# \n# Full list of resources:\n# \n#  Master/Slave Set: drbd-master [drbd]\n#      Masters: [ nfs01 ]\n#      Slaves: [ nfs02 ]\n#  Resource Group: group-nfs\n#      fs (ocf::heartbeat:Filesystem):    Started nfs01\n#      vip        (ocf::heartbeat:IPaddr2):       Started nfs01\n#      nfsserver  (ocf::heartbeat:nfsserver):     Started nfs01\n#      exportfs   (ocf::heartbeat:exportfs):      Started nfs01\n# \n# (...snip...)\n\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u30de\u30a6\u30f3\u30c8\nsv01 \u304b\u3089\u30de\u30a6\u30f3\u30c8\u3057\u3066\u9069\u5f53\u306b\u30d5\u30a1\u30a4\u30eb\u3092\u66f8\u3044\u3066\u307f\u307e\u3059\u3002\n# [sv01]\nsudo mount -t nfs nfsvip:/drbd/nfs/nfsroot /mnt -o rw,rsize=8192,wsize=8192,soft,intr,timeo=20,retrans=3\nuname -n | sudo tee /mnt/$(uname -n)\n\nsv02 \u304b\u3089\u3082\u30de\u30a6\u30f3\u30c8\u3057\u3066\u9069\u5f53\u306b\u30d5\u30a1\u30a4\u30eb\u3092\u66f8\u3044\u3066\u307f\u307e\u3059\u3002\n# [sv02]\nsudo mount -t nfs nfsvip:/drbd/nfs/nfsroot /mnt -o rw,rsize=8192,wsize=8192,soft,intr,timeo=20,retrans=3\nuname -n | sudo tee /mnt/$(uname -n)\n\n\u76f8\u4e92\u306b\u8aad\u3081\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n# [sv01]\ncat /mnt/sv02\n\n# [sv02]\ncat /mnt/sv01\n\n\n\u969c\u5bb3\u767a\u751f\nNFS \u306e\u30ce\u30fc\u30c9\u3067\u969c\u5bb3\u304c\u767a\u751f\u3057\u305f\u3068\u304d\u306e\u52d5\u4f5c\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\nsv01 \u3067\u30de\u30a6\u30f3\u30c8\u5148\u306e\u30d5\u30a1\u30a4\u30eb\u306b\u9023\u7d9a\u3057\u3066\u66f8\u304d\u8fbc\u307f\u307e\u304f\u308a\u307e\u3059\u3002\n# [sv01]\nsudo touch /mnt/date.txt\nsudo chown $USER: /mnt/date.txt\nwhile sleep 0.1; do date 1>&2; date > /mnt/date.txt; done\n\n\u304a\u3082\u3080\u308d\u306b\u30a2\u30af\u30c6\u30a3\u30d6\u5074\u306e\u30ce\u30fc\u30c9\u3092\u5f37\u5236\u7d42\u4e86\u3055\u305b\u307e\u3059\u3002\n# [nfs01]\nsudo halt -f\n\n20\u79d2\u3050\u3089\u3044\u66f8\u304d\u8fbc\u307f\u304c\u6b62\u307e\u3063\u305f\u5f8c\u3001I/O error \u306b\u306a\u3063\u3066\u66f8\u304d\u8fbc\u307f\u304c\u518d\u958b\u3057\u307e\u3057\u305f\u3002\n# [sv01]\n# (...snip...)\n# Tue Jun  7 01:47:23 UTC 2016\n# Tue Jun  7 01:47:23 UTC 2016\n# -bash: /mnt/date.txt: Input/output error\n# Tue Jun  7 01:47:40 UTC 2016\n# Tue Jun  7 01:47:40 UTC 2016\n# (...snip...)\n\n\u5b9f\u969b\u306e\u6642\u9593\u3084\u52d5\u4f5c\u306f Pacemaker/Corosync \u306e\u8a2d\u5b9a\u3084 NFS \u306e\u30de\u30a6\u30f3\u30c8\u30aa\u30d7\u30b7\u30e7\u30f3\u306b\u3088\u3063\u3066\u5909\u308f\u308a\u307e\u3059\u3002\n\u306a\u304a\u3001DRBD \u306e\u30c7\u30a3\u30b9\u30af\u306b\u30eb\u30fc\u30d7\u30d0\u30c3\u30af\u30c7\u30d0\u30a4\u30b9\u3092\u4f7f\u7528\u3057\u3066\u3044\u308b\u306e\u3068\u3001pacemaker \u306e\u81ea\u52d5\u8d77\u52d5\u3092\u8a2d\u5b9a\u3057\u3066\u3044\u306a\u3044\u306e\u3067\u3001\u30ce\u30fc\u30c9\u306e\u518d\u8d77\u52d5\u5f8c\u306f\u624b\u52d5\u3067\u30eb\u30fc\u30d7\u30d0\u30c3\u30af\u30c7\u30d0\u30a4\u30b9\u306e\u4f5c\u6210\u3068 pacemaker \u306e\u8d77\u52d5\u3092\u884c\u3046\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n# [nfs01]\nsudo losetup /dev/loop0 /var/opt/drbddisk\nsudo systemctl start pacemaker\n\n\n\u30ce\u30fc\u30c9\u8d77\u52d5\u6642\u306e monitor \u3067 NFS Server \u304c\u958b\u59cb\u3057\u3066\u3057\u307e\u3046\u554f\u984c\nNFS \u306e\u30ce\u30fc\u30c9\u3092\u518d\u8d77\u52d5\u3057\u3066 pacemaker \u3092\u8d77\u52d5\u3057\u305f\u3068\u304d\u306b\u3067\u3059\u304c\u3001\u8d77\u52d5\u3057\u305f\u30ce\u30fc\u30c9\u306e\u5074\u3067\u4e0b\u8a18\u306e\u3088\u3046\u306b NFS server \u304c\u8d77\u52d5\u3057\u305f\u65e8\u306e\u30ed\u30b0\u304c\u8a18\u9332\u3055\u308c\u307e\u3057\u305f\u3002\nnfsserver(nfsserver)[3486]: 2016/06/07_01:51:31 INFO: Status: rpcbind\nnfsserver(nfsserver)[3486]: 2016/06/07_01:51:31 INFO: Status: nfs-mountd\nnfsserver(nfsserver)[3486]: 2016/06/07_01:51:31 INFO: Starting NFS server ...\nnfsserver(nfsserver)[3486]: 2016/06/07_01:51:31 INFO: Start: rpcbind i: 10\nnfsserver(nfsserver)[3486]: 2016/06/07_01:51:31 INFO: Start: v3locking: 0\nnfsserver(nfsserver)[3486]: 2016/06/07_01:51:31 INFO: Start: nfs-mountd i: 10\nnfsserver(nfsserver)[3486]: 2016/06/07_01:51:31 INFO: Start: nfs-idmapd i: 10\nnfsserver(nfsserver)[3486]: 2016/06/07_01:51:31 INFO: Start: rpc-statd i: 10\nnfsserver(nfsserver)[3486]: 2016/06/07_01:51:31 INFO: executing sm-notify\nnfsserver(nfsserver)[3486]: 2016/06/07_01:51:31 INFO: NFS server started\nnfsserver(nfsserver)[3486]: 2016/06/07_01:51:31 INFO: Status: nfs-idmapd\nnfsserver(nfsserver)[3486]: 2016/06/07_01:51:31 INFO: Status: rpc-statd\n\n\u3053\u306e\u5f8c\u76f4\u3050\u306b\u505c\u6b62\u3055\u308c\u3066\u3044\u307e\u3059\u3002\nnfsserver(nfsserver)[3782]: 2016/06/07_01:51:32 INFO: Stopping NFS server ...\nnfsserver(nfsserver)[3782]: 2016/06/07_01:51:32 INFO: Stop: threads\nnfsserver(nfsserver)[3782]: 2016/06/07_01:51:32 INFO: Stop: rpc-statd\nnfsserver(nfsserver)[3782]: 2016/06/07_01:51:32 INFO: Stop: nfs-idmapd\nnfsserver(nfsserver)[3782]: 2016/06/07_01:51:32 INFO: Stop: nfs-mountd\nnfsserver(nfsserver)[3782]: 2016/06/07_01:51:32 INFO: Stop: rpcbind\nnfsserver(nfsserver)[3782]: 2016/06/07_01:51:32 INFO: NFS server stopped\n\n\u30a2\u30af\u30c6\u30a3\u30d6\u5074\uff08DC\u5074\u3067\u3082\u3042\u308b\uff09\u3067\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306b nfsserver \u304c\u4e21\u65b9\u306e\u30ce\u30fc\u30c9\u3067\u958b\u59cb\u3057\u3066\u3044\u308b\u65e8\u306e\u30ed\u30b0\u304c\u8a18\u9332\u3055\u308c\u3066\u3044\u307e\u3057\u305f\u3002\nJun 07 01:51:32 [19992] nfs02    pengine:    error: native_create_actions:  Resource nfsserver (ocf::nfsserver) is active on 2 nodes attempting recovery\nJun 07 01:51:32 [19992] nfs02    pengine:  warning: native_create_actions:  See http://clusterlabs.org/wiki/FAQ#Resource_is_Too_Active for more information.\n\n\u3053\u306e\u5f8c\u306b\u4e21\u65b9\u306e\u30ce\u30fc\u30c9\u3067 NFS server \u304c\u505c\u6b62\u3057\u3066\u30a2\u30af\u30c6\u30a3\u30d6\u5074\u3067\u306e\u307f\u518d\u958b\u3057\u3066\u3044\u308b\u306e\u3067\u3059\u304c\u3001\u3053\u306e\u305f\u3081\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u306f\u4e00\u6642\u7684\u306b\u66f8\u304d\u8fbc\u307f\u304c\u5931\u6557\u3057\u3066\u3044\u307e\u3059\u3002\nTue Jun  7 01:51:32 UTC 2016\nTue Jun  7 01:51:32 UTC 2016\n-bash: /mnt/date.txt: Permission denied\nTue Jun  7 01:51:32 UTC 2016\n-bash: /mnt/date.txt: Permission denied\nTue Jun  7 01:51:32 UTC 2016\nTue Jun  7 01:51:32 UTC 2016\nTue Jun  7 01:51:39 UTC 2016\nTue Jun  7 01:51:39 UTC 2016\n\nnfsserver \u306e ocf \u30d5\u30a1\u30a4\u30eb (/usr/lib/ocf/resource.d/heartbeat/nfsserver) \u3092\u898b\u305f\u611f\u3058\u3001\nnfsserver_monitor ()\n{\n        # Skip trying to start processes once before failing\n        # when run from nfsserver_start ()\n        if [ \"$1\" == \"fromstart\" ]; then\n                ocf_log info \"fromstart\"\n                fromstart=1\n        else\n                tries=1\n        fi\n:\n                ocf_log info \"Status: rpcbind\"\n                rpcinfo &> /dev/null\n                rc=$?\n                if [ \"$rc\" -ne \"0\" ]; then\n                        if [ ! \"$fromstart\" ] && [ \"$tries\" -gt \"0\" ]; then\n                                nfsserver_start frommonitor\n                                rc=$?\n                                let tries=$tries-1\n                        fi\n                        if [ \"$rc\" -ne \"0\" ]; then\n                                ocf_exit_reason \"rpcbind is not running\"\n                                return $OCF_NOT_RUNNING\n                        fi\n                fi\n:\n}\n\nmonitor \u3067\u30ea\u30bd\u30fc\u30b9\u306e\u958b\u59cb\u304c\u884c\u308f\u308c\u3066\u3057\u307e\u3046\u3088\u3046\u3067\u3059\u30fb\u30fb\u30fb\uff1f\nocf \u306f resource-agents \u30d1\u30c3\u30b1\u30fc\u30b8\u306b\u542b\u307e\u308c\u3066\u3044\u307e\u3059\u304c\u3001\u30a2\u30c3\u30d7\u30b9\u30c8\u30ea\u30fc\u30e0\u3067\u306f\u3053\u306e\u3088\u3046\u306a\u5185\u5bb9\u306b\u306f\u306a\u3063\u3066\u3044\u307e\u305b\u3093\u3067\u3057\u305f\u3002\nCentOS 7 \u306e resource-agents \u306e SRPM \u3092\u898b\u3066\u307f\u305f\u3068\u3053\u308d bz1304370-nfsserver-fix-systemd-status-detection.patch \u3067\u3053\u306e\u5909\u66f4\u304c\u884c\u308f\u308c\u3066\u3044\u307e\u3057\u305f\u304c\u30fb\u30fb\u30fb\nRHBZ#1304370\n\u975e\u516c\u958b\u306e\u3088\u3046\u3067\u3059\u3002\nmonitor \u3067\u30ea\u30bd\u30fc\u30b9\u304c\u958b\u59cb\u3055\u308c\u308b\u306e\u306f\u306a\u306b\u304b\u306e\u9593\u9055\u3044\u3060\u3068\u3057\u304b\u601d\u3048\u307e\u305b\u3093\u3002\u3068\u308a\u3042\u3048\u305a ocf \u3067 tries=0 \u306b\u3059\u308c\u3070 monitor \u304b\u3089\u30ea\u30bd\u30fc\u30b9\u306e\u958b\u59cb\u306f\u884c\u308f\u308c\u306a\u304f\u306a\u308b\u306e\u3067\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306b\u30d1\u30c3\u30c1\u3059\u308b\u3053\u3068\u306b\u3057\u307e\u3057\u305f\u3002\nsudo cp -a /usr/lib/ocf/resource.d/heartbeat/nfsserver{,.orig}\nsudo sed 's/tries=1/tries=0/g' -i /usr/lib/ocf/resource.d/heartbeat/nfsserver\ndiff -u /usr/lib/ocf/resource.d/heartbeat/nfsserver{.orig,}\n\n--- /usr/lib/ocf/resource.d/heartbeat/nfsserver.orig    2016-05-12 14:02:40.000000000 +0000\n+++ /usr/lib/ocf/resource.d/heartbeat/nfsserver 2016-06-07 02:04:09.825775009 +0000\n@@ -364,7 +364,7 @@\n                ocf_log info \"fromstart\"\n                fromstart=1\n        else\n-               tries=1\n+               tries=0\n        fi\n\n        # systemd\n\n\nnfsserver \u306f\u30af\u30ed\u30fc\u30f3\u30ea\u30bd\u30fc\u30b9\u3067\u3082\u826f\u3044\uff1f\n\u4e0b\u8a18\u3060\u3068 nfsserver \u306f systemd \u306e\u30ea\u30bd\u30fc\u30b9\u3067\u5b9a\u7fa9\u3057\u3066\u30af\u30ed\u30fc\u30f3\u30ea\u30bd\u30fc\u30b9\u306b\u3057\u3066\u3044\u307e\u3057\u305f\u3002\nhttps://www.suse.com/documentation/sle-ha-12/book_sleha_techguides/data/sec_ha_quick_nfs_resources.html#sec_ha_quick_nfs_resources_nfsserver\n\u305d\u308c\u3082\u30a2\u30ea\u306a\u306e\u304b\u306a\uff1f\u3001\u8a66\u3057\u3066\u307f\u307e\u3057\u305f\u3002\u307e\u305a\u306f DRBD \u306e\u30de\u30a6\u30f3\u30c8\u30dd\u30a4\u30f3\u30c8\u3092 exportfs \u3059\u308b\u69cb\u6210\u3067\u3001\u3053\u306e\u5834\u5408\u306f exportfs \u3082\u30af\u30ed\u30fc\u30f3\u30ea\u30bd\u30fc\u30b9\u306b\u3067\u304d\u307e\u3059\u3002\nsudo pcs resource delete exportfs\nsudo pcs resource delete nfsserver\nsudo pcs resource cleanup exportfs\nsudo pcs resource cleanup nfsserver\n\nsudo pcs resource create nfsserver systemd:nfs-server \\\n  op monitor interval=\"30s\"\n\nsudo pcs resource create exportfs ocf:heartbeat:exportfs \\\n  clientspec=\"192.168.33.0/24\" options=\"rw,no_root_squash\" directory=\"/drbd/nfs\" fsid=\"root\" \\\n  op monitor interval=\"30s\"\n\nsudo pcs resource group add group-nfsserver nfsserver exportfs\nsudo pcs resource clone group-nfsserver\n\nsudo pcs constraint colocation add group-nfs with group-nfsserver-clone INFINITY\nsudo pcs constraint order start group-nfsserver-clone then start group-nfs\n\n\u6b21\u306b DRBD \u306e\u30de\u30a6\u30f3\u30c8\u30dd\u30a4\u30f3\u30c8\u306e\u30b5\u30d6\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092 exportfs \u3059\u308b\u69cb\u6210\u3067\u3001\u3053\u306e\u5834\u5408\u306f exportfs \u306f\u901a\u5e38\u306e\u30ea\u30bd\u30fc\u30b9\u3067 fs \u3068\u304b vip \u3068\u304b\u3068\u540c\u3058\u30b0\u30eb\u30fc\u30d7\u306b\u3057\u307e\u3059\u3002\nsudo pcs resource delete exportfs\nsudo pcs resource delete nfsserver\nsudo pcs resource cleanup exportfs\nsudo pcs resource cleanup nfsserver\n\nsudo pcs resource create nfsserver systemd:nfs-server \\\n  op monitor interval=\"30s\" --clone\n\nsudo pcs resource create exportfs ocf:heartbeat:exportfs \\\n  clientspec=\"192.168.33.0/24\" options=\"rw,no_root_squash\" directory=\"/drbd/nfs/nfsroot\" fsid=\"root\" \\\n  op monitor interval=\"30s\"\n\n# fs vip exportfs\nsudo pcs resource group add group-nfs exportfs\n\nsudo pcs constraint colocation add group-nfs with nfsserver-clone INFINITY\nsudo pcs constraint order start nfsserver-clone then start group-nfs\n\n\u898b\u305f\u611f\u3058\u3001\u3069\u3061\u3089\u306e\u65b9\u6cd5\u3067\u3082\u554f\u984c\u7121\u3055\u305d\u3046\u3067\u3057\u305f\u3002/var/lib/nfs/ \u3063\u3066\u540c\u671f\u3057\u306a\u304f\u3066\u3082\u3044\u3044\u3082\u306e\u306a\u306e\uff1f\n/var/lib/nfs/ \u3092\u540c\u671f\u3057\u3066\u3044\u306a\u3044\u3068\u30d5\u30a7\u30a4\u30eb\u30aa\u30fc\u30d0\u30fc\u3057\u305f\u3068\u304d\u306b\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3067\u30de\u30a6\u30f3\u30c8\u3057\u306a\u304a\u3059\u5fc5\u8981\u304c\u3042\u308b\u3068\u601d\u3063\u3066\u305f\u3093\u3060\u3051\u3069\u305d\u3093\u306a\u3053\u3068\u3082\u7121\u3055\u305d\u3046\u3002tcp/udp \u3068\u304b nfs v3/v4 \u3068\u304b\u306b\u3088\u3063\u3066\u7570\u306a\u308b\u306e\u3060\u308d\u3046\u304b\uff1f\n\u3084\u3063\u3066\u307f\u307e\u3057\u305f\u3002\n\n## Vagrant\n\nsv01/sv02 \u304c NFS \u3092\u30de\u30a6\u30f3\u30c8\u3059\u308b\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3067\u3001nfs01/nfs02 \u304c NFS \u30b5\u30fc\u30d0\u3067\u3059\u3002\n\n```ruby\nVagrant.configure(2) do |config|\n  config.vm.box = \"bento/centos-7.2\"\n  config.ssh.insert_key = false\n  config.vm.define \"sv01\" do |config|\n    config.vm.hostname = \"sv01\"\n    config.vm.network :private_network, ip: \"192.168.33.11\", virtualbox__intnet: \"ha-nfs\"\n  end\n  config.vm.define \"sv02\" do |config|\n    config.vm.hostname = \"sv02\"\n    config.vm.network :private_network, ip: \"192.168.33.12\", virtualbox__intnet: \"ha-nfs\"\n  end\n  config.vm.define \"nfs01\" do |config|\n    config.vm.hostname = \"nfs01\"\n    config.vm.network :private_network, ip: \"192.168.33.21\", virtualbox__intnet: \"ha-nfs\"\n  end\n  config.vm.define \"nfs02\" do |config|\n    config.vm.hostname = \"nfs02\"\n    config.vm.network :private_network, ip: \"192.168.33.22\", virtualbox__intnet: \"ha-nfs\"\n  end\n  config.vm.provider :virtualbox do |v|\n    v.linked_clone = true\n  end\nend\n```\n\n`vagrant up` \u306e\u5f8c\u3001\u540d\u524d\u3067\u89e3\u6c7a\u3067\u304d\u308b\u3088\u3046\u306b hosts \u3092\u4f5c\u6210\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n```sh\nsudo tee /etc/hosts <<EOS\n127.0.0.1     localhost localhost.localdomain localhost4 localhost4.localdomain4\n::1           localhost localhost.localdomain localhost6 localhost6.localdomain6\n192.168.33.11 sv01\n192.168.33.12 sv02\n192.168.33.21 nfs01\n192.168.33.22 nfs02\n192.168.33.20 nfsvip\nEOS\n```\n\nnfsvip \u306f Floating IP \u3067\u4ed8\u3051\u308b\u4e88\u5b9a\u306e NFS \u30b5\u30fc\u30d0\u306e\u30a2\u30af\u30c6\u30a3\u30d6\u5074\u306e\u4eee\u60f3\u30a2\u30c9\u30ec\u30b9\u3067\u3059\u3002\n\n## \u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n\u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u3092 yum \u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002DRBD \u306f ELrepo \u304b\u3089\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\n```sh\n# [nfs01/nfs02]\nsudo yum -y install http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm\nsudo yum -y install kmod-drbd84 pacemaker corosync resource-agents pcs nfs-utils\n```\n\n## DRBD\n\nDRBD \u306e\u8a2d\u5b9a\u3092\u884c\u3044\u307e\u3059\u3002Vagrant \u74b0\u5883\u3067\u306e\u691c\u8a3c\u306a\u306e\u3067\u7c21\u5358\u5316\u306e\u305f\u3081\u306b\u30eb\u30fc\u30d7\u30d0\u30c3\u30af\u30c7\u30d0\u30a4\u30b9\u3092\u4f7f\u3044\u307e\u3059\u3002\n\n```sh\n# [nfs01/nfs02]\nsudo fallocate -l 1G /var/opt/drbddisk\nsudo losetup /dev/loop0 /var/opt/drbddisk\n\nsudo tee /etc/drbd.d/nfs.res <<EOS\nresource nfs\n{\n    protocol C;\n    device /dev/drbd0;\n    meta-disk internal;\n\n    on nfs01 {\n        address 192.168.33.21:7791;\n        disk /dev/loop0;\n    }\n\n    on nfs02 {\n        address 192.168.33.22:7791;\n        disk /dev/loop0;\n    }\n}\nEOS\n```\n\n\u30e1\u30bf\u30c7\u30fc\u30bf\u3092\u4f5c\u6210\u3057\u3066\u958b\u59cb\u3057\u307e\u3059\u3002\n\n```sh\n# [nfs01/nfs02]\nsudo drbdadm create-md nfs\nsudo systemctl start drbd.service\nsudo systemctl status drbd.service\n```\n\n\u958b\u59cb\u76f4\u5f8c\u306a\u306e\u3067 Inconsistent \u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n```sh\n# [nfs01/nfs02]\ncat /proc/drbd\n# (...snip...)\n# 0: cs:Connected ro:Secondary/Secondary ds:Inconsistent/Inconsistent C r-----\n#    ns:0 nr:0 dw:0 dr:0 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:1048508\n```\n\nnfs01 \u3092\u30d7\u30e9\u30a4\u30de\u30ea\u306b\u3057\u307e\u3059\u3002\n\n```sh\n# [nfs01]\nsudo drbdadm primary nfs --force\n```\n\n`--force` \u3057\u305f\u306e\u3067\u540c\u671f\u3082\u958b\u59cb\u3057\u307e\u3059\u3002\n\n```sh\n# [nfs01]\ncat /proc/drbd\n# (...snip...)\n# 0: cs:SyncSource ro:Primary/Secondary ds:UpToDate/Inconsistent C r-----\n#    ns:1720 nr:0 dw:0 dr:2632 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:1046788\n#        [>....................] sync'ed:  0.4% (1046788/1048508)K\n#        finish: 0:08:43 speed: 1,720 (1,720) K/sec\n```\n\nDRBD \u306e\u30d6\u30ed\u30c3\u30af\u30c7\u30d0\u30a4\u30b9\u3092 xfs \u3067\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3057\u307e\u3059\u3002\n\n```sh\n# [nfs01]\nsudo mkfs.xfs /dev/drbd/by-res/nfs\n```\n\n\u30de\u30a6\u30f3\u30c8\u30dd\u30a4\u30f3\u30c8\u3092\u4f5c\u6210\u3057\u3066\u30de\u30a6\u30f3\u30c8\u3057\u307e\u3059\u3002\n\n```sh\n# [nfs01]\nsudo mkdir -p /drbd/nfs\nsudo mount /dev/drbd/by-res/nfs /drbd/nfs\n```\n\n\u5fc5\u8981\u306a\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\u305d\u308c\u305e\u308c exportfs \u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3068 `/var/lib/nfs` \u306b `mount --bind` \u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3067\u3059\uff08`ocf:heartbeat:nfsserver` \u304c\u52dd\u624b\u306b\u3084\u308a\u307e\u3059\uff09\u3002\n\n```sh\n# [nfs01]\nsudo mkdir -p /drbd/nfs/nfsroot\nsudo mkdir -p /drbd/nfs/var-lib-nfs\n```\n\n\u30a2\u30f3\u30de\u30a6\u30f3\u30c8\u3057\u3066\u30bb\u30ab\u30f3\u30c0\u30ea\u306b\u623b\u3057\u307e\u3059\u3002\n\n```sh\n# [nfs01]\nsudo umount /drbd/nfs\nsudo drbdadm secondary nfs\n```\n\n\u6b21\u306f nfs02 \u3067\u4f5c\u696d\u3057\u307e\u3059\u3002\u3082\u3046\u305d\u308d\u305d\u308d\u540c\u671f\u3082\u7d42\u308f\u3063\u3066\u3044\u308b\u3067\u3057\u3087\u3046\u3002\n\n```sh\n# [nfs02]\ncat /proc/drbd\n# (...snip...)\n# 0: cs:Connected ro:Secondary/Secondary ds:UpToDate/UpToDate C r-----\n#    ns:728889 nr:0 dw:1054333 dr:725379 al:12 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0\n```\n\nDRBD \u30ea\u30bd\u30fc\u30b9\u3092\u30d7\u30e9\u30a4\u30de\u30ea\u306b\u3057\u307e\u3059\u3002\n\n```sh\n# [nfs02]\nsudo drbdadm primary nfs\n```\n\n\u30de\u30a6\u30f3\u30c8\u30dd\u30a4\u30f3\u30c8\u3092\u4f5c\u6210\u3057\u3066\u30de\u30a6\u30f3\u30c8\u3057\u307e\u3059\u3002\n\n```sh\n# [nfs02]\nsudo mkdir -p /drbd/nfs\nsudo mount /dev/drbd/by-res/nfs /drbd/nfs\n```\n\nnfs01 \u3067\u4f5c\u6210\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304c\u898b\u3048\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```sh\n# [nfs02]\nls /drbd/nfs\n# nfsroot  var-lib-nfs\n```\n\n\u30a2\u30f3\u30de\u30a6\u30f3\u30c8\u3057\u3066\u30bb\u30ab\u30f3\u30c0\u30ea\u306b\u623b\u308a\u307e\u3059\u3002\n\n```sh\n# [nfs02]\nsudo umount /drbd/nfs\nsudo drbdadm secondary nfs\n```\n\nDRBD \u306e\u4f5c\u696d\u306f\u7d42\u308f\u308a\u306a\u306e\u3067\u505c\u6b62\u3057\u3066\u304a\u304d\u307e\u3059\uff08DRBD \u306f Pacemaker \u304b\u3089\u958b\u59cb\u3055\u308c\u308b\uff09\u3002\n\n```sh\n# [nfs01/nfs02]\nsudo systemctl stop drbd.service\nsudo systemctl status drbd.service\n```\n\n## Corosync\n\nCorosync \u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u4e0b\u8a18\u306e\u3088\u3046\u306a\u611f\u3058\u3067\u4f5c\u6210\u3057\u307e\u3059\u3002\uff12\u30ce\u30fc\u30c9\u306a\u306e\u3067 quorum \u3067 `two_node: 1` \u304c\u5fc5\u8981\u3067\u3059\u3002\n\n```sh\n# [nfs01/nfs02]\nsudo tee /etc/corosync/corosync.conf <<EOS\ntotem {\n    version: 2\n    crypto_cipher: none\n    crypto_hash: none\n    token: 4000\n    rrp_mode: active\n    transport: udpu\n\n    interface {\n        ringnumber: 0\n        bindnetaddr: 192.168.33.0\n        mcastaddr: 239.255.1.1\n        mcastport: 5405\n    }\n}\n\nlogging {\n    timestamp: on\n    debug: off\n    to_stderr: no\n    to_syslog: no\n    to_logfile: yes\n    logfile: /var/log/cluster/corosync.log\n}\n\nnodelist {\n    node {\n        ring0_addr: 192.168.33.21\n        nodeid: 1\n    }\n    node {\n        ring0_addr: 192.168.33.22\n        nodeid: 2\n    }\n}\n\nquorum {\n    provider: corosync_votequorum\n    two_node: 1\n}\nEOS\n```\n\n\u958b\u59cb\u3057\u307e\u3059\u3002pacemaker \u3092\u958b\u59cb\u3059\u308b\u3068 corosync \u3082\u958b\u59cb\u3059\u308b\u306e\u3067 pacemaker \u3060\u3051\u3067\u826f\u3044\u3067\u3059\u3002\n\n```sh\n# [nfs01/nfs02]\nsudo systemctl start pacemaker.service\nsudo systemctl status pacemaker.service\n```\n\n\u4e21\u65b9\u306e\u30ce\u30fc\u30c9\u304c\u30aa\u30f3\u30e9\u30a4\u30f3\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```sh\n# [nfs01]\nsudo crm_mon -1\n# (...snip...)\n#\n# Online: [ nfs01 nfs02 ]\n#\n# (...snip...)\n```\n\n## Pacemaker\n\nPacemaker \u306e\u30ea\u30bd\u30fc\u30b9\u5b9a\u7fa9\u3092\u884c\u3044\u307e\u3059\u3002\n\n\u307e\u305a\u306f\u30d7\u30ed\u30d1\u30c6\u30a3\u3084\u30ea\u30bd\u30fc\u30b9\u30c7\u30d5\u30a9\u30eb\u30c8\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n```sh\n# [nfs01]\nsudo pcs property set stonith-enabled=\"false\"\nsudo pcs property set no-quorum-policy=\"ignore\"\nsudo pcs property set start-failure-is-fatal=\"false\"\nsudo pcs resource defaults migration-threshold=\"5\"\nsudo pcs resource defaults resource-stickiness=\"INFINITY\"\nsudo pcs resource defaults failure-timeout=\"3600s\"\n```\n\nCIB \u3092\u30d5\u30a1\u30a4\u30eb\u306b\u51fa\u529b\u3057\u307e\u3059\u3002\n\n```sh\n# [nfs01]\nsudo pcs cluster cib output.cib\n```\n\n\u51fa\u529b\u3057\u305f CIB \u30d5\u30a1\u30a4\u30eb\u3092\u5bfe\u8c61\u306b\u30ea\u30bd\u30fc\u30b9\u3092\u4f5c\u6210\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n\u307e\u305a\u306f DRBD \u306e\u30ea\u30bd\u30fc\u30b9\u3002\u3053\u308c\u306f Master/Slave \u30ea\u30bd\u30fc\u30b9\u3067\u3059\u3002\n\n```sh\n# [nfs01]\nsudo pcs -f output.cib resource create drbd ocf:linbit:drbd \\\n  drbd_resource=\"nfs\" drbdconf=\"/etc/drbd.conf\" \\\n    op start timeout=\"240s\" on-fail=\"restart\" \\\n    op stop  timeout=\"100s\" on-fail=\"block\" \\\n    op monitor interval=\"20s\" timeout=\"20s\" start-delay=\"1m\" on-fail=\"restart\" \\\n      --master meta notify=\"true\" \n```\n\nDRBD \u30c7\u30d0\u30a4\u30b9\u306e\u30de\u30a6\u30f3\u30c8\u3001\u4eee\u60f3\u30a2\u30c9\u30ec\u30b9\u306e\u4ed8\u4e0e\u3001NFS \u30b5\u30fc\u30d0\u3001exportfs \u306e\u30ea\u30bd\u30fc\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u3053\u308c\u3089\u306f\u901a\u5e38\u306e\u30ea\u30bd\u30fc\u30b9\u3067\u3059\u3002\n\n```sh\n# [nfs01]\nsudo pcs -f output.cib resource create fs ocf:heartbeat:Filesystem \\\n  device=\"/dev/drbd/by-res/nfs\" directory=\"/drbd/nfs\" fstype=\"xfs\" \\\n    op start timeout=\"60s\" on-fail=\"restart\" \\\n    op stop  timeout=\"60s\" on-fail=\"block\" \\\n    op monitor interval=\"10s\" timeout=\"60s\" on-fail=\"restart\"\n\nsudo pcs -f output.cib resource create vip ocf:heartbeat:IPaddr2 \\\n  ip=\"192.168.33.20\" cidr_netmask=\"24\" nic=\"enp0s8\" \\\n    op start timeout=\"20s\" on-fail=\"restart\" \\\n    op stop  timeout=\"20s\" on-fail=\"block\" \\\n    op monitor interval=\"10s\" timeout=\"20s\" on-fail=\"restart\"\n\nsudo pcs -f output.cib resource create nfsserver ocf:heartbeat:nfsserver \\\n  nfs_shared_infodir=\"/drbd/nfs/var-lib-nfs\" \\\n    op start timeout=\"20s\" \\\n    op stop  timeout=\"20s\" \\\n    op monitor interval=\"10s\" timeout=\"10s\" on-fail=\"restart\" start-delay=\"20s\"\n\nsudo pcs -f output.cib resource create exportfs ocf:heartbeat:exportfs \\\n  clientspec=\"192.168.33.0/24\" options=\"rw,no_root_squash\" directory=\"/drbd/nfs/nfsroot\" fsid=\"root\"\n```\n\n\u30b0\u30eb\u30fc\u30d7\u306b\u3057\u307e\u3059\u3002\n\n```sh\n# [nfs01]\nsudo pcs -f output.cib resource group add group-nfs fs vip nfsserver exportfs\n```\n\ndrbd \u30ea\u30bd\u30fc\u30b9\u3068\u2191\u306e\u30b0\u30eb\u30fc\u30d7\u3068\u306e\u5236\u7d04\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u2191\u306e\u30b0\u30eb\u30fc\u30d7\u306f drbd \u306e\u30de\u30b9\u30bf\u30fc\u3068\u540c\u3058\u30ce\u30fc\u30c9\u3067\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u3057\u3001drbd \u306e\u30d7\u30ed\u30e2\u30fc\u30c8\u304c\u5148\u306b\u884c\u308f\u308c\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n```sh\n# [nfs01]\nsudo pcs -f output.cib constraint colocation add master drbd-master with group-nfs INFINITY\nsudo pcs -f output.cib constraint order promote drbd-master then start group-nfs\n```\n\nCIB \u30d5\u30a1\u30a4\u30eb\u306e\u5909\u66f4\u3092\u9069\u7528\u3057\u307e\u3059\u3002\n\n```sh\n# [nfs01]\nsudo pcs cluster cib-push output.cib\n```\n\n\u30b9\u30c6\u30fc\u30bf\u30b9\u3092\u8868\u793a\u3055\u305b\u3066\u305d\u308c\u3063\u307d\u304f\u306a\u3063\u3066\u3044\u308c\u3070 OK \u3067\u3059\u3002\n\n```sh\n# [nfs01]\nsudo pcs status\n# (...snip...)\n#\n# Online: [ nfs01 nfs02 ]\n# \n# Full list of resources:\n# \n#  Master/Slave Set: drbd-master [drbd]\n#      Masters: [ nfs01 ]\n#      Slaves: [ nfs02 ]\n#  Resource Group: group-nfs\n#      fs (ocf::heartbeat:Filesystem):    Started nfs01\n#      vip        (ocf::heartbeat:IPaddr2):       Started nfs01\n#      nfsserver  (ocf::heartbeat:nfsserver):     Started nfs01\n#      exportfs   (ocf::heartbeat:exportfs):      Started nfs01\n# \n# (...snip...)\n```\n\n## \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u30de\u30a6\u30f3\u30c8\n\nsv01 \u304b\u3089\u30de\u30a6\u30f3\u30c8\u3057\u3066\u9069\u5f53\u306b\u30d5\u30a1\u30a4\u30eb\u3092\u66f8\u3044\u3066\u307f\u307e\u3059\u3002\n\n```sh\n# [sv01]\nsudo mount -t nfs nfsvip:/drbd/nfs/nfsroot /mnt -o rw,rsize=8192,wsize=8192,soft,intr,timeo=20,retrans=3\nuname -n | sudo tee /mnt/$(uname -n)\n```\n\nsv02 \u304b\u3089\u3082\u30de\u30a6\u30f3\u30c8\u3057\u3066\u9069\u5f53\u306b\u30d5\u30a1\u30a4\u30eb\u3092\u66f8\u3044\u3066\u307f\u307e\u3059\u3002\n\n```sh\n# [sv02]\nsudo mount -t nfs nfsvip:/drbd/nfs/nfsroot /mnt -o rw,rsize=8192,wsize=8192,soft,intr,timeo=20,retrans=3\nuname -n | sudo tee /mnt/$(uname -n)\n```\n\n\u76f8\u4e92\u306b\u8aad\u3081\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```sh\n# [sv01]\ncat /mnt/sv02\n\n# [sv02]\ncat /mnt/sv01\n```\n\n## \u969c\u5bb3\u767a\u751f\n\nNFS \u306e\u30ce\u30fc\u30c9\u3067\u969c\u5bb3\u304c\u767a\u751f\u3057\u305f\u3068\u304d\u306e\u52d5\u4f5c\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\nsv01 \u3067\u30de\u30a6\u30f3\u30c8\u5148\u306e\u30d5\u30a1\u30a4\u30eb\u306b\u9023\u7d9a\u3057\u3066\u66f8\u304d\u8fbc\u307f\u307e\u304f\u308a\u307e\u3059\u3002\n\n```sh\n# [sv01]\nsudo touch /mnt/date.txt\nsudo chown $USER: /mnt/date.txt\nwhile sleep 0.1; do date 1>&2; date > /mnt/date.txt; done\n```\n\n\u304a\u3082\u3080\u308d\u306b\u30a2\u30af\u30c6\u30a3\u30d6\u5074\u306e\u30ce\u30fc\u30c9\u3092\u5f37\u5236\u7d42\u4e86\u3055\u305b\u307e\u3059\u3002\n\n```sh\n# [nfs01]\nsudo halt -f\n```\n\n20\u79d2\u3050\u3089\u3044\u66f8\u304d\u8fbc\u307f\u304c\u6b62\u307e\u3063\u305f\u5f8c\u3001I/O error \u306b\u306a\u3063\u3066\u66f8\u304d\u8fbc\u307f\u304c\u518d\u958b\u3057\u307e\u3057\u305f\u3002\n\n```sh\n# [sv01]\n# (...snip...)\n# Tue Jun  7 01:47:23 UTC 2016\n# Tue Jun  7 01:47:23 UTC 2016\n# -bash: /mnt/date.txt: Input/output error\n# Tue Jun  7 01:47:40 UTC 2016\n# Tue Jun  7 01:47:40 UTC 2016\n# (...snip...)\n```\n\n\u5b9f\u969b\u306e\u6642\u9593\u3084\u52d5\u4f5c\u306f Pacemaker/Corosync \u306e\u8a2d\u5b9a\u3084 NFS \u306e\u30de\u30a6\u30f3\u30c8\u30aa\u30d7\u30b7\u30e7\u30f3\u306b\u3088\u3063\u3066\u5909\u308f\u308a\u307e\u3059\u3002\n\n\u306a\u304a\u3001DRBD \u306e\u30c7\u30a3\u30b9\u30af\u306b\u30eb\u30fc\u30d7\u30d0\u30c3\u30af\u30c7\u30d0\u30a4\u30b9\u3092\u4f7f\u7528\u3057\u3066\u3044\u308b\u306e\u3068\u3001pacemaker \u306e\u81ea\u52d5\u8d77\u52d5\u3092\u8a2d\u5b9a\u3057\u3066\u3044\u306a\u3044\u306e\u3067\u3001\u30ce\u30fc\u30c9\u306e\u518d\u8d77\u52d5\u5f8c\u306f\u624b\u52d5\u3067\u30eb\u30fc\u30d7\u30d0\u30c3\u30af\u30c7\u30d0\u30a4\u30b9\u306e\u4f5c\u6210\u3068 pacemaker \u306e\u8d77\u52d5\u3092\u884c\u3046\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n```sh\n# [nfs01]\nsudo losetup /dev/loop0 /var/opt/drbddisk\nsudo systemctl start pacemaker\n```\n\n## \u30ce\u30fc\u30c9\u8d77\u52d5\u6642\u306e monitor \u3067 NFS Server \u304c\u958b\u59cb\u3057\u3066\u3057\u307e\u3046\u554f\u984c\n\nNFS \u306e\u30ce\u30fc\u30c9\u3092\u518d\u8d77\u52d5\u3057\u3066 pacemaker \u3092\u8d77\u52d5\u3057\u305f\u3068\u304d\u306b\u3067\u3059\u304c\u3001\u8d77\u52d5\u3057\u305f\u30ce\u30fc\u30c9\u306e\u5074\u3067\u4e0b\u8a18\u306e\u3088\u3046\u306b NFS server \u304c\u8d77\u52d5\u3057\u305f\u65e8\u306e\u30ed\u30b0\u304c\u8a18\u9332\u3055\u308c\u307e\u3057\u305f\u3002\n\n```\nnfsserver(nfsserver)[3486]: 2016/06/07_01:51:31 INFO: Status: rpcbind\nnfsserver(nfsserver)[3486]: 2016/06/07_01:51:31 INFO: Status: nfs-mountd\nnfsserver(nfsserver)[3486]: 2016/06/07_01:51:31 INFO: Starting NFS server ...\nnfsserver(nfsserver)[3486]: 2016/06/07_01:51:31 INFO: Start: rpcbind i: 10\nnfsserver(nfsserver)[3486]: 2016/06/07_01:51:31 INFO: Start: v3locking: 0\nnfsserver(nfsserver)[3486]: 2016/06/07_01:51:31 INFO: Start: nfs-mountd i: 10\nnfsserver(nfsserver)[3486]: 2016/06/07_01:51:31 INFO: Start: nfs-idmapd i: 10\nnfsserver(nfsserver)[3486]: 2016/06/07_01:51:31 INFO: Start: rpc-statd i: 10\nnfsserver(nfsserver)[3486]: 2016/06/07_01:51:31 INFO: executing sm-notify\nnfsserver(nfsserver)[3486]: 2016/06/07_01:51:31 INFO: NFS server started\nnfsserver(nfsserver)[3486]: 2016/06/07_01:51:31 INFO: Status: nfs-idmapd\nnfsserver(nfsserver)[3486]: 2016/06/07_01:51:31 INFO: Status: rpc-statd\n```\n\n\u3053\u306e\u5f8c\u76f4\u3050\u306b\u505c\u6b62\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n```\nnfsserver(nfsserver)[3782]: 2016/06/07_01:51:32 INFO: Stopping NFS server ...\nnfsserver(nfsserver)[3782]: 2016/06/07_01:51:32 INFO: Stop: threads\nnfsserver(nfsserver)[3782]: 2016/06/07_01:51:32 INFO: Stop: rpc-statd\nnfsserver(nfsserver)[3782]: 2016/06/07_01:51:32 INFO: Stop: nfs-idmapd\nnfsserver(nfsserver)[3782]: 2016/06/07_01:51:32 INFO: Stop: nfs-mountd\nnfsserver(nfsserver)[3782]: 2016/06/07_01:51:32 INFO: Stop: rpcbind\nnfsserver(nfsserver)[3782]: 2016/06/07_01:51:32 INFO: NFS server stopped\n```\n\n\u30a2\u30af\u30c6\u30a3\u30d6\u5074\uff08DC\u5074\u3067\u3082\u3042\u308b\uff09\u3067\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306b nfsserver \u304c\u4e21\u65b9\u306e\u30ce\u30fc\u30c9\u3067\u958b\u59cb\u3057\u3066\u3044\u308b\u65e8\u306e\u30ed\u30b0\u304c\u8a18\u9332\u3055\u308c\u3066\u3044\u307e\u3057\u305f\u3002\n\n```\nJun 07 01:51:32 [19992] nfs02    pengine:    error: native_create_actions:  Resource nfsserver (ocf::nfsserver) is active on 2 nodes attempting recovery\nJun 07 01:51:32 [19992] nfs02    pengine:  warning: native_create_actions:  See http://clusterlabs.org/wiki/FAQ#Resource_is_Too_Active for more information.\n```\n\n\u3053\u306e\u5f8c\u306b\u4e21\u65b9\u306e\u30ce\u30fc\u30c9\u3067 NFS server \u304c\u505c\u6b62\u3057\u3066\u30a2\u30af\u30c6\u30a3\u30d6\u5074\u3067\u306e\u307f\u518d\u958b\u3057\u3066\u3044\u308b\u306e\u3067\u3059\u304c\u3001\u3053\u306e\u305f\u3081\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u306f\u4e00\u6642\u7684\u306b\u66f8\u304d\u8fbc\u307f\u304c\u5931\u6557\u3057\u3066\u3044\u307e\u3059\u3002\n\n```\nTue Jun  7 01:51:32 UTC 2016\nTue Jun  7 01:51:32 UTC 2016\n-bash: /mnt/date.txt: Permission denied\nTue Jun  7 01:51:32 UTC 2016\n-bash: /mnt/date.txt: Permission denied\nTue Jun  7 01:51:32 UTC 2016\nTue Jun  7 01:51:32 UTC 2016\nTue Jun  7 01:51:39 UTC 2016\nTue Jun  7 01:51:39 UTC 2016\n```\n\nnfsserver \u306e ocf \u30d5\u30a1\u30a4\u30eb (`/usr/lib/ocf/resource.d/heartbeat/nfsserver`) \u3092\u898b\u305f\u611f\u3058\u3001\n\n```sh\nnfsserver_monitor ()\n{\n        # Skip trying to start processes once before failing\n        # when run from nfsserver_start ()\n        if [ \"$1\" == \"fromstart\" ]; then\n                ocf_log info \"fromstart\"\n                fromstart=1\n        else\n                tries=1\n        fi\n:\n                ocf_log info \"Status: rpcbind\"\n                rpcinfo &> /dev/null\n                rc=$?\n                if [ \"$rc\" -ne \"0\" ]; then\n                        if [ ! \"$fromstart\" ] && [ \"$tries\" -gt \"0\" ]; then\n                                nfsserver_start frommonitor\n                                rc=$?\n                                let tries=$tries-1\n                        fi\n                        if [ \"$rc\" -ne \"0\" ]; then\n                                ocf_exit_reason \"rpcbind is not running\"\n                                return $OCF_NOT_RUNNING\n                        fi\n                fi\n:\n}\n```\n\nmonitor \u3067\u30ea\u30bd\u30fc\u30b9\u306e\u958b\u59cb\u304c\u884c\u308f\u308c\u3066\u3057\u307e\u3046\u3088\u3046\u3067\u3059\u30fb\u30fb\u30fb\uff1f\n\nocf \u306f resource-agents \u30d1\u30c3\u30b1\u30fc\u30b8\u306b\u542b\u307e\u308c\u3066\u3044\u307e\u3059\u304c\u3001\u30a2\u30c3\u30d7\u30b9\u30c8\u30ea\u30fc\u30e0\u3067\u306f\u3053\u306e\u3088\u3046\u306a\u5185\u5bb9\u306b\u306f\u306a\u3063\u3066\u3044\u307e\u305b\u3093\u3067\u3057\u305f\u3002\n\nCentOS 7 \u306e resource-agents \u306e SRPM \u3092\u898b\u3066\u307f\u305f\u3068\u3053\u308d bz1304370-nfsserver-fix-systemd-status-detection.patch \u3067\u3053\u306e\u5909\u66f4\u304c\u884c\u308f\u308c\u3066\u3044\u307e\u3057\u305f\u304c\u30fb\u30fb\u30fb\n\n[RHBZ#1304370](https://bugzilla.redhat.com//show_bug.cgi?id=1304370)\n\n\u975e\u516c\u958b\u306e\u3088\u3046\u3067\u3059\u3002\n\nmonitor \u3067\u30ea\u30bd\u30fc\u30b9\u304c\u958b\u59cb\u3055\u308c\u308b\u306e\u306f\u306a\u306b\u304b\u306e\u9593\u9055\u3044\u3060\u3068\u3057\u304b\u601d\u3048\u307e\u305b\u3093\u3002\u3068\u308a\u3042\u3048\u305a ocf \u3067 `tries=0` \u306b\u3059\u308c\u3070 monitor \u304b\u3089\u30ea\u30bd\u30fc\u30b9\u306e\u958b\u59cb\u306f\u884c\u308f\u308c\u306a\u304f\u306a\u308b\u306e\u3067\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306b\u30d1\u30c3\u30c1\u3059\u308b\u3053\u3068\u306b\u3057\u307e\u3057\u305f\u3002\n\n```sh\nsudo cp -a /usr/lib/ocf/resource.d/heartbeat/nfsserver{,.orig}\nsudo sed 's/tries=1/tries=0/g' -i /usr/lib/ocf/resource.d/heartbeat/nfsserver\ndiff -u /usr/lib/ocf/resource.d/heartbeat/nfsserver{.orig,}\n```\n\n```diff\n--- /usr/lib/ocf/resource.d/heartbeat/nfsserver.orig    2016-05-12 14:02:40.000000000 +0000\n+++ /usr/lib/ocf/resource.d/heartbeat/nfsserver 2016-06-07 02:04:09.825775009 +0000\n@@ -364,7 +364,7 @@\n                ocf_log info \"fromstart\"\n                fromstart=1\n        else\n-               tries=1\n+               tries=0\n        fi\n \n        # systemd\n```\n\n## nfsserver \u306f\u30af\u30ed\u30fc\u30f3\u30ea\u30bd\u30fc\u30b9\u3067\u3082\u826f\u3044\uff1f\n\n\u4e0b\u8a18\u3060\u3068 nfsserver \u306f systemd \u306e\u30ea\u30bd\u30fc\u30b9\u3067\u5b9a\u7fa9\u3057\u3066\u30af\u30ed\u30fc\u30f3\u30ea\u30bd\u30fc\u30b9\u306b\u3057\u3066\u3044\u307e\u3057\u305f\u3002\n\nhttps://www.suse.com/documentation/sle-ha-12/book_sleha_techguides/data/sec_ha_quick_nfs_resources.html#sec_ha_quick_nfs_resources_nfsserver\n\n\u305d\u308c\u3082\u30a2\u30ea\u306a\u306e\u304b\u306a\uff1f\u3001\u8a66\u3057\u3066\u307f\u307e\u3057\u305f\u3002\u307e\u305a\u306f DRBD \u306e\u30de\u30a6\u30f3\u30c8\u30dd\u30a4\u30f3\u30c8\u3092 exportfs \u3059\u308b\u69cb\u6210\u3067\u3001\u3053\u306e\u5834\u5408\u306f exportfs \u3082\u30af\u30ed\u30fc\u30f3\u30ea\u30bd\u30fc\u30b9\u306b\u3067\u304d\u307e\u3059\u3002\n\n```sh\nsudo pcs resource delete exportfs\nsudo pcs resource delete nfsserver\nsudo pcs resource cleanup exportfs\nsudo pcs resource cleanup nfsserver\n\nsudo pcs resource create nfsserver systemd:nfs-server \\\n  op monitor interval=\"30s\"\n\nsudo pcs resource create exportfs ocf:heartbeat:exportfs \\\n  clientspec=\"192.168.33.0/24\" options=\"rw,no_root_squash\" directory=\"/drbd/nfs\" fsid=\"root\" \\\n  op monitor interval=\"30s\"\n\nsudo pcs resource group add group-nfsserver nfsserver exportfs\nsudo pcs resource clone group-nfsserver\n\nsudo pcs constraint colocation add group-nfs with group-nfsserver-clone INFINITY\nsudo pcs constraint order start group-nfsserver-clone then start group-nfs\n```\n\n\u6b21\u306b DRBD \u306e\u30de\u30a6\u30f3\u30c8\u30dd\u30a4\u30f3\u30c8\u306e\u30b5\u30d6\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092 exportfs \u3059\u308b\u69cb\u6210\u3067\u3001\u3053\u306e\u5834\u5408\u306f exportfs \u306f\u901a\u5e38\u306e\u30ea\u30bd\u30fc\u30b9\u3067 fs \u3068\u304b vip \u3068\u304b\u3068\u540c\u3058\u30b0\u30eb\u30fc\u30d7\u306b\u3057\u307e\u3059\u3002\n\n```sh\nsudo pcs resource delete exportfs\nsudo pcs resource delete nfsserver\nsudo pcs resource cleanup exportfs\nsudo pcs resource cleanup nfsserver\n\nsudo pcs resource create nfsserver systemd:nfs-server \\\n  op monitor interval=\"30s\" --clone\n\nsudo pcs resource create exportfs ocf:heartbeat:exportfs \\\n  clientspec=\"192.168.33.0/24\" options=\"rw,no_root_squash\" directory=\"/drbd/nfs/nfsroot\" fsid=\"root\" \\\n  op monitor interval=\"30s\"\n\n# fs vip exportfs\nsudo pcs resource group add group-nfs exportfs\n\nsudo pcs constraint colocation add group-nfs with nfsserver-clone INFINITY\nsudo pcs constraint order start nfsserver-clone then start group-nfs\n```\n\n\u898b\u305f\u611f\u3058\u3001\u3069\u3061\u3089\u306e\u65b9\u6cd5\u3067\u3082\u554f\u984c\u7121\u3055\u305d\u3046\u3067\u3057\u305f\u3002`/var/lib/nfs/` \u3063\u3066\u540c\u671f\u3057\u306a\u304f\u3066\u3082\u3044\u3044\u3082\u306e\u306a\u306e\uff1f\n\n`/var/lib/nfs/` \u3092\u540c\u671f\u3057\u3066\u3044\u306a\u3044\u3068\u30d5\u30a7\u30a4\u30eb\u30aa\u30fc\u30d0\u30fc\u3057\u305f\u3068\u304d\u306b\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3067\u30de\u30a6\u30f3\u30c8\u3057\u306a\u304a\u3059\u5fc5\u8981\u304c\u3042\u308b\u3068\u601d\u3063\u3066\u305f\u3093\u3060\u3051\u3069\u305d\u3093\u306a\u3053\u3068\u3082\u7121\u3055\u305d\u3046\u3002tcp/udp \u3068\u304b nfs v3/v4 \u3068\u304b\u306b\u3088\u3063\u3066\u7570\u306a\u308b\u306e\u3060\u308d\u3046\u304b\uff1f\n", "tags": ["drbd", "pacemaker", "corosync", "nfs"]}