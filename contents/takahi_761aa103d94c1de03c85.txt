{"context": "\n\n\u5916\u90e8\u306eKML\u30c7\u30fc\u30bf\u3092\u7c21\u5358\u306b\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u3057\u305f\u3044\n\u30aa\u30fc\u30d7\u30f3\u30c7\u30fc\u30bf\u306a\u3069\u3067\u81ea\u6cbb\u4f53\u304b\u3089\u516c\u958b\u3055\u308c\u308b\u7a7a\u9593\u60c5\u5831\uff08GIS\uff09\u3067\u306f\u3001KML\u3084KMZ\uff08KML\u3092ZIP\u5727\u7e2e\u3057\u305f\u3082\u306e\uff09\u3092\u898b\u304b\u3051\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n\u9762\u5012\u306a\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3078\u306e\u30ed\u30fc\u30c9\nKML\u306fXML\u5f62\u5f0f\u306e\u30c6\u30ad\u30b9\u30c8\u30c7\u30fc\u30bf\u3067\u3059\u3002\u3053\u308c\u3092\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u8aad\u307f\u8fbc\u3080\u306b\u306f\uff12\u3064\u306e\u65b9\u6cd5\u304c\u3042\u308a\u307e\u3059\u3001\n\n\u30b3\u30f3\u30d4\u30e5\u30bf\u30fc\u30d7\u30ed\u30b0\u30e9\u30e0\u3067XML\u3092\u8aad\u8fbc\u307f\u3001\u6210\u5f62\u3057\u305f\u5f8c\u306b\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u53d6\u308a\u8fbc\u3080\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306bXML\u578b\u306e\u30c7\u30fc\u30bf\u3068\u3057\u3066\u53d6\u308a\u8fbc\u307f\u3001\u6210\u5f62\u3059\u308b\n\n\u3069\u3061\u3089\u3082XML\u30c7\u30fc\u30bf\u3092\u8aad\u8fbc\u307f\u52a0\u5de5\u3059\u308b\u30d7\u30ed\u30bb\u30b9\u3092\u53d6\u308a\u307e\u3059\u304c\u3001\u300c\uff11\u300d\u306e\u65b9\u5f0f\u3067\u306f\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u4ee5\u5916\u306b\u30d7\u30ed\u30b0\u30e9\u30df\u30f3\u30b0\u304c\u5fc5\u8981\u3067\u3059\u3002\u300c\uff12\u300d\u306e\u65b9\u6cd5\u3067\u306f\u3001XML\u3092\u53d6\u308a\u8fbc\u3093\u3067\u304b\u3089\u306f\u5168\u3066\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306eSQL\u3067\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\nPostgreSQL\u306bKML\u30c7\u30fc\u30bf\u3092\u30ed\u30fc\u30c9\nPostgreSQL\u306b\u306fXML\u578b\u304c\u5b9a\u7fa9\u3057\u3066\u3042\u308a\u3001XML\u30c7\u30fc\u30bf\u3092\u8aad\u8fbc\u30fb\u691c\u7d22\u30fb\u52a0\u5de5\u304c\u53ef\u80fd\u3067\u3059\u3002XML\u578b\u306e\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\u3057\u3001\u30c7\u30fc\u30bf\u3092\u30ed\u30fc\u30c9\u3057\u307e\u3059\u3002\n\nSTEP1_create_table.sql\n--XML\u578b\u306e\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\u3059\u308b\nCREATE TABLE t_kml(kml xml);\n\n\nCOPY\u6587\u3092\u4f7f\u3063\u3066\u3001\u5916\u90e8\u30d5\u30a1\u30a4\u30eb\u306eKML\u3092\u30c6\u30fc\u30d6\u30eb\u306b\u8aad\u307f\u8fbc\u307f\u307e\u3059\u3002\n\uff08MAC\u3084LINUX\u74b0\u5883\u304c\u524d\u63d0\u3067\u3059\u3002Windows\u306e\u5834\u5408\u306fCygwin\u306a\u3069\u3067cat,sed,tr\u304c\u4f7f\u3048\u308b\u3088\u3046\u306b\u3057\u3066\u4e0b\u3055\u3044\u3002\uff09\n\nSTEP2_copy_from_kml.sql\nCOPY t_kml FROM \nPROGRAM 'cat /tmp/od_gis_10121_kokudo.kml | sed -e ''s/xmlns=[^\"]*\\\"/\\hoge=\"/g'' | tr -d ''\\n'' '\nDELIMITER '*';\n-- /tmp/od_gis_10121_kokudo.kml \u304ckml\u30d5\u30a1\u30a4\u30eb\u306e\u30d5\u30eb\u30d1\u30b9\n\n\n\n\uff4b\uff4d\uff4c\u3092\u8aad\u307f\u8fbc\u3080\u30b3\u30c4\n\n\u540d\u524d\u7a7a\u9593(xmlns)\u306e\u524a\u9664 \n\n\n\uff58\uff4d\uff4c\u306e\u540d\u524d\u7a7a\u9593\u306e\u5ba3\u8a00<kml xmlns=\"URL\u306a\u3069\" >\u304c\u3042\u308b\u3068\u3001XML\u30c7\u30fc\u30bf\u306e\u30ed\u30fc\u30c9\u306b\u5931\u6557\u3059\u308b\u3053\u3068\u304b\u3089\u3001COPY\u30b3\u30de\u30f3\u30c9\u306ePROGRAM(PostgreSQL 9.3\u4ee5\u964d\uff09\u3092\u7528\u3044\u3066sed\u30b3\u30de\u30f3\u30c9\u3067xmlns\u3092hoge\u306b\u7f6e\u63db\u3057\u3066\u3044\u307e\u3059\u3002\uff08\u306a\u305cxmlns\u304c\u3042\u308b\u3068NG\u306a\u306e\u304b\u306f\u3001\u79c1\u306e\u52c9\u5f37\u4e0d\u8db3\u3067\u3088\u304f\u5206\u304b\u3089\u306a\u3044\uff09\n\n\n\u6539\u884c\u8a18\u53f7\u306e\u524a\u9664\n\n\nCOPY\u6587\u306f\u6539\u884c\u8a18\u53f7\u3067\u884c\u3092\u5224\u5225\u3057\u3066\u3057\u307e\u3044\u307e\u3059\u3002xml\u578b\u306fxml\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u5168\u4f53\u3092\uff11\u884c\u306e\u30c7\u30fc\u30bf\u3068\u3057\u3066\u53d6\u308a\u8fbc\u3080\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u306e\u3067\u3001\u6539\u884c\u8a18\u53f7\u304c\u90aa\u9b54\u3067\u3059\u3002\u305d\u3053\u3067tr -d '\\n'\u3067KML\u30c7\u30fc\u30bf\u306e\u5168\u3066\u306e\u6539\u884c\u8a18\u53f7\u3092\u524a\u9664\u3057\u3066\u3044\u307e\u3059\u3002\n\n\n\n\n\u7a7a\u9593\u30c7\u30fc\u30bf\u306e\u62bd\u51fa\n\u4eca\u56de\u306f\u65b0\u6f5f\u5e02\u306e\u30aa\u30fc\u30d7\u30f3\u30c7\u30fc\u30bf\u56fd\u9053\u3092\u4f8b\u306b\u8aac\u660e\u3057\u307e\u3059\u3002\n\u7dda\u5f62\u72b6\u3067\u8868\u73fe\u3055\u308c\u3066\u3044\u3066LineString\u3068\u3044\u3046\u30bf\u30b0\u306e\u4e2d\u306b\u683c\u7d0d\u3055\u308c\u3066\u3044\u307e\u3059\u3002xpath\u95a2\u6570\u3092\u7528\u3044\u3066\u3001xml\u306e\u4e2d\u306eLineString\u30bf\u30b0\u3092\u62bd\u51fa\u3057\u3066\u307f\u307e\u3059\u3002\n\nSTEP3_select_LineString.sql\nSELECT \n unnest( line_data )::text AS line\nFROM \n (SELECT  \n   xpath(E'//LineString' , kml ) AS line_data \n  FROM t_kml\n ) AS main ;\n\n\n\n\u89e3\u8aac\u3000xpath(E'//LineString' , kml )\n\nkml\u5217\u306b\u683c\u7d0d\u3055\u308c\u3066\u3044\u308bXML\u30c7\u30fc\u30bf\u304b\u3089LineString\u30bf\u30b0\u3092\u62bd\u51fa\u3057\u307e\u3059\n\u623b\u308a\u5024\u306fxml\u914d\u5217\u578b\n\n\n\u89e3\u8aac unnest( line_data )::text\n\nunnset\u306f\u914d\u5217\u578b\u306e\u30c7\u30fc\u30bf\u3092\u8907\u6570\u306e\u884c\u306b\u5909\u63db\u3059\u308b\u5909\u63db\u3059\u308b\u95a2\u6570\u3067\u3059\n\n\n\n\n\u7a7a\u9593\u5206\u6790\n\u62bd\u51fa\u3057\u305fLineString\u30bf\u30b0\u3092\u7a7a\u9593\u60c5\u5831\u306b\u5909\u63db\u3057\u3066\u3001\u7a7a\u9593\u5206\u6790\u3092\u5b9f\u65bd\u3057\u307e\u3059\u3002\n\nSTEP4_get_legth.sql\nWITH base AS (\n    SELECT \n    unnest(pm)::text AS line\n    FROM (SELECT  xpath(E'//LineString' , kml ) AS pm  FROM t_kml ) AS main \n) \nSELECT \n SUM( ST_Length( ST_GeomFromKML( line ) ::geography ) )/1000 AS km_length , COUNT(*) AS road_link_num\nFROM \nbase \n;\n\n\n\n\u89e3\u8aac :\u3000ST_GeomFromKML( line )\n\nST_GeomFromKML\u306fKML\u306e\u30bf\u30b0\u3092\u6295\u5165\u3059\u308b\u3068\u7a7a\u9593\u60c5\u5831\uff08geometry\u578b)\u306b\u5909\u63db\u3057\u307e\u3059\n\n\n\u89e3\u8aac :ST_Length\n\n\u7dda\u5206\u5f62\u72b6\u306e\u9577\u3055\u3092\u7b97\u51fa\u3059\u308b\u95a2\u6570\u3067\u3059\u3002geography\u578b\u306e\u30c7\u30fc\u30bf\u306f\n\n\n\n\u5b9f\u884c\u7d50\u679c\n\n\n\nkm_length\nroad_link_num\n\n\n\n\n115.57520633318\n35\n\n\n\n\u5b9f\u884c\u306e\u7d50\u679c\u3001\u65b0\u6f5f\u5e02\u306e\u56fd\u9053\u306e\u9577\u3055\u306f\uff11\uff11\uff15\uff4b\uff4d\u3067\u3042\u308b\u3053\u3068\u304c\u5206\u304b\u308a\u307e\u3057\u305f\u3002\n#\u5916\u90e8\u306eKML\u30c7\u30fc\u30bf\u3092\u7c21\u5358\u306b\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u3057\u305f\u3044\n\n\u30aa\u30fc\u30d7\u30f3\u30c7\u30fc\u30bf\u306a\u3069\u3067\u81ea\u6cbb\u4f53\u304b\u3089\u516c\u958b\u3055\u308c\u308b\u7a7a\u9593\u60c5\u5831\uff08GIS\uff09\u3067\u306f\u3001KML\u3084KMZ\uff08KML\u3092ZIP\u5727\u7e2e\u3057\u305f\u3082\u306e\uff09\u3092\u898b\u304b\u3051\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n##\u9762\u5012\u306a\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3078\u306e\u30ed\u30fc\u30c9\n\nKML\u306fXML\u5f62\u5f0f\u306e\u30c6\u30ad\u30b9\u30c8\u30c7\u30fc\u30bf\u3067\u3059\u3002\u3053\u308c\u3092\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u8aad\u307f\u8fbc\u3080\u306b\u306f\uff12\u3064\u306e\u65b9\u6cd5\u304c\u3042\u308a\u307e\u3059\u3001\n\n 1. \u30b3\u30f3\u30d4\u30e5\u30bf\u30fc\u30d7\u30ed\u30b0\u30e9\u30e0\u3067XML\u3092\u8aad\u8fbc\u307f\u3001\u6210\u5f62\u3057\u305f\u5f8c\u306b\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u53d6\u308a\u8fbc\u3080\n 2. \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306bXML\u578b\u306e\u30c7\u30fc\u30bf\u3068\u3057\u3066\u53d6\u308a\u8fbc\u307f\u3001\u6210\u5f62\u3059\u308b\n\n\u3069\u3061\u3089\u3082XML\u30c7\u30fc\u30bf\u3092\u8aad\u8fbc\u307f\u52a0\u5de5\u3059\u308b\u30d7\u30ed\u30bb\u30b9\u3092\u53d6\u308a\u307e\u3059\u304c\u3001\u300c\uff11\u300d\u306e\u65b9\u5f0f\u3067\u306f\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u4ee5\u5916\u306b\u30d7\u30ed\u30b0\u30e9\u30df\u30f3\u30b0\u304c\u5fc5\u8981\u3067\u3059\u3002\u300c\uff12\u300d\u306e\u65b9\u6cd5\u3067\u306f\u3001XML\u3092\u53d6\u308a\u8fbc\u3093\u3067\u304b\u3089\u306f\u5168\u3066\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306eSQL\u3067\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n##PostgreSQL\u306bKML\u30c7\u30fc\u30bf\u3092\u30ed\u30fc\u30c9\n\nPostgreSQL\u306b\u306fXML\u578b\u304c\u5b9a\u7fa9\u3057\u3066\u3042\u308a\u3001XML\u30c7\u30fc\u30bf\u3092\u8aad\u8fbc\u30fb\u691c\u7d22\u30fb\u52a0\u5de5\u304c\u53ef\u80fd\u3067\u3059\u3002XML\u578b\u306e\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\u3057\u3001\u30c7\u30fc\u30bf\u3092\u30ed\u30fc\u30c9\u3057\u307e\u3059\u3002\n\n```sql:STEP1_create_table.sql\n--XML\u578b\u306e\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\u3059\u308b\nCREATE TABLE t_kml(kml xml);\n```\n\nCOPY\u6587\u3092\u4f7f\u3063\u3066\u3001\u5916\u90e8\u30d5\u30a1\u30a4\u30eb\u306eKML\u3092\u30c6\u30fc\u30d6\u30eb\u306b\u8aad\u307f\u8fbc\u307f\u307e\u3059\u3002\n\uff08MAC\u3084LINUX\u74b0\u5883\u304c\u524d\u63d0\u3067\u3059\u3002Windows\u306e\u5834\u5408\u306fCygwin\u306a\u3069\u3067cat,sed,tr\u304c\u4f7f\u3048\u308b\u3088\u3046\u306b\u3057\u3066\u4e0b\u3055\u3044\u3002\uff09\n\n```sql:STEP2_copy_from_kml.sql\nCOPY t_kml FROM \nPROGRAM 'cat /tmp/od_gis_10121_kokudo.kml | sed -e ''s/xmlns=[^\"]*\\\"/\\hoge=\"/g'' | tr -d ''\\n'' '\nDELIMITER '*';\n-- /tmp/od_gis_10121_kokudo.kml \u304ckml\u30d5\u30a1\u30a4\u30eb\u306e\u30d5\u30eb\u30d1\u30b9\n```\n\n###\uff4b\uff4d\uff4c\u3092\u8aad\u307f\u8fbc\u3080\u30b3\u30c4\n- \u540d\u524d\u7a7a\u9593(xmlns)\u306e\u524a\u9664 \n    - \uff58\uff4d\uff4c\u306e\u540d\u524d\u7a7a\u9593\u306e\u5ba3\u8a00`<kml xmlns=\"URL\u306a\u3069\" >`\u304c\u3042\u308b\u3068\u3001XML\u30c7\u30fc\u30bf\u306e\u30ed\u30fc\u30c9\u306b\u5931\u6557\u3059\u308b\u3053\u3068\u304b\u3089\u3001COPY\u30b3\u30de\u30f3\u30c9\u306e`PROGRAM`(PostgreSQL 9.3\u4ee5\u964d\uff09\u3092\u7528\u3044\u3066sed\u30b3\u30de\u30f3\u30c9\u3067xmlns\u3092hoge\u306b\u7f6e\u63db\u3057\u3066\u3044\u307e\u3059\u3002\uff08\u306a\u305cxmlns\u304c\u3042\u308b\u3068NG\u306a\u306e\u304b\u306f\u3001\u79c1\u306e\u52c9\u5f37\u4e0d\u8db3\u3067\u3088\u304f\u5206\u304b\u3089\u306a\u3044\uff09\n- \u6539\u884c\u8a18\u53f7\u306e\u524a\u9664\n    - COPY\u6587\u306f\u6539\u884c\u8a18\u53f7\u3067\u884c\u3092\u5224\u5225\u3057\u3066\u3057\u307e\u3044\u307e\u3059\u3002xml\u578b\u306fxml\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u5168\u4f53\u3092\uff11\u884c\u306e\u30c7\u30fc\u30bf\u3068\u3057\u3066\u53d6\u308a\u8fbc\u3080\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u306e\u3067\u3001\u6539\u884c\u8a18\u53f7\u304c\u90aa\u9b54\u3067\u3059\u3002\u305d\u3053\u3067` tr -d '\\n'`\u3067KML\u30c7\u30fc\u30bf\u306e\u5168\u3066\u306e\u6539\u884c\u8a18\u53f7\u3092\u524a\u9664\u3057\u3066\u3044\u307e\u3059\u3002\n\n##\u7a7a\u9593\u30c7\u30fc\u30bf\u306e\u62bd\u51fa\n\n\u4eca\u56de\u306f\u65b0\u6f5f\u5e02\u306e\u30aa\u30fc\u30d7\u30f3\u30c7\u30fc\u30bf[\u56fd\u9053](http://www.city.niigata.lg.jp/shisei/seisaku/it/open-data/opendata-gis/od-gis_dourosuido/od-gis_kokudo.files/od_gis_10121_kokudo.zip)\u3092\u4f8b\u306b\u8aac\u660e\u3057\u307e\u3059\u3002\n\u7dda\u5f62\u72b6\u3067\u8868\u73fe\u3055\u308c\u3066\u3044\u3066`LineString`\u3068\u3044\u3046\u30bf\u30b0\u306e\u4e2d\u306b\u683c\u7d0d\u3055\u308c\u3066\u3044\u307e\u3059\u3002xpath\u95a2\u6570\u3092\u7528\u3044\u3066\u3001xml\u306e\u4e2d\u306e`LineString`\u30bf\u30b0\u3092\u62bd\u51fa\u3057\u3066\u307f\u307e\u3059\u3002\n\n```sql:STEP3_select_LineString.sql\nSELECT \n unnest( line_data )::text AS line\nFROM \n (SELECT  \n   xpath(E'//LineString' , kml ) AS line_data \n  FROM t_kml\n ) AS main ;\n```\n\n- \u89e3\u8aac\u3000` xpath(E'//LineString' , kml )` \n    - kml\u5217\u306b\u683c\u7d0d\u3055\u308c\u3066\u3044\u308bXML\u30c7\u30fc\u30bf\u304b\u3089LineString\u30bf\u30b0\u3092\u62bd\u51fa\u3057\u307e\u3059\n    - \u623b\u308a\u5024\u306fxml\u914d\u5217\u578b\n- \u89e3\u8aac `unnest( line_data )::text`\n    - unnset\u306f\u914d\u5217\u578b\u306e\u30c7\u30fc\u30bf\u3092\u8907\u6570\u306e\u884c\u306b\u5909\u63db\u3059\u308b\u5909\u63db\u3059\u308b\u95a2\u6570\u3067\u3059\n\n##\u7a7a\u9593\u5206\u6790\n\n\u62bd\u51fa\u3057\u305fLineString\u30bf\u30b0\u3092\u7a7a\u9593\u60c5\u5831\u306b\u5909\u63db\u3057\u3066\u3001\u7a7a\u9593\u5206\u6790\u3092\u5b9f\u65bd\u3057\u307e\u3059\u3002\n\n```sql:STEP4_get_legth.sql\nWITH base AS (\n\tSELECT \n\tunnest(pm)::text AS line\n\tFROM (SELECT  xpath(E'//LineString' , kml ) AS pm  FROM t_kml ) AS main \n) \nSELECT \n SUM( ST_Length( ST_GeomFromKML( line ) ::geography ) )/1000 AS km_length , COUNT(*) AS road_link_num\nFROM \nbase \n;\n```\n\n- \u89e3\u8aac :`\u3000ST_GeomFromKML( line )`\n    - ST_GeomFromKML\u306fKML\u306e\u30bf\u30b0\u3092\u6295\u5165\u3059\u308b\u3068\u7a7a\u9593\u60c5\u5831\uff08geometry\u578b)\u306b\u5909\u63db\u3057\u307e\u3059\n- \u89e3\u8aac :`ST_Length`\n    - \u7dda\u5206\u5f62\u72b6\u306e\u9577\u3055\u3092\u7b97\u51fa\u3059\u308b\u95a2\u6570\u3067\u3059\u3002geography\u578b\u306e\u30c7\u30fc\u30bf\u306f\n\n\u5b9f\u884c\u7d50\u679c\n\n| km_length| road_link_num |\n|:-----------|------------:|\n| 115.57520633318|35|  \n\n\u5b9f\u884c\u306e\u7d50\u679c\u3001\u65b0\u6f5f\u5e02\u306e\u56fd\u9053\u306e\u9577\u3055\u306f\uff11\uff11\uff15\uff4b\uff4d\u3067\u3042\u308b\u3053\u3068\u304c\u5206\u304b\u308a\u307e\u3057\u305f\u3002\n\n", "tags": ["GIS", "KML", "opendata", "PostgreSQL", "PostGIS"]}