{"context": "\u3064\u3044\u5148\u65e5serverless\u306b\u5165\u9580\u3057\u305f\u3070\u304b\u308a\u3067\u3059\u304c\u3001\n\u8272\u3005\u5b9f\u9a13\u3057\u305f\u7d50\u679cAPI\u304b\u3089\u53ec\u559a\u3055\u308c\u305fLambda\u304c\u65b0\u305f\u306aLambda\u3092\u52d5\u7684\u306b\u4f5c\u308a\u51fa\u3059\u3068\u3044\u3046\u9ed2\u9b54\u8853\u3092\u7fd2\u5f97\u3057\u305f\u306e\u3067\u3054\u7d39\u4ecb\u3057\u307e\u3059\u3002\n\u3084\u3084\u3053\u3057\u3044\u306e\u3067\u3001\u4ee5\u4e0bAPI\u304b\u3089\u53ec\u559a\u3055\u308c\u308bLambda\u30d5\u30a1\u30f3\u30af\u30b7\u30e7\u30f3\u3092\u89aa\u30e9\u30e0\u30c0\u3001\u89aa\u30e9\u30e0\u30c0\u306b\u4f5c\u308a\u51fa\u3055\u308c\u308bLambda\u30d5\u30a1\u30f3\u30af\u30b7\u30e7\u30f3\u3092\u5b50\u30e9\u30e0\u30c0\u3068\u8868\u8a18\u3057\u307e\u3059\u3002\n\n\u5b9f\u88c5\u65b9\u91dd\n\u52d5\u7684\u306b\u30b3\u30fc\u30c9\u3092\u3064\u304f\u308b\u3068\u3044\u3063\u3066\u3082js\u306e\u30b3\u30fc\u30c9\u3092\u30b4\u30ea\u30b4\u30ea\u4f5c\u308a\u51fa\u3059\u306e\u306f\u8f9b\u3044\u306e\u3067\u3001\u65b9\u91dd\u3068\u3057\u3066\u306f\n\nS3\u306b\u3072\u306a\u578b\u3068\u306a\u308bjs\u306e\u30b3\u30fc\u30c9\u3092\u7528\u610f(index.js\u3068\u3059\u308b)\n\u3072\u306a\u578b\u306e\u52d5\u7684\u306b\u5909\u5316\u3057\u3046\u308b\u7b87\u6240\u306f\u5916\u90e8\u30d5\u30a1\u30a4\u30eb\u304b\u3089\u8aad\u307f\u8fbc\u3080\u3088\u3046\u306b\u3059\u308b(parameters.json\u304b\u3089\u8aad\u307f\u8fbc\u3080)\nparamaters.json\u306e\u5b9f\u4f53\u306f\u89aa\u30e9\u30e0\u30c0\u5185\u3067API\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u30dc\u30c7\u30a3\u304b\u3089\u4f5c\u6210\nindex.js\u3068parametes.json\u3092\u307e\u3068\u3081\u3066zip\u5727\u7e2e\n4\u3067\u4f5c\u6210\u3057\u305fzip\u3092\u30bd\u30fc\u30b9\u306b\u5b50\u30e9\u30e0\u30c0\u4f5c\u6210\n\n\u306a\u3093\u3060\u304b\u3044\u3051\u305d\u3046\u306a\u6c17\u304c\u3057\u307e\u3059\u306d\u3002\n\n\u74b0\u5883\u69cb\u7bc9\n\nServerless\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u57fa\u672c\u7684\u306b\u306f\u62d9\u7a3f\u3092\u53c2\u8003\u306b\u3057\u3066\u3044\u305f\u3060\u3051\u308c\u3070\u3068\n\nserverless.yml\u306e\u7de8\u96c6\n\u305f\u3060\u3057\u3001\u4eca\u56de\u306fLambda\u3067\u65b0\u3057\u304f\u30d5\u30a1\u30f3\u30af\u30b7\u30e7\u30f3\u3092\u4f5c\u308b\u306e\u3067lambda:CreateFunction\u306e\u6a29\u9650\u3092\u4ed8\u4e0e\u3057\u3066\u304a\u304f\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u3042\u3068\u76f2\u70b9\u306b\u306a\u308a\u3084\u3059\u3044\u3068\u601d\u3046\u306e\u3067\u3059\u304c\u3001iam:PassRole\u306e\u6a29\u9650\u3082\u5fc5\u8981\u3067\u3059\u3002\n(\u65b0\u3057\u304f\u4f5c\u3063\u305f\u5b50\u30e9\u30e0\u30c0\u306bIAM\u30ed\u30fc\u30eb\u3092\u4ed8\u4e0e\u3059\u308b\u3053\u3068\u304c\u4e0d\u53ef\u907f\u306e\u305f\u3081\u3002\u79c1\u306f\u3053\u308c\u3067\u3057\u3070\u3089\u304f\u306f\u307e\u308a\u307e\u3057\u305f\u3002)\n\u30d5\u30a1\u30f3\u30af\u30b7\u30e7\u30f3\u540d\u306f\u30b7\u30f3\u30d7\u30eb\u306blambda\u3068\u3057\u3068\u304d\u307e\u3057\u3087\u3046\u3002\n\nserverless.yml\nservice: serverless-test\nprovider:\n  name: aws\n  runtime: nodejs4.3\n  stage: dev\n  region: us-east-1\n  iamRoleStatements:\n    - Effect: \"Allow\"\n      Action:\n        - \"s3:getObject\"\n        - \"s3:putObject\"\n      Resource: \"arn:aws:s3:::my-bucket-name/*\"\n    - Effect: \"Allow\"\n      Action:\n        - \"lambda:CreateFunction\"\n      Resource: \"*\"\n    - Effect: \"Allow\"\n      Action:\n        - \"iam:PassRole\"\n      Resource: \"arn:aws:iam::my-account-id:role/serverless-created-function\"\n\nfunctions:\n  lambda:\n    description: \"create lambda function\"\n    handler: handler.lambda\n    memorySize: 256\n    timeout: 60\n    events:\n        - http:\n            path: lambda\n            method: post\n\n\n\u5b50\u30e9\u30e0\u30c0\u306b\u3064\u3051\u308bIAM\u30ed\u30fc\u30eb\u306f\u3042\u3089\u304b\u3058\u3081\u4f5c\u6210\u3057\u3066\u304a\u304d\u307e\u3057\u3087\u3046\u3002\n\u3053\u3053\u3067\u306fserverless-created-function\u3068\u3044\u3046\u540d\u524d\u3067\u4f5c\u6210\u3057\u3066\u307e\u3059\u3002\n\n\u5b9f\u88c5\n\n\u5b50\u30e9\u30e0\u30c0\u7528\u306e\u3072\u306a\u578b\n\u5b9f\u9a13\u7528\u306a\u306e\u3067\u30b7\u30f3\u30d7\u30eb\u306b\u3001parameters.json\u306eoutput\u30d7\u30ed\u30d1\u30c6\u30a3\u304c\u3042\u3063\u305f\u3089\u30ed\u30b0\u306b\u51fa\u3059\u3060\u3051\u3067\u3059\u3002\n\nindex.js\n'use strict';\n\nconst params = require('./parameters.json');\n\nexports.handler = (event, context, callback) => {\n    if(!params.output){\n        callback(\"Parameter Empty!!\");\n    }else{\n        console.log(params.output);\n        callback(null, \"function succeed\");\n    }\n};\n\n\nparameters.json\u306f\u89aa\u30e9\u30e0\u30c0\u304c\u751f\u307f\u51fa\u3057\u3066\u304f\u308c\u308b\u306e\u3067\u3001\u3053\u3053\u3067\u4f5c\u308b\u5fc5\u8981\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\n\u89aa\u30e9\u30e0\u30c0\u306e\u30b3\u30fc\u30c9\n\u3055\u3066\u89aa\u30e9\u30e0\u30c0\u306e\u65b9\u3067\u3059\u304c\u3053\u3053\u3067\u5b9f\u88c5\u65b9\u91dd\u3092\u601d\u3044\u8fd4\u3057\u307e\u3057\u3087\u3046\u3002\n\u5bdf\u3057\u306e\u826f\u3044\u65b9\u306a\u3089\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u5730\u7344\u306e\u547c\u3073\u58f0\u304c\u805e\u3053\u3048\u3066\u304d\u305f\u304b\u3068\u601d\u3044\u307e\u3059\u3002\n\u5b9f\u9a13\u3068\u306f\u3044\u3048\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u304c\u4e8c\u91cd\u4e09\u91cd\u306b\u306a\u308b\u306e\u306f\u3055\u3059\u304c\u306b\u8f9b\u3044\u306e\u3067\u3001\n\u3053\u3053\u306fco\u3055\u3093\u306e\u529b\u3092\u501f\u308a\u307e\u3059\u3002\n\u305d\u3057\u3066zip\u306e\u751f\u6210\u306b\u306fnode-zip\u3092\u4f7f\u3044\u307e\u3059\u3002\n\u6700\u521d\u306f\nlet zipContent = zip.generate({base64: false,compression:'DEFLATE'});\nlambda.createFunction({\n            Code: {ZipFile: zipContent},\n            FunctionName: 'function_' + moment().format('YYYYMMDDHHmmssSSS'),\n            Handler: 'index.handler',\n            Role: IAM_ROLE,\n            Runtime: 'nodejs4.3',\n            MemorySize: 256,\n            Timeout: 60\n        }, (lambdaErr, lambdaData) => {\n            if(lambdaErr !== null){\n                reject(lambdaErr);\n            }else{\n                resolve(lambdaData);\n            }\n        });\n\n\u307f\u305f\u3044\u306b\u3084\u3063\u3066\u307f\u305f\u306e\u3067\u3059\u304c\u300c\u304a\u524d\u306e\u4e0a\u3052\u305f\u30d5\u30a1\u30a4\u30eb\u89e3\u51cd\u3067\u304d\u3078\u3093\u308f\u300d\u3068\u6012\u3089\u308c\u305f\u306e\u3067\u3001\u3084\u3080\u306a\u304f\u4e00\u5ea6zip\u30d5\u30a1\u30a4\u30eb\u3092\u4fdd\u5b58\u3059\u308b\u3053\u3068\u306b\u3057\u307e\u3057\u305f\u3002\n\u4e0a\u8a18\u306e\u30b3\u30fc\u30c9\u3060\u3068zipContent\u304c\u30d0\u30a4\u30ca\u30ea\u306b\u306a\u3063\u3066\u306a\u3044\u306e\u304c\u7406\u7531\u3063\u307d\u3044\u306e\u3067\u3059\u304c\u3001\u30bd\u30fc\u30b9\u5185\u3067\u30d0\u30a4\u30ca\u30ea\u306b\u5909\u63db\u3057\u3066\u3084\u308b\u65b9\u6cd5\u304c\u308f\u304b\u3089\u306a\u304b\u3063\u305f\u306e\u3067...\n\u3053\u306e\u8a18\u4e8b\u306b\u3088\u308b\u3068Lambda\u5185\u3067\u3082/tmp\u4ee5\u4e0b\u306f\u4e00\u6642\u4f5c\u696d\u9818\u57df\u3068\u3057\u3066\u4f7f\u3048\u308b\u3088\u3046\u3067\u3059\u3002\n\u203b\u305f\u3060\u3057\u3001\u540c\u3058\u74b0\u5883\u3067\u307b\u304b\u306b\u8ab0\u304c\u4f7f\u3063\u3066\u308b\u304b\u308f\u304b\u3089\u306a\u3044\u306e\u3067\u30d5\u30a1\u30a4\u30eb\u540d\u306b\u6ce8\u610f\u3057\u3001\u5f8c\u7247\u4ed8\u3051\u3092\u5fd8\u308c\u305a\u3084\u3063\u3068\u304d\u307e\u3057\u3087\u3046\u3002\n\u5b8c\u6210\u3057\u305f\u546a\u6587\u304c\u3053\u3061\u3089\n\nfunctions/create_function.js\n'use strict';\n\nconst AWS = require('aws-sdk');\nconst moment = require('moment');\nconst IAM_ROLE = \"arn:aws:iam::my-account-id:role/serverless-created-function\"; //\u5b50\u30e9\u30e0\u30c0\u306b\u4ed8\u4e0e\u3059\u308bIAM\u30ed\u30fc\u30eb\nconst nodeZip = require('node-zip');\nconst fs = require('fs');\nconst co = require('co');\n// Your first function handler\nmodule.exports = (event, context, callback) => {\n\n\n    const BUCKET = \"my-bucket-name\";\n    const zip = new nodeZip();\n\n    co(function *() {\n        try{\n            let objectData = yield s3GetObject({Bucket:BUCKET, Key: 'serverless-test/templates/index.js'});\n            zip.file('index.js', objectData.toString());\n            zip.file('parameters.json', JSON.stringify(event.body));\u3000//body\u4ee5\u4e0b\u3092json\u306b\u5410\u304d\u51fa\u3057\n            let zipContent = zip.generate({base64: false,compression:'DEFLATE'});\n            let zipFile = '/tmp/' + moment().format('YYYYMMDDHHmmssSSS') + '.zip'; //\u30d5\u30a1\u30a4\u30eb\u540d\u304c\u88ab\u3089\u306a\u3044\u3088\u3046\u306b \u771f\u9762\u76ee\u306b\u3084\u308b\u306a\u3089uuid\u3068\u304b\u4f7f\u3046\u3079\u304d\n\n            fs.writeFileSync(zipFile, zipContent, 'binary'); //zip\u30d5\u30a1\u30a4\u30eb\u4f5c\u6210\n            let result = yield lambdaCreateFunction(fs.readFileSync(zipFile));\n            fs.unlinkSync(zipFile); //zip\u30d5\u30a1\u30a4\u30eb\u524a\u9664\n            return result;\n\n        }catch(e){\n            console.log('failed:' + e);\n        }\n    }).then((data) => {\n        callback(null, data);\n    }).catch((error) => {\n        callback(error);\n    });\n};\n\nfunction s3GetObject(params){\n    const s3 = new AWS.S3();\n    return new Promise((resolve, reject) => {\n        s3.getObject(params,(err, data) => {\n            if(err){\n                reject(err);\n            }else{\n                resolve(data.Body);\n            }\n        });\n    });\n}\n\nfunction lambdaCreateFunction(zipFileContent){\n    const lambda = new AWS.Lambda({\n        region: 'us-east-1', //\u4eca\u56de\u79c1\u306f\u5317\u30f4\u30a1\u30fc\u30b8\u30cb\u30a2\u30ea\u30fc\u30b8\u30e7\u30f3\u3092\u4f7f\u3063\u3066\u307e\u3059\n        apiVersion: '2015-03-31'\n    });\n    return new Promise((resolve, reject) => {\n        lambda.createFunction({\n            Code: {ZipFile: zipFileContent},\n            FunctionName: 'function_' + moment().format('YYYYMMDDHHmmssSSS'),\n            Handler: 'index.handler',\n            Role: IAM_ROLE,\n            Runtime: 'nodejs4.3',\n            MemorySize: 256,\n            Timeout: 60\n        }, (lambdaErr, lambdaData) => {\n            if(lambdaErr !== null){\n                reject(lambdaErr);\n            }else{\n                resolve(lambdaData);\n            }\n        });\n    });\n}\n\n\n\n\u975e\u540c\u671f\u51e6\u7406\u304c\u3053\u3093\u306a\u306b\u30b9\u30c3\u30ad\u30ea\u66f8\u3051\u308b\u306a\u3093\u3066\u3001co\u3055\u3093\u306f\u5049\u5927\u3067\u3059\u3002\n\u3042\u3068\u306fhandler.js\u306bmodule.exports.lambda = require('./functions/create_function');\u3068\u8ffd\u8a18\u3059\u308c\u3070\u9ed2\u9b54\u8853\u306e\u5b8c\u6210\n\n\u5b9f\u884c\n\u3067\u306f\u3001\u9ed2\u9b54\u8853\u3092\u5b9f\u884c\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\u307e\u305a\u30c6\u30b9\u30c8\u7528\u306bevent.json\u3092\u7de8\u96c6\n\nevent.json\n{\n  \"body\":{\n    \"output\": \"\u30e9\u30e0\u30c0\u304c\u30e9\u30e0\u30c0\u3092\u751f\u307f\u51fa\u3059\u9ed2\u9b54\u8853\"\n  }\n}\n\n\n\u30c7\u30d7\u30ed\u30a4&\u5b9f\u884c\nserverless deploy\nserverless invoke --function lambda --path ./event.json\n\u3053\u3046\u3059\u308b\u3053\u3068\u3067event.json\u306e\u4e2d\u8eab\u304c\u89aa\u30e9\u30e0\u30c0\u306e\u5f15\u6570\u3067\u3042\u308bevent\u306b\u305d\u306e\u307e\u307e\u653e\u308a\u8fbc\u307e\u308c\u307e\u3059\u3002\nAPI\u304b\u3089\u30ea\u30af\u30a8\u30b9\u30c8\u3057\u305f\u5834\u5408\u306f\u3001\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u30fc\u306e\u4e2d\u8eab\u304cevent\u306b\u5165\u308a\u307e\u3059\u3002\n\u305d\u3057\u3066...\n\n\u751f\u307e\u308c\u305f...!\u65b0\u305f\u306a\u308bLambda\u304c...!\n\u751f\u307e\u308c\u305f\u3066\u306e\u5b50\u30e9\u30e0\u30c0\u306b\u306f\u30c8\u30ea\u30ac\u30fc\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u306a\u3044\u306e\u3067\u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089\u30c6\u30b9\u30c8\u5b9f\u884c\u3057\u307e\u3059\u3002\n\n\u308f\u304b\u308a\u306b\u304f\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u304c\u3001event.json\u3067\u8a2d\u5b9a\u3057\u305f\u6587\u5b57\u5217\u304c\u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089\u51fa\u529b\u3055\u308c\u3066\u307e\u3059\u3002\n\u4eca\u56de\u306f\u5358\u306a\u308b\u5b9f\u9a13\u3063\u3066\u611f\u3058\u3067\u3057\u305f\u304c\u3001\u3082\u3046\u5c11\u3057\u9811\u5f35\u308c\u3070\u52d5\u7684\u306bAPI\u3092\u751f\u6210\u306a\u3093\u3066\u3053\u3068\u3082\u3067\u304d\u305d\u3046\u3067\u5922\u304c\u5e83\u304c\u308a\u3093\u3050\u3067\u3059\u306d\u3002\n\n\u53c2\u8003\u30da\u30fc\u30b8\n\n\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\nco\u306e\u4f7f\u3044\u65b9\u30e1\u30e2\nAWS_Lambda_\u3092\u5229\u7528\u3059\u308b\u4e0a\u3067\u77e5\u3063\u3066\u304a\u3044\u305f\u307b\u3046\u304c\u3088\u3044\u3053\u3068\n\n\u3064\u3044\u5148\u65e5[serverless](https://github.com/serverless/serverless)\u306b\u5165\u9580\u3057\u305f\u3070\u304b\u308a\u3067\u3059\u304c\u3001\n\u8272\u3005\u5b9f\u9a13\u3057\u305f\u7d50\u679cAPI\u304b\u3089\u53ec\u559a\u3055\u308c\u305fLambda\u304c\u65b0\u305f\u306aLambda\u3092\u52d5\u7684\u306b\u4f5c\u308a\u51fa\u3059\u3068\u3044\u3046\u9ed2\u9b54\u8853\u3092\u7fd2\u5f97\u3057\u305f\u306e\u3067\u3054\u7d39\u4ecb\u3057\u307e\u3059\u3002\n\n\u3084\u3084\u3053\u3057\u3044\u306e\u3067\u3001\u4ee5\u4e0bAPI\u304b\u3089\u53ec\u559a\u3055\u308c\u308bLambda\u30d5\u30a1\u30f3\u30af\u30b7\u30e7\u30f3\u3092\u89aa\u30e9\u30e0\u30c0\u3001\u89aa\u30e9\u30e0\u30c0\u306b\u4f5c\u308a\u51fa\u3055\u308c\u308bLambda\u30d5\u30a1\u30f3\u30af\u30b7\u30e7\u30f3\u3092\u5b50\u30e9\u30e0\u30c0\u3068\u8868\u8a18\u3057\u307e\u3059\u3002\n\n# \u5b9f\u88c5\u65b9\u91dd\n\n\u52d5\u7684\u306b\u30b3\u30fc\u30c9\u3092\u3064\u304f\u308b\u3068\u3044\u3063\u3066\u3082js\u306e\u30b3\u30fc\u30c9\u3092\u30b4\u30ea\u30b4\u30ea\u4f5c\u308a\u51fa\u3059\u306e\u306f\u8f9b\u3044\u306e\u3067\u3001\u65b9\u91dd\u3068\u3057\u3066\u306f\n\n1. S3\u306b\u3072\u306a\u578b\u3068\u306a\u308bjs\u306e\u30b3\u30fc\u30c9\u3092\u7528\u610f(index.js\u3068\u3059\u308b)\n2. \u3072\u306a\u578b\u306e\u52d5\u7684\u306b\u5909\u5316\u3057\u3046\u308b\u7b87\u6240\u306f\u5916\u90e8\u30d5\u30a1\u30a4\u30eb\u304b\u3089\u8aad\u307f\u8fbc\u3080\u3088\u3046\u306b\u3059\u308b(parameters.json\u304b\u3089\u8aad\u307f\u8fbc\u3080)\n3. paramaters.json\u306e\u5b9f\u4f53\u306f\u89aa\u30e9\u30e0\u30c0\u5185\u3067API\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u30dc\u30c7\u30a3\u304b\u3089\u4f5c\u6210\n4. index.js\u3068parametes.json\u3092\u307e\u3068\u3081\u3066zip\u5727\u7e2e\n5. 4\u3067\u4f5c\u6210\u3057\u305fzip\u3092\u30bd\u30fc\u30b9\u306b\u5b50\u30e9\u30e0\u30c0\u4f5c\u6210\n\n\u306a\u3093\u3060\u304b\u3044\u3051\u305d\u3046\u306a\u6c17\u304c\u3057\u307e\u3059\u306d\u3002\n\n# \u74b0\u5883\u69cb\u7bc9\n\n## Serverless\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n\u57fa\u672c\u7684\u306b\u306f[\u62d9\u7a3f](http://qiita.com/Mic-U/items/07d2b9dcd7a34a98f8f5)\u3092\u53c2\u8003\u306b\u3057\u3066\u3044\u305f\u3060\u3051\u308c\u3070\u3068\n\n## serverless.yml\u306e\u7de8\u96c6\n\n\u305f\u3060\u3057\u3001\u4eca\u56de\u306fLambda\u3067\u65b0\u3057\u304f\u30d5\u30a1\u30f3\u30af\u30b7\u30e7\u30f3\u3092\u4f5c\u308b\u306e\u3067lambda:CreateFunction\u306e\u6a29\u9650\u3092\u4ed8\u4e0e\u3057\u3066\u304a\u304f\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u3042\u3068\u76f2\u70b9\u306b\u306a\u308a\u3084\u3059\u3044\u3068\u601d\u3046\u306e\u3067\u3059\u304c\u3001iam:PassRole\u306e\u6a29\u9650\u3082\u5fc5\u8981\u3067\u3059\u3002\n(\u65b0\u3057\u304f\u4f5c\u3063\u305f\u5b50\u30e9\u30e0\u30c0\u306bIAM\u30ed\u30fc\u30eb\u3092\u4ed8\u4e0e\u3059\u308b\u3053\u3068\u304c\u4e0d\u53ef\u907f\u306e\u305f\u3081\u3002\u79c1\u306f\u3053\u308c\u3067\u3057\u3070\u3089\u304f\u306f\u307e\u308a\u307e\u3057\u305f\u3002)\n\n\u30d5\u30a1\u30f3\u30af\u30b7\u30e7\u30f3\u540d\u306f\u30b7\u30f3\u30d7\u30eb\u306blambda\u3068\u3057\u3068\u304d\u307e\u3057\u3087\u3046\u3002\n\n```yaml:serverless.yml\nservice: serverless-test\nprovider:\n  name: aws\n  runtime: nodejs4.3\n  stage: dev\n  region: us-east-1\n  iamRoleStatements:\n    - Effect: \"Allow\"\n      Action:\n        - \"s3:getObject\"\n        - \"s3:putObject\"\n      Resource: \"arn:aws:s3:::my-bucket-name/*\"\n    - Effect: \"Allow\"\n      Action:\n        - \"lambda:CreateFunction\"\n      Resource: \"*\"\n    - Effect: \"Allow\"\n      Action:\n        - \"iam:PassRole\"\n      Resource: \"arn:aws:iam::my-account-id:role/serverless-created-function\"\n\nfunctions:\n  lambda:\n    description: \"create lambda function\"\n    handler: handler.lambda\n    memorySize: 256\n    timeout: 60\n    events:\n        - http:\n            path: lambda\n            method: post\n```\n\n\u5b50\u30e9\u30e0\u30c0\u306b\u3064\u3051\u308bIAM\u30ed\u30fc\u30eb\u306f\u3042\u3089\u304b\u3058\u3081\u4f5c\u6210\u3057\u3066\u304a\u304d\u307e\u3057\u3087\u3046\u3002\n\u3053\u3053\u3067\u306fserverless-created-function\u3068\u3044\u3046\u540d\u524d\u3067\u4f5c\u6210\u3057\u3066\u307e\u3059\u3002\n\n# \u5b9f\u88c5\n\n## \u5b50\u30e9\u30e0\u30c0\u7528\u306e\u3072\u306a\u578b\n\n\u5b9f\u9a13\u7528\u306a\u306e\u3067\u30b7\u30f3\u30d7\u30eb\u306b\u3001parameters.json\u306eoutput\u30d7\u30ed\u30d1\u30c6\u30a3\u304c\u3042\u3063\u305f\u3089\u30ed\u30b0\u306b\u51fa\u3059\u3060\u3051\u3067\u3059\u3002\n\n```js:index.js\n'use strict';\n\nconst params = require('./parameters.json');\n\nexports.handler = (event, context, callback) => {\n    if(!params.output){\n        callback(\"Parameter Empty!!\");\n    }else{\n        console.log(params.output);\n        callback(null, \"function succeed\");\n    }\n};\n```\n\nparameters.json\u306f\u89aa\u30e9\u30e0\u30c0\u304c\u751f\u307f\u51fa\u3057\u3066\u304f\u308c\u308b\u306e\u3067\u3001\u3053\u3053\u3067\u4f5c\u308b\u5fc5\u8981\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\n## \u89aa\u30e9\u30e0\u30c0\u306e\u30b3\u30fc\u30c9\n\n\u3055\u3066\u89aa\u30e9\u30e0\u30c0\u306e\u65b9\u3067\u3059\u304c\u3053\u3053\u3067\u5b9f\u88c5\u65b9\u91dd\u3092\u601d\u3044\u8fd4\u3057\u307e\u3057\u3087\u3046\u3002\n\u5bdf\u3057\u306e\u826f\u3044\u65b9\u306a\u3089\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u5730\u7344\u306e\u547c\u3073\u58f0\u304c\u805e\u3053\u3048\u3066\u304d\u305f\u304b\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u5b9f\u9a13\u3068\u306f\u3044\u3048\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u304c\u4e8c\u91cd\u4e09\u91cd\u306b\u306a\u308b\u306e\u306f\u3055\u3059\u304c\u306b\u8f9b\u3044\u306e\u3067\u3001\n\u3053\u3053\u306f[co](https://github.com/tj/co)\u3055\u3093\u306e\u529b\u3092\u501f\u308a\u307e\u3059\u3002\n\n\u305d\u3057\u3066zip\u306e\u751f\u6210\u306b\u306f[node-zip](https://github.com/daraosn/node-zip)\u3092\u4f7f\u3044\u307e\u3059\u3002\n\n\u6700\u521d\u306f\n\n```js\nlet zipContent = zip.generate({base64: false,compression:'DEFLATE'});\nlambda.createFunction({\n            Code: {ZipFile: zipContent},\n            FunctionName: 'function_' + moment().format('YYYYMMDDHHmmssSSS'),\n            Handler: 'index.handler',\n            Role: IAM_ROLE,\n            Runtime: 'nodejs4.3',\n            MemorySize: 256,\n            Timeout: 60\n        }, (lambdaErr, lambdaData) => {\n            if(lambdaErr !== null){\n                reject(lambdaErr);\n            }else{\n                resolve(lambdaData);\n            }\n        });\n```\n\n\u307f\u305f\u3044\u306b\u3084\u3063\u3066\u307f\u305f\u306e\u3067\u3059\u304c\u300c\u304a\u524d\u306e\u4e0a\u3052\u305f\u30d5\u30a1\u30a4\u30eb\u89e3\u51cd\u3067\u304d\u3078\u3093\u308f\u300d\u3068\u6012\u3089\u308c\u305f\u306e\u3067\u3001\u3084\u3080\u306a\u304f\u4e00\u5ea6zip\u30d5\u30a1\u30a4\u30eb\u3092\u4fdd\u5b58\u3059\u308b\u3053\u3068\u306b\u3057\u307e\u3057\u305f\u3002\n\u4e0a\u8a18\u306e\u30b3\u30fc\u30c9\u3060\u3068zipContent\u304c\u30d0\u30a4\u30ca\u30ea\u306b\u306a\u3063\u3066\u306a\u3044\u306e\u304c\u7406\u7531\u3063\u307d\u3044\u306e\u3067\u3059\u304c\u3001\u30bd\u30fc\u30b9\u5185\u3067\u30d0\u30a4\u30ca\u30ea\u306b\u5909\u63db\u3057\u3066\u3084\u308b\u65b9\u6cd5\u304c\u308f\u304b\u3089\u306a\u304b\u3063\u305f\u306e\u3067...\n\n[\u3053\u306e\u8a18\u4e8b](http://www.bokukoko.info/entry/2015/09/17/AWS_Lambda_\u3092\u5229\u7528\u3059\u308b\u4e0a\u3067\u77e5\u3063\u3066\u304a\u3044\u305f\u307b\u3046\u304c\u3088\u3044\u3053\u3068)\u306b\u3088\u308b\u3068Lambda\u5185\u3067\u3082/tmp\u4ee5\u4e0b\u306f\u4e00\u6642\u4f5c\u696d\u9818\u57df\u3068\u3057\u3066\u4f7f\u3048\u308b\u3088\u3046\u3067\u3059\u3002\n\u203b\u305f\u3060\u3057\u3001\u540c\u3058\u74b0\u5883\u3067\u307b\u304b\u306b\u8ab0\u304c\u4f7f\u3063\u3066\u308b\u304b\u308f\u304b\u3089\u306a\u3044\u306e\u3067\u30d5\u30a1\u30a4\u30eb\u540d\u306b\u6ce8\u610f\u3057\u3001\u5f8c\u7247\u4ed8\u3051\u3092\u5fd8\u308c\u305a\u3084\u3063\u3068\u304d\u307e\u3057\u3087\u3046\u3002\n\n\u5b8c\u6210\u3057\u305f\u546a\u6587\u304c\u3053\u3061\u3089\n\n```js:functions/create_function.js\n'use strict';\n\nconst AWS = require('aws-sdk');\nconst moment = require('moment');\nconst IAM_ROLE = \"arn:aws:iam::my-account-id:role/serverless-created-function\"; //\u5b50\u30e9\u30e0\u30c0\u306b\u4ed8\u4e0e\u3059\u308bIAM\u30ed\u30fc\u30eb\nconst nodeZip = require('node-zip');\nconst fs = require('fs');\nconst co = require('co');\n// Your first function handler\nmodule.exports = (event, context, callback) => {\n\n\n    const BUCKET = \"my-bucket-name\";\n    const zip = new nodeZip();\n\n    co(function *() {\n        try{\n            let objectData = yield s3GetObject({Bucket:BUCKET, Key: 'serverless-test/templates/index.js'});\n            zip.file('index.js', objectData.toString());\n            zip.file('parameters.json', JSON.stringify(event.body));\u3000//body\u4ee5\u4e0b\u3092json\u306b\u5410\u304d\u51fa\u3057\n            let zipContent = zip.generate({base64: false,compression:'DEFLATE'});\n            let zipFile = '/tmp/' + moment().format('YYYYMMDDHHmmssSSS') + '.zip'; //\u30d5\u30a1\u30a4\u30eb\u540d\u304c\u88ab\u3089\u306a\u3044\u3088\u3046\u306b \u771f\u9762\u76ee\u306b\u3084\u308b\u306a\u3089uuid\u3068\u304b\u4f7f\u3046\u3079\u304d\n\n            fs.writeFileSync(zipFile, zipContent, 'binary'); //zip\u30d5\u30a1\u30a4\u30eb\u4f5c\u6210\n            let result = yield lambdaCreateFunction(fs.readFileSync(zipFile));\n            fs.unlinkSync(zipFile); //zip\u30d5\u30a1\u30a4\u30eb\u524a\u9664\n            return result;\n\n        }catch(e){\n            console.log('failed:' + e);\n        }\n    }).then((data) => {\n        callback(null, data);\n    }).catch((error) => {\n        callback(error);\n    });\n};\n\nfunction s3GetObject(params){\n    const s3 = new AWS.S3();\n    return new Promise((resolve, reject) => {\n        s3.getObject(params,(err, data) => {\n            if(err){\n                reject(err);\n            }else{\n                resolve(data.Body);\n            }\n        });\n    });\n}\n\nfunction lambdaCreateFunction(zipFileContent){\n    const lambda = new AWS.Lambda({\n        region: 'us-east-1', //\u4eca\u56de\u79c1\u306f\u5317\u30f4\u30a1\u30fc\u30b8\u30cb\u30a2\u30ea\u30fc\u30b8\u30e7\u30f3\u3092\u4f7f\u3063\u3066\u307e\u3059\n        apiVersion: '2015-03-31'\n    });\n    return new Promise((resolve, reject) => {\n        lambda.createFunction({\n            Code: {ZipFile: zipFileContent},\n            FunctionName: 'function_' + moment().format('YYYYMMDDHHmmssSSS'),\n            Handler: 'index.handler',\n            Role: IAM_ROLE,\n            Runtime: 'nodejs4.3',\n            MemorySize: 256,\n            Timeout: 60\n        }, (lambdaErr, lambdaData) => {\n            if(lambdaErr !== null){\n                reject(lambdaErr);\n            }else{\n                resolve(lambdaData);\n            }\n        });\n    });\n}\n\n```\n\n\u975e\u540c\u671f\u51e6\u7406\u304c\u3053\u3093\u306a\u306b\u30b9\u30c3\u30ad\u30ea\u66f8\u3051\u308b\u306a\u3093\u3066\u3001co\u3055\u3093\u306f\u5049\u5927\u3067\u3059\u3002\n\u3042\u3068\u306fhandler.js\u306b`module.exports.lambda = require('./functions/create_function');`\u3068\u8ffd\u8a18\u3059\u308c\u3070\u9ed2\u9b54\u8853\u306e\u5b8c\u6210\n\n# \u5b9f\u884c\n\n\u3067\u306f\u3001\u9ed2\u9b54\u8853\u3092\u5b9f\u884c\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\u307e\u305a\u30c6\u30b9\u30c8\u7528\u306bevent.json\u3092\u7de8\u96c6\n\n```json:event.json\n{\n  \"body\":{\n    \"output\": \"\u30e9\u30e0\u30c0\u304c\u30e9\u30e0\u30c0\u3092\u751f\u307f\u51fa\u3059\u9ed2\u9b54\u8853\"\n  }\n}\n```\n\n\u30c7\u30d7\u30ed\u30a4&\u5b9f\u884c\n`serverless deploy`\n`serverless invoke --function lambda --path ./event.json`\n\n\u3053\u3046\u3059\u308b\u3053\u3068\u3067event.json\u306e\u4e2d\u8eab\u304c\u89aa\u30e9\u30e0\u30c0\u306e\u5f15\u6570\u3067\u3042\u308bevent\u306b\u305d\u306e\u307e\u307e\u653e\u308a\u8fbc\u307e\u308c\u307e\u3059\u3002\nAPI\u304b\u3089\u30ea\u30af\u30a8\u30b9\u30c8\u3057\u305f\u5834\u5408\u306f\u3001\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u30fc\u306e\u4e2d\u8eab\u304cevent\u306b\u5165\u308a\u307e\u3059\u3002\n\n\u305d\u3057\u3066...\n\n![child_lambda.JPG](https://qiita-image-store.s3.amazonaws.com/0/116434/d35d97ea-2081-b2c3-9ee0-1046b7f534e0.jpeg)\n\n\u751f\u307e\u308c\u305f...!\u65b0\u305f\u306a\u308bLambda\u304c...!\n\n\u751f\u307e\u308c\u305f\u3066\u306e\u5b50\u30e9\u30e0\u30c0\u306b\u306f\u30c8\u30ea\u30ac\u30fc\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u306a\u3044\u306e\u3067\u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089\u30c6\u30b9\u30c8\u5b9f\u884c\u3057\u307e\u3059\u3002\n![child_lambda2.JPG](https://qiita-image-store.s3.amazonaws.com/0/116434/58163d30-a696-3a98-aa35-b4c77c29906e.jpeg)\n\n\u308f\u304b\u308a\u306b\u304f\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u304c\u3001event.json\u3067\u8a2d\u5b9a\u3057\u305f\u6587\u5b57\u5217\u304c\u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089\u51fa\u529b\u3055\u308c\u3066\u307e\u3059\u3002\n\n\u4eca\u56de\u306f\u5358\u306a\u308b\u5b9f\u9a13\u3063\u3066\u611f\u3058\u3067\u3057\u305f\u304c\u3001\u3082\u3046\u5c11\u3057\u9811\u5f35\u308c\u3070\u52d5\u7684\u306bAPI\u3092\u751f\u6210\u306a\u3093\u3066\u3053\u3068\u3082\u3067\u304d\u305d\u3046\u3067\u5922\u304c\u5e83\u304c\u308a\u3093\u3050\u3067\u3059\u306d\u3002\n\n# \u53c2\u8003\u30da\u30fc\u30b8\n\n- [\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](http://docs.aws.amazon.com/AWSJavaScriptSDK/latest/_index.html)\n- [co\u306e\u4f7f\u3044\u65b9\u30e1\u30e2](http://qiita.com/hachi_eiji/items/d4a6e2683344a208c6d0)\n- [AWS_Lambda_\u3092\u5229\u7528\u3059\u308b\u4e0a\u3067\u77e5\u3063\u3066\u304a\u3044\u305f\u307b\u3046\u304c\u3088\u3044\u3053\u3068](http://www.bokukoko.info/entry/2015/09/17/AWS_Lambda_\u3092\u5229\u7528\u3059\u308b\u4e0a\u3067\u77e5\u3063\u3066\u304a\u3044\u305f\u307b\u3046\u304c\u3088\u3044\u3053\u3068)\n", "tags": ["AWS", "serverless", "lambda", "Node.js"]}