{"context": " More than 1 year has passed since last update.\n\nRuby DSL\u3068\u306f\uff1f\nfluentd\u306e\u8a2d\u5b9a\u306eRuby DSL\u7684\u306a\u8a18\u6cd5\u3002\n--use-v1-config\u3067Ruby\u306e\u30b3\u30fc\u30c9\u3092\u8a2d\u5b9a\u306b\u66f8\u304f\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u304c\u3001\u3055\u3089\u306b\u67d4\u8edf\u306a\u8a18\u6cd5\u304c\u53ef\u80fd\u306b\u306a\u308b\u3002\n\u4ee5\u524d\u8abf\u3079\u3066\u3044\u305f\u3053\u3068\u304c\u3042\u308b\u306e\u3067\u3001\u307e\u3068\u3081\u3066\u307f\u308b\u3002\n\n\u5b9f\u884c\u65b9\u6cd5\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u62e1\u5f35\u5b50\u304crb\u3067\u3042\u308c\u3070DSL\u30e2\u30fc\u30c9\u3067\u8d77\u52d5\u3059\u308b\n$ fluentd -c fluent.rb\n\n\n\u3069\u3046\u66f8\u304f\uff1f\n\u3053\u308c\u304c\u3001\n\nfluent.conf\n<match {foo,bar}.**>\n  type stdout\n</match>\n\n<match hoge.**>\n  type copy\n  <store>\n    type stdout\n  </store>\n  <store>\n    type file\n    path /tmp/hoge.txt\n  </store>\n</match>\n\n<source>\n  type forward\n</source>\n\n\n\n\u3053\u3046\u306a\u308b\u3002\n\nfluent.rb\nmatch ('{foo,bar}.**') {\n  type :stdout\n}\n\nmatch ('hoge.**') {\n  type :copy\n  store {\n    type :stdout\n  }\n  store {\n    type :file\n    path \"/tmp/hoge.txt\"\n  }\n}\n\nsource {\n  type :forward\n}\n\n\n\n\neach\u3092\u4f7f\u3046\n\u3053\u308c\u3060\u3051\u3060\u3068\u3061\u3087\u3063\u3068\u30e1\u30ea\u30c3\u30c8\u304c\u308f\u304b\u308a\u3065\u3089\u3044\u306e\u3067\u3002\n\u3082\u3046\u3061\u3087\u3063\u3068\u308f\u304b\u308a\u3084\u3059\u304f\u3002\n\u3053\u308c\u304c\u3001\n\nfluent.conf\n<match foo1.**>\n  type stdout\n</match>\n\n<match foo2.**>\n  type stdout\n</match>\n\n<match foo3.**>\n  type stdout\n</match>\n\n<match foo4.**>\n  type stdout\n</match>\n\n\n\u3053\u3046\u306a\u308b\u3002\n\nfluent.rb\n(1..4).each do |i|\n  match (\"foo#{i}.**\") {\n    type :stdout\n  }\nend\n\n\n\nif\u3067\u5206\u5c90\nweb\u7cfb\u306e\u30b5\u30fc\u30d0\u3067\u306ftail\u3059\u308b\u3068\u304b\n\nfluent.rb\nsource {\n  type :forward\n}\n\nhostname = ruby.open('|hostname').read.strip\n\nif hostname.include?('web')\n  source {\n      type :tail\n      path \"/var/log/httpd/access_log.ltsv\"\n      format 'ltsv'\n      time_key 'time'\n      time_format \"%d/%b/%Y:%H:%M:%S %z\"\n      pos_file \"/tmp/access.pos\"\n      tag \"hogehoge.batch\"\n  }\nend\n\n\n\u4e09\u9805\u6f14\u7b97\u5b50\u3068\u304b\nhostname = ruby.open('|hostname').read.strip\nmatch ('hoge.**') {\n  type :file\n  path hostname.include?('web') ? \"/tmp/web.txt\" : \"/tmp/batch.txt\"\n}\n\n\n\u5916\u90e8\u30e9\u30a4\u30d6\u30e9\u30ea\u8aad\u307f\u8fbc\u3080\ndotenv\u4f7f\u3063\u3066HIPCHAT\u306etoken\u3092\u96a0\u853d\u3059\u308b\u3068\u304b\n\nfluent.rb\n\nruby.require 'dotenv'\nDotenv.load!\nruby.puts ENV['HIPCHAT_API_TOKEN']\n\nmatch ('hipchat.**') do\n  type :hipchat\n  default_room '000000'\n  api_token ENV['HIPCHAT_API_TOKEN']\n  default_from 'fluentd'\n  default_color 'red'\n  default_notify 0\n  default_format 'html'\nend\n\n\n\nopen\u3068\u304bputs\u3068\u304brequire\u306a\u3069\u306eruby\u306e\u51e6\u7406\u3092\u8a18\u8ff0\u3059\u308b\u969b\u306f\u3001prefix\u306bruby\u3092\u3064\u3051\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\nplugin\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u306bArray\u3084Hash\u3092\u4f7f\u3046\nplugin\u5074\u304c\u5bfe\u5fdc\u3057\u3066\u3044\u308b\u5fc5\u8981\u304c\u3042\u308b\u304c\u3001Array\u3084Hash\u3082\u4f7f\u3048\u308b\u3002\n\nfluent.rb\nname = 'user3'\nmatch ('hoge.**') do\n  type :hoge\n  tags [ \"java\", \"ruby\" ]\n  user  id: 3, name: name\n  users [\n    { id: 1, name: 'user1' },\n    { id: 2, name: 'user2' }\n  ]\nend\n\n\n\n\u4e0a\u8a18\u306e\u4f8b\u3067\u306ftags\u306fArray\u3001user\u306fHash\u3002\nusers\u306e\u4f8b\u306e\u3088\u3046\u306b\u6539\u884c\u3057\u3066\u8a18\u8ff0\u3067\u304d\u308b\u3002(v1\u8a18\u6cd5\u3067\u3082\u53ef\u80fd)\n\n\ntd-agent\u3067\u4f7f\u3046\u5834\u5408\n/usr/sbin/td-agent\u3092\u66f8\u304d\u63db\u3048\u308b\n\n/usr/sbin/td-agent\n-ENV[\"FLUENT_CONF\"]=\"/etc/td-agent/td-agent.conf\"\n+ENV[\"FLUENT_CONF\"]=\"/etc/td-agent/td-agent.rb\"\n\n\n\n\u62e1\u5f35\u5b50\u304c.rb\u3060\u3063\u305f\u3089dsl\u3067\u8a2d\u5b9a\u304c\u8aad\u307f\u8fbc\u307e\u308c\u308b\u3002(\u53c2\u8003)\n\n\n\u5099\u8003\n\ninclude\u306f\u73fe\u72b6\u306f\u4f7f\u3048\u306a\u3044\u304c\u3001\u3053\u3053\u306bissue\u304c\u4e0a\u304c\u3063\u3066\u3044\u308b\u3002\n\n\nruby\u306a\u306e\u3067eval\u3067\u30b4\u30cb\u30e7\u30b4\u30cb\u30e7\u3084\u308c\u3070\u51fa\u6765\u308b\u304b\u3082\u3057\u308c\u306a\u3044\u3002\u3002(\u672a\u78ba\u8a8d)\n\n\n\n\n## Ruby DSL\u3068\u306f\uff1f\nfluentd\u306e\u8a2d\u5b9a\u306eRuby DSL\u7684\u306a\u8a18\u6cd5\u3002\n\n--use-v1-config\u3067Ruby\u306e\u30b3\u30fc\u30c9\u3092\u8a2d\u5b9a\u306b\u66f8\u304f\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u304c\u3001\u3055\u3089\u306b\u67d4\u8edf\u306a\u8a18\u6cd5\u304c\u53ef\u80fd\u306b\u306a\u308b\u3002\n\n\u4ee5\u524d\u8abf\u3079\u3066\u3044\u305f\u3053\u3068\u304c\u3042\u308b\u306e\u3067\u3001\u307e\u3068\u3081\u3066\u307f\u308b\u3002\n\n## \u5b9f\u884c\u65b9\u6cd5\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u62e1\u5f35\u5b50\u304crb\u3067\u3042\u308c\u3070DSL\u30e2\u30fc\u30c9\u3067\u8d77\u52d5\u3059\u308b\n\n```bash\n$ fluentd -c fluent.rb\n```\n\n## \u3069\u3046\u66f8\u304f\uff1f\n\u3053\u308c\u304c\u3001\n\n```fluent.conf\n<match {foo,bar}.**>\n  type stdout\n</match>\n\n<match hoge.**>\n  type copy\n  <store>\n    type stdout\n  </store>\n  <store>\n    type file\n    path /tmp/hoge.txt\n  </store>\n</match>\n\n<source>\n  type forward\n</source>\n\n```\n\n\u3053\u3046\u306a\u308b\u3002\n\n```ruby:fluent.rb\nmatch ('{foo,bar}.**') {\n  type :stdout\n}\n\nmatch ('hoge.**') {\n  type :copy\n  store {\n    type :stdout\n  }\n  store {\n    type :file\n    path \"/tmp/hoge.txt\"\n  }\n}\n\nsource {\n  type :forward\n}\n\n```\n\n## each\u3092\u4f7f\u3046\n\n\u3053\u308c\u3060\u3051\u3060\u3068\u3061\u3087\u3063\u3068\u30e1\u30ea\u30c3\u30c8\u304c\u308f\u304b\u308a\u3065\u3089\u3044\u306e\u3067\u3002\n\n\u3082\u3046\u3061\u3087\u3063\u3068\u308f\u304b\u308a\u3084\u3059\u304f\u3002\n\n\u3053\u308c\u304c\u3001\n\n```fluent.conf\n<match foo1.**>\n  type stdout\n</match>\n\n<match foo2.**>\n  type stdout\n</match>\n\n<match foo3.**>\n  type stdout\n</match>\n\n<match foo4.**>\n  type stdout\n</match>\n```\n\n\u3053\u3046\u306a\u308b\u3002\n\n```ruby:fluent.rb\n(1..4).each do |i|\n  match (\"foo#{i}.**\") {\n    type :stdout\n  }\nend\n```\n\n## if\u3067\u5206\u5c90\n\nweb\u7cfb\u306e\u30b5\u30fc\u30d0\u3067\u306ftail\u3059\u308b\u3068\u304b\n\n```ruby:fluent.rb\nsource {\n  type :forward\n}\n\nhostname = ruby.open('|hostname').read.strip\n\nif hostname.include?('web')\n  source {\n      type :tail\n      path \"/var/log/httpd/access_log.ltsv\"\n      format 'ltsv'\n      time_key 'time'\n      time_format \"%d/%b/%Y:%H:%M:%S %z\"\n      pos_file \"/tmp/access.pos\"\n      tag \"hogehoge.batch\"\n  }\nend\n```\n\n\u4e09\u9805\u6f14\u7b97\u5b50\u3068\u304b\n\n```ruby\nhostname = ruby.open('|hostname').read.strip\nmatch ('hoge.**') {\n  type :file\n  path hostname.include?('web') ? \"/tmp/web.txt\" : \"/tmp/batch.txt\"\n}\n```\n\n\n## \u5916\u90e8\u30e9\u30a4\u30d6\u30e9\u30ea\u8aad\u307f\u8fbc\u3080\n\ndotenv\u4f7f\u3063\u3066HIPCHAT\u306etoken\u3092\u96a0\u853d\u3059\u308b\u3068\u304b\n\n```ruby:fluent.rb\n\nruby.require 'dotenv'\nDotenv.load!\nruby.puts ENV['HIPCHAT_API_TOKEN']\n\nmatch ('hipchat.**') do\n  type :hipchat\n  default_room '000000'\n  api_token ENV['HIPCHAT_API_TOKEN']\n  default_from 'fluentd'\n  default_color 'red'\n  default_notify 0\n  default_format 'html'\nend\n\n```\n\nopen\u3068\u304bputs\u3068\u304brequire\u306a\u3069\u306eruby\u306e\u51e6\u7406\u3092\u8a18\u8ff0\u3059\u308b\u969b\u306f\u3001prefix\u306b`ruby`\u3092\u3064\u3051\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\n\n## plugin\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u306bArray\u3084Hash\u3092\u4f7f\u3046\n\nplugin\u5074\u304c\u5bfe\u5fdc\u3057\u3066\u3044\u308b\u5fc5\u8981\u304c\u3042\u308b\u304c\u3001Array\u3084Hash\u3082\u4f7f\u3048\u308b\u3002\n\n```ruby:fluent.rb\nname = 'user3'\nmatch ('hoge.**') do\n  type :hoge\n  tags [ \"java\", \"ruby\" ]\n  user  id: 3, name: name\n  users [\n    { id: 1, name: 'user1' },\n    { id: 2, name: 'user2' }\n  ]\nend\n```\n\n* \u4e0a\u8a18\u306e\u4f8b\u3067\u306ftags\u306fArray\u3001user\u306fHash\u3002\n* users\u306e\u4f8b\u306e\u3088\u3046\u306b\u6539\u884c\u3057\u3066\u8a18\u8ff0\u3067\u304d\u308b\u3002(v1\u8a18\u6cd5\u3067\u3082\u53ef\u80fd)\n\n\n## td-agent\u3067\u4f7f\u3046\u5834\u5408\n/usr/sbin/td-agent\u3092\u66f8\u304d\u63db\u3048\u308b\n\n```diff:/usr/sbin/td-agent\n-ENV[\"FLUENT_CONF\"]=\"/etc/td-agent/td-agent.conf\"\n+ENV[\"FLUENT_CONF\"]=\"/etc/td-agent/td-agent.rb\"\n```\n* \u62e1\u5f35\u5b50\u304c.rb\u3060\u3063\u305f\u3089dsl\u3067\u8a2d\u5b9a\u304c\u8aad\u307f\u8fbc\u307e\u308c\u308b\u3002([\u53c2\u8003](https://github.com/fluent/fluentd/blob/master/lib/fluent/config.rb#L23))\n\n\n## \u5099\u8003\n* include\u306f\u73fe\u72b6\u306f\u4f7f\u3048\u306a\u3044\u304c\u3001[\u3053\u3053](https://github.com/fluent/fluentd/issues/360)\u306bissue\u304c\u4e0a\u304c\u3063\u3066\u3044\u308b\u3002\n  * ruby\u306a\u306e\u3067eval\u3067\u30b4\u30cb\u30e7\u30b4\u30cb\u30e7\u3084\u308c\u3070\u51fa\u6765\u308b\u304b\u3082\u3057\u308c\u306a\u3044\u3002\u3002(\u672a\u78ba\u8a8d)\n\n", "tags": ["fluentd", "td-agent", "Ruby"]}