{"tags": ["juniper", "junos", "Python", "junoscript"], "context": "\n\u3082\u3046\u3059\u3050IPv6\u5143\u5e74!?\u3068\u3044\u3046\u3053\u3068\u3067() \u4e00\u767a\u30cd\u30bf\u3067\u3059\u3002\nIPv4\u304b\u3089\u306e\u30b3\u30df\u30c3\u30c8\u306a\u3093\u3066\u7981\u6b62\u3057\u3061\u3083\u3044\u307e\u3057\u3087\u3046\u3002\nJunos 16.1R1\u4ee5\u964d\u3067\u52d5\u4f5c\u3057\u307e\u3059\u3002\n\u53c2\u8003: Junos\u306eOn-box Python\u3092\u4f7f\u3063\u3066\u307f\u308b #2 Commit Script\n\n\u8a2d\u5b9a\n\ncommit-script.junos\nset system scripts language python\nset system scripts commit file commit-script.py\n\n\n\n\u30b9\u30af\u30ea\u30d7\u30c8\n\n/var/db/scripts/commit/commit-script.py\nfrom junos import Junos_Context\nfrom jnpr.junos import Device\nimport jcs\n\ndef main():\n  login_name = Junos_Context['user-context']['login-name']\n  host_name = Junos_Context['hostname']\n  product_name = Junos_Context['product']\n  tty_dev = Junos_Context['tty'].replace('/dev/','')\n\n  dev = Device()\n  dev.open()\n\n  sessions = dev.rpc.get_system_users_information(no_resolve=True)\n\n  user_ip = None\n\n  for session in sessions.getiterator(\"user-entry\"):\n    if session.find(\"tty\").text.strip() == tty_dev:\n      user_ip = session.find(\"from\").text.strip()\n\n  if user_ip:\n    if user_ip.count('.'):\n      jcs.emit_error(\"Commit through IPv4 is prohibited!!\")\n\nif __name__ == '__main__':\n  main()\n\n\n\n\u7d50\u679c\n\noutput.txt\n[edit]\nroot@vmx1# run show system users no-resolve\n 2:18PM  up 22 days,  4:15, 1 users, load averages: 0.36, 0.35, 0.33\nUSER     TTY      FROM                              LOGIN@  IDLE WHAT\nroot     pts/0    192.168.0.10                     2:18PM      - cli\n\n[edit]\nroot@vmx1# commit\nerror: Commit through IPv4 is prohibited!!\nerror: 1 error reported by commit scripts\nerror: commit script failure\n\n\n\noutput-v6.txt\n[edit]\nroot@vmx1# run show system users no-resolve\n 2:47PM  up 22 days,  4:44, 1 users, load averages: 0.34, 0.30, 0.27\nUSER     TTY      FROM                              LOGIN@  IDLE WHAT\nroot     pts/1    fe80::250:560f:fcb6:4397         2:47PM      - cli\n\n[edit]\nroot@vmx1# commit\ncommit complete\n\n\n\n\u3055\u3044\u3054\u306b\n\u30aa\u30c1\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n<blockquote class=\"twitter-tweet\" data-lang=\"ja\"><p lang=\"ja\" dir=\"ltr\">\u6b21\u306e\u5143\u53f7\u306fIPv6\u3067\u3059\u306d\u3002\u3064\u3044\u306bIPv6\u5143\u5e74\u304c\u3084\u3063\u3066\u304d\u307e\u3059</p>&mdash; masahiro nagano (@kazeburo) <a href=\"https://twitter.com/kazeburo/status/818668746873061376\">2017\u5e741\u670810\u65e5</a></blockquote>\n\n\u3082\u3046\u3059\u3050IPv6\u5143\u5e74!?\u3068\u3044\u3046\u3053\u3068\u3067() \u4e00\u767a\u30cd\u30bf\u3067\u3059\u3002\nIPv4\u304b\u3089\u306e\u30b3\u30df\u30c3\u30c8\u306a\u3093\u3066\u7981\u6b62\u3057\u3061\u3083\u3044\u307e\u3057\u3087\u3046\u3002\n\nJunos 16.1R1\u4ee5\u964d\u3067\u52d5\u4f5c\u3057\u307e\u3059\u3002\n\u53c2\u8003: [Junos\u306eOn-box Python\u3092\u4f7f\u3063\u3066\u307f\u308b #2 Commit Script](http://qiita.com/kazubu/items/6d5c94cf32436c4d228f)\n\n# \u8a2d\u5b9a\n```commit-script.junos\nset system scripts language python\nset system scripts commit file commit-script.py\n```\n\n# \u30b9\u30af\u30ea\u30d7\u30c8\n```/var/db/scripts/commit/commit-script.py\nfrom junos import Junos_Context\nfrom jnpr.junos import Device\nimport jcs\n \ndef main():\n  login_name = Junos_Context['user-context']['login-name']\n  host_name = Junos_Context['hostname']\n  product_name = Junos_Context['product']\n  tty_dev = Junos_Context['tty'].replace('/dev/','')\n \n  dev = Device()\n  dev.open()\n \n  sessions = dev.rpc.get_system_users_information(no_resolve=True)\n \n  user_ip = None\n \n  for session in sessions.getiterator(\"user-entry\"):\n    if session.find(\"tty\").text.strip() == tty_dev:\n      user_ip = session.find(\"from\").text.strip()\n \n  if user_ip:\n    if user_ip.count('.'):\n      jcs.emit_error(\"Commit through IPv4 is prohibited!!\")\n \nif __name__ == '__main__':\n  main()\n```\n\n# \u7d50\u679c\n\n```output.txt\n[edit]\nroot@vmx1# run show system users no-resolve\n 2:18PM  up 22 days,  4:15, 1 users, load averages: 0.36, 0.35, 0.33\nUSER     TTY      FROM                              LOGIN@  IDLE WHAT\nroot     pts/0    192.168.0.10                     2:18PM      - cli\n\n[edit]\nroot@vmx1# commit\nerror: Commit through IPv4 is prohibited!!\nerror: 1 error reported by commit scripts\nerror: commit script failure\n```\n\n```output-v6.txt\n[edit]\nroot@vmx1# run show system users no-resolve\n 2:47PM  up 22 days,  4:44, 1 users, load averages: 0.34, 0.30, 0.27\nUSER     TTY      FROM                              LOGIN@  IDLE WHAT\nroot     pts/1    fe80::250:560f:fcb6:4397         2:47PM      - cli\n\n[edit]\nroot@vmx1# commit\ncommit complete\n```\n\n# \u3055\u3044\u3054\u306b\n\n\u30aa\u30c1\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n"}