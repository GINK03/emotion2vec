{"context": "CakePHP 2.8.3\u30013.0.18\u30013.1.13\u30013.2.6 \u306e\u30ea\u30ea\u30fc\u30b9\u3067\u3001Validation::uploadedFile()\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f\u3002\nCakePHP 2.8.3, 3.0.18, 3.1.13 and 3.2.6 Released\n\u5177\u4f53\u7684\u306b\u306f\u3001is_uploaded_file($file['tmp_name'])\u306e\u30c1\u30a7\u30c3\u30af\u304c\u5897\u3048\u3066\u3001\u672c\u5f53\u306bPOST\u3067\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3055\u308c\u305f\u30d5\u30a1\u30a4\u30eb\u306a\u306e\u304b\u3092\u78ba\u8a8d\u3059\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\u307e\u3041\u305d\u308c\u306f\u3044\u3044\u3093\u3067\u3059\u304c\u3001\u30c6\u30b9\u30c8\u3067\u30d5\u30a1\u30a4\u30eb\u306e\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3092\u5b9f\u884c\u3057\u3066\u3044\u305f\u3068\u3053\u308d\u304c\u901a\u3089\u306a\u304f\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u2026\u3002\n\u4eca\u307e\u3067\u3053\u3093\u306a\u98a8\u306b\u30c6\u30b9\u30c8\u3057\u3066\u3044\u307e\u3057\u305f\u3002\n\ntests/TestCase/Controller/ArticlesControllerTest.php\npublic function testAdd()\n{\n    $data = [\n        'title' => 'test title',\n        'file1' => [\n            'name' => 'picture.jpg',\n            'type' => 'image/jpg',\n            'tmp_name' => ROOT . DS . 'tests' . DS . 'Fixture' . DS . 'sample.jpg',\n            'error' => UPLOAD_ERR_OK,\n            'size' => 1475\n        ]\n    ];\n    $this->post('/articles/add', $data);\n    $this->assertRedirect(['controller' => 'articles', 'action' => 'index']);\n}\n\n\nFixture\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u7f6e\u3044\u3066\u3042\u308bsample.jpg\u30d5\u30a1\u30a4\u30eb\u3092POST\u3057\u305f\u3088\u3046\u306b\u3057\u3066\u30c6\u30b9\u30c8\u3057\u3066\u3044\u305f\u306e\u3067\u3059\u304c\u3001file1\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306buploadedFile\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u3092\u4f7f\u3063\u3066\u3044\u305f\u305f\u3081\u3001is_uploaded_file()\u3067\u5f15\u3063\u304b\u304b\u3063\u3066\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u30a8\u30e9\u30fc\u304c\u8fd4\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u3002\n\nsrc/Model/Table/ArticlesTable.php\npublic function validationDefault(Validator $validator)\n{\n    $validator\n        ->add('file1', 'image', [\n            'rule' => ['uploadedFile', [\n                'types' => Configure::read('image.allow_mime_types'),\n                'maxSize' => Configure::read('image.max_size')\n            ]],\n            'message' => '\u30b5\u30a4\u30ba\u304c\u5927\u304d\u3059\u304e\u308b\u304b\u3001\u4e0d\u6b63\u306a\u30d5\u30a1\u30a4\u30eb\u30bf\u30a4\u30d7\u3067\u3059'\n        ])\n        ->allowEmpty('file1');\n\n\nis_uploaded_file()\u3092\u507d\u88c5(\uff1f)\u3059\u308b\u65b9\u6cd5\u306f\u306a\u3044\u3082\u306e\u304b\u3068\u8abf\u3079\u3066\u307f\u307e\u3057\u305f\u304c\u3001\u7c21\u5358\u306b\u3067\u304d\u305d\u3046\u306b\u306a\u304f(\u307e\u3041\u305d\u3046\u3044\u3046\u3082\u306e\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u304c)\u3001uploadedFile\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u3092\u30b3\u30d4\u30fc\u3057\u3066\u30ab\u30b9\u30bf\u30e0\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u3092\u4f5c\u308b\u3053\u3068\u306b\u3057\u307e\u3057\u305f\u3002\n\nsrc/Model/Validation.php\n<?php\nnamespace App\\Model;\n\nclass Validation extends \\Cake\\Validation\\Validation\n{\n    public static function uploadedFile($file, array $options = [])\n    {\n        $options += [\n            'minSize' => null,\n            'maxSize' => null,\n            'types' => null,\n            'optional' => false,\n        ];\n        if (!is_array($file)) {\n            return false;\n        }\n        $keys = ['error', 'name', 'size', 'tmp_name', 'type'];\n        ksort($file);\n        if (array_keys($file) != $keys) {\n            return false;\n        }\n        if (!static::uploadError($file, $options['optional'])) {\n            return false;\n        }\n        if ($options['optional'] && (int)$file['error'] === UPLOAD_ERR_NO_FILE) {\n            return true;\n        }\n        if (isset($options['minSize']) && !static::fileSize($file, '>=', $options['minSize'])) {\n            return false;\n        }\n        if (isset($options['maxSize']) && !static::fileSize($file, '<=', $options['maxSize'])) {\n            return false;\n        }\n        if (isset($options['types']) && !static::mimeType($file, $options['types'])) {\n            return false;\n        }\n        if (defined('IS_TEST') && IS_TEST) {\n            return true;\n        }\n        return is_uploaded_file($file['tmp_name']);\n    }\n}\n\n\n\u6700\u5f8c\u306ereturn\u306e\u624b\u524d\u306eIS_TEST\u3092\u30c1\u30a7\u30c3\u30af\u3057\u3066\u3044\u308b\u3068\u3053\u308d\u4ee5\u5916\u306f\u5143\u306euploadedFile\u3068\u540c\u3058\u3067\u3059\u3002\nIS_TEST\u306ftests/bootstrap.php\u3067define\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\u2193\u3092\u8ffd\u52a0\u3002\n\ntest/bootstrap.php\ndefine('IS_TEST', true);\n\n\n\u30ab\u30b9\u30bf\u30e0\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\nsrc/Model/Table/ArticlesTable.php\npublic function validationDefault(Validator $validator)\n{\n    $validator->provider('custom', 'App\\Model\\Validation');\n    $validator\n        ->add('file1', 'image', [\n            'rule' => ['uploadedFile', [\n                'types' => Configure::read('image.allow_mime_types'),\n                'maxSize' => Configure::read('image.max_size')\n            ]],\n            'provider' => 'custom',\n            'message' => '\u30b5\u30a4\u30ba\u304c\u5927\u304d\u3059\u304e\u308b\u304b\u3001\u4e0d\u6b63\u306a\u30d5\u30a1\u30a4\u30eb\u30bf\u30a4\u30d7\u3067\u3059'\n        ])\n        ->allowEmpty('file1');\n\n\n\u3053\u308c\u3067\u30c6\u30b9\u30c8\u306e\u6642\u306fis_uploaded_file()\u3092\u30c1\u30a7\u30c3\u30af\u3057\u306a\u3044\u3088\u3046\u306b\u306a\u3063\u305f\u306e\u3067\u3001\u30c6\u30b9\u30c8\u304c\u901a\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\u306a\u3093\u304b\u3059\u3063\u304d\u308a\u3057\u306a\u3044\u3051\u3069\u2026\u3002\n\n\u8ffd\u8a18 (2016/04/19)\n\u30b3\u30e1\u30f3\u30c8\u3067\u6559\u3048\u3066\u3082\u3089\u3063\u305f\u65b9\u6cd5\u3067\u3001\u5143\u306e\u30bd\u30fc\u30b9\u306b\u624b\u3092\u5165\u308c\u306a\u304f\u3066\u3082\u30c6\u30b9\u30c8\u3092\u901a\u3059\u3053\u3068\u304c\u3067\u304d\u307e\u3057\u305f\u3002\nhttps://github.com/cakephp/cakephp/blob/master/tests/TestCase/Validation/stubs.php\n\u2191\u3092\u30b3\u30d4\u30fc\u3057\u3066\u3001tests/TestCase/Validation/stubs.php\u3068\u3044\u3046\u30d5\u30a1\u30a4\u30eb(\u5834\u6240\u306f\u7279\u306b\u6c7a\u307e\u3063\u3066\u306a\u3044\u3068\u601d\u3044\u307e\u3059\u304c\u3001\u540c\u3058\u3088\u3046\u306b\u3057\u307e\u3057\u305f)\u3092\u4f5c\u6210\u3057\u3001\u8a72\u5f53\u306e\u30c6\u30b9\u30c8(\u4e0a\u8a18\u4f8b\u3060\u3068tests/TestCase/Controller/ArticlesControllerTest.php)\u3067\n\ntests/TestCase/Controller/ArticlesControllerTest.php\nrequire_once TESTS . 'TestCase' . DS . 'Validation' . DS . 'stubs.php';\n\n\n\u3092use\u306e\u6b21\u3050\u3089\u3044\u306b\u66f8\u304f\u3060\u3051\u3067\u3059\u3002\u3059\u3063\u304d\u308a\uff01\n\u540d\u524d\u7a7a\u9593\u4e0a\u306b\u95a2\u6570\u304c\u5b58\u5728\u3059\u308c\u3070\u305d\u306e\u95a2\u6570\u3092\u547c\u3076\u306a\u3093\u3066\u77e5\u308a\u307e\u305b\u3093\u3067\u3057\u305f\u3002\nCakePHP 2.8.3\u30013.0.18\u30013.1.13\u30013.2.6 \u306e\u30ea\u30ea\u30fc\u30b9\u3067\u3001Validation::uploadedFile()\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f\u3002\n[CakePHP 2.8.3, 3.0.18, 3.1.13 and 3.2.6 Released](http://bakery.cakephp.org/2016/03/28/cakephp_283_3018_3113_326_released.html)\n\n\u5177\u4f53\u7684\u306b\u306f\u3001`is_uploaded_file($file['tmp_name'])`\u306e\u30c1\u30a7\u30c3\u30af\u304c\u5897\u3048\u3066\u3001\u672c\u5f53\u306bPOST\u3067\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3055\u308c\u305f\u30d5\u30a1\u30a4\u30eb\u306a\u306e\u304b\u3092\u78ba\u8a8d\u3059\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n\u307e\u3041\u305d\u308c\u306f\u3044\u3044\u3093\u3067\u3059\u304c\u3001\u30c6\u30b9\u30c8\u3067\u30d5\u30a1\u30a4\u30eb\u306e\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3092\u5b9f\u884c\u3057\u3066\u3044\u305f\u3068\u3053\u308d\u304c\u901a\u3089\u306a\u304f\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u2026\u3002\n\n\u4eca\u307e\u3067\u3053\u3093\u306a\u98a8\u306b\u30c6\u30b9\u30c8\u3057\u3066\u3044\u307e\u3057\u305f\u3002\n\n```php:tests/TestCase/Controller/ArticlesControllerTest.php\npublic function testAdd()\n{\n    $data = [\n        'title' => 'test title',\n        'file1' => [\n            'name' => 'picture.jpg',\n            'type' => 'image/jpg',\n            'tmp_name' => ROOT . DS . 'tests' . DS . 'Fixture' . DS . 'sample.jpg',\n            'error' => UPLOAD_ERR_OK,\n            'size' => 1475\n        ]\n    ];\n    $this->post('/articles/add', $data);\n    $this->assertRedirect(['controller' => 'articles', 'action' => 'index']);\n}\n```\n\nFixture\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u7f6e\u3044\u3066\u3042\u308bsample.jpg\u30d5\u30a1\u30a4\u30eb\u3092POST\u3057\u305f\u3088\u3046\u306b\u3057\u3066\u30c6\u30b9\u30c8\u3057\u3066\u3044\u305f\u306e\u3067\u3059\u304c\u3001file1\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306buploadedFile\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u3092\u4f7f\u3063\u3066\u3044\u305f\u305f\u3081\u3001`is_uploaded_file()`\u3067\u5f15\u3063\u304b\u304b\u3063\u3066\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u30a8\u30e9\u30fc\u304c\u8fd4\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u3002\n\n```php:src/Model/Table/ArticlesTable.php\npublic function validationDefault(Validator $validator)\n{\n    $validator\n        ->add('file1', 'image', [\n            'rule' => ['uploadedFile', [\n                'types' => Configure::read('image.allow_mime_types'),\n                'maxSize' => Configure::read('image.max_size')\n            ]],\n            'message' => '\u30b5\u30a4\u30ba\u304c\u5927\u304d\u3059\u304e\u308b\u304b\u3001\u4e0d\u6b63\u306a\u30d5\u30a1\u30a4\u30eb\u30bf\u30a4\u30d7\u3067\u3059'\n        ])\n        ->allowEmpty('file1');\n```\n\n`is_uploaded_file()`\u3092\u507d\u88c5(\uff1f)\u3059\u308b\u65b9\u6cd5\u306f\u306a\u3044\u3082\u306e\u304b\u3068\u8abf\u3079\u3066\u307f\u307e\u3057\u305f\u304c\u3001\u7c21\u5358\u306b\u3067\u304d\u305d\u3046\u306b\u306a\u304f(\u307e\u3041\u305d\u3046\u3044\u3046\u3082\u306e\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u304c)\u3001uploadedFile\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u3092\u30b3\u30d4\u30fc\u3057\u3066\u30ab\u30b9\u30bf\u30e0\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u3092\u4f5c\u308b\u3053\u3068\u306b\u3057\u307e\u3057\u305f\u3002\n\n```php:src/Model/Validation.php\n<?php\nnamespace App\\Model;\n\nclass Validation extends \\Cake\\Validation\\Validation\n{\n    public static function uploadedFile($file, array $options = [])\n    {\n        $options += [\n            'minSize' => null,\n            'maxSize' => null,\n            'types' => null,\n            'optional' => false,\n        ];\n        if (!is_array($file)) {\n            return false;\n        }\n        $keys = ['error', 'name', 'size', 'tmp_name', 'type'];\n        ksort($file);\n        if (array_keys($file) != $keys) {\n            return false;\n        }\n        if (!static::uploadError($file, $options['optional'])) {\n            return false;\n        }\n        if ($options['optional'] && (int)$file['error'] === UPLOAD_ERR_NO_FILE) {\n            return true;\n        }\n        if (isset($options['minSize']) && !static::fileSize($file, '>=', $options['minSize'])) {\n            return false;\n        }\n        if (isset($options['maxSize']) && !static::fileSize($file, '<=', $options['maxSize'])) {\n            return false;\n        }\n        if (isset($options['types']) && !static::mimeType($file, $options['types'])) {\n            return false;\n        }\n        if (defined('IS_TEST') && IS_TEST) {\n            return true;\n        }\n        return is_uploaded_file($file['tmp_name']);\n    }\n}\n```\n\n\u6700\u5f8c\u306ereturn\u306e\u624b\u524d\u306eIS_TEST\u3092\u30c1\u30a7\u30c3\u30af\u3057\u3066\u3044\u308b\u3068\u3053\u308d\u4ee5\u5916\u306f\u5143\u306euploadedFile\u3068\u540c\u3058\u3067\u3059\u3002\nIS_TEST\u306ftests/bootstrap.php\u3067define\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\u2193\u3092\u8ffd\u52a0\u3002\n\n```php:test/bootstrap.php\ndefine('IS_TEST', true);\n```\n\n\u30ab\u30b9\u30bf\u30e0\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n```php:src/Model/Table/ArticlesTable.php\npublic function validationDefault(Validator $validator)\n{\n    $validator->provider('custom', 'App\\Model\\Validation');\n    $validator\n        ->add('file1', 'image', [\n            'rule' => ['uploadedFile', [\n                'types' => Configure::read('image.allow_mime_types'),\n                'maxSize' => Configure::read('image.max_size')\n            ]],\n            'provider' => 'custom',\n            'message' => '\u30b5\u30a4\u30ba\u304c\u5927\u304d\u3059\u304e\u308b\u304b\u3001\u4e0d\u6b63\u306a\u30d5\u30a1\u30a4\u30eb\u30bf\u30a4\u30d7\u3067\u3059'\n        ])\n        ->allowEmpty('file1');\n```\n\n\u3053\u308c\u3067\u30c6\u30b9\u30c8\u306e\u6642\u306f`is_uploaded_file()`\u3092\u30c1\u30a7\u30c3\u30af\u3057\u306a\u3044\u3088\u3046\u306b\u306a\u3063\u305f\u306e\u3067\u3001\u30c6\u30b9\u30c8\u304c\u901a\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\u306a\u3093\u304b\u3059\u3063\u304d\u308a\u3057\u306a\u3044\u3051\u3069\u2026\u3002\n\n# \u8ffd\u8a18 (2016/04/19)\n\n\u30b3\u30e1\u30f3\u30c8\u3067\u6559\u3048\u3066\u3082\u3089\u3063\u305f\u65b9\u6cd5\u3067\u3001\u5143\u306e\u30bd\u30fc\u30b9\u306b\u624b\u3092\u5165\u308c\u306a\u304f\u3066\u3082\u30c6\u30b9\u30c8\u3092\u901a\u3059\u3053\u3068\u304c\u3067\u304d\u307e\u3057\u305f\u3002\n\nhttps://github.com/cakephp/cakephp/blob/master/tests/TestCase/Validation/stubs.php\n\u2191\u3092\u30b3\u30d4\u30fc\u3057\u3066\u3001tests/TestCase/Validation/stubs.php\u3068\u3044\u3046\u30d5\u30a1\u30a4\u30eb(\u5834\u6240\u306f\u7279\u306b\u6c7a\u307e\u3063\u3066\u306a\u3044\u3068\u601d\u3044\u307e\u3059\u304c\u3001\u540c\u3058\u3088\u3046\u306b\u3057\u307e\u3057\u305f)\u3092\u4f5c\u6210\u3057\u3001\u8a72\u5f53\u306e\u30c6\u30b9\u30c8(\u4e0a\u8a18\u4f8b\u3060\u3068tests/TestCase/Controller/ArticlesControllerTest.php)\u3067\n\n```php:tests/TestCase/Controller/ArticlesControllerTest.php\nrequire_once TESTS . 'TestCase' . DS . 'Validation' . DS . 'stubs.php';\n```\n\n\u3092use\u306e\u6b21\u3050\u3089\u3044\u306b\u66f8\u304f\u3060\u3051\u3067\u3059\u3002\u3059\u3063\u304d\u308a\uff01\n\u540d\u524d\u7a7a\u9593\u4e0a\u306b\u95a2\u6570\u304c\u5b58\u5728\u3059\u308c\u3070\u305d\u306e\u95a2\u6570\u3092\u547c\u3076\u306a\u3093\u3066\u77e5\u308a\u307e\u305b\u3093\u3067\u3057\u305f\u3002\n", "tags": ["CakePHP", "cakephp3", "unittest"]}